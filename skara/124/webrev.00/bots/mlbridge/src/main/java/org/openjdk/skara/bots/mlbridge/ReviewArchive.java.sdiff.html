<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/ReviewArchive.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="MailingListArchiveReaderBot.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/ReviewArchive.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 package org.openjdk.skara.bots.mlbridge;
  2 
  3 import org.openjdk.skara.census.Contributor;
  4 import org.openjdk.skara.email.*;
  5 import org.openjdk.skara.host.*;
  6 import org.openjdk.skara.vcs.Hash;
  7 
  8 import java.io.*;
  9 import java.net.URI;
 10 import java.nio.charset.StandardCharsets;
 11 import java.security.*;
 12 import java.util.*;
 13 import java.util.stream.*;
 14 
 15 class ReviewArchive {
 16     private final PullRequestInstance prInstance;

 17     private final EmailAddress sender;
<span class="line-removed"> 18     private final String nameDecoration;</span>
 19     private final List&lt;Email&gt; existing;
 20     private final Map&lt;String, Email&gt; existingIds = new HashMap&lt;&gt;();
 21     private final List&lt;Email&gt; generated = new ArrayList&lt;&gt;();
 22     private final Map&lt;String, Email&gt; generatedIds = new HashMap&lt;&gt;();
 23     private final List&lt;Hash&gt; reportedHeads;
 24     private final List&lt;Hash&gt; reportedBases;
 25 
 26     private EmailAddress getAuthorAddress(HostUserDetails originalAuthor) {
<span class="line-modified"> 27         return EmailAddress.from(originalAuthor.fullName() + nameDecoration,</span>
<span class="line-modified"> 28                                  sender.address());</span>






 29     }
 30 
 31     private EmailAddress getUniqueMessageId(String identifier) {
 32         try {
 33             var prSpecific = prInstance.pr().repository().getName().replace(&quot;/&quot;, &quot;.&quot;) + &quot;.&quot; + prInstance.id();
 34             var digest = MessageDigest.getInstance(&quot;SHA-256&quot;);
 35             digest.update(prSpecific.getBytes(StandardCharsets.UTF_8));
 36             digest.update(identifier.getBytes(StandardCharsets.UTF_8));
 37             var encodedCommon = Base64.getUrlEncoder().encodeToString(digest.digest());
 38 
 39             return EmailAddress.from(encodedCommon + &quot;.&quot; + UUID.randomUUID() + &quot;@&quot; + prInstance.pr().repository().getUrl().getHost());
 40         } catch (NoSuchAlgorithmException e) {
 41             throw new RuntimeException(&quot;Cannot find SHA-256&quot;);
 42         }
 43     }
 44 
 45     private EmailAddress getMessageId() {
 46         return getUniqueMessageId(&quot;fc&quot;);
 47     }
 48 
</pre>
<hr />
<pre>
110     }
111 
112     private Email parentForReviewComment(ReviewComment reviewComment) {
113         var parent = topCommentForHash(reviewComment.hash());
114         if (reviewComment.parent().isPresent()) {
115             var parentId = getStableMessageId(getMessageId(reviewComment.parent().get()));
116             var last = Stream.concat(existing.stream(), generated.stream())
117                              .filter(email -&gt; (email.hasHeader(&quot;References&quot;) &amp;&amp; email.headerValue(&quot;References&quot;).contains(parentId)) ||
118                                      (getStableMessageId(email.id()).equals(parentId)))
119                              .max(Comparator.comparingInt(email -&gt; Integer.parseInt(email.headerValue(&quot;PR-Sequence&quot;))));
120 
121             if (last.isEmpty()) {
122                 throw new RuntimeException(&quot;Failed to find parent&quot;);
123             } else {
124                 return last.get();
125             }
126         }
127         return parent;
128     }
129 
<span class="line-modified">130     ReviewArchive(EmailAddress sender, PullRequestInstance prInstance, List&lt;Email&gt; sentMails, String nameDecoration) {</span>
131         this.sender = sender;
132         this.prInstance = prInstance;
<span class="line-modified">133         this.nameDecoration = nameDecoration;</span>
134 
135         existing = sentMails;
136         for (var email : existing) {
137             var stableIds = getStableMessageIds(email);
138             for (var stableId : stableIds) {
139                 existingIds.put(stableId, email);
140             }
141         }
142 
143         // Determine the latest hashes reported
144         reportedHeads = existing.stream()
145                                 .filter(email -&gt; email.hasHeader(&quot;PR-Head-Hash&quot;))
146                                 .map(email -&gt; email.headerValue(&quot;PR-Head-Hash&quot;))
147                                 .map(Hash::new)
148                                 .collect(Collectors.toList());
149         reportedBases = existing.stream()
150                                 .filter(email -&gt; email.hasHeader(&quot;PR-Base-Hash&quot;))
151                                 .map(email -&gt; email.headerValue(&quot;PR-Base-Hash&quot;))
152                                 .map(Hash::new)
153                                 .collect(Collectors.toList());
</pre>
<hr />
<pre>
291                              .id(id)
292                              .header(&quot;In-Reply-To&quot;, parent.id().toString())
293                              .header(&quot;References&quot;, references)
294                              .header(&quot;PR-Sequence&quot;, Integer.toString(existing.size() + generated.size()))
295                              .build();
296             generated.add(email);
297             generatedIds.put(getStableMessageId(id), email);
298         }
299     }
300 
301     void addComment(Comment comment) {
302         var id = getMessageId(comment);
303         if (existingIds.containsKey(getStableMessageId(id))) {
304             return;
305         }
306 
307         var parent = latestGeneralComment();
308         addReplyCommon(parent, comment.author(), &quot;Re: RFR: &quot; + prInstance.pr().getTitle(), comment.body(), id);
309     }
310 
<span class="line-modified">311     private String projectRole(Contributor contributor, CensusInstance censusInstance) {</span>
312         var version = censusInstance.configuration().census().version();
313         if (censusInstance.project().isLead(contributor.username(), version)) {
314             return &quot;Lead&quot;;
315         } else if (censusInstance.project().isReviewer(contributor.username(), version)) {
316             return &quot;Reviewer&quot;;
317         } else if (censusInstance.project().isCommitter(contributor.username(), version)) {
318             return &quot;Committer&quot;;
319         } else if (censusInstance.project().isAuthor(contributor.username(), version)) {
320             return &quot;Author&quot;;
321         }
322         return &quot;none&quot;;
323     }
324 
<span class="line-modified">325     void addReview(Review review, CensusInstance censusInstance) {</span>
326         var contributor = censusInstance.namespace().get(review.reviewer().id());
327 
328         // Post the review body as a regular comment
329         if (review.body().isPresent()) {
330             var id = getMessageId(review, false);
331             if (!existingIds.containsKey(getStableMessageId(id))) {
332                 var parent = topCommentForHash(review.hash());
333                 var userName = contributor != null ? contributor.username() : review.reviewer().userName() + &quot;@&quot; + censusInstance.namespace().name();
<span class="line-modified">334                 var userRole = contributor != null ? projectRole(contributor, censusInstance) : &quot;none&quot;;</span>
335                 var replyBody = ArchiveMessages.reviewCommentBody(review.body().get(), review.verdict(), userName, userRole);
336                 addReplyCommon(parent, review.reviewer(), &quot;Re: RFR: &quot; + prInstance.pr().getTitle(), replyBody, id);
337             }
338         }
339 
340         if (contributor != null) {
341             var isReviewer = censusInstance.project().isReviewer(contributor.username(), censusInstance.configuration().census().version());
342             if (review.verdict() == Review.Verdict.APPROVED &amp;&amp; isReviewer) {
343                 var id = getMessageId(review, true);
344                 if (!existingIds.containsKey(getStableMessageId(id))) {
345                     var parent = topEmail();
346                     var replyBody = ArchiveMessages.reviewApprovalBodyReviewer(contributor.username());
347                     addReplyCommon(parent, review.reviewer(), &quot;Approved and Reviewed by &quot; + contributor.username(), replyBody, id);
348                 }
349             }
350         }
351     }
352 
353     void addReviewComment(ReviewComment reviewComment) {
354         var id = getMessageId(reviewComment);
</pre>
</td>
<td>
<hr />
<pre>
  1 package org.openjdk.skara.bots.mlbridge;
  2 
  3 import org.openjdk.skara.census.Contributor;
  4 import org.openjdk.skara.email.*;
  5 import org.openjdk.skara.host.*;
  6 import org.openjdk.skara.vcs.Hash;
  7 
  8 import java.io.*;
  9 import java.net.URI;
 10 import java.nio.charset.StandardCharsets;
 11 import java.security.*;
 12 import java.util.*;
 13 import java.util.stream.*;
 14 
 15 class ReviewArchive {
 16     private final PullRequestInstance prInstance;
<span class="line-added"> 17     private final CensusInstance censusInstance;</span>
 18     private final EmailAddress sender;

 19     private final List&lt;Email&gt; existing;
 20     private final Map&lt;String, Email&gt; existingIds = new HashMap&lt;&gt;();
 21     private final List&lt;Email&gt; generated = new ArrayList&lt;&gt;();
 22     private final Map&lt;String, Email&gt; generatedIds = new HashMap&lt;&gt;();
 23     private final List&lt;Hash&gt; reportedHeads;
 24     private final List&lt;Hash&gt; reportedBases;
 25 
 26     private EmailAddress getAuthorAddress(HostUserDetails originalAuthor) {
<span class="line-modified"> 27         var contributor = censusInstance.namespace().get(originalAuthor.id());</span>
<span class="line-modified"> 28         if (contributor == null) {</span>
<span class="line-added"> 29             return EmailAddress.from(originalAuthor.fullName(),</span>
<span class="line-added"> 30                                      originalAuthor.id() + &quot;+&quot; + originalAuthor.userName() + &quot;@users.noreply.&quot; + censusInstance.namespace().name());</span>
<span class="line-added"> 31         } else {</span>
<span class="line-added"> 32             return EmailAddress.from(contributor.fullName().orElse(originalAuthor.fullName()),</span>
<span class="line-added"> 33                                      contributor.username() + &quot;@&quot; + censusInstance.configuration().census().domain());</span>
<span class="line-added"> 34         }</span>
 35     }
 36 
 37     private EmailAddress getUniqueMessageId(String identifier) {
 38         try {
 39             var prSpecific = prInstance.pr().repository().getName().replace(&quot;/&quot;, &quot;.&quot;) + &quot;.&quot; + prInstance.id();
 40             var digest = MessageDigest.getInstance(&quot;SHA-256&quot;);
 41             digest.update(prSpecific.getBytes(StandardCharsets.UTF_8));
 42             digest.update(identifier.getBytes(StandardCharsets.UTF_8));
 43             var encodedCommon = Base64.getUrlEncoder().encodeToString(digest.digest());
 44 
 45             return EmailAddress.from(encodedCommon + &quot;.&quot; + UUID.randomUUID() + &quot;@&quot; + prInstance.pr().repository().getUrl().getHost());
 46         } catch (NoSuchAlgorithmException e) {
 47             throw new RuntimeException(&quot;Cannot find SHA-256&quot;);
 48         }
 49     }
 50 
 51     private EmailAddress getMessageId() {
 52         return getUniqueMessageId(&quot;fc&quot;);
 53     }
 54 
</pre>
<hr />
<pre>
116     }
117 
118     private Email parentForReviewComment(ReviewComment reviewComment) {
119         var parent = topCommentForHash(reviewComment.hash());
120         if (reviewComment.parent().isPresent()) {
121             var parentId = getStableMessageId(getMessageId(reviewComment.parent().get()));
122             var last = Stream.concat(existing.stream(), generated.stream())
123                              .filter(email -&gt; (email.hasHeader(&quot;References&quot;) &amp;&amp; email.headerValue(&quot;References&quot;).contains(parentId)) ||
124                                      (getStableMessageId(email.id()).equals(parentId)))
125                              .max(Comparator.comparingInt(email -&gt; Integer.parseInt(email.headerValue(&quot;PR-Sequence&quot;))));
126 
127             if (last.isEmpty()) {
128                 throw new RuntimeException(&quot;Failed to find parent&quot;);
129             } else {
130                 return last.get();
131             }
132         }
133         return parent;
134     }
135 
<span class="line-modified">136     ReviewArchive(EmailAddress sender, PullRequestInstance prInstance, CensusInstance censusInstance, List&lt;Email&gt; sentMails) {</span>
137         this.sender = sender;
138         this.prInstance = prInstance;
<span class="line-modified">139         this.censusInstance = censusInstance;</span>
140 
141         existing = sentMails;
142         for (var email : existing) {
143             var stableIds = getStableMessageIds(email);
144             for (var stableId : stableIds) {
145                 existingIds.put(stableId, email);
146             }
147         }
148 
149         // Determine the latest hashes reported
150         reportedHeads = existing.stream()
151                                 .filter(email -&gt; email.hasHeader(&quot;PR-Head-Hash&quot;))
152                                 .map(email -&gt; email.headerValue(&quot;PR-Head-Hash&quot;))
153                                 .map(Hash::new)
154                                 .collect(Collectors.toList());
155         reportedBases = existing.stream()
156                                 .filter(email -&gt; email.hasHeader(&quot;PR-Base-Hash&quot;))
157                                 .map(email -&gt; email.headerValue(&quot;PR-Base-Hash&quot;))
158                                 .map(Hash::new)
159                                 .collect(Collectors.toList());
</pre>
<hr />
<pre>
297                              .id(id)
298                              .header(&quot;In-Reply-To&quot;, parent.id().toString())
299                              .header(&quot;References&quot;, references)
300                              .header(&quot;PR-Sequence&quot;, Integer.toString(existing.size() + generated.size()))
301                              .build();
302             generated.add(email);
303             generatedIds.put(getStableMessageId(id), email);
304         }
305     }
306 
307     void addComment(Comment comment) {
308         var id = getMessageId(comment);
309         if (existingIds.containsKey(getStableMessageId(id))) {
310             return;
311         }
312 
313         var parent = latestGeneralComment();
314         addReplyCommon(parent, comment.author(), &quot;Re: RFR: &quot; + prInstance.pr().getTitle(), comment.body(), id);
315     }
316 
<span class="line-modified">317     private String projectRole(Contributor contributor) {</span>
318         var version = censusInstance.configuration().census().version();
319         if (censusInstance.project().isLead(contributor.username(), version)) {
320             return &quot;Lead&quot;;
321         } else if (censusInstance.project().isReviewer(contributor.username(), version)) {
322             return &quot;Reviewer&quot;;
323         } else if (censusInstance.project().isCommitter(contributor.username(), version)) {
324             return &quot;Committer&quot;;
325         } else if (censusInstance.project().isAuthor(contributor.username(), version)) {
326             return &quot;Author&quot;;
327         }
328         return &quot;none&quot;;
329     }
330 
<span class="line-modified">331     void addReview(Review review) {</span>
332         var contributor = censusInstance.namespace().get(review.reviewer().id());
333 
334         // Post the review body as a regular comment
335         if (review.body().isPresent()) {
336             var id = getMessageId(review, false);
337             if (!existingIds.containsKey(getStableMessageId(id))) {
338                 var parent = topCommentForHash(review.hash());
339                 var userName = contributor != null ? contributor.username() : review.reviewer().userName() + &quot;@&quot; + censusInstance.namespace().name();
<span class="line-modified">340                 var userRole = contributor != null ? projectRole(contributor) : &quot;none&quot;;</span>
341                 var replyBody = ArchiveMessages.reviewCommentBody(review.body().get(), review.verdict(), userName, userRole);
342                 addReplyCommon(parent, review.reviewer(), &quot;Re: RFR: &quot; + prInstance.pr().getTitle(), replyBody, id);
343             }
344         }
345 
346         if (contributor != null) {
347             var isReviewer = censusInstance.project().isReviewer(contributor.username(), censusInstance.configuration().census().version());
348             if (review.verdict() == Review.Verdict.APPROVED &amp;&amp; isReviewer) {
349                 var id = getMessageId(review, true);
350                 if (!existingIds.containsKey(getStableMessageId(id))) {
351                     var parent = topEmail();
352                     var replyBody = ArchiveMessages.reviewApprovalBodyReviewer(contributor.username());
353                     addReplyCommon(parent, review.reviewer(), &quot;Approved and Reviewed by &quot; + contributor.username(), replyBody, id);
354                 }
355             }
356         }
357     }
358 
359     void addReviewComment(ReviewComment reviewComment) {
360         var id = getMessageId(reviewComment);
</pre>
</td>
</tr>
</table>
<center><a href="MailingListArchiveReaderBot.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>