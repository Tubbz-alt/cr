<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/mlbridge/ReviewArchive.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.mlbridge;
  24 
  25 import org.openjdk.skara.email.EmailAddress;
<span class="line-modified">  26 import org.openjdk.skara.host.Review;</span>
  27 import org.openjdk.skara.host.network.URIBuilder;
  28 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  29 import org.openjdk.skara.test.*;
  30 import org.openjdk.skara.vcs.Repository;
  31 
  32 import org.junit.jupiter.api.*;
  33 
  34 import java.io.IOException;
  35 import java.nio.charset.StandardCharsets;
  36 import java.nio.file.*;
  37 import java.time.Duration;
  38 import java.util.*;
  39 import java.util.regex.Pattern;
  40 import java.util.stream.Collectors;
  41 
  42 import static org.junit.jupiter.api.Assertions.*;
  43 
  44 class MailingListBridgeBotTests {
  45     private boolean archiveContains(Path archive, String text) {
  46         return archiveContainsCount(archive, text) &gt; 0;
</pre>
<hr />
<pre>
  67         }
  68     }
  69 
  70     private boolean webrevContains(Path webrev, String text) {
  71         try {
  72             var index = Files.find(webrev, 5, (path, attrs) -&gt; path.toString().endsWith(&quot;index.html&quot;)).findAny();
  73             if (index.isEmpty()) {
  74                 return false;
  75             }
  76             var lines = Files.readString(index.get(), StandardCharsets.UTF_8);
  77             return lines.contains(text);
  78         } catch (IOException e) {
  79             return false;
  80         }
  81     }
  82 
  83     private long countSubstrings(String string, String substring) {
  84         return Pattern.compile(substring).matcher(string).results().count();
  85     }
  86 






  87     @Test
  88     void simpleArchive(TestInfo testInfo) throws IOException {
  89         try (var credentials = new HostCredentials(testInfo);
  90              var tempFolder = new TemporaryDirectory();
  91              var archiveFolder = new TemporaryDirectory();
  92              var webrevFolder = new TemporaryDirectory();
  93              var listServer = new TestMailmanServer()) {
  94             var author = credentials.getHostedRepository();
  95             var archive = credentials.getHostedRepository();
  96             var ignored = credentials.getHostedRepository();
  97             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
  98             var censusBuilder = credentials.getCensusBuilder()
  99                                            .addAuthor(author.host().getCurrentUserDetails().id());
 100             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 101             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,
 102                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 103                                                  Set.of(),
 104                                                  listServer.getArchive(), listServer.getSMTP(),
 105                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 106                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
</pre>
<hr />
<pre>
 159             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 160             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 161             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
 162             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
 163             assertTrue(archiveContains(archiveFolder.path(), &quot;Pull request:&quot;));
 164             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
 165             assertTrue(archiveContains(archiveFolder.path(), &quot;http://www.test.test/&quot;));
 166             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));
 167             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch command:&quot;));
 168             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - &quot; + editHash.abbreviate() + &quot;:\tChange msg&quot;));
 169             assertTrue(archiveContains(archiveFolder.path(), &quot;^\t\t\tWith several lines&quot;));
 170 
 171             // The mailing list as well
 172             listServer.processIncoming();
 173             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 174             var mailmanList = mailmanServer.getList(listAddress.address());
 175             var conversations = mailmanList.conversations(Duration.ofDays(1));
 176             assertEquals(1, conversations.size());
 177             var mail = conversations.get(0).first();
 178             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
<span class="line-modified"> 179             assertEquals(pr.getAuthor().fullName() + &quot; via &quot; + pr.repository().getUrl().getHost(), mail.author().fullName().orElseThrow());</span>
<span class="line-modified"> 180             assertEquals(from.address(), mail.author().address());</span>
 181             assertEquals(from, mail.sender());
 182 
 183             // And there should be a webrev
 184             Repository.materialize(webrevFolder.path(), archive.getUrl(), &quot;webrev&quot;);
 185             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
 186             var comments = pr.getComments();
 187             var webrevComments = comments.stream()
 188                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 189                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 190                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 191                                          .collect(Collectors.toList());
 192             assertEquals(1, webrevComments.size());
 193 
 194             // Add a comment
 195             pr.addComment(&quot;This is a comment :smile:&quot;);
 196 
 197             // Add a comment from an ignored user as well
 198             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);
 199 
 200             // Run another archive pass
</pre>
<hr />
<pre>
 211             assertEquals(1, conversations.size());
 212             assertEquals(2, conversations.get(0).allMessages().size());
 213 
 214             // Remove the rfr flag and post another comment
 215             pr.addLabel(&quot;rfr&quot;);
 216             pr.addComment(&quot;This is another comment&quot;);
 217 
 218             // Run another archive pass
 219             TestBotRunner.runPeriodicItems(mlBot);
 220 
 221             // The archive should contain the additional comment
 222             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 223             assertTrue(archiveContains(archiveFolder.path(), &quot;This is another comment&quot;));
 224             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This should now be ready&quot;));
 225 
 226             listServer.processIncoming();
 227             conversations = mailmanList.conversations(Duration.ofDays(1));
 228             assertEquals(1, conversations.size());
 229             assertEquals(3, conversations.get(0).allMessages().size());
 230             for (var newMail : conversations.get(0).allMessages()) {
<span class="line-modified"> 231                 assertEquals(from.address(), newMail.author().address());</span>
 232                 assertEquals(from, newMail.sender());
 233             }
 234             assertTrue(conversations.get(0).allMessages().get(2).body().contains(&quot;This is a comment ðŸ˜„&quot;));
 235         }
 236     }
 237 
 238     @Test
 239     void reviewComment(TestInfo testInfo) throws IOException {
 240         try (var credentials = new HostCredentials(testInfo);
 241              var tempFolder = new TemporaryDirectory();
 242              var archiveFolder = new TemporaryDirectory();
 243              var listServer = new TestMailmanServer()) {
 244             var author = credentials.getHostedRepository();
 245             var archive = credentials.getHostedRepository();
 246             var ignored = credentials.getHostedRepository();
 247             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 248             var censusBuilder = credentials.getCensusBuilder()
 249                                            .addAuthor(author.host().getCurrentUserDetails().id());
 250             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 251             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,
</pre>
<hr />
<pre>
 298             var conversations = mailmanList.conversations(Duration.ofDays(1));
 299             assertEquals(1, conversations.size());
 300             var mail = conversations.get(0).first();
 301             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 302 
 303             // Comment on the comment
 304             pr.addReviewCommentReply(comment, &quot;This is a review reply&quot;);
 305             TestBotRunner.runPeriodicItems(mlBot);
 306             listServer.processIncoming();
 307 
 308             // The archive should contain the additional comment
 309             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 310             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a review reply&quot;));
 311             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This is now ready&quot;));
 312 
 313             // As well as the mailing list
 314             conversations = mailmanList.conversations(Duration.ofDays(1));
 315             assertEquals(1, conversations.size());
 316             assertEquals(3, conversations.get(0).allMessages().size());
 317             for (var newMail : conversations.get(0).allMessages()) {
<span class="line-modified"> 318                 assertEquals(from.address(), newMail.author().address());</span>
 319                 assertEquals(from, newMail.sender());
 320             }
 321         }
 322     }
 323 
 324     @Test
 325     void combineComments(TestInfo testInfo) throws IOException {
 326         try (var credentials = new HostCredentials(testInfo);
 327              var tempFolder = new TemporaryDirectory();
 328              var archiveFolder = new TemporaryDirectory();
 329              var listServer = new TestMailmanServer()) {
 330             var author = credentials.getHostedRepository();
 331             var archive = credentials.getHostedRepository();
 332             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 333             var censusBuilder = credentials.getCensusBuilder()
 334                                            .addAuthor(author.host().getCurrentUserDetails().id());
 335             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 336             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 337                                                  listAddress, Set.of(), Set.of(),
 338                                                  listServer.getArchive(),
</pre>
<hr />
<pre>
 445             assertEquals(6, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 446 
 447             // Check the mailing list
 448             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 449             var mailmanList = mailmanServer.getList(listAddress.address());
 450             var conversations = mailmanList.conversations(Duration.ofDays(1));
 451             assertEquals(1, conversations.size());
 452             var mail = conversations.get(0).first();
 453             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 454             assertEquals(7, conversations.get(0).allMessages().size());
 455 
 456             // There should be two separate threads
 457             var thread1 = conversations.get(0).replies(mail).get(0);
 458             assertEquals(2, thread1.body().split(&quot;^On.*wrote:&quot;).length);
 459             assertEquals(2, thread1.body().split(&quot;&gt; This is now ready&quot;).length, thread1.body());
 460             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread1.subject());
 461             assertTrue(thread1.body().contains(&quot;Review comment\n\n&quot;), thread1.body());
 462             assertFalse(thread1.body().contains(&quot;Another review comment&quot;), thread1.body());
 463             var thread1reply1 = conversations.get(0).replies(thread1).get(0);
 464             assertTrue(thread1reply1.body().contains(&quot;I agree&quot;));


 465             var thread1reply2 = conversations.get(0).replies(thread1reply1).get(0);
 466             assertTrue(thread1reply2.body().contains(&quot;Great&quot;));


 467 
 468             var thread2 = conversations.get(0).replies(mail).get(1);
 469             assertEquals(2, thread2.body().split(&quot;^On.*wrote:&quot;).length);
 470             assertEquals(2, thread2.body().split(&quot;&gt; This is now ready&quot;).length, thread2.body());
 471             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread2.subject());
 472             assertFalse(thread2.body().contains(&quot;Review comment\n\n&quot;), thread2.body());
 473             assertTrue(thread2.body().contains(&quot;Another review comment&quot;), thread2.body());
 474             var thread2reply1 = conversations.get(0).replies(thread2).get(0);
 475             assertTrue(thread2reply1.body().contains(&quot;Sounds good&quot;));
 476             var thread2reply2 = conversations.get(0).replies(thread2reply1).get(0);
 477             assertTrue(thread2reply2.body().contains(&quot;Thanks&quot;));
 478         }
 479     }
 480 
 481     @Test
 482     void reviewContext(TestInfo testInfo) throws IOException {
 483         try (var credentials = new HostCredentials(testInfo);
 484              var tempFolder = new TemporaryDirectory();
 485              var archiveFolder = new TemporaryDirectory();
 486              var listServer = new TestMailmanServer()) {
</pre>
<hr />
<pre>
 714             assertTrue(archiveContains(archiveFolder.path(), &quot;Updated full patch&quot;));
 715             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
 716             assertTrue(archiveContains(archiveFolder.path(), &quot;Fixing&quot;));
 717 
 718             // The webrev comment should be updated
 719             var comments = pr.getComments();
 720             var webrevComments = comments.stream()
 721                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 722                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 723                                          .filter(comment -&gt; comment.body().contains(nextHash.hex()))
 724                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 725                                          .collect(Collectors.toList());
 726             assertEquals(1, webrevComments.size());
 727 
 728             // Check that sender address is set properly
 729             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 730             var mailmanList = mailmanServer.getList(listAddress.address());
 731             var conversations = mailmanList.conversations(Duration.ofDays(1));
 732             assertEquals(1, conversations.size());
 733             for (var newMail : conversations.get(0).allMessages()) {
<span class="line-modified"> 734                 assertEquals(from.address(), newMail.author().address());</span>
 735                 assertEquals(from, newMail.sender());
 736             }
 737 
 738             // Ensure that additional updates are only reported once
 739             for (int i = 0; i &lt; 3; ++i) {
 740                 var anotherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fixing&quot;);
 741                 localRepo.push(anotherHash, author.getUrl(), &quot;edit&quot;);
 742 
 743                 // Make sure that the push registered
 744                 lastHeadHash = pr.getHeadHash();
 745                 refreshCount = 0;
 746                 do {
 747                     pr = author.getPullRequest(pr.getId());
 748                     if (refreshCount++ &gt; 100) {
 749                         fail(&quot;The PR did not update after the new push&quot;);
 750                     }
 751                 } while (pr.getHeadHash().equals(lastHeadHash));
 752 
 753                 TestBotRunner.runPeriodicItems(mlBot);
 754                 TestBotRunner.runPeriodicItems(mlBot);
 755                 listServer.processIncoming();
 756             }
 757             var updatedConversations = mailmanList.conversations(Duration.ofDays(1));
 758             assertEquals(1, updatedConversations.size());
 759             var conversation = updatedConversations.get(0);
 760             assertEquals(5, conversation.allMessages().size());
 761         }
 762     }
 763 
 764     @Test
 765     void rebased(TestInfo testInfo) throws IOException {
 766         try (var credentials = new HostCredentials(testInfo);
 767              var tempFolder = new TemporaryDirectory();
 768              var archiveFolder = new TemporaryDirectory();
 769              var listServer = new TestMailmanServer()) {
 770             var author = credentials.getHostedRepository();
 771             var archive = credentials.getHostedRepository();
 772             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 773             var censusBuilder = credentials.getCensusBuilder()
 774                                            .addAuthor(author.host().getCurrentUserDetails().id());
<span class="line-modified"> 775             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);</span>
<span class="line-modified"> 776             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,</span>
 777                                                  listAddress, Set.of(), Set.of(),
 778                                                  listServer.getArchive(), listServer.getSMTP(),
 779                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 780                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 781                                                  Set.of(), Map.of());
 782 
 783             // Populate the projects repository
 784             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 785             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.getRepositoryType(), reviewFile);
 786             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 787             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 788             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 789 
 790             // Make a change with a corresponding PR
 791             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
 792             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 793             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 794             pr.setBody(&quot;This is now ready&quot;);
 795 
 796             // Run an archive pass
</pre>
<hr />
<pre>
 823             assertTrue(archiveContains(archiveFolder.path(), &quot;Updated full patch&quot;));
 824             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
 825             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
 826             assertTrue(archiveContains(archiveFolder.path(), &quot;Replaced msg&quot;));
 827 
 828             // The webrev comment should be updated
 829             var comments = pr.getComments();
 830             var webrevComments = comments.stream()
 831                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 832                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 833                                          .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
 834                                          .collect(Collectors.toList());
 835             assertEquals(1, webrevComments.size());
 836 
 837             // Check that sender address is set properly
 838             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 839             var mailmanList = mailmanServer.getList(listAddress.address());
 840             var conversations = mailmanList.conversations(Duration.ofDays(1));
 841             assertEquals(1, conversations.size());
 842             for (var newMail : conversations.get(0).allMessages()) {
<span class="line-modified"> 843                 assertEquals(from.address(), newMail.author().address());</span>
<span class="line-modified"> 844                 assertEquals(from, newMail.sender());</span>
 845             }
 846         }
 847     }
 848 
 849     @Test
 850     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
 851         try (var credentials = new HostCredentials(testInfo);
 852              var tempFolder = new TemporaryDirectory();
 853              var archiveFolder = new TemporaryDirectory();
 854              var webrevFolder = new TemporaryDirectory();
 855              var listServer = new TestMailmanServer()) {
 856             var author = credentials.getHostedRepository();
 857             var archive = credentials.getHostedRepository();
 858             var ignored = credentials.getHostedRepository();
 859             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 860             var censusBuilder = credentials.getCensusBuilder()
 861                                            .addAuthor(author.host().getCurrentUserDetails().id());
 862             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 863             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 864                                                  listAddress,
</pre>
</td>
<td>
<hr />
<pre>
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.mlbridge;
  24 
  25 import org.openjdk.skara.email.EmailAddress;
<span class="line-modified">  26 import org.openjdk.skara.host.*;</span>
  27 import org.openjdk.skara.host.network.URIBuilder;
  28 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  29 import org.openjdk.skara.test.*;
  30 import org.openjdk.skara.vcs.Repository;
  31 
  32 import org.junit.jupiter.api.*;
  33 
  34 import java.io.IOException;
  35 import java.nio.charset.StandardCharsets;
  36 import java.nio.file.*;
  37 import java.time.Duration;
  38 import java.util.*;
  39 import java.util.regex.Pattern;
  40 import java.util.stream.Collectors;
  41 
  42 import static org.junit.jupiter.api.Assertions.*;
  43 
  44 class MailingListBridgeBotTests {
  45     private boolean archiveContains(Path archive, String text) {
  46         return archiveContainsCount(archive, text) &gt; 0;
</pre>
<hr />
<pre>
  67         }
  68     }
  69 
  70     private boolean webrevContains(Path webrev, String text) {
  71         try {
  72             var index = Files.find(webrev, 5, (path, attrs) -&gt; path.toString().endsWith(&quot;index.html&quot;)).findAny();
  73             if (index.isEmpty()) {
  74                 return false;
  75             }
  76             var lines = Files.readString(index.get(), StandardCharsets.UTF_8);
  77             return lines.contains(text);
  78         } catch (IOException e) {
  79             return false;
  80         }
  81     }
  82 
  83     private long countSubstrings(String string, String substring) {
  84         return Pattern.compile(substring).matcher(string).results().count();
  85     }
  86 
<span class="line-added">  87     private String noreplyAddress(HostedRepository repository) {</span>
<span class="line-added">  88         return repository.host().getCurrentUserDetails().id() + &quot;+&quot; +</span>
<span class="line-added">  89                 repository.host().getCurrentUserDetails().userName() +</span>
<span class="line-added">  90                 &quot;@users.noreply.test&quot;;</span>
<span class="line-added">  91     }</span>
<span class="line-added">  92 </span>
  93     @Test
  94     void simpleArchive(TestInfo testInfo) throws IOException {
  95         try (var credentials = new HostCredentials(testInfo);
  96              var tempFolder = new TemporaryDirectory();
  97              var archiveFolder = new TemporaryDirectory();
  98              var webrevFolder = new TemporaryDirectory();
  99              var listServer = new TestMailmanServer()) {
 100             var author = credentials.getHostedRepository();
 101             var archive = credentials.getHostedRepository();
 102             var ignored = credentials.getHostedRepository();
 103             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 104             var censusBuilder = credentials.getCensusBuilder()
 105                                            .addAuthor(author.host().getCurrentUserDetails().id());
 106             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 107             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,
 108                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 109                                                  Set.of(),
 110                                                  listServer.getArchive(), listServer.getSMTP(),
 111                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 112                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
</pre>
<hr />
<pre>
 165             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 166             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 167             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
 168             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
 169             assertTrue(archiveContains(archiveFolder.path(), &quot;Pull request:&quot;));
 170             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
 171             assertTrue(archiveContains(archiveFolder.path(), &quot;http://www.test.test/&quot;));
 172             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));
 173             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch command:&quot;));
 174             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - &quot; + editHash.abbreviate() + &quot;:\tChange msg&quot;));
 175             assertTrue(archiveContains(archiveFolder.path(), &quot;^\t\t\tWith several lines&quot;));
 176 
 177             // The mailing list as well
 178             listServer.processIncoming();
 179             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 180             var mailmanList = mailmanServer.getList(listAddress.address());
 181             var conversations = mailmanList.conversations(Duration.ofDays(1));
 182             assertEquals(1, conversations.size());
 183             var mail = conversations.get(0).first();
 184             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
<span class="line-modified"> 185             assertEquals(pr.getAuthor().fullName(), mail.author().fullName().orElseThrow());</span>
<span class="line-modified"> 186             assertEquals(noreplyAddress(archive), mail.author().address());</span>
 187             assertEquals(from, mail.sender());
 188 
 189             // And there should be a webrev
 190             Repository.materialize(webrevFolder.path(), archive.getUrl(), &quot;webrev&quot;);
 191             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
 192             var comments = pr.getComments();
 193             var webrevComments = comments.stream()
 194                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 195                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 196                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 197                                          .collect(Collectors.toList());
 198             assertEquals(1, webrevComments.size());
 199 
 200             // Add a comment
 201             pr.addComment(&quot;This is a comment :smile:&quot;);
 202 
 203             // Add a comment from an ignored user as well
 204             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);
 205 
 206             // Run another archive pass
</pre>
<hr />
<pre>
 217             assertEquals(1, conversations.size());
 218             assertEquals(2, conversations.get(0).allMessages().size());
 219 
 220             // Remove the rfr flag and post another comment
 221             pr.addLabel(&quot;rfr&quot;);
 222             pr.addComment(&quot;This is another comment&quot;);
 223 
 224             // Run another archive pass
 225             TestBotRunner.runPeriodicItems(mlBot);
 226 
 227             // The archive should contain the additional comment
 228             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 229             assertTrue(archiveContains(archiveFolder.path(), &quot;This is another comment&quot;));
 230             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This should now be ready&quot;));
 231 
 232             listServer.processIncoming();
 233             conversations = mailmanList.conversations(Duration.ofDays(1));
 234             assertEquals(1, conversations.size());
 235             assertEquals(3, conversations.get(0).allMessages().size());
 236             for (var newMail : conversations.get(0).allMessages()) {
<span class="line-modified"> 237                 assertEquals(noreplyAddress(archive), newMail.author().address());</span>
 238                 assertEquals(from, newMail.sender());
 239             }
 240             assertTrue(conversations.get(0).allMessages().get(2).body().contains(&quot;This is a comment ðŸ˜„&quot;));
 241         }
 242     }
 243 
 244     @Test
 245     void reviewComment(TestInfo testInfo) throws IOException {
 246         try (var credentials = new HostCredentials(testInfo);
 247              var tempFolder = new TemporaryDirectory();
 248              var archiveFolder = new TemporaryDirectory();
 249              var listServer = new TestMailmanServer()) {
 250             var author = credentials.getHostedRepository();
 251             var archive = credentials.getHostedRepository();
 252             var ignored = credentials.getHostedRepository();
 253             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 254             var censusBuilder = credentials.getCensusBuilder()
 255                                            .addAuthor(author.host().getCurrentUserDetails().id());
 256             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 257             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,
</pre>
<hr />
<pre>
 304             var conversations = mailmanList.conversations(Duration.ofDays(1));
 305             assertEquals(1, conversations.size());
 306             var mail = conversations.get(0).first();
 307             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 308 
 309             // Comment on the comment
 310             pr.addReviewCommentReply(comment, &quot;This is a review reply&quot;);
 311             TestBotRunner.runPeriodicItems(mlBot);
 312             listServer.processIncoming();
 313 
 314             // The archive should contain the additional comment
 315             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 316             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a review reply&quot;));
 317             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This is now ready&quot;));
 318 
 319             // As well as the mailing list
 320             conversations = mailmanList.conversations(Duration.ofDays(1));
 321             assertEquals(1, conversations.size());
 322             assertEquals(3, conversations.get(0).allMessages().size());
 323             for (var newMail : conversations.get(0).allMessages()) {
<span class="line-modified"> 324                 assertEquals(noreplyAddress(archive), newMail.author().address());</span>
 325                 assertEquals(from, newMail.sender());
 326             }
 327         }
 328     }
 329 
 330     @Test
 331     void combineComments(TestInfo testInfo) throws IOException {
 332         try (var credentials = new HostCredentials(testInfo);
 333              var tempFolder = new TemporaryDirectory();
 334              var archiveFolder = new TemporaryDirectory();
 335              var listServer = new TestMailmanServer()) {
 336             var author = credentials.getHostedRepository();
 337             var archive = credentials.getHostedRepository();
 338             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 339             var censusBuilder = credentials.getCensusBuilder()
 340                                            .addAuthor(author.host().getCurrentUserDetails().id());
 341             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 342             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 343                                                  listAddress, Set.of(), Set.of(),
 344                                                  listServer.getArchive(),
</pre>
<hr />
<pre>
 451             assertEquals(6, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 452 
 453             // Check the mailing list
 454             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 455             var mailmanList = mailmanServer.getList(listAddress.address());
 456             var conversations = mailmanList.conversations(Duration.ofDays(1));
 457             assertEquals(1, conversations.size());
 458             var mail = conversations.get(0).first();
 459             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 460             assertEquals(7, conversations.get(0).allMessages().size());
 461 
 462             // There should be two separate threads
 463             var thread1 = conversations.get(0).replies(mail).get(0);
 464             assertEquals(2, thread1.body().split(&quot;^On.*wrote:&quot;).length);
 465             assertEquals(2, thread1.body().split(&quot;&gt; This is now ready&quot;).length, thread1.body());
 466             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread1.subject());
 467             assertTrue(thread1.body().contains(&quot;Review comment\n\n&quot;), thread1.body());
 468             assertFalse(thread1.body().contains(&quot;Another review comment&quot;), thread1.body());
 469             var thread1reply1 = conversations.get(0).replies(thread1).get(0);
 470             assertTrue(thread1reply1.body().contains(&quot;I agree&quot;));
<span class="line-added"> 471             assertEquals(noreplyAddress(archive), thread1reply1.author().address());</span>
<span class="line-added"> 472             assertEquals(archive.host().getCurrentUserDetails().fullName(), thread1reply1.author().fullName().orElseThrow());</span>
 473             var thread1reply2 = conversations.get(0).replies(thread1reply1).get(0);
 474             assertTrue(thread1reply2.body().contains(&quot;Great&quot;));
<span class="line-added"> 475             assertEquals(&quot;integrationreviewer1@openjdk.java.net&quot;, thread1reply2.author().address());</span>
<span class="line-added"> 476             assertEquals(&quot;Generated Reviewer 1&quot;, thread1reply2.author().fullName().orElseThrow());</span>
 477 
 478             var thread2 = conversations.get(0).replies(mail).get(1);
 479             assertEquals(2, thread2.body().split(&quot;^On.*wrote:&quot;).length);
 480             assertEquals(2, thread2.body().split(&quot;&gt; This is now ready&quot;).length, thread2.body());
 481             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread2.subject());
 482             assertFalse(thread2.body().contains(&quot;Review comment\n\n&quot;), thread2.body());
 483             assertTrue(thread2.body().contains(&quot;Another review comment&quot;), thread2.body());
 484             var thread2reply1 = conversations.get(0).replies(thread2).get(0);
 485             assertTrue(thread2reply1.body().contains(&quot;Sounds good&quot;));
 486             var thread2reply2 = conversations.get(0).replies(thread2reply1).get(0);
 487             assertTrue(thread2reply2.body().contains(&quot;Thanks&quot;));
 488         }
 489     }
 490 
 491     @Test
 492     void reviewContext(TestInfo testInfo) throws IOException {
 493         try (var credentials = new HostCredentials(testInfo);
 494              var tempFolder = new TemporaryDirectory();
 495              var archiveFolder = new TemporaryDirectory();
 496              var listServer = new TestMailmanServer()) {
</pre>
<hr />
<pre>
 724             assertTrue(archiveContains(archiveFolder.path(), &quot;Updated full patch&quot;));
 725             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
 726             assertTrue(archiveContains(archiveFolder.path(), &quot;Fixing&quot;));
 727 
 728             // The webrev comment should be updated
 729             var comments = pr.getComments();
 730             var webrevComments = comments.stream()
 731                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 732                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 733                                          .filter(comment -&gt; comment.body().contains(nextHash.hex()))
 734                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 735                                          .collect(Collectors.toList());
 736             assertEquals(1, webrevComments.size());
 737 
 738             // Check that sender address is set properly
 739             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 740             var mailmanList = mailmanServer.getList(listAddress.address());
 741             var conversations = mailmanList.conversations(Duration.ofDays(1));
 742             assertEquals(1, conversations.size());
 743             for (var newMail : conversations.get(0).allMessages()) {
<span class="line-modified"> 744                 assertEquals(noreplyAddress(archive), newMail.author().address());</span>
 745                 assertEquals(from, newMail.sender());
 746             }
 747 
 748             // Ensure that additional updates are only reported once
 749             for (int i = 0; i &lt; 3; ++i) {
 750                 var anotherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fixing&quot;);
 751                 localRepo.push(anotherHash, author.getUrl(), &quot;edit&quot;);
 752 
 753                 // Make sure that the push registered
 754                 lastHeadHash = pr.getHeadHash();
 755                 refreshCount = 0;
 756                 do {
 757                     pr = author.getPullRequest(pr.getId());
 758                     if (refreshCount++ &gt; 100) {
 759                         fail(&quot;The PR did not update after the new push&quot;);
 760                     }
 761                 } while (pr.getHeadHash().equals(lastHeadHash));
 762 
 763                 TestBotRunner.runPeriodicItems(mlBot);
 764                 TestBotRunner.runPeriodicItems(mlBot);
 765                 listServer.processIncoming();
 766             }
 767             var updatedConversations = mailmanList.conversations(Duration.ofDays(1));
 768             assertEquals(1, updatedConversations.size());
 769             var conversation = updatedConversations.get(0);
 770             assertEquals(5, conversation.allMessages().size());
 771         }
 772     }
 773 
 774     @Test
 775     void rebased(TestInfo testInfo) throws IOException {
 776         try (var credentials = new HostCredentials(testInfo);
 777              var tempFolder = new TemporaryDirectory();
 778              var archiveFolder = new TemporaryDirectory();
 779              var listServer = new TestMailmanServer()) {
 780             var author = credentials.getHostedRepository();
 781             var archive = credentials.getHostedRepository();
 782             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 783             var censusBuilder = credentials.getCensusBuilder()
 784                                            .addAuthor(author.host().getCurrentUserDetails().id());
<span class="line-modified"> 785             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);</span>
<span class="line-modified"> 786             var mlBot = new MailingListBridgeBot(sender, author, archive, censusBuilder.build(), &quot;master&quot;,</span>
 787                                                  listAddress, Set.of(), Set.of(),
 788                                                  listServer.getArchive(), listServer.getSMTP(),
 789                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 790                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 791                                                  Set.of(), Map.of());
 792 
 793             // Populate the projects repository
 794             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 795             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.getRepositoryType(), reviewFile);
 796             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 797             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 798             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 799 
 800             // Make a change with a corresponding PR
 801             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
 802             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 803             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 804             pr.setBody(&quot;This is now ready&quot;);
 805 
 806             // Run an archive pass
</pre>
<hr />
<pre>
 833             assertTrue(archiveContains(archiveFolder.path(), &quot;Updated full patch&quot;));
 834             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
 835             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
 836             assertTrue(archiveContains(archiveFolder.path(), &quot;Replaced msg&quot;));
 837 
 838             // The webrev comment should be updated
 839             var comments = pr.getComments();
 840             var webrevComments = comments.stream()
 841                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 842                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 843                                          .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
 844                                          .collect(Collectors.toList());
 845             assertEquals(1, webrevComments.size());
 846 
 847             // Check that sender address is set properly
 848             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 849             var mailmanList = mailmanServer.getList(listAddress.address());
 850             var conversations = mailmanList.conversations(Duration.ofDays(1));
 851             assertEquals(1, conversations.size());
 852             for (var newMail : conversations.get(0).allMessages()) {
<span class="line-modified"> 853                 assertEquals(noreplyAddress(archive), newMail.author().address());</span>
<span class="line-modified"> 854                 assertEquals(sender, newMail.sender());</span>
 855             }
 856         }
 857     }
 858 
 859     @Test
 860     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
 861         try (var credentials = new HostCredentials(testInfo);
 862              var tempFolder = new TemporaryDirectory();
 863              var archiveFolder = new TemporaryDirectory();
 864              var webrevFolder = new TemporaryDirectory();
 865              var listServer = new TestMailmanServer()) {
 866             var author = credentials.getHostedRepository();
 867             var archive = credentials.getHostedRepository();
 868             var ignored = credentials.getHostedRepository();
 869             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 870             var censusBuilder = credentials.getCensusBuilder()
 871                                            .addAuthor(author.host().getCurrentUserDetails().id());
 872             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 873             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 874                                                  listAddress,
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/mlbridge/ReviewArchive.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>