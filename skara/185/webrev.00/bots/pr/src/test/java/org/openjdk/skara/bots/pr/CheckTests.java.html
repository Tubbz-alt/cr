<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New bots/pr/src/test/java/org/openjdk/skara/bots/pr/CheckTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.bots.pr;
 24 
 25 import org.openjdk.skara.host.*;
 26 import org.openjdk.skara.test.*;
 27 
 28 import org.junit.jupiter.api.*;
 29 
 30 import java.io.IOException;
 31 import java.nio.file.*;
 32 import java.util.*;
 33 import java.util.regex.Pattern;
 34 
 35 import static org.junit.jupiter.api.Assertions.*;
 36 import static org.junit.jupiter.api.Assumptions.assumeTrue;
 37 
 38 class CheckTests {
 39     @Test
 40     void simpleCommit(TestInfo testInfo) throws IOException {
 41         try (var credentials = new HostCredentials(testInfo);
 42              var tempFolder = new TemporaryDirectory()) {
 43             var author = credentials.getHostedRepository();
 44             var reviewer = credentials.getHostedRepository();
 45 
 46             var censusBuilder = credentials.getCensusBuilder()
 47                                            .addAuthor(author.host().getCurrentUserDetails().id())
 48                                            .addReviewer(reviewer.host().getCurrentUserDetails().id());
 49             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
 50 
 51             // Populate the projects repository
 52             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
 53             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 54             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 55 
 56             // Make a change with a corresponding PR
 57             var editHash = CheckableRepository.appendAndCommit(localRepo);
 58             localRepo.push(editHash, author.getUrl(), &quot;refs/heads/edit&quot;, true);
 59             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 60 
 61             // Check the status
 62             TestBotRunner.runPeriodicItems(checkBot);
 63 
 64             // Verify that the check succeeded
 65             var checks = pr.getChecks(editHash);
 66             assertEquals(1, checks.size());
 67             var check = checks.get(&quot;jcheck&quot;);
 68             assertEquals(CheckStatus.SUCCESS, check.status());
 69 
 70             // The PR should now be ready for review
 71             assertTrue(pr.getLabels().contains(&quot;rfr&quot;));
 72             assertFalse(pr.getLabels().contains(&quot;ready&quot;));
 73 
 74             // Approve it as another user
 75             var approvalPr = reviewer.getPullRequest(pr.getId());
 76             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 77 
 78             // Check the status again
 79             TestBotRunner.runPeriodicItems(checkBot);
 80 
 81             // The check should now be successful
 82             checks = pr.getChecks(editHash);
 83             assertEquals(1, checks.size());
 84             check = checks.get(&quot;jcheck&quot;);
 85             assertEquals(CheckStatus.SUCCESS, check.status());
 86 
 87             // The PR should not be flagged as ready for review, at it is already reviewed
 88             assertFalse(pr.getLabels().contains(&quot;rfr&quot;));
 89             assertTrue(pr.getLabels().contains(&quot;ready&quot;));
 90         }
 91     }
 92 
 93     @Test
 94     void whitespaceIssue(TestInfo testInfo) throws IOException {
 95         try (var credentials = new HostCredentials(testInfo);
 96              var tempFolder = new TemporaryDirectory()) {
 97 
 98             var author = credentials.getHostedRepository();
 99             var reviewer = credentials.getHostedRepository();
100 
101             var censusBuilder = credentials.getCensusBuilder()
102                                            .addAuthor(author.host().getCurrentUserDetails().id())
103                                            .addReviewer(reviewer.host().getCurrentUserDetails().id());
104             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
105 
106             // Populate the projects repository
107             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
108             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
109             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
110 
111             // Make a change with a corresponding PR
112             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line with a trailing whitespace   &quot;);
113             localRepo.push(editHash, author.getUrl(), &quot;refs/heads/edit&quot;, true);
114             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
115 
116             // Check the status
117             TestBotRunner.runPeriodicItems(checkBot);
118 
119             // The PR should not be flagged as ready for review
120             assertFalse(pr.getLabels().contains(&quot;rfr&quot;));
121 
122             // Approve it as another user
123             var approvalPr = reviewer.getPullRequest(pr.getId());
124             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
125 
126             // Check the status
127             TestBotRunner.runPeriodicItems(checkBot);
128 
129             // Verify that the check failed
130             var checks = pr.getChecks(editHash);
131             assertEquals(1, checks.size());
132             var check = checks.get(&quot;jcheck&quot;);
133             assertEquals(CheckStatus.FAILURE, check.status());
134 
135             // The PR should not still not be flagged as ready for review
136             assertFalse(pr.getLabels().contains(&quot;rfr&quot;));
137 
138             // Remove the trailing whitespace in a new commit
139             editHash = CheckableRepository.replaceAndCommit(localRepo, &quot;A line without a trailing whitespace&quot;);
140             localRepo.push(editHash, author.getUrl(), &quot;refs/heads/edit&quot;, true);
141 
142             // Make sure that the push registered
143             var lastHeadHash = pr.getHeadHash();
144             var refreshCount = 0;
145             do {
146                 pr = author.getPullRequest(pr.getId());
147                 if (refreshCount++ &gt; 100) {
148                     fail(&quot;The PR did not update after the new push&quot;);
149                 }
150             } while (pr.getHeadHash().equals(lastHeadHash));
151 
152             // Check the status again
153             TestBotRunner.runPeriodicItems(checkBot);
154 
155             // The PR should not be flagged as ready for review, at it is already reviewed
156             assertFalse(pr.getLabels().contains(&quot;rfr&quot;));
157 
158             // The check should now be successful
159             checks = pr.getChecks(editHash);
160             assertEquals(1, checks.size());
161             check = checks.get(&quot;jcheck&quot;);
162             assertEquals(CheckStatus.SUCCESS, check.status());
163         }
164     }
165 
166     @Test
167     void multipleReviews(TestInfo testInfo) throws IOException {
168         try (var credentials = new HostCredentials(testInfo);
169              var tempFolder = new TemporaryDirectory()) {
170 
171             var author = credentials.getHostedRepository();
172             var reviewer = credentials.getHostedRepository();
173             var commenter = credentials.getHostedRepository();
174 
175             var censusBuilder = credentials.getCensusBuilder()
176                                            .addAuthor(author.host().getCurrentUserDetails().id())
177                                            .addReviewer(reviewer.host().getCurrentUserDetails().id())
178                                            .addReviewer(commenter.host().getCurrentUserDetails().id());
179 
180             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
181 
182             // Populate the projects repository
183             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
184             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
185             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
186 
187             // Make a change with a corresponding PR
188             var editHash = CheckableRepository.appendAndCommit(localRepo);
189             localRepo.push(editHash, author.getUrl(), &quot;refs/heads/edit&quot;, true);
190             var authorPr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
191 
192             // Let the status bot inspect the PR
193             TestBotRunner.runPeriodicItems(checkBot);
194             assertFalse(authorPr.getBody().contains(&quot;Approvers&quot;));
195 
196             // Approve it
197             var reviewerPr = reviewer.getPullRequest(authorPr.getId());
198             reviewerPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
199             TestBotRunner.runPeriodicItems(checkBot);
200 
201             // Refresh the PR and check that it has been approved
202             authorPr = author.getPullRequest(authorPr.getId());
203             assertTrue(authorPr.getBody().contains(&quot;Approvers&quot;));
204 
205             // Update the file after approval
206             editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Now I&#39;ve gone and changed it&quot;);
207             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
208 
209             // Make sure that the push registered
210             var lastHeadHash = authorPr.getHeadHash();
211             var refreshCount = 0;
212             do {
213                 authorPr = author.getPullRequest(authorPr.getId());
214                 if (refreshCount++ &gt; 100) {
215                     fail(&quot;The PR did not update after the new push&quot;);
216                 }
217             } while (authorPr.getHeadHash().equals(lastHeadHash));
218 
219             // Check that the review is flagged as stale
220             TestBotRunner.runPeriodicItems(checkBot);
221             authorPr = author.getPullRequest(authorPr.getId());
222             assertTrue(authorPr.getBody().contains(&quot;Note&quot;));
223 
224             // Now we can approve it again
225             reviewerPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
226             TestBotRunner.runPeriodicItems(checkBot);
227 
228             // Refresh the PR and check that it has been approved (once) and is no longer stale
229             authorPr = author.getPullRequest(authorPr.getId());
230             assertTrue(authorPr.getBody().contains(&quot;Approvers&quot;));
231             assertEquals(1, authorPr.getBody().split(&quot;Generated Reviewer&quot;, -1).length - 1);
232             assertTrue(authorPr.getReviews().size() &gt;= 1);
233             assertFalse(authorPr.getBody().contains(&quot;Note&quot;));
234 
235             // Add a review with disapproval
236             var commenterPr = commenter.getPullRequest(authorPr.getId());
237             commenterPr.addReview(Review.Verdict.DISAPPROVED, &quot;Disapproved&quot;);
238             TestBotRunner.runPeriodicItems(checkBot);
239 
240             // Refresh the PR and check that it still only approved once (but two reviews) and is no longer stale
241             authorPr = author.getPullRequest(authorPr.getId());
242             assertTrue(authorPr.getBody().contains(&quot;Approvers&quot;));
243             assertEquals(1, authorPr.getBody().split(&quot;Generated Reviewer&quot;, -1).length - 1);
244             assertTrue(authorPr.getReviews().size() &gt;= 2);
245             assertFalse(authorPr.getBody().contains(&quot;Note&quot;));
246         }
247     }
248 
249     @Test
250     void selfReview(TestInfo testInfo) throws IOException {
251         try (var credentials = new HostCredentials(testInfo);
252              var tempFolder = new TemporaryDirectory()) {
253 
254             var author = credentials.getHostedRepository();
255 
256             var censusBuilder = credentials.getCensusBuilder()
257                                            .addReviewer(author.host().getCurrentUserDetails().id());
258 
259             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
260 
261             // Populate the projects repository
262             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
263             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
264             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
265 
266             // Make a change with a corresponding PR
267             var editHash = CheckableRepository.appendAndCommit(localRepo);
268             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
269             var authorPr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
270 
271             // Let the status bot inspect the PR
272             TestBotRunner.runPeriodicItems(checkBot);
273             assertFalse(authorPr.getBody().contains(&quot;Approvers&quot;));
274 
275             // Approve it
276             authorPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
277             TestBotRunner.runPeriodicItems(checkBot);
278 
279             // Refresh the PR and check that it has been approved
280             authorPr = author.getPullRequest(authorPr.getId());
281             assertTrue(authorPr.getBody().contains(&quot;Approvers&quot;));
282 
283             // Verify that the check failed
284             var checks = authorPr.getChecks(editHash);
285             assertEquals(1, checks.size());
286             var check = checks.get(&quot;jcheck&quot;);
287             assertEquals(CheckStatus.FAILURE, check.status());
288         }
289     }
290 
291     @Test
292     void multipleCommitters(TestInfo testInfo) throws IOException {
293         try (var credentials = new HostCredentials(testInfo);
294              var tempFolder = new TemporaryDirectory()) {
295             var author = credentials.getHostedRepository();
296             var reviewer = credentials.getHostedRepository();
297 
298             var censusBuilder = credentials.getCensusBuilder()
299                                            .addReviewer(reviewer.host().getCurrentUserDetails().id());
300             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
301 
302             // Populate the projects repository
303             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
304             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
305             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
306 
307             // Make two changes with different authors
308             CheckableRepository.appendAndCommit(localRepo, &quot;First edit&quot;, &quot;Edit by number 1&quot;,
309                                                 &quot;number1&quot;, &quot;number1@none.none&quot;);
310             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Second edit&quot;, &quot;Edit by number 2&quot;,
311                                                                &quot;number2&quot;, &quot;number2@none.none&quot;);
312             localRepo.push(editHash, author.getUrl(), &quot;refs/heads/edit&quot;, true);
313             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
314 
315             // Check the status
316             TestBotRunner.runPeriodicItems(checkBot);
317 
318             // Verify that the check failed
319             var checks = pr.getChecks(editHash);
320             assertEquals(1, checks.size());
321             var check = checks.get(&quot;jcheck&quot;);
322             assertEquals(CheckStatus.FAILURE, check.status());
323 
324             // Approve it as another user
325             var approvalPr = reviewer.getPullRequest(pr.getId());
326             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
327 
328             // Check the status again
329             TestBotRunner.runPeriodicItems(checkBot);
330 
331             // The check should still be failing
332             checks = pr.getChecks(editHash);
333             assertEquals(1, checks.size());
334             check = checks.get(&quot;jcheck&quot;);
335             assertEquals(CheckStatus.FAILURE, check.status());
336 
337             // The PR should not be flagged as ready for review, as multiple committers is a problem
338             assertFalse(pr.getLabels().contains(&quot;rfr&quot;));
339         }
340     }
341 
342     @Test
343     void updatedContentFailsCheck(TestInfo testInfo) throws IOException {
344         try (var credentials = new HostCredentials(testInfo);
345              var tempFolder = new TemporaryDirectory()) {
346             var author = credentials.getHostedRepository();
347             var reviewer = credentials.getHostedRepository();
348 
349             var censusBuilder = credentials.getCensusBuilder()
350                                            .addAuthor(author.host().getCurrentUserDetails().id())
351                                            .addReviewer(reviewer.host().getCurrentUserDetails().id());
352             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
353 
354             // Populate the projects repository
355             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
356             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
357             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
358 
359             // Make a change with a corresponding PR
360             var editHash = CheckableRepository.appendAndCommit(localRepo);
361             localRepo.push(editHash, author.getUrl(), &quot;refs/heads/edit&quot;, true);
362             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
363 
364             // Check the status
365             TestBotRunner.runPeriodicItems(checkBot);
366 
367             // Verify that the check passed
368             var checks = pr.getChecks(editHash);
369             assertEquals(1, checks.size());
370             var check = checks.get(&quot;jcheck&quot;);
371             assertEquals(CheckStatus.SUCCESS, check.status());
372 
373             // The PR should now be ready for review
374             assertTrue(pr.getLabels().contains(&quot;rfr&quot;));
375             assertFalse(pr.getLabels().contains(&quot;ready&quot;));
376 
377             // Approve it as another user
378             var approvalPr = reviewer.getPullRequest(pr.getId());
379             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
380 
381             // Check the status again
382             TestBotRunner.runPeriodicItems(checkBot);
383 
384             // The check should now be successful
385             checks = pr.getChecks(editHash);
386             assertEquals(1, checks.size());
387             check = checks.get(&quot;jcheck&quot;);
388             assertEquals(CheckStatus.SUCCESS, check.status());
389 
390             // The PR should not be flagged as ready for review, at it is already reviewed
391             assertFalse(pr.getLabels().contains(&quot;rfr&quot;));
392             assertTrue(pr.getLabels().contains(&quot;ready&quot;));
393 
394             var addedHash = CheckableRepository.appendAndCommit(localRepo, &quot;trailing whitespace   &quot;);
395             localRepo.push(addedHash, author.getUrl(), &quot;edit&quot;);
396 
397             // Make sure that the push registered
398             var lastHeadHash = pr.getHeadHash();
399             var refreshCount = 0;
400             do {
401                 pr = author.getPullRequest(pr.getId());
402                 if (refreshCount++ &gt; 100) {
403                     fail(&quot;The PR did not update after the new push&quot;);
404                 }
405             } while (pr.getHeadHash().equals(lastHeadHash));
406 
407             // Check the status
408             TestBotRunner.runPeriodicItems(checkBot);
409 
410             // The PR is now neither ready for review nor integration
411             assertFalse(pr.getLabels().contains(&quot;rfr&quot;));
412             assertFalse(pr.getLabels().contains(&quot;ready&quot;));
413 
414             // The check should now be failing
415             checks = pr.getChecks(addedHash);
416             assertEquals(1, checks.size());
417             check = checks.get(&quot;jcheck&quot;);
418             assertEquals(CheckStatus.FAILURE, check.status());
419         }
420     }
421 
422     @Test
423     void individualReviewComments(TestInfo testInfo) throws IOException {
424         try (var credentials = new HostCredentials(testInfo);
425              var tempFolder = new TemporaryDirectory()) {
426             var author = credentials.getHostedRepository();
427             var reviewer = credentials.getHostedRepository();
428 
429             // This test is only relevant on hosts not supporting proper review comment bodies
430             assumeTrue(!author.host().supportsReviewBody());
431 
432             var censusBuilder = credentials.getCensusBuilder()
433                                            .addAuthor(author.host().getCurrentUserDetails().id())
434                                            .addReviewer(reviewer.host().getCurrentUserDetails().id());
435             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
436 
437             // Populate the projects repository
438             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
439             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
440             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
441 
442             // Make a change with a corresponding PR
443             var editHash = CheckableRepository.appendAndCommit(localRepo);
444             localRepo.push(editHash, author.getUrl(), &quot;refs/heads/edit&quot;, true);
445             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
446 
447             // Check the status
448             TestBotRunner.runPeriodicItems(checkBot);
449             var comments = pr.getComments();
450             var commentCount = comments.size();
451 
452             // Approve it as another user
453             var approvalPr = reviewer.getPullRequest(pr.getId());
454             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
455 
456             // Check the status again
457             TestBotRunner.runPeriodicItems(checkBot);
458 
459             // There should now be two additional comments
460             comments = pr.getComments();
461             assertEquals(commentCount + 2, comments.size());
462             var comment = comments.get(commentCount);
463             assertTrue(comment.body().contains(reviewer.host().getCurrentUserDetails().userName()));
464             assertTrue(comment.body().contains(&quot;approved&quot;));
465 
466             // Drop the review
467             approvalPr.addReview(Review.Verdict.NONE, &quot;Unreviewed&quot;);
468 
469             // Check the status again
470             TestBotRunner.runPeriodicItems(checkBot);
471 
472             // There should now be yet another comment
473             comments = pr.getComments();
474             assertEquals(commentCount + 3, comments.size());
475             comment = comments.get(commentCount + 2);
476             assertTrue(comment.body().contains(reviewer.host().getCurrentUserDetails().userName()));
477             assertTrue(comment.body().contains(&quot;comment&quot;));
478 
479             // No changes should not generate additional comments
480             TestBotRunner.runPeriodicItems(checkBot);
481             comments = pr.getComments();
482             assertEquals(commentCount + 3, comments.size());
483         }
484     }
485 
486     @Test
487     void mergeMessage(TestInfo testInfo) throws IOException {
488         try (var credentials = new HostCredentials(testInfo);
489              var tempFolder = new TemporaryDirectory();
490              var pushedFolder = new TemporaryDirectory()) {
491 
492             var author = credentials.getHostedRepository();
493             var integrator = credentials.getHostedRepository();
494             var censusBuilder = credentials.getCensusBuilder()
495                                            .addCommitter(author.host().getCurrentUserDetails().id())
496                                            .addReviewer(integrator.host().getCurrentUserDetails().id());
497             var mergeBot = new PullRequestBot(integrator, censusBuilder.build(), &quot;master&quot;);
498 
499             // Populate the projects repository
500             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
501             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
502             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
503             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
504 
505             // Make a change with a corresponding PR
506             var editHash = CheckableRepository.appendAndCommit(localRepo);
507             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
508             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
509 
510             // Approve it as another user
511             var approvalPr = integrator.getPullRequest(pr.getId());
512             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
513 
514             // Get all messages up to date
515             TestBotRunner.runPeriodicItems(mergeBot);
516 
517             // Push something unrelated to master
518             localRepo.checkout(masterHash, true);
519             var unrelated = localRepo.root().resolve(&quot;unrelated.txt&quot;);
520             Files.writeString(unrelated, &quot;Hello&quot;);
521             localRepo.add(unrelated);
522             var unrelatedHash = localRepo.commit(&quot;Unrelated&quot;, &quot;X&quot;, &quot;x@y.z&quot;);
523             localRepo.push(unrelatedHash, author.getUrl(), &quot;master&quot;);
524 
525             // Let the bot see the changes
526             TestBotRunner.runPeriodicItems(mergeBot);
527 
528             // The bot should reply with an ok message
529             var updated = pr.getComments().stream()
530                             .filter(comment -&gt; comment.body().contains(&quot;there has been 1 commit&quot;))
531                             .filter(comment -&gt; comment.body().contains(&quot;please merge&quot;))
532                             .count();
533             assertEquals(1, updated);
534         }
535     }
536 
537     @Test
538     void cannotRebase(TestInfo testInfo) throws IOException {
539         try (var credentials = new HostCredentials(testInfo);
540              var tempFolder = new TemporaryDirectory();
541              var pushedFolder = new TemporaryDirectory()) {
542 
543             var author = credentials.getHostedRepository();
544             var integrator = credentials.getHostedRepository();
545             var censusBuilder = credentials.getCensusBuilder()
546                                            .addCommitter(author.host().getCurrentUserDetails().id())
547                                            .addReviewer(integrator.host().getCurrentUserDetails().id());
548             var mergeBot = new PullRequestBot(integrator, censusBuilder.build(), &quot;master&quot;);
549 
550             // Populate the projects repository
551             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
552             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
553             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
554             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
555 
556             // Make a change with a corresponding PR
557             var editHash = CheckableRepository.appendAndCommit(localRepo);
558             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
559             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
560 
561             // Approve it as another user
562             var approvalPr = integrator.getPullRequest(pr.getId());
563             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
564 
565             // Get all messages up to date
566             TestBotRunner.runPeriodicItems(mergeBot);
567 
568             // Push something conflicting to master
569             localRepo.checkout(masterHash, true);
570             var conflictingHash = CheckableRepository.appendAndCommit(localRepo, &quot;This looks like a conflict&quot;);
571             localRepo.push(conflictingHash, author.getUrl(), &quot;master&quot;);
572 
573             // Let the bot see the changes
574             TestBotRunner.runPeriodicItems(mergeBot);
575 
576             // The bot should reply with that there is a conflict
577             var updated = pr.getComments().stream()
578                             .filter(comment -&gt; comment.body().contains(&quot;there has been 1 commit&quot;))
579                             .filter(comment -&gt; comment.body().contains(&quot;cannot be rebased automatically&quot;))
580                             .count();
581             assertEquals(1, updated);
582 
583             // The PR should be flagged as outdated
584             assertTrue(pr.getLabels().contains(&quot;outdated&quot;));
585 
586             // But it should still pass jcheck
587             var checks = pr.getChecks(editHash);
588             assertEquals(1, checks.size());
589             var check = checks.get(&quot;jcheck&quot;);
590             assertEquals(CheckStatus.SUCCESS, check.status());
591 
592             // Restore the master branch
593             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
594 
595             // Let the bot see the changes
596             TestBotRunner.runPeriodicItems(mergeBot);
597 
598             // The bot should no longer detect a conflict
599             updated = pr.getComments().stream()
600                             .filter(comment -&gt; comment.body().contains(&quot;change can now be integrated&quot;))
601                             .count();
602             assertEquals(1, updated);
603 
604             // The PR should not be flagged as outdated
605             assertFalse(pr.getLabels().contains(&quot;outdated&quot;));
606         }
607     }
608 
609     @Test
610     void blockingLabel(TestInfo testInfo) throws IOException {
611         try (var credentials = new HostCredentials(testInfo);
612              var tempFolder = new TemporaryDirectory()) {
613             var author = credentials.getHostedRepository();
614             var reviewer = credentials.getHostedRepository();
615 
616             var censusBuilder = credentials.getCensusBuilder()
617                                            .addAuthor(author.host().getCurrentUserDetails().id())
618                                            .addReviewer(reviewer.host().getCurrentUserDetails().id());
619             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;, Map.of(), Map.of(),
620                                               Map.of(&quot;block&quot;, &quot;Test Blocker&quot;), Set.of(), Map.of());
621 
622             // Populate the projects repository
623             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
624             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
625             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
626 
627             // Make a change with a corresponding PR
628             var editHash = CheckableRepository.appendAndCommit(localRepo);
629             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
630             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
631             pr.addLabel(&quot;block&quot;);
632 
633             // Check the status
634             TestBotRunner.runPeriodicItems(checkBot);
635 
636             // Verify that the check failed
637             var checks = pr.getChecks(editHash);
638             assertEquals(1, checks.size());
639             var check = checks.get(&quot;jcheck&quot;);
640             assertEquals(CheckStatus.FAILURE, check.status());
641             assertTrue(check.summary().orElseThrow().contains(&quot;Test Blocker&quot;));
642 
643             // The PR should not yet be ready for review
644             assertTrue(pr.getLabels().contains(&quot;block&quot;));
645             assertFalse(pr.getLabels().contains(&quot;rfr&quot;));
646             assertFalse(pr.getLabels().contains(&quot;ready&quot;));
647 
648             // Check the status again
649             pr.removeLabel(&quot;block&quot;);
650             TestBotRunner.runPeriodicItems(checkBot);
651 
652             // The PR should now be ready for review
653             assertTrue(pr.getLabels().contains(&quot;rfr&quot;));
654             assertFalse(pr.getLabels().contains(&quot;ready&quot;));
655         }
656     }
657 
658     @Test
659     void missingReadyLabel(TestInfo testInfo) throws IOException {
660         try (var credentials = new HostCredentials(testInfo);
661              var tempFolder = new TemporaryDirectory()) {
662             var author = credentials.getHostedRepository();
663             var reviewer = credentials.getHostedRepository();
664 
665             var censusBuilder = credentials.getCensusBuilder()
666                                            .addAuthor(author.host().getCurrentUserDetails().id())
667                                            .addReviewer(reviewer.host().getCurrentUserDetails().id());
668             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;, Map.of(), Map.of(),
669                                               Map.of(), Set.of(&quot;good-to-go&quot;), Map.of());
670 
671             // Populate the projects repository
672             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
673             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
674             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
675 
676             // Make a change with a corresponding PR
677             var editHash = CheckableRepository.appendAndCommit(localRepo);
678             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
679             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
680 
681             // Check the status
682             TestBotRunner.runPeriodicItems(checkBot);
683 
684             // Verify that no checks have been run
685             var checks = pr.getChecks(editHash);
686             assertEquals(0, checks.size());
687 
688             // The PR should not yet be ready for review
689             assertFalse(pr.getLabels().contains(&quot;rfr&quot;));
690 
691             // Check the status again
692             pr.addLabel(&quot;good-to-go&quot;);
693             TestBotRunner.runPeriodicItems(checkBot);
694 
695             // The PR should now be ready for review
696             assertTrue(pr.getLabels().contains(&quot;rfr&quot;));
697         }
698     }
699 
700     @Test
701     void missingReadyComment(TestInfo testInfo) throws IOException {
702         try (var credentials = new HostCredentials(testInfo);
703              var tempFolder = new TemporaryDirectory()) {
704             var author = credentials.getHostedRepository();
705             var reviewer = credentials.getHostedRepository();
706 
707             var censusBuilder = credentials.getCensusBuilder()
708                                            .addAuthor(author.host().getCurrentUserDetails().id())
709                                            .addReviewer(reviewer.host().getCurrentUserDetails().id());
710             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;, Map.of(), Map.of(),
711                                               Map.of(), Set.of(), Map.of(reviewer.host().getCurrentUserDetails().userName(), Pattern.compile(&quot;proceed&quot;)));
712 
713             // Populate the projects repository
714             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
715             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
716             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
717 
718             // Make a change with a corresponding PR
719             var editHash = CheckableRepository.appendAndCommit(localRepo);
720             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
721             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
722 
723             // Check the status
724             TestBotRunner.runPeriodicItems(checkBot);
725 
726             // Verify that no checks have been run
727             var checks = pr.getChecks(editHash);
728             assertEquals(0, checks.size());
729 
730             // The PR should not yet be ready for review
731             assertFalse(pr.getLabels().contains(&quot;rfr&quot;));
732 
733             // Check the status again
734             var reviewerPr = reviewer.getPullRequest(pr.getId());
735             reviewerPr.addComment(&quot;proceed&quot;);
736             TestBotRunner.runPeriodicItems(checkBot);
737 
738             // The PR should now be ready for review
739             assertTrue(pr.getLabels().contains(&quot;rfr&quot;));
740         }
741     }
742 
743     @Test
744     void issueIssue(TestInfo testInfo) throws IOException {
745         try (var credentials = new HostCredentials(testInfo);
746              var tempFolder = new TemporaryDirectory()) {
747             var author = credentials.getHostedRepository();
748             var reviewer = credentials.getHostedRepository();
749 
750             var censusBuilder = credentials.getCensusBuilder()
751                                            .addAuthor(author.host().getCurrentUserDetails().id())
752                                            .addReviewer(reviewer.host().getCurrentUserDetails().id());
753             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;, Map.of(), Map.of(),
754                                               Map.of(), Set.of(), Map.of());
755 
756             // Populate the projects repository
757             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), Path.of(&quot;appendable.txt&quot;),
758                                                      Set.of(&quot;issues&quot;));
759             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
760             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
761 
762             // Make a change with a corresponding PR
763             var editHash = CheckableRepository.appendAndCommit(localRepo);
764             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
765             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
766 
767             // Check the status
768             TestBotRunner.runPeriodicItems(checkBot);
769 
770             // Verify that the check failed
771             var checks = pr.getChecks(editHash);
772             assertEquals(1, checks.size());
773             var check = checks.get(&quot;jcheck&quot;);
774             assertEquals(CheckStatus.FAILURE, check.status());
775 
776             // Add an issue to the title
777             pr.setTitle(&quot;1234: This is a pull request&quot;);
778 
779             // Check the status again
780             TestBotRunner.runPeriodicItems(checkBot);
781 
782             // The check should now be successful
783             checks = pr.getChecks(editHash);
784             assertEquals(1, checks.size());
785             check = checks.get(&quot;jcheck&quot;);
786             assertEquals(CheckStatus.SUCCESS, check.status());
787         }
788     }
789 
790     @Test
791     void issueInSummary(TestInfo testInfo) throws IOException {
792         try (var credentials = new HostCredentials(testInfo);
793              var tempFolder = new TemporaryDirectory()) {
794             var author = credentials.getHostedRepository();
795             var reviewer = credentials.getHostedRepository();
796             var issues = credentials.getIssueProject();
797 
798             var censusBuilder = credentials.getCensusBuilder()
799                                            .addAuthor(author.host().getCurrentUserDetails().id())
800                                            .addReviewer(reviewer.host().getCurrentUserDetails().id());
801             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;, Map.of(), Map.of(),
802                                               Map.of(), Set.of(), Map.of(), issues);
803 
804             // Populate the projects repository
805             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), Path.of(&quot;appendable.txt&quot;),
806                                                      Set.of(&quot;issues&quot;));
807             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
808             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
809 
810             var issue1 = issues.createIssue(&quot;My first issue&quot;, List.of(&quot;Hello&quot;));
811 
812             // Make a change with a corresponding PR
813             var editHash = CheckableRepository.appendAndCommit(localRepo);
814             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
815             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, issue1.getId() + &quot;: This is a pull request&quot;);
816 
817             // Check the status
818             TestBotRunner.runPeriodicItems(checkBot);
819 
820             // The check should be successful
821             var checks = pr.getChecks(editHash);
822             assertEquals(1, checks.size());
823             var check = checks.get(&quot;jcheck&quot;);
824             assertEquals(CheckStatus.SUCCESS, check.status());
825 
826             // And the body should contain the issue title
827             assertTrue(pr.getBody().contains(&quot;My first issue&quot;));
828 
829             // Change the issue
830             var issue2 = issues.createIssue(&quot;My second issue&quot;, List.of(&quot;Body&quot;));
831             pr.setTitle(issue2.getId() + &quot;: This is a pull request&quot;);
832 
833             // Check the status again
834             TestBotRunner.runPeriodicItems(checkBot);
835 
836             // The body should contain the updated issue title
837             assertFalse(pr.getBody().contains(&quot;My first issue&quot;));
838             assertTrue(pr.getBody().contains(&quot;My second issue&quot;));
839 
840             // Now enter an invalid issue id
841             pr.setTitle(&quot;2384848: This is a pull request&quot;);
842 
843             // Check the status again
844             TestBotRunner.runPeriodicItems(checkBot);
845             assertFalse(pr.getBody().contains(&quot;My first issue&quot;));
846             assertFalse(pr.getBody().contains(&quot;My second issue&quot;));
847             assertTrue(pr.getBody().contains(&quot;Failed to retrieve&quot;));
848 
849             // The check should still be successful though
850             checks = pr.getChecks(editHash);
851             assertEquals(1, checks.size());
852             check = checks.get(&quot;jcheck&quot;);
853             assertEquals(CheckStatus.SUCCESS, check.status());
854         }
855     }
856 
857     @Test
858     void cancelCheck(TestInfo testInfo) throws IOException {
859         try (var credentials = new HostCredentials(testInfo);
860              var tempFolder = new TemporaryDirectory()) {
861             var author = credentials.getHostedRepository();
862 
863             // Populate the projects repository
864             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
865             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
866             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
867 
868             // Make a change with a corresponding PR
869             var editHash = CheckableRepository.appendAndCommit(localRepo);
870             localRepo.push(editHash, author.getUrl(), &quot;refs/heads/edit&quot;, true);
871             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
872 
873             // Verify no checks exists
874             var checks = pr.getChecks(editHash);
875             assertEquals(0, checks.size());
876 
877             // Create a check that is running
878             var original = CheckBuilder.create(&quot;jcheck&quot;, editHash)
879                                        .title(&quot;jcheck title&quot;)
880                                        .summary(&quot;jcheck summary&quot;)
881                                        .build();
882             pr.createCheck(original);
883 
884             // Verify check is created
885             checks = pr.getChecks(editHash);
886             assertEquals(1, checks.size());
887             var retrieved = checks.get(&quot;jcheck&quot;);
888             assertEquals(&quot;jcheck title&quot;, retrieved.title().get());
889             assertEquals(&quot;jcheck summary&quot;, retrieved.summary().get());
890             assertEquals(CheckStatus.IN_PROGRESS, retrieved.status());
891 
892             // Cancel the check
893             var cancelled = CheckBuilder.from(retrieved).cancel().build();
894             pr.updateCheck(cancelled);
895             checks = pr.getChecks(editHash);
896             assertEquals(1, checks.size());
897             retrieved = checks.get(&quot;jcheck&quot;);
898             assertEquals(&quot;jcheck title&quot;, retrieved.title().get());
899             assertEquals(&quot;jcheck summary&quot;, retrieved.summary().get());
900             assertEquals(CheckStatus.CANCELLED, retrieved.status());
901         }
902     }
903 
904     @Test
905     void rebaseBeforeCheck(TestInfo testInfo) throws IOException {
906         try (var credentials = new HostCredentials(testInfo);
907              var tempFolder = new TemporaryDirectory()) {
908             var author = credentials.getHostedRepository();
909             var reviewer = credentials.getHostedRepository();
910 
911             var censusBuilder = credentials.getCensusBuilder()
912                                            .addAuthor(author.host().getCurrentUserDetails().id())
913                                            .addReviewer(reviewer.host().getCurrentUserDetails().id());
914             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
915 
916             // Populate the projects repository
917             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
918             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
919             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
920 
921             // Make a change with a corresponding PR
922             var editHash = CheckableRepository.appendAndCommit(localRepo);
923             localRepo.push(editHash, author.getUrl(), &quot;refs/heads/edit&quot;, true);
924             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
925 
926             // Enable a new check in the target branch
927             localRepo.checkout(masterHash, true);
928             CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), Path.of(&quot;appendable.txt&quot;),
929                                      Set.of(&quot;author&quot;, &quot;reviewers&quot;, &quot;whitespace&quot;, &quot;issues&quot;));
930             var headHash = localRepo.resolve(&quot;HEAD&quot;).orElseThrow();
931             localRepo.push(headHash, author.getUrl(), &quot;master&quot;, true);
932 
933             // Check the status
934             TestBotRunner.runPeriodicItems(checkBot);
935 
936             // Verify that the check failed
937             var checks = pr.getChecks(editHash);
938             assertEquals(1, checks.size());
939             var check = checks.get(&quot;jcheck&quot;);
940             assertTrue(check.summary().orElseThrow().contains(&quot;commit message does not reference any issue&quot;));
941             assertEquals(CheckStatus.FAILURE, check.status());
942 
943             // Adjust the title to conform and check the status again
944             pr.setTitle(&quot;12345: This is a pull request&quot;);
945             TestBotRunner.runPeriodicItems(checkBot);
946 
947             // Verify that the check passed
948             checks = pr.getChecks(editHash);
949             assertEquals(1, checks.size());
950             check = checks.get(&quot;jcheck&quot;);
951             assertEquals(CheckStatus.SUCCESS, check.status());
952         }
953     }
954 }
    </pre>
  </body>
</html>