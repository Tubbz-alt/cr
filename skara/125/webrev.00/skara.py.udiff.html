<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff skara.py</title>
    <link rel="stylesheet" href="style.css" />
  </head>
<body>
<center><a href="host/src/main/java/org/openjdk/skara/host/github/GitHubPullRequest.java.udiff.html" target="_top">&lt; prev</a> <a href="index.html" target="_top">index</a> <a href="vcs/src/main/java/org/openjdk/skara/vcs/ReadOnlyRepository.java.udiff.html" target="_top">next &gt;</a></center>    <h2>skara.py</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -63,24 +63,57 @@</span>
              shutil.rmtree(skara_bin)
          shutil.move(skara_build, skara_bin)
  
      sys.exit(subprocess.call([git_skara] + args))
  
<span class="udiff-line-modified-removed">- fork_opts = [</span>
<span class="udiff-line-modified-removed">-     (&#39;u&#39;, &#39;username&#39;, &#39;&#39;, &#39;Username on host&#39;),</span>
<span class="udiff-line-modified-removed">- ]</span>
<span class="udiff-line-modified-removed">- @command(&#39;fork&#39;, fork_opts, &#39;hg fork URL [DEST]&#39;, norepo=True)</span>
<span class="udiff-line-modified-removed">- def fork(ui, url, dest=None, **opts):</span>
<span class="udiff-line-modified-added">+ def _web_url(url):</span>
<span class="udiff-line-modified-added">+     if url.startswith(&#39;git+&#39;):</span>
<span class="udiff-line-modified-added">+         url = url[len(&#39;git+&#39;):]</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     if url.startswith(&#39;http&#39;):</span>
<span class="udiff-line-added">+         return url</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if not url.startswith(&#39;ssh://&#39;):</span>
<span class="udiff-line-added">+         raise ValueError(&#39;Unexpected url: &#39; + url)</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     without_protocol = url[len(&#39;ssh://&#39;):]</span>
<span class="udiff-line-added">+     first_slash = without_protocol.index(&#39;/&#39;)</span>
<span class="udiff-line-added">+     host = without_protocol[:first_slash]</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     ssh_config = os.path.join(os.path.expanduser(&#39;~&#39;), &#39;.ssh&#39;, &#39;config&#39;)</span>
<span class="udiff-line-added">+     if os.path.exists(ssh_config):</span>
<span class="udiff-line-added">+         with open(ssh_config) as f:</span>
<span class="udiff-line-added">+             lines = f.readlines()</span>
<span class="udiff-line-added">+             current = None</span>
<span class="udiff-line-added">+             for line in lines:</span>
<span class="udiff-line-added">+                 if line.startswith(&#39;Host &#39;):</span>
<span class="udiff-line-added">+                     current = line.split(&#39; &#39;)[1].strip()</span>
<span class="udiff-line-added">+                 if line.strip().lower().startswith(&#39;hostname&#39;) and host == current:</span>
<span class="udiff-line-added">+                     host = line.strip().split(&#39; &#39;)[1]</span>
<span class="udiff-line-added">+                     break</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return &#39;https://&#39; + host + without_protocol[first_slash:]</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ def _username(ui, opts, url):</span>
<span class="udiff-line-added">+     web_url = _web_url(url)</span>
      username = None
<span class="udiff-line-modified-removed">-     if opts[&#39;username&#39;] != &#39;&#39; and url.startswith(&#39;http&#39;):</span>
<span class="udiff-line-modified-removed">-         username = ui.config(&#39;credential &quot;&#39; + url + &#39;&quot;&#39;, &#39;username&#39;)</span>
<span class="udiff-line-modified-added">+     if opts.get(&#39;username&#39;) == &#39;&#39;:</span>
<span class="udiff-line-modified-added">+         username = ui.config(&#39;credential &quot;&#39; + web_url + &#39;&quot;&#39;, &#39;username&#39;)</span>
          if username == None:
<span class="udiff-line-modified-removed">-             protocol, rest = url.split(&#39;://&#39;)</span>
<span class="udiff-line-modified-removed">-             hostname = rest[:rest.find(&#39;/&#39;)]</span>
<span class="udiff-line-modified-added">+             protocol, rest = web_url.split(&#39;://&#39;)</span>
<span class="udiff-line-modified-added">+             hostname = rest[:rest.index(&#39;/&#39;)]</span>
              username = ui.config(&#39;credential &quot;&#39; + protocol + &#39;://&#39; + hostname + &#39;&quot;&#39;, &#39;username&#39;)
              if username == None:
                  username = ui.config(&#39;credential&#39;, &#39;username&#39;)
<span class="udiff-line-added">+     return username</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ fork_opts = [</span>
<span class="udiff-line-added">+     (&#39;u&#39;, &#39;username&#39;, &#39;&#39;, &#39;Username on host&#39;),</span>
<span class="udiff-line-added">+ ]</span>
<span class="udiff-line-added">+ @command(&#39;fork&#39;, fork_opts, &#39;hg fork URL [DEST]&#39;, norepo=True)</span>
<span class="udiff-line-added">+ def fork(ui, url, dest=None, **opts):</span>
<span class="udiff-line-added">+     username = _username(ui, opts, url)</span>
      args = [&#39;fork&#39;, &#39;--mercurial&#39;]
      if username != None:
          args.append(&quot;--username&quot;)
          args.append(username)
      args.append(url)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -142,16 +175,28 @@</span>
  def info(ui, repo, rev, **opts):
      _skara(ui, [&#39;info&#39;, &#39;--mercurial&#39;, rev], **opts)
  
  pr_opts = [
      (&#39;u&#39;, &#39;username&#39;, &#39;&#39;, &#39;Username on host&#39;),
<span class="udiff-line-modified-removed">-     (&#39;r&#39;, &#39;remote&#39;, &#39;&#39;, &#39;Name of remote, defaults to &quot;origin&quot;&#39;),</span>
<span class="udiff-line-modified-removed">-     (&#39;b&#39;, &#39;branch&#39;, &#39;&#39;, &#39;Name of target branch, defaults to &quot;master&quot;&#39;),</span>
<span class="udiff-line-modified-added">+     (&#39;r&#39;, &#39;remote&#39;, &#39;&#39;, &#39;Name of path, defaults to &quot;default&quot;&#39;),</span>
<span class="udiff-line-modified-added">+     (&#39;b&#39;, &#39;branch&#39;, &#39;&#39;, &#39;Name of target branch, defaults to &quot;default&quot;&#39;),</span>
      (&#39;&#39;,  &#39;authors&#39;, &#39;&#39;, &#39;Comma separated list of authors&#39;),
      (&#39;&#39;,  &#39;assignees&#39;, &#39;&#39;, &#39;Comma separated list of assignees&#39;),
      (&#39;&#39;,  &#39;labels&#39;, &#39;&#39;, &#39;Comma separated list of labels&#39;),
      (&#39;&#39;,  &#39;columns&#39;, &#39;&#39;, &#39;Comma separated list of columns to show&#39;),
      (&#39;&#39;, &#39;no-decoration&#39;, False, &#39;Do not prefix lines with any decoration&#39;)
  ]
<span class="udiff-line-modified-removed">- @command(&#39;pr&#39;, info_opts, &#39;hg pr &lt;list|fetch|show|checkout|apply|integrate|approve|create|close|update&gt;&#39;)</span>
<span class="udiff-line-modified-removed">- def pr(ui, repo, action, **opts):</span>
<span class="udiff-line-modified-removed">-     _skara(ui, [&#39;pr&#39;, &#39;--mercurial&#39;, action], **opts)</span>
<span class="udiff-line-modified-added">+ @command(&#39;pr&#39;, pr_opts, &#39;hg pr &lt;list|fetch|show|checkout|apply|integrate|approve|create|close|update&gt;&#39;)</span>
<span class="udiff-line-modified-added">+ def pr(ui, repo, action, n=None, **opts):</span>
<span class="udiff-line-modified-added">+     path = opts.get(&#39;remote&#39;)</span>
<span class="udiff-line-added">+     if path == &#39;&#39;:</span>
<span class="udiff-line-added">+         path = &#39;default&#39;</span>
<span class="udiff-line-added">+     url = ui.config(&#39;paths&#39;, path)</span>
<span class="udiff-line-added">+     username = _username(ui, opts, url)</span>
<span class="udiff-line-added">+     args = [&#39;pr&#39;, &#39;--mercurial&#39;]</span>
<span class="udiff-line-added">+     if username != None:</span>
<span class="udiff-line-added">+         args.append(&#39;--username&#39;)</span>
<span class="udiff-line-added">+         args.append(username)</span>
<span class="udiff-line-added">+     args.append(action)</span>
<span class="udiff-line-added">+     if n != None:</span>
<span class="udiff-line-added">+         args.append(n)</span>
<span class="udiff-line-added">+     _skara(ui, args, **opts)</span>
</pre>
<center><a href="host/src/main/java/org/openjdk/skara/host/github/GitHubPullRequest.java.udiff.html" target="_top">&lt; prev</a> <a href="index.html" target="_top">index</a> <a href="vcs/src/main/java/org/openjdk/skara/vcs/ReadOnlyRepository.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>