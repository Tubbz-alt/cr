<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff host/src/main/java/org/openjdk/skara/host/github/GitHubPullRequest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="GitHubHost.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../skara.py.sdiff.html" target="_top">next &gt;</a></center>    <h2>host/src/main/java/org/openjdk/skara/host/github/GitHubPullRequest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 43 
 44     GitHubPullRequest(GitHubRepository repository, JSONValue jsonValue, RestRequest request) {
 45         this.host = (GitHubHost)repository.host();
 46         this.repository = repository;
 47         this.request = request;
 48         this.json = jsonValue;
 49     }
 50 
 51     @Override
 52     public HostedRepository repository() {
 53         return repository;
 54     }
 55 
 56     @Override
 57     public String getId() {
 58         return json.get(&quot;number&quot;).toString();
 59     }
 60 
 61     @Override
 62     public HostUserDetails getAuthor() {
<span class="line-modified"> 63         return host.parseUserDetails(json);</span>
 64     }
 65 
 66     @Override
 67     public List&lt;Review&gt; getReviews() {
 68         var reviews = request.get(&quot;pulls/&quot; + json.get(&quot;number&quot;).toString() + &quot;/reviews&quot;).execute().stream()
 69                              .map(JSONValue::asObject)
 70                              .filter(obj -&gt; !(obj.get(&quot;state&quot;).asString().equals(&quot;COMMENTED&quot;) &amp;&amp; obj.get(&quot;body&quot;).asString().isEmpty()))
 71                              .map(obj -&gt; {
<span class="line-modified"> 72                                  var reviewer = host.parseUserDetails(obj);</span>
 73                                  var hash = new Hash(obj.get(&quot;commit_id&quot;).asString());
 74                                  Review.Verdict verdict;
 75                                  switch (obj.get(&quot;state&quot;).asString()) {
 76                                      case &quot;APPROVED&quot;:
 77                                          verdict = Review.Verdict.APPROVED;
 78                                          break;
 79                                      case &quot;CHANGES_REQUESTED&quot;:
 80                                          verdict = Review.Verdict.DISAPPROVED;
 81                                          break;
 82                                      default:
 83                                          verdict = Review.Verdict.NONE;
 84                                          break;
 85                                  }
 86                                  var id = obj.get(&quot;id&quot;).asInt();
 87                                  var body = obj.get(&quot;body&quot;).asString();
 88                                  return new Review(reviewer, verdict, hash, id, body);
 89                              })
 90                              .collect(Collectors.toList());
 91         return reviews;
 92     }
</pre>
<hr />
<pre>
 95     public void addReview(Review.Verdict verdict, String body) {
 96         var query = JSON.object();
 97         switch (verdict) {
 98             case APPROVED:
 99                 query.put(&quot;event&quot;, &quot;APPROVE&quot;);
100                 break;
101             case DISAPPROVED:
102                 query.put(&quot;event&quot;, &quot;REQUEST_CHANGES&quot;);
103                 break;
104             case NONE:
105                 query.put(&quot;event&quot;, &quot;COMMENT&quot;);
106                 break;
107         }
108         query.put(&quot;body&quot;, body);
109         request.post(&quot;pulls/&quot; + json.get(&quot;number&quot;).toString() + &quot;/reviews&quot;)
110                .body(query)
111                .execute();
112     }
113 
114     private ReviewComment parseReviewComment(ReviewComment parent, JSONObject json, PositionMapper diff) {
<span class="line-modified">115         var author = host.parseUserDetails(json);</span>
116         var threadId = parent == null ? json.get(&quot;id&quot;).toString() : parent.threadId();
117         var comment = new ReviewComment(parent,
118                                         threadId,
119                                         new Hash(json.get(&quot;commit_id&quot;).asString()),
120                                         json.get(&quot;path&quot;).asString(),
121                                         diff.positionToLine(json.get(&quot;path&quot;).asString(), json.get(&quot;original_position&quot;).asInt()),
122                                         json.get(&quot;id&quot;).toString(),
123                                         json.get(&quot;body&quot;).asString(),
124                                         author,
125                                         ZonedDateTime.parse(json.get(&quot;created_at&quot;).asString()),
126                                         ZonedDateTime.parse(json.get(&quot;updated_at&quot;).asString()));
127         return comment;
128     }
129 
130     @Override
131     public ReviewComment addReviewComment(Hash base, Hash hash, String path, int line, String body) {
132         var rawDiff = request.get(&quot;pulls/&quot; + json.get(&quot;number&quot;).toString())
133                              .header(&quot;Accept&quot;, &quot;application/vnd.github.v3.diff&quot;)
134                              .executeUnparsed();
135         var diff = PositionMapper.parse(rawDiff);
</pre>
<hr />
<pre>
214 
215     @Override
216     public String getBody() {
217         var body = json.get(&quot;body&quot;).asString();
218         if (body == null) {
219             body = &quot;&quot;;
220         }
221         return body;
222     }
223 
224     @Override
225     public void setBody(String body) {
226         request.patch(&quot;pulls/&quot; + json.get(&quot;number&quot;).toString())
227                .body(&quot;body&quot;, body)
228                .execute();
229     }
230 
231     private Comment parseComment(JSONValue comment) {
232         var ret = new Comment(Integer.toString(comment.get(&quot;id&quot;).asInt()),
233                               comment.get(&quot;body&quot;).asString(),
<span class="line-modified">234                               host.parseUserDetails(comment),</span>
235                               ZonedDateTime.parse(comment.get(&quot;created_at&quot;).asString()),
236                               ZonedDateTime.parse(comment.get(&quot;updated_at&quot;).asString()));
237         return ret;
238     }
239 
240     @Override
241     public List&lt;Comment&gt; getComments() {
242         return request.get(&quot;issues/&quot; + json.get(&quot;number&quot;).toString() + &quot;/comments&quot;).execute().stream()
243                 .map(this::parseComment)
244                 .collect(Collectors.toList());
245     }
246 
247     @Override
248     public Comment addComment(String body) {
249         var comment = request.post(&quot;issues/&quot; + json.get(&quot;number&quot;).toString() + &quot;/comments&quot;)
250                 .body(&quot;body&quot;, body)
251                 .execute();
252         return parseComment(comment);
253     }
254 
</pre>
<hr />
<pre>
408                       .sorted()
409                       .collect(Collectors.toList());
410     }
411 
412     @Override
413     public URI getWebUrl() {
414         var host = (GitHubHost)repository.host();
415         var endpoint = &quot;/&quot; + repository.getName() + &quot;/pull/&quot; + getId();
416         return host.getWebURI(endpoint);
417     }
418 
419     @Override
420     public String toString() {
421         return &quot;GitHubPullRequest #&quot; + getId() + &quot; by &quot; + getAuthor();
422     }
423 
424     @Override
425     public List&lt;HostUserDetails&gt; getAssignees() {
426         return json.get(&quot;assignees&quot;).asArray()
427                                     .stream()
<span class="line-modified">428                                     .map(host::parseUserDetails)</span>
429                                     .collect(Collectors.toList());
430     }
431 
432     @Override
433     public void setAssignees(List&lt;HostUserDetails&gt; assignees) {
434         var assignee_ids = JSON.array();
435         for (var assignee : assignees) {
436             assignee_ids.add(assignee.userName());
437         }
438         var param = JSON.object().put(&quot;assignees&quot;, assignee_ids);
439         request.patch(&quot;issues/&quot; + json.get(&quot;number&quot;).toString()).body(param).execute();
440     }
441 }
</pre>
</td>
<td>
<hr />
<pre>
 43 
 44     GitHubPullRequest(GitHubRepository repository, JSONValue jsonValue, RestRequest request) {
 45         this.host = (GitHubHost)repository.host();
 46         this.repository = repository;
 47         this.request = request;
 48         this.json = jsonValue;
 49     }
 50 
 51     @Override
 52     public HostedRepository repository() {
 53         return repository;
 54     }
 55 
 56     @Override
 57     public String getId() {
 58         return json.get(&quot;number&quot;).toString();
 59     }
 60 
 61     @Override
 62     public HostUserDetails getAuthor() {
<span class="line-modified"> 63         return host.parseUserField(json);</span>
 64     }
 65 
 66     @Override
 67     public List&lt;Review&gt; getReviews() {
 68         var reviews = request.get(&quot;pulls/&quot; + json.get(&quot;number&quot;).toString() + &quot;/reviews&quot;).execute().stream()
 69                              .map(JSONValue::asObject)
 70                              .filter(obj -&gt; !(obj.get(&quot;state&quot;).asString().equals(&quot;COMMENTED&quot;) &amp;&amp; obj.get(&quot;body&quot;).asString().isEmpty()))
 71                              .map(obj -&gt; {
<span class="line-modified"> 72                                  var reviewer = host.parseUserField(obj);</span>
 73                                  var hash = new Hash(obj.get(&quot;commit_id&quot;).asString());
 74                                  Review.Verdict verdict;
 75                                  switch (obj.get(&quot;state&quot;).asString()) {
 76                                      case &quot;APPROVED&quot;:
 77                                          verdict = Review.Verdict.APPROVED;
 78                                          break;
 79                                      case &quot;CHANGES_REQUESTED&quot;:
 80                                          verdict = Review.Verdict.DISAPPROVED;
 81                                          break;
 82                                      default:
 83                                          verdict = Review.Verdict.NONE;
 84                                          break;
 85                                  }
 86                                  var id = obj.get(&quot;id&quot;).asInt();
 87                                  var body = obj.get(&quot;body&quot;).asString();
 88                                  return new Review(reviewer, verdict, hash, id, body);
 89                              })
 90                              .collect(Collectors.toList());
 91         return reviews;
 92     }
</pre>
<hr />
<pre>
 95     public void addReview(Review.Verdict verdict, String body) {
 96         var query = JSON.object();
 97         switch (verdict) {
 98             case APPROVED:
 99                 query.put(&quot;event&quot;, &quot;APPROVE&quot;);
100                 break;
101             case DISAPPROVED:
102                 query.put(&quot;event&quot;, &quot;REQUEST_CHANGES&quot;);
103                 break;
104             case NONE:
105                 query.put(&quot;event&quot;, &quot;COMMENT&quot;);
106                 break;
107         }
108         query.put(&quot;body&quot;, body);
109         request.post(&quot;pulls/&quot; + json.get(&quot;number&quot;).toString() + &quot;/reviews&quot;)
110                .body(query)
111                .execute();
112     }
113 
114     private ReviewComment parseReviewComment(ReviewComment parent, JSONObject json, PositionMapper diff) {
<span class="line-modified">115         var author = host.parseUserField(json);</span>
116         var threadId = parent == null ? json.get(&quot;id&quot;).toString() : parent.threadId();
117         var comment = new ReviewComment(parent,
118                                         threadId,
119                                         new Hash(json.get(&quot;commit_id&quot;).asString()),
120                                         json.get(&quot;path&quot;).asString(),
121                                         diff.positionToLine(json.get(&quot;path&quot;).asString(), json.get(&quot;original_position&quot;).asInt()),
122                                         json.get(&quot;id&quot;).toString(),
123                                         json.get(&quot;body&quot;).asString(),
124                                         author,
125                                         ZonedDateTime.parse(json.get(&quot;created_at&quot;).asString()),
126                                         ZonedDateTime.parse(json.get(&quot;updated_at&quot;).asString()));
127         return comment;
128     }
129 
130     @Override
131     public ReviewComment addReviewComment(Hash base, Hash hash, String path, int line, String body) {
132         var rawDiff = request.get(&quot;pulls/&quot; + json.get(&quot;number&quot;).toString())
133                              .header(&quot;Accept&quot;, &quot;application/vnd.github.v3.diff&quot;)
134                              .executeUnparsed();
135         var diff = PositionMapper.parse(rawDiff);
</pre>
<hr />
<pre>
214 
215     @Override
216     public String getBody() {
217         var body = json.get(&quot;body&quot;).asString();
218         if (body == null) {
219             body = &quot;&quot;;
220         }
221         return body;
222     }
223 
224     @Override
225     public void setBody(String body) {
226         request.patch(&quot;pulls/&quot; + json.get(&quot;number&quot;).toString())
227                .body(&quot;body&quot;, body)
228                .execute();
229     }
230 
231     private Comment parseComment(JSONValue comment) {
232         var ret = new Comment(Integer.toString(comment.get(&quot;id&quot;).asInt()),
233                               comment.get(&quot;body&quot;).asString(),
<span class="line-modified">234                               host.parseUserField(comment),</span>
235                               ZonedDateTime.parse(comment.get(&quot;created_at&quot;).asString()),
236                               ZonedDateTime.parse(comment.get(&quot;updated_at&quot;).asString()));
237         return ret;
238     }
239 
240     @Override
241     public List&lt;Comment&gt; getComments() {
242         return request.get(&quot;issues/&quot; + json.get(&quot;number&quot;).toString() + &quot;/comments&quot;).execute().stream()
243                 .map(this::parseComment)
244                 .collect(Collectors.toList());
245     }
246 
247     @Override
248     public Comment addComment(String body) {
249         var comment = request.post(&quot;issues/&quot; + json.get(&quot;number&quot;).toString() + &quot;/comments&quot;)
250                 .body(&quot;body&quot;, body)
251                 .execute();
252         return parseComment(comment);
253     }
254 
</pre>
<hr />
<pre>
408                       .sorted()
409                       .collect(Collectors.toList());
410     }
411 
412     @Override
413     public URI getWebUrl() {
414         var host = (GitHubHost)repository.host();
415         var endpoint = &quot;/&quot; + repository.getName() + &quot;/pull/&quot; + getId();
416         return host.getWebURI(endpoint);
417     }
418 
419     @Override
420     public String toString() {
421         return &quot;GitHubPullRequest #&quot; + getId() + &quot; by &quot; + getAuthor();
422     }
423 
424     @Override
425     public List&lt;HostUserDetails&gt; getAssignees() {
426         return json.get(&quot;assignees&quot;).asArray()
427                                     .stream()
<span class="line-modified">428                                     .map(host::parseUserObject)</span>
429                                     .collect(Collectors.toList());
430     }
431 
432     @Override
433     public void setAssignees(List&lt;HostUserDetails&gt; assignees) {
434         var assignee_ids = JSON.array();
435         for (var assignee : assignees) {
436             assignee_ids.add(assignee.userName());
437         }
438         var param = JSON.object().put(&quot;assignees&quot;, assignee_ids);
439         request.patch(&quot;issues/&quot; + json.get(&quot;number&quot;).toString()).body(param).execute();
440     }
441 }
</pre>
</td>
</tr>
</table>
<center><a href="GitHubHost.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../skara.py.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>