<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames vcs/src/main/java/org/openjdk/skara/vcs/git/GitRepository.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.vcs.git;
  24 
  25 import org.openjdk.skara.process.*;
  26 import org.openjdk.skara.process.Process;
  27 import org.openjdk.skara.vcs.*;
  28 import org.openjdk.skara.vcs.tools.*;
  29 
  30 import java.io.*;
  31 import java.net.URI;
  32 import java.nio.file.*;
  33 import java.nio.charset.StandardCharsets;
  34 import java.time.*;
  35 import java.time.format.DateTimeFormatter;
  36 import java.util.*;
  37 import java.util.logging.Logger;
  38 import java.util.stream.Collectors;
  39 
  40 public class GitRepository implements Repository {
  41     private final Path dir;
  42     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.vcs.git&quot;);
  43     private Path cachedRoot = null;
  44 
  45     private java.lang.Process start(String... cmd) throws IOException {
  46         return start(Arrays.asList(cmd));
  47     }
  48 
  49     private java.lang.Process start(List&lt;String&gt; cmd) throws IOException {
  50         log.fine(&quot;Executing &quot; + String.join(&quot; &quot;, cmd));
  51         var pb = new ProcessBuilder(cmd);
  52         pb.directory(dir.toFile());
  53         pb.redirectError(ProcessBuilder.Redirect.DISCARD);
  54         return pb.start();
  55     }
  56 
  57     private static void stop(java.lang.Process p) throws IOException {
  58         if (p != null &amp;&amp; p.isAlive()) {
  59             var stream = p.getInputStream();
  60             var read = 0;
  61             var buf = new byte[128];
  62             while (read != -1) {
  63                 read = stream.read(buf);
  64             }
  65             try {
  66                 p.waitFor();
  67             } catch (InterruptedException e) {
  68                 throw new IOException(e);
  69             }
  70         }
  71     }
  72 
  73     private Execution capture(List&lt;String&gt; cmd) {
  74         return capture(cmd.toArray(new String[0]));
  75     }
  76 
  77     private Execution capture(String... cmd) {
  78         return capture(dir, cmd);
  79     }
  80 
  81     private static Execution capture(Path cwd, String... cmd) {
  82         return Process.capture(cmd)
  83                       .workdir(cwd)
  84                       .execute();
  85     }
  86 
  87     private static Execution capture(Path cwd, List&lt;String&gt; cmd) {
  88         return capture(cwd, cmd.toArray(new String[0]));
  89     }
  90 
  91     private static Execution.Result await(Execution e) throws IOException {
  92         var result = e.await();
  93         if (result.status() != 0) {
  94             throw new IOException(&quot;Unexpected exit code\n&quot; + result);
  95         }
  96         return result;
  97     }
  98 
  99     private static void await(java.lang.Process p) throws IOException {
 100         try {
 101             var res = p.waitFor();
 102             if (res != 0) {
 103                 throw new IOException(&quot;Unexpected exit code: &quot; + res);
 104             }
 105         } catch (InterruptedException e) {
 106             throw new IOException(e);
 107         }
 108     }
 109 
 110     public GitRepository(Path dir) {
 111         this.dir = dir.toAbsolutePath();
 112     }
 113 
 114     public List&lt;Branch&gt; branches() throws IOException {
 115         try (var p = capture(&quot;git&quot;, &quot;for-each-ref&quot;, &quot;--format=%(refname:short)&quot;, &quot;refs/heads&quot;)) {
 116             return await(p).stdout()
 117                            .stream()
 118                            .map(Branch::new)
 119                            .collect(Collectors.toList());
 120         }
 121     }
 122 
 123     public List&lt;Tag&gt; tags() throws IOException {
 124         try (var p = capture(&quot;git&quot;, &quot;for-each-ref&quot;, &quot;--format=%(refname:short)&quot;, &quot;refs/tags&quot;)) {
 125             return await(p).stdout()
 126                            .stream()
 127                            .map(Tag::new)
 128                            .collect(Collectors.toList());
 129         }
 130     }
 131 
 132     @Override
 133     public Commits commits() throws IOException {
 134         return new GitCommits(dir, &quot;--all&quot;, false, -1);
 135     }
 136 
 137     @Override
 138     public Commits commits(int n) throws IOException {
 139         return new GitCommits(dir, &quot;--all&quot;, false, n);
 140     }
 141 
 142     @Override
 143     public Commits commits(boolean reverse) throws IOException {
 144         return new GitCommits(dir, &quot;--all&quot;, reverse, -1);
 145     }
 146 
 147     @Override
 148     public Commits commits(int n, boolean reverse) throws IOException {
 149         return new GitCommits(dir, &quot;--all&quot;, reverse, n);
 150     }
 151 
 152     @Override
 153     public Commits commits(String range) throws IOException {
 154         return new GitCommits(dir, range, false, -1);
 155     }
 156 
 157     @Override
 158     public Commits commits(String range, int n) throws IOException {
 159         return new GitCommits(dir, range, false, n);
 160     }
 161 
 162     @Override
 163     public Commits commits(String range, boolean reverse) throws IOException {
 164         return new GitCommits(dir, range, reverse, -1);
 165     }
 166 
 167     @Override
 168     public Commits commits(String range, int n, boolean reverse) throws IOException {
 169         return new GitCommits(dir, range, reverse, n);
 170     }
 171 
 172     @Override
 173     public Optional&lt;Commit&gt; lookup(Hash h) throws IOException {
 174         var commits = commits(h.hex(), 1).asList();
 175         if (commits.size() != 1) {
 176             return Optional.empty();
 177         }
 178         return Optional.of(commits.get(0));
 179     }
 180 
 181     @Override
 182     public Optional&lt;Commit&gt; lookup(Branch b) throws IOException {
 183         var hash = resolve(b.name()).orElseThrow(() -&gt; new IOException(&quot;Branch &quot; + b.name() + &quot; not found&quot;));
 184         return lookup(hash);
 185     }
 186 
 187     @Override
 188     public Optional&lt;Commit&gt; lookup(Tag t) throws IOException {
 189         var hash = resolve(t.name()).orElseThrow(() -&gt; new IOException(&quot;Tag &quot; + t.name() + &quot; not found&quot;));
 190         return lookup(hash);
 191     }
 192 
 193     public List&lt;CommitMetadata&gt; commitMetadata() throws IOException {
 194         var revisions = &quot;--all&quot;;
 195         var p = start(&quot;git&quot;, &quot;rev-list&quot;, &quot;--format=&quot; + GitCommitMetadata.FORMAT, &quot;--no-abbrev&quot;, &quot;--reverse&quot;, &quot;--no-color&quot;, revisions);
 196         var reader = new UnixStreamReader(p.getInputStream());
 197         var result = new ArrayList&lt;CommitMetadata&gt;();
 198 
 199         var line = reader.readLine();
 200         while (line != null) {
 201             if (!line.startsWith(&quot;commit&quot;)) {
 202                 throw new IOException(&quot;Unexpected line: &quot; + line);
 203             }
 204 
 205             result.add(GitCommitMetadata.read(reader));
 206             line = reader.readLine();
 207         }
 208 
 209         await(p);
 210         return result;
 211     }
 212 
 213     private List&lt;Hash&gt; refs() throws IOException {
 214         try (var p = capture(&quot;git&quot;, &quot;show-ref&quot;, &quot;--hash&quot;, &quot;--abbrev&quot;)) {
 215             var res = p.await();
 216             if (res.status() == -1) {
 217                 if (res.stdout().size() != 0) {
 218                     throw new IOException(&quot;Unexpected output\n&quot; + res);
 219                 }
 220                 return new ArrayList&lt;&gt;();
 221             } else {
 222                 return res.stdout().stream()
 223                           .map(Hash::new)
 224                           .collect(Collectors.toList());
 225             }
 226         }
 227     }
 228 
 229     @Override
 230     public boolean isEmpty() throws IOException {
 231         int numLooseObjects = -1;
 232         int numPackedObjects = -1;
 233 
 234         try (var p = capture(&quot;git&quot;, &quot;count-objects&quot;, &quot;-v&quot;)) {
 235             var res = await(p);
 236             var stdout = res.stdout();
 237 
 238             for (var line : stdout) {
 239                 if (line.startsWith(&quot;count: &quot;)) {
 240                     try {
 241                         numLooseObjects = Integer.parseUnsignedInt(line.split(&quot; &quot;)[1]);
 242                     } catch (NumberFormatException e) {
 243                         throw new IOException(&quot;Unexpected &#39;count&#39; value\n&quot; + res, e);
 244                     }
 245 
 246                 } else if (line.startsWith(&quot;in-pack: &quot;)) {
 247                     try {
 248                         numPackedObjects = Integer.parseUnsignedInt(line.split(&quot; &quot;)[1]);
 249                     } catch (NumberFormatException e) {
 250                         throw new IOException(&quot;Unexpected &#39;in-pack&#39; value\n&quot; + res, e);
 251                     }
 252                 }
 253             }
 254         }
 255 
 256         return numLooseObjects == 0 &amp;&amp; numPackedObjects == 0 &amp;&amp; refs().size() == 0;
 257     }
 258 
 259     @Override
<a name="1" id="anc1"></a>




 260 
<a name="2" id="anc2"></a><span class="line-modified"> 261     public boolean isHealthy() throws IOException {</span>
<span class="line-modified"> 262         try (var p = capture(&quot;git&quot;, &quot;fsck&quot;, &quot;--connectivity-only&quot;)) {</span>





 263             if (p.await().status() != 0) {
 264                 return false;
 265             }
 266         }
<a name="3" id="anc3"></a>
 267         return true;
 268     }
 269 
 270     @Override
 271     public void clean() throws IOException {
 272         cachedRoot = null;
 273 
 274         try (var p = capture(&quot;git&quot;, &quot;clean&quot;, &quot;-x&quot;, &quot;-d&quot;, &quot;--force&quot;, &quot;--force&quot;)) {
 275             await(p);
 276         }
 277 
 278         try (var p = capture(&quot;git&quot;, &quot;reset&quot;, &quot;--hard&quot;)) {
 279             await(p);
 280         }
 281 
 282         try (var p = capture(&quot;git&quot;, &quot;rebase&quot;, &quot;--quit&quot;)) {
 283             p.await(); // Don&#39;t care about the result.
 284         }
 285     }
 286 
 287     @Override
 288     public void reset(Hash target, boolean hard) throws IOException {
 289         var cmd = new ArrayList&lt;&gt;(List.of(&quot;git&quot;, &quot;reset&quot;));
 290         if (hard) {
 291            cmd.add(&quot;--hard&quot;);
 292         }
 293         cmd.add(target.hex());
 294 
 295         try (var p = capture(cmd)) {
 296             await(p);
 297         }
 298     }
 299 
 300 
 301     @Override
 302     public void revert(Hash h) throws IOException {
 303         try (var p = capture(&quot;git&quot;, &quot;checkout&quot;, &quot;--recurse-submodules&quot;, h.hex(), &quot;--&quot;, &quot;.&quot;)) {
 304             await(p);
 305         }
 306     }
 307 
 308     @Override
 309     public Repository reinitialize() throws IOException {
 310         cachedRoot = null;
 311 
 312         Files.walk(dir)
 313              .map(Path::toFile)
 314              .sorted(Comparator.reverseOrder())
 315              .forEach(File::delete);
 316 
 317         return init();
 318     }
 319 
 320     @Override
 321     public Hash fetch(URI uri, String refspec) throws IOException {
 322         try (var p = capture(&quot;git&quot;, &quot;fetch&quot;, &quot;--recurse-submodules=on-demand&quot;, &quot;--tags&quot;, uri.toString(), refspec)) {
 323             await(p);
 324             return resolve(&quot;FETCH_HEAD&quot;).get();
 325         }
 326     }
 327 
 328     @Override
 329     public void fetchAll() throws IOException {
 330         try (var p = capture(&quot;git&quot;, &quot;fetch&quot;, &quot;--recurse-submodules=on-demand&quot;, &quot;--tags&quot;, &quot;--prune&quot;, &quot;--prune-tags&quot;, &quot;--all&quot;)) {
 331             await(p);
 332         }
 333     }
 334 
 335     @Override
 336     public void fetchRemote(String remote) throws IOException {
 337         try (var p = capture(&quot;git&quot;, &quot;fetch&quot;, &quot;--recurse-submodules=on-demand&quot;, &quot;--tags&quot;, &quot;--prune&quot;, &quot;--prune-tags&quot;, remote)) {
 338             await(p);
 339         }
 340     }
 341 
 342     private void checkout(String ref, boolean force) throws IOException {
 343         var cmd = new ArrayList&lt;String&gt;();
 344         cmd.addAll(List.of(&quot;git&quot;, &quot;-c&quot;, &quot;advice.detachedHead=false&quot;, &quot;checkout&quot;, &quot;--recurse-submodules&quot;));
 345         if (force) {
 346             cmd.add(&quot;--force&quot;);
 347         }
 348         cmd.add(ref);
 349         try (var p = capture(cmd)) {
 350             await(p);
 351         }
 352     }
 353 
 354     @Override
 355     public void checkout(Hash h, boolean force) throws IOException {
 356         checkout(h.hex(), force);
 357     }
 358 
 359     @Override
 360     public void checkout(Branch b, boolean force) throws IOException {
 361         checkout(b.name(), force);
 362     }
 363 
 364     @Override
 365     public Repository init() throws IOException {
 366         cachedRoot = null;
 367 
 368         if (!Files.exists(dir)) {
 369             Files.createDirectories(dir);
 370         }
 371 
 372         try (var p = capture(&quot;git&quot;, &quot;init&quot;)) {
 373             await(p);
 374             return this;
 375         }
 376     }
 377 
 378     @Override
 379     public void pushAll(URI uri) throws IOException {
 380         try (var p = capture(&quot;git&quot;, &quot;push&quot;, &quot;--mirror&quot;, uri.toString())) {
 381             await(p);
 382         }
 383     }
 384 
 385     @Override
 386     public void push(Hash hash, URI uri, String ref, boolean force) throws IOException {
 387         String refspec = force ? &quot;+&quot; : &quot;&quot;;
 388         if (!ref.startsWith(&quot;refs/&quot;)) {
 389             ref = &quot;refs/heads/&quot; + ref;
 390         }
 391         refspec += hash.hex() + &quot;:&quot; + ref;
 392 
 393         try (var p = capture(&quot;git&quot;, &quot;push&quot;, uri.toString(), refspec)) {
 394             await(p);
 395         }
 396     }
 397 
 398     @Override
 399     public void push(Branch branch, String remote, boolean setUpstream) throws IOException {
 400         var cmd = new ArrayList&lt;String&gt;();
 401         cmd.addAll(List.of(&quot;git&quot;, &quot;push&quot;, remote, branch.name()));
 402         if (setUpstream) {
 403             cmd.add(&quot;--set-upstream&quot;);
 404         }
 405 
 406         try (var p = capture(cmd)) {
 407             await(p);
 408         }
 409     }
 410 
 411     @Override
 412     public boolean isClean() throws IOException {
 413         try (var p = capture(&quot;git&quot;, &quot;status&quot;, &quot;--porcelain&quot;)) {
 414             var output = await(p);
 415             return output.stdout().size() == 0;
 416         }
 417     }
 418 
 419     @Override
 420     public boolean exists() throws IOException {
 421         if (!Files.exists(dir)) {
 422             return false;
 423         }
 424 
 425         try (var p = capture(&quot;git&quot;, &quot;rev-parse&quot;, &quot;--git-dir&quot;)) {
 426             return p.await().status() == 0;
 427         }
 428     }
 429 
 430     @Override
 431     public Path root() throws IOException {
 432         if (cachedRoot != null) {
 433             return cachedRoot;
 434         }
 435 
 436         try (var p = capture(&quot;git&quot;, &quot;rev-parse&quot;, &quot;--show-toplevel&quot;)) {
 437             var res = p.await();
 438             if (res.status() != 0 || res.stdout().size() != 1) {
 439                 // Perhaps this is a bare repository
 440                 try (var p2 = capture(&quot;git&quot;, &quot;rev-parse&quot;, &quot;--git-dir&quot;)) {
 441                     var res2 = await(p2);
 442                     if (res2.stdout().size() != 1) {
 443                         throw new IOException(&quot;Unexpected output\n&quot; + res2);
 444                     }
 445                     cachedRoot = dir.resolve(Path.of(res2.stdout().get(0)));
 446                     return cachedRoot;
 447                 }
 448             }
 449 
 450             cachedRoot = Path.of(res.stdout().get(0));
 451             return cachedRoot;
 452         }
 453     }
 454 
 455     @Override
 456     public void squash(Hash h) throws IOException {
 457         try (var p = capture(&quot;git&quot;, &quot;merge&quot;, &quot;--squash&quot;, h.hex())) {
 458             await(p);
 459         }
 460     }
 461 
 462     @FunctionalInterface
 463     private static interface Operation {
 464         void execute(List&lt;Path&gt; args) throws IOException;
 465     }
 466 
 467     private void batch(Operation op, List&lt;Path&gt; args) throws IOException {
 468         var batchSize = 64;
 469         var start = 0;
 470         while (start &lt; args.size()) {
 471             var end = start + batchSize;
 472             if (end &gt; args.size()) {
 473                 end = args.size();
 474             }
 475             op.execute(args.subList(start, end));
 476             start = end;
 477         }
 478     }
 479 
 480     private void addAll(List&lt;Path&gt; paths) throws IOException {
 481         var cmd = new ArrayList&lt;&gt;(List.of(&quot;git&quot;, &quot;add&quot;));
 482         for (var path : paths) {
 483             cmd.add(path.toString());
 484         }
 485         try (var p = capture(cmd)) {
 486             await(p);
 487         }
 488     }
 489 
 490     @Override
 491     public void add(List&lt;Path&gt; paths) throws IOException {
 492         batch(this::addAll, paths);
 493     }
 494 
 495     private void removeAll(List&lt;Path&gt; paths) throws IOException {
 496         var cmd = new ArrayList&lt;&gt;(List.of(&quot;git&quot;, &quot;rm&quot;));
 497         for (var path : paths) {
 498             cmd.add(path.toString());
 499         }
 500         try (var p = capture(cmd)) {
 501             await(p);
 502         }
 503     }
 504 
 505     @Override
 506     public void remove(List&lt;Path&gt; paths) throws IOException {
 507         batch(this::removeAll, paths);
 508     }
 509 
 510     @Override
 511     public void delete(Branch b) throws IOException {
 512         try (var p = capture(&quot;git&quot;, &quot;branch&quot;, &quot;-D&quot;, b.name())) {
 513             await(p);
 514         }
 515     }
 516 
 517     @Override
 518     public void addremove() throws IOException {
 519         try (var p = capture(&quot;git&quot;, &quot;add&quot;, &quot;--all&quot;)) {
 520             await(p);
 521         }
 522     }
 523 
 524     @Override
 525     public Hash commit(String message, String authorName, String authorEmail)  throws IOException {
 526         return commit(message, authorName, authorEmail, null);
 527     }
 528 
 529     @Override
 530     public Hash commit(String message, String authorName, String authorEmail, ZonedDateTime authorDate)  throws IOException {
 531         return commit(message, authorName, authorEmail, authorDate, authorName, authorEmail, authorDate);
 532     }
 533 
 534     @Override
 535     public Hash commit(String message,
 536                        String authorName,
 537                        String authorEmail,
 538                        String committerName,
 539                        String committerEmail) throws IOException {
 540         return commit(message, authorName, authorEmail, null, committerName, committerEmail, null);
 541     }
 542 
 543     @Override
 544     public Hash commit(String message,
 545                        String authorName,
 546                        String authorEmail,
 547                        ZonedDateTime authorDate,
 548                        String committerName,
 549                        String committerEmail,
 550                        ZonedDateTime committerDate) throws IOException {
 551         var cmd = Process.capture(&quot;git&quot;, &quot;commit&quot;, &quot;--message=&quot; + message)
 552                          .workdir(dir)
 553                          .environ(&quot;GIT_AUTHOR_NAME&quot;, authorName)
 554                          .environ(&quot;GIT_AUTHOR_EMAIL&quot;, authorEmail)
 555                          .environ(&quot;GIT_COMMITTER_NAME&quot;, committerName)
 556                          .environ(&quot;GIT_COMMITTER_EMAIL&quot;, committerEmail);
 557         if (authorDate != null) {
 558             cmd = cmd.environ(&quot;GIT_AUTHOR_DATE&quot;,
 559                               authorDate.format(DateTimeFormatter.ISO_OFFSET_DATE_TIME));
 560         }
 561         if (committerDate != null) {
 562             cmd = cmd.environ(&quot;GIT_COMMITTER_DATE&quot;,
 563                               committerDate.format(DateTimeFormatter.ISO_OFFSET_DATE_TIME));
 564         }
 565         try (var p = cmd.execute()) {
 566             await(p);
 567             return head();
 568         }
 569     }
 570 
 571     @Override
 572     public Hash amend(String message, String authorName, String authorEmail) throws IOException {
 573         return amend(message, authorName, authorEmail, null, null);
 574     }
 575 
 576     @Override
 577     public Hash amend(String message, String authorName, String authorEmail, String committerName, String committerEmail) throws IOException {
 578         if (committerName == null) {
 579             committerName = authorName;
 580             committerEmail = authorEmail;
 581         }
 582         var cmd = Process.capture(&quot;git&quot;, &quot;commit&quot;, &quot;--amend&quot;, &quot;--reset-author&quot;, &quot;--message=&quot; + message)
 583                          .workdir(dir)
 584                          .environ(&quot;GIT_AUTHOR_NAME&quot;, authorName)
 585                          .environ(&quot;GIT_AUTHOR_EMAIL&quot;, authorEmail)
 586                          .environ(&quot;GIT_COMMITTER_NAME&quot;, committerName)
 587                          .environ(&quot;GIT_COMMITTER_EMAIL&quot;, committerEmail);
 588         try (var p = cmd.execute()) {
 589             await(p);
 590             return head();
 591         }
 592     }
 593 
 594     @Override
 595     public Tag tag(Hash hash, String name, String message, String authorName, String authorEmail) throws IOException {
 596         var cmd = Process.capture(&quot;git&quot;, &quot;tag&quot;, &quot;--annotate&quot;, &quot;--message=&quot; + message, name, hash.hex())
 597                          .workdir(dir)
 598                          .environ(&quot;GIT_AUTHOR_NAME&quot;, authorName)
 599                          .environ(&quot;GIT_AUTHOR_EMAIL&quot;, authorEmail)
 600                          .environ(&quot;GIT_COMMITTER_NAME&quot;, authorName)
 601                          .environ(&quot;GIT_COMMITTER_EMAIL&quot;, authorEmail);
 602         try (var p = cmd.execute()) {
 603             await(p);
 604         }
 605 
 606         return new Tag(name);
 607     }
 608 
 609     @Override
 610     public Branch branch(Hash hash, String name) throws IOException {
 611         try (var p = capture(&quot;git&quot;, &quot;branch&quot;, name, hash.hex())) {
 612             await(p);
 613         }
 614 
 615         return new Branch(name);
 616     }
 617 
 618     @Override
 619     public void prune(Branch branch, String remote) throws IOException {
 620         try (var p = capture(&quot;git&quot;, &quot;push&quot;, &quot;--delete&quot;, remote, branch.name())) {
 621             await(p);
 622         }
 623         try (var p = capture(&quot;git&quot;, &quot;branch&quot;, &quot;--delete&quot;, &quot;--force&quot;, branch.name())) {
 624             await(p);
 625         }
 626     }
 627 
 628     @Override
 629     public Hash mergeBase(Hash first, Hash second) throws IOException {
 630         try (var p = capture(&quot;git&quot;, &quot;merge-base&quot;, first.hex(), second.hex())) {
 631             var res = await(p);
 632             if (res.stdout().size() != 1) {
 633                  throw new IOException(&quot;Unexpected output\n&quot; + res);
 634             }
 635             return new Hash(res.stdout().get(0));
 636         }
 637     }
 638 
 639     @Override
 640     public boolean isAncestor(Hash ancestor, Hash descendant) throws IOException {
 641         try (var p = capture(&quot;git&quot;, &quot;merge-base&quot;, &quot;--is-ancestor&quot;, ancestor.hex(), descendant.hex())) {
 642             var res = p.await();
 643             return res.status() == 0;
 644         }
 645     }
 646 
 647     @Override
 648     public void rebase(Hash hash, String committerName, String committerEmail) throws IOException {
 649         try (var p = Process.capture(&quot;git&quot;, &quot;rebase&quot;, &quot;--onto&quot;, hash.hex(), &quot;--root&quot;, &quot;--rebase-merges&quot;)
 650                             .environ(&quot;GIT_COMMITTER_NAME&quot;, committerName)
 651                             .environ(&quot;GIT_COMMITTER_EMAIL&quot;, committerEmail)
 652                             .workdir(dir)
 653                             .execute()) {
 654             await(p);
 655         }
 656     }
 657 
 658     @Override
 659     public Optional&lt;Hash&gt; resolve(String ref) throws IOException {
 660         try (var p = capture(&quot;git&quot;, &quot;rev-parse&quot;, ref + &quot;^{commit}&quot;)) {
 661             var res = p.await();
 662             if (res.status() == 0 &amp;&amp; res.stdout().size() == 1) {
 663                 return Optional.of(new Hash(res.stdout().get(0)));
 664             }
 665             return Optional.empty();
 666         }
 667     }
 668 
 669     @Override
 670     public Optional&lt;Branch&gt; currentBranch() throws IOException {
 671         try (var p = capture(&quot;git&quot;, &quot;symbolic-ref&quot;, &quot;--short&quot;, &quot;HEAD&quot;)) {
 672             var res = p.await();
 673             if (res.status() == 0 &amp;&amp; res.stdout().size() == 1) {
 674                 return Optional.of(new Branch(res.stdout().get(0)));
 675             }
 676             return Optional.empty();
 677         }
 678     }
 679 
 680     @Override
 681     public Optional&lt;Bookmark&gt; currentBookmark() throws IOException {
 682         throw new RuntimeException(&quot;git does not have bookmarks&quot;);
 683     }
 684 
 685     @Override
 686     public Branch defaultBranch() throws IOException {
 687         try (var p = capture(&quot;git&quot;, &quot;symbolic-ref&quot;, &quot;--short&quot;, &quot;refs/remotes/origin/HEAD&quot;)) {
 688             var res = p.await();
 689             if (res.status() == 0 &amp;&amp; res.stdout().size() == 1) {
 690                 var ref = res.stdout().get(0).substring(&quot;origin/&quot;.length());
 691                 return new Branch(ref);
 692             } else {
 693                 return new Branch(&quot;master&quot;);
 694             }
 695         }
 696     }
 697 
 698     @Override
 699     public Optional&lt;Tag&gt; defaultTag() throws IOException {
 700         return Optional.empty();
 701     }
 702 
 703     @Override
 704     public Optional&lt;String&gt; username() throws IOException {
 705         var lines = config(&quot;user.name&quot;);
 706         return lines.size() == 1 ? Optional.of(lines.get(0)) : Optional.empty();
 707     }
 708 
 709     private String treeEntry(Path path, Hash hash) throws IOException {
 710         try (var p = Process.capture(&quot;git&quot;, &quot;ls-tree&quot;, hash.hex(), path.toString())
 711                             .workdir(root())
 712                             .execute()) {
 713             var res = await(p);
 714             if (res.stdout().size() == 0) {
 715                 return null;
 716             }
 717             if (res.stdout().size() &gt; 1) {
 718                 throw new IOException(&quot;Unexpected output\n&quot; + res);
 719             }
 720             return res.stdout().get(0);
 721         }
 722     }
 723 
 724     private List&lt;FileEntry&gt; allFiles(Hash hash, List&lt;Path&gt; paths) throws IOException {
 725         var cmd = new ArrayList&lt;String&gt;();
 726         cmd.addAll(List.of(&quot;git&quot;, &quot;ls-tree&quot;, &quot;-r&quot;));
 727         cmd.add(hash.hex());
 728         cmd.addAll(paths.stream().map(Path::toString).collect(Collectors.toList()));
 729         try (var p = Process.capture(cmd.toArray(new String[0]))
 730                             .workdir(root())
 731                             .execute()) {
 732             var res = await(p);
 733             var entries = new ArrayList&lt;FileEntry&gt;();
 734             for (var line : res.stdout()) {
 735                 var parts = line.split(&quot;\t&quot;);
 736                 var metadata = parts[0].split(&quot; &quot;);
 737                 var filename = parts[1];
 738 
 739                 var entry = new FileEntry(hash,
 740                                           FileType.fromOctal(metadata[0]),
 741                                           new Hash(metadata[2]),
 742                                           Path.of(filename));
 743                 entries.add(entry);
 744             }
 745             return entries;
 746         }
 747     }
 748 
 749     @Override
 750     public List&lt;FileEntry&gt; files(Hash hash, List&lt;Path&gt; paths) throws IOException {
 751         if (paths.isEmpty()) {
 752             return allFiles(hash, paths);
 753         }
 754 
 755         var entries = new ArrayList&lt;FileEntry&gt;();
 756         var batchSize = 64;
 757         var start = 0;
 758         while (start &lt; paths.size()) {
 759             var end = start + batchSize;
 760             if (end &gt; paths.size()) {
 761                 end = paths.size();
 762             }
 763             entries.addAll(allFiles(hash, paths.subList(start, end)));
 764             start = end;
 765         }
 766         return entries;
 767     }
 768 
 769     private Path unpackFile(String blob) throws IOException {
 770         try (var p = capture(&quot;git&quot;, &quot;unpack-file&quot;, blob)) {
 771             var res = await(p);
 772             if (res.stdout().size() != 1) {
 773                 throw new IOException(&quot;Unexpected output\n&quot; + res);
 774             }
 775 
 776             return Path.of(root().toString(), res.stdout().get(0));
 777         }
 778     }
 779 
 780     @Override
 781     public Optional&lt;byte[]&gt; show(Path path, Hash hash) throws IOException {
 782         var entries = files(hash, path);
 783         if (entries.size() == 0) {
 784             return Optional.empty();
 785         } else if (entries.size() &gt; 1) {
 786             throw new IOException(&quot;Multiple files match path &quot; + path.toString() + &quot; in commit &quot; + hash.hex());
 787         }
 788 
 789         var entry = entries.get(0);
 790         var type = entry.type();
 791         if (type.isVCSLink()) {
 792             var content = &quot;Subproject commit &quot; + entry.hash().hex() + &quot; &quot; + entry.path().toString();
 793             return Optional.of(content.getBytes(StandardCharsets.UTF_8));
 794         } else if (type.isRegular()) {
 795             var tmp = unpackFile(entry.hash().hex());
 796             var content = Files.readAllBytes(tmp);
 797             Files.delete(tmp);
 798             return Optional.of(content);
 799         }
 800 
 801         return Optional.empty();
 802     }
 803 
 804     @Override
 805     public void dump(FileEntry entry, Path to) throws IOException {
 806         var type = entry.type();
 807         if (type.isRegular()) {
 808             var path = unpackFile(entry.hash().hex());
 809             Files.createDirectories(to.getParent());
 810             Files.move(path, to, StandardCopyOption.REPLACE_EXISTING);
 811         }
 812     }
 813 
 814     @Override
 815     public List&lt;StatusEntry&gt; status(Hash from, Hash to) throws IOException {
 816         try (var p = capture(&quot;git&quot;, &quot;diff&quot;, &quot;--raw&quot;, &quot;--find-renames=99%&quot;, &quot;--find-copies=99%&quot;, &quot;--find-copies-harder&quot;, &quot;--no-abbrev&quot;, &quot;--no-color&quot;, from.hex(), to.hex())) {
 817             var res = await(p);
 818             var entries = new ArrayList&lt;StatusEntry&gt;();
 819             for (var line : res.stdout()) {
 820                 entries.add(StatusEntry.fromRawLine(line));
 821             }
 822             return entries;
 823         }
 824     }
 825 
 826     @Override
 827     public Diff diff(Hash from) throws IOException {
 828         return diff(from, List.of());
 829     }
 830 
 831     @Override
 832     public Diff diff(Hash from, List&lt;Path&gt; files) throws IOException {
 833         return diff(from, null, files);
 834     }
 835 
 836     @Override
 837     public Diff diff(Hash from, Hash to) throws IOException {
 838         return diff(from, to, List.of());
 839     }
 840 
 841     @Override
 842     public Diff diff(Hash from, Hash to, List&lt;Path&gt; files) throws IOException {
 843         var cmd = new ArrayList&lt;&gt;(List.of(&quot;git&quot;, &quot;diff&quot;, &quot;--patch&quot;,
 844                                                          &quot;--find-renames=99%&quot;,
 845                                                          &quot;--find-copies=99%&quot;,
 846                                                          &quot;--find-copies-harder&quot;,
 847                                                          &quot;--binary&quot;,
 848                                                          &quot;--raw&quot;,
 849                                                          &quot;--no-abbrev&quot;,
 850                                                          &quot;--unified=0&quot;,
 851                                                          &quot;--no-color&quot;,
 852                                                          from.hex()));
 853         if (to != null) {
 854             cmd.add(to.hex());
 855         }
 856 
 857         if (files != null &amp;&amp; !files.isEmpty()) {
 858             cmd.add(&quot;--&quot;);
 859             for (var file : files) {
 860                 cmd.add(file.toString());
 861             }
 862         }
 863 
 864         var p = start(cmd);
 865         try {
 866             var patches = UnifiedDiffParser.parseGitRaw(p.getInputStream());
 867             await(p);
 868             return new Diff(from, to, patches);
 869         } catch (Throwable t) {
 870             stop(p);
 871             throw t;
 872         }
 873     }
 874 
 875     @Override
 876     public List&lt;String&gt; config(String key) throws IOException {
 877         try (var p = capture(&quot;git&quot;, &quot;config&quot;, key)) {
 878             var res = p.await();
 879             return res.status() == 0 ? res.stdout() : List.of();
 880         }
 881     }
 882 
 883     @Override
 884     public Hash head() throws IOException {
 885         return resolve(&quot;HEAD&quot;).orElseThrow(() -&gt; new IllegalStateException(&quot;HEAD ref is not present&quot;));
 886     }
 887 
 888     public static Optional&lt;Repository&gt; get(Path p) throws IOException {
 889         if (!Files.exists(p)) {
 890             return Optional.empty();
 891         }
 892 
 893         var r = new GitRepository(p);
 894         return r.exists() ? Optional.of(new GitRepository(r.root())) : Optional.empty();
 895     }
 896 
 897     @Override
 898     public Repository copyTo(Path destination) throws IOException {
 899         try (var p = capture(&quot;git&quot;, &quot;clone&quot;, &quot;--recurse-submodules&quot;, root().toString(), destination.toString())) {
 900             await(p);
 901         }
 902 
 903         return new GitRepository(destination);
 904     }
 905 
 906     @Override
 907     public void merge(Hash h) throws IOException {
 908         merge(h, null);
 909     }
 910 
 911     @Override
 912     public void merge(Hash h, String strategy) throws IOException {
 913         var cmd = new ArrayList&lt;String&gt;();
 914         cmd.addAll(List.of(&quot;git&quot;, &quot;-c&quot;, &quot;user.name=unused&quot;, &quot;-c&quot;, &quot;user.email=unused&quot;,
 915                            &quot;merge&quot;, &quot;--no-commit&quot;));
 916         if (strategy != null) {
 917             cmd.add(&quot;-s&quot;);
 918             cmd.add(strategy);
 919         }
 920         cmd.add(h.hex());
 921         try (var p = capture(cmd)) {
 922             await(p);
 923         }
 924     }
 925 
 926     @Override
 927     public void abortMerge() throws IOException {
 928         try (var p = capture(&quot;git&quot;, &quot;merge&quot;, &quot;--abort&quot;)) {
 929             await(p);
 930         }
 931     }
 932 
 933     @Override
 934     public void addRemote(String name, String pullPath) throws IOException {
 935         try (var p = capture(&quot;git&quot;, &quot;remote&quot;, &quot;add&quot;, name, pullPath)) {
 936             await(p);
 937         }
 938     }
 939 
 940     @Override
 941     public void setPaths(String remote, String pullPath, String pushPath) throws IOException {
 942         pullPath = pullPath == null ? &quot;&quot; : pullPath;
 943         try (var p = capture(&quot;git&quot;, &quot;config&quot;, &quot;remote.&quot; + remote + &quot;.url&quot;, pullPath)) {
 944             await(p);
 945         }
 946 
 947         pushPath = pushPath == null ? &quot;&quot; : pushPath;
 948         try (var p = capture(&quot;git&quot;, &quot;config&quot;, &quot;remote.&quot; + remote + &quot;.pushurl&quot;, pushPath)) {
 949             await(p);
 950         }
 951     }
 952 
 953     @Override
 954     public String pullPath(String remote) throws IOException {
 955         var lines = config(&quot;remote.&quot; + remote + &quot;.url&quot;);
 956         if (lines.size() != 1) {
 957             throw new IOException(&quot;No pull path found for remote &quot; + remote);
 958         }
 959         return lines.get(0);
 960     }
 961 
 962     @Override
 963     public String pushPath(String remote) throws IOException {
 964         var lines = config(&quot;remote.&quot; + remote + &quot;.pushurl&quot;);
 965         if (lines.size() != 1) {
 966             return pullPath(remote);
 967         }
 968         return lines.get(0);
 969     }
 970 
 971     @Override
 972     public boolean isValidRevisionRange(String expression) throws IOException {
 973         try (var p = capture(&quot;git&quot;, &quot;rev-parse&quot;, expression)) {
 974             return p.await().status() == 0;
 975         }
 976     }
 977 
 978     private void applyPatch(Patch patch) throws IOException {
 979         if (patch.isEmpty()) {
 980             return;
 981         }
 982 
 983         if (patch.isTextual()) {
 984         } else {
 985             throw new IllegalArgumentException(&quot;Cannot handle binary patches yet&quot;);
 986         }
 987     }
 988 
 989     @Override
 990     public void apply(Diff diff, boolean force) throws IOException {
 991         // ignore force, no such concept in git
 992         var patchFile = Files.createTempFile(&quot;apply&quot;, &quot;.patch&quot;);
 993         diff.toFile(patchFile);
 994         apply(patchFile, force);
 995         Files.delete(patchFile);
 996     }
 997 
 998     @Override
 999     public void apply(Path patchFile, boolean force)  throws IOException {
1000         var cmd = new ArrayList&lt;String&gt;();
1001         cmd.addAll(List.of(&quot;git&quot;, &quot;apply&quot;, &quot;--index&quot;, &quot;--unidiff-zero&quot;));
1002         cmd.add(patchFile.toAbsolutePath().toString());
1003         try (var p = capture(cmd)) {
1004             await(p);
1005             Files.delete(patchFile);
1006         }
1007     }
1008 
1009     @Override
1010     public void copy(Path from, Path to) throws IOException {
1011         Files.copy(from, to);
1012         add(to);
1013     }
1014 
1015     @Override
1016     public void move(Path from, Path to) throws IOException {
1017         try (var p = capture(&quot;git&quot;, &quot;mv&quot;, from.toString(), to.toString())) {
1018             await(p);
1019         }
1020     }
1021 
1022     @Override
1023     public Optional&lt;String&gt; upstreamFor(Branch b) throws IOException {
1024         try (var p = capture(&quot;git&quot;, &quot;for-each-ref&quot;, &quot;--format=%(upstream:short)&quot;, &quot;refs/heads/&quot; + b.name())) {
1025             var lines = await(p).stdout();
1026             return lines.size() == 1 &amp;&amp; !lines.get(0).isEmpty()? Optional.of(lines.get(0)) : Optional.empty();
1027         }
1028     }
1029 
1030     public static Repository clone(URI from, Path to, boolean isBare) throws IOException {
1031         var cmd = new ArrayList&lt;String&gt;();
1032         cmd.addAll(List.of(&quot;git&quot;, &quot;clone&quot;));
1033         if (isBare) {
1034             cmd.add(&quot;--bare&quot;);
1035         } else {
1036             cmd.add(&quot;--recurse-submodules&quot;);
1037         }
1038         cmd.addAll(List.of(from.toString(), to.toString()));
1039         try (var p = capture(Path.of(&quot;&quot;).toAbsolutePath(), cmd)) {
1040             await(p);
1041         }
1042         return new GitRepository(to);
1043     }
1044 
1045     public static Repository mirror(URI from, Path to) throws IOException {
1046         var cwd = Path.of(&quot;&quot;).toAbsolutePath();
1047         try (var p = capture(cwd, &quot;git&quot;, &quot;clone&quot;, &quot;--mirror&quot;, from.toString(), to.toString())) {
1048             await(p);
1049         }
1050         return new GitRepository(to);
1051     }
1052 
1053     @Override
1054     public void pull() throws IOException {
1055         pull(null, null);
1056     }
1057 
1058     @Override
1059     public void pull(String remote) throws IOException {
1060         pull(remote, null);
1061     }
1062 
1063 
1064     @Override
1065     public void pull(String remote, String refspec) throws IOException {
1066         var cmd = new ArrayList&lt;String&gt;();
1067         cmd.add(&quot;git&quot;);
1068         cmd.add(&quot;pull&quot;);
1069         if (remote != null) {
1070             cmd.add(remote);
1071         }
1072         if (refspec != null) {
1073             cmd.add(refspec);
1074         }
1075         try (var p = capture(cmd)) {
1076             await(p);
1077         }
1078     }
1079 
1080     @Override
1081     public boolean contains(Branch b, Hash h) throws IOException {
1082         try (var p = capture(&quot;git&quot;, &quot;for-each-ref&quot;, &quot;--contains&quot;, h.hex(), &quot;--format&quot;, &quot;%(refname:short)&quot;)) {
1083             var res = await(p);
1084             for (var line : res.stdout()) {
1085                 if (line.equals(b.name())) {
1086                     return true;
1087                 }
1088             }
1089         }
1090 
1091         return false;
1092     }
1093 
1094     @Override
1095     public List&lt;Reference&gt; remoteBranches(String remote) throws IOException {
1096         var refs = new ArrayList&lt;Reference&gt;();
1097         try (var p = capture(&quot;git&quot;, &quot;ls-remote&quot;, &quot;--heads&quot;, &quot;--refs&quot;, remote)) {
1098             for (var line : await(p).stdout()) {
1099                 var parts = line.split(&quot;\t&quot;);
1100                 var name = parts[1].replace(&quot;refs/heads/&quot;, &quot;&quot;);
1101                 refs.add(new Reference(name, new Hash(parts[0])));
1102             }
1103         }
1104         return refs;
1105     }
1106 
1107     @Override
1108     public List&lt;String&gt; remotes() throws IOException {
1109         var remotes = new ArrayList&lt;String&gt;();
1110         try (var p = capture(&quot;git&quot;, &quot;remote&quot;)) {
1111             for (var line : await(p).stdout()) {
1112                 remotes.add(line);
1113             }
1114         }
1115         return remotes;
1116     }
1117 
1118     @Override
1119     public void addSubmodule(String pullPath, Path path) throws IOException {
1120         try (var p = capture(&quot;git&quot;, &quot;submodule&quot;, &quot;add&quot;, pullPath, path.toString())) {
1121             await(p);
1122         }
1123     }
1124 
1125     @Override
1126     public List&lt;Submodule&gt; submodules() throws IOException {
1127         var gitModules = root().resolve(&quot;.gitmodules&quot;);
1128         if (!Files.exists(gitModules)) {
1129             return List.of();
1130         }
1131 
1132         var urls = new HashMap&lt;String, String&gt;();
1133         var paths = new HashMap&lt;String, String&gt;();
1134         try (var p = capture(&quot;git&quot;, &quot;config&quot;, &quot;--file&quot;, gitModules.toAbsolutePath().toString(),
1135                                               &quot;--list&quot;)) {
1136             for (var line : await(p).stdout()) {
1137                 if (line.startsWith(&quot;submodule.&quot;)) {
1138                     line = line.substring(&quot;submodule.&quot;.length());
1139                     var parts = line.split(&quot;=&quot;);
1140                     var nameAndProperty = parts[0].split(&quot;\\.&quot;);
1141                     var name = nameAndProperty[0];
1142                     var prop = nameAndProperty[1];
1143                     var value = parts[1];
1144                     if (prop.equals(&quot;path&quot;)) {
1145                         paths.put(name, value);
1146                     } else if (prop.equals(&quot;url&quot;)) {
1147                         urls.put(name, value);
1148                     } else {
1149                         throw new IOException(&quot;Unexpected submodule property: &quot; + prop);
1150                     }
1151                 }
1152             }
1153         }
1154 
1155         var hashes = new HashMap&lt;String, String&gt;();
1156         try (var p = capture(&quot;git&quot;, &quot;submodule&quot;, &quot;status&quot;)) {
1157             for (var line : await(p).stdout()) {
1158                 var parts = line.substring(1).split(&quot; &quot;);
1159                 var hash = parts[0];
1160                 var path = parts[1];
1161                 hashes.put(path, hash);
1162             }
1163         }
1164 
1165         var modules = new ArrayList&lt;Submodule&gt;();
1166         for (var name : paths.keySet()) {
1167             var url = urls.get(name);
1168             var path = paths.get(name);
1169             var hash = hashes.get(path);
1170 
1171             modules.add(new Submodule(new Hash(hash), Path.of(path), url));
1172         }
1173 
1174         return modules;
1175     }
1176 
1177     @Override
1178     public Optional&lt;Tag.Annotated&gt; annotate(Tag tag) throws IOException {
1179         var ref = &quot;refs/tags/&quot; + tag.name();
1180         var format = &quot;%(refname:short)%0a%(*objectname)%0a%(taggername) %(taggeremail)%0a%(taggerdate:iso-strict)%0a%(contents)&quot;;
1181         try (var p = capture(&quot;git&quot;, &quot;for-each-ref&quot;, &quot;--format&quot;, format, ref)) {
1182             var lines = await(p).stdout();
1183             if (lines.size() &gt;= 4) {
1184                 var name = lines.get(0);
1185                 var target = new Hash(lines.get(1));
1186                 var author = Author.fromString(lines.get(2));
1187 
1188                 var formatter = DateTimeFormatter.ISO_OFFSET_DATE_TIME;
1189                 var date = ZonedDateTime.parse(lines.get(3), formatter);
1190                 var message = String.join(&quot;\n&quot;, lines.subList(4, lines.size()));
1191 
1192                 return Optional.of(new Tag.Annotated(name, target, author, date, message));
1193             }
1194             return Optional.empty();
1195         }
1196     }
1197 
1198     @Override
1199     public void config(String section, String key, String value, boolean global) throws IOException {
1200         var cmd = new ArrayList&lt;String&gt;();
1201         cmd.addAll(List.of(&quot;git&quot;, &quot;config&quot;));
1202         if (global) {
1203             cmd.add(&quot;--global&quot;);
1204         }
1205         cmd.add(section + &quot;.&quot; + key);
1206         cmd.add(value);
1207         try (var p = capture(cmd)) {
1208             await(p);
1209         }
1210     }
1211 }
<a name="4" id="anc4"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="4" type="hidden" />
</body>
</html>