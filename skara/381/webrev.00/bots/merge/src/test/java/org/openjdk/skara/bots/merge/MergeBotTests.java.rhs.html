<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames bots/merge/src/test/java/org/openjdk/skara/bots/merge/MergeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.merge;
  24 
  25 import org.openjdk.skara.host.*;
  26 import org.openjdk.skara.test.*;
  27 import org.openjdk.skara.vcs.*;
  28 
  29 import org.junit.jupiter.api.Test;
  30 import org.junit.jupiter.api.TestInfo;
  31 
  32 import java.io.IOException;
  33 import java.nio.file.Files;
  34 import java.nio.file.StandardOpenOption;
  35 import java.util.*;
  36 import java.util.stream.Collectors;
<a name="1" id="anc1"></a><span class="line-added">  37 import java.time.DayOfWeek;</span>
<span class="line-added">  38 import java.time.Month;</span>
  39 import java.time.ZonedDateTime;
<a name="2" id="anc2"></a><span class="line-added">  40 import java.time.ZoneId;</span>
  41 
  42 import static org.junit.jupiter.api.Assertions.*;
  43 
  44 class MergeBotTests {
  45     @Test
  46     void mergeMasterBranch(TestInfo testInfo) throws IOException {
  47         try (var temp = new TemporaryDirectory(false)) {
  48             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
  49 
  50             var fromDir = temp.path().resolve(&quot;from.git&quot;);
  51             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
  52             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
  53 
  54             var toDir = temp.path().resolve(&quot;to.git&quot;);
  55             var toLocalRepo = Repository.init(toDir, VCS.GIT);
  56             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
  57             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
  58                         StandardOpenOption.APPEND);
  59             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
  60 
  61             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
  62             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
  63             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
  64             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
  65                         StandardOpenOption.APPEND);
  66             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
  67 
  68             var now = ZonedDateTime.now();
  69             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
  70             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
  71             fromLocalRepo.add(fromFileA);
  72             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
  73             var fromCommits = fromLocalRepo.commits().asList();
  74             assertEquals(1, fromCommits.size());
  75             assertEquals(fromHashA, fromCommits.get(0).hash());
  76 
  77             var toFileA = toDir.resolve(&quot;a.txt&quot;);
  78             Files.writeString(toFileA, &quot;Hello A\n&quot;);
  79             toLocalRepo.add(toFileA);
  80             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
  81             var toCommits = toLocalRepo.commits().asList();
  82             assertEquals(1, toCommits.size());
  83             assertEquals(toHashA, toCommits.get(0).hash());
  84             assertEquals(fromHashA, toHashA);
  85 
  86             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
  87             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
  88             fromLocalRepo.add(fromFileB);
  89             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
  90 
  91             var toFileC = toDir.resolve(&quot;c.txt&quot;);
  92             Files.writeString(toFileC, &quot;Hello C\n&quot;);
  93             toLocalRepo.add(toFileC);
  94             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
  95 
  96             var storage = temp.path().resolve(&quot;storage&quot;);
  97             var master = new Branch(&quot;master&quot;);
  98             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
  99             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 100             TestBotRunner.runPeriodicItems(bot);
 101 
 102             toCommits = toLocalRepo.commits().asList();
 103             assertEquals(4, toCommits.size());
 104             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 105             assertTrue(hashes.contains(toHashA));
 106             assertTrue(hashes.contains(fromHashB));
 107             assertTrue(hashes.contains(toHashC));
 108 
 109             var known = Set.of(toHashA, fromHashB, toHashC);
 110             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
 111             assertTrue(merge.isMerge());
 112             assertEquals(List.of(&quot;Merge&quot;), merge.message());
 113             assertEquals(&quot;duke&quot;, merge.author().name());
 114             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
 115 
 116             assertEquals(0, toHostedRepo.pullRequests().size());
 117         }
 118     }
 119 
 120     @Test
 121     void failingMergeTest(TestInfo testInfo) throws IOException {
 122         try (var temp = new TemporaryDirectory(false)) {
 123             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 124 
 125             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 126             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 127             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 128 
 129             var toDir = temp.path().resolve(&quot;to.git&quot;);
 130             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 131             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 132             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 133                         StandardOpenOption.APPEND);
 134             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 135 
 136             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 137             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 138             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 139             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 140                         StandardOpenOption.APPEND);
 141             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 142 
 143             var now = ZonedDateTime.now();
 144             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 145             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 146             fromLocalRepo.add(fromFileA);
 147             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 148             var fromCommits = fromLocalRepo.commits().asList();
 149             assertEquals(1, fromCommits.size());
 150             assertEquals(fromHashA, fromCommits.get(0).hash());
 151 
 152             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 153             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 154             toLocalRepo.add(toFileA);
 155             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 156             var toCommits = toLocalRepo.commits().asList();
 157             assertEquals(1, toCommits.size());
 158             assertEquals(toHashA, toCommits.get(0).hash());
 159             assertEquals(fromHashA, toHashA);
 160 
 161             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 162             Files.writeString(fromFileB, &quot;Hello B1\n&quot;);
 163             fromLocalRepo.add(fromFileB);
 164             var fromHashB = fromLocalRepo.commit(&quot;Adding b1.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 165 
 166             var toFileB = toDir.resolve(&quot;b.txt&quot;);
 167             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
 168             toLocalRepo.add(toFileB);
 169             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 170 
 171             var storage = temp.path().resolve(&quot;storage&quot;);
 172             var master = new Branch(&quot;master&quot;);
 173             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
 174             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 175             TestBotRunner.runPeriodicItems(bot);
 176 
 177             toCommits = toLocalRepo.commits().asList();
 178             assertEquals(2, toCommits.size());
 179             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 180             assertTrue(toHashes.contains(toHashA));
 181             assertTrue(toHashes.contains(toHashB));
 182 
 183             var pullRequests = toHostedRepo.pullRequests();
 184             assertEquals(1, pullRequests.size());
 185             var pr = pullRequests.get(0);
 186             assertEquals(&quot;Cannot automatically merge test:master to master&quot;, pr.title());
 187         }
 188     }
 189 
 190     @Test
 191     void failingMergeShouldResultInOnlyOnePR(TestInfo testInfo) throws IOException {
 192         try (var temp = new TemporaryDirectory(false)) {
 193             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 194 
 195             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 196             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 197             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 198 
 199             var toDir = temp.path().resolve(&quot;to.git&quot;);
 200             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 201             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 202             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 203                         StandardOpenOption.APPEND);
 204             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 205 
 206             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 207             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 208             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 209             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 210                         StandardOpenOption.APPEND);
 211             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 212 
 213             var now = ZonedDateTime.now();
 214             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 215             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 216             fromLocalRepo.add(fromFileA);
 217             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 218             var fromCommits = fromLocalRepo.commits().asList();
 219             assertEquals(1, fromCommits.size());
 220             assertEquals(fromHashA, fromCommits.get(0).hash());
 221 
 222             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 223             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 224             toLocalRepo.add(toFileA);
 225             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 226             var toCommits = toLocalRepo.commits().asList();
 227             assertEquals(1, toCommits.size());
 228             assertEquals(toHashA, toCommits.get(0).hash());
 229             assertEquals(fromHashA, toHashA);
 230 
 231             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 232             Files.writeString(fromFileB, &quot;Hello B1\n&quot;);
 233             fromLocalRepo.add(fromFileB);
 234             var fromHashB = fromLocalRepo.commit(&quot;Adding b1.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 235 
 236             var toFileB = toDir.resolve(&quot;b.txt&quot;);
 237             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
 238             toLocalRepo.add(toFileB);
 239             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 240 
 241             var storage = temp.path().resolve(&quot;storage&quot;);
 242             var master = new Branch(&quot;master&quot;);
 243             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
 244             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 245             TestBotRunner.runPeriodicItems(bot);
 246             TestBotRunner.runPeriodicItems(bot);
 247 
 248             toCommits = toLocalRepo.commits().asList();
 249             assertEquals(2, toCommits.size());
 250             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 251             assertTrue(toHashes.contains(toHashA));
 252             assertTrue(toHashes.contains(toHashB));
 253 
 254             var pullRequests = toHostedRepo.pullRequests();
 255             assertEquals(1, pullRequests.size());
 256             var pr = pullRequests.get(0);
 257             assertEquals(&quot;Cannot automatically merge test:master to master&quot;, pr.title());
 258         }
 259     }
 260 
 261     @Test
 262     void resolvedMergeConflictShouldResultInClosedPR(TestInfo testInfo) throws IOException {
 263         try (var temp = new TemporaryDirectory(false)) {
 264             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 265 
 266             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 267             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 268             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 269 
 270             var toDir = temp.path().resolve(&quot;to.git&quot;);
 271             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 272             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 273             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 274                         StandardOpenOption.APPEND);
 275             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 276 
 277             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 278             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 279             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 280             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 281                         StandardOpenOption.APPEND);
 282             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 283 
 284             var now = ZonedDateTime.now();
 285             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 286             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 287             fromLocalRepo.add(fromFileA);
 288             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 289             var fromCommits = fromLocalRepo.commits().asList();
 290             assertEquals(1, fromCommits.size());
 291             assertEquals(fromHashA, fromCommits.get(0).hash());
 292 
 293             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 294             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 295             toLocalRepo.add(toFileA);
 296             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 297             var toCommits = toLocalRepo.commits().asList();
 298             assertEquals(1, toCommits.size());
 299             assertEquals(toHashA, toCommits.get(0).hash());
 300             assertEquals(fromHashA, toHashA);
 301 
 302             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 303             Files.writeString(fromFileB, &quot;Hello B1\n&quot;);
 304             fromLocalRepo.add(fromFileB);
 305             var fromHashB = fromLocalRepo.commit(&quot;Adding b1.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 306 
 307             var toFileB = toDir.resolve(&quot;b.txt&quot;);
 308             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
 309             toLocalRepo.add(toFileB);
 310             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 311 
 312             var storage = temp.path().resolve(&quot;storage&quot;);
 313             var master = new Branch(&quot;master&quot;);
 314             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
 315             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 316             TestBotRunner.runPeriodicItems(bot);
 317             TestBotRunner.runPeriodicItems(bot);
 318 
 319             toCommits = toLocalRepo.commits().asList();
 320             assertEquals(2, toCommits.size());
 321             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 322             assertTrue(toHashes.contains(toHashA));
 323             assertTrue(toHashes.contains(toHashB));
 324 
 325             var pullRequests = toHostedRepo.pullRequests();
 326             assertEquals(1, pullRequests.size());
 327             var pr = pullRequests.get(0);
 328             assertEquals(&quot;Cannot automatically merge test:master to master&quot;, pr.title());
 329 
 330             var fetchHead = toLocalRepo.fetch(fromHostedRepo.webUrl(), &quot;master&quot;);
 331             toLocalRepo.merge(fetchHead, &quot;ours&quot;);
 332             toLocalRepo.commit(&quot;Merge&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 333 
 334             toCommits = toLocalRepo.commits().asList();
 335             assertEquals(4, toCommits.size());
 336 
 337             TestBotRunner.runPeriodicItems(bot);
 338             pullRequests = toHostedRepo.pullRequests();
 339             assertEquals(0, pullRequests.size());
 340         }
 341     }
 342 
 343     @Test
 344     void resolvedMergeConflictAndThenNewConflict(TestInfo testInfo) throws IOException {
 345         try (var temp = new TemporaryDirectory(false)) {
 346             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 347 
 348             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 349             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 350             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 351 
 352             var toDir = temp.path().resolve(&quot;to.git&quot;);
 353             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 354             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 355             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 356                         StandardOpenOption.APPEND);
 357             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 358 
 359             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 360             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 361             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 362             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 363                         StandardOpenOption.APPEND);
 364             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 365 
 366             var now = ZonedDateTime.now();
 367             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 368             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 369             fromLocalRepo.add(fromFileA);
 370             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 371             var fromCommits = fromLocalRepo.commits().asList();
 372             assertEquals(1, fromCommits.size());
 373             assertEquals(fromHashA, fromCommits.get(0).hash());
 374 
 375             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 376             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 377             toLocalRepo.add(toFileA);
 378             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 379             var toCommits = toLocalRepo.commits().asList();
 380             assertEquals(1, toCommits.size());
 381             assertEquals(toHashA, toCommits.get(0).hash());
 382             assertEquals(fromHashA, toHashA);
 383 
 384             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 385             Files.writeString(fromFileB, &quot;Hello B1\n&quot;);
 386             fromLocalRepo.add(fromFileB);
 387             var fromHashB = fromLocalRepo.commit(&quot;Adding b1.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 388 
 389             var toFileB = toDir.resolve(&quot;b.txt&quot;);
 390             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
 391             toLocalRepo.add(toFileB);
 392             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 393 
 394             var storage = temp.path().resolve(&quot;storage&quot;);
 395             var master = new Branch(&quot;master&quot;);
 396             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
 397             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 398             TestBotRunner.runPeriodicItems(bot);
 399             TestBotRunner.runPeriodicItems(bot);
 400 
 401             toCommits = toLocalRepo.commits().asList();
 402             assertEquals(2, toCommits.size());
 403             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 404             assertTrue(toHashes.contains(toHashA));
 405             assertTrue(toHashes.contains(toHashB));
 406 
 407             var pullRequests = toHostedRepo.pullRequests();
 408             assertEquals(1, pullRequests.size());
 409             var pr = pullRequests.get(0);
 410             assertEquals(&quot;Cannot automatically merge test:master to master&quot;, pr.title());
 411 
 412             var fetchHead = toLocalRepo.fetch(fromHostedRepo.webUrl(), &quot;master&quot;);
 413             toLocalRepo.merge(fetchHead, &quot;ours&quot;);
 414             toLocalRepo.commit(&quot;Merge&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 415 
 416             toCommits = toLocalRepo.commits().asList();
 417             assertEquals(4, toCommits.size());
 418 
 419             TestBotRunner.runPeriodicItems(bot);
 420             pullRequests = toHostedRepo.pullRequests();
 421             assertEquals(0, pullRequests.size());
 422 
 423             var fromFileC = fromDir.resolve(&quot;c.txt&quot;);
 424             Files.writeString(fromFileC, &quot;Hello C1\n&quot;);
 425             fromLocalRepo.add(fromFileC);
 426             fromLocalRepo.commit(&quot;Adding c1&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 427 
 428             var toFileC = toDir.resolve(&quot;c.txt&quot;);
 429             Files.writeString(toFileC, &quot;Hello C2\n&quot;);
 430             toLocalRepo.add(toFileC);
 431             toLocalRepo.commit(&quot;Adding c2&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 432 
 433             TestBotRunner.runPeriodicItems(bot);
 434             pullRequests = toHostedRepo.pullRequests();
 435             assertEquals(1, pullRequests.size());
 436             assertEquals(&quot;Cannot automatically merge test:master to master&quot;, pr.title());
 437         }
 438     }
<a name="3" id="anc3"></a><span class="line-added"> 439 </span>
<span class="line-added"> 440     final static class TestClock implements Clock {</span>
<span class="line-added"> 441         ZonedDateTime now;</span>
<span class="line-added"> 442 </span>
<span class="line-added"> 443         TestClock() {</span>
<span class="line-added"> 444             this(null);</span>
<span class="line-added"> 445         }</span>
<span class="line-added"> 446 </span>
<span class="line-added"> 447         TestClock(ZonedDateTime now) {</span>
<span class="line-added"> 448             this.now = now;</span>
<span class="line-added"> 449         }</span>
<span class="line-added"> 450 </span>
<span class="line-added"> 451         @Override</span>
<span class="line-added"> 452         public ZonedDateTime now() {</span>
<span class="line-added"> 453             return now;</span>
<span class="line-added"> 454         }</span>
<span class="line-added"> 455     }</span>
<span class="line-added"> 456 </span>
<span class="line-added"> 457     @Test</span>
<span class="line-added"> 458     void testMergeHourly(TestInfo testInfo) throws IOException {</span>
<span class="line-added"> 459         try (var temp = new TemporaryDirectory(false)) {</span>
<span class="line-added"> 460             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));</span>
<span class="line-added"> 461 </span>
<span class="line-added"> 462             var fromDir = temp.path().resolve(&quot;from.git&quot;);</span>
<span class="line-added"> 463             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);</span>
<span class="line-added"> 464             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);</span>
<span class="line-added"> 465 </span>
<span class="line-added"> 466             var toDir = temp.path().resolve(&quot;to.git&quot;);</span>
<span class="line-added"> 467             var toLocalRepo = Repository.init(toDir, VCS.GIT);</span>
<span class="line-added"> 468             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="line-added"> 469             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
<span class="line-added"> 470                         StandardOpenOption.APPEND);</span>
<span class="line-added"> 471             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);</span>
<span class="line-added"> 472 </span>
<span class="line-added"> 473             var forkDir = temp.path().resolve(&quot;fork.git&quot;);</span>
<span class="line-added"> 474             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);</span>
<span class="line-added"> 475             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="line-added"> 476             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
<span class="line-added"> 477                         StandardOpenOption.APPEND);</span>
<span class="line-added"> 478             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);</span>
<span class="line-added"> 479 </span>
<span class="line-added"> 480             var now = ZonedDateTime.now();</span>
<span class="line-added"> 481             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);</span>
<span class="line-added"> 482             Files.writeString(fromFileA, &quot;Hello A\n&quot;);</span>
<span class="line-added"> 483             fromLocalRepo.add(fromFileA);</span>
<span class="line-added"> 484             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);</span>
<span class="line-added"> 485             var fromCommits = fromLocalRepo.commits().asList();</span>
<span class="line-added"> 486             assertEquals(1, fromCommits.size());</span>
<span class="line-added"> 487             assertEquals(fromHashA, fromCommits.get(0).hash());</span>
<span class="line-added"> 488 </span>
<span class="line-added"> 489             var toFileA = toDir.resolve(&quot;a.txt&quot;);</span>
<span class="line-added"> 490             Files.writeString(toFileA, &quot;Hello A\n&quot;);</span>
<span class="line-added"> 491             toLocalRepo.add(toFileA);</span>
<span class="line-added"> 492             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);</span>
<span class="line-added"> 493             var toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added"> 494             assertEquals(1, toCommits.size());</span>
<span class="line-added"> 495             assertEquals(toHashA, toCommits.get(0).hash());</span>
<span class="line-added"> 496             assertEquals(fromHashA, toHashA);</span>
<span class="line-added"> 497 </span>
<span class="line-added"> 498             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);</span>
<span class="line-added"> 499             Files.writeString(fromFileB, &quot;Hello B\n&quot;);</span>
<span class="line-added"> 500             fromLocalRepo.add(fromFileB);</span>
<span class="line-added"> 501             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);</span>
<span class="line-added"> 502 </span>
<span class="line-added"> 503             var toFileC = toDir.resolve(&quot;c.txt&quot;);</span>
<span class="line-added"> 504             Files.writeString(toFileC, &quot;Hello C\n&quot;);</span>
<span class="line-added"> 505             toLocalRepo.add(toFileC);</span>
<span class="line-added"> 506             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);</span>
<span class="line-added"> 507 </span>
<span class="line-added"> 508             var storage = temp.path().resolve(&quot;storage&quot;);</span>
<span class="line-added"> 509             var master = new Branch(&quot;master&quot;);</span>
<span class="line-added"> 510 </span>
<span class="line-added"> 511             // Merge only at most once during the first minute every hour</span>
<span class="line-added"> 512             var freq = MergeBot.Spec.Frequency.hourly(1);</span>
<span class="line-added"> 513             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));</span>
<span class="line-added"> 514 </span>
<span class="line-added"> 515             var clock = new TestClock(ZonedDateTime.of(2020, 1, 23, 15, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));</span>
<span class="line-added"> 516             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);</span>
<span class="line-added"> 517 </span>
<span class="line-added"> 518             TestBotRunner.runPeriodicItems(bot);</span>
<span class="line-added"> 519 </span>
<span class="line-added"> 520             // Ensure nothing has been merged</span>
<span class="line-added"> 521             toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added"> 522             assertEquals(2, toCommits.size());</span>
<span class="line-added"> 523             assertEquals(toHashC, toCommits.get(0).hash());</span>
<span class="line-added"> 524             assertEquals(toHashA, toCommits.get(1).hash());</span>
<span class="line-added"> 525 </span>
<span class="line-added"> 526             // Set the clock to the first minute of the hour</span>
<span class="line-added"> 527             clock.now = ZonedDateTime.of(2020, 1, 23, 15, 1, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="line-added"> 528             TestBotRunner.runPeriodicItems(bot);</span>
<span class="line-added"> 529 </span>
<span class="line-added"> 530             // Should have merged</span>
<span class="line-added"> 531             toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added"> 532             assertEquals(4, toCommits.size());</span>
<span class="line-added"> 533             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());</span>
<span class="line-added"> 534             assertTrue(hashes.contains(toHashA));</span>
<span class="line-added"> 535             assertTrue(hashes.contains(fromHashB));</span>
<span class="line-added"> 536             assertTrue(hashes.contains(toHashC));</span>
<span class="line-added"> 537 </span>
<span class="line-added"> 538             var known = Set.of(toHashA, fromHashB, toHashC);</span>
<span class="line-added"> 539             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();</span>
<span class="line-added"> 540             assertTrue(merge.isMerge());</span>
<span class="line-added"> 541             assertEquals(List.of(&quot;Merge&quot;), merge.message());</span>
<span class="line-added"> 542             assertEquals(&quot;duke&quot;, merge.author().name());</span>
<span class="line-added"> 543             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());</span>
<span class="line-added"> 544 </span>
<span class="line-added"> 545             assertEquals(0, toHostedRepo.pullRequests().size());</span>
<span class="line-added"> 546 </span>
<span class="line-added"> 547             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);</span>
<span class="line-added"> 548             Files.writeString(fromFileD, &quot;Hello D\n&quot;);</span>
<span class="line-added"> 549             fromLocalRepo.add(fromFileD);</span>
<span class="line-added"> 550             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);</span>
<span class="line-added"> 551 </span>
<span class="line-added"> 552             // Since the time hasn&#39;t changed it should not merge again</span>
<span class="line-added"> 553             TestBotRunner.runPeriodicItems(bot);</span>
<span class="line-added"> 554             toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added"> 555             assertEquals(4, toCommits.size());</span>
<span class="line-added"> 556 </span>
<span class="line-added"> 557             // Move the minutes forward, the bot should not merge</span>
<span class="line-added"> 558             clock.now = ZonedDateTime.of(2020, 1, 23, 15, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="line-added"> 559             TestBotRunner.runPeriodicItems(bot);</span>
<span class="line-added"> 560             toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added"> 561             assertEquals(4, toCommits.size());</span>
<span class="line-added"> 562 </span>
<span class="line-added"> 563             // Move the clock forward one hour, the bot should merge</span>
<span class="line-added"> 564             clock.now = ZonedDateTime.of(2020, 1, 23, 16, 1, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="line-added"> 565             TestBotRunner.runPeriodicItems(bot);</span>
<span class="line-added"> 566 </span>
<span class="line-added"> 567             toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added"> 568             assertEquals(6, toCommits.size());</span>
<span class="line-added"> 569         }</span>
<span class="line-added"> 570     }</span>
<span class="line-added"> 571 </span>
<span class="line-added"> 572     @Test</span>
<span class="line-added"> 573     void testMergeDaily(TestInfo testInfo) throws IOException {</span>
<span class="line-added"> 574         try (var temp = new TemporaryDirectory(false)) {</span>
<span class="line-added"> 575             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));</span>
<span class="line-added"> 576 </span>
<span class="line-added"> 577             var fromDir = temp.path().resolve(&quot;from.git&quot;);</span>
<span class="line-added"> 578             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);</span>
<span class="line-added"> 579             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);</span>
<span class="line-added"> 580 </span>
<span class="line-added"> 581             var toDir = temp.path().resolve(&quot;to.git&quot;);</span>
<span class="line-added"> 582             var toLocalRepo = Repository.init(toDir, VCS.GIT);</span>
<span class="line-added"> 583             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="line-added"> 584             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
<span class="line-added"> 585                         StandardOpenOption.APPEND);</span>
<span class="line-added"> 586             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);</span>
<span class="line-added"> 587 </span>
<span class="line-added"> 588             var forkDir = temp.path().resolve(&quot;fork.git&quot;);</span>
<span class="line-added"> 589             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);</span>
<span class="line-added"> 590             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="line-added"> 591             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
<span class="line-added"> 592                         StandardOpenOption.APPEND);</span>
<span class="line-added"> 593             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);</span>
<span class="line-added"> 594 </span>
<span class="line-added"> 595             var now = ZonedDateTime.now();</span>
<span class="line-added"> 596             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);</span>
<span class="line-added"> 597             Files.writeString(fromFileA, &quot;Hello A\n&quot;);</span>
<span class="line-added"> 598             fromLocalRepo.add(fromFileA);</span>
<span class="line-added"> 599             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);</span>
<span class="line-added"> 600             var fromCommits = fromLocalRepo.commits().asList();</span>
<span class="line-added"> 601             assertEquals(1, fromCommits.size());</span>
<span class="line-added"> 602             assertEquals(fromHashA, fromCommits.get(0).hash());</span>
<span class="line-added"> 603 </span>
<span class="line-added"> 604             var toFileA = toDir.resolve(&quot;a.txt&quot;);</span>
<span class="line-added"> 605             Files.writeString(toFileA, &quot;Hello A\n&quot;);</span>
<span class="line-added"> 606             toLocalRepo.add(toFileA);</span>
<span class="line-added"> 607             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);</span>
<span class="line-added"> 608             var toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added"> 609             assertEquals(1, toCommits.size());</span>
<span class="line-added"> 610             assertEquals(toHashA, toCommits.get(0).hash());</span>
<span class="line-added"> 611             assertEquals(fromHashA, toHashA);</span>
<span class="line-added"> 612 </span>
<span class="line-added"> 613             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);</span>
<span class="line-added"> 614             Files.writeString(fromFileB, &quot;Hello B\n&quot;);</span>
<span class="line-added"> 615             fromLocalRepo.add(fromFileB);</span>
<span class="line-added"> 616             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);</span>
<span class="line-added"> 617 </span>
<span class="line-added"> 618             var toFileC = toDir.resolve(&quot;c.txt&quot;);</span>
<span class="line-added"> 619             Files.writeString(toFileC, &quot;Hello C\n&quot;);</span>
<span class="line-added"> 620             toLocalRepo.add(toFileC);</span>
<span class="line-added"> 621             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);</span>
<span class="line-added"> 622 </span>
<span class="line-added"> 623             var storage = temp.path().resolve(&quot;storage&quot;);</span>
<span class="line-added"> 624             var master = new Branch(&quot;master&quot;);</span>
<span class="line-added"> 625 </span>
<span class="line-added"> 626             // Merge only at most once during the third hour every day</span>
<span class="line-added"> 627             var freq = MergeBot.Spec.Frequency.daily(3);</span>
<span class="line-added"> 628             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));</span>
<span class="line-added"> 629 </span>
<span class="line-added"> 630             var clock = new TestClock(ZonedDateTime.of(2020, 1, 23, 2, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));</span>
<span class="line-added"> 631             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);</span>
<span class="line-added"> 632 </span>
<span class="line-added"> 633             TestBotRunner.runPeriodicItems(bot);</span>
<span class="line-added"> 634 </span>
<span class="line-added"> 635             // Ensure nothing has been merged</span>
<span class="line-added"> 636             toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added"> 637             assertEquals(2, toCommits.size());</span>
<span class="line-added"> 638             assertEquals(toHashC, toCommits.get(0).hash());</span>
<span class="line-added"> 639             assertEquals(toHashA, toCommits.get(1).hash());</span>
<span class="line-added"> 640 </span>
<span class="line-added"> 641             // Set the clock to the third hour of the day (minutes should not matter)</span>
<span class="line-added"> 642             clock.now = ZonedDateTime.of(2020, 1, 23, 3, 37, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="line-added"> 643             TestBotRunner.runPeriodicItems(bot);</span>
<span class="line-added"> 644 </span>
<span class="line-added"> 645             // Should have merged</span>
<span class="line-added"> 646             toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added"> 647             assertEquals(4, toCommits.size());</span>
<span class="line-added"> 648             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());</span>
<span class="line-added"> 649             assertTrue(hashes.contains(toHashA));</span>
<span class="line-added"> 650             assertTrue(hashes.contains(fromHashB));</span>
<span class="line-added"> 651             assertTrue(hashes.contains(toHashC));</span>
<span class="line-added"> 652 </span>
<span class="line-added"> 653             var known = Set.of(toHashA, fromHashB, toHashC);</span>
<span class="line-added"> 654             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();</span>
<span class="line-added"> 655             assertTrue(merge.isMerge());</span>
<span class="line-added"> 656             assertEquals(List.of(&quot;Merge&quot;), merge.message());</span>
<span class="line-added"> 657             assertEquals(&quot;duke&quot;, merge.author().name());</span>
<span class="line-added"> 658             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());</span>
<span class="line-added"> 659 </span>
<span class="line-added"> 660             assertEquals(0, toHostedRepo.pullRequests().size());</span>
<span class="line-added"> 661 </span>
<span class="line-added"> 662             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);</span>
<span class="line-added"> 663             Files.writeString(fromFileD, &quot;Hello D\n&quot;);</span>
<span class="line-added"> 664             fromLocalRepo.add(fromFileD);</span>
<span class="line-added"> 665             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);</span>
<span class="line-added"> 666 </span>
<span class="line-added"> 667             // Since the time hasn&#39;t changed it should not merge</span>
<span class="line-added"> 668             TestBotRunner.runPeriodicItems(bot);</span>
<span class="line-added"> 669             toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added"> 670             assertEquals(4, toCommits.size());</span>
<span class="line-added"> 671 </span>
<span class="line-added"> 672             // Move the minutes forward, the bot should not merge</span>
<span class="line-added"> 673             clock.now = ZonedDateTime.of(2020, 1, 23, 3, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="line-added"> 674             TestBotRunner.runPeriodicItems(bot);</span>
<span class="line-added"> 675             toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added"> 676             assertEquals(4, toCommits.size());</span>
<span class="line-added"> 677 </span>
<span class="line-added"> 678             // Move the hours forward, the bot should not merge</span>
<span class="line-added"> 679             clock.now = ZonedDateTime.of(2020, 1, 23, 17, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="line-added"> 680             TestBotRunner.runPeriodicItems(bot);</span>
<span class="line-added"> 681             toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added"> 682             assertEquals(4, toCommits.size());</span>
<span class="line-added"> 683 </span>
<span class="line-added"> 684             // Move the clock forward one day, the bot should merge</span>
<span class="line-added"> 685             clock.now = ZonedDateTime.of(2020, 1, 24, 3, 55, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="line-added"> 686             TestBotRunner.runPeriodicItems(bot);</span>
<span class="line-added"> 687 </span>
<span class="line-added"> 688             toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added"> 689             assertEquals(6, toCommits.size());</span>
<span class="line-added"> 690         }</span>
<span class="line-added"> 691     }</span>
<span class="line-added"> 692 </span>
<span class="line-added"> 693     @Test</span>
<span class="line-added"> 694     void testMergeWeekly(TestInfo testInfo) throws IOException {</span>
<span class="line-added"> 695         try (var temp = new TemporaryDirectory(false)) {</span>
<span class="line-added"> 696             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));</span>
<span class="line-added"> 697 </span>
<span class="line-added"> 698             var fromDir = temp.path().resolve(&quot;from.git&quot;);</span>
<span class="line-added"> 699             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);</span>
<span class="line-added"> 700             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);</span>
<span class="line-added"> 701 </span>
<span class="line-added"> 702             var toDir = temp.path().resolve(&quot;to.git&quot;);</span>
<span class="line-added"> 703             var toLocalRepo = Repository.init(toDir, VCS.GIT);</span>
<span class="line-added"> 704             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="line-added"> 705             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
<span class="line-added"> 706                         StandardOpenOption.APPEND);</span>
<span class="line-added"> 707             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);</span>
<span class="line-added"> 708 </span>
<span class="line-added"> 709             var forkDir = temp.path().resolve(&quot;fork.git&quot;);</span>
<span class="line-added"> 710             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);</span>
<span class="line-added"> 711             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="line-added"> 712             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
<span class="line-added"> 713                         StandardOpenOption.APPEND);</span>
<span class="line-added"> 714             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);</span>
<span class="line-added"> 715 </span>
<span class="line-added"> 716             var now = ZonedDateTime.now();</span>
<span class="line-added"> 717             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);</span>
<span class="line-added"> 718             Files.writeString(fromFileA, &quot;Hello A\n&quot;);</span>
<span class="line-added"> 719             fromLocalRepo.add(fromFileA);</span>
<span class="line-added"> 720             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);</span>
<span class="line-added"> 721             var fromCommits = fromLocalRepo.commits().asList();</span>
<span class="line-added"> 722             assertEquals(1, fromCommits.size());</span>
<span class="line-added"> 723             assertEquals(fromHashA, fromCommits.get(0).hash());</span>
<span class="line-added"> 724 </span>
<span class="line-added"> 725             var toFileA = toDir.resolve(&quot;a.txt&quot;);</span>
<span class="line-added"> 726             Files.writeString(toFileA, &quot;Hello A\n&quot;);</span>
<span class="line-added"> 727             toLocalRepo.add(toFileA);</span>
<span class="line-added"> 728             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);</span>
<span class="line-added"> 729             var toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added"> 730             assertEquals(1, toCommits.size());</span>
<span class="line-added"> 731             assertEquals(toHashA, toCommits.get(0).hash());</span>
<span class="line-added"> 732             assertEquals(fromHashA, toHashA);</span>
<span class="line-added"> 733 </span>
<span class="line-added"> 734             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);</span>
<span class="line-added"> 735             Files.writeString(fromFileB, &quot;Hello B\n&quot;);</span>
<span class="line-added"> 736             fromLocalRepo.add(fromFileB);</span>
<span class="line-added"> 737             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);</span>
<span class="line-added"> 738 </span>
<span class="line-added"> 739             var toFileC = toDir.resolve(&quot;c.txt&quot;);</span>
<span class="line-added"> 740             Files.writeString(toFileC, &quot;Hello C\n&quot;);</span>
<span class="line-added"> 741             toLocalRepo.add(toFileC);</span>
<span class="line-added"> 742             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);</span>
<span class="line-added"> 743 </span>
<span class="line-added"> 744             var storage = temp.path().resolve(&quot;storage&quot;);</span>
<span class="line-added"> 745             var master = new Branch(&quot;master&quot;);</span>
<span class="line-added"> 746 </span>
<span class="line-added"> 747             // Merge only at most once per week on Friday&#39;s at 12:00</span>
<span class="line-added"> 748             var freq = MergeBot.Spec.Frequency.weekly(DayOfWeek.FRIDAY, 12);</span>
<span class="line-added"> 749             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));</span>
<span class="line-added"> 750 </span>
<span class="line-added"> 751             var clock = new TestClock(ZonedDateTime.of(2020, 1, 24, 11, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));</span>
<span class="line-added"> 752             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);</span>
<span class="line-added"> 753 </span>
<span class="line-added"> 754             TestBotRunner.runPeriodicItems(bot);</span>
<span class="line-added"> 755 </span>
<span class="line-added"> 756             // Ensure nothing has been merged</span>
<span class="line-added"> 757             toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added"> 758             assertEquals(2, toCommits.size());</span>
<span class="line-added"> 759             assertEquals(toHashC, toCommits.get(0).hash());</span>
<span class="line-added"> 760             assertEquals(toHashA, toCommits.get(1).hash());</span>
<span class="line-added"> 761 </span>
<span class="line-added"> 762             // Set the clock to the 12th hour of the day (minutes should not matter)</span>
<span class="line-added"> 763             clock.now = ZonedDateTime.of(2020, 1, 24, 12, 37, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="line-added"> 764             TestBotRunner.runPeriodicItems(bot);</span>
<span class="line-added"> 765 </span>
<span class="line-added"> 766             // Should have merged</span>
<span class="line-added"> 767             toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added"> 768             assertEquals(4, toCommits.size());</span>
<span class="line-added"> 769             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());</span>
<span class="line-added"> 770             assertTrue(hashes.contains(toHashA));</span>
<span class="line-added"> 771             assertTrue(hashes.contains(fromHashB));</span>
<span class="line-added"> 772             assertTrue(hashes.contains(toHashC));</span>
<span class="line-added"> 773 </span>
<span class="line-added"> 774             var known = Set.of(toHashA, fromHashB, toHashC);</span>
<span class="line-added"> 775             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();</span>
<span class="line-added"> 776             assertTrue(merge.isMerge());</span>
<span class="line-added"> 777             assertEquals(List.of(&quot;Merge&quot;), merge.message());</span>
<span class="line-added"> 778             assertEquals(&quot;duke&quot;, merge.author().name());</span>
<span class="line-added"> 779             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());</span>
<span class="line-added"> 780 </span>
<span class="line-added"> 781             assertEquals(0, toHostedRepo.pullRequests().size());</span>
<span class="line-added"> 782 </span>
<span class="line-added"> 783             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);</span>
<span class="line-added"> 784             Files.writeString(fromFileD, &quot;Hello D\n&quot;);</span>
<span class="line-added"> 785             fromLocalRepo.add(fromFileD);</span>
<span class="line-added"> 786             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);</span>
<span class="line-added"> 787 </span>
<span class="line-added"> 788             // Since the time hasn&#39;t changed it should not merge</span>
<span class="line-added"> 789             TestBotRunner.runPeriodicItems(bot);</span>
<span class="line-added"> 790             toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added"> 791             assertEquals(4, toCommits.size());</span>
<span class="line-added"> 792 </span>
<span class="line-added"> 793             // Move the hours forward, the bot should not merge</span>
<span class="line-added"> 794             clock.now = ZonedDateTime.of(2020, 1, 24, 13, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="line-added"> 795             TestBotRunner.runPeriodicItems(bot);</span>
<span class="line-added"> 796             toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added"> 797             assertEquals(4, toCommits.size());</span>
<span class="line-added"> 798 </span>
<span class="line-added"> 799             // Move the days forward, the bot should not merge</span>
<span class="line-added"> 800             clock.now = ZonedDateTime.of(2020, 1, 25, 13, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="line-added"> 801             TestBotRunner.runPeriodicItems(bot);</span>
<span class="line-added"> 802             toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added"> 803             assertEquals(4, toCommits.size());</span>
<span class="line-added"> 804 </span>
<span class="line-added"> 805             // Move the clock forward one week, the bot should merge</span>
<span class="line-added"> 806             clock.now = ZonedDateTime.of(2020, 1, 31, 12, 29, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="line-added"> 807             TestBotRunner.runPeriodicItems(bot);</span>
<span class="line-added"> 808 </span>
<span class="line-added"> 809             toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added"> 810             assertEquals(6, toCommits.size());</span>
<span class="line-added"> 811         }</span>
<span class="line-added"> 812     }</span>
<span class="line-added"> 813 </span>
<span class="line-added"> 814     @Test</span>
<span class="line-added"> 815     void testMergeMonthly(TestInfo testInfo) throws IOException {</span>
<span class="line-added"> 816         try (var temp = new TemporaryDirectory(false)) {</span>
<span class="line-added"> 817             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));</span>
<span class="line-added"> 818 </span>
<span class="line-added"> 819             var fromDir = temp.path().resolve(&quot;from.git&quot;);</span>
<span class="line-added"> 820             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);</span>
<span class="line-added"> 821             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);</span>
<span class="line-added"> 822 </span>
<span class="line-added"> 823             var toDir = temp.path().resolve(&quot;to.git&quot;);</span>
<span class="line-added"> 824             var toLocalRepo = Repository.init(toDir, VCS.GIT);</span>
<span class="line-added"> 825             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="line-added"> 826             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
<span class="line-added"> 827                         StandardOpenOption.APPEND);</span>
<span class="line-added"> 828             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);</span>
<span class="line-added"> 829 </span>
<span class="line-added"> 830             var forkDir = temp.path().resolve(&quot;fork.git&quot;);</span>
<span class="line-added"> 831             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);</span>
<span class="line-added"> 832             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="line-added"> 833             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
<span class="line-added"> 834                         StandardOpenOption.APPEND);</span>
<span class="line-added"> 835             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);</span>
<span class="line-added"> 836 </span>
<span class="line-added"> 837             var now = ZonedDateTime.now();</span>
<span class="line-added"> 838             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);</span>
<span class="line-added"> 839             Files.writeString(fromFileA, &quot;Hello A\n&quot;);</span>
<span class="line-added"> 840             fromLocalRepo.add(fromFileA);</span>
<span class="line-added"> 841             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);</span>
<span class="line-added"> 842             var fromCommits = fromLocalRepo.commits().asList();</span>
<span class="line-added"> 843             assertEquals(1, fromCommits.size());</span>
<span class="line-added"> 844             assertEquals(fromHashA, fromCommits.get(0).hash());</span>
<span class="line-added"> 845 </span>
<span class="line-added"> 846             var toFileA = toDir.resolve(&quot;a.txt&quot;);</span>
<span class="line-added"> 847             Files.writeString(toFileA, &quot;Hello A\n&quot;);</span>
<span class="line-added"> 848             toLocalRepo.add(toFileA);</span>
<span class="line-added"> 849             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);</span>
<span class="line-added"> 850             var toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added"> 851             assertEquals(1, toCommits.size());</span>
<span class="line-added"> 852             assertEquals(toHashA, toCommits.get(0).hash());</span>
<span class="line-added"> 853             assertEquals(fromHashA, toHashA);</span>
<span class="line-added"> 854 </span>
<span class="line-added"> 855             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);</span>
<span class="line-added"> 856             Files.writeString(fromFileB, &quot;Hello B\n&quot;);</span>
<span class="line-added"> 857             fromLocalRepo.add(fromFileB);</span>
<span class="line-added"> 858             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);</span>
<span class="line-added"> 859 </span>
<span class="line-added"> 860             var toFileC = toDir.resolve(&quot;c.txt&quot;);</span>
<span class="line-added"> 861             Files.writeString(toFileC, &quot;Hello C\n&quot;);</span>
<span class="line-added"> 862             toLocalRepo.add(toFileC);</span>
<span class="line-added"> 863             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);</span>
<span class="line-added"> 864 </span>
<span class="line-added"> 865             var storage = temp.path().resolve(&quot;storage&quot;);</span>
<span class="line-added"> 866             var master = new Branch(&quot;master&quot;);</span>
<span class="line-added"> 867 </span>
<span class="line-added"> 868             // Merge only at most once per month on the 17th day at at 11:00</span>
<span class="line-added"> 869             var freq = MergeBot.Spec.Frequency.monthly(17, 11);</span>
<span class="line-added"> 870             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));</span>
<span class="line-added"> 871 </span>
<span class="line-added"> 872             var clock = new TestClock(ZonedDateTime.of(2020, 1, 16, 11, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));</span>
<span class="line-added"> 873             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);</span>
<span class="line-added"> 874 </span>
<span class="line-added"> 875             TestBotRunner.runPeriodicItems(bot);</span>
<span class="line-added"> 876 </span>
<span class="line-added"> 877             // Ensure nothing has been merged</span>
<span class="line-added"> 878             toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added"> 879             assertEquals(2, toCommits.size());</span>
<span class="line-added"> 880             assertEquals(toHashC, toCommits.get(0).hash());</span>
<span class="line-added"> 881             assertEquals(toHashA, toCommits.get(1).hash());</span>
<span class="line-added"> 882 </span>
<span class="line-added"> 883             // Set the clock to the 17th day and at hour 11 (minutes should not matter)</span>
<span class="line-added"> 884             clock.now = ZonedDateTime.of(2020, 1, 17, 11, 37, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="line-added"> 885             TestBotRunner.runPeriodicItems(bot);</span>
<span class="line-added"> 886 </span>
<span class="line-added"> 887             // Should have merged</span>
<span class="line-added"> 888             toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added"> 889             assertEquals(4, toCommits.size());</span>
<span class="line-added"> 890             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());</span>
<span class="line-added"> 891             assertTrue(hashes.contains(toHashA));</span>
<span class="line-added"> 892             assertTrue(hashes.contains(fromHashB));</span>
<span class="line-added"> 893             assertTrue(hashes.contains(toHashC));</span>
<span class="line-added"> 894 </span>
<span class="line-added"> 895             var known = Set.of(toHashA, fromHashB, toHashC);</span>
<span class="line-added"> 896             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();</span>
<span class="line-added"> 897             assertTrue(merge.isMerge());</span>
<span class="line-added"> 898             assertEquals(List.of(&quot;Merge&quot;), merge.message());</span>
<span class="line-added"> 899             assertEquals(&quot;duke&quot;, merge.author().name());</span>
<span class="line-added"> 900             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());</span>
<span class="line-added"> 901 </span>
<span class="line-added"> 902             assertEquals(0, toHostedRepo.pullRequests().size());</span>
<span class="line-added"> 903 </span>
<span class="line-added"> 904             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);</span>
<span class="line-added"> 905             Files.writeString(fromFileD, &quot;Hello D\n&quot;);</span>
<span class="line-added"> 906             fromLocalRepo.add(fromFileD);</span>
<span class="line-added"> 907             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);</span>
<span class="line-added"> 908 </span>
<span class="line-added"> 909             // Since the time hasn&#39;t changed it should not merge</span>
<span class="line-added"> 910             TestBotRunner.runPeriodicItems(bot);</span>
<span class="line-added"> 911             toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added"> 912             assertEquals(4, toCommits.size());</span>
<span class="line-added"> 913 </span>
<span class="line-added"> 914             // Move the hours forward, the bot should not merge</span>
<span class="line-added"> 915             clock.now = ZonedDateTime.of(2020, 1, 17, 12, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="line-added"> 916             TestBotRunner.runPeriodicItems(bot);</span>
<span class="line-added"> 917             toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added"> 918             assertEquals(4, toCommits.size());</span>
<span class="line-added"> 919 </span>
<span class="line-added"> 920             // Move the days forward, the bot should not merge</span>
<span class="line-added"> 921             clock.now = ZonedDateTime.of(2020, 1, 18, 11, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="line-added"> 922             TestBotRunner.runPeriodicItems(bot);</span>
<span class="line-added"> 923             toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added"> 924             assertEquals(4, toCommits.size());</span>
<span class="line-added"> 925 </span>
<span class="line-added"> 926             // Move the clock forward one month, the bot should merge</span>
<span class="line-added"> 927             clock.now = ZonedDateTime.of(2020, 2, 17, 11, 55, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="line-added"> 928             TestBotRunner.runPeriodicItems(bot);</span>
<span class="line-added"> 929 </span>
<span class="line-added"> 930             toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added"> 931             assertEquals(6, toCommits.size());</span>
<span class="line-added"> 932         }</span>
<span class="line-added"> 933     }</span>
<span class="line-added"> 934 </span>
<span class="line-added"> 935     @Test</span>
<span class="line-added"> 936     void testMergeYearly(TestInfo testInfo) throws IOException {</span>
<span class="line-added"> 937         try (var temp = new TemporaryDirectory(false)) {</span>
<span class="line-added"> 938             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));</span>
<span class="line-added"> 939 </span>
<span class="line-added"> 940             var fromDir = temp.path().resolve(&quot;from.git&quot;);</span>
<span class="line-added"> 941             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);</span>
<span class="line-added"> 942             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);</span>
<span class="line-added"> 943 </span>
<span class="line-added"> 944             var toDir = temp.path().resolve(&quot;to.git&quot;);</span>
<span class="line-added"> 945             var toLocalRepo = Repository.init(toDir, VCS.GIT);</span>
<span class="line-added"> 946             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="line-added"> 947             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
<span class="line-added"> 948                         StandardOpenOption.APPEND);</span>
<span class="line-added"> 949             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);</span>
<span class="line-added"> 950 </span>
<span class="line-added"> 951             var forkDir = temp.path().resolve(&quot;fork.git&quot;);</span>
<span class="line-added"> 952             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);</span>
<span class="line-added"> 953             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="line-added"> 954             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
<span class="line-added"> 955                         StandardOpenOption.APPEND);</span>
<span class="line-added"> 956             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);</span>
<span class="line-added"> 957 </span>
<span class="line-added"> 958             var now = ZonedDateTime.now();</span>
<span class="line-added"> 959             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);</span>
<span class="line-added"> 960             Files.writeString(fromFileA, &quot;Hello A\n&quot;);</span>
<span class="line-added"> 961             fromLocalRepo.add(fromFileA);</span>
<span class="line-added"> 962             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);</span>
<span class="line-added"> 963             var fromCommits = fromLocalRepo.commits().asList();</span>
<span class="line-added"> 964             assertEquals(1, fromCommits.size());</span>
<span class="line-added"> 965             assertEquals(fromHashA, fromCommits.get(0).hash());</span>
<span class="line-added"> 966 </span>
<span class="line-added"> 967             var toFileA = toDir.resolve(&quot;a.txt&quot;);</span>
<span class="line-added"> 968             Files.writeString(toFileA, &quot;Hello A\n&quot;);</span>
<span class="line-added"> 969             toLocalRepo.add(toFileA);</span>
<span class="line-added"> 970             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);</span>
<span class="line-added"> 971             var toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added"> 972             assertEquals(1, toCommits.size());</span>
<span class="line-added"> 973             assertEquals(toHashA, toCommits.get(0).hash());</span>
<span class="line-added"> 974             assertEquals(fromHashA, toHashA);</span>
<span class="line-added"> 975 </span>
<span class="line-added"> 976             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);</span>
<span class="line-added"> 977             Files.writeString(fromFileB, &quot;Hello B\n&quot;);</span>
<span class="line-added"> 978             fromLocalRepo.add(fromFileB);</span>
<span class="line-added"> 979             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);</span>
<span class="line-added"> 980 </span>
<span class="line-added"> 981             var toFileC = toDir.resolve(&quot;c.txt&quot;);</span>
<span class="line-added"> 982             Files.writeString(toFileC, &quot;Hello C\n&quot;);</span>
<span class="line-added"> 983             toLocalRepo.add(toFileC);</span>
<span class="line-added"> 984             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);</span>
<span class="line-added"> 985 </span>
<span class="line-added"> 986             var storage = temp.path().resolve(&quot;storage&quot;);</span>
<span class="line-added"> 987             var master = new Branch(&quot;master&quot;);</span>
<span class="line-added"> 988 </span>
<span class="line-added"> 989             // Merge only at most once per year on the 29th day of May at at 07:00</span>
<span class="line-added"> 990             var freq = MergeBot.Spec.Frequency.yearly(Month.MAY, 29, 07);</span>
<span class="line-added"> 991             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));</span>
<span class="line-added"> 992 </span>
<span class="line-added"> 993             var clock = new TestClock(ZonedDateTime.of(2020, 5, 27, 11, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));</span>
<span class="line-added"> 994             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);</span>
<span class="line-added"> 995 </span>
<span class="line-added"> 996             TestBotRunner.runPeriodicItems(bot);</span>
<span class="line-added"> 997 </span>
<span class="line-added"> 998             // Ensure nothing has been merged</span>
<span class="line-added"> 999             toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added">1000             assertEquals(2, toCommits.size());</span>
<span class="line-added">1001             assertEquals(toHashC, toCommits.get(0).hash());</span>
<span class="line-added">1002             assertEquals(toHashA, toCommits.get(1).hash());</span>
<span class="line-added">1003 </span>
<span class="line-added">1004             // Set the clock to the 29th of May and at hour 11 (minutes should not matter)</span>
<span class="line-added">1005             clock.now = ZonedDateTime.of(2020, 5, 29, 7, 37, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="line-added">1006             TestBotRunner.runPeriodicItems(bot);</span>
<span class="line-added">1007 </span>
<span class="line-added">1008             // Should have merged</span>
<span class="line-added">1009             toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added">1010             assertEquals(4, toCommits.size());</span>
<span class="line-added">1011             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());</span>
<span class="line-added">1012             assertTrue(hashes.contains(toHashA));</span>
<span class="line-added">1013             assertTrue(hashes.contains(fromHashB));</span>
<span class="line-added">1014             assertTrue(hashes.contains(toHashC));</span>
<span class="line-added">1015 </span>
<span class="line-added">1016             var known = Set.of(toHashA, fromHashB, toHashC);</span>
<span class="line-added">1017             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();</span>
<span class="line-added">1018             assertTrue(merge.isMerge());</span>
<span class="line-added">1019             assertEquals(List.of(&quot;Merge&quot;), merge.message());</span>
<span class="line-added">1020             assertEquals(&quot;duke&quot;, merge.author().name());</span>
<span class="line-added">1021             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());</span>
<span class="line-added">1022 </span>
<span class="line-added">1023             assertEquals(0, toHostedRepo.pullRequests().size());</span>
<span class="line-added">1024 </span>
<span class="line-added">1025             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);</span>
<span class="line-added">1026             Files.writeString(fromFileD, &quot;Hello D\n&quot;);</span>
<span class="line-added">1027             fromLocalRepo.add(fromFileD);</span>
<span class="line-added">1028             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);</span>
<span class="line-added">1029 </span>
<span class="line-added">1030             // Since the time hasn&#39;t changed it should not merge again</span>
<span class="line-added">1031             TestBotRunner.runPeriodicItems(bot);</span>
<span class="line-added">1032             toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added">1033             assertEquals(4, toCommits.size());</span>
<span class="line-added">1034 </span>
<span class="line-added">1035             // Move the hours forward, the bot should not merge</span>
<span class="line-added">1036             clock.now = ZonedDateTime.of(2020, 5, 29, 8, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="line-added">1037             TestBotRunner.runPeriodicItems(bot);</span>
<span class="line-added">1038             toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added">1039             assertEquals(4, toCommits.size());</span>
<span class="line-added">1040 </span>
<span class="line-added">1041             // Move the days forward, the bot should not merge</span>
<span class="line-added">1042             clock.now = ZonedDateTime.of(2020, 5, 30, 11, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="line-added">1043             TestBotRunner.runPeriodicItems(bot);</span>
<span class="line-added">1044             toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added">1045             assertEquals(4, toCommits.size());</span>
<span class="line-added">1046 </span>
<span class="line-added">1047             // Move the months forward, the bot should not merge</span>
<span class="line-added">1048             clock.now = ZonedDateTime.of(2020, 7, 29, 7, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="line-added">1049             TestBotRunner.runPeriodicItems(bot);</span>
<span class="line-added">1050             toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added">1051             assertEquals(4, toCommits.size());</span>
<span class="line-added">1052 </span>
<span class="line-added">1053             // Move the clock forward one year, the bot should merge</span>
<span class="line-added">1054             clock.now = ZonedDateTime.of(2021, 5, 29, 7, 55, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="line-added">1055             TestBotRunner.runPeriodicItems(bot);</span>
<span class="line-added">1056 </span>
<span class="line-added">1057             toCommits = toLocalRepo.commits().asList();</span>
<span class="line-added">1058             assertEquals(6, toCommits.size());</span>
<span class="line-added">1059         }</span>
<span class="line-added">1060     }</span>
1061 }
<a name="4" id="anc4"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="4" type="hidden" />
</body>
</html>