<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff bots/merge/src/test/java/org/openjdk/skara/bots/merge/MergeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/merge/MergeBotFactory.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/merge/src/test/java/org/openjdk/skara/bots/merge/MergeBotTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -32,11 +32,14 @@</span>
  import java.io.IOException;
  import java.nio.file.Files;
  import java.nio.file.StandardOpenOption;
  import java.util.*;
  import java.util.stream.Collectors;
<span class="udiff-line-added">+ import java.time.DayOfWeek;</span>
<span class="udiff-line-added">+ import java.time.Month;</span>
  import java.time.ZonedDateTime;
<span class="udiff-line-added">+ import java.time.ZoneId;</span>
  
  import static org.junit.jupiter.api.Assertions.*;
  
  class MergeBotTests {
      @Test
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -431,6 +434,628 @@</span>
              pullRequests = toHostedRepo.pullRequests();
              assertEquals(1, pullRequests.size());
              assertEquals(&quot;Cannot automatically merge test:master to master&quot;, pr.title());
          }
      }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     final static class TestClock implements Clock {</span>
<span class="udiff-line-added">+         ZonedDateTime now;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         TestClock() {</span>
<span class="udiff-line-added">+             this(null);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         TestClock(ZonedDateTime now) {</span>
<span class="udiff-line-added">+             this.now = now;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         @Override</span>
<span class="udiff-line-added">+         public ZonedDateTime now() {</span>
<span class="udiff-line-added">+             return now;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Test</span>
<span class="udiff-line-added">+     void testMergeHourly(TestInfo testInfo) throws IOException {</span>
<span class="udiff-line-added">+         try (var temp = new TemporaryDirectory(false)) {</span>
<span class="udiff-line-added">+             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var fromDir = temp.path().resolve(&quot;from.git&quot;);</span>
<span class="udiff-line-added">+             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);</span>
<span class="udiff-line-added">+             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var toDir = temp.path().resolve(&quot;to.git&quot;);</span>
<span class="udiff-line-added">+             var toLocalRepo = Repository.init(toDir, VCS.GIT);</span>
<span class="udiff-line-added">+             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="udiff-line-added">+             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
<span class="udiff-line-added">+                         StandardOpenOption.APPEND);</span>
<span class="udiff-line-added">+             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var forkDir = temp.path().resolve(&quot;fork.git&quot;);</span>
<span class="udiff-line-added">+             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);</span>
<span class="udiff-line-added">+             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="udiff-line-added">+             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
<span class="udiff-line-added">+                         StandardOpenOption.APPEND);</span>
<span class="udiff-line-added">+             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var now = ZonedDateTime.now();</span>
<span class="udiff-line-added">+             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);</span>
<span class="udiff-line-added">+             Files.writeString(fromFileA, &quot;Hello A\n&quot;);</span>
<span class="udiff-line-added">+             fromLocalRepo.add(fromFileA);</span>
<span class="udiff-line-added">+             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);</span>
<span class="udiff-line-added">+             var fromCommits = fromLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(1, fromCommits.size());</span>
<span class="udiff-line-added">+             assertEquals(fromHashA, fromCommits.get(0).hash());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var toFileA = toDir.resolve(&quot;a.txt&quot;);</span>
<span class="udiff-line-added">+             Files.writeString(toFileA, &quot;Hello A\n&quot;);</span>
<span class="udiff-line-added">+             toLocalRepo.add(toFileA);</span>
<span class="udiff-line-added">+             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);</span>
<span class="udiff-line-added">+             var toCommits = toLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(1, toCommits.size());</span>
<span class="udiff-line-added">+             assertEquals(toHashA, toCommits.get(0).hash());</span>
<span class="udiff-line-added">+             assertEquals(fromHashA, toHashA);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);</span>
<span class="udiff-line-added">+             Files.writeString(fromFileB, &quot;Hello B\n&quot;);</span>
<span class="udiff-line-added">+             fromLocalRepo.add(fromFileB);</span>
<span class="udiff-line-added">+             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var toFileC = toDir.resolve(&quot;c.txt&quot;);</span>
<span class="udiff-line-added">+             Files.writeString(toFileC, &quot;Hello C\n&quot;);</span>
<span class="udiff-line-added">+             toLocalRepo.add(toFileC);</span>
<span class="udiff-line-added">+             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var storage = temp.path().resolve(&quot;storage&quot;);</span>
<span class="udiff-line-added">+             var master = new Branch(&quot;master&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Merge only at most once during the first minute every hour</span>
<span class="udiff-line-added">+             var freq = MergeBot.Spec.Frequency.hourly(1);</span>
<span class="udiff-line-added">+             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var clock = new TestClock(ZonedDateTime.of(2020, 1, 23, 15, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));</span>
<span class="udiff-line-added">+             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(bot);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Ensure nothing has been merged</span>
<span class="udiff-line-added">+             toCommits = toLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(2, toCommits.size());</span>
<span class="udiff-line-added">+             assertEquals(toHashC, toCommits.get(0).hash());</span>
<span class="udiff-line-added">+             assertEquals(toHashA, toCommits.get(1).hash());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Set the clock to the first minute of the hour</span>
<span class="udiff-line-added">+             clock.now = ZonedDateTime.of(2020, 1, 23, 15, 1, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(bot);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Should have merged</span>
<span class="udiff-line-added">+             toCommits = toLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(4, toCommits.size());</span>
<span class="udiff-line-added">+             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());</span>
<span class="udiff-line-added">+             assertTrue(hashes.contains(toHashA));</span>
<span class="udiff-line-added">+             assertTrue(hashes.contains(fromHashB));</span>
<span class="udiff-line-added">+             assertTrue(hashes.contains(toHashC));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var known = Set.of(toHashA, fromHashB, toHashC);</span>
<span class="udiff-line-added">+             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();</span>
<span class="udiff-line-added">+             assertTrue(merge.isMerge());</span>
<span class="udiff-line-added">+             assertEquals(List.of(&quot;Merge&quot;), merge.message());</span>
<span class="udiff-line-added">+             assertEquals(&quot;duke&quot;, merge.author().name());</span>
<span class="udiff-line-added">+             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             assertEquals(0, toHostedRepo.pullRequests().size());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);</span>
<span class="udiff-line-added">+             Files.writeString(fromFileD, &quot;Hello D\n&quot;);</span>
<span class="udiff-line-added">+             fromLocalRepo.add(fromFileD);</span>
<span class="udiff-line-added">+             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Since the time hasn&#39;t changed it should not merge again</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(bot);</span>
<span class="udiff-line-added">+             toCommits = toLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(4, toCommits.size());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Move the minutes forward, the bot should not merge</span>
<span class="udiff-line-added">+             clock.now = ZonedDateTime.of(2020, 1, 23, 15, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(bot);</span>
<span class="udiff-line-added">+             toCommits = toLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(4, toCommits.size());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Move the clock forward one hour, the bot should merge</span>
<span class="udiff-line-added">+             clock.now = ZonedDateTime.of(2020, 1, 23, 16, 1, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(bot);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             toCommits = toLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(6, toCommits.size());</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Test</span>
<span class="udiff-line-added">+     void testMergeDaily(TestInfo testInfo) throws IOException {</span>
<span class="udiff-line-added">+         try (var temp = new TemporaryDirectory(false)) {</span>
<span class="udiff-line-added">+             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var fromDir = temp.path().resolve(&quot;from.git&quot;);</span>
<span class="udiff-line-added">+             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);</span>
<span class="udiff-line-added">+             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var toDir = temp.path().resolve(&quot;to.git&quot;);</span>
<span class="udiff-line-added">+             var toLocalRepo = Repository.init(toDir, VCS.GIT);</span>
<span class="udiff-line-added">+             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="udiff-line-added">+             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
<span class="udiff-line-added">+                         StandardOpenOption.APPEND);</span>
<span class="udiff-line-added">+             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var forkDir = temp.path().resolve(&quot;fork.git&quot;);</span>
<span class="udiff-line-added">+             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);</span>
<span class="udiff-line-added">+             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="udiff-line-added">+             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
<span class="udiff-line-added">+                         StandardOpenOption.APPEND);</span>
<span class="udiff-line-added">+             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var now = ZonedDateTime.now();</span>
<span class="udiff-line-added">+             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);</span>
<span class="udiff-line-added">+             Files.writeString(fromFileA, &quot;Hello A\n&quot;);</span>
<span class="udiff-line-added">+             fromLocalRepo.add(fromFileA);</span>
<span class="udiff-line-added">+             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);</span>
<span class="udiff-line-added">+             var fromCommits = fromLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(1, fromCommits.size());</span>
<span class="udiff-line-added">+             assertEquals(fromHashA, fromCommits.get(0).hash());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var toFileA = toDir.resolve(&quot;a.txt&quot;);</span>
<span class="udiff-line-added">+             Files.writeString(toFileA, &quot;Hello A\n&quot;);</span>
<span class="udiff-line-added">+             toLocalRepo.add(toFileA);</span>
<span class="udiff-line-added">+             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);</span>
<span class="udiff-line-added">+             var toCommits = toLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(1, toCommits.size());</span>
<span class="udiff-line-added">+             assertEquals(toHashA, toCommits.get(0).hash());</span>
<span class="udiff-line-added">+             assertEquals(fromHashA, toHashA);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);</span>
<span class="udiff-line-added">+             Files.writeString(fromFileB, &quot;Hello B\n&quot;);</span>
<span class="udiff-line-added">+             fromLocalRepo.add(fromFileB);</span>
<span class="udiff-line-added">+             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var toFileC = toDir.resolve(&quot;c.txt&quot;);</span>
<span class="udiff-line-added">+             Files.writeString(toFileC, &quot;Hello C\n&quot;);</span>
<span class="udiff-line-added">+             toLocalRepo.add(toFileC);</span>
<span class="udiff-line-added">+             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var storage = temp.path().resolve(&quot;storage&quot;);</span>
<span class="udiff-line-added">+             var master = new Branch(&quot;master&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Merge only at most once during the third hour every day</span>
<span class="udiff-line-added">+             var freq = MergeBot.Spec.Frequency.daily(3);</span>
<span class="udiff-line-added">+             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var clock = new TestClock(ZonedDateTime.of(2020, 1, 23, 2, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));</span>
<span class="udiff-line-added">+             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(bot);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Ensure nothing has been merged</span>
<span class="udiff-line-added">+             toCommits = toLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(2, toCommits.size());</span>
<span class="udiff-line-added">+             assertEquals(toHashC, toCommits.get(0).hash());</span>
<span class="udiff-line-added">+             assertEquals(toHashA, toCommits.get(1).hash());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Set the clock to the third hour of the day (minutes should not matter)</span>
<span class="udiff-line-added">+             clock.now = ZonedDateTime.of(2020, 1, 23, 3, 37, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(bot);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Should have merged</span>
<span class="udiff-line-added">+             toCommits = toLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(4, toCommits.size());</span>
<span class="udiff-line-added">+             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());</span>
<span class="udiff-line-added">+             assertTrue(hashes.contains(toHashA));</span>
<span class="udiff-line-added">+             assertTrue(hashes.contains(fromHashB));</span>
<span class="udiff-line-added">+             assertTrue(hashes.contains(toHashC));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var known = Set.of(toHashA, fromHashB, toHashC);</span>
<span class="udiff-line-added">+             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();</span>
<span class="udiff-line-added">+             assertTrue(merge.isMerge());</span>
<span class="udiff-line-added">+             assertEquals(List.of(&quot;Merge&quot;), merge.message());</span>
<span class="udiff-line-added">+             assertEquals(&quot;duke&quot;, merge.author().name());</span>
<span class="udiff-line-added">+             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             assertEquals(0, toHostedRepo.pullRequests().size());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);</span>
<span class="udiff-line-added">+             Files.writeString(fromFileD, &quot;Hello D\n&quot;);</span>
<span class="udiff-line-added">+             fromLocalRepo.add(fromFileD);</span>
<span class="udiff-line-added">+             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Since the time hasn&#39;t changed it should not merge</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(bot);</span>
<span class="udiff-line-added">+             toCommits = toLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(4, toCommits.size());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Move the minutes forward, the bot should not merge</span>
<span class="udiff-line-added">+             clock.now = ZonedDateTime.of(2020, 1, 23, 3, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(bot);</span>
<span class="udiff-line-added">+             toCommits = toLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(4, toCommits.size());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Move the hours forward, the bot should not merge</span>
<span class="udiff-line-added">+             clock.now = ZonedDateTime.of(2020, 1, 23, 17, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(bot);</span>
<span class="udiff-line-added">+             toCommits = toLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(4, toCommits.size());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Move the clock forward one day, the bot should merge</span>
<span class="udiff-line-added">+             clock.now = ZonedDateTime.of(2020, 1, 24, 3, 55, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(bot);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             toCommits = toLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(6, toCommits.size());</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Test</span>
<span class="udiff-line-added">+     void testMergeWeekly(TestInfo testInfo) throws IOException {</span>
<span class="udiff-line-added">+         try (var temp = new TemporaryDirectory(false)) {</span>
<span class="udiff-line-added">+             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var fromDir = temp.path().resolve(&quot;from.git&quot;);</span>
<span class="udiff-line-added">+             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);</span>
<span class="udiff-line-added">+             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var toDir = temp.path().resolve(&quot;to.git&quot;);</span>
<span class="udiff-line-added">+             var toLocalRepo = Repository.init(toDir, VCS.GIT);</span>
<span class="udiff-line-added">+             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="udiff-line-added">+             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
<span class="udiff-line-added">+                         StandardOpenOption.APPEND);</span>
<span class="udiff-line-added">+             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var forkDir = temp.path().resolve(&quot;fork.git&quot;);</span>
<span class="udiff-line-added">+             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);</span>
<span class="udiff-line-added">+             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="udiff-line-added">+             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
<span class="udiff-line-added">+                         StandardOpenOption.APPEND);</span>
<span class="udiff-line-added">+             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var now = ZonedDateTime.now();</span>
<span class="udiff-line-added">+             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);</span>
<span class="udiff-line-added">+             Files.writeString(fromFileA, &quot;Hello A\n&quot;);</span>
<span class="udiff-line-added">+             fromLocalRepo.add(fromFileA);</span>
<span class="udiff-line-added">+             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);</span>
<span class="udiff-line-added">+             var fromCommits = fromLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(1, fromCommits.size());</span>
<span class="udiff-line-added">+             assertEquals(fromHashA, fromCommits.get(0).hash());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var toFileA = toDir.resolve(&quot;a.txt&quot;);</span>
<span class="udiff-line-added">+             Files.writeString(toFileA, &quot;Hello A\n&quot;);</span>
<span class="udiff-line-added">+             toLocalRepo.add(toFileA);</span>
<span class="udiff-line-added">+             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);</span>
<span class="udiff-line-added">+             var toCommits = toLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(1, toCommits.size());</span>
<span class="udiff-line-added">+             assertEquals(toHashA, toCommits.get(0).hash());</span>
<span class="udiff-line-added">+             assertEquals(fromHashA, toHashA);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);</span>
<span class="udiff-line-added">+             Files.writeString(fromFileB, &quot;Hello B\n&quot;);</span>
<span class="udiff-line-added">+             fromLocalRepo.add(fromFileB);</span>
<span class="udiff-line-added">+             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var toFileC = toDir.resolve(&quot;c.txt&quot;);</span>
<span class="udiff-line-added">+             Files.writeString(toFileC, &quot;Hello C\n&quot;);</span>
<span class="udiff-line-added">+             toLocalRepo.add(toFileC);</span>
<span class="udiff-line-added">+             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var storage = temp.path().resolve(&quot;storage&quot;);</span>
<span class="udiff-line-added">+             var master = new Branch(&quot;master&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Merge only at most once per week on Friday&#39;s at 12:00</span>
<span class="udiff-line-added">+             var freq = MergeBot.Spec.Frequency.weekly(DayOfWeek.FRIDAY, 12);</span>
<span class="udiff-line-added">+             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var clock = new TestClock(ZonedDateTime.of(2020, 1, 24, 11, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));</span>
<span class="udiff-line-added">+             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(bot);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Ensure nothing has been merged</span>
<span class="udiff-line-added">+             toCommits = toLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(2, toCommits.size());</span>
<span class="udiff-line-added">+             assertEquals(toHashC, toCommits.get(0).hash());</span>
<span class="udiff-line-added">+             assertEquals(toHashA, toCommits.get(1).hash());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Set the clock to the 12th hour of the day (minutes should not matter)</span>
<span class="udiff-line-added">+             clock.now = ZonedDateTime.of(2020, 1, 24, 12, 37, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(bot);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Should have merged</span>
<span class="udiff-line-added">+             toCommits = toLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(4, toCommits.size());</span>
<span class="udiff-line-added">+             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());</span>
<span class="udiff-line-added">+             assertTrue(hashes.contains(toHashA));</span>
<span class="udiff-line-added">+             assertTrue(hashes.contains(fromHashB));</span>
<span class="udiff-line-added">+             assertTrue(hashes.contains(toHashC));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var known = Set.of(toHashA, fromHashB, toHashC);</span>
<span class="udiff-line-added">+             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();</span>
<span class="udiff-line-added">+             assertTrue(merge.isMerge());</span>
<span class="udiff-line-added">+             assertEquals(List.of(&quot;Merge&quot;), merge.message());</span>
<span class="udiff-line-added">+             assertEquals(&quot;duke&quot;, merge.author().name());</span>
<span class="udiff-line-added">+             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             assertEquals(0, toHostedRepo.pullRequests().size());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);</span>
<span class="udiff-line-added">+             Files.writeString(fromFileD, &quot;Hello D\n&quot;);</span>
<span class="udiff-line-added">+             fromLocalRepo.add(fromFileD);</span>
<span class="udiff-line-added">+             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Since the time hasn&#39;t changed it should not merge</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(bot);</span>
<span class="udiff-line-added">+             toCommits = toLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(4, toCommits.size());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Move the hours forward, the bot should not merge</span>
<span class="udiff-line-added">+             clock.now = ZonedDateTime.of(2020, 1, 24, 13, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(bot);</span>
<span class="udiff-line-added">+             toCommits = toLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(4, toCommits.size());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Move the days forward, the bot should not merge</span>
<span class="udiff-line-added">+             clock.now = ZonedDateTime.of(2020, 1, 25, 13, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(bot);</span>
<span class="udiff-line-added">+             toCommits = toLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(4, toCommits.size());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Move the clock forward one week, the bot should merge</span>
<span class="udiff-line-added">+             clock.now = ZonedDateTime.of(2020, 1, 31, 12, 29, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(bot);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             toCommits = toLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(6, toCommits.size());</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Test</span>
<span class="udiff-line-added">+     void testMergeMonthly(TestInfo testInfo) throws IOException {</span>
<span class="udiff-line-added">+         try (var temp = new TemporaryDirectory(false)) {</span>
<span class="udiff-line-added">+             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var fromDir = temp.path().resolve(&quot;from.git&quot;);</span>
<span class="udiff-line-added">+             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);</span>
<span class="udiff-line-added">+             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var toDir = temp.path().resolve(&quot;to.git&quot;);</span>
<span class="udiff-line-added">+             var toLocalRepo = Repository.init(toDir, VCS.GIT);</span>
<span class="udiff-line-added">+             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="udiff-line-added">+             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
<span class="udiff-line-added">+                         StandardOpenOption.APPEND);</span>
<span class="udiff-line-added">+             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var forkDir = temp.path().resolve(&quot;fork.git&quot;);</span>
<span class="udiff-line-added">+             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);</span>
<span class="udiff-line-added">+             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="udiff-line-added">+             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
<span class="udiff-line-added">+                         StandardOpenOption.APPEND);</span>
<span class="udiff-line-added">+             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var now = ZonedDateTime.now();</span>
<span class="udiff-line-added">+             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);</span>
<span class="udiff-line-added">+             Files.writeString(fromFileA, &quot;Hello A\n&quot;);</span>
<span class="udiff-line-added">+             fromLocalRepo.add(fromFileA);</span>
<span class="udiff-line-added">+             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);</span>
<span class="udiff-line-added">+             var fromCommits = fromLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(1, fromCommits.size());</span>
<span class="udiff-line-added">+             assertEquals(fromHashA, fromCommits.get(0).hash());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var toFileA = toDir.resolve(&quot;a.txt&quot;);</span>
<span class="udiff-line-added">+             Files.writeString(toFileA, &quot;Hello A\n&quot;);</span>
<span class="udiff-line-added">+             toLocalRepo.add(toFileA);</span>
<span class="udiff-line-added">+             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);</span>
<span class="udiff-line-added">+             var toCommits = toLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(1, toCommits.size());</span>
<span class="udiff-line-added">+             assertEquals(toHashA, toCommits.get(0).hash());</span>
<span class="udiff-line-added">+             assertEquals(fromHashA, toHashA);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);</span>
<span class="udiff-line-added">+             Files.writeString(fromFileB, &quot;Hello B\n&quot;);</span>
<span class="udiff-line-added">+             fromLocalRepo.add(fromFileB);</span>
<span class="udiff-line-added">+             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var toFileC = toDir.resolve(&quot;c.txt&quot;);</span>
<span class="udiff-line-added">+             Files.writeString(toFileC, &quot;Hello C\n&quot;);</span>
<span class="udiff-line-added">+             toLocalRepo.add(toFileC);</span>
<span class="udiff-line-added">+             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var storage = temp.path().resolve(&quot;storage&quot;);</span>
<span class="udiff-line-added">+             var master = new Branch(&quot;master&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Merge only at most once per month on the 17th day at at 11:00</span>
<span class="udiff-line-added">+             var freq = MergeBot.Spec.Frequency.monthly(17, 11);</span>
<span class="udiff-line-added">+             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var clock = new TestClock(ZonedDateTime.of(2020, 1, 16, 11, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));</span>
<span class="udiff-line-added">+             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(bot);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Ensure nothing has been merged</span>
<span class="udiff-line-added">+             toCommits = toLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(2, toCommits.size());</span>
<span class="udiff-line-added">+             assertEquals(toHashC, toCommits.get(0).hash());</span>
<span class="udiff-line-added">+             assertEquals(toHashA, toCommits.get(1).hash());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Set the clock to the 17th day and at hour 11 (minutes should not matter)</span>
<span class="udiff-line-added">+             clock.now = ZonedDateTime.of(2020, 1, 17, 11, 37, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(bot);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Should have merged</span>
<span class="udiff-line-added">+             toCommits = toLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(4, toCommits.size());</span>
<span class="udiff-line-added">+             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());</span>
<span class="udiff-line-added">+             assertTrue(hashes.contains(toHashA));</span>
<span class="udiff-line-added">+             assertTrue(hashes.contains(fromHashB));</span>
<span class="udiff-line-added">+             assertTrue(hashes.contains(toHashC));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var known = Set.of(toHashA, fromHashB, toHashC);</span>
<span class="udiff-line-added">+             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();</span>
<span class="udiff-line-added">+             assertTrue(merge.isMerge());</span>
<span class="udiff-line-added">+             assertEquals(List.of(&quot;Merge&quot;), merge.message());</span>
<span class="udiff-line-added">+             assertEquals(&quot;duke&quot;, merge.author().name());</span>
<span class="udiff-line-added">+             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             assertEquals(0, toHostedRepo.pullRequests().size());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);</span>
<span class="udiff-line-added">+             Files.writeString(fromFileD, &quot;Hello D\n&quot;);</span>
<span class="udiff-line-added">+             fromLocalRepo.add(fromFileD);</span>
<span class="udiff-line-added">+             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Since the time hasn&#39;t changed it should not merge</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(bot);</span>
<span class="udiff-line-added">+             toCommits = toLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(4, toCommits.size());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Move the hours forward, the bot should not merge</span>
<span class="udiff-line-added">+             clock.now = ZonedDateTime.of(2020, 1, 17, 12, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(bot);</span>
<span class="udiff-line-added">+             toCommits = toLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(4, toCommits.size());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Move the days forward, the bot should not merge</span>
<span class="udiff-line-added">+             clock.now = ZonedDateTime.of(2020, 1, 18, 11, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(bot);</span>
<span class="udiff-line-added">+             toCommits = toLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(4, toCommits.size());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Move the clock forward one month, the bot should merge</span>
<span class="udiff-line-added">+             clock.now = ZonedDateTime.of(2020, 2, 17, 11, 55, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(bot);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             toCommits = toLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(6, toCommits.size());</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Test</span>
<span class="udiff-line-added">+     void testMergeYearly(TestInfo testInfo) throws IOException {</span>
<span class="udiff-line-added">+         try (var temp = new TemporaryDirectory(false)) {</span>
<span class="udiff-line-added">+             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var fromDir = temp.path().resolve(&quot;from.git&quot;);</span>
<span class="udiff-line-added">+             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);</span>
<span class="udiff-line-added">+             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var toDir = temp.path().resolve(&quot;to.git&quot;);</span>
<span class="udiff-line-added">+             var toLocalRepo = Repository.init(toDir, VCS.GIT);</span>
<span class="udiff-line-added">+             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="udiff-line-added">+             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
<span class="udiff-line-added">+                         StandardOpenOption.APPEND);</span>
<span class="udiff-line-added">+             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var forkDir = temp.path().resolve(&quot;fork.git&quot;);</span>
<span class="udiff-line-added">+             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);</span>
<span class="udiff-line-added">+             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="udiff-line-added">+             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
<span class="udiff-line-added">+                         StandardOpenOption.APPEND);</span>
<span class="udiff-line-added">+             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var now = ZonedDateTime.now();</span>
<span class="udiff-line-added">+             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);</span>
<span class="udiff-line-added">+             Files.writeString(fromFileA, &quot;Hello A\n&quot;);</span>
<span class="udiff-line-added">+             fromLocalRepo.add(fromFileA);</span>
<span class="udiff-line-added">+             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);</span>
<span class="udiff-line-added">+             var fromCommits = fromLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(1, fromCommits.size());</span>
<span class="udiff-line-added">+             assertEquals(fromHashA, fromCommits.get(0).hash());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var toFileA = toDir.resolve(&quot;a.txt&quot;);</span>
<span class="udiff-line-added">+             Files.writeString(toFileA, &quot;Hello A\n&quot;);</span>
<span class="udiff-line-added">+             toLocalRepo.add(toFileA);</span>
<span class="udiff-line-added">+             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);</span>
<span class="udiff-line-added">+             var toCommits = toLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(1, toCommits.size());</span>
<span class="udiff-line-added">+             assertEquals(toHashA, toCommits.get(0).hash());</span>
<span class="udiff-line-added">+             assertEquals(fromHashA, toHashA);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);</span>
<span class="udiff-line-added">+             Files.writeString(fromFileB, &quot;Hello B\n&quot;);</span>
<span class="udiff-line-added">+             fromLocalRepo.add(fromFileB);</span>
<span class="udiff-line-added">+             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var toFileC = toDir.resolve(&quot;c.txt&quot;);</span>
<span class="udiff-line-added">+             Files.writeString(toFileC, &quot;Hello C\n&quot;);</span>
<span class="udiff-line-added">+             toLocalRepo.add(toFileC);</span>
<span class="udiff-line-added">+             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var storage = temp.path().resolve(&quot;storage&quot;);</span>
<span class="udiff-line-added">+             var master = new Branch(&quot;master&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Merge only at most once per year on the 29th day of May at at 07:00</span>
<span class="udiff-line-added">+             var freq = MergeBot.Spec.Frequency.yearly(Month.MAY, 29, 07);</span>
<span class="udiff-line-added">+             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var clock = new TestClock(ZonedDateTime.of(2020, 5, 27, 11, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));</span>
<span class="udiff-line-added">+             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(bot);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Ensure nothing has been merged</span>
<span class="udiff-line-added">+             toCommits = toLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(2, toCommits.size());</span>
<span class="udiff-line-added">+             assertEquals(toHashC, toCommits.get(0).hash());</span>
<span class="udiff-line-added">+             assertEquals(toHashA, toCommits.get(1).hash());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Set the clock to the 29th of May and at hour 11 (minutes should not matter)</span>
<span class="udiff-line-added">+             clock.now = ZonedDateTime.of(2020, 5, 29, 7, 37, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(bot);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Should have merged</span>
<span class="udiff-line-added">+             toCommits = toLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(4, toCommits.size());</span>
<span class="udiff-line-added">+             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());</span>
<span class="udiff-line-added">+             assertTrue(hashes.contains(toHashA));</span>
<span class="udiff-line-added">+             assertTrue(hashes.contains(fromHashB));</span>
<span class="udiff-line-added">+             assertTrue(hashes.contains(toHashC));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var known = Set.of(toHashA, fromHashB, toHashC);</span>
<span class="udiff-line-added">+             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();</span>
<span class="udiff-line-added">+             assertTrue(merge.isMerge());</span>
<span class="udiff-line-added">+             assertEquals(List.of(&quot;Merge&quot;), merge.message());</span>
<span class="udiff-line-added">+             assertEquals(&quot;duke&quot;, merge.author().name());</span>
<span class="udiff-line-added">+             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             assertEquals(0, toHostedRepo.pullRequests().size());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);</span>
<span class="udiff-line-added">+             Files.writeString(fromFileD, &quot;Hello D\n&quot;);</span>
<span class="udiff-line-added">+             fromLocalRepo.add(fromFileD);</span>
<span class="udiff-line-added">+             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Since the time hasn&#39;t changed it should not merge again</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(bot);</span>
<span class="udiff-line-added">+             toCommits = toLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(4, toCommits.size());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Move the hours forward, the bot should not merge</span>
<span class="udiff-line-added">+             clock.now = ZonedDateTime.of(2020, 5, 29, 8, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(bot);</span>
<span class="udiff-line-added">+             toCommits = toLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(4, toCommits.size());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Move the days forward, the bot should not merge</span>
<span class="udiff-line-added">+             clock.now = ZonedDateTime.of(2020, 5, 30, 11, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(bot);</span>
<span class="udiff-line-added">+             toCommits = toLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(4, toCommits.size());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Move the months forward, the bot should not merge</span>
<span class="udiff-line-added">+             clock.now = ZonedDateTime.of(2020, 7, 29, 7, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(bot);</span>
<span class="udiff-line-added">+             toCommits = toLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(4, toCommits.size());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Move the clock forward one year, the bot should merge</span>
<span class="udiff-line-added">+             clock.now = ZonedDateTime.of(2021, 5, 29, 7, 55, 0, 0, ZoneId.of(&quot;GMT+1&quot;));</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(bot);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             toCommits = toLocalRepo.commits().asList();</span>
<span class="udiff-line-added">+             assertEquals(6, toCommits.size());</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
  }
</pre>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/merge/MergeBotFactory.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>