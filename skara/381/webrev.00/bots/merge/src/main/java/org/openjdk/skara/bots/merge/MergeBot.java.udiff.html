<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff bots/merge/src/main/java/org/openjdk/skara/bots/merge/MergeBot.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../../../../Makefile.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="MergeBotFactory.java.udiff.html" target="_top">next &gt;</a></center>    <h2>bots/merge/src/main/java/org/openjdk/skara/bots/merge/MergeBot.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2019, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -30,39 +30,172 @@</span>
  import java.io.UncheckedIOException;
  import java.nio.charset.StandardCharsets;
  import java.nio.file.Path;
  import java.nio.file.Files;
  import java.net.URLEncoder;
<span class="udiff-line-modified-removed">- import java.util.List;</span>
<span class="udiff-line-modified-removed">- import java.util.ArrayList;</span>
<span class="udiff-line-modified-added">+ import java.time.DayOfWeek;</span>
<span class="udiff-line-modified-added">+ import java.time.Month;</span>
<span class="udiff-line-added">+ import java.time.temporal.WeekFields;</span>
<span class="udiff-line-added">+ import java.time.ZonedDateTime;</span>
<span class="udiff-line-added">+ import java.util.*;</span>
  import java.util.logging.Logger;
  
  class MergeBot implements Bot, WorkItem {
      private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.bots&quot;);;
      private final Path storage;
  
      private final HostedRepository target;
      private final HostedRepository fork;
      private final List&lt;Spec&gt; specs;
  
<span class="udiff-line-added">+     private final Clock clock;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private final Map&lt;String, Set&lt;Integer&gt;&gt; hourly = new HashMap&lt;&gt;();</span>
<span class="udiff-line-added">+     private final Map&lt;String, Set&lt;Integer&gt;&gt; daily = new HashMap&lt;&gt;();</span>
<span class="udiff-line-added">+     private final Map&lt;String, Set&lt;Integer&gt;&gt; weekly = new HashMap&lt;&gt;();</span>
<span class="udiff-line-added">+     private final Map&lt;String, Set&lt;Month&gt;&gt; monthly = new HashMap&lt;&gt;();</span>
<span class="udiff-line-added">+     private final Map&lt;String, Set&lt;Integer&gt;&gt; yearly = new HashMap&lt;&gt;();</span>
<span class="udiff-line-added">+ </span>
      MergeBot(Path storage, HostedRepository target, HostedRepository fork,
               List&lt;Spec&gt; specs) {
<span class="udiff-line-added">+         this(storage, target, fork, specs, new Clock() {</span>
<span class="udiff-line-added">+             public ZonedDateTime now() {</span>
<span class="udiff-line-added">+                 return ZonedDateTime.now();</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         });</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     MergeBot(Path storage, HostedRepository target, HostedRepository fork,</span>
<span class="udiff-line-added">+              List&lt;Spec&gt; specs, Clock clock) {</span>
          this.storage = storage;
          this.target = target;
          this.fork = fork;
          this.specs = specs;
<span class="udiff-line-added">+         this.clock = clock;</span>
      }
  
      final static class Spec {
<span class="udiff-line-added">+         final static class Frequency {</span>
<span class="udiff-line-added">+             static enum Interval {</span>
<span class="udiff-line-added">+                 HOURLY,</span>
<span class="udiff-line-added">+                 DAILY,</span>
<span class="udiff-line-added">+                 WEEKLY,</span>
<span class="udiff-line-added">+                 MONTHLY,</span>
<span class="udiff-line-added">+                 YEARLY;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                 boolean isHourly() {</span>
<span class="udiff-line-added">+                     return this.equals(HOURLY);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                 boolean isDaily() {</span>
<span class="udiff-line-added">+                     return this.equals(DAILY);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                 boolean isWeekly() {</span>
<span class="udiff-line-added">+                     return this.equals(WEEKLY);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                 boolean isMonthly() {</span>
<span class="udiff-line-added">+                     return this.equals(MONTHLY);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                 boolean isYearly() {</span>
<span class="udiff-line-added">+                     return this.equals(YEARLY);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             private final Interval interval;</span>
<span class="udiff-line-added">+             private final DayOfWeek weekday;</span>
<span class="udiff-line-added">+             private final Month month;</span>
<span class="udiff-line-added">+             private final int day;</span>
<span class="udiff-line-added">+             private final int hour;</span>
<span class="udiff-line-added">+             private final int minute;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             private Frequency(Interval interval, DayOfWeek weekday, Month month, int day, int hour, int minute) {</span>
<span class="udiff-line-added">+                 this.interval = interval;</span>
<span class="udiff-line-added">+                 this.weekday = weekday;</span>
<span class="udiff-line-added">+                 this.month = month;</span>
<span class="udiff-line-added">+                 this.day = day;</span>
<span class="udiff-line-added">+                 this.hour = hour;</span>
<span class="udiff-line-added">+                 this.minute = minute;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             static Frequency hourly(int minute) {</span>
<span class="udiff-line-added">+                 return new Frequency(Interval.HOURLY, null, null, -1, -1, minute);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             static Frequency daily(int hour) {</span>
<span class="udiff-line-added">+                 return new Frequency(Interval.DAILY, null, null, -1, hour, -1);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             static Frequency weekly(DayOfWeek weekday, int hour) {</span>
<span class="udiff-line-added">+                 return new Frequency(Interval.WEEKLY, weekday, null, -1, hour, -1);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             static Frequency monthly(int day, int hour) {</span>
<span class="udiff-line-added">+                 return new Frequency(Interval.MONTHLY, null, null, day, hour, -1);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             static Frequency yearly(Month month, int day, int hour) {</span>
<span class="udiff-line-added">+                 return new Frequency(Interval.YEARLY, null, month, day, hour, -1);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             boolean isHourly() {</span>
<span class="udiff-line-added">+                 return interval.isHourly();</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             boolean isDaily() {</span>
<span class="udiff-line-added">+                 return interval.isDaily();</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             boolean isWeekly() {</span>
<span class="udiff-line-added">+                 return interval.isWeekly();</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             boolean isMonthly() {</span>
<span class="udiff-line-added">+                 return interval.isMonthly();</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             boolean isYearly() {</span>
<span class="udiff-line-added">+                 return interval.isYearly();</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             DayOfWeek weekday() {</span>
<span class="udiff-line-added">+                 return weekday;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             Month month() {</span>
<span class="udiff-line-added">+                 return month;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             int day() {</span>
<span class="udiff-line-added">+                 return day;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             int hour() {</span>
<span class="udiff-line-added">+                 return hour;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             int minute() {</span>
<span class="udiff-line-added">+                 return minute;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
          private final HostedRepository fromRepo;
          private final Branch fromBranch;
          private final Branch toBranch;
<span class="udiff-line-added">+         private final Frequency frequency;</span>
  
          Spec(HostedRepository fromRepo, Branch fromBranch, Branch toBranch) {
<span class="udiff-line-added">+             this(fromRepo, fromBranch, toBranch, null);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         Spec(HostedRepository fromRepo, Branch fromBranch, Branch toBranch, Frequency frequency) {</span>
              this.fromRepo = fromRepo;
              this.fromBranch = fromBranch;
              this.toBranch = toBranch;
<span class="udiff-line-added">+             this.frequency = frequency;</span>
          }
  
          HostedRepository fromRepo() {
              return fromRepo;
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -72,10 +205,14 @@</span>
          }
  
          Branch toBranch() {
              return toBranch;
          }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         Optional&lt;Frequency&gt; frequency() {</span>
<span class="udiff-line-added">+             return Optional.ofNullable(frequency);</span>
<span class="udiff-line-added">+         }</span>
      }
  
      @Override
      public boolean concurrentWith(WorkItem other) {
          if (!(other instanceof MergeBot)) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -124,11 +261,11 @@</span>
                  // Checkout the branch to merge into
                  repo.pull(fork.url().toString(), toBranch.name());
                  repo.checkout(toBranch, false);
  
                  // Check if merge conflict pull request is present
<span class="udiff-line-modified-removed">-                 var isMergeConflictPRPresent = false;</span>
<span class="udiff-line-modified-added">+                 var shouldMerge = true;</span>
                  var title = &quot;Cannot automatically merge &quot; + fromRepo.name() + &quot;:&quot; + fromBranch.name() + &quot; to &quot; + toBranch.name();
                  var marker = &quot;&lt;!-- MERGE CONFLICTS --&gt;&quot;;
                  for (var pr : prs) {
                      if (pr.title().equals(title) &amp;&amp;
                          pr.body().startsWith(marker) &amp;&amp;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -139,17 +276,89 @@</span>
                              log.info(&quot;Closing resolved merge conflict PR &quot; + pr.id());
                              pr.addComment(&quot;Merge conflicts have been resolved, closing this PR&quot;);
                              pr.setState(PullRequest.State.CLOSED);
                          } else {
                              log.info(&quot;Outstanding unresolved merge already present&quot;);
<span class="udiff-line-modified-removed">-                             isMergeConflictPRPresent = true;</span>
<span class="udiff-line-modified-added">+                             shouldMerge = false;</span>
                          }
                          break;
                      }
                  }
  
<span class="udiff-line-modified-removed">-                 if (isMergeConflictPRPresent) {</span>
<span class="udiff-line-modified-added">+                 if (spec.frequency().isPresent()) {</span>
<span class="udiff-line-added">+                     var now = clock.now();</span>
<span class="udiff-line-added">+                     var desc = toBranch.name() + &quot;-&gt;&quot; + fromRepo.name() + &quot;:&quot; + fromBranch.name();</span>
<span class="udiff-line-added">+                     var freq = spec.frequency().get();</span>
<span class="udiff-line-added">+                     if (freq.isHourly()) {</span>
<span class="udiff-line-added">+                         if (!hourly.containsKey(desc)) {</span>
<span class="udiff-line-added">+                             hourly.put(desc, new HashSet&lt;Integer&gt;());</span>
<span class="udiff-line-added">+                         }</span>
<span class="udiff-line-added">+                         var minute = now.getMinute();</span>
<span class="udiff-line-added">+                         var hour = now.getHour();</span>
<span class="udiff-line-added">+                         if (freq.minute() == minute &amp;&amp; !hourly.get(desc).contains(hour)) {</span>
<span class="udiff-line-added">+                             hourly.get(desc).add(hour);</span>
<span class="udiff-line-added">+                         } else {</span>
<span class="udiff-line-added">+                             shouldMerge = false;</span>
<span class="udiff-line-added">+                         }</span>
<span class="udiff-line-added">+                     } else if (freq.isDaily()) {</span>
<span class="udiff-line-added">+                         if (!daily.containsKey(desc)) {</span>
<span class="udiff-line-added">+                             daily.put(desc, new HashSet&lt;Integer&gt;());</span>
<span class="udiff-line-added">+                         }</span>
<span class="udiff-line-added">+                         var hour = now.getHour();</span>
<span class="udiff-line-added">+                         var day = now.getDayOfYear();</span>
<span class="udiff-line-added">+                         if (freq.hour() == hour &amp;&amp; !daily.get(desc).contains(day)) {</span>
<span class="udiff-line-added">+                             daily.get(desc).add(day);</span>
<span class="udiff-line-added">+                         } else {</span>
<span class="udiff-line-added">+                             shouldMerge = false;</span>
<span class="udiff-line-added">+                         }</span>
<span class="udiff-line-added">+                     } else if (freq.isWeekly()) {</span>
<span class="udiff-line-added">+                         if (!weekly.containsKey(desc)) {</span>
<span class="udiff-line-added">+                             weekly.put(desc, new HashSet&lt;Integer&gt;());</span>
<span class="udiff-line-added">+                         }</span>
<span class="udiff-line-added">+                         var weekOfYear = now.get(WeekFields.ISO.weekOfYear());</span>
<span class="udiff-line-added">+                         var weekday = now.getDayOfWeek();</span>
<span class="udiff-line-added">+                         var hour = now.getHour();</span>
<span class="udiff-line-added">+                         if (freq.weekday().equals(weekday) &amp;&amp;</span>
<span class="udiff-line-added">+                             freq.hour() == hour &amp;&amp;</span>
<span class="udiff-line-added">+                             !weekly.get(desc).contains(weekOfYear)) {</span>
<span class="udiff-line-added">+                             weekly.get(desc).add(weekOfYear);</span>
<span class="udiff-line-added">+                         } else {</span>
<span class="udiff-line-added">+                             shouldMerge = false;</span>
<span class="udiff-line-added">+                         }</span>
<span class="udiff-line-added">+                     } else if (freq.isMonthly()) {</span>
<span class="udiff-line-added">+                         if (!monthly.containsKey(desc)) {</span>
<span class="udiff-line-added">+                             monthly.put(desc, new HashSet&lt;Month&gt;());</span>
<span class="udiff-line-added">+                         }</span>
<span class="udiff-line-added">+                         var day = now.getDayOfMonth();</span>
<span class="udiff-line-added">+                         var hour = now.getHour();</span>
<span class="udiff-line-added">+                         var month = now.getMonth();</span>
<span class="udiff-line-added">+                         if (freq.day() == day &amp;&amp; freq.hour() == hour &amp;&amp;</span>
<span class="udiff-line-added">+                             !monthly.get(desc).contains(month)) {</span>
<span class="udiff-line-added">+                             monthly.get(desc).add(month);</span>
<span class="udiff-line-added">+                         } else {</span>
<span class="udiff-line-added">+                             shouldMerge = false;</span>
<span class="udiff-line-added">+                         }</span>
<span class="udiff-line-added">+                     } else if (freq.isYearly()) {</span>
<span class="udiff-line-added">+                         if (!yearly.containsKey(desc)) {</span>
<span class="udiff-line-added">+                             yearly.put(desc, new HashSet&lt;Integer&gt;());</span>
<span class="udiff-line-added">+                         }</span>
<span class="udiff-line-added">+                         var month = now.getMonth();</span>
<span class="udiff-line-added">+                         var day = now.getDayOfMonth();</span>
<span class="udiff-line-added">+                         var hour = now.getHour();</span>
<span class="udiff-line-added">+                         var year = now.getYear();</span>
<span class="udiff-line-added">+                         if (freq.month().equals(month) &amp;&amp;</span>
<span class="udiff-line-added">+                             freq.day() == day &amp;&amp;</span>
<span class="udiff-line-added">+                             freq.hour() == hour &amp;&amp;</span>
<span class="udiff-line-added">+                             !yearly.get(desc).contains(year)) {</span>
<span class="udiff-line-added">+                             yearly.get(desc).add(year);</span>
<span class="udiff-line-added">+                         } else {</span>
<span class="udiff-line-added">+                             shouldMerge = false;</span>
<span class="udiff-line-added">+                         }</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                 if (!shouldMerge) {</span>
                      continue;
                  }
  
                  log.info(&quot;Fetching &quot; + fromRepo.name() + &quot;:&quot; + fromBranch.name());
                  var fetchHead = repo.fetch(fromRepo.url(), fromBranch.name());
</pre>
<center><a href="../../../../../../../../../../Makefile.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="MergeBotFactory.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>