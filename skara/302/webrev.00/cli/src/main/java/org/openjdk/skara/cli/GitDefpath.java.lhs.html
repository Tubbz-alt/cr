<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames cli/src/main/java/org/openjdk/skara/cli/GitDefpath.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.cli;
 24 
 25 import org.openjdk.skara.args.*;
<a name="1" id="anc1"></a>

 26 import org.openjdk.skara.vcs.*;
 27 import org.openjdk.skara.webrev.*;
<a name="2" id="anc2"></a>
 28 
 29 import java.io.*;
 30 import java.nio.file.*;
 31 import java.util.*;
 32 import java.net.http.*;
 33 import static java.net.http.HttpResponse.BodyHandlers;
 34 import java.net.URI;
 35 
 36 public class GitDefpath {
 37     private static String config(ReadOnlyRepository repo, String key, String fallback) throws IOException {
 38         var lines = repo.config(key);
 39         if (lines.size() == 0) {
 40             return fallback;
 41         }
 42 
 43         return lines.get(0);
 44     }
 45 
 46     static boolean probe(URI uri) {
 47         try {
 48             var client = HttpClient.newHttpClient();
 49             var req = HttpRequest.newBuilder(uri).build();
 50             var res = client.send(req, BodyHandlers.discarding());
 51             return res.statusCode() &lt; 400;
 52         } catch (InterruptedException e) {
 53             // do nothing
 54         } catch (IOException e) {
 55             // do nothing
 56         }
 57 
 58         return false;
 59     }
 60 
 61     static String probe(String primary, String fallback) {
 62         if (primary.startsWith(&quot;http&quot;) || primary.startsWith(&quot;https&quot;)) {
 63             var uri = URI.create(primary);
 64             if (probe(uri)) {
 65                 return primary;
 66             }
 67 
 68             if (fallback == null) {
 69                 System.err.println(&quot;error: repository &quot; + primary + &quot; not found&quot;);
 70                 System.exit(1);
 71             }
 72 
 73             if (fallback.startsWith(&quot;http&quot;) || fallback.startsWith(&quot;https&quot;)) {
 74                 var alternative = URI.create(fallback + uri.getPath());
 75                 if (probe(alternative)) {
 76                     return fallback;
 77                 }
 78             }
 79 
 80             System.err.println(&quot;error: repository &quot; + primary + &quot; not found&quot;);
 81             System.err.println(&quot;error: repository &quot; + fallback + &quot; not found&quot;);
 82             System.exit(1);
 83         }
 84 
 85         return primary;
 86     }
 87 
 88     static String toPushPath(String pullPath, String username, boolean isMercurial) {
 89         if (pullPath.startsWith(&quot;http&quot;) || pullPath.startsWith(&quot;https&quot;)) {
 90             var uri = URI.create(pullPath);
 91             var scheme = uri.getScheme();
<a name="3" id="anc3"></a><span class="line-modified"> 92             if (isMercurial) {</span>
<span class="line-modified"> 93                 return URI.create(&quot;ssh://&quot; + username + &quot;@&quot; + uri.getAuthority() + uri.getPath()).toString();</span>
<span class="line-removed"> 94             } else {</span>
<span class="line-removed"> 95                 var path = uri.getPath();</span>
<span class="line-removed"> 96                 if (path.startsWith(&quot;/&quot;)) {</span>
<span class="line-removed"> 97                     path = path.substring(1);</span>
<span class="line-removed"> 98                 }</span>
<span class="line-removed"> 99                 return &quot;git@&quot; + uri.getAuthority() + &quot;:&quot; + path;</span>
<span class="line-removed">100             }</span>
101         }
102 
103         return pullPath;
104     }
105 
106     static void showPaths(ReadOnlyRepository repo, String remote) throws IOException {
107         showPaths(repo, repo.pullPath(remote), repo.pushPath(remote));
108 
109     }
110 
111     static void showPaths(ReadOnlyRepository repo, String pull, String push) throws IOException {
112         System.out.format(&quot;%s:\n&quot;, repo.root().toString());
113         System.out.format(&quot;         default = %s\n&quot;, pull);
114         System.out.format(&quot;    default-push = %s\n&quot;, push);
115     }
116 
117     static String getUsername(ReadOnlyRepository repo, Arguments arguments) {
118         var arg = arguments.get(&quot;username&quot;);
119         if (arg.isPresent()) {
120             return arg.asString();
121         }
122 
123         try {
124             var lines = repo.config(&quot;defpath.username&quot;);
125             if (lines.size() == 1) {
126                 return lines.get(0);
127             }
128         } catch (IOException e) {
129         }
130 
131         try {
132             var conf = repo.username();
133             if (conf.isPresent()) {
134                 return conf.get();
135             }
136         } catch (IOException e) {
137         }
138 
139         return System.getProperty(&quot;user.name&quot;);
140     }
141     private static void die(String message) {
142         System.err.println(message);
143         System.exit(1);
144     }
145 
146     public static void main(String[] args) throws IOException {
147         var flags = List.of(
148             Option.shortcut(&quot;u&quot;)
149                   .fullname(&quot;username&quot;)
150                   .describe(&quot;NAME&quot;)
151                   .helptext(&quot;username for push URL&quot;)
152                   .optional(),
153             Option.shortcut(&quot;r&quot;)
154                   .fullname(&quot;remote&quot;)
155                   .describe(&quot;URI&quot;)
156                   .helptext(&quot;remote for which to set paths&quot;)
157                   .optional(),
158             Option.shortcut(&quot;s&quot;)
159                   .fullname(&quot;secondary&quot;)
160                   .describe(&quot;URL&quot;)
161                   .helptext(&quot;secondary peer repository base URL&quot;)
162                   .optional(),
163             Switch.shortcut(&quot;m&quot;)
164                   .fullname(&quot;mercurial&quot;)
165                   .helptext(&quot;Deprecated: force use of mercurial&quot;)
166                   .optional(),
167             Switch.shortcut(&quot;d&quot;)
168                   .fullname(&quot;default&quot;)
169                   .helptext(&quot;use current default path to compute push path&quot;)
170                   .optional(),
<a name="4" id="anc4"></a>







171             Switch.shortcut(&quot;g&quot;)
172                   .fullname(&quot;gated&quot;)
173                   .helptext(&quot;create gated push URL&quot;)
174                   .optional(),
175             Switch.shortcut(&quot;n&quot;)
176                   .fullname(&quot;dry-run&quot;)
177                   .helptext(&quot;do not perform actions, just print output&quot;)
178                   .optional(),
179             Switch.shortcut(&quot;v&quot;)
180                   .fullname(&quot;version&quot;)
181                   .helptext(&quot;Print the version of this tool&quot;)
182                   .optional());
183 
184         var inputs = List.of(
185             Input.position(0)
186                  .describe(&quot;PEER&quot;)
187                  .singular()
188                  .optional(),
189             Input.position(1)
190                  .describe(&quot;PEER-PUSH&quot;)
191                  .singular()
192                  .optional()
193         );
194 
195         var parser = new ArgumentParser(&quot;git-defpath&quot;, flags, inputs);
196         var arguments = parser.parse(args);
197 
198         if (arguments.contains(&quot;version&quot;)) {
199             System.out.println(&quot;git-defpath version: &quot; + Version.fromManifest().orElse(&quot;unknown&quot;));
200             System.exit(0);
201         }
202 
203         var cwd = Path.of(&quot;&quot;).toAbsolutePath();
204         var repository = Repository.get(cwd);
205         if (!repository.isPresent()) {
206             die(String.format(&quot;error: %s is not a hg repository&quot;, cwd.toString()));
207         }
208         var repo = repository.get();
209 
210         var username = getUsername(repo, arguments);
211         if (username == null) {
212             die(&quot;error: no username found&quot;);
213         }
214 
215         var isMercurial = arguments.contains(&quot;mercurial&quot;);
<a name="5" id="anc5"></a><span class="line-modified">216         var remote = arguments.get(&quot;remote&quot;).orString(isMercurial ? &quot;default&quot;: &quot;origin&quot;);</span>









217 
218         if (arguments.contains(&quot;gated&quot;)) {
219             System.err.println(&quot;warning: gated push repositories are no longer used, option ignored&quot;);
220         }
221 
222         if ((arguments.at(0).isPresent() || arguments.at(1).isPresent()) &amp;&amp; arguments.contains(&quot;default&quot;)) {
223             die(&quot;error: peers cannot be specified together with -d flag&quot;);
224         }
225 
226         var fallback = arguments.contains(&quot;secondary&quot;) ? arguments.get(&quot;secondary&quot;).asString() : null;
<a name="6" id="anc6"></a>







227 
228         String pullPath = null;
229         if (arguments.at(0).isPresent()) {
230             pullPath = arguments.at(0).asString();
<a name="7" id="anc7"></a><span class="line-modified">231         } else if (arguments.contains(&quot;default&quot;)) {</span>
<span class="line-modified">232             try {</span>
<span class="line-modified">233                 pullPath = repo.pullPath(remote);</span>
<span class="line-modified">234             } catch (IOException e) {</span>
<span class="line-modified">235                 die(&quot;error: -d flag specified but repository has no default path&quot;);</span>
















































































236             }
237         }
238 
239         if (pullPath == null) {
240             showPaths(repo, remote);
<a name="8" id="anc8"></a>





241             System.exit(0);
242         }
243 
244         var newPullPath = probe(pullPath, fallback);
245 
246         String pushPath = null;
247         if (arguments.at(1).isPresent()) {
248             pushPath = arguments.at(1).asString();
249         }
250 
251         var newPushPath = pushPath == null ? toPushPath(newPullPath, username, isMercurial) : pushPath;
<a name="9" id="anc9"></a><span class="line-modified">252         if (arguments.contains(&quot;dry-run&quot;)) {</span>

253             showPaths(repo, newPullPath, newPushPath);
254         } else {
255             repo.setPaths(remote, newPullPath, newPushPath);
256         }
257     }
258 }
<a name="10" id="anc10"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="10" type="hidden" />
</body>
</html>