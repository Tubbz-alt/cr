<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/notify/RepositoryUpdateConsumer.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 179     void testMailingList(TestInfo testInfo) throws IOException {
 180         try (var listServer = new TestMailmanServer();
 181              var credentials = new HostCredentials(testInfo);
 182              var tempFolder = new TemporaryDirectory()) {
 183             var repo = credentials.getHostedRepository();
 184             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 185             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 186             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 187             credentials.commitLock(localRepo);
 188             localRepo.pushAll(repo.url());
 189 
 190             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 191             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 192             var mailmanList = mailmanServer.getList(listAddress.address());
 193             var tagStorage = createTagStorage(repo);
 194             var branchStorage = createBranchStorage(repo);
 195             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 196             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 197 
 198             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
<span class="line-modified"> 199             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null, false, MailingListUpdater.Mode.ALL,</span>

 200                                                  Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;), Pattern.compile(&quot;none&quot;));
 201             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 202                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 203 
 204             // No mail should be sent on the first run as there is no history
 205             TestBotRunner.runPeriodicItems(notifyBot);
 206             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 207 
 208             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 209             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 210             TestBotRunner.runPeriodicItems(notifyBot);
 211             listServer.processIncoming();
 212 
 213             var conversations = mailmanList.conversations(Duration.ofDays(1));
 214             var email = conversations.get(0).first();
 215             assertEquals(listAddress, email.sender());
 216             assertEquals(sender, email.author());
 217             assertEquals(email.recipients(), List.of(listAddress));
 218             assertTrue(email.subject().contains(&quot;: 23456789: More fixes&quot;));
 219             assertFalse(email.subject().contains(&quot;master&quot;));
</pre>
<hr />
<pre>
 232     void testMailingListMultiple(TestInfo testInfo) throws IOException {
 233         try (var listServer = new TestMailmanServer();
 234              var credentials = new HostCredentials(testInfo);
 235              var tempFolder = new TemporaryDirectory()) {
 236             var repo = credentials.getHostedRepository();
 237             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 238             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 239             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 240             credentials.commitLock(localRepo);
 241             localRepo.pushAll(repo.url());
 242 
 243             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 244             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 245             var mailmanList = mailmanServer.getList(listAddress.address());
 246             var tagStorage = createTagStorage(repo);
 247             var branchStorage = createBranchStorage(repo);
 248             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 249             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 250 
 251             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
<span class="line-modified"> 252             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null, false,</span>

 253                                                  MailingListUpdater.Mode.ALL, Map.of(), Pattern.compile(&quot;.*&quot;));
 254             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 255                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 256 
 257             // No mail should be sent on the first run as there is no history
 258             TestBotRunner.runPeriodicItems(notifyBot);
 259             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 260 
 261             var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
 262                                                                 &quot;first_author&quot;, &quot;first@author.example.com&quot;);
 263             localRepo.push(editHash1, repo.url(), &quot;master&quot;);
 264             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;,
 265                                                                 &quot;another_author&quot;, &quot;another@author.example.com&quot;);
 266             localRepo.push(editHash2, repo.url(), &quot;master&quot;);
 267 
 268             TestBotRunner.runPeriodicItems(notifyBot);
 269             listServer.processIncoming();
 270 
 271             var conversations = mailmanList.conversations(Duration.ofDays(1));
 272             var email = conversations.get(0).first();
</pre>
<hr />
<pre>
 287     void testMailingListSponsored(TestInfo testInfo) throws IOException {
 288         try (var listServer = new TestMailmanServer();
 289              var credentials = new HostCredentials(testInfo);
 290              var tempFolder = new TemporaryDirectory()) {
 291             var repo = credentials.getHostedRepository();
 292             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 293             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 294             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 295             credentials.commitLock(localRepo);
 296             localRepo.pushAll(repo.url());
 297 
 298             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 299             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 300             var mailmanList = mailmanServer.getList(listAddress.address());
 301             var tagStorage = createTagStorage(repo);
 302             var branchStorage = createBranchStorage(repo);
 303             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 304             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 305 
 306             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
<span class="line-modified"> 307             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null, false,</span>

 308                                                  MailingListUpdater.Mode.ALL, Map.of(), Pattern.compile(&quot;.*&quot;));
 309             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 310                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 311 
 312             // No mail should be sent on the first run as there is no history
 313             TestBotRunner.runPeriodicItems(notifyBot);
 314             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 315 
 316             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
 317                                                                &quot;author&quot;, &quot;author@test.test&quot;,
 318                                                                &quot;committer&quot;, &quot;committer@test.test&quot;);
 319             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 320             TestBotRunner.runPeriodicItems(notifyBot);
 321             listServer.processIncoming();
 322 
 323             var conversations = mailmanList.conversations(Duration.ofDays(1));
 324             var email = conversations.get(0).first();
 325             assertEquals(listAddress, email.sender());
 326             assertEquals(EmailAddress.from(&quot;committer&quot;, &quot;committer@test.test&quot;), email.author());
 327             assertEquals(email.recipients(), List.of(listAddress));
</pre>
<hr />
<pre>
 339              var credentials = new HostCredentials(testInfo);
 340              var tempFolder = new TemporaryDirectory()) {
 341             var repo = credentials.getHostedRepository();
 342             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 343             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 344             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 345             credentials.commitLock(localRepo);
 346             var branch = localRepo.branch(masterHash, &quot;another&quot;);
 347             localRepo.pushAll(repo.url());
 348 
 349             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 350             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 351             var mailmanList = mailmanServer.getList(listAddress.address());
 352             var tagStorage = createTagStorage(repo);
 353             var branchStorage = createBranchStorage(repo);
 354             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 355             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 356 
 357             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 358             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);
<span class="line-modified"> 359             var updater = new MailingListUpdater(mailmanList, listAddress, sender, author, true,</span>

 360                                                  MailingListUpdater.Mode.ALL, Map.of(), Pattern.compile(&quot;.*&quot;));
 361             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master|another&quot;), tagStorage, branchStorage,
 362                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 363 
 364             // No mail should be sent on the first run as there is no history
 365             TestBotRunner.runPeriodicItems(notifyBot);
 366             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 367 
 368             var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 369             localRepo.push(editHash1, repo.url(), &quot;master&quot;);
 370             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;);
 371             localRepo.push(editHash2, repo.url(), &quot;master&quot;);
 372 
 373             TestBotRunner.runPeriodicItems(notifyBot);
 374             listServer.processIncoming();
 375 
 376             var conversations = mailmanList.conversations(Duration.ofDays(1));
 377             var email = conversations.get(0).first();
 378             assertEquals(listAddress, email.sender());
 379             assertEquals(author, email.author());
</pre>
<hr />
<pre>
 414         try (var listServer = new TestMailmanServer();
 415              var credentials = new HostCredentials(testInfo);
 416              var tempFolder = new TemporaryDirectory()) {
 417             var repo = credentials.getHostedRepository();
 418             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 419             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 420             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 421             credentials.commitLock(localRepo);
 422             localRepo.pushAll(repo.url());
 423 
 424             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 425             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 426             var mailmanList = mailmanServer.getList(listAddress.address());
 427             var tagStorage = createTagStorage(repo);
 428             var branchStorage = createBranchStorage(repo);
 429             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 430             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 431 
 432             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 433             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);
<span class="line-modified"> 434             var updater = new MailingListUpdater(mailmanList, listAddress, sender, author, false,</span>

 435                                                  MailingListUpdater.Mode.PR_ONLY, Map.of(&quot;extra1&quot;, &quot;value1&quot;),
 436                                                  Pattern.compile(&quot;.*&quot;));
 437             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 438                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 439 
 440             // No mail should be sent on the first run as there is no history
 441             TestBotRunner.runPeriodicItems(notifyBot);
 442             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 443 
 444             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 445             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 446             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 447 
 448             // Create a potentially conflicting one
 449             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 450             localRepo.push(otherHash, repo.url(), &quot;other&quot;);
 451             var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);
 452 
 453             // PR hasn&#39;t been integrated yet, so there should be no mail
 454             TestBotRunner.runPeriodicItems(notifyBot);
</pre>
<hr />
<pre>
 494     void testMailingListPR(TestInfo testInfo) throws IOException {
 495         try (var listServer = new TestMailmanServer();
 496              var credentials = new HostCredentials(testInfo);
 497              var tempFolder = new TemporaryDirectory()) {
 498             var repo = credentials.getHostedRepository();
 499             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 500             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 501             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 502             credentials.commitLock(localRepo);
 503             localRepo.pushAll(repo.url());
 504 
 505             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 506             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 507             var mailmanList = mailmanServer.getList(listAddress.address());
 508             var tagStorage = createTagStorage(repo);
 509             var branchStorage = createBranchStorage(repo);
 510             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 511             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 512 
 513             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
<span class="line-modified"> 514             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null, false,</span>

 515                                                  MailingListUpdater.Mode.PR, Map.of(), Pattern.compile(&quot;.*&quot;));
 516             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 517                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 518 
 519             // No mail should be sent on the first run as there is no history
 520             TestBotRunner.runPeriodicItems(notifyBot);
 521             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 522 
 523             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 524             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 525             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 526 
 527             // Create a potentially conflicting one
 528             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 529             localRepo.push(otherHash, repo.url(), &quot;other&quot;);
 530             var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);
 531 
 532             // PR hasn&#39;t been integrated yet, so there should be no mail
 533             TestBotRunner.runPeriodicItems(notifyBot);
 534             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
</pre>
<hr />
<pre>
 583         try (var credentials = new HostCredentials(testInfo);
 584              var tempFolder = new TemporaryDirectory();
 585              var listServer = new TestMailmanServer()) {
 586             var repo = credentials.getHostedRepository();
 587             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 588             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
 589             credentials.commitLock(localRepo);
 590             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 591             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 592             localRepo.pushAll(repo.url());
 593 
 594             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 595             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 596             var mailmanList = mailmanServer.getList(listAddress.address());
 597             var tagStorage = createTagStorage(repo);
 598             var branchStorage = createBranchStorage(repo);
 599             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 600             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 601 
 602             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
<span class="line-modified"> 603             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null, false, MailingListUpdater.Mode.ALL,</span>


 604                                                  Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;),
 605                                                  Pattern.compile(&quot;.*&quot;));
<span class="line-modified"> 606             var prOnlyUpdater = new MailingListUpdater(mailmanList, listAddress, sender, null, false,</span>

 607                                                        MailingListUpdater.Mode.PR_ONLY, Map.of(), Pattern.compile(&quot;.*&quot;));
 608             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 609                                           prIssuesStorage, List.of(updater, prOnlyUpdater), List.of(), Set.of(), Map.of());
 610 
 611             // No mail should be sent on the first run as there is no history
 612             TestBotRunner.runPeriodicItems(notifyBot);
 613             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 614 
 615             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 616             localRepo.fetch(repo.url(), &quot;history:history&quot;);
 617             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 618             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);
 619             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);
 620             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);
 621             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 622             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);
 623             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);
 624             localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 625             localRepo.pushAll(repo.url());
 626 
</pre>
<hr />
<pre>
 661                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 662                 } else if (email.subject().equals(&quot;git: test: 6 new changesets&quot;)) {
 663                     assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 664                     assertTrue(email.body().contains(&quot;34567890: Even more fixes&quot;));
 665                     assertTrue(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
 666                     assertTrue(email.body().contains(&quot;56789012: Still even more fixes&quot;));
 667                     assertTrue(email.body().contains(&quot;67890123: Brand new fixes&quot;));
 668                     assertTrue(email.body().contains(&quot;78901234: More brand new fixes&quot;));
 669                     assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());
 670                 } else {
 671                     fail(&quot;Mismatched subject: &quot; + email.subject());
 672                 }
 673                 assertTrue(email.hasHeader(&quot;extra1&quot;));
 674                 assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
 675                 assertTrue(email.hasHeader(&quot;extra2&quot;));
 676                 assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
 677             }
 678         }
 679     }
 680 















































































 681     @Test
 682     void testMailingListBranch(TestInfo testInfo) throws IOException {
 683         try (var listServer = new TestMailmanServer();
 684              var credentials = new HostCredentials(testInfo);
 685              var tempFolder = new TemporaryDirectory()) {
 686             var repo = credentials.getHostedRepository();
 687             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 688             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 689             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 690             credentials.commitLock(localRepo);
 691             localRepo.pushAll(repo.url());
 692 
 693             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 694             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 695             var mailmanList = mailmanServer.getList(listAddress.address());
 696             var tagStorage = createTagStorage(repo);
 697             var branchStorage = createBranchStorage(repo);
 698             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 699             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 700 
 701             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
<span class="line-modified"> 702             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null, false, MailingListUpdater.Mode.ALL,</span>


 703                                                  Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;),
 704                                                  Pattern.compile(&quot;.*&quot;));
 705             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master|newbranch.&quot;), tagStorage, branchStorage,
 706                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 707 
 708             // No mail should be sent on the first run as there is no history
 709             TestBotRunner.runPeriodicItems(notifyBot);
 710             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 711 
 712             CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;12345678: Some fixes&quot;);
 713             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 714             localRepo.push(editHash, repo.url(), &quot;newbranch1&quot;);
 715             TestBotRunner.runPeriodicItems(notifyBot);
 716             listServer.processIncoming();
 717 
 718             var conversations = mailmanList.conversations(Duration.ofDays(1));
 719             var email = conversations.get(0).first();
 720             assertEquals(listAddress, email.sender());
 721             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());
 722             assertEquals(email.recipients(), List.of(listAddress));
</pre>
<hr />
<pre>
 750     void testMailingListNoIdempotence(TestInfo testInfo) throws IOException {
 751         try (var listServer = new TestMailmanServer();
 752              var credentials = new HostCredentials(testInfo);
 753              var tempFolder = new TemporaryDirectory()) {
 754             var repo = credentials.getHostedRepository();
 755             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 756             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 757             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 758             credentials.commitLock(localRepo);
 759             localRepo.pushAll(repo.url());
 760 
 761             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 762             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 763             var mailmanList = mailmanServer.getList(listAddress.address());
 764             var tagStorage = createTagStorage(repo);
 765             var branchStorage = createBranchStorage(repo);
 766             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 767             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 768 
 769             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
<span class="line-modified"> 770             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null, false, MailingListUpdater.Mode.ALL,</span>


 771                                                  Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;), Pattern.compile(&quot;none&quot;));
 772             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 773                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 774 
 775             // No mail should be sent on the first run as there is no history
 776             TestBotRunner.runPeriodicItems(notifyBot);
 777             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 778 
 779             // Save history state
 780             var historyHash = localRepo.fetch(repo.url(), &quot;history&quot;);
 781 
 782             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 783             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 784             TestBotRunner.runPeriodicItems(notifyBot);
 785             listServer.processIncoming();
 786 
 787             var conversations = mailmanList.conversations(Duration.ofDays(1));
 788             assertEquals(1, conversations.size());
 789 
 790             // Reset the history
</pre>
</td>
<td>
<hr />
<pre>
 179     void testMailingList(TestInfo testInfo) throws IOException {
 180         try (var listServer = new TestMailmanServer();
 181              var credentials = new HostCredentials(testInfo);
 182              var tempFolder = new TemporaryDirectory()) {
 183             var repo = credentials.getHostedRepository();
 184             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 185             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 186             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 187             credentials.commitLock(localRepo);
 188             localRepo.pushAll(repo.url());
 189 
 190             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 191             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 192             var mailmanList = mailmanServer.getList(listAddress.address());
 193             var tagStorage = createTagStorage(repo);
 194             var branchStorage = createBranchStorage(repo);
 195             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 196             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 197 
 198             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
<span class="line-modified"> 199             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null, false, false, false, false,</span>
<span class="line-added"> 200                                                  MailingListUpdater.Mode.ALL,</span>
 201                                                  Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;), Pattern.compile(&quot;none&quot;));
 202             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 203                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 204 
 205             // No mail should be sent on the first run as there is no history
 206             TestBotRunner.runPeriodicItems(notifyBot);
 207             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 208 
 209             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 210             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 211             TestBotRunner.runPeriodicItems(notifyBot);
 212             listServer.processIncoming();
 213 
 214             var conversations = mailmanList.conversations(Duration.ofDays(1));
 215             var email = conversations.get(0).first();
 216             assertEquals(listAddress, email.sender());
 217             assertEquals(sender, email.author());
 218             assertEquals(email.recipients(), List.of(listAddress));
 219             assertTrue(email.subject().contains(&quot;: 23456789: More fixes&quot;));
 220             assertFalse(email.subject().contains(&quot;master&quot;));
</pre>
<hr />
<pre>
 233     void testMailingListMultiple(TestInfo testInfo) throws IOException {
 234         try (var listServer = new TestMailmanServer();
 235              var credentials = new HostCredentials(testInfo);
 236              var tempFolder = new TemporaryDirectory()) {
 237             var repo = credentials.getHostedRepository();
 238             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 239             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 240             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 241             credentials.commitLock(localRepo);
 242             localRepo.pushAll(repo.url());
 243 
 244             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 245             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 246             var mailmanList = mailmanServer.getList(listAddress.address());
 247             var tagStorage = createTagStorage(repo);
 248             var branchStorage = createBranchStorage(repo);
 249             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 250             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 251 
 252             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
<span class="line-modified"> 253             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null,</span>
<span class="line-added"> 254                                                  false, false, false, false,</span>
 255                                                  MailingListUpdater.Mode.ALL, Map.of(), Pattern.compile(&quot;.*&quot;));
 256             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 257                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 258 
 259             // No mail should be sent on the first run as there is no history
 260             TestBotRunner.runPeriodicItems(notifyBot);
 261             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 262 
 263             var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
 264                                                                 &quot;first_author&quot;, &quot;first@author.example.com&quot;);
 265             localRepo.push(editHash1, repo.url(), &quot;master&quot;);
 266             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;,
 267                                                                 &quot;another_author&quot;, &quot;another@author.example.com&quot;);
 268             localRepo.push(editHash2, repo.url(), &quot;master&quot;);
 269 
 270             TestBotRunner.runPeriodicItems(notifyBot);
 271             listServer.processIncoming();
 272 
 273             var conversations = mailmanList.conversations(Duration.ofDays(1));
 274             var email = conversations.get(0).first();
</pre>
<hr />
<pre>
 289     void testMailingListSponsored(TestInfo testInfo) throws IOException {
 290         try (var listServer = new TestMailmanServer();
 291              var credentials = new HostCredentials(testInfo);
 292              var tempFolder = new TemporaryDirectory()) {
 293             var repo = credentials.getHostedRepository();
 294             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 295             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 296             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 297             credentials.commitLock(localRepo);
 298             localRepo.pushAll(repo.url());
 299 
 300             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 301             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 302             var mailmanList = mailmanServer.getList(listAddress.address());
 303             var tagStorage = createTagStorage(repo);
 304             var branchStorage = createBranchStorage(repo);
 305             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 306             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 307 
 308             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
<span class="line-modified"> 309             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null,</span>
<span class="line-added"> 310                                                  false, false, false, false,</span>
 311                                                  MailingListUpdater.Mode.ALL, Map.of(), Pattern.compile(&quot;.*&quot;));
 312             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 313                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 314 
 315             // No mail should be sent on the first run as there is no history
 316             TestBotRunner.runPeriodicItems(notifyBot);
 317             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 318 
 319             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
 320                                                                &quot;author&quot;, &quot;author@test.test&quot;,
 321                                                                &quot;committer&quot;, &quot;committer@test.test&quot;);
 322             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 323             TestBotRunner.runPeriodicItems(notifyBot);
 324             listServer.processIncoming();
 325 
 326             var conversations = mailmanList.conversations(Duration.ofDays(1));
 327             var email = conversations.get(0).first();
 328             assertEquals(listAddress, email.sender());
 329             assertEquals(EmailAddress.from(&quot;committer&quot;, &quot;committer@test.test&quot;), email.author());
 330             assertEquals(email.recipients(), List.of(listAddress));
</pre>
<hr />
<pre>
 342              var credentials = new HostCredentials(testInfo);
 343              var tempFolder = new TemporaryDirectory()) {
 344             var repo = credentials.getHostedRepository();
 345             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 346             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 347             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 348             credentials.commitLock(localRepo);
 349             var branch = localRepo.branch(masterHash, &quot;another&quot;);
 350             localRepo.pushAll(repo.url());
 351 
 352             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 353             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 354             var mailmanList = mailmanServer.getList(listAddress.address());
 355             var tagStorage = createTagStorage(repo);
 356             var branchStorage = createBranchStorage(repo);
 357             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 358             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 359 
 360             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 361             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);
<span class="line-modified"> 362             var updater = new MailingListUpdater(mailmanList, listAddress, sender, author,</span>
<span class="line-added"> 363                                                  true, false, false, false,</span>
 364                                                  MailingListUpdater.Mode.ALL, Map.of(), Pattern.compile(&quot;.*&quot;));
 365             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master|another&quot;), tagStorage, branchStorage,
 366                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 367 
 368             // No mail should be sent on the first run as there is no history
 369             TestBotRunner.runPeriodicItems(notifyBot);
 370             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 371 
 372             var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 373             localRepo.push(editHash1, repo.url(), &quot;master&quot;);
 374             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;);
 375             localRepo.push(editHash2, repo.url(), &quot;master&quot;);
 376 
 377             TestBotRunner.runPeriodicItems(notifyBot);
 378             listServer.processIncoming();
 379 
 380             var conversations = mailmanList.conversations(Duration.ofDays(1));
 381             var email = conversations.get(0).first();
 382             assertEquals(listAddress, email.sender());
 383             assertEquals(author, email.author());
</pre>
<hr />
<pre>
 418         try (var listServer = new TestMailmanServer();
 419              var credentials = new HostCredentials(testInfo);
 420              var tempFolder = new TemporaryDirectory()) {
 421             var repo = credentials.getHostedRepository();
 422             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 423             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 424             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 425             credentials.commitLock(localRepo);
 426             localRepo.pushAll(repo.url());
 427 
 428             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 429             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 430             var mailmanList = mailmanServer.getList(listAddress.address());
 431             var tagStorage = createTagStorage(repo);
 432             var branchStorage = createBranchStorage(repo);
 433             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 434             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 435 
 436             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 437             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);
<span class="line-modified"> 438             var updater = new MailingListUpdater(mailmanList, listAddress, sender, author,</span>
<span class="line-added"> 439                                                  false, false, false, false,</span>
 440                                                  MailingListUpdater.Mode.PR_ONLY, Map.of(&quot;extra1&quot;, &quot;value1&quot;),
 441                                                  Pattern.compile(&quot;.*&quot;));
 442             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 443                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 444 
 445             // No mail should be sent on the first run as there is no history
 446             TestBotRunner.runPeriodicItems(notifyBot);
 447             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 448 
 449             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 450             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 451             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 452 
 453             // Create a potentially conflicting one
 454             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 455             localRepo.push(otherHash, repo.url(), &quot;other&quot;);
 456             var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);
 457 
 458             // PR hasn&#39;t been integrated yet, so there should be no mail
 459             TestBotRunner.runPeriodicItems(notifyBot);
</pre>
<hr />
<pre>
 499     void testMailingListPR(TestInfo testInfo) throws IOException {
 500         try (var listServer = new TestMailmanServer();
 501              var credentials = new HostCredentials(testInfo);
 502              var tempFolder = new TemporaryDirectory()) {
 503             var repo = credentials.getHostedRepository();
 504             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 505             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 506             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 507             credentials.commitLock(localRepo);
 508             localRepo.pushAll(repo.url());
 509 
 510             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 511             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 512             var mailmanList = mailmanServer.getList(listAddress.address());
 513             var tagStorage = createTagStorage(repo);
 514             var branchStorage = createBranchStorage(repo);
 515             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 516             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 517 
 518             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
<span class="line-modified"> 519             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null,</span>
<span class="line-added"> 520                                                  false, false, false, false,</span>
 521                                                  MailingListUpdater.Mode.PR, Map.of(), Pattern.compile(&quot;.*&quot;));
 522             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 523                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 524 
 525             // No mail should be sent on the first run as there is no history
 526             TestBotRunner.runPeriodicItems(notifyBot);
 527             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 528 
 529             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 530             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 531             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 532 
 533             // Create a potentially conflicting one
 534             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 535             localRepo.push(otherHash, repo.url(), &quot;other&quot;);
 536             var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);
 537 
 538             // PR hasn&#39;t been integrated yet, so there should be no mail
 539             TestBotRunner.runPeriodicItems(notifyBot);
 540             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
</pre>
<hr />
<pre>
 589         try (var credentials = new HostCredentials(testInfo);
 590              var tempFolder = new TemporaryDirectory();
 591              var listServer = new TestMailmanServer()) {
 592             var repo = credentials.getHostedRepository();
 593             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 594             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
 595             credentials.commitLock(localRepo);
 596             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 597             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 598             localRepo.pushAll(repo.url());
 599 
 600             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 601             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 602             var mailmanList = mailmanServer.getList(listAddress.address());
 603             var tagStorage = createTagStorage(repo);
 604             var branchStorage = createBranchStorage(repo);
 605             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 606             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 607 
 608             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
<span class="line-modified"> 609             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null,</span>
<span class="line-added"> 610                                                  false, true, false, true,</span>
<span class="line-added"> 611                                                  MailingListUpdater.Mode.ALL,</span>
 612                                                  Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;),
 613                                                  Pattern.compile(&quot;.*&quot;));
<span class="line-modified"> 614             var prOnlyUpdater = new MailingListUpdater(mailmanList, listAddress, sender, null,</span>
<span class="line-added"> 615                                                        false, false, false, false,</span>
 616                                                        MailingListUpdater.Mode.PR_ONLY, Map.of(), Pattern.compile(&quot;.*&quot;));
 617             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 618                                           prIssuesStorage, List.of(updater, prOnlyUpdater), List.of(), Set.of(), Map.of());
 619 
 620             // No mail should be sent on the first run as there is no history
 621             TestBotRunner.runPeriodicItems(notifyBot);
 622             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 623 
 624             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 625             localRepo.fetch(repo.url(), &quot;history:history&quot;);
 626             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 627             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);
 628             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);
 629             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);
 630             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 631             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);
 632             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);
 633             localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 634             localRepo.pushAll(repo.url());
 635 
</pre>
<hr />
<pre>
 670                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 671                 } else if (email.subject().equals(&quot;git: test: 6 new changesets&quot;)) {
 672                     assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 673                     assertTrue(email.body().contains(&quot;34567890: Even more fixes&quot;));
 674                     assertTrue(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
 675                     assertTrue(email.body().contains(&quot;56789012: Still even more fixes&quot;));
 676                     assertTrue(email.body().contains(&quot;67890123: Brand new fixes&quot;));
 677                     assertTrue(email.body().contains(&quot;78901234: More brand new fixes&quot;));
 678                     assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());
 679                 } else {
 680                     fail(&quot;Mismatched subject: &quot; + email.subject());
 681                 }
 682                 assertTrue(email.hasHeader(&quot;extra1&quot;));
 683                 assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
 684                 assertTrue(email.hasHeader(&quot;extra2&quot;));
 685                 assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
 686             }
 687         }
 688     }
 689 
<span class="line-added"> 690     @Test</span>
<span class="line-added"> 691     void testMailinglistPlainTags(TestInfo testInfo) throws IOException {</span>
<span class="line-added"> 692         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added"> 693              var tempFolder = new TemporaryDirectory();</span>
<span class="line-added"> 694              var listServer = new TestMailmanServer()) {</span>
<span class="line-added"> 695             var repo = credentials.getHostedRepository();</span>
<span class="line-added"> 696             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-added"> 697             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());</span>
<span class="line-added"> 698             credentials.commitLock(localRepo);</span>
<span class="line-added"> 699             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="line-added"> 700             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);</span>
<span class="line-added"> 701             localRepo.pushAll(repo.url());</span>
<span class="line-added"> 702 </span>
<span class="line-added"> 703             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="line-added"> 704             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);</span>
<span class="line-added"> 705             var mailmanList = mailmanServer.getList(listAddress.address());</span>
<span class="line-added"> 706             var tagStorage = createTagStorage(repo);</span>
<span class="line-added"> 707             var branchStorage = createBranchStorage(repo);</span>
<span class="line-added"> 708             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="line-added"> 709             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-added"> 710 </span>
<span class="line-added"> 711             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);</span>
<span class="line-added"> 712             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null,</span>
<span class="line-added"> 713                                                  false, true, false, false,</span>
<span class="line-added"> 714                                                  MailingListUpdater.Mode.ALL,</span>
<span class="line-added"> 715                                                  Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;),</span>
<span class="line-added"> 716                                                  Pattern.compile(&quot;.*&quot;));</span>
<span class="line-added"> 717             var prOnlyUpdater = new MailingListUpdater(mailmanList, listAddress, sender, null,</span>
<span class="line-added"> 718                                                        false, false, false, false,</span>
<span class="line-added"> 719                                                        MailingListUpdater.Mode.PR_ONLY, Map.of(), Pattern.compile(&quot;.*&quot;));</span>
<span class="line-added"> 720             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-added"> 721                                           prIssuesStorage, List.of(updater, prOnlyUpdater), List.of(), Set.of(), Map.of());</span>
<span class="line-added"> 722 </span>
<span class="line-added"> 723             // No mail should be sent on the first run as there is no history</span>
<span class="line-added"> 724             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added"> 725             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="line-added"> 726 </span>
<span class="line-added"> 727             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);</span>
<span class="line-added"> 728             localRepo.fetch(repo.url(), &quot;history:history&quot;);</span>
<span class="line-added"> 729             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);</span>
<span class="line-added"> 730             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);</span>
<span class="line-added"> 731             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);</span>
<span class="line-added"> 732             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);</span>
<span class="line-added"> 733             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);</span>
<span class="line-added"> 734             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);</span>
<span class="line-added"> 735             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);</span>
<span class="line-added"> 736             localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);</span>
<span class="line-added"> 737             localRepo.pushAll(repo.url());</span>
<span class="line-added"> 738 </span>
<span class="line-added"> 739             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added"> 740             listServer.processIncoming();</span>
<span class="line-added"> 741             listServer.processIncoming();</span>
<span class="line-added"> 742             listServer.processIncoming();</span>
<span class="line-added"> 743             listServer.processIncoming();</span>
<span class="line-added"> 744 </span>
<span class="line-added"> 745             var conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="line-added"> 746             assertEquals(4, conversations.size());</span>
<span class="line-added"> 747 </span>
<span class="line-added"> 748             for (var conversation : conversations) {</span>
<span class="line-added"> 749                 var email = conversation.first();</span>
<span class="line-added"> 750                 if (email.subject().equals(&quot;git: test: Added tag jdk-12+2 for changeset &quot; + editHash.abbreviate())) {</span>
<span class="line-added"> 751                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());</span>
<span class="line-added"> 752                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-12+4 for changeset &quot; + editHash2.abbreviate())) {</span>
<span class="line-added"> 753                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());</span>
<span class="line-added"> 754                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-13+0 for changeset &quot; + editHash3.abbreviate())) {</span>
<span class="line-added"> 755                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());</span>
<span class="line-added"> 756                 } else if (email.subject().equals(&quot;git: test: 6 new changesets&quot;)) {</span>
<span class="line-added"> 757                     assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());</span>
<span class="line-added"> 758                 } else {</span>
<span class="line-added"> 759                     fail(&quot;Mismatched subject: &quot; + email.subject());</span>
<span class="line-added"> 760                 }</span>
<span class="line-added"> 761                 assertTrue(email.hasHeader(&quot;extra1&quot;));</span>
<span class="line-added"> 762                 assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));</span>
<span class="line-added"> 763                 assertTrue(email.hasHeader(&quot;extra2&quot;));</span>
<span class="line-added"> 764                 assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));</span>
<span class="line-added"> 765             }</span>
<span class="line-added"> 766         }</span>
<span class="line-added"> 767     }</span>
<span class="line-added"> 768 </span>
 769     @Test
 770     void testMailingListBranch(TestInfo testInfo) throws IOException {
 771         try (var listServer = new TestMailmanServer();
 772              var credentials = new HostCredentials(testInfo);
 773              var tempFolder = new TemporaryDirectory()) {
 774             var repo = credentials.getHostedRepository();
 775             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 776             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 777             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 778             credentials.commitLock(localRepo);
 779             localRepo.pushAll(repo.url());
 780 
 781             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 782             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 783             var mailmanList = mailmanServer.getList(listAddress.address());
 784             var tagStorage = createTagStorage(repo);
 785             var branchStorage = createBranchStorage(repo);
 786             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 787             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 788 
 789             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
<span class="line-modified"> 790             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null,</span>
<span class="line-added"> 791                                                  false, false, true, false,</span>
<span class="line-added"> 792                                                  MailingListUpdater.Mode.ALL,</span>
 793                                                  Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;),
 794                                                  Pattern.compile(&quot;.*&quot;));
 795             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master|newbranch.&quot;), tagStorage, branchStorage,
 796                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 797 
 798             // No mail should be sent on the first run as there is no history
 799             TestBotRunner.runPeriodicItems(notifyBot);
 800             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 801 
 802             CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;12345678: Some fixes&quot;);
 803             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 804             localRepo.push(editHash, repo.url(), &quot;newbranch1&quot;);
 805             TestBotRunner.runPeriodicItems(notifyBot);
 806             listServer.processIncoming();
 807 
 808             var conversations = mailmanList.conversations(Duration.ofDays(1));
 809             var email = conversations.get(0).first();
 810             assertEquals(listAddress, email.sender());
 811             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());
 812             assertEquals(email.recipients(), List.of(listAddress));
</pre>
<hr />
<pre>
 840     void testMailingListNoIdempotence(TestInfo testInfo) throws IOException {
 841         try (var listServer = new TestMailmanServer();
 842              var credentials = new HostCredentials(testInfo);
 843              var tempFolder = new TemporaryDirectory()) {
 844             var repo = credentials.getHostedRepository();
 845             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 846             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 847             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 848             credentials.commitLock(localRepo);
 849             localRepo.pushAll(repo.url());
 850 
 851             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 852             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 853             var mailmanList = mailmanServer.getList(listAddress.address());
 854             var tagStorage = createTagStorage(repo);
 855             var branchStorage = createBranchStorage(repo);
 856             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 857             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 858 
 859             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
<span class="line-modified"> 860             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null,</span>
<span class="line-added"> 861                                                  false, false, false, false,</span>
<span class="line-added"> 862                                                  MailingListUpdater.Mode.ALL,</span>
 863                                                  Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;), Pattern.compile(&quot;none&quot;));
 864             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 865                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 866 
 867             // No mail should be sent on the first run as there is no history
 868             TestBotRunner.runPeriodicItems(notifyBot);
 869             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 870 
 871             // Save history state
 872             var historyHash = localRepo.fetch(repo.url(), &quot;history&quot;);
 873 
 874             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 875             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 876             TestBotRunner.runPeriodicItems(notifyBot);
 877             listServer.processIncoming();
 878 
 879             var conversations = mailmanList.conversations(Duration.ofDays(1));
 880             assertEquals(1, conversations.size());
 881 
 882             // Reset the history
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/notify/RepositoryUpdateConsumer.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>