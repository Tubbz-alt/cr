<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames vcs/src/test/java/org/openjdk/skara/vcs/RepositoryTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.vcs;
  24 
  25 import org.junit.jupiter.api.Assumptions;
  26 import org.openjdk.skara.test.TemporaryDirectory;
  27 
  28 import org.junit.jupiter.api.Test;
  29 import org.junit.jupiter.params.ParameterizedTest;
  30 import org.junit.jupiter.params.provider.EnumSource;
  31 
  32 import java.io.IOException;
  33 import java.net.URI;
  34 import java.nio.file.*;
  35 import java.nio.file.attribute.*;
  36 import java.util.*;
  37 import java.util.stream.Collectors;
  38 
  39 import static java.nio.file.StandardOpenOption.*;
  40 import static org.junit.jupiter.api.Assertions.*;
  41 import static org.junit.jupiter.api.Assumptions.assumeTrue;
  42 
  43 public class RepositoryTests {
  44 
  45     @ParameterizedTest
  46     @EnumSource(VCS.class)
  47     void testExistsOnMissingDirectory(VCS vcs) throws IOException {
  48         var d = Paths.get(&quot;/&quot;, &quot;this&quot;, &quot;path&quot;, &quot;does&quot;, &quot;not&quot;, &quot;exist&quot;);
  49         var r = Repository.get(d);
  50         assertTrue(r.isEmpty());
  51     }
  52 
  53     @ParameterizedTest
  54     @EnumSource(VCS.class)
  55     void testExistsOnEmptyDirectory(VCS vcs) throws IOException {
  56         try (var dir = new TemporaryDirectory()) {
  57             var r = Repository.get(dir.path());
  58             assertTrue(r.isEmpty());
  59         }
  60     }
  61 
  62     @ParameterizedTest
  63     @EnumSource(VCS.class)
  64     void testExistsOnInitializedRepository(VCS vcs) throws IOException {
  65         try (var dir = new TemporaryDirectory()) {
  66             var r = Repository.init(dir.path(), vcs);
  67             assertTrue(r.exists());
  68         }
  69     }
  70 
  71     @ParameterizedTest
  72     @EnumSource(VCS.class)
  73     void testExistsOnSubdir() throws IOException {
  74         try (var dir = new TemporaryDirectory()) {
  75             var r = Repository.init(dir.path(), VCS.GIT);
  76             assertTrue(r.exists());
  77 
  78             var subdir = Paths.get(dir.toString(), &quot;test&quot;);
  79             Files.createDirectories(subdir);
  80             var r2 = Repository.get(subdir);
  81             assertTrue(r2.get().exists());
  82         }
  83     }
  84 
  85     @ParameterizedTest
  86     @EnumSource(VCS.class)
  87     void testRootOnTopLevel() throws IOException {
  88         try (var dir = new TemporaryDirectory()) {
  89             var r = Repository.init(dir.path(), VCS.GIT);
  90             assertEquals(dir.toString(), r.root().toString());
  91         }
  92     }
  93 
  94     @ParameterizedTest
  95     @EnumSource(VCS.class)
  96     void testRootOnSubdirectory(VCS vcs) throws IOException {
  97         try (var dir = new TemporaryDirectory()) {
  98             var r = Repository.init(dir.path(), vcs);
  99             assertEquals(dir.toString(), r.root().toString());
 100 
 101             var subdir = Paths.get(dir.toString(), &quot;sub&quot;);
 102             Files.createDirectories(subdir);
 103 
 104             var r2 = Repository.get(subdir);
 105             assertEquals(dir.toString(), r2.get().root().toString());
 106         }
 107     }
 108 
 109     @ParameterizedTest
 110     @EnumSource(VCS.class)
 111     void testResolveOnEmptyRepository(VCS vcs) throws IOException {
 112         try (var dir = new TemporaryDirectory()) {
 113             var r = Repository.init(dir.path(), vcs);
 114             assertTrue(r.resolve(&quot;HEAD&quot;).isEmpty());
 115         }
 116     }
 117 
 118     @ParameterizedTest
 119     @EnumSource(VCS.class)
 120     void testResolveWithHEAD(VCS vcs) throws IOException {
 121         try (var dir = new TemporaryDirectory()) {
 122             var r = Repository.init(dir.path(), vcs);
 123 
 124             var readme = dir.path().resolve(&quot;README&quot;);
 125             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 126 
 127             r.add(readme);
 128             var head = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 129             assertEquals(head, r.head());
 130         }
 131     }
 132 
 133     @ParameterizedTest
 134     @EnumSource(VCS.class)
 135     void testConfig(VCS vcs) throws IOException {
 136         try (var dir = new TemporaryDirectory()) {
 137             var r = Repository.init(dir.path(), vcs);
 138 
 139             if (vcs == VCS.GIT) {
 140                 var config = dir.path().resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 141                 Files.write(config, List.of(&quot;[user]&quot;, &quot;name = duke&quot;), WRITE, APPEND);
 142                 assertEquals(List.of(&quot;duke&quot;), r.config(&quot;user.name&quot;));
 143             } else if (vcs == VCS.HG) {
 144                 var config = dir.path().resolve(&quot;.hg&quot;).resolve(&quot;hgrc&quot;);
 145                 Files.write(config, List.of(&quot;[ui]&quot;, &quot;username = duke&quot;), WRITE, CREATE);
 146                 assertEquals(List.of(&quot;duke&quot;), r.config(&quot;ui.username&quot;));
 147             }
 148 
 149             assertEquals(&quot;duke&quot;, r.username().get());
 150         }
 151     }
 152 
 153     @ParameterizedTest
 154     @EnumSource(VCS.class)
 155     void testCurrentBranchOnEmptyRepository(VCS vcs) throws IOException {
 156         try (var dir = new TemporaryDirectory()) {
 157             var r = Repository.init(dir.path(), vcs);
 158             assertEquals(r.defaultBranch(), r.currentBranch());
 159         }
 160     }
 161 
 162     @ParameterizedTest
 163     @EnumSource(VCS.class)
 164     void testCheckout(VCS vcs) throws IOException {
 165         try (var dir = new TemporaryDirectory()) {
 166             var r = Repository.init(dir.path(), vcs);
 167 
 168             var readme = dir.path().resolve(&quot;README&quot;);
 169             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 170             r.add(readme);
 171 
 172             var head1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 173             assertEquals(head1, r.head());
 174 
 175             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 176             r.add(readme);
 177 
 178             var head2 = r.commit(&quot;Add one more line&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 179             assertEquals(head2, r.head());
 180 
 181             r.checkout(head1, false);
 182             assertEquals(head1, r.head());
 183 
 184             r.checkout(head2, false);
 185             assertEquals(head2, r.head());
 186         }
 187     }
 188 
 189     @ParameterizedTest
 190     @EnumSource(VCS.class)
 191     void testLines(VCS vcs) throws IOException {
 192         try (var dir = new TemporaryDirectory()) {
 193             var r = Repository.init(dir.path(), vcs);
 194 
 195             var readme = dir.path().resolve(&quot;README&quot;);
 196             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 197             r.add(readme);
 198 
 199             var head1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 200             assertEquals(List.of(&quot;Hello, readme!&quot;),
 201                          r.lines(readme, head1).orElseThrow());
 202 
 203             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 204             r.add(readme);
 205 
 206             var head2 = r.commit(&quot;Add one more line&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 207             assertEquals(List.of(&quot;Hello, readme!&quot;, &quot;Another line&quot;),
 208                          r.lines(readme, head2).orElseThrow());
 209         }
 210     }
 211 
 212     @ParameterizedTest
 213     @EnumSource(VCS.class)
 214     void testLinesInSubdir(VCS vcs) throws IOException {
 215         try (var dir = new TemporaryDirectory()) {
 216             Repository.init(dir.path(), vcs);
 217 
 218             var subdir = dir.path().resolve(&quot;sub&quot;);
 219             Files.createDirectories(subdir);
 220             var r = Repository.get(subdir).get();
 221 
 222             var readme = subdir.getParent().resolve(&quot;README&quot;);
 223             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 224             r.add(readme);
 225 
 226             var head = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 227             assertEquals(List.of(&quot;Hello, readme!&quot;),
 228                          r.lines(readme, head).orElseThrow());
 229 
 230             var example = subdir.resolve(&quot;EXAMPLE&quot;);
 231             Files.write(example, List.of(&quot;An example&quot;));
 232             r.add(example);
 233 
 234             var head2 = r.commit(&quot;Add EXAMPLE&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 235             assertEquals(List.of(&quot;An example&quot;),
 236                          r.lines(example, head2).orElseThrow());
 237         }
 238     }
 239 
 240     @ParameterizedTest
 241     @EnumSource(VCS.class)
 242     void testCommitListingOnEmptyRepo(VCS vcs) throws IOException {
 243         try (var dir = new TemporaryDirectory()) {
 244             var r = Repository.init(dir.path(), vcs);
 245             assertTrue(r.commits().asList().isEmpty());
 246         }
 247     }
 248 
 249     @ParameterizedTest
 250     @EnumSource(VCS.class)
 251     void testCommitListingWithSingleCommit(VCS vcs) throws IOException {
 252         try (var dir = new TemporaryDirectory()) {
 253             var r = Repository.init(dir.path(), vcs);
 254 
 255             var readme = dir.path().resolve(&quot;README&quot;);
 256             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 257 
 258             r.add(readme);
 259 
 260             var committerName = vcs == VCS.GIT ? &quot;bot&quot; : &quot;duke&quot;;
 261             var committerEmail = vcs == VCS.GIT ? &quot;bot@openjdk.java.net&quot; : &quot;duke@openjdk.java.net&quot;;
 262             var hash = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;, committerName, committerEmail);
 263 
 264             var commits = r.commits().asList();
 265             assertEquals(1, commits.size());
 266 
 267             var commit = commits.get(0);
 268             assertEquals(&quot;duke&quot;, commit.author().name());
 269             assertEquals(&quot;duke@openjdk.java.net&quot;, commit.author().email());
 270             assertEquals(committerName, commit.committer().name());
 271             assertEquals(committerEmail, commit.committer().email());
 272 
 273             assertEquals(List.of(&quot;Add README&quot;), commit.message());
 274 
 275             assertEquals(1, commit.numParents());
 276             assertEquals(1, commit.parents().size());
 277 
 278             var nullHash = &quot;0&quot;.repeat(40);
 279             var parent = commit.parents().get(0);
 280             assertEquals(nullHash, parent.hex());
 281 
 282             assertTrue(commit.isInitialCommit());
 283             assertFalse(commit.isMerge());
 284             assertEquals(hash, commit.hash());
 285 
 286             var diffs = commit.parentDiffs();
 287             assertEquals(1, diffs.size());
 288 
 289             var diff = diffs.get(0);
 290             assertEquals(nullHash, diff.from().hex());
 291             assertEquals(hash, diff.to());
 292 
 293             assertEquals(0, diff.removed());
 294             assertEquals(0, diff.modified());
 295             assertEquals(1, diff.added());
 296 
 297             var patches = diff.patches();
 298             assertEquals(1, patches.size());
 299 
 300             var patch = patches.get(0).asTextualPatch();
 301             assertTrue(patch.status().isAdded());
 302 
 303             assertTrue(patch.source().path().isEmpty());
 304             assertTrue(patch.source().type().isEmpty());
 305 
 306             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 307             assertTrue(patch.target().type().get().isRegularNonExecutable());
 308 
 309             var hunks = patch.hunks();
 310             assertEquals(1, hunks.size());
 311 
 312             var hunk = hunks.get(0);
 313             assertEquals(new Range(0, 0), hunk.source().range());
 314             assertEquals(new Range(1, 1), hunk.target().range());
 315 
 316             assertLinesEquals(List.of(), hunk.source().lines());
 317             assertLinesEquals(List.of(&quot;Hello, readme!&quot;), hunk.target().lines());
 318         }
 319     }
 320 
 321     static String stripTrailingCR(String line) {
 322         return line.endsWith(&quot;\r&quot;) ? line.substring(0, line.length() - 1) : line;
 323     }
 324 
 325     static void assertLinesEquals(List&lt;String&gt; expected, List&lt;String&gt; actual) {
 326         assertEquals(expected, actual.stream().map(RepositoryTests::stripTrailingCR).collect(Collectors.toList()));
 327     }
 328 
 329     @ParameterizedTest
 330     @EnumSource(VCS.class)
 331     void testCommitListingWithMultipleCommits(VCS vcs) throws IOException {
 332         try (var dir = new TemporaryDirectory()) {
 333             var r = Repository.init(dir.path(), vcs);
 334 
 335             var readme = dir.path().resolve(&quot;README&quot;);
 336             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 337 
 338             r.add(readme);
 339             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 340 
 341             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 342             r.add(readme);
 343             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 344 
 345             var commits = r.commits().asList();
 346             assertEquals(2, commits.size());
 347 
 348             var commit = commits.get(0);
 349             assertEquals(&quot;duke&quot;, commit.author().name());
 350             assertEquals(&quot;duke@openjdk.java.net&quot;, commit.author().email());
 351 
 352             assertEquals(List.of(&quot;Modify README&quot;), commit.message());
 353 
 354             assertEquals(1, commit.numParents());
 355             assertEquals(1, commit.parents().size());
 356 
 357             var parent = commit.parents().get(0);
 358             assertEquals(hash1, parent);
 359 
 360             assertFalse(commit.isInitialCommit());
 361             assertFalse(commit.isMerge());
 362             assertEquals(hash2, commit.hash());
 363 
 364             var diffs = commit.parentDiffs();
 365             assertEquals(1, diffs.size());
 366 
 367             var diff = diffs.get(0);
 368             assertEquals(hash1, diff.from());
 369             assertEquals(hash2, diff.to());
 370 
 371             assertEquals(0, diff.removed());
 372             assertEquals(0, diff.modified());
 373             assertEquals(1, diff.added());
 374 
 375             var patches = diff.patches();
 376             assertEquals(1, patches.size());
 377 
 378             var patch = patches.get(0).asTextualPatch();
 379             assertTrue(patch.status().isModified());
 380             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 381             assertTrue(patch.source().type().get().isRegularNonExecutable());
 382             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 383             assertTrue(patch.target().type().get().isRegularNonExecutable());
 384 
 385             var hunks = patch.hunks();
 386             assertEquals(1, hunks.size());
 387 
 388             var hunk = hunks.get(0);
 389             assertEquals(new Range(2, 0), hunk.source().range());
 390             assertEquals(new Range(2, 1), hunk.target().range());
 391 
 392             assertLinesEquals(List.of(), hunk.source().lines());
 393             assertLinesEquals(List.of(&quot;Another line&quot;), hunk.target().lines());
 394         }
 395     }
 396 
 397     @ParameterizedTest
 398     @EnumSource(VCS.class)
 399     void testSquashDeletes(VCS vcs) throws IOException {
 400         try (var dir = new TemporaryDirectory()) {
 401             var r = Repository.init(dir.path(), vcs);
 402 
 403             var file1 = dir.path().resolve(&quot;file1.txt&quot;);
 404             Files.write(file1, List.of(&quot;Hello, file 1!&quot;));
 405             var file2 = dir.path().resolve(&quot;file2.txt&quot;);
 406             Files.write(file2, List.of(&quot;Hello, file 2!&quot;));
 407             var file3 = dir.path().resolve(&quot;file3.txt&quot;);
 408             Files.write(file3, List.of(&quot;Hello, file 3!&quot;));
 409 
 410             r.add(file1, file2, file3);
 411             var hash1 = r.commit(&quot;Add files&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 412 
 413             Files.delete(file2);
 414             r.remove(file2);
 415             var hash2 = r.commit(&quot;Remove file 2&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 416 
 417             Files.delete(file3);
 418             r.remove(file3);
 419             var hash3 = r.commit(&quot;Remove file 3&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 420 
 421             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 422             assertEquals(3, r.commits(refspec).asList().size());
 423 
 424             r.checkout(hash1, false);
 425             r.squash(hash3);
 426             r.commit(&quot;Squashed remove of file 2 and 3&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 427 
 428             refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 429             var commits = r.commits(refspec).asList();
 430             assertEquals(2, commits.size());
 431 
 432             assertEquals(hash1, commits.get(1).hash());
 433 
 434             var head = commits.get(0);
 435             assertNotEquals(hash2, head);
 436             assertNotEquals(hash3, head);
 437 
 438             assertEquals(hash1, head.parents().get(0));
 439             assertFalse(head.isInitialCommit());
 440             assertFalse(head.isMerge());
 441 
 442             var diffs = head.parentDiffs();
 443             assertEquals(1, diffs.size());
 444 
 445             var diff = diffs.get(0);
 446             assertEquals(hash1, diff.from());
 447             assertEquals(head.hash(), diff.to());
 448 
 449             assertEquals(2, diff.removed());
 450             assertEquals(0, diff.modified());
 451             assertEquals(0, diff.added());
 452         }
 453     }
 454 
 455     @ParameterizedTest
 456     @EnumSource(VCS.class)
 457     void testSquash(VCS vcs) throws IOException {
 458         try (var dir = new TemporaryDirectory()) {
 459             var r = Repository.init(dir.path(), vcs);
 460 
 461             var readme = dir.path().resolve(&quot;README&quot;);
 462             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 463 
 464             r.add(readme);
 465             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 466 
 467             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 468             r.add(readme);
 469             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 470 
 471             Files.write(readme, List.of(&quot;A final line&quot;), WRITE, APPEND);
 472             r.add(readme);
 473             var hash3 = r.commit(&quot;Modify README again&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 474 
 475             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 476             assertEquals(3, r.commits(refspec).asList().size());
 477 
 478             r.checkout(hash1, false);
 479             r.squash(hash3);
 480             r.commit(&quot;Squashed commits 2 and 3&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 481 
 482             refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 483             var commits = r.commits(refspec).asList();
 484             assertEquals(2, commits.size());
 485 
 486             assertEquals(hash1, commits.get(1).hash());
 487 
 488             var head = commits.get(0);
 489             assertNotEquals(hash2, head);
 490             assertNotEquals(hash3, head);
 491 
 492             assertEquals(hash1, head.parents().get(0));
 493             assertFalse(head.isInitialCommit());
 494             assertFalse(head.isMerge());
 495 
 496             var diffs = head.parentDiffs();
 497             assertEquals(1, diffs.size());
 498 
 499             var diff = diffs.get(0);
 500             assertEquals(hash1, diff.from());
 501             assertEquals(head.hash(), diff.to());
 502 
 503             assertEquals(0, diff.removed());
 504             assertEquals(0, diff.modified());
 505             assertEquals(2, diff.added());
 506 
 507             var patches = diff.patches();
 508             assertEquals(1, patches.size());
 509 
 510             var patch = patches.get(0).asTextualPatch();
 511             assertTrue(patch.status().isModified());
 512             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 513             assertTrue(patch.source().type().get().isRegularNonExecutable());
 514             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 515             assertTrue(patch.target().type().get().isRegularNonExecutable());
 516 
 517             var hunks = patch.hunks();
 518             assertEquals(1, hunks.size());
 519 
 520             var hunk = hunks.get(0);
 521             assertEquals(new Range(2, 0), hunk.source().range());
 522             assertEquals(new Range(2, 2), hunk.target().range());
 523 
 524             assertLinesEquals(List.of(), hunk.source().lines());
 525             assertLinesEquals(List.of(&quot;Another line&quot;, &quot;A final line&quot;), hunk.target().lines());
 526         }
 527     }
 528 
 529     @ParameterizedTest
 530     @EnumSource(VCS.class)
 531     void testMergeBase(VCS vcs) throws IOException {
 532         try (var dir = new TemporaryDirectory()) {
 533             var r = Repository.init(dir.path(), vcs);
 534 
 535             var readme = dir.path().resolve(&quot;README&quot;);
 536             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 537 
 538             r.add(readme);
 539             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 540 
 541             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 542             r.add(readme);
 543             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 544 
 545             r.checkout(hash1, false);
 546             Files.write(readme, List.of(&quot;A conflicting line&quot;), WRITE, APPEND);
 547             r.add(readme);
 548             var hash3 = r.commit(&quot;Branching README modification&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 549 
 550             assertEquals(hash1, r.mergeBase(hash2, hash3));
 551         }
 552     }
 553 
 554     @ParameterizedTest
 555     @EnumSource(VCS.class)
 556     void testRebase(VCS vcs) throws IOException {
 557         try (var dir = new TemporaryDirectory()) {
 558             var r = Repository.init(dir.path(), vcs);
 559 
 560             var readme = dir.path().resolve(&quot;README&quot;);
 561             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 562 
 563             r.add(readme);
 564             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 565 
 566             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 567             r.add(readme);
 568             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 569 
 570             r.checkout(hash1, false);
 571 
 572             var contributing = dir.path().resolve(&quot;CONTRIBUTING&quot;);
 573             Files.write(contributing, List.of(&quot;Keep the patches coming&quot;));
 574             r.add(contributing);
 575             var hash3 = r.commit(&quot;Add independent change&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 576 
 577             var committerName = vcs == VCS.GIT ? &quot;bot&quot; : &quot;duke&quot;;
 578             var committerEmail = vcs == VCS.GIT ? &quot;bot@openjdk.java.net&quot; : &quot;duke@openjdk.java.net&quot;;
 579             r.rebase(hash2, committerName, committerEmail);
 580 
 581             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 582             var commits = r.commits(refspec).asList();
 583             assertEquals(3, commits.size());
 584             assertEquals(hash2, commits.get(1).hash());
 585             assertEquals(hash1, commits.get(2).hash());
 586 
 587             assertEquals(&quot;duke&quot;, commits.get(0).author().name());
 588             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(0).author().email());
 589             assertEquals(committerName, commits.get(0).committer().name());
 590             assertEquals(committerEmail, commits.get(0).committer().email());
 591 
 592             assertEquals(&quot;duke&quot;, commits.get(1).author().name());
 593             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(1).author().email());
 594             assertEquals(&quot;duke&quot;, commits.get(1).committer().name());
 595             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(1).committer().email());
 596 
 597             assertEquals(&quot;duke&quot;, commits.get(2).author().name());
 598             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(2).author().email());
 599             assertEquals(&quot;duke&quot;, commits.get(2).committer().name());
 600             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(2).committer().email());
 601 
 602             var head = commits.get(0);
 603             assertEquals(hash2, head.parents().get(0));
 604             assertEquals(List.of(&quot;Add independent change&quot;), head.message());
 605 
 606             var diffs = head.parentDiffs();
 607             assertEquals(1, diffs.size());
 608             var diff = diffs.get(0);
 609 
 610             assertEquals(0, diff.removed());
 611             assertEquals(0, diff.modified());
 612             assertEquals(1, diff.added());
 613 
 614             var patches = diff.patches();
 615             assertEquals(1, patches.size());
 616             var patch = patches.get(0).asTextualPatch();
 617             assertEquals(Path.of(&quot;CONTRIBUTING&quot;), patch.target().path().get());
 618 
 619             var hunks = patch.hunks();
 620             assertEquals(1, hunks.size());
 621             var hunk = hunks.get(0);
 622             assertLinesEquals(List.of(&quot;Keep the patches coming&quot;), hunk.target().lines());
 623         }
 624     }
 625 
 626     @ParameterizedTest
 627     @EnumSource(VCS.class)
 628     void testInitializedRepositoryIsEmpty(VCS vcs) throws IOException {
 629         try (var dir = new TemporaryDirectory()) {
 630             var r = Repository.init(dir.path(), vcs);
 631             assertTrue(r.isEmpty());
 632         }
 633     }
 634 
 635     @ParameterizedTest
 636     @EnumSource(VCS.class)
 637     void testRepositoryWithCommitIsNonEmpty(VCS vcs) throws IOException {
 638         try (var dir = new TemporaryDirectory()) {
 639             var r = Repository.init(dir.path(), vcs);
 640 
 641             var readme = dir.path().resolve(&quot;README&quot;);
 642             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 643 
 644             r.add(readme);
 645             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 646 
 647             assertFalse(r.isEmpty());
 648         }
 649     }
 650 
 651     @ParameterizedTest
 652     @EnumSource(VCS.class)
 653     void testEmptyRepositoryIsHealthy(VCS vcs) throws IOException {
 654         try (var dir = new TemporaryDirectory()) {
 655             var r = Repository.init(dir.path(), vcs);
 656             assertTrue(r.isHealthy());
 657         }
 658     }
 659 
 660     @ParameterizedTest
 661     @EnumSource(VCS.class)
 662     void testNonEmptyRepositoryIsHealthy(VCS vcs) throws IOException {
 663         try (var dir = new TemporaryDirectory()) {
 664             var r = Repository.init(dir.path(), vcs);
 665 
 666             var readme = dir.path().resolve(&quot;README&quot;);
 667             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 668 
 669             r.add(readme);
 670             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 671 
 672             assertTrue(r.isHealthy());
 673         }
 674     }
 675 
 676     @ParameterizedTest
 677     @EnumSource(VCS.class)
 678     void testNonCheckedOutRepositoryIsHealthy(VCS vcs) throws IOException {
 679         try (var dir1 = new TemporaryDirectory();
 680              var dir2 = new TemporaryDirectory()) {
 681             var r1 = Repository.init(dir1.path(), vcs);
 682 
 683             var readme = dir1.path().resolve(&quot;README&quot;);
 684             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 685 
 686             r1.add(readme);
 687             var hash = r1.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 688             r1.tag(hash, &quot;tag&quot;, &quot;tagging&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 689 
 690             var r2 = Repository.init(dir2.path(), vcs);
 691             r2.fetch(r1.root().toUri(), r1.defaultBranch().name());
 692 
 693             assertTrue(r2.isHealthy());
 694         }
 695     }
 696 
 697     @ParameterizedTest
 698     @EnumSource(VCS.class)
 699     void testBranchesOnEmptyRepository(VCS vcs) throws IOException {
 700         try (var dir = new TemporaryDirectory()) {
 701             var r = Repository.init(dir.path(), vcs);
 702             var expected = vcs == VCS.GIT ? List.of() : List.of(new Branch(&quot;default&quot;));
 703             assertEquals(List.of(), r.branches());
 704         }
 705     }
 706 
 707     @ParameterizedTest
 708     @EnumSource(VCS.class)
 709     void testBranchesOnNonEmptyRepository(VCS vcs) throws IOException {
 710         try (var dir = new TemporaryDirectory()) {
 711             var r = Repository.init(dir.path(), vcs);
 712 
 713             var readme = dir.path().resolve(&quot;README&quot;);
 714             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 715 
 716             r.add(readme);
 717             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 718 
 719             assertEquals(List.of(r.defaultBranch()), r.branches());
 720         }
 721     }
 722 
 723     @ParameterizedTest
 724     @EnumSource(VCS.class)
 725     void testTagsOnEmptyRepository(VCS vcs) throws IOException {
 726         try (var dir = new TemporaryDirectory()) {
 727             var r = Repository.init(dir.path(), vcs);
 728             var expected = vcs == VCS.GIT ? List.of() : List.of(new Tag(&quot;tip&quot;));
 729             assertEquals(expected, r.tags());
 730         }
 731     }
 732 
 733     @ParameterizedTest
 734     @EnumSource(VCS.class)
 735     void testTagsOnNonEmptyRepository(VCS vcs) throws IOException {
 736         try (var dir = new TemporaryDirectory()) {
 737             var r = Repository.init(dir.path(), vcs);
 738 
 739             var readme = dir.path().resolve(&quot;README&quot;);
 740             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 741 
 742             r.add(readme);
 743             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 744 
 745             var expected = vcs == VCS.GIT ? List.of() : List.of(new Tag(&quot;tip&quot;));
 746             assertEquals(expected, r.tags());
 747         }
 748     }
 749 
 750     @ParameterizedTest
 751     @EnumSource(VCS.class)
 752     void testFetchAndPush(VCS vcs) throws IOException {
 753         try (var dir = new TemporaryDirectory()) {
 754             var upstream = Repository.init(dir.path(), vcs);
 755 
 756             if (vcs == VCS.GIT) {
 757                 Files.write(upstream.root().resolve(&quot;.git&quot;).resolve(&quot;config&quot;),
 758                             List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch=ignore&quot;),
 759                             WRITE, APPEND);
 760             }
 761 
 762             var readme = dir.path().resolve(&quot;README&quot;);
 763             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 764 
 765             upstream.add(readme);
 766             upstream.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 767 
 768             try (var dir2 = new TemporaryDirectory()) {
 769                 var downstream = Repository.init(dir2.path(), vcs);
 770 
 771                  // note: forcing unix path separators for URI
 772                 var upstreamURI = URI.create(&quot;file:///&quot; + dir.toString().replace(&#39;\\&#39;, &#39;/&#39;));
 773 
 774                 var fetchHead = downstream.fetch(upstreamURI, downstream.defaultBranch().name());
 775                 downstream.checkout(fetchHead, false);
 776 
 777                 var downstreamReadme = dir2.path().resolve(&quot;README&quot;);
 778                 Files.write(downstreamReadme, List.of(&quot;Downstream change&quot;), WRITE, APPEND);
 779 
 780                 downstream.add(downstreamReadme);
 781                 var head = downstream.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 782 
 783                 downstream.push(head, upstreamURI, downstream.defaultBranch().name());
 784             }
 785 
 786             upstream.checkout(upstream.resolve(upstream.defaultBranch().name()).get(), false);
 787 
 788             var commits = upstream.commits().asList();
 789             assertEquals(2, commits.size());
 790         }
 791     }
 792 
 793     @ParameterizedTest
 794     @EnumSource(VCS.class)
 795     void testClean(VCS vcs) throws IOException {
 796         try (var dir = new TemporaryDirectory()) {
 797             var r = Repository.init(dir.path(), vcs);
 798             r.clean();
 799 
 800             var readme = dir.path().resolve(&quot;README&quot;);
 801             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 802 
 803             r.add(readme);
 804             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 805 
 806             r.clean();
 807 
 808             assertEquals(hash1, r.head());
 809 
 810             Files.write(readme, List.of(&quot;A random change&quot;), WRITE, APPEND);
 811 
 812             r.clean();
 813 
 814             assertEquals(List.of(&quot;Hello, readme!&quot;), Files.readAllLines(readme));
 815 
 816             var untracked = dir.path().resolve(&quot;UNTRACKED&quot;);
 817             Files.write(untracked, List.of(&quot;Random text&quot;));
 818 
 819             r.clean();
 820 
 821             assertFalse(Files.exists(untracked));
 822 
 823             // Mercurial cannot currently deal with this situation
 824             if (vcs != VCS.HG) {
 825                 var subRepo = Repository.init(dir.path().resolve(&quot;submodule&quot;), vcs);
 826                 var subRepoFile = subRepo.root().resolve(&quot;file.txt&quot;);
 827                 Files.write(subRepoFile, List.of(&quot;Looks like a file in a submodule&quot;));
 828 
 829                 r.clean();
 830 
 831                 assertFalse(Files.exists(subRepoFile));
 832             }
 833         }
 834     }
 835 
 836     @ParameterizedTest
 837     @EnumSource(VCS.class)
 838     void testCleanIgnored(VCS vcs) throws IOException {
 839         try (var dir = new TemporaryDirectory()) {
 840             var r = Repository.init(dir.path(), vcs);
 841             r.clean();
 842 
 843             var readme = dir.path().resolve(&quot;README&quot;);
 844             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 845             Files.write(dir.path().resolve(&quot;.gitignore&quot;), List.of(&quot;*.txt&quot;));
 846             Files.write(dir.path().resolve(&quot;.hgignore&quot;), List.of(&quot;.*txt&quot;));
 847 
 848             r.add(readme);
 849             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 850 
 851             var ignored = dir.path().resolve(&quot;ignored.txt&quot;);
 852             Files.write(ignored, List.of(&quot;Random text&quot;));
 853 
 854             r.clean();
 855 
 856             assertFalse(Files.exists(ignored));
 857         }
 858     }
 859 
 860     @ParameterizedTest
 861     @EnumSource(VCS.class)
 862     void testDiffBetweenCommits(VCS vcs) throws IOException {
 863         try (var dir = new TemporaryDirectory()) {
 864             var r = Repository.init(dir.path(), vcs);
 865 
 866             var readme = dir.path().resolve(&quot;README&quot;);
 867             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 868 
 869             r.add(readme);
 870             var first = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 871 
 872             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
 873             r.add(readme);
 874             var second = r.commit(&quot;Add one more line&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 875 
 876             var diff = r.diff(first, second);
 877             assertEquals(first, diff.from());
 878             assertEquals(second, diff.to());
 879 
 880             var patches = diff.patches();
 881             assertEquals(1, patches.size());
 882 
 883             var patch = patches.get(0).asTextualPatch();
 884             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 885             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 886             assertTrue(patch.source().type().get().isRegularNonExecutable());
 887             assertTrue(patch.target().type().get().isRegularNonExecutable());
 888             assertTrue(patch.status().isModified());
 889 
 890             var hunks = patch.hunks();
 891             assertEquals(1, hunks.size());
 892 
 893             var hunk = hunks.get(0);
 894             assertEquals(2, hunk.source().range().start());
 895             assertEquals(0, hunk.source().range().count());
 896             assertEquals(0, hunk.source().lines().size());
 897 
 898             assertEquals(2, hunk.target().range().start());
 899             assertEquals(1, hunk.target().range().count());
 900             assertLinesEquals(List.of(&quot;One more line&quot;), hunk.target().lines());
 901 
 902             assertEquals(1, hunk.added());
 903             assertEquals(0, hunk.removed());
 904             assertEquals(0, hunk.modified());
 905         }
 906     }
 907 
 908     @ParameterizedTest
 909     @EnumSource(VCS.class)
 910     void testDiffBetweenCommitsWithMultiplePatches(VCS vcs) throws IOException {
 911         try (var dir = new TemporaryDirectory()) {
 912             var r = Repository.init(dir.path(), vcs);
 913 
 914             var readme = dir.path().resolve(&quot;README&quot;);
 915             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 916 
 917             var building = dir.path().resolve(&quot;BUILDING&quot;);
 918             Files.write(building, List.of(&quot;make&quot;));
 919 
 920             r.add(readme);
 921             r.add(building);
 922             var first = r.commit(&quot;Add README and BUILDING&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 923 
 924             Files.write(readme, List.of(&quot;Hello, Skara!&quot;), WRITE, TRUNCATE_EXISTING);
 925             Files.write(building, List.of(&quot;make images&quot;), WRITE, TRUNCATE_EXISTING);
 926             r.add(readme);
 927             r.add(building);
 928             var second = r.commit(&quot;Modify README and BUILDING&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 929 
 930             var diff = r.diff(first, second);
 931             assertEquals(first, diff.from());
 932             assertEquals(second, diff.to());
 933 
 934             var patches = diff.patches();
 935             assertEquals(2, patches.size());
 936 
 937             var patch1 = patches.get(0).asTextualPatch();
 938             assertEquals(Path.of(&quot;BUILDING&quot;), patch1.source().path().get());
 939             assertEquals(Path.of(&quot;BUILDING&quot;), patch1.target().path().get());
 940             assertTrue(patch1.source().type().get().isRegularNonExecutable());
 941             assertTrue(patch1.target().type().get().isRegularNonExecutable());
 942             assertTrue(patch1.status().isModified());
 943 
 944             var hunks1 = patch1.hunks();
 945             assertEquals(1, hunks1.size());
 946 
 947             var hunk1 = hunks1.get(0);
 948             assertEquals(1, hunk1.source().range().start());
 949             assertEquals(1, hunk1.source().range().count());
 950             assertLinesEquals(List.of(&quot;make&quot;), hunk1.source().lines());
 951 
 952             assertEquals(1, hunk1.target().range().start());
 953             assertEquals(1, hunk1.target().range().count());
 954             assertLinesEquals(List.of(&quot;make images&quot;), hunk1.target().lines());
 955 
 956             var patch2 = patches.get(1).asTextualPatch();
 957             assertEquals(Path.of(&quot;README&quot;), patch2.source().path().get());
 958             assertEquals(Path.of(&quot;README&quot;), patch2.target().path().get());
 959             assertTrue(patch2.source().type().get().isRegularNonExecutable());
 960             assertTrue(patch2.target().type().get().isRegularNonExecutable());
 961             assertTrue(patch2.status().isModified());
 962 
 963             var hunks2 = patch2.hunks();
 964             assertEquals(1, hunks2.size());
 965 
 966             var hunk2 = hunks2.get(0);
 967             assertEquals(1, hunk2.source().range().start());
 968             assertEquals(1, hunk2.source().range().count());
 969             assertLinesEquals(List.of(&quot;Hello, readme!&quot;), hunk2.source().lines());
 970 
 971             assertEquals(1, hunk2.target().range().start());
 972             assertEquals(1, hunk2.target().range().count());
 973             assertLinesEquals(List.of(&quot;Hello, Skara!&quot;), hunk2.target().lines());
 974         }
 975     }
 976 
 977     @ParameterizedTest
 978     @EnumSource(VCS.class)
 979     void testDiffBetweenCommitsWithMultipleHunks(VCS vcs) throws IOException {
 980         try (var dir = new TemporaryDirectory()) {
 981             var r = Repository.init(dir.path(), vcs);
 982 
 983             var abc = dir.path().resolve(&quot;abc.txt&quot;);
 984             Files.write(abc, List.of(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;));
 985 
 986             r.add(abc);
 987             var first = r.commit(&quot;Added ABC&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 988 
 989             Files.write(abc, List.of(&quot;1&quot;, &quot;2&quot;, &quot;B&quot;, &quot;3&quot;), WRITE, TRUNCATE_EXISTING);
 990             r.add(abc);
 991             var second = r.commit(&quot;Modify A and C&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 992 
 993             var diff = r.diff(first, second);
 994             assertEquals(first, diff.from());
 995             assertEquals(second, diff.to());
 996 
 997             var patches = diff.patches();
 998             assertEquals(1, patches.size());
 999 
1000             var patch = patches.get(0).asTextualPatch();
1001             assertEquals(Path.of(&quot;abc.txt&quot;), patch.source().path().get());
1002             assertEquals(Path.of(&quot;abc.txt&quot;), patch.target().path().get());
1003             assertTrue(patch.source().type().get().isRegularNonExecutable());
1004             assertTrue(patch.target().type().get().isRegularNonExecutable());
1005             assertTrue(patch.status().isModified());
1006 
1007             var hunks = patch.hunks();
1008             assertEquals(2, hunks.size());
1009 
1010             var hunk1 = hunks.get(0);
1011             assertEquals(1, hunk1.source().range().start());
1012             assertEquals(1, hunk1.source().range().count());
1013             assertLinesEquals(List.of(&quot;A&quot;), hunk1.source().lines());
1014 
1015             assertEquals(1, hunk1.target().range().start());
1016             assertEquals(2, hunk1.target().range().count());
1017             assertLinesEquals(List.of(&quot;1&quot;, &quot;2&quot;), hunk1.target().lines());
1018 
1019             assertEquals(1, hunk1.added());
1020             assertEquals(0, hunk1.removed());
1021             assertEquals(1, hunk1.modified());
1022 
1023             var hunk2 = hunks.get(1);
1024             assertEquals(3, hunk2.source().range().start());
1025             assertEquals(1, hunk2.source().range().count());
1026             assertLinesEquals(List.of(&quot;C&quot;), hunk2.source().lines());
1027 
1028             assertEquals(4, hunk2.target().range().start());
1029             assertEquals(1, hunk2.target().range().count());
1030             assertLinesEquals(List.of(&quot;3&quot;), hunk2.target().lines());
1031 
1032             assertEquals(0, hunk2.added());
1033             assertEquals(0, hunk2.removed());
1034             assertEquals(1, hunk2.modified());
1035         }
1036     }
1037 
1038     @ParameterizedTest
1039     @EnumSource(VCS.class)
1040     void testDiffWithRemoval(VCS vcs) throws IOException {
1041         try (var dir = new TemporaryDirectory()) {
1042             var r = Repository.init(dir.path(), vcs);
1043 
1044             var readme = dir.path().resolve(&quot;README&quot;);
1045             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1046 
1047             r.add(readme);
1048             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1049 
1050             Files.delete(readme);
1051             r.remove(readme);
1052             var second = r.commit(&quot;Removed README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1053 
1054             var diff = r.diff(first, second);
1055             assertEquals(first, diff.from());
1056             assertEquals(second, diff.to());
1057 
1058             var patches = diff.patches();
1059             assertEquals(1, patches.size());
1060 
1061             var patch = patches.get(0).asTextualPatch();
1062             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
1063             assertTrue(patch.target().path().isEmpty());
1064             assertTrue(patch.source().type().get().isRegularNonExecutable());
1065             assertTrue(patch.target().type().isEmpty());
1066             assertTrue(patch.status().isDeleted());
1067 
1068             var hunks = patch.hunks();
1069             assertEquals(1, hunks.size());
1070 
1071             var hunk = hunks.get(0);
1072             assertEquals(1, hunk.source().range().start());
1073             assertEquals(1, hunk.source().range().count());
1074             assertLinesEquals(List.of(&quot;Hello, world!&quot;), hunk.source().lines());
1075 
1076             assertEquals(0, hunk.target().range().start());
1077             assertEquals(0, hunk.target().range().count());
1078             assertLinesEquals(List.of(), hunk.target().lines());
1079 
1080             assertEquals(0, hunk.added());
1081             assertEquals(1, hunk.removed());
1082             assertEquals(0, hunk.modified());
1083         }
1084     }
1085 
1086     @ParameterizedTest
1087     @EnumSource(VCS.class)
1088     void testDiffWithAddition(VCS vcs) throws IOException {
1089         try (var dir = new TemporaryDirectory()) {
1090             var r = Repository.init(dir.path(), vcs);
1091 
1092             var readme = dir.path().resolve(&quot;README&quot;);
1093             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1094 
1095             r.add(readme);
1096             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1097 
1098             var building = dir.path().resolve(&quot;BUILDING&quot;);
1099             Files.write(building, List.of(&quot;make&quot;));
1100             r.add(building);
1101             var second = r.commit(&quot;Added BUILDING&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1102 
1103             var diff = r.diff(first, second);
1104             assertEquals(first, diff.from());
1105             assertEquals(second, diff.to());
1106 
1107             var patches = diff.patches();
1108             assertEquals(1, patches.size());
1109 
1110             var patch = patches.get(0).asTextualPatch();
1111             assertTrue(patch.source().path().isEmpty());
1112             assertEquals(Path.of(&quot;BUILDING&quot;), patch.target().path().get());
1113             assertTrue(patch.source().type().isEmpty());
1114             assertTrue(patch.target().type().get().isRegularNonExecutable());
1115             assertTrue(patch.status().isAdded());
1116 
1117             var hunks = patch.hunks();
1118             assertEquals(1, hunks.size());
1119 
1120             var hunk = hunks.get(0);
1121             assertEquals(0, hunk.source().range().start());
1122             assertEquals(0, hunk.source().range().count());
1123             assertLinesEquals(List.of(), hunk.source().lines());
1124 
1125             assertEquals(1, hunk.target().range().start());
1126             assertEquals(1, hunk.target().range().count());
1127             assertLinesEquals(List.of(&quot;make&quot;), hunk.target().lines());
1128 
1129             assertEquals(1, hunk.added());
1130             assertEquals(0, hunk.removed());
1131             assertEquals(0, hunk.modified());
1132         }
1133     }
1134 
1135     @ParameterizedTest
1136     @EnumSource(VCS.class)
1137     void testDiffWithWorkingDir(VCS vcs) throws IOException {
1138         try (var dir = new TemporaryDirectory()) {
1139             var r = Repository.init(dir.path(), vcs);
1140 
1141             var readme = dir.path().resolve(&quot;README&quot;);
1142             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1143 
1144             r.add(readme);
1145             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1146 
1147             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1148             var diff = r.diff(first);
1149 
1150             assertEquals(first, diff.from());
1151             assertNull(diff.to());
1152 
1153             var patches = diff.patches();
1154             assertEquals(1, patches.size());
1155 
1156             var patch = patches.get(0).asTextualPatch();
1157             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
1158             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
1159             assertTrue(patch.source().type().get().isRegularNonExecutable());
1160             assertTrue(patch.target().type().get().isRegularNonExecutable());
1161             assertTrue(patch.status().isModified());
1162 
1163             var hunks = patch.hunks();
1164             assertEquals(1, hunks.size());
1165 
1166             var hunk = hunks.get(0);
1167             assertEquals(2, hunk.source().range().start());
1168             assertEquals(0, hunk.source().range().count());
1169             assertLinesEquals(List.of(), hunk.source().lines());
1170 
1171             assertEquals(2, hunk.target().range().start());
1172             assertEquals(1, hunk.target().range().count());
1173             assertLinesEquals(List.of(&quot;One more line&quot;), hunk.target().lines());
1174 
1175             assertEquals(1, hunk.added());
1176             assertEquals(0, hunk.removed());
1177             assertEquals(0, hunk.modified());
1178         }
1179     }
1180 
1181     @ParameterizedTest
1182     @EnumSource(VCS.class)
1183     void testCommitMetadata(VCS vcs) throws IOException {
1184         try (var dir = new TemporaryDirectory()) {
1185             var r = Repository.init(dir.path(), vcs);
1186 
1187             var readme = dir.path().resolve(&quot;README&quot;);
1188             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1189             r.add(readme);
1190             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1191 
1192             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1193             r.add(readme);
1194             var second = r.commit(&quot;Modified README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1195 
1196             var metadata = r.commitMetadata();
1197             assertEquals(2, metadata.size());
1198 
1199             assertEquals(first, metadata.get(0).hash());
1200             assertEquals(List.of(&quot;Added README&quot;), metadata.get(0).message());
1201 
1202             assertEquals(second, metadata.get(1).hash());
1203             assertEquals(List.of(&quot;Modified README&quot;), metadata.get(1).message());
1204         }
1205     }
1206 
1207     @ParameterizedTest
1208     @EnumSource(VCS.class)
1209     void testTrivialMerge(VCS vcs) throws IOException {
1210         try (var dir = new TemporaryDirectory()) {
1211             var r = Repository.init(dir.path(), vcs);
1212 
1213             var readme = dir.path().resolve(&quot;README&quot;);
1214             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1215             r.add(readme);
1216             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1217 
1218             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1219             r.add(readme);
1220             var second = r.commit(&quot;Modified README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1221 
1222             r.checkout(first, false);
1223 
1224             var contributing = dir.path().resolve(&quot;CONTRIBUTING&quot;);
1225             Files.write(contributing, List.of(&quot;Send those patches!&quot;));
1226             r.add(contributing);
1227             var third = r.commit(&quot;Added contributing&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1228 
1229             r.merge(second);
1230             r.commit(&quot;Merge&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1231 
1232             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
1233             var commits = r.commits(refspec).asList();
1234 
1235             assertEquals(4, commits.size());
1236 
1237             var merge = commits.get(0);
1238             assertEquals(List.of(&quot;Merge&quot;), merge.message());
1239 
1240             var parents = new HashSet&lt;&gt;(merge.parents());
1241             assertEquals(2, parents.size());
1242             assertTrue(parents.contains(second));
1243             assertTrue(parents.contains(third));
1244 
1245             var diffs = merge.parentDiffs();
1246             assertEquals(2, diffs.size());
1247 
1248             var diff1 = diffs.get(0);
1249             assertEquals(merge.hash(), diff1.to());
1250             assertEquals(0, diff1.patches().size());
1251             assertTrue(parents.contains(diff1.from()));
1252 
1253             var diff2 = diffs.get(1);
1254             assertEquals(merge.hash(), diff2.to());
1255             assertEquals(0, diff2.patches().size());
1256             assertTrue(parents.contains(diff2.from()));
1257         }
1258     }
1259 
1260     @ParameterizedTest
1261     @EnumSource(VCS.class)
1262     void testMergeWithEdit(VCS vcs) throws IOException {
1263         try (var dir = new TemporaryDirectory()) {
1264             var r = Repository.init(dir.path(), vcs);
1265 
1266             var readme = dir.path().resolve(&quot;README&quot;);
1267             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1268             r.add(readme);
1269             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1270 
1271             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1272             r.add(readme);
1273             var second = r.commit(&quot;Modified README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1274 
1275             r.checkout(first, false);
1276 
1277             var contributing = dir.path().resolve(&quot;CONTRIBUTING&quot;);
1278             Files.write(contributing, List.of(&quot;Send those patches!&quot;));
1279             r.add(contributing);
1280             var third = r.commit(&quot;Added contributing&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1281 
1282             r.merge(second);
1283 
1284             Files.write(readme, List.of(&quot;One last line&quot;), WRITE, APPEND);
1285             r.add(readme);
1286             r.commit(&quot;Merge&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1287 
1288             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
1289             var commits = r.commits(refspec).asList();
1290 
1291             assertEquals(4, commits.size());
1292 
1293             var merge = commits.get(0);
1294             assertEquals(List.of(&quot;Merge&quot;), merge.message());
1295 
1296             var parents = new HashSet&lt;&gt;(merge.parents());
1297             assertEquals(2, parents.size());
1298             assertTrue(parents.contains(second));
1299             assertTrue(parents.contains(third));
1300 
1301             var diffs = merge.parentDiffs();
1302             assertEquals(2, diffs.size());
1303 
1304             var secondDiff = diffs.stream().filter(d -&gt; d.from().equals(second)).findFirst().get();
1305             assertEquals(merge.hash(), secondDiff.to());
1306             assertEquals(1, secondDiff.patches().size());
1307             var secondPatch = secondDiff.patches().get(0).asTextualPatch();
1308 
1309             assertEquals(Path.of(&quot;README&quot;), secondPatch.source().path().get());
1310             assertEquals(Path.of(&quot;README&quot;), secondPatch.target().path().get());
1311             assertTrue(secondPatch.status().isModified());
1312             assertEquals(1, secondPatch.hunks().size());
1313 
1314             var secondHunk = secondPatch.hunks().get(0);
1315             assertLinesEquals(List.of(), secondHunk.source().lines());
1316             assertLinesEquals(List.of(&quot;One last line&quot;), secondHunk.target().lines());
1317 
1318             assertEquals(3, secondHunk.source().range().start());
1319             assertEquals(0, secondHunk.source().range().count());
1320             assertEquals(3, secondHunk.target().range().start());
1321             assertEquals(1, secondHunk.target().range().count());
1322 
1323             var thirdDiff = diffs.stream().filter(d -&gt; d.from().equals(third)).findFirst().get();
1324             assertEquals(merge.hash(), thirdDiff.to());
1325             assertEquals(1, thirdDiff.patches().size());
1326             var thirdPatch = thirdDiff.patches().get(0).asTextualPatch();
1327 
1328             assertEquals(Path.of(&quot;README&quot;), thirdPatch.source().path().get());
1329             assertEquals(Path.of(&quot;README&quot;), thirdPatch.target().path().get());
1330             assertTrue(thirdPatch.status().isModified());
1331             assertEquals(1, thirdPatch.hunks().size());
1332 
1333             var thirdHunk = thirdPatch.hunks().get(0);
1334             assertLinesEquals(List.of(), thirdHunk.source().lines());
1335             assertLinesEquals(List.of(&quot;One more line&quot;, &quot;One last line&quot;), thirdHunk.target().lines());
1336 
1337             assertEquals(2, thirdHunk.source().range().start());
1338             assertEquals(0, thirdHunk.source().range().count());
1339             assertEquals(2, thirdHunk.target().range().start());
1340             assertEquals(2, thirdHunk.target().range().count());
1341         }
1342     }
1343 
1344     @ParameterizedTest
1345     @EnumSource(VCS.class)
1346     void testDefaultBranch(VCS vcs) throws IOException {
1347         try (var dir = new TemporaryDirectory()) {
1348             var r = Repository.init(dir.path(), vcs);
1349             var expected = vcs == VCS.GIT ? &quot;master&quot; : &quot;default&quot;;
1350             assertEquals(expected, r.defaultBranch().name());
1351         }
1352     }
1353 
1354     @ParameterizedTest
1355     @EnumSource(VCS.class)
1356     void testPaths(VCS vcs) throws IOException {
1357         try (var dir = new TemporaryDirectory()) {
1358             var r = Repository.init(dir.path(), vcs);
1359             var remote = vcs == VCS.GIT ? &quot;origin&quot; : &quot;default&quot;;
1360             r.setPaths(remote, &quot;http://pull&quot;, &quot;http://push&quot;);
1361             assertEquals(&quot;http://pull&quot;, r.pullPath(remote));
1362             assertEquals(&quot;http://push&quot;, r.pushPath(remote));
1363         }
1364     }
1365 
1366     @ParameterizedTest
1367     @EnumSource(VCS.class)
1368     void testIsValidRevisionRange(VCS vcs) throws IOException {
1369         try (var dir = new TemporaryDirectory()) {
1370             var r = Repository.init(dir.path(), vcs);
1371             assertFalse(r.isValidRevisionRange(&quot;foo&quot;));
1372 
1373             var readme = dir.path().resolve(&quot;README&quot;);
1374             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1375             r.add(readme);
1376             r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1377 
1378             assertTrue(r.isValidRevisionRange(r.defaultBranch().toString()));
1379         }
1380     }
1381 
1382     @ParameterizedTest
1383     @EnumSource(VCS.class)
1384     void testDefaultTag(VCS vcs) throws IOException {
1385         try (var dir = new TemporaryDirectory()) {
1386             var r = Repository.init(dir.path(), vcs);
1387             var expected = vcs == VCS.GIT ? Optional.empty() : Optional.of(new Tag(&quot;tip&quot;));
1388             assertEquals(expected, r.defaultTag());
1389         }
1390     }
1391 
1392     @ParameterizedTest
1393     @EnumSource(VCS.class)
1394     void testTag(VCS vcs) throws IOException {
1395         try (var dir = new TemporaryDirectory()) {
1396             var r = Repository.init(dir.path(), vcs);
1397 
1398             var readme = dir.path().resolve(&quot;README&quot;);
1399             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1400             r.add(readme);
1401             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1402 
1403             r.tag(first, &quot;test&quot;, &quot;Tagging test&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1404             var defaultTag = r.defaultTag().orElse(null);
1405             var nonDefaultTags = r.tags().stream()
1406                                   .filter(tag -&gt; !tag.equals(defaultTag))
1407                                   .map(Tag::toString)
1408                                   .collect(Collectors.toList());
1409             assertEquals(List.of(&quot;test&quot;), nonDefaultTags);
1410         }
1411     }
1412 
1413     @ParameterizedTest
1414     @EnumSource(VCS.class)
1415     void testIsClean(VCS vcs) throws IOException {
1416         try (var dir = new TemporaryDirectory()) {
1417             var r = Repository.init(dir.path(), vcs);
1418             assertTrue(r.isClean());
1419 
1420             var readme = dir.path().resolve(&quot;README&quot;);
1421             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1422             assertFalse(r.isClean());
1423 
1424             r.add(readme);
1425             assertFalse(r.isClean());
1426 
1427             r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1428             assertTrue(r.isClean());
1429 
1430             Files.delete(readme);
1431             assertFalse(r.isClean());
1432 
1433             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1434             assertTrue(r.isClean());
1435         }
1436     }
1437 
1438     @ParameterizedTest
1439     @EnumSource(VCS.class)
1440     void testShowOnExecutableFiles(VCS vcs) throws IOException {
1441         try (var dir = new TemporaryDirectory()) {
1442             var r = Repository.init(dir.path(), vcs);
1443             assertTrue(r.isClean());
1444 
1445             var readOnlyExecutableFile = dir.path().resolve(&quot;hello.sh&quot;);
1446             Files.write(readOnlyExecutableFile, List.of(&quot;echo &#39;hello&#39;&quot;));
1447             if (readOnlyExecutableFile.getFileSystem().supportedFileAttributeViews().contains(&quot;posix&quot;)) {
1448                 var permissions = PosixFilePermissions.fromString(&quot;r-xr-xr-x&quot;);
1449                 Files.setPosixFilePermissions(readOnlyExecutableFile, permissions);
1450             }
1451             r.add(readOnlyExecutableFile);
1452             var hash = r.commit(&quot;Added read only executable file&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1453             assertEquals(Optional.of(List.of(&quot;echo &#39;hello&#39;&quot;)), r.lines(readOnlyExecutableFile, hash));
1454 
1455             var readWriteExecutableFile = dir.path().resolve(&quot;goodbye.sh&quot;);
1456             Files.write(readWriteExecutableFile, List.of(&quot;echo &#39;goodbye&#39;&quot;));
1457             if (readOnlyExecutableFile.getFileSystem().supportedFileAttributeViews().contains(&quot;posix&quot;)) {
1458                 var permissions = PosixFilePermissions.fromString(&quot;rwxrwxrwx&quot;);
1459                 Files.setPosixFilePermissions(readWriteExecutableFile, permissions);
1460             }
1461             r.add(readWriteExecutableFile);
1462             var hash2 = r.commit(&quot;Added read-write executable file&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1463             assertEquals(Optional.of(List.of(&quot;echo &#39;goodbye&#39;&quot;)), r.lines(readWriteExecutableFile, hash2));
1464         }
1465     }
1466 
1467     @Test
1468     void testGetAndExistsOnNonExistingDirectory() throws IOException {
1469         var nonExistingDirectory = Path.of(&quot;this&quot;, &quot;does&quot;, &quot;not&quot;, &quot;exist&quot;);
1470         assertEquals(Optional.empty(), Repository.get(nonExistingDirectory));
1471         assertEquals(false, Repository.exists(nonExistingDirectory));
1472     }
1473 
1474     @ParameterizedTest
1475     @EnumSource(VCS.class)
1476     void testDiffOnFilenamesWithSpace(VCS vcs) throws IOException {
1477         try (var dir = new TemporaryDirectory()) {
1478             var r = Repository.init(dir.path(), vcs);
1479             assertTrue(r.isClean());
1480 
1481             var fileWithSpaceInName = dir.path().resolve(&quot;hello world.txt&quot;);
1482             Files.writeString(fileWithSpaceInName, &quot;Hello world\n&quot;);
1483             r.add(fileWithSpaceInName);
1484             var hash1 = r.commit(&quot;Added file with space in name&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1485             Files.writeString(fileWithSpaceInName, &quot;Goodbye world\n&quot;);
1486             r.add(fileWithSpaceInName);
1487             var hash2 = r.commit(&quot;Modified file with space in name&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1488             var diff = r.diff(hash1, hash2);
1489             var patches = diff.patches();
1490             assertEquals(1, patches.size());
1491             var patch = patches.get(0);
1492             assertTrue(patch.target().path().isPresent());
1493             var path = patch.target().path().get();
1494             assertEquals(Path.of(&quot;hello world.txt&quot;), path);
1495         }
1496     }
1497 
1498     @Test
1499     void testSingleEmptyCommit() throws IOException, InterruptedException {
1500         try (var dir = new TemporaryDirectory()) {
1501             var r = Repository.init(dir.path(), VCS.GIT);
1502             assertTrue(r.isClean());
1503 
1504             // must ust git directly to be able to pass --allow-empty
1505             var pb = new ProcessBuilder(&quot;git&quot;, &quot;commit&quot;, &quot;--message&quot;, &quot;An empty commit&quot;, &quot;--allow-empty&quot;);
1506             pb.environment().put(&quot;GIT_AUTHOR_NAME&quot;, &quot;duke&quot;);
1507             pb.environment().put(&quot;GIT_AUTHOR_EMAIL&quot;, &quot;duke@openjdk.org&quot;);
1508             pb.environment().put(&quot;GIT_COMMITTER_NAME&quot;, &quot;duke&quot;);
1509             pb.environment().put(&quot;GIT_COMMITTER_EMAIL&quot;, &quot;duke@openjdk.org&quot;);
1510             pb.directory(dir.path().toFile());
1511 
1512             var res = pb.start().waitFor();
1513             assertEquals(0, res);
1514 
1515             var commits = r.commits().asList();
1516             assertEquals(1, commits.size());
1517             var commit = commits.get(0);
1518             assertEquals(&quot;duke&quot;, commit.author().name());
1519             assertEquals(&quot;duke@openjdk.org&quot;, commit.author().email());
1520             assertEquals(&quot;duke&quot;, commit.committer().name());
1521             assertEquals(&quot;duke@openjdk.org&quot;, commit.committer().email());
1522             assertEquals(List.of(&quot;An empty commit&quot;), commit.message());
1523         }
1524     }
1525 
1526     @Test
1527     void testEmptyCommitWithParent() throws IOException, InterruptedException {
1528         try (var dir = new TemporaryDirectory()) {
1529             var r = Repository.init(dir.path(), VCS.GIT);
1530             assertTrue(r.isClean());
1531 
1532             var f = Files.createFile(dir.path().resolve(&quot;hello.txt&quot;));
1533             Files.writeString(f, &quot;Hello world\n&quot;);
1534             r.add(f);
1535             r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1536 
1537             // must ust git directly to be able to pass --allow-empty
1538             var pb = new ProcessBuilder(&quot;git&quot;, &quot;commit&quot;, &quot;--message&quot;, &quot;An empty commit&quot;, &quot;--allow-empty&quot;);
1539             pb.environment().put(&quot;GIT_AUTHOR_NAME&quot;, &quot;duke&quot;);
1540             pb.environment().put(&quot;GIT_AUTHOR_EMAIL&quot;, &quot;duke@openjdk.org&quot;);
1541             pb.environment().put(&quot;GIT_COMMITTER_NAME&quot;, &quot;duke&quot;);
1542             pb.environment().put(&quot;GIT_COMMITTER_EMAIL&quot;, &quot;duke@openjdk.org&quot;);
1543             pb.directory(dir.path().toFile());
1544 
1545             var res = pb.start().waitFor();
1546             assertEquals(0, res);
1547 
1548             var commits = r.commits().asList();
1549             assertEquals(2, commits.size());
1550             var commit = commits.get(0);
1551             assertEquals(&quot;duke&quot;, commit.author().name());
1552             assertEquals(&quot;duke@openjdk.org&quot;, commit.author().email());
1553             assertEquals(&quot;duke&quot;, commit.committer().name());
1554             assertEquals(&quot;duke@openjdk.org&quot;, commit.committer().email());
1555             assertEquals(List.of(&quot;An empty commit&quot;), commit.message());
1556         }
1557     }
1558 
1559     @ParameterizedTest
1560     @EnumSource(VCS.class)
1561     void testAmend(VCS vcs) throws IOException {
1562         try (var dir = new TemporaryDirectory()) {
1563             var r = Repository.init(dir.path(), vcs);
1564             assertTrue(r.isClean());
1565 
1566             var f = dir.path().resolve(&quot;README&quot;);
1567             Files.writeString(f, &quot;Hello\n&quot;);
1568             r.add(f);
1569             r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1570 
1571             Files.writeString(f, &quot;Hello, world\n&quot;);
1572             r.add(f);
1573             r.amend(&quot;Initial commit corrected&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1574             var commits = r.commits().asList();
1575             assertEquals(1, commits.size());
1576             var commit = commits.get(0);
1577             assertEquals(List.of(&quot;Initial commit corrected&quot;), commit.message());
1578         }
1579     }
1580 
1581     @ParameterizedTest
1582     @EnumSource(VCS.class)
1583     void testRevert(VCS vcs) throws IOException {
1584         try (var dir = new TemporaryDirectory()) {
1585             var r = Repository.init(dir.path(), vcs);
1586             assertTrue(r.isClean());
1587 
1588             var f = dir.path().resolve(&quot;README&quot;);
1589             Files.writeString(f, &quot;Hello\n&quot;);
1590             r.add(f);
1591             var initial = r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1592 
1593             Files.writeString(f, &quot;Hello, world\n&quot;);
1594             r.revert(initial);
1595             Files.writeString(f, &quot;Goodbye, world\n&quot;);
1596             r.add(f);
1597             var hash = r.commit(&quot;Second commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1598             var commit = r.lookup(hash).orElseThrow();
1599             var patches = commit.parentDiffs().get(0).patches();
1600             assertEquals(1, patches.size());
1601             var patch = patches.get(0).asTextualPatch();
1602             assertEquals(1, patch.hunks().size());
1603             var hunk = patch.hunks().get(0);
1604             assertEquals(List.of(&quot;Goodbye, world&quot;), hunk.target().lines());
1605         }
1606     }
1607 
1608     @ParameterizedTest
1609     @EnumSource(VCS.class)
1610     void testFiles(VCS vcs) throws IOException {
1611         try (var dir = new TemporaryDirectory()) {
1612             var r = Repository.init(dir.path(), vcs);
1613             assertTrue(r.isClean());
1614 
1615             var f = dir.path().resolve(&quot;README&quot;);
1616             Files.writeString(f, &quot;Hello\n&quot;);
1617             r.add(f);
1618             var initial = r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1619 
1620             var entries = r.files(initial);
1621             assertEquals(1, entries.size());
1622             var entry = entries.get(0);
1623             assertEquals(Path.of(&quot;README&quot;), entry.path());
1624             assertTrue(entry.type().isRegularNonExecutable());
1625 
1626             var f2 = dir.path().resolve(&quot;CONTRIBUTING&quot;);
1627             Files.writeString(f2, &quot;Hello\n&quot;);
1628             r.add(f2);
1629             var second = r.commit(&quot;Second commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1630 
1631             entries = r.files(second);
1632             assertEquals(2, entries.size());
1633             assertTrue(entries.stream().allMatch(e -&gt; e.type().isRegularNonExecutable()));
1634             var paths = entries.stream().map(FileEntry::path).collect(Collectors.toSet());
1635             assertTrue(paths.contains(Path.of(&quot;README&quot;)));
1636             assertTrue(paths.contains(Path.of(&quot;CONTRIBUTING&quot;)));
1637 
1638             entries = r.files(second, Path.of(&quot;README&quot;));
1639             assertEquals(1, entries.size());
1640             entry = entries.get(0);
1641             assertEquals(Path.of(&quot;README&quot;), entry.path());
1642             assertTrue(entry.type().isRegularNonExecutable());
1643         }
1644     }
1645 
1646     @ParameterizedTest
1647     @EnumSource(VCS.class)
1648     void testDump(VCS vcs) throws IOException {
1649         try (var dir = new TemporaryDirectory()) {
1650             var r = Repository.init(dir.path(), vcs);
1651             assertTrue(r.isClean());
1652 
1653             var f = dir.path().resolve(&quot;README&quot;);
1654             Files.writeString(f, &quot;Hello\n&quot;);
1655             r.add(f);
1656             var initial = r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1657 
1658             var readme = r.files(initial).get(0);
1659 
1660             var tmp = Files.createTempFile(&quot;README&quot;, &quot;txt&quot;);
1661             r.dump(readme, tmp);
1662             assertEquals(&quot;Hello\n&quot;, Files.readString(tmp));
1663             Files.delete(tmp);
1664         }
1665     }
1666 
1667     @ParameterizedTest
1668     @EnumSource(VCS.class)
1669     void testStatus(VCS vcs) throws IOException {
1670         try (var dir = new TemporaryDirectory()) {
1671             var r = Repository.init(dir.path(), vcs);
1672             assertTrue(r.isClean());
1673 
1674             var f = dir.path().resolve(&quot;README&quot;);
1675             Files.writeString(f, &quot;Hello\n&quot;);
1676             r.add(f);
1677             var initial = r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1678 
1679             var f2 = dir.path().resolve(&quot;CONTRIBUTING&quot;);
1680             Files.writeString(f2, &quot;Goodbye\n&quot;);
1681             r.add(f2);
1682             var second = r.commit(&quot;Second commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1683 
1684             var entries = r.status(initial, second);
1685             assertEquals(1, entries.size());
1686             var entry = entries.get(0);
1687             assertTrue(entry.status().isAdded());
1688             assertTrue(entry.source().path().isEmpty());
1689             assertTrue(entry.source().type().isEmpty());
1690 
1691             assertTrue(entry.target().path().isPresent());
1692             assertEquals(Path.of(&quot;CONTRIBUTING&quot;), entry.target().path().get());
1693             assertTrue(entry.target().type().get().isRegular());
1694         }
1695     }
1696 
1697     @ParameterizedTest
1698     @EnumSource(VCS.class)
1699     void testTrackLineEndings(VCS vcs) throws IOException, InterruptedException {
1700         try (var dir = new TemporaryDirectory()) {
1701             var r = Repository.init(dir.path(), vcs);
1702             if (vcs == VCS.GIT) { // turn of git&#39;s meddling
1703                 int exitCode = new ProcessBuilder()
1704                         .command(&quot;git&quot;, &quot;config&quot;, &quot;--local&quot;, &quot;core.autocrlf&quot;, &quot;false&quot;)
1705                         .directory(dir.path().toFile())
1706                         .start()
1707                         .waitFor();
1708                 assertEquals(0, exitCode);
1709             }
1710 
1711             var readme = dir.path().resolve(&quot;README&quot;);
1712             Files.writeString(readme, &quot;Line with Unix line ending\n&quot;);
1713             Files.writeString(readme, &quot;Line with Windows line ending\r\n&quot;, APPEND);
1714 
1715             r.add(readme);
1716             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1717 
1718             var commits = r.commits().asList();
1719             assertEquals(1, commits.size());
1720 
1721             var commit = commits.get(0);
1722             var diffs = commit.parentDiffs();
1723             var diff = diffs.get(0);
1724             assertEquals(2, diff.added());
1725 
1726             var patches = diff.patches();
1727             assertEquals(1, patches.size());
1728 
1729             var patch = patches.get(0).asTextualPatch();
1730             var hunks = patch.hunks();
1731             assertEquals(1, hunks.size());
1732 
1733             var hunk = hunks.get(0);
1734             assertEquals(new Range(0, 0), hunk.source().range());
1735             assertEquals(new Range(1, 2), hunk.target().range());
1736 
1737             assertEquals(
1738                     List.of(&quot;Line with Unix line ending&quot;, &quot;Line with Windows line ending\r&quot;),
1739                     hunk.target().lines());
1740         }
1741     }
1742 
1743     @ParameterizedTest
1744     @EnumSource(VCS.class)
1745     void testContains(VCS vcs) throws IOException {
1746         try (var dir = new TemporaryDirectory()) {
1747             var r = Repository.init(dir.path(), vcs);
1748             assertTrue(r.isClean());
1749 
1750             var f = dir.path().resolve(&quot;README&quot;);
1751             Files.writeString(f, &quot;Hello\n&quot;);
1752             r.add(f);
1753             var initial = r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1754 
1755             assertTrue(r.contains(r.defaultBranch(), initial));
1756 
1757             Files.writeString(f, &quot;Hello again\n&quot;);
1758             r.add(f);
1759             var second = r.commit(&quot;Second commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1760 
1761             assertTrue(r.contains(r.defaultBranch(), initial));
1762         }
1763     }
1764 
1765     @ParameterizedTest
1766     @EnumSource(VCS.class)
1767     void testAbortMerge(VCS vcs) throws IOException {
1768         try (var dir = new TemporaryDirectory(false)) {
1769             var r = Repository.init(dir.path(), vcs);
1770             assertTrue(r.isClean());
1771 
1772             var f = dir.path().resolve(&quot;README&quot;);
1773             Files.writeString(f, &quot;Hello\n&quot;);
1774             r.add(f);
1775             var initial = r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1776 
1777             Files.writeString(f, &quot;Hello again\n&quot;);
1778             r.add(f);
1779             var second = r.commit(&quot;Second commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1780 
1781             r.checkout(initial);
1782             Files.writeString(f, &quot;Conflicting hello\n&quot;);
1783             r.add(f);
1784             var third = r.commit(&quot;Third commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1785 
1786             assertThrows(IOException.class, () -&gt; { r.merge(second); });
1787 
1788             r.abortMerge();
1789             assertTrue(r.isClean());
1790         }
1791     }
1792 
1793     @ParameterizedTest
1794     @EnumSource(VCS.class)
1795     void testReset(VCS vcs) throws IOException {
1796         assumeTrue(vcs == VCS.GIT); // FIXME reset is not yet implemented for HG
1797 
1798         try (var dir = new TemporaryDirectory()) {
1799             var repo = Repository.init(dir.path(), vcs);
1800             assertTrue(repo.isClean());
1801 
1802             var f = dir.path().resolve(&quot;README&quot;);
1803             Files.writeString(f, &quot;Hello\n&quot;);
1804             repo.add(f);
1805             var initial = repo.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1806 
1807             Files.writeString(f, &quot;Hello again\n&quot;);
1808             repo.add(f);
1809             var second = repo.commit(&quot;Second commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1810 
1811             assertEquals(second, repo.head());
1812             assertEquals(2, repo.commits().asList().size());
1813 
1814             repo.reset(initial, true);
1815 
1816             assertEquals(initial, repo.head());
1817             assertEquals(1, repo.commits().asList().size());
1818         }
1819     }
1820 
1821     @ParameterizedTest
1822     @EnumSource(VCS.class)
1823     void testRemotes(VCS vcs) throws IOException {
1824         try (var dir = new TemporaryDirectory()) {
1825             var repo = Repository.init(dir.path(), vcs);
1826             assertEquals(List.of(), repo.remotes());
1827             repo.addRemote(&quot;foobar&quot;, &quot;https://foo/bar&quot;);
1828             assertEquals(List.of(&quot;foobar&quot;), repo.remotes());
1829         }
1830     }
1831 
1832     @ParameterizedTest
1833     @EnumSource(VCS.class)
1834     void testRemoteBranches(VCS vcs) throws IOException {
1835         try (var dir = new TemporaryDirectory()) {
1836             var upstream = Repository.init(dir.path().resolve(&quot;upstream&quot;), vcs);
1837             var readme = upstream.root().resolve(&quot;README&quot;);
1838             Files.writeString(readme, &quot;Hello\n&quot;);
1839             upstream.add(readme);
1840             var head = upstream.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1841 
1842             var fork = Repository.init(dir.path().resolve(&quot;fork&quot;), vcs);
<a name="1" id="anc1"></a><span class="line-modified">1843             fork.addRemote(&quot;upstream&quot;, &quot;file://&quot; + upstream.root());</span>
1844             var refs = fork.remoteBranches(&quot;upstream&quot;);
1845             assertEquals(1, refs.size());
1846             var ref = refs.get(0);
1847             assertEquals(head, ref.hash());
1848             assertEquals(upstream.defaultBranch().name(), ref.name());
1849         }
1850     }
1851 }
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>