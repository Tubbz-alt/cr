<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/notify/IssueUpdater.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../tester/src/test/java/org/openjdk/skara/bots/tester/InMemoryPullRequest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.notify;
  24 
  25 import org.openjdk.skara.email.*;
  26 import org.openjdk.skara.forge.HostedRepository;

  27 import org.openjdk.skara.json.*;
  28 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  29 import org.openjdk.skara.storage.StorageBuilder;
  30 import org.openjdk.skara.test.*;
  31 import org.openjdk.skara.vcs.Tag;
  32 
  33 import org.junit.jupiter.api.*;
  34 
  35 import java.io.IOException;
  36 import java.net.URI;
  37 import java.nio.charset.StandardCharsets;
  38 import java.nio.file.*;
  39 import java.time.Duration;
  40 import java.util.*;
  41 import java.util.regex.Pattern;
  42 import java.util.stream.Collectors;
  43 
  44 import static org.junit.jupiter.api.Assertions.*;
  45 
  46 class UpdaterTests {
</pre>
<hr />
<pre>
  49                     .filter(path -&gt; path.toString().endsWith(&quot;.json&quot;))
  50                     .filter(path -&gt; path.toString().contains(partialName))
  51                     .collect(Collectors.toList());
  52     }
  53 
  54     private StorageBuilder&lt;Tag&gt; createTagStorage(HostedRepository repository) {
  55         return new StorageBuilder&lt;Tag&gt;(&quot;tags.txt&quot;)
  56                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated tags&quot;);
  57     }
  58 
  59     private StorageBuilder&lt;ResolvedBranch&gt; createBranchStorage(HostedRepository repository) {
  60         return new StorageBuilder&lt;ResolvedBranch&gt;(&quot;branches.txt&quot;)
  61                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated branches&quot;);
  62     }
  63 
  64     private StorageBuilder&lt;PullRequestIssues&gt; createPullRequestIssuesStorage(HostedRepository repository) {
  65         return new StorageBuilder&lt;PullRequestIssues&gt;(&quot;prissues.txt&quot;)
  66                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated prissues&quot;);
  67     }
  68 









  69     @Test
  70     void testJsonUpdaterBranch(TestInfo testInfo) throws IOException {
  71         try (var credentials = new HostCredentials(testInfo);
  72              var tempFolder = new TemporaryDirectory()) {
  73             var repo = credentials.getHostedRepository();
  74             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
  75             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
  76             credentials.commitLock(localRepo);
  77             localRepo.pushAll(repo.url());
  78 
  79             var tagStorage = createTagStorage(repo);
  80             var branchStorage = createBranchStorage(repo);
  81             var prIssuesStorage = createPullRequestIssuesStorage(repo);
  82             var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
  83             Files.createDirectory(jsonFolder);
  84             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
  85 
  86             var updater = new JsonUpdater(jsonFolder, &quot;12&quot;, &quot;team&quot;);
  87             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
  88                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
</pre>
<hr />
<pre>
 898             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 899             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 900             credentials.commitLock(localRepo);
 901             localRepo.pushAll(repo.url());
 902 
 903             var tagStorage = createTagStorage(repo);
 904             var branchStorage = createBranchStorage(repo);
 905             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 906             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 907 
 908             var issueProject = credentials.getIssueProject();
 909             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
 910             var updater = new IssueUpdater(issueProject, false, null, true, commitIcon, true, null);
 911             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 912                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 913 
 914             // Initialize history
 915             TestBotRunner.runPeriodicItems(notifyBot);
 916 
 917             // Create an issue and commit a fix
<span class="line-modified"> 918             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;type&quot;, &quot;Enhancement&quot;));</span>
 919             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
 920             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 921             TestBotRunner.runPeriodicItems(notifyBot);
 922 
 923             // The changeset should be reflected in a comment
 924             var comments = issue.comments();
 925             assertEquals(1, comments.size());
 926             var comment = comments.get(0);
 927             assertTrue(comment.body().contains(editHash.abbreviate()));
 928 
 929             // And in a link
 930             var links = issue.links();
 931             assertEquals(1, links.size());
 932             var link = links.get(0);
 933             assertEquals(commitIcon, link.iconUrl().orElseThrow());
 934             assertEquals(&quot;Commit&quot;, link.title().orElseThrow());
 935             assertEquals(repo.webUrl(editHash), link.uri().orElseThrow());
 936 
 937             // As well as a fixVersion
<span class="line-modified"> 938             var fixVersions = issue.fixVersions();</span>
<span class="line-removed"> 939             assertEquals(1, fixVersions.size());</span>
<span class="line-removed"> 940             var fixVersion = fixVersions.get(0);</span>
<span class="line-removed"> 941             assertEquals(&quot;0.1&quot;, fixVersion);</span>
 942         }
 943     }
 944 
 945     @Test
 946     void testIssueNoVersion(TestInfo testInfo) throws IOException {
 947         try (var credentials = new HostCredentials(testInfo);
 948              var tempFolder = new TemporaryDirectory()) {
 949             var repo = credentials.getHostedRepository();
 950             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 951             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
 952             credentials.commitLock(localRepo);
 953             localRepo.pushAll(repo.url());
 954 
 955             var tagStorage = createTagStorage(repo);
 956             var branchStorage = createBranchStorage(repo);
 957             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 958             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 959 
 960             var issueProject = credentials.getIssueProject();
 961             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
 962             var updater = new IssueUpdater(issueProject, false, null, true, commitIcon, true, null);
 963             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 964                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 965 
 966             // Initialize history
 967             TestBotRunner.runPeriodicItems(notifyBot);
 968 
 969             // Create an issue and commit a fix
<span class="line-modified"> 970             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;type&quot;, &quot;Enhancement&quot;));</span>
 971             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
 972             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 973             TestBotRunner.runPeriodicItems(notifyBot);
 974 
 975             // The changeset should be reflected in a comment
 976             var comments = issue.comments();
 977             assertEquals(1, comments.size());
 978             var comment = comments.get(0);
 979             assertTrue(comment.body().contains(editHash.abbreviate()));
 980 
 981             // But not in the fixVersion
<span class="line-modified"> 982             var fixVersions = issue.fixVersions();</span>
<span class="line-removed"> 983             assertEquals(0, fixVersions.size());</span>
 984         }
 985     }
 986 
 987     @Test
 988     void testIssueConfiguredVersionNoCommit(TestInfo testInfo) throws IOException {
 989         try (var credentials = new HostCredentials(testInfo);
 990              var tempFolder = new TemporaryDirectory()) {
 991             var repo = credentials.getHostedRepository();
 992             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 993             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
 994             credentials.commitLock(localRepo);
 995             localRepo.pushAll(repo.url());
 996 
 997             var tagStorage = createTagStorage(repo);
 998             var branchStorage = createBranchStorage(repo);
 999             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1000             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1001 
1002             var issueProject = credentials.getIssueProject();
1003             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
1004             var updater = new IssueUpdater(issueProject, false, null, false, commitIcon, true,&quot;2.0&quot;);
1005             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1006                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1007 
1008             // Initialize history
1009             TestBotRunner.runPeriodicItems(notifyBot);
1010 
1011             // Create an issue and commit a fix
<span class="line-modified">1012             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;type&quot;, &quot;Enhancement&quot;));</span>
1013             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1014             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1015             TestBotRunner.runPeriodicItems(notifyBot);
1016 
1017             // The changeset should not reflected in a comment
1018             var comments = issue.comments();
1019             assertEquals(1, comments.size());
1020             var comment = comments.get(0);
1021             assertTrue(comment.body().contains(editHash.abbreviate()));
1022 
1023             // As well as a fixVersion - but not the one from the repo
<span class="line-modified">1024             var fixVersions = issue.fixVersions();</span>
<span class="line-removed">1025             assertEquals(1, fixVersions.size());</span>
<span class="line-removed">1026             var fixVersion = fixVersions.get(0);</span>
<span class="line-removed">1027             assertEquals(&quot;2.0&quot;, fixVersion);</span>
1028 
1029             // And no commit link
1030             var links = issue.links();
1031             assertEquals(0, links.size());
1032         }
1033     }
1034 
1035     @Test
1036     void testIssueIdempotence(TestInfo testInfo) throws IOException {
1037         try (var credentials = new HostCredentials(testInfo);
1038              var tempFolder = new TemporaryDirectory()) {
1039             var repo = credentials.getHostedRepository();
1040             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1041             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1042             credentials.commitLock(localRepo);
1043             localRepo.pushAll(repo.url());
1044 
1045             var tagStorage = createTagStorage(repo);
1046             var branchStorage = createBranchStorage(repo);
1047             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1048             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1049 
1050             var issueProject = credentials.getIssueProject();
1051             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
1052             var updater = new IssueUpdater(issueProject, false, null, true, commitIcon, true, null);
1053             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1054                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1055 
1056             // Initialize history
1057             TestBotRunner.runPeriodicItems(notifyBot);
1058 
1059             // Save the state
1060             var historyState = localRepo.fetch(repo.url(), &quot;history&quot;);
1061 
1062             // Create an issue and commit a fix
<span class="line-modified">1063             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;type&quot;, &quot;Enhancement&quot;));</span>
1064             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1065             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1066             TestBotRunner.runPeriodicItems(notifyBot);
1067 
1068             // The changeset should be reflected in a comment
1069             var comments = issue.comments();
1070             assertEquals(1, comments.size());
1071             var comment = comments.get(0);
1072             assertTrue(comment.body().contains(editHash.abbreviate()));
1073 
1074             // And in a link
1075             var links = issue.links();
1076             assertEquals(1, links.size());
1077             var link = links.get(0);
1078             assertEquals(commitIcon, link.iconUrl().orElseThrow());
1079             assertEquals(&quot;Commit&quot;, link.title().orElseThrow());
1080             assertEquals(repo.webUrl(editHash), link.uri().orElseThrow());
1081 
1082             // As well as a fixVersion
<span class="line-modified">1083             var fixVersions = issue.fixVersions();</span>
<span class="line-removed">1084             assertEquals(1, fixVersions.size());</span>
<span class="line-removed">1085             var fixVersion = fixVersions.get(0);</span>
<span class="line-removed">1086             assertEquals(&quot;0.1&quot;, fixVersion);</span>
1087 
1088             // Wipe the history
1089             localRepo.push(historyState, repo.url(), &quot;history&quot;, true);
1090 
1091             // Run it again
1092             TestBotRunner.runPeriodicItems(notifyBot);
1093 
1094             // There should be no new comments, links or fixVersions
1095             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1096             assertEquals(1, updatedIssue.comments().size());
1097             assertEquals(1, updatedIssue.links().size());
<span class="line-modified">1098             assertEquals(1, updatedIssue.fixVersions().size());</span>
1099         }
1100     }
1101 
1102     @Test
1103     void testIssuePoolVersion(TestInfo testInfo) throws IOException {
1104         try (var credentials = new HostCredentials(testInfo);
1105              var tempFolder = new TemporaryDirectory()) {
1106             var repo = credentials.getHostedRepository();
1107             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1108             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1109             credentials.commitLock(localRepo);
1110             localRepo.pushAll(repo.url());
1111 
1112             var tagStorage = createTagStorage(repo);
1113             var branchStorage = createBranchStorage(repo);
1114             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1115             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1116 
1117             var issueProject = credentials.getIssueProject();
1118             var updater = new IssueUpdater(issueProject, false, null, false, null, true, &quot;12u14&quot;);
1119             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1120                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1121 
1122             // Initialize history
1123             TestBotRunner.runPeriodicItems(notifyBot);
1124 
1125             // Create an issue and commit a fix
<span class="line-modified">1126             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;type&quot;, &quot;Enhancement&quot;));</span>
<span class="line-modified">1127             issue.addFixVersion(&quot;12-pool&quot;);</span>
<span class="line-removed">1128             issue.addFixVersion(&quot;tbd13&quot;);</span>
<span class="line-removed">1129             issue.addFixVersion(&quot;unknown&quot;);</span>
1130 
1131             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1132             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1133             TestBotRunner.runPeriodicItems(notifyBot);
1134 
1135             // The fixVersion should have been updated
<span class="line-modified">1136             var fixVersions = issue.fixVersions();</span>
<span class="line-removed">1137             assertEquals(1, fixVersions.size());</span>
<span class="line-removed">1138             assertEquals(&quot;12u14&quot;, fixVersions.get(0));</span>
1139         }
1140     }
1141 
1142     @Test
1143     void testIssuePoolOpenVersion(TestInfo testInfo) throws IOException {
1144         try (var credentials = new HostCredentials(testInfo);
1145              var tempFolder = new TemporaryDirectory()) {
1146             var repo = credentials.getHostedRepository();
1147             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1148             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1149             credentials.commitLock(localRepo);
1150             localRepo.pushAll(repo.url());
1151 
1152             var tagStorage = createTagStorage(repo);
1153             var branchStorage = createBranchStorage(repo);
1154             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1155             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1156 
1157             var issueProject = credentials.getIssueProject();
1158             var updater = new IssueUpdater(issueProject, false, null, false, null, true, &quot;12u14&quot;);
1159             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1160                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1161 
1162             // Initialize history
1163             TestBotRunner.runPeriodicItems(notifyBot);
1164 
1165             // Create an issue and commit a fix
<span class="line-modified">1166             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;type&quot;, &quot;Enhancement&quot;));</span>
<span class="line-modified">1167             issue.addFixVersion(&quot;12-open&quot;);</span>
<span class="line-removed">1168             issue.addFixVersion(&quot;tbd13&quot;);</span>
<span class="line-removed">1169             issue.addFixVersion(&quot;unknown&quot;);</span>
1170 
1171             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1172             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1173             TestBotRunner.runPeriodicItems(notifyBot);
1174 
1175             // The fixVersion should have been updated
<span class="line-modified">1176             var fixVersions = issue.fixVersions();</span>
<span class="line-removed">1177             assertEquals(1, fixVersions.size());</span>
<span class="line-removed">1178             assertEquals(&quot;12u14&quot;, fixVersions.get(0));</span>
1179         }
1180     }
1181 
1182     @Test
1183     void testIssueBackport(TestInfo testInfo) throws IOException {
1184         try (var credentials = new HostCredentials(testInfo);
1185              var tempFolder = new TemporaryDirectory()) {
1186             var repo = credentials.getHostedRepository();
1187             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1188             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1189             credentials.commitLock(localRepo);
1190             localRepo.pushAll(repo.url());
1191 
1192             var tagStorage = createTagStorage(repo);
1193             var branchStorage = createBranchStorage(repo);
1194             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1195             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1196 
1197             var issueProject = credentials.getIssueProject();
1198             var updater = new IssueUpdater(issueProject, false, null, false, null, true, &quot;12.0.2&quot;);
1199             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1200                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1201 
1202             // Initialize history
1203             TestBotRunner.runPeriodicItems(notifyBot);
1204 
1205             // Create an issue and commit a fix
<span class="line-modified">1206             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;type&quot;, &quot;Enhancement&quot;));</span>
<span class="line-modified">1207             issue.addFixVersion(&quot;13.0.1&quot;);</span>

1208 
1209             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1210             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1211             TestBotRunner.runPeriodicItems(notifyBot);
1212 
1213             // The fixVersion should not have been updated
1214             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
<span class="line-modified">1215             var fixVersions = updatedIssue.fixVersions();</span>
<span class="line-removed">1216             assertEquals(1, fixVersions.size());</span>
<span class="line-removed">1217             assertEquals(&quot;13.0.1&quot;, fixVersions.get(0));</span>
1218 
1219             // There should be a link
1220             var links = updatedIssue.links();
1221             assertEquals(1, links.size());
1222             var link = links.get(0);
1223             var backport = link.issue().orElseThrow();
1224 
1225             // The backport issue should have a correct fixVersion
<span class="line-modified">1226             var backportFixVersions = backport.fixVersions();</span>
<span class="line-modified">1227             assertEquals(1, backportFixVersions.size());</span>
<span class="line-modified">1228             assertEquals(&quot;12.0.2&quot;, backportFixVersions.get(0));</span>
<span class="line-modified">1229             assertEquals(&quot;Backport&quot;, backport.properties().get(&quot;type&quot;));</span>
1230         }
1231     }
1232 
1233     @Test
1234     void testPullRequest(TestInfo testInfo) throws IOException {
1235         try (var credentials = new HostCredentials(testInfo);
1236              var tempFolder = new TemporaryDirectory()) {
1237             var repo = credentials.getHostedRepository();
1238             var reviewer = credentials.getHostedRepository();
1239             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1240             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1241             credentials.commitLock(localRepo);
1242             localRepo.pushAll(repo.url());
1243 
1244             var tagStorage = createTagStorage(repo);
1245             var branchStorage = createBranchStorage(repo);
1246             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1247             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1248 
1249             var issueProject = credentials.getIssueProject();
1250             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
1251             var updater = new IssueUpdater(issueProject, true, reviewIcon, false, null, false, null);
1252             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1253                                           prIssuesStorage, List.of(), List.of(updater), Set.of(&quot;rfr&quot;),
1254                                           Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)));
1255 
1256             // Initialize history
1257             TestBotRunner.runPeriodicItems(notifyBot);
1258 
1259             // Create an issue and a pull request to fix it
<span class="line-modified">1260             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;type&quot;, &quot;Enhancement&quot;));</span>
1261             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
1262             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1263             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
1264             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1265             TestBotRunner.runPeriodicItems(notifyBot);
1266 
1267             // The issue should not yet contain a link to the PR
1268             var links = issue.links();
1269             assertEquals(0, links.size());
1270 
1271             // Just a label isn&#39;t enough
1272             pr.addLabel(&quot;rfr&quot;);
1273             TestBotRunner.runPeriodicItems(notifyBot);
1274             links = issue.links();
1275             assertEquals(0, links.size());
1276 
1277             // Neither is just a comment
1278             pr.removeLabel(&quot;rfr&quot;);
1279             var reviewPr = reviewer.pullRequest(pr.id());
1280             reviewPr.addComment(&quot;This is now ready&quot;);
1281             TestBotRunner.runPeriodicItems(notifyBot);
1282             links = issue.links();
1283             assertEquals(0, links.size());
1284 
1285             // Both are needed
1286             pr.addLabel(&quot;rfr&quot;);
1287             TestBotRunner.runPeriodicItems(notifyBot);
1288 
1289             // The issue should now contain a link to the PR
1290             links = issue.links();
1291             assertEquals(1, links.size());
1292             assertEquals(pr.webUrl(), links.get(0).uri().orElseThrow());
1293             assertEquals(reviewIcon, links.get(0).iconUrl().orElseThrow());
1294 
1295             // Add another issue
<span class="line-modified">1296             var issue2 = issueProject.createIssue(&quot;This is another issue&quot;, List.of(&quot;Yes indeed&quot;), Map.of(&quot;type&quot;, &quot;Enhancement&quot;));</span>
1297             pr.setBody(&quot;\n\n## Issues\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue\n[&quot; + issue2.id() +
1298                                &quot;](http://www.test2.test/): The second issue&quot;);
1299             TestBotRunner.runPeriodicItems(notifyBot);
1300 
1301             // Both issues should contain a link to the PR
1302             var links1 = issue.links();
1303             assertEquals(1, links1.size());
1304             assertEquals(pr.webUrl(), links1.get(0).uri().orElseThrow());
1305             var links2 = issue2.links();
1306             assertEquals(1, links2.size());
1307             assertEquals(pr.webUrl(), links2.get(0).uri().orElseThrow());
1308 
1309             // Drop the first one
1310             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue2.id() + &quot;](http://www.test2.test/): That other issue&quot;);
1311             TestBotRunner.runPeriodicItems(notifyBot);
1312 
1313             // Only the second issue should now contain a link to the PR
1314             links1 = issue.links();
1315             assertEquals(0, links1.size());
1316             links2 = issue2.links();
</pre>
<hr />
<pre>
1328             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1329             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1330             credentials.commitLock(localRepo);
1331             localRepo.pushAll(repo.url());
1332 
1333             var tagStorage = createTagStorage(repo);
1334             var branchStorage = createBranchStorage(repo);
1335             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1336             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1337 
1338             var issueProject = credentials.getIssueProject();
1339             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
1340             var updater = new IssueUpdater(issueProject, false, reviewIcon, false, null, false,null);
1341             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1342                                           prIssuesStorage, List.of(), List.of(updater), Set.of(&quot;rfr&quot;),
1343                                           Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)));
1344             // Initialize history
1345             TestBotRunner.runPeriodicItems(notifyBot);
1346 
1347             // Create an issue and a pull request to fix it
<span class="line-modified">1348             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;type&quot;, &quot;Enhancement&quot;));</span>
1349             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
1350             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1351             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
1352             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1353             TestBotRunner.runPeriodicItems(notifyBot);
1354 
1355             // Add required label
1356             pr.addLabel(&quot;rfr&quot;);
1357             TestBotRunner.runPeriodicItems(notifyBot);
1358 
1359             // And the required comment
1360             var reviewPr = reviewer.pullRequest(pr.id());
1361             reviewPr.addComment(&quot;This is now ready&quot;);
1362             TestBotRunner.runPeriodicItems(notifyBot);
1363 
1364             // The issue should still not contain a link to the PR
1365             var links = issue.links();
1366             assertEquals(0, links.size());
1367         }
1368     }
</pre>
</td>
<td>
<hr />
<pre>
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.notify;
  24 
  25 import org.openjdk.skara.email.*;
  26 import org.openjdk.skara.forge.HostedRepository;
<span class="line-added">  27 import org.openjdk.skara.issuetracker.Issue;</span>
  28 import org.openjdk.skara.json.*;
  29 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  30 import org.openjdk.skara.storage.StorageBuilder;
  31 import org.openjdk.skara.test.*;
  32 import org.openjdk.skara.vcs.Tag;
  33 
  34 import org.junit.jupiter.api.*;
  35 
  36 import java.io.IOException;
  37 import java.net.URI;
  38 import java.nio.charset.StandardCharsets;
  39 import java.nio.file.*;
  40 import java.time.Duration;
  41 import java.util.*;
  42 import java.util.regex.Pattern;
  43 import java.util.stream.Collectors;
  44 
  45 import static org.junit.jupiter.api.Assertions.*;
  46 
  47 class UpdaterTests {
</pre>
<hr />
<pre>
  50                     .filter(path -&gt; path.toString().endsWith(&quot;.json&quot;))
  51                     .filter(path -&gt; path.toString().contains(partialName))
  52                     .collect(Collectors.toList());
  53     }
  54 
  55     private StorageBuilder&lt;Tag&gt; createTagStorage(HostedRepository repository) {
  56         return new StorageBuilder&lt;Tag&gt;(&quot;tags.txt&quot;)
  57                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated tags&quot;);
  58     }
  59 
  60     private StorageBuilder&lt;ResolvedBranch&gt; createBranchStorage(HostedRepository repository) {
  61         return new StorageBuilder&lt;ResolvedBranch&gt;(&quot;branches.txt&quot;)
  62                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated branches&quot;);
  63     }
  64 
  65     private StorageBuilder&lt;PullRequestIssues&gt; createPullRequestIssuesStorage(HostedRepository repository) {
  66         return new StorageBuilder&lt;PullRequestIssues&gt;(&quot;prissues.txt&quot;)
  67                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated prissues&quot;);
  68     }
  69 
<span class="line-added">  70     private Set&lt;String&gt; fixVersions(Issue issue) {</span>
<span class="line-added">  71         if (!issue.properties().containsKey(&quot;fixVersions&quot;)) {</span>
<span class="line-added">  72             return Set.of();</span>
<span class="line-added">  73         }</span>
<span class="line-added">  74         return issue.properties().get(&quot;fixVersions&quot;).stream()</span>
<span class="line-added">  75                     .map(JSONValue::asString)</span>
<span class="line-added">  76                     .collect(Collectors.toSet());</span>
<span class="line-added">  77     }</span>
<span class="line-added">  78 </span>
  79     @Test
  80     void testJsonUpdaterBranch(TestInfo testInfo) throws IOException {
  81         try (var credentials = new HostCredentials(testInfo);
  82              var tempFolder = new TemporaryDirectory()) {
  83             var repo = credentials.getHostedRepository();
  84             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
  85             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
  86             credentials.commitLock(localRepo);
  87             localRepo.pushAll(repo.url());
  88 
  89             var tagStorage = createTagStorage(repo);
  90             var branchStorage = createBranchStorage(repo);
  91             var prIssuesStorage = createPullRequestIssuesStorage(repo);
  92             var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
  93             Files.createDirectory(jsonFolder);
  94             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
  95 
  96             var updater = new JsonUpdater(jsonFolder, &quot;12&quot;, &quot;team&quot;);
  97             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
  98                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
</pre>
<hr />
<pre>
 908             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 909             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 910             credentials.commitLock(localRepo);
 911             localRepo.pushAll(repo.url());
 912 
 913             var tagStorage = createTagStorage(repo);
 914             var branchStorage = createBranchStorage(repo);
 915             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 916             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 917 
 918             var issueProject = credentials.getIssueProject();
 919             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
 920             var updater = new IssueUpdater(issueProject, false, null, true, commitIcon, true, null);
 921             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 922                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 923 
 924             // Initialize history
 925             TestBotRunner.runPeriodicItems(notifyBot);
 926 
 927             // Create an issue and commit a fix
<span class="line-modified"> 928             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
 929             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
 930             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 931             TestBotRunner.runPeriodicItems(notifyBot);
 932 
 933             // The changeset should be reflected in a comment
 934             var comments = issue.comments();
 935             assertEquals(1, comments.size());
 936             var comment = comments.get(0);
 937             assertTrue(comment.body().contains(editHash.abbreviate()));
 938 
 939             // And in a link
 940             var links = issue.links();
 941             assertEquals(1, links.size());
 942             var link = links.get(0);
 943             assertEquals(commitIcon, link.iconUrl().orElseThrow());
 944             assertEquals(&quot;Commit&quot;, link.title().orElseThrow());
 945             assertEquals(repo.webUrl(editHash), link.uri().orElseThrow());
 946 
 947             // As well as a fixVersion
<span class="line-modified"> 948             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(issue));</span>



 949         }
 950     }
 951 
 952     @Test
 953     void testIssueNoVersion(TestInfo testInfo) throws IOException {
 954         try (var credentials = new HostCredentials(testInfo);
 955              var tempFolder = new TemporaryDirectory()) {
 956             var repo = credentials.getHostedRepository();
 957             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 958             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
 959             credentials.commitLock(localRepo);
 960             localRepo.pushAll(repo.url());
 961 
 962             var tagStorage = createTagStorage(repo);
 963             var branchStorage = createBranchStorage(repo);
 964             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 965             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 966 
 967             var issueProject = credentials.getIssueProject();
 968             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
 969             var updater = new IssueUpdater(issueProject, false, null, true, commitIcon, true, null);
 970             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 971                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 972 
 973             // Initialize history
 974             TestBotRunner.runPeriodicItems(notifyBot);
 975 
 976             // Create an issue and commit a fix
<span class="line-modified"> 977             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
 978             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
 979             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 980             TestBotRunner.runPeriodicItems(notifyBot);
 981 
 982             // The changeset should be reflected in a comment
 983             var comments = issue.comments();
 984             assertEquals(1, comments.size());
 985             var comment = comments.get(0);
 986             assertTrue(comment.body().contains(editHash.abbreviate()));
 987 
 988             // But not in the fixVersion
<span class="line-modified"> 989             assertEquals(Set.of(), fixVersions(issue));</span>

 990         }
 991     }
 992 
 993     @Test
 994     void testIssueConfiguredVersionNoCommit(TestInfo testInfo) throws IOException {
 995         try (var credentials = new HostCredentials(testInfo);
 996              var tempFolder = new TemporaryDirectory()) {
 997             var repo = credentials.getHostedRepository();
 998             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 999             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1000             credentials.commitLock(localRepo);
1001             localRepo.pushAll(repo.url());
1002 
1003             var tagStorage = createTagStorage(repo);
1004             var branchStorage = createBranchStorage(repo);
1005             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1006             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1007 
1008             var issueProject = credentials.getIssueProject();
1009             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
1010             var updater = new IssueUpdater(issueProject, false, null, false, commitIcon, true,&quot;2.0&quot;);
1011             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1012                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1013 
1014             // Initialize history
1015             TestBotRunner.runPeriodicItems(notifyBot);
1016 
1017             // Create an issue and commit a fix
<span class="line-modified">1018             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
1019             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1020             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1021             TestBotRunner.runPeriodicItems(notifyBot);
1022 
1023             // The changeset should not reflected in a comment
1024             var comments = issue.comments();
1025             assertEquals(1, comments.size());
1026             var comment = comments.get(0);
1027             assertTrue(comment.body().contains(editHash.abbreviate()));
1028 
1029             // As well as a fixVersion - but not the one from the repo
<span class="line-modified">1030             assertEquals(Set.of(&quot;2.0&quot;), fixVersions(issue));</span>



1031 
1032             // And no commit link
1033             var links = issue.links();
1034             assertEquals(0, links.size());
1035         }
1036     }
1037 
1038     @Test
1039     void testIssueIdempotence(TestInfo testInfo) throws IOException {
1040         try (var credentials = new HostCredentials(testInfo);
1041              var tempFolder = new TemporaryDirectory()) {
1042             var repo = credentials.getHostedRepository();
1043             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1044             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1045             credentials.commitLock(localRepo);
1046             localRepo.pushAll(repo.url());
1047 
1048             var tagStorage = createTagStorage(repo);
1049             var branchStorage = createBranchStorage(repo);
1050             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1051             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1052 
1053             var issueProject = credentials.getIssueProject();
1054             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
1055             var updater = new IssueUpdater(issueProject, false, null, true, commitIcon, true, null);
1056             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1057                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1058 
1059             // Initialize history
1060             TestBotRunner.runPeriodicItems(notifyBot);
1061 
1062             // Save the state
1063             var historyState = localRepo.fetch(repo.url(), &quot;history&quot;);
1064 
1065             // Create an issue and commit a fix
<span class="line-modified">1066             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
1067             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1068             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1069             TestBotRunner.runPeriodicItems(notifyBot);
1070 
1071             // The changeset should be reflected in a comment
1072             var comments = issue.comments();
1073             assertEquals(1, comments.size());
1074             var comment = comments.get(0);
1075             assertTrue(comment.body().contains(editHash.abbreviate()));
1076 
1077             // And in a link
1078             var links = issue.links();
1079             assertEquals(1, links.size());
1080             var link = links.get(0);
1081             assertEquals(commitIcon, link.iconUrl().orElseThrow());
1082             assertEquals(&quot;Commit&quot;, link.title().orElseThrow());
1083             assertEquals(repo.webUrl(editHash), link.uri().orElseThrow());
1084 
1085             // As well as a fixVersion
<span class="line-modified">1086             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(issue));</span>



1087 
1088             // Wipe the history
1089             localRepo.push(historyState, repo.url(), &quot;history&quot;, true);
1090 
1091             // Run it again
1092             TestBotRunner.runPeriodicItems(notifyBot);
1093 
1094             // There should be no new comments, links or fixVersions
1095             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1096             assertEquals(1, updatedIssue.comments().size());
1097             assertEquals(1, updatedIssue.links().size());
<span class="line-modified">1098             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(updatedIssue));</span>
1099         }
1100     }
1101 
1102     @Test
1103     void testIssuePoolVersion(TestInfo testInfo) throws IOException {
1104         try (var credentials = new HostCredentials(testInfo);
1105              var tempFolder = new TemporaryDirectory()) {
1106             var repo = credentials.getHostedRepository();
1107             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1108             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1109             credentials.commitLock(localRepo);
1110             localRepo.pushAll(repo.url());
1111 
1112             var tagStorage = createTagStorage(repo);
1113             var branchStorage = createBranchStorage(repo);
1114             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1115             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1116 
1117             var issueProject = credentials.getIssueProject();
1118             var updater = new IssueUpdater(issueProject, false, null, false, null, true, &quot;12u14&quot;);
1119             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1120                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1121 
1122             // Initialize history
1123             TestBotRunner.runPeriodicItems(notifyBot);
1124 
1125             // Create an issue and commit a fix
<span class="line-modified">1126             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
<span class="line-modified">1127             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));</span>


1128 
1129             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1130             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1131             TestBotRunner.runPeriodicItems(notifyBot);
1132 
1133             // The fixVersion should have been updated
<span class="line-modified">1134             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));</span>


1135         }
1136     }
1137 
1138     @Test
1139     void testIssuePoolOpenVersion(TestInfo testInfo) throws IOException {
1140         try (var credentials = new HostCredentials(testInfo);
1141              var tempFolder = new TemporaryDirectory()) {
1142             var repo = credentials.getHostedRepository();
1143             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1144             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1145             credentials.commitLock(localRepo);
1146             localRepo.pushAll(repo.url());
1147 
1148             var tagStorage = createTagStorage(repo);
1149             var branchStorage = createBranchStorage(repo);
1150             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1151             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1152 
1153             var issueProject = credentials.getIssueProject();
1154             var updater = new IssueUpdater(issueProject, false, null, false, null, true, &quot;12u14&quot;);
1155             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1156                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1157 
1158             // Initialize history
1159             TestBotRunner.runPeriodicItems(notifyBot);
1160 
1161             // Create an issue and commit a fix
<span class="line-modified">1162             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
<span class="line-modified">1163             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));</span>


1164 
1165             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1166             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1167             TestBotRunner.runPeriodicItems(notifyBot);
1168 
1169             // The fixVersion should have been updated
<span class="line-modified">1170             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));</span>


1171         }
1172     }
1173 
1174     @Test
1175     void testIssueBackport(TestInfo testInfo) throws IOException {
1176         try (var credentials = new HostCredentials(testInfo);
1177              var tempFolder = new TemporaryDirectory()) {
1178             var repo = credentials.getHostedRepository();
1179             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1180             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1181             credentials.commitLock(localRepo);
1182             localRepo.pushAll(repo.url());
1183 
1184             var tagStorage = createTagStorage(repo);
1185             var branchStorage = createBranchStorage(repo);
1186             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1187             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1188 
1189             var issueProject = credentials.getIssueProject();
1190             var updater = new IssueUpdater(issueProject, false, null, false, null, true, &quot;12.0.2&quot;);
1191             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1192                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1193 
1194             // Initialize history
1195             TestBotRunner.runPeriodicItems(notifyBot);
1196 
1197             // Create an issue and commit a fix
<span class="line-modified">1198             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
<span class="line-modified">1199             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;13.0.1&quot;));</span>
<span class="line-added">1200             issue.setProperty(&quot;priority&quot;, JSON.of(&quot;1&quot;));</span>
1201 
1202             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1203             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1204             TestBotRunner.runPeriodicItems(notifyBot);
1205 
1206             // The fixVersion should not have been updated
1207             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
<span class="line-modified">1208             assertEquals(Set.of(&quot;13.0.1&quot;), fixVersions(updatedIssue));</span>


1209 
1210             // There should be a link
1211             var links = updatedIssue.links();
1212             assertEquals(1, links.size());
1213             var link = links.get(0);
1214             var backport = link.issue().orElseThrow();
1215 
1216             // The backport issue should have a correct fixVersion
<span class="line-modified">1217             assertEquals(Set.of(&quot;12.0.2&quot;), fixVersions(backport));</span>
<span class="line-modified">1218 </span>
<span class="line-modified">1219             // Custom properties should also propagate</span>
<span class="line-modified">1220             assertEquals(&quot;1&quot;, backport.properties().get(&quot;priority&quot;).asString());</span>
1221         }
1222     }
1223 
1224     @Test
1225     void testPullRequest(TestInfo testInfo) throws IOException {
1226         try (var credentials = new HostCredentials(testInfo);
1227              var tempFolder = new TemporaryDirectory()) {
1228             var repo = credentials.getHostedRepository();
1229             var reviewer = credentials.getHostedRepository();
1230             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1231             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1232             credentials.commitLock(localRepo);
1233             localRepo.pushAll(repo.url());
1234 
1235             var tagStorage = createTagStorage(repo);
1236             var branchStorage = createBranchStorage(repo);
1237             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1238             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1239 
1240             var issueProject = credentials.getIssueProject();
1241             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
1242             var updater = new IssueUpdater(issueProject, true, reviewIcon, false, null, false, null);
1243             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1244                                           prIssuesStorage, List.of(), List.of(updater), Set.of(&quot;rfr&quot;),
1245                                           Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)));
1246 
1247             // Initialize history
1248             TestBotRunner.runPeriodicItems(notifyBot);
1249 
1250             // Create an issue and a pull request to fix it
<span class="line-modified">1251             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
1252             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
1253             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1254             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
1255             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1256             TestBotRunner.runPeriodicItems(notifyBot);
1257 
1258             // The issue should not yet contain a link to the PR
1259             var links = issue.links();
1260             assertEquals(0, links.size());
1261 
1262             // Just a label isn&#39;t enough
1263             pr.addLabel(&quot;rfr&quot;);
1264             TestBotRunner.runPeriodicItems(notifyBot);
1265             links = issue.links();
1266             assertEquals(0, links.size());
1267 
1268             // Neither is just a comment
1269             pr.removeLabel(&quot;rfr&quot;);
1270             var reviewPr = reviewer.pullRequest(pr.id());
1271             reviewPr.addComment(&quot;This is now ready&quot;);
1272             TestBotRunner.runPeriodicItems(notifyBot);
1273             links = issue.links();
1274             assertEquals(0, links.size());
1275 
1276             // Both are needed
1277             pr.addLabel(&quot;rfr&quot;);
1278             TestBotRunner.runPeriodicItems(notifyBot);
1279 
1280             // The issue should now contain a link to the PR
1281             links = issue.links();
1282             assertEquals(1, links.size());
1283             assertEquals(pr.webUrl(), links.get(0).uri().orElseThrow());
1284             assertEquals(reviewIcon, links.get(0).iconUrl().orElseThrow());
1285 
1286             // Add another issue
<span class="line-modified">1287             var issue2 = issueProject.createIssue(&quot;This is another issue&quot;, List.of(&quot;Yes indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
1288             pr.setBody(&quot;\n\n## Issues\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue\n[&quot; + issue2.id() +
1289                                &quot;](http://www.test2.test/): The second issue&quot;);
1290             TestBotRunner.runPeriodicItems(notifyBot);
1291 
1292             // Both issues should contain a link to the PR
1293             var links1 = issue.links();
1294             assertEquals(1, links1.size());
1295             assertEquals(pr.webUrl(), links1.get(0).uri().orElseThrow());
1296             var links2 = issue2.links();
1297             assertEquals(1, links2.size());
1298             assertEquals(pr.webUrl(), links2.get(0).uri().orElseThrow());
1299 
1300             // Drop the first one
1301             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue2.id() + &quot;](http://www.test2.test/): That other issue&quot;);
1302             TestBotRunner.runPeriodicItems(notifyBot);
1303 
1304             // Only the second issue should now contain a link to the PR
1305             links1 = issue.links();
1306             assertEquals(0, links1.size());
1307             links2 = issue2.links();
</pre>
<hr />
<pre>
1319             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1320             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1321             credentials.commitLock(localRepo);
1322             localRepo.pushAll(repo.url());
1323 
1324             var tagStorage = createTagStorage(repo);
1325             var branchStorage = createBranchStorage(repo);
1326             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1327             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1328 
1329             var issueProject = credentials.getIssueProject();
1330             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
1331             var updater = new IssueUpdater(issueProject, false, reviewIcon, false, null, false,null);
1332             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1333                                           prIssuesStorage, List.of(), List.of(updater), Set.of(&quot;rfr&quot;),
1334                                           Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)));
1335             // Initialize history
1336             TestBotRunner.runPeriodicItems(notifyBot);
1337 
1338             // Create an issue and a pull request to fix it
<span class="line-modified">1339             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
1340             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
1341             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1342             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
1343             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1344             TestBotRunner.runPeriodicItems(notifyBot);
1345 
1346             // Add required label
1347             pr.addLabel(&quot;rfr&quot;);
1348             TestBotRunner.runPeriodicItems(notifyBot);
1349 
1350             // And the required comment
1351             var reviewPr = reviewer.pullRequest(pr.id());
1352             reviewPr.addComment(&quot;This is now ready&quot;);
1353             TestBotRunner.runPeriodicItems(notifyBot);
1354 
1355             // The issue should still not contain a link to the PR
1356             var links = issue.links();
1357             assertEquals(0, links.size());
1358         }
1359     }
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/notify/IssueUpdater.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../tester/src/test/java/org/openjdk/skara/bots/tester/InMemoryPullRequest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>