<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff bots/tester/src/main/java/org/openjdk/skara/bots/tester/TestBot.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/tester/src/main/java/org/openjdk/skara/bots/tester/TestBot.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -31,19 +31,29 @@</span>
  import java.nio.file.*;
  import java.util.*;
  import java.util.stream.Collectors;
  
  public class TestBot implements Bot {
<span class="udiff-line-added">+     private static class Observation {</span>
<span class="udiff-line-added">+         Job.State nextToLast;</span>
<span class="udiff-line-added">+         Job.State last;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         Observation(Job.State nextToLast, Job.State last) {</span>
<span class="udiff-line-added">+             this.nextToLast = nextToLast;</span>
<span class="udiff-line-added">+             this.last = last;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      private final ContinuousIntegration ci;
      private final String approversGroupId;
      private final List&lt;String&gt; availableJobs;
      private final List&lt;String&gt; defaultJobs;
      private final String name;
      private final Path storage;
      private final HostedRepository repo;
      private final PullRequestUpdateCache cache;
<span class="udiff-line-modified-removed">-     private final Map&lt;String, Job.State&gt; states;</span>
<span class="udiff-line-modified-added">+     private final Map&lt;String, Observation&gt; states;</span>
  
      TestBot(ContinuousIntegration ci,
              String approversGroupId,
              List&lt;String&gt; availableJobs,
              List&lt;String&gt; defaultJobs,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -83,16 +93,22 @@</span>
                      if (!jobs.isEmpty()) {
                          var shouldUpdate = false;
                          for (var job : jobs) {
                              if (!states.containsKey(job.id())) {
                                  shouldUpdate = true;
<span class="udiff-line-added">+                                 states.put(job.id(), new Observation(job.state(), job.state()));</span>
                              } else {
<span class="udiff-line-modified-removed">-                                 if (!states.get(job.id()).equals(Job.State.COMPLETED)) {</span>
<span class="udiff-line-modified-added">+                                 var observed = states.get(job.id());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                                 if (!observed.last.equals(Job.State.COMPLETED) ||</span>
<span class="udiff-line-added">+                                     !observed.nextToLast.equals(Job.State.COMPLETED)) {</span>
                                      shouldUpdate = true;
                                  }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                                 observed.nextToLast = observed.last;</span>
<span class="udiff-line-added">+                                 observed.last = job.state();</span>
                              }
<span class="udiff-line-removed">-                             states.put(job.id(), job.state());</span>
                          }
                          if (shouldUpdate) {
                              ret.add(new TestWorkItem(ci,
                                                       approversGroupId,
                                                       availableJobs,
</pre>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>