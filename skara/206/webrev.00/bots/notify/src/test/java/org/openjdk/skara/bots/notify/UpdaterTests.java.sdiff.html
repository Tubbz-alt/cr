<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../../../cli/src/main/java/org/openjdk/skara/bots/cli/BotLauncher.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
643                 assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
644                 assertTrue(email.hasHeader(&quot;extra2&quot;));
645                 assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
646             }
647         }
648     }
649 
650     @Test
651     void testMailingListBranch(TestInfo testInfo) throws IOException {
652         try (var listServer = new TestMailmanServer();
653              var credentials = new HostCredentials(testInfo);
654              var tempFolder = new TemporaryDirectory()) {
655             var repo = credentials.getHostedRepository();
656             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
657             var localRepo = CheckableRepository.init(repoFolder, repo.getRepositoryType());
658             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
659             credentials.commitLock(localRepo);
660             localRepo.pushAll(repo.getUrl());
661 
662             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
<span class="line-modified">663             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());</span>
664             var mailmanList = mailmanServer.getList(listAddress.address());
665             var tagStorage = createTagStorage(repo);
666             var branchStorage = createBranchStorage(repo);
667             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
668 
669             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
670             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null, false, MailingListUpdater.Mode.ALL,
671                                                  Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;));
672             var notifyBot = new JNotifyBot(repo, storageFolder, Pattern.compile(&quot;master|newbranch.&quot;), tagStorage, branchStorage, List.of(updater));
673 
674             // No mail should be sent on the first run as there is no history
675             TestBotRunner.runPeriodicItems(notifyBot);
676             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
677 
678             CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;12345678: Some fixes&quot;);
679             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
680             localRepo.push(editHash, repo.getUrl(), &quot;newbranch1&quot;);
681             TestBotRunner.runPeriodicItems(notifyBot);
682             listServer.processIncoming();
683 
</pre>
</td>
<td>
<hr />
<pre>
643                 assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
644                 assertTrue(email.hasHeader(&quot;extra2&quot;));
645                 assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
646             }
647         }
648     }
649 
650     @Test
651     void testMailingListBranch(TestInfo testInfo) throws IOException {
652         try (var listServer = new TestMailmanServer();
653              var credentials = new HostCredentials(testInfo);
654              var tempFolder = new TemporaryDirectory()) {
655             var repo = credentials.getHostedRepository();
656             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
657             var localRepo = CheckableRepository.init(repoFolder, repo.getRepositoryType());
658             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
659             credentials.commitLock(localRepo);
660             localRepo.pushAll(repo.getUrl());
661 
662             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
<span class="line-modified">663             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);</span>
664             var mailmanList = mailmanServer.getList(listAddress.address());
665             var tagStorage = createTagStorage(repo);
666             var branchStorage = createBranchStorage(repo);
667             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
668 
669             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
670             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null, false, MailingListUpdater.Mode.ALL,
671                                                  Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;));
672             var notifyBot = new JNotifyBot(repo, storageFolder, Pattern.compile(&quot;master|newbranch.&quot;), tagStorage, branchStorage, List.of(updater));
673 
674             // No mail should be sent on the first run as there is no history
675             TestBotRunner.runPeriodicItems(notifyBot);
676             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
677 
678             CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;12345678: Some fixes&quot;);
679             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
680             localRepo.push(editHash, repo.getUrl(), &quot;newbranch1&quot;);
681             TestBotRunner.runPeriodicItems(notifyBot);
682             listServer.processIncoming();
683 
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../../../cli/src/main/java/org/openjdk/skara/bots/cli/BotLauncher.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>