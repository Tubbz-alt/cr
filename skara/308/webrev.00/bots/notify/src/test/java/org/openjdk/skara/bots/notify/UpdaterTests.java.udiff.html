<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/notify/MailingListUpdater.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -31,10 +31,11 @@</span>
  import org.openjdk.skara.vcs.Tag;
  
  import org.junit.jupiter.api.*;
  
  import java.io.IOException;
<span class="udiff-line-added">+ import java.net.URI;</span>
  import java.nio.charset.StandardCharsets;
  import java.nio.file.*;
  import java.time.Duration;
  import java.util.*;
  import java.util.regex.Pattern;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -48,18 +49,23 @@</span>
                      .filter(path -&gt; path.toString().endsWith(&quot;.json&quot;))
                      .filter(path -&gt; path.toString().contains(partialName))
                      .collect(Collectors.toList());
      }
  
<span class="udiff-line-modified-removed">-     private StorageBuilder&lt;Tag&gt; createTagStorage(HostedRepository repository) throws IOException {</span>
<span class="udiff-line-modified-added">+     private StorageBuilder&lt;Tag&gt; createTagStorage(HostedRepository repository) {</span>
          return new StorageBuilder&lt;Tag&gt;(&quot;tags.txt&quot;)
<span class="udiff-line-modified-removed">-                 .remoteRepository(repository, &quot;refs/heads/history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated tags&quot;);</span>
<span class="udiff-line-modified-added">+                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated tags&quot;);</span>
      }
  
<span class="udiff-line-modified-removed">-     private StorageBuilder&lt;ResolvedBranch&gt; createBranchStorage(HostedRepository repository) throws IOException {</span>
<span class="udiff-line-modified-added">+     private StorageBuilder&lt;ResolvedBranch&gt; createBranchStorage(HostedRepository repository) {</span>
          return new StorageBuilder&lt;ResolvedBranch&gt;(&quot;branches.txt&quot;)
<span class="udiff-line-modified-removed">-                 .remoteRepository(repository, &quot;refs/heads/history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated branches&quot;);</span>
<span class="udiff-line-modified-added">+                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated branches&quot;);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private StorageBuilder&lt;PullRequestIssues&gt; createPullRequestIssuesStorage(HostedRepository repository) {</span>
<span class="udiff-line-added">+         return new StorageBuilder&lt;PullRequestIssues&gt;(&quot;prissues.txt&quot;)</span>
<span class="udiff-line-added">+                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated prissues&quot;);</span>
      }
  
      @Test
      void testJsonUpdaterBranch(TestInfo testInfo) throws IOException {
          try (var credentials = new HostCredentials(testInfo);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -70,16 +76,18 @@</span>
              credentials.commitLock(localRepo);
              localRepo.pushAll(repo.url());
  
              var tagStorage = createTagStorage(repo);
              var branchStorage = createBranchStorage(repo);
<span class="udiff-line-added">+             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
              var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
              Files.createDirectory(jsonFolder);
              var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
  
              var updater = new JsonUpdater(jsonFolder, &quot;12&quot;, &quot;team&quot;);
<span class="udiff-line-modified-removed">-             var notifyBot = new JNotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage, List.of(updater));</span>
<span class="udiff-line-modified-added">+             var notifyBot = new JNotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="udiff-line-added">+                                            prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>
  
              TestBotRunner.runPeriodicItems(notifyBot);
              assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));
  
              var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;One more line&quot;, &quot;12345678: Fixes&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -109,16 +117,18 @@</span>
              localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
              localRepo.pushAll(repo.url());
  
              var tagStorage = createTagStorage(repo);
              var branchStorage = createBranchStorage(repo);
<span class="udiff-line-added">+             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
              var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
              Files.createDirectory(jsonFolder);
              var storageFolder =tempFolder.path().resolve(&quot;storage&quot;);
  
              var updater = new JsonUpdater(jsonFolder, &quot;12&quot;, &quot;team&quot;);
<span class="udiff-line-modified-removed">-             var notifyBot = new JNotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage, List.of(updater));</span>
<span class="udiff-line-modified-added">+             var notifyBot = new JNotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="udiff-line-added">+                                            prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>
  
              TestBotRunner.runPeriodicItems(notifyBot);
              assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));
  
              var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -180,16 +190,18 @@</span>
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
              var mailmanList = mailmanServer.getList(listAddress.address());
              var tagStorage = createTagStorage(repo);
              var branchStorage = createBranchStorage(repo);
<span class="udiff-line-added">+             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
              var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
  
              var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
              var updater = new MailingListUpdater(mailmanList, listAddress, sender, null, false, MailingListUpdater.Mode.ALL,
                                                   Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;), Pattern.compile(&quot;none&quot;));
<span class="udiff-line-modified-removed">-             var notifyBot = new JNotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage, List.of(updater));</span>
<span class="udiff-line-modified-added">+             var notifyBot = new JNotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="udiff-line-added">+                                            prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>
  
              // No mail should be sent on the first run as there is no history
              TestBotRunner.runPeriodicItems(notifyBot);
              assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -231,16 +243,18 @@</span>
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
              var mailmanList = mailmanServer.getList(listAddress.address());
              var tagStorage = createTagStorage(repo);
              var branchStorage = createBranchStorage(repo);
<span class="udiff-line-added">+             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
              var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
  
              var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
              var updater = new MailingListUpdater(mailmanList, listAddress, sender, null, false,
                                                   MailingListUpdater.Mode.ALL, Map.of(), Pattern.compile(&quot;.*&quot;));
<span class="udiff-line-modified-removed">-             var notifyBot = new JNotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage, List.of(updater));</span>
<span class="udiff-line-modified-added">+             var notifyBot = new JNotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="udiff-line-added">+                                            prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>
  
              // No mail should be sent on the first run as there is no history
              TestBotRunner.runPeriodicItems(notifyBot);
              assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -284,16 +298,18 @@</span>
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
              var mailmanList = mailmanServer.getList(listAddress.address());
              var tagStorage = createTagStorage(repo);
              var branchStorage = createBranchStorage(repo);
<span class="udiff-line-added">+             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
              var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
  
              var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
              var updater = new MailingListUpdater(mailmanList, listAddress, sender, null, false,
                                                   MailingListUpdater.Mode.ALL, Map.of(), Pattern.compile(&quot;.*&quot;));
<span class="udiff-line-modified-removed">-             var notifyBot = new JNotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage, List.of(updater));</span>
<span class="udiff-line-modified-added">+             var notifyBot = new JNotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="udiff-line-added">+                                            prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>
  
              // No mail should be sent on the first run as there is no history
              TestBotRunner.runPeriodicItems(notifyBot);
              assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -333,17 +349,19 @@</span>
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
              var mailmanList = mailmanServer.getList(listAddress.address());
              var tagStorage = createTagStorage(repo);
              var branchStorage = createBranchStorage(repo);
<span class="udiff-line-added">+             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
              var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
  
              var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
              var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);
              var updater = new MailingListUpdater(mailmanList, listAddress, sender, author, true,
                                                   MailingListUpdater.Mode.ALL, Map.of(), Pattern.compile(&quot;.*&quot;));
<span class="udiff-line-modified-removed">-             var notifyBot = new JNotifyBot(repo, storageFolder, Pattern.compile(&quot;master|another&quot;), tagStorage, branchStorage, List.of(updater));</span>
<span class="udiff-line-modified-added">+             var notifyBot = new JNotifyBot(repo, storageFolder, Pattern.compile(&quot;master|another&quot;), tagStorage, branchStorage,</span>
<span class="udiff-line-added">+                                            prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>
  
              // No mail should be sent on the first run as there is no history
              TestBotRunner.runPeriodicItems(notifyBot);
              assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -406,18 +424,20 @@</span>
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
              var mailmanList = mailmanServer.getList(listAddress.address());
              var tagStorage = createTagStorage(repo);
              var branchStorage = createBranchStorage(repo);
<span class="udiff-line-added">+             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
              var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
  
              var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
              var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);
              var updater = new MailingListUpdater(mailmanList, listAddress, sender, author, false,
                                                   MailingListUpdater.Mode.PR_ONLY, Map.of(&quot;extra1&quot;, &quot;value1&quot;),
                                                   Pattern.compile(&quot;.*&quot;));
<span class="udiff-line-modified-removed">-             var notifyBot = new JNotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage, List.of(updater));</span>
<span class="udiff-line-modified-added">+             var notifyBot = new JNotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="udiff-line-added">+                                            prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>
  
              // No mail should be sent on the first run as there is no history
              TestBotRunner.runPeriodicItems(notifyBot);
              assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -485,16 +505,18 @@</span>
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
              var mailmanList = mailmanServer.getList(listAddress.address());
              var tagStorage = createTagStorage(repo);
              var branchStorage = createBranchStorage(repo);
<span class="udiff-line-added">+             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
              var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
  
              var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
              var updater = new MailingListUpdater(mailmanList, listAddress, sender, null, false,
                                                   MailingListUpdater.Mode.PR, Map.of(), Pattern.compile(&quot;.*&quot;));
<span class="udiff-line-modified-removed">-             var notifyBot = new JNotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage, List.of(updater));</span>
<span class="udiff-line-modified-added">+             var notifyBot = new JNotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="udiff-line-added">+                                            prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>
  
              // No mail should be sent on the first run as there is no history
              TestBotRunner.runPeriodicItems(notifyBot);
              assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -572,20 +594,21 @@</span>
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
              var mailmanList = mailmanServer.getList(listAddress.address());
              var tagStorage = createTagStorage(repo);
              var branchStorage = createBranchStorage(repo);
<span class="udiff-line-added">+             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
              var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
  
              var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
              var updater = new MailingListUpdater(mailmanList, listAddress, sender, null, false, MailingListUpdater.Mode.ALL,
                                                   Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;),
                                                   Pattern.compile(&quot;.*&quot;));
              var prOnlyUpdater = new MailingListUpdater(mailmanList, listAddress, sender, null, false,
                                                         MailingListUpdater.Mode.PR_ONLY, Map.of(), Pattern.compile(&quot;.*&quot;));
              var notifyBot = new JNotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
<span class="udiff-line-modified-removed">-                                            List.of(updater, prOnlyUpdater));</span>
<span class="udiff-line-modified-added">+                                            prIssuesStorage, List.of(updater, prOnlyUpdater), List.of(), Set.of(), Map.of());</span>
  
              // No mail should be sent on the first run as there is no history
              TestBotRunner.runPeriodicItems(notifyBot);
              assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -670,17 +693,19 @@</span>
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
              var mailmanList = mailmanServer.getList(listAddress.address());
              var tagStorage = createTagStorage(repo);
              var branchStorage = createBranchStorage(repo);
<span class="udiff-line-added">+             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
              var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
  
              var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
              var updater = new MailingListUpdater(mailmanList, listAddress, sender, null, false, MailingListUpdater.Mode.ALL,
                                                   Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;),
                                                   Pattern.compile(&quot;.*&quot;));
<span class="udiff-line-modified-removed">-             var notifyBot = new JNotifyBot(repo, storageFolder, Pattern.compile(&quot;master|newbranch.&quot;), tagStorage, branchStorage, List.of(updater));</span>
<span class="udiff-line-modified-added">+             var notifyBot = new JNotifyBot(repo, storageFolder, Pattern.compile(&quot;master|newbranch.&quot;), tagStorage, branchStorage,</span>
<span class="udiff-line-added">+                                            prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>
  
              // No mail should be sent on the first run as there is no history
              TestBotRunner.runPeriodicItems(notifyBot);
              assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -731,15 +756,17 @@</span>
              credentials.commitLock(localRepo);
              localRepo.pushAll(repo.url());
  
              var tagStorage = createTagStorage(repo);
              var branchStorage = createBranchStorage(repo);
<span class="udiff-line-added">+             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
              var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
  
              var issueProject = credentials.getIssueProject();
<span class="udiff-line-modified-removed">-             var updater = new IssueUpdater(issueProject);</span>
<span class="udiff-line-modified-removed">-             var notifyBot = new JNotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage, List.of(updater));</span>
<span class="udiff-line-modified-added">+             var updater = new IssueUpdater(issueProject, null);</span>
<span class="udiff-line-modified-added">+             var notifyBot = new JNotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="udiff-line-added">+                                            prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>
  
              // Initialize history
              TestBotRunner.runPeriodicItems(notifyBot);
  
              // Create an issue and commit a fix
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -756,6 +783,95 @@</span>
  
              // There should be no open issues
              assertEquals(0, issueProject.issues().size());
          }
      }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Test</span>
<span class="udiff-line-added">+     void testPullRequest(TestInfo testInfo) throws IOException {</span>
<span class="udiff-line-added">+         try (var credentials = new HostCredentials(testInfo);</span>
<span class="udiff-line-added">+              var tempFolder = new TemporaryDirectory()) {</span>
<span class="udiff-line-added">+             var repo = credentials.getHostedRepository();</span>
<span class="udiff-line-added">+             var reviewer = credentials.getHostedRepository();</span>
<span class="udiff-line-added">+             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="udiff-line-added">+             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="udiff-line-added">+             credentials.commitLock(localRepo);</span>
<span class="udiff-line-added">+             localRepo.pushAll(repo.url());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var tagStorage = createTagStorage(repo);</span>
<span class="udiff-line-added">+             var branchStorage = createBranchStorage(repo);</span>
<span class="udiff-line-added">+             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="udiff-line-added">+             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var issueProject = credentials.getIssueProject();</span>
<span class="udiff-line-added">+             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);</span>
<span class="udiff-line-added">+             var updater = new IssueUpdater(issueProject, reviewIcon);</span>
<span class="udiff-line-added">+             var notifyBot = new JNotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="udiff-line-added">+                                            prIssuesStorage, List.of(), List.of(updater), Set.of(&quot;rfr&quot;),</span>
<span class="udiff-line-added">+                                            Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Initialize history</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Create an issue and a pull request to fix it</span>
<span class="udiff-line-added">+             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;));</span>
<span class="udiff-line-added">+             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);</span>
<span class="udiff-line-added">+             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);</span>
<span class="udiff-line-added">+             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);</span>
<span class="udiff-line-added">+             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // The issue should not yet contain a link to the PR</span>
<span class="udiff-line-added">+             var links = issue.links();</span>
<span class="udiff-line-added">+             assertEquals(0, links.size());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Just a label isn&#39;t enough</span>
<span class="udiff-line-added">+             pr.addLabel(&quot;rfr&quot;);</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-added">+             links = issue.links();</span>
<span class="udiff-line-added">+             assertEquals(0, links.size());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Neither is just a comment</span>
<span class="udiff-line-added">+             pr.removeLabel(&quot;rfr&quot;);</span>
<span class="udiff-line-added">+             var reviewPr = reviewer.pullRequest(pr.id());</span>
<span class="udiff-line-added">+             reviewPr.addComment(&quot;This is now ready&quot;);</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-added">+             links = issue.links();</span>
<span class="udiff-line-added">+             assertEquals(0, links.size());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Both are needed</span>
<span class="udiff-line-added">+             pr.addLabel(&quot;rfr&quot;);</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // The issue should now contain a link to the PR</span>
<span class="udiff-line-added">+             links = issue.links();</span>
<span class="udiff-line-added">+             assertEquals(1, links.size());</span>
<span class="udiff-line-added">+             assertEquals(pr.webUrl(), links.get(0).uri());</span>
<span class="udiff-line-added">+             assertEquals(reviewIcon, links.get(0).iconUrl().orElseThrow());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Add another issue</span>
<span class="udiff-line-added">+             var issue2 = issueProject.createIssue(&quot;This is another issue&quot;, List.of(&quot;Yes indeed&quot;));</span>
<span class="udiff-line-added">+             pr.setBody(&quot;\n\n## Issues\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue\n[&quot; + issue2.id() +</span>
<span class="udiff-line-added">+                                &quot;](http://www.test2.test/): The second issue&quot;);</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Both issues should contain a link to the PR</span>
<span class="udiff-line-added">+             var links1 = issue.links();</span>
<span class="udiff-line-added">+             assertEquals(1, links1.size());</span>
<span class="udiff-line-added">+             assertEquals(pr.webUrl(), links1.get(0).uri());</span>
<span class="udiff-line-added">+             var links2 = issue2.links();</span>
<span class="udiff-line-added">+             assertEquals(1, links2.size());</span>
<span class="udiff-line-added">+             assertEquals(pr.webUrl(), links2.get(0).uri());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Drop the first one</span>
<span class="udiff-line-added">+             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue2.id() + &quot;](http://www.test2.test/): That other issue&quot;);</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Only the second issue should now contain a link to the PR</span>
<span class="udiff-line-added">+             links1 = issue.links();</span>
<span class="udiff-line-added">+             assertEquals(0, links1.size());</span>
<span class="udiff-line-added">+             links2 = issue2.links();</span>
<span class="udiff-line-added">+             assertEquals(1, links2.size());</span>
<span class="udiff-line-added">+             assertEquals(pr.webUrl(), links2.get(0).uri());</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
  }
</pre>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/notify/MailingListUpdater.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>