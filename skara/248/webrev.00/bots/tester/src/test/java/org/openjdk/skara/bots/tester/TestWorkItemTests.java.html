<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New bots/tester/src/test/java/org/openjdk/skara/bots/tester/TestWorkItemTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.bots.tester;
 24 
 25 import org.openjdk.skara.forge.CheckStatus;
 26 import org.openjdk.skara.host.*;
 27 import org.openjdk.skara.issuetracker.Comment;
 28 import org.openjdk.skara.vcs.*;
 29 import org.openjdk.skara.test.*;
 30 import org.openjdk.skara.ci.Job;
 31 
 32 import java.io.*;
 33 import java.net.URI;
 34 import java.nio.file.*;
 35 import java.util.*;
 36 import java.time.ZonedDateTime;
 37 
 38 import org.junit.jupiter.api.Test;
 39 import static org.junit.jupiter.api.Assertions.*;
 40 
 41 class TestWorkItemTests {
 42     @Test
 43     void noTestCommentsShouldDoNothing() throws IOException {
 44         try (var tmp = new TemporaryDirectory()) {
 45             var ci = new InMemoryContinuousIntegration();
 46             var approvers = &quot;0&quot;;
 47             var available = List.of(&quot;tier1&quot;, &quot;tier2&quot;, &quot;tier3&quot;);
 48             var defaultJobs = List.of(&quot;tier1&quot;);
 49             var name = &quot;test&quot;;
 50             var storage = tmp.path().resolve(&quot;storage&quot;);
 51             var scratch = tmp.path().resolve(&quot;storage&quot;);
 52 
 53             var bot = new HostUser(1, &quot;bot&quot;, &quot;openjdk [bot]&quot;);
 54             var host = new InMemoryHost();
 55             host.currentUserDetails = bot;
 56 
 57             var repo = new InMemoryHostedRepository();
 58             repo.host = host;
 59 
 60             var pr = new InMemoryPullRequest();
 61             pr.repository = repo;
 62 
 63             var duke = new HostUser(0, &quot;duke&quot;, &quot;Duke&quot;);
 64             pr.author = duke;
 65             pr.comments = List.of();
 66 
 67             var item = new TestWorkItem(ci, approvers, available, defaultJobs, name, storage, pr);
 68             item.run(scratch);
 69 
 70             var comments = pr.comments();
 71             assertEquals(0, comments.size());
 72         }
 73     }
 74 
 75     @Test
 76     void topLevelTestApproveShouldDoNothing() throws IOException {
 77         try (var tmp = new TemporaryDirectory()) {
 78             var ci = new InMemoryContinuousIntegration();
 79             var approvers = &quot;0&quot;;
 80             var available = List.of(&quot;tier1&quot;, &quot;tier2&quot;, &quot;tier3&quot;);
 81             var defaultJobs = List.of(&quot;tier1&quot;);
 82             var name = &quot;test&quot;;
 83             var storage = tmp.path().resolve(&quot;storage&quot;);
 84             var scratch = tmp.path().resolve(&quot;storage&quot;);
 85 
 86             var bot = new HostUser(1, &quot;bot&quot;, &quot;openjdk [bot]&quot;);
 87             var host = new InMemoryHost();
 88             host.currentUserDetails = bot;
 89 
 90             var repo = new InMemoryHostedRepository();
 91             repo.host = host;
 92 
 93             var pr = new InMemoryPullRequest();
 94             pr.repository = repo;
 95 
 96             var duke = new HostUser(0, &quot;duke&quot;, &quot;Duke&quot;);
 97             var now = ZonedDateTime.now();
 98             pr.author = duke;
 99             var testApproveComment = new Comment(&quot;0&quot;, &quot;/test approve&quot;, duke, now, now);
100             pr.comments = List.of(testApproveComment);
101 
102             var item = new TestWorkItem(ci, approvers, available, defaultJobs, name, storage, pr);
103             item.run(scratch);
104 
105             var comments = pr.comments();
106             assertEquals(1, comments.size());
107             assertEquals(testApproveComment, comments.get(0));
108         }
109     }
110 
111     @Test
112     void topLevelTestCancelShouldDoNothing() throws IOException {
113         try (var tmp = new TemporaryDirectory()) {
114             var ci = new InMemoryContinuousIntegration();
115             var approvers = &quot;0&quot;;
116             var available = List.of(&quot;tier1&quot;, &quot;tier2&quot;, &quot;tier3&quot;);
117             var defaultJobs = List.of(&quot;tier1&quot;);
118             var name = &quot;test&quot;;
119             var storage = tmp.path().resolve(&quot;storage&quot;);
120             var scratch = tmp.path().resolve(&quot;storage&quot;);
121 
122             var bot = new HostUser(1, &quot;bot&quot;, &quot;openjdk [bot]&quot;);
123             var host = new InMemoryHost();
124             host.currentUserDetails = bot;
125 
126             var repo = new InMemoryHostedRepository();
127             repo.host = host;
128 
129             var pr = new InMemoryPullRequest();
130             pr.repository = repo;
131 
132             var duke = new HostUser(0, &quot;duke&quot;, &quot;Duke&quot;);
133             var now = ZonedDateTime.now();
134             pr.author = duke;
135             var testApproveComment = new Comment(&quot;0&quot;, &quot;/test cancel&quot;, duke, now, now);
136             pr.comments = List.of(testApproveComment);
137 
138             var item = new TestWorkItem(ci, approvers, available, defaultJobs, name, storage, pr);
139             item.run(scratch);
140 
141             var comments = pr.comments();
142             assertEquals(1, comments.size());
143             assertEquals(testApproveComment, comments.get(0));
144         }
145     }
146 
147     @Test
148     void testCommentWithMadeUpJobShouldBeError() throws IOException {
149         try (var tmp = new TemporaryDirectory()) {
150             var ci = new InMemoryContinuousIntegration();
151             var approvers = &quot;0&quot;;
152             var available = List.of(&quot;tier1&quot;, &quot;tier2&quot;, &quot;tier3&quot;);
153             var defaultJobs = List.of(&quot;tier1&quot;);
154             var name = &quot;test&quot;;
155             var storage = tmp.path().resolve(&quot;storage&quot;);
156             var scratch = tmp.path().resolve(&quot;storage&quot;);
157 
158             var bot = new HostUser(1, &quot;bot&quot;, &quot;openjdk [bot]&quot;);
159             var host = new InMemoryHost();
160             host.currentUserDetails = bot;
161             host.groups = Map.of(&quot;0&quot;, Set.of());
162 
163             var repo = new InMemoryHostedRepository();
164             repo.host = host;
165 
166             var pr = new InMemoryPullRequest();
167             pr.repository = repo;
168 
169             var duke = new HostUser(0, &quot;duke&quot;, &quot;Duke&quot;);
170             pr.author = duke;
171 
172             var now = ZonedDateTime.now();
173             var comment = new Comment(&quot;0&quot;, &quot;/test foobar&quot;, duke, now, now);
174             pr.comments = new ArrayList&lt;&gt;(List.of(comment));
175 
176             var item = new TestWorkItem(ci, approvers, available, defaultJobs, name, storage, pr);
177             item.run(scratch);
178 
179             var comments = pr.comments();
180             assertEquals(2, comments.size());
181             assertEquals(comment, comments.get(0));
182 
183             var secondComment = comments.get(1);
184             assertEquals(bot, secondComment.author());
185 
186             var lines = secondComment.body().split(&quot;\n&quot;);
187             assertEquals(2, lines.length);
188             assertEquals(&quot;&lt;!-- TEST ERROR --&gt;&quot;, lines[0]);
189             assertEquals(&quot;@duke the test group foobar does not exist&quot;, lines[1]);
190         }
191     }
192 
193     @Test
194     void testCommentFromUnapprovedUserShouldBePending() throws IOException {
195         try (var tmp = new TemporaryDirectory()) {
196             var ci = new InMemoryContinuousIntegration();
197             var approvers = &quot;0&quot;;
198             var available = List.of(&quot;tier1&quot;, &quot;tier2&quot;, &quot;tier3&quot;);
199             var defaultJobs = List.of(&quot;tier1&quot;);
200             var name = &quot;test&quot;;
201             var storage = tmp.path().resolve(&quot;storage&quot;);
202             var scratch = tmp.path().resolve(&quot;storage&quot;);
203 
204             var bot = new HostUser(1, &quot;bot&quot;, &quot;openjdk [bot]&quot;);
205             var host = new InMemoryHost();
206             host.currentUserDetails = bot;
207             host.groups = Map.of(&quot;0&quot;, Set.of());
208 
209             var repo = new InMemoryHostedRepository();
210             repo.host = host;
211 
212             var pr = new InMemoryPullRequest();
213             pr.repository = repo;
214 
215             var duke = new HostUser(0, &quot;duke&quot;, &quot;Duke&quot;);
216             pr.author = duke;
217             pr.headHash = new Hash(&quot;01234567890123456789012345789012345789&quot;);
218 
219             var now = ZonedDateTime.now();
220             var comment = new Comment(&quot;0&quot;, &quot;/test foobar&quot;, duke, now, now);
221             pr.comments = new ArrayList&lt;&gt;(List.of(comment));
222 
223             var item = new TestWorkItem(ci, approvers, available, defaultJobs, name, storage, pr);
224 
225             // Non-existing test group should result in error
226             item.run(scratch);
227 
228             var comments = pr.comments();
229             assertEquals(2, comments.size());
230             assertEquals(comment, comments.get(0));
231 
232             var secondComment = comments.get(1);
233             assertEquals(bot, secondComment.author());
234 
235             var lines = secondComment.body().split(&quot;\n&quot;);
236             assertEquals(2, lines.length);
237             assertEquals(&quot;&lt;!-- TEST ERROR --&gt;&quot;, lines[0]);
238             assertEquals(&quot;@duke the test group foobar does not exist&quot;, lines[1]);
239 
240             // Trying to test again should be fine
241             var thirdComment = new Comment(&quot;2&quot;, &quot;/test tier1&quot;, duke, now, now);
242             pr.comments.add(thirdComment);
243             item.run(scratch);
244 
245             comments = pr.comments();
246             assertEquals(4, comments.size());
247             assertEquals(comment, comments.get(0));
248             assertEquals(secondComment, comments.get(1));
249             assertEquals(thirdComment, comments.get(2));
250 
251             var fourthComment = comments.get(3);
252             assertEquals(bot, fourthComment.author());
253 
254             lines = fourthComment.body().split(&quot;\n&quot;);
255             assertEquals(&quot;&lt;!-- TEST PENDING --&gt;&quot;, lines[0]);
256             assertEquals(&quot;&lt;!-- 01234567890123456789012345789012345789 --&gt;&quot;, lines[1]);
257             assertEquals(&quot;&lt;!-- tier1 --&gt;&quot;, lines[2]);
258             assertEquals(&quot;@duke you need to get approval to run the tests in tier1 for commits up until 01234567&quot;,
259                          lines[3]);
260 
261             // Nothing should change if we run it yet again
262             item.run(scratch);
263 
264             comments = pr.comments();
265             assertEquals(4, comments.size());
266             assertEquals(comment, comments.get(0));
267             assertEquals(secondComment, comments.get(1));
268             assertEquals(thirdComment, comments.get(2));
269             assertEquals(fourthComment, comments.get(3));
270         }
271     }
272 
273     @Test
274     void cancelAtestCommentShouldBeCancel() throws IOException {
275         try (var tmp = new TemporaryDirectory()) {
276             var ci = new InMemoryContinuousIntegration();
277             var approvers = &quot;0&quot;;
278             var available = List.of(&quot;tier1&quot;, &quot;tier2&quot;, &quot;tier3&quot;);
279             var defaultJobs = List.of(&quot;tier1&quot;);
280             var name = &quot;test&quot;;
281             var storage = tmp.path().resolve(&quot;storage&quot;);
282             var scratch = tmp.path().resolve(&quot;storage&quot;);
283 
284             var bot = new HostUser(1, &quot;bot&quot;, &quot;openjdk [bot]&quot;);
285             var host = new InMemoryHost();
286             host.currentUserDetails = bot;
287             host.groups = Map.of(&quot;0&quot;, Set.of());
288 
289             var repo = new InMemoryHostedRepository();
290             repo.host = host;
291 
292             var pr = new InMemoryPullRequest();
293             pr.repository = repo;
294 
295             var duke = new HostUser(0, &quot;duke&quot;, &quot;Duke&quot;);
296             pr.author = duke;
297             pr.headHash = new Hash(&quot;01234567890123456789012345789012345789&quot;);
298 
299             var now = ZonedDateTime.now();
300             var testComment = new Comment(&quot;0&quot;, &quot;/test tier1&quot;, duke, now, now);
301             var cancelComment = new Comment(&quot;1&quot;, &quot;/test cancel&quot;, duke, now, now);
302             pr.comments = new ArrayList&lt;&gt;(List.of(testComment, cancelComment));
303 
304             var item = new TestWorkItem(ci, approvers, available, defaultJobs, name, storage, pr);
305 
306             item.run(scratch);
307 
308             var comments = pr.comments();
309             assertEquals(2, comments.size());
310             assertEquals(testComment, comments.get(0));
311             assertEquals(cancelComment, comments.get(1));
312         }
313     }
314 
315     @Test
316     void cancellingAPendingTestCommentShouldWork() throws IOException {
317         try (var tmp = new TemporaryDirectory()) {
318             var ci = new InMemoryContinuousIntegration();
319             var approvers = &quot;0&quot;;
320             var available = List.of(&quot;tier1&quot;, &quot;tier2&quot;, &quot;tier3&quot;);
321             var defaultJobs = List.of(&quot;tier1&quot;);
322             var name = &quot;test&quot;;
323             var storage = tmp.path().resolve(&quot;storage&quot;);
324             var scratch = tmp.path().resolve(&quot;storage&quot;);
325 
326             var bot = new HostUser(1, &quot;bot&quot;, &quot;openjdk [bot]&quot;);
327             var host = new InMemoryHost();
328             host.currentUserDetails = bot;
329             host.groups = Map.of(approvers, Set.of());
330 
331             var repo = new InMemoryHostedRepository();
332             repo.host = host;
333 
334             var pr = new InMemoryPullRequest();
335             pr.repository = repo;
336 
337             var duke = new HostUser(0, &quot;duke&quot;, &quot;Duke&quot;);
338             pr.author = duke;
339             pr.headHash = new Hash(&quot;01234567890123456789012345789012345789&quot;);
340 
341             var now = ZonedDateTime.now();
342             var comment = new Comment(&quot;0&quot;, &quot;/test tier1&quot;, duke, now, now);
343             pr.comments = new ArrayList&lt;&gt;(List.of(comment));
344 
345             var item = new TestWorkItem(ci, approvers, available, defaultJobs, name, storage, pr);
346 
347             item.run(scratch);
348 
349             var comments = pr.comments();
350             assertEquals(2, comments.size());
351             assertEquals(comment, comments.get(0));
352             var secondComment = comments.get(1);
353             assertEquals(bot, secondComment.author());
354 
355             var lines = secondComment.body().split(&quot;\n&quot;);
356             assertEquals(&quot;&lt;!-- TEST PENDING --&gt;&quot;, lines[0]);
357             assertEquals(&quot;&lt;!-- 01234567890123456789012345789012345789 --&gt;&quot;, lines[1]);
358             assertEquals(&quot;&lt;!-- tier1 --&gt;&quot;, lines[2]);
359             assertEquals(&quot;@duke you need to get approval to run the tests in tier1 for commits up until 01234567&quot;,
360                          lines[3]);
361 
362             // Nothing should change if we run it yet again
363             item.run(scratch);
364 
365             comments = pr.comments();
366             assertEquals(2, comments.size());
367             assertEquals(comment, comments.get(0));
368             assertEquals(secondComment, comments.get(1));
369 
370             // Cancelling the test now should be fine
371             var cancelComment = new Comment(&quot;2&quot;, &quot;/test cancel&quot;, duke, now, now);
372             pr.comments.add(cancelComment);
373 
374             item.run(scratch);
375 
376             comments = pr.comments();
377             assertEquals(3, comments.size());
378             assertEquals(comment, comments.get(0));
379             assertEquals(secondComment, comments.get(1));
380             assertEquals(cancelComment, comments.get(2));
381 
382             // Approving the test should not start a job, it has already been cancelled
383             var member = new HostUser(3, &quot;foo&quot;, &quot;Foo Bar&quot;);
384             host.groups = Map.of(approvers, Set.of(member));
385             var approveComment = new Comment(&quot;3&quot;, &quot;/test approve&quot;, member, now, now);
386             pr.comments.add(approveComment);
387 
388             item.run(scratch);
389 
390             comments = pr.comments();
391             assertEquals(4, comments.size());
392             assertEquals(comment, comments.get(0));
393             assertEquals(secondComment, comments.get(1));
394             assertEquals(cancelComment, comments.get(2));
395             assertEquals(approveComment, comments.get(3));
396         }
397     }
398 
399     @Test
400     void cancellingApprovedPendingRequestShouldBeCancelled() throws IOException {
401         try (var tmp = new TemporaryDirectory()) {
402             var ci = new InMemoryContinuousIntegration();
403             var approvers = &quot;0&quot;;
404             var available = List.of(&quot;tier1&quot;, &quot;tier2&quot;, &quot;tier3&quot;);
405             var defaultJobs = List.of(&quot;tier1&quot;);
406             var name = &quot;test&quot;;
407             var storage = tmp.path().resolve(&quot;storage&quot;);
408             var scratch = tmp.path().resolve(&quot;storage&quot;);
409 
410             var bot = new HostUser(1, &quot;bot&quot;, &quot;openjdk [bot]&quot;);
411             var host = new InMemoryHost();
412             host.currentUserDetails = bot;
413             host.groups = Map.of(approvers, Set.of());
414 
415             var repo = new InMemoryHostedRepository();
416             repo.host = host;
417 
418             var pr = new InMemoryPullRequest();
419             pr.repository = repo;
420 
421             var duke = new HostUser(0, &quot;duke&quot;, &quot;Duke&quot;);
422             pr.author = duke;
423             pr.headHash = new Hash(&quot;01234567890123456789012345789012345789&quot;);
424 
425             var now = ZonedDateTime.now();
426             var comment = new Comment(&quot;0&quot;, &quot;/test tier1&quot;, duke, now, now);
427             pr.comments = new ArrayList&lt;&gt;(List.of(comment));
428 
429             var item = new TestWorkItem(ci, approvers, available, defaultJobs, name, storage, pr);
430 
431             item.run(scratch);
432 
433             var comments = pr.comments();
434             assertEquals(2, comments.size());
435             assertEquals(comment, comments.get(0));
436             var secondComment = comments.get(1);
437             assertEquals(bot, secondComment.author());
438 
439             var lines = secondComment.body().split(&quot;\n&quot;);
440             assertEquals(&quot;&lt;!-- TEST PENDING --&gt;&quot;, lines[0]);
441             assertEquals(&quot;&lt;!-- 01234567890123456789012345789012345789 --&gt;&quot;, lines[1]);
442             assertEquals(&quot;&lt;!-- tier1 --&gt;&quot;, lines[2]);
443             assertEquals(&quot;@duke you need to get approval to run the tests in tier1 for commits up until 01234567&quot;,
444                          lines[3]);
445 
446             // Nothing should change if we run it yet again
447             item.run(scratch);
448 
449             comments = pr.comments();
450             assertEquals(2, comments.size());
451             assertEquals(comment, comments.get(0));
452             assertEquals(secondComment, comments.get(1));
453 
454             // Approve the request
455             var member = new HostUser(2, &quot;foo&quot;, &quot;Foo Bar&quot;);
456             host.groups = Map.of(approvers, Set.of(member));
457             var approveComment = new Comment(&quot;2&quot;, &quot;/test approve&quot;, member, now, now);
458             pr.comments.add(approveComment);
459 
460             // Cancelling the request
461             var cancelComment = new Comment(&quot;2&quot;, &quot;/test cancel&quot;, duke, now, now);
462             pr.comments.add(cancelComment);
463 
464             item.run(scratch);
465 
466             comments = pr.comments();
467             assertEquals(4, comments.size());
468             assertEquals(comment, comments.get(0));
469             assertEquals(secondComment, comments.get(1));
470             assertEquals(approveComment, comments.get(2));
471             assertEquals(cancelComment, comments.get(3));
472         }
473     }
474 
475     @Test
476     void approvedPendingRequestShouldBeStarted() throws IOException {
477         try (var tmp = new TemporaryDirectory()) {
478             var localRepoDir = tmp.path().resolve(&quot;repository.git&quot;);
479             var localRepo = Repository.init(localRepoDir, VCS.GIT);
480             var readme = localRepoDir.resolve(&quot;README&quot;);
481             Files.writeString(readme, &quot;Hello\n&quot;);
482             localRepo.add(readme);
483             var head = localRepo.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
484 
485             var ci = new InMemoryContinuousIntegration();
486             var approvers = &quot;0&quot;;
487             var available = List.of(&quot;tier1&quot;, &quot;tier2&quot;, &quot;tier3&quot;);
488             var defaultJobs = List.of(&quot;tier1&quot;);
489             var name = &quot;test&quot;;
490             var storage = tmp.path().resolve(&quot;storage&quot;);
491             var scratch = tmp.path().resolve(&quot;storage&quot;);
492 
493             var bot = new HostUser(1, &quot;bot&quot;, &quot;openjdk [bot]&quot;);
494             var host = new InMemoryHost();
495             host.currentUserDetails = bot;
496             host.groups = Map.of(approvers, Set.of());
497 
498             var repo = new InMemoryHostedRepository();
499             repo.host = host;
500             repo.webUrl = URI.create(&quot;file://&quot; + localRepoDir.toAbsolutePath());
501             repo.url = URI.create(&quot;file://&quot; + localRepoDir.toAbsolutePath());
502             repo.id = 1337L;
503 
504             var pr = new InMemoryPullRequest();
505             pr.repository = repo;
506             pr.id = &quot;17&quot;;
507             pr.targetRef = &quot;master&quot;;
508 
509             var duke = new HostUser(0, &quot;duke&quot;, &quot;Duke&quot;);
510             pr.author = duke;
511             pr.headHash = head;
512 
513             var now = ZonedDateTime.now();
514             var comment = new Comment(&quot;0&quot;, &quot;/test tier1&quot;, duke, now, now);
515             pr.comments = new ArrayList&lt;&gt;(List.of(comment));
516 
517             var item = new TestWorkItem(ci, approvers, available, defaultJobs, name, storage, pr);
518 
519             item.run(scratch);
520 
521             var comments = pr.comments();
522             assertEquals(2, comments.size());
523             assertEquals(comment, comments.get(0));
524             var secondComment = comments.get(1);
525             assertEquals(bot, secondComment.author());
526 
527             var lines = secondComment.body().split(&quot;\n&quot;);
528             assertEquals(&quot;&lt;!-- TEST PENDING --&gt;&quot;, lines[0]);
529             assertEquals(&quot;&lt;!-- &quot; + head.hex() + &quot; --&gt;&quot;, lines[1]);
530             assertEquals(&quot;&lt;!-- tier1 --&gt;&quot;, lines[2]);
531             assertEquals(&quot;@duke you need to get approval to run the tests in tier1 for commits up until &quot; + head.abbreviate(),
532                          lines[3]);
533 
534             // Nothing should change if we run it yet again
535             item.run(scratch);
536 
537             comments = pr.comments();
538             assertEquals(2, comments.size());
539             assertEquals(comment, comments.get(0));
540             assertEquals(secondComment, comments.get(1));
541 
542             // Approve the request
543             var member = new HostUser(2, &quot;foo&quot;, &quot;Foo Bar&quot;);
544             host.groups = Map.of(approvers, Set.of(member));
545             var approveComment = new Comment(&quot;2&quot;, &quot;/test approve&quot;, member, now, now);
546             pr.comments.add(approveComment);
547 
548             var expectedJobId = &quot;null-1337-17-0&quot;;
549             var expectedJob = new InMemoryJob();
550             expectedJob.status = new Job.Status(0, 1, 7);
551             ci.jobs.put(expectedJobId, expectedJob);
552 
553             item.run(scratch);
554 
555             comments = pr.comments();
556             assertEquals(4, comments.size());
557             assertEquals(comment, comments.get(0));
558             assertEquals(secondComment, comments.get(1));
559             assertEquals(approveComment, comments.get(2));
560 
561             var fourthComment = comments.get(3);
562             lines = fourthComment.body().split(&quot;\n&quot;);
563             assertEquals(&quot;&lt;!-- TEST STARTED --&gt;&quot;, lines[0]);
564             assertEquals(&quot;&lt;!-- &quot; + expectedJobId + &quot; --&gt;&quot;, lines[1]);
565             assertEquals(&quot;&lt;!-- &quot; + head.hex() + &quot; --&gt;&quot;, lines[2]);
566             assertEquals(&quot;A test job has been started with id: &quot; + expectedJobId, lines[3]);
567 
568             assertEquals(1, ci.submissions.size());
569             var submission = ci.submissions.get(0);
570             assertTrue(submission.source.startsWith(storage));
571             assertEquals(List.of(&quot;tier1&quot;), submission.jobs);
572             assertEquals(expectedJobId, submission.id);
573 
574             var checks = pr.checks(pr.headHash());
575             assertEquals(1, checks.keySet().size());
576             var check = checks.get(&quot;test&quot;);
577             assertEquals(&quot;Summary&quot;, check.title().get());
578             assertTrue(check.summary()
579                             .get()
580                             .contains(&quot;0 jobs completed, 1 job running, 7 jobs not yet started&quot;));
581         }
582     }
583 
584     @Test
585     void cancellingApprovedPendingRequestShouldBeCancel() throws IOException {
586         try (var tmp = new TemporaryDirectory()) {
587             var localRepoDir = tmp.path().resolve(&quot;repository.git&quot;);
588             var localRepo = Repository.init(localRepoDir, VCS.GIT);
589             var readme = localRepoDir.resolve(&quot;README&quot;);
590             Files.writeString(readme, &quot;Hello\n&quot;);
591             localRepo.add(readme);
592             var head = localRepo.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
593 
594             var ci = new InMemoryContinuousIntegration();
595             var approvers = &quot;0&quot;;
596             var available = List.of(&quot;tier1&quot;, &quot;tier2&quot;, &quot;tier3&quot;);
597             var defaultJobs = List.of(&quot;tier1&quot;);
598             var name = &quot;test&quot;;
599             var storage = tmp.path().resolve(&quot;storage&quot;);
600             var scratch = tmp.path().resolve(&quot;storage&quot;);
601 
602             var bot = new HostUser(1, &quot;bot&quot;, &quot;openjdk [bot]&quot;);
603             var host = new InMemoryHost();
604             host.currentUserDetails = bot;
605             host.groups = Map.of(approvers, Set.of());
606 
607             var repo = new InMemoryHostedRepository();
608             repo.host = host;
609             repo.webUrl = URI.create(&quot;file://&quot; + localRepoDir.toAbsolutePath());
610             repo.url = URI.create(&quot;file://&quot; + localRepoDir.toAbsolutePath());
611             repo.id = 1337L;
612 
613             var pr = new InMemoryPullRequest();
614             pr.repository = repo;
615             pr.id = &quot;17&quot;;
616             pr.targetRef = &quot;master&quot;;
617 
618             var duke = new HostUser(0, &quot;duke&quot;, &quot;Duke&quot;);
619             pr.author = duke;
620             pr.headHash = head;
621 
622             var now = ZonedDateTime.now();
623             var comment = new Comment(&quot;0&quot;, &quot;/test tier1&quot;, duke, now, now);
624             pr.comments = new ArrayList&lt;&gt;(List.of(comment));
625 
626             var item = new TestWorkItem(ci, approvers, available, defaultJobs, name, storage, pr);
627 
628             item.run(scratch);
629 
630             var comments = pr.comments();
631             assertEquals(2, comments.size());
632             assertEquals(comment, comments.get(0));
633             var secondComment = comments.get(1);
634             assertEquals(bot, secondComment.author());
635 
636             var lines = secondComment.body().split(&quot;\n&quot;);
637             assertEquals(&quot;&lt;!-- TEST PENDING --&gt;&quot;, lines[0]);
638             assertEquals(&quot;&lt;!-- &quot; + head.hex() + &quot; --&gt;&quot;, lines[1]);
639             assertEquals(&quot;&lt;!-- tier1 --&gt;&quot;, lines[2]);
640             assertEquals(&quot;@duke you need to get approval to run the tests in tier1 for commits up until &quot; + head.abbreviate(),
641                          lines[3]);
642 
643             // Nothing should change if we run it yet again
644             item.run(scratch);
645 
646             comments = pr.comments();
647             assertEquals(2, comments.size());
648             assertEquals(comment, comments.get(0));
649             assertEquals(secondComment, comments.get(1));
650 
651             // Approve the request
652             var member = new HostUser(2, &quot;foo&quot;, &quot;Foo Bar&quot;);
653             host.groups = Map.of(approvers, Set.of(member));
654             var approveComment = new Comment(&quot;2&quot;, &quot;/test approve&quot;, member, now, now);
655             pr.comments.add(approveComment);
656 
657             var expectedJobId = &quot;null-1337-17-0&quot;;
658             var expectedJob = new InMemoryJob();
659             expectedJob.status = new Job.Status(0, 1, 7);
660             ci.jobs.put(expectedJobId, expectedJob);
661 
662             item.run(scratch);
663 
664             comments = pr.comments();
665             assertEquals(4, comments.size());
666             assertEquals(comment, comments.get(0));
667             assertEquals(secondComment, comments.get(1));
668             assertEquals(approveComment, comments.get(2));
669 
670             var fourthComment = comments.get(3);
671             lines = fourthComment.body().split(&quot;\n&quot;);
672             assertEquals(&quot;&lt;!-- TEST STARTED --&gt;&quot;, lines[0]);
673             assertEquals(&quot;&lt;!-- &quot; + expectedJobId + &quot; --&gt;&quot;, lines[1]);
674             assertEquals(&quot;&lt;!-- &quot; + head.hex() + &quot; --&gt;&quot;, lines[2]);
675             assertEquals(&quot;A test job has been started with id: &quot; + expectedJobId, lines[3]);
676 
677             assertEquals(1, ci.submissions.size());
678             var submission = ci.submissions.get(0);
679             assertTrue(submission.source.startsWith(storage));
680             assertEquals(List.of(&quot;tier1&quot;), submission.jobs);
681             assertEquals(expectedJobId, submission.id);
682 
683             var checks = pr.checks(pr.headHash());
684             assertEquals(1, checks.keySet().size());
685             var check = checks.get(&quot;test&quot;);
686             assertEquals(&quot;Summary&quot;, check.title().get());
687             assertEquals(CheckStatus.IN_PROGRESS, check.status());
688             assertTrue(check.summary()
689                             .get()
690                             .contains(&quot;## Status\n0 jobs completed, 1 job running, 7 jobs not yet started\n&quot;));
691 
692             var cancelComment = new Comment(&quot;4&quot;, &quot;/test cancel&quot;, duke, now, now);
693             pr.comments.add(cancelComment);
694 
695             item.run(scratch);
696 
697             checks = pr.checks(pr.headHash());
698             assertEquals(1, checks.keySet().size());
699             check = checks.get(&quot;test&quot;);
700             assertEquals(&quot;Summary&quot;, check.title().get());
701             assertEquals(CheckStatus.CANCELLED, check.status());
702             assertTrue(check.summary()
703                             .get()
704                             .contains(&quot;## Status\n0 jobs completed, 1 job running, 7 jobs not yet started\n&quot;));
705 
706             assertEquals(expectedJobId, ci.cancelled.get(0));
707         }
708     }
709 
710     @Test
711     void errorWhenCreatingTestJobShouldResultInError() throws IOException {
712         try (var tmp = new TemporaryDirectory()) {
713             var localRepoDir = tmp.path().resolve(&quot;repository.git&quot;);
714             var localRepo = Repository.init(localRepoDir, VCS.GIT);
715             var readme = localRepoDir.resolve(&quot;README&quot;);
716             Files.writeString(readme, &quot;Hello\n&quot;);
717             localRepo.add(readme);
718             var head = localRepo.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
719 
720             var ci = new InMemoryContinuousIntegration();
721             var approvers = &quot;0&quot;;
722             var available = List.of(&quot;tier1&quot;, &quot;tier2&quot;, &quot;tier3&quot;);
723             var defaultJobs = List.of(&quot;tier1&quot;);
724             var name = &quot;test&quot;;
725             var storage = tmp.path().resolve(&quot;storage&quot;);
726             var scratch = tmp.path().resolve(&quot;storage&quot;);
727 
728             var bot = new HostUser(1, &quot;bot&quot;, &quot;openjdk [bot]&quot;);
729             var host = new InMemoryHost();
730             host.currentUserDetails = bot;
731             host.groups = Map.of(approvers, Set.of());
732 
733             var repo = new InMemoryHostedRepository();
734             repo.host = host;
735             repo.webUrl = URI.create(&quot;file://&quot; + localRepoDir.toAbsolutePath());
736             repo.url = URI.create(&quot;file://&quot; + localRepoDir.toAbsolutePath());
737             repo.id = 1337L;
738 
739             var pr = new InMemoryPullRequest();
740             pr.repository = repo;
741             pr.id = &quot;17&quot;;
742             pr.targetRef = &quot;master&quot;;
743 
744             var duke = new HostUser(0, &quot;duke&quot;, &quot;Duke&quot;);
745             pr.author = duke;
746             pr.headHash = head;
747 
748             var now = ZonedDateTime.now();
749             var comment = new Comment(&quot;0&quot;, &quot;/test tier1&quot;, duke, now, now);
750             pr.comments = new ArrayList&lt;&gt;(List.of(comment));
751 
752             var item = new TestWorkItem(ci, approvers, available, defaultJobs, name, storage, pr);
753 
754             item.run(scratch);
755 
756             var comments = pr.comments();
757             assertEquals(2, comments.size());
758             assertEquals(comment, comments.get(0));
759             var secondComment = comments.get(1);
760             assertEquals(bot, secondComment.author());
761 
762             var lines = secondComment.body().split(&quot;\n&quot;);
763             assertEquals(&quot;&lt;!-- TEST PENDING --&gt;&quot;, lines[0]);
764             assertEquals(&quot;&lt;!-- &quot; + head.hex() + &quot; --&gt;&quot;, lines[1]);
765             assertEquals(&quot;&lt;!-- tier1 --&gt;&quot;, lines[2]);
766             assertEquals(&quot;@duke you need to get approval to run the tests in tier1 for commits up until &quot; + head.abbreviate(),
767                          lines[3]);
768 
769             // Nothing should change if we run it yet again
770             item.run(scratch);
771 
772             comments = pr.comments();
773             assertEquals(2, comments.size());
774             assertEquals(comment, comments.get(0));
775             assertEquals(secondComment, comments.get(1));
776 
777             // Approve the request
778             var member = new HostUser(2, &quot;foo&quot;, &quot;Foo Bar&quot;);
779             host.groups = Map.of(approvers, Set.of(member));
780             var approveComment = new Comment(&quot;2&quot;, &quot;/test approve&quot;, member, now, now);
781             pr.comments.add(approveComment);
782 
783             ci.throwOnSubmit = true;
784             assertThrows(UncheckedIOException.class, () -&gt; item.run(scratch));
785 
786             comments = pr.comments();
787             assertEquals(4, comments.size());
788             assertEquals(comment, comments.get(0));
789             assertEquals(secondComment, comments.get(1));
790             assertEquals(approveComment, comments.get(2));
791 
792             var fifthComment = comments.get(3);
793             lines = fifthComment.body().split(&quot;\n&quot;);
794             assertEquals(&quot;&lt;!-- TEST ERROR --&gt;&quot;, lines[0]);
795             assertEquals(&quot;Could not create test job&quot;, lines[1]);
796         }
797     }
798 
799     @Test
800     void finishedJobShouldResultInFinishedComment() throws IOException {
801         try (var tmp = new TemporaryDirectory()) {
802             var localRepoDir = tmp.path().resolve(&quot;repository.git&quot;);
803             var localRepo = Repository.init(localRepoDir, VCS.GIT);
804             var readme = localRepoDir.resolve(&quot;README&quot;);
805             Files.writeString(readme, &quot;Hello\n&quot;);
806             localRepo.add(readme);
807             var head = localRepo.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
808 
809             var ci = new InMemoryContinuousIntegration();
810             var approvers = &quot;0&quot;;
811             var available = List.of(&quot;tier1&quot;, &quot;tier2&quot;, &quot;tier3&quot;);
812             var defaultJobs = List.of(&quot;tier1&quot;);
813             var name = &quot;test&quot;;
814             var storage = tmp.path().resolve(&quot;storage&quot;);
815             var scratch = tmp.path().resolve(&quot;storage&quot;);
816 
817             var bot = new HostUser(1, &quot;bot&quot;, &quot;openjdk [bot]&quot;);
818             var host = new InMemoryHost();
819             host.currentUserDetails = bot;
820             host.groups = Map.of(approvers, Set.of());
821 
822             var repo = new InMemoryHostedRepository();
823             repo.host = host;
824             repo.webUrl = URI.create(&quot;file://&quot; + localRepoDir.toAbsolutePath());
825             repo.url = URI.create(&quot;file://&quot; + localRepoDir.toAbsolutePath());
826             repo.id = 1337L;
827 
828             var pr = new InMemoryPullRequest();
829             pr.repository = repo;
830             pr.id = &quot;17&quot;;
831             pr.targetRef = &quot;master&quot;;
832 
833             var duke = new HostUser(0, &quot;duke&quot;, &quot;Duke&quot;);
834             pr.author = duke;
835             pr.headHash = head;
836 
837             var now = ZonedDateTime.now();
838             var comment = new Comment(&quot;0&quot;, &quot;/test tier1&quot;, duke, now, now);
839             pr.comments = new ArrayList&lt;&gt;(List.of(comment));
840 
841             var item = new TestWorkItem(ci, approvers, available, defaultJobs, name, storage, pr);
842 
843             item.run(scratch);
844 
845             var comments = pr.comments();
846             assertEquals(2, comments.size());
847             assertEquals(comment, comments.get(0));
848             var secondComment = comments.get(1);
849             assertEquals(bot, secondComment.author());
850 
851             var lines = secondComment.body().split(&quot;\n&quot;);
852             assertEquals(&quot;&lt;!-- TEST PENDING --&gt;&quot;, lines[0]);
853             assertEquals(&quot;&lt;!-- &quot; + head.hex() + &quot; --&gt;&quot;, lines[1]);
854             assertEquals(&quot;&lt;!-- tier1 --&gt;&quot;, lines[2]);
855             assertEquals(&quot;@duke you need to get approval to run the tests in tier1 for commits up until &quot; + head.abbreviate(),
856                          lines[3]);
857 
858             // Nothing should change if we run it yet again
859             item.run(scratch);
860 
861             comments = pr.comments();
862             assertEquals(2, comments.size());
863             assertEquals(comment, comments.get(0));
864             assertEquals(secondComment, comments.get(1));
865 
866             // Approve the request
867             var member = new HostUser(2, &quot;foo&quot;, &quot;Foo Bar&quot;);
868             host.groups = Map.of(approvers, Set.of(member));
869             var approveComment = new Comment(&quot;2&quot;, &quot;/test approve&quot;, member, now, now);
870             pr.comments.add(approveComment);
871 
872             var expectedJobId = &quot;null-1337-17-0&quot;;
873             var expectedJob = new InMemoryJob();
874             expectedJob.status = new Job.Status(0, 1, 7);
875             ci.jobs.put(expectedJobId, expectedJob);
876 
877             item.run(scratch);
878 
879             comments = pr.comments();
880             assertEquals(4, comments.size());
881             assertEquals(comment, comments.get(0));
882             assertEquals(secondComment, comments.get(1));
883             assertEquals(approveComment, comments.get(2));
884 
885             var fourthComment = comments.get(3);
886             lines = fourthComment.body().split(&quot;\n&quot;);
887             assertEquals(&quot;&lt;!-- TEST STARTED --&gt;&quot;, lines[0]);
888             assertEquals(&quot;&lt;!-- &quot; + expectedJobId + &quot; --&gt;&quot;, lines[1]);
889             assertEquals(&quot;&lt;!-- &quot; + head.hex() + &quot; --&gt;&quot;, lines[2]);
890             assertEquals(&quot;A test job has been started with id: &quot; + expectedJobId, lines[3]);
891 
892             assertEquals(1, ci.submissions.size());
893             var submission = ci.submissions.get(0);
894             assertTrue(submission.source.startsWith(storage));
895             assertEquals(List.of(&quot;tier1&quot;), submission.jobs);
896             assertEquals(expectedJobId, submission.id);
897 
898             var checks = pr.checks(pr.headHash());
899             assertEquals(1, checks.keySet().size());
900             var check = checks.get(&quot;test&quot;);
901             assertEquals(&quot;Summary&quot;, check.title().get());
902             assertEquals(CheckStatus.IN_PROGRESS, check.status());
903             assertTrue(check.summary()
904                             .get()
905                             .contains(&quot;0 jobs completed, 1 job running, 7 jobs not yet started&quot;));
906 
907             var job = ci.jobs.get(expectedJobId);
908             assertNotNull(job);
909             job.id = &quot;id&quot;;
910             job.state = Job.State.COMPLETED;
911             job.status = new Job.Status(8, 0, 0);
912             job.result = new Job.Result(8, 0, 0);
913 
914             item.run(scratch);
915 
916             comments = pr.comments();
917             assertEquals(5, comments.size());
918             assertEquals(comment, comments.get(0));
919             assertEquals(secondComment, comments.get(1));
920             assertEquals(approveComment, comments.get(2));
921             assertEquals(fourthComment, comments.get(3));
922 
923             var finishedComment = comments.get(4);
924             lines = finishedComment.body().split(&quot;\n&quot;);
925             assertEquals(&quot;&lt;!-- TEST FINISHED --&gt;&quot;, lines[0]);
926             assertEquals(&quot;&lt;!-- &quot; + expectedJobId +&quot; --&gt;&quot;, lines[1]);
927             assertEquals(&quot;&lt;!-- &quot; + head.hex() +&quot; --&gt;&quot;, lines[2]);
928             assertEquals(&quot;@duke your test job with id &quot; + expectedJobId + &quot; for commits up until &quot; +
929                          head.abbreviate() + &quot; has finished.&quot;, lines[3]);
930 
931             checks = pr.checks(pr.headHash());
932             assertEquals(1, checks.keySet().size());
933             check = checks.get(&quot;test&quot;);
934             assertEquals(&quot;Summary&quot;, check.title().get());
935             assertEquals(CheckStatus.SUCCESS, check.status());
936 
937             var summaryLines = check.summary().get().split(&quot;\n&quot;);
938             assertEquals(&quot;## Id&quot;, summaryLines[0]);
939             assertEquals(&quot;`id`&quot;, summaryLines[1]);
940             assertEquals(&quot;&quot;, summaryLines[2]);
941             assertEquals(&quot;## Builds&quot;, summaryLines[3]);
942             assertEquals(&quot;&quot;, summaryLines[4]);
943             assertEquals(&quot;## Tests&quot;, summaryLines[5]);
944             assertEquals(&quot;&quot;, summaryLines[6]);
945             assertEquals(&quot;## Status&quot;, summaryLines[7]);
946             assertEquals(&quot;8 jobs completed, 0 jobs running, 0 jobs not yet started&quot;, summaryLines[8]);
947             assertEquals(&quot;&quot;, summaryLines[9]);
948             assertEquals(&quot;## Result&quot;, summaryLines[10]);
949             assertEquals(&quot;8 jobs passed, 0 jobs with failures, 0 jobs not run&quot;, summaryLines[11]);
950         }
951     }
952 }
    </pre>
  </body>
</html>