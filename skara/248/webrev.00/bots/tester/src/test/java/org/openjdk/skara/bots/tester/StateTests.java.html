<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New bots/tester/src/test/java/org/openjdk/skara/bots/tester/StateTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.bots.tester;
 24 
 25 import org.openjdk.skara.issuetracker.Comment;
 26 import org.openjdk.skara.host.HostUser;
 27 
 28 import java.util.*;
 29 import java.time.ZonedDateTime;
 30 
 31 import org.junit.jupiter.api.Test;
 32 import static org.junit.jupiter.api.Assertions.*;
 33 
 34 class StateTests {
 35     @Test
 36     void noCommentsShouldEqualNA() {
 37         var bot = new HostUser(1, &quot;bot&quot;, &quot;openjdk [bot]&quot;);
 38         var host = new InMemoryHost();
 39         host.currentUserDetails = bot;
 40 
 41         var repo = new InMemoryHostedRepository();
 42         repo.host = host;
 43 
 44         var pr = new InMemoryPullRequest();
 45         pr.repository = repo;
 46 
 47         var duke = new HostUser(0, &quot;duke&quot;, &quot;Duke&quot;);
 48         pr.author = duke;
 49         pr.comments = List.of();
 50 
 51         var state = State.from(pr, &quot;0&quot;);
 52         assertEquals(Stage.NA, state.stage());
 53         assertEquals(null, state.requested());
 54         assertEquals(null, state.pending());
 55         assertEquals(null, state.started());
 56     }
 57 
 58     @Test
 59     void testCommentFromNotApprovedUserShouldEqualRequested() {
 60         var bot = new HostUser(1, &quot;bot&quot;, &quot;openjdk [bot]&quot;);
 61 
 62         var host = new InMemoryHost();
 63         host.currentUserDetails = bot;
 64 
 65         var repo = new InMemoryHostedRepository();
 66         repo.host = host;
 67 
 68         var pr = new InMemoryPullRequest();
 69         pr.repository = repo;
 70 
 71         var duke = new HostUser(0, &quot;duke&quot;, &quot;Duke&quot;);
 72         pr.author = duke;
 73 
 74         var now = ZonedDateTime.now();
 75         var comment = new Comment(&quot;0&quot;, &quot;/test tier1&quot;, duke, now, now);
 76         pr.comments = List.of(comment);
 77 
 78         var approvers = &quot;0&quot;;
 79         host.groups = Map.of(approvers, Set.of());
 80 
 81         var state = State.from(pr, approvers);
 82         assertEquals(Stage.REQUESTED, state.stage());
 83         assertEquals(comment, state.requested());
 84         assertEquals(null, state.pending());
 85         assertEquals(null, state.started());
 86     }
 87 
 88     @Test
 89     void testCommentFromApprovedUserShouldEqualApproved() {
 90         var bot = new HostUser(1, &quot;bot&quot;, &quot;openjdk [bot]&quot;);
 91 
 92         var host = new InMemoryHost();
 93         host.currentUserDetails = bot;
 94 
 95         var repo = new InMemoryHostedRepository();
 96         repo.host = host;
 97 
 98         var pr = new InMemoryPullRequest();
 99         pr.repository = repo;
100 
101         var duke = new HostUser(0, &quot;duke&quot;, &quot;Duke&quot;);
102         pr.author = duke;
103 
104         var now = ZonedDateTime.now();
105         var comment = new Comment(&quot;0&quot;, &quot;/test tier1&quot;, duke, now, now);
106         pr.comments = List.of(comment);
107 
108         var approvers = &quot;0&quot;;
109         host.groups = Map.of(approvers, Set.of(duke));
110 
111         var state = State.from(pr, approvers);
112         assertEquals(Stage.APPROVED, state.stage());
113         assertEquals(comment, state.requested());
114         assertEquals(null, state.pending());
115         assertEquals(null, state.started());
116     }
117 
118     @Test
119     void testApprovalNeededCommentShouldResultInPending() {
120         var bot = new HostUser(1, &quot;bot&quot;, &quot;openjdk [bot]&quot;);
121 
122         var host = new InMemoryHost();
123         host.currentUserDetails = bot;
124 
125         var repo = new InMemoryHostedRepository();
126         repo.host = host;
127 
128         var pr = new InMemoryPullRequest();
129         pr.repository = repo;
130 
131         var duke = new HostUser(0, &quot;duke&quot;, &quot;Duke&quot;);
132         pr.author = duke;
133 
134         var now = ZonedDateTime.now();
135         var testComment = new Comment(&quot;0&quot;, &quot;/test tier1&quot;, duke, now, now);
136 
137         var pendingBody = List.of(
138             &quot;&lt;!-- TEST PENDING --&gt;&quot;,
139             &quot;&lt;!-- tier1 --&gt;&quot;,
140             &quot;@duke you need to get approval to run these tests&quot;
141         );
142         var pendingComment = new Comment(&quot;0&quot;, String.join(&quot;\n&quot;, pendingBody), bot, now, now);
143         pr.comments = List.of(testComment, pendingComment);
144         host.groups = Map.of(&quot;0&quot;, Set.of());
145 
146         var state = State.from(pr, &quot;0&quot;);
147         assertEquals(Stage.PENDING, state.stage());
148         assertEquals(testComment, state.requested());
149         assertEquals(pendingComment, state.pending());
150         assertEquals(null, state.started());
151     }
152 
153     @Test
154     void testStartedCommentShouldResultInRunning() {
155         var bot = new HostUser(1, &quot;bot&quot;, &quot;openjdk [bot]&quot;);
156 
157         var host = new InMemoryHost();
158         host.currentUserDetails = bot;
159 
160         var repo = new InMemoryHostedRepository();
161         repo.host = host;
162 
163         var pr = new InMemoryPullRequest();
164         pr.repository = repo;
165 
166         var duke = new HostUser(0, &quot;duke&quot;, &quot;Duke&quot;);
167         pr.author = duke;
168 
169         var now = ZonedDateTime.now();
170         var testComment = new Comment(&quot;0&quot;, &quot;/test tier1&quot;, duke, now, now);
171 
172         var pendingBody = List.of(
173             &quot;&lt;!-- TEST PENDING --&gt;&quot;,
174             &quot;&lt;!-- tier1 --&gt;&quot;,
175             &quot;@duke you need to get approval to run these tests&quot;
176         );
177         var pendingComment = new Comment(&quot;1&quot;, String.join(&quot;\n&quot;, pendingBody), bot, now, now);
178 
179         var member = new HostUser(2, &quot;foo&quot;, &quot;Foo Bar&quot;);
180         var approveComment = new Comment(&quot;2&quot;, &quot;/test approve&quot;, member, now, now);
181 
182         var startedBody = List.of(
183             &quot;&lt;!-- TEST STARTED --&gt;&quot;,
184             &quot;&lt;!-- 0 --&gt;&quot;,
185             &quot;A test job has been started with id 0&quot;
186         );
187         var startedComment = new Comment(&quot;3&quot;, String.join(&quot;\n&quot;, startedBody), bot, now, now);
188 
189         pr.comments = List.of(testComment, pendingComment, approveComment, startedComment);
190 
191         var approvers = &quot;0&quot;;
192         host.groups = Map.of(approvers, Set.of(member));
193 
194         var state = State.from(pr, approvers);
195         assertEquals(Stage.STARTED, state.stage());
196         assertEquals(testComment, state.requested());
197         assertEquals(pendingComment, state.pending());
198         assertEquals(startedComment, state.started());
199     }
200 
201     @Test
202     void cancelCommentFromAuthorShouldEqualCancelled() {
203         var bot = new HostUser(1, &quot;bot&quot;, &quot;openjdk [bot]&quot;);
204 
205         var host = new InMemoryHost();
206         host.currentUserDetails = bot;
207 
208         var repo = new InMemoryHostedRepository();
209         repo.host = host;
210 
211         var pr = new InMemoryPullRequest();
212         pr.repository = repo;
213 
214         var duke = new HostUser(0, &quot;duke&quot;, &quot;Duke&quot;);
215         pr.author = duke;
216 
217         var now = ZonedDateTime.now();
218         var testComment = new Comment(&quot;0&quot;, &quot;/test tier1&quot;, duke, now, now);
219         var cancelComment = new Comment(&quot;1&quot;, &quot;/test cancel&quot;, duke, now, now);
220         pr.comments = List.of(testComment, cancelComment);
221 
222         var approvers = &quot;0&quot;;
223         host.groups = Map.of(approvers, Set.of());
224 
225         var state = State.from(pr, approvers);
226         assertEquals(Stage.CANCELLED, state.stage());
227         assertEquals(testComment, state.requested());
228         assertEquals(cancelComment, state.cancelled());
229         assertEquals(null, state.pending());
230         assertEquals(null, state.started());
231     }
232 
233     @Test
234     void cancelCommentFromAnotherUserShouldHaveNoEffect() {
235         var bot = new HostUser(1, &quot;bot&quot;, &quot;openjdk [bot]&quot;);
236 
237         var host = new InMemoryHost();
238         host.currentUserDetails = bot;
239 
240         var repo = new InMemoryHostedRepository();
241         repo.host = host;
242 
243         var pr = new InMemoryPullRequest();
244         pr.repository = repo;
245 
246         var duke = new HostUser(0, &quot;duke&quot;, &quot;Duke&quot;);
247         pr.author = duke;
248 
249         var user = new HostUser(0, &quot;foo&quot;, &quot;Foo Bar&quot;);
250 
251         var now = ZonedDateTime.now();
252         var testComment = new Comment(&quot;0&quot;, &quot;/test tier1&quot;, duke, now, now);
253         var cancelComment = new Comment(&quot;1&quot;, &quot;/test cancel&quot;, user, now, now);
254         pr.comments = List.of(testComment, cancelComment);
255 
256         var approvers = &quot;0&quot;;
257         host.groups = Map.of(approvers, Set.of());
258 
259         var state = State.from(pr, approvers);
260         assertEquals(Stage.REQUESTED, state.stage());
261         assertEquals(testComment, state.requested());
262         assertEquals(null, state.cancelled());
263         assertEquals(null, state.pending());
264         assertEquals(null, state.started());
265     }
266 
267     @Test
268     void multipleTestCommentsShouldOnlyCareAboutLast() {
269         var bot = new HostUser(1, &quot;bot&quot;, &quot;openjdk [bot]&quot;);
270 
271         var host = new InMemoryHost();
272         host.currentUserDetails = bot;
273 
274         var repo = new InMemoryHostedRepository();
275         repo.host = host;
276 
277         var pr = new InMemoryPullRequest();
278         pr.repository = repo;
279 
280         var duke = new HostUser(0, &quot;duke&quot;, &quot;Duke&quot;);
281         pr.author = duke;
282 
283         var now = ZonedDateTime.now();
284         var test1Comment = new Comment(&quot;0&quot;, &quot;/test tier1&quot;, duke, now, now);
285         var test2Comment = new Comment(&quot;1&quot;, &quot;/test tier1,tier2&quot;, duke, now, now);
286         var test3Comment = new Comment(&quot;2&quot;, &quot;/test tier1,tier2,tier3&quot;, duke, now, now);
287         pr.comments = List.of(test1Comment, test2Comment, test3Comment);
288 
289         var approvers = &quot;0&quot;;
290         host.groups = Map.of(approvers, Set.of());
291 
292         var state = State.from(pr, approvers);
293         assertEquals(Stage.REQUESTED, state.stage());
294         assertEquals(test3Comment, state.requested());
295         assertEquals(null, state.cancelled());
296         assertEquals(null, state.pending());
297         assertEquals(null, state.started());
298     }
299 
300     @Test
301     void errorAfterRequestedShouldBeError() {
302         var bot = new HostUser(1, &quot;bot&quot;, &quot;openjdk [bot]&quot;);
303 
304         var host = new InMemoryHost();
305         host.currentUserDetails = bot;
306 
307         var repo = new InMemoryHostedRepository();
308         repo.host = host;
309 
310         var pr = new InMemoryPullRequest();
311         pr.repository = repo;
312 
313         var duke = new HostUser(0, &quot;duke&quot;, &quot;Duke&quot;);
314         pr.author = duke;
315 
316         var now = ZonedDateTime.now();
317         var testComment = new Comment(&quot;0&quot;, &quot;/test tier1&quot;, duke, now, now);
318 
319         var lines = List.of(
320             &quot;&lt;!-- TEST ERROR --&gt;&quot;,
321             &quot;The test tier1 does not exist&quot;
322         );
323         var errorComment = new Comment(&quot;2&quot;, String.join(&quot;\n&quot;, lines), bot, now, now);
324         pr.comments = List.of(testComment, errorComment);
325 
326         var approvers = &quot;0&quot;;
327         host.groups = Map.of(approvers, Set.of());
328 
329         var state = State.from(pr, approvers);
330         assertEquals(Stage.ERROR, state.stage());
331         assertEquals(testComment, state.requested());
332         assertEquals(null, state.pending());
333         assertEquals(null, state.started());
334     }
335 
336     @Test
337     void testFinishedCommentShouldResultInFinished() {
338         var bot = new HostUser(1, &quot;bot&quot;, &quot;openjdk [bot]&quot;);
339 
340         var host = new InMemoryHost();
341         host.currentUserDetails = bot;
342 
343         var repo = new InMemoryHostedRepository();
344         repo.host = host;
345 
346         var pr = new InMemoryPullRequest();
347         pr.repository = repo;
348 
349         var duke = new HostUser(0, &quot;duke&quot;, &quot;Duke&quot;);
350         pr.author = duke;
351 
352         var now = ZonedDateTime.now();
353         var testComment = new Comment(&quot;0&quot;, &quot;/test tier1&quot;, duke, now, now);
354 
355         var pendingBody = List.of(
356             &quot;&lt;!-- TEST PENDING --&gt;&quot;,
357             &quot;&lt;!-- tier1 --&gt;&quot;,
358             &quot;@duke you need to get approval to run these tests&quot;
359         );
360         var pendingComment = new Comment(&quot;1&quot;, String.join(&quot;\n&quot;, pendingBody), bot, now, now);
361 
362         var member = new HostUser(2, &quot;foo&quot;, &quot;Foo Bar&quot;);
363         var approveComment = new Comment(&quot;2&quot;, &quot;/test approve&quot;, member, now, now);
364 
365         var startedBody = List.of(
366             &quot;&lt;!-- TEST STARTED --&gt;&quot;,
367             &quot;&lt;!-- 0 --&gt;&quot;,
368             &quot;A test job has been started with id 0&quot;
369         );
370         var startedComment = new Comment(&quot;3&quot;, String.join(&quot;\n&quot;, startedBody), bot, now, now);
371 
372         var finishedBody = List.of(
373             &quot;&lt;!-- TEST FINISHED --&gt;&quot;,
374             &quot;&lt;!-- 0 --&gt;&quot;,
375             &quot;A test job has been started with id 0&quot;
376         );
377         var finishedComment = new Comment(&quot;4&quot;, String.join(&quot;\n&quot;, finishedBody), bot, now, now);
378 
379         pr.comments = List.of(testComment, pendingComment, approveComment, startedComment, finishedComment);
380 
381         var approvers = &quot;0&quot;;
382         host.groups = Map.of(approvers, Set.of(member));
383 
384         var state = State.from(pr, approvers);
385         assertEquals(Stage.FINISHED, state.stage());
386         assertEquals(testComment, state.requested());
387         assertEquals(pendingComment, state.pending());
388         assertEquals(startedComment, state.started());
389         assertEquals(finishedComment, state.finished());
390     }
391 }
    </pre>
  </body>
</html>