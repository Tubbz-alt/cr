<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff cli/src/main/java/org/openjdk/skara/cli/GitPr.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>cli/src/main/java/org/openjdk/skara/cli/GitPr.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  41 import java.util.concurrent.TimeUnit;
  42 import java.util.function.Supplier;
  43 import java.util.logging.Level;
  44 import java.util.stream.Collectors;
  45 
  46 public class GitPr {
  47     private static final StandardOpenOption APPEND = StandardOpenOption.APPEND;
  48 
  49     private static void exit(String fmt, Object...args) {
  50         System.err.println(String.format(fmt, args));
  51         System.exit(1);
  52     }
  53 
  54     private static &lt;T&gt; Supplier&lt;T&gt; die(String fmt, Object... args) {
  55         return () -&gt; {
  56             exit(fmt, args);
  57             return null;
  58         };
  59     }
  60 




























































  61     private static String rightPad(String s, int length) {
  62         return String.format(&quot;%-&quot; + length + &quot;s&quot;, s);
  63     }
  64 
  65     private static void appendPaddedHTMLComment(Path file, String line) throws IOException {
  66         var end = &quot; --&gt;&quot;;
  67         var pad = 79 - end.length();
  68         var newLine = &quot;\n&quot;;
  69         Files.writeString(file, rightPad(&quot;&lt;!-- &quot; + line, pad) + end + newLine, StandardOpenOption.APPEND);
  70     }
  71 
  72     private static String format(Issue issue) {
  73         var parts = issue.id().split(&quot;-&quot;);
  74         var id = parts.length == 2 ? parts[1] : issue.id();
  75         return id + &quot;: &quot; + issue.title();
  76     }
  77 
  78     private static String jbsProjectFromJcheckConf(Repository repo) throws IOException {
  79         var conf = JCheckConfiguration.from(repo, repo.resolve(&quot;master&quot;).orElseThrow(() -&gt;
  80             new IOException(&quot;Could not resolve &#39;master&#39; branch&quot;)
</pre>
<hr />
<pre>
 371                  .describe(&quot;ID&quot;)
 372                  .singular()
 373                  .optional()
 374         );
 375 
 376         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);
 377         var arguments = parser.parse(args);
 378 
 379         if (arguments.contains(&quot;version&quot;)) {
 380             System.out.println(&quot;git-pr version: &quot; + Version.fromManifest().orElse(&quot;unknown&quot;));
 381             System.exit(0);
 382         }
 383 
 384         if (arguments.contains(&quot;verbose&quot;) || arguments.contains(&quot;debug&quot;)) {
 385             var level = arguments.contains(&quot;debug&quot;) ? Level.FINER : Level.FINE;
 386             Logging.setup(level);
 387         }
 388 
 389         HttpProxy.setup();
 390 
<span class="line-modified"> 391         var isMercurial = arguments.contains(&quot;mercurial&quot;);</span>
 392         var cwd = Path.of(&quot;&quot;).toAbsolutePath();
 393         var repo = Repository.get(cwd).orElseThrow(() -&gt; new IOException(&quot;no git repository found at &quot; + cwd.toString()));
<span class="line-modified"> 394         var remote = arguments.get(&quot;remote&quot;).orString(isMercurial ? &quot;default&quot; : &quot;origin&quot;);</span>



 395         var remotePullPath = repo.pullPath(remote);
<span class="line-modified"> 396         var username = arguments.contains(&quot;username&quot;) ? arguments.get(&quot;username&quot;).asString() : null;</span>
<span class="line-modified"> 397         var token = isMercurial ? System.getenv(&quot;HG_TOKEN&quot;) :  System.getenv(&quot;GIT_TOKEN&quot;);</span>
 398         var uri = Remote.toWebURI(remotePullPath);
<span class="line-modified"> 399         var shouldUseToken = !arguments.contains(&quot;no-token&quot;);</span>
 400         var credentials = !shouldUseToken ?
 401             null :
 402             GitCredentials.fill(uri.getHost(), uri.getPath(), username, token, uri.getScheme());
 403         var forgeURI = URI.create(uri.getScheme() + &quot;://&quot; + uri.getHost());
 404         var forge = credentials == null ?
 405             Forge.from(forgeURI) :
 406             Forge.from(forgeURI, new Credential(credentials.username(), credentials.password()));
 407         if (forge.isEmpty()) {
 408             if (!shouldUseToken) {
 409                 if (arguments.contains(&quot;verbose&quot;)) {
 410                     System.err.println(&quot;&quot;);
 411                 }
 412                 System.err.println(&quot;warning: using git-pr with --no-token may result in rate limiting from &quot; + forgeURI);
 413                 if (!arguments.contains(&quot;verbose&quot;)) {
 414                     System.err.println(&quot;         Re-run git-pr with --verbose to see if you are being rate limited&quot;);
 415                     System.err.println(&quot;&quot;);
 416                 }
 417             }
 418             exit(&quot;error: failed to connect to host: &quot; + forgeURI);
 419         }
</pre>
<hr />
<pre>
 611                 Files.deleteIfExists(file);
 612 
 613                 System.exit(0);
 614             }
 615             var currentBranch = repo.currentBranch().orElseGet(() -&gt; {
 616                     System.err.println(&quot;error: the repository is in a detached HEAD state&quot;);
 617                     System.exit(1);
 618                     return null;
 619             });
 620             if (currentBranch.equals(repo.defaultBranch())) {
 621                 System.err.println(&quot;error: you should not create pull requests from the &#39;master&#39; branch&quot;);
 622                 System.err.println(&quot;&quot;);
 623                 System.err.println(&quot;To create a local branch for your changes and restore the &#39;master&#39; branch, run:&quot;);
 624                 System.err.println(&quot;&quot;);
 625                 System.err.println(&quot;    git checkout -b NAME-FOR-YOUR-LOCAL-BRANCH&quot;);
 626                 System.err.println(&quot;    git branch --force master origin/master&quot;);
 627                 System.err.println(&quot;&quot;);
 628                 System.exit(1);
 629             }
 630 
<span class="line-modified"> 631             var ignoreWorkspace = arguments.contains(&quot;ignore-workspace&quot;);</span>
<span class="line-removed"> 632             if (!ignoreWorkspace) {</span>
<span class="line-removed"> 633                 var lines = repo.config(&quot;pr.ignore-workspace&quot;);</span>
<span class="line-removed"> 634                 ignoreWorkspace = lines.size() == 1 &amp;&amp; lines.get(0).equals(&quot;true&quot;);</span>
<span class="line-removed"> 635             }</span>
 636             if (!ignoreWorkspace) {
 637                 var diff = repo.diff(repo.head());
 638                 if (!diff.patches().isEmpty()) {
 639                     System.err.println(&quot;error: there are uncommitted changes in your working tree:&quot;);
 640                     System.err.println(&quot;&quot;);
 641                     for (var patch : diff.patches()) {
 642                         var path = patch.target().path().isPresent() ?
 643                             patch.target().path().get() : patch.source().path().get();
 644                         System.err.println(&quot;    &quot; + patch.status().toString() + &quot; &quot; + path.toString());
 645                     }
 646                     System.err.println(&quot;&quot;);
 647                     System.err.println(&quot;If these changes are meant to be part of the pull request, run:&quot;);
 648                     System.err.println(&quot;&quot;);
 649                     System.err.println(&quot;    git commit -am &#39;Forgot to add some changes&#39;&quot;);
 650                     System.err.println(&quot;&quot;);
 651                     System.err.println(&quot;If these changes are *not* meant to be part of the pull request, run:&quot;);
 652                     System.err.println(&quot;&quot;);
 653                     System.err.println(&quot;    git stash&quot;);
 654                     System.err.println(&quot;&quot;);
 655                     System.err.println(&quot;(You can later restore the changes by running: git stash pop)&quot;);
 656                     System.exit(1);
 657                 }
 658             }
 659 
 660             var upstream = repo.upstreamFor(currentBranch);
 661             if (upstream.isEmpty()) {
<span class="line-modified"> 662                 var shouldPublish = arguments.contains(&quot;publish&quot;);</span>
<span class="line-removed"> 663                 if (!shouldPublish) {</span>
<span class="line-removed"> 664                     var lines = repo.config(&quot;pr.publish&quot;);</span>
<span class="line-removed"> 665                     shouldPublish = lines.size() == 1 &amp;&amp; lines.get(0).toLowerCase().equals(&quot;true&quot;);</span>
<span class="line-removed"> 666                 }</span>
 667                 if (shouldPublish) {
 668                     GitPublish.main(new String[] { &quot;--quiet&quot;, remote });
 669                     upstream = repo.upstreamFor(currentBranch);
 670                 } else {
 671                     System.err.println(&quot;error: there is no remote branch for the local branch &#39;&quot; + currentBranch.name() + &quot;&#39;&quot;);
 672                     System.err.println(&quot;&quot;);
 673                     System.err.println(&quot;A remote branch must be present at &quot; + remotePullPath + &quot; to create a pull request&quot;);
 674                     System.err.println(&quot;To create a remote branch and push the commits for your local branch, run:&quot;);
 675                     System.err.println(&quot;&quot;);
 676                     System.err.println(&quot;    git publish&quot;);
 677                     System.err.println(&quot;&quot;);
 678                     System.err.println(&quot;If you created the remote branch from another client, you must update this repository.&quot;);
 679                     System.err.println(&quot;To update remote information for this repository, run:&quot;);
 680                     System.err.println(&quot;&quot;);
 681                     System.err.println(&quot;    git fetch &quot; + remote);
 682                     System.err.println(&quot;    git branch --set-upstream &quot; + currentBranch + &quot; &quot; + remote + &quot;/&quot; + currentBranch);
 683                     System.err.println(&quot;&quot;);
 684                     System.exit(1);
 685                 }
 686             }
 687 
 688             var upstreamRefName = upstream.get().substring(remote.length() + 1);
 689             repo.fetch(uri, upstreamRefName);
 690 
<span class="line-modified"> 691             var shouldIgnoreLocalCommits = arguments.contains(&quot;ignore-local-commits&quot;);</span>
<span class="line-removed"> 692             if (!shouldIgnoreLocalCommits) {</span>
<span class="line-removed"> 693                 var lines = repo.config(&quot;pr.ignore-local-commits&quot;);</span>
<span class="line-removed"> 694                 shouldIgnoreLocalCommits = lines.size() == 1 &amp;&amp; lines.get(0).toLowerCase().equals(&quot;true&quot;);</span>
<span class="line-removed"> 695             }</span>
 696             if (!shouldIgnoreLocalCommits) {
 697                 var branchCommits = repo.commits(upstream.get() + &quot;..&quot; + currentBranch.name()).asList();
 698                 if (!branchCommits.isEmpty()) {
 699                     System.err.println(&quot;error: there are local commits on branch &#39;&quot; + currentBranch.name() + &quot;&#39; not present in the remote repository &quot; + remotePullPath);
 700                     System.err.println(&quot;&quot;);
 701                     System.err.println(&quot;All commits must be present in the remote repository to be part of the pull request&quot;);
 702                     System.err.println(&quot;The following commits are not present in the remote repository:&quot;);
 703                     System.err.println(&quot;&quot;);
 704                     for (var commit : branchCommits) {
 705                         System.err.println(&quot;- &quot; + commit.hash().abbreviate() + &quot;: &quot; + commit.message().get(0));
 706                     }
 707                     System.err.println(&quot;&quot;);
 708                     System.err.println(&quot;To push the above local commits to the remote repository, run:&quot;);
 709                     System.err.println(&quot;&quot;);
 710                     System.err.println(&quot;    git push &quot; + remote + &quot; &quot; + currentBranch.name());
 711                     System.err.println(&quot;&quot;);
 712                     System.exit(1);
 713                 }
 714             }
 715 
<span class="line-modified"> 716             var targetBranch = arguments.get(&quot;branch&quot;).orString(&quot;master&quot;);</span>



 717             var commits = repo.commits(targetBranch + &quot;..&quot; + upstream.get()).asList();
 718             if (commits.isEmpty()) {
 719                 System.err.println(&quot;error: no difference between branches &quot; + targetBranch + &quot; and &quot; + currentBranch.name());
 720                 System.err.println(&quot;       Cannot create an empty pull request, have you committed?&quot;);
 721                 System.exit(1);
 722             }
 723 
<span class="line-modified"> 724             var shouldRunJCheck = arguments.contains(&quot;jcheck&quot;);</span>
<span class="line-removed"> 725             if (!shouldRunJCheck) {</span>
<span class="line-removed"> 726                 var lines = repo.config(&quot;pr.jcheck&quot;);</span>
<span class="line-removed"> 727                 shouldRunJCheck = lines.size() == 1 &amp;&amp; lines.get(0).toLowerCase().equals(&quot;true&quot;);</span>
<span class="line-removed"> 728             }</span>
 729             if (shouldRunJCheck) {
 730                 var jcheckArgs = new String[]{ &quot;--pull-request&quot;, &quot;--rev&quot;, targetBranch + &quot;..&quot; + upstream.get() };
 731                 var err = GitJCheck.run(jcheckArgs);
 732                 if (err != 0) {
 733                     System.exit(err);
 734                 }
 735             }
 736 
 737             var remoteRepo = host.repository(projectName(uri)).orElseThrow(() -&gt;
 738                     new IOException(&quot;Could not find repository at &quot; + uri.toString())
 739             );
 740             if (token == null) {
 741                 GitCredentials.approve(credentials);
 742             }
 743             var parentRepo = remoteRepo.parent().orElseThrow(() -&gt;
 744                     new IOException(&quot;error: remote repository &quot; + remotePullPath + &quot; is not a fork of any repository&quot;));
 745 
 746             var project = jbsProjectFromJcheckConf(repo);
 747             var issue = getIssue(currentBranch, project);
 748             var file = Files.createTempFile(&quot;PULL_REQUEST_&quot;, &quot;.md&quot;);
</pre>
<hr />
<pre>
 813                              .filter(l -&gt; !(l.startsWith(&quot;&lt;!--&quot;) &amp;&amp; l.endsWith(&quot;--&gt;&quot;)))
 814                              .collect(Collectors.toList());
 815             var isEmpty = lines.stream().allMatch(String::isEmpty);
 816             if (isEmpty) {
 817                 System.err.println(&quot;error: no message present, aborting&quot;);
 818                 System.exit(1);
 819             }
 820 
 821             var title = lines.get(0);
 822             List&lt;String&gt; body = null;
 823             if (lines.size() &gt; 1) {
 824                 body = lines.subList(1, lines.size())
 825                             .stream()
 826                             .dropWhile(String::isEmpty)
 827                             .collect(Collectors.toList());
 828             } else {
 829                 body = Collections.emptyList();
 830             }
 831 
 832             var pr = remoteRepo.createPullRequest(parentRepo, targetBranch, currentBranch.name(), title, body);
<span class="line-modified"> 833             if (arguments.contains(&quot;assignees&quot;)) {</span>
<span class="line-modified"> 834                 var usernames = Arrays.asList(arguments.get(&quot;assignees&quot;).asString().split(&quot;,&quot;));</span>

 835                 var assignees = usernames.stream()
 836                                          .map(u -&gt; host.user(u))
 837                                          .collect(Collectors.toList());
 838                 pr.setAssignees(assignees);
 839             }
 840             System.out.println(pr.webUrl().toString());
 841             Files.deleteIfExists(file);
 842 
 843             repo.config(&quot;pr.&quot; + currentBranch.name(), &quot;id&quot;, pr.id().toString());
 844         } else if (action.equals(&quot;integrate&quot;) || action.equals(&quot;approve&quot;) || action.equals(&quot;test&quot;)) {
 845             String id = null;
 846             if (arguments.at(1).isPresent()) {
 847                 id = arguments.at(1).asString();
 848             } else {
 849                 if (action.equals(&quot;approve&quot;)) {
 850                     exit(&quot;error: you must provide a pull request id&quot;);
 851                 } else {
 852                     var currentBranch = repo.currentBranch();
 853                     if (currentBranch.isPresent()) {
 854                         var lines = repo.config(&quot;pr.&quot; + currentBranch.get().name() + &quot;.id&quot;);
</pre>
<hr />
<pre>
 864             var pr = getPullRequest(uri, repo, host, id);
 865 
 866             if (action.equals(&quot;integrate&quot;)) {
 867                 pr.addComment(&quot;/integrate&quot;);
 868             } else if (action.equals(&quot;test&quot;)) {
 869                 pr.addComment(&quot;/test&quot;);
 870             } else if (action.equals(&quot;approve&quot;)) {
 871                 pr.addReview(Review.Verdict.APPROVED, &quot;Looks good!&quot;);
 872             } else {
 873                 throw new IllegalStateException(&quot;unexpected action: &quot; + action);
 874             }
 875         } else if (action.equals(&quot;list&quot;)) {
 876             var remoteRepo = getHostedRepositoryFor(uri, repo, host);
 877             var prs = remoteRepo.pullRequests();
 878             var ids = new ArrayList&lt;String&gt;();
 879             var titles = new ArrayList&lt;String&gt;();
 880             var authors = new ArrayList&lt;String&gt;();
 881             var assignees = new ArrayList&lt;String&gt;();
 882             var labels = new ArrayList&lt;String&gt;();
 883 
<span class="line-modified"> 884             var filterAuthors = arguments.contains(&quot;authors&quot;) ?</span>
<span class="line-modified"> 885                 new HashSet&lt;&gt;(Arrays.asList(arguments.get(&quot;authors&quot;).asString().split(&quot;,&quot;))) :</span>
<span class="line-modified"> 886                 Set.of();</span>
<span class="line-modified"> 887             var filterAssignees = arguments.contains(&quot;assignees&quot;) ?</span>
<span class="line-modified"> 888                 Arrays.asList(arguments.get(&quot;assignees&quot;).asString().split(&quot;,&quot;)) :</span>
<span class="line-modified"> 889                 Set.of();</span>
<span class="line-modified"> 890             var filterLabels = arguments.contains(&quot;labels&quot;) ?</span>
<span class="line-modified"> 891                 Arrays.asList(arguments.get(&quot;labels&quot;).asString().split(&quot;,&quot;)) :</span>
<span class="line-modified"> 892                 Set.of();</span>





 893 
 894             var defaultColumns = List.of(&quot;id&quot;, &quot;title&quot;, &quot;authors&quot;, &quot;assignees&quot;, &quot;labels&quot;);
 895             var columnValues = Map.of(defaultColumns.get(0), ids,
 896                                       defaultColumns.get(1), titles,
 897                                       defaultColumns.get(2), authors,
 898                                       defaultColumns.get(3), assignees,
 899                                       defaultColumns.get(4), labels);
<span class="line-modified"> 900             var columns = arguments.contains(&quot;columns&quot;) ?</span>
<span class="line-modified"> 901                 Arrays.asList(arguments.get(&quot;columns&quot;).asString().split(&quot;,&quot;)) :</span>
<span class="line-modified"> 902                 defaultColumns;</span>

 903             if (columns != defaultColumns) {
 904                 for (var column : columns) {
 905                     if (!defaultColumns.contains(column)) {
 906                         System.err.println(&quot;error: unknown column: &quot; + column);
 907                         System.err.println(&quot;       available columns are: &quot; + String.join(&quot;,&quot;, defaultColumns));
 908                         System.exit(1);
 909                     }
 910                 }
 911             }
 912 
 913             for (var pr : prs) {
 914                 var prAuthor = pr.author().userName();
 915                 if (!filterAuthors.isEmpty() &amp;&amp; !filterAuthors.contains(prAuthor)) {
 916                     continue;
 917                 }
 918 
 919                 var prAssignees = pr.assignees().stream()
 920                                     .map(HostUser::userName)
 921                                     .collect(Collectors.toSet());
 922                 if (!filterAssignees.isEmpty() &amp;&amp; !filterAssignees.stream().anyMatch(prAssignees::contains)) {
</pre>
<hr />
<pre>
 927                 if (!filterLabels.isEmpty() &amp;&amp; !filterLabels.stream().anyMatch(prLabels::contains)) {
 928                     continue;
 929                 }
 930 
 931                 ids.add(pr.id());
 932                 titles.add(pr.title());
 933                 authors.add(prAuthor);
 934                 assignees.add(String.join(&quot;,&quot;, prAssignees));
 935                 labels.add(String.join(&quot;,&quot;, prLabels));
 936             }
 937 
 938 
 939             String fmt = &quot;&quot;;
 940             for (var column : columns.subList(0, columns.size() - 1)) {
 941                 var values = columnValues.get(column);
 942                 var n = Math.max(column.length(), longest(values));
 943                 fmt += &quot;%-&quot; + n + &quot;s\t&quot;;
 944             }
 945             fmt += &quot;%s\n&quot;;
 946 
<span class="line-modified"> 947             if (!ids.isEmpty() &amp;&amp; !arguments.contains(&quot;no-decoration&quot;)) {</span>

 948                 var upperCase = columns.stream()
 949                                        .map(String::toUpperCase)
 950                                        .collect(Collectors.toList());
 951                 System.out.format(fmt, (Object[]) upperCase.toArray(new String[0]));
 952             }
 953             for (var i = 0; i &lt; ids.size(); i++) {
 954                 final int n = i;
 955                 var row = columns.stream()
 956                                  .map(columnValues::get)
 957                                  .map(values -&gt; values.get(n))
 958                                  .collect(Collectors.toList());
 959                 System.out.format(fmt, (Object[]) row.toArray(new String[0]));
 960             }
 961         } else if (action.equals(&quot;fetch&quot;) || action.equals(&quot;checkout&quot;) || action.equals(&quot;show&quot;) || action.equals(&quot;apply&quot;)) {
 962             var prId = arguments.at(1);
 963             if (!prId.isPresent()) {
 964                 exit(&quot;error: missing pull request identifier&quot;);
 965             }
 966 
 967             var remoteRepo = getHostedRepositoryFor(uri, repo, host);
</pre>
<hr />
<pre>
 994                     gimport();
 995                     var hgFetchHead = repo.resolve(hgGitRef).get();
 996 
 997                     if (action.equals(&quot;fetch&quot;) &amp;&amp; arguments.contains(&quot;branch&quot;)) {
 998                         repo.branch(hgFetchHead, arguments.get(&quot;branch&quot;).asString());
 999                     } else if (action.equals(&quot;checkout&quot;)) {
1000                         repo.checkout(hgFetchHead);
1001                         if (arguments.contains(&quot;branch&quot;)) {
1002                             repo.branch(hgFetchHead, arguments.get(&quot;branch&quot;).asString());
1003                         }
1004                     }
1005                 } else {
1006                     exit(&quot;Unexpected action: &quot; + action);
1007                 }
1008 
1009                 return;
1010             }
1011 
1012             var fetchHead = repo.fetch(repoUrl, pr.sourceRef());
1013             if (action.equals(&quot;fetch&quot;)) {
<span class="line-modified">1014                 if (arguments.contains(&quot;branch&quot;)) {</span>
<span class="line-modified">1015                     var branchName = arguments.get(&quot;branch&quot;).asString();</span>
1016                     repo.branch(fetchHead, branchName);
1017                 } else {
1018                     System.out.println(fetchHead.hex());
1019                 }
1020             } else if (action.equals(&quot;checkout&quot;)) {
<span class="line-modified">1021                 if (arguments.contains(&quot;branch&quot;)) {</span>
<span class="line-modified">1022                     var branchName = arguments.get(&quot;branch&quot;).asString();</span>
1023                     var branch = repo.branch(fetchHead, branchName);
1024                     repo.checkout(branch, false);
1025                 } else {
1026                     repo.checkout(fetchHead, false);
1027                 }
1028             } else if (action.equals(&quot;show&quot;)) {
1029                 show(pr.targetRef(), fetchHead);
1030             } else if (action.equals(&quot;apply&quot;)) {
1031                 var patch = diff(pr.targetRef(), fetchHead);
1032                 apply(patch);
1033                 Files.deleteIfExists(patch);
1034             }
1035         } else if (action.equals(&quot;close&quot;)) {
1036             var prId = arguments.at(1);
1037             if (!prId.isPresent()) {
1038                 exit(&quot;error: missing pull request identifier&quot;);
1039             }
1040 
1041             var remoteRepo = getHostedRepositoryFor(uri, repo, host);
1042             var pr = remoteRepo.pullRequest(prId.asString());
1043             pr.setState(PullRequest.State.CLOSED);
1044         } else if (action.equals(&quot;update&quot;)) {
1045             var prId = arguments.at(1);
1046             if (!prId.isPresent()) {
1047                 exit(&quot;error: missing pull request identifier&quot;);
1048             }
1049 
1050             var remoteRepo = getHostedRepositoryFor(uri, repo, host);
1051             var pr = remoteRepo.pullRequest(prId.asString());
<span class="line-modified">1052             if (arguments.contains(&quot;assignees&quot;)) {</span>
<span class="line-modified">1053                 var usernames = Arrays.asList(arguments.get(&quot;assignees&quot;).asString().split(&quot;,&quot;));</span>

1054                 var assignees = usernames.stream()
1055                     .map(u -&gt; host.user(u))
1056                     .collect(Collectors.toList());
1057                 pr.setAssignees(assignees);
1058             }
1059         } else {
1060             exit(&quot;error: unexpected action: &quot; + action);
1061         }
1062     }
1063 }
</pre>
</td>
<td>
<hr />
<pre>
  41 import java.util.concurrent.TimeUnit;
  42 import java.util.function.Supplier;
  43 import java.util.logging.Level;
  44 import java.util.stream.Collectors;
  45 
  46 public class GitPr {
  47     private static final StandardOpenOption APPEND = StandardOpenOption.APPEND;
  48 
  49     private static void exit(String fmt, Object...args) {
  50         System.err.println(String.format(fmt, args));
  51         System.exit(1);
  52     }
  53 
  54     private static &lt;T&gt; Supplier&lt;T&gt; die(String fmt, Object... args) {
  55         return () -&gt; {
  56             exit(fmt, args);
  57             return null;
  58         };
  59     }
  60 
<span class="line-added">  61     private static String gitConfig(String key) {</span>
<span class="line-added">  62         try {</span>
<span class="line-added">  63             var pb = new ProcessBuilder(&quot;git&quot;, &quot;config&quot;, key);</span>
<span class="line-added">  64             pb.redirectOutput(ProcessBuilder.Redirect.PIPE);</span>
<span class="line-added">  65             pb.redirectError(ProcessBuilder.Redirect.DISCARD);</span>
<span class="line-added">  66             var p = pb.start();</span>
<span class="line-added">  67 </span>
<span class="line-added">  68             var output = new String(p.getInputStream().readAllBytes(), StandardCharsets.UTF_8);</span>
<span class="line-added">  69             var res = p.waitFor();</span>
<span class="line-added">  70             if (res != 0) {</span>
<span class="line-added">  71                 return null;</span>
<span class="line-added">  72             }</span>
<span class="line-added">  73 </span>
<span class="line-added">  74             return output == null ? null : output.replace(&quot;\n&quot;, &quot;&quot;);</span>
<span class="line-added">  75         } catch (InterruptedException e) {</span>
<span class="line-added">  76             return null;</span>
<span class="line-added">  77         } catch (IOException e) {</span>
<span class="line-added">  78             return null;</span>
<span class="line-added">  79         }</span>
<span class="line-added">  80     }</span>
<span class="line-added">  81 </span>
<span class="line-added">  82     private static String getOption(String name, Arguments arguments) {</span>
<span class="line-added">  83         return getOption(name, null, arguments);</span>
<span class="line-added">  84     }</span>
<span class="line-added">  85 </span>
<span class="line-added">  86     private static String getOption(String name, String subsection, Arguments arguments) {</span>
<span class="line-added">  87         if (arguments.contains(name)) {</span>
<span class="line-added">  88             return arguments.get(name).asString();</span>
<span class="line-added">  89         }</span>
<span class="line-added">  90 </span>
<span class="line-added">  91         if (subsection != null &amp;&amp; !subsection.isEmpty()) {</span>
<span class="line-added">  92             var subsectionSpecific = gitConfig(&quot;pr.&quot; + subsection + &quot;.&quot; + name);</span>
<span class="line-added">  93             if (subsectionSpecific != null) {</span>
<span class="line-added">  94                 return subsectionSpecific;</span>
<span class="line-added">  95             }</span>
<span class="line-added">  96         }</span>
<span class="line-added">  97 </span>
<span class="line-added">  98         return gitConfig(&quot;fork.&quot; + name);</span>
<span class="line-added">  99     }</span>
<span class="line-added"> 100 </span>
<span class="line-added"> 101     private static boolean getSwitch(String name, Arguments arguments) {</span>
<span class="line-added"> 102         return getSwitch(name, null, arguments);</span>
<span class="line-added"> 103     }</span>
<span class="line-added"> 104 </span>
<span class="line-added"> 105     private static boolean getSwitch(String name, String subsection, Arguments arguments) {</span>
<span class="line-added"> 106         if (arguments.contains(name)) {</span>
<span class="line-added"> 107             return true;</span>
<span class="line-added"> 108         }</span>
<span class="line-added"> 109 </span>
<span class="line-added"> 110         if (subsection != null &amp;&amp; !subsection.isEmpty()) {</span>
<span class="line-added"> 111             var subsectionSpecific = gitConfig(&quot;pr.&quot; + subsection + &quot;.&quot; + name);</span>
<span class="line-added"> 112             if (subsectionSpecific != null) {</span>
<span class="line-added"> 113                 return subsectionSpecific.toLowerCase().equals(&quot;true&quot;);</span>
<span class="line-added"> 114             }</span>
<span class="line-added"> 115         }</span>
<span class="line-added"> 116 </span>
<span class="line-added"> 117         var sectionSpecific = gitConfig(&quot;fork.&quot; + name);</span>
<span class="line-added"> 118         return sectionSpecific != null &amp;&amp; sectionSpecific.toLowerCase().equals(&quot;true&quot;);</span>
<span class="line-added"> 119     }</span>
<span class="line-added"> 120 </span>
 121     private static String rightPad(String s, int length) {
 122         return String.format(&quot;%-&quot; + length + &quot;s&quot;, s);
 123     }
 124 
 125     private static void appendPaddedHTMLComment(Path file, String line) throws IOException {
 126         var end = &quot; --&gt;&quot;;
 127         var pad = 79 - end.length();
 128         var newLine = &quot;\n&quot;;
 129         Files.writeString(file, rightPad(&quot;&lt;!-- &quot; + line, pad) + end + newLine, StandardOpenOption.APPEND);
 130     }
 131 
 132     private static String format(Issue issue) {
 133         var parts = issue.id().split(&quot;-&quot;);
 134         var id = parts.length == 2 ? parts[1] : issue.id();
 135         return id + &quot;: &quot; + issue.title();
 136     }
 137 
 138     private static String jbsProjectFromJcheckConf(Repository repo) throws IOException {
 139         var conf = JCheckConfiguration.from(repo, repo.resolve(&quot;master&quot;).orElseThrow(() -&gt;
 140             new IOException(&quot;Could not resolve &#39;master&#39; branch&quot;)
</pre>
<hr />
<pre>
 431                  .describe(&quot;ID&quot;)
 432                  .singular()
 433                  .optional()
 434         );
 435 
 436         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);
 437         var arguments = parser.parse(args);
 438 
 439         if (arguments.contains(&quot;version&quot;)) {
 440             System.out.println(&quot;git-pr version: &quot; + Version.fromManifest().orElse(&quot;unknown&quot;));
 441             System.exit(0);
 442         }
 443 
 444         if (arguments.contains(&quot;verbose&quot;) || arguments.contains(&quot;debug&quot;)) {
 445             var level = arguments.contains(&quot;debug&quot;) ? Level.FINER : Level.FINE;
 446             Logging.setup(level);
 447         }
 448 
 449         HttpProxy.setup();
 450 
<span class="line-modified"> 451         var isMercurial = getSwitch(&quot;mercurial&quot;, arguments);</span>
 452         var cwd = Path.of(&quot;&quot;).toAbsolutePath();
 453         var repo = Repository.get(cwd).orElseThrow(() -&gt; new IOException(&quot;no git repository found at &quot; + cwd.toString()));
<span class="line-modified"> 454         var remote = getOption(&quot;remote&quot;, arguments);</span>
<span class="line-added"> 455         if (remote == null) {</span>
<span class="line-added"> 456             remote = isMercurial ? &quot;default&quot; : &quot;origin&quot;;</span>
<span class="line-added"> 457         }</span>
 458         var remotePullPath = repo.pullPath(remote);
<span class="line-modified"> 459         var username = getOption(&quot;username&quot;, arguments);</span>
<span class="line-modified"> 460         var token = isMercurial ? System.getenv(&quot;HG_TOKEN&quot;) : System.getenv(&quot;GIT_TOKEN&quot;);</span>
 461         var uri = Remote.toWebURI(remotePullPath);
<span class="line-modified"> 462         var shouldUseToken = !getSwitch(&quot;no-token&quot;, arguments);</span>
 463         var credentials = !shouldUseToken ?
 464             null :
 465             GitCredentials.fill(uri.getHost(), uri.getPath(), username, token, uri.getScheme());
 466         var forgeURI = URI.create(uri.getScheme() + &quot;://&quot; + uri.getHost());
 467         var forge = credentials == null ?
 468             Forge.from(forgeURI) :
 469             Forge.from(forgeURI, new Credential(credentials.username(), credentials.password()));
 470         if (forge.isEmpty()) {
 471             if (!shouldUseToken) {
 472                 if (arguments.contains(&quot;verbose&quot;)) {
 473                     System.err.println(&quot;&quot;);
 474                 }
 475                 System.err.println(&quot;warning: using git-pr with --no-token may result in rate limiting from &quot; + forgeURI);
 476                 if (!arguments.contains(&quot;verbose&quot;)) {
 477                     System.err.println(&quot;         Re-run git-pr with --verbose to see if you are being rate limited&quot;);
 478                     System.err.println(&quot;&quot;);
 479                 }
 480             }
 481             exit(&quot;error: failed to connect to host: &quot; + forgeURI);
 482         }
</pre>
<hr />
<pre>
 674                 Files.deleteIfExists(file);
 675 
 676                 System.exit(0);
 677             }
 678             var currentBranch = repo.currentBranch().orElseGet(() -&gt; {
 679                     System.err.println(&quot;error: the repository is in a detached HEAD state&quot;);
 680                     System.exit(1);
 681                     return null;
 682             });
 683             if (currentBranch.equals(repo.defaultBranch())) {
 684                 System.err.println(&quot;error: you should not create pull requests from the &#39;master&#39; branch&quot;);
 685                 System.err.println(&quot;&quot;);
 686                 System.err.println(&quot;To create a local branch for your changes and restore the &#39;master&#39; branch, run:&quot;);
 687                 System.err.println(&quot;&quot;);
 688                 System.err.println(&quot;    git checkout -b NAME-FOR-YOUR-LOCAL-BRANCH&quot;);
 689                 System.err.println(&quot;    git branch --force master origin/master&quot;);
 690                 System.err.println(&quot;&quot;);
 691                 System.exit(1);
 692             }
 693 
<span class="line-modified"> 694             var ignoreWorkspace = getSwitch(&quot;ignore-workspace&quot;, &quot;create&quot;, arguments);</span>




 695             if (!ignoreWorkspace) {
 696                 var diff = repo.diff(repo.head());
 697                 if (!diff.patches().isEmpty()) {
 698                     System.err.println(&quot;error: there are uncommitted changes in your working tree:&quot;);
 699                     System.err.println(&quot;&quot;);
 700                     for (var patch : diff.patches()) {
 701                         var path = patch.target().path().isPresent() ?
 702                             patch.target().path().get() : patch.source().path().get();
 703                         System.err.println(&quot;    &quot; + patch.status().toString() + &quot; &quot; + path.toString());
 704                     }
 705                     System.err.println(&quot;&quot;);
 706                     System.err.println(&quot;If these changes are meant to be part of the pull request, run:&quot;);
 707                     System.err.println(&quot;&quot;);
 708                     System.err.println(&quot;    git commit -am &#39;Forgot to add some changes&#39;&quot;);
 709                     System.err.println(&quot;&quot;);
 710                     System.err.println(&quot;If these changes are *not* meant to be part of the pull request, run:&quot;);
 711                     System.err.println(&quot;&quot;);
 712                     System.err.println(&quot;    git stash&quot;);
 713                     System.err.println(&quot;&quot;);
 714                     System.err.println(&quot;(You can later restore the changes by running: git stash pop)&quot;);
 715                     System.exit(1);
 716                 }
 717             }
 718 
 719             var upstream = repo.upstreamFor(currentBranch);
 720             if (upstream.isEmpty()) {
<span class="line-modified"> 721                 var shouldPublish = getSwitch(&quot;publish&quot;, &quot;create&quot;, arguments);</span>




 722                 if (shouldPublish) {
 723                     GitPublish.main(new String[] { &quot;--quiet&quot;, remote });
 724                     upstream = repo.upstreamFor(currentBranch);
 725                 } else {
 726                     System.err.println(&quot;error: there is no remote branch for the local branch &#39;&quot; + currentBranch.name() + &quot;&#39;&quot;);
 727                     System.err.println(&quot;&quot;);
 728                     System.err.println(&quot;A remote branch must be present at &quot; + remotePullPath + &quot; to create a pull request&quot;);
 729                     System.err.println(&quot;To create a remote branch and push the commits for your local branch, run:&quot;);
 730                     System.err.println(&quot;&quot;);
 731                     System.err.println(&quot;    git publish&quot;);
 732                     System.err.println(&quot;&quot;);
 733                     System.err.println(&quot;If you created the remote branch from another client, you must update this repository.&quot;);
 734                     System.err.println(&quot;To update remote information for this repository, run:&quot;);
 735                     System.err.println(&quot;&quot;);
 736                     System.err.println(&quot;    git fetch &quot; + remote);
 737                     System.err.println(&quot;    git branch --set-upstream &quot; + currentBranch + &quot; &quot; + remote + &quot;/&quot; + currentBranch);
 738                     System.err.println(&quot;&quot;);
 739                     System.exit(1);
 740                 }
 741             }
 742 
 743             var upstreamRefName = upstream.get().substring(remote.length() + 1);
 744             repo.fetch(uri, upstreamRefName);
 745 
<span class="line-modified"> 746             var shouldIgnoreLocalCommits = getSwitch(&quot;ignore-local-commits&quot;, &quot;create&quot;, arguments);</span>




 747             if (!shouldIgnoreLocalCommits) {
 748                 var branchCommits = repo.commits(upstream.get() + &quot;..&quot; + currentBranch.name()).asList();
 749                 if (!branchCommits.isEmpty()) {
 750                     System.err.println(&quot;error: there are local commits on branch &#39;&quot; + currentBranch.name() + &quot;&#39; not present in the remote repository &quot; + remotePullPath);
 751                     System.err.println(&quot;&quot;);
 752                     System.err.println(&quot;All commits must be present in the remote repository to be part of the pull request&quot;);
 753                     System.err.println(&quot;The following commits are not present in the remote repository:&quot;);
 754                     System.err.println(&quot;&quot;);
 755                     for (var commit : branchCommits) {
 756                         System.err.println(&quot;- &quot; + commit.hash().abbreviate() + &quot;: &quot; + commit.message().get(0));
 757                     }
 758                     System.err.println(&quot;&quot;);
 759                     System.err.println(&quot;To push the above local commits to the remote repository, run:&quot;);
 760                     System.err.println(&quot;&quot;);
 761                     System.err.println(&quot;    git push &quot; + remote + &quot; &quot; + currentBranch.name());
 762                     System.err.println(&quot;&quot;);
 763                     System.exit(1);
 764                 }
 765             }
 766 
<span class="line-modified"> 767             var targetBranch = getOption(&quot;branch&quot;, &quot;create&quot;, arguments);</span>
<span class="line-added"> 768             if (targetBranch == null) {</span>
<span class="line-added"> 769                 targetBranch = &quot;master&quot;;</span>
<span class="line-added"> 770             }</span>
 771             var commits = repo.commits(targetBranch + &quot;..&quot; + upstream.get()).asList();
 772             if (commits.isEmpty()) {
 773                 System.err.println(&quot;error: no difference between branches &quot; + targetBranch + &quot; and &quot; + currentBranch.name());
 774                 System.err.println(&quot;       Cannot create an empty pull request, have you committed?&quot;);
 775                 System.exit(1);
 776             }
 777 
<span class="line-modified"> 778             var shouldRunJCheck = getSwitch(&quot;jcheck&quot;, &quot;create&quot;, arguments);</span>




 779             if (shouldRunJCheck) {
 780                 var jcheckArgs = new String[]{ &quot;--pull-request&quot;, &quot;--rev&quot;, targetBranch + &quot;..&quot; + upstream.get() };
 781                 var err = GitJCheck.run(jcheckArgs);
 782                 if (err != 0) {
 783                     System.exit(err);
 784                 }
 785             }
 786 
 787             var remoteRepo = host.repository(projectName(uri)).orElseThrow(() -&gt;
 788                     new IOException(&quot;Could not find repository at &quot; + uri.toString())
 789             );
 790             if (token == null) {
 791                 GitCredentials.approve(credentials);
 792             }
 793             var parentRepo = remoteRepo.parent().orElseThrow(() -&gt;
 794                     new IOException(&quot;error: remote repository &quot; + remotePullPath + &quot; is not a fork of any repository&quot;));
 795 
 796             var project = jbsProjectFromJcheckConf(repo);
 797             var issue = getIssue(currentBranch, project);
 798             var file = Files.createTempFile(&quot;PULL_REQUEST_&quot;, &quot;.md&quot;);
</pre>
<hr />
<pre>
 863                              .filter(l -&gt; !(l.startsWith(&quot;&lt;!--&quot;) &amp;&amp; l.endsWith(&quot;--&gt;&quot;)))
 864                              .collect(Collectors.toList());
 865             var isEmpty = lines.stream().allMatch(String::isEmpty);
 866             if (isEmpty) {
 867                 System.err.println(&quot;error: no message present, aborting&quot;);
 868                 System.exit(1);
 869             }
 870 
 871             var title = lines.get(0);
 872             List&lt;String&gt; body = null;
 873             if (lines.size() &gt; 1) {
 874                 body = lines.subList(1, lines.size())
 875                             .stream()
 876                             .dropWhile(String::isEmpty)
 877                             .collect(Collectors.toList());
 878             } else {
 879                 body = Collections.emptyList();
 880             }
 881 
 882             var pr = remoteRepo.createPullRequest(parentRepo, targetBranch, currentBranch.name(), title, body);
<span class="line-modified"> 883             var assigneesOption = getOption(&quot;assignees&quot;, &quot;create&quot;, arguments);</span>
<span class="line-modified"> 884             if (assigneesOption != null) {</span>
<span class="line-added"> 885                 var usernames = Arrays.asList(assigneesOption.split(&quot;,&quot;));</span>
 886                 var assignees = usernames.stream()
 887                                          .map(u -&gt; host.user(u))
 888                                          .collect(Collectors.toList());
 889                 pr.setAssignees(assignees);
 890             }
 891             System.out.println(pr.webUrl().toString());
 892             Files.deleteIfExists(file);
 893 
 894             repo.config(&quot;pr.&quot; + currentBranch.name(), &quot;id&quot;, pr.id().toString());
 895         } else if (action.equals(&quot;integrate&quot;) || action.equals(&quot;approve&quot;) || action.equals(&quot;test&quot;)) {
 896             String id = null;
 897             if (arguments.at(1).isPresent()) {
 898                 id = arguments.at(1).asString();
 899             } else {
 900                 if (action.equals(&quot;approve&quot;)) {
 901                     exit(&quot;error: you must provide a pull request id&quot;);
 902                 } else {
 903                     var currentBranch = repo.currentBranch();
 904                     if (currentBranch.isPresent()) {
 905                         var lines = repo.config(&quot;pr.&quot; + currentBranch.get().name() + &quot;.id&quot;);
</pre>
<hr />
<pre>
 915             var pr = getPullRequest(uri, repo, host, id);
 916 
 917             if (action.equals(&quot;integrate&quot;)) {
 918                 pr.addComment(&quot;/integrate&quot;);
 919             } else if (action.equals(&quot;test&quot;)) {
 920                 pr.addComment(&quot;/test&quot;);
 921             } else if (action.equals(&quot;approve&quot;)) {
 922                 pr.addReview(Review.Verdict.APPROVED, &quot;Looks good!&quot;);
 923             } else {
 924                 throw new IllegalStateException(&quot;unexpected action: &quot; + action);
 925             }
 926         } else if (action.equals(&quot;list&quot;)) {
 927             var remoteRepo = getHostedRepositoryFor(uri, repo, host);
 928             var prs = remoteRepo.pullRequests();
 929             var ids = new ArrayList&lt;String&gt;();
 930             var titles = new ArrayList&lt;String&gt;();
 931             var authors = new ArrayList&lt;String&gt;();
 932             var assignees = new ArrayList&lt;String&gt;();
 933             var labels = new ArrayList&lt;String&gt;();
 934 
<span class="line-modified"> 935             var authorsOption = getOption(&quot;authors&quot;, &quot;list&quot;, arguments);</span>
<span class="line-modified"> 936             var filterAuthors = authorsOption == null ?</span>
<span class="line-modified"> 937                 Set.of() :</span>
<span class="line-modified"> 938                 new HashSet&lt;&gt;(Arrays.asList(authorsOption.split(&quot;,&quot;)));</span>
<span class="line-modified"> 939 </span>
<span class="line-modified"> 940             var assigneesOption = getOption(&quot;assignees&quot;, &quot;list&quot;, arguments);</span>
<span class="line-modified"> 941             var filterAssignees = assigneesOption == null ?</span>
<span class="line-modified"> 942                 Set.of() :</span>
<span class="line-modified"> 943                 Arrays.asList(assigneesOption.split(&quot;,&quot;));</span>
<span class="line-added"> 944 </span>
<span class="line-added"> 945             var labelsOption = getOption(&quot;labels&quot;, &quot;list&quot;, arguments);</span>
<span class="line-added"> 946             var filterLabels = labelsOption == null ?</span>
<span class="line-added"> 947                 Set.of() :</span>
<span class="line-added"> 948                 Arrays.asList(labelsOption.split(&quot;,&quot;));</span>
 949 
 950             var defaultColumns = List.of(&quot;id&quot;, &quot;title&quot;, &quot;authors&quot;, &quot;assignees&quot;, &quot;labels&quot;);
 951             var columnValues = Map.of(defaultColumns.get(0), ids,
 952                                       defaultColumns.get(1), titles,
 953                                       defaultColumns.get(2), authors,
 954                                       defaultColumns.get(3), assignees,
 955                                       defaultColumns.get(4), labels);
<span class="line-modified"> 956             var columnsOption = getOption(&quot;columns&quot;, &quot;list&quot;, arguments);</span>
<span class="line-modified"> 957             var columns = columnsOption == null ?</span>
<span class="line-modified"> 958                 defaultColumns :</span>
<span class="line-added"> 959                 Arrays.asList(columnsOption.split(&quot;,&quot;));</span>
 960             if (columns != defaultColumns) {
 961                 for (var column : columns) {
 962                     if (!defaultColumns.contains(column)) {
 963                         System.err.println(&quot;error: unknown column: &quot; + column);
 964                         System.err.println(&quot;       available columns are: &quot; + String.join(&quot;,&quot;, defaultColumns));
 965                         System.exit(1);
 966                     }
 967                 }
 968             }
 969 
 970             for (var pr : prs) {
 971                 var prAuthor = pr.author().userName();
 972                 if (!filterAuthors.isEmpty() &amp;&amp; !filterAuthors.contains(prAuthor)) {
 973                     continue;
 974                 }
 975 
 976                 var prAssignees = pr.assignees().stream()
 977                                     .map(HostUser::userName)
 978                                     .collect(Collectors.toSet());
 979                 if (!filterAssignees.isEmpty() &amp;&amp; !filterAssignees.stream().anyMatch(prAssignees::contains)) {
</pre>
<hr />
<pre>
 984                 if (!filterLabels.isEmpty() &amp;&amp; !filterLabels.stream().anyMatch(prLabels::contains)) {
 985                     continue;
 986                 }
 987 
 988                 ids.add(pr.id());
 989                 titles.add(pr.title());
 990                 authors.add(prAuthor);
 991                 assignees.add(String.join(&quot;,&quot;, prAssignees));
 992                 labels.add(String.join(&quot;,&quot;, prLabels));
 993             }
 994 
 995 
 996             String fmt = &quot;&quot;;
 997             for (var column : columns.subList(0, columns.size() - 1)) {
 998                 var values = columnValues.get(column);
 999                 var n = Math.max(column.length(), longest(values));
1000                 fmt += &quot;%-&quot; + n + &quot;s\t&quot;;
1001             }
1002             fmt += &quot;%s\n&quot;;
1003 
<span class="line-modified">1004             var noDecoration = getSwitch(&quot;no-decoration&quot;, &quot;list&quot;, arguments);</span>
<span class="line-added">1005             if (!ids.isEmpty() &amp;&amp; !noDecoration) {</span>
1006                 var upperCase = columns.stream()
1007                                        .map(String::toUpperCase)
1008                                        .collect(Collectors.toList());
1009                 System.out.format(fmt, (Object[]) upperCase.toArray(new String[0]));
1010             }
1011             for (var i = 0; i &lt; ids.size(); i++) {
1012                 final int n = i;
1013                 var row = columns.stream()
1014                                  .map(columnValues::get)
1015                                  .map(values -&gt; values.get(n))
1016                                  .collect(Collectors.toList());
1017                 System.out.format(fmt, (Object[]) row.toArray(new String[0]));
1018             }
1019         } else if (action.equals(&quot;fetch&quot;) || action.equals(&quot;checkout&quot;) || action.equals(&quot;show&quot;) || action.equals(&quot;apply&quot;)) {
1020             var prId = arguments.at(1);
1021             if (!prId.isPresent()) {
1022                 exit(&quot;error: missing pull request identifier&quot;);
1023             }
1024 
1025             var remoteRepo = getHostedRepositoryFor(uri, repo, host);
</pre>
<hr />
<pre>
1052                     gimport();
1053                     var hgFetchHead = repo.resolve(hgGitRef).get();
1054 
1055                     if (action.equals(&quot;fetch&quot;) &amp;&amp; arguments.contains(&quot;branch&quot;)) {
1056                         repo.branch(hgFetchHead, arguments.get(&quot;branch&quot;).asString());
1057                     } else if (action.equals(&quot;checkout&quot;)) {
1058                         repo.checkout(hgFetchHead);
1059                         if (arguments.contains(&quot;branch&quot;)) {
1060                             repo.branch(hgFetchHead, arguments.get(&quot;branch&quot;).asString());
1061                         }
1062                     }
1063                 } else {
1064                     exit(&quot;Unexpected action: &quot; + action);
1065                 }
1066 
1067                 return;
1068             }
1069 
1070             var fetchHead = repo.fetch(repoUrl, pr.sourceRef());
1071             if (action.equals(&quot;fetch&quot;)) {
<span class="line-modified">1072                 var branchName = getOption(&quot;branch&quot;, &quot;fetch&quot;, arguments);</span>
<span class="line-modified">1073                 if (branchName != null) {</span>
1074                     repo.branch(fetchHead, branchName);
1075                 } else {
1076                     System.out.println(fetchHead.hex());
1077                 }
1078             } else if (action.equals(&quot;checkout&quot;)) {
<span class="line-modified">1079                 var branchName = getOption(&quot;branch&quot;, &quot;checkout&quot;, arguments);</span>
<span class="line-modified">1080                 if (branchName != null) {</span>
1081                     var branch = repo.branch(fetchHead, branchName);
1082                     repo.checkout(branch, false);
1083                 } else {
1084                     repo.checkout(fetchHead, false);
1085                 }
1086             } else if (action.equals(&quot;show&quot;)) {
1087                 show(pr.targetRef(), fetchHead);
1088             } else if (action.equals(&quot;apply&quot;)) {
1089                 var patch = diff(pr.targetRef(), fetchHead);
1090                 apply(patch);
1091                 Files.deleteIfExists(patch);
1092             }
1093         } else if (action.equals(&quot;close&quot;)) {
1094             var prId = arguments.at(1);
1095             if (!prId.isPresent()) {
1096                 exit(&quot;error: missing pull request identifier&quot;);
1097             }
1098 
1099             var remoteRepo = getHostedRepositoryFor(uri, repo, host);
1100             var pr = remoteRepo.pullRequest(prId.asString());
1101             pr.setState(PullRequest.State.CLOSED);
1102         } else if (action.equals(&quot;update&quot;)) {
1103             var prId = arguments.at(1);
1104             if (!prId.isPresent()) {
1105                 exit(&quot;error: missing pull request identifier&quot;);
1106             }
1107 
1108             var remoteRepo = getHostedRepositoryFor(uri, repo, host);
1109             var pr = remoteRepo.pullRequest(prId.asString());
<span class="line-modified">1110             var assigneesOption = getOption(&quot;assignees&quot;, &quot;update&quot;, arguments);</span>
<span class="line-modified">1111             if (assigneesOption != null) {</span>
<span class="line-added">1112                 var usernames = Arrays.asList(assigneesOption.split(&quot;,&quot;));</span>
1113                 var assignees = usernames.stream()
1114                     .map(u -&gt; host.user(u))
1115                     .collect(Collectors.toList());
1116                 pr.setAssignees(assignees);
1117             }
1118         } else {
1119             exit(&quot;error: unexpected action: &quot; + action);
1120         }
1121     }
1122 }
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>