<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/notify/src/main/java/org/openjdk/skara/bots/notify/MailingListUpdater.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="JNotifyBot.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/java/org/openjdk/skara/bots/notify/UpdaterTests.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/notify/src/main/java/org/openjdk/skara/bots/notify/MailingListUpdater.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
106 
107     private String commitsToSubject(HostedRepository repository, List&lt;Commit&gt; commits, Branch branch) {
108         var subject = new StringBuilder();
109         subject.append(repository.getRepositoryType().shortName());
110         subject.append(&quot;: &quot;);
111         subject.append(repository.getName());
112         subject.append(&quot;: &quot;);
113         if (includeBranch) {
114             subject.append(branch.name());
115             subject.append(&quot;: &quot;);
116         }
117         if (commits.size() &gt; 1) {
118             subject.append(commits.size());
119             subject.append(&quot; new changesets&quot;);
120         } else {
121             subject.append(commits.get(0).message().get(0));
122         }
123         return subject.toString();
124     }
125 










126     private List&lt;Commit&gt; filterAndSendPrCommits(HostedRepository repository, List&lt;Commit&gt; commits) {
127         var ret = new ArrayList&lt;Commit&gt;();
128 
129         var rfrs = list.conversations(Duration.ofDays(365)).stream()
130                        .map(Conversation::first)
131                        .filter(email -&gt; email.subject().startsWith(&quot;RFR: &quot;))
132                        .collect(Collectors.toList());
133 
134         for (var commit : commits) {
135             var candidates = repository.findPullRequestsWithComment(null, &quot;Pushed as commit &quot; + commit.hash() + &quot;.&quot;);
136             if (candidates.size() != 1) {
137                 log.warning(&quot;Commit &quot; + commit.hash() + &quot; matches &quot; + candidates.size() + &quot; pull requests - expected 1&quot;);
138                 ret.add(commit);
139                 continue;
140             }
141 
142             var candidate = candidates.get(0);
143             var prLink = candidate.getWebUrl();
144             var prLinkPattern = Pattern.compile(&quot;^(?:PR: )?&quot; + Pattern.quote(prLink.toString()), Pattern.MULTILINE);
145 
</pre>
<hr />
<pre>
190         list.post(email);
191     }
192 
193     @Override
194     public void handleCommits(HostedRepository repository, List&lt;Commit&gt; commits, Branch branch) {
195         switch (mode) {
196             case PR_ONLY:
197                 filterAndSendPrCommits(repository, commits);
198                 break;
199             case PR:
200                 commits = filterAndSendPrCommits(repository, commits);
201                 // fall-through
202             case ALL:
203                 sendCombinedCommits(repository, commits, branch);
204                 break;
205         }
206     }
207 
208     @Override
209     public void handleTagCommits(HostedRepository repository, List&lt;Commit&gt; commits, OpenJDKTag tag) {


210 





















211     }
212 }
</pre>
</td>
<td>
<hr />
<pre>
106 
107     private String commitsToSubject(HostedRepository repository, List&lt;Commit&gt; commits, Branch branch) {
108         var subject = new StringBuilder();
109         subject.append(repository.getRepositoryType().shortName());
110         subject.append(&quot;: &quot;);
111         subject.append(repository.getName());
112         subject.append(&quot;: &quot;);
113         if (includeBranch) {
114             subject.append(branch.name());
115             subject.append(&quot;: &quot;);
116         }
117         if (commits.size() &gt; 1) {
118             subject.append(commits.size());
119             subject.append(&quot; new changesets&quot;);
120         } else {
121             subject.append(commits.get(0).message().get(0));
122         }
123         return subject.toString();
124     }
125 
<span class="line-added">126     private String tagToSubject(HostedRepository repository, Hash hash, OpenJDKTag tag) {</span>
<span class="line-added">127         return repository.getRepositoryType().shortName() +</span>
<span class="line-added">128                 &quot;: &quot; +</span>
<span class="line-added">129                 repository.getName() +</span>
<span class="line-added">130                 &quot;: Added tag &quot; +</span>
<span class="line-added">131                 tag.tag() +</span>
<span class="line-added">132                 &quot; for changeset &quot; +</span>
<span class="line-added">133                 hash.abbreviate();</span>
<span class="line-added">134     }</span>
<span class="line-added">135 </span>
136     private List&lt;Commit&gt; filterAndSendPrCommits(HostedRepository repository, List&lt;Commit&gt; commits) {
137         var ret = new ArrayList&lt;Commit&gt;();
138 
139         var rfrs = list.conversations(Duration.ofDays(365)).stream()
140                        .map(Conversation::first)
141                        .filter(email -&gt; email.subject().startsWith(&quot;RFR: &quot;))
142                        .collect(Collectors.toList());
143 
144         for (var commit : commits) {
145             var candidates = repository.findPullRequestsWithComment(null, &quot;Pushed as commit &quot; + commit.hash() + &quot;.&quot;);
146             if (candidates.size() != 1) {
147                 log.warning(&quot;Commit &quot; + commit.hash() + &quot; matches &quot; + candidates.size() + &quot; pull requests - expected 1&quot;);
148                 ret.add(commit);
149                 continue;
150             }
151 
152             var candidate = candidates.get(0);
153             var prLink = candidate.getWebUrl();
154             var prLinkPattern = Pattern.compile(&quot;^(?:PR: )?&quot; + Pattern.quote(prLink.toString()), Pattern.MULTILINE);
155 
</pre>
<hr />
<pre>
200         list.post(email);
201     }
202 
203     @Override
204     public void handleCommits(HostedRepository repository, List&lt;Commit&gt; commits, Branch branch) {
205         switch (mode) {
206             case PR_ONLY:
207                 filterAndSendPrCommits(repository, commits);
208                 break;
209             case PR:
210                 commits = filterAndSendPrCommits(repository, commits);
211                 // fall-through
212             case ALL:
213                 sendCombinedCommits(repository, commits, branch);
214                 break;
215         }
216     }
217 
218     @Override
219     public void handleTagCommits(HostedRepository repository, List&lt;Commit&gt; commits, OpenJDKTag tag) {
<span class="line-added">220         var writer = new StringWriter();</span>
<span class="line-added">221         var printer = new PrintWriter(writer);</span>
222 
<span class="line-added">223         printer.println(&quot;The following commits are included in &quot; + tag.tag());</span>
<span class="line-added">224         printer.println(&quot;========================================================&quot;);</span>
<span class="line-added">225         for (var commit : commits) {</span>
<span class="line-added">226             printer.print(commit.hash().abbreviate());</span>
<span class="line-added">227             if (commit.message().size() &gt; 0) {</span>
<span class="line-added">228                 printer.print(&quot;: &quot; + commit.message().get(0));</span>
<span class="line-added">229             }</span>
<span class="line-added">230             printer.println();</span>
<span class="line-added">231         }</span>
<span class="line-added">232 </span>
<span class="line-added">233         var tagCommit = commits.get(commits.size() - 1);</span>
<span class="line-added">234         var subject = tagToSubject(repository, tagCommit.hash(), tag);</span>
<span class="line-added">235         var finalAuthor = author != null ? author : commitsToAuthor(commits);</span>
<span class="line-added">236         var email = Email.create(subject, writer.toString())</span>
<span class="line-added">237                          .sender(sender)</span>
<span class="line-added">238                          .author(finalAuthor)</span>
<span class="line-added">239                          .recipient(recipient)</span>
<span class="line-added">240                          .headers(headers)</span>
<span class="line-added">241                          .build();</span>
<span class="line-added">242 </span>
<span class="line-added">243         list.post(email);</span>
244     }
245 }
</pre>
</td>
</tr>
</table>
<center><a href="JNotifyBot.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/java/org/openjdk/skara/bots/notify/UpdaterTests.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>