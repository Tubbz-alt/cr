<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/notify/src/main/java/org/openjdk/skara/bots/notify/JNotifyBot.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="MailingListUpdater.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/notify/src/main/java/org/openjdk/skara/bots/notify/JNotifyBot.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
113             if (tags.size() &gt; 0) {
114                 log.warning(&quot;No previous tag history found - ignoring all current tags&quot;);
115                 history.addTags(tags);
116             }
117             return;
118         }
119 
120         var allJdkTags = tags.stream()
121                              .map(OpenJDKTag::create)
122                              .filter(Optional::isPresent)
123                              .map(Optional::get)
124                              .collect(Collectors.toSet());
125         var newJdkTags = newTags.stream()
126                              .map(OpenJDKTag::create)
127                              .filter(Optional::isPresent)
128                              .map(Optional::get)
129                              .sorted(Comparator.comparingInt(OpenJDKTag::buildNum))
130                              .collect(Collectors.toList());
131 
132         for (var tag : newJdkTags) {




133             var previous = existingPrevious(tag, allJdkTags);
134             if (previous.isEmpty()) {
<span class="line-modified">135                 log.warning(&quot;No previous tag found for &#39;&quot; + tag.tag() + &quot;&#39; - ignoring&quot;);</span>
<span class="line-modified">136                 continue;</span>







137             }
<span class="line-removed">138             var commits = localRepo.commits(previous.get().tag() + &quot;..&quot; + tag.tag()).asList();</span>
<span class="line-removed">139             if (commits.size() == 0) {</span>
<span class="line-removed">140                 continue;</span>
<span class="line-removed">141             }</span>
<span class="line-removed">142 </span>
<span class="line-removed">143             // Update the history first - if there is a problem here we don&#39;t want to send out multiple updates</span>
<span class="line-removed">144             history.addTags(List.of(tag.tag()));</span>
145 
146             Collections.reverse(commits);
147             for (var updater : updaters) {
148                 updater.handleTagCommits(repository, commits, tag);
149             }
150         }
151     }
152 
153     private Repository fetchAll(Path dir, URI remote) throws IOException {
154         Repository repo = null;
155         if (!Files.exists(dir)) {
156             Files.createDirectories(dir);
157             repo = Repository.clone(remote, dir);
158         } else {
159             repo = Repository.get(dir).orElseThrow(() -&gt; new RuntimeException(&quot;Repository in &quot; + dir + &quot; has vanished&quot;));
160         }
161         repo.fetchAll();
162         return repo;
163     }
164 
</pre>
</td>
<td>
<hr />
<pre>
113             if (tags.size() &gt; 0) {
114                 log.warning(&quot;No previous tag history found - ignoring all current tags&quot;);
115                 history.addTags(tags);
116             }
117             return;
118         }
119 
120         var allJdkTags = tags.stream()
121                              .map(OpenJDKTag::create)
122                              .filter(Optional::isPresent)
123                              .map(Optional::get)
124                              .collect(Collectors.toSet());
125         var newJdkTags = newTags.stream()
126                              .map(OpenJDKTag::create)
127                              .filter(Optional::isPresent)
128                              .map(Optional::get)
129                              .sorted(Comparator.comparingInt(OpenJDKTag::buildNum))
130                              .collect(Collectors.toList());
131 
132         for (var tag : newJdkTags) {
<span class="line-added">133             // Update the history first - if there is a problem here we don&#39;t want to send out multiple updates</span>
<span class="line-added">134             history.addTags(List.of(tag.tag()));</span>
<span class="line-added">135 </span>
<span class="line-added">136             var commits = new ArrayList&lt;Commit&gt;();</span>
137             var previous = existingPrevious(tag, allJdkTags);
138             if (previous.isEmpty()) {
<span class="line-modified">139                 var commit = localRepo.lookup(tag.tag());</span>
<span class="line-modified">140                 if (commit.isEmpty()) {</span>
<span class="line-added">141                     throw new RuntimeException(&quot;Failed to lookup tag &#39;&quot; + tag.toString() + &quot;&#39;&quot;);</span>
<span class="line-added">142                 } else {</span>
<span class="line-added">143                     commits.add(commit.get());</span>
<span class="line-added">144                     log.warning(&quot;No previous tag found for &#39;&quot; + tag.tag() + &quot;&#39;&quot;);</span>
<span class="line-added">145                 }</span>
<span class="line-added">146             } else {</span>
<span class="line-added">147                 commits.addAll(localRepo.commits(previous.get().tag() + &quot;..&quot; + tag.tag()).asList());</span>
148             }







149 
150             Collections.reverse(commits);
151             for (var updater : updaters) {
152                 updater.handleTagCommits(repository, commits, tag);
153             }
154         }
155     }
156 
157     private Repository fetchAll(Path dir, URI remote) throws IOException {
158         Repository repo = null;
159         if (!Files.exists(dir)) {
160             Files.createDirectories(dir);
161             repo = Repository.clone(remote, dir);
162         } else {
163             repo = Repository.get(dir).orElseThrow(() -&gt; new RuntimeException(&quot;Repository in &quot; + dir + &quot; has vanished&quot;));
164         }
165         repo.fetchAll();
166         return repo;
167     }
168 
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="MailingListUpdater.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>