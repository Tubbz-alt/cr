<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff cli/src/main/java/org/openjdk/skara/cli/GitPr.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="GitFork.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="GitSync.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>cli/src/main/java/org/openjdk/skara/cli/GitPr.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 91             throw new IOException(e);
 92         }
 93     }
 94 
 95     private static String projectName(URI uri) {
 96         var name = uri.getPath().toString().substring(1);
 97         if (name.endsWith(&quot;.git&quot;)) {
 98             name = name.substring(0, name.length() - &quot;.git&quot;.length());
 99         }
100         return name;
101     }
102 
103     private static HostedRepository getHostedRepositoryFor(URI uri, GitCredentials credentials) throws IOException {
104         var host = Forge.from(uri, new Credential(credentials.username(), credentials.password()));
105         if (System.getenv(&quot;GIT_TOKEN&quot;) == null) {
106             GitCredentials.approve(credentials);
107         }
108         if (host.isEmpty() || !host.get().isValid()) {
109             exit(&quot;error: failed to connect to host &quot; + uri);
110         }
<span class="line-modified">111         var remoteRepo = host.get().repository(projectName(uri));</span>


112         var parentRepo = remoteRepo.parent();
113         var targetRepo = parentRepo.isPresent() ? parentRepo.get() : remoteRepo;
114         return targetRepo;
115     }
116 
117     private static PullRequest getPullRequest(URI uri, GitCredentials credentials, Argument prId) throws IOException {
118         if (!prId.isPresent()) {
119             exit(&quot;error: missing pull request identifier&quot;);
120         }
121 
122         var pr = getHostedRepositoryFor(uri, credentials).pullRequest(prId.asString());
123         if (pr == null) {
124             exit(&quot;error: could not fetch PR information&quot;);
125         }
126 
127         return pr;
128     }
129 
130     private static void show(String ref, Hash hash) throws IOException {
131         show(ref, hash, null);
</pre>
<hr />
<pre>
401                         var path = patch.target().path().isPresent() ?
402                             patch.target().path().get() : patch.source().path().get();
403                         System.err.println(&quot;    &quot; + patch.status().toString() + &quot; &quot; + path.toString());
404                     }
405                     System.err.println(&quot;&quot;);
406                     System.err.println(&quot;If these changes are meant to be part of the pull request, run:&quot;);
407                     System.err.println(&quot;&quot;);
408                     System.err.println(&quot;    hg commit --amend&quot;);
409                     System.err.println(&quot;    hg git-cleanup&quot;);
410                     System.err.println(&quot;    hg push --bookmark &quot; + bookmark.name() + &quot; &lt;PATH&gt;&quot;);
411                     System.err.println(&quot;    hg gimport&quot;);
412                     System.err.println(&quot;&quot;);
413                     System.err.println(&quot;If these changes are *not* meant to be part of the pull request, run:&quot;);
414                     System.err.println(&quot;&quot;);
415                     System.err.println(&quot;    hg shelve&quot;);
416                     System.err.println(&quot;&quot;);
417                     System.err.println(&quot;(You can later restore the changes by running: hg unshelve)&quot;);
418                     System.exit(1);
419                 }
420 
<span class="line-modified">421                 var remoteRepo = host.get().repository(projectName(uri));</span>


422                 if (token == null) {
423                     GitCredentials.approve(credentials);
424                 }
425                 var parentRepo = remoteRepo.parent().orElseThrow(() -&gt;
426                         new IOException(&quot;error: remote repository &quot; + remotePullPath + &quot; is not a fork of any repository&quot;));
427 
428                 var file = Files.createTempFile(&quot;PULL_REQUEST_&quot;, &quot;.txt&quot;);
429                 if (commits.size() == 1) {
430                     var commit = commits.get(0);
431                     var message = CommitMessageParsers.v1.parse(commit.message());
432                     Files.writeString(file, message.title() + &quot;\n&quot;);
433                     if (!message.summaries().isEmpty()) {
434                         Files.write(file, message.summaries(), StandardOpenOption.APPEND);
435                     }
436                     if (!message.additional().isEmpty()) {
437                         Files.write(file, message.additional(), StandardOpenOption.APPEND);
438                     }
439                 } else {
440                     Files.write(file, List.of(&quot;&quot;));
441                 }
</pre>
<hr />
<pre>
558                 System.err.println(&quot;error: there are uncommitted changes in your working tree:&quot;);
559                 System.err.println(&quot;&quot;);
560                 for (var patch : diff.patches()) {
561                     var path = patch.target().path().isPresent() ?
562                         patch.target().path().get() : patch.source().path().get();
563                     System.err.println(&quot;    &quot; + patch.status().toString() + &quot; &quot; + path.toString());
564                 }
565                 System.err.println(&quot;&quot;);
566                 System.err.println(&quot;If these changes are meant to be part of the pull request, run:&quot;);
567                 System.err.println(&quot;&quot;);
568                 System.err.println(&quot;    git commit -am &#39;Forgot to add some changes&#39;&quot;);
569                 System.err.println(&quot;&quot;);
570                 System.err.println(&quot;If these changes are *not* meant to be part of the pull request, run:&quot;);
571                 System.err.println(&quot;&quot;);
572                 System.err.println(&quot;    git stash&quot;);
573                 System.err.println(&quot;&quot;);
574                 System.err.println(&quot;(You can later restore the changes by running: git stash pop)&quot;);
575                 System.exit(1);
576             }
577 
<span class="line-modified">578             var remoteRepo = host.get().repository(projectName(uri));</span>


579             if (token == null) {
580                 GitCredentials.approve(credentials);
581             }
582             var parentRepo = remoteRepo.parent().orElseThrow(() -&gt;
583                     new IOException(&quot;error: remote repository &quot; + remotePullPath + &quot; is not a fork of any repository&quot;));
584 
585             var file = Files.createTempFile(&quot;PULL_REQUEST_&quot;, &quot;.txt&quot;);
586             if (commits.size() == 1) {
587                 var commit = commits.get(0);
588                 var message = CommitMessageParsers.v1.parse(commit.message());
589                 Files.writeString(file, message.title() + &quot;\n&quot;);
590                 if (!message.summaries().isEmpty()) {
591                     Files.write(file, message.summaries(), StandardOpenOption.APPEND);
592                 }
593                 if (!message.additional().isEmpty()) {
594                     Files.write(file, message.additional(), StandardOpenOption.APPEND);
595                 }
596             } else {
597                 Files.write(file, List.of(&quot;&quot;));
598             }
</pre>
</td>
<td>
<hr />
<pre>
 91             throw new IOException(e);
 92         }
 93     }
 94 
 95     private static String projectName(URI uri) {
 96         var name = uri.getPath().toString().substring(1);
 97         if (name.endsWith(&quot;.git&quot;)) {
 98             name = name.substring(0, name.length() - &quot;.git&quot;.length());
 99         }
100         return name;
101     }
102 
103     private static HostedRepository getHostedRepositoryFor(URI uri, GitCredentials credentials) throws IOException {
104         var host = Forge.from(uri, new Credential(credentials.username(), credentials.password()));
105         if (System.getenv(&quot;GIT_TOKEN&quot;) == null) {
106             GitCredentials.approve(credentials);
107         }
108         if (host.isEmpty() || !host.get().isValid()) {
109             exit(&quot;error: failed to connect to host &quot; + uri);
110         }
<span class="line-modified">111         var remoteRepo = host.get().repository(projectName(uri)).orElseThrow(() -&gt;</span>
<span class="line-added">112                 new IOException(&quot;Could not find repository at: &quot; + uri.toString())</span>
<span class="line-added">113         );</span>
114         var parentRepo = remoteRepo.parent();
115         var targetRepo = parentRepo.isPresent() ? parentRepo.get() : remoteRepo;
116         return targetRepo;
117     }
118 
119     private static PullRequest getPullRequest(URI uri, GitCredentials credentials, Argument prId) throws IOException {
120         if (!prId.isPresent()) {
121             exit(&quot;error: missing pull request identifier&quot;);
122         }
123 
124         var pr = getHostedRepositoryFor(uri, credentials).pullRequest(prId.asString());
125         if (pr == null) {
126             exit(&quot;error: could not fetch PR information&quot;);
127         }
128 
129         return pr;
130     }
131 
132     private static void show(String ref, Hash hash) throws IOException {
133         show(ref, hash, null);
</pre>
<hr />
<pre>
403                         var path = patch.target().path().isPresent() ?
404                             patch.target().path().get() : patch.source().path().get();
405                         System.err.println(&quot;    &quot; + patch.status().toString() + &quot; &quot; + path.toString());
406                     }
407                     System.err.println(&quot;&quot;);
408                     System.err.println(&quot;If these changes are meant to be part of the pull request, run:&quot;);
409                     System.err.println(&quot;&quot;);
410                     System.err.println(&quot;    hg commit --amend&quot;);
411                     System.err.println(&quot;    hg git-cleanup&quot;);
412                     System.err.println(&quot;    hg push --bookmark &quot; + bookmark.name() + &quot; &lt;PATH&gt;&quot;);
413                     System.err.println(&quot;    hg gimport&quot;);
414                     System.err.println(&quot;&quot;);
415                     System.err.println(&quot;If these changes are *not* meant to be part of the pull request, run:&quot;);
416                     System.err.println(&quot;&quot;);
417                     System.err.println(&quot;    hg shelve&quot;);
418                     System.err.println(&quot;&quot;);
419                     System.err.println(&quot;(You can later restore the changes by running: hg unshelve)&quot;);
420                     System.exit(1);
421                 }
422 
<span class="line-modified">423                 var remoteRepo = host.get().repository(projectName(uri)).orElseThrow(() -&gt;</span>
<span class="line-added">424                         new IOException(&quot;Could not find repository at &quot; + uri.toString())</span>
<span class="line-added">425                 );</span>
426                 if (token == null) {
427                     GitCredentials.approve(credentials);
428                 }
429                 var parentRepo = remoteRepo.parent().orElseThrow(() -&gt;
430                         new IOException(&quot;error: remote repository &quot; + remotePullPath + &quot; is not a fork of any repository&quot;));
431 
432                 var file = Files.createTempFile(&quot;PULL_REQUEST_&quot;, &quot;.txt&quot;);
433                 if (commits.size() == 1) {
434                     var commit = commits.get(0);
435                     var message = CommitMessageParsers.v1.parse(commit.message());
436                     Files.writeString(file, message.title() + &quot;\n&quot;);
437                     if (!message.summaries().isEmpty()) {
438                         Files.write(file, message.summaries(), StandardOpenOption.APPEND);
439                     }
440                     if (!message.additional().isEmpty()) {
441                         Files.write(file, message.additional(), StandardOpenOption.APPEND);
442                     }
443                 } else {
444                     Files.write(file, List.of(&quot;&quot;));
445                 }
</pre>
<hr />
<pre>
562                 System.err.println(&quot;error: there are uncommitted changes in your working tree:&quot;);
563                 System.err.println(&quot;&quot;);
564                 for (var patch : diff.patches()) {
565                     var path = patch.target().path().isPresent() ?
566                         patch.target().path().get() : patch.source().path().get();
567                     System.err.println(&quot;    &quot; + patch.status().toString() + &quot; &quot; + path.toString());
568                 }
569                 System.err.println(&quot;&quot;);
570                 System.err.println(&quot;If these changes are meant to be part of the pull request, run:&quot;);
571                 System.err.println(&quot;&quot;);
572                 System.err.println(&quot;    git commit -am &#39;Forgot to add some changes&#39;&quot;);
573                 System.err.println(&quot;&quot;);
574                 System.err.println(&quot;If these changes are *not* meant to be part of the pull request, run:&quot;);
575                 System.err.println(&quot;&quot;);
576                 System.err.println(&quot;    git stash&quot;);
577                 System.err.println(&quot;&quot;);
578                 System.err.println(&quot;(You can later restore the changes by running: git stash pop)&quot;);
579                 System.exit(1);
580             }
581 
<span class="line-modified">582             var remoteRepo = host.get().repository(projectName(uri)).orElseThrow(() -&gt;</span>
<span class="line-added">583                     new IOException(&quot;Could not find repository at &quot; + uri.toString())</span>
<span class="line-added">584             );</span>
585             if (token == null) {
586                 GitCredentials.approve(credentials);
587             }
588             var parentRepo = remoteRepo.parent().orElseThrow(() -&gt;
589                     new IOException(&quot;error: remote repository &quot; + remotePullPath + &quot; is not a fork of any repository&quot;));
590 
591             var file = Files.createTempFile(&quot;PULL_REQUEST_&quot;, &quot;.txt&quot;);
592             if (commits.size() == 1) {
593                 var commit = commits.get(0);
594                 var message = CommitMessageParsers.v1.parse(commit.message());
595                 Files.writeString(file, message.title() + &quot;\n&quot;);
596                 if (!message.summaries().isEmpty()) {
597                     Files.write(file, message.summaries(), StandardOpenOption.APPEND);
598                 }
599                 if (!message.additional().isEmpty()) {
600                     Files.write(file, message.additional(), StandardOpenOption.APPEND);
601                 }
602             } else {
603                 Files.write(file, List.of(&quot;&quot;));
604             }
</pre>
</td>
</tr>
</table>
<center><a href="GitFork.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="GitSync.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>