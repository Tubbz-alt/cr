<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff cli/src/main/java/org/openjdk/skara/cli/GitSync.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>cli/src/main/java/org/openjdk/skara/cli/GitSync.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 90 
 91         if (arguments.contains(&quot;version&quot;)) {
 92             System.out.println(&quot;git-sync version: &quot; + Version.fromManifest().orElse(&quot;unknown&quot;));
 93             System.exit(0);
 94         }
 95 
 96         if (arguments.contains(&quot;verbose&quot;) || arguments.contains(&quot;debug&quot;)) {
 97             var level = arguments.contains(&quot;debug&quot;) ? Level.FINER : Level.FINE;
 98             Logging.setup(level);
 99         }
100 
101         var cwd = Paths.get(&quot;&quot;).toAbsolutePath();
102         var repo = Repository.get(cwd).orElseThrow(() -&gt;
103                 die(&quot;error: no repository found at &quot; + cwd.toString())
104         );
105 
106         HttpProxy.setup();
107 
108         var remotes = repo.remotes();
109 
<span class="line-modified">110         String upstream = null;</span>
111         if (arguments.contains(&quot;from&quot;)) {
<span class="line-modified">112             upstream = arguments.get(&quot;from&quot;).asString();</span>
113         } else {
114             var lines = repo.config(&quot;sync.from&quot;);
115             if (lines.size() == 1 &amp;&amp; remotes.contains(lines.get(0))) {
<span class="line-modified">116                 upstream = lines.get(0);</span>
117             } else {
<span class="line-modified">118                 if (remotes.contains(&quot;origin&quot;)) {</span>
<span class="line-modified">119                     var originPullPath = repo.pullPath(&quot;origin&quot;);</span>
<span class="line-modified">120                     try {</span>
<span class="line-modified">121                         var uri = Remote.toWebURI(originPullPath);</span>
<span class="line-modified">122                         upstream = Forge.from(URI.create(uri.getScheme() + &quot;://&quot; + uri.getHost()))</span>





123                                         .flatMap(f -&gt; f.repository(uri.getPath().substring(1)))
124                                         .flatMap(r -&gt; r.parent())
125                                         .map(p -&gt; p.webUrl().toString())
126                                         .orElse(null);
<span class="line-modified">127                     } catch (IllegalArgumentException e) {</span>
<span class="line-modified">128                         upstream = null;</span>

129                     }
130                 }
131             }
132         }
133 
<span class="line-modified">134         if (upstream == null) {</span>
<span class="line-modified">135             die(&quot;Could not find upstream repository, please specify one with --from&quot;);</span>
136         }
<span class="line-removed">137         var upstreamPullPath = remotes.contains(upstream) ?</span>
<span class="line-removed">138             Remote.toURI(repo.pullPath(upstream)) : URI.create(upstream);</span>
139 
<span class="line-modified">140         String origin = null;</span>



141         if (arguments.contains(&quot;to&quot;)) {
<span class="line-modified">142             origin = arguments.get(&quot;to&quot;).asString();</span>
143         } else {
144             var lines = repo.config(&quot;sync.to&quot;);
145             if (lines.size() == 1) {
146                 if (!remotes.contains(lines.get(0))) {
147                     die(&quot;The given remote to push to, &quot; + lines.get(0) + &quot;, does not exist&quot;);
148                 } else {
<span class="line-modified">149                     origin = lines.get(0);</span>
150                 }
151             } else {
<span class="line-modified">152                 origin = &quot;origin&quot;;</span>




153             }
154         }
<span class="line-modified">155         var originPushPath = Remote.toURI(repo.pushPath(origin));</span>


156 
157         var branches = new HashSet&lt;String&gt;();
158         if (arguments.contains(&quot;branches&quot;)) {
159             var requested = arguments.get(&quot;branches&quot;).asString().split(&quot;,&quot;);
160             for (var branch : requested) {
161                 branches.add(branch.trim());
162             }
163         } else {
164             var lines = repo.config(&quot;sync.branches&quot;);
165             if (lines.size() == 1) {
166                 var requested = lines.get(0).split(&quot;,&quot;);
167                 for (var branch : requested) {
168                     branches.add(branch.trim());
169                 }
170             }
171         }
172 
<span class="line-modified">173         for (var branch : repo.remoteBranches(upstream)) {</span>
174             var name = branch.name();
175             if (!branches.isEmpty() &amp;&amp; !branches.contains(name)) {
176                 if (arguments.contains(&quot;verbose&quot;) || arguments.contains(&quot;debug&quot;)) {
177                     System.out.println(&quot;Skipping branch &quot; + name);
178                 }
179                 continue;
180             }
<span class="line-modified">181             System.out.print(&quot;Syncing &quot; + upstream + &quot;/&quot; + name + &quot; to &quot; + origin + &quot;/&quot; + name + &quot;... &quot;);</span>
182             System.out.flush();
<span class="line-modified">183             var fetchHead = repo.fetch(upstreamPullPath, branch.hash().hex());</span>
<span class="line-modified">184             repo.push(fetchHead, originPushPath, name);</span>
185             System.out.println(&quot;done&quot;);
186         }
187 
188         var shouldPull = arguments.contains(&quot;pull&quot;);
189         if (!shouldPull) {
190             var lines = repo.config(&quot;sync.pull&quot;);
191             shouldPull = lines.size() == 1 &amp;&amp; lines.get(0).toLowerCase().equals(&quot;always&quot;);
192         }
193         if (shouldPull) {
194             int err = pull();
195             if (err != 0) {
196                 System.exit(err);
197             }
198         }
199     }
200 }
</pre>
</td>
<td>
<hr />
<pre>
 90 
 91         if (arguments.contains(&quot;version&quot;)) {
 92             System.out.println(&quot;git-sync version: &quot; + Version.fromManifest().orElse(&quot;unknown&quot;));
 93             System.exit(0);
 94         }
 95 
 96         if (arguments.contains(&quot;verbose&quot;) || arguments.contains(&quot;debug&quot;)) {
 97             var level = arguments.contains(&quot;debug&quot;) ? Level.FINER : Level.FINE;
 98             Logging.setup(level);
 99         }
100 
101         var cwd = Paths.get(&quot;&quot;).toAbsolutePath();
102         var repo = Repository.get(cwd).orElseThrow(() -&gt;
103                 die(&quot;error: no repository found at &quot; + cwd.toString())
104         );
105 
106         HttpProxy.setup();
107 
108         var remotes = repo.remotes();
109 
<span class="line-modified">110         String from = null;</span>
111         if (arguments.contains(&quot;from&quot;)) {
<span class="line-modified">112             from = arguments.get(&quot;from&quot;).asString();</span>
113         } else {
114             var lines = repo.config(&quot;sync.from&quot;);
115             if (lines.size() == 1 &amp;&amp; remotes.contains(lines.get(0))) {
<span class="line-modified">116                 from = lines.get(0);</span>
117             } else {
<span class="line-modified">118                 if (remotes.contains(&quot;upstream&quot;)) {</span>
<span class="line-modified">119                     from = &quot;upstream&quot;;</span>
<span class="line-modified">120                 } else if (remotes.contains(&quot;origin&quot;)) {</span>
<span class="line-modified">121                     if (remotes.contains(&quot;fork&quot;)) {</span>
<span class="line-modified">122                         from = &quot;origin&quot;;</span>
<span class="line-added">123                     } else {</span>
<span class="line-added">124                         var originPullPath = repo.pullPath(&quot;origin&quot;);</span>
<span class="line-added">125                         try {</span>
<span class="line-added">126                             var uri = Remote.toWebURI(originPullPath);</span>
<span class="line-added">127                             from = Forge.from(uri)</span>
128                                         .flatMap(f -&gt; f.repository(uri.getPath().substring(1)))
129                                         .flatMap(r -&gt; r.parent())
130                                         .map(p -&gt; p.webUrl().toString())
131                                         .orElse(null);
<span class="line-modified">132                         } catch (IllegalArgumentException e) {</span>
<span class="line-modified">133                             from = null;</span>
<span class="line-added">134                         }</span>
135                     }
136                 }
137             }
138         }
139 
<span class="line-modified">140         if (from == null) {</span>
<span class="line-modified">141             die(&quot;Could not find repository to sync from, please specify one with --from&quot;);</span>
142         }


143 
<span class="line-modified">144         var fromPullPath = remotes.contains(from) ?</span>
<span class="line-added">145             Remote.toURI(repo.pullPath(from)) : URI.create(from);</span>
<span class="line-added">146 </span>
<span class="line-added">147         String to = null;</span>
148         if (arguments.contains(&quot;to&quot;)) {
<span class="line-modified">149             to = arguments.get(&quot;to&quot;).asString();</span>
150         } else {
151             var lines = repo.config(&quot;sync.to&quot;);
152             if (lines.size() == 1) {
153                 if (!remotes.contains(lines.get(0))) {
154                     die(&quot;The given remote to push to, &quot; + lines.get(0) + &quot;, does not exist&quot;);
155                 } else {
<span class="line-modified">156                     to = lines.get(0);</span>
157                 }
158             } else {
<span class="line-modified">159                 if (remotes.contains(&quot;fork&quot;)) {</span>
<span class="line-added">160                     to = &quot;fork&quot;;</span>
<span class="line-added">161                 } else {</span>
<span class="line-added">162                     to = &quot;origin&quot;;</span>
<span class="line-added">163                 }</span>
164             }
165         }
<span class="line-modified">166 </span>
<span class="line-added">167         var toPushPath = remotes.contains(to) ?</span>
<span class="line-added">168             Remote.toURI(repo.pullPath(to)) : URI.create(to);</span>
169 
170         var branches = new HashSet&lt;String&gt;();
171         if (arguments.contains(&quot;branches&quot;)) {
172             var requested = arguments.get(&quot;branches&quot;).asString().split(&quot;,&quot;);
173             for (var branch : requested) {
174                 branches.add(branch.trim());
175             }
176         } else {
177             var lines = repo.config(&quot;sync.branches&quot;);
178             if (lines.size() == 1) {
179                 var requested = lines.get(0).split(&quot;,&quot;);
180                 for (var branch : requested) {
181                     branches.add(branch.trim());
182                 }
183             }
184         }
185 
<span class="line-modified">186         for (var branch : repo.remoteBranches(from)) {</span>
187             var name = branch.name();
188             if (!branches.isEmpty() &amp;&amp; !branches.contains(name)) {
189                 if (arguments.contains(&quot;verbose&quot;) || arguments.contains(&quot;debug&quot;)) {
190                     System.out.println(&quot;Skipping branch &quot; + name);
191                 }
192                 continue;
193             }
<span class="line-modified">194             System.out.print(&quot;Syncing &quot; + from + &quot;/&quot; + name + &quot; to &quot; + to + &quot;/&quot; + name + &quot;... &quot;);</span>
195             System.out.flush();
<span class="line-modified">196             var fetchHead = repo.fetch(fromPullPath, branch.hash().hex());</span>
<span class="line-modified">197             repo.push(fetchHead, toPushPath, name);</span>
198             System.out.println(&quot;done&quot;);
199         }
200 
201         var shouldPull = arguments.contains(&quot;pull&quot;);
202         if (!shouldPull) {
203             var lines = repo.config(&quot;sync.pull&quot;);
204             shouldPull = lines.size() == 1 &amp;&amp; lines.get(0).toLowerCase().equals(&quot;always&quot;);
205         }
206         if (shouldPull) {
207             int err = pull();
208             if (err != 0) {
209                 System.exit(err);
210             }
211         }
212     }
213 }
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>