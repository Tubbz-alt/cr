<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/pr/src/main/java/org/openjdk/skara/bots/pr/CheckRun.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="CheckWorkItem.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/pr/src/main/java/org/openjdk/skara/bots/pr/CheckRun.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
246     }
247 
248     private Optional&lt;String&gt; getReviewersList(List&lt;Review&gt; reviews) {
249         var reviewers = reviews.stream()
250                                .filter(review -&gt; review.verdict() == Review.Verdict.APPROVED)
251                                .map(review -&gt; {
252                                    var entry = &quot; * &quot; + formatReviewer(review.reviewer());
253                                    if (!review.hash().equals(pr.headHash())) {
254                                        entry += &quot; **Note!** Review applies to &quot; + review.hash();
255                                    }
256                                    return entry;
257                                })
258                                .collect(Collectors.joining(&quot;\n&quot;));
259         if (reviewers.length() &gt; 0) {
260             return Optional.of(reviewers);
261         } else {
262             return Optional.empty();
263         }
264     }
265 
<span class="line-modified">266     private String getStatusMessage(List&lt;Review&gt; reviews, PullRequestCheckIssueVisitor visitor) {</span>
267         var progressBody = new StringBuilder();
268         progressBody.append(&quot;## Progress\n&quot;);
269         progressBody.append(getChecksList(visitor));
270 
271         var issue = Issue.fromString(pr.title());
272         if (issueProject != null &amp;&amp; issue.isPresent()) {
<span class="line-modified">273             progressBody.append(&quot;\n\n## Issue\n&quot;);</span>
<span class="line-modified">274             var iss = issueProject.issue(issue.get().id());</span>
<span class="line-modified">275             if (iss.isPresent()) {</span>
<span class="line-modified">276                 progressBody.append(&quot;[&quot;);</span>
<span class="line-modified">277                 progressBody.append(iss.get().id());</span>
<span class="line-modified">278                 progressBody.append(&quot;](&quot;);</span>
<span class="line-modified">279                 progressBody.append(iss.get().webUrl());</span>
<span class="line-modified">280                 progressBody.append(&quot;): &quot;);</span>
<span class="line-modified">281                 progressBody.append(iss.get().title());</span>
<span class="line-modified">282                 progressBody.append(&quot;\n&quot;);</span>
<span class="line-modified">283             } else {</span>
<span class="line-modified">284                 progressBody.append(&quot;⚠️ Failed to retrieve information on issue `&quot;);</span>
<span class="line-modified">285                 progressBody.append(issue.get().id());</span>
<span class="line-modified">286                 progressBody.append(&quot;`.\n&quot;);</span>









287             }
288         }
289 
290         getReviewersList(reviews).ifPresent(reviewers -&gt; {
291             progressBody.append(&quot;\n\n## Approvers\n&quot;);
292             progressBody.append(reviewers);
293         });
294 
295         return progressBody.toString();
296     }
297 
298     private String updateStatusMessage(String message) {
299         var description = pr.body();
300         var markerIndex = description.lastIndexOf(progressMarker);
301 
302         if (markerIndex &gt;= 0 &amp;&amp; description.substring(markerIndex).equals(message)) {
303             log.info(&quot;Progress already up to date&quot;);
304             return description;
305         }
306         var newBody = (markerIndex &lt; 0 ?
</pre>
<hr />
<pre>
460             pr.createCheck(checkBuilder.build());
461             var localHash = prInstance.commit(censusInstance.namespace(), censusDomain, null);
462 
463             // Try to rebase
464             boolean rebasePossible = true;
465             var ignored = new PrintWriter(new StringWriter());
466             var rebasedHash = prInstance.rebase(localHash, ignored);
467             if (rebasedHash.isEmpty()) {
468                 rebasePossible = false;
469             } else {
470                 localHash = rebasedHash.get();
471             }
472 
473             // Determine current status
474             var visitor = prInstance.executeChecks(localHash, censusInstance);
475             var additionalErrors = botSpecificChecks();
476             updateCheckBuilder(checkBuilder, visitor, additionalErrors);
477             updateReadyForReview(visitor, additionalErrors);
478 
479             // Calculate and update the status message if needed
<span class="line-modified">480             var statusMessage = getStatusMessage(activeReviews, visitor);</span>
481             var updatedBody = updateStatusMessage(statusMessage);
482 
483             // Post / update approval messages (only needed if the review itself can&#39;t contain a body)
484             if (!pr.repository().forge().supportsReviewBody()) {
485                 updateReviewedMessages(comments, allReviews);
486             }
487 
488             var commit = prInstance.localRepo().lookup(localHash).orElseThrow();
489             var commitMessage = String.join(&quot;\n&quot;, commit.message());
490             var readyForIntegration = visitor.getMessages().isEmpty() &amp;&amp; additionalErrors.isEmpty();
491             updateMergeReadyComment(readyForIntegration, commitMessage, comments, activeReviews, rebasePossible);
492             if (readyForIntegration) {
493                 newLabels.add(&quot;ready&quot;);
494             } else {
495                 newLabels.remove(&quot;ready&quot;);
496             }
497             if (!rebasePossible) {
498                 newLabels.add(&quot;outdated&quot;);
499             } else {
500                 newLabels.remove(&quot;outdated&quot;);
</pre>
</td>
<td>
<hr />
<pre>
246     }
247 
248     private Optional&lt;String&gt; getReviewersList(List&lt;Review&gt; reviews) {
249         var reviewers = reviews.stream()
250                                .filter(review -&gt; review.verdict() == Review.Verdict.APPROVED)
251                                .map(review -&gt; {
252                                    var entry = &quot; * &quot; + formatReviewer(review.reviewer());
253                                    if (!review.hash().equals(pr.headHash())) {
254                                        entry += &quot; **Note!** Review applies to &quot; + review.hash();
255                                    }
256                                    return entry;
257                                })
258                                .collect(Collectors.joining(&quot;\n&quot;));
259         if (reviewers.length() &gt; 0) {
260             return Optional.of(reviewers);
261         } else {
262             return Optional.empty();
263         }
264     }
265 
<span class="line-modified">266     private String getStatusMessage(List&lt;Comment&gt; comments, List&lt;Review&gt; reviews, PullRequestCheckIssueVisitor visitor) {</span>
267         var progressBody = new StringBuilder();
268         progressBody.append(&quot;## Progress\n&quot;);
269         progressBody.append(getChecksList(visitor));
270 
271         var issue = Issue.fromString(pr.title());
272         if (issueProject != null &amp;&amp; issue.isPresent()) {
<span class="line-modified">273             var allIssues = new ArrayList&lt;Issue&gt;();</span>
<span class="line-modified">274             allIssues.add(issue.get());</span>
<span class="line-modified">275             allIssues.addAll(SolvesTracker.currentSolved(pr.repository().forge().currentUser(), comments));</span>
<span class="line-modified">276             progressBody.append(&quot;\n\n## Issue&quot;);</span>
<span class="line-modified">277             if (allIssues.size() &gt; 1) {</span>
<span class="line-modified">278                 progressBody.append(&quot;s&quot;);</span>
<span class="line-modified">279             }</span>
<span class="line-modified">280             progressBody.append(&quot;\n&quot;);</span>
<span class="line-modified">281             for (var currentIssue : allIssues) {</span>
<span class="line-modified">282                 var iss = issueProject.issue(currentIssue.id());</span>
<span class="line-modified">283                 if (iss.isPresent()) {</span>
<span class="line-modified">284                     progressBody.append(&quot;[&quot;);</span>
<span class="line-modified">285                     progressBody.append(iss.get().id());</span>
<span class="line-modified">286                     progressBody.append(&quot;](&quot;);</span>
<span class="line-added">287                     progressBody.append(iss.get().webUrl());</span>
<span class="line-added">288                     progressBody.append(&quot;): &quot;);</span>
<span class="line-added">289                     progressBody.append(iss.get().title());</span>
<span class="line-added">290                     progressBody.append(&quot;\n&quot;);</span>
<span class="line-added">291                 } else {</span>
<span class="line-added">292                     progressBody.append(&quot;⚠️ Failed to retrieve information on issue `&quot;);</span>
<span class="line-added">293                     progressBody.append(currentIssue.id());</span>
<span class="line-added">294                     progressBody.append(&quot;`.\n&quot;);</span>
<span class="line-added">295                 }</span>
296             }
297         }
298 
299         getReviewersList(reviews).ifPresent(reviewers -&gt; {
300             progressBody.append(&quot;\n\n## Approvers\n&quot;);
301             progressBody.append(reviewers);
302         });
303 
304         return progressBody.toString();
305     }
306 
307     private String updateStatusMessage(String message) {
308         var description = pr.body();
309         var markerIndex = description.lastIndexOf(progressMarker);
310 
311         if (markerIndex &gt;= 0 &amp;&amp; description.substring(markerIndex).equals(message)) {
312             log.info(&quot;Progress already up to date&quot;);
313             return description;
314         }
315         var newBody = (markerIndex &lt; 0 ?
</pre>
<hr />
<pre>
469             pr.createCheck(checkBuilder.build());
470             var localHash = prInstance.commit(censusInstance.namespace(), censusDomain, null);
471 
472             // Try to rebase
473             boolean rebasePossible = true;
474             var ignored = new PrintWriter(new StringWriter());
475             var rebasedHash = prInstance.rebase(localHash, ignored);
476             if (rebasedHash.isEmpty()) {
477                 rebasePossible = false;
478             } else {
479                 localHash = rebasedHash.get();
480             }
481 
482             // Determine current status
483             var visitor = prInstance.executeChecks(localHash, censusInstance);
484             var additionalErrors = botSpecificChecks();
485             updateCheckBuilder(checkBuilder, visitor, additionalErrors);
486             updateReadyForReview(visitor, additionalErrors);
487 
488             // Calculate and update the status message if needed
<span class="line-modified">489             var statusMessage = getStatusMessage(comments, activeReviews, visitor);</span>
490             var updatedBody = updateStatusMessage(statusMessage);
491 
492             // Post / update approval messages (only needed if the review itself can&#39;t contain a body)
493             if (!pr.repository().forge().supportsReviewBody()) {
494                 updateReviewedMessages(comments, allReviews);
495             }
496 
497             var commit = prInstance.localRepo().lookup(localHash).orElseThrow();
498             var commitMessage = String.join(&quot;\n&quot;, commit.message());
499             var readyForIntegration = visitor.getMessages().isEmpty() &amp;&amp; additionalErrors.isEmpty();
500             updateMergeReadyComment(readyForIntegration, commitMessage, comments, activeReviews, rebasePossible);
501             if (readyForIntegration) {
502                 newLabels.add(&quot;ready&quot;);
503             } else {
504                 newLabels.remove(&quot;ready&quot;);
505             }
506             if (!rebasePossible) {
507                 newLabels.add(&quot;outdated&quot;);
508             } else {
509                 newLabels.remove(&quot;outdated&quot;);
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="CheckWorkItem.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>