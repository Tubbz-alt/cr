<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/mlbridge/ReviewArchive.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 487             assertEquals(archive.host().getCurrentUserDetails().fullName(), thread1reply1.author().fullName().orElseThrow());
 488             var thread1reply2 = conversations.get(0).replies(thread1reply1).get(0);
 489             assertTrue(thread1reply2.body().contains(&quot;Great&quot;));
 490             assertEquals(&quot;integrationreviewer1@openjdk.java.net&quot;, thread1reply2.author().address());
 491             assertEquals(&quot;Generated Reviewer 1&quot;, thread1reply2.author().fullName().orElseThrow());
 492 
 493             var thread2 = conversations.get(0).replies(mail).get(1);
 494             assertEquals(2, thread2.body().split(&quot;^On.*wrote:&quot;).length);
 495             assertEquals(2, thread2.body().split(&quot;&gt; This is now ready&quot;).length, thread2.body());
 496             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread2.subject());
 497             assertFalse(thread2.body().contains(&quot;Review comment\n\n&quot;), thread2.body());
 498             assertTrue(thread2.body().contains(&quot;Another review comment&quot;), thread2.body());
 499             var thread2reply1 = conversations.get(0).replies(thread2).get(0);
 500             assertTrue(thread2reply1.body().contains(&quot;Sounds good&quot;));
 501             var thread2reply2 = conversations.get(0).replies(thread2reply1).get(0);
 502             assertTrue(thread2reply2.body().contains(&quot;Thanks&quot;));
 503 
 504             var thread3 = conversations.get(0).replies(mail).get(2);
 505             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread3.subject());
 506             var thread4 = conversations.get(0).replies(mail).get(3);
<span class="line-modified"> 507             assertEquals(&quot;Re: [Approved]: RFR: This is a pull request&quot;, thread4.subject());</span>
 508         }
 509     }
 510 
 511     @Test
 512     void reviewContext(TestInfo testInfo) throws IOException {
 513         try (var credentials = new HostCredentials(testInfo);
 514              var tempFolder = new TemporaryDirectory();
 515              var archiveFolder = new TemporaryDirectory();
 516              var listServer = new TestMailmanServer()) {
 517             var author = credentials.getHostedRepository();
 518             var archive = credentials.getHostedRepository();
 519             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 520             var censusBuilder = credentials.getCensusBuilder()
 521                                            .addAuthor(author.host().getCurrentUserDetails().id());
 522             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 523             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 524                                                  listAddress, Set.of(), Set.of(),
 525                                                  listServer.getArchive(),
 526                                                  listServer.getSMTP(),
 527                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
</pre>
<hr />
<pre>
 778                 localRepo.push(anotherHash, author.getUrl(), &quot;edit&quot;);
 779 
 780                 // Make sure that the push registered
 781                 lastHeadHash = pr.getHeadHash();
 782                 refreshCount = 0;
 783                 do {
 784                     pr = author.getPullRequest(pr.getId());
 785                     if (refreshCount++ &gt; 100) {
 786                         fail(&quot;The PR did not update after the new push&quot;);
 787                     }
 788                 } while (pr.getHeadHash().equals(lastHeadHash));
 789 
 790                 TestBotRunner.runPeriodicItems(mlBot);
 791                 TestBotRunner.runPeriodicItems(mlBot);
 792                 listServer.processIncoming();
 793             }
 794             var updatedConversations = mailmanList.conversations(Duration.ofDays(1));
 795             assertEquals(1, updatedConversations.size());
 796             var conversation = updatedConversations.get(0);
 797             assertEquals(6, conversation.allMessages().size());
<span class="line-modified"> 798             assertEquals(&quot;Re: [Rev 01]: RFR: This is a pull request&quot;, conversation.allMessages().get(1).subject());</span>
<span class="line-modified"> 799             assertEquals(&quot;Re: [Rev 01]: RFR: This is a pull request&quot;, conversation.allMessages().get(2).subject(), conversation.allMessages().get(2).toString());</span>
<span class="line-modified"> 800             assertEquals(&quot;Re: [Rev 04]: RFR: This is a pull request&quot;, conversation.allMessages().get(5).subject());</span>
 801         }
 802     }
 803 
 804     @Test
 805     void rebased(TestInfo testInfo) throws IOException {
 806         try (var credentials = new HostCredentials(testInfo);
 807              var tempFolder = new TemporaryDirectory();
 808              var archiveFolder = new TemporaryDirectory();
 809              var listServer = new TestMailmanServer()) {
 810             var author = credentials.getHostedRepository();
 811             var archive = credentials.getHostedRepository();
 812             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 813             var censusBuilder = credentials.getCensusBuilder()
 814                                            .addAuthor(author.host().getCurrentUserDetails().id());
 815             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 816             var mlBot = new MailingListBridgeBot(sender, author, archive, censusBuilder.build(), &quot;master&quot;,
 817                                                  listAddress, Set.of(), Set.of(),
 818                                                  listServer.getArchive(), listServer.getSMTP(),
 819                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 820                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
</pre>
<hr />
<pre>
 867 
 868             // The webrev comment should be updated
 869             var comments = pr.getComments();
 870             var webrevComments = comments.stream()
 871                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 872                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 873                                          .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
 874                                          .collect(Collectors.toList());
 875             assertEquals(1, webrevComments.size());
 876 
 877             // Check that sender address is set properly
 878             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 879             var mailmanList = mailmanServer.getList(listAddress.address());
 880             var conversations = mailmanList.conversations(Duration.ofDays(1));
 881             assertEquals(1, conversations.size());
 882             for (var newMail : conversations.get(0).allMessages()) {
 883                 assertEquals(noreplyAddress(archive), newMail.author().address());
 884                 assertEquals(sender, newMail.sender());
 885                 assertFalse(newMail.hasHeader(&quot;PR-Head-Hash&quot;));
 886             }
<span class="line-modified"> 887             assertEquals(&quot;Re: [Rev 01]: RFR: This is a pull request&quot;, conversations.get(0).allMessages().get(1).subject());</span>
 888         }
 889     }
 890 
 891     @Test
 892     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
 893         try (var credentials = new HostCredentials(testInfo);
 894              var tempFolder = new TemporaryDirectory();
 895              var archiveFolder = new TemporaryDirectory();
 896              var webrevFolder = new TemporaryDirectory();
 897              var listServer = new TestMailmanServer()) {
 898             var author = credentials.getHostedRepository();
 899             var archive = credentials.getHostedRepository();
 900             var ignored = credentials.getHostedRepository();
 901             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 902             var censusBuilder = credentials.getCensusBuilder()
 903                                            .addAuthor(author.host().getCurrentUserDetails().id());
 904             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 905             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 906                                                  listAddress,
 907                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
</pre>
<hr />
<pre>
1008             // The archive should contain a note
1009             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1010             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Review status set to Disapproved&quot;));
1011             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot; by integrationreviewer1&quot;));
1012             if (author.host().supportsReviewBody()) {
1013                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
1014             }
1015 
1016             // Then approve it
1017             reviewedPr.addReview(Review.Verdict.APPROVED, &quot;Reason 2&quot;);
1018             TestBotRunner.runPeriodicItems(mlBot);
1019             TestBotRunner.runPeriodicItems(mlBot);
1020             TestBotRunner.runPeriodicItems(mlBot);
1021 
1022             // The archive should contain another note
1023             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1024             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Review status set to Approved&quot;));
1025             if (author.host().supportsReviewBody()) {
1026                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 2&quot;));
1027             }
<span class="line-modified">1028             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Re: \\[Approved\\]:&quot;));</span>
1029 
1030             // Yet another change
1031             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 3&quot;);
1032             TestBotRunner.runPeriodicItems(mlBot);
1033             TestBotRunner.runPeriodicItems(mlBot);
1034             TestBotRunner.runPeriodicItems(mlBot);
1035 
1036             // The archive should contain another note
1037             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1038             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Review status set to Disapproved&quot;));
1039             if (author.host().supportsReviewBody()) {
1040                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
1041             }
1042         }
1043     }
1044 
1045     @Test
1046     void ignoreComments(TestInfo testInfo) throws IOException {
1047         try (var credentials = new HostCredentials(testInfo);
1048              var tempFolder = new TemporaryDirectory();
</pre>
</td>
<td>
<hr />
<pre>
 487             assertEquals(archive.host().getCurrentUserDetails().fullName(), thread1reply1.author().fullName().orElseThrow());
 488             var thread1reply2 = conversations.get(0).replies(thread1reply1).get(0);
 489             assertTrue(thread1reply2.body().contains(&quot;Great&quot;));
 490             assertEquals(&quot;integrationreviewer1@openjdk.java.net&quot;, thread1reply2.author().address());
 491             assertEquals(&quot;Generated Reviewer 1&quot;, thread1reply2.author().fullName().orElseThrow());
 492 
 493             var thread2 = conversations.get(0).replies(mail).get(1);
 494             assertEquals(2, thread2.body().split(&quot;^On.*wrote:&quot;).length);
 495             assertEquals(2, thread2.body().split(&quot;&gt; This is now ready&quot;).length, thread2.body());
 496             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread2.subject());
 497             assertFalse(thread2.body().contains(&quot;Review comment\n\n&quot;), thread2.body());
 498             assertTrue(thread2.body().contains(&quot;Another review comment&quot;), thread2.body());
 499             var thread2reply1 = conversations.get(0).replies(thread2).get(0);
 500             assertTrue(thread2reply1.body().contains(&quot;Sounds good&quot;));
 501             var thread2reply2 = conversations.get(0).replies(thread2reply1).get(0);
 502             assertTrue(thread2reply2.body().contains(&quot;Thanks&quot;));
 503 
 504             var thread3 = conversations.get(0).replies(mail).get(2);
 505             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread3.subject());
 506             var thread4 = conversations.get(0).replies(mail).get(3);
<span class="line-modified"> 507             assertEquals(&quot;Re: [Approved] RFR: This is a pull request&quot;, thread4.subject());</span>
 508         }
 509     }
 510 
 511     @Test
 512     void reviewContext(TestInfo testInfo) throws IOException {
 513         try (var credentials = new HostCredentials(testInfo);
 514              var tempFolder = new TemporaryDirectory();
 515              var archiveFolder = new TemporaryDirectory();
 516              var listServer = new TestMailmanServer()) {
 517             var author = credentials.getHostedRepository();
 518             var archive = credentials.getHostedRepository();
 519             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 520             var censusBuilder = credentials.getCensusBuilder()
 521                                            .addAuthor(author.host().getCurrentUserDetails().id());
 522             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 523             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 524                                                  listAddress, Set.of(), Set.of(),
 525                                                  listServer.getArchive(),
 526                                                  listServer.getSMTP(),
 527                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
</pre>
<hr />
<pre>
 778                 localRepo.push(anotherHash, author.getUrl(), &quot;edit&quot;);
 779 
 780                 // Make sure that the push registered
 781                 lastHeadHash = pr.getHeadHash();
 782                 refreshCount = 0;
 783                 do {
 784                     pr = author.getPullRequest(pr.getId());
 785                     if (refreshCount++ &gt; 100) {
 786                         fail(&quot;The PR did not update after the new push&quot;);
 787                     }
 788                 } while (pr.getHeadHash().equals(lastHeadHash));
 789 
 790                 TestBotRunner.runPeriodicItems(mlBot);
 791                 TestBotRunner.runPeriodicItems(mlBot);
 792                 listServer.processIncoming();
 793             }
 794             var updatedConversations = mailmanList.conversations(Duration.ofDays(1));
 795             assertEquals(1, updatedConversations.size());
 796             var conversation = updatedConversations.get(0);
 797             assertEquals(6, conversation.allMessages().size());
<span class="line-modified"> 798             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(1).subject());</span>
<span class="line-modified"> 799             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(2).subject(), conversation.allMessages().get(2).toString());</span>
<span class="line-modified"> 800             assertEquals(&quot;Re: [Rev 04] RFR: This is a pull request&quot;, conversation.allMessages().get(5).subject());</span>
 801         }
 802     }
 803 
 804     @Test
 805     void rebased(TestInfo testInfo) throws IOException {
 806         try (var credentials = new HostCredentials(testInfo);
 807              var tempFolder = new TemporaryDirectory();
 808              var archiveFolder = new TemporaryDirectory();
 809              var listServer = new TestMailmanServer()) {
 810             var author = credentials.getHostedRepository();
 811             var archive = credentials.getHostedRepository();
 812             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 813             var censusBuilder = credentials.getCensusBuilder()
 814                                            .addAuthor(author.host().getCurrentUserDetails().id());
 815             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 816             var mlBot = new MailingListBridgeBot(sender, author, archive, censusBuilder.build(), &quot;master&quot;,
 817                                                  listAddress, Set.of(), Set.of(),
 818                                                  listServer.getArchive(), listServer.getSMTP(),
 819                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 820                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
</pre>
<hr />
<pre>
 867 
 868             // The webrev comment should be updated
 869             var comments = pr.getComments();
 870             var webrevComments = comments.stream()
 871                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 872                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 873                                          .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
 874                                          .collect(Collectors.toList());
 875             assertEquals(1, webrevComments.size());
 876 
 877             // Check that sender address is set properly
 878             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 879             var mailmanList = mailmanServer.getList(listAddress.address());
 880             var conversations = mailmanList.conversations(Duration.ofDays(1));
 881             assertEquals(1, conversations.size());
 882             for (var newMail : conversations.get(0).allMessages()) {
 883                 assertEquals(noreplyAddress(archive), newMail.author().address());
 884                 assertEquals(sender, newMail.sender());
 885                 assertFalse(newMail.hasHeader(&quot;PR-Head-Hash&quot;));
 886             }
<span class="line-modified"> 887             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversations.get(0).allMessages().get(1).subject());</span>
 888         }
 889     }
 890 
 891     @Test
 892     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
 893         try (var credentials = new HostCredentials(testInfo);
 894              var tempFolder = new TemporaryDirectory();
 895              var archiveFolder = new TemporaryDirectory();
 896              var webrevFolder = new TemporaryDirectory();
 897              var listServer = new TestMailmanServer()) {
 898             var author = credentials.getHostedRepository();
 899             var archive = credentials.getHostedRepository();
 900             var ignored = credentials.getHostedRepository();
 901             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 902             var censusBuilder = credentials.getCensusBuilder()
 903                                            .addAuthor(author.host().getCurrentUserDetails().id());
 904             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 905             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 906                                                  listAddress,
 907                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
</pre>
<hr />
<pre>
1008             // The archive should contain a note
1009             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1010             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Review status set to Disapproved&quot;));
1011             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot; by integrationreviewer1&quot;));
1012             if (author.host().supportsReviewBody()) {
1013                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
1014             }
1015 
1016             // Then approve it
1017             reviewedPr.addReview(Review.Verdict.APPROVED, &quot;Reason 2&quot;);
1018             TestBotRunner.runPeriodicItems(mlBot);
1019             TestBotRunner.runPeriodicItems(mlBot);
1020             TestBotRunner.runPeriodicItems(mlBot);
1021 
1022             // The archive should contain another note
1023             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1024             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Review status set to Approved&quot;));
1025             if (author.host().supportsReviewBody()) {
1026                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 2&quot;));
1027             }
<span class="line-modified">1028             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Re: \\[Approved\\] RFR:&quot;));</span>
1029 
1030             // Yet another change
1031             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 3&quot;);
1032             TestBotRunner.runPeriodicItems(mlBot);
1033             TestBotRunner.runPeriodicItems(mlBot);
1034             TestBotRunner.runPeriodicItems(mlBot);
1035 
1036             // The archive should contain another note
1037             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1038             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Review status set to Disapproved&quot;));
1039             if (author.host().supportsReviewBody()) {
1040                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
1041             }
1042         }
1043     }
1044 
1045     @Test
1046     void ignoreComments(TestInfo testInfo) throws IOException {
1047         try (var credentials = new HostCredentials(testInfo);
1048              var tempFolder = new TemporaryDirectory();
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/mlbridge/ReviewArchive.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>