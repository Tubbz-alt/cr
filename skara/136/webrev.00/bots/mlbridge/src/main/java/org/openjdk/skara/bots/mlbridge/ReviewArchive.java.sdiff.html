<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/ReviewArchive.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/ReviewArchive.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
173         var id = getMessageId();
174         var email = Email.create(&quot;RFR: &quot; + prInstance.pr().getTitle(), body)
175                          .sender(sender)
176                          .author(getAuthorAddress(prInstance.pr().getAuthor()))
177                          .id(id)
178                          .header(&quot;PR-Head-Hash&quot;, prInstance.headHash().hex())
179                          .header(&quot;PR-Base-Hash&quot;, prInstance.baseHash().hex())
180                          .build();
181         generated.add(email);
182         generatedIds.put(getStableMessageId(id), email);
183     }
184 
185     private String latestHeadPrefix() {
186         return String.format(&quot;[Rev %02d]&quot;, revisionCount());
187     }
188 
189     void addFull(URI webrev) {
190         var body = ArchiveMessages.composeRebaseComment(prInstance, webrev);
191         var id = getMessageId(prInstance.headHash());
192         var parent = topEmail();
<span class="line-modified">193         var email = Email.reply(parent, &quot;Re: &quot; + latestHeadPrefix() + &quot;: RFR: &quot; + prInstance.pr().getTitle(), body)</span>
194                          .sender(sender)
195                          .author(getAuthorAddress(prInstance.pr().getAuthor()))
196                          .recipient(parent.author())
197                          .id(id)
198                          .header(&quot;PR-Head-Hash&quot;, prInstance.headHash().hex())
199                          .header(&quot;PR-Base-Hash&quot;, prInstance.baseHash().hex())
200                          .header(&quot;PR-Sequence&quot;, Integer.toString(existing.size() + generated.size()))
201                          .build();
202         generated.add(email);
203         generatedIds.put(getStableMessageId(id), email);
204     }
205 
206     void addIncremental(URI fullWebrev, URI incrementalWebrev) {
207         var body = ArchiveMessages.composeIncrementalComment(latestHead(), prInstance, fullWebrev, incrementalWebrev);
208         var id = getMessageId(prInstance.headHash());
209         var parent = topEmail();
<span class="line-modified">210         var email = Email.reply(parent, &quot;Re: &quot; + latestHeadPrefix() + &quot;: RFR: &quot; + prInstance.pr().getTitle(), body)</span>
211                          .sender(sender)
212                          .author(getAuthorAddress(prInstance.pr().getAuthor()))
213                          .recipient(parent.author())
214                          .id(id)
215                          .header(&quot;PR-Head-Hash&quot;, prInstance.headHash().hex())
216                          .header(&quot;PR-Base-Hash&quot;, prInstance.baseHash().hex())
217                          .header(&quot;PR-Sequence&quot;, Integer.toString(existing.size() + generated.size()))
218                          .build();
219         generated.add(email);
220         generatedIds.put(getStableMessageId(id), email);
221     }
222 
223     private Optional&lt;Email&gt; findCollapsable(Email parent, HostUserDetails author, String subject) {
224         var parentId = getStableMessageId(parent.id());
225 
226         // Is it a self-reply?
227         if (parent.author().equals(getAuthorAddress(author)) &amp;&amp; generatedIds.containsKey(parentId)) {
228             // But avoid extending top-level parents
229             if (!parent.hasHeader(&quot;PR-Head-Hash&quot;)) {
230                 // And only collapse identical subjects
</pre>
<hr />
<pre>
315         }
316         return &quot;none&quot;;
317     }
318 
319     void addReview(Review review) {
320         var id = getMessageId(review);
321         if (existingIds.containsKey(getStableMessageId(id))) {
322             return;
323         }
324 
325         var contributor = censusInstance.namespace().get(review.reviewer().id());
326         var isReviewer = contributor != null &amp;&amp; censusInstance.project().isReviewer(contributor.username(), censusInstance.configuration().census().version());
327 
328         // Default parent and subject
329         var parent = topCommentForHash(review.hash());
330         var subject = parent.subject();
331 
332         // Approvals by Reviewers get special treatment - post these as top-level comments
333         if (review.verdict() == Review.Verdict.APPROVED &amp;&amp; isReviewer) {
334             parent = topEmail();
<span class="line-modified">335             subject = &quot;Re: [Approved]: &quot; + &quot;RFR: &quot; + prInstance.pr().getTitle();</span>
336         }
337 
338         var userName = contributor != null ? contributor.username() : review.reviewer().userName() + &quot;@&quot; + censusInstance.namespace().name();
339         var userRole = contributor != null ? projectRole(contributor) : &quot;none&quot;;
340         var replyBody = ArchiveMessages.reviewCommentBody(review.body().orElse(&quot;&quot;), review.verdict(), userName, userRole);
341 
342         addReplyCommon(parent, review.reviewer(), subject, replyBody, id);
343     }
344 
345     void addReviewComment(ReviewComment reviewComment) {
346         var id = getMessageId(reviewComment);
347         if (existingIds.containsKey(getStableMessageId(id))) {
348             return;
349         }
350 
351         var parent = parentForReviewComment(reviewComment);
352         var body = new StringBuilder();
353 
354         // Add some context to the first post
355         if (reviewComment.parent().isEmpty()) {
</pre>
</td>
<td>
<hr />
<pre>
173         var id = getMessageId();
174         var email = Email.create(&quot;RFR: &quot; + prInstance.pr().getTitle(), body)
175                          .sender(sender)
176                          .author(getAuthorAddress(prInstance.pr().getAuthor()))
177                          .id(id)
178                          .header(&quot;PR-Head-Hash&quot;, prInstance.headHash().hex())
179                          .header(&quot;PR-Base-Hash&quot;, prInstance.baseHash().hex())
180                          .build();
181         generated.add(email);
182         generatedIds.put(getStableMessageId(id), email);
183     }
184 
185     private String latestHeadPrefix() {
186         return String.format(&quot;[Rev %02d]&quot;, revisionCount());
187     }
188 
189     void addFull(URI webrev) {
190         var body = ArchiveMessages.composeRebaseComment(prInstance, webrev);
191         var id = getMessageId(prInstance.headHash());
192         var parent = topEmail();
<span class="line-modified">193         var email = Email.reply(parent, &quot;Re: &quot; + latestHeadPrefix() + &quot; RFR: &quot; + prInstance.pr().getTitle(), body)</span>
194                          .sender(sender)
195                          .author(getAuthorAddress(prInstance.pr().getAuthor()))
196                          .recipient(parent.author())
197                          .id(id)
198                          .header(&quot;PR-Head-Hash&quot;, prInstance.headHash().hex())
199                          .header(&quot;PR-Base-Hash&quot;, prInstance.baseHash().hex())
200                          .header(&quot;PR-Sequence&quot;, Integer.toString(existing.size() + generated.size()))
201                          .build();
202         generated.add(email);
203         generatedIds.put(getStableMessageId(id), email);
204     }
205 
206     void addIncremental(URI fullWebrev, URI incrementalWebrev) {
207         var body = ArchiveMessages.composeIncrementalComment(latestHead(), prInstance, fullWebrev, incrementalWebrev);
208         var id = getMessageId(prInstance.headHash());
209         var parent = topEmail();
<span class="line-modified">210         var email = Email.reply(parent, &quot;Re: &quot; + latestHeadPrefix() + &quot; RFR: &quot; + prInstance.pr().getTitle(), body)</span>
211                          .sender(sender)
212                          .author(getAuthorAddress(prInstance.pr().getAuthor()))
213                          .recipient(parent.author())
214                          .id(id)
215                          .header(&quot;PR-Head-Hash&quot;, prInstance.headHash().hex())
216                          .header(&quot;PR-Base-Hash&quot;, prInstance.baseHash().hex())
217                          .header(&quot;PR-Sequence&quot;, Integer.toString(existing.size() + generated.size()))
218                          .build();
219         generated.add(email);
220         generatedIds.put(getStableMessageId(id), email);
221     }
222 
223     private Optional&lt;Email&gt; findCollapsable(Email parent, HostUserDetails author, String subject) {
224         var parentId = getStableMessageId(parent.id());
225 
226         // Is it a self-reply?
227         if (parent.author().equals(getAuthorAddress(author)) &amp;&amp; generatedIds.containsKey(parentId)) {
228             // But avoid extending top-level parents
229             if (!parent.hasHeader(&quot;PR-Head-Hash&quot;)) {
230                 // And only collapse identical subjects
</pre>
<hr />
<pre>
315         }
316         return &quot;none&quot;;
317     }
318 
319     void addReview(Review review) {
320         var id = getMessageId(review);
321         if (existingIds.containsKey(getStableMessageId(id))) {
322             return;
323         }
324 
325         var contributor = censusInstance.namespace().get(review.reviewer().id());
326         var isReviewer = contributor != null &amp;&amp; censusInstance.project().isReviewer(contributor.username(), censusInstance.configuration().census().version());
327 
328         // Default parent and subject
329         var parent = topCommentForHash(review.hash());
330         var subject = parent.subject();
331 
332         // Approvals by Reviewers get special treatment - post these as top-level comments
333         if (review.verdict() == Review.Verdict.APPROVED &amp;&amp; isReviewer) {
334             parent = topEmail();
<span class="line-modified">335             subject = &quot;Re: [Approved] &quot; + &quot;RFR: &quot; + prInstance.pr().getTitle();</span>
336         }
337 
338         var userName = contributor != null ? contributor.username() : review.reviewer().userName() + &quot;@&quot; + censusInstance.namespace().name();
339         var userRole = contributor != null ? projectRole(contributor) : &quot;none&quot;;
340         var replyBody = ArchiveMessages.reviewCommentBody(review.body().orElse(&quot;&quot;), review.verdict(), userName, userRole);
341 
342         addReplyCommon(parent, review.reviewer(), subject, replyBody, id);
343     }
344 
345     void addReviewComment(ReviewComment reviewComment) {
346         var id = getMessageId(reviewComment);
347         if (existingIds.containsKey(getStableMessageId(id))) {
348             return;
349         }
350 
351         var parent = parentForReviewComment(reviewComment);
352         var body = new StringBuilder();
353 
354         // Add some context to the first post
355         if (reviewComment.parent().isEmpty()) {
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>