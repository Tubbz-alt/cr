<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/WebrevStorage.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../../test/src/main/java/org/openjdk/skara/test/TestWebrevServer.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/WebrevStorage.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
133                 localStorage.push(hash, storage.url(), storageRef);
134             }
135         }
136     }
137 
138     private static void clearDirectory(Path directory) {
139         try (var files = Files.walk(directory)) {
140             files.map(Path::toFile)
141                  .sorted(Comparator.reverseOrder())
142                  .forEach(File::delete);
143         } catch (IOException io) {
144             throw new RuntimeException(io);
145         }
146     }
147 
148     private void awaitPublication(URI uri, Duration timeout) throws IOException {
149         var end = Instant.now().plus(timeout);
150         var uriBuilder = URIBuilder.base(uri);
151         var client = HttpClient.newBuilder()
152                                .connectTimeout(Duration.ofSeconds(30))
<span class="line-removed">153                                .followRedirects(HttpClient.Redirect.NORMAL)</span>
154                                .build();
155         while (Instant.now().isBefore(end)) {
156             var uncachedUri = uriBuilder.setQuery(Map.of(&quot;nocache&quot;, UUID.randomUUID().toString())).build();

157             var request = HttpRequest.newBuilder(uncachedUri)
158                                      .timeout(Duration.ofSeconds(30))
159                                      .GET()
160                                      .build();
161             try {
162                 var response = client.send(request, HttpResponse.BodyHandlers.ofString());
<span class="line-modified">163                 if (response.statusCode() &lt; 400) {</span>
164                     log.info(response.statusCode() + &quot; when checking &quot; + uncachedUri + &quot; - success!&quot;);
<span class="line-removed">165                     // Success!</span>
166                     return;
167                 }








168                 log.info(response.statusCode() + &quot; when checking &quot; + uncachedUri + &quot; - waiting...&quot;);
169                 Thread.sleep(Duration.ofSeconds(10).toMillis());
170             } catch (InterruptedException ignored) {
171             }
172         }
173 
174         throw new RuntimeException(&quot;No success response from &quot; + uri + &quot; within &quot; + timeout);
175     }
176 
177     private URI createAndArchive(PullRequest pr, Repository localRepository, Path scratchPath, Hash base, Hash head, String identifier) {
178         try {
179             var localStorage = Repository.materialize(scratchPath, storage.url(),
180                                                       &quot;+&quot; + storageRef + &quot;:mlbridge_webrevs&quot;);
181             var relativeFolder = baseFolder.resolve(String.format(&quot;%s/webrev.%s&quot;, pr.id(), identifier));
182             var outputFolder = scratchPath.resolve(relativeFolder);
183             // If a previous operation was interrupted there may be content here already - overwrite if so
184             if (Files.exists(outputFolder)) {
185                 clearDirectory(outputFolder);
186             }
187             generate(pr, localRepository, outputFolder, base, head);
</pre>
</td>
<td>
<hr />
<pre>
133                 localStorage.push(hash, storage.url(), storageRef);
134             }
135         }
136     }
137 
138     private static void clearDirectory(Path directory) {
139         try (var files = Files.walk(directory)) {
140             files.map(Path::toFile)
141                  .sorted(Comparator.reverseOrder())
142                  .forEach(File::delete);
143         } catch (IOException io) {
144             throw new RuntimeException(io);
145         }
146     }
147 
148     private void awaitPublication(URI uri, Duration timeout) throws IOException {
149         var end = Instant.now().plus(timeout);
150         var uriBuilder = URIBuilder.base(uri);
151         var client = HttpClient.newBuilder()
152                                .connectTimeout(Duration.ofSeconds(30))

153                                .build();
154         while (Instant.now().isBefore(end)) {
155             var uncachedUri = uriBuilder.setQuery(Map.of(&quot;nocache&quot;, UUID.randomUUID().toString())).build();
<span class="line-added">156             log.fine(&quot;Validating webrev URL: &quot; + uncachedUri);</span>
157             var request = HttpRequest.newBuilder(uncachedUri)
158                                      .timeout(Duration.ofSeconds(30))
159                                      .GET()
160                                      .build();
161             try {
162                 var response = client.send(request, HttpResponse.BodyHandlers.ofString());
<span class="line-modified">163                 if (response.statusCode() &lt; 300) {</span>
164                     log.info(response.statusCode() + &quot; when checking &quot; + uncachedUri + &quot; - success!&quot;);

165                     return;
166                 }
<span class="line-added">167                 if (response.statusCode() &lt; 400) {</span>
<span class="line-added">168                     var newLocation = response.headers().firstValue(&quot;location&quot;);</span>
<span class="line-added">169                     if (newLocation.isPresent()) {</span>
<span class="line-added">170                         log.info(&quot;Webrev url redirection: &quot; + newLocation.get());</span>
<span class="line-added">171                         uriBuilder = URIBuilder.base(newLocation.get());</span>
<span class="line-added">172                         continue;</span>
<span class="line-added">173                     }</span>
<span class="line-added">174                 }</span>
175                 log.info(response.statusCode() + &quot; when checking &quot; + uncachedUri + &quot; - waiting...&quot;);
176                 Thread.sleep(Duration.ofSeconds(10).toMillis());
177             } catch (InterruptedException ignored) {
178             }
179         }
180 
181         throw new RuntimeException(&quot;No success response from &quot; + uri + &quot; within &quot; + timeout);
182     }
183 
184     private URI createAndArchive(PullRequest pr, Repository localRepository, Path scratchPath, Hash base, Hash head, String identifier) {
185         try {
186             var localStorage = Repository.materialize(scratchPath, storage.url(),
187                                                       &quot;+&quot; + storageRef + &quot;:mlbridge_webrevs&quot;);
188             var relativeFolder = baseFolder.resolve(String.format(&quot;%s/webrev.%s&quot;, pr.id(), identifier));
189             var outputFolder = scratchPath.resolve(relativeFolder);
190             // If a previous operation was interrupted there may be content here already - overwrite if so
191             if (Files.exists(outputFolder)) {
192                 clearDirectory(outputFolder);
193             }
194             generate(pr, localRepository, outputFolder, base, head);
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../../test/src/main/java/org/openjdk/skara/test/TestWebrevServer.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>