<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/WebrevStorage.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../../test/src/main/java/org/openjdk/skara/test/TestWebrevServer.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/WebrevStorage.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 148,25 ***</span>
      private void awaitPublication(URI uri, Duration timeout) throws IOException {
          var end = Instant.now().plus(timeout);
          var uriBuilder = URIBuilder.base(uri);
          var client = HttpClient.newBuilder()
                                 .connectTimeout(Duration.ofSeconds(30))
<span class="line-removed">-                                .followRedirects(HttpClient.Redirect.NORMAL)</span>
                                 .build();
          while (Instant.now().isBefore(end)) {
              var uncachedUri = uriBuilder.setQuery(Map.of(&quot;nocache&quot;, UUID.randomUUID().toString())).build();
              var request = HttpRequest.newBuilder(uncachedUri)
                                       .timeout(Duration.ofSeconds(30))
                                       .GET()
                                       .build();
              try {
                  var response = client.send(request, HttpResponse.BodyHandlers.ofString());
<span class="line-modified">!                 if (response.statusCode() &lt; 400) {</span>
                      log.info(response.statusCode() + &quot; when checking &quot; + uncachedUri + &quot; - success!&quot;);
<span class="line-removed">-                     // Success!</span>
                      return;
                  }
                  log.info(response.statusCode() + &quot; when checking &quot; + uncachedUri + &quot; - waiting...&quot;);
                  Thread.sleep(Duration.ofSeconds(10).toMillis());
              } catch (InterruptedException ignored) {
              }
          }
<span class="line-new-header">--- 148,32 ---</span>
      private void awaitPublication(URI uri, Duration timeout) throws IOException {
          var end = Instant.now().plus(timeout);
          var uriBuilder = URIBuilder.base(uri);
          var client = HttpClient.newBuilder()
                                 .connectTimeout(Duration.ofSeconds(30))
                                 .build();
          while (Instant.now().isBefore(end)) {
              var uncachedUri = uriBuilder.setQuery(Map.of(&quot;nocache&quot;, UUID.randomUUID().toString())).build();
<span class="line-added">+             log.fine(&quot;Validating webrev URL: &quot; + uncachedUri);</span>
              var request = HttpRequest.newBuilder(uncachedUri)
                                       .timeout(Duration.ofSeconds(30))
                                       .GET()
                                       .build();
              try {
                  var response = client.send(request, HttpResponse.BodyHandlers.ofString());
<span class="line-modified">!                 if (response.statusCode() &lt; 300) {</span>
                      log.info(response.statusCode() + &quot; when checking &quot; + uncachedUri + &quot; - success!&quot;);
                      return;
                  }
<span class="line-added">+                 if (response.statusCode() &lt; 400) {</span>
<span class="line-added">+                     var newLocation = response.headers().firstValue(&quot;location&quot;);</span>
<span class="line-added">+                     if (newLocation.isPresent()) {</span>
<span class="line-added">+                         log.info(&quot;Webrev url redirection: &quot; + newLocation.get());</span>
<span class="line-added">+                         uriBuilder = URIBuilder.base(newLocation.get());</span>
<span class="line-added">+                         continue;</span>
<span class="line-added">+                     }</span>
<span class="line-added">+                 }</span>
                  log.info(response.statusCode() + &quot; when checking &quot; + uncachedUri + &quot; - waiting...&quot;);
                  Thread.sleep(Duration.ofSeconds(10).toMillis());
              } catch (InterruptedException ignored) {
              }
          }
</pre>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../../test/src/main/java/org/openjdk/skara/test/TestWebrevServer.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>