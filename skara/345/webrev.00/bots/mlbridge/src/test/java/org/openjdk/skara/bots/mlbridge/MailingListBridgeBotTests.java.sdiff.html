<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="MailingListArchiveReaderBotTests.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="WebrevStorageTests.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  87             return false;
  88         }
  89     }
  90 
  91     private long countSubstrings(String string, String substring) {
  92         return Pattern.compile(substring).matcher(string).results().count();
  93     }
  94 
  95     private String noreplyAddress(HostedRepository repository) {
  96         return &quot;test+&quot; + repository.forge().currentUser().id() + &quot;+&quot; +
  97                 repository.forge().currentUser().userName() +
  98                 &quot;@openjdk.java.net&quot;;
  99     }
 100 
 101     @Test
 102     void simpleArchive(TestInfo testInfo) throws IOException {
 103         try (var credentials = new HostCredentials(testInfo);
 104              var tempFolder = new TemporaryDirectory();
 105              var archiveFolder = new TemporaryDirectory();
 106              var webrevFolder = new TemporaryDirectory();
<span class="line-modified"> 107              var listServer = new TestMailmanServer()) {</span>

 108             var author = credentials.getHostedRepository();
 109             var archive = credentials.getHostedRepository();
 110             var ignored = credentials.getHostedRepository();
 111             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 112             var censusBuilder = credentials.getCensusBuilder()
 113                                            .addAuthor(author.forge().currentUser().id());
 114             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 115             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 116                                                  censusBuilder.build(), &quot;master&quot;, listAddress,
 117                                                  Set.of(ignored.forge().currentUser().userName()),
 118                                                  Set.of(),
 119                                                  listServer.getArchive(), listServer.getSMTP(),
 120                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified"> 121                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),</span>
 122                                                  Set.of(&quot;rfr&quot;), Map.of(ignored.forge().currentUser().userName(),
 123                                                                        Pattern.compile(&quot;ready&quot;)),
 124                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 125                                                  Map.of(&quot;Extra1&quot;, &quot;val1&quot;, &quot;Extra2&quot;, &quot;val2&quot;),
 126                                                  Duration.ZERO);
 127 
 128             // Populate the projects repository
 129             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 130             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 131             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 132             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 133 
 134             // Make a change with a corresponding PR
 135             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 136                                                                &quot;Change msg\n\nWith several lines&quot;);
 137             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 138             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 139             pr.setBody(&quot;This should not be ready&quot;);
 140 
 141             // Run an archive pass
</pre>
<hr />
<pre>
 163             // Run another archive pass
 164             TestBotRunner.runPeriodicItems(mlBot);
 165 
 166             // It should still not be archived
 167             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 168             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 169 
 170             // Now post a ready comment
 171             ignoredPr.addComment(&quot;ready&quot;);
 172 
 173             // Run another archive pass
 174             TestBotRunner.runPeriodicItems(mlBot);
 175 
 176             // The archive should now contain an entry
 177             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 178             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 179             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
 180             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
 181             assertTrue(archiveContains(archiveFolder.path(), &quot;Changes:&quot;));
 182             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
<span class="line-modified"> 183             assertTrue(archiveContains(archiveFolder.path(), &quot;http://www.test.test/&quot;));</span>
 184             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));
 185             assertTrue(archiveContains(archiveFolder.path(), &quot;Issue:&quot;));
 186             assertTrue(archiveContains(archiveFolder.path(), &quot;http://issues.test/browse/TSTPRJ-1234&quot;));
 187             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch:&quot;));
 188             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - &quot; + editHash.abbreviate() + &quot;: Change msg&quot;));
 189             assertFalse(archiveContains(archiveFolder.path(), &quot;With several lines&quot;));
 190 
 191             // The mailing list as well
 192             listServer.processIncoming();
 193             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 194             var mailmanList = mailmanServer.getList(listAddress.address());
 195             var conversations = mailmanList.conversations(Duration.ofDays(1));
 196             assertEquals(1, conversations.size());
 197             var mail = conversations.get(0).first();
 198             assertEquals(&quot;RFR: 1234: This is a pull request&quot;, mail.subject());
 199             assertEquals(pr.author().fullName(), mail.author().fullName().orElseThrow());
 200             assertEquals(noreplyAddress(archive), mail.author().address());
 201             assertEquals(listAddress, mail.sender());
 202             assertEquals(&quot;val1&quot;, mail.headerValue(&quot;Extra1&quot;));
 203             assertEquals(&quot;val2&quot;, mail.headerValue(&quot;Extra2&quot;));
</pre>
<hr />
<pre>
 245             assertTrue(archiveContains(archiveFolder.path(), &quot;This is another comment&quot;));
 246             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This should now be ready&quot;));
 247 
 248             listServer.processIncoming();
 249             conversations = mailmanList.conversations(Duration.ofDays(1));
 250             assertEquals(1, conversations.size());
 251             assertEquals(3, conversations.get(0).allMessages().size());
 252             for (var newMail : conversations.get(0).allMessages()) {
 253                 assertEquals(noreplyAddress(archive), newMail.author().address());
 254                 assertEquals(listAddress, newMail.sender());
 255             }
 256             assertTrue(conversations.get(0).allMessages().get(2).body().contains(&quot;This is a comment ðŸ˜„&quot;));
 257         }
 258     }
 259 
 260     @Test
 261     void reviewComment(TestInfo testInfo) throws IOException {
 262         try (var credentials = new HostCredentials(testInfo);
 263              var tempFolder = new TemporaryDirectory();
 264              var archiveFolder = new TemporaryDirectory();
<span class="line-modified"> 265              var listServer = new TestMailmanServer()) {</span>

 266             var author = credentials.getHostedRepository();
 267             var archive = credentials.getHostedRepository();
 268             var ignored = credentials.getHostedRepository();
 269             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 270             var censusBuilder = credentials.getCensusBuilder()
 271                                            .addAuthor(author.forge().currentUser().id());
 272             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 273             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 274                                                  censusBuilder.build(), &quot;master&quot;, listAddress,
 275                                                  Set.of(ignored.forge().currentUser().userName()),
 276                                                  Set.of(),
 277                                                  listServer.getArchive(), listServer.getSMTP(),
 278                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified"> 279                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),</span>
 280                                                  Set.of(), Map.of(),
 281                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 282                                                  Map.of(), Duration.ZERO);
 283 
 284             // Populate the projects repository
 285             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 286             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 287             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 288             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 289             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 290 
 291             // Make a change with a corresponding PR
 292             var editHash = CheckableRepository.appendAndCommit(localRepo);
 293             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 294             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 295             pr.setBody(&quot;This is now ready&quot;);
 296             TestBotRunner.runPeriodicItems(mlBot);
 297             listServer.processIncoming();
 298 
 299             // And make a file specific comment
</pre>
<hr />
<pre>
 335             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a review reply&quot;));
 336             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This is now ready&quot;));
 337             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; PR:&quot;));
 338 
 339             // As well as the mailing list
 340             conversations = mailmanList.conversations(Duration.ofDays(1));
 341             assertEquals(1, conversations.size());
 342             assertEquals(3, conversations.get(0).allMessages().size());
 343             for (var newMail : conversations.get(0).allMessages()) {
 344                 assertEquals(noreplyAddress(archive), newMail.author().address());
 345                 assertEquals(listAddress, newMail.sender());
 346             }
 347         }
 348     }
 349 
 350     @Test
 351     void combineComments(TestInfo testInfo) throws IOException {
 352         try (var credentials = new HostCredentials(testInfo);
 353              var tempFolder = new TemporaryDirectory();
 354              var archiveFolder = new TemporaryDirectory();
<span class="line-modified"> 355              var listServer = new TestMailmanServer()) {</span>

 356             var author = credentials.getHostedRepository();
 357             var archive = credentials.getHostedRepository();
 358             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 359             var censusBuilder = credentials.getCensusBuilder()
 360                                            .addAuthor(author.forge().currentUser().id());
 361             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 362             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 363                                                  censusBuilder.build(), &quot;master&quot;,
 364                                                  listAddress, Set.of(), Set.of(),
 365                                                  listServer.getArchive(),
 366                                                  listServer.getSMTP(),
 367                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified"> 368                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),</span>
 369                                                  Set.of(), Map.of(),
 370                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 371                                                  Map.of(), Duration.ZERO);
 372 
 373             // Populate the projects repository
 374             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 375             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 376             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 377             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 378             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 379 
 380             // Make a change with a corresponding PR
 381             var editHash = CheckableRepository.appendAndCommit(localRepo);
 382             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 383             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 384             pr.setBody(&quot;This is now ready&quot;);
 385             pr.addComment(&quot;Avoid combining&quot;);
 386 
 387             TestBotRunner.runPeriodicItems(mlBot);
 388             listServer.processIncoming();
</pre>
<hr />
<pre>
 422 
 423             // Now reply to the first (collapsed) comment
 424             pr.addReviewCommentReply(first, &quot;I agree&quot;);
 425             TestBotRunner.runPeriodicItems(mlBot);
 426             listServer.processIncoming();
 427 
 428             // The archive should contain a new entry
 429             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 430             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 431 
 432             // The combined review comments should only appear unquoted once
 433             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^Another review comment&quot;));
 434         }
 435     }
 436 
 437     @Test
 438     void commentThreading(TestInfo testInfo) throws IOException {
 439         try (var credentials = new HostCredentials(testInfo);
 440              var tempFolder = new TemporaryDirectory();
 441              var archiveFolder = new TemporaryDirectory();
<span class="line-modified"> 442              var listServer = new TestMailmanServer()) {</span>

 443             var author = credentials.getHostedRepository();
 444             var reviewer = credentials.getHostedRepository();
 445             var archive = credentials.getHostedRepository();
 446             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 447             var censusBuilder = credentials.getCensusBuilder()
 448                                            .addReviewer(reviewer.forge().currentUser().id())
 449                                            .addAuthor(author.forge().currentUser().id());
 450             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 451             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 452                                                  censusBuilder.build(), &quot;master&quot;,
 453                                                  listAddress, Set.of(), Set.of(),
 454                                                  listServer.getArchive(),
 455                                                  listServer.getSMTP(),
 456                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified"> 457                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),</span>
 458                                                  Set.of(), Map.of(),
 459                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 460                                                  Map.of(), Duration.ZERO);
 461 
 462             // Populate the projects repository
 463             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 464             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 465             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 466             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 467             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 468 
 469             // Make a change with a corresponding PR
 470             var editHash = CheckableRepository.appendAndCommit(localRepo);
 471             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 472             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 473             pr.setBody(&quot;This is now ready&quot;);
 474             TestBotRunner.runPeriodicItems(mlBot);
 475             listServer.processIncoming();
 476 
 477             // Make a file specific comment
</pre>
<hr />
<pre>
 546             assertTrue(thread2reply1.body().contains(&quot;Sounds good&quot;));
 547             var thread2reply2 = conversations.get(0).replies(thread2reply1).get(0);
 548             assertTrue(thread2reply2.body().contains(&quot;Thanks&quot;));
 549 
 550             var replies = conversations.get(0).replies(mail);
 551             var thread3 = replies.get(2);
 552             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread3.subject());
 553             var thread4 = replies.get(3);
 554             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread4.subject());
 555             assertTrue(thread4.body().contains(&quot;Looks fine&quot;));
 556             assertTrue(thread4.body().contains(&quot;The final review comment&quot;));
 557             assertTrue(thread4.body().contains(&quot;Marked as reviewed by integrationreviewer1 (Reviewer)&quot;));
 558         }
 559     }
 560 
 561     @Test
 562     void commentThreadingSeparated(TestInfo testInfo) throws IOException {
 563         try (var credentials = new HostCredentials(testInfo);
 564              var tempFolder = new TemporaryDirectory();
 565              var archiveFolder = new TemporaryDirectory();
<span class="line-modified"> 566              var listServer = new TestMailmanServer()) {</span>

 567             var author = credentials.getHostedRepository();
 568             var reviewer = credentials.getHostedRepository();
 569             var archive = credentials.getHostedRepository();
 570             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 571             var censusBuilder = credentials.getCensusBuilder()
 572                                            .addReviewer(reviewer.forge().currentUser().id())
 573                                            .addAuthor(author.forge().currentUser().id());
 574             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 575             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;, censusBuilder.build(), &quot;master&quot;,
 576                                                  listAddress, Set.of(), Set.of(),
 577                                                  listServer.getArchive(),
 578                                                  listServer.getSMTP(),
 579                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified"> 580                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),</span>
 581                                                  Set.of(), Map.of(),
 582                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 583                                                  Map.of(), Duration.ZERO);
 584 
 585             // Populate the projects repository
 586             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 587             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 588             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 589             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 590             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 591 
 592             // Make a change with a corresponding PR
 593             var editHash = CheckableRepository.appendAndCommit(localRepo);
 594             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 595             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 596             pr.setBody(&quot;This is now ready&quot;);
 597             TestBotRunner.runPeriodicItems(mlBot);
 598             listServer.processIncoming();
 599 
 600             // Make two file specific comments
</pre>
<hr />
<pre>
 603             var comment2 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 604             TestBotRunner.runPeriodicItems(mlBot);
 605             listServer.processIncoming();
 606 
 607             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 608             pr.addReviewCommentReply(comment2, &quot;I don&#39;t agree&quot;);
 609             TestBotRunner.runPeriodicItems(mlBot);
 610             listServer.processIncoming();
 611 
 612             // Sanity check the archive
 613             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 614             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 615         }
 616     }
 617 
 618     @Test
 619     void reviewContext(TestInfo testInfo) throws IOException {
 620         try (var credentials = new HostCredentials(testInfo);
 621              var tempFolder = new TemporaryDirectory();
 622              var archiveFolder = new TemporaryDirectory();
<span class="line-modified"> 623              var listServer = new TestMailmanServer()) {</span>

 624             var author = credentials.getHostedRepository();
 625             var archive = credentials.getHostedRepository();
 626             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 627             var censusBuilder = credentials.getCensusBuilder()
 628                                            .addAuthor(author.forge().currentUser().id());
 629             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 630             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 631                                                  censusBuilder.build(), &quot;master&quot;,
 632                                                  listAddress, Set.of(), Set.of(),
 633                                                  listServer.getArchive(),
 634                                                  listServer.getSMTP(),
 635                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified"> 636                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),</span>
 637                                                  Set.of(), Map.of(),
 638                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 639                                                  Map.of(), Duration.ZERO);
 640 
 641             // Populate the projects repository
 642             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 643             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 644             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 645             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 646             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 647 
 648             // Make a change with a corresponding PR
 649             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
 650             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 651             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 652             pr.setBody(&quot;This is now ready&quot;);
 653             TestBotRunner.runPeriodicItems(mlBot);
 654             listServer.processIncoming();
 655 
 656             // Make a file specific comment
 657             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 658 
 659             TestBotRunner.runPeriodicItems(mlBot);
 660             listServer.processIncoming();
 661 
 662             // The archive should only contain context around line 2
 663             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 664             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
 665             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
 666             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
 667         }
 668     }
 669 
 670     @Test
 671     void multipleReviewContexts(TestInfo testInfo) throws IOException {
 672         try (var credentials = new HostCredentials(testInfo);
 673              var tempFolder = new TemporaryDirectory();
 674              var archiveFolder = new TemporaryDirectory();
<span class="line-modified"> 675              var listServer = new TestMailmanServer()) {</span>

 676             var author = credentials.getHostedRepository();
 677             var archive = credentials.getHostedRepository();
 678             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 679             var censusBuilder = credentials.getCensusBuilder()
 680                                            .addAuthor(author.forge().currentUser().id());
 681             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 682             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 683                                                  censusBuilder.build(), &quot;master&quot;,
 684                                                  listAddress, Set.of(), Set.of(),
 685                                                  listServer.getArchive(),
 686                                                  listServer.getSMTP(),
 687                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified"> 688                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),</span>
 689                                                  Set.of(), Map.of(),
 690                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 691                                                  Map.of(), Duration.ZERO);
 692 
 693             // Populate the projects repository
 694             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 695             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 696             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 697             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 698             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 699             var initialHash = CheckableRepository.appendAndCommit(localRepo,
 700                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
 701                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
 702                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
 703                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
 704                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
 705                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
 706             localRepo.push(initialHash, author.url(), &quot;master&quot;);
 707 
 708             // Make a change with a corresponding PR
</pre>
<hr />
<pre>
 726 
 727             // The archive should only contain context around line 2 and 20
 728             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 729             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 7&quot;));
 730             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 6: Line 1$&quot;));
 731             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 7: Line 2 edit$&quot;));
 732             assertFalse(archiveContains(archiveFolder.path(), &quot;Line 3&quot;));
 733 
 734             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 24&quot;));
 735             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 23: Line 12.5$&quot;));
 736             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 24: Line 13 edit$&quot;));
 737             assertFalse(archiveContains(archiveFolder.path(), &quot;^Line 15&quot;));
 738         }
 739     }
 740 
 741     @Test
 742     void filterComments(TestInfo testInfo) throws IOException {
 743         try (var credentials = new HostCredentials(testInfo);
 744              var tempFolder = new TemporaryDirectory();
 745              var archiveFolder = new TemporaryDirectory();
<span class="line-modified"> 746              var listServer = new TestMailmanServer()) {</span>

 747             var author = credentials.getHostedRepository();
 748             var archive = credentials.getHostedRepository();
 749             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 750             var censusBuilder = credentials.getCensusBuilder()
 751                                            .addAuthor(author.forge().currentUser().id());
 752             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 753             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 754                                                  censusBuilder.build(), &quot;master&quot;,
 755                                                  listAddress, Set.of(), Set.of(),
 756                                                  listServer.getArchive(), listServer.getSMTP(),
 757                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified"> 758                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),</span>
 759                                                  Set.of(), Map.of(),
 760                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 761                                                  Map.of(), Duration.ZERO);
 762 
 763             // Populate the projects repository
 764             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 765             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 766             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 767             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 768             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 769 
 770             // Make a change with a corresponding PR
 771             var editHash = CheckableRepository.appendAndCommit(localRepo);
 772             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 773             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 774             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
 775                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
 776 
 777             // Make a bunch of comments
 778             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
</pre>
<hr />
<pre>
 785 
 786             // The archive should not contain the comment
 787             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 788             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 789             assertFalse(archiveContains(archiveFolder.path(), &quot;this is a comment&quot;));
 790             assertFalse(archiveContains(archiveFolder.path(), &quot;Status stuff&quot;));
 791             assertTrue(archiveContains(archiveFolder.path(), &quot;And this is not&quot;));
 792             assertFalse(archiveContains(archiveFolder.path(), &quot;&lt;!--&quot;));
 793             assertFalse(archiveContains(archiveFolder.path(), &quot;--&gt;&quot;));
 794             assertTrue(archiveContains(archiveFolder.path(), &quot;Plain comment&quot;));
 795             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 796             assertFalse(archiveContains(archiveFolder.path(), &quot;/integrate&quot;));
 797         }
 798     }
 799 
 800     @Test
 801     void incrementalChanges(TestInfo testInfo) throws IOException {
 802         try (var credentials = new HostCredentials(testInfo);
 803              var tempFolder = new TemporaryDirectory();
 804              var archiveFolder = new TemporaryDirectory();
<span class="line-modified"> 805              var listServer = new TestMailmanServer()) {</span>

 806             var author = credentials.getHostedRepository();
 807             var archive = credentials.getHostedRepository();
 808             var commenter = credentials.getHostedRepository();
 809             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 810             var censusBuilder = credentials.getCensusBuilder()
 811                                            .addAuthor(author.forge().currentUser().id());
 812             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 813             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 814                                                  censusBuilder.build(), &quot;master&quot;,
 815                                                  listAddress, Set.of(), Set.of(),
 816                                                  listServer.getArchive(), listServer.getSMTP(),
 817                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified"> 818                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),</span>
 819                                                  Set.of(), Map.of(),
 820                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 821                                                  Map.of(), Duration.ZERO);
 822 
 823             // Populate the projects repository
 824             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 825             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 826             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 827             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 828             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 829 
 830             // Make a change with a corresponding PR
 831             var editHash = CheckableRepository.appendAndCommit(localRepo);
 832             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 833             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 834             pr.setBody(&quot;This is now ready&quot;);
 835 
 836             // Run an archive pass
 837             TestBotRunner.runPeriodicItems(mlBot);
 838             listServer.processIncoming();
</pre>
<hr />
<pre>
 908 
 909                 TestBotRunner.runPeriodicItems(mlBot);
 910                 TestBotRunner.runPeriodicItems(mlBot);
 911                 listServer.processIncoming();
 912             }
 913             var updatedConversations = mailmanList.conversations(Duration.ofDays(1));
 914             assertEquals(1, updatedConversations.size());
 915             var conversation = updatedConversations.get(0);
 916             assertEquals(6, conversation.allMessages().size());
 917             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(1).subject());
 918             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(2).subject(), conversation.allMessages().get(2).toString());
 919             assertEquals(&quot;Re: [Rev 04] RFR: This is a pull request&quot;, conversation.allMessages().get(5).subject());
 920         }
 921     }
 922 
 923     @Test
 924     void rebased(TestInfo testInfo) throws IOException {
 925         try (var credentials = new HostCredentials(testInfo);
 926              var tempFolder = new TemporaryDirectory();
 927              var archiveFolder = new TemporaryDirectory();
<span class="line-modified"> 928              var listServer = new TestMailmanServer()) {</span>

 929             var author = credentials.getHostedRepository();
 930             var archive = credentials.getHostedRepository();
 931             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 932             var censusBuilder = credentials.getCensusBuilder()
 933                                            .addAuthor(author.forge().currentUser().id());
 934             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 935             var mlBot = new MailingListBridgeBot(sender, author, archive, &quot;master&quot;,
 936                                                  censusBuilder.build(), &quot;master&quot;,
 937                                                  listAddress, Set.of(), Set.of(),
 938                                                  listServer.getArchive(), listServer.getSMTP(),
 939                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified"> 940                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),</span>
 941                                                  Set.of(), Map.of(),
 942                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 943                                                  Map.of(), Duration.ZERO);
 944 
 945             // Populate the projects repository
 946             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 947             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
 948             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 949             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 950             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 951 
 952             // Make a change with a corresponding PR
 953             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
 954             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 955             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 956             pr.setBody(&quot;This is now ready&quot;);
 957 
 958             // Run an archive pass
 959             TestBotRunner.runPeriodicItems(mlBot);
 960             listServer.processIncoming();
</pre>
<hr />
<pre>
 998 
 999             // Check that sender address is set properly
1000             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1001             var mailmanList = mailmanServer.getList(listAddress.address());
1002             var conversations = mailmanList.conversations(Duration.ofDays(1));
1003             assertEquals(1, conversations.size());
1004             for (var newMail : conversations.get(0).allMessages()) {
1005                 assertEquals(noreplyAddress(archive), newMail.author().address());
1006                 assertEquals(listAddress, newMail.sender());
1007                 assertFalse(newMail.hasHeader(&quot;PR-Head-Hash&quot;));
1008             }
1009             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversations.get(0).allMessages().get(1).subject());
1010         }
1011     }
1012 
1013     @Test
1014     void incrementalAfterRebase(TestInfo testInfo) throws IOException {
1015         try (var credentials = new HostCredentials(testInfo);
1016              var tempFolder = new TemporaryDirectory();
1017              var archiveFolder = new TemporaryDirectory();
<span class="line-modified">1018              var listServer = new TestMailmanServer()) {</span>

1019             var author = credentials.getHostedRepository();
1020             var archive = credentials.getHostedRepository();
1021             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1022             var censusBuilder = credentials.getCensusBuilder()
1023                                            .addAuthor(author.forge().currentUser().id());
1024             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1025             var mlBot = new MailingListBridgeBot(sender, author, archive, &quot;archive&quot;,
1026                                                  censusBuilder.build(), &quot;master&quot;,
1027                                                  listAddress, Set.of(), Set.of(),
1028                                                  listServer.getArchive(), listServer.getSMTP(),
1029                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified">1030                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),</span>
1031                                                  Set.of(), Map.of(),
1032                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
1033                                                  Map.of(), Duration.ZERO);
1034 
1035             // Populate the projects repository
1036             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1037             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1038             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1039             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1040             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1041             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1042 
1043             // Make a change with a corresponding PR
1044             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1045             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1046             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1047             pr.setBody(&quot;This is now ready&quot;);
1048 
1049             // Run an archive pass
1050             TestBotRunner.runPeriodicItems(mlBot);
</pre>
<hr />
<pre>
1081             TestBotRunner.runPeriodicItems(mlBot);
1082             listServer.processIncoming();
1083 
1084             // The archive should reference the rebased push
1085             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1086             assertTrue(archiveContains(archiveFolder.path(), &quot;updated with a new target base&quot;));
1087             assertTrue(archiveContains(archiveFolder.path(), &quot;excludes the unrelated changes&quot;));
1088             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.01&quot;));
1089             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.00-01&quot;));
1090             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1091             assertTrue(archiveContains(archiveFolder.path(), &quot;More updates&quot;));
1092         }
1093     }
1094 
1095     @Test
1096     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
1097         try (var credentials = new HostCredentials(testInfo);
1098              var tempFolder = new TemporaryDirectory();
1099              var archiveFolder = new TemporaryDirectory();
1100              var webrevFolder = new TemporaryDirectory();
<span class="line-modified">1101              var listServer = new TestMailmanServer()) {</span>

1102             var author = credentials.getHostedRepository();
1103             var archive = credentials.getHostedRepository();
1104             var ignored = credentials.getHostedRepository();
1105             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1106             var censusBuilder = credentials.getCensusBuilder()
1107                                            .addAuthor(author.forge().currentUser().id());
1108             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1109             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
1110                                                  censusBuilder.build(), &quot;master&quot;,
1111                                                  listAddress,
1112                                                  Set.of(ignored.forge().currentUser().userName()),
1113                                                  Set.of(),
1114                                                  listServer.getArchive(), listServer.getSMTP(),
1115                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified">1116                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),</span>
1117                                                  Set.of(), Map.of(),
1118                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
1119                                                  Map.of(), Duration.ZERO);
1120 
1121             // Populate the projects repository
1122             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1123             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1124             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1125             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1126 
1127             // Make a change with a corresponding PR
1128             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
1129                                                                &quot;Change msg\n\nWith several lines&quot;);
1130             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1131             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1132 
1133             // Flag it as ready for review
1134             pr.setBody(&quot;This should now be ready&quot;);
1135 
1136             // Run an archive pass
</pre>
<hr />
<pre>
1156             // Run another archive pass
1157             TestBotRunner.runPeriodicItems(mlBot);
1158 
1159             // The webrev comment should not contain duplicate entries
1160             comments = pr.comments();
1161             webrevComments = comments.stream()
1162                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1163                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1164                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
1165                                          .collect(Collectors.toList());
1166             assertEquals(1, webrevComments.size());
1167             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
1168         }
1169     }
1170 
1171     @Test
1172     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
1173         try (var credentials = new HostCredentials(testInfo);
1174              var tempFolder = new TemporaryDirectory();
1175              var archiveFolder = new TemporaryDirectory();
<span class="line-modified">1176              var listServer = new TestMailmanServer()) {</span>

1177             var author = credentials.getHostedRepository();
1178             var archive = credentials.getHostedRepository();
1179             var reviewer = credentials.getHostedRepository();
1180             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1181             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1182             var censusBuilder = credentials.getCensusBuilder()
1183                                            .addReviewer(reviewer.forge().currentUser().id())
1184                                            .addAuthor(author.forge().currentUser().id());
1185             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
1186                                                  censusBuilder.build(), &quot;master&quot;,
1187                                                  listAddress, Set.of(), Set.of(),
1188                                                  listServer.getArchive(), listServer.getSMTP(),
1189                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified">1190                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),</span>
1191                                                  Set.of(), Map.of(),
1192                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
1193                                                  Map.of(), Duration.ZERO);
1194 
1195             // Populate the projects repository
1196             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1197             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1198             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1199             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1200             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1201 
1202             // Make a change with a corresponding PR
1203             var editHash = CheckableRepository.appendAndCommit(localRepo);
1204             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1205             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1206             pr.setBody(&quot;This is now ready&quot;);
1207 
1208             // Run an archive pass
1209             TestBotRunner.runPeriodicItems(mlBot);
1210 
</pre>
<hr />
<pre>
1240             // Yet another change
1241             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 3&quot;);
1242             TestBotRunner.runPeriodicItems(mlBot);
1243             TestBotRunner.runPeriodicItems(mlBot);
1244             TestBotRunner.runPeriodicItems(mlBot);
1245 
1246             // The archive should contain another note
1247             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1248             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
1249             if (author.forge().supportsReviewBody()) {
1250                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
1251             }
1252         }
1253     }
1254 
1255     @Test
1256     void ignoreComments(TestInfo testInfo) throws IOException {
1257         try (var credentials = new HostCredentials(testInfo);
1258              var tempFolder = new TemporaryDirectory();
1259              var archiveFolder = new TemporaryDirectory();
<span class="line-modified">1260              var listServer = new TestMailmanServer()) {</span>

1261             var author = credentials.getHostedRepository();
1262             var ignored = credentials.getHostedRepository();
1263             var archive = credentials.getHostedRepository();
1264             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1265             var censusBuilder = credentials.getCensusBuilder()
1266                                            .addAuthor(author.forge().currentUser().id());
1267             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1268             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
1269                                                  censusBuilder.build(), &quot;master&quot;,
1270                                                  listAddress,
1271                                                  Set.of(ignored.forge().currentUser().userName()),
1272                                                  Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)),
1273                                                  listServer.getArchive(), listServer.getSMTP(),
1274                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified">1275                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),</span>
1276                                                  Set.of(), Map.of(),
1277                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
1278                                                  Map.of(), Duration.ZERO);
1279 
1280             // Populate the projects repository
1281             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1282             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1283             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1284             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1285             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1286 
1287             // Make a change with a corresponding PR
1288             var editHash = CheckableRepository.appendAndCommit(localRepo);
1289             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1290             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1291             pr.setBody(&quot;This is now ready&quot;);
1292 
1293             // Make a bunch of comments
1294             pr.addComment(&quot;Plain comment&quot;);
1295             pr.addComment(&quot;ignore this comment&quot;);
</pre>
</td>
<td>
<hr />
<pre>
  87             return false;
  88         }
  89     }
  90 
  91     private long countSubstrings(String string, String substring) {
  92         return Pattern.compile(substring).matcher(string).results().count();
  93     }
  94 
  95     private String noreplyAddress(HostedRepository repository) {
  96         return &quot;test+&quot; + repository.forge().currentUser().id() + &quot;+&quot; +
  97                 repository.forge().currentUser().userName() +
  98                 &quot;@openjdk.java.net&quot;;
  99     }
 100 
 101     @Test
 102     void simpleArchive(TestInfo testInfo) throws IOException {
 103         try (var credentials = new HostCredentials(testInfo);
 104              var tempFolder = new TemporaryDirectory();
 105              var archiveFolder = new TemporaryDirectory();
 106              var webrevFolder = new TemporaryDirectory();
<span class="line-modified"> 107              var listServer = new TestMailmanServer();</span>
<span class="line-added"> 108              var webrevServer = new TestWebrevServer()) {</span>
 109             var author = credentials.getHostedRepository();
 110             var archive = credentials.getHostedRepository();
 111             var ignored = credentials.getHostedRepository();
 112             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 113             var censusBuilder = credentials.getCensusBuilder()
 114                                            .addAuthor(author.forge().currentUser().id());
 115             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 116             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 117                                                  censusBuilder.build(), &quot;master&quot;, listAddress,
 118                                                  Set.of(ignored.forge().currentUser().userName()),
 119                                                  Set.of(),
 120                                                  listServer.getArchive(), listServer.getSMTP(),
 121                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified"> 122                                                  webrevServer.uri(),</span>
 123                                                  Set.of(&quot;rfr&quot;), Map.of(ignored.forge().currentUser().userName(),
 124                                                                        Pattern.compile(&quot;ready&quot;)),
 125                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 126                                                  Map.of(&quot;Extra1&quot;, &quot;val1&quot;, &quot;Extra2&quot;, &quot;val2&quot;),
 127                                                  Duration.ZERO);
 128 
 129             // Populate the projects repository
 130             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 131             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 132             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 133             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 134 
 135             // Make a change with a corresponding PR
 136             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 137                                                                &quot;Change msg\n\nWith several lines&quot;);
 138             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 139             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 140             pr.setBody(&quot;This should not be ready&quot;);
 141 
 142             // Run an archive pass
</pre>
<hr />
<pre>
 164             // Run another archive pass
 165             TestBotRunner.runPeriodicItems(mlBot);
 166 
 167             // It should still not be archived
 168             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 169             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 170 
 171             // Now post a ready comment
 172             ignoredPr.addComment(&quot;ready&quot;);
 173 
 174             // Run another archive pass
 175             TestBotRunner.runPeriodicItems(mlBot);
 176 
 177             // The archive should now contain an entry
 178             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 179             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 180             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
 181             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
 182             assertTrue(archiveContains(archiveFolder.path(), &quot;Changes:&quot;));
 183             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
<span class="line-modified"> 184             assertTrue(archiveContains(archiveFolder.path(), webrevServer.uri().toString()));</span>
 185             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));
 186             assertTrue(archiveContains(archiveFolder.path(), &quot;Issue:&quot;));
 187             assertTrue(archiveContains(archiveFolder.path(), &quot;http://issues.test/browse/TSTPRJ-1234&quot;));
 188             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch:&quot;));
 189             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - &quot; + editHash.abbreviate() + &quot;: Change msg&quot;));
 190             assertFalse(archiveContains(archiveFolder.path(), &quot;With several lines&quot;));
 191 
 192             // The mailing list as well
 193             listServer.processIncoming();
 194             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 195             var mailmanList = mailmanServer.getList(listAddress.address());
 196             var conversations = mailmanList.conversations(Duration.ofDays(1));
 197             assertEquals(1, conversations.size());
 198             var mail = conversations.get(0).first();
 199             assertEquals(&quot;RFR: 1234: This is a pull request&quot;, mail.subject());
 200             assertEquals(pr.author().fullName(), mail.author().fullName().orElseThrow());
 201             assertEquals(noreplyAddress(archive), mail.author().address());
 202             assertEquals(listAddress, mail.sender());
 203             assertEquals(&quot;val1&quot;, mail.headerValue(&quot;Extra1&quot;));
 204             assertEquals(&quot;val2&quot;, mail.headerValue(&quot;Extra2&quot;));
</pre>
<hr />
<pre>
 246             assertTrue(archiveContains(archiveFolder.path(), &quot;This is another comment&quot;));
 247             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This should now be ready&quot;));
 248 
 249             listServer.processIncoming();
 250             conversations = mailmanList.conversations(Duration.ofDays(1));
 251             assertEquals(1, conversations.size());
 252             assertEquals(3, conversations.get(0).allMessages().size());
 253             for (var newMail : conversations.get(0).allMessages()) {
 254                 assertEquals(noreplyAddress(archive), newMail.author().address());
 255                 assertEquals(listAddress, newMail.sender());
 256             }
 257             assertTrue(conversations.get(0).allMessages().get(2).body().contains(&quot;This is a comment ðŸ˜„&quot;));
 258         }
 259     }
 260 
 261     @Test
 262     void reviewComment(TestInfo testInfo) throws IOException {
 263         try (var credentials = new HostCredentials(testInfo);
 264              var tempFolder = new TemporaryDirectory();
 265              var archiveFolder = new TemporaryDirectory();
<span class="line-modified"> 266              var listServer = new TestMailmanServer();</span>
<span class="line-added"> 267              var webrevServer = new TestWebrevServer()) {</span>
 268             var author = credentials.getHostedRepository();
 269             var archive = credentials.getHostedRepository();
 270             var ignored = credentials.getHostedRepository();
 271             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 272             var censusBuilder = credentials.getCensusBuilder()
 273                                            .addAuthor(author.forge().currentUser().id());
 274             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 275             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 276                                                  censusBuilder.build(), &quot;master&quot;, listAddress,
 277                                                  Set.of(ignored.forge().currentUser().userName()),
 278                                                  Set.of(),
 279                                                  listServer.getArchive(), listServer.getSMTP(),
 280                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified"> 281                                                  webrevServer.uri(),</span>
 282                                                  Set.of(), Map.of(),
 283                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 284                                                  Map.of(), Duration.ZERO);
 285 
 286             // Populate the projects repository
 287             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 288             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 289             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 290             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 291             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 292 
 293             // Make a change with a corresponding PR
 294             var editHash = CheckableRepository.appendAndCommit(localRepo);
 295             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 296             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 297             pr.setBody(&quot;This is now ready&quot;);
 298             TestBotRunner.runPeriodicItems(mlBot);
 299             listServer.processIncoming();
 300 
 301             // And make a file specific comment
</pre>
<hr />
<pre>
 337             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a review reply&quot;));
 338             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This is now ready&quot;));
 339             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; PR:&quot;));
 340 
 341             // As well as the mailing list
 342             conversations = mailmanList.conversations(Duration.ofDays(1));
 343             assertEquals(1, conversations.size());
 344             assertEquals(3, conversations.get(0).allMessages().size());
 345             for (var newMail : conversations.get(0).allMessages()) {
 346                 assertEquals(noreplyAddress(archive), newMail.author().address());
 347                 assertEquals(listAddress, newMail.sender());
 348             }
 349         }
 350     }
 351 
 352     @Test
 353     void combineComments(TestInfo testInfo) throws IOException {
 354         try (var credentials = new HostCredentials(testInfo);
 355              var tempFolder = new TemporaryDirectory();
 356              var archiveFolder = new TemporaryDirectory();
<span class="line-modified"> 357              var listServer = new TestMailmanServer();</span>
<span class="line-added"> 358              var webrevServer = new TestWebrevServer()) {</span>
 359             var author = credentials.getHostedRepository();
 360             var archive = credentials.getHostedRepository();
 361             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 362             var censusBuilder = credentials.getCensusBuilder()
 363                                            .addAuthor(author.forge().currentUser().id());
 364             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 365             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 366                                                  censusBuilder.build(), &quot;master&quot;,
 367                                                  listAddress, Set.of(), Set.of(),
 368                                                  listServer.getArchive(),
 369                                                  listServer.getSMTP(),
 370                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified"> 371                                                  webrevServer.uri(),</span>
 372                                                  Set.of(), Map.of(),
 373                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 374                                                  Map.of(), Duration.ZERO);
 375 
 376             // Populate the projects repository
 377             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 378             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 379             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 380             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 381             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 382 
 383             // Make a change with a corresponding PR
 384             var editHash = CheckableRepository.appendAndCommit(localRepo);
 385             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 386             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 387             pr.setBody(&quot;This is now ready&quot;);
 388             pr.addComment(&quot;Avoid combining&quot;);
 389 
 390             TestBotRunner.runPeriodicItems(mlBot);
 391             listServer.processIncoming();
</pre>
<hr />
<pre>
 425 
 426             // Now reply to the first (collapsed) comment
 427             pr.addReviewCommentReply(first, &quot;I agree&quot;);
 428             TestBotRunner.runPeriodicItems(mlBot);
 429             listServer.processIncoming();
 430 
 431             // The archive should contain a new entry
 432             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 433             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 434 
 435             // The combined review comments should only appear unquoted once
 436             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^Another review comment&quot;));
 437         }
 438     }
 439 
 440     @Test
 441     void commentThreading(TestInfo testInfo) throws IOException {
 442         try (var credentials = new HostCredentials(testInfo);
 443              var tempFolder = new TemporaryDirectory();
 444              var archiveFolder = new TemporaryDirectory();
<span class="line-modified"> 445              var listServer = new TestMailmanServer();</span>
<span class="line-added"> 446              var webrevServer = new TestWebrevServer()) {</span>
 447             var author = credentials.getHostedRepository();
 448             var reviewer = credentials.getHostedRepository();
 449             var archive = credentials.getHostedRepository();
 450             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 451             var censusBuilder = credentials.getCensusBuilder()
 452                                            .addReviewer(reviewer.forge().currentUser().id())
 453                                            .addAuthor(author.forge().currentUser().id());
 454             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 455             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 456                                                  censusBuilder.build(), &quot;master&quot;,
 457                                                  listAddress, Set.of(), Set.of(),
 458                                                  listServer.getArchive(),
 459                                                  listServer.getSMTP(),
 460                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified"> 461                                                  webrevServer.uri(),</span>
 462                                                  Set.of(), Map.of(),
 463                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 464                                                  Map.of(), Duration.ZERO);
 465 
 466             // Populate the projects repository
 467             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 468             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 469             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 470             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 471             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 472 
 473             // Make a change with a corresponding PR
 474             var editHash = CheckableRepository.appendAndCommit(localRepo);
 475             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 476             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 477             pr.setBody(&quot;This is now ready&quot;);
 478             TestBotRunner.runPeriodicItems(mlBot);
 479             listServer.processIncoming();
 480 
 481             // Make a file specific comment
</pre>
<hr />
<pre>
 550             assertTrue(thread2reply1.body().contains(&quot;Sounds good&quot;));
 551             var thread2reply2 = conversations.get(0).replies(thread2reply1).get(0);
 552             assertTrue(thread2reply2.body().contains(&quot;Thanks&quot;));
 553 
 554             var replies = conversations.get(0).replies(mail);
 555             var thread3 = replies.get(2);
 556             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread3.subject());
 557             var thread4 = replies.get(3);
 558             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread4.subject());
 559             assertTrue(thread4.body().contains(&quot;Looks fine&quot;));
 560             assertTrue(thread4.body().contains(&quot;The final review comment&quot;));
 561             assertTrue(thread4.body().contains(&quot;Marked as reviewed by integrationreviewer1 (Reviewer)&quot;));
 562         }
 563     }
 564 
 565     @Test
 566     void commentThreadingSeparated(TestInfo testInfo) throws IOException {
 567         try (var credentials = new HostCredentials(testInfo);
 568              var tempFolder = new TemporaryDirectory();
 569              var archiveFolder = new TemporaryDirectory();
<span class="line-modified"> 570              var listServer = new TestMailmanServer();</span>
<span class="line-added"> 571              var webrevServer = new TestWebrevServer()) {</span>
 572             var author = credentials.getHostedRepository();
 573             var reviewer = credentials.getHostedRepository();
 574             var archive = credentials.getHostedRepository();
 575             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 576             var censusBuilder = credentials.getCensusBuilder()
 577                                            .addReviewer(reviewer.forge().currentUser().id())
 578                                            .addAuthor(author.forge().currentUser().id());
 579             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 580             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;, censusBuilder.build(), &quot;master&quot;,
 581                                                  listAddress, Set.of(), Set.of(),
 582                                                  listServer.getArchive(),
 583                                                  listServer.getSMTP(),
 584                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified"> 585                                                  webrevServer.uri(),</span>
 586                                                  Set.of(), Map.of(),
 587                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 588                                                  Map.of(), Duration.ZERO);
 589 
 590             // Populate the projects repository
 591             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 592             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 593             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 594             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 595             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 596 
 597             // Make a change with a corresponding PR
 598             var editHash = CheckableRepository.appendAndCommit(localRepo);
 599             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 600             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 601             pr.setBody(&quot;This is now ready&quot;);
 602             TestBotRunner.runPeriodicItems(mlBot);
 603             listServer.processIncoming();
 604 
 605             // Make two file specific comments
</pre>
<hr />
<pre>
 608             var comment2 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 609             TestBotRunner.runPeriodicItems(mlBot);
 610             listServer.processIncoming();
 611 
 612             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 613             pr.addReviewCommentReply(comment2, &quot;I don&#39;t agree&quot;);
 614             TestBotRunner.runPeriodicItems(mlBot);
 615             listServer.processIncoming();
 616 
 617             // Sanity check the archive
 618             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 619             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 620         }
 621     }
 622 
 623     @Test
 624     void reviewContext(TestInfo testInfo) throws IOException {
 625         try (var credentials = new HostCredentials(testInfo);
 626              var tempFolder = new TemporaryDirectory();
 627              var archiveFolder = new TemporaryDirectory();
<span class="line-modified"> 628              var listServer = new TestMailmanServer();</span>
<span class="line-added"> 629              var webrevServer = new TestWebrevServer()) {</span>
 630             var author = credentials.getHostedRepository();
 631             var archive = credentials.getHostedRepository();
 632             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 633             var censusBuilder = credentials.getCensusBuilder()
 634                                            .addAuthor(author.forge().currentUser().id());
 635             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 636             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 637                                                  censusBuilder.build(), &quot;master&quot;,
 638                                                  listAddress, Set.of(), Set.of(),
 639                                                  listServer.getArchive(),
 640                                                  listServer.getSMTP(),
 641                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified"> 642                                                  webrevServer.uri(),</span>
 643                                                  Set.of(), Map.of(),
 644                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 645                                                  Map.of(), Duration.ZERO);
 646 
 647             // Populate the projects repository
 648             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 649             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 650             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 651             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 652             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 653 
 654             // Make a change with a corresponding PR
 655             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
 656             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 657             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 658             pr.setBody(&quot;This is now ready&quot;);
 659             TestBotRunner.runPeriodicItems(mlBot);
 660             listServer.processIncoming();
 661 
 662             // Make a file specific comment
 663             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 664 
 665             TestBotRunner.runPeriodicItems(mlBot);
 666             listServer.processIncoming();
 667 
 668             // The archive should only contain context around line 2
 669             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 670             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
 671             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
 672             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
 673         }
 674     }
 675 
 676     @Test
 677     void multipleReviewContexts(TestInfo testInfo) throws IOException {
 678         try (var credentials = new HostCredentials(testInfo);
 679              var tempFolder = new TemporaryDirectory();
 680              var archiveFolder = new TemporaryDirectory();
<span class="line-modified"> 681              var listServer = new TestMailmanServer();</span>
<span class="line-added"> 682              var webrevServer = new TestWebrevServer()) {</span>
 683             var author = credentials.getHostedRepository();
 684             var archive = credentials.getHostedRepository();
 685             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 686             var censusBuilder = credentials.getCensusBuilder()
 687                                            .addAuthor(author.forge().currentUser().id());
 688             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 689             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 690                                                  censusBuilder.build(), &quot;master&quot;,
 691                                                  listAddress, Set.of(), Set.of(),
 692                                                  listServer.getArchive(),
 693                                                  listServer.getSMTP(),
 694                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified"> 695                                                  webrevServer.uri(),</span>
 696                                                  Set.of(), Map.of(),
 697                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 698                                                  Map.of(), Duration.ZERO);
 699 
 700             // Populate the projects repository
 701             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 702             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 703             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 704             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 705             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 706             var initialHash = CheckableRepository.appendAndCommit(localRepo,
 707                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
 708                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
 709                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
 710                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
 711                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
 712                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
 713             localRepo.push(initialHash, author.url(), &quot;master&quot;);
 714 
 715             // Make a change with a corresponding PR
</pre>
<hr />
<pre>
 733 
 734             // The archive should only contain context around line 2 and 20
 735             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 736             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 7&quot;));
 737             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 6: Line 1$&quot;));
 738             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 7: Line 2 edit$&quot;));
 739             assertFalse(archiveContains(archiveFolder.path(), &quot;Line 3&quot;));
 740 
 741             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 24&quot;));
 742             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 23: Line 12.5$&quot;));
 743             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 24: Line 13 edit$&quot;));
 744             assertFalse(archiveContains(archiveFolder.path(), &quot;^Line 15&quot;));
 745         }
 746     }
 747 
 748     @Test
 749     void filterComments(TestInfo testInfo) throws IOException {
 750         try (var credentials = new HostCredentials(testInfo);
 751              var tempFolder = new TemporaryDirectory();
 752              var archiveFolder = new TemporaryDirectory();
<span class="line-modified"> 753              var listServer = new TestMailmanServer();</span>
<span class="line-added"> 754              var webrevServer = new TestWebrevServer()) {</span>
 755             var author = credentials.getHostedRepository();
 756             var archive = credentials.getHostedRepository();
 757             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 758             var censusBuilder = credentials.getCensusBuilder()
 759                                            .addAuthor(author.forge().currentUser().id());
 760             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 761             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 762                                                  censusBuilder.build(), &quot;master&quot;,
 763                                                  listAddress, Set.of(), Set.of(),
 764                                                  listServer.getArchive(), listServer.getSMTP(),
 765                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified"> 766                                                  webrevServer.uri(),</span>
 767                                                  Set.of(), Map.of(),
 768                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 769                                                  Map.of(), Duration.ZERO);
 770 
 771             // Populate the projects repository
 772             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 773             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 774             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 775             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 776             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 777 
 778             // Make a change with a corresponding PR
 779             var editHash = CheckableRepository.appendAndCommit(localRepo);
 780             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 781             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 782             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
 783                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
 784 
 785             // Make a bunch of comments
 786             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
</pre>
<hr />
<pre>
 793 
 794             // The archive should not contain the comment
 795             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 796             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 797             assertFalse(archiveContains(archiveFolder.path(), &quot;this is a comment&quot;));
 798             assertFalse(archiveContains(archiveFolder.path(), &quot;Status stuff&quot;));
 799             assertTrue(archiveContains(archiveFolder.path(), &quot;And this is not&quot;));
 800             assertFalse(archiveContains(archiveFolder.path(), &quot;&lt;!--&quot;));
 801             assertFalse(archiveContains(archiveFolder.path(), &quot;--&gt;&quot;));
 802             assertTrue(archiveContains(archiveFolder.path(), &quot;Plain comment&quot;));
 803             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 804             assertFalse(archiveContains(archiveFolder.path(), &quot;/integrate&quot;));
 805         }
 806     }
 807 
 808     @Test
 809     void incrementalChanges(TestInfo testInfo) throws IOException {
 810         try (var credentials = new HostCredentials(testInfo);
 811              var tempFolder = new TemporaryDirectory();
 812              var archiveFolder = new TemporaryDirectory();
<span class="line-modified"> 813              var listServer = new TestMailmanServer();</span>
<span class="line-added"> 814              var webrevServer = new TestWebrevServer()) {</span>
 815             var author = credentials.getHostedRepository();
 816             var archive = credentials.getHostedRepository();
 817             var commenter = credentials.getHostedRepository();
 818             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 819             var censusBuilder = credentials.getCensusBuilder()
 820                                            .addAuthor(author.forge().currentUser().id());
 821             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 822             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 823                                                  censusBuilder.build(), &quot;master&quot;,
 824                                                  listAddress, Set.of(), Set.of(),
 825                                                  listServer.getArchive(), listServer.getSMTP(),
 826                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified"> 827                                                  webrevServer.uri(),</span>
 828                                                  Set.of(), Map.of(),
 829                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 830                                                  Map.of(), Duration.ZERO);
 831 
 832             // Populate the projects repository
 833             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 834             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 835             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 836             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 837             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 838 
 839             // Make a change with a corresponding PR
 840             var editHash = CheckableRepository.appendAndCommit(localRepo);
 841             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 842             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 843             pr.setBody(&quot;This is now ready&quot;);
 844 
 845             // Run an archive pass
 846             TestBotRunner.runPeriodicItems(mlBot);
 847             listServer.processIncoming();
</pre>
<hr />
<pre>
 917 
 918                 TestBotRunner.runPeriodicItems(mlBot);
 919                 TestBotRunner.runPeriodicItems(mlBot);
 920                 listServer.processIncoming();
 921             }
 922             var updatedConversations = mailmanList.conversations(Duration.ofDays(1));
 923             assertEquals(1, updatedConversations.size());
 924             var conversation = updatedConversations.get(0);
 925             assertEquals(6, conversation.allMessages().size());
 926             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(1).subject());
 927             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(2).subject(), conversation.allMessages().get(2).toString());
 928             assertEquals(&quot;Re: [Rev 04] RFR: This is a pull request&quot;, conversation.allMessages().get(5).subject());
 929         }
 930     }
 931 
 932     @Test
 933     void rebased(TestInfo testInfo) throws IOException {
 934         try (var credentials = new HostCredentials(testInfo);
 935              var tempFolder = new TemporaryDirectory();
 936              var archiveFolder = new TemporaryDirectory();
<span class="line-modified"> 937              var listServer = new TestMailmanServer();</span>
<span class="line-added"> 938              var webrevServer = new TestWebrevServer()) {</span>
 939             var author = credentials.getHostedRepository();
 940             var archive = credentials.getHostedRepository();
 941             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 942             var censusBuilder = credentials.getCensusBuilder()
 943                                            .addAuthor(author.forge().currentUser().id());
 944             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 945             var mlBot = new MailingListBridgeBot(sender, author, archive, &quot;master&quot;,
 946                                                  censusBuilder.build(), &quot;master&quot;,
 947                                                  listAddress, Set.of(), Set.of(),
 948                                                  listServer.getArchive(), listServer.getSMTP(),
 949                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified"> 950                                                  webrevServer.uri(),</span>
 951                                                  Set.of(), Map.of(),
 952                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 953                                                  Map.of(), Duration.ZERO);
 954 
 955             // Populate the projects repository
 956             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 957             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
 958             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 959             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 960             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 961 
 962             // Make a change with a corresponding PR
 963             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
 964             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 965             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 966             pr.setBody(&quot;This is now ready&quot;);
 967 
 968             // Run an archive pass
 969             TestBotRunner.runPeriodicItems(mlBot);
 970             listServer.processIncoming();
</pre>
<hr />
<pre>
1008 
1009             // Check that sender address is set properly
1010             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1011             var mailmanList = mailmanServer.getList(listAddress.address());
1012             var conversations = mailmanList.conversations(Duration.ofDays(1));
1013             assertEquals(1, conversations.size());
1014             for (var newMail : conversations.get(0).allMessages()) {
1015                 assertEquals(noreplyAddress(archive), newMail.author().address());
1016                 assertEquals(listAddress, newMail.sender());
1017                 assertFalse(newMail.hasHeader(&quot;PR-Head-Hash&quot;));
1018             }
1019             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversations.get(0).allMessages().get(1).subject());
1020         }
1021     }
1022 
1023     @Test
1024     void incrementalAfterRebase(TestInfo testInfo) throws IOException {
1025         try (var credentials = new HostCredentials(testInfo);
1026              var tempFolder = new TemporaryDirectory();
1027              var archiveFolder = new TemporaryDirectory();
<span class="line-modified">1028              var listServer = new TestMailmanServer();</span>
<span class="line-added">1029              var webrevServer = new TestWebrevServer()) {</span>
1030             var author = credentials.getHostedRepository();
1031             var archive = credentials.getHostedRepository();
1032             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1033             var censusBuilder = credentials.getCensusBuilder()
1034                                            .addAuthor(author.forge().currentUser().id());
1035             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1036             var mlBot = new MailingListBridgeBot(sender, author, archive, &quot;archive&quot;,
1037                                                  censusBuilder.build(), &quot;master&quot;,
1038                                                  listAddress, Set.of(), Set.of(),
1039                                                  listServer.getArchive(), listServer.getSMTP(),
1040                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified">1041                                                  webrevServer.uri(),</span>
1042                                                  Set.of(), Map.of(),
1043                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
1044                                                  Map.of(), Duration.ZERO);
1045 
1046             // Populate the projects repository
1047             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1048             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1049             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1050             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1051             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1052             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1053 
1054             // Make a change with a corresponding PR
1055             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1056             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1057             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1058             pr.setBody(&quot;This is now ready&quot;);
1059 
1060             // Run an archive pass
1061             TestBotRunner.runPeriodicItems(mlBot);
</pre>
<hr />
<pre>
1092             TestBotRunner.runPeriodicItems(mlBot);
1093             listServer.processIncoming();
1094 
1095             // The archive should reference the rebased push
1096             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1097             assertTrue(archiveContains(archiveFolder.path(), &quot;updated with a new target base&quot;));
1098             assertTrue(archiveContains(archiveFolder.path(), &quot;excludes the unrelated changes&quot;));
1099             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.01&quot;));
1100             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.00-01&quot;));
1101             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1102             assertTrue(archiveContains(archiveFolder.path(), &quot;More updates&quot;));
1103         }
1104     }
1105 
1106     @Test
1107     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
1108         try (var credentials = new HostCredentials(testInfo);
1109              var tempFolder = new TemporaryDirectory();
1110              var archiveFolder = new TemporaryDirectory();
1111              var webrevFolder = new TemporaryDirectory();
<span class="line-modified">1112              var listServer = new TestMailmanServer();</span>
<span class="line-added">1113              var webrevServer = new TestWebrevServer()) {</span>
1114             var author = credentials.getHostedRepository();
1115             var archive = credentials.getHostedRepository();
1116             var ignored = credentials.getHostedRepository();
1117             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1118             var censusBuilder = credentials.getCensusBuilder()
1119                                            .addAuthor(author.forge().currentUser().id());
1120             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1121             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
1122                                                  censusBuilder.build(), &quot;master&quot;,
1123                                                  listAddress,
1124                                                  Set.of(ignored.forge().currentUser().userName()),
1125                                                  Set.of(),
1126                                                  listServer.getArchive(), listServer.getSMTP(),
1127                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified">1128                                                  webrevServer.uri(),</span>
1129                                                  Set.of(), Map.of(),
1130                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
1131                                                  Map.of(), Duration.ZERO);
1132 
1133             // Populate the projects repository
1134             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1135             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1136             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1137             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1138 
1139             // Make a change with a corresponding PR
1140             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
1141                                                                &quot;Change msg\n\nWith several lines&quot;);
1142             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1143             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1144 
1145             // Flag it as ready for review
1146             pr.setBody(&quot;This should now be ready&quot;);
1147 
1148             // Run an archive pass
</pre>
<hr />
<pre>
1168             // Run another archive pass
1169             TestBotRunner.runPeriodicItems(mlBot);
1170 
1171             // The webrev comment should not contain duplicate entries
1172             comments = pr.comments();
1173             webrevComments = comments.stream()
1174                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1175                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1176                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
1177                                          .collect(Collectors.toList());
1178             assertEquals(1, webrevComments.size());
1179             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
1180         }
1181     }
1182 
1183     @Test
1184     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
1185         try (var credentials = new HostCredentials(testInfo);
1186              var tempFolder = new TemporaryDirectory();
1187              var archiveFolder = new TemporaryDirectory();
<span class="line-modified">1188              var listServer = new TestMailmanServer();</span>
<span class="line-added">1189              var webrevServer = new TestWebrevServer()) {</span>
1190             var author = credentials.getHostedRepository();
1191             var archive = credentials.getHostedRepository();
1192             var reviewer = credentials.getHostedRepository();
1193             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1194             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1195             var censusBuilder = credentials.getCensusBuilder()
1196                                            .addReviewer(reviewer.forge().currentUser().id())
1197                                            .addAuthor(author.forge().currentUser().id());
1198             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
1199                                                  censusBuilder.build(), &quot;master&quot;,
1200                                                  listAddress, Set.of(), Set.of(),
1201                                                  listServer.getArchive(), listServer.getSMTP(),
1202                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified">1203                                                  webrevServer.uri(),</span>
1204                                                  Set.of(), Map.of(),
1205                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
1206                                                  Map.of(), Duration.ZERO);
1207 
1208             // Populate the projects repository
1209             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1210             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1211             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1212             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1213             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1214 
1215             // Make a change with a corresponding PR
1216             var editHash = CheckableRepository.appendAndCommit(localRepo);
1217             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1218             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1219             pr.setBody(&quot;This is now ready&quot;);
1220 
1221             // Run an archive pass
1222             TestBotRunner.runPeriodicItems(mlBot);
1223 
</pre>
<hr />
<pre>
1253             // Yet another change
1254             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 3&quot;);
1255             TestBotRunner.runPeriodicItems(mlBot);
1256             TestBotRunner.runPeriodicItems(mlBot);
1257             TestBotRunner.runPeriodicItems(mlBot);
1258 
1259             // The archive should contain another note
1260             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1261             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
1262             if (author.forge().supportsReviewBody()) {
1263                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
1264             }
1265         }
1266     }
1267 
1268     @Test
1269     void ignoreComments(TestInfo testInfo) throws IOException {
1270         try (var credentials = new HostCredentials(testInfo);
1271              var tempFolder = new TemporaryDirectory();
1272              var archiveFolder = new TemporaryDirectory();
<span class="line-modified">1273              var listServer = new TestMailmanServer();</span>
<span class="line-added">1274              var webrevServer = new TestWebrevServer()) {</span>
1275             var author = credentials.getHostedRepository();
1276             var ignored = credentials.getHostedRepository();
1277             var archive = credentials.getHostedRepository();
1278             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1279             var censusBuilder = credentials.getCensusBuilder()
1280                                            .addAuthor(author.forge().currentUser().id());
1281             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1282             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
1283                                                  censusBuilder.build(), &quot;master&quot;,
1284                                                  listAddress,
1285                                                  Set.of(ignored.forge().currentUser().userName()),
1286                                                  Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)),
1287                                                  listServer.getArchive(), listServer.getSMTP(),
1288                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified">1289                                                  webrevServer.uri(),</span>
1290                                                  Set.of(), Map.of(),
1291                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
1292                                                  Map.of(), Duration.ZERO);
1293 
1294             // Populate the projects repository
1295             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1296             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1297             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1298             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1299             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1300 
1301             // Make a change with a corresponding PR
1302             var editHash = CheckableRepository.appendAndCommit(localRepo);
1303             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1304             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1305             pr.setBody(&quot;This is now ready&quot;);
1306 
1307             // Make a bunch of comments
1308             pr.addComment(&quot;Plain comment&quot;);
1309             pr.addComment(&quot;ignore this comment&quot;);
</pre>
</td>
</tr>
</table>
<center><a href="MailingListArchiveReaderBotTests.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="WebrevStorageTests.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>