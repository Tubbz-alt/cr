<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff vcs/src/main/resources/ext.py</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>vcs/src/main/resources/ext.py</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  5 # under the terms of the GNU General Public License version 2 only, as
  6 # published by the Free Software Foundation.
  7 #
  8 # This code is distributed in the hope that it will be useful, but WITHOUT
  9 # ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 10 # FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 11 # version 2 for more details (a copy is included in the LICENSE file that
 12 # accompanied this code).
 13 #
 14 # You should have received a copy of the GNU General Public License version
 15 # 2 along with this work; if not, write to the Free Software Foundation,
 16 # Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 17 #
 18 # Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 19 # or visit www.oracle.com if you need additional information or have any
 20 # questions.
 21 
 22 import mercurial
 23 import mercurial.patch
 24 import mercurial.mdiff

 25 import difflib
 26 import sys
 27 



 28 def mode(fctx):
 29     flags = fctx.flags()
 30     if flags == &#39;&#39;: return &#39;100644&#39;
 31     if flags == &#39;x&#39;: return &#39;100755&#39;
 32     if flags == &#39;l&#39;: return &#39;120000&#39;
 33 
 34 def ratio(a, b, threshold):
 35     s = difflib.SequenceMatcher(None, a, b)
 36     if s.real_quick_ratio() &lt; threshold:
 37         return 0
 38     if s.quick_ratio() &lt; threshold:
 39         return 0
 40     ratio = s.ratio()
 41     if ratio &lt; threshold:
 42         return 0
 43     return ratio
 44 
 45 def encode(s):
 46     return s.decode(&#39;utf-8&#39;).encode(&#39;utf-8&#39;)
 47 
</pre>
<hr />
<pre>
 35     s = difflib.SequenceMatcher(None, a, b)
 36     if s.real_quick_ratio() &lt; threshold:
 37         return 0
 38     if s.quick_ratio() &lt; threshold:
 39         return 0
 40     ratio = s.ratio()
 41     if ratio &lt; threshold:
 42         return 0
 43     return ratio
 44 
 45 def encode(s):
 46     return s.decode(&#39;utf-8&#39;).encode(&#39;utf-8&#39;)
 47 
 48 def write(s):
 49     sys.stdout.write(encode(s))
 50 
 51 def writeln(s):
 52     write(s)
 53     sys.stdout.write(encode(&#39;\n&#39;))
 54 









 55 def _diff_git_raw(repo, ctx1, ctx2, modified, added, removed):
 56     nullHash = &#39;0&#39; * 40
 57     removed_copy = set(removed)
 58 
 59     for path in added:
 60         fctx = ctx2.filectx(path)
 61         if fctx.renamed():
 62             parent = fctx.p1()
 63             old_path, _ = fctx.renamed()
 64             if old_path in removed:
 65                 removed_copy.discard(old_path)
 66 
 67     for path in sorted(modified | added | removed_copy):
 68         if path in modified:
 69             fctx = ctx2.filectx(path)
 70             writeln(&#39;:{} {} {} {} M\t{}&#39;.format(mode(ctx1.filectx(path)), mode(fctx), nullHash, nullHash, fctx.path()))
 71         elif path in added:
 72             fctx = ctx2.filectx(path)
 73             if not fctx.renamed():
 74                 writeln(&#39;:000000 {} {} {} A\t{}&#39;.format(mode(fctx), nullHash, nullHash, fctx.path()))
</pre>
<hr />
<pre>
 72             fctx = ctx2.filectx(path)
 73             if not fctx.renamed():
 74                 writeln(&#39;:000000 {} {} {} A\t{}&#39;.format(mode(fctx), nullHash, nullHash, fctx.path()))
 75             else:
 76                 parent = fctx.p1()
 77                 score = int(ratio(parent.data(), fctx.data(), 0.5) * 100)
 78                 old_path, _ = fctx.renamed()
 79 
 80                 if old_path in removed:
 81                     operation = &#39;R&#39;
 82                 else:
 83                     operation = &#39;C&#39;
 84 
 85                 writeln(&#39;:{} {} {} {} {}{}\t{}\t{}&#39;.format(mode(parent), mode(fctx), nullHash, nullHash, operation, score, old_path, path))
 86         elif path in removed_copy:
 87             fctx = ctx1.filectx(path)
 88             writeln(&#39;:{} 000000 {} {} D\t{}&#39;.format(mode(fctx), nullHash, nullHash, path))
 89 
 90     writeln(&#39;&#39;)
 91 
<span class="line-modified"> 92     match = mercurial.match.exact(repo.root, repo.getcwd(), list(modified) + list(added) + list(removed_copy))</span>
 93     opts = mercurial.mdiff.diffopts(git=True, nodates=True, context=0, showfunc=True)
 94     for d in mercurial.patch.diff(repo, ctx1.node(), ctx2.node(), match=match, opts=opts):
 95         sys.stdout.write(d)
 96 
 97 def really_differs(repo, p1, p2, ctx, files):
 98     # workaround bug in hg (present since forever):
 99     # `hg status` can, for merge commits, report a file as modififed between one parent
100     # and the merge even though it isn&#39;t. `hg diff` works correctly, so remove any &quot;modified&quot;
101     # that has an empty diff against one of its parents
102     differs = set()
103     for path in files:
104         match = mercurial.match.exact(repo.root, repo.getcwd(), [path])
105         opts = mercurial.mdiff.diffopts(git=True, nodates=True, context=0, showfunc=True)
106 
107         diff1 = mercurial.patch.diff(repo, p1.node(), ctx.node(), match=match, opts=opts)
108         diff2 = mercurial.patch.diff(repo, p2.node(), ctx.node(), match=match, opts=opts)
109         if len(list(diff1)) &gt; 0 and len(list(diff2)) &gt; 0:
110             differs.add(path)
111 
112     return differs
</pre>
</td>
<td>
<hr />
<pre>
  5 # under the terms of the GNU General Public License version 2 only, as
  6 # published by the Free Software Foundation.
  7 #
  8 # This code is distributed in the hope that it will be useful, but WITHOUT
  9 # ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 10 # FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 11 # version 2 for more details (a copy is included in the LICENSE file that
 12 # accompanied this code).
 13 #
 14 # You should have received a copy of the GNU General Public License version
 15 # 2 along with this work; if not, write to the Free Software Foundation,
 16 # Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 17 #
 18 # Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 19 # or visit www.oracle.com if you need additional information or have any
 20 # questions.
 21 
 22 import mercurial
 23 import mercurial.patch
 24 import mercurial.mdiff
<span class="line-added"> 25 import mercurial.util</span>
 26 import difflib
 27 import sys
 28 
<span class="line-added"> 29 # space separated version list</span>
<span class="line-added"> 30 testedwith = &#39;4.9.2 5.0.2&#39;</span>
<span class="line-added"> 31 </span>
 32 def mode(fctx):
 33     flags = fctx.flags()
 34     if flags == &#39;&#39;: return &#39;100644&#39;
 35     if flags == &#39;x&#39;: return &#39;100755&#39;
 36     if flags == &#39;l&#39;: return &#39;120000&#39;
 37 
 38 def ratio(a, b, threshold):
 39     s = difflib.SequenceMatcher(None, a, b)
 40     if s.real_quick_ratio() &lt; threshold:
 41         return 0
 42     if s.quick_ratio() &lt; threshold:
 43         return 0
 44     ratio = s.ratio()
 45     if ratio &lt; threshold:
 46         return 0
 47     return ratio
 48 
 49 def encode(s):
 50     return s.decode(&#39;utf-8&#39;).encode(&#39;utf-8&#39;)
 51 
</pre>
<hr />
<pre>
 39     s = difflib.SequenceMatcher(None, a, b)
 40     if s.real_quick_ratio() &lt; threshold:
 41         return 0
 42     if s.quick_ratio() &lt; threshold:
 43         return 0
 44     ratio = s.ratio()
 45     if ratio &lt; threshold:
 46         return 0
 47     return ratio
 48 
 49 def encode(s):
 50     return s.decode(&#39;utf-8&#39;).encode(&#39;utf-8&#39;)
 51 
 52 def write(s):
 53     sys.stdout.write(encode(s))
 54 
 55 def writeln(s):
 56     write(s)
 57     sys.stdout.write(encode(&#39;\n&#39;))
 58 
<span class="line-added"> 59 def _match_exact(root, cwd, files, badfn=None):</span>
<span class="line-added"> 60     &quot;&quot;&quot;</span>
<span class="line-added"> 61     Wrapper for mercurial.match.exact that ignores some arguments based on the used version</span>
<span class="line-added"> 62     &quot;&quot;&quot;</span>
<span class="line-added"> 63     if mercurial.util.versiontuple() &lt; 5:</span>
<span class="line-added"> 64         return mercurial.match.exact(root, cwd, files, badfn)</span>
<span class="line-added"> 65     else:</span>
<span class="line-added"> 66         return mercurial.match.exact(files, badfn)</span>
<span class="line-added"> 67 </span>
 68 def _diff_git_raw(repo, ctx1, ctx2, modified, added, removed):
 69     nullHash = &#39;0&#39; * 40
 70     removed_copy = set(removed)
 71 
 72     for path in added:
 73         fctx = ctx2.filectx(path)
 74         if fctx.renamed():
 75             parent = fctx.p1()
 76             old_path, _ = fctx.renamed()
 77             if old_path in removed:
 78                 removed_copy.discard(old_path)
 79 
 80     for path in sorted(modified | added | removed_copy):
 81         if path in modified:
 82             fctx = ctx2.filectx(path)
 83             writeln(&#39;:{} {} {} {} M\t{}&#39;.format(mode(ctx1.filectx(path)), mode(fctx), nullHash, nullHash, fctx.path()))
 84         elif path in added:
 85             fctx = ctx2.filectx(path)
 86             if not fctx.renamed():
 87                 writeln(&#39;:000000 {} {} {} A\t{}&#39;.format(mode(fctx), nullHash, nullHash, fctx.path()))
</pre>
<hr />
<pre>
 85             fctx = ctx2.filectx(path)
 86             if not fctx.renamed():
 87                 writeln(&#39;:000000 {} {} {} A\t{}&#39;.format(mode(fctx), nullHash, nullHash, fctx.path()))
 88             else:
 89                 parent = fctx.p1()
 90                 score = int(ratio(parent.data(), fctx.data(), 0.5) * 100)
 91                 old_path, _ = fctx.renamed()
 92 
 93                 if old_path in removed:
 94                     operation = &#39;R&#39;
 95                 else:
 96                     operation = &#39;C&#39;
 97 
 98                 writeln(&#39;:{} {} {} {} {}{}\t{}\t{}&#39;.format(mode(parent), mode(fctx), nullHash, nullHash, operation, score, old_path, path))
 99         elif path in removed_copy:
100             fctx = ctx1.filectx(path)
101             writeln(&#39;:{} 000000 {} {} D\t{}&#39;.format(mode(fctx), nullHash, nullHash, path))
102 
103     writeln(&#39;&#39;)
104 
<span class="line-modified">105     match = _match_exact(repo.root, repo.getcwd(), list(modified) + list(added) + list(removed_copy))</span>
106     opts = mercurial.mdiff.diffopts(git=True, nodates=True, context=0, showfunc=True)
107     for d in mercurial.patch.diff(repo, ctx1.node(), ctx2.node(), match=match, opts=opts):
108         sys.stdout.write(d)
109 
110 def really_differs(repo, p1, p2, ctx, files):
111     # workaround bug in hg (present since forever):
112     # `hg status` can, for merge commits, report a file as modififed between one parent
113     # and the merge even though it isn&#39;t. `hg diff` works correctly, so remove any &quot;modified&quot;
114     # that has an empty diff against one of its parents
115     differs = set()
116     for path in files:
117         match = mercurial.match.exact(repo.root, repo.getcwd(), [path])
118         opts = mercurial.mdiff.diffopts(git=True, nodates=True, context=0, showfunc=True)
119 
120         diff1 = mercurial.patch.diff(repo, p1.node(), ctx.node(), match=match, opts=opts)
121         diff2 = mercurial.patch.diff(repo, p2.node(), ctx.node(), match=match, opts=opts)
122         if len(list(diff1)) &gt; 0 and len(list(diff2)) &gt; 0:
123             differs.add(path)
124 
125     return differs
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>