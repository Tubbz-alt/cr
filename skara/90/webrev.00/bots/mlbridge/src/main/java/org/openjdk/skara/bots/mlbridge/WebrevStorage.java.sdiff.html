<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/WebrevStorage.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/WebrevStorage.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 44 
 45     WebrevStorage(HostedRepository storage, String ref, Path baseFolder, URI baseUri, EmailAddress author) {
 46         this.baseFolder = baseFolder;
 47         this.baseUri = baseUri;
 48         this.storage = storage;
 49         storageRef = ref;
 50         this.author = author;
 51     }
 52 
 53     private void generate(PullRequestInstance prInstance, Path folder, Hash base, Hash head) throws IOException {
 54         Files.createDirectories(folder);
 55         Webrev.repository(prInstance.localRepo()).output(folder)
 56               .generate(base, head);
 57     }
 58 
 59     private void push(Repository localStorage, Path webrevFolder, String identifier) throws IOException {
 60         var batchIndex = new AtomicInteger();
 61         try (var files = Files.walk(webrevFolder)) {
 62             // Try to push 1000 files at a time
 63             var batches = files.filter(Files::isRegularFile)








 64                                .collect(Collectors.groupingBy(path -&gt; {
 65                                    int curIndex = batchIndex.incrementAndGet();
 66                                    return Math.floorDiv(curIndex, 1000);
 67                                }));
 68 
 69             for (var batch : batches.entrySet()) {
 70                 localStorage.add(batch.getValue());
 71                 Hash hash;
 72                 var message = &quot;Added webrev for &quot; + identifier +
 73                         (batches.size() &gt; 1 ? &quot; (&quot; + (batch.getKey() + 1) + &quot;/&quot; + batches.size() + &quot;)&quot; : &quot;&quot;);
 74                 try {
 75                     hash = localStorage.commit(message, author.fullName().orElseThrow(), author.address());
 76                 } catch (IOException e) {
 77                     // If the commit fails, it probably means that we&#39;re resuming a partially completed previous update
 78                     // where some of the files have already been committed. Ignore it and continue.
 79                     continue;
 80                 }
 81                 localStorage.push(hash, storage.getUrl(), storageRef);
 82             }
 83         }
</pre>
</td>
<td>
<hr />
<pre>
 44 
 45     WebrevStorage(HostedRepository storage, String ref, Path baseFolder, URI baseUri, EmailAddress author) {
 46         this.baseFolder = baseFolder;
 47         this.baseUri = baseUri;
 48         this.storage = storage;
 49         storageRef = ref;
 50         this.author = author;
 51     }
 52 
 53     private void generate(PullRequestInstance prInstance, Path folder, Hash base, Hash head) throws IOException {
 54         Files.createDirectories(folder);
 55         Webrev.repository(prInstance.localRepo()).output(folder)
 56               .generate(base, head);
 57     }
 58 
 59     private void push(Repository localStorage, Path webrevFolder, String identifier) throws IOException {
 60         var batchIndex = new AtomicInteger();
 61         try (var files = Files.walk(webrevFolder)) {
 62             // Try to push 1000 files at a time
 63             var batches = files.filter(Files::isRegularFile)
<span class="line-added"> 64                                .filter(file -&gt; {</span>
<span class="line-added"> 65                                    // Huge files are not that useful in a webrev</span>
<span class="line-added"> 66                                    try {</span>
<span class="line-added"> 67                                        return Files.size(file) &lt; 1000 * 1000;</span>
<span class="line-added"> 68                                    } catch (IOException e) {</span>
<span class="line-added"> 69                                        return false;</span>
<span class="line-added"> 70                                    }</span>
<span class="line-added"> 71                                })</span>
 72                                .collect(Collectors.groupingBy(path -&gt; {
 73                                    int curIndex = batchIndex.incrementAndGet();
 74                                    return Math.floorDiv(curIndex, 1000);
 75                                }));
 76 
 77             for (var batch : batches.entrySet()) {
 78                 localStorage.add(batch.getValue());
 79                 Hash hash;
 80                 var message = &quot;Added webrev for &quot; + identifier +
 81                         (batches.size() &gt; 1 ? &quot; (&quot; + (batch.getKey() + 1) + &quot;/&quot; + batches.size() + &quot;)&quot; : &quot;&quot;);
 82                 try {
 83                     hash = localStorage.commit(message, author.fullName().orElseThrow(), author.address());
 84                 } catch (IOException e) {
 85                     // If the commit fails, it probably means that we&#39;re resuming a partially completed previous update
 86                     // where some of the files have already been committed. Ignore it and continue.
 87                     continue;
 88                 }
 89                 localStorage.push(hash, storage.getUrl(), storageRef);
 90             }
 91         }
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>