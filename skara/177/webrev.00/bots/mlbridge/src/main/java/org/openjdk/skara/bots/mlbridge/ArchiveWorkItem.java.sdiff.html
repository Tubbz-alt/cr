<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/ArchiveWorkItem.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/ArchiveWorkItem.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
262                 } else {
263                     var index = reviewArchive.revisionCount();
264                     var fullWebrev = bot.webrevStorage().createAndArchive(prInstance, webrevPath, prInstance.baseHash(),
265                                                                           prInstance.headHash(), String.format(&quot;%02d&quot;, index));
266                     var incrementalWebrev = bot.webrevStorage().createAndArchive(prInstance, webrevPath, latestHead,
267                                                                                  prInstance.headHash(), String.format(&quot;%02d-%02d&quot;, index - 1, index));
268                     reviewArchive.addIncremental(fullWebrev, incrementalWebrev);
269                     updateWebrevComment(comments, index, fullWebrev, incrementalWebrev);
270                 }
271             }
272         }
273 
274         // Regular comments
275         for (var comment : comments) {
276             if (ignoreComment(comment.author(), comment.body())) {
277                 continue;
278             }
279             reviewArchive.addComment(comment);
280         }
281 
<span class="line-removed">282         // Review comments</span>
<span class="line-removed">283         var reviews = pr.getReviews();</span>
<span class="line-removed">284         for (var review : reviews) {</span>
<span class="line-removed">285             if (ignoreComment(review.reviewer(), review.body().orElse(&quot;&quot;))) {</span>
<span class="line-removed">286                 continue;</span>
<span class="line-removed">287             }</span>
<span class="line-removed">288             reviewArchive.addReview(review);</span>
<span class="line-removed">289         }</span>
<span class="line-removed">290 </span>
291         // File specific comments
292         var reviewComments = pr.getReviewComments();
293         for (var reviewComment : reviewComments) {
294             if (ignoreComment(reviewComment.author(), reviewComment.body())) {
295                 continue;
296             }
297             reviewArchive.addReviewComment(reviewComment);
298         }
299 









300         var newMails = reviewArchive.generatedEmails();
301         if (newMails.isEmpty()) {
302             return;
303         }
304 
305         // Push all new mails to the archive repository
306         newMails.forEach(reviewArchiveList::post);
307         pushMbox(archiveRepo, &quot;Adding comments for PR &quot; + bot.codeRepo().getName() + &quot;/&quot; + pr.getId());
308 
309         // Finally post all new mails to the actual list
310         for (var newMail : newMails) {
311             var filteredHeaders = newMail.headers().stream()
312                                          .filter(header -&gt; !header.startsWith(&quot;PR-&quot;))
313                                          .collect(Collectors.toMap(Function.identity(),
314                                                                    newMail::headerValue));
315             var filteredEmail = Email.from(newMail)
316                                      .replaceHeaders(filteredHeaders)
317                                      .headers(bot.headers())
318                                      .build();
319             list.post(filteredEmail);
</pre>
</td>
<td>
<hr />
<pre>
262                 } else {
263                     var index = reviewArchive.revisionCount();
264                     var fullWebrev = bot.webrevStorage().createAndArchive(prInstance, webrevPath, prInstance.baseHash(),
265                                                                           prInstance.headHash(), String.format(&quot;%02d&quot;, index));
266                     var incrementalWebrev = bot.webrevStorage().createAndArchive(prInstance, webrevPath, latestHead,
267                                                                                  prInstance.headHash(), String.format(&quot;%02d-%02d&quot;, index - 1, index));
268                     reviewArchive.addIncremental(fullWebrev, incrementalWebrev);
269                     updateWebrevComment(comments, index, fullWebrev, incrementalWebrev);
270                 }
271             }
272         }
273 
274         // Regular comments
275         for (var comment : comments) {
276             if (ignoreComment(comment.author(), comment.body())) {
277                 continue;
278             }
279             reviewArchive.addComment(comment);
280         }
281 









282         // File specific comments
283         var reviewComments = pr.getReviewComments();
284         for (var reviewComment : reviewComments) {
285             if (ignoreComment(reviewComment.author(), reviewComment.body())) {
286                 continue;
287             }
288             reviewArchive.addReviewComment(reviewComment);
289         }
290 
<span class="line-added">291         // Review comments</span>
<span class="line-added">292         var reviews = pr.getReviews();</span>
<span class="line-added">293         for (var review : reviews) {</span>
<span class="line-added">294             if (ignoreComment(review.reviewer(), review.body().orElse(&quot;&quot;))) {</span>
<span class="line-added">295                 continue;</span>
<span class="line-added">296             }</span>
<span class="line-added">297             reviewArchive.addReview(review);</span>
<span class="line-added">298         }</span>
<span class="line-added">299 </span>
300         var newMails = reviewArchive.generatedEmails();
301         if (newMails.isEmpty()) {
302             return;
303         }
304 
305         // Push all new mails to the archive repository
306         newMails.forEach(reviewArchiveList::post);
307         pushMbox(archiveRepo, &quot;Adding comments for PR &quot; + bot.codeRepo().getName() + &quot;/&quot; + pr.getId());
308 
309         // Finally post all new mails to the actual list
310         for (var newMail : newMails) {
311             var filteredHeaders = newMail.headers().stream()
312                                          .filter(header -&gt; !header.startsWith(&quot;PR-&quot;))
313                                          .collect(Collectors.toMap(Function.identity(),
314                                                                    newMail::headerValue));
315             var filteredEmail = Email.from(newMail)
316                                      .replaceHeaders(filteredHeaders)
317                                      .headers(bot.headers())
318                                      .build();
319             list.post(filteredEmail);
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>