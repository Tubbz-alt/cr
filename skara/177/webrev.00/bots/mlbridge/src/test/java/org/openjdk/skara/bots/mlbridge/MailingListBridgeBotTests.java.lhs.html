<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.mlbridge;
  24 
  25 import org.openjdk.skara.email.EmailAddress;
  26 import org.openjdk.skara.host.*;
  27 import org.openjdk.skara.host.network.URIBuilder;
  28 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  29 import org.openjdk.skara.test.*;
  30 import org.openjdk.skara.vcs.Repository;
  31 
  32 import org.junit.jupiter.api.*;
  33 
  34 import java.io.IOException;
  35 import java.nio.charset.StandardCharsets;
  36 import java.nio.file.*;
  37 import java.time.Duration;
  38 import java.util.*;
  39 import java.util.regex.Pattern;
  40 import java.util.stream.Collectors;
  41 
  42 import static org.junit.jupiter.api.Assertions.*;
  43 
  44 class MailingListBridgeBotTests {
<a name="1" id="anc1"></a><span class="line-modified">  45     private boolean archiveContains(Path archive, String text) {</span>
<span class="line-removed">  46         return archiveContainsCount(archive, text) &gt; 0;</span>
<span class="line-removed">  47     }</span>
<span class="line-removed">  48 </span>
<span class="line-removed">  49     private int archiveContainsCount(Path archive, String text) {</span>
  50         try {
  51             var mbox = Files.find(archive, 50, (path, attrs) -&gt; path.toString().endsWith(&quot;.mbox&quot;)).findAny();
  52             if (mbox.isEmpty()) {
<a name="2" id="anc2"></a><span class="line-modified">  53                 return 0;</span>
  54             }
<a name="3" id="anc3"></a><span class="line-modified">  55             var lines = Files.readString(mbox.get(), StandardCharsets.UTF_8);</span>
<span class="line-removed">  56             var pattern = Pattern.compile(text);</span>
<span class="line-removed">  57             int count = 0;</span>
<span class="line-removed">  58             for (var line : lines.split(&quot;\\R&quot;)) {</span>
<span class="line-removed">  59                 var matcher = pattern.matcher(line);</span>
<span class="line-removed">  60                 if (matcher.find()) {</span>
<span class="line-removed">  61                     count++;</span>
<span class="line-removed">  62                 }</span>
<span class="line-removed">  63             }</span>
<span class="line-removed">  64             return count;</span>
  65         } catch (IOException e) {
<a name="4" id="anc4"></a>











  66             return 0;
  67         }
<a name="5" id="anc5"></a>








  68     }
  69 
  70     private boolean webrevContains(Path webrev, String text) {
  71         try {
  72             var index = Files.find(webrev, 5, (path, attrs) -&gt; path.toString().endsWith(&quot;index.html&quot;)).findAny();
  73             if (index.isEmpty()) {
  74                 return false;
  75             }
  76             var lines = Files.readString(index.get(), StandardCharsets.UTF_8);
  77             return lines.contains(text);
  78         } catch (IOException e) {
  79             return false;
  80         }
  81     }
  82 
  83     private long countSubstrings(String string, String substring) {
  84         return Pattern.compile(substring).matcher(string).results().count();
  85     }
  86 
  87     private String noreplyAddress(HostedRepository repository) {
  88         return repository.host().getCurrentUserDetails().id() + &quot;+&quot; +
  89                 repository.host().getCurrentUserDetails().userName() +
  90                 &quot;@users.noreply.test&quot;;
  91     }
  92 
  93     @Test
  94     void simpleArchive(TestInfo testInfo) throws IOException {
  95         try (var credentials = new HostCredentials(testInfo);
  96              var tempFolder = new TemporaryDirectory();
  97              var archiveFolder = new TemporaryDirectory();
  98              var webrevFolder = new TemporaryDirectory();
  99              var listServer = new TestMailmanServer()) {
 100             var author = credentials.getHostedRepository();
 101             var archive = credentials.getHostedRepository();
 102             var ignored = credentials.getHostedRepository();
 103             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 104             var censusBuilder = credentials.getCensusBuilder()
 105                                            .addAuthor(author.host().getCurrentUserDetails().id());
 106             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 107             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,
 108                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 109                                                  Set.of(),
 110                                                  listServer.getArchive(), listServer.getSMTP(),
 111                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 112                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 113                                                  Set.of(&quot;rfr&quot;), Map.of(ignored.host().getCurrentUserDetails().userName(),
 114                                                                        Pattern.compile(&quot;ready&quot;)),
 115                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 116                                                  Map.of(&quot;Extra1&quot;, &quot;val1&quot;, &quot;Extra2&quot;, &quot;val2&quot;));
 117 
 118             // Populate the projects repository
 119             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
 120             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 121             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 122             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 123 
 124             // Make a change with a corresponding PR
 125             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 126                                                                &quot;Change msg\n\nWith several lines&quot;);
 127             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 128             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 129             pr.setBody(&quot;This should not be ready&quot;);
 130 
 131             // Run an archive pass
 132             TestBotRunner.runPeriodicItems(mlBot);
 133 
 134             // A PR that isn&#39;t ready for review should not be archived
 135             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 136             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 137 
 138             // Flag it as ready for review
 139             pr.setBody(&quot;This should now be ready&quot;);
 140             pr.addLabel(&quot;rfr&quot;);
 141 
 142             // Run another archive pass
 143             TestBotRunner.runPeriodicItems(mlBot);
 144 
 145             // But it should still not be archived
 146             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 147             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 148 
 149             // Now post a general comment - not a ready marker
 150             var ignoredPr = ignored.getPullRequest(pr.getId());
 151             ignoredPr.addComment(&quot;hello there&quot;);
 152 
 153             // Run another archive pass
 154             TestBotRunner.runPeriodicItems(mlBot);
 155 
 156             // It should still not be archived
 157             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 158             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 159 
 160             // Now post a ready comment
 161             ignoredPr.addComment(&quot;ready&quot;);
 162 
 163             // Run another archive pass
 164             TestBotRunner.runPeriodicItems(mlBot);
 165 
 166             // The archive should now contain an entry
 167             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 168             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 169             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
 170             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
 171             assertTrue(archiveContains(archiveFolder.path(), &quot;Changes:&quot;));
 172             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
 173             assertTrue(archiveContains(archiveFolder.path(), &quot;http://www.test.test/&quot;));
 174             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));
 175             assertTrue(archiveContains(archiveFolder.path(), &quot;Issue:&quot;));
 176             assertTrue(archiveContains(archiveFolder.path(), &quot;http://issues.test/browse/TSTPRJ-1234&quot;));
 177             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch:&quot;));
 178             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - &quot; + editHash.abbreviate() + &quot;: Change msg&quot;));
 179             assertFalse(archiveContains(archiveFolder.path(), &quot;With several lines&quot;));
 180 
 181             // The mailing list as well
 182             listServer.processIncoming();
 183             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 184             var mailmanList = mailmanServer.getList(listAddress.address());
 185             var conversations = mailmanList.conversations(Duration.ofDays(1));
 186             assertEquals(1, conversations.size());
 187             var mail = conversations.get(0).first();
 188             assertEquals(&quot;RFR: 1234: This is a pull request&quot;, mail.subject());
 189             assertEquals(pr.getAuthor().fullName(), mail.author().fullName().orElseThrow());
 190             assertEquals(noreplyAddress(archive), mail.author().address());
 191             assertEquals(from, mail.sender());
 192             assertEquals(&quot;val1&quot;, mail.headerValue(&quot;Extra1&quot;));
 193             assertEquals(&quot;val2&quot;, mail.headerValue(&quot;Extra2&quot;));
 194 
 195             // And there should be a webrev
 196             Repository.materialize(webrevFolder.path(), archive.getUrl(), &quot;webrev&quot;);
 197             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
 198             var comments = pr.getComments();
 199             var webrevComments = comments.stream()
 200                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 201                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 202                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 203                                          .collect(Collectors.toList());
 204             assertEquals(1, webrevComments.size());
 205 
 206             // Add a comment
 207             pr.addComment(&quot;This is a comment :smile:&quot;);
 208 
 209             // Add a comment from an ignored user as well
 210             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);
 211 
 212             // Run another archive pass
 213             TestBotRunner.runPeriodicItems(mlBot);
 214 
 215             // The archive should now contain the comment, but not the ignored one
 216             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 217             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a comment&quot;));
 218             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This should now be ready&quot;));
 219             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 220 
 221             listServer.processIncoming();
 222             conversations = mailmanList.conversations(Duration.ofDays(1));
 223             assertEquals(1, conversations.size());
 224             assertEquals(2, conversations.get(0).allMessages().size());
 225 
 226             // Remove the rfr flag and post another comment
 227             pr.addLabel(&quot;rfr&quot;);
 228             pr.addComment(&quot;This is another comment&quot;);
 229 
 230             // Run another archive pass
 231             TestBotRunner.runPeriodicItems(mlBot);
 232 
 233             // The archive should contain the additional comment
 234             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 235             assertTrue(archiveContains(archiveFolder.path(), &quot;This is another comment&quot;));
 236             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This should now be ready&quot;));
 237 
 238             listServer.processIncoming();
 239             conversations = mailmanList.conversations(Duration.ofDays(1));
 240             assertEquals(1, conversations.size());
 241             assertEquals(3, conversations.get(0).allMessages().size());
 242             for (var newMail : conversations.get(0).allMessages()) {
 243                 assertEquals(noreplyAddress(archive), newMail.author().address());
 244                 assertEquals(from, newMail.sender());
 245             }
 246             assertTrue(conversations.get(0).allMessages().get(2).body().contains(&quot;This is a comment 😄&quot;));
 247         }
 248     }
 249 
 250     @Test
 251     void reviewComment(TestInfo testInfo) throws IOException {
 252         try (var credentials = new HostCredentials(testInfo);
 253              var tempFolder = new TemporaryDirectory();
 254              var archiveFolder = new TemporaryDirectory();
 255              var listServer = new TestMailmanServer()) {
 256             var author = credentials.getHostedRepository();
 257             var archive = credentials.getHostedRepository();
 258             var ignored = credentials.getHostedRepository();
 259             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 260             var censusBuilder = credentials.getCensusBuilder()
 261                                            .addAuthor(author.host().getCurrentUserDetails().id());
 262             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 263             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,
 264                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 265                                                  Set.of(),
 266                                                  listServer.getArchive(), listServer.getSMTP(),
 267                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 268                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 269                                                  Set.of(), Map.of(),
 270                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 271                                                  Map.of());
 272 
 273             // Populate the projects repository
 274             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 275             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 276             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 277             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 278             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 279 
 280             // Make a change with a corresponding PR
 281             var editHash = CheckableRepository.appendAndCommit(localRepo);
 282             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 283             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 284             pr.setBody(&quot;This is now ready&quot;);
 285             TestBotRunner.runPeriodicItems(mlBot);
 286             listServer.processIncoming();
 287 
 288             // And make a file specific comment
 289             var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
 290             var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 291 
 292             // Add one from an ignored user as well
 293             var ignoredPr = ignored.getPullRequest(pr.getId());
 294             ignoredPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Don&#39;t mind me&quot;);
 295 
 296             // Process comments
 297             TestBotRunner.runPeriodicItems(mlBot);
 298             listServer.processIncoming();
 299 
 300             // The archive should now contain an entry
 301             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 302             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 303             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 304             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 305             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This is now ready&quot;));
 306             assertTrue(archiveContains(archiveFolder.path(), reviewFile.toString()));
 307             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 308 
 309             // The mailing list as well
 310             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 311             var mailmanList = mailmanServer.getList(listAddress.address());
 312             var conversations = mailmanList.conversations(Duration.ofDays(1));
 313             assertEquals(1, conversations.size());
 314             var mail = conversations.get(0).first();
 315             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 316 
 317             // Comment on the comment
 318             pr.addReviewCommentReply(comment, &quot;This is a review reply&quot;);
 319             TestBotRunner.runPeriodicItems(mlBot);
 320             listServer.processIncoming();
 321 
 322             // The archive should contain the additional comment (but no quoted footers)
 323             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 324             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a review reply&quot;));
 325             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This is now ready&quot;));
 326             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; PR:&quot;));
 327 
 328             // As well as the mailing list
 329             conversations = mailmanList.conversations(Duration.ofDays(1));
 330             assertEquals(1, conversations.size());
 331             assertEquals(3, conversations.get(0).allMessages().size());
 332             for (var newMail : conversations.get(0).allMessages()) {
 333                 assertEquals(noreplyAddress(archive), newMail.author().address());
 334                 assertEquals(from, newMail.sender());
 335             }
 336         }
 337     }
 338 
 339     @Test
 340     void combineComments(TestInfo testInfo) throws IOException {
 341         try (var credentials = new HostCredentials(testInfo);
 342              var tempFolder = new TemporaryDirectory();
 343              var archiveFolder = new TemporaryDirectory();
 344              var listServer = new TestMailmanServer()) {
 345             var author = credentials.getHostedRepository();
 346             var archive = credentials.getHostedRepository();
 347             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 348             var censusBuilder = credentials.getCensusBuilder()
 349                                            .addAuthor(author.host().getCurrentUserDetails().id());
 350             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 351             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 352                                                  listAddress, Set.of(), Set.of(),
 353                                                  listServer.getArchive(),
 354                                                  listServer.getSMTP(),
 355                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 356                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 357                                                  Set.of(), Map.of(),
 358                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 359                                                  Map.of());
 360 
 361             // Populate the projects repository
 362             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 363             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 364             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 365             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 366             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 367 
 368             // Make a change with a corresponding PR
 369             var editHash = CheckableRepository.appendAndCommit(localRepo);
 370             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 371             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 372             pr.setBody(&quot;This is now ready&quot;);
 373             pr.addComment(&quot;Avoid combining&quot;);
 374 
 375             TestBotRunner.runPeriodicItems(mlBot);
 376             listServer.processIncoming();
 377             listServer.processIncoming();
 378 
 379             // Make several file specific comments
 380             var first = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 381             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 382             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Further review comment&quot;);
 383             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Final review comment&quot;);
 384             TestBotRunner.runPeriodicItems(mlBot);
 385             listServer.processIncoming();
 386 
 387             // The archive should contain a combined entry
 388             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 389             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 390 
 391             // As well as the mailing list
 392             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 393             var mailmanList = mailmanServer.getList(listAddress.address());
 394             var conversations = mailmanList.conversations(Duration.ofDays(1));
 395             assertEquals(1, conversations.size());
 396             var mail = conversations.get(0).first();
 397             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 398             assertEquals(3, conversations.get(0).allMessages().size());
 399 
 400             var commentReply = conversations.get(0).replies(mail).get(0);
 401             assertEquals(2, commentReply.body().split(&quot;^On.*wrote:&quot;).length);
 402             assertTrue(commentReply.body().contains(&quot;Avoid combining\n\n&quot;), commentReply.body());
 403 
 404             var reviewReply = conversations.get(0).replies(mail).get(1);
 405             assertEquals(2, reviewReply.body().split(&quot;^On.*wrote:&quot;).length);
 406             assertEquals(2, reviewReply.body().split(&quot;&gt; This is now ready&quot;).length, reviewReply.body());
 407             assertEquals(&quot;Re: RFR: This is a pull request&quot;, reviewReply.subject());
 408             assertTrue(reviewReply.body().contains(&quot;Review comment\n\n&quot;), reviewReply.body());
 409             assertTrue(reviewReply.body().contains(&quot;Another review comment&quot;), reviewReply.body());
 410 
 411             // Now reply to the first (collapsed) comment
 412             pr.addReviewCommentReply(first, &quot;I agree&quot;);
 413             TestBotRunner.runPeriodicItems(mlBot);
 414             listServer.processIncoming();
 415 
 416             // The archive should contain a new entry
 417             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 418             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 419 
 420             // The combined review comments should only appear unquoted once
 421             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^Another review comment&quot;));
 422         }
 423     }
 424 
 425     @Test
 426     void commentThreading(TestInfo testInfo) throws IOException {
 427         try (var credentials = new HostCredentials(testInfo);
 428              var tempFolder = new TemporaryDirectory();
 429              var archiveFolder = new TemporaryDirectory();
 430              var listServer = new TestMailmanServer()) {
 431             var author = credentials.getHostedRepository();
 432             var reviewer = credentials.getHostedRepository();
 433             var archive = credentials.getHostedRepository();
 434             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 435             var censusBuilder = credentials.getCensusBuilder()
 436                                            .addReviewer(reviewer.host().getCurrentUserDetails().id())
 437                                            .addAuthor(author.host().getCurrentUserDetails().id());
 438             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 439             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 440                                                  listAddress, Set.of(), Set.of(),
 441                                                  listServer.getArchive(),
 442                                                  listServer.getSMTP(),
 443                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 444                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 445                                                  Set.of(), Map.of(),
 446                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 447                                                  Map.of());
 448 
 449             // Populate the projects repository
 450             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 451             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 452             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 453             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 454             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 455 
 456             // Make a change with a corresponding PR
 457             var editHash = CheckableRepository.appendAndCommit(localRepo);
 458             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 459             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 460             pr.setBody(&quot;This is now ready&quot;);
 461             TestBotRunner.runPeriodicItems(mlBot);
 462             listServer.processIncoming();
 463 
 464             // Make a file specific comment
 465             var reviewPr = reviewer.getPullRequest(pr.getId());
 466             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 467             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 468             reviewPr.addReviewCommentReply(comment1, &quot;Great&quot;);
 469             TestBotRunner.runPeriodicItems(mlBot);
 470             listServer.processIncoming();
 471             listServer.processIncoming();
 472             listServer.processIncoming();
 473 
 474             // And a second one by ourselves
 475             var comment2 = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 476             reviewPr.addReviewCommentReply(comment2, &quot;Sounds good&quot;);
 477             pr.addReviewCommentReply(comment2, &quot;Thanks&quot;);
 478             TestBotRunner.runPeriodicItems(mlBot);
 479             listServer.processIncoming();
 480             listServer.processIncoming();
 481             listServer.processIncoming();
 482 
<a name="6" id="anc6"></a><span class="line-modified"> 483             // Finally some approvals</span>
 484             pr.addReview(Review.Verdict.APPROVED, &quot;Nice&quot;);
 485             reviewPr.addReview(Review.Verdict.APPROVED, &quot;Looks fine&quot;);
<a name="7" id="anc7"></a>
 486             TestBotRunner.runPeriodicItems(mlBot);
 487             listServer.processIncoming();
 488             listServer.processIncoming();
<a name="8" id="anc8"></a>
 489 
 490             // Sanity check the archive
 491             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
<a name="9" id="anc9"></a><span class="line-modified"> 492             assertEquals(8, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));</span>




 493 
 494             // Check the mailing list
 495             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 496             var mailmanList = mailmanServer.getList(listAddress.address());
 497             var conversations = mailmanList.conversations(Duration.ofDays(1));
 498             assertEquals(1, conversations.size());
 499             var mail = conversations.get(0).first();
 500             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
<a name="10" id="anc10"></a><span class="line-modified"> 501             assertEquals(9, conversations.get(0).allMessages().size());</span>
 502 
 503             // There should be four separate threads
 504             var thread1 = conversations.get(0).replies(mail).get(0);
 505             assertEquals(2, thread1.body().split(&quot;^On.*wrote:&quot;).length);
 506             assertEquals(2, thread1.body().split(&quot;&gt; This is now ready&quot;).length, thread1.body());
 507             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread1.subject());
 508             assertTrue(thread1.body().contains(&quot;Review comment\n\n&quot;), thread1.body());
 509             assertFalse(thread1.body().contains(&quot;Another review comment&quot;), thread1.body());
 510             var thread1reply1 = conversations.get(0).replies(thread1).get(0);
 511             assertTrue(thread1reply1.body().contains(&quot;I agree&quot;));
 512             assertEquals(noreplyAddress(archive), thread1reply1.author().address());
 513             assertEquals(archive.host().getCurrentUserDetails().fullName(), thread1reply1.author().fullName().orElseThrow());
 514             var thread1reply2 = conversations.get(0).replies(thread1reply1).get(0);
 515             assertTrue(thread1reply2.body().contains(&quot;Great&quot;));
 516             assertEquals(&quot;integrationreviewer1@openjdk.java.net&quot;, thread1reply2.author().address());
 517             assertEquals(&quot;Generated Reviewer 1&quot;, thread1reply2.author().fullName().orElseThrow());
 518 
 519             var thread2 = conversations.get(0).replies(mail).get(1);
 520             assertEquals(2, thread2.body().split(&quot;^On.*wrote:&quot;).length);
 521             assertEquals(2, thread2.body().split(&quot;&gt; This is now ready&quot;).length, thread2.body());
 522             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread2.subject());
 523             assertFalse(thread2.body().contains(&quot;Review comment\n\n&quot;), thread2.body());
 524             assertTrue(thread2.body().contains(&quot;Another review comment&quot;), thread2.body());
 525             var thread2reply1 = conversations.get(0).replies(thread2).get(0);
 526             assertTrue(thread2reply1.body().contains(&quot;Sounds good&quot;));
 527             var thread2reply2 = conversations.get(0).replies(thread2reply1).get(0);
 528             assertTrue(thread2reply2.body().contains(&quot;Thanks&quot;));
 529 
<a name="11" id="anc11"></a>
 530             var thread3 = conversations.get(0).replies(mail).get(2);
 531             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread3.subject());
 532             var thread4 = conversations.get(0).replies(mail).get(3);
 533             assertEquals(&quot;Re: [Approved] RFR: This is a pull request&quot;, thread4.subject());
 534         }
 535     }
 536 
 537     @Test
 538     void reviewContext(TestInfo testInfo) throws IOException {
 539         try (var credentials = new HostCredentials(testInfo);
 540              var tempFolder = new TemporaryDirectory();
 541              var archiveFolder = new TemporaryDirectory();
 542              var listServer = new TestMailmanServer()) {
 543             var author = credentials.getHostedRepository();
 544             var archive = credentials.getHostedRepository();
 545             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 546             var censusBuilder = credentials.getCensusBuilder()
 547                                            .addAuthor(author.host().getCurrentUserDetails().id());
 548             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 549             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 550                                                  listAddress, Set.of(), Set.of(),
 551                                                  listServer.getArchive(),
 552                                                  listServer.getSMTP(),
 553                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 554                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 555                                                  Set.of(), Map.of(),
 556                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 557                                                  Map.of());
 558 
 559             // Populate the projects repository
 560             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 561             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 562             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 563             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 564             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 565 
 566             // Make a change with a corresponding PR
 567             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
 568             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 569             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 570             pr.setBody(&quot;This is now ready&quot;);
 571             TestBotRunner.runPeriodicItems(mlBot);
 572             listServer.processIncoming();
 573 
 574             // Make a file specific comment
 575             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 576 
 577             TestBotRunner.runPeriodicItems(mlBot);
 578             listServer.processIncoming();
 579 
 580             // The archive should only contain context around line 2
 581             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 582             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
 583             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
 584             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
 585         }
 586     }
 587 
 588     @Test
 589     void multipleReviewContexts(TestInfo testInfo) throws IOException {
 590         try (var credentials = new HostCredentials(testInfo);
 591              var tempFolder = new TemporaryDirectory();
 592              var archiveFolder = new TemporaryDirectory();
 593              var listServer = new TestMailmanServer()) {
 594             var author = credentials.getHostedRepository();
 595             var archive = credentials.getHostedRepository();
 596             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 597             var censusBuilder = credentials.getCensusBuilder()
 598                                            .addAuthor(author.host().getCurrentUserDetails().id());
 599             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 600             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 601                                                  listAddress, Set.of(), Set.of(),
 602                                                  listServer.getArchive(),
 603                                                  listServer.getSMTP(),
 604                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 605                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 606                                                  Set.of(), Map.of(),
 607                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 608                                                  Map.of());
 609 
 610             // Populate the projects repository
 611             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 612             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 613             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 614             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 615             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 616             var initialHash = CheckableRepository.appendAndCommit(localRepo,
 617                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
 618                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
 619                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
 620                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
 621                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
 622                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
 623             localRepo.push(initialHash, author.getUrl(), &quot;master&quot;);
 624 
 625             // Make a change with a corresponding PR
 626             var current = Files.readString(localRepo.root().resolve(reviewFile), StandardCharsets.UTF_8);
 627             var updated = current.replaceAll(&quot;Line 2&quot;, &quot;Line 2 edit\nLine 2.5&quot;);
 628             updated = updated.replaceAll(&quot;Line 13&quot;, &quot;Line 12.5\nLine 13 edit&quot;);
 629             Files.writeString(localRepo.root().resolve(reviewFile), updated, StandardCharsets.UTF_8);
 630             var editHash = CheckableRepository.appendAndCommit(localRepo);
 631             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 632             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 633             pr.setBody(&quot;This is now ready&quot;);
 634             TestBotRunner.runPeriodicItems(mlBot);
 635             listServer.processIncoming();
 636 
 637             // Make file specific comments
 638             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 7, &quot;Review comment&quot;);
 639             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 24, &quot;Another review comment&quot;);
 640 
 641             TestBotRunner.runPeriodicItems(mlBot);
 642             listServer.processIncoming();
 643 
 644             // The archive should only contain context around line 2 and 20
 645             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 646             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 7&quot;));
 647             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 6: Line 1$&quot;));
 648             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 7: Line 2 edit$&quot;));
 649             assertFalse(archiveContains(archiveFolder.path(), &quot;Line 3&quot;));
 650 
 651             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 24&quot;));
 652             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 23: Line 12.5$&quot;));
 653             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 24: Line 13 edit$&quot;));
 654             assertFalse(archiveContains(archiveFolder.path(), &quot;^Line 15&quot;));
 655         }
 656     }
 657 
 658     @Test
 659     void filterComments(TestInfo testInfo) throws IOException {
 660         try (var credentials = new HostCredentials(testInfo);
 661              var tempFolder = new TemporaryDirectory();
 662              var archiveFolder = new TemporaryDirectory();
 663              var listServer = new TestMailmanServer()) {
 664             var author = credentials.getHostedRepository();
 665             var archive = credentials.getHostedRepository();
 666             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 667             var censusBuilder = credentials.getCensusBuilder()
 668                                            .addAuthor(author.host().getCurrentUserDetails().id());
 669             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 670             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 671                                                  listAddress, Set.of(), Set.of(),
 672                                                  listServer.getArchive(), listServer.getSMTP(),
 673                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 674                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 675                                                  Set.of(), Map.of(),
 676                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 677                                                  Map.of());
 678 
 679             // Populate the projects repository
 680             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 681             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 682             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 683             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 684             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 685 
 686             // Make a change with a corresponding PR
 687             var editHash = CheckableRepository.appendAndCommit(localRepo);
 688             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 689             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 690             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
 691                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
 692 
 693             // Make a bunch of comments
 694             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
 695             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment &lt;!-- this is a comment --&gt;\n&quot;);
 696             pr.addComment(&quot;/integrate stuff&quot;);
 697             TestBotRunner.runPeriodicItems(mlBot);
 698 
 699             // Run an archive pass
 700             TestBotRunner.runPeriodicItems(mlBot);
 701 
 702             // The archive should not contain the comment
 703             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 704             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 705             assertFalse(archiveContains(archiveFolder.path(), &quot;this is a comment&quot;));
 706             assertFalse(archiveContains(archiveFolder.path(), &quot;Status stuff&quot;));
 707             assertTrue(archiveContains(archiveFolder.path(), &quot;And this is not&quot;));
 708             assertFalse(archiveContains(archiveFolder.path(), &quot;&lt;!--&quot;));
 709             assertFalse(archiveContains(archiveFolder.path(), &quot;--&gt;&quot;));
 710             assertTrue(archiveContains(archiveFolder.path(), &quot;Plain comment&quot;));
 711             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 712             assertFalse(archiveContains(archiveFolder.path(), &quot;/integrate&quot;));
 713         }
 714     }
 715 
 716     @Test
 717     void incrementalChanges(TestInfo testInfo) throws IOException {
 718         try (var credentials = new HostCredentials(testInfo);
 719              var tempFolder = new TemporaryDirectory();
 720              var archiveFolder = new TemporaryDirectory();
 721              var listServer = new TestMailmanServer()) {
 722             var author = credentials.getHostedRepository();
 723             var archive = credentials.getHostedRepository();
 724             var commenter = credentials.getHostedRepository();
 725             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 726             var censusBuilder = credentials.getCensusBuilder()
 727                                            .addAuthor(author.host().getCurrentUserDetails().id());
 728             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 729             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 730                                                  listAddress, Set.of(), Set.of(),
 731                                                  listServer.getArchive(), listServer.getSMTP(),
 732                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 733                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 734                                                  Set.of(), Map.of(),
 735                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 736                                                  Map.of());
 737 
 738             // Populate the projects repository
 739             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 740             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 741             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 742             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 743             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 744 
 745             // Make a change with a corresponding PR
 746             var editHash = CheckableRepository.appendAndCommit(localRepo);
 747             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 748             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 749             pr.setBody(&quot;This is now ready&quot;);
 750 
 751             // Run an archive pass
 752             TestBotRunner.runPeriodicItems(mlBot);
 753             listServer.processIncoming();
 754 
 755             var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
 756             localRepo.push(nextHash, author.getUrl(), &quot;edit&quot;);
 757 
 758             // Make sure that the push registered
 759             var lastHeadHash = pr.getHeadHash();
 760             var refreshCount = 0;
 761             do {
 762                 pr = author.getPullRequest(pr.getId());
 763                 if (refreshCount++ &gt; 100) {
 764                     fail(&quot;The PR did not update after the new push&quot;);
 765                 }
 766             } while (pr.getHeadHash().equals(lastHeadHash));
 767 
 768             // Run another archive pass
 769             TestBotRunner.runPeriodicItems(mlBot);
 770             TestBotRunner.runPeriodicItems(mlBot);
 771             TestBotRunner.runPeriodicItems(mlBot);
 772             listServer.processIncoming();
 773 
 774             // The archive should reference the updated push
 775             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 776             assertTrue(archiveContains(archiveFolder.path(), &quot;additional changes&quot;));
 777             assertTrue(archiveContains(archiveFolder.path(), &quot;full.*/&quot; + pr.getId() + &quot;/webrev.01&quot;));
 778             assertTrue(archiveContains(archiveFolder.path(), &quot;inc.*/&quot; + pr.getId() + &quot;/webrev.00-01&quot;));
 779             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
 780             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
 781             assertTrue(archiveContains(archiveFolder.path(), &quot;Fixing&quot;));
 782 
 783             // The webrev comment should be updated
 784             var comments = pr.getComments();
 785             var webrevComments = comments.stream()
 786                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 787                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 788                                          .filter(comment -&gt; comment.body().contains(nextHash.hex()))
 789                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 790                                          .collect(Collectors.toList());
 791             assertEquals(1, webrevComments.size());
 792 
 793             // Check that sender address is set properly
 794             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 795             var mailmanList = mailmanServer.getList(listAddress.address());
 796             var conversations = mailmanList.conversations(Duration.ofDays(1));
 797             assertEquals(1, conversations.size());
 798             for (var newMail : conversations.get(0).allMessages()) {
 799                 assertEquals(noreplyAddress(archive), newMail.author().address());
 800                 assertEquals(from, newMail.sender());
 801             }
 802 
 803             // Add a comment
 804             var commenterPr = commenter.getPullRequest(pr.getId());
 805             commenterPr.addReviewComment(masterHash, nextHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 806             TestBotRunner.runPeriodicItems(mlBot);
 807             listServer.processIncoming();
 808 
 809             // Ensure that additional updates are only reported once
 810             for (int i = 0; i &lt; 3; ++i) {
 811                 var anotherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fixing&quot;);
 812                 localRepo.push(anotherHash, author.getUrl(), &quot;edit&quot;);
 813 
 814                 // Make sure that the push registered
 815                 lastHeadHash = pr.getHeadHash();
 816                 refreshCount = 0;
 817                 do {
 818                     pr = author.getPullRequest(pr.getId());
 819                     if (refreshCount++ &gt; 100) {
 820                         fail(&quot;The PR did not update after the new push&quot;);
 821                     }
 822                 } while (pr.getHeadHash().equals(lastHeadHash));
 823 
 824                 TestBotRunner.runPeriodicItems(mlBot);
 825                 TestBotRunner.runPeriodicItems(mlBot);
 826                 listServer.processIncoming();
 827             }
 828             var updatedConversations = mailmanList.conversations(Duration.ofDays(1));
 829             assertEquals(1, updatedConversations.size());
 830             var conversation = updatedConversations.get(0);
 831             assertEquals(6, conversation.allMessages().size());
 832             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(1).subject());
 833             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(2).subject(), conversation.allMessages().get(2).toString());
 834             assertEquals(&quot;Re: [Rev 04] RFR: This is a pull request&quot;, conversation.allMessages().get(5).subject());
 835         }
 836     }
 837 
 838     @Test
 839     void rebased(TestInfo testInfo) throws IOException {
 840         try (var credentials = new HostCredentials(testInfo);
 841              var tempFolder = new TemporaryDirectory();
 842              var archiveFolder = new TemporaryDirectory();
 843              var listServer = new TestMailmanServer()) {
 844             var author = credentials.getHostedRepository();
 845             var archive = credentials.getHostedRepository();
 846             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 847             var censusBuilder = credentials.getCensusBuilder()
 848                                            .addAuthor(author.host().getCurrentUserDetails().id());
 849             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 850             var mlBot = new MailingListBridgeBot(sender, author, archive, censusBuilder.build(), &quot;master&quot;,
 851                                                  listAddress, Set.of(), Set.of(),
 852                                                  listServer.getArchive(), listServer.getSMTP(),
 853                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 854                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 855                                                  Set.of(), Map.of(),
 856                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 857                                                  Map.of());
 858 
 859             // Populate the projects repository
 860             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 861             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.getRepositoryType(), reviewFile);
 862             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 863             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 864             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 865 
 866             // Make a change with a corresponding PR
 867             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
 868             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 869             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 870             pr.setBody(&quot;This is now ready&quot;);
 871 
 872             // Run an archive pass
 873             TestBotRunner.runPeriodicItems(mlBot);
 874             listServer.processIncoming();
 875 
 876             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.getUrl(), &quot;master&quot;);
 877             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
 878             newLocalRepo.push(newEditHash, author.getUrl(), &quot;edit&quot;, true);
 879 
 880             // Make sure that the push registered
 881             var lastHeadHash = pr.getHeadHash();
 882             var refreshCount = 0;
 883             do {
 884                 pr = author.getPullRequest(pr.getId());
 885                 if (refreshCount++ &gt; 100) {
 886                     fail(&quot;The PR did not update after the new push&quot;);
 887                 }
 888             } while (pr.getHeadHash().equals(lastHeadHash));
 889 
 890             // Run another archive pass
 891             TestBotRunner.runPeriodicItems(mlBot);
 892             listServer.processIncoming();
 893 
 894             // The archive should reference the rebased push
 895             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 896             assertTrue(archiveContains(archiveFolder.path(), &quot;complete new set of changes&quot;));
 897             assertTrue(archiveContains(archiveFolder.path(), pr.getId() + &quot;/webrev.01&quot;));
 898             assertFalse(archiveContains(archiveFolder.path(), &quot;Incremental&quot;));
 899             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
 900             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
 901             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
 902             assertTrue(archiveContains(archiveFolder.path(), &quot;Replaced msg&quot;));
 903 
 904             // The webrev comment should be updated
 905             var comments = pr.getComments();
 906             var webrevComments = comments.stream()
 907                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 908                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 909                                          .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
 910                                          .collect(Collectors.toList());
 911             assertEquals(1, webrevComments.size());
 912 
 913             // Check that sender address is set properly
 914             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 915             var mailmanList = mailmanServer.getList(listAddress.address());
 916             var conversations = mailmanList.conversations(Duration.ofDays(1));
 917             assertEquals(1, conversations.size());
 918             for (var newMail : conversations.get(0).allMessages()) {
 919                 assertEquals(noreplyAddress(archive), newMail.author().address());
 920                 assertEquals(sender, newMail.sender());
 921                 assertFalse(newMail.hasHeader(&quot;PR-Head-Hash&quot;));
 922             }
 923             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversations.get(0).allMessages().get(1).subject());
 924         }
 925     }
 926 
 927     @Test
 928     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
 929         try (var credentials = new HostCredentials(testInfo);
 930              var tempFolder = new TemporaryDirectory();
 931              var archiveFolder = new TemporaryDirectory();
 932              var webrevFolder = new TemporaryDirectory();
 933              var listServer = new TestMailmanServer()) {
 934             var author = credentials.getHostedRepository();
 935             var archive = credentials.getHostedRepository();
 936             var ignored = credentials.getHostedRepository();
 937             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 938             var censusBuilder = credentials.getCensusBuilder()
 939                                            .addAuthor(author.host().getCurrentUserDetails().id());
 940             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 941             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 942                                                  listAddress,
 943                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 944                                                  Set.of(),
 945                                                  listServer.getArchive(), listServer.getSMTP(),
 946                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 947                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 948                                                  Set.of(), Map.of(),
 949                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 950                                                  Map.of());
 951 
 952             // Populate the projects repository
 953             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
 954             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 955             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 956             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 957 
 958             // Make a change with a corresponding PR
 959             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 960                                                                &quot;Change msg\n\nWith several lines&quot;);
 961             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 962             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 963 
 964             // Flag it as ready for review
 965             pr.setBody(&quot;This should now be ready&quot;);
 966 
 967             // Run an archive pass
 968             TestBotRunner.runPeriodicItems(mlBot);
 969 
 970             // The archive should now contain an entry
 971             var archiveRepo = Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 972             assertTrue(archiveContains(archiveFolder.path(), editHash.abbreviate()));
 973 
 974             // And there should be a webrev comment
 975             var comments = pr.getComments();
 976             var webrevComments = comments.stream()
 977                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 978                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 979                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 980                                          .collect(Collectors.toList());
 981             assertEquals(1, webrevComments.size());
 982             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
 983 
 984             // Pretend the archive didn&#39;t work out
 985             archiveRepo.push(masterHash, archive.getUrl(), &quot;master&quot;, true);
 986 
 987             // Run another archive pass
 988             TestBotRunner.runPeriodicItems(mlBot);
 989 
 990             // The webrev comment should not contain duplicate entries
 991             comments = pr.getComments();
 992             webrevComments = comments.stream()
 993                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 994                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 995                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 996                                          .collect(Collectors.toList());
 997             assertEquals(1, webrevComments.size());
 998             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
 999         }
1000     }
1001 
1002     @Test
1003     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
1004         try (var credentials = new HostCredentials(testInfo);
1005              var tempFolder = new TemporaryDirectory();
1006              var archiveFolder = new TemporaryDirectory();
1007              var listServer = new TestMailmanServer()) {
1008             var author = credentials.getHostedRepository();
1009             var archive = credentials.getHostedRepository();
1010             var reviewer = credentials.getHostedRepository();
1011             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1012             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1013             var censusBuilder = credentials.getCensusBuilder()
1014                                            .addReviewer(reviewer.host().getCurrentUserDetails().id())
1015                                            .addAuthor(author.host().getCurrentUserDetails().id());
1016             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
1017                                                  listAddress, Set.of(), Set.of(),
1018                                                  listServer.getArchive(), listServer.getSMTP(),
1019                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
1020                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
1021                                                  Set.of(), Map.of(),
1022                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
1023                                                  Map.of());
1024 
1025             // Populate the projects repository
1026             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1027             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
1028             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1029             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
1030             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
1031 
1032             // Make a change with a corresponding PR
1033             var editHash = CheckableRepository.appendAndCommit(localRepo);
1034             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
1035             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1036             pr.setBody(&quot;This is now ready&quot;);
1037 
1038             // Run an archive pass
1039             TestBotRunner.runPeriodicItems(mlBot);
1040 
1041             // First unapprove it
1042             var reviewedPr = reviewer.getPullRequest(pr.getId());
1043             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
1044             TestBotRunner.runPeriodicItems(mlBot);
1045             TestBotRunner.runPeriodicItems(mlBot);
1046             TestBotRunner.runPeriodicItems(mlBot);
1047 
1048             // The archive should contain a note
1049             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1050             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Disapproved by &quot;));
1051             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot; by integrationreviewer1&quot;));
1052             if (author.host().supportsReviewBody()) {
1053                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
1054             }
1055 
1056             // Then approve it
1057             reviewedPr.addReview(Review.Verdict.APPROVED, &quot;Reason 2&quot;);
1058             TestBotRunner.runPeriodicItems(mlBot);
1059             TestBotRunner.runPeriodicItems(mlBot);
1060             TestBotRunner.runPeriodicItems(mlBot);
1061 
1062             // The archive should contain another note
1063             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1064             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Approved by &quot;));
1065             if (author.host().supportsReviewBody()) {
1066                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 2&quot;));
1067             }
1068             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Re: \\[Approved\\] RFR:&quot;));
1069 
1070             // Yet another change
1071             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 3&quot;);
1072             TestBotRunner.runPeriodicItems(mlBot);
1073             TestBotRunner.runPeriodicItems(mlBot);
1074             TestBotRunner.runPeriodicItems(mlBot);
1075 
1076             // The archive should contain another note
1077             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1078             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Disapproved by &quot;));
1079             if (author.host().supportsReviewBody()) {
1080                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
1081             }
1082         }
1083     }
1084 
1085     @Test
1086     void ignoreComments(TestInfo testInfo) throws IOException {
1087         try (var credentials = new HostCredentials(testInfo);
1088              var tempFolder = new TemporaryDirectory();
1089              var archiveFolder = new TemporaryDirectory();
1090              var listServer = new TestMailmanServer()) {
1091             var author = credentials.getHostedRepository();
1092             var ignored = credentials.getHostedRepository();
1093             var archive = credentials.getHostedRepository();
1094             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1095             var censusBuilder = credentials.getCensusBuilder()
1096                                            .addAuthor(author.host().getCurrentUserDetails().id());
1097             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1098             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
1099                                                  listAddress,
1100                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
1101                                                  Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)),
1102                                                  listServer.getArchive(), listServer.getSMTP(),
1103                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
1104                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
1105                                                  Set.of(), Map.of(),
1106                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
1107                                                  Map.of());
1108 
1109             // Populate the projects repository
1110             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1111             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
1112             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1113             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
1114             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
1115 
1116             // Make a change with a corresponding PR
1117             var editHash = CheckableRepository.appendAndCommit(localRepo);
1118             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
1119             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1120             pr.setBody(&quot;This is now ready&quot;);
1121 
1122             // Make a bunch of comments
1123             pr.addComment(&quot;Plain comment&quot;);
1124             pr.addComment(&quot;ignore this comment&quot;);
1125             pr.addComment(&quot;I think it is time to\nignore this comment!&quot;);
1126             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review ignore this comment&quot;);
1127 
1128             var ignoredPR = ignored.getPullRequest(pr.getId());
1129             ignoredPR.addComment(&quot;Don&#39;t mind me&quot;);
1130 
1131             TestBotRunner.runPeriodicItems(mlBot);
1132             TestBotRunner.runPeriodicItems(mlBot);
1133 
1134             // The archive should not contain the ignored comments
1135             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1136             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
1137             assertFalse(archiveContains(archiveFolder.path(), &quot;ignore this comment&quot;));
1138             assertFalse(archiveContains(archiveFolder.path(), &quot;it is time to&quot;));
1139             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
1140             assertFalse(archiveContains(archiveFolder.path(), &quot;Review ignore&quot;));
1141         }
1142     }
1143 }
<a name="12" id="anc12"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="12" type="hidden" />
</body>
</html>