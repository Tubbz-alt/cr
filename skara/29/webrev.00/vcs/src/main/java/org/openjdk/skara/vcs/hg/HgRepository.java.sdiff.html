<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff vcs/src/main/java/org/openjdk/skara/vcs/hg/HgRepository.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../git/GitRepository.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/java/org/openjdk/skara/vcs/RepositoryTests.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>vcs/src/main/java/org/openjdk/skara/vcs/hg/HgRepository.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
378     }
379 
380     @Override
381     public void push(Branch branch, String remote, boolean setUpstream) throws IOException {
382         // ignore setUpstream, no such concept in Mercurial
383         try (var p = capture(&quot;hg&quot;, &quot;push&quot;, &quot;--branch&quot;, branch.name(), remote)) {
384             await(p);
385         }
386     }
387 
388     @Override
389     public boolean isClean() throws IOException {
390         try (var p = capture(&quot;hg&quot;, &quot;status&quot;)) {
391             var output = await(p);
392             return output.stdout().size() == 0;
393         }
394     }
395 
396     @Override
397     public boolean exists() throws IOException {




398         try {
399             root();
400             return true;
401         } catch (IOException e) {
402             return false;
403         }
404     }
405 
406     private void export(String revset, Path to) throws IOException {
407         var cmd = List.of(&quot;hg&quot;, &quot;export&quot;, &quot;--git&quot;, &quot;--rev&quot;, revset);
408         log.fine(&quot;Executing &quot; + String.join(&quot; &quot;, cmd));
409         var pb = new ProcessBuilder(cmd);
410         pb.directory(dir.toFile());
411         pb.redirectError(ProcessBuilder.Redirect.DISCARD);
412         pb.redirectOutput(to.toFile());
413         pb.environment().put(&quot;HGRCPATH&quot;, &quot;&quot;);
414         pb.environment().put(&quot;HGPLAIN&quot;, &quot;&quot;);
415         var p = pb.start();
416         try {
417             await(p);
</pre>
<hr />
<pre>
640         }
641         return heads;
642     }
643 
644     @Override
645     public List&lt;String&gt; config(String key) throws IOException {
646         // Do not use HgRepository.capture() here, want to run *with*
647         // hg configuration.
648         try (var p = Process.capture(&quot;hg&quot;, &quot;showconfig&quot;, key)
649                             .workdir(dir)
650                             .execute()) {
651             var res = p.await();
652             if (res.status() == 1) {
653                 return List.of();
654             }
655             return res.stdout();
656         }
657     }
658 
659     public static Optional&lt;Repository&gt; get(Path p) throws IOException {




660         var r = new HgRepository(p);
661         return r.exists() ? Optional.of(new HgRepository(r.root())) : Optional.empty();
662     }
663 
664     @Override
665     public Repository copyTo(Path destination) throws IOException {
666         var from = root().toAbsolutePath().toString();
667         var to = destination.toAbsolutePath().toString();
668         try (var p = capture(&quot;hg&quot;, &quot;clone&quot;, from, to)) {
669             await(p);
670         }
671 
672         return new HgRepository(destination.toAbsolutePath());
673     }
674 
675     @Override
676     public void merge(Hash h) throws IOException {
677         merge(h, null);
678     }
679 
</pre>
</td>
<td>
<hr />
<pre>
378     }
379 
380     @Override
381     public void push(Branch branch, String remote, boolean setUpstream) throws IOException {
382         // ignore setUpstream, no such concept in Mercurial
383         try (var p = capture(&quot;hg&quot;, &quot;push&quot;, &quot;--branch&quot;, branch.name(), remote)) {
384             await(p);
385         }
386     }
387 
388     @Override
389     public boolean isClean() throws IOException {
390         try (var p = capture(&quot;hg&quot;, &quot;status&quot;)) {
391             var output = await(p);
392             return output.stdout().size() == 0;
393         }
394     }
395 
396     @Override
397     public boolean exists() throws IOException {
<span class="line-added">398         if (!Files.exists(dir)) {</span>
<span class="line-added">399             return false;</span>
<span class="line-added">400         }</span>
<span class="line-added">401 </span>
402         try {
403             root();
404             return true;
405         } catch (IOException e) {
406             return false;
407         }
408     }
409 
410     private void export(String revset, Path to) throws IOException {
411         var cmd = List.of(&quot;hg&quot;, &quot;export&quot;, &quot;--git&quot;, &quot;--rev&quot;, revset);
412         log.fine(&quot;Executing &quot; + String.join(&quot; &quot;, cmd));
413         var pb = new ProcessBuilder(cmd);
414         pb.directory(dir.toFile());
415         pb.redirectError(ProcessBuilder.Redirect.DISCARD);
416         pb.redirectOutput(to.toFile());
417         pb.environment().put(&quot;HGRCPATH&quot;, &quot;&quot;);
418         pb.environment().put(&quot;HGPLAIN&quot;, &quot;&quot;);
419         var p = pb.start();
420         try {
421             await(p);
</pre>
<hr />
<pre>
644         }
645         return heads;
646     }
647 
648     @Override
649     public List&lt;String&gt; config(String key) throws IOException {
650         // Do not use HgRepository.capture() here, want to run *with*
651         // hg configuration.
652         try (var p = Process.capture(&quot;hg&quot;, &quot;showconfig&quot;, key)
653                             .workdir(dir)
654                             .execute()) {
655             var res = p.await();
656             if (res.status() == 1) {
657                 return List.of();
658             }
659             return res.stdout();
660         }
661     }
662 
663     public static Optional&lt;Repository&gt; get(Path p) throws IOException {
<span class="line-added">664         if (!Files.exists(p)) {</span>
<span class="line-added">665             return Optional.empty();</span>
<span class="line-added">666         }</span>
<span class="line-added">667 </span>
668         var r = new HgRepository(p);
669         return r.exists() ? Optional.of(new HgRepository(r.root())) : Optional.empty();
670     }
671 
672     @Override
673     public Repository copyTo(Path destination) throws IOException {
674         var from = root().toAbsolutePath().toString();
675         var to = destination.toAbsolutePath().toString();
676         try (var p = capture(&quot;hg&quot;, &quot;clone&quot;, from, to)) {
677             await(p);
678         }
679 
680         return new HgRepository(destination.toAbsolutePath());
681     }
682 
683     @Override
684     public void merge(Hash h) throws IOException {
685         merge(h, null);
686     }
687 
</pre>
</td>
</tr>
</table>
<center><a href="../git/GitRepository.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/java/org/openjdk/skara/vcs/RepositoryTests.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>