<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff vcs/src/test/java/org/openjdk/skara/vcs/RepositoryTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>vcs/src/test/java/org/openjdk/skara/vcs/RepositoryTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 299             assertTrue(patch.status().isAdded());
 300 
 301             assertTrue(patch.source().path().isEmpty());
 302             assertTrue(patch.source().type().isEmpty());
 303 
 304             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 305             assertTrue(patch.target().type().get().isRegularNonExecutable());
 306 
 307             var hunks = patch.hunks();
 308             assertEquals(1, hunks.size());
 309 
 310             var hunk = hunks.get(0);
 311             assertEquals(new Range(0, 0), hunk.source().range());
 312             assertEquals(new Range(1, 1), hunk.target().range());
 313 
 314             assertLinesEquals(List.of(), hunk.source().lines());
 315             assertLinesEquals(List.of(&quot;Hello, readme!&quot;), hunk.target().lines());
 316         }
 317     }
 318 




 319     static void assertLinesEquals(List&lt;String&gt; expected, List&lt;String&gt; actual) {
<span class="line-modified"> 320         var newLine = System.lineSeparator();</span>
<span class="line-removed"> 321         var suffix = newLine.endsWith(&quot;\n&quot;)</span>
<span class="line-removed"> 322                 ? newLine.substring(0, newLine.length() - 1) // drop trailing &#39;\n&#39; (keeping any &#39;\r&#39;)</span>
<span class="line-removed"> 323                 : newLine;</span>
<span class="line-removed"> 324         assertEquals(expected.stream().map(l -&gt; l + suffix).collect(Collectors.toList()), actual);</span>
 325     }
 326 
 327     @ParameterizedTest
 328     @EnumSource(VCS.class)
 329     void testCommitListingWithMultipleCommits(VCS vcs) throws IOException {
 330         try (var dir = new TemporaryDirectory()) {
 331             var r = Repository.init(dir.path(), vcs);
 332 
 333             var readme = dir.path().resolve(&quot;README&quot;);
 334             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 335 
 336             r.add(readme);
 337             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 338 
 339             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 340             r.add(readme);
 341             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 342 
 343             var commits = r.commits().asList();
 344             assertEquals(2, commits.size());
</pre>
<hr />
<pre>
1674             r.add(f);
1675             var initial = r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1676 
1677             var f2 = dir.path().resolve(&quot;CONTRIBUTING&quot;);
1678             Files.writeString(f2, &quot;Goodbye\n&quot;);
1679             r.add(f2);
1680             var second = r.commit(&quot;Second commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1681 
1682             var entries = r.status(initial, second);
1683             assertEquals(1, entries.size());
1684             var entry = entries.get(0);
1685             assertTrue(entry.status().isAdded());
1686             assertTrue(entry.source().path().isEmpty());
1687             assertTrue(entry.source().type().isEmpty());
1688 
1689             assertTrue(entry.target().path().isPresent());
1690             assertEquals(Path.of(&quot;CONTRIBUTING&quot;), entry.target().path().get());
1691             assertTrue(entry.target().type().get().isRegular());
1692         }
1693     }














































1694 }
</pre>
</td>
<td>
<hr />
<pre>
 299             assertTrue(patch.status().isAdded());
 300 
 301             assertTrue(patch.source().path().isEmpty());
 302             assertTrue(patch.source().type().isEmpty());
 303 
 304             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 305             assertTrue(patch.target().type().get().isRegularNonExecutable());
 306 
 307             var hunks = patch.hunks();
 308             assertEquals(1, hunks.size());
 309 
 310             var hunk = hunks.get(0);
 311             assertEquals(new Range(0, 0), hunk.source().range());
 312             assertEquals(new Range(1, 1), hunk.target().range());
 313 
 314             assertLinesEquals(List.of(), hunk.source().lines());
 315             assertLinesEquals(List.of(&quot;Hello, readme!&quot;), hunk.target().lines());
 316         }
 317     }
 318 
<span class="line-added"> 319     static String stripTrailingCR(String line) {</span>
<span class="line-added"> 320         return line.endsWith(&quot;\r&quot;) ? line.substring(0, line.length() - 1) : line;</span>
<span class="line-added"> 321     }</span>
<span class="line-added"> 322 </span>
 323     static void assertLinesEquals(List&lt;String&gt; expected, List&lt;String&gt; actual) {
<span class="line-modified"> 324         assertEquals(expected, actual.stream().map(RepositoryTests::stripTrailingCR).collect(Collectors.toList()));</span>




 325     }
 326 
 327     @ParameterizedTest
 328     @EnumSource(VCS.class)
 329     void testCommitListingWithMultipleCommits(VCS vcs) throws IOException {
 330         try (var dir = new TemporaryDirectory()) {
 331             var r = Repository.init(dir.path(), vcs);
 332 
 333             var readme = dir.path().resolve(&quot;README&quot;);
 334             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 335 
 336             r.add(readme);
 337             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 338 
 339             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 340             r.add(readme);
 341             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 342 
 343             var commits = r.commits().asList();
 344             assertEquals(2, commits.size());
</pre>
<hr />
<pre>
1674             r.add(f);
1675             var initial = r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1676 
1677             var f2 = dir.path().resolve(&quot;CONTRIBUTING&quot;);
1678             Files.writeString(f2, &quot;Goodbye\n&quot;);
1679             r.add(f2);
1680             var second = r.commit(&quot;Second commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1681 
1682             var entries = r.status(initial, second);
1683             assertEquals(1, entries.size());
1684             var entry = entries.get(0);
1685             assertTrue(entry.status().isAdded());
1686             assertTrue(entry.source().path().isEmpty());
1687             assertTrue(entry.source().type().isEmpty());
1688 
1689             assertTrue(entry.target().path().isPresent());
1690             assertEquals(Path.of(&quot;CONTRIBUTING&quot;), entry.target().path().get());
1691             assertTrue(entry.target().type().get().isRegular());
1692         }
1693     }
<span class="line-added">1694 </span>
<span class="line-added">1695     @ParameterizedTest</span>
<span class="line-added">1696     @EnumSource(VCS.class)</span>
<span class="line-added">1697     void testTrackLineEndings(VCS vcs) throws IOException, InterruptedException {</span>
<span class="line-added">1698         try (var dir = new TemporaryDirectory()) {</span>
<span class="line-added">1699             var r = Repository.init(dir.path(), vcs);</span>
<span class="line-added">1700             if (vcs == VCS.GIT) { // turn of git&#39;s meddling</span>
<span class="line-added">1701                 int exitCode = new ProcessBuilder()</span>
<span class="line-added">1702                         .command(&quot;git&quot;, &quot;config&quot;, &quot;--local&quot;, &quot;core.autocrlf&quot;, &quot;false&quot;)</span>
<span class="line-added">1703                         .directory(dir.path().toFile())</span>
<span class="line-added">1704                         .start()</span>
<span class="line-added">1705                         .waitFor();</span>
<span class="line-added">1706                 assertEquals(0, exitCode);</span>
<span class="line-added">1707             }</span>
<span class="line-added">1708 </span>
<span class="line-added">1709             var readme = dir.path().resolve(&quot;README&quot;);</span>
<span class="line-added">1710             Files.writeString(readme, &quot;Line with Unix line ending\n&quot;);</span>
<span class="line-added">1711             Files.writeString(readme, &quot;Line with Windows line ending\r\n&quot;, APPEND);</span>
<span class="line-added">1712 </span>
<span class="line-added">1713             r.add(readme);</span>
<span class="line-added">1714             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);</span>
<span class="line-added">1715 </span>
<span class="line-added">1716             var commits = r.commits().asList();</span>
<span class="line-added">1717             assertEquals(1, commits.size());</span>
<span class="line-added">1718 </span>
<span class="line-added">1719             var commit = commits.get(0);</span>
<span class="line-added">1720             var diffs = commit.parentDiffs();</span>
<span class="line-added">1721             var diff = diffs.get(0);</span>
<span class="line-added">1722             assertEquals(2, diff.added());</span>
<span class="line-added">1723 </span>
<span class="line-added">1724             var patches = diff.patches();</span>
<span class="line-added">1725             assertEquals(1, patches.size());</span>
<span class="line-added">1726 </span>
<span class="line-added">1727             var patch = patches.get(0).asTextualPatch();</span>
<span class="line-added">1728             var hunks = patch.hunks();</span>
<span class="line-added">1729             assertEquals(1, hunks.size());</span>
<span class="line-added">1730 </span>
<span class="line-added">1731             var hunk = hunks.get(0);</span>
<span class="line-added">1732             assertEquals(new Range(0, 0), hunk.source().range());</span>
<span class="line-added">1733             assertEquals(new Range(1, 2), hunk.target().range());</span>
<span class="line-added">1734 </span>
<span class="line-added">1735             assertEquals(</span>
<span class="line-added">1736                     List.of(&quot;Line with Unix line ending&quot;, &quot;Line with Windows line ending\r&quot;),</span>
<span class="line-added">1737                     hunk.target().lines());</span>
<span class="line-added">1738         }</span>
<span class="line-added">1739     }</span>
1740 }
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>