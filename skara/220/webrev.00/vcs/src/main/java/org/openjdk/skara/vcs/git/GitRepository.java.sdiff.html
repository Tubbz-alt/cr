<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff vcs/src/main/java/org/openjdk/skara/vcs/git/GitRepository.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>vcs/src/main/java/org/openjdk/skara/vcs/git/GitRepository.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 294             p.await(); // Don&#39;t care about the result.
 295         }
 296     }
 297 
 298     @Override
 299     public void reset(Hash target, boolean hard) throws IOException {
 300         var cmd = new ArrayList&lt;&gt;(List.of(&quot;git&quot;, &quot;reset&quot;));
 301         if (hard) {
 302            cmd.add(&quot;--hard&quot;);
 303         }
 304         cmd.add(target.hex());
 305 
 306         try (var p = capture(cmd)) {
 307             await(p);
 308         }
 309     }
 310 
 311 
 312     @Override
 313     public void revert(Hash h) throws IOException {
<span class="line-modified"> 314         try (var p = capture(&quot;git&quot;, &quot;checkout&quot;, h.hex(), &quot;--&quot;, &quot;.&quot;)) {</span>
 315             await(p);
 316         }
 317     }
 318 
 319     @Override
 320     public Repository reinitialize() throws IOException {
 321         cachedRoot = null;
 322 
 323         Files.walk(dir)
 324              .map(Path::toFile)
 325              .sorted(Comparator.reverseOrder())
 326              .forEach(File::delete);
 327 
 328         return init();
 329     }
 330 
 331     @Override
 332     public Hash fetch(URI uri, String refspec) throws IOException {
 333         try (var p = capture(&quot;git&quot;, &quot;fetch&quot;, &quot;--tags&quot;, uri.toString(), refspec)) {
 334             await(p);
 335             return resolve(&quot;FETCH_HEAD&quot;).get();
 336         }
 337     }
 338 
 339     @Override
 340     public void fetchAll() throws IOException {
 341         try (var p = capture(&quot;git&quot;, &quot;fetch&quot;, &quot;--tags&quot;, &quot;--prune&quot;, &quot;--prune-tags&quot;, &quot;--all&quot;)) {
 342             await(p);
 343         }
 344     }
 345 
 346     private void checkout(String ref, boolean force) throws IOException {
 347         var cmd = new ArrayList&lt;String&gt;();
<span class="line-modified"> 348         cmd.addAll(List.of(&quot;git&quot;, &quot;-c&quot;, &quot;advice.detachedHead=false&quot;, &quot;checkout&quot;));</span>
 349         if (force) {
 350             cmd.add(&quot;--force&quot;);
 351         }
 352         cmd.add(ref);
 353         try (var p = capture(cmd)) {
 354             await(p);
 355         }
 356     }
 357 
 358     @Override
 359     public void checkout(Hash h, boolean force) throws IOException {
 360         checkout(h.hex(), force);
 361     }
 362 
 363     @Override
 364     public void checkout(Branch b, boolean force) throws IOException {
 365         checkout(b.name(), force);
 366     }
 367 
 368     @Override
</pre>
<hr />
<pre>
 856             return res.status() == 0 ? res.stdout() : List.of();
 857         }
 858     }
 859 
 860     @Override
 861     public Hash head() throws IOException {
 862         return resolve(&quot;HEAD&quot;).orElseThrow(() -&gt; new IllegalStateException(&quot;HEAD ref is not present&quot;));
 863     }
 864 
 865     public static Optional&lt;Repository&gt; get(Path p) throws IOException {
 866         if (!Files.exists(p)) {
 867             return Optional.empty();
 868         }
 869 
 870         var r = new GitRepository(p);
 871         return r.exists() ? Optional.of(new GitRepository(r.root())) : Optional.empty();
 872     }
 873 
 874     @Override
 875     public Repository copyTo(Path destination) throws IOException {
<span class="line-modified"> 876         try (var p = capture(&quot;git&quot;, &quot;clone&quot;, root().toString(), destination.toString())) {</span>
 877             await(p);
 878         }
 879 
 880         return new GitRepository(destination);
 881     }
 882 
 883     @Override
 884     public void merge(Hash h) throws IOException {
 885         merge(h, null);
 886     }
 887 
 888     @Override
 889     public void merge(Hash h, String strategy) throws IOException {
 890         var cmd = new ArrayList&lt;String&gt;();
 891         cmd.addAll(List.of(&quot;git&quot;, &quot;-c&quot;, &quot;user.name=unused&quot;, &quot;-c&quot;, &quot;user.email=unused&quot;,
 892                            &quot;merge&quot;, &quot;--no-commit&quot;));
 893         if (strategy != null) {
 894             cmd.add(&quot;-s&quot;);
 895             cmd.add(strategy);
 896         }
</pre>
<hr />
<pre>
 992     @Override
 993     public void move(Path from, Path to) throws IOException {
 994         try (var p = capture(&quot;git&quot;, &quot;mv&quot;, from.toString(), to.toString())) {
 995             await(p);
 996         }
 997     }
 998 
 999     @Override
1000     public Optional&lt;String&gt; upstreamFor(Branch b) throws IOException {
1001         try (var p = capture(&quot;git&quot;, &quot;for-each-ref&quot;, &quot;--format=%(upstream:short)&quot;, &quot;refs/heads/&quot; + b.name())) {
1002             var lines = await(p).stdout();
1003             return lines.size() == 1 &amp;&amp; !lines.get(0).isEmpty()? Optional.of(lines.get(0)) : Optional.empty();
1004         }
1005     }
1006 
1007     public static Repository clone(URI from, Path to, boolean isBare) throws IOException {
1008         var cmd = new ArrayList&lt;String&gt;();
1009         cmd.addAll(List.of(&quot;git&quot;, &quot;clone&quot;));
1010         if (isBare) {
1011             cmd.add(&quot;--bare&quot;);


1012         }
1013         cmd.addAll(List.of(from.toString(), to.toString()));
1014         try (var p = capture(Path.of(&quot;&quot;).toAbsolutePath(), cmd)) {
1015             await(p);
1016         }
1017         return new GitRepository(to);
1018     }
1019 
1020     public static Repository mirror(URI from, Path to) throws IOException {
1021         var cwd = Path.of(&quot;&quot;).toAbsolutePath();
1022         try (var p = capture(cwd, &quot;git&quot;, &quot;clone&quot;, &quot;--mirror&quot;, from.toString(), to.toString())) {
1023             await(p);
1024         }
1025         return new GitRepository(to);
1026     }
1027 
1028     @Override
1029     public void pull() throws IOException {
1030         pull(null, null);
1031     }
</pre>
</td>
<td>
<hr />
<pre>
 294             p.await(); // Don&#39;t care about the result.
 295         }
 296     }
 297 
 298     @Override
 299     public void reset(Hash target, boolean hard) throws IOException {
 300         var cmd = new ArrayList&lt;&gt;(List.of(&quot;git&quot;, &quot;reset&quot;));
 301         if (hard) {
 302            cmd.add(&quot;--hard&quot;);
 303         }
 304         cmd.add(target.hex());
 305 
 306         try (var p = capture(cmd)) {
 307             await(p);
 308         }
 309     }
 310 
 311 
 312     @Override
 313     public void revert(Hash h) throws IOException {
<span class="line-modified"> 314         try (var p = capture(&quot;git&quot;, &quot;checkout&quot;, &quot;--recurse-submodules&quot;, h.hex(), &quot;--&quot;, &quot;.&quot;)) {</span>
 315             await(p);
 316         }
 317     }
 318 
 319     @Override
 320     public Repository reinitialize() throws IOException {
 321         cachedRoot = null;
 322 
 323         Files.walk(dir)
 324              .map(Path::toFile)
 325              .sorted(Comparator.reverseOrder())
 326              .forEach(File::delete);
 327 
 328         return init();
 329     }
 330 
 331     @Override
 332     public Hash fetch(URI uri, String refspec) throws IOException {
 333         try (var p = capture(&quot;git&quot;, &quot;fetch&quot;, &quot;--tags&quot;, uri.toString(), refspec)) {
 334             await(p);
 335             return resolve(&quot;FETCH_HEAD&quot;).get();
 336         }
 337     }
 338 
 339     @Override
 340     public void fetchAll() throws IOException {
 341         try (var p = capture(&quot;git&quot;, &quot;fetch&quot;, &quot;--tags&quot;, &quot;--prune&quot;, &quot;--prune-tags&quot;, &quot;--all&quot;)) {
 342             await(p);
 343         }
 344     }
 345 
 346     private void checkout(String ref, boolean force) throws IOException {
 347         var cmd = new ArrayList&lt;String&gt;();
<span class="line-modified"> 348         cmd.addAll(List.of(&quot;git&quot;, &quot;-c&quot;, &quot;advice.detachedHead=false&quot;, &quot;checkout&quot;, &quot;--recurse-submodules&quot;));</span>
 349         if (force) {
 350             cmd.add(&quot;--force&quot;);
 351         }
 352         cmd.add(ref);
 353         try (var p = capture(cmd)) {
 354             await(p);
 355         }
 356     }
 357 
 358     @Override
 359     public void checkout(Hash h, boolean force) throws IOException {
 360         checkout(h.hex(), force);
 361     }
 362 
 363     @Override
 364     public void checkout(Branch b, boolean force) throws IOException {
 365         checkout(b.name(), force);
 366     }
 367 
 368     @Override
</pre>
<hr />
<pre>
 856             return res.status() == 0 ? res.stdout() : List.of();
 857         }
 858     }
 859 
 860     @Override
 861     public Hash head() throws IOException {
 862         return resolve(&quot;HEAD&quot;).orElseThrow(() -&gt; new IllegalStateException(&quot;HEAD ref is not present&quot;));
 863     }
 864 
 865     public static Optional&lt;Repository&gt; get(Path p) throws IOException {
 866         if (!Files.exists(p)) {
 867             return Optional.empty();
 868         }
 869 
 870         var r = new GitRepository(p);
 871         return r.exists() ? Optional.of(new GitRepository(r.root())) : Optional.empty();
 872     }
 873 
 874     @Override
 875     public Repository copyTo(Path destination) throws IOException {
<span class="line-modified"> 876         try (var p = capture(&quot;git&quot;, &quot;clone&quot;, &quot;--recurse-submodules&quot;, root().toString(), destination.toString())) {</span>
 877             await(p);
 878         }
 879 
 880         return new GitRepository(destination);
 881     }
 882 
 883     @Override
 884     public void merge(Hash h) throws IOException {
 885         merge(h, null);
 886     }
 887 
 888     @Override
 889     public void merge(Hash h, String strategy) throws IOException {
 890         var cmd = new ArrayList&lt;String&gt;();
 891         cmd.addAll(List.of(&quot;git&quot;, &quot;-c&quot;, &quot;user.name=unused&quot;, &quot;-c&quot;, &quot;user.email=unused&quot;,
 892                            &quot;merge&quot;, &quot;--no-commit&quot;));
 893         if (strategy != null) {
 894             cmd.add(&quot;-s&quot;);
 895             cmd.add(strategy);
 896         }
</pre>
<hr />
<pre>
 992     @Override
 993     public void move(Path from, Path to) throws IOException {
 994         try (var p = capture(&quot;git&quot;, &quot;mv&quot;, from.toString(), to.toString())) {
 995             await(p);
 996         }
 997     }
 998 
 999     @Override
1000     public Optional&lt;String&gt; upstreamFor(Branch b) throws IOException {
1001         try (var p = capture(&quot;git&quot;, &quot;for-each-ref&quot;, &quot;--format=%(upstream:short)&quot;, &quot;refs/heads/&quot; + b.name())) {
1002             var lines = await(p).stdout();
1003             return lines.size() == 1 &amp;&amp; !lines.get(0).isEmpty()? Optional.of(lines.get(0)) : Optional.empty();
1004         }
1005     }
1006 
1007     public static Repository clone(URI from, Path to, boolean isBare) throws IOException {
1008         var cmd = new ArrayList&lt;String&gt;();
1009         cmd.addAll(List.of(&quot;git&quot;, &quot;clone&quot;));
1010         if (isBare) {
1011             cmd.add(&quot;--bare&quot;);
<span class="line-added">1012         } else {</span>
<span class="line-added">1013             cmd.add(&quot;--recurse-submodules&quot;);</span>
1014         }
1015         cmd.addAll(List.of(from.toString(), to.toString()));
1016         try (var p = capture(Path.of(&quot;&quot;).toAbsolutePath(), cmd)) {
1017             await(p);
1018         }
1019         return new GitRepository(to);
1020     }
1021 
1022     public static Repository mirror(URI from, Path to) throws IOException {
1023         var cwd = Path.of(&quot;&quot;).toAbsolutePath();
1024         try (var p = capture(cwd, &quot;git&quot;, &quot;clone&quot;, &quot;--mirror&quot;, from.toString(), to.toString())) {
1025             await(p);
1026         }
1027         return new GitRepository(to);
1028     }
1029 
1030     @Override
1031     public void pull() throws IOException {
1032         pull(null, null);
1033     }
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>