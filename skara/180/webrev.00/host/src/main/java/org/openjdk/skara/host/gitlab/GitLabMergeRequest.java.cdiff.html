<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff host/src/main/java/org/openjdk/skara/host/gitlab/GitLabMergeRequest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../github/GitHubPullRequest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>host/src/main/java/org/openjdk/skara/host/gitlab/GitLabMergeRequest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 362,119 ***</span>
                  .filter(entry -&gt; entry.getValue().find())
                  .collect(Collectors.toMap(entry -&gt; entry.getValue().group(1),
                          entry -&gt; {
                              var checkBuilder = CheckBuilder.create(entry.getValue().group(1), hash);
                              checkBuilder.startedAt(entry.getKey().createdAt());
<span class="line-modified">!                             if (!entry.getValue().group(2).equals(&quot;RUNNING&quot;)) {</span>
<span class="line-modified">!                                 checkBuilder.complete(entry.getValue().group(2).equals(&quot;SUCCESS&quot;), entry.getKey().updatedAt());</span>
                              }
                              if (!entry.getValue().group(3).equals(&quot;NONE&quot;)) {
                                  checkBuilder.metadata(new String(Base64.getDecoder().decode(entry.getValue().group(3)), StandardCharsets.UTF_8));
                              }
                              var checkBodyMatcher = checkBodyPattern.matcher(entry.getKey().body());
                              if (checkBodyMatcher.find()) {
<span class="line-modified">!                                 checkBuilder.title(checkBodyMatcher.group(1));</span>
                                  checkBuilder.summary(checkBodyMatcher.group(2));
                              }
                              return checkBuilder.build();
                          }));
      }
  
<span class="line-modified">!     @Override</span>
<span class="line-modified">!     public void createCheck(Check check) {</span>
<span class="line-modified">!         log.info(&quot;Looking for previous status check comment&quot;);</span>
  
<span class="line-modified">!         var previous = getStatusCheckComment(check.name());</span>
<span class="line-removed">-         var body = &quot;:hourglass_flowing_sand: The merge request check **&quot; + check.name() + &quot;** is currently running...&quot;;</span>
<span class="line-removed">-         var metadata = &quot;NONE&quot;;</span>
          if (check.metadata().isPresent()) {
<span class="line-modified">!             metadata = Base64.getEncoder().encodeToString(check.metadata().get().getBytes(StandardCharsets.UTF_8));</span>
          }
<span class="line-modified">!         var message = String.format(checkMarker, check.name()) + &quot;\n&quot; +</span>
<span class="line-removed">-                 String.format(checkResultMarker,</span>
<span class="line-removed">-                         check.name(),</span>
<span class="line-removed">-                         &quot;RUNNING&quot;,</span>
<span class="line-removed">-                         check.hash(),</span>
<span class="line-removed">-                         metadata</span>
<span class="line-removed">-                         ) + &quot;\n&quot; + encodeMarkdown(body);</span>
<span class="line-removed">- </span>
<span class="line-removed">-         previous.ifPresentOrElse(p -&gt; updateComment(p.id(), message),</span>
<span class="line-removed">-                 () -&gt; addComment(message));</span>
      }
  
      private String linkToDiff(String path, Hash hash, int line) {
          return &quot;[&quot; + path + &quot; line &quot; + line + &quot;](&quot; + URIBuilder.base(repository.getUrl())
                           .setPath(&quot;/&quot; + repository.getName()+ &quot;/blob/&quot; + hash.hex() + &quot;/&quot; + path)
                           .setAuthentication(null)
                           .build() + &quot;#L&quot; + Integer.toString(line) + &quot;)&quot;;
      }
  
<span class="line-modified">!     @Override</span>
<span class="line-modified">!     public void updateCheck(Check check) {</span>
<span class="line-modified">!         log.info(&quot;Looking for previous status check comment&quot;);</span>
<span class="line-modified">! </span>
<span class="line-removed">-         var previous = getStatusCheckComment(check.name())</span>
<span class="line-removed">-                 .orElseGet(() -&gt; addComment(&quot;Progress deleted?&quot;));</span>
<span class="line-removed">- </span>
<span class="line-removed">-         String status;</span>
<span class="line-removed">-         switch (check.status()) {</span>
              case IN_PROGRESS:
<span class="line-modified">!                 status = &quot;RUNNING&quot;;</span>
                  break;
              case SUCCESS:
<span class="line-modified">!                 status = &quot;SUCCESS&quot;;</span>
                  break;
              case FAILURE:
<span class="line-modified">!                 status = &quot;FAILURE&quot;;</span>
                  break;
              default:
                  throw new RuntimeException(&quot;Unknown check status&quot;);
          }
  
<span class="line-modified">!         var metadata = &quot;NONE&quot;;</span>
<span class="line-modified">!         if (check.metadata().isPresent()) {</span>
<span class="line-modified">!             metadata = Base64.getEncoder().encodeToString(check.metadata().get().getBytes(StandardCharsets.UTF_8));</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         var markers = String.format(checkMarker, check.name()) + &quot;\n&quot; + String.format(checkResultMarker, check.name(),</span>
<span class="line-modified">!                 status, check.hash(), metadata);</span>
<span class="line-modified">! </span>
<span class="line-modified">!         String body;</span>
<span class="line-modified">!         if (check.status() == CheckStatus.SUCCESS) {</span>
<span class="line-modified">!             body = &quot;:tada: The merge request check **&quot; + check.name() + &quot;** completed successfully!&quot;;</span>
<span class="line-modified">!         } else {</span>
<span class="line-modified">!             if (check.status() == CheckStatus.IN_PROGRESS) {</span>
<span class="line-modified">!                 body = &quot;:hourglass_flowing_sand: The merge request check **&quot; + check.name() + &quot;** is currently running...&quot;;</span>
<span class="line-modified">!             } else {</span>
<span class="line-modified">!                 body = &quot;:warning: The merge request check **&quot; + check.name() + &quot;** identified the following issues:&quot;;</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-             if (check.title().isPresent() &amp;&amp; check.summary().isPresent()) {</span>
<span class="line-removed">-                 body += encodeMarkdown(&quot;\n&quot; + &quot;##### &quot; + check.title().get() + &quot;\n&quot; + check.summary().get());</span>
<span class="line-removed">- </span>
<span class="line-removed">-                 for (var annotation : check.annotations()) {</span>
<span class="line-removed">-                     var annotationString = &quot;  - &quot;;</span>
<span class="line-removed">-                     switch (annotation.level()) {</span>
<span class="line-removed">-                         case NOTICE:</span>
<span class="line-removed">-                             annotationString += &quot;Notice: &quot;;</span>
<span class="line-removed">-                             break;</span>
<span class="line-removed">-                         case WARNING:</span>
<span class="line-removed">-                             annotationString += &quot;Warning: &quot;;</span>
<span class="line-removed">-                             break;</span>
<span class="line-removed">-                         case FAILURE:</span>
<span class="line-removed">-                             annotationString += &quot;Failure: &quot;;</span>
<span class="line-removed">-                             break;</span>
<span class="line-removed">-                     }</span>
<span class="line-removed">-                     annotationString += linkToDiff(annotation.path(), check.hash(), annotation.startLine());</span>
<span class="line-removed">-                     annotationString += &quot;\n    - &quot; + annotation.message().lines().collect(Collectors.joining(&quot;\n    - &quot;));</span>
<span class="line-removed">- </span>
<span class="line-removed">-                     body += &quot;\n&quot; + annotationString;</span>
                  }
              }
          }
  
<span class="line-modified">!         updateComment(previous.id(), markers + &quot;\n&quot; + body);</span>
      }
  
      @Override
      public void setState(State state) {
          request.put(&quot;&quot;)
                 .body(&quot;state_event&quot;, state == State.CLOSED ? &quot;close&quot; : &quot;reopen&quot;)
                 .execute();
<span class="line-new-header">--- 362,153 ---</span>
                  .filter(entry -&gt; entry.getValue().find())
                  .collect(Collectors.toMap(entry -&gt; entry.getValue().group(1),
                          entry -&gt; {
                              var checkBuilder = CheckBuilder.create(entry.getValue().group(1), hash);
                              checkBuilder.startedAt(entry.getKey().createdAt());
<span class="line-modified">!                             var status = entry.getValue().group(2);</span>
<span class="line-modified">!                             var completedAt = entry.getKey().updatedAt();</span>
<span class="line-added">+                             switch (status) {</span>
<span class="line-added">+                                 case &quot;RUNNING&quot;:</span>
<span class="line-added">+                                     // do nothing</span>
<span class="line-added">+                                     break;</span>
<span class="line-added">+                                 case &quot;SUCCESS&quot;:</span>
<span class="line-added">+                                     checkBuilder.complete(true, completedAt);</span>
<span class="line-added">+                                     break;</span>
<span class="line-added">+                                 case &quot;FAILURE&quot;:</span>
<span class="line-added">+                                     checkBuilder.complete(false, completedAt);</span>
<span class="line-added">+                                     break;</span>
<span class="line-added">+                                 case &quot;CANCELLED&quot;:</span>
<span class="line-added">+                                     checkBuilder.cancel(completedAt);</span>
<span class="line-added">+                                     break;</span>
<span class="line-added">+                                 default:</span>
<span class="line-added">+                                     throw new IllegalStateException(&quot;Unknown status: &quot; + status);</span>
                              }
                              if (!entry.getValue().group(3).equals(&quot;NONE&quot;)) {
                                  checkBuilder.metadata(new String(Base64.getDecoder().decode(entry.getValue().group(3)), StandardCharsets.UTF_8));
                              }
                              var checkBodyMatcher = checkBodyPattern.matcher(entry.getKey().body());
                              if (checkBodyMatcher.find()) {
<span class="line-modified">!                                 // escapeMarkdown adds an additional space before the newline</span>
<span class="line-added">+                                 var title = checkBodyMatcher.group(1);</span>
<span class="line-added">+                                 var nonEscapedTitle = title.substring(0, title.length() - 2);</span>
<span class="line-added">+                                 checkBuilder.title(nonEscapedTitle);</span>
                                  checkBuilder.summary(checkBodyMatcher.group(2));
                              }
                              return checkBuilder.build();
                          }));
      }
  
<span class="line-modified">!     private String statusFor(Check check) {</span>
<span class="line-modified">!         switch (check.status()) {</span>
<span class="line-modified">!             case IN_PROGRESS:</span>
<span class="line-added">+                 return &quot;RUNNING&quot;;</span>
<span class="line-added">+             case SUCCESS:</span>
<span class="line-added">+                 return &quot;SUCCESS&quot;;</span>
<span class="line-added">+             case FAILURE:</span>
<span class="line-added">+                 return &quot;FAILURE&quot;;</span>
<span class="line-added">+             case CANCELLED:</span>
<span class="line-added">+                 return &quot;CANCELLED&quot;;</span>
<span class="line-added">+             default:</span>
<span class="line-added">+                 throw new RuntimeException(&quot;Unknown check status&quot;);</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
  
<span class="line-modified">!     private String metadataFor(Check check) {</span>
          if (check.metadata().isPresent()) {
<span class="line-modified">!             return Base64.getEncoder().encodeToString(check.metadata().get().getBytes(StandardCharsets.UTF_8));</span>
          }
<span class="line-modified">!         return &quot;NONE&quot;;</span>
      }
  
      private String linkToDiff(String path, Hash hash, int line) {
          return &quot;[&quot; + path + &quot; line &quot; + line + &quot;](&quot; + URIBuilder.base(repository.getUrl())
                           .setPath(&quot;/&quot; + repository.getName()+ &quot;/blob/&quot; + hash.hex() + &quot;/&quot; + path)
                           .setAuthentication(null)
                           .build() + &quot;#L&quot; + Integer.toString(line) + &quot;)&quot;;
      }
  
<span class="line-modified">!     private String bodyFor(Check check) {</span>
<span class="line-modified">!         var status = check.status();</span>
<span class="line-modified">!         String body;</span>
<span class="line-modified">!         switch (status) {</span>
              case IN_PROGRESS:
<span class="line-modified">!                 body = &quot;:hourglass_flowing_sand: The merge request check **&quot; + check.name() + &quot;** is currently running...&quot;;</span>
                  break;
              case SUCCESS:
<span class="line-modified">!                 body = &quot;:tada: The merge request check **&quot; + check.name() + &quot;** completed successfully!&quot;;</span>
                  break;
              case FAILURE:
<span class="line-modified">!                 body = &quot;:warning: The merge request check **&quot; + check.name() + &quot;** identified the following issues:&quot;;</span>
<span class="line-added">+                 break;</span>
<span class="line-added">+             case CANCELLED:</span>
<span class="line-added">+                 body = &quot;:x: The merge request check **&quot; + check.name() + &quot;** has been cancelled&quot;;</span>
                  break;
              default:
                  throw new RuntimeException(&quot;Unknown check status&quot;);
          }
  
<span class="line-modified">!         if ( check.title().isPresent() &amp;&amp; check.summary().isPresent()) {</span>
<span class="line-modified">!             body += encodeMarkdown(&quot;\n&quot; + &quot;##### &quot; + check.title().get() + &quot;\n&quot; + check.summary().get());</span>
<span class="line-modified">! </span>
<span class="line-modified">!             for (var annotation : check.annotations()) {</span>
<span class="line-modified">!                 var annotationString = &quot;  - &quot;;</span>
<span class="line-modified">!                 switch (annotation.level()) {</span>
<span class="line-modified">!                     case NOTICE:</span>
<span class="line-modified">!                         annotationString += &quot;Notice: &quot;;</span>
<span class="line-modified">!                         break;</span>
<span class="line-modified">!                     case WARNING:</span>
<span class="line-modified">!                         annotationString += &quot;Warning: &quot;;</span>
<span class="line-modified">!                         break;</span>
<span class="line-modified">!                     case FAILURE:</span>
<span class="line-modified">!                         annotationString += &quot;Failure: &quot;;</span>
<span class="line-modified">!                         break;</span>
                  }
<span class="line-added">+                 annotationString += linkToDiff(annotation.path(), check.hash(), annotation.startLine());</span>
<span class="line-added">+                 annotationString += &quot;\n    - &quot; + annotation.message().lines().collect(Collectors.joining(&quot;\n    - &quot;));</span>
<span class="line-added">+ </span>
<span class="line-added">+                 body += &quot;\n&quot; + annotationString;</span>
              }
          }
  
<span class="line-modified">!         return body;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     private void updateCheckComment(Optional&lt;Comment&gt; previous, Check check) {</span>
<span class="line-added">+         var status = statusFor(check);</span>
<span class="line-added">+         var metadata = metadataFor(check);</span>
<span class="line-added">+         var markers = String.format(checkMarker, check.name()) + &quot;\n&quot; +</span>
<span class="line-added">+                       String.format(checkResultMarker,</span>
<span class="line-added">+                                     check.name(),</span>
<span class="line-added">+                                     status,</span>
<span class="line-added">+                                     check.hash(),</span>
<span class="line-added">+                                     metadata);</span>
<span class="line-added">+ </span>
<span class="line-added">+         var body = bodyFor(check);</span>
<span class="line-added">+         var message = markers + &quot;\n&quot; + body;</span>
<span class="line-added">+         previous.ifPresentOrElse(</span>
<span class="line-added">+                 p  -&gt; updateComment(p.id(), message),</span>
<span class="line-added">+                 () -&gt; addComment(message));</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     @Override</span>
<span class="line-added">+     public void createCheck(Check check) {</span>
<span class="line-added">+         log.info(&quot;Looking for previous status check comment&quot;);</span>
<span class="line-added">+ </span>
<span class="line-added">+         var previous = getStatusCheckComment(check.name());</span>
<span class="line-added">+         updateCheckComment(previous, check);</span>
      }
  
<span class="line-added">+     @Override</span>
<span class="line-added">+     public void updateCheck(Check check) {</span>
<span class="line-added">+         log.info(&quot;Looking for previous status check comment&quot;);</span>
<span class="line-added">+ </span>
<span class="line-added">+         var previous = getStatusCheckComment(check.name())</span>
<span class="line-added">+                 .orElseGet(() -&gt; addComment(&quot;Progress deleted?&quot;));</span>
<span class="line-added">+         updateCheckComment(Optional.of(previous), check);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+ </span>
      @Override
      public void setState(State state) {
          request.put(&quot;&quot;)
                 .body(&quot;state_event&quot;, state == State.CLOSED ? &quot;close&quot; : &quot;reopen&quot;)
                 .execute();
</pre>
<center><a href="../github/GitHubPullRequest.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>