<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff host/src/main/java/org/openjdk/skara/host/gitlab/GitLabMergeRequest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../github/GitHubPullRequest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>host/src/main/java/org/openjdk/skara/host/gitlab/GitLabMergeRequest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
347     private String encodeMarkdown(String message) {
348         return message.replaceAll(&quot;\n&quot;, &quot;  \n&quot;);
349     }
350 
351     private final Pattern checkBodyPattern = Pattern.compile(&quot;^##### ([^\\n\\r]*)\\R(.*)&quot;,
352                                                              Pattern.DOTALL | Pattern.MULTILINE);
353 
354     @Override
355     public Map&lt;String, Check&gt; getChecks(Hash hash) {
356         var pattern = Pattern.compile(String.format(checkResultPattern, hash.hex()));
357         var matchers = getComments().stream()
358                 .collect(Collectors.toMap(comment -&gt; comment,
359                         comment -&gt; pattern.matcher(comment.body())));
360 
361         return matchers.entrySet().stream()
362                 .filter(entry -&gt; entry.getValue().find())
363                 .collect(Collectors.toMap(entry -&gt; entry.getValue().group(1),
364                         entry -&gt; {
365                             var checkBuilder = CheckBuilder.create(entry.getValue().group(1), hash);
366                             checkBuilder.startedAt(entry.getKey().createdAt());
<span class="line-modified">367                             if (!entry.getValue().group(2).equals(&quot;RUNNING&quot;)) {</span>
<span class="line-modified">368                                 checkBuilder.complete(entry.getValue().group(2).equals(&quot;SUCCESS&quot;), entry.getKey().updatedAt());</span>















369                             }
370                             if (!entry.getValue().group(3).equals(&quot;NONE&quot;)) {
371                                 checkBuilder.metadata(new String(Base64.getDecoder().decode(entry.getValue().group(3)), StandardCharsets.UTF_8));
372                             }
373                             var checkBodyMatcher = checkBodyPattern.matcher(entry.getKey().body());
374                             if (checkBodyMatcher.find()) {
<span class="line-modified">375                                 checkBuilder.title(checkBodyMatcher.group(1));</span>



376                                 checkBuilder.summary(checkBodyMatcher.group(2));
377                             }
378                             return checkBuilder.build();
379                         }));
380     }
381 
<span class="line-modified">382     @Override</span>
<span class="line-modified">383     public void createCheck(Check check) {</span>
<span class="line-modified">384         log.info(&quot;Looking for previous status check comment&quot;);</span>











385 
<span class="line-modified">386         var previous = getStatusCheckComment(check.name());</span>
<span class="line-removed">387         var body = &quot;:hourglass_flowing_sand: The merge request check **&quot; + check.name() + &quot;** is currently running...&quot;;</span>
<span class="line-removed">388         var metadata = &quot;NONE&quot;;</span>
389         if (check.metadata().isPresent()) {
<span class="line-modified">390             metadata = Base64.getEncoder().encodeToString(check.metadata().get().getBytes(StandardCharsets.UTF_8));</span>
391         }
<span class="line-modified">392         var message = String.format(checkMarker, check.name()) + &quot;\n&quot; +</span>
<span class="line-removed">393                 String.format(checkResultMarker,</span>
<span class="line-removed">394                         check.name(),</span>
<span class="line-removed">395                         &quot;RUNNING&quot;,</span>
<span class="line-removed">396                         check.hash(),</span>
<span class="line-removed">397                         metadata</span>
<span class="line-removed">398                         ) + &quot;\n&quot; + encodeMarkdown(body);</span>
<span class="line-removed">399 </span>
<span class="line-removed">400         previous.ifPresentOrElse(p -&gt; updateComment(p.id(), message),</span>
<span class="line-removed">401                 () -&gt; addComment(message));</span>
402     }
403 
404     private String linkToDiff(String path, Hash hash, int line) {
405         return &quot;[&quot; + path + &quot; line &quot; + line + &quot;](&quot; + URIBuilder.base(repository.getUrl())
406                          .setPath(&quot;/&quot; + repository.getName()+ &quot;/blob/&quot; + hash.hex() + &quot;/&quot; + path)
407                          .setAuthentication(null)
408                          .build() + &quot;#L&quot; + Integer.toString(line) + &quot;)&quot;;
409     }
410 
<span class="line-modified">411     @Override</span>
<span class="line-modified">412     public void updateCheck(Check check) {</span>
<span class="line-modified">413         log.info(&quot;Looking for previous status check comment&quot;);</span>
<span class="line-modified">414 </span>
<span class="line-removed">415         var previous = getStatusCheckComment(check.name())</span>
<span class="line-removed">416                 .orElseGet(() -&gt; addComment(&quot;Progress deleted?&quot;));</span>
<span class="line-removed">417 </span>
<span class="line-removed">418         String status;</span>
<span class="line-removed">419         switch (check.status()) {</span>
420             case IN_PROGRESS:
<span class="line-modified">421                 status = &quot;RUNNING&quot;;</span>
422                 break;
423             case SUCCESS:
<span class="line-modified">424                 status = &quot;SUCCESS&quot;;</span>
425                 break;
426             case FAILURE:
<span class="line-modified">427                 status = &quot;FAILURE&quot;;</span>



428                 break;
429             default:
430                 throw new RuntimeException(&quot;Unknown check status&quot;);
431         }
432 
<span class="line-modified">433         var metadata = &quot;NONE&quot;;</span>
<span class="line-modified">434         if (check.metadata().isPresent()) {</span>
<span class="line-modified">435             metadata = Base64.getEncoder().encodeToString(check.metadata().get().getBytes(StandardCharsets.UTF_8));</span>
<span class="line-modified">436         }</span>
<span class="line-modified">437         var markers = String.format(checkMarker, check.name()) + &quot;\n&quot; + String.format(checkResultMarker, check.name(),</span>
<span class="line-modified">438                 status, check.hash(), metadata);</span>
<span class="line-modified">439 </span>
<span class="line-modified">440         String body;</span>
<span class="line-modified">441         if (check.status() == CheckStatus.SUCCESS) {</span>
<span class="line-modified">442             body = &quot;:tada: The merge request check **&quot; + check.name() + &quot;** completed successfully!&quot;;</span>
<span class="line-modified">443         } else {</span>
<span class="line-modified">444             if (check.status() == CheckStatus.IN_PROGRESS) {</span>
<span class="line-modified">445                 body = &quot;:hourglass_flowing_sand: The merge request check **&quot; + check.name() + &quot;** is currently running...&quot;;</span>
<span class="line-modified">446             } else {</span>
<span class="line-modified">447                 body = &quot;:warning: The merge request check **&quot; + check.name() + &quot;** identified the following issues:&quot;;</span>
<span class="line-removed">448             }</span>
<span class="line-removed">449             if (check.title().isPresent() &amp;&amp; check.summary().isPresent()) {</span>
<span class="line-removed">450                 body += encodeMarkdown(&quot;\n&quot; + &quot;##### &quot; + check.title().get() + &quot;\n&quot; + check.summary().get());</span>
<span class="line-removed">451 </span>
<span class="line-removed">452                 for (var annotation : check.annotations()) {</span>
<span class="line-removed">453                     var annotationString = &quot;  - &quot;;</span>
<span class="line-removed">454                     switch (annotation.level()) {</span>
<span class="line-removed">455                         case NOTICE:</span>
<span class="line-removed">456                             annotationString += &quot;Notice: &quot;;</span>
<span class="line-removed">457                             break;</span>
<span class="line-removed">458                         case WARNING:</span>
<span class="line-removed">459                             annotationString += &quot;Warning: &quot;;</span>
<span class="line-removed">460                             break;</span>
<span class="line-removed">461                         case FAILURE:</span>
<span class="line-removed">462                             annotationString += &quot;Failure: &quot;;</span>
<span class="line-removed">463                             break;</span>
<span class="line-removed">464                     }</span>
<span class="line-removed">465                     annotationString += linkToDiff(annotation.path(), check.hash(), annotation.startLine());</span>
<span class="line-removed">466                     annotationString += &quot;\n    - &quot; + annotation.message().lines().collect(Collectors.joining(&quot;\n    - &quot;));</span>
<span class="line-removed">467 </span>
<span class="line-removed">468                     body += &quot;\n&quot; + annotationString;</span>
469                 }




470             }
471         }
472 
<span class="line-modified">473         updateComment(previous.id(), markers + &quot;\n&quot; + body);</span>

























474     }
475 










476     @Override
477     public void setState(State state) {
478         request.put(&quot;&quot;)
479                .body(&quot;state_event&quot;, state == State.CLOSED ? &quot;close&quot; : &quot;reopen&quot;)
480                .execute();
481     }
482 
483     @Override
484     public void addLabel(String label) {
485         // GitLab does not allow adding/removing single labels, only setting the full list
486         // We retrieve the list again here to try to minimize the race condition window
487         var currentJson = request.get(&quot;&quot;).execute().asObject();
488         var labels = Stream.concat(currentJson.get(&quot;labels&quot;).stream()
489                 .map(JSONValue::asString),
490                 List.of(label).stream())
491                 .collect(Collectors.toSet());
492         request.put(&quot;&quot;)
493                .body(&quot;labels&quot;, String.join(&quot;,&quot;, labels))
494                .execute();
495     }
</pre>
</td>
<td>
<hr />
<pre>
347     private String encodeMarkdown(String message) {
348         return message.replaceAll(&quot;\n&quot;, &quot;  \n&quot;);
349     }
350 
351     private final Pattern checkBodyPattern = Pattern.compile(&quot;^##### ([^\\n\\r]*)\\R(.*)&quot;,
352                                                              Pattern.DOTALL | Pattern.MULTILINE);
353 
354     @Override
355     public Map&lt;String, Check&gt; getChecks(Hash hash) {
356         var pattern = Pattern.compile(String.format(checkResultPattern, hash.hex()));
357         var matchers = getComments().stream()
358                 .collect(Collectors.toMap(comment -&gt; comment,
359                         comment -&gt; pattern.matcher(comment.body())));
360 
361         return matchers.entrySet().stream()
362                 .filter(entry -&gt; entry.getValue().find())
363                 .collect(Collectors.toMap(entry -&gt; entry.getValue().group(1),
364                         entry -&gt; {
365                             var checkBuilder = CheckBuilder.create(entry.getValue().group(1), hash);
366                             checkBuilder.startedAt(entry.getKey().createdAt());
<span class="line-modified">367                             var status = entry.getValue().group(2);</span>
<span class="line-modified">368                             var completedAt = entry.getKey().updatedAt();</span>
<span class="line-added">369                             switch (status) {</span>
<span class="line-added">370                                 case &quot;RUNNING&quot;:</span>
<span class="line-added">371                                     // do nothing</span>
<span class="line-added">372                                     break;</span>
<span class="line-added">373                                 case &quot;SUCCESS&quot;:</span>
<span class="line-added">374                                     checkBuilder.complete(true, completedAt);</span>
<span class="line-added">375                                     break;</span>
<span class="line-added">376                                 case &quot;FAILURE&quot;:</span>
<span class="line-added">377                                     checkBuilder.complete(false, completedAt);</span>
<span class="line-added">378                                     break;</span>
<span class="line-added">379                                 case &quot;CANCELLED&quot;:</span>
<span class="line-added">380                                     checkBuilder.cancel(completedAt);</span>
<span class="line-added">381                                     break;</span>
<span class="line-added">382                                 default:</span>
<span class="line-added">383                                     throw new IllegalStateException(&quot;Unknown status: &quot; + status);</span>
384                             }
385                             if (!entry.getValue().group(3).equals(&quot;NONE&quot;)) {
386                                 checkBuilder.metadata(new String(Base64.getDecoder().decode(entry.getValue().group(3)), StandardCharsets.UTF_8));
387                             }
388                             var checkBodyMatcher = checkBodyPattern.matcher(entry.getKey().body());
389                             if (checkBodyMatcher.find()) {
<span class="line-modified">390                                 // escapeMarkdown adds an additional space before the newline</span>
<span class="line-added">391                                 var title = checkBodyMatcher.group(1);</span>
<span class="line-added">392                                 var nonEscapedTitle = title.substring(0, title.length() - 2);</span>
<span class="line-added">393                                 checkBuilder.title(nonEscapedTitle);</span>
394                                 checkBuilder.summary(checkBodyMatcher.group(2));
395                             }
396                             return checkBuilder.build();
397                         }));
398     }
399 
<span class="line-modified">400     private String statusFor(Check check) {</span>
<span class="line-modified">401         switch (check.status()) {</span>
<span class="line-modified">402             case IN_PROGRESS:</span>
<span class="line-added">403                 return &quot;RUNNING&quot;;</span>
<span class="line-added">404             case SUCCESS:</span>
<span class="line-added">405                 return &quot;SUCCESS&quot;;</span>
<span class="line-added">406             case FAILURE:</span>
<span class="line-added">407                 return &quot;FAILURE&quot;;</span>
<span class="line-added">408             case CANCELLED:</span>
<span class="line-added">409                 return &quot;CANCELLED&quot;;</span>
<span class="line-added">410             default:</span>
<span class="line-added">411                 throw new RuntimeException(&quot;Unknown check status&quot;);</span>
<span class="line-added">412         }</span>
<span class="line-added">413     }</span>
414 
<span class="line-modified">415     private String metadataFor(Check check) {</span>


416         if (check.metadata().isPresent()) {
<span class="line-modified">417             return Base64.getEncoder().encodeToString(check.metadata().get().getBytes(StandardCharsets.UTF_8));</span>
418         }
<span class="line-modified">419         return &quot;NONE&quot;;</span>









420     }
421 
422     private String linkToDiff(String path, Hash hash, int line) {
423         return &quot;[&quot; + path + &quot; line &quot; + line + &quot;](&quot; + URIBuilder.base(repository.getUrl())
424                          .setPath(&quot;/&quot; + repository.getName()+ &quot;/blob/&quot; + hash.hex() + &quot;/&quot; + path)
425                          .setAuthentication(null)
426                          .build() + &quot;#L&quot; + Integer.toString(line) + &quot;)&quot;;
427     }
428 
<span class="line-modified">429     private String bodyFor(Check check) {</span>
<span class="line-modified">430         var status = check.status();</span>
<span class="line-modified">431         String body;</span>
<span class="line-modified">432         switch (status) {</span>





433             case IN_PROGRESS:
<span class="line-modified">434                 body = &quot;:hourglass_flowing_sand: The merge request check **&quot; + check.name() + &quot;** is currently running...&quot;;</span>
435                 break;
436             case SUCCESS:
<span class="line-modified">437                 body = &quot;:tada: The merge request check **&quot; + check.name() + &quot;** completed successfully!&quot;;</span>
438                 break;
439             case FAILURE:
<span class="line-modified">440                 body = &quot;:warning: The merge request check **&quot; + check.name() + &quot;** identified the following issues:&quot;;</span>
<span class="line-added">441                 break;</span>
<span class="line-added">442             case CANCELLED:</span>
<span class="line-added">443                 body = &quot;:x: The merge request check **&quot; + check.name() + &quot;** has been cancelled&quot;;</span>
444                 break;
445             default:
446                 throw new RuntimeException(&quot;Unknown check status&quot;);
447         }
448 
<span class="line-modified">449         if ( check.title().isPresent() &amp;&amp; check.summary().isPresent()) {</span>
<span class="line-modified">450             body += encodeMarkdown(&quot;\n&quot; + &quot;##### &quot; + check.title().get() + &quot;\n&quot; + check.summary().get());</span>
<span class="line-modified">451 </span>
<span class="line-modified">452             for (var annotation : check.annotations()) {</span>
<span class="line-modified">453                 var annotationString = &quot;  - &quot;;</span>
<span class="line-modified">454                 switch (annotation.level()) {</span>
<span class="line-modified">455                     case NOTICE:</span>
<span class="line-modified">456                         annotationString += &quot;Notice: &quot;;</span>
<span class="line-modified">457                         break;</span>
<span class="line-modified">458                     case WARNING:</span>
<span class="line-modified">459                         annotationString += &quot;Warning: &quot;;</span>
<span class="line-modified">460                         break;</span>
<span class="line-modified">461                     case FAILURE:</span>
<span class="line-modified">462                         annotationString += &quot;Failure: &quot;;</span>
<span class="line-modified">463                         break;</span>





















464                 }
<span class="line-added">465                 annotationString += linkToDiff(annotation.path(), check.hash(), annotation.startLine());</span>
<span class="line-added">466                 annotationString += &quot;\n    - &quot; + annotation.message().lines().collect(Collectors.joining(&quot;\n    - &quot;));</span>
<span class="line-added">467 </span>
<span class="line-added">468                 body += &quot;\n&quot; + annotationString;</span>
469             }
470         }
471 
<span class="line-modified">472         return body;</span>
<span class="line-added">473     }</span>
<span class="line-added">474 </span>
<span class="line-added">475     private void updateCheckComment(Optional&lt;Comment&gt; previous, Check check) {</span>
<span class="line-added">476         var status = statusFor(check);</span>
<span class="line-added">477         var metadata = metadataFor(check);</span>
<span class="line-added">478         var markers = String.format(checkMarker, check.name()) + &quot;\n&quot; +</span>
<span class="line-added">479                       String.format(checkResultMarker,</span>
<span class="line-added">480                                     check.name(),</span>
<span class="line-added">481                                     status,</span>
<span class="line-added">482                                     check.hash(),</span>
<span class="line-added">483                                     metadata);</span>
<span class="line-added">484 </span>
<span class="line-added">485         var body = bodyFor(check);</span>
<span class="line-added">486         var message = markers + &quot;\n&quot; + body;</span>
<span class="line-added">487         previous.ifPresentOrElse(</span>
<span class="line-added">488                 p  -&gt; updateComment(p.id(), message),</span>
<span class="line-added">489                 () -&gt; addComment(message));</span>
<span class="line-added">490     }</span>
<span class="line-added">491 </span>
<span class="line-added">492     @Override</span>
<span class="line-added">493     public void createCheck(Check check) {</span>
<span class="line-added">494         log.info(&quot;Looking for previous status check comment&quot;);</span>
<span class="line-added">495 </span>
<span class="line-added">496         var previous = getStatusCheckComment(check.name());</span>
<span class="line-added">497         updateCheckComment(previous, check);</span>
498     }
499 
<span class="line-added">500     @Override</span>
<span class="line-added">501     public void updateCheck(Check check) {</span>
<span class="line-added">502         log.info(&quot;Looking for previous status check comment&quot;);</span>
<span class="line-added">503 </span>
<span class="line-added">504         var previous = getStatusCheckComment(check.name())</span>
<span class="line-added">505                 .orElseGet(() -&gt; addComment(&quot;Progress deleted?&quot;));</span>
<span class="line-added">506         updateCheckComment(Optional.of(previous), check);</span>
<span class="line-added">507     }</span>
<span class="line-added">508 </span>
<span class="line-added">509 </span>
510     @Override
511     public void setState(State state) {
512         request.put(&quot;&quot;)
513                .body(&quot;state_event&quot;, state == State.CLOSED ? &quot;close&quot; : &quot;reopen&quot;)
514                .execute();
515     }
516 
517     @Override
518     public void addLabel(String label) {
519         // GitLab does not allow adding/removing single labels, only setting the full list
520         // We retrieve the list again here to try to minimize the race condition window
521         var currentJson = request.get(&quot;&quot;).execute().asObject();
522         var labels = Stream.concat(currentJson.get(&quot;labels&quot;).stream()
523                 .map(JSONValue::asString),
524                 List.of(label).stream())
525                 .collect(Collectors.toSet());
526         request.put(&quot;&quot;)
527                .body(&quot;labels&quot;, String.join(&quot;,&quot;, labels))
528                .execute();
529     }
</pre>
</td>
</tr>
</table>
<center><a href="../github/GitHubPullRequest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>