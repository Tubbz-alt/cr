<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff forge/src/main/java/org/openjdk/skara/forge/github/GitHubPullRequest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../../../bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/ReviewArchive.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="GitHubRepository.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>forge/src/main/java/org/openjdk/skara/forge/github/GitHubPullRequest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 27,11 ***</span>
  import org.openjdk.skara.issuetracker.*;
  import org.openjdk.skara.json.*;
  import org.openjdk.skara.network.*;
  import org.openjdk.skara.vcs.Hash;
  
<span class="line-removed">- import java.io.*;</span>
  import java.net.URI;
  import java.time.*;
  import java.time.format.DateTimeFormatter;
  import java.util.*;
  import java.util.logging.Logger;
<span class="line-new-header">--- 27,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 117,96 ***</span>
          request.post(&quot;pulls/&quot; + json.get(&quot;number&quot;).toString() + &quot;/reviews&quot;)
                 .body(query)
                 .execute();
      }
  
<span class="line-modified">!     private ReviewComment parseReviewComment(ReviewComment parent, JSONObject json, PositionMapper diff) {</span>
          var author = host.parseUserField(json);
          var threadId = parent == null ? json.get(&quot;id&quot;).toString() : parent.threadId();
          var comment = new ReviewComment(parent,
                                          threadId,
<span class="line-modified">!                                         new Hash(json.get(&quot;commit_id&quot;).asString()),</span>
<span class="line-modified">!                                         json.get(&quot;path&quot;).asString(),</span>
<span class="line-modified">!                                         diff.positionToLine(json.get(&quot;path&quot;).asString(), json.get(&quot;original_position&quot;).asInt()),</span>
                                          json.get(&quot;id&quot;).toString(),
                                          json.get(&quot;body&quot;).asString(),
                                          author,
                                          ZonedDateTime.parse(json.get(&quot;created_at&quot;).asString()),
                                          ZonedDateTime.parse(json.get(&quot;updated_at&quot;).asString()));
          return comment;
      }
  
      @Override
      public ReviewComment addReviewComment(Hash base, Hash hash, String path, int line, String body) {
<span class="line-modified">!         try {</span>
<span class="line-modified">!             var rawDiff = request.get(&quot;pulls/&quot; + json.get(&quot;number&quot;).toString())</span>
<span class="line-modified">!                                  .header(&quot;Accept&quot;, &quot;application/vnd.github.v3.diff&quot;)</span>
<span class="line-modified">!                                  .executeUnparsed();</span>
<span class="line-modified">!             var diff = PositionMapper.parse(rawDiff);</span>
<span class="line-modified">! </span>
<span class="line-modified">!             var query = JSON.object()</span>
<span class="line-modified">!                             .put(&quot;body&quot;, body)</span>
<span class="line-modified">!                             .put(&quot;commit_id&quot;, hash.hex())</span>
<span class="line-modified">!                             .put(&quot;path&quot;, path)</span>
<span class="line-removed">-                             .put(&quot;position&quot;, diff.lineToPosition(path, line));</span>
<span class="line-removed">-             var response = request.post(&quot;pulls/&quot; + json.get(&quot;number&quot;).toString() + &quot;/comments&quot;)</span>
<span class="line-removed">-                                   .body(query)</span>
<span class="line-removed">-                                   .execute();</span>
<span class="line-removed">-             return parseReviewComment(null, response.asObject(), diff);</span>
<span class="line-removed">-         } catch (IOException e) {</span>
<span class="line-removed">-             throw new UncheckedIOException(e);</span>
<span class="line-removed">-         }</span>
      }
  
      @Override
      public ReviewComment addReviewCommentReply(ReviewComment parent, String body) {
<span class="line-modified">!         try {</span>
<span class="line-modified">!             var rawDiff = request.get(&quot;pulls/&quot; + json.get(&quot;number&quot;).toString())</span>
<span class="line-modified">!                                  .header(&quot;Accept&quot;, &quot;application/vnd.github.v3.diff&quot;)</span>
<span class="line-modified">!                                  .executeUnparsed();</span>
<span class="line-modified">!             var diff = PositionMapper.parse(rawDiff);</span>
<span class="line-modified">! </span>
<span class="line-modified">!             var query = JSON.object()</span>
<span class="line-removed">-                             .put(&quot;body&quot;, body)</span>
<span class="line-removed">-                             .put(&quot;in_reply_to&quot;, Integer.parseInt(parent.threadId()));</span>
<span class="line-removed">-             var response = request.post(&quot;pulls/&quot; + json.get(&quot;number&quot;).toString() + &quot;/comments&quot;)</span>
<span class="line-removed">-                                   .body(query)</span>
<span class="line-removed">-                                   .execute();</span>
<span class="line-removed">-             return parseReviewComment(parent, response.asObject(), diff);</span>
<span class="line-removed">-         } catch (IOException e) {</span>
<span class="line-removed">-             throw new UncheckedIOException(e);</span>
<span class="line-removed">-         }</span>
      }
  
      @Override
      public List&lt;ReviewComment&gt; reviewComments() {
<span class="line-modified">!         try {</span>
<span class="line-modified">!             var rawDiff = request.get(&quot;pulls/&quot; + json.get(&quot;number&quot;).toString())</span>
<span class="line-modified">!                                  .header(&quot;Accept&quot;, &quot;application/vnd.github.v3.diff&quot;)</span>
<span class="line-modified">!                                  .executeUnparsed();</span>
<span class="line-modified">!             var diff = PositionMapper.parse(rawDiff);</span>
<span class="line-modified">! </span>
<span class="line-modified">!             var ret = new ArrayList&lt;ReviewComment&gt;();</span>
<span class="line-modified">!             var reviewComments = request.get(&quot;pulls/&quot; + json.get(&quot;number&quot;).toString() + &quot;/comments&quot;).execute().stream()</span>
<span class="line-modified">!                                         .map(JSONValue::asObject)</span>
<span class="line-modified">!                                         .collect(Collectors.toList());</span>
<span class="line-removed">-             var idToComment = new HashMap&lt;String, ReviewComment&gt;();</span>
<span class="line-removed">- </span>
<span class="line-removed">-             for (var reviewComment : reviewComments) {</span>
<span class="line-removed">-                 ReviewComment parent = null;</span>
<span class="line-removed">-                 if (reviewComment.contains(&quot;in_reply_to_id&quot;)) {</span>
<span class="line-removed">-                     parent = idToComment.get(reviewComment.get(&quot;in_reply_to_id&quot;).toString());</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-                 var comment = parseReviewComment(parent, reviewComment, diff);</span>
<span class="line-removed">-                 idToComment.put(comment.id(), comment);</span>
<span class="line-removed">-                 ret.add(comment);</span>
              }
<span class="line-modified">! </span>
<span class="line-modified">!             return ret;</span>
<span class="line-modified">!         } catch (IOException e) {</span>
<span class="line-removed">-             throw new UncheckedIOException(e);</span>
          }
      }
  
      @Override
      public Hash headHash() {
          return new Hash(json.get(&quot;head&quot;).get(&quot;sha&quot;).asString());
<span class="line-new-header">--- 116,91 ---</span>
          request.post(&quot;pulls/&quot; + json.get(&quot;number&quot;).toString() + &quot;/reviews&quot;)
                 .body(query)
                 .execute();
      }
  
<span class="line-modified">!     private ReviewComment parseReviewComment(ReviewComment parent, JSONObject json) {</span>
          var author = host.parseUserField(json);
          var threadId = parent == null ? json.get(&quot;id&quot;).toString() : parent.threadId();
<span class="line-added">+ </span>
<span class="line-added">+         int line = json.get(&quot;original_line&quot;).asInt();</span>
<span class="line-added">+         var hash = new Hash(json.get(&quot;original_commit_id&quot;).asString());</span>
<span class="line-added">+         var path = json.get(&quot;path&quot;).asString();</span>
<span class="line-added">+ </span>
<span class="line-added">+         if (json.get(&quot;side&quot;).asString().equals(&quot;LEFT&quot;)) {</span>
<span class="line-added">+             var commitInfo = request.get(&quot;commits/&quot; + hash).execute();</span>
<span class="line-added">+ </span>
<span class="line-added">+             // It&#39;s possible that the file in question was renamed / deleted in an earlier commit, would</span>
<span class="line-added">+             // need to parse all the commits in the PR to be sure. But this should cover most cases.</span>
<span class="line-added">+             hash = new Hash(commitInfo.get(&quot;parents&quot;).asArray().get(0).get(&quot;sha&quot;).asString());</span>
<span class="line-added">+             for (var file : commitInfo.get(&quot;files&quot;).asArray()) {</span>
<span class="line-added">+                 if (file.get(&quot;filename&quot;).asString().equals(path)) {</span>
<span class="line-added">+                     if (file.get(&quot;status&quot;).asString().equals(&quot;renamed&quot;)) {</span>
<span class="line-added">+                         path = file.get(&quot;previous_filename&quot;).asString();</span>
<span class="line-added">+                     }</span>
<span class="line-added">+                     break;</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             }</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
          var comment = new ReviewComment(parent,
                                          threadId,
<span class="line-modified">!                                         hash,</span>
<span class="line-modified">!                                         path,</span>
<span class="line-modified">!                                         line,</span>
                                          json.get(&quot;id&quot;).toString(),
                                          json.get(&quot;body&quot;).asString(),
                                          author,
                                          ZonedDateTime.parse(json.get(&quot;created_at&quot;).asString()),
                                          ZonedDateTime.parse(json.get(&quot;updated_at&quot;).asString()));
          return comment;
      }
  
      @Override
      public ReviewComment addReviewComment(Hash base, Hash hash, String path, int line, String body) {
<span class="line-modified">!         var query = JSON.object()</span>
<span class="line-modified">!                         .put(&quot;body&quot;, body)</span>
<span class="line-modified">!                         .put(&quot;commit_id&quot;, hash.hex())</span>
<span class="line-modified">!                         .put(&quot;path&quot;, path)</span>
<span class="line-modified">!                         .put(&quot;side&quot;, &quot;RIGHT&quot;)</span>
<span class="line-modified">!                         .put(&quot;line&quot;, line);</span>
<span class="line-modified">!         var response = request.post(&quot;pulls/&quot; + json.get(&quot;number&quot;).toString() + &quot;/comments&quot;)</span>
<span class="line-modified">!                               .body(query)</span>
<span class="line-modified">!                               .execute();</span>
<span class="line-modified">!         return parseReviewComment(null, response.asObject());</span>
      }
  
      @Override
      public ReviewComment addReviewCommentReply(ReviewComment parent, String body) {
<span class="line-modified">!         var query = JSON.object()</span>
<span class="line-modified">!                         .put(&quot;body&quot;, body)</span>
<span class="line-modified">!                         .put(&quot;in_reply_to&quot;, Integer.parseInt(parent.threadId()));</span>
<span class="line-modified">!         var response = request.post(&quot;pulls/&quot; + json.get(&quot;number&quot;).toString() + &quot;/comments&quot;)</span>
<span class="line-modified">!                               .body(query)</span>
<span class="line-modified">!                               .execute();</span>
<span class="line-modified">!         return parseReviewComment(parent, response.asObject());</span>
      }
  
      @Override
      public List&lt;ReviewComment&gt; reviewComments() {
<span class="line-modified">!         var ret = new ArrayList&lt;ReviewComment&gt;();</span>
<span class="line-modified">!         var reviewComments = request.get(&quot;pulls/&quot; + json.get(&quot;number&quot;).toString() + &quot;/comments&quot;).execute().stream()</span>
<span class="line-modified">!                                     .map(JSONValue::asObject)</span>
<span class="line-modified">!                                     .collect(Collectors.toList());</span>
<span class="line-modified">!         var idToComment = new HashMap&lt;String, ReviewComment&gt;();</span>
<span class="line-modified">! </span>
<span class="line-modified">!         for (var reviewComment : reviewComments) {</span>
<span class="line-modified">!             ReviewComment parent = null;</span>
<span class="line-modified">!             if (reviewComment.contains(&quot;in_reply_to_id&quot;)) {</span>
<span class="line-modified">!                 parent = idToComment.get(reviewComment.get(&quot;in_reply_to_id&quot;).toString());</span>
              }
<span class="line-modified">!             var comment = parseReviewComment(parent, reviewComment);</span>
<span class="line-modified">!             idToComment.put(comment.id(), comment);</span>
<span class="line-modified">!             ret.add(comment);</span>
          }
<span class="line-added">+ </span>
<span class="line-added">+         return ret;</span>
      }
  
      @Override
      public Hash headHash() {
          return new Hash(json.get(&quot;head&quot;).get(&quot;sha&quot;).asString());
</pre>
<center><a href="../../../../../../../../../bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/ReviewArchive.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="GitHubRepository.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>