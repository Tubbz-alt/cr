<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/mlbridge/ArchiveMessages.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 294             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 295             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 296             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 297             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This is now ready&quot;));
 298             assertTrue(archiveContains(archiveFolder.path(), reviewFile.toString()));
 299             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 300 
 301             // The mailing list as well
 302             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 303             var mailmanList = mailmanServer.getList(listAddress.address());
 304             var conversations = mailmanList.conversations(Duration.ofDays(1));
 305             assertEquals(1, conversations.size());
 306             var mail = conversations.get(0).first();
 307             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 308 
 309             // Comment on the comment
 310             pr.addReviewCommentReply(comment, &quot;This is a review reply&quot;);
 311             TestBotRunner.runPeriodicItems(mlBot);
 312             listServer.processIncoming();
 313 
<span class="line-modified"> 314             // The archive should contain the additional comment</span>
 315             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 316             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a review reply&quot;));
 317             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This is now ready&quot;));

 318 
 319             // As well as the mailing list
 320             conversations = mailmanList.conversations(Duration.ofDays(1));
 321             assertEquals(1, conversations.size());
 322             assertEquals(3, conversations.get(0).allMessages().size());
 323             for (var newMail : conversations.get(0).allMessages()) {
 324                 assertEquals(noreplyAddress(archive), newMail.author().address());
 325                 assertEquals(from, newMail.sender());
 326             }
 327         }
 328     }
 329 
 330     @Test
 331     void combineComments(TestInfo testInfo) throws IOException {
 332         try (var credentials = new HostCredentials(testInfo);
 333              var tempFolder = new TemporaryDirectory();
 334              var archiveFolder = new TemporaryDirectory();
 335              var listServer = new TestMailmanServer()) {
 336             var author = credentials.getHostedRepository();
 337             var archive = credentials.getHostedRepository();
</pre>
</td>
<td>
<hr />
<pre>
 294             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 295             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 296             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 297             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This is now ready&quot;));
 298             assertTrue(archiveContains(archiveFolder.path(), reviewFile.toString()));
 299             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 300 
 301             // The mailing list as well
 302             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 303             var mailmanList = mailmanServer.getList(listAddress.address());
 304             var conversations = mailmanList.conversations(Duration.ofDays(1));
 305             assertEquals(1, conversations.size());
 306             var mail = conversations.get(0).first();
 307             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 308 
 309             // Comment on the comment
 310             pr.addReviewCommentReply(comment, &quot;This is a review reply&quot;);
 311             TestBotRunner.runPeriodicItems(mlBot);
 312             listServer.processIncoming();
 313 
<span class="line-modified"> 314             // The archive should contain the additional comment (but no quoted footers)</span>
 315             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 316             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a review reply&quot;));
 317             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This is now ready&quot;));
<span class="line-added"> 318             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; PR:&quot;));</span>
 319 
 320             // As well as the mailing list
 321             conversations = mailmanList.conversations(Duration.ofDays(1));
 322             assertEquals(1, conversations.size());
 323             assertEquals(3, conversations.get(0).allMessages().size());
 324             for (var newMail : conversations.get(0).allMessages()) {
 325                 assertEquals(noreplyAddress(archive), newMail.author().address());
 326                 assertEquals(from, newMail.sender());
 327             }
 328         }
 329     }
 330 
 331     @Test
 332     void combineComments(TestInfo testInfo) throws IOException {
 333         try (var credentials = new HostCredentials(testInfo);
 334              var tempFolder = new TemporaryDirectory();
 335              var archiveFolder = new TemporaryDirectory();
 336              var listServer = new TestMailmanServer()) {
 337             var author = credentials.getHostedRepository();
 338             var archive = credentials.getHostedRepository();
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/mlbridge/ArchiveMessages.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>