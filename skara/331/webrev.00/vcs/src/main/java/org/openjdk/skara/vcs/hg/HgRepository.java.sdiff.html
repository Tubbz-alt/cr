<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff vcs/src/main/java/org/openjdk/skara/vcs/hg/HgRepository.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../git/GitRepository.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/java/org/openjdk/skara/vcs/RepositoryTests.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>vcs/src/main/java/org/openjdk/skara/vcs/hg/HgRepository.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 318         }
 319     }
 320 
 321     @Override
 322     public void reset(Hash target, boolean hard) throws IOException {
 323         throw new RuntimeException(&quot;Not implemented yet&quot;);
 324     }
 325 
 326     @Override
 327     public Repository reinitialize() throws IOException {
 328         Files.walk(dir)
 329              .map(Path::toFile)
 330              .sorted(Comparator.reverseOrder())
 331              .forEach(File::delete);
 332 
 333         return init();
 334     }
 335 
 336     @Override
 337     public Hash fetch(URI uri, String refspec) throws IOException {




 338         var oldHeads = new HashSet&lt;Hash&gt;(heads());
 339 
 340         var cmd = new ArrayList&lt;String&gt;();
 341         cmd.add(&quot;hg&quot;);
 342         cmd.add(&quot;pull&quot;);
 343         if (refspec != null) {
 344             cmd.add(&quot;--rev&quot;);
 345             cmd.add(refspec);
 346         }
<span class="line-modified"> 347         if (uri != null) {</span>
<span class="line-modified"> 348             cmd.add(uri.toString());</span>
 349         }
 350         try (var p = capture(cmd)) {
 351             await(p);
 352         }
 353 
 354         var newHeads = new HashSet&lt;Hash&gt;(heads());
 355         newHeads.removeAll(oldHeads);
 356 
 357         if (newHeads.size() &gt; 1) {
 358             throw new IllegalStateException(&quot;fetching multiple heads is not supported&quot;);
 359         } else if (newHeads.size() == 0) {
 360             // no new head was fetched, return current head
 361             return head();
 362         }
 363         return newHeads.iterator().next();
 364     }
 365 
 366     @Override
 367     public void fetchAll() throws IOException {
 368         var pullPaths = new ArrayList&lt;URI&gt;();
 369         try (var p = capture(&quot;hg&quot;, &quot;paths&quot;)) {
 370             var res = await(p);
 371             for (var line : res.stdout()) {
 372                 var parts = line.split(&quot;=&quot;);
 373                 var name = parts[0].trim();
 374                 var uri = parts[1].trim();
 375                 if (!name.endsWith(&quot;-push&quot;)) {
 376                     pullPaths.add(URI.create(uri));
 377                 }
 378             }
 379         }
 380 
 381         for (var uri : pullPaths) {
 382             fetch(uri, null);
 383         }
 384     }
 385 





 386     @Override
 387     public void delete(Branch b) throws IOException {
 388         throw new RuntimeException(&quot;Branches cannot be deleted in Mercurial&quot;);
 389     }
 390 
 391     @Override
 392     public Repository init() throws IOException {
 393         if (!Files.exists(dir)) {
 394             Files.createDirectories(dir);
 395         }
 396 
 397         try (var p = capture(&quot;hg&quot;, &quot;init&quot;)) {
 398             await(p);
 399             return this;
 400         }
 401     }
 402 
 403     @Override
 404     public void pushAll(URI uri) throws IOException {
 405         try (var p = capture(&quot;hg&quot;, &quot;push&quot;, &quot;--new-branch&quot;, uri.toString())) {
</pre>
</td>
<td>
<hr />
<pre>
 318         }
 319     }
 320 
 321     @Override
 322     public void reset(Hash target, boolean hard) throws IOException {
 323         throw new RuntimeException(&quot;Not implemented yet&quot;);
 324     }
 325 
 326     @Override
 327     public Repository reinitialize() throws IOException {
 328         Files.walk(dir)
 329              .map(Path::toFile)
 330              .sorted(Comparator.reverseOrder())
 331              .forEach(File::delete);
 332 
 333         return init();
 334     }
 335 
 336     @Override
 337     public Hash fetch(URI uri, String refspec) throws IOException {
<span class="line-added"> 338         return fetch(uri != null ? uri.toString() : null, refspec);</span>
<span class="line-added"> 339     }</span>
<span class="line-added"> 340 </span>
<span class="line-added"> 341     private Hash fetch(String from, String refspec) throws IOException {</span>
 342         var oldHeads = new HashSet&lt;Hash&gt;(heads());
 343 
 344         var cmd = new ArrayList&lt;String&gt;();
 345         cmd.add(&quot;hg&quot;);
 346         cmd.add(&quot;pull&quot;);
 347         if (refspec != null) {
 348             cmd.add(&quot;--rev&quot;);
 349             cmd.add(refspec);
 350         }
<span class="line-modified"> 351         if (from != null) {</span>
<span class="line-modified"> 352             cmd.add(from);</span>
 353         }
 354         try (var p = capture(cmd)) {
 355             await(p);
 356         }
 357 
 358         var newHeads = new HashSet&lt;Hash&gt;(heads());
 359         newHeads.removeAll(oldHeads);
 360 
 361         if (newHeads.size() &gt; 1) {
 362             throw new IllegalStateException(&quot;fetching multiple heads is not supported&quot;);
 363         } else if (newHeads.size() == 0) {
 364             // no new head was fetched, return current head
 365             return head();
 366         }
 367         return newHeads.iterator().next();
 368     }
 369 
 370     @Override
 371     public void fetchAll() throws IOException {
 372         var pullPaths = new ArrayList&lt;URI&gt;();
 373         try (var p = capture(&quot;hg&quot;, &quot;paths&quot;)) {
 374             var res = await(p);
 375             for (var line : res.stdout()) {
 376                 var parts = line.split(&quot;=&quot;);
 377                 var name = parts[0].trim();
 378                 var uri = parts[1].trim();
 379                 if (!name.endsWith(&quot;-push&quot;)) {
 380                     pullPaths.add(URI.create(uri));
 381                 }
 382             }
 383         }
 384 
 385         for (var uri : pullPaths) {
 386             fetch(uri, null);
 387         }
 388     }
 389 
<span class="line-added"> 390     @Override</span>
<span class="line-added"> 391     public void fetchRemote(String remote) throws IOException {</span>
<span class="line-added"> 392         fetch(remote, null);</span>
<span class="line-added"> 393     }</span>
<span class="line-added"> 394 </span>
 395     @Override
 396     public void delete(Branch b) throws IOException {
 397         throw new RuntimeException(&quot;Branches cannot be deleted in Mercurial&quot;);
 398     }
 399 
 400     @Override
 401     public Repository init() throws IOException {
 402         if (!Files.exists(dir)) {
 403             Files.createDirectories(dir);
 404         }
 405 
 406         try (var p = capture(&quot;hg&quot;, &quot;init&quot;)) {
 407             await(p);
 408             return this;
 409         }
 410     }
 411 
 412     @Override
 413     public void pushAll(URI uri) throws IOException {
 414         try (var p = capture(&quot;hg&quot;, &quot;push&quot;, &quot;--new-branch&quot;, uri.toString())) {
</pre>
</td>
</tr>
</table>
<center><a href="../git/GitRepository.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/java/org/openjdk/skara/vcs/RepositoryTests.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>