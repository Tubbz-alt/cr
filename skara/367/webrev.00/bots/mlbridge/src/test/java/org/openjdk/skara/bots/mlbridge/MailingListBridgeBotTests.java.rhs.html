<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.mlbridge;
  24 
  25 import org.openjdk.skara.email.EmailAddress;
  26 import org.openjdk.skara.forge.*;
  27 import org.openjdk.skara.network.URIBuilder;
  28 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  29 import org.openjdk.skara.test.*;
  30 import org.openjdk.skara.vcs.Repository;
  31 
  32 import org.junit.jupiter.api.*;
  33 
  34 import java.io.IOException;
  35 import java.nio.charset.StandardCharsets;
  36 import java.nio.file.*;
  37 import java.time.Duration;
  38 import java.util.*;
  39 import java.util.regex.Pattern;
  40 import java.util.stream.Collectors;
  41 
  42 import static org.junit.jupiter.api.Assertions.*;
  43 
  44 class MailingListBridgeBotTests {
  45     private Optional&lt;String&gt; archiveContents(Path archive) {
  46         try {
  47             var mbox = Files.find(archive, 50, (path, attrs) -&gt; path.toString().endsWith(&quot;.mbox&quot;)).findAny();
  48             if (mbox.isEmpty()) {
  49                 return Optional.empty();
  50             }
  51             return Optional.of(Files.readString(mbox.get(), StandardCharsets.UTF_8));
  52         } catch (IOException e) {
  53             return Optional.empty();
  54         }
  55 
  56     }
  57 
  58     private boolean archiveContains(Path archive, String text) {
  59         return archiveContainsCount(archive, text) &gt; 0;
  60     }
  61 
  62     private int archiveContainsCount(Path archive, String text) {
  63         var lines = archiveContents(archive);
  64         if (lines.isEmpty()) {
  65             return 0;
  66         }
  67         var pattern = Pattern.compile(text);
  68         int count = 0;
  69         for (var line : lines.get().split(&quot;\\R&quot;)) {
  70             var matcher = pattern.matcher(line);
  71             if (matcher.find()) {
  72                 count++;
  73             }
  74         }
  75         return count;
  76     }
  77 
  78     private boolean webrevContains(Path webrev, String text) {
  79         try {
  80             var index = Files.find(webrev, 5, (path, attrs) -&gt; path.toString().endsWith(&quot;index.html&quot;)).findAny();
  81             if (index.isEmpty()) {
  82                 return false;
  83             }
  84             var lines = Files.readString(index.get(), StandardCharsets.UTF_8);
  85             return lines.contains(text);
  86         } catch (IOException e) {
  87             return false;
  88         }
  89     }
  90 
  91     private long countSubstrings(String string, String substring) {
  92         return Pattern.compile(substring).matcher(string).results().count();
  93     }
  94 
  95     private String noreplyAddress(HostedRepository repository) {
  96         return &quot;test+&quot; + repository.forge().currentUser().id() + &quot;+&quot; +
  97                 repository.forge().currentUser().userName() +
  98                 &quot;@openjdk.java.net&quot;;
  99     }
 100 
 101     @Test
 102     void simpleArchive(TestInfo testInfo) throws IOException {
 103         try (var credentials = new HostCredentials(testInfo);
 104              var tempFolder = new TemporaryDirectory();
 105              var archiveFolder = new TemporaryDirectory();
 106              var webrevFolder = new TemporaryDirectory();
 107              var listServer = new TestMailmanServer();
 108              var webrevServer = new TestWebrevServer()) {
 109             var author = credentials.getHostedRepository();
 110             var archive = credentials.getHostedRepository();
 111             var ignored = credentials.getHostedRepository();
 112             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 113             var censusBuilder = credentials.getCensusBuilder()
 114                                            .addAuthor(author.forge().currentUser().id());
 115             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 116             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 117                                                  censusBuilder.build(), &quot;master&quot;, listAddress,
 118                                                  Set.of(ignored.forge().currentUser().userName()),
 119                                                  Set.of(),
 120                                                  listServer.getArchive(), listServer.getSMTP(),
 121                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 122                                                  webrevServer.uri(),
 123                                                  Set.of(&quot;rfr&quot;), Map.of(ignored.forge().currentUser().userName(),
 124                                                                        Pattern.compile(&quot;ready&quot;)),
 125                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 126                                                  Map.of(&quot;Extra1&quot;, &quot;val1&quot;, &quot;Extra2&quot;, &quot;val2&quot;),
 127                                                  Duration.ZERO);
 128 
 129             // Populate the projects repository
 130             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 131             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 132             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 133             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 134 
 135             // Make a change with a corresponding PR
 136             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 137                                                                &quot;Change msg\n\nWith several lines&quot;);
 138             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 139             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 140             pr.setBody(&quot;This should not be ready&quot;);
 141 
 142             // Run an archive pass
 143             TestBotRunner.runPeriodicItems(mlBot);
 144 
 145             // A PR that isn&#39;t ready for review should not be archived
 146             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 147             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 148 
 149             // Flag it as ready for review
 150             pr.setBody(&quot;This should now be ready&quot;);
 151             pr.addLabel(&quot;rfr&quot;);
 152 
 153             // Run another archive pass
 154             TestBotRunner.runPeriodicItems(mlBot);
 155 
 156             // But it should still not be archived
 157             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 158             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 159 
 160             // Now post a general comment - not a ready marker
 161             var ignoredPr = ignored.pullRequest(pr.id());
 162             ignoredPr.addComment(&quot;hello there&quot;);
 163 
 164             // Run another archive pass
 165             TestBotRunner.runPeriodicItems(mlBot);
 166 
 167             // It should still not be archived
 168             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 169             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 170 
 171             // Now post a ready comment
 172             ignoredPr.addComment(&quot;ready&quot;);
 173 
 174             // Run another archive pass
 175             TestBotRunner.runPeriodicItems(mlBot);
 176 
 177             // The archive should now contain an entry
 178             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 179             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 180             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
 181             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
 182             assertTrue(archiveContains(archiveFolder.path(), &quot;Changes:&quot;));
 183             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
 184             assertTrue(archiveContains(archiveFolder.path(), webrevServer.uri().toString()));
 185             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));
 186             assertTrue(archiveContains(archiveFolder.path(), &quot;Issue:&quot;));
 187             assertTrue(archiveContains(archiveFolder.path(), &quot;http://issues.test/browse/TSTPRJ-1234&quot;));
 188             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch:&quot;));
 189             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - &quot; + editHash.abbreviate() + &quot;: Change msg&quot;));
 190             assertFalse(archiveContains(archiveFolder.path(), &quot;With several lines&quot;));
 191 
 192             // The mailing list as well
 193             listServer.processIncoming();
 194             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 195             var mailmanList = mailmanServer.getList(listAddress.address());
 196             var conversations = mailmanList.conversations(Duration.ofDays(1));
 197             assertEquals(1, conversations.size());
 198             var mail = conversations.get(0).first();
 199             assertEquals(&quot;RFR: 1234: This is a pull request&quot;, mail.subject());
 200             assertEquals(pr.author().fullName(), mail.author().fullName().orElseThrow());
 201             assertEquals(noreplyAddress(archive), mail.author().address());
 202             assertEquals(listAddress, mail.sender());
 203             assertEquals(&quot;val1&quot;, mail.headerValue(&quot;Extra1&quot;));
 204             assertEquals(&quot;val2&quot;, mail.headerValue(&quot;Extra2&quot;));
 205 
 206             // And there should be a webrev
 207             Repository.materialize(webrevFolder.path(), archive.url(), &quot;webrev&quot;);
 208             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
 209             var comments = pr.comments();
 210             var webrevComments = comments.stream()
 211                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
 212                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 213                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 214                                          .collect(Collectors.toList());
 215             assertEquals(1, webrevComments.size());
 216 
 217             // Add a comment
 218             pr.addComment(&quot;This is a comment :smile:&quot;);
 219 
 220             // Add a comment from an ignored user as well
 221             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);
 222 
 223             // Run another archive pass
 224             TestBotRunner.runPeriodicItems(mlBot);
 225 
 226             // The archive should now contain the comment, but not the ignored one
 227             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 228             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a comment&quot;));
 229             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This should now be ready&quot;));
 230             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 231 
 232             listServer.processIncoming();
 233             conversations = mailmanList.conversations(Duration.ofDays(1));
 234             assertEquals(1, conversations.size());
 235             assertEquals(2, conversations.get(0).allMessages().size());
 236 
 237             // Remove the rfr flag and post another comment
 238             pr.addLabel(&quot;rfr&quot;);
 239             pr.addComment(&quot;This is another comment&quot;);
 240 
 241             // Run another archive pass
 242             TestBotRunner.runPeriodicItems(mlBot);
 243 
 244             // The archive should contain the additional comment
 245             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 246             assertTrue(archiveContains(archiveFolder.path(), &quot;This is another comment&quot;));
 247             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This should now be ready&quot;));
 248 
 249             listServer.processIncoming();
 250             conversations = mailmanList.conversations(Duration.ofDays(1));
 251             assertEquals(1, conversations.size());
 252             assertEquals(3, conversations.get(0).allMessages().size());
 253             for (var newMail : conversations.get(0).allMessages()) {
 254                 assertEquals(noreplyAddress(archive), newMail.author().address());
 255                 assertEquals(listAddress, newMail.sender());
 256             }
 257             assertTrue(conversations.get(0).allMessages().get(2).body().contains(&quot;This is a comment 😄&quot;));
 258         }
 259     }
 260 
 261     @Test
 262     void reviewComment(TestInfo testInfo) throws IOException {
 263         try (var credentials = new HostCredentials(testInfo);
 264              var tempFolder = new TemporaryDirectory();
 265              var archiveFolder = new TemporaryDirectory();
 266              var listServer = new TestMailmanServer();
 267              var webrevServer = new TestWebrevServer()) {
 268             var author = credentials.getHostedRepository();
 269             var archive = credentials.getHostedRepository();
 270             var ignored = credentials.getHostedRepository();
 271             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 272             var censusBuilder = credentials.getCensusBuilder()
 273                                            .addAuthor(author.forge().currentUser().id());
 274             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 275             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 276                                                  censusBuilder.build(), &quot;master&quot;, listAddress,
 277                                                  Set.of(ignored.forge().currentUser().userName()),
 278                                                  Set.of(),
 279                                                  listServer.getArchive(), listServer.getSMTP(),
 280                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 281                                                  webrevServer.uri(),
 282                                                  Set.of(), Map.of(),
 283                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 284                                                  Map.of(), Duration.ZERO);
 285 
 286             // Populate the projects repository
 287             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 288             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 289             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 290             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 291             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 292 
 293             // Make a change with a corresponding PR
 294             var editHash = CheckableRepository.appendAndCommit(localRepo);
 295             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 296             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 297             pr.setBody(&quot;This is now ready&quot;);
 298             TestBotRunner.runPeriodicItems(mlBot);
 299             listServer.processIncoming();
 300 
 301             // And make a file specific comment
 302             var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
 303             var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 304 
 305             // Add one from an ignored user as well
 306             var ignoredPr = ignored.pullRequest(pr.id());
 307             ignoredPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Don&#39;t mind me&quot;);
 308 
 309             // Process comments
 310             TestBotRunner.runPeriodicItems(mlBot);
 311             listServer.processIncoming();
 312 
 313             // The archive should now contain an entry
 314             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 315             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 316             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 317             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 318             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This is now ready&quot;));
 319             assertTrue(archiveContains(archiveFolder.path(), reviewFile.toString()));
 320             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 321 
 322             // The mailing list as well
 323             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 324             var mailmanList = mailmanServer.getList(listAddress.address());
 325             var conversations = mailmanList.conversations(Duration.ofDays(1));
 326             assertEquals(1, conversations.size());
 327             var mail = conversations.get(0).first();
 328             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 329 
 330             // Comment on the comment
 331             pr.addReviewCommentReply(comment, &quot;This is a review reply&quot;);
 332             TestBotRunner.runPeriodicItems(mlBot);
 333             listServer.processIncoming();
 334 
 335             // The archive should contain the additional comment (but no quoted footers)
 336             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 337             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a review reply&quot;));
 338             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This is now ready&quot;));
 339             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; PR:&quot;));
 340 
 341             // As well as the mailing list
 342             conversations = mailmanList.conversations(Duration.ofDays(1));
 343             assertEquals(1, conversations.size());
 344             assertEquals(3, conversations.get(0).allMessages().size());
 345             for (var newMail : conversations.get(0).allMessages()) {
 346                 assertEquals(noreplyAddress(archive), newMail.author().address());
 347                 assertEquals(listAddress, newMail.sender());
 348             }
 349         }
 350     }
 351 
 352     @Test
 353     void combineComments(TestInfo testInfo) throws IOException {
 354         try (var credentials = new HostCredentials(testInfo);
 355              var tempFolder = new TemporaryDirectory();
 356              var archiveFolder = new TemporaryDirectory();
 357              var listServer = new TestMailmanServer();
 358              var webrevServer = new TestWebrevServer()) {
 359             var author = credentials.getHostedRepository();
 360             var archive = credentials.getHostedRepository();
 361             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 362             var censusBuilder = credentials.getCensusBuilder()
 363                                            .addAuthor(author.forge().currentUser().id());
 364             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 365             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 366                                                  censusBuilder.build(), &quot;master&quot;,
 367                                                  listAddress, Set.of(), Set.of(),
 368                                                  listServer.getArchive(),
 369                                                  listServer.getSMTP(),
 370                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 371                                                  webrevServer.uri(),
 372                                                  Set.of(), Map.of(),
 373                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 374                                                  Map.of(), Duration.ZERO);
 375 
 376             // Populate the projects repository
 377             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 378             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 379             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 380             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 381             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 382 
 383             // Make a change with a corresponding PR
 384             var editHash = CheckableRepository.appendAndCommit(localRepo);
 385             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 386             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 387             pr.setBody(&quot;This is now ready&quot;);
 388             pr.addComment(&quot;Avoid combining&quot;);
 389 
 390             TestBotRunner.runPeriodicItems(mlBot);
 391             listServer.processIncoming();
 392             listServer.processIncoming();
 393 
 394             // Make several file specific comments
 395             var first = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 396             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 397             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Further review comment&quot;);
 398             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Final review comment&quot;);
 399             TestBotRunner.runPeriodicItems(mlBot);
 400             listServer.processIncoming();
 401 
 402             // The archive should contain a combined entry
 403             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 404             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 405 
 406             // As well as the mailing list
 407             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 408             var mailmanList = mailmanServer.getList(listAddress.address());
 409             var conversations = mailmanList.conversations(Duration.ofDays(1));
 410             assertEquals(1, conversations.size());
 411             var mail = conversations.get(0).first();
 412             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 413             assertEquals(3, conversations.get(0).allMessages().size());
 414 
 415             var commentReply = conversations.get(0).replies(mail).get(0);
 416             assertEquals(2, commentReply.body().split(&quot;^On.*wrote:&quot;).length);
 417             assertTrue(commentReply.body().contains(&quot;Avoid combining\n\n&quot;), commentReply.body());
 418 
 419             var reviewReply = conversations.get(0).replies(mail).get(1);
 420             assertEquals(2, reviewReply.body().split(&quot;^On.*wrote:&quot;).length);
 421             assertEquals(2, reviewReply.body().split(&quot;&gt; This is now ready&quot;).length, reviewReply.body());
 422             assertEquals(&quot;Re: RFR: This is a pull request&quot;, reviewReply.subject());
 423             assertTrue(reviewReply.body().contains(&quot;Review comment\n\n&quot;), reviewReply.body());
 424             assertTrue(reviewReply.body().contains(&quot;Another review comment&quot;), reviewReply.body());
 425 
 426             // Now reply to the first (collapsed) comment
 427             pr.addReviewCommentReply(first, &quot;I agree&quot;);
 428             TestBotRunner.runPeriodicItems(mlBot);
 429             listServer.processIncoming();
 430 
 431             // The archive should contain a new entry
 432             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 433             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 434 
 435             // The combined review comments should only appear unquoted once
 436             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^Another review comment&quot;));
 437         }
 438     }
 439 
 440     @Test
 441     void commentThreading(TestInfo testInfo) throws IOException {
 442         try (var credentials = new HostCredentials(testInfo);
 443              var tempFolder = new TemporaryDirectory();
 444              var archiveFolder = new TemporaryDirectory();
 445              var listServer = new TestMailmanServer();
 446              var webrevServer = new TestWebrevServer()) {
 447             var author = credentials.getHostedRepository();
 448             var reviewer = credentials.getHostedRepository();
 449             var archive = credentials.getHostedRepository();
 450             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 451             var censusBuilder = credentials.getCensusBuilder()
 452                                            .addReviewer(reviewer.forge().currentUser().id())
 453                                            .addAuthor(author.forge().currentUser().id());
 454             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 455             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 456                                                  censusBuilder.build(), &quot;master&quot;,
 457                                                  listAddress, Set.of(), Set.of(),
 458                                                  listServer.getArchive(),
 459                                                  listServer.getSMTP(),
 460                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 461                                                  webrevServer.uri(),
 462                                                  Set.of(), Map.of(),
 463                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 464                                                  Map.of(), Duration.ZERO);
 465 
 466             // Populate the projects repository
 467             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 468             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 469             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 470             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 471             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 472 
 473             // Make a change with a corresponding PR
 474             var editHash = CheckableRepository.appendAndCommit(localRepo);
 475             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 476             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 477             pr.setBody(&quot;This is now ready&quot;);
 478             TestBotRunner.runPeriodicItems(mlBot);
 479             listServer.processIncoming();
 480 
 481             // Make a file specific comment
 482             var reviewPr = reviewer.pullRequest(pr.id());
 483             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 484             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 485             reviewPr.addReviewCommentReply(comment1, &quot;Great&quot;);
 486             TestBotRunner.runPeriodicItems(mlBot);
 487             listServer.processIncoming();
 488             listServer.processIncoming();
 489             listServer.processIncoming();
 490 
 491             // And a second one by ourselves
 492             var comment2 = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 493             reviewPr.addReviewCommentReply(comment2, &quot;Sounds good&quot;);
 494             pr.addReviewCommentReply(comment2, &quot;Thanks&quot;);
 495             TestBotRunner.runPeriodicItems(mlBot);
 496             listServer.processIncoming();
 497             listServer.processIncoming();
 498             listServer.processIncoming();
 499 
 500             // Finally some approvals and another comment
 501             pr.addReview(Review.Verdict.APPROVED, &quot;Nice&quot;);
 502             reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;The final review comment&quot;);
 503             reviewPr.addReview(Review.Verdict.APPROVED, &quot;Looks fine&quot;);
 504             reviewPr.addReviewCommentReply(comment2, &quot;You are welcome&quot;);
 505             TestBotRunner.runPeriodicItems(mlBot);
 506             listServer.processIncoming();
 507             listServer.processIncoming();
 508             listServer.processIncoming();
 509 
 510             // Sanity check the archive
 511             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 512             assertEquals(9, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 513 
 514             // File specific comments should appear after the approval
 515             var archiveText = archiveContents(archiveFolder.path()).orElseThrow();
 516             assertTrue(archiveText.indexOf(&quot;Looks fine&quot;) &lt; archiveText.indexOf(&quot;The final review comment&quot;));
 517 
 518             // Check the mailing list
 519             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 520             var mailmanList = mailmanServer.getList(listAddress.address());
 521             var conversations = mailmanList.conversations(Duration.ofDays(1));
 522             assertEquals(1, conversations.size());
 523             var mail = conversations.get(0).first();
 524             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 525             assertEquals(10, conversations.get(0).allMessages().size());
 526 
 527             // There should be four separate threads
 528             var thread1 = conversations.get(0).replies(mail).get(0);
 529             assertEquals(2, thread1.body().split(&quot;^On.*wrote:&quot;).length);
 530             assertEquals(2, thread1.body().split(&quot;&gt; This is now ready&quot;).length, thread1.body());
 531             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread1.subject());
 532             assertTrue(thread1.body().contains(&quot;Review comment\n\n&quot;), thread1.body());
 533             assertFalse(thread1.body().contains(&quot;Another review comment&quot;), thread1.body());
 534             var thread1reply1 = conversations.get(0).replies(thread1).get(0);
 535             assertTrue(thread1reply1.body().contains(&quot;I agree&quot;));
 536             assertEquals(noreplyAddress(archive), thread1reply1.author().address());
 537             assertEquals(archive.forge().currentUser().fullName(), thread1reply1.author().fullName().orElseThrow());
 538             var thread1reply2 = conversations.get(0).replies(thread1reply1).get(0);
 539             assertTrue(thread1reply2.body().contains(&quot;Great&quot;));
 540             assertEquals(&quot;integrationreviewer1@openjdk.java.net&quot;, thread1reply2.author().address());
 541             assertEquals(&quot;Generated Reviewer 1&quot;, thread1reply2.author().fullName().orElseThrow());
 542 
 543             var thread2 = conversations.get(0).replies(mail).get(1);
 544             assertEquals(2, thread2.body().split(&quot;^On.*wrote:&quot;).length);
 545             assertEquals(2, thread2.body().split(&quot;&gt; This is now ready&quot;).length, thread2.body());
 546             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread2.subject());
 547             assertFalse(thread2.body().contains(&quot;Review comment\n\n&quot;), thread2.body());
 548             assertTrue(thread2.body().contains(&quot;Another review comment&quot;), thread2.body());
 549             var thread2reply1 = conversations.get(0).replies(thread2).get(0);
 550             assertTrue(thread2reply1.body().contains(&quot;Sounds good&quot;));
 551             var thread2reply2 = conversations.get(0).replies(thread2reply1).get(0);
 552             assertTrue(thread2reply2.body().contains(&quot;Thanks&quot;));
 553 
 554             var replies = conversations.get(0).replies(mail);
 555             var thread3 = replies.get(2);
 556             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread3.subject());
 557             var thread4 = replies.get(3);
 558             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread4.subject());
 559             assertTrue(thread4.body().contains(&quot;Looks fine&quot;));
 560             assertTrue(thread4.body().contains(&quot;The final review comment&quot;));
 561             assertTrue(thread4.body().contains(&quot;Marked as reviewed by integrationreviewer1 (Reviewer)&quot;));
 562         }
 563     }
 564 
 565     @Test
 566     void commentThreadingSeparated(TestInfo testInfo) throws IOException {
 567         try (var credentials = new HostCredentials(testInfo);
 568              var tempFolder = new TemporaryDirectory();
 569              var archiveFolder = new TemporaryDirectory();
 570              var listServer = new TestMailmanServer();
 571              var webrevServer = new TestWebrevServer()) {
 572             var author = credentials.getHostedRepository();
 573             var reviewer = credentials.getHostedRepository();
 574             var archive = credentials.getHostedRepository();
 575             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 576             var censusBuilder = credentials.getCensusBuilder()
 577                                            .addReviewer(reviewer.forge().currentUser().id())
 578                                            .addAuthor(author.forge().currentUser().id());
 579             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 580             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;, censusBuilder.build(), &quot;master&quot;,
 581                                                  listAddress, Set.of(), Set.of(),
 582                                                  listServer.getArchive(),
 583                                                  listServer.getSMTP(),
 584                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 585                                                  webrevServer.uri(),
 586                                                  Set.of(), Map.of(),
 587                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 588                                                  Map.of(), Duration.ZERO);
 589 
 590             // Populate the projects repository
 591             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 592             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 593             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 594             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 595             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 596 
 597             // Make a change with a corresponding PR
 598             var editHash = CheckableRepository.appendAndCommit(localRepo);
 599             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 600             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 601             pr.setBody(&quot;This is now ready&quot;);
 602             TestBotRunner.runPeriodicItems(mlBot);
 603             listServer.processIncoming();
 604 
 605             // Make two file specific comments
 606             var reviewPr = reviewer.pullRequest(pr.id());
 607             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 608             var comment2 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 609             TestBotRunner.runPeriodicItems(mlBot);
 610             listServer.processIncoming();
 611 
 612             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 613             pr.addReviewCommentReply(comment2, &quot;I don&#39;t agree&quot;);
 614             TestBotRunner.runPeriodicItems(mlBot);
 615             listServer.processIncoming();
 616 
 617             // Sanity check the archive
 618             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 619             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 620         }
 621     }
 622 
 623     @Test
 624     void reviewContext(TestInfo testInfo) throws IOException {
 625         try (var credentials = new HostCredentials(testInfo);
 626              var tempFolder = new TemporaryDirectory();
 627              var archiveFolder = new TemporaryDirectory();
 628              var listServer = new TestMailmanServer();
 629              var webrevServer = new TestWebrevServer()) {
 630             var author = credentials.getHostedRepository();
 631             var archive = credentials.getHostedRepository();
 632             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 633             var censusBuilder = credentials.getCensusBuilder()
 634                                            .addAuthor(author.forge().currentUser().id());
 635             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 636             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 637                                                  censusBuilder.build(), &quot;master&quot;,
 638                                                  listAddress, Set.of(), Set.of(),
 639                                                  listServer.getArchive(),
 640                                                  listServer.getSMTP(),
 641                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 642                                                  webrevServer.uri(),
 643                                                  Set.of(), Map.of(),
 644                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 645                                                  Map.of(), Duration.ZERO);
 646 
 647             // Populate the projects repository
 648             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 649             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 650             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 651             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 652             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 653 
 654             // Make a change with a corresponding PR
 655             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
 656             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 657             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 658             pr.setBody(&quot;This is now ready&quot;);
 659             TestBotRunner.runPeriodicItems(mlBot);
 660             listServer.processIncoming();
 661 
 662             // Make a file specific comment
 663             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 664 
 665             TestBotRunner.runPeriodicItems(mlBot);
 666             listServer.processIncoming();
 667 
 668             // The archive should only contain context around line 2
 669             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 670             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
 671             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
 672             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
 673         }
 674     }
 675 
 676     @Test
 677     void multipleReviewContexts(TestInfo testInfo) throws IOException {
 678         try (var credentials = new HostCredentials(testInfo);
 679              var tempFolder = new TemporaryDirectory();
 680              var archiveFolder = new TemporaryDirectory();
 681              var listServer = new TestMailmanServer();
 682              var webrevServer = new TestWebrevServer()) {
 683             var author = credentials.getHostedRepository();
 684             var archive = credentials.getHostedRepository();
 685             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 686             var censusBuilder = credentials.getCensusBuilder()
 687                                            .addAuthor(author.forge().currentUser().id());
 688             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 689             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 690                                                  censusBuilder.build(), &quot;master&quot;,
 691                                                  listAddress, Set.of(), Set.of(),
 692                                                  listServer.getArchive(),
 693                                                  listServer.getSMTP(),
 694                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 695                                                  webrevServer.uri(),
 696                                                  Set.of(), Map.of(),
 697                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 698                                                  Map.of(), Duration.ZERO);
 699 
 700             // Populate the projects repository
 701             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 702             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 703             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 704             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 705             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 706             var initialHash = CheckableRepository.appendAndCommit(localRepo,
 707                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
 708                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
 709                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
 710                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
 711                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
 712                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
 713             localRepo.push(initialHash, author.url(), &quot;master&quot;);
 714 
 715             // Make a change with a corresponding PR
 716             var current = Files.readString(localRepo.root().resolve(reviewFile), StandardCharsets.UTF_8);
 717             var updated = current.replaceAll(&quot;Line 2&quot;, &quot;Line 2 edit\nLine 2.5&quot;);
 718             updated = updated.replaceAll(&quot;Line 13&quot;, &quot;Line 12.5\nLine 13 edit&quot;);
 719             Files.writeString(localRepo.root().resolve(reviewFile), updated, StandardCharsets.UTF_8);
 720             var editHash = CheckableRepository.appendAndCommit(localRepo);
 721             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 722             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 723             pr.setBody(&quot;This is now ready&quot;);
 724             TestBotRunner.runPeriodicItems(mlBot);
 725             listServer.processIncoming();
 726 
 727             // Make file specific comments
 728             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 7, &quot;Review comment&quot;);
 729             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 24, &quot;Another review comment&quot;);
 730 
 731             TestBotRunner.runPeriodicItems(mlBot);
 732             listServer.processIncoming();
 733 
 734             // The archive should only contain context around line 2 and 20
 735             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 736             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 7&quot;));
 737             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 6: Line 1$&quot;));
 738             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 7: Line 2 edit$&quot;));
 739             assertFalse(archiveContains(archiveFolder.path(), &quot;Line 3&quot;));
 740 
 741             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 24&quot;));
 742             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 23: Line 12.5$&quot;));
 743             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 24: Line 13 edit$&quot;));
 744             assertFalse(archiveContains(archiveFolder.path(), &quot;^Line 15&quot;));
 745         }
 746     }
 747 
 748     @Test
 749     void filterComments(TestInfo testInfo) throws IOException {
 750         try (var credentials = new HostCredentials(testInfo);
 751              var tempFolder = new TemporaryDirectory();
 752              var archiveFolder = new TemporaryDirectory();
 753              var listServer = new TestMailmanServer();
 754              var webrevServer = new TestWebrevServer()) {
 755             var author = credentials.getHostedRepository();
 756             var archive = credentials.getHostedRepository();
 757             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 758             var censusBuilder = credentials.getCensusBuilder()
 759                                            .addAuthor(author.forge().currentUser().id());
 760             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 761             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 762                                                  censusBuilder.build(), &quot;master&quot;,
 763                                                  listAddress, Set.of(), Set.of(),
 764                                                  listServer.getArchive(), listServer.getSMTP(),
 765                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 766                                                  webrevServer.uri(),
 767                                                  Set.of(), Map.of(),
 768                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 769                                                  Map.of(), Duration.ZERO);
 770 
 771             // Populate the projects repository
 772             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 773             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 774             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 775             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 776             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 777 
 778             // Make a change with a corresponding PR
 779             var editHash = CheckableRepository.appendAndCommit(localRepo);
 780             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 781             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 782             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
 783                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
 784 
 785             // Make a bunch of comments
 786             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
 787             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment &lt;!-- this is a comment --&gt;\n&quot;);
 788             pr.addComment(&quot;/integrate stuff&quot;);
 789             TestBotRunner.runPeriodicItems(mlBot);
 790 
 791             // Run an archive pass
 792             TestBotRunner.runPeriodicItems(mlBot);
 793 
 794             // The archive should not contain the comment
 795             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 796             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 797             assertFalse(archiveContains(archiveFolder.path(), &quot;this is a comment&quot;));
 798             assertFalse(archiveContains(archiveFolder.path(), &quot;Status stuff&quot;));
 799             assertTrue(archiveContains(archiveFolder.path(), &quot;And this is not&quot;));
 800             assertFalse(archiveContains(archiveFolder.path(), &quot;&lt;!--&quot;));
 801             assertFalse(archiveContains(archiveFolder.path(), &quot;--&gt;&quot;));
 802             assertTrue(archiveContains(archiveFolder.path(), &quot;Plain comment&quot;));
 803             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 804             assertFalse(archiveContains(archiveFolder.path(), &quot;/integrate&quot;));
 805         }
 806     }
 807 
 808     @Test
 809     void incrementalChanges(TestInfo testInfo) throws IOException {
 810         try (var credentials = new HostCredentials(testInfo);
 811              var tempFolder = new TemporaryDirectory();
 812              var archiveFolder = new TemporaryDirectory();
 813              var listServer = new TestMailmanServer();
 814              var webrevServer = new TestWebrevServer()) {
 815             var author = credentials.getHostedRepository();
 816             var archive = credentials.getHostedRepository();
 817             var commenter = credentials.getHostedRepository();
 818             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 819             var censusBuilder = credentials.getCensusBuilder()
 820                                            .addAuthor(author.forge().currentUser().id());
 821             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 822             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 823                                                  censusBuilder.build(), &quot;master&quot;,
 824                                                  listAddress, Set.of(), Set.of(),
 825                                                  listServer.getArchive(), listServer.getSMTP(),
 826                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 827                                                  webrevServer.uri(),
 828                                                  Set.of(), Map.of(),
 829                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 830                                                  Map.of(), Duration.ZERO);
 831 
 832             // Populate the projects repository
 833             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 834             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 835             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 836             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 837             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 838 
 839             // Make a change with a corresponding PR
 840             var editHash = CheckableRepository.appendAndCommit(localRepo);
 841             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 842             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 843             pr.setBody(&quot;This is now ready&quot;);
 844 
 845             // Run an archive pass
 846             TestBotRunner.runPeriodicItems(mlBot);
 847             listServer.processIncoming();
 848 
 849             var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
 850             localRepo.push(nextHash, author.url(), &quot;edit&quot;);
 851 
 852             // Make sure that the push registered
 853             var lastHeadHash = pr.headHash();
 854             var refreshCount = 0;
 855             do {
 856                 pr = author.pullRequest(pr.id());
 857                 if (refreshCount++ &gt; 100) {
 858                     fail(&quot;The PR did not update after the new push&quot;);
 859                 }
 860             } while (pr.headHash().equals(lastHeadHash));
 861 
 862             // Run another archive pass
 863             TestBotRunner.runPeriodicItems(mlBot);
 864             TestBotRunner.runPeriodicItems(mlBot);
 865             TestBotRunner.runPeriodicItems(mlBot);
 866             listServer.processIncoming();
 867 
 868             // The archive should reference the updated push
 869             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 870             assertTrue(archiveContains(archiveFolder.path(), &quot;1 additional commit&quot;));
 871             assertTrue(archiveContains(archiveFolder.path(), &quot;full.*/&quot; + pr.id() + &quot;/webrev.01&quot;));
 872             assertTrue(archiveContains(archiveFolder.path(), &quot;inc.*/&quot; + pr.id() + &quot;/webrev.00-01&quot;));
 873             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
 874             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
 875             assertTrue(archiveContains(archiveFolder.path(), &quot;Fixing&quot;));
 876 
 877             // The webrev comment should be updated
 878             var comments = pr.comments();
 879             var webrevComments = comments.stream()
 880                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
 881                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
<a name="1" id="anc1"></a><span class="line-added"> 882                                          .filter(comment -&gt; comment.body().contains(&quot;Full&quot;))</span>
<span class="line-added"> 883                                          .filter(comment -&gt; comment.body().contains(&quot;Incremental&quot;))</span>
 884                                          .filter(comment -&gt; comment.body().contains(nextHash.hex()))
 885                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 886                                          .collect(Collectors.toList());
 887             assertEquals(1, webrevComments.size());
 888 
 889             // Check that sender address is set properly
 890             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 891             var mailmanList = mailmanServer.getList(listAddress.address());
 892             var conversations = mailmanList.conversations(Duration.ofDays(1));
 893             assertEquals(1, conversations.size());
 894             for (var newMail : conversations.get(0).allMessages()) {
 895                 assertEquals(noreplyAddress(archive), newMail.author().address());
 896                 assertEquals(listAddress, newMail.sender());
 897             }
 898 
 899             // Add a comment
 900             var commenterPr = commenter.pullRequest(pr.id());
 901             commenterPr.addReviewComment(masterHash, nextHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 902             TestBotRunner.runPeriodicItems(mlBot);
 903             listServer.processIncoming();
 904 
 905             // Ensure that additional updates are only reported once
 906             for (int i = 0; i &lt; 3; ++i) {
 907                 var anotherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fixing&quot;);
 908                 localRepo.push(anotherHash, author.url(), &quot;edit&quot;);
 909 
 910                 // Make sure that the push registered
 911                 lastHeadHash = pr.headHash();
 912                 refreshCount = 0;
 913                 do {
 914                     pr = author.pullRequest(pr.id());
 915                     if (refreshCount++ &gt; 100) {
 916                         fail(&quot;The PR did not update after the new push&quot;);
 917                     }
 918                 } while (pr.headHash().equals(lastHeadHash));
 919 
 920                 TestBotRunner.runPeriodicItems(mlBot);
 921                 TestBotRunner.runPeriodicItems(mlBot);
 922                 listServer.processIncoming();
 923             }
 924             var updatedConversations = mailmanList.conversations(Duration.ofDays(1));
 925             assertEquals(1, updatedConversations.size());
 926             var conversation = updatedConversations.get(0);
 927             assertEquals(6, conversation.allMessages().size());
 928             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(1).subject());
 929             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(2).subject(), conversation.allMessages().get(2).toString());
 930             assertEquals(&quot;Re: [Rev 04] RFR: This is a pull request&quot;, conversation.allMessages().get(5).subject());
 931         }
 932     }
 933 
 934     @Test
 935     void rebased(TestInfo testInfo) throws IOException {
 936         try (var credentials = new HostCredentials(testInfo);
 937              var tempFolder = new TemporaryDirectory();
 938              var archiveFolder = new TemporaryDirectory();
 939              var listServer = new TestMailmanServer();
 940              var webrevServer = new TestWebrevServer()) {
 941             var author = credentials.getHostedRepository();
 942             var archive = credentials.getHostedRepository();
 943             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 944             var censusBuilder = credentials.getCensusBuilder()
 945                                            .addAuthor(author.forge().currentUser().id());
 946             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 947             var mlBot = new MailingListBridgeBot(sender, author, archive, &quot;master&quot;,
 948                                                  censusBuilder.build(), &quot;master&quot;,
 949                                                  listAddress, Set.of(), Set.of(),
 950                                                  listServer.getArchive(), listServer.getSMTP(),
 951                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 952                                                  webrevServer.uri(),
 953                                                  Set.of(), Map.of(),
 954                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 955                                                  Map.of(), Duration.ZERO);
 956 
 957             // Populate the projects repository
 958             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 959             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
 960             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 961             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 962             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 963 
 964             // Make a change with a corresponding PR
 965             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
 966             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 967             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 968             pr.setBody(&quot;This is now ready&quot;);
 969 
 970             // Run an archive pass
 971             TestBotRunner.runPeriodicItems(mlBot);
 972             listServer.processIncoming();
 973 
 974             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.url(), &quot;master&quot;);
 975             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
 976             newLocalRepo.push(newEditHash, author.url(), &quot;edit&quot;, true);
 977 
 978             // Make sure that the push registered
 979             var lastHeadHash = pr.headHash();
 980             var refreshCount = 0;
 981             do {
 982                 pr = author.pullRequest(pr.id());
 983                 if (refreshCount++ &gt; 100) {
 984                     fail(&quot;The PR did not update after the new push&quot;);
 985                 }
 986             } while (pr.headHash().equals(lastHeadHash));
 987 
 988             // Run another archive pass
 989             TestBotRunner.runPeriodicItems(mlBot);
 990             listServer.processIncoming();
 991 
 992             // The archive should reference the rebased push
 993             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 994             assertTrue(archiveContains(archiveFolder.path(), &quot;updated with a new target base&quot;));
 995             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.01&quot;));
 996             assertFalse(archiveContains(archiveFolder.path(), &quot;Incremental&quot;));
 997             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
 998             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
 999             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1000             assertTrue(archiveContains(archiveFolder.path(), &quot;Replaced msg&quot;));
1001 
1002             // The webrev comment should be updated
1003             var comments = pr.comments();
1004             var webrevComments = comments.stream()
1005                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1006                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1007                                          .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
1008                                          .collect(Collectors.toList());
1009             assertEquals(1, webrevComments.size());
1010 
1011             // Check that sender address is set properly
1012             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1013             var mailmanList = mailmanServer.getList(listAddress.address());
1014             var conversations = mailmanList.conversations(Duration.ofDays(1));
1015             assertEquals(1, conversations.size());
1016             for (var newMail : conversations.get(0).allMessages()) {
1017                 assertEquals(noreplyAddress(archive), newMail.author().address());
1018                 assertEquals(listAddress, newMail.sender());
1019                 assertFalse(newMail.hasHeader(&quot;PR-Head-Hash&quot;));
1020             }
1021             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversations.get(0).allMessages().get(1).subject());
1022         }
1023     }
1024 
1025     @Test
1026     void incrementalAfterRebase(TestInfo testInfo) throws IOException {
1027         try (var credentials = new HostCredentials(testInfo);
1028              var tempFolder = new TemporaryDirectory();
1029              var archiveFolder = new TemporaryDirectory();
1030              var listServer = new TestMailmanServer();
1031              var webrevServer = new TestWebrevServer()) {
1032             var author = credentials.getHostedRepository();
1033             var archive = credentials.getHostedRepository();
1034             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1035             var censusBuilder = credentials.getCensusBuilder()
1036                                            .addAuthor(author.forge().currentUser().id());
1037             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1038             var mlBot = new MailingListBridgeBot(sender, author, archive, &quot;archive&quot;,
1039                                                  censusBuilder.build(), &quot;master&quot;,
1040                                                  listAddress, Set.of(), Set.of(),
1041                                                  listServer.getArchive(), listServer.getSMTP(),
1042                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
1043                                                  webrevServer.uri(),
1044                                                  Set.of(), Map.of(),
1045                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
1046                                                  Map.of(), Duration.ZERO);
1047 
1048             // Populate the projects repository
1049             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1050             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1051             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1052             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1053             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1054             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1055 
1056             // Make a change with a corresponding PR
1057             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1058             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1059             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1060             pr.setBody(&quot;This is now ready&quot;);
1061 
1062             // Run an archive pass
1063             TestBotRunner.runPeriodicItems(mlBot);
1064             listServer.processIncoming();
1065 
1066             // Push more stuff to master
1067             localRepo.checkout(masterHash, true);
1068             var unrelatedFile = localRepo.root().resolve(&quot;unrelated.txt&quot;);
1069             Files.writeString(unrelatedFile, &quot;Other things happens in master&quot;);
1070             localRepo.add(unrelatedFile);
1071             var newMasterHash = localRepo.commit(&quot;Unrelated change&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1072             localRepo.push(newMasterHash, author.url(), &quot;master&quot;);
1073 
1074             // And more stuff to the pr branch
1075             localRepo.checkout(editHash, true);
1076             CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;More updates&quot;);
1077 
1078             // Merge master
1079             localRepo.merge(newMasterHash);
1080             var newEditHash = localRepo.commit(&quot;Latest changes from master&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1081             localRepo.push(newEditHash, author.url(), &quot;edit&quot;);
1082 
1083             // Make sure that the push registered
1084             var lastHeadHash = pr.headHash();
1085             var refreshCount = 0;
1086             do {
1087                 pr = author.pullRequest(pr.id());
1088                 if (refreshCount++ &gt; 100) {
1089                     fail(&quot;The PR did not update after the new push&quot;);
1090                 }
1091             } while (pr.headHash().equals(lastHeadHash));
1092 
1093             // Run another archive pass
1094             TestBotRunner.runPeriodicItems(mlBot);
1095             listServer.processIncoming();
1096 
1097             // The archive should reference the rebased push
1098             Repository.materialize(archiveFolder.path(), archive.url(), &quot;archive&quot;);
1099             assertTrue(archiveContains(archiveFolder.path(), &quot;updated with a new target base&quot;));
1100             assertTrue(archiveContains(archiveFolder.path(), &quot;excludes the unrelated changes&quot;));
1101             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.01&quot;));
1102             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.00-01&quot;));
1103             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1104             assertTrue(archiveContains(archiveFolder.path(), &quot;More updates&quot;));
1105         }
1106     }
1107 
1108     @Test
1109     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
1110         try (var credentials = new HostCredentials(testInfo);
1111              var tempFolder = new TemporaryDirectory();
1112              var archiveFolder = new TemporaryDirectory();
1113              var webrevFolder = new TemporaryDirectory();
1114              var listServer = new TestMailmanServer();
1115              var webrevServer = new TestWebrevServer()) {
1116             var author = credentials.getHostedRepository();
1117             var archive = credentials.getHostedRepository();
1118             var ignored = credentials.getHostedRepository();
1119             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1120             var censusBuilder = credentials.getCensusBuilder()
1121                                            .addAuthor(author.forge().currentUser().id());
1122             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1123             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
1124                                                  censusBuilder.build(), &quot;master&quot;,
1125                                                  listAddress,
1126                                                  Set.of(ignored.forge().currentUser().userName()),
1127                                                  Set.of(),
1128                                                  listServer.getArchive(), listServer.getSMTP(),
1129                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
1130                                                  webrevServer.uri(),
1131                                                  Set.of(), Map.of(),
1132                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
1133                                                  Map.of(), Duration.ZERO);
1134 
1135             // Populate the projects repository
1136             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1137             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1138             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1139             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1140 
1141             // Make a change with a corresponding PR
1142             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
1143                                                                &quot;Change msg\n\nWith several lines&quot;);
1144             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1145             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1146 
1147             // Flag it as ready for review
1148             pr.setBody(&quot;This should now be ready&quot;);
1149 
1150             // Run an archive pass
1151             TestBotRunner.runPeriodicItems(mlBot);
1152 
1153             // The archive should now contain an entry
1154             var archiveRepo = Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1155             assertTrue(archiveContains(archiveFolder.path(), editHash.abbreviate()));
1156 
1157             // And there should be a webrev comment
1158             var comments = pr.comments();
1159             var webrevComments = comments.stream()
1160                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1161                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1162                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
1163                                          .collect(Collectors.toList());
1164             assertEquals(1, webrevComments.size());
1165             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
1166 
1167             // Pretend the archive didn&#39;t work out
1168             archiveRepo.push(masterHash, archive.url(), &quot;master&quot;, true);
1169 
1170             // Run another archive pass
1171             TestBotRunner.runPeriodicItems(mlBot);
1172 
1173             // The webrev comment should not contain duplicate entries
1174             comments = pr.comments();
1175             webrevComments = comments.stream()
1176                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1177                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1178                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
1179                                          .collect(Collectors.toList());
1180             assertEquals(1, webrevComments.size());
1181             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
1182         }
1183     }
1184 
1185     @Test
1186     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
1187         try (var credentials = new HostCredentials(testInfo);
1188              var tempFolder = new TemporaryDirectory();
1189              var archiveFolder = new TemporaryDirectory();
1190              var listServer = new TestMailmanServer();
1191              var webrevServer = new TestWebrevServer()) {
1192             var author = credentials.getHostedRepository();
1193             var archive = credentials.getHostedRepository();
1194             var reviewer = credentials.getHostedRepository();
1195             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1196             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1197             var censusBuilder = credentials.getCensusBuilder()
1198                                            .addReviewer(reviewer.forge().currentUser().id())
1199                                            .addAuthor(author.forge().currentUser().id());
1200             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
1201                                                  censusBuilder.build(), &quot;master&quot;,
1202                                                  listAddress, Set.of(), Set.of(),
1203                                                  listServer.getArchive(), listServer.getSMTP(),
1204                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
1205                                                  webrevServer.uri(),
1206                                                  Set.of(), Map.of(),
1207                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
1208                                                  Map.of(), Duration.ZERO);
1209 
1210             // Populate the projects repository
1211             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1212             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1213             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1214             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1215             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1216 
1217             // Make a change with a corresponding PR
1218             var editHash = CheckableRepository.appendAndCommit(localRepo);
1219             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1220             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1221             pr.setBody(&quot;This is now ready&quot;);
1222 
1223             // Run an archive pass
1224             TestBotRunner.runPeriodicItems(mlBot);
1225 
1226             // First unapprove it
1227             var reviewedPr = reviewer.pullRequest(pr.id());
1228             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
1229             TestBotRunner.runPeriodicItems(mlBot);
1230             TestBotRunner.runPeriodicItems(mlBot);
1231             TestBotRunner.runPeriodicItems(mlBot);
1232 
1233             // The archive should contain a note
1234             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1235             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
1236             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot; by integrationreviewer1&quot;));
1237             if (author.forge().supportsReviewBody()) {
1238                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
1239             }
1240 
1241             // Then approve it
1242             reviewedPr.addReview(Review.Verdict.APPROVED, &quot;Reason 2&quot;);
1243             TestBotRunner.runPeriodicItems(mlBot);
1244             TestBotRunner.runPeriodicItems(mlBot);
1245             TestBotRunner.runPeriodicItems(mlBot);
1246 
1247             // The archive should contain another note
1248             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1249             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Marked as reviewed by &quot;));
1250             if (author.forge().supportsReviewBody()) {
1251                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 2&quot;));
1252             }
1253             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Re: RFR:&quot;));
1254 
1255             // Yet another change
1256             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 3&quot;);
1257             TestBotRunner.runPeriodicItems(mlBot);
1258             TestBotRunner.runPeriodicItems(mlBot);
1259             TestBotRunner.runPeriodicItems(mlBot);
1260 
1261             // The archive should contain another note
1262             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1263             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
1264             if (author.forge().supportsReviewBody()) {
1265                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
1266             }
1267         }
1268     }
1269 
1270     @Test
1271     void ignoreComments(TestInfo testInfo) throws IOException {
1272         try (var credentials = new HostCredentials(testInfo);
1273              var tempFolder = new TemporaryDirectory();
1274              var archiveFolder = new TemporaryDirectory();
1275              var listServer = new TestMailmanServer();
1276              var webrevServer = new TestWebrevServer()) {
1277             var author = credentials.getHostedRepository();
1278             var ignored = credentials.getHostedRepository();
1279             var archive = credentials.getHostedRepository();
1280             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1281             var censusBuilder = credentials.getCensusBuilder()
1282                                            .addAuthor(author.forge().currentUser().id());
1283             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1284             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
1285                                                  censusBuilder.build(), &quot;master&quot;,
1286                                                  listAddress,
1287                                                  Set.of(ignored.forge().currentUser().userName()),
1288                                                  Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)),
1289                                                  listServer.getArchive(), listServer.getSMTP(),
1290                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
1291                                                  webrevServer.uri(),
1292                                                  Set.of(), Map.of(),
1293                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
1294                                                  Map.of(), Duration.ZERO);
1295 
1296             // Populate the projects repository
1297             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1298             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1299             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1300             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1301             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1302 
1303             // Make a change with a corresponding PR
1304             var editHash = CheckableRepository.appendAndCommit(localRepo);
1305             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1306             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1307             pr.setBody(&quot;This is now ready&quot;);
1308 
1309             // Make a bunch of comments
1310             pr.addComment(&quot;Plain comment&quot;);
1311             pr.addComment(&quot;ignore this comment&quot;);
1312             pr.addComment(&quot;I think it is time to\nignore this comment!&quot;);
1313             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review ignore this comment&quot;);
1314 
1315             var ignoredPR = ignored.pullRequest(pr.id());
1316             ignoredPR.addComment(&quot;Don&#39;t mind me&quot;);
1317 
1318             TestBotRunner.runPeriodicItems(mlBot);
1319             TestBotRunner.runPeriodicItems(mlBot);
1320 
1321             // The archive should not contain the ignored comments
1322             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1323             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
1324             assertFalse(archiveContains(archiveFolder.path(), &quot;ignore this comment&quot;));
1325             assertFalse(archiveContains(archiveFolder.path(), &quot;it is time to&quot;));
1326             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
1327             assertFalse(archiveContains(archiveFolder.path(), &quot;Review ignore&quot;));
1328         }
1329     }
1330 }
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>