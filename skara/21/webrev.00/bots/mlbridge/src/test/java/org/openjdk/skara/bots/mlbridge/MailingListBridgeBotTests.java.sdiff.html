<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="MailingListArchiveReaderBotTests.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.bots.mlbridge;
 24 
 25 import org.openjdk.skara.email.EmailAddress;
 26 import org.openjdk.skara.host.Review;
 27 import org.openjdk.skara.host.network.URIBuilder;
 28 import org.openjdk.skara.mailinglist.MailingListServerFactory;
 29 import org.openjdk.skara.test.*;
 30 import org.openjdk.skara.vcs.Repository;
 31 
 32 import org.junit.jupiter.api.*;
 33 
 34 import java.io.IOException;
 35 import java.nio.charset.StandardCharsets;
 36 import java.nio.file.*;
 37 import java.time.Duration;
<span class="line-modified"> 38 import java.util.Set;</span>
 39 import java.util.regex.Pattern;
 40 import java.util.stream.Collectors;
 41 
 42 import static org.junit.jupiter.api.Assertions.*;
 43 
 44 class MailingListBridgeBotTests {
 45     private boolean archiveContains(Path archive, String text) {
 46         return archiveContainsCount(archive, text) &gt; 0;
 47     }
 48 
 49     private int archiveContainsCount(Path archive, String text) {
 50         try {
 51             var mbox = Files.find(archive, 50, (path, attrs) -&gt; path.toString().endsWith(&quot;.mbox&quot;)).findAny();
 52             if (mbox.isEmpty()) {
 53                 return 0;
 54             }
 55             var lines = Files.readString(mbox.get(), StandardCharsets.UTF_8);
 56             var pattern = Pattern.compile(text);
 57             int count = 0;
 58             for (var line : lines.split(&quot;\\R&quot;)) {
</pre>
<hr />
<pre>
 85     }
 86 
 87     @Test
 88     void simpleArchive(TestInfo testInfo) throws IOException {
 89         try (var credentials = new HostCredentials(testInfo);
 90              var tempFolder = new TemporaryDirectory();
 91              var archiveFolder = new TemporaryDirectory();
 92              var webrevFolder = new TemporaryDirectory();
 93              var listServer = new TestMailmanServer()) {
 94             var author = credentials.getHostedRepository();
 95             var archive = credentials.getHostedRepository();
 96             var ignored = credentials.getHostedRepository();
 97             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 98             var censusBuilder = credentials.getCensusBuilder()
 99                                            .addAuthor(author.host().getCurrentUserDetails().id());
100             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
101             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress,
102                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
103                                                  listServer.getArchive(), listServer.getSMTP(),
104                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified">105                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build());</span>


106 
107             // Populate the projects repository
108             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
109             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
110             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
111             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
112 
113             // Make a change with a corresponding PR
114             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
115                                                                &quot;Change msg\n\nWith several lines&quot;);
116             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
117             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
118             pr.setBody(&quot;This should not be ready&quot;);
119 
120             // Run an archive pass
121             TestBotRunner.runPeriodicItems(mlBot);
122 
123             // A PR that isn&#39;t ready for review should not be archived
124             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
125             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
</pre>
<hr />
<pre>
114             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
115                                                                &quot;Change msg\n\nWith several lines&quot;);
116             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
117             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
118             pr.setBody(&quot;This should not be ready&quot;);
119 
120             // Run an archive pass
121             TestBotRunner.runPeriodicItems(mlBot);
122 
123             // A PR that isn&#39;t ready for review should not be archived
124             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
125             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
126 
127             // Flag it as ready for review
128             pr.setBody(&quot;This should now be ready&quot;);
129             pr.addLabel(&quot;rfr&quot;);
130 
131             // Run another archive pass
132             TestBotRunner.runPeriodicItems(mlBot);
133 





















134             // The archive should now contain an entry
135             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
136             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
137             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
138             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
139             assertTrue(archiveContains(archiveFolder.path(), &quot;Pull request:&quot;));
140             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
141             assertTrue(archiveContains(archiveFolder.path(), &quot;http://www.test.test/&quot;));
142             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));
143             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch command:&quot;));
144             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - &quot; + editHash.abbreviate() + &quot;:\tChange msg&quot;));
145             assertTrue(archiveContains(archiveFolder.path(), &quot;^\t\t\tWith several lines&quot;));
146 
147             // The mailing list as well
148             listServer.processIncoming();
149             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
150             var mailmanList = mailmanServer.getList(listAddress.address());
151             var conversations = mailmanList.conversations(Duration.ofDays(1));
152             assertEquals(1, conversations.size());
153             var mail = conversations.get(0).first();
</pre>
<hr />
<pre>
154             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
155             assertEquals(pr.getAuthor().fullName() + &quot; via &quot; + pr.repository().getUrl().getHost(), mail.author().fullName().orElseThrow());
156             assertEquals(from.address(), mail.author().address());
157             assertEquals(from, mail.sender());
158 
159             // And there should be a webrev
160             Repository.materialize(webrevFolder.path(), archive.getUrl(), &quot;webrev&quot;);
161             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
162             var comments = pr.getComments();
163             var webrevComments = comments.stream()
164                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
165                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
166                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
167                                          .collect(Collectors.toList());
168             assertEquals(1, webrevComments.size());
169 
170             // Add a comment
171             pr.addComment(&quot;This is a comment&quot;);
172 
173             // Add a comment from an ignored user as well
<span class="line-removed">174             var ignoredPr = ignored.getPullRequest(pr.getId());</span>
175             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);
176 
177             // Run another archive pass
178             TestBotRunner.runPeriodicItems(mlBot);
179 
180             // The archive should now contain the comment, but not the ignored one
181             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
182             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a comment&quot;));
183             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This should now be ready&quot;));
184             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
185 
186             listServer.processIncoming();
187             conversations = mailmanList.conversations(Duration.ofDays(1));
188             assertEquals(1, conversations.size());
189             assertEquals(2, conversations.get(0).allMessages().size());
190 
191             // Remove the rfr flag and post another comment
192             pr.addLabel(&quot;rfr&quot;);
193             pr.addComment(&quot;This is another comment&quot;);
194 
</pre>
<hr />
<pre>
211         }
212     }
213 
214     @Test
215     void reviewComment(TestInfo testInfo) throws IOException {
216         try (var credentials = new HostCredentials(testInfo);
217              var tempFolder = new TemporaryDirectory();
218              var archiveFolder = new TemporaryDirectory();
219              var listServer = new TestMailmanServer()) {
220             var author = credentials.getHostedRepository();
221             var archive = credentials.getHostedRepository();
222             var ignored = credentials.getHostedRepository();
223             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
224             var censusBuilder = credentials.getCensusBuilder()
225                                            .addAuthor(author.host().getCurrentUserDetails().id());
226             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
227             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress,
228                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
229                                                  listServer.getArchive(), listServer.getSMTP(),
230                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified">231                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build());</span>

232 
233             // Populate the projects repository
234             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
235             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
236             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
237             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
238             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
239 
240             // Make a change with a corresponding PR
241             var editHash = CheckableRepository.appendAndCommit(localRepo);
242             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
243             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
<span class="line-removed">244             pr.addLabel(&quot;rfr&quot;);</span>
245             pr.setBody(&quot;This is now ready&quot;);
246             TestBotRunner.runPeriodicItems(mlBot);
247             listServer.processIncoming();
248 
249             // And make a file specific comment
250             var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
251             var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
252 
253             // Add one from an ignored user as well
254             var ignoredPr = ignored.getPullRequest(pr.getId());
255             ignoredPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Don&#39;t mind me&quot;);
256 
257             // Process comments
258             TestBotRunner.runPeriodicItems(mlBot);
259             listServer.processIncoming();
260 
261             // The archive should now contain an entry
262             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
263             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
264             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
</pre>
<hr />
<pre>
294                 assertEquals(from, newMail.sender());
295             }
296         }
297     }
298 
299     @Test
300     void combineComments(TestInfo testInfo) throws IOException {
301         try (var credentials = new HostCredentials(testInfo);
302              var tempFolder = new TemporaryDirectory();
303              var archiveFolder = new TemporaryDirectory();
304              var listServer = new TestMailmanServer()) {
305             var author = credentials.getHostedRepository();
306             var archive = credentials.getHostedRepository();
307             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
308             var censusBuilder = credentials.getCensusBuilder()
309                                            .addAuthor(author.host().getCurrentUserDetails().id());
310             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
311             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress, Set.of(), listServer.getArchive(),
312                                                  listServer.getSMTP(),
313                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified">314                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build());</span>

315 
316             // Populate the projects repository
317             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
318             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
319             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
320             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
321             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
322 
323             // Make a change with a corresponding PR
324             var editHash = CheckableRepository.appendAndCommit(localRepo);
325             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
326             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
<span class="line-removed">327             pr.addLabel(&quot;rfr&quot;);</span>
328             pr.setBody(&quot;This is now ready&quot;);
329             TestBotRunner.runPeriodicItems(mlBot);
330             listServer.processIncoming();
331 
332             // Make two file specific comments
333             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
334             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
335             TestBotRunner.runPeriodicItems(mlBot);
336             listServer.processIncoming();
337 
338             // The archive should not contain a combined entry
339             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
340             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
341 
342             // But the mailing list should
343             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
344             var mailmanList = mailmanServer.getList(listAddress.address());
345             var conversations = mailmanList.conversations(Duration.ofDays(1));
346             assertEquals(1, conversations.size());
347             var mail = conversations.get(0).first();
</pre>
<hr />
<pre>
355             assertTrue(reply.body().contains(&quot;Review comment\n\n&quot;), reply.body());
356             assertTrue(reply.body().contains(&quot;Another review comment&quot;), reply.body());
357         }
358     }
359 
360     @Test
361     void reviewContext(TestInfo testInfo) throws IOException {
362         try (var credentials = new HostCredentials(testInfo);
363              var tempFolder = new TemporaryDirectory();
364              var archiveFolder = new TemporaryDirectory();
365              var listServer = new TestMailmanServer()) {
366             var author = credentials.getHostedRepository();
367             var archive = credentials.getHostedRepository();
368             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
369             var censusBuilder = credentials.getCensusBuilder()
370                                            .addAuthor(author.host().getCurrentUserDetails().id());
371             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
372             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress, Set.of(), listServer.getArchive(),
373                                                  listServer.getSMTP(),
374                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified">375                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build());</span>

376 
377             // Populate the projects repository
378             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
379             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
380             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
381             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
382             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
383 
384             // Make a change with a corresponding PR
385             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
386             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
387             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
<span class="line-removed">388             pr.addLabel(&quot;rfr&quot;);</span>
389             pr.setBody(&quot;This is now ready&quot;);
390             TestBotRunner.runPeriodicItems(mlBot);
391             listServer.processIncoming();
392 
393             // Make a file specific comment
394             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
395 
396             TestBotRunner.runPeriodicItems(mlBot);
397             listServer.processIncoming();
398 
399             // The archive should only contain context around line 2
400             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
401             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
402             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
403             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
404         }
405     }
406 
407     @Test
408     void filterComments(TestInfo testInfo) throws IOException {
</pre>
<hr />
<pre>
402             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
403             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
404         }
405     }
406 
407     @Test
408     void filterComments(TestInfo testInfo) throws IOException {
409         try (var credentials = new HostCredentials(testInfo);
410              var tempFolder = new TemporaryDirectory();
411              var archiveFolder = new TemporaryDirectory();
412              var listServer = new TestMailmanServer()) {
413             var author = credentials.getHostedRepository();
414             var archive = credentials.getHostedRepository();
415             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
416             var censusBuilder = credentials.getCensusBuilder()
417                                            .addAuthor(author.host().getCurrentUserDetails().id());
418             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
419             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress, Set.of(),
420                                                  listServer.getArchive(), listServer.getSMTP(),
421                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified">422                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build());</span>

423 
424             // Populate the projects repository
425             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
426             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
427             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
428             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
429             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
430 
431             // Make a change with a corresponding PR
432             var editHash = CheckableRepository.appendAndCommit(localRepo);
433             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
434             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
<span class="line-removed">435             pr.addLabel(&quot;rfr&quot;);</span>
436             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
437                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
438 
439             // Make a bunch of comments
440             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
441             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment &lt;!-- this is a comment --&gt;\n&quot;);
442             pr.addComment(&quot;/integrate stuff&quot;);
443             TestBotRunner.runPeriodicItems(mlBot);
444 
445             // Run an archive pass
446             TestBotRunner.runPeriodicItems(mlBot);
447 
448             // The archive should not contain the comment
449             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
450             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
451             assertFalse(archiveContains(archiveFolder.path(), &quot;this is a comment&quot;));
452             assertFalse(archiveContains(archiveFolder.path(), &quot;Status stuff&quot;));
453             assertTrue(archiveContains(archiveFolder.path(), &quot;And this is not&quot;));
454             assertFalse(archiveContains(archiveFolder.path(), &quot;&lt;!--&quot;));
455             assertFalse(archiveContains(archiveFolder.path(), &quot;--&gt;&quot;));
</pre>
<hr />
<pre>
457             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
458             assertFalse(archiveContains(archiveFolder.path(), &quot;/integrate&quot;));
459         }
460     }
461 
462     @Test
463     void incrementalChanges(TestInfo testInfo) throws IOException {
464         try (var credentials = new HostCredentials(testInfo);
465              var tempFolder = new TemporaryDirectory();
466              var archiveFolder = new TemporaryDirectory();
467              var listServer = new TestMailmanServer()) {
468             var author = credentials.getHostedRepository();
469             var archive = credentials.getHostedRepository();
470             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
471             var censusBuilder = credentials.getCensusBuilder()
472                                            .addAuthor(author.host().getCurrentUserDetails().id());
473             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
474             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress, Set.of(),
475                                                  listServer.getArchive(), listServer.getSMTP(),
476                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified">477                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build());</span>

478 
479             // Populate the projects repository
480             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
481             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
482             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
483             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
484             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
485 
486             // Make a change with a corresponding PR
487             var editHash = CheckableRepository.appendAndCommit(localRepo);
488             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
489             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
<span class="line-removed">490             pr.addLabel(&quot;rfr&quot;);</span>
491             pr.setBody(&quot;This is now ready&quot;);
492 
493             // Run an archive pass
494             TestBotRunner.runPeriodicItems(mlBot);
495             listServer.processIncoming();
496 
497             var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
498             localRepo.push(nextHash, author.getUrl(), &quot;edit&quot;);
499 
500             // Make sure that the push registered
501             var lastHeadHash = pr.getHeadHash();
502             var refreshCount = 0;
503             do {
504                 pr = author.getPullRequest(pr.getId());
505                 if (refreshCount++ &gt; 100) {
506                     fail(&quot;The PR did not update after the new push&quot;);
507                 }
508             } while (pr.getHeadHash().equals(lastHeadHash));
509 
510             // Run another archive pass
</pre>
<hr />
<pre>
566             var conversation = updatedConversations.get(0);
567             assertEquals(5, conversation.allMessages().size());
568         }
569     }
570 
571     @Test
572     void rebased(TestInfo testInfo) throws IOException {
573         try (var credentials = new HostCredentials(testInfo);
574              var tempFolder = new TemporaryDirectory();
575              var archiveFolder = new TemporaryDirectory();
576              var listServer = new TestMailmanServer()) {
577             var author = credentials.getHostedRepository();
578             var archive = credentials.getHostedRepository();
579             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
580             var censusBuilder = credentials.getCensusBuilder()
581                                            .addAuthor(author.host().getCurrentUserDetails().id());
582             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
583             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress, Set.of(),
584                                                  listServer.getArchive(), listServer.getSMTP(),
585                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified">586                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build());</span>

587 
588             // Populate the projects repository
589             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
590             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.getRepositoryType(), reviewFile);
591             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
592             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
593             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
594 
595             // Make a change with a corresponding PR
596             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
597             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
598             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
<span class="line-removed">599             pr.addLabel(&quot;rfr&quot;);</span>
600             pr.setBody(&quot;This is now ready&quot;);
601 
602             // Run an archive pass
603             TestBotRunner.runPeriodicItems(mlBot);
604             listServer.processIncoming();
605 
606             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.getUrl(), &quot;master&quot;);
607             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
608             newLocalRepo.push(newEditHash, author.getUrl(), &quot;edit&quot;, true);
609 
610             // Make sure that the push registered
611             var lastHeadHash = pr.getHeadHash();
612             var refreshCount = 0;
613             do {
614                 pr = author.getPullRequest(pr.getId());
615                 if (refreshCount++ &gt; 100) {
616                     fail(&quot;The PR did not update after the new push&quot;);
617                 }
618             } while (pr.getHeadHash().equals(lastHeadHash));
619 
</pre>
<hr />
<pre>
653     }
654 
655     @Test
656     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
657         try (var credentials = new HostCredentials(testInfo);
658              var tempFolder = new TemporaryDirectory();
659              var archiveFolder = new TemporaryDirectory();
660              var webrevFolder = new TemporaryDirectory();
661              var listServer = new TestMailmanServer()) {
662             var author = credentials.getHostedRepository();
663             var archive = credentials.getHostedRepository();
664             var ignored = credentials.getHostedRepository();
665             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
666             var censusBuilder = credentials.getCensusBuilder()
667                                            .addAuthor(author.host().getCurrentUserDetails().id());
668             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
669             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress,
670                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
671                                                  listServer.getArchive(), listServer.getSMTP(),
672                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified">673                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build());</span>

674 
675             // Populate the projects repository
676             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
677             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
678             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
679             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
680 
681             // Make a change with a corresponding PR
682             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
683                                                                &quot;Change msg\n\nWith several lines&quot;);
684             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
685             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
686 
687             // Flag it as ready for review
688             pr.setBody(&quot;This should now be ready&quot;);
<span class="line-removed">689             pr.addLabel(&quot;rfr&quot;);</span>
690 
691             // Run an archive pass
692             TestBotRunner.runPeriodicItems(mlBot);
693 
694             // The archive should now contain an entry
695             var archiveRepo = Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
696             assertTrue(archiveContains(archiveFolder.path(), editHash.abbreviate()));
697 
698             // And there should be a webrev comment
699             var comments = pr.getComments();
700             var webrevComments = comments.stream()
701                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
702                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
703                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
704                                          .collect(Collectors.toList());
705             assertEquals(1, webrevComments.size());
706             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
707 
708             // Pretend the archive didn&#39;t work out
709             archiveRepo.push(masterHash, archive.getUrl(), &quot;master&quot;, true);
</pre>
<hr />
<pre>
719                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
720                                          .collect(Collectors.toList());
721             assertEquals(1, webrevComments.size());
722             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
723         }
724     }
725 
726     @Test
727     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
728         try (var credentials = new HostCredentials(testInfo);
729              var tempFolder = new TemporaryDirectory();
730              var archiveFolder = new TemporaryDirectory();
731              var listServer = new TestMailmanServer()) {
732             var author = credentials.getHostedRepository();
733             var archive = credentials.getHostedRepository();
734             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
735             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
736             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress, Set.of(),
737                                                  listServer.getArchive(), listServer.getSMTP(),
738                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified">739                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build());</span>

740 
741             // Populate the projects repository
742             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
743             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
744             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
745             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
746             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
747 
748             // Make a change with a corresponding PR
749             var editHash = CheckableRepository.appendAndCommit(localRepo);
750             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
751             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
<span class="line-removed">752             pr.addLabel(&quot;rfr&quot;);</span>
753             pr.setBody(&quot;This is now ready&quot;);
754 
755             // Run an archive pass
756             TestBotRunner.runPeriodicItems(mlBot);
757 
758             // First unapprove it
759             var reviewedPr = credentials.getHostedRepository().getPullRequest(pr.getId());
760             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
761             TestBotRunner.runPeriodicItems(mlBot);
762             TestBotRunner.runPeriodicItems(mlBot);
763             TestBotRunner.runPeriodicItems(mlBot);
764 
765             // The archive should contain a note
766             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
767             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;This PR has been reviewed.*more changes are needed&quot;));
768             if (author.host().supportsReviewBody()) {
769                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
770             }
771 
772             // Then approve it
</pre>
</td>
<td>
<hr />
<pre>
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.bots.mlbridge;
 24 
 25 import org.openjdk.skara.email.EmailAddress;
 26 import org.openjdk.skara.host.Review;
 27 import org.openjdk.skara.host.network.URIBuilder;
 28 import org.openjdk.skara.mailinglist.MailingListServerFactory;
 29 import org.openjdk.skara.test.*;
 30 import org.openjdk.skara.vcs.Repository;
 31 
 32 import org.junit.jupiter.api.*;
 33 
 34 import java.io.IOException;
 35 import java.nio.charset.StandardCharsets;
 36 import java.nio.file.*;
 37 import java.time.Duration;
<span class="line-modified"> 38 import java.util.*;</span>
 39 import java.util.regex.Pattern;
 40 import java.util.stream.Collectors;
 41 
 42 import static org.junit.jupiter.api.Assertions.*;
 43 
 44 class MailingListBridgeBotTests {
 45     private boolean archiveContains(Path archive, String text) {
 46         return archiveContainsCount(archive, text) &gt; 0;
 47     }
 48 
 49     private int archiveContainsCount(Path archive, String text) {
 50         try {
 51             var mbox = Files.find(archive, 50, (path, attrs) -&gt; path.toString().endsWith(&quot;.mbox&quot;)).findAny();
 52             if (mbox.isEmpty()) {
 53                 return 0;
 54             }
 55             var lines = Files.readString(mbox.get(), StandardCharsets.UTF_8);
 56             var pattern = Pattern.compile(text);
 57             int count = 0;
 58             for (var line : lines.split(&quot;\\R&quot;)) {
</pre>
<hr />
<pre>
 85     }
 86 
 87     @Test
 88     void simpleArchive(TestInfo testInfo) throws IOException {
 89         try (var credentials = new HostCredentials(testInfo);
 90              var tempFolder = new TemporaryDirectory();
 91              var archiveFolder = new TemporaryDirectory();
 92              var webrevFolder = new TemporaryDirectory();
 93              var listServer = new TestMailmanServer()) {
 94             var author = credentials.getHostedRepository();
 95             var archive = credentials.getHostedRepository();
 96             var ignored = credentials.getHostedRepository();
 97             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 98             var censusBuilder = credentials.getCensusBuilder()
 99                                            .addAuthor(author.host().getCurrentUserDetails().id());
100             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
101             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress,
102                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
103                                                  listServer.getArchive(), listServer.getSMTP(),
104                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified">105                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),</span>
<span class="line-added">106                                                  Set.of(&quot;rfr&quot;), Map.of(ignored.host().getCurrentUserDetails().userName(),</span>
<span class="line-added">107                                                                        Pattern.compile(&quot;ready&quot;)));</span>
108 
109             // Populate the projects repository
110             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
111             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
112             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
113             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
114 
115             // Make a change with a corresponding PR
116             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
117                                                                &quot;Change msg\n\nWith several lines&quot;);
118             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
119             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
120             pr.setBody(&quot;This should not be ready&quot;);
121 
122             // Run an archive pass
123             TestBotRunner.runPeriodicItems(mlBot);
124 
125             // A PR that isn&#39;t ready for review should not be archived
126             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
127             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
</pre>
<hr />
<pre>
116             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
117                                                                &quot;Change msg\n\nWith several lines&quot;);
118             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
119             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
120             pr.setBody(&quot;This should not be ready&quot;);
121 
122             // Run an archive pass
123             TestBotRunner.runPeriodicItems(mlBot);
124 
125             // A PR that isn&#39;t ready for review should not be archived
126             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
127             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
128 
129             // Flag it as ready for review
130             pr.setBody(&quot;This should now be ready&quot;);
131             pr.addLabel(&quot;rfr&quot;);
132 
133             // Run another archive pass
134             TestBotRunner.runPeriodicItems(mlBot);
135 
<span class="line-added">136             // But it should still not be archived</span>
<span class="line-added">137             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);</span>
<span class="line-added">138             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));</span>
<span class="line-added">139 </span>
<span class="line-added">140             // Now post a general comment - not a ready marker</span>
<span class="line-added">141             var ignoredPr = ignored.getPullRequest(pr.getId());</span>
<span class="line-added">142             ignoredPr.addComment(&quot;hello there&quot;);</span>
<span class="line-added">143 </span>
<span class="line-added">144             // Run another archive pass</span>
<span class="line-added">145             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added">146 </span>
<span class="line-added">147             // It should still not be archived</span>
<span class="line-added">148             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);</span>
<span class="line-added">149             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));</span>
<span class="line-added">150 </span>
<span class="line-added">151             // Now post a ready comment</span>
<span class="line-added">152             ignoredPr.addComment(&quot;ready&quot;);</span>
<span class="line-added">153 </span>
<span class="line-added">154             // Run another archive pass</span>
<span class="line-added">155             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added">156 </span>
157             // The archive should now contain an entry
158             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
159             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
160             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
161             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
162             assertTrue(archiveContains(archiveFolder.path(), &quot;Pull request:&quot;));
163             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
164             assertTrue(archiveContains(archiveFolder.path(), &quot;http://www.test.test/&quot;));
165             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));
166             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch command:&quot;));
167             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - &quot; + editHash.abbreviate() + &quot;:\tChange msg&quot;));
168             assertTrue(archiveContains(archiveFolder.path(), &quot;^\t\t\tWith several lines&quot;));
169 
170             // The mailing list as well
171             listServer.processIncoming();
172             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
173             var mailmanList = mailmanServer.getList(listAddress.address());
174             var conversations = mailmanList.conversations(Duration.ofDays(1));
175             assertEquals(1, conversations.size());
176             var mail = conversations.get(0).first();
</pre>
<hr />
<pre>
177             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
178             assertEquals(pr.getAuthor().fullName() + &quot; via &quot; + pr.repository().getUrl().getHost(), mail.author().fullName().orElseThrow());
179             assertEquals(from.address(), mail.author().address());
180             assertEquals(from, mail.sender());
181 
182             // And there should be a webrev
183             Repository.materialize(webrevFolder.path(), archive.getUrl(), &quot;webrev&quot;);
184             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
185             var comments = pr.getComments();
186             var webrevComments = comments.stream()
187                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
188                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
189                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
190                                          .collect(Collectors.toList());
191             assertEquals(1, webrevComments.size());
192 
193             // Add a comment
194             pr.addComment(&quot;This is a comment&quot;);
195 
196             // Add a comment from an ignored user as well

197             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);
198 
199             // Run another archive pass
200             TestBotRunner.runPeriodicItems(mlBot);
201 
202             // The archive should now contain the comment, but not the ignored one
203             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
204             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a comment&quot;));
205             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This should now be ready&quot;));
206             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
207 
208             listServer.processIncoming();
209             conversations = mailmanList.conversations(Duration.ofDays(1));
210             assertEquals(1, conversations.size());
211             assertEquals(2, conversations.get(0).allMessages().size());
212 
213             // Remove the rfr flag and post another comment
214             pr.addLabel(&quot;rfr&quot;);
215             pr.addComment(&quot;This is another comment&quot;);
216 
</pre>
<hr />
<pre>
233         }
234     }
235 
236     @Test
237     void reviewComment(TestInfo testInfo) throws IOException {
238         try (var credentials = new HostCredentials(testInfo);
239              var tempFolder = new TemporaryDirectory();
240              var archiveFolder = new TemporaryDirectory();
241              var listServer = new TestMailmanServer()) {
242             var author = credentials.getHostedRepository();
243             var archive = credentials.getHostedRepository();
244             var ignored = credentials.getHostedRepository();
245             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
246             var censusBuilder = credentials.getCensusBuilder()
247                                            .addAuthor(author.host().getCurrentUserDetails().id());
248             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
249             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress,
250                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
251                                                  listServer.getArchive(), listServer.getSMTP(),
252                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified">253                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),</span>
<span class="line-added">254                                                  Set.of(), Map.of());</span>
255 
256             // Populate the projects repository
257             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
258             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
259             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
260             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
261             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
262 
263             // Make a change with a corresponding PR
264             var editHash = CheckableRepository.appendAndCommit(localRepo);
265             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
266             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);

267             pr.setBody(&quot;This is now ready&quot;);
268             TestBotRunner.runPeriodicItems(mlBot);
269             listServer.processIncoming();
270 
271             // And make a file specific comment
272             var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
273             var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
274 
275             // Add one from an ignored user as well
276             var ignoredPr = ignored.getPullRequest(pr.getId());
277             ignoredPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Don&#39;t mind me&quot;);
278 
279             // Process comments
280             TestBotRunner.runPeriodicItems(mlBot);
281             listServer.processIncoming();
282 
283             // The archive should now contain an entry
284             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
285             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
286             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
</pre>
<hr />
<pre>
316                 assertEquals(from, newMail.sender());
317             }
318         }
319     }
320 
321     @Test
322     void combineComments(TestInfo testInfo) throws IOException {
323         try (var credentials = new HostCredentials(testInfo);
324              var tempFolder = new TemporaryDirectory();
325              var archiveFolder = new TemporaryDirectory();
326              var listServer = new TestMailmanServer()) {
327             var author = credentials.getHostedRepository();
328             var archive = credentials.getHostedRepository();
329             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
330             var censusBuilder = credentials.getCensusBuilder()
331                                            .addAuthor(author.host().getCurrentUserDetails().id());
332             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
333             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress, Set.of(), listServer.getArchive(),
334                                                  listServer.getSMTP(),
335                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified">336                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),</span>
<span class="line-added">337                                                  Set.of(), Map.of());</span>
338 
339             // Populate the projects repository
340             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
341             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
342             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
343             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
344             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
345 
346             // Make a change with a corresponding PR
347             var editHash = CheckableRepository.appendAndCommit(localRepo);
348             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
349             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);

350             pr.setBody(&quot;This is now ready&quot;);
351             TestBotRunner.runPeriodicItems(mlBot);
352             listServer.processIncoming();
353 
354             // Make two file specific comments
355             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
356             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
357             TestBotRunner.runPeriodicItems(mlBot);
358             listServer.processIncoming();
359 
360             // The archive should not contain a combined entry
361             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
362             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
363 
364             // But the mailing list should
365             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
366             var mailmanList = mailmanServer.getList(listAddress.address());
367             var conversations = mailmanList.conversations(Duration.ofDays(1));
368             assertEquals(1, conversations.size());
369             var mail = conversations.get(0).first();
</pre>
<hr />
<pre>
377             assertTrue(reply.body().contains(&quot;Review comment\n\n&quot;), reply.body());
378             assertTrue(reply.body().contains(&quot;Another review comment&quot;), reply.body());
379         }
380     }
381 
382     @Test
383     void reviewContext(TestInfo testInfo) throws IOException {
384         try (var credentials = new HostCredentials(testInfo);
385              var tempFolder = new TemporaryDirectory();
386              var archiveFolder = new TemporaryDirectory();
387              var listServer = new TestMailmanServer()) {
388             var author = credentials.getHostedRepository();
389             var archive = credentials.getHostedRepository();
390             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
391             var censusBuilder = credentials.getCensusBuilder()
392                                            .addAuthor(author.host().getCurrentUserDetails().id());
393             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
394             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress, Set.of(), listServer.getArchive(),
395                                                  listServer.getSMTP(),
396                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified">397                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),</span>
<span class="line-added">398                                                  Set.of(), Map.of());</span>
399 
400             // Populate the projects repository
401             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
402             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
403             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
404             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
405             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
406 
407             // Make a change with a corresponding PR
408             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
409             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
410             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);

411             pr.setBody(&quot;This is now ready&quot;);
412             TestBotRunner.runPeriodicItems(mlBot);
413             listServer.processIncoming();
414 
415             // Make a file specific comment
416             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
417 
418             TestBotRunner.runPeriodicItems(mlBot);
419             listServer.processIncoming();
420 
421             // The archive should only contain context around line 2
422             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
423             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
424             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
425             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
426         }
427     }
428 
429     @Test
430     void filterComments(TestInfo testInfo) throws IOException {
</pre>
<hr />
<pre>
424             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
425             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
426         }
427     }
428 
429     @Test
430     void filterComments(TestInfo testInfo) throws IOException {
431         try (var credentials = new HostCredentials(testInfo);
432              var tempFolder = new TemporaryDirectory();
433              var archiveFolder = new TemporaryDirectory();
434              var listServer = new TestMailmanServer()) {
435             var author = credentials.getHostedRepository();
436             var archive = credentials.getHostedRepository();
437             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
438             var censusBuilder = credentials.getCensusBuilder()
439                                            .addAuthor(author.host().getCurrentUserDetails().id());
440             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
441             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress, Set.of(),
442                                                  listServer.getArchive(), listServer.getSMTP(),
443                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified">444                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),</span>
<span class="line-added">445                                                  Set.of(), Map.of());</span>
446 
447             // Populate the projects repository
448             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
449             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
450             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
451             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
452             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
453 
454             // Make a change with a corresponding PR
455             var editHash = CheckableRepository.appendAndCommit(localRepo);
456             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
457             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);

458             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
459                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
460 
461             // Make a bunch of comments
462             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
463             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment &lt;!-- this is a comment --&gt;\n&quot;);
464             pr.addComment(&quot;/integrate stuff&quot;);
465             TestBotRunner.runPeriodicItems(mlBot);
466 
467             // Run an archive pass
468             TestBotRunner.runPeriodicItems(mlBot);
469 
470             // The archive should not contain the comment
471             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
472             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
473             assertFalse(archiveContains(archiveFolder.path(), &quot;this is a comment&quot;));
474             assertFalse(archiveContains(archiveFolder.path(), &quot;Status stuff&quot;));
475             assertTrue(archiveContains(archiveFolder.path(), &quot;And this is not&quot;));
476             assertFalse(archiveContains(archiveFolder.path(), &quot;&lt;!--&quot;));
477             assertFalse(archiveContains(archiveFolder.path(), &quot;--&gt;&quot;));
</pre>
<hr />
<pre>
479             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
480             assertFalse(archiveContains(archiveFolder.path(), &quot;/integrate&quot;));
481         }
482     }
483 
484     @Test
485     void incrementalChanges(TestInfo testInfo) throws IOException {
486         try (var credentials = new HostCredentials(testInfo);
487              var tempFolder = new TemporaryDirectory();
488              var archiveFolder = new TemporaryDirectory();
489              var listServer = new TestMailmanServer()) {
490             var author = credentials.getHostedRepository();
491             var archive = credentials.getHostedRepository();
492             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
493             var censusBuilder = credentials.getCensusBuilder()
494                                            .addAuthor(author.host().getCurrentUserDetails().id());
495             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
496             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress, Set.of(),
497                                                  listServer.getArchive(), listServer.getSMTP(),
498                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified">499                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),</span>
<span class="line-added">500                                                  Set.of(), Map.of());</span>
501 
502             // Populate the projects repository
503             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
504             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
505             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
506             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
507             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
508 
509             // Make a change with a corresponding PR
510             var editHash = CheckableRepository.appendAndCommit(localRepo);
511             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
512             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);

513             pr.setBody(&quot;This is now ready&quot;);
514 
515             // Run an archive pass
516             TestBotRunner.runPeriodicItems(mlBot);
517             listServer.processIncoming();
518 
519             var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
520             localRepo.push(nextHash, author.getUrl(), &quot;edit&quot;);
521 
522             // Make sure that the push registered
523             var lastHeadHash = pr.getHeadHash();
524             var refreshCount = 0;
525             do {
526                 pr = author.getPullRequest(pr.getId());
527                 if (refreshCount++ &gt; 100) {
528                     fail(&quot;The PR did not update after the new push&quot;);
529                 }
530             } while (pr.getHeadHash().equals(lastHeadHash));
531 
532             // Run another archive pass
</pre>
<hr />
<pre>
588             var conversation = updatedConversations.get(0);
589             assertEquals(5, conversation.allMessages().size());
590         }
591     }
592 
593     @Test
594     void rebased(TestInfo testInfo) throws IOException {
595         try (var credentials = new HostCredentials(testInfo);
596              var tempFolder = new TemporaryDirectory();
597              var archiveFolder = new TemporaryDirectory();
598              var listServer = new TestMailmanServer()) {
599             var author = credentials.getHostedRepository();
600             var archive = credentials.getHostedRepository();
601             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
602             var censusBuilder = credentials.getCensusBuilder()
603                                            .addAuthor(author.host().getCurrentUserDetails().id());
604             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
605             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress, Set.of(),
606                                                  listServer.getArchive(), listServer.getSMTP(),
607                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified">608                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),</span>
<span class="line-added">609                                                  Set.of(), Map.of());</span>
610 
611             // Populate the projects repository
612             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
613             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.getRepositoryType(), reviewFile);
614             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
615             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
616             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
617 
618             // Make a change with a corresponding PR
619             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
620             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
621             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);

622             pr.setBody(&quot;This is now ready&quot;);
623 
624             // Run an archive pass
625             TestBotRunner.runPeriodicItems(mlBot);
626             listServer.processIncoming();
627 
628             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.getUrl(), &quot;master&quot;);
629             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
630             newLocalRepo.push(newEditHash, author.getUrl(), &quot;edit&quot;, true);
631 
632             // Make sure that the push registered
633             var lastHeadHash = pr.getHeadHash();
634             var refreshCount = 0;
635             do {
636                 pr = author.getPullRequest(pr.getId());
637                 if (refreshCount++ &gt; 100) {
638                     fail(&quot;The PR did not update after the new push&quot;);
639                 }
640             } while (pr.getHeadHash().equals(lastHeadHash));
641 
</pre>
<hr />
<pre>
675     }
676 
677     @Test
678     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
679         try (var credentials = new HostCredentials(testInfo);
680              var tempFolder = new TemporaryDirectory();
681              var archiveFolder = new TemporaryDirectory();
682              var webrevFolder = new TemporaryDirectory();
683              var listServer = new TestMailmanServer()) {
684             var author = credentials.getHostedRepository();
685             var archive = credentials.getHostedRepository();
686             var ignored = credentials.getHostedRepository();
687             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
688             var censusBuilder = credentials.getCensusBuilder()
689                                            .addAuthor(author.host().getCurrentUserDetails().id());
690             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
691             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress,
692                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
693                                                  listServer.getArchive(), listServer.getSMTP(),
694                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified">695                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),</span>
<span class="line-added">696                                                  Set.of(), Map.of());</span>
697 
698             // Populate the projects repository
699             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
700             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
701             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
702             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
703 
704             // Make a change with a corresponding PR
705             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
706                                                                &quot;Change msg\n\nWith several lines&quot;);
707             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
708             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
709 
710             // Flag it as ready for review
711             pr.setBody(&quot;This should now be ready&quot;);

712 
713             // Run an archive pass
714             TestBotRunner.runPeriodicItems(mlBot);
715 
716             // The archive should now contain an entry
717             var archiveRepo = Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
718             assertTrue(archiveContains(archiveFolder.path(), editHash.abbreviate()));
719 
720             // And there should be a webrev comment
721             var comments = pr.getComments();
722             var webrevComments = comments.stream()
723                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
724                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
725                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
726                                          .collect(Collectors.toList());
727             assertEquals(1, webrevComments.size());
728             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
729 
730             // Pretend the archive didn&#39;t work out
731             archiveRepo.push(masterHash, archive.getUrl(), &quot;master&quot;, true);
</pre>
<hr />
<pre>
741                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
742                                          .collect(Collectors.toList());
743             assertEquals(1, webrevComments.size());
744             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
745         }
746     }
747 
748     @Test
749     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
750         try (var credentials = new HostCredentials(testInfo);
751              var tempFolder = new TemporaryDirectory();
752              var archiveFolder = new TemporaryDirectory();
753              var listServer = new TestMailmanServer()) {
754             var author = credentials.getHostedRepository();
755             var archive = credentials.getHostedRepository();
756             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
757             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
758             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress, Set.of(),
759                                                  listServer.getArchive(), listServer.getSMTP(),
760                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-modified">761                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),</span>
<span class="line-added">762                                                  Set.of(), Map.of());</span>
763 
764             // Populate the projects repository
765             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
766             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
767             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
768             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
769             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
770 
771             // Make a change with a corresponding PR
772             var editHash = CheckableRepository.appendAndCommit(localRepo);
773             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
774             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);

775             pr.setBody(&quot;This is now ready&quot;);
776 
777             // Run an archive pass
778             TestBotRunner.runPeriodicItems(mlBot);
779 
780             // First unapprove it
781             var reviewedPr = credentials.getHostedRepository().getPullRequest(pr.getId());
782             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
783             TestBotRunner.runPeriodicItems(mlBot);
784             TestBotRunner.runPeriodicItems(mlBot);
785             TestBotRunner.runPeriodicItems(mlBot);
786 
787             // The archive should contain a note
788             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
789             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;This PR has been reviewed.*more changes are needed&quot;));
790             if (author.host().supportsReviewBody()) {
791                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
792             }
793 
794             // Then approve it
</pre>
</td>
</tr>
</table>
<center><a href="MailingListArchiveReaderBotTests.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>