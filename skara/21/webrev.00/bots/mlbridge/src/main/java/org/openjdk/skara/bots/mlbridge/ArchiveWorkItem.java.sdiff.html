<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/ArchiveWorkItem.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="MailingListBridgeBot.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/ArchiveWorkItem.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
528             var previousListStart = existing.get().body().indexOf(webrevListMarker) + webrevListMarker.length() + 1;
529             var previousList = existing.get().body().substring(previousListStart);
530             comment += previousList;
531             pr.updateComment(existing.get().id(), comment);
532         } else {
533             pr.addComment(comment);
534         }
535     }
536 
537     @Override
538     public void run(Path scratchPath) {
539         var path = scratchPath.resolve(&quot;mlbridge&quot;);
540         var archiveRepo = materializeArchive(path);
541         var mboxBasePath = path.resolve(bot.codeRepo().getName());
542         var mbox = MailingListServerFactory.createMboxFileServer(mboxBasePath);
543         var archive = mbox.getList(pr.getId());
544         var archiveMails = parseArchive(archive);
545 
546         // First determine if this PR should be inspected further or not
547         if (archiveMails.isEmpty()) {
<span class="line-modified">548             // Wait until the PR is ready for review</span>
<span class="line-modified">549             if (!pr.getLabels().contains(&quot;rfr&quot;)) {</span>
<span class="line-modified">550                 log.fine(&quot;PR is not yet ready for review&quot;);</span>
<span class="line-modified">551                 return;</span>
























552             }
553         }
554 
555         var webrevPath = scratchPath.resolve(&quot;mlbridge-webrevs&quot;);
556         var listServer = MailingListServerFactory.createMailmanServer(bot.listArchive(), bot.smtpServer());
557         var list = listServer.getList(bot.listAddress().address());
558         var newMails = new ArrayList&lt;Email&gt;();
559         var stableIdToMail = archiveMails.stream().collect(Collectors.toMap(email -&gt; getStableMessageId(email.id()),
560                                                                             Function.identity()));
<span class="line-removed">561         var comments = pr.getComments();</span>
562         var prInstance = new PullRequestInstance(scratchPath.resolve(&quot;mlbridge-mergebase&quot;), pr);
563 
564         // First post
565         if (archiveMails.isEmpty()) {
566             var webrev = bot.webrevStorage().createAndArchive(prInstance, webrevPath, prInstance.baseHash(),
567                                                               prInstance.headHash(), &quot;00&quot;);
568             var firstMail = newConversation(prInstance, webrev);
569             archive.post(firstMail);
570             newMails.add(firstMail);
571             stableIdToMail.put(getStableMessageId(firstMail.id()), firstMail);
572             updateWebrevComment(comments, 0, webrev, null);
573             log.fine(&quot;Posting new PR conversation&quot;);
574         } else {
575             // Determine the latest head hash reported
576             var reportedHeads = archiveMails.stream()
577                                             .filter(email -&gt; email.hasHeader(&quot;PR-Head-Hash&quot;))
578                                             .map(email -&gt; email.headerValue(&quot;PR-Head-Hash&quot;))
579                                             .map(Hash::new)
580                                             .collect(Collectors.toList());
581             var latestHead = reportedHeads.size() &gt; 0 ? reportedHeads.get(reportedHeads.size() - 1) : pr.getHeadHash();
</pre>
</td>
<td>
<hr />
<pre>
528             var previousListStart = existing.get().body().indexOf(webrevListMarker) + webrevListMarker.length() + 1;
529             var previousList = existing.get().body().substring(previousListStart);
530             comment += previousList;
531             pr.updateComment(existing.get().id(), comment);
532         } else {
533             pr.addComment(comment);
534         }
535     }
536 
537     @Override
538     public void run(Path scratchPath) {
539         var path = scratchPath.resolve(&quot;mlbridge&quot;);
540         var archiveRepo = materializeArchive(path);
541         var mboxBasePath = path.resolve(bot.codeRepo().getName());
542         var mbox = MailingListServerFactory.createMboxFileServer(mboxBasePath);
543         var archive = mbox.getList(pr.getId());
544         var archiveMails = parseArchive(archive);
545 
546         // First determine if this PR should be inspected further or not
547         if (archiveMails.isEmpty()) {
<span class="line-modified">548             var labels = new HashSet&lt;&gt;(pr.getLabels());</span>
<span class="line-modified">549             for (var readyLabel : bot.readyLabels()) {</span>
<span class="line-modified">550                 if (!labels.contains(readyLabel)) {</span>
<span class="line-modified">551                     log.fine(&quot;PR is not yet ready - missing label &#39;&quot; + readyLabel + &quot;&#39;&quot;);</span>
<span class="line-added">552                     return;</span>
<span class="line-added">553                 }</span>
<span class="line-added">554             }</span>
<span class="line-added">555         }</span>
<span class="line-added">556 </span>
<span class="line-added">557         // Also inspect comments before making the first post</span>
<span class="line-added">558         var comments = pr.getComments();</span>
<span class="line-added">559         if (archiveMails.isEmpty()) {</span>
<span class="line-added">560             for (var readyComment : bot.readyComments().entrySet()) {</span>
<span class="line-added">561                 var commentFound = false;</span>
<span class="line-added">562                 for (var comment : comments) {</span>
<span class="line-added">563                     if (comment.author().userName().equals(readyComment.getKey())) {</span>
<span class="line-added">564                         var matcher = readyComment.getValue().matcher(comment.body());</span>
<span class="line-added">565                         if (matcher.find()) {</span>
<span class="line-added">566                             commentFound = true;</span>
<span class="line-added">567                             break;</span>
<span class="line-added">568                         }</span>
<span class="line-added">569                     }</span>
<span class="line-added">570                 }</span>
<span class="line-added">571                 if (!commentFound) {</span>
<span class="line-added">572                     log.fine(&quot;PR is not yet ready - missing ready comment from &#39;&quot; + readyComment.getKey() +</span>
<span class="line-added">573                                      &quot;containing &#39;&quot; + readyComment.getValue().pattern() + &quot;&#39;&quot;);</span>
<span class="line-added">574                     return;</span>
<span class="line-added">575                 }</span>
576             }
577         }
578 
579         var webrevPath = scratchPath.resolve(&quot;mlbridge-webrevs&quot;);
580         var listServer = MailingListServerFactory.createMailmanServer(bot.listArchive(), bot.smtpServer());
581         var list = listServer.getList(bot.listAddress().address());
582         var newMails = new ArrayList&lt;Email&gt;();
583         var stableIdToMail = archiveMails.stream().collect(Collectors.toMap(email -&gt; getStableMessageId(email.id()),
584                                                                             Function.identity()));

585         var prInstance = new PullRequestInstance(scratchPath.resolve(&quot;mlbridge-mergebase&quot;), pr);
586 
587         // First post
588         if (archiveMails.isEmpty()) {
589             var webrev = bot.webrevStorage().createAndArchive(prInstance, webrevPath, prInstance.baseHash(),
590                                                               prInstance.headHash(), &quot;00&quot;);
591             var firstMail = newConversation(prInstance, webrev);
592             archive.post(firstMail);
593             newMails.add(firstMail);
594             stableIdToMail.put(getStableMessageId(firstMail.id()), firstMail);
595             updateWebrevComment(comments, 0, webrev, null);
596             log.fine(&quot;Posting new PR conversation&quot;);
597         } else {
598             // Determine the latest head hash reported
599             var reportedHeads = archiveMails.stream()
600                                             .filter(email -&gt; email.hasHeader(&quot;PR-Head-Hash&quot;))
601                                             .map(email -&gt; email.headerValue(&quot;PR-Head-Hash&quot;))
602                                             .map(Hash::new)
603                                             .collect(Collectors.toList());
604             var latestHead = reportedHeads.size() &gt; 0 ? reportedHeads.get(reportedHeads.size() - 1) : pr.getHeadHash();
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="MailingListBridgeBot.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>