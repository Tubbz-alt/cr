<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/pr/src/main/java/org/openjdk/skara/bots/pr/CheckRun.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/pr/src/main/java/org/openjdk/skara/bots/pr/CheckRun.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 53     private CheckRun(CheckWorkItem workItem, PullRequest pr, PullRequestInstance prInstance, List&lt;Comment&gt; comments,
 54                      List&lt;Review&gt; allReviews, List&lt;Review&gt; activeReviews, Set&lt;String&gt; labels,
 55                      CensusInstance censusInstance) {
 56         this.workItem = workItem;
 57         this.pr = pr;
 58         this.prInstance = prInstance;
 59         this.comments = comments;
 60         this.allReviews = allReviews;
 61         this.activeReviews = activeReviews;
 62         this.labels = new HashSet&lt;&gt;(labels);
 63         this.newLabels = new HashSet&lt;&gt;(labels);
 64         this.censusInstance = censusInstance;
 65     }
 66 
 67     static void execute(CheckWorkItem workItem, PullRequest pr, PullRequestInstance prInstance, List&lt;Comment&gt; comments,
 68                         List&lt;Review&gt; allReviews, List&lt;Review&gt; activeReviews, Set&lt;String&gt; labels, CensusInstance censusInstance) {
 69         var run = new CheckRun(workItem, pr, prInstance, comments, allReviews, activeReviews, labels, censusInstance);
 70         run.checkStatus();
 71     }
 72 
<span class="line-modified"> 73     private boolean checkTargetBranch() {</span>
 74         var matcher = workItem.bot.allowedTargetBranches().matcher(pr.targetRef());
 75         return matcher.matches();
 76     }
 77 
 78     private List&lt;String&gt; allowedTargetBranches() {
 79         var remoteBranches = prInstance.remoteBranches().stream()
 80                                        .map(Reference::name)
 81                                        .map(name -&gt; workItem.bot.allowedTargetBranches().matcher(name))
 82                                        .filter(Matcher::matches)
 83                                        .map(Matcher::group)
 84                                        .collect(Collectors.toList());
 85         return remoteBranches;
 86     }
 87 
 88     // For unknown contributors, check that all commits have the same name and email
 89     private boolean checkCommitAuthor(List&lt;Commit&gt; commits) throws IOException {
 90         var author = censusInstance.namespace().get(pr.author().id());
 91         if (author != null) {
 92             return true;
 93         }
</pre>
<hr />
<pre>
107         var repoMatcher = mergeSourcePattern.matcher(pr.title());
108         if (!repoMatcher.matches()) {
109             return Optional.empty();
110         }
111         return Optional.of(repoMatcher.group(1));
112     }
113 
114     private Optional&lt;String&gt; mergeSourceBranch() {
115         var branchMatcher = mergeSourcePattern.matcher(pr.title());
116         if (!branchMatcher.matches()) {
117             return Optional.empty();
118         }
119         var mergeSourceBranch = branchMatcher.group(2);
120         return Optional.of(mergeSourceBranch);
121     }
122 
123     // Additional bot-specific checks that are not handled by JCheck
124     private List&lt;String&gt; botSpecificChecks() throws IOException {
125         var ret = new ArrayList&lt;String&gt;();
126 
<span class="line-modified">127         if (!checkTargetBranch()) {</span>
128             var error = &quot;The branch `&quot; + pr.targetRef() + &quot;` is not allowed as target branch. The allowed target branches are:\n&quot; +
129                     allowedTargetBranches().stream()
130                     .map(name -&gt; &quot;   - &quot; + name)
131                     .collect(Collectors.joining(&quot;\n&quot;));
132             ret.add(error);
133         }
134 
135         var baseHash = prInstance.baseHash();
136         var headHash = pr.headHash();
137         var commits = prInstance.localRepo().commits(baseHash + &quot;..&quot; + headHash).asList();
138 
139         if (!checkCommitAuthor(commits)) {
140             var error = &quot;For contributors who are not existing OpenJDK Authors, commit attribution will be taken from &quot; +
141                     &quot;the commits in the PR. However, the commits in this PR have inconsistent user names and/or &quot; +
142                     &quot;email addresses. Please amend the commits.&quot;;
143             ret.add(error);
144         }
145 
146         if (pr.title().startsWith(&quot;Merge&quot;)) {
147             if (commits.size() &lt; 2) {
</pre>
</td>
<td>
<hr />
<pre>
 53     private CheckRun(CheckWorkItem workItem, PullRequest pr, PullRequestInstance prInstance, List&lt;Comment&gt; comments,
 54                      List&lt;Review&gt; allReviews, List&lt;Review&gt; activeReviews, Set&lt;String&gt; labels,
 55                      CensusInstance censusInstance) {
 56         this.workItem = workItem;
 57         this.pr = pr;
 58         this.prInstance = prInstance;
 59         this.comments = comments;
 60         this.allReviews = allReviews;
 61         this.activeReviews = activeReviews;
 62         this.labels = new HashSet&lt;&gt;(labels);
 63         this.newLabels = new HashSet&lt;&gt;(labels);
 64         this.censusInstance = censusInstance;
 65     }
 66 
 67     static void execute(CheckWorkItem workItem, PullRequest pr, PullRequestInstance prInstance, List&lt;Comment&gt; comments,
 68                         List&lt;Review&gt; allReviews, List&lt;Review&gt; activeReviews, Set&lt;String&gt; labels, CensusInstance censusInstance) {
 69         var run = new CheckRun(workItem, pr, prInstance, comments, allReviews, activeReviews, labels, censusInstance);
 70         run.checkStatus();
 71     }
 72 
<span class="line-modified"> 73     private boolean isTargetBranchAllowed() {</span>
 74         var matcher = workItem.bot.allowedTargetBranches().matcher(pr.targetRef());
 75         return matcher.matches();
 76     }
 77 
 78     private List&lt;String&gt; allowedTargetBranches() {
 79         var remoteBranches = prInstance.remoteBranches().stream()
 80                                        .map(Reference::name)
 81                                        .map(name -&gt; workItem.bot.allowedTargetBranches().matcher(name))
 82                                        .filter(Matcher::matches)
 83                                        .map(Matcher::group)
 84                                        .collect(Collectors.toList());
 85         return remoteBranches;
 86     }
 87 
 88     // For unknown contributors, check that all commits have the same name and email
 89     private boolean checkCommitAuthor(List&lt;Commit&gt; commits) throws IOException {
 90         var author = censusInstance.namespace().get(pr.author().id());
 91         if (author != null) {
 92             return true;
 93         }
</pre>
<hr />
<pre>
107         var repoMatcher = mergeSourcePattern.matcher(pr.title());
108         if (!repoMatcher.matches()) {
109             return Optional.empty();
110         }
111         return Optional.of(repoMatcher.group(1));
112     }
113 
114     private Optional&lt;String&gt; mergeSourceBranch() {
115         var branchMatcher = mergeSourcePattern.matcher(pr.title());
116         if (!branchMatcher.matches()) {
117             return Optional.empty();
118         }
119         var mergeSourceBranch = branchMatcher.group(2);
120         return Optional.of(mergeSourceBranch);
121     }
122 
123     // Additional bot-specific checks that are not handled by JCheck
124     private List&lt;String&gt; botSpecificChecks() throws IOException {
125         var ret = new ArrayList&lt;String&gt;();
126 
<span class="line-modified">127         if (!isTargetBranchAllowed()) {</span>
128             var error = &quot;The branch `&quot; + pr.targetRef() + &quot;` is not allowed as target branch. The allowed target branches are:\n&quot; +
129                     allowedTargetBranches().stream()
130                     .map(name -&gt; &quot;   - &quot; + name)
131                     .collect(Collectors.joining(&quot;\n&quot;));
132             ret.add(error);
133         }
134 
135         var baseHash = prInstance.baseHash();
136         var headHash = pr.headHash();
137         var commits = prInstance.localRepo().commits(baseHash + &quot;..&quot; + headHash).asList();
138 
139         if (!checkCommitAuthor(commits)) {
140             var error = &quot;For contributors who are not existing OpenJDK Authors, commit attribution will be taken from &quot; +
141                     &quot;the commits in the PR. However, the commits in this PR have inconsistent user names and/or &quot; +
142                     &quot;email addresses. Please amend the commits.&quot;;
143             ret.add(error);
144         }
145 
146         if (pr.title().startsWith(&quot;Merge&quot;)) {
147             if (commits.size() &lt; 2) {
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>