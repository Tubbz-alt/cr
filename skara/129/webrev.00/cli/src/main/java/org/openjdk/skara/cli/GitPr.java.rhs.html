<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames cli/src/main/java/org/openjdk/skara/cli/GitPr.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.cli;
 24 
 25 import org.openjdk.skara.args.*;
 26 import org.openjdk.skara.host.*;
 27 import org.openjdk.skara.vcs.*;
 28 import org.openjdk.skara.vcs.openjdk.*;
 29 import org.openjdk.skara.proxy.HttpProxy;
 30 import org.openjdk.skara.ssh.SSHConfig;
 31 
 32 import java.io.IOException;
 33 import java.net.URI;
 34 import java.nio.file.*;
 35 import java.util.*;
<a name="1" id="anc1"></a><span class="line-added"> 36 import java.util.concurrent.TimeUnit;</span>
 37 import java.util.function.Supplier;
 38 import java.util.logging.Level;
 39 import java.util.stream.Collectors;
<a name="2" id="anc2"></a><span class="line-added"> 40 import java.nio.charset.StandardCharsets;</span>
 41 
 42 public class GitPr {
 43     private static void exit(String fmt, Object...args) {
 44         System.err.println(String.format(fmt, args));
 45         System.exit(1);
 46     }
 47 
 48     private static &lt;T&gt; Supplier&lt;T&gt; die(String fmt, Object... args) {
 49         return () -&gt; {
 50             exit(fmt, args);
 51             return null;
 52         };
 53     }
 54 
 55     private static void await(Process p) throws IOException {
 56         try {
 57             var res = p.waitFor();
 58             if (res != 0) {
 59                 throw new IOException(&quot;Unexpected exit code &quot; + res);
 60             }
 61         } catch (InterruptedException e) {
 62             throw new IOException(e);
 63         }
 64     }
 65 
 66     private static boolean spawnEditor(ReadOnlyRepository repo, Path file) throws IOException {
 67         String editor = null;
 68         var lines = repo.config(&quot;core.editor&quot;);
 69         if (lines.size() == 1) {
 70             editor = lines.get(0);
 71         }
 72         if (editor == null) {
 73             editor = System.getenv(&quot;GIT_EDITOR&quot;);
 74         }
 75         if (editor == null) {
 76             editor = System.getenv(&quot;EDITOR&quot;);
 77         }
 78         if (editor == null) {
 79             editor = System.getenv(&quot;VISUAL&quot;);
 80         }
 81         if (editor == null) {
 82             editor = &quot;vi&quot;;
 83         }
 84 
 85         var pb = new ProcessBuilder(editor, file.toString());
 86         pb.inheritIO();
 87         var p = pb.start();
 88         try {
 89             return p.waitFor() == 0;
 90         } catch (InterruptedException e) {
 91             throw new IOException(e);
 92         }
 93     }
 94 
 95     private static String projectName(URI uri) {
 96         var name = uri.getPath().toString().substring(1);
 97         if (name.endsWith(&quot;.git&quot;)) {
 98             name = name.substring(0, name.length() - &quot;.git&quot;.length());
 99         }
100         return name;
101     }
102 
103     private static HostedRepository getHostedRepositoryFor(URI uri, GitCredentials credentials) throws IOException {
104         var host = Host.from(uri, new PersonalAccessToken(credentials.username(), credentials.password()));
105         if (System.getenv(&quot;GIT_TOKEN&quot;) == null) {
106             GitCredentials.approve(credentials);
107         }
108         var remoteRepo = host.getRepository(projectName(uri));
109         var parentRepo = remoteRepo.getParent();
110         var targetRepo = parentRepo.isPresent() ? parentRepo.get() : remoteRepo;
111         return targetRepo;
112     }
113 
114     private static PullRequest getPullRequest(URI uri, GitCredentials credentials, Argument prId) throws IOException {
115         if (!prId.isPresent()) {
116             exit(&quot;error: missing pull request identifier&quot;);
117         }
118 
119         var pr = getHostedRepositoryFor(uri, credentials).getPullRequest(prId.asString());
120         if (pr == null) {
121             exit(&quot;error: could not fetch PR information&quot;);
122         }
123 
124         return pr;
125     }
126 
127     private static void show(String ref, Hash hash) throws IOException {
128         show(ref, hash, null);
129     }
130     private static void show(String ref, Hash hash, Path dir) throws IOException {
131         var pb = new ProcessBuilder(&quot;git&quot;, &quot;diff&quot;, &quot;--binary&quot;,
132                                                    &quot;--patch&quot;,
133                                                    &quot;--find-renames=50%&quot;,
134                                                    &quot;--find-copies=50%&quot;,
135                                                    &quot;--find-copies-harder&quot;,
136                                                    &quot;--abbrev&quot;,
137                                                    ref + &quot;...&quot; + hash.hex());
138         if (dir != null) {
139             pb.directory(dir.toFile());
140         }
141         pb.inheritIO();
142         await(pb.start());
143     }
144 
145     private static void gimport() throws IOException {
146         var pb = new ProcessBuilder(&quot;hg&quot;, &quot;gimport&quot;);
147         pb.inheritIO();
148         await(pb.start());
149     }
150 
151     private static void hgImport(Path patch) throws IOException {
152         var pb = new ProcessBuilder(&quot;hg&quot;, &quot;import&quot;, &quot;--no-commit&quot;, patch.toAbsolutePath().toString());
153         pb.inheritIO();
154         await(pb.start());
155     }
156 
<a name="3" id="anc3"></a><span class="line-added">157     private static List&lt;String&gt; hgTags() throws IOException, InterruptedException {</span>
<span class="line-added">158         var pb = new ProcessBuilder(&quot;hg&quot;, &quot;tags&quot;, &quot;--quiet&quot;);</span>
<span class="line-added">159         pb.redirectOutput(ProcessBuilder.Redirect.PIPE);</span>
<span class="line-added">160         pb.redirectError(ProcessBuilder.Redirect.INHERIT);</span>
<span class="line-added">161         var p = pb.start();</span>
<span class="line-added">162         var bytes = p.getInputStream().readAllBytes();</span>
<span class="line-added">163         var exited = p.waitFor(1, TimeUnit.MINUTES);</span>
<span class="line-added">164         var exitValue = p.exitValue();</span>
<span class="line-added">165         if (!exited || exitValue != 0) {</span>
<span class="line-added">166             throw new IOException(&quot;&#39;hg tags&#39; exited with value: &quot; + exitValue);</span>
<span class="line-added">167         }</span>
<span class="line-added">168 </span>
<span class="line-added">169         return Arrays.asList(new String(bytes, StandardCharsets.UTF_8).split(&quot;\n&quot;));</span>
<span class="line-added">170     }</span>
<span class="line-added">171 </span>
<span class="line-added">172     private static String hgResolve(String ref) throws IOException, InterruptedException {</span>
<span class="line-added">173         var pb = new ProcessBuilder(&quot;hg&quot;, &quot;log&quot;, &quot;-r&quot;, ref, &quot;--template&quot;, &quot;{node}&quot;);</span>
<span class="line-added">174         pb.redirectOutput(ProcessBuilder.Redirect.PIPE);</span>
<span class="line-added">175         pb.redirectError(ProcessBuilder.Redirect.INHERIT);</span>
<span class="line-added">176         var p = pb.start();</span>
<span class="line-added">177         var bytes = p.getInputStream().readAllBytes();</span>
<span class="line-added">178         var exited = p.waitFor(1, TimeUnit.MINUTES);</span>
<span class="line-added">179         var exitValue = p.exitValue();</span>
<span class="line-added">180         if (!exited || exitValue != 0) {</span>
<span class="line-added">181             throw new IOException(&quot;&#39;hg log&#39; exited with value: &quot; + exitValue);</span>
<span class="line-added">182         }</span>
<span class="line-added">183 </span>
<span class="line-added">184         return new String(bytes, StandardCharsets.UTF_8);</span>
<span class="line-added">185     }</span>
<span class="line-added">186 </span>
187     private static Path diff(String ref, Hash hash) throws IOException {
188         return diff(ref, hash, null);
189     }
190 
191     private static Path diff(String ref, Hash hash, Path dir) throws IOException {
192         var patch = Files.createTempFile(hash.hex(), &quot;.patch&quot;);
193         var pb = new ProcessBuilder(&quot;git&quot;, &quot;diff&quot;, &quot;--binary&quot;,
194                                                    &quot;--patch&quot;,
195                                                    &quot;--find-renames=50%&quot;,
196                                                    &quot;--find-copies=50%&quot;,
197                                                    &quot;--find-copies-harder&quot;,
198                                                    &quot;--abbrev&quot;,
199                                                    ref + &quot;...&quot; + hash.hex());
200         if (dir != null) {
201             pb.directory(dir.toFile());
202         }
203         pb.redirectOutput(patch.toFile());
204         pb.redirectError(ProcessBuilder.Redirect.INHERIT);
205         await(pb.start());
206         return patch;
207     }
208 
209     private static void apply(Path patch) throws IOException {
210         var pb = new ProcessBuilder(&quot;git&quot;, &quot;apply&quot;, &quot;--no-commit&quot;, patch.toString());
211         pb.inheritIO();
212         await(pb.start());
213     }
214 
215     private static URI toURI(String remotePath) throws IOException {
216         if (remotePath.startsWith(&quot;git+&quot;)) {
217             remotePath = remotePath.substring(&quot;git+&quot;.length());
218         }
219         if (remotePath.startsWith(&quot;http&quot;)) {
220             return URI.create(remotePath);
221         } else {
222             if (remotePath.startsWith(&quot;ssh://&quot;)) {
223                 remotePath = remotePath.substring(&quot;ssh://&quot;.length()).replaceFirst(&quot;/&quot;, &quot;:&quot;);
224             }
225             var indexOfColon = remotePath.indexOf(&#39;:&#39;);
226             var indexOfSlash = remotePath.indexOf(&#39;/&#39;);
227             if (indexOfColon != -1) {
228                 if (indexOfSlash == -1 || indexOfColon &lt; indexOfSlash) {
229                     var path = remotePath.contains(&quot;@&quot;) ? remotePath.split(&quot;@&quot;)[1] : remotePath;
230                     var name = path.split(&quot;:&quot;)[0];
231 
232                     // Could be a Host in the ~/.ssh/config file
233                     var sshConfig = Path.of(System.getProperty(&quot;user.home&quot;), &quot;.ssh&quot;, &quot;config&quot;);
234                     if (Files.exists(sshConfig)) {
235                         for (var host : SSHConfig.parse(sshConfig).hosts()) {
236                             if (host.name().equals(name)) {
237                                 var hostName = host.hostName();
238                                 if (hostName != null) {
239                                     return URI.create(&quot;https://&quot; + hostName + &quot;/&quot; + path.split(&quot;:&quot;)[1]);
240                                 }
241                             }
242                         }
243                     }
244 
245                     // Otherwise is must be a domain
246                     return URI.create(&quot;https://&quot; + path.replace(&quot;:&quot;, &quot;/&quot;));
247                 }
248             }
249         }
250 
251         exit(&quot;error: cannot find remote repository for &quot; + remotePath);
252         return null; // will never reach here
253     }
254 
255     private static int longest(List&lt;String&gt; strings) {
256         return strings.stream().mapToInt(String::length).max().orElse(0);
257     }
258 
<a name="4" id="anc4"></a><span class="line-modified">259     public static void main(String[] args) throws IOException, InterruptedException {</span>
260         var flags = List.of(
261             Option.shortcut(&quot;u&quot;)
262                   .fullname(&quot;username&quot;)
263                   .describe(&quot;NAME&quot;)
264                   .helptext(&quot;Username on host&quot;)
265                   .optional(),
266             Option.shortcut(&quot;r&quot;)
267                   .fullname(&quot;remote&quot;)
268                   .describe(&quot;NAME&quot;)
269                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)
270                   .optional(),
271             Option.shortcut(&quot;b&quot;)
272                   .fullname(&quot;branch&quot;)
273                   .describe(&quot;NAME&quot;)
274                   .helptext(&quot;Name of target branch, defaults to &#39;master&#39;&quot;)
275                   .optional(),
276             Option.shortcut(&quot;&quot;)
277                   .fullname(&quot;authors&quot;)
278                   .describe(&quot;LIST&quot;)
279                   .helptext(&quot;Comma separated list of authors&quot;)
280                   .optional(),
281             Option.shortcut(&quot;&quot;)
282                   .fullname(&quot;assignees&quot;)
283                   .describe(&quot;LIST&quot;)
284                   .helptext(&quot;Comma separated list of assignees&quot;)
285                   .optional(),
286             Option.shortcut(&quot;&quot;)
287                   .fullname(&quot;labels&quot;)
288                   .describe(&quot;LIST&quot;)
289                   .helptext(&quot;Comma separated list of labels&quot;)
290                   .optional(),
291             Option.shortcut(&quot;&quot;)
292                   .fullname(&quot;columns&quot;)
293                   .describe(&quot;id,title,author,assignees,labels&quot;)
294                   .helptext(&quot;Comma separated list of columns to show&quot;)
295                   .optional(),
296             Switch.shortcut(&quot;&quot;)
297                   .fullname(&quot;no-decoration&quot;)
298                   .helptext(&quot;Hide any decorations when listing PRs&quot;)
299                   .optional(),
300             Switch.shortcut(&quot;&quot;)
301                   .fullname(&quot;mercurial&quot;)
302                   .helptext(&quot;Force use of Mercurial (hg)&quot;)
303                   .optional(),
304             Switch.shortcut(&quot;&quot;)
305                   .fullname(&quot;verbose&quot;)
306                   .helptext(&quot;Turn on verbose output&quot;)
307                   .optional(),
308             Switch.shortcut(&quot;&quot;)
309                   .fullname(&quot;debug&quot;)
310                   .helptext(&quot;Turn on debugging output&quot;)
311                   .optional(),
312             Switch.shortcut(&quot;&quot;)
313                   .fullname(&quot;version&quot;)
314                   .helptext(&quot;Print the version of this tool&quot;)
315                   .optional());
316 
317         var inputs = List.of(
318             Input.position(0)
319                  .describe(&quot;list|fetch|show|checkout|apply|integrate|approve|create|close|update&quot;)
320                  .singular()
321                  .required(),
322             Input.position(1)
323                  .describe(&quot;ID&quot;)
324                  .singular()
325                  .optional()
326         );
327 
328         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);
329         var arguments = parser.parse(args);
330 
331         if (arguments.contains(&quot;version&quot;)) {
332             System.out.println(&quot;git-pr version: &quot; + Version.fromManifest().orElse(&quot;unknown&quot;));
333             System.exit(0);
334         }
335 
336         if (arguments.contains(&quot;verbose&quot;) || arguments.contains(&quot;debug&quot;)) {
337             var level = arguments.contains(&quot;debug&quot;) ? Level.FINER : Level.FINE;
338             Logging.setup(level);
339         }
340 
341         HttpProxy.setup();
342 
343         var isMercurial = arguments.contains(&quot;mercurial&quot;);
344         var cwd = Path.of(&quot;&quot;).toAbsolutePath();
345         var repo = Repository.get(cwd).orElseThrow(() -&gt; new IOException(&quot;no git repository found at &quot; + cwd.toString()));
346         var remote = arguments.get(&quot;remote&quot;).orString(isMercurial ? &quot;default&quot; : &quot;origin&quot;);
347         var remotePullPath = repo.pullPath(remote);
348         var username = arguments.contains(&quot;username&quot;) ? arguments.get(&quot;username&quot;).asString() : null;
349         var token = isMercurial ? System.getenv(&quot;HG_TOKEN&quot;) :  System.getenv(&quot;GIT_TOKEN&quot;);
350         var uri = toURI(remotePullPath);
351         var credentials = GitCredentials.fill(uri.getHost(), uri.getPath(), username, token, uri.getScheme());
352         var host = Host.from(uri, new PersonalAccessToken(credentials.username(), credentials.password()));
353 
354         var action = arguments.at(0).asString();
355         if (action.equals(&quot;create&quot;)) {
<a name="5" id="anc5"></a><span class="line-added">356             if (isMercurial) {</span>
<span class="line-added">357                 var currentBookmark = repo.currentBookmark();</span>
<span class="line-added">358                 if (!currentBookmark.isPresent()) {</span>
<span class="line-added">359                     System.err.println(&quot;error: no bookmark is active, you must be on an active bookmark&quot;);</span>
<span class="line-added">360                     System.err.println(&quot;&quot;);</span>
<span class="line-added">361                     System.err.println(&quot;To create a bookmark and activate it, run:&quot;);</span>
<span class="line-added">362                     System.err.println(&quot;&quot;);</span>
<span class="line-added">363                     System.err.println(&quot;    hg bookmark NAME-FOR-YOUR-BOOKMARK&quot;);</span>
<span class="line-added">364                     System.err.println(&quot;&quot;);</span>
<span class="line-added">365                     System.exit(1);</span>
<span class="line-added">366                 }</span>
<span class="line-added">367 </span>
<span class="line-added">368                 var bookmark = currentBookmark.get();</span>
<span class="line-added">369                 if (bookmark.equals(new Bookmark(&quot;master&quot;))) {</span>
<span class="line-added">370                     System.err.println(&quot;error: you should not create pull requests from the &#39;master&#39; bookmark&quot;);</span>
<span class="line-added">371                     System.err.println(&quot;To create a bookmark and activate it, run:&quot;);</span>
<span class="line-added">372                     System.err.println(&quot;&quot;);</span>
<span class="line-added">373                     System.err.println(&quot;    hg bookmark NAME-FOR-YOUR-BOOKMARK&quot;);</span>
<span class="line-added">374                     System.err.println(&quot;&quot;);</span>
<span class="line-added">375                     System.exit(1);</span>
<span class="line-added">376                 }</span>
<span class="line-added">377 </span>
<span class="line-added">378                 var tags = hgTags();</span>
<span class="line-added">379                 var upstreams = tags.stream()</span>
<span class="line-added">380                                     .filter(t -&gt; t.endsWith(bookmark.name()))</span>
<span class="line-added">381                                     .collect(Collectors.toList());</span>
<span class="line-added">382                 if (upstreams.isEmpty()) {</span>
<span class="line-added">383                     System.err.println(&quot;error: there is no remote branch for the local bookmark &#39;&quot; + bookmark.name() + &quot;&#39;&quot;);</span>
<span class="line-added">384                     System.err.println(&quot;&quot;);</span>
<span class="line-added">385                     System.err.println(&quot;To create a remote branch and push the commits for your local branch, run:&quot;);</span>
<span class="line-added">386                     System.err.println(&quot;&quot;);</span>
<span class="line-added">387                     System.err.println(&quot;    hg push --bookmark &quot; + bookmark.name());</span>
<span class="line-added">388                     System.err.println(&quot;&quot;);</span>
<span class="line-added">389                     System.exit(1);</span>
<span class="line-added">390                 }</span>
<span class="line-added">391 </span>
<span class="line-added">392                 var tagsAndHashes = new HashMap&lt;String, String&gt;();</span>
<span class="line-added">393                 for (var tag : tags) {</span>
<span class="line-added">394                     tagsAndHashes.put(tag, hgResolve(tag));</span>
<span class="line-added">395                 }</span>
<span class="line-added">396                 var bookmarkHash = hgResolve(bookmark.name());</span>
<span class="line-added">397                 if (!tagsAndHashes.containsValue(bookmarkHash)) {</span>
<span class="line-added">398                     System.err.println(&quot;error: there are local commits on bookmark &#39;&quot; + bookmark.name() + &quot;&#39; not present in a remote repository&quot;);</span>
<span class="line-added">399                     System.err.println(&quot;&quot;);</span>
<span class="line-added">400 </span>
<span class="line-added">401                     if (upstreams.size() == 1) {</span>
<span class="line-added">402                         System.err.println(&quot;To push the local commits to the remote repository, run:&quot;);</span>
<span class="line-added">403                         System.err.println(&quot;&quot;);</span>
<span class="line-added">404                         System.err.println(&quot;    hg push --bookmark &quot; + bookmark.name() + &quot; &quot; + upstreams.get(0));</span>
<span class="line-added">405                         System.err.println(&quot;&quot;);</span>
<span class="line-added">406                     } else {</span>
<span class="line-added">407                         System.err.println(&quot;The following paths contains the &quot; + bookmark.name() + &quot; bookmark:&quot;);</span>
<span class="line-added">408                         System.err.println(&quot;&quot;);</span>
<span class="line-added">409                         for (var upstream : upstreams) {</span>
<span class="line-added">410                             System.err.println(&quot;- &quot; + upstream.replace(&quot;/&quot; + bookmark.name(), &quot;&quot;));</span>
<span class="line-added">411                         }</span>
<span class="line-added">412                         System.err.println(&quot;&quot;);</span>
<span class="line-added">413                         System.err.println(&quot;To push the local commits to a remote repository, run:&quot;);</span>
<span class="line-added">414                         System.err.println(&quot;&quot;);</span>
<span class="line-added">415                         System.err.println(&quot;    hg push --bookmark &quot; + bookmark.name() + &quot; &lt;PATH&gt;&quot;);</span>
<span class="line-added">416                         System.err.println(&quot;&quot;);</span>
<span class="line-added">417                     }</span>
<span class="line-added">418                     System.exit(1);</span>
<span class="line-added">419                 }</span>
<span class="line-added">420 </span>
<span class="line-added">421                 var targetBranch = arguments.get(&quot;branch&quot;).orString(&quot;master&quot;);</span>
<span class="line-added">422                 var targetHash = hgResolve(targetBranch);</span>
<span class="line-added">423                 var commits = repo.commits(targetHash + &quot;..&quot; + bookmarkHash + &quot;-&quot; + targetHash).asList();</span>
<span class="line-added">424                 if (commits.isEmpty()) {</span>
<span class="line-added">425                     System.err.println(&quot;error: no difference between bookmarks &quot; + targetBranch + &quot; and &quot; + bookmark.name());</span>
<span class="line-added">426                     System.err.println(&quot;       Cannot create an empty pull request, have you committed?&quot;);</span>
<span class="line-added">427                     System.exit(1);</span>
<span class="line-added">428                 }</span>
<span class="line-added">429 </span>
<span class="line-added">430                 var diff = repo.diff(repo.head());</span>
<span class="line-added">431                 if (!diff.patches().isEmpty()) {</span>
<span class="line-added">432                     System.err.println(&quot;error: there are uncommitted changes in your working tree:&quot;);</span>
<span class="line-added">433                     System.err.println(&quot;&quot;);</span>
<span class="line-added">434                     for (var patch : diff.patches()) {</span>
<span class="line-added">435                         var path = patch.target().path().isPresent() ?</span>
<span class="line-added">436                             patch.target().path().get() : patch.source().path().get();</span>
<span class="line-added">437                         System.err.println(&quot;    &quot; + patch.status().toString() + &quot; &quot; + path.toString());</span>
<span class="line-added">438                     }</span>
<span class="line-added">439                     System.err.println(&quot;&quot;);</span>
<span class="line-added">440                     System.err.println(&quot;If these changes are meant to be part of the pull request, run:&quot;);</span>
<span class="line-added">441                     System.err.println(&quot;&quot;);</span>
<span class="line-added">442                     System.err.println(&quot;    hg commit --amend&quot;);</span>
<span class="line-added">443                     System.err.println(&quot;    hg git-cleanup&quot;);</span>
<span class="line-added">444                     System.err.println(&quot;    hg push --bookmark &quot; + bookmark.name() + &quot; &lt;PATH&gt;&quot;);</span>
<span class="line-added">445                     System.err.println(&quot;    hg gimport&quot;);</span>
<span class="line-added">446                     System.err.println(&quot;&quot;);</span>
<span class="line-added">447                     System.err.println(&quot;If these changes are *not* meant to be part of the pull request, run:&quot;);</span>
<span class="line-added">448                     System.err.println(&quot;&quot;);</span>
<span class="line-added">449                     System.err.println(&quot;    hg shelve&quot;);</span>
<span class="line-added">450                     System.err.println(&quot;&quot;);</span>
<span class="line-added">451                     System.err.println(&quot;(You can later restore the changes by running: hg unshelve)&quot;);</span>
<span class="line-added">452                     System.exit(1);</span>
<span class="line-added">453                 }</span>
<span class="line-added">454 </span>
<span class="line-added">455                 var remoteRepo = host.getRepository(projectName(uri));</span>
<span class="line-added">456                 if (token == null) {</span>
<span class="line-added">457                     GitCredentials.approve(credentials);</span>
<span class="line-added">458                 }</span>
<span class="line-added">459                 var parentRepo = remoteRepo.getParent().orElseThrow(() -&gt;</span>
<span class="line-added">460                         new IOException(&quot;error: remote repository &quot; + remotePullPath + &quot; is not a fork of any repository&quot;));</span>
<span class="line-added">461 </span>
<span class="line-added">462                 var file = Files.createTempFile(&quot;PULL_REQUEST_&quot;, &quot;.txt&quot;);</span>
<span class="line-added">463                 if (commits.size() == 1) {</span>
<span class="line-added">464                     var commit = commits.get(0);</span>
<span class="line-added">465                     var message = CommitMessageParsers.v1.parse(commit.message());</span>
<span class="line-added">466                     Files.writeString(file, message.title() + &quot;\n&quot;);</span>
<span class="line-added">467                     if (!message.summaries().isEmpty()) {</span>
<span class="line-added">468                         Files.write(file, message.summaries(), StandardOpenOption.APPEND);</span>
<span class="line-added">469                     }</span>
<span class="line-added">470                     if (!message.additional().isEmpty()) {</span>
<span class="line-added">471                         Files.write(file, message.additional(), StandardOpenOption.APPEND);</span>
<span class="line-added">472                     }</span>
<span class="line-added">473                 } else {</span>
<span class="line-added">474                     Files.write(file, List.of(&quot;&quot;));</span>
<span class="line-added">475                 }</span>
<span class="line-added">476                 Files.write(file, List.of(</span>
<span class="line-added">477                     &quot;# Please enter the pull request message for your changes. Lines starting&quot;,</span>
<span class="line-added">478                     &quot;# with &#39;#&#39; will be ignored, and an empty message aborts the pull request.&quot;,</span>
<span class="line-added">479                     &quot;# The first line will be considered the subject, use a blank line to separate&quot;,</span>
<span class="line-added">480                     &quot;# the subject from the body.&quot;,</span>
<span class="line-added">481                     &quot;#&quot;,</span>
<span class="line-added">482                     &quot;# Commits to be included from branch &#39;&quot; + bookmark.name() + &quot;&#39;&quot;</span>
<span class="line-added">483                     ),</span>
<span class="line-added">484                     StandardOpenOption.APPEND</span>
<span class="line-added">485                 );</span>
<span class="line-added">486                 for (var commit : commits) {</span>
<span class="line-added">487                     var desc = commit.hash().abbreviate() + &quot;: &quot; + commit.message().get(0);</span>
<span class="line-added">488                     Files.writeString(file, &quot;# - &quot; + desc + &quot;\n&quot;, StandardOpenOption.APPEND);</span>
<span class="line-added">489                 }</span>
<span class="line-added">490                 Files.writeString(file, &quot;#\n&quot;, StandardOpenOption.APPEND);</span>
<span class="line-added">491                 Files.writeString(file, &quot;# Target repository: &quot; + remotePullPath + &quot;\n&quot;, StandardOpenOption.APPEND);</span>
<span class="line-added">492                 Files.writeString(file, &quot;# Target branch: &quot; + targetBranch + &quot;\n&quot;, StandardOpenOption.APPEND);</span>
<span class="line-added">493                 var success = spawnEditor(repo, file);</span>
<span class="line-added">494                 if (!success) {</span>
<span class="line-added">495                     System.err.println(&quot;error: editor exited with non-zero status code, aborting&quot;);</span>
<span class="line-added">496                     System.exit(1);</span>
<span class="line-added">497                 }</span>
<span class="line-added">498                 var lines = Files.readAllLines(file)</span>
<span class="line-added">499                                  .stream()</span>
<span class="line-added">500                                  .filter(l -&gt; !l.startsWith(&quot;#&quot;))</span>
<span class="line-added">501                                  .collect(Collectors.toList());</span>
<span class="line-added">502                 var isEmpty = lines.stream().allMatch(String::isEmpty);</span>
<span class="line-added">503                 if (isEmpty) {</span>
<span class="line-added">504                     System.err.println(&quot;error: no message present, aborting&quot;);</span>
<span class="line-added">505                     System.exit(1);</span>
<span class="line-added">506                 }</span>
<span class="line-added">507 </span>
<span class="line-added">508                 var title = lines.get(0);</span>
<span class="line-added">509                 List&lt;String&gt; body = null;</span>
<span class="line-added">510                 if (lines.size() &gt; 1) {</span>
<span class="line-added">511                     body = lines.subList(1, lines.size())</span>
<span class="line-added">512                                 .stream()</span>
<span class="line-added">513                                 .dropWhile(String::isEmpty)</span>
<span class="line-added">514                                 .collect(Collectors.toList());</span>
<span class="line-added">515                 } else {</span>
<span class="line-added">516                     body = Collections.emptyList();</span>
<span class="line-added">517                 }</span>
<span class="line-added">518 </span>
<span class="line-added">519                 var pr = remoteRepo.createPullRequest(parentRepo, targetBranch, bookmark.name(), title, body);</span>
<span class="line-added">520                 if (arguments.contains(&quot;assignees&quot;)) {</span>
<span class="line-added">521                     var usernames = Arrays.asList(arguments.get(&quot;assignees&quot;).asString().split(&quot;,&quot;));</span>
<span class="line-added">522                     var assignees = usernames.stream()</span>
<span class="line-added">523                                              .map(host::getUserDetails)</span>
<span class="line-added">524                                              .collect(Collectors.toList());</span>
<span class="line-added">525                     pr.setAssignees(assignees);</span>
<span class="line-added">526                 }</span>
<span class="line-added">527                 System.out.println(pr.getWebUrl().toString());</span>
<span class="line-added">528                 Files.deleteIfExists(file);</span>
<span class="line-added">529 </span>
<span class="line-added">530                 System.exit(0);</span>
<span class="line-added">531             }</span>
532             var currentBranch = repo.currentBranch();
533             if (currentBranch.equals(repo.defaultBranch())) {
534                 System.err.println(&quot;error: you should not create pull requests from the &#39;master&#39; branch&quot;);
535                 System.err.println(&quot;&quot;);
536                 System.err.println(&quot;To create a local branch for your changes and restore the &#39;master&#39; branch, run:&quot;);
537                 System.err.println(&quot;&quot;);
538                 System.err.println(&quot;    git checkout -b NAME-FOR-YOUR-LOCAL-BRANCH&quot;);
539                 System.err.println(&quot;    git branch --force master origin/master&quot;);
540                 System.err.println(&quot;&quot;);
541                 System.exit(1);
542             }
543 
544             var upstream = repo.upstreamFor(currentBranch);
545             if (upstream.isEmpty()) {
546                 System.err.println(&quot;error: there is no remote branch for the local branch &#39;&quot; + currentBranch.name() + &quot;&#39;&quot;);
547                 System.err.println(&quot;&quot;);
548                 System.err.println(&quot;A remote branch must be present at &quot; + remotePullPath + &quot; to create a pull request&quot;);
549                 System.err.println(&quot;To create a remote branch and push the commits for your local branch, run:&quot;);
550                 System.err.println(&quot;&quot;);
551                 System.err.println(&quot;    git push --set-upstream &quot; + remote + &quot; &quot; + currentBranch.name());
552                 System.err.println(&quot;&quot;);
553                 System.err.println(&quot;If you created the remote branch from another client, you must update this repository.&quot;);
554                 System.err.println(&quot;To update remote information for this repository, run:&quot;);
555                 System.err.println(&quot;&quot;);
556                 System.err.println(&quot;    git fetch &quot; + remote);
557                 System.err.println(&quot;    git branch --set-upstream &quot; + currentBranch + &quot; &quot; + remote + &quot;/&quot; + currentBranch);
558                 System.err.println(&quot;&quot;);
559                 System.exit(1);
560             }
561 
562             var upstreamRefName = upstream.get().substring(remote.length() + 1);
563             repo.fetch(uri, upstreamRefName);
564             var branchCommits = repo.commits(upstream.get() + &quot;..&quot; + currentBranch.name()).asList();
565             if (!branchCommits.isEmpty()) {
566                 System.err.println(&quot;error: there are local commits on branch &#39;&quot; + currentBranch.name() + &quot;&#39; not present in the remote repository &quot; + remotePullPath);
567                 System.err.println(&quot;&quot;);
568                 System.err.println(&quot;All commits must be present in the remote repository to be part of the pull request&quot;);
569                 System.err.println(&quot;The following commits are not present in the remote repository:&quot;);
570                 System.err.println(&quot;&quot;);
571                 for (var commit : branchCommits) {
572                     System.err.println(&quot;- &quot; + commit.hash().abbreviate() + &quot;: &quot; + commit.message().get(0));
573                 }
574                 System.err.println(&quot;&quot;);
575                 System.err.println(&quot;To push the above local commits to the remote repository, run:&quot;);
576                 System.err.println(&quot;&quot;);
577                 System.err.println(&quot;    git push &quot; + remote + &quot; &quot; + currentBranch.name());
578                 System.err.println(&quot;&quot;);
579                 System.exit(1);
580             }
581 
582             var targetBranch = arguments.get(&quot;branch&quot;).orString(&quot;master&quot;);
583             var commits = repo.commits(targetBranch + &quot;..&quot; + currentBranch.name()).asList();
584             if (commits.isEmpty()) {
585                 System.err.println(&quot;error: no difference between branches &quot; + targetBranch + &quot; and &quot; + currentBranch.name());
586                 System.err.println(&quot;       Cannot create an empty pull request, have you committed?&quot;);
587                 System.exit(1);
588             }
589 
590             var diff = repo.diff(repo.head());
591             if (!diff.patches().isEmpty()) {
592                 System.err.println(&quot;error: there are uncommitted changes in your working tree:&quot;);
593                 System.err.println(&quot;&quot;);
594                 for (var patch : diff.patches()) {
595                     var path = patch.target().path().isPresent() ?
596                         patch.target().path().get() : patch.source().path().get();
597                     System.err.println(&quot;    &quot; + patch.status().toString() + &quot; &quot; + path.toString());
598                 }
599                 System.err.println(&quot;&quot;);
600                 System.err.println(&quot;If these changes are meant to be part of the pull request, run:&quot;);
601                 System.err.println(&quot;&quot;);
602                 System.err.println(&quot;    git commit -am &#39;Forgot to add some changes&#39;&quot;);
603                 System.err.println(&quot;&quot;);
604                 System.err.println(&quot;If these changes are *not* meant to be part of the pull request, run:&quot;);
605                 System.err.println(&quot;&quot;);
606                 System.err.println(&quot;    git stash&quot;);
607                 System.err.println(&quot;&quot;);
608                 System.err.println(&quot;(You can later restore the changes by running: git stash pop)&quot;);
609                 System.exit(1);
610             }
611 
612             var remoteRepo = host.getRepository(projectName(uri));
613             if (token == null) {
614                 GitCredentials.approve(credentials);
615             }
616             var parentRepo = remoteRepo.getParent().orElseThrow(() -&gt;
617                     new IOException(&quot;error: remote repository &quot; + remotePullPath + &quot; is not a fork of any repository&quot;));
618 
619             var file = Files.createTempFile(&quot;PULL_REQUEST_&quot;, &quot;.txt&quot;);
620             if (commits.size() == 1) {
621                 var commit = commits.get(0);
622                 var message = CommitMessageParsers.v1.parse(commit.message());
623                 Files.writeString(file, message.title() + &quot;\n&quot;);
624                 if (!message.summaries().isEmpty()) {
625                     Files.write(file, message.summaries(), StandardOpenOption.APPEND);
626                 }
627                 if (!message.additional().isEmpty()) {
628                     Files.write(file, message.additional(), StandardOpenOption.APPEND);
629                 }
630             } else {
631                 Files.write(file, List.of(&quot;&quot;));
632             }
633             Files.write(file, List.of(
634                 &quot;# Please enter the pull request message for your changes. Lines starting&quot;,
635                 &quot;# with &#39;#&#39; will be ignored, and an empty message aborts the pull request.&quot;,
636                 &quot;# The first line will be considered the subject, use a blank line to separate&quot;,
637                 &quot;# the subject from the body.&quot;,
638                 &quot;#&quot;,
639                 &quot;# Commits to be included from branch &#39;&quot; + currentBranch.name() + &quot;&#39;&quot;
640                 ),
641                 StandardOpenOption.APPEND
642             );
643             for (var commit : commits) {
644                 var desc = commit.hash().abbreviate() + &quot;: &quot; + commit.message().get(0);
645                 Files.writeString(file, &quot;# - &quot; + desc + &quot;\n&quot;, StandardOpenOption.APPEND);
646             }
647             Files.writeString(file, &quot;#\n&quot;, StandardOpenOption.APPEND);
648             Files.writeString(file, &quot;# Target repository: &quot; + remotePullPath + &quot;\n&quot;, StandardOpenOption.APPEND);
649             Files.writeString(file, &quot;# Target branch: &quot; + targetBranch + &quot;\n&quot;, StandardOpenOption.APPEND);
650             var success = spawnEditor(repo, file);
651             if (!success) {
652                 System.err.println(&quot;error: editor exited with non-zero status code, aborting&quot;);
653                 System.exit(1);
654             }
655             var lines = Files.readAllLines(file)
656                              .stream()
657                              .filter(l -&gt; !l.startsWith(&quot;#&quot;))
658                              .collect(Collectors.toList());
659             var isEmpty = lines.stream().allMatch(String::isEmpty);
660             if (isEmpty) {
661                 System.err.println(&quot;error: no message present, aborting&quot;);
662                 System.exit(1);
663             }
664 
665             var title = lines.get(0);
666             List&lt;String&gt; body = null;
667             if (lines.size() &gt; 1) {
668                 body = lines.subList(1, lines.size())
669                             .stream()
670                             .dropWhile(String::isEmpty)
671                             .collect(Collectors.toList());
672             } else {
673                 body = Collections.emptyList();
674             }
675 
676             var pr = remoteRepo.createPullRequest(parentRepo, targetBranch, currentBranch.name(), title, body);
677             if (arguments.contains(&quot;assignees&quot;)) {
678                 var usernames = Arrays.asList(arguments.get(&quot;assignees&quot;).asString().split(&quot;,&quot;));
679                 var assignees = usernames.stream()
680                                          .map(host::getUserDetails)
681                                          .collect(Collectors.toList());
682                 pr.setAssignees(assignees);
683             }
684             System.out.println(pr.getWebUrl().toString());
685             Files.deleteIfExists(file);
686         } else if (action.equals(&quot;integrate&quot;) || action.equals(&quot;approve&quot;)) {
687             var pr = getPullRequest(uri, credentials, arguments.at(1));
688 
689             if (action.equals(&quot;integrate&quot;)) {
690                 pr.addComment(&quot;/integrate&quot;);
691             } else if (action.equals(&quot;approve&quot;)) {
692                 pr.addReview(Review.Verdict.APPROVED, &quot;Looks good!&quot;);
693             } else {
694                 throw new IllegalStateException(&quot;unexpected action: &quot; + action);
695             }
696         } else if (action.equals(&quot;list&quot;)) {
697             var remoteRepo = getHostedRepositoryFor(uri, credentials);
698             var prs = remoteRepo.getPullRequests();
699 
700             var ids = new ArrayList&lt;String&gt;();
701             var titles = new ArrayList&lt;String&gt;();
702             var authors = new ArrayList&lt;String&gt;();
703             var assignees = new ArrayList&lt;String&gt;();
704             var labels = new ArrayList&lt;String&gt;();
705 
706             var filterAuthors = arguments.contains(&quot;authors&quot;) ?
707                 new HashSet&lt;&gt;(Arrays.asList(arguments.get(&quot;authors&quot;).asString().split(&quot;,&quot;))) :
708                 Set.of();
709             var filterAssignees = arguments.contains(&quot;assignees&quot;) ?
710                 Arrays.asList(arguments.get(&quot;assignees&quot;).asString().split(&quot;,&quot;)) :
711                 Set.of();
712             var filterLabels = arguments.contains(&quot;labels&quot;) ?
713                 Arrays.asList(arguments.get(&quot;labels&quot;).asString().split(&quot;,&quot;)) :
714                 Set.of();
715 
716             var defaultColumns = List.of(&quot;id&quot;, &quot;title&quot;, &quot;authors&quot;, &quot;assignees&quot;, &quot;labels&quot;);
717             var columnValues = Map.of(defaultColumns.get(0), ids,
718                                       defaultColumns.get(1), titles,
719                                       defaultColumns.get(2), authors,
720                                       defaultColumns.get(3), assignees,
721                                       defaultColumns.get(4), labels);
722             var columns = arguments.contains(&quot;columns&quot;) ?
723                 Arrays.asList(arguments.get(&quot;columns&quot;).asString().split(&quot;,&quot;)) :
724                 defaultColumns;
725             if (columns != defaultColumns) {
726                 for (var column : columns) {
727                     if (!defaultColumns.contains(column)) {
728                         System.err.println(&quot;error: unknown column: &quot; + column);
729                         System.err.println(&quot;       available columns are: &quot; + String.join(&quot;,&quot;, defaultColumns));
730                         System.exit(1);
731                     }
732                 }
733             }
734 
735             for (var pr : remoteRepo.getPullRequests()) {
736                 var prAuthor = pr.getAuthor().userName();
737                 if (!filterAuthors.isEmpty() &amp;&amp; !filterAuthors.contains(prAuthor)) {
738                     continue;
739                 }
740 
741                 var prAssignees = pr.getAssignees().stream()
742                                    .map(HostUserDetails::userName)
743                                    .collect(Collectors.toSet());
744                 if (!filterAssignees.isEmpty() &amp;&amp; !filterAssignees.stream().anyMatch(prAssignees::contains)) {
745                     continue;
746                 }
747 
748                 var prLabels = new HashSet&lt;&gt;(pr.getLabels());
749                 if (!filterLabels.isEmpty() &amp;&amp; !filterLabels.stream().anyMatch(prLabels::contains)) {
750                     continue;
751                 }
752 
753                 ids.add(pr.getId());
754                 titles.add(pr.getTitle());
755                 authors.add(prAuthor);
756                 assignees.add(String.join(&quot;,&quot;, prAssignees));
757                 labels.add(String.join(&quot;,&quot;, prLabels));
758             }
759 
760 
761             String fmt = &quot;&quot;;
762             for (var column : columns.subList(0, columns.size() - 1)) {
763                 var values = columnValues.get(column);
764                 var n = Math.max(column.length(), longest(values));
765                 fmt += &quot;%-&quot; + n + &quot;s\t&quot;;
766             }
767             fmt += &quot;%s\n&quot;;
768 
769             if (!ids.isEmpty() &amp;&amp; !arguments.contains(&quot;no-decoration&quot;)) {
770                 var upperCase = columns.stream()
771                                        .map(String::toUpperCase)
772                                        .collect(Collectors.toList());
773                 System.out.format(fmt, (Object[]) upperCase.toArray(new String[0]));
774             }
775             for (var i = 0; i &lt; ids.size(); i++) {
776                 final int n = i;
777                 var row = columns.stream()
778                                  .map(columnValues::get)
779                                  .map(values -&gt; values.get(n))
780                                  .collect(Collectors.toList());
781                 System.out.format(fmt, (Object[]) row.toArray(new String[0]));
782             }
783         } else if (action.equals(&quot;fetch&quot;) || action.equals(&quot;checkout&quot;) || action.equals(&quot;show&quot;) || action.equals(&quot;apply&quot;)) {
784             var prId = arguments.at(1);
785             if (!prId.isPresent()) {
786                 exit(&quot;error: missing pull request identifier&quot;);
787             }
788 
789             var remoteRepo = getHostedRepositoryFor(uri, credentials);
790             var pr = remoteRepo.getPullRequest(prId.asString());
791             var repoUrl = remoteRepo.getWebUrl();
792             var prHeadRef = pr.getSourceRef();
793             var isHgGit = isMercurial &amp;&amp; Repository.exists(repo.root().resolve(&quot;.hg&quot;).resolve(&quot;git&quot;));
794             if (isHgGit) {
795                 var hgGitRepo = Repository.get(repo.root().resolve(&quot;.hg&quot;).resolve(&quot;git&quot;)).get();
796                 var hgGitFetchHead = hgGitRepo.fetch(repoUrl, prHeadRef);
797 
798                 if (action.equals(&quot;show&quot;) || action.equals(&quot;apply&quot;)) {
799                     var target = hgGitRepo.fetch(repoUrl, pr.getTargetRef());
800                     var hgGitMergeBase = hgGitRepo.mergeBase(target, hgGitFetchHead);
801 
802                     if (action.equals(&quot;show&quot;)) {
803                         show(hgGitMergeBase.hex(), hgGitFetchHead, hgGitRepo.root());
804                     } else {
805                         var patch = diff(hgGitMergeBase.hex(), hgGitFetchHead, hgGitRepo.root());
806                         hgImport(patch);
807                         Files.delete(patch);
808                     }
809                 } else if (action.equals(&quot;fetch&quot;) || action.equals(&quot;checkout&quot;)) {
810                     var hgGitRef = prHeadRef.endsWith(&quot;/head&quot;) ? prHeadRef.replace(&quot;/head&quot;, &quot;&quot;) : prHeadRef;
811                     var hgGitBranches = hgGitRepo.branches();
812                     if (hgGitBranches.contains(new Branch(hgGitRef))) {
813                         hgGitRepo.delete(new Branch(hgGitRef));
814                     }
815                     hgGitRepo.branch(hgGitFetchHead, hgGitRef);
816                     gimport();
817                     var hgFetchHead = repo.resolve(hgGitRef).get();
818 
819                     if (action.equals(&quot;fetch&quot;) &amp;&amp; arguments.contains(&quot;branch&quot;)) {
820                         repo.branch(hgFetchHead, arguments.get(&quot;branch&quot;).asString());
821                     } else if (action.equals(&quot;checkout&quot;)) {
822                         repo.checkout(hgFetchHead);
823                         if (arguments.contains(&quot;branch&quot;)) {
824                             repo.branch(hgFetchHead, arguments.get(&quot;branch&quot;).asString());
825                         }
826                     }
827                 } else {
828                     exit(&quot;Unexpected action: &quot; + action);
829                 }
830 
831                 return;
832             }
833 
834             var fetchHead = repo.fetch(repoUrl, pr.getSourceRef());
835             if (action.equals(&quot;fetch&quot;)) {
836                 if (arguments.contains(&quot;branch&quot;)) {
837                     var branchName = arguments.get(&quot;branch&quot;).asString();
838                     repo.branch(fetchHead, branchName);
839                 } else {
840                     System.out.println(fetchHead.hex());
841                 }
842             } else if (action.equals(&quot;checkout&quot;)) {
843                 if (arguments.contains(&quot;branch&quot;)) {
844                     var branchName = arguments.get(&quot;branch&quot;).asString();
845                     var branch = repo.branch(fetchHead, branchName);
846                     repo.checkout(branch, false);
847                 } else {
848                     repo.checkout(fetchHead, false);
849                 }
850             } else if (action.equals(&quot;show&quot;)) {
851                 show(pr.getTargetRef(), fetchHead);
852             } else if (action.equals(&quot;apply&quot;)) {
853                 var patch = diff(pr.getTargetRef(), fetchHead);
854                 apply(patch);
855                 Files.deleteIfExists(patch);
856             }
857         } else if (action.equals(&quot;close&quot;)) {
858             var prId = arguments.at(1);
859             if (!prId.isPresent()) {
860                 exit(&quot;error: missing pull request identifier&quot;);
861             }
862 
863             var remoteRepo = getHostedRepositoryFor(uri, credentials);
864             var pr = remoteRepo.getPullRequest(prId.asString());
865             pr.setState(PullRequest.State.CLOSED);
866         } else if (action.equals(&quot;update&quot;)) {
867             var prId = arguments.at(1);
868             if (!prId.isPresent()) {
869                 exit(&quot;error: missing pull request identifier&quot;);
870             }
871 
872             var remoteRepo = getHostedRepositoryFor(uri, credentials);
873             var pr = remoteRepo.getPullRequest(prId.asString());
874             if (arguments.contains(&quot;assignees&quot;)) {
875                 var usernames = Arrays.asList(arguments.get(&quot;assignees&quot;).asString().split(&quot;,&quot;));
876                 var assignees = usernames.stream()
877                     .map(host::getUserDetails)
878                     .collect(Collectors.toList());
879                 pr.setAssignees(assignees);
880             }
881         } else {
882             exit(&quot;error: unexpected action: &quot; + action);
883         }
884     }
885 }
<a name="6" id="anc6"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="6" type="hidden" />
</body>
</html>