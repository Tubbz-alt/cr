<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="MailingListArchiveReaderBotTests.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  95         try (var credentials = new HostCredentials(testInfo);
  96              var tempFolder = new TemporaryDirectory();
  97              var archiveFolder = new TemporaryDirectory();
  98              var webrevFolder = new TemporaryDirectory();
  99              var listServer = new TestMailmanServer()) {
 100             var author = credentials.getHostedRepository();
 101             var archive = credentials.getHostedRepository();
 102             var ignored = credentials.getHostedRepository();
 103             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 104             var censusBuilder = credentials.getCensusBuilder()
 105                                            .addAuthor(author.host().getCurrentUserDetails().id());
 106             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 107             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,
 108                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 109                                                  Set.of(),
 110                                                  listServer.getArchive(), listServer.getSMTP(),
 111                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 112                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 113                                                  Set.of(&quot;rfr&quot;), Map.of(ignored.host().getCurrentUserDetails().userName(),
 114                                                                        Pattern.compile(&quot;ready&quot;)),
<span class="line-modified"> 115                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>

 116 
 117             // Populate the projects repository
 118             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
 119             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 120             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 121             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 122 
 123             // Make a change with a corresponding PR
 124             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 125                                                                &quot;Change msg\n\nWith several lines&quot;);
 126             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 127             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 128             pr.setBody(&quot;This should not be ready&quot;);
 129 
 130             // Run an archive pass
 131             TestBotRunner.runPeriodicItems(mlBot);
 132 
 133             // A PR that isn&#39;t ready for review should not be archived
 134             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 135             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
</pre>
<hr />
<pre>
 171             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
 172             assertTrue(archiveContains(archiveFolder.path(), &quot;http://www.test.test/&quot;));
 173             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));
 174             assertTrue(archiveContains(archiveFolder.path(), &quot;Issue:&quot;));
 175             assertTrue(archiveContains(archiveFolder.path(), &quot;http://issues.test/browse/TSTPRJ-1234&quot;));
 176             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch:&quot;));
 177             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - &quot; + editHash.abbreviate() + &quot;: Change msg&quot;));
 178             assertFalse(archiveContains(archiveFolder.path(), &quot;With several lines&quot;));
 179 
 180             // The mailing list as well
 181             listServer.processIncoming();
 182             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 183             var mailmanList = mailmanServer.getList(listAddress.address());
 184             var conversations = mailmanList.conversations(Duration.ofDays(1));
 185             assertEquals(1, conversations.size());
 186             var mail = conversations.get(0).first();
 187             assertEquals(&quot;RFR: 1234: This is a pull request&quot;, mail.subject());
 188             assertEquals(pr.getAuthor().fullName(), mail.author().fullName().orElseThrow());
 189             assertEquals(noreplyAddress(archive), mail.author().address());
 190             assertEquals(from, mail.sender());


 191 
 192             // And there should be a webrev
 193             Repository.materialize(webrevFolder.path(), archive.getUrl(), &quot;webrev&quot;);
 194             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
 195             var comments = pr.getComments();
 196             var webrevComments = comments.stream()
 197                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 198                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 199                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 200                                          .collect(Collectors.toList());
 201             assertEquals(1, webrevComments.size());
 202 
 203             // Add a comment
 204             pr.addComment(&quot;This is a comment :smile:&quot;);
 205 
 206             // Add a comment from an ignored user as well
 207             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);
 208 
 209             // Run another archive pass
 210             TestBotRunner.runPeriodicItems(mlBot);
</pre>
<hr />
<pre>
 247     @Test
 248     void reviewComment(TestInfo testInfo) throws IOException {
 249         try (var credentials = new HostCredentials(testInfo);
 250              var tempFolder = new TemporaryDirectory();
 251              var archiveFolder = new TemporaryDirectory();
 252              var listServer = new TestMailmanServer()) {
 253             var author = credentials.getHostedRepository();
 254             var archive = credentials.getHostedRepository();
 255             var ignored = credentials.getHostedRepository();
 256             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 257             var censusBuilder = credentials.getCensusBuilder()
 258                                            .addAuthor(author.host().getCurrentUserDetails().id());
 259             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 260             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,
 261                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 262                                                  Set.of(),
 263                                                  listServer.getArchive(), listServer.getSMTP(),
 264                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 265                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 266                                                  Set.of(), Map.of(),
<span class="line-modified"> 267                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>

 268 
 269             // Populate the projects repository
 270             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 271             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 272             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 273             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 274             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 275 
 276             // Make a change with a corresponding PR
 277             var editHash = CheckableRepository.appendAndCommit(localRepo);
 278             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 279             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 280             pr.setBody(&quot;This is now ready&quot;);
 281             TestBotRunner.runPeriodicItems(mlBot);
 282             listServer.processIncoming();
 283 
 284             // And make a file specific comment
 285             var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
 286             var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 287 
</pre>
<hr />
<pre>
 334 
 335     @Test
 336     void combineComments(TestInfo testInfo) throws IOException {
 337         try (var credentials = new HostCredentials(testInfo);
 338              var tempFolder = new TemporaryDirectory();
 339              var archiveFolder = new TemporaryDirectory();
 340              var listServer = new TestMailmanServer()) {
 341             var author = credentials.getHostedRepository();
 342             var archive = credentials.getHostedRepository();
 343             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 344             var censusBuilder = credentials.getCensusBuilder()
 345                                            .addAuthor(author.host().getCurrentUserDetails().id());
 346             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 347             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 348                                                  listAddress, Set.of(), Set.of(),
 349                                                  listServer.getArchive(),
 350                                                  listServer.getSMTP(),
 351                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 352                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 353                                                  Set.of(), Map.of(),
<span class="line-modified"> 354                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>

 355 
 356             // Populate the projects repository
 357             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 358             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 359             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 360             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 361             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 362 
 363             // Make a change with a corresponding PR
 364             var editHash = CheckableRepository.appendAndCommit(localRepo);
 365             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 366             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 367             pr.setBody(&quot;This is now ready&quot;);
 368             pr.addComment(&quot;Avoid combining&quot;);
 369 
 370             TestBotRunner.runPeriodicItems(mlBot);
 371             listServer.processIncoming();
 372             listServer.processIncoming();
 373 
 374             // Make two file specific comments
</pre>
<hr />
<pre>
 416     void commentThreading(TestInfo testInfo) throws IOException {
 417         try (var credentials = new HostCredentials(testInfo);
 418              var tempFolder = new TemporaryDirectory();
 419              var archiveFolder = new TemporaryDirectory();
 420              var listServer = new TestMailmanServer()) {
 421             var author = credentials.getHostedRepository();
 422             var reviewer = credentials.getHostedRepository();
 423             var archive = credentials.getHostedRepository();
 424             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 425             var censusBuilder = credentials.getCensusBuilder()
 426                                            .addReviewer(reviewer.host().getCurrentUserDetails().id())
 427                                            .addAuthor(author.host().getCurrentUserDetails().id());
 428             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 429             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 430                                                  listAddress, Set.of(), Set.of(),
 431                                                  listServer.getArchive(),
 432                                                  listServer.getSMTP(),
 433                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 434                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 435                                                  Set.of(), Map.of(),
<span class="line-modified"> 436                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>

 437 
 438             // Populate the projects repository
 439             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 440             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 441             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 442             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 443             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 444 
 445             // Make a change with a corresponding PR
 446             var editHash = CheckableRepository.appendAndCommit(localRepo);
 447             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 448             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 449             pr.setBody(&quot;This is now ready&quot;);
 450             TestBotRunner.runPeriodicItems(mlBot);
 451             listServer.processIncoming();
 452 
 453             // Make a file specific comment
 454             var reviewPr = reviewer.getPullRequest(pr.getId());
 455             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 456             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
</pre>
<hr />
<pre>
 525 
 526     @Test
 527     void reviewContext(TestInfo testInfo) throws IOException {
 528         try (var credentials = new HostCredentials(testInfo);
 529              var tempFolder = new TemporaryDirectory();
 530              var archiveFolder = new TemporaryDirectory();
 531              var listServer = new TestMailmanServer()) {
 532             var author = credentials.getHostedRepository();
 533             var archive = credentials.getHostedRepository();
 534             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 535             var censusBuilder = credentials.getCensusBuilder()
 536                                            .addAuthor(author.host().getCurrentUserDetails().id());
 537             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 538             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 539                                                  listAddress, Set.of(), Set.of(),
 540                                                  listServer.getArchive(),
 541                                                  listServer.getSMTP(),
 542                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 543                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 544                                                  Set.of(), Map.of(),
<span class="line-modified"> 545                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>

 546 
 547             // Populate the projects repository
 548             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 549             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 550             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 551             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 552             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 553 
 554             // Make a change with a corresponding PR
 555             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
 556             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 557             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 558             pr.setBody(&quot;This is now ready&quot;);
 559             TestBotRunner.runPeriodicItems(mlBot);
 560             listServer.processIncoming();
 561 
 562             // Make a file specific comment
 563             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 564 
 565             TestBotRunner.runPeriodicItems(mlBot);
</pre>
<hr />
<pre>
 575 
 576     @Test
 577     void multipleReviewContexts(TestInfo testInfo) throws IOException {
 578         try (var credentials = new HostCredentials(testInfo);
 579              var tempFolder = new TemporaryDirectory();
 580              var archiveFolder = new TemporaryDirectory();
 581              var listServer = new TestMailmanServer()) {
 582             var author = credentials.getHostedRepository();
 583             var archive = credentials.getHostedRepository();
 584             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 585             var censusBuilder = credentials.getCensusBuilder()
 586                                            .addAuthor(author.host().getCurrentUserDetails().id());
 587             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 588             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 589                                                  listAddress, Set.of(), Set.of(),
 590                                                  listServer.getArchive(),
 591                                                  listServer.getSMTP(),
 592                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 593                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 594                                                  Set.of(), Map.of(),
<span class="line-modified"> 595                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>

 596 
 597             // Populate the projects repository
 598             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 599             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 600             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 601             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 602             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 603             var initialHash = CheckableRepository.appendAndCommit(localRepo,
 604                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
 605                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
 606                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
 607                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
 608                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
 609                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
 610             localRepo.push(initialHash, author.getUrl(), &quot;master&quot;);
 611 
 612             // Make a change with a corresponding PR
 613             var current = Files.readString(localRepo.root().resolve(reviewFile), StandardCharsets.UTF_8);
 614             var updated = current.replaceAll(&quot;Line 2&quot;, &quot;Line 2 edit\nLine 2.5&quot;);
 615             updated = updated.replaceAll(&quot;Line 13&quot;, &quot;Line 12.5\nLine 13 edit&quot;);
</pre>
<hr />
<pre>
 643     }
 644 
 645     @Test
 646     void filterComments(TestInfo testInfo) throws IOException {
 647         try (var credentials = new HostCredentials(testInfo);
 648              var tempFolder = new TemporaryDirectory();
 649              var archiveFolder = new TemporaryDirectory();
 650              var listServer = new TestMailmanServer()) {
 651             var author = credentials.getHostedRepository();
 652             var archive = credentials.getHostedRepository();
 653             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 654             var censusBuilder = credentials.getCensusBuilder()
 655                                            .addAuthor(author.host().getCurrentUserDetails().id());
 656             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 657             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 658                                                  listAddress, Set.of(), Set.of(),
 659                                                  listServer.getArchive(), listServer.getSMTP(),
 660                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 661                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 662                                                  Set.of(), Map.of(),
<span class="line-modified"> 663                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>

 664 
 665             // Populate the projects repository
 666             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 667             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 668             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 669             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 670             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 671 
 672             // Make a change with a corresponding PR
 673             var editHash = CheckableRepository.appendAndCommit(localRepo);
 674             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 675             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 676             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
 677                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
 678 
 679             // Make a bunch of comments
 680             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
 681             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment &lt;!-- this is a comment --&gt;\n&quot;);
 682             pr.addComment(&quot;/integrate stuff&quot;);
 683             TestBotRunner.runPeriodicItems(mlBot);
</pre>
<hr />
<pre>
 701 
 702     @Test
 703     void incrementalChanges(TestInfo testInfo) throws IOException {
 704         try (var credentials = new HostCredentials(testInfo);
 705              var tempFolder = new TemporaryDirectory();
 706              var archiveFolder = new TemporaryDirectory();
 707              var listServer = new TestMailmanServer()) {
 708             var author = credentials.getHostedRepository();
 709             var archive = credentials.getHostedRepository();
 710             var commenter = credentials.getHostedRepository();
 711             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 712             var censusBuilder = credentials.getCensusBuilder()
 713                                            .addAuthor(author.host().getCurrentUserDetails().id());
 714             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 715             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 716                                                  listAddress, Set.of(), Set.of(),
 717                                                  listServer.getArchive(), listServer.getSMTP(),
 718                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 719                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 720                                                  Set.of(), Map.of(),
<span class="line-modified"> 721                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>

 722 
 723             // Populate the projects repository
 724             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 725             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 726             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 727             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 728             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 729 
 730             // Make a change with a corresponding PR
 731             var editHash = CheckableRepository.appendAndCommit(localRepo);
 732             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 733             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 734             pr.setBody(&quot;This is now ready&quot;);
 735 
 736             // Run an archive pass
 737             TestBotRunner.runPeriodicItems(mlBot);
 738             listServer.processIncoming();
 739 
 740             var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
 741             localRepo.push(nextHash, author.getUrl(), &quot;edit&quot;);
</pre>
<hr />
<pre>
 821     }
 822 
 823     @Test
 824     void rebased(TestInfo testInfo) throws IOException {
 825         try (var credentials = new HostCredentials(testInfo);
 826              var tempFolder = new TemporaryDirectory();
 827              var archiveFolder = new TemporaryDirectory();
 828              var listServer = new TestMailmanServer()) {
 829             var author = credentials.getHostedRepository();
 830             var archive = credentials.getHostedRepository();
 831             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 832             var censusBuilder = credentials.getCensusBuilder()
 833                                            .addAuthor(author.host().getCurrentUserDetails().id());
 834             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 835             var mlBot = new MailingListBridgeBot(sender, author, archive, censusBuilder.build(), &quot;master&quot;,
 836                                                  listAddress, Set.of(), Set.of(),
 837                                                  listServer.getArchive(), listServer.getSMTP(),
 838                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 839                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 840                                                  Set.of(), Map.of(),
<span class="line-modified"> 841                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>

 842 
 843             // Populate the projects repository
 844             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 845             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.getRepositoryType(), reviewFile);
 846             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 847             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 848             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 849 
 850             // Make a change with a corresponding PR
 851             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
 852             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 853             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 854             pr.setBody(&quot;This is now ready&quot;);
 855 
 856             // Run an archive pass
 857             TestBotRunner.runPeriodicItems(mlBot);
 858             listServer.processIncoming();
 859 
 860             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.getUrl(), &quot;master&quot;);
 861             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
</pre>
<hr />
<pre>
 913         try (var credentials = new HostCredentials(testInfo);
 914              var tempFolder = new TemporaryDirectory();
 915              var archiveFolder = new TemporaryDirectory();
 916              var webrevFolder = new TemporaryDirectory();
 917              var listServer = new TestMailmanServer()) {
 918             var author = credentials.getHostedRepository();
 919             var archive = credentials.getHostedRepository();
 920             var ignored = credentials.getHostedRepository();
 921             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 922             var censusBuilder = credentials.getCensusBuilder()
 923                                            .addAuthor(author.host().getCurrentUserDetails().id());
 924             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 925             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 926                                                  listAddress,
 927                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 928                                                  Set.of(),
 929                                                  listServer.getArchive(), listServer.getSMTP(),
 930                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 931                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 932                                                  Set.of(), Map.of(),
<span class="line-modified"> 933                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>

 934 
 935             // Populate the projects repository
 936             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
 937             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 938             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 939             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 940 
 941             // Make a change with a corresponding PR
 942             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 943                                                                &quot;Change msg\n\nWith several lines&quot;);
 944             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 945             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 946 
 947             // Flag it as ready for review
 948             pr.setBody(&quot;This should now be ready&quot;);
 949 
 950             // Run an archive pass
 951             TestBotRunner.runPeriodicItems(mlBot);
 952 
 953             // The archive should now contain an entry
</pre>
<hr />
<pre>
 985     @Test
 986     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
 987         try (var credentials = new HostCredentials(testInfo);
 988              var tempFolder = new TemporaryDirectory();
 989              var archiveFolder = new TemporaryDirectory();
 990              var listServer = new TestMailmanServer()) {
 991             var author = credentials.getHostedRepository();
 992             var archive = credentials.getHostedRepository();
 993             var reviewer = credentials.getHostedRepository();
 994             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 995             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 996             var censusBuilder = credentials.getCensusBuilder()
 997                                            .addReviewer(reviewer.host().getCurrentUserDetails().id())
 998                                            .addAuthor(author.host().getCurrentUserDetails().id());
 999             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
1000                                                  listAddress, Set.of(), Set.of(),
1001                                                  listServer.getArchive(), listServer.getSMTP(),
1002                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
1003                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
1004                                                  Set.of(), Map.of(),
<span class="line-modified">1005                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>

1006 
1007             // Populate the projects repository
1008             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1009             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
1010             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1011             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
1012             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
1013 
1014             // Make a change with a corresponding PR
1015             var editHash = CheckableRepository.appendAndCommit(localRepo);
1016             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
1017             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1018             pr.setBody(&quot;This is now ready&quot;);
1019 
1020             // Run an archive pass
1021             TestBotRunner.runPeriodicItems(mlBot);
1022 
1023             // First unapprove it
1024             var reviewedPr = reviewer.getPullRequest(pr.getId());
1025             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
</pre>
<hr />
<pre>
1068     void ignoreComments(TestInfo testInfo) throws IOException {
1069         try (var credentials = new HostCredentials(testInfo);
1070              var tempFolder = new TemporaryDirectory();
1071              var archiveFolder = new TemporaryDirectory();
1072              var listServer = new TestMailmanServer()) {
1073             var author = credentials.getHostedRepository();
1074             var ignored = credentials.getHostedRepository();
1075             var archive = credentials.getHostedRepository();
1076             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1077             var censusBuilder = credentials.getCensusBuilder()
1078                                            .addAuthor(author.host().getCurrentUserDetails().id());
1079             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1080             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
1081                                                  listAddress,
1082                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
1083                                                  Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)),
1084                                                  listServer.getArchive(), listServer.getSMTP(),
1085                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
1086                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
1087                                                  Set.of(), Map.of(),
<span class="line-modified">1088                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>

1089 
1090             // Populate the projects repository
1091             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1092             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
1093             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1094             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
1095             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
1096 
1097             // Make a change with a corresponding PR
1098             var editHash = CheckableRepository.appendAndCommit(localRepo);
1099             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
1100             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1101             pr.setBody(&quot;This is now ready&quot;);
1102 
1103             // Make a bunch of comments
1104             pr.addComment(&quot;Plain comment&quot;);
1105             pr.addComment(&quot;ignore this comment&quot;);
1106             pr.addComment(&quot;I think it is time to\nignore this comment!&quot;);
1107             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review ignore this comment&quot;);
1108 
</pre>
</td>
<td>
<hr />
<pre>
  95         try (var credentials = new HostCredentials(testInfo);
  96              var tempFolder = new TemporaryDirectory();
  97              var archiveFolder = new TemporaryDirectory();
  98              var webrevFolder = new TemporaryDirectory();
  99              var listServer = new TestMailmanServer()) {
 100             var author = credentials.getHostedRepository();
 101             var archive = credentials.getHostedRepository();
 102             var ignored = credentials.getHostedRepository();
 103             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 104             var censusBuilder = credentials.getCensusBuilder()
 105                                            .addAuthor(author.host().getCurrentUserDetails().id());
 106             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 107             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,
 108                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 109                                                  Set.of(),
 110                                                  listServer.getArchive(), listServer.getSMTP(),
 111                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 112                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 113                                                  Set.of(&quot;rfr&quot;), Map.of(ignored.host().getCurrentUserDetails().userName(),
 114                                                                        Pattern.compile(&quot;ready&quot;)),
<span class="line-modified"> 115                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),</span>
<span class="line-added"> 116                                                  Map.of(&quot;Extra1&quot;, &quot;val1&quot;, &quot;Extra2&quot;, &quot;val2&quot;));</span>
 117 
 118             // Populate the projects repository
 119             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
 120             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 121             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 122             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 123 
 124             // Make a change with a corresponding PR
 125             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 126                                                                &quot;Change msg\n\nWith several lines&quot;);
 127             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 128             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 129             pr.setBody(&quot;This should not be ready&quot;);
 130 
 131             // Run an archive pass
 132             TestBotRunner.runPeriodicItems(mlBot);
 133 
 134             // A PR that isn&#39;t ready for review should not be archived
 135             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 136             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
</pre>
<hr />
<pre>
 172             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
 173             assertTrue(archiveContains(archiveFolder.path(), &quot;http://www.test.test/&quot;));
 174             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));
 175             assertTrue(archiveContains(archiveFolder.path(), &quot;Issue:&quot;));
 176             assertTrue(archiveContains(archiveFolder.path(), &quot;http://issues.test/browse/TSTPRJ-1234&quot;));
 177             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch:&quot;));
 178             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - &quot; + editHash.abbreviate() + &quot;: Change msg&quot;));
 179             assertFalse(archiveContains(archiveFolder.path(), &quot;With several lines&quot;));
 180 
 181             // The mailing list as well
 182             listServer.processIncoming();
 183             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 184             var mailmanList = mailmanServer.getList(listAddress.address());
 185             var conversations = mailmanList.conversations(Duration.ofDays(1));
 186             assertEquals(1, conversations.size());
 187             var mail = conversations.get(0).first();
 188             assertEquals(&quot;RFR: 1234: This is a pull request&quot;, mail.subject());
 189             assertEquals(pr.getAuthor().fullName(), mail.author().fullName().orElseThrow());
 190             assertEquals(noreplyAddress(archive), mail.author().address());
 191             assertEquals(from, mail.sender());
<span class="line-added"> 192             assertEquals(&quot;val1&quot;, mail.headerValue(&quot;Extra1&quot;));</span>
<span class="line-added"> 193             assertEquals(&quot;val2&quot;, mail.headerValue(&quot;Extra2&quot;));</span>
 194 
 195             // And there should be a webrev
 196             Repository.materialize(webrevFolder.path(), archive.getUrl(), &quot;webrev&quot;);
 197             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
 198             var comments = pr.getComments();
 199             var webrevComments = comments.stream()
 200                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 201                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 202                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 203                                          .collect(Collectors.toList());
 204             assertEquals(1, webrevComments.size());
 205 
 206             // Add a comment
 207             pr.addComment(&quot;This is a comment :smile:&quot;);
 208 
 209             // Add a comment from an ignored user as well
 210             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);
 211 
 212             // Run another archive pass
 213             TestBotRunner.runPeriodicItems(mlBot);
</pre>
<hr />
<pre>
 250     @Test
 251     void reviewComment(TestInfo testInfo) throws IOException {
 252         try (var credentials = new HostCredentials(testInfo);
 253              var tempFolder = new TemporaryDirectory();
 254              var archiveFolder = new TemporaryDirectory();
 255              var listServer = new TestMailmanServer()) {
 256             var author = credentials.getHostedRepository();
 257             var archive = credentials.getHostedRepository();
 258             var ignored = credentials.getHostedRepository();
 259             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 260             var censusBuilder = credentials.getCensusBuilder()
 261                                            .addAuthor(author.host().getCurrentUserDetails().id());
 262             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 263             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,
 264                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 265                                                  Set.of(),
 266                                                  listServer.getArchive(), listServer.getSMTP(),
 267                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 268                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 269                                                  Set.of(), Map.of(),
<span class="line-modified"> 270                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),</span>
<span class="line-added"> 271                                                  Map.of());</span>
 272 
 273             // Populate the projects repository
 274             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 275             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 276             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 277             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 278             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 279 
 280             // Make a change with a corresponding PR
 281             var editHash = CheckableRepository.appendAndCommit(localRepo);
 282             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 283             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 284             pr.setBody(&quot;This is now ready&quot;);
 285             TestBotRunner.runPeriodicItems(mlBot);
 286             listServer.processIncoming();
 287 
 288             // And make a file specific comment
 289             var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
 290             var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 291 
</pre>
<hr />
<pre>
 338 
 339     @Test
 340     void combineComments(TestInfo testInfo) throws IOException {
 341         try (var credentials = new HostCredentials(testInfo);
 342              var tempFolder = new TemporaryDirectory();
 343              var archiveFolder = new TemporaryDirectory();
 344              var listServer = new TestMailmanServer()) {
 345             var author = credentials.getHostedRepository();
 346             var archive = credentials.getHostedRepository();
 347             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 348             var censusBuilder = credentials.getCensusBuilder()
 349                                            .addAuthor(author.host().getCurrentUserDetails().id());
 350             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 351             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 352                                                  listAddress, Set.of(), Set.of(),
 353                                                  listServer.getArchive(),
 354                                                  listServer.getSMTP(),
 355                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 356                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 357                                                  Set.of(), Map.of(),
<span class="line-modified"> 358                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),</span>
<span class="line-added"> 359                                                  Map.of());</span>
 360 
 361             // Populate the projects repository
 362             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 363             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 364             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 365             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 366             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 367 
 368             // Make a change with a corresponding PR
 369             var editHash = CheckableRepository.appendAndCommit(localRepo);
 370             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 371             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 372             pr.setBody(&quot;This is now ready&quot;);
 373             pr.addComment(&quot;Avoid combining&quot;);
 374 
 375             TestBotRunner.runPeriodicItems(mlBot);
 376             listServer.processIncoming();
 377             listServer.processIncoming();
 378 
 379             // Make two file specific comments
</pre>
<hr />
<pre>
 421     void commentThreading(TestInfo testInfo) throws IOException {
 422         try (var credentials = new HostCredentials(testInfo);
 423              var tempFolder = new TemporaryDirectory();
 424              var archiveFolder = new TemporaryDirectory();
 425              var listServer = new TestMailmanServer()) {
 426             var author = credentials.getHostedRepository();
 427             var reviewer = credentials.getHostedRepository();
 428             var archive = credentials.getHostedRepository();
 429             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 430             var censusBuilder = credentials.getCensusBuilder()
 431                                            .addReviewer(reviewer.host().getCurrentUserDetails().id())
 432                                            .addAuthor(author.host().getCurrentUserDetails().id());
 433             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 434             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 435                                                  listAddress, Set.of(), Set.of(),
 436                                                  listServer.getArchive(),
 437                                                  listServer.getSMTP(),
 438                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 439                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 440                                                  Set.of(), Map.of(),
<span class="line-modified"> 441                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),</span>
<span class="line-added"> 442                                                  Map.of());</span>
 443 
 444             // Populate the projects repository
 445             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 446             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 447             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 448             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 449             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 450 
 451             // Make a change with a corresponding PR
 452             var editHash = CheckableRepository.appendAndCommit(localRepo);
 453             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 454             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 455             pr.setBody(&quot;This is now ready&quot;);
 456             TestBotRunner.runPeriodicItems(mlBot);
 457             listServer.processIncoming();
 458 
 459             // Make a file specific comment
 460             var reviewPr = reviewer.getPullRequest(pr.getId());
 461             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 462             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
</pre>
<hr />
<pre>
 531 
 532     @Test
 533     void reviewContext(TestInfo testInfo) throws IOException {
 534         try (var credentials = new HostCredentials(testInfo);
 535              var tempFolder = new TemporaryDirectory();
 536              var archiveFolder = new TemporaryDirectory();
 537              var listServer = new TestMailmanServer()) {
 538             var author = credentials.getHostedRepository();
 539             var archive = credentials.getHostedRepository();
 540             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 541             var censusBuilder = credentials.getCensusBuilder()
 542                                            .addAuthor(author.host().getCurrentUserDetails().id());
 543             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 544             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 545                                                  listAddress, Set.of(), Set.of(),
 546                                                  listServer.getArchive(),
 547                                                  listServer.getSMTP(),
 548                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 549                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 550                                                  Set.of(), Map.of(),
<span class="line-modified"> 551                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),</span>
<span class="line-added"> 552                                                  Map.of());</span>
 553 
 554             // Populate the projects repository
 555             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 556             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 557             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 558             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 559             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 560 
 561             // Make a change with a corresponding PR
 562             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
 563             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 564             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 565             pr.setBody(&quot;This is now ready&quot;);
 566             TestBotRunner.runPeriodicItems(mlBot);
 567             listServer.processIncoming();
 568 
 569             // Make a file specific comment
 570             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 571 
 572             TestBotRunner.runPeriodicItems(mlBot);
</pre>
<hr />
<pre>
 582 
 583     @Test
 584     void multipleReviewContexts(TestInfo testInfo) throws IOException {
 585         try (var credentials = new HostCredentials(testInfo);
 586              var tempFolder = new TemporaryDirectory();
 587              var archiveFolder = new TemporaryDirectory();
 588              var listServer = new TestMailmanServer()) {
 589             var author = credentials.getHostedRepository();
 590             var archive = credentials.getHostedRepository();
 591             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 592             var censusBuilder = credentials.getCensusBuilder()
 593                                            .addAuthor(author.host().getCurrentUserDetails().id());
 594             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 595             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 596                                                  listAddress, Set.of(), Set.of(),
 597                                                  listServer.getArchive(),
 598                                                  listServer.getSMTP(),
 599                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 600                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 601                                                  Set.of(), Map.of(),
<span class="line-modified"> 602                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),</span>
<span class="line-added"> 603                                                  Map.of());</span>
 604 
 605             // Populate the projects repository
 606             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 607             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 608             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 609             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 610             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 611             var initialHash = CheckableRepository.appendAndCommit(localRepo,
 612                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
 613                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
 614                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
 615                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
 616                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
 617                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
 618             localRepo.push(initialHash, author.getUrl(), &quot;master&quot;);
 619 
 620             // Make a change with a corresponding PR
 621             var current = Files.readString(localRepo.root().resolve(reviewFile), StandardCharsets.UTF_8);
 622             var updated = current.replaceAll(&quot;Line 2&quot;, &quot;Line 2 edit\nLine 2.5&quot;);
 623             updated = updated.replaceAll(&quot;Line 13&quot;, &quot;Line 12.5\nLine 13 edit&quot;);
</pre>
<hr />
<pre>
 651     }
 652 
 653     @Test
 654     void filterComments(TestInfo testInfo) throws IOException {
 655         try (var credentials = new HostCredentials(testInfo);
 656              var tempFolder = new TemporaryDirectory();
 657              var archiveFolder = new TemporaryDirectory();
 658              var listServer = new TestMailmanServer()) {
 659             var author = credentials.getHostedRepository();
 660             var archive = credentials.getHostedRepository();
 661             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 662             var censusBuilder = credentials.getCensusBuilder()
 663                                            .addAuthor(author.host().getCurrentUserDetails().id());
 664             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 665             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 666                                                  listAddress, Set.of(), Set.of(),
 667                                                  listServer.getArchive(), listServer.getSMTP(),
 668                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 669                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 670                                                  Set.of(), Map.of(),
<span class="line-modified"> 671                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),</span>
<span class="line-added"> 672                                                  Map.of());</span>
 673 
 674             // Populate the projects repository
 675             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 676             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 677             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 678             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 679             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 680 
 681             // Make a change with a corresponding PR
 682             var editHash = CheckableRepository.appendAndCommit(localRepo);
 683             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 684             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 685             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
 686                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
 687 
 688             // Make a bunch of comments
 689             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
 690             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment &lt;!-- this is a comment --&gt;\n&quot;);
 691             pr.addComment(&quot;/integrate stuff&quot;);
 692             TestBotRunner.runPeriodicItems(mlBot);
</pre>
<hr />
<pre>
 710 
 711     @Test
 712     void incrementalChanges(TestInfo testInfo) throws IOException {
 713         try (var credentials = new HostCredentials(testInfo);
 714              var tempFolder = new TemporaryDirectory();
 715              var archiveFolder = new TemporaryDirectory();
 716              var listServer = new TestMailmanServer()) {
 717             var author = credentials.getHostedRepository();
 718             var archive = credentials.getHostedRepository();
 719             var commenter = credentials.getHostedRepository();
 720             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 721             var censusBuilder = credentials.getCensusBuilder()
 722                                            .addAuthor(author.host().getCurrentUserDetails().id());
 723             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 724             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 725                                                  listAddress, Set.of(), Set.of(),
 726                                                  listServer.getArchive(), listServer.getSMTP(),
 727                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 728                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 729                                                  Set.of(), Map.of(),
<span class="line-modified"> 730                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),</span>
<span class="line-added"> 731                                                  Map.of());</span>
 732 
 733             // Populate the projects repository
 734             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 735             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 736             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 737             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 738             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 739 
 740             // Make a change with a corresponding PR
 741             var editHash = CheckableRepository.appendAndCommit(localRepo);
 742             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 743             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 744             pr.setBody(&quot;This is now ready&quot;);
 745 
 746             // Run an archive pass
 747             TestBotRunner.runPeriodicItems(mlBot);
 748             listServer.processIncoming();
 749 
 750             var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
 751             localRepo.push(nextHash, author.getUrl(), &quot;edit&quot;);
</pre>
<hr />
<pre>
 831     }
 832 
 833     @Test
 834     void rebased(TestInfo testInfo) throws IOException {
 835         try (var credentials = new HostCredentials(testInfo);
 836              var tempFolder = new TemporaryDirectory();
 837              var archiveFolder = new TemporaryDirectory();
 838              var listServer = new TestMailmanServer()) {
 839             var author = credentials.getHostedRepository();
 840             var archive = credentials.getHostedRepository();
 841             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 842             var censusBuilder = credentials.getCensusBuilder()
 843                                            .addAuthor(author.host().getCurrentUserDetails().id());
 844             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 845             var mlBot = new MailingListBridgeBot(sender, author, archive, censusBuilder.build(), &quot;master&quot;,
 846                                                  listAddress, Set.of(), Set.of(),
 847                                                  listServer.getArchive(), listServer.getSMTP(),
 848                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 849                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 850                                                  Set.of(), Map.of(),
<span class="line-modified"> 851                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),</span>
<span class="line-added"> 852                                                  Map.of());</span>
 853 
 854             // Populate the projects repository
 855             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 856             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.getRepositoryType(), reviewFile);
 857             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 858             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 859             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 860 
 861             // Make a change with a corresponding PR
 862             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
 863             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 864             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 865             pr.setBody(&quot;This is now ready&quot;);
 866 
 867             // Run an archive pass
 868             TestBotRunner.runPeriodicItems(mlBot);
 869             listServer.processIncoming();
 870 
 871             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.getUrl(), &quot;master&quot;);
 872             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
</pre>
<hr />
<pre>
 924         try (var credentials = new HostCredentials(testInfo);
 925              var tempFolder = new TemporaryDirectory();
 926              var archiveFolder = new TemporaryDirectory();
 927              var webrevFolder = new TemporaryDirectory();
 928              var listServer = new TestMailmanServer()) {
 929             var author = credentials.getHostedRepository();
 930             var archive = credentials.getHostedRepository();
 931             var ignored = credentials.getHostedRepository();
 932             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 933             var censusBuilder = credentials.getCensusBuilder()
 934                                            .addAuthor(author.host().getCurrentUserDetails().id());
 935             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 936             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 937                                                  listAddress,
 938                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 939                                                  Set.of(),
 940                                                  listServer.getArchive(), listServer.getSMTP(),
 941                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 942                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 943                                                  Set.of(), Map.of(),
<span class="line-modified"> 944                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),</span>
<span class="line-added"> 945                                                  Map.of());</span>
 946 
 947             // Populate the projects repository
 948             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
 949             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 950             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 951             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 952 
 953             // Make a change with a corresponding PR
 954             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 955                                                                &quot;Change msg\n\nWith several lines&quot;);
 956             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 957             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 958 
 959             // Flag it as ready for review
 960             pr.setBody(&quot;This should now be ready&quot;);
 961 
 962             // Run an archive pass
 963             TestBotRunner.runPeriodicItems(mlBot);
 964 
 965             // The archive should now contain an entry
</pre>
<hr />
<pre>
 997     @Test
 998     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
 999         try (var credentials = new HostCredentials(testInfo);
1000              var tempFolder = new TemporaryDirectory();
1001              var archiveFolder = new TemporaryDirectory();
1002              var listServer = new TestMailmanServer()) {
1003             var author = credentials.getHostedRepository();
1004             var archive = credentials.getHostedRepository();
1005             var reviewer = credentials.getHostedRepository();
1006             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1007             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1008             var censusBuilder = credentials.getCensusBuilder()
1009                                            .addReviewer(reviewer.host().getCurrentUserDetails().id())
1010                                            .addAuthor(author.host().getCurrentUserDetails().id());
1011             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
1012                                                  listAddress, Set.of(), Set.of(),
1013                                                  listServer.getArchive(), listServer.getSMTP(),
1014                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
1015                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
1016                                                  Set.of(), Map.of(),
<span class="line-modified">1017                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),</span>
<span class="line-added">1018                                                  Map.of());</span>
1019 
1020             // Populate the projects repository
1021             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1022             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
1023             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1024             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
1025             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
1026 
1027             // Make a change with a corresponding PR
1028             var editHash = CheckableRepository.appendAndCommit(localRepo);
1029             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
1030             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1031             pr.setBody(&quot;This is now ready&quot;);
1032 
1033             // Run an archive pass
1034             TestBotRunner.runPeriodicItems(mlBot);
1035 
1036             // First unapprove it
1037             var reviewedPr = reviewer.getPullRequest(pr.getId());
1038             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
</pre>
<hr />
<pre>
1081     void ignoreComments(TestInfo testInfo) throws IOException {
1082         try (var credentials = new HostCredentials(testInfo);
1083              var tempFolder = new TemporaryDirectory();
1084              var archiveFolder = new TemporaryDirectory();
1085              var listServer = new TestMailmanServer()) {
1086             var author = credentials.getHostedRepository();
1087             var ignored = credentials.getHostedRepository();
1088             var archive = credentials.getHostedRepository();
1089             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1090             var censusBuilder = credentials.getCensusBuilder()
1091                                            .addAuthor(author.host().getCurrentUserDetails().id());
1092             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1093             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
1094                                                  listAddress,
1095                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
1096                                                  Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)),
1097                                                  listServer.getArchive(), listServer.getSMTP(),
1098                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
1099                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
1100                                                  Set.of(), Map.of(),
<span class="line-modified">1101                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),</span>
<span class="line-added">1102                                                  Map.of());</span>
1103 
1104             // Populate the projects repository
1105             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1106             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
1107             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1108             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
1109             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
1110 
1111             // Make a change with a corresponding PR
1112             var editHash = CheckableRepository.appendAndCommit(localRepo);
1113             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
1114             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1115             pr.setBody(&quot;This is now ready&quot;);
1116 
1117             // Make a bunch of comments
1118             pr.addComment(&quot;Plain comment&quot;);
1119             pr.addComment(&quot;ignore this comment&quot;);
1120             pr.addComment(&quot;I think it is time to\nignore this comment!&quot;);
1121             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review ignore this comment&quot;);
1122 
</pre>
</td>
</tr>
</table>
<center><a href="MailingListArchiveReaderBotTests.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>