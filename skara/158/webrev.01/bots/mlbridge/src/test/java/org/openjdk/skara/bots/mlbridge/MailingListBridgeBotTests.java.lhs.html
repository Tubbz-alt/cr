<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.mlbridge;
  24 
  25 import org.openjdk.skara.email.EmailAddress;
  26 import org.openjdk.skara.host.*;
  27 import org.openjdk.skara.host.network.URIBuilder;
  28 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  29 import org.openjdk.skara.test.*;
  30 import org.openjdk.skara.vcs.Repository;
  31 
  32 import org.junit.jupiter.api.*;
  33 
  34 import java.io.IOException;
  35 import java.nio.charset.StandardCharsets;
  36 import java.nio.file.*;
  37 import java.time.Duration;
  38 import java.util.*;
  39 import java.util.regex.Pattern;
  40 import java.util.stream.Collectors;
  41 
  42 import static org.junit.jupiter.api.Assertions.*;
  43 
  44 class MailingListBridgeBotTests {
  45     private boolean archiveContains(Path archive, String text) {
  46         return archiveContainsCount(archive, text) &gt; 0;
  47     }
  48 
  49     private int archiveContainsCount(Path archive, String text) {
  50         try {
  51             var mbox = Files.find(archive, 50, (path, attrs) -&gt; path.toString().endsWith(&quot;.mbox&quot;)).findAny();
  52             if (mbox.isEmpty()) {
  53                 return 0;
  54             }
  55             var lines = Files.readString(mbox.get(), StandardCharsets.UTF_8);
  56             var pattern = Pattern.compile(text);
  57             int count = 0;
  58             for (var line : lines.split(&quot;\\R&quot;)) {
  59                 var matcher = pattern.matcher(line);
  60                 if (matcher.find()) {
  61                     count++;
  62                 }
  63             }
  64             return count;
  65         } catch (IOException e) {
  66             return 0;
  67         }
  68     }
  69 
  70     private boolean webrevContains(Path webrev, String text) {
  71         try {
  72             var index = Files.find(webrev, 5, (path, attrs) -&gt; path.toString().endsWith(&quot;index.html&quot;)).findAny();
  73             if (index.isEmpty()) {
  74                 return false;
  75             }
  76             var lines = Files.readString(index.get(), StandardCharsets.UTF_8);
  77             return lines.contains(text);
  78         } catch (IOException e) {
  79             return false;
  80         }
  81     }
  82 
  83     private long countSubstrings(String string, String substring) {
  84         return Pattern.compile(substring).matcher(string).results().count();
  85     }
  86 
  87     private String noreplyAddress(HostedRepository repository) {
  88         return repository.host().getCurrentUserDetails().id() + &quot;+&quot; +
  89                 repository.host().getCurrentUserDetails().userName() +
  90                 &quot;@users.noreply.test&quot;;
  91     }
  92 
  93     @Test
  94     void simpleArchive(TestInfo testInfo) throws IOException {
  95         try (var credentials = new HostCredentials(testInfo);
  96              var tempFolder = new TemporaryDirectory();
  97              var archiveFolder = new TemporaryDirectory();
  98              var webrevFolder = new TemporaryDirectory();
  99              var listServer = new TestMailmanServer()) {
 100             var author = credentials.getHostedRepository();
 101             var archive = credentials.getHostedRepository();
 102             var ignored = credentials.getHostedRepository();
 103             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 104             var censusBuilder = credentials.getCensusBuilder()
 105                                            .addAuthor(author.host().getCurrentUserDetails().id());
 106             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 107             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,
 108                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 109                                                  Set.of(),
 110                                                  listServer.getArchive(), listServer.getSMTP(),
 111                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 112                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 113                                                  Set.of(&quot;rfr&quot;), Map.of(ignored.host().getCurrentUserDetails().userName(),
 114                                                                        Pattern.compile(&quot;ready&quot;)),
<a name="1" id="anc1"></a><span class="line-modified"> 115                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>

 116 
 117             // Populate the projects repository
 118             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
 119             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 120             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 121             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 122 
 123             // Make a change with a corresponding PR
 124             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 125                                                                &quot;Change msg\n\nWith several lines&quot;);
 126             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 127             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 128             pr.setBody(&quot;This should not be ready&quot;);
 129 
 130             // Run an archive pass
 131             TestBotRunner.runPeriodicItems(mlBot);
 132 
 133             // A PR that isn&#39;t ready for review should not be archived
 134             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 135             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 136 
 137             // Flag it as ready for review
 138             pr.setBody(&quot;This should now be ready&quot;);
 139             pr.addLabel(&quot;rfr&quot;);
 140 
 141             // Run another archive pass
 142             TestBotRunner.runPeriodicItems(mlBot);
 143 
 144             // But it should still not be archived
 145             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 146             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 147 
 148             // Now post a general comment - not a ready marker
 149             var ignoredPr = ignored.getPullRequest(pr.getId());
 150             ignoredPr.addComment(&quot;hello there&quot;);
 151 
 152             // Run another archive pass
 153             TestBotRunner.runPeriodicItems(mlBot);
 154 
 155             // It should still not be archived
 156             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 157             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 158 
 159             // Now post a ready comment
 160             ignoredPr.addComment(&quot;ready&quot;);
 161 
 162             // Run another archive pass
 163             TestBotRunner.runPeriodicItems(mlBot);
 164 
 165             // The archive should now contain an entry
 166             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 167             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 168             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
 169             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
 170             assertTrue(archiveContains(archiveFolder.path(), &quot;Changes:&quot;));
 171             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
 172             assertTrue(archiveContains(archiveFolder.path(), &quot;http://www.test.test/&quot;));
 173             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));
 174             assertTrue(archiveContains(archiveFolder.path(), &quot;Issue:&quot;));
 175             assertTrue(archiveContains(archiveFolder.path(), &quot;http://issues.test/browse/TSTPRJ-1234&quot;));
 176             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch:&quot;));
 177             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - &quot; + editHash.abbreviate() + &quot;: Change msg&quot;));
 178             assertFalse(archiveContains(archiveFolder.path(), &quot;With several lines&quot;));
 179 
 180             // The mailing list as well
 181             listServer.processIncoming();
 182             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 183             var mailmanList = mailmanServer.getList(listAddress.address());
 184             var conversations = mailmanList.conversations(Duration.ofDays(1));
 185             assertEquals(1, conversations.size());
 186             var mail = conversations.get(0).first();
 187             assertEquals(&quot;RFR: 1234: This is a pull request&quot;, mail.subject());
 188             assertEquals(pr.getAuthor().fullName(), mail.author().fullName().orElseThrow());
 189             assertEquals(noreplyAddress(archive), mail.author().address());
 190             assertEquals(from, mail.sender());
<a name="2" id="anc2"></a>

 191 
 192             // And there should be a webrev
 193             Repository.materialize(webrevFolder.path(), archive.getUrl(), &quot;webrev&quot;);
 194             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
 195             var comments = pr.getComments();
 196             var webrevComments = comments.stream()
 197                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 198                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 199                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 200                                          .collect(Collectors.toList());
 201             assertEquals(1, webrevComments.size());
 202 
 203             // Add a comment
 204             pr.addComment(&quot;This is a comment :smile:&quot;);
 205 
 206             // Add a comment from an ignored user as well
 207             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);
 208 
 209             // Run another archive pass
 210             TestBotRunner.runPeriodicItems(mlBot);
 211 
 212             // The archive should now contain the comment, but not the ignored one
 213             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 214             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a comment&quot;));
 215             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This should now be ready&quot;));
 216             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 217 
 218             listServer.processIncoming();
 219             conversations = mailmanList.conversations(Duration.ofDays(1));
 220             assertEquals(1, conversations.size());
 221             assertEquals(2, conversations.get(0).allMessages().size());
 222 
 223             // Remove the rfr flag and post another comment
 224             pr.addLabel(&quot;rfr&quot;);
 225             pr.addComment(&quot;This is another comment&quot;);
 226 
 227             // Run another archive pass
 228             TestBotRunner.runPeriodicItems(mlBot);
 229 
 230             // The archive should contain the additional comment
 231             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 232             assertTrue(archiveContains(archiveFolder.path(), &quot;This is another comment&quot;));
 233             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This should now be ready&quot;));
 234 
 235             listServer.processIncoming();
 236             conversations = mailmanList.conversations(Duration.ofDays(1));
 237             assertEquals(1, conversations.size());
 238             assertEquals(3, conversations.get(0).allMessages().size());
 239             for (var newMail : conversations.get(0).allMessages()) {
 240                 assertEquals(noreplyAddress(archive), newMail.author().address());
 241                 assertEquals(from, newMail.sender());
 242             }
 243             assertTrue(conversations.get(0).allMessages().get(2).body().contains(&quot;This is a comment 😄&quot;));
 244         }
 245     }
 246 
 247     @Test
 248     void reviewComment(TestInfo testInfo) throws IOException {
 249         try (var credentials = new HostCredentials(testInfo);
 250              var tempFolder = new TemporaryDirectory();
 251              var archiveFolder = new TemporaryDirectory();
 252              var listServer = new TestMailmanServer()) {
 253             var author = credentials.getHostedRepository();
 254             var archive = credentials.getHostedRepository();
 255             var ignored = credentials.getHostedRepository();
 256             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 257             var censusBuilder = credentials.getCensusBuilder()
 258                                            .addAuthor(author.host().getCurrentUserDetails().id());
 259             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 260             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,
 261                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 262                                                  Set.of(),
 263                                                  listServer.getArchive(), listServer.getSMTP(),
 264                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 265                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 266                                                  Set.of(), Map.of(),
<a name="3" id="anc3"></a><span class="line-modified"> 267                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>

 268 
 269             // Populate the projects repository
 270             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 271             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 272             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 273             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 274             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 275 
 276             // Make a change with a corresponding PR
 277             var editHash = CheckableRepository.appendAndCommit(localRepo);
 278             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 279             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 280             pr.setBody(&quot;This is now ready&quot;);
 281             TestBotRunner.runPeriodicItems(mlBot);
 282             listServer.processIncoming();
 283 
 284             // And make a file specific comment
 285             var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
 286             var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 287 
 288             // Add one from an ignored user as well
 289             var ignoredPr = ignored.getPullRequest(pr.getId());
 290             ignoredPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Don&#39;t mind me&quot;);
 291 
 292             // Process comments
 293             TestBotRunner.runPeriodicItems(mlBot);
 294             listServer.processIncoming();
 295 
 296             // The archive should now contain an entry
 297             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 298             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 299             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 300             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 301             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This is now ready&quot;));
 302             assertTrue(archiveContains(archiveFolder.path(), reviewFile.toString()));
 303             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 304 
 305             // The mailing list as well
 306             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 307             var mailmanList = mailmanServer.getList(listAddress.address());
 308             var conversations = mailmanList.conversations(Duration.ofDays(1));
 309             assertEquals(1, conversations.size());
 310             var mail = conversations.get(0).first();
 311             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 312 
 313             // Comment on the comment
 314             pr.addReviewCommentReply(comment, &quot;This is a review reply&quot;);
 315             TestBotRunner.runPeriodicItems(mlBot);
 316             listServer.processIncoming();
 317 
 318             // The archive should contain the additional comment (but no quoted footers)
 319             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 320             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a review reply&quot;));
 321             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This is now ready&quot;));
 322             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; PR:&quot;));
 323 
 324             // As well as the mailing list
 325             conversations = mailmanList.conversations(Duration.ofDays(1));
 326             assertEquals(1, conversations.size());
 327             assertEquals(3, conversations.get(0).allMessages().size());
 328             for (var newMail : conversations.get(0).allMessages()) {
 329                 assertEquals(noreplyAddress(archive), newMail.author().address());
 330                 assertEquals(from, newMail.sender());
 331             }
 332         }
 333     }
 334 
 335     @Test
 336     void combineComments(TestInfo testInfo) throws IOException {
 337         try (var credentials = new HostCredentials(testInfo);
 338              var tempFolder = new TemporaryDirectory();
 339              var archiveFolder = new TemporaryDirectory();
 340              var listServer = new TestMailmanServer()) {
 341             var author = credentials.getHostedRepository();
 342             var archive = credentials.getHostedRepository();
 343             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 344             var censusBuilder = credentials.getCensusBuilder()
 345                                            .addAuthor(author.host().getCurrentUserDetails().id());
 346             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 347             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 348                                                  listAddress, Set.of(), Set.of(),
 349                                                  listServer.getArchive(),
 350                                                  listServer.getSMTP(),
 351                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 352                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 353                                                  Set.of(), Map.of(),
<a name="4" id="anc4"></a><span class="line-modified"> 354                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>

 355 
 356             // Populate the projects repository
 357             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 358             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 359             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 360             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 361             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 362 
 363             // Make a change with a corresponding PR
 364             var editHash = CheckableRepository.appendAndCommit(localRepo);
 365             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 366             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 367             pr.setBody(&quot;This is now ready&quot;);
 368             pr.addComment(&quot;Avoid combining&quot;);
 369 
 370             TestBotRunner.runPeriodicItems(mlBot);
 371             listServer.processIncoming();
 372             listServer.processIncoming();
 373 
 374             // Make two file specific comments
 375             var first = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 376             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 377             TestBotRunner.runPeriodicItems(mlBot);
 378             listServer.processIncoming();
 379 
 380             // The archive should contain a combined entry
 381             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 382             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 383 
 384             // As well as the mailing list
 385             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 386             var mailmanList = mailmanServer.getList(listAddress.address());
 387             var conversations = mailmanList.conversations(Duration.ofDays(1));
 388             assertEquals(1, conversations.size());
 389             var mail = conversations.get(0).first();
 390             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 391             assertEquals(3, conversations.get(0).allMessages().size());
 392 
 393             var commentReply = conversations.get(0).replies(mail).get(0);
 394             assertEquals(2, commentReply.body().split(&quot;^On.*wrote:&quot;).length);
 395             assertTrue(commentReply.body().contains(&quot;Avoid combining\n\n&quot;), commentReply.body());
 396 
 397             var reviewReply = conversations.get(0).replies(mail).get(1);
 398             assertEquals(2, reviewReply.body().split(&quot;^On.*wrote:&quot;).length);
 399             assertEquals(2, reviewReply.body().split(&quot;&gt; This is now ready&quot;).length, reviewReply.body());
 400             assertEquals(&quot;Re: RFR: This is a pull request&quot;, reviewReply.subject());
 401             assertTrue(reviewReply.body().contains(&quot;Review comment\n\n&quot;), reviewReply.body());
 402             assertTrue(reviewReply.body().contains(&quot;Another review comment&quot;), reviewReply.body());
 403 
 404             // Now reply to the first (collapsed) comment
 405             pr.addReviewCommentReply(first, &quot;I agree&quot;);
 406             TestBotRunner.runPeriodicItems(mlBot);
 407             listServer.processIncoming();
 408 
 409             // The archive should contain a new entry
 410             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 411             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 412         }
 413     }
 414 
 415     @Test
 416     void commentThreading(TestInfo testInfo) throws IOException {
 417         try (var credentials = new HostCredentials(testInfo);
 418              var tempFolder = new TemporaryDirectory();
 419              var archiveFolder = new TemporaryDirectory();
 420              var listServer = new TestMailmanServer()) {
 421             var author = credentials.getHostedRepository();
 422             var reviewer = credentials.getHostedRepository();
 423             var archive = credentials.getHostedRepository();
 424             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 425             var censusBuilder = credentials.getCensusBuilder()
 426                                            .addReviewer(reviewer.host().getCurrentUserDetails().id())
 427                                            .addAuthor(author.host().getCurrentUserDetails().id());
 428             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 429             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 430                                                  listAddress, Set.of(), Set.of(),
 431                                                  listServer.getArchive(),
 432                                                  listServer.getSMTP(),
 433                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 434                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 435                                                  Set.of(), Map.of(),
<a name="5" id="anc5"></a><span class="line-modified"> 436                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>

 437 
 438             // Populate the projects repository
 439             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 440             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 441             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 442             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 443             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 444 
 445             // Make a change with a corresponding PR
 446             var editHash = CheckableRepository.appendAndCommit(localRepo);
 447             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 448             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 449             pr.setBody(&quot;This is now ready&quot;);
 450             TestBotRunner.runPeriodicItems(mlBot);
 451             listServer.processIncoming();
 452 
 453             // Make a file specific comment
 454             var reviewPr = reviewer.getPullRequest(pr.getId());
 455             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 456             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 457             reviewPr.addReviewCommentReply(comment1, &quot;Great&quot;);
 458             TestBotRunner.runPeriodicItems(mlBot);
 459             listServer.processIncoming();
 460             listServer.processIncoming();
 461             listServer.processIncoming();
 462 
 463             // And a second one by ourselves
 464             var comment2 = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 465             reviewPr.addReviewCommentReply(comment2, &quot;Sounds good&quot;);
 466             pr.addReviewCommentReply(comment2, &quot;Thanks&quot;);
 467             TestBotRunner.runPeriodicItems(mlBot);
 468             listServer.processIncoming();
 469             listServer.processIncoming();
 470             listServer.processIncoming();
 471 
 472             // Finally some approvals
 473             pr.addReview(Review.Verdict.APPROVED, &quot;Nice&quot;);
 474             reviewPr.addReview(Review.Verdict.APPROVED, &quot;Looks fine&quot;);
 475             TestBotRunner.runPeriodicItems(mlBot);
 476             listServer.processIncoming();
 477             listServer.processIncoming();
 478 
 479             // Sanity check the archive
 480             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 481             assertEquals(8, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 482 
 483             // Check the mailing list
 484             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 485             var mailmanList = mailmanServer.getList(listAddress.address());
 486             var conversations = mailmanList.conversations(Duration.ofDays(1));
 487             assertEquals(1, conversations.size());
 488             var mail = conversations.get(0).first();
 489             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 490             assertEquals(9, conversations.get(0).allMessages().size());
 491 
 492             // There should be four separate threads
 493             var thread1 = conversations.get(0).replies(mail).get(0);
 494             assertEquals(2, thread1.body().split(&quot;^On.*wrote:&quot;).length);
 495             assertEquals(2, thread1.body().split(&quot;&gt; This is now ready&quot;).length, thread1.body());
 496             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread1.subject());
 497             assertTrue(thread1.body().contains(&quot;Review comment\n\n&quot;), thread1.body());
 498             assertFalse(thread1.body().contains(&quot;Another review comment&quot;), thread1.body());
 499             var thread1reply1 = conversations.get(0).replies(thread1).get(0);
 500             assertTrue(thread1reply1.body().contains(&quot;I agree&quot;));
 501             assertEquals(noreplyAddress(archive), thread1reply1.author().address());
 502             assertEquals(archive.host().getCurrentUserDetails().fullName(), thread1reply1.author().fullName().orElseThrow());
 503             var thread1reply2 = conversations.get(0).replies(thread1reply1).get(0);
 504             assertTrue(thread1reply2.body().contains(&quot;Great&quot;));
 505             assertEquals(&quot;integrationreviewer1@openjdk.java.net&quot;, thread1reply2.author().address());
 506             assertEquals(&quot;Generated Reviewer 1&quot;, thread1reply2.author().fullName().orElseThrow());
 507 
 508             var thread2 = conversations.get(0).replies(mail).get(1);
 509             assertEquals(2, thread2.body().split(&quot;^On.*wrote:&quot;).length);
 510             assertEquals(2, thread2.body().split(&quot;&gt; This is now ready&quot;).length, thread2.body());
 511             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread2.subject());
 512             assertFalse(thread2.body().contains(&quot;Review comment\n\n&quot;), thread2.body());
 513             assertTrue(thread2.body().contains(&quot;Another review comment&quot;), thread2.body());
 514             var thread2reply1 = conversations.get(0).replies(thread2).get(0);
 515             assertTrue(thread2reply1.body().contains(&quot;Sounds good&quot;));
 516             var thread2reply2 = conversations.get(0).replies(thread2reply1).get(0);
 517             assertTrue(thread2reply2.body().contains(&quot;Thanks&quot;));
 518 
 519             var thread3 = conversations.get(0).replies(mail).get(2);
 520             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread3.subject());
 521             var thread4 = conversations.get(0).replies(mail).get(3);
 522             assertEquals(&quot;Re: [Approved] RFR: This is a pull request&quot;, thread4.subject());
 523         }
 524     }
 525 
 526     @Test
 527     void reviewContext(TestInfo testInfo) throws IOException {
 528         try (var credentials = new HostCredentials(testInfo);
 529              var tempFolder = new TemporaryDirectory();
 530              var archiveFolder = new TemporaryDirectory();
 531              var listServer = new TestMailmanServer()) {
 532             var author = credentials.getHostedRepository();
 533             var archive = credentials.getHostedRepository();
 534             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 535             var censusBuilder = credentials.getCensusBuilder()
 536                                            .addAuthor(author.host().getCurrentUserDetails().id());
 537             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 538             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 539                                                  listAddress, Set.of(), Set.of(),
 540                                                  listServer.getArchive(),
 541                                                  listServer.getSMTP(),
 542                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 543                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 544                                                  Set.of(), Map.of(),
<a name="6" id="anc6"></a><span class="line-modified"> 545                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>

 546 
 547             // Populate the projects repository
 548             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 549             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 550             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 551             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 552             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 553 
 554             // Make a change with a corresponding PR
 555             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
 556             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 557             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 558             pr.setBody(&quot;This is now ready&quot;);
 559             TestBotRunner.runPeriodicItems(mlBot);
 560             listServer.processIncoming();
 561 
 562             // Make a file specific comment
 563             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 564 
 565             TestBotRunner.runPeriodicItems(mlBot);
 566             listServer.processIncoming();
 567 
 568             // The archive should only contain context around line 2
 569             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 570             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
 571             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
 572             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
 573         }
 574     }
 575 
 576     @Test
 577     void multipleReviewContexts(TestInfo testInfo) throws IOException {
 578         try (var credentials = new HostCredentials(testInfo);
 579              var tempFolder = new TemporaryDirectory();
 580              var archiveFolder = new TemporaryDirectory();
 581              var listServer = new TestMailmanServer()) {
 582             var author = credentials.getHostedRepository();
 583             var archive = credentials.getHostedRepository();
 584             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 585             var censusBuilder = credentials.getCensusBuilder()
 586                                            .addAuthor(author.host().getCurrentUserDetails().id());
 587             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 588             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 589                                                  listAddress, Set.of(), Set.of(),
 590                                                  listServer.getArchive(),
 591                                                  listServer.getSMTP(),
 592                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 593                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 594                                                  Set.of(), Map.of(),
<a name="7" id="anc7"></a><span class="line-modified"> 595                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>

 596 
 597             // Populate the projects repository
 598             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 599             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 600             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 601             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 602             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 603             var initialHash = CheckableRepository.appendAndCommit(localRepo,
 604                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
 605                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
 606                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
 607                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
 608                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
 609                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
 610             localRepo.push(initialHash, author.getUrl(), &quot;master&quot;);
 611 
 612             // Make a change with a corresponding PR
 613             var current = Files.readString(localRepo.root().resolve(reviewFile), StandardCharsets.UTF_8);
 614             var updated = current.replaceAll(&quot;Line 2&quot;, &quot;Line 2 edit\nLine 2.5&quot;);
 615             updated = updated.replaceAll(&quot;Line 13&quot;, &quot;Line 12.5\nLine 13 edit&quot;);
 616             Files.writeString(localRepo.root().resolve(reviewFile), updated, StandardCharsets.UTF_8);
 617             var editHash = CheckableRepository.appendAndCommit(localRepo);
 618             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 619             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 620             pr.setBody(&quot;This is now ready&quot;);
 621             TestBotRunner.runPeriodicItems(mlBot);
 622             listServer.processIncoming();
 623 
 624             // Make file specific comments
 625             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 7, &quot;Review comment&quot;);
 626             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 24, &quot;Another review comment&quot;);
 627 
 628             TestBotRunner.runPeriodicItems(mlBot);
 629             listServer.processIncoming();
 630 
 631             // The archive should only contain context around line 2 and 20
 632             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 633             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 7&quot;));
 634             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 6: Line 1$&quot;));
 635             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 7: Line 2 edit$&quot;));
 636             assertFalse(archiveContains(archiveFolder.path(), &quot;Line 3&quot;));
 637 
 638             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 24&quot;));
 639             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 23: Line 12.5$&quot;));
 640             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 24: Line 13 edit$&quot;));
 641             assertFalse(archiveContains(archiveFolder.path(), &quot;^Line 15&quot;));
 642         }
 643     }
 644 
 645     @Test
 646     void filterComments(TestInfo testInfo) throws IOException {
 647         try (var credentials = new HostCredentials(testInfo);
 648              var tempFolder = new TemporaryDirectory();
 649              var archiveFolder = new TemporaryDirectory();
 650              var listServer = new TestMailmanServer()) {
 651             var author = credentials.getHostedRepository();
 652             var archive = credentials.getHostedRepository();
 653             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 654             var censusBuilder = credentials.getCensusBuilder()
 655                                            .addAuthor(author.host().getCurrentUserDetails().id());
 656             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 657             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 658                                                  listAddress, Set.of(), Set.of(),
 659                                                  listServer.getArchive(), listServer.getSMTP(),
 660                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 661                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 662                                                  Set.of(), Map.of(),
<a name="8" id="anc8"></a><span class="line-modified"> 663                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>

 664 
 665             // Populate the projects repository
 666             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 667             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 668             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 669             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 670             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 671 
 672             // Make a change with a corresponding PR
 673             var editHash = CheckableRepository.appendAndCommit(localRepo);
 674             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 675             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 676             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
 677                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
 678 
 679             // Make a bunch of comments
 680             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
 681             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment &lt;!-- this is a comment --&gt;\n&quot;);
 682             pr.addComment(&quot;/integrate stuff&quot;);
 683             TestBotRunner.runPeriodicItems(mlBot);
 684 
 685             // Run an archive pass
 686             TestBotRunner.runPeriodicItems(mlBot);
 687 
 688             // The archive should not contain the comment
 689             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 690             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 691             assertFalse(archiveContains(archiveFolder.path(), &quot;this is a comment&quot;));
 692             assertFalse(archiveContains(archiveFolder.path(), &quot;Status stuff&quot;));
 693             assertTrue(archiveContains(archiveFolder.path(), &quot;And this is not&quot;));
 694             assertFalse(archiveContains(archiveFolder.path(), &quot;&lt;!--&quot;));
 695             assertFalse(archiveContains(archiveFolder.path(), &quot;--&gt;&quot;));
 696             assertTrue(archiveContains(archiveFolder.path(), &quot;Plain comment&quot;));
 697             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 698             assertFalse(archiveContains(archiveFolder.path(), &quot;/integrate&quot;));
 699         }
 700     }
 701 
 702     @Test
 703     void incrementalChanges(TestInfo testInfo) throws IOException {
 704         try (var credentials = new HostCredentials(testInfo);
 705              var tempFolder = new TemporaryDirectory();
 706              var archiveFolder = new TemporaryDirectory();
 707              var listServer = new TestMailmanServer()) {
 708             var author = credentials.getHostedRepository();
 709             var archive = credentials.getHostedRepository();
 710             var commenter = credentials.getHostedRepository();
 711             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 712             var censusBuilder = credentials.getCensusBuilder()
 713                                            .addAuthor(author.host().getCurrentUserDetails().id());
 714             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 715             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 716                                                  listAddress, Set.of(), Set.of(),
 717                                                  listServer.getArchive(), listServer.getSMTP(),
 718                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 719                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 720                                                  Set.of(), Map.of(),
<a name="9" id="anc9"></a><span class="line-modified"> 721                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>

 722 
 723             // Populate the projects repository
 724             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 725             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 726             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 727             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 728             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 729 
 730             // Make a change with a corresponding PR
 731             var editHash = CheckableRepository.appendAndCommit(localRepo);
 732             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 733             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 734             pr.setBody(&quot;This is now ready&quot;);
 735 
 736             // Run an archive pass
 737             TestBotRunner.runPeriodicItems(mlBot);
 738             listServer.processIncoming();
 739 
 740             var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
 741             localRepo.push(nextHash, author.getUrl(), &quot;edit&quot;);
 742 
 743             // Make sure that the push registered
 744             var lastHeadHash = pr.getHeadHash();
 745             var refreshCount = 0;
 746             do {
 747                 pr = author.getPullRequest(pr.getId());
 748                 if (refreshCount++ &gt; 100) {
 749                     fail(&quot;The PR did not update after the new push&quot;);
 750                 }
 751             } while (pr.getHeadHash().equals(lastHeadHash));
 752 
 753             // Run another archive pass
 754             TestBotRunner.runPeriodicItems(mlBot);
 755             TestBotRunner.runPeriodicItems(mlBot);
 756             TestBotRunner.runPeriodicItems(mlBot);
 757             listServer.processIncoming();
 758 
 759             // The archive should reference the updated push
 760             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 761             assertTrue(archiveContains(archiveFolder.path(), &quot;additional changes&quot;));
 762             assertTrue(archiveContains(archiveFolder.path(), &quot;full.*/&quot; + pr.getId() + &quot;/webrev.01&quot;));
 763             assertTrue(archiveContains(archiveFolder.path(), &quot;inc.*/&quot; + pr.getId() + &quot;/webrev.00-01&quot;));
 764             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
 765             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
 766             assertTrue(archiveContains(archiveFolder.path(), &quot;Fixing&quot;));
 767 
 768             // The webrev comment should be updated
 769             var comments = pr.getComments();
 770             var webrevComments = comments.stream()
 771                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 772                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 773                                          .filter(comment -&gt; comment.body().contains(nextHash.hex()))
 774                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 775                                          .collect(Collectors.toList());
 776             assertEquals(1, webrevComments.size());
 777 
 778             // Check that sender address is set properly
 779             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 780             var mailmanList = mailmanServer.getList(listAddress.address());
 781             var conversations = mailmanList.conversations(Duration.ofDays(1));
 782             assertEquals(1, conversations.size());
 783             for (var newMail : conversations.get(0).allMessages()) {
 784                 assertEquals(noreplyAddress(archive), newMail.author().address());
 785                 assertEquals(from, newMail.sender());
 786             }
 787 
 788             // Add a comment
 789             var commenterPr = commenter.getPullRequest(pr.getId());
 790             commenterPr.addReviewComment(masterHash, nextHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 791             TestBotRunner.runPeriodicItems(mlBot);
 792             listServer.processIncoming();
 793 
 794             // Ensure that additional updates are only reported once
 795             for (int i = 0; i &lt; 3; ++i) {
 796                 var anotherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fixing&quot;);
 797                 localRepo.push(anotherHash, author.getUrl(), &quot;edit&quot;);
 798 
 799                 // Make sure that the push registered
 800                 lastHeadHash = pr.getHeadHash();
 801                 refreshCount = 0;
 802                 do {
 803                     pr = author.getPullRequest(pr.getId());
 804                     if (refreshCount++ &gt; 100) {
 805                         fail(&quot;The PR did not update after the new push&quot;);
 806                     }
 807                 } while (pr.getHeadHash().equals(lastHeadHash));
 808 
 809                 TestBotRunner.runPeriodicItems(mlBot);
 810                 TestBotRunner.runPeriodicItems(mlBot);
 811                 listServer.processIncoming();
 812             }
 813             var updatedConversations = mailmanList.conversations(Duration.ofDays(1));
 814             assertEquals(1, updatedConversations.size());
 815             var conversation = updatedConversations.get(0);
 816             assertEquals(6, conversation.allMessages().size());
 817             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(1).subject());
 818             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(2).subject(), conversation.allMessages().get(2).toString());
 819             assertEquals(&quot;Re: [Rev 04] RFR: This is a pull request&quot;, conversation.allMessages().get(5).subject());
 820         }
 821     }
 822 
 823     @Test
 824     void rebased(TestInfo testInfo) throws IOException {
 825         try (var credentials = new HostCredentials(testInfo);
 826              var tempFolder = new TemporaryDirectory();
 827              var archiveFolder = new TemporaryDirectory();
 828              var listServer = new TestMailmanServer()) {
 829             var author = credentials.getHostedRepository();
 830             var archive = credentials.getHostedRepository();
 831             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 832             var censusBuilder = credentials.getCensusBuilder()
 833                                            .addAuthor(author.host().getCurrentUserDetails().id());
 834             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 835             var mlBot = new MailingListBridgeBot(sender, author, archive, censusBuilder.build(), &quot;master&quot;,
 836                                                  listAddress, Set.of(), Set.of(),
 837                                                  listServer.getArchive(), listServer.getSMTP(),
 838                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 839                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 840                                                  Set.of(), Map.of(),
<a name="10" id="anc10"></a><span class="line-modified"> 841                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>

 842 
 843             // Populate the projects repository
 844             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 845             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.getRepositoryType(), reviewFile);
 846             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 847             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 848             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 849 
 850             // Make a change with a corresponding PR
 851             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
 852             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 853             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 854             pr.setBody(&quot;This is now ready&quot;);
 855 
 856             // Run an archive pass
 857             TestBotRunner.runPeriodicItems(mlBot);
 858             listServer.processIncoming();
 859 
 860             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.getUrl(), &quot;master&quot;);
 861             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
 862             newLocalRepo.push(newEditHash, author.getUrl(), &quot;edit&quot;, true);
 863 
 864             // Make sure that the push registered
 865             var lastHeadHash = pr.getHeadHash();
 866             var refreshCount = 0;
 867             do {
 868                 pr = author.getPullRequest(pr.getId());
 869                 if (refreshCount++ &gt; 100) {
 870                     fail(&quot;The PR did not update after the new push&quot;);
 871                 }
 872             } while (pr.getHeadHash().equals(lastHeadHash));
 873 
 874             // Run another archive pass
 875             TestBotRunner.runPeriodicItems(mlBot);
 876             listServer.processIncoming();
 877 
 878             // The archive should reference the rebased push
 879             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 880             assertTrue(archiveContains(archiveFolder.path(), &quot;complete new set of changes&quot;));
 881             assertTrue(archiveContains(archiveFolder.path(), pr.getId() + &quot;/webrev.01&quot;));
 882             assertFalse(archiveContains(archiveFolder.path(), &quot;Incremental&quot;));
 883             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
 884             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
 885             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
 886             assertTrue(archiveContains(archiveFolder.path(), &quot;Replaced msg&quot;));
 887 
 888             // The webrev comment should be updated
 889             var comments = pr.getComments();
 890             var webrevComments = comments.stream()
 891                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 892                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 893                                          .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
 894                                          .collect(Collectors.toList());
 895             assertEquals(1, webrevComments.size());
 896 
 897             // Check that sender address is set properly
 898             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 899             var mailmanList = mailmanServer.getList(listAddress.address());
 900             var conversations = mailmanList.conversations(Duration.ofDays(1));
 901             assertEquals(1, conversations.size());
 902             for (var newMail : conversations.get(0).allMessages()) {
 903                 assertEquals(noreplyAddress(archive), newMail.author().address());
 904                 assertEquals(sender, newMail.sender());
 905                 assertFalse(newMail.hasHeader(&quot;PR-Head-Hash&quot;));
 906             }
 907             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversations.get(0).allMessages().get(1).subject());
 908         }
 909     }
 910 
 911     @Test
 912     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
 913         try (var credentials = new HostCredentials(testInfo);
 914              var tempFolder = new TemporaryDirectory();
 915              var archiveFolder = new TemporaryDirectory();
 916              var webrevFolder = new TemporaryDirectory();
 917              var listServer = new TestMailmanServer()) {
 918             var author = credentials.getHostedRepository();
 919             var archive = credentials.getHostedRepository();
 920             var ignored = credentials.getHostedRepository();
 921             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 922             var censusBuilder = credentials.getCensusBuilder()
 923                                            .addAuthor(author.host().getCurrentUserDetails().id());
 924             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 925             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 926                                                  listAddress,
 927                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 928                                                  Set.of(),
 929                                                  listServer.getArchive(), listServer.getSMTP(),
 930                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 931                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 932                                                  Set.of(), Map.of(),
<a name="11" id="anc11"></a><span class="line-modified"> 933                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>

 934 
 935             // Populate the projects repository
 936             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
 937             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 938             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 939             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 940 
 941             // Make a change with a corresponding PR
 942             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 943                                                                &quot;Change msg\n\nWith several lines&quot;);
 944             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 945             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 946 
 947             // Flag it as ready for review
 948             pr.setBody(&quot;This should now be ready&quot;);
 949 
 950             // Run an archive pass
 951             TestBotRunner.runPeriodicItems(mlBot);
 952 
 953             // The archive should now contain an entry
 954             var archiveRepo = Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 955             assertTrue(archiveContains(archiveFolder.path(), editHash.abbreviate()));
 956 
 957             // And there should be a webrev comment
 958             var comments = pr.getComments();
 959             var webrevComments = comments.stream()
 960                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 961                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 962                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 963                                          .collect(Collectors.toList());
 964             assertEquals(1, webrevComments.size());
 965             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
 966 
 967             // Pretend the archive didn&#39;t work out
 968             archiveRepo.push(masterHash, archive.getUrl(), &quot;master&quot;, true);
 969 
 970             // Run another archive pass
 971             TestBotRunner.runPeriodicItems(mlBot);
 972 
 973             // The webrev comment should not contain duplicate entries
 974             comments = pr.getComments();
 975             webrevComments = comments.stream()
 976                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 977                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 978                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 979                                          .collect(Collectors.toList());
 980             assertEquals(1, webrevComments.size());
 981             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
 982         }
 983     }
 984 
 985     @Test
 986     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
 987         try (var credentials = new HostCredentials(testInfo);
 988              var tempFolder = new TemporaryDirectory();
 989              var archiveFolder = new TemporaryDirectory();
 990              var listServer = new TestMailmanServer()) {
 991             var author = credentials.getHostedRepository();
 992             var archive = credentials.getHostedRepository();
 993             var reviewer = credentials.getHostedRepository();
 994             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 995             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 996             var censusBuilder = credentials.getCensusBuilder()
 997                                            .addReviewer(reviewer.host().getCurrentUserDetails().id())
 998                                            .addAuthor(author.host().getCurrentUserDetails().id());
 999             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
1000                                                  listAddress, Set.of(), Set.of(),
1001                                                  listServer.getArchive(), listServer.getSMTP(),
1002                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
1003                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
1004                                                  Set.of(), Map.of(),
<a name="12" id="anc12"></a><span class="line-modified">1005                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>

1006 
1007             // Populate the projects repository
1008             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1009             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
1010             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1011             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
1012             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
1013 
1014             // Make a change with a corresponding PR
1015             var editHash = CheckableRepository.appendAndCommit(localRepo);
1016             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
1017             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1018             pr.setBody(&quot;This is now ready&quot;);
1019 
1020             // Run an archive pass
1021             TestBotRunner.runPeriodicItems(mlBot);
1022 
1023             // First unapprove it
1024             var reviewedPr = reviewer.getPullRequest(pr.getId());
1025             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
1026             TestBotRunner.runPeriodicItems(mlBot);
1027             TestBotRunner.runPeriodicItems(mlBot);
1028             TestBotRunner.runPeriodicItems(mlBot);
1029 
1030             // The archive should contain a note
1031             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1032             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Disapproved by &quot;));
1033             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot; by integrationreviewer1&quot;));
1034             if (author.host().supportsReviewBody()) {
1035                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
1036             }
1037 
1038             // Then approve it
1039             reviewedPr.addReview(Review.Verdict.APPROVED, &quot;Reason 2&quot;);
1040             TestBotRunner.runPeriodicItems(mlBot);
1041             TestBotRunner.runPeriodicItems(mlBot);
1042             TestBotRunner.runPeriodicItems(mlBot);
1043 
1044             // The archive should contain another note
1045             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1046             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Approved by &quot;));
1047             if (author.host().supportsReviewBody()) {
1048                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 2&quot;));
1049             }
1050             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Re: \\[Approved\\] RFR:&quot;));
1051 
1052             // Yet another change
1053             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 3&quot;);
1054             TestBotRunner.runPeriodicItems(mlBot);
1055             TestBotRunner.runPeriodicItems(mlBot);
1056             TestBotRunner.runPeriodicItems(mlBot);
1057 
1058             // The archive should contain another note
1059             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1060             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Disapproved by &quot;));
1061             if (author.host().supportsReviewBody()) {
1062                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
1063             }
1064         }
1065     }
1066 
1067     @Test
1068     void ignoreComments(TestInfo testInfo) throws IOException {
1069         try (var credentials = new HostCredentials(testInfo);
1070              var tempFolder = new TemporaryDirectory();
1071              var archiveFolder = new TemporaryDirectory();
1072              var listServer = new TestMailmanServer()) {
1073             var author = credentials.getHostedRepository();
1074             var ignored = credentials.getHostedRepository();
1075             var archive = credentials.getHostedRepository();
1076             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1077             var censusBuilder = credentials.getCensusBuilder()
1078                                            .addAuthor(author.host().getCurrentUserDetails().id());
1079             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1080             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
1081                                                  listAddress,
1082                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
1083                                                  Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)),
1084                                                  listServer.getArchive(), listServer.getSMTP(),
1085                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
1086                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
1087                                                  Set.of(), Map.of(),
<a name="13" id="anc13"></a><span class="line-modified">1088                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>

1089 
1090             // Populate the projects repository
1091             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1092             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
1093             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1094             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
1095             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
1096 
1097             // Make a change with a corresponding PR
1098             var editHash = CheckableRepository.appendAndCommit(localRepo);
1099             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
1100             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1101             pr.setBody(&quot;This is now ready&quot;);
1102 
1103             // Make a bunch of comments
1104             pr.addComment(&quot;Plain comment&quot;);
1105             pr.addComment(&quot;ignore this comment&quot;);
1106             pr.addComment(&quot;I think it is time to\nignore this comment!&quot;);
1107             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review ignore this comment&quot;);
1108 
1109             var ignoredPR = ignored.getPullRequest(pr.getId());
1110             ignoredPR.addComment(&quot;Don&#39;t mind me&quot;);
1111 
1112             TestBotRunner.runPeriodicItems(mlBot);
1113             TestBotRunner.runPeriodicItems(mlBot);
1114 
1115             // The archive should not contain the ignored comments
1116             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1117             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
1118             assertFalse(archiveContains(archiveFolder.path(), &quot;ignore this comment&quot;));
1119             assertFalse(archiveContains(archiveFolder.path(), &quot;it is time to&quot;));
1120             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
1121             assertFalse(archiveContains(archiveFolder.path(), &quot;Review ignore&quot;));
1122         }
1123     }
1124 }
<a name="14" id="anc14"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="14" type="hidden" />
</body>
</html>