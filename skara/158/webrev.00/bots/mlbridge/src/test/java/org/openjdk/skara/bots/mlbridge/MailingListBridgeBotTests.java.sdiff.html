<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="MailingListArchiveReaderBotTests.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  94     void simpleArchive(TestInfo testInfo) throws IOException {
  95         try (var credentials = new HostCredentials(testInfo);
  96              var tempFolder = new TemporaryDirectory();
  97              var archiveFolder = new TemporaryDirectory();
  98              var webrevFolder = new TemporaryDirectory();
  99              var listServer = new TestMailmanServer()) {
 100             var author = credentials.getHostedRepository();
 101             var archive = credentials.getHostedRepository();
 102             var ignored = credentials.getHostedRepository();
 103             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 104             var censusBuilder = credentials.getCensusBuilder()
 105                                            .addAuthor(author.host().getCurrentUserDetails().id());
 106             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 107             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,
 108                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 109                                                  Set.of(),
 110                                                  listServer.getArchive(), listServer.getSMTP(),
 111                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 112                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 113                                                  Set.of(&quot;rfr&quot;), Map.of(ignored.host().getCurrentUserDetails().userName(),
<span class="line-modified"> 114                                                                        Pattern.compile(&quot;ready&quot;)));</span>

 115 
 116             // Populate the projects repository
 117             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
 118             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 119             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 120             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 121 
 122             // Make a change with a corresponding PR
 123             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 124                                                                &quot;Change msg\n\nWith several lines&quot;);
 125             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 126             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 127             pr.setBody(&quot;This should not be ready&quot;);
 128 
 129             // Run an archive pass
 130             TestBotRunner.runPeriodicItems(mlBot);
 131 
 132             // A PR that isn&#39;t ready for review should not be archived
 133             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 134             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
</pre>
<hr />
<pre>
 168             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
 169             assertTrue(archiveContains(archiveFolder.path(), &quot;Changes:&quot;));
 170             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
 171             assertTrue(archiveContains(archiveFolder.path(), &quot;http://www.test.test/&quot;));
 172             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));
 173             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch:&quot;));
 174             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - &quot; + editHash.abbreviate() + &quot;: Change msg&quot;));
 175             assertFalse(archiveContains(archiveFolder.path(), &quot;With several lines&quot;));
 176 
 177             // The mailing list as well
 178             listServer.processIncoming();
 179             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 180             var mailmanList = mailmanServer.getList(listAddress.address());
 181             var conversations = mailmanList.conversations(Duration.ofDays(1));
 182             assertEquals(1, conversations.size());
 183             var mail = conversations.get(0).first();
 184             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 185             assertEquals(pr.getAuthor().fullName(), mail.author().fullName().orElseThrow());
 186             assertEquals(noreplyAddress(archive), mail.author().address());
 187             assertEquals(from, mail.sender());


 188 
 189             // And there should be a webrev
 190             Repository.materialize(webrevFolder.path(), archive.getUrl(), &quot;webrev&quot;);
 191             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
 192             var comments = pr.getComments();
 193             var webrevComments = comments.stream()
 194                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 195                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 196                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 197                                          .collect(Collectors.toList());
 198             assertEquals(1, webrevComments.size());
 199 
 200             // Add a comment
 201             pr.addComment(&quot;This is a comment :smile:&quot;);
 202 
 203             // Add a comment from an ignored user as well
 204             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);
 205 
 206             // Run another archive pass
 207             TestBotRunner.runPeriodicItems(mlBot);
</pre>
<hr />
<pre>
 243 
 244     @Test
 245     void reviewComment(TestInfo testInfo) throws IOException {
 246         try (var credentials = new HostCredentials(testInfo);
 247              var tempFolder = new TemporaryDirectory();
 248              var archiveFolder = new TemporaryDirectory();
 249              var listServer = new TestMailmanServer()) {
 250             var author = credentials.getHostedRepository();
 251             var archive = credentials.getHostedRepository();
 252             var ignored = credentials.getHostedRepository();
 253             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 254             var censusBuilder = credentials.getCensusBuilder()
 255                                            .addAuthor(author.host().getCurrentUserDetails().id());
 256             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 257             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,
 258                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 259                                                  Set.of(),
 260                                                  listServer.getArchive(), listServer.getSMTP(),
 261                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 262                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 263                                                  Set.of(), Map.of());</span>
 264 
 265             // Populate the projects repository
 266             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 267             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 268             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 269             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 270             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 271 
 272             // Make a change with a corresponding PR
 273             var editHash = CheckableRepository.appendAndCommit(localRepo);
 274             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 275             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 276             pr.setBody(&quot;This is now ready&quot;);
 277             TestBotRunner.runPeriodicItems(mlBot);
 278             listServer.processIncoming();
 279 
 280             // And make a file specific comment
 281             var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
 282             var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 283 
</pre>
<hr />
<pre>
 329     }
 330 
 331     @Test
 332     void combineComments(TestInfo testInfo) throws IOException {
 333         try (var credentials = new HostCredentials(testInfo);
 334              var tempFolder = new TemporaryDirectory();
 335              var archiveFolder = new TemporaryDirectory();
 336              var listServer = new TestMailmanServer()) {
 337             var author = credentials.getHostedRepository();
 338             var archive = credentials.getHostedRepository();
 339             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 340             var censusBuilder = credentials.getCensusBuilder()
 341                                            .addAuthor(author.host().getCurrentUserDetails().id());
 342             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 343             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 344                                                  listAddress, Set.of(), Set.of(),
 345                                                  listServer.getArchive(),
 346                                                  listServer.getSMTP(),
 347                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 348                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 349                                                  Set.of(), Map.of());</span>
 350 
 351             // Populate the projects repository
 352             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 353             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 354             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 355             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 356             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 357 
 358             // Make a change with a corresponding PR
 359             var editHash = CheckableRepository.appendAndCommit(localRepo);
 360             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 361             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 362             pr.setBody(&quot;This is now ready&quot;);
 363             pr.addComment(&quot;Avoid combining&quot;);
 364 
 365             TestBotRunner.runPeriodicItems(mlBot);
 366             listServer.processIncoming();
 367             listServer.processIncoming();
 368 
 369             // Make two file specific comments
</pre>
<hr />
<pre>
 410     @Test
 411     void commentThreading(TestInfo testInfo) throws IOException {
 412         try (var credentials = new HostCredentials(testInfo);
 413              var tempFolder = new TemporaryDirectory();
 414              var archiveFolder = new TemporaryDirectory();
 415              var listServer = new TestMailmanServer()) {
 416             var author = credentials.getHostedRepository();
 417             var reviewer = credentials.getHostedRepository();
 418             var archive = credentials.getHostedRepository();
 419             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 420             var censusBuilder = credentials.getCensusBuilder()
 421                                            .addReviewer(reviewer.host().getCurrentUserDetails().id())
 422                                            .addAuthor(author.host().getCurrentUserDetails().id());
 423             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 424             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 425                                                  listAddress, Set.of(), Set.of(),
 426                                                  listServer.getArchive(),
 427                                                  listServer.getSMTP(),
 428                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 429                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 430                                                  Set.of(), Map.of());</span>
 431 
 432             // Populate the projects repository
 433             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 434             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 435             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 436             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 437             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 438 
 439             // Make a change with a corresponding PR
 440             var editHash = CheckableRepository.appendAndCommit(localRepo);
 441             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 442             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 443             pr.setBody(&quot;This is now ready&quot;);
 444             TestBotRunner.runPeriodicItems(mlBot);
 445             listServer.processIncoming();
 446 
 447             // Make a file specific comment
 448             var reviewPr = reviewer.getPullRequest(pr.getId());
 449             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 450             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
</pre>
<hr />
<pre>
 518     }
 519 
 520     @Test
 521     void reviewContext(TestInfo testInfo) throws IOException {
 522         try (var credentials = new HostCredentials(testInfo);
 523              var tempFolder = new TemporaryDirectory();
 524              var archiveFolder = new TemporaryDirectory();
 525              var listServer = new TestMailmanServer()) {
 526             var author = credentials.getHostedRepository();
 527             var archive = credentials.getHostedRepository();
 528             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 529             var censusBuilder = credentials.getCensusBuilder()
 530                                            .addAuthor(author.host().getCurrentUserDetails().id());
 531             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 532             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 533                                                  listAddress, Set.of(), Set.of(),
 534                                                  listServer.getArchive(),
 535                                                  listServer.getSMTP(),
 536                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 537                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 538                                                  Set.of(), Map.of());</span>
 539 
 540             // Populate the projects repository
 541             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 542             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 543             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 544             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 545             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 546 
 547             // Make a change with a corresponding PR
 548             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
 549             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 550             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 551             pr.setBody(&quot;This is now ready&quot;);
 552             TestBotRunner.runPeriodicItems(mlBot);
 553             listServer.processIncoming();
 554 
 555             // Make a file specific comment
 556             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 557 
 558             TestBotRunner.runPeriodicItems(mlBot);
</pre>
<hr />
<pre>
 567     }
 568 
 569     @Test
 570     void multipleReviewContexts(TestInfo testInfo) throws IOException {
 571         try (var credentials = new HostCredentials(testInfo);
 572              var tempFolder = new TemporaryDirectory();
 573              var archiveFolder = new TemporaryDirectory();
 574              var listServer = new TestMailmanServer()) {
 575             var author = credentials.getHostedRepository();
 576             var archive = credentials.getHostedRepository();
 577             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 578             var censusBuilder = credentials.getCensusBuilder()
 579                                            .addAuthor(author.host().getCurrentUserDetails().id());
 580             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 581             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 582                                                  listAddress, Set.of(), Set.of(),
 583                                                  listServer.getArchive(),
 584                                                  listServer.getSMTP(),
 585                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 586                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 587                                                  Set.of(), Map.of());</span>
 588 
 589             // Populate the projects repository
 590             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 591             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 592             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 593             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 594             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 595             var initialHash = CheckableRepository.appendAndCommit(localRepo,
 596                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
 597                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
 598                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
 599                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
 600                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
 601                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
 602             localRepo.push(initialHash, author.getUrl(), &quot;master&quot;);
 603 
 604             // Make a change with a corresponding PR
 605             var current = Files.readString(localRepo.root().resolve(reviewFile), StandardCharsets.UTF_8);
 606             var updated = current.replaceAll(&quot;Line 2&quot;, &quot;Line 2 edit\nLine 2.5&quot;);
 607             updated = updated.replaceAll(&quot;Line 13&quot;, &quot;Line 12.5\nLine 13 edit&quot;);
</pre>
<hr />
<pre>
 634         }
 635     }
 636 
 637     @Test
 638     void filterComments(TestInfo testInfo) throws IOException {
 639         try (var credentials = new HostCredentials(testInfo);
 640              var tempFolder = new TemporaryDirectory();
 641              var archiveFolder = new TemporaryDirectory();
 642              var listServer = new TestMailmanServer()) {
 643             var author = credentials.getHostedRepository();
 644             var archive = credentials.getHostedRepository();
 645             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 646             var censusBuilder = credentials.getCensusBuilder()
 647                                            .addAuthor(author.host().getCurrentUserDetails().id());
 648             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 649             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 650                                                  listAddress, Set.of(), Set.of(),
 651                                                  listServer.getArchive(), listServer.getSMTP(),
 652                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 653                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 654                                                  Set.of(), Map.of());</span>
 655 
 656             // Populate the projects repository
 657             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 658             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 659             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 660             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 661             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 662 
 663             // Make a change with a corresponding PR
 664             var editHash = CheckableRepository.appendAndCommit(localRepo);
 665             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 666             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 667             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
 668                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
 669 
 670             // Make a bunch of comments
 671             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
 672             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment &lt;!-- this is a comment --&gt;\n&quot;);
 673             pr.addComment(&quot;/integrate stuff&quot;);
 674             TestBotRunner.runPeriodicItems(mlBot);
</pre>
<hr />
<pre>
 691     }
 692 
 693     @Test
 694     void incrementalChanges(TestInfo testInfo) throws IOException {
 695         try (var credentials = new HostCredentials(testInfo);
 696              var tempFolder = new TemporaryDirectory();
 697              var archiveFolder = new TemporaryDirectory();
 698              var listServer = new TestMailmanServer()) {
 699             var author = credentials.getHostedRepository();
 700             var archive = credentials.getHostedRepository();
 701             var commenter = credentials.getHostedRepository();
 702             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 703             var censusBuilder = credentials.getCensusBuilder()
 704                                            .addAuthor(author.host().getCurrentUserDetails().id());
 705             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 706             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 707                                                  listAddress, Set.of(), Set.of(),
 708                                                  listServer.getArchive(), listServer.getSMTP(),
 709                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 710                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 711                                                  Set.of(), Map.of());</span>
 712 
 713             // Populate the projects repository
 714             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 715             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 716             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 717             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 718             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 719 
 720             // Make a change with a corresponding PR
 721             var editHash = CheckableRepository.appendAndCommit(localRepo);
 722             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 723             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 724             pr.setBody(&quot;This is now ready&quot;);
 725 
 726             // Run an archive pass
 727             TestBotRunner.runPeriodicItems(mlBot);
 728             listServer.processIncoming();
 729 
 730             var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
 731             localRepo.push(nextHash, author.getUrl(), &quot;edit&quot;);
</pre>
<hr />
<pre>
 810         }
 811     }
 812 
 813     @Test
 814     void rebased(TestInfo testInfo) throws IOException {
 815         try (var credentials = new HostCredentials(testInfo);
 816              var tempFolder = new TemporaryDirectory();
 817              var archiveFolder = new TemporaryDirectory();
 818              var listServer = new TestMailmanServer()) {
 819             var author = credentials.getHostedRepository();
 820             var archive = credentials.getHostedRepository();
 821             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 822             var censusBuilder = credentials.getCensusBuilder()
 823                                            .addAuthor(author.host().getCurrentUserDetails().id());
 824             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 825             var mlBot = new MailingListBridgeBot(sender, author, archive, censusBuilder.build(), &quot;master&quot;,
 826                                                  listAddress, Set.of(), Set.of(),
 827                                                  listServer.getArchive(), listServer.getSMTP(),
 828                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 829                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 830                                                  Set.of(), Map.of());</span>
 831 
 832             // Populate the projects repository
 833             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 834             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.getRepositoryType(), reviewFile);
 835             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 836             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 837             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 838 
 839             // Make a change with a corresponding PR
 840             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
 841             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 842             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 843             pr.setBody(&quot;This is now ready&quot;);
 844 
 845             // Run an archive pass
 846             TestBotRunner.runPeriodicItems(mlBot);
 847             listServer.processIncoming();
 848 
 849             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.getUrl(), &quot;master&quot;);
 850             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
</pre>
<hr />
<pre>
 901     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
 902         try (var credentials = new HostCredentials(testInfo);
 903              var tempFolder = new TemporaryDirectory();
 904              var archiveFolder = new TemporaryDirectory();
 905              var webrevFolder = new TemporaryDirectory();
 906              var listServer = new TestMailmanServer()) {
 907             var author = credentials.getHostedRepository();
 908             var archive = credentials.getHostedRepository();
 909             var ignored = credentials.getHostedRepository();
 910             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 911             var censusBuilder = credentials.getCensusBuilder()
 912                                            .addAuthor(author.host().getCurrentUserDetails().id());
 913             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 914             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 915                                                  listAddress,
 916                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 917                                                  Set.of(),
 918                                                  listServer.getArchive(), listServer.getSMTP(),
 919                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 920                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 921                                                  Set.of(), Map.of());</span>
 922 
 923             // Populate the projects repository
 924             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
 925             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 926             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 927             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 928 
 929             // Make a change with a corresponding PR
 930             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 931                                                                &quot;Change msg\n\nWith several lines&quot;);
 932             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 933             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 934 
 935             // Flag it as ready for review
 936             pr.setBody(&quot;This should now be ready&quot;);
 937 
 938             // Run an archive pass
 939             TestBotRunner.runPeriodicItems(mlBot);
 940 
 941             // The archive should now contain an entry
</pre>
<hr />
<pre>
 972 
 973     @Test
 974     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
 975         try (var credentials = new HostCredentials(testInfo);
 976              var tempFolder = new TemporaryDirectory();
 977              var archiveFolder = new TemporaryDirectory();
 978              var listServer = new TestMailmanServer()) {
 979             var author = credentials.getHostedRepository();
 980             var archive = credentials.getHostedRepository();
 981             var reviewer = credentials.getHostedRepository();
 982             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 983             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 984             var censusBuilder = credentials.getCensusBuilder()
 985                                            .addReviewer(reviewer.host().getCurrentUserDetails().id())
 986                                            .addAuthor(author.host().getCurrentUserDetails().id());
 987             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 988                                                  listAddress, Set.of(), Set.of(),
 989                                                  listServer.getArchive(), listServer.getSMTP(),
 990                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 991                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 992                                                  Set.of(), Map.of());</span>
 993 
 994             // Populate the projects repository
 995             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 996             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 997             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 998             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 999             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
1000 
1001             // Make a change with a corresponding PR
1002             var editHash = CheckableRepository.appendAndCommit(localRepo);
1003             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
1004             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1005             pr.setBody(&quot;This is now ready&quot;);
1006 
1007             // Run an archive pass
1008             TestBotRunner.runPeriodicItems(mlBot);
1009 
1010             // First unapprove it
1011             var reviewedPr = reviewer.getPullRequest(pr.getId());
1012             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
</pre>
<hr />
<pre>
1054     @Test
1055     void ignoreComments(TestInfo testInfo) throws IOException {
1056         try (var credentials = new HostCredentials(testInfo);
1057              var tempFolder = new TemporaryDirectory();
1058              var archiveFolder = new TemporaryDirectory();
1059              var listServer = new TestMailmanServer()) {
1060             var author = credentials.getHostedRepository();
1061             var ignored = credentials.getHostedRepository();
1062             var archive = credentials.getHostedRepository();
1063             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1064             var censusBuilder = credentials.getCensusBuilder()
1065                                            .addAuthor(author.host().getCurrentUserDetails().id());
1066             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1067             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
1068                                                  listAddress,
1069                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
1070                                                  Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)),
1071                                                  listServer.getArchive(), listServer.getSMTP(),
1072                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
1073                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified">1074                                                  Set.of(), Map.of());</span>
1075 
1076             // Populate the projects repository
1077             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1078             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
1079             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1080             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
1081             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
1082 
1083             // Make a change with a corresponding PR
1084             var editHash = CheckableRepository.appendAndCommit(localRepo);
1085             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
1086             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1087             pr.setBody(&quot;This is now ready&quot;);
1088 
1089             // Make a bunch of comments
1090             pr.addComment(&quot;Plain comment&quot;);
1091             pr.addComment(&quot;ignore this comment&quot;);
1092             pr.addComment(&quot;I think it is time to\nignore this comment!&quot;);
1093             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review ignore this comment&quot;);
1094 
</pre>
</td>
<td>
<hr />
<pre>
  94     void simpleArchive(TestInfo testInfo) throws IOException {
  95         try (var credentials = new HostCredentials(testInfo);
  96              var tempFolder = new TemporaryDirectory();
  97              var archiveFolder = new TemporaryDirectory();
  98              var webrevFolder = new TemporaryDirectory();
  99              var listServer = new TestMailmanServer()) {
 100             var author = credentials.getHostedRepository();
 101             var archive = credentials.getHostedRepository();
 102             var ignored = credentials.getHostedRepository();
 103             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 104             var censusBuilder = credentials.getCensusBuilder()
 105                                            .addAuthor(author.host().getCurrentUserDetails().id());
 106             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 107             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,
 108                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 109                                                  Set.of(),
 110                                                  listServer.getArchive(), listServer.getSMTP(),
 111                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 112                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 113                                                  Set.of(&quot;rfr&quot;), Map.of(ignored.host().getCurrentUserDetails().userName(),
<span class="line-modified"> 114                                                                        Pattern.compile(&quot;ready&quot;)),</span>
<span class="line-added"> 115                                                  Map.of(&quot;Extra1&quot;, &quot;val1&quot;, &quot;Extra2&quot;, &quot;val2&quot;));</span>
 116 
 117             // Populate the projects repository
 118             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
 119             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 120             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 121             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 122 
 123             // Make a change with a corresponding PR
 124             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 125                                                                &quot;Change msg\n\nWith several lines&quot;);
 126             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 127             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 128             pr.setBody(&quot;This should not be ready&quot;);
 129 
 130             // Run an archive pass
 131             TestBotRunner.runPeriodicItems(mlBot);
 132 
 133             // A PR that isn&#39;t ready for review should not be archived
 134             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 135             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
</pre>
<hr />
<pre>
 169             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
 170             assertTrue(archiveContains(archiveFolder.path(), &quot;Changes:&quot;));
 171             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
 172             assertTrue(archiveContains(archiveFolder.path(), &quot;http://www.test.test/&quot;));
 173             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));
 174             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch:&quot;));
 175             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - &quot; + editHash.abbreviate() + &quot;: Change msg&quot;));
 176             assertFalse(archiveContains(archiveFolder.path(), &quot;With several lines&quot;));
 177 
 178             // The mailing list as well
 179             listServer.processIncoming();
 180             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 181             var mailmanList = mailmanServer.getList(listAddress.address());
 182             var conversations = mailmanList.conversations(Duration.ofDays(1));
 183             assertEquals(1, conversations.size());
 184             var mail = conversations.get(0).first();
 185             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 186             assertEquals(pr.getAuthor().fullName(), mail.author().fullName().orElseThrow());
 187             assertEquals(noreplyAddress(archive), mail.author().address());
 188             assertEquals(from, mail.sender());
<span class="line-added"> 189             assertEquals(&quot;val1&quot;, mail.headerValue(&quot;Extra1&quot;));</span>
<span class="line-added"> 190             assertEquals(&quot;val2&quot;, mail.headerValue(&quot;Extra2&quot;));</span>
 191 
 192             // And there should be a webrev
 193             Repository.materialize(webrevFolder.path(), archive.getUrl(), &quot;webrev&quot;);
 194             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
 195             var comments = pr.getComments();
 196             var webrevComments = comments.stream()
 197                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 198                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 199                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 200                                          .collect(Collectors.toList());
 201             assertEquals(1, webrevComments.size());
 202 
 203             // Add a comment
 204             pr.addComment(&quot;This is a comment :smile:&quot;);
 205 
 206             // Add a comment from an ignored user as well
 207             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);
 208 
 209             // Run another archive pass
 210             TestBotRunner.runPeriodicItems(mlBot);
</pre>
<hr />
<pre>
 246 
 247     @Test
 248     void reviewComment(TestInfo testInfo) throws IOException {
 249         try (var credentials = new HostCredentials(testInfo);
 250              var tempFolder = new TemporaryDirectory();
 251              var archiveFolder = new TemporaryDirectory();
 252              var listServer = new TestMailmanServer()) {
 253             var author = credentials.getHostedRepository();
 254             var archive = credentials.getHostedRepository();
 255             var ignored = credentials.getHostedRepository();
 256             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 257             var censusBuilder = credentials.getCensusBuilder()
 258                                            .addAuthor(author.host().getCurrentUserDetails().id());
 259             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 260             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,
 261                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 262                                                  Set.of(),
 263                                                  listServer.getArchive(), listServer.getSMTP(),
 264                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 265                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 266                                                  Set.of(), Map.of(), Map.of());</span>
 267 
 268             // Populate the projects repository
 269             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 270             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 271             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 272             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 273             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 274 
 275             // Make a change with a corresponding PR
 276             var editHash = CheckableRepository.appendAndCommit(localRepo);
 277             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 278             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 279             pr.setBody(&quot;This is now ready&quot;);
 280             TestBotRunner.runPeriodicItems(mlBot);
 281             listServer.processIncoming();
 282 
 283             // And make a file specific comment
 284             var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
 285             var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 286 
</pre>
<hr />
<pre>
 332     }
 333 
 334     @Test
 335     void combineComments(TestInfo testInfo) throws IOException {
 336         try (var credentials = new HostCredentials(testInfo);
 337              var tempFolder = new TemporaryDirectory();
 338              var archiveFolder = new TemporaryDirectory();
 339              var listServer = new TestMailmanServer()) {
 340             var author = credentials.getHostedRepository();
 341             var archive = credentials.getHostedRepository();
 342             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 343             var censusBuilder = credentials.getCensusBuilder()
 344                                            .addAuthor(author.host().getCurrentUserDetails().id());
 345             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 346             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 347                                                  listAddress, Set.of(), Set.of(),
 348                                                  listServer.getArchive(),
 349                                                  listServer.getSMTP(),
 350                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 351                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 352                                                  Set.of(), Map.of(), Map.of());</span>
 353 
 354             // Populate the projects repository
 355             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 356             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 357             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 358             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 359             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 360 
 361             // Make a change with a corresponding PR
 362             var editHash = CheckableRepository.appendAndCommit(localRepo);
 363             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 364             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 365             pr.setBody(&quot;This is now ready&quot;);
 366             pr.addComment(&quot;Avoid combining&quot;);
 367 
 368             TestBotRunner.runPeriodicItems(mlBot);
 369             listServer.processIncoming();
 370             listServer.processIncoming();
 371 
 372             // Make two file specific comments
</pre>
<hr />
<pre>
 413     @Test
 414     void commentThreading(TestInfo testInfo) throws IOException {
 415         try (var credentials = new HostCredentials(testInfo);
 416              var tempFolder = new TemporaryDirectory();
 417              var archiveFolder = new TemporaryDirectory();
 418              var listServer = new TestMailmanServer()) {
 419             var author = credentials.getHostedRepository();
 420             var reviewer = credentials.getHostedRepository();
 421             var archive = credentials.getHostedRepository();
 422             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 423             var censusBuilder = credentials.getCensusBuilder()
 424                                            .addReviewer(reviewer.host().getCurrentUserDetails().id())
 425                                            .addAuthor(author.host().getCurrentUserDetails().id());
 426             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 427             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 428                                                  listAddress, Set.of(), Set.of(),
 429                                                  listServer.getArchive(),
 430                                                  listServer.getSMTP(),
 431                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 432                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 433                                                  Set.of(), Map.of(), Map.of());</span>
 434 
 435             // Populate the projects repository
 436             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 437             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 438             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 439             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 440             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 441 
 442             // Make a change with a corresponding PR
 443             var editHash = CheckableRepository.appendAndCommit(localRepo);
 444             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 445             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 446             pr.setBody(&quot;This is now ready&quot;);
 447             TestBotRunner.runPeriodicItems(mlBot);
 448             listServer.processIncoming();
 449 
 450             // Make a file specific comment
 451             var reviewPr = reviewer.getPullRequest(pr.getId());
 452             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 453             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
</pre>
<hr />
<pre>
 521     }
 522 
 523     @Test
 524     void reviewContext(TestInfo testInfo) throws IOException {
 525         try (var credentials = new HostCredentials(testInfo);
 526              var tempFolder = new TemporaryDirectory();
 527              var archiveFolder = new TemporaryDirectory();
 528              var listServer = new TestMailmanServer()) {
 529             var author = credentials.getHostedRepository();
 530             var archive = credentials.getHostedRepository();
 531             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 532             var censusBuilder = credentials.getCensusBuilder()
 533                                            .addAuthor(author.host().getCurrentUserDetails().id());
 534             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 535             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 536                                                  listAddress, Set.of(), Set.of(),
 537                                                  listServer.getArchive(),
 538                                                  listServer.getSMTP(),
 539                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 540                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 541                                                  Set.of(), Map.of(), Map.of());</span>
 542 
 543             // Populate the projects repository
 544             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 545             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 546             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 547             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 548             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 549 
 550             // Make a change with a corresponding PR
 551             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
 552             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 553             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 554             pr.setBody(&quot;This is now ready&quot;);
 555             TestBotRunner.runPeriodicItems(mlBot);
 556             listServer.processIncoming();
 557 
 558             // Make a file specific comment
 559             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 560 
 561             TestBotRunner.runPeriodicItems(mlBot);
</pre>
<hr />
<pre>
 570     }
 571 
 572     @Test
 573     void multipleReviewContexts(TestInfo testInfo) throws IOException {
 574         try (var credentials = new HostCredentials(testInfo);
 575              var tempFolder = new TemporaryDirectory();
 576              var archiveFolder = new TemporaryDirectory();
 577              var listServer = new TestMailmanServer()) {
 578             var author = credentials.getHostedRepository();
 579             var archive = credentials.getHostedRepository();
 580             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 581             var censusBuilder = credentials.getCensusBuilder()
 582                                            .addAuthor(author.host().getCurrentUserDetails().id());
 583             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 584             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 585                                                  listAddress, Set.of(), Set.of(),
 586                                                  listServer.getArchive(),
 587                                                  listServer.getSMTP(),
 588                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 589                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 590                                                  Set.of(), Map.of(), Map.of());</span>
 591 
 592             // Populate the projects repository
 593             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 594             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 595             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 596             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 597             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 598             var initialHash = CheckableRepository.appendAndCommit(localRepo,
 599                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
 600                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
 601                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
 602                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
 603                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
 604                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
 605             localRepo.push(initialHash, author.getUrl(), &quot;master&quot;);
 606 
 607             // Make a change with a corresponding PR
 608             var current = Files.readString(localRepo.root().resolve(reviewFile), StandardCharsets.UTF_8);
 609             var updated = current.replaceAll(&quot;Line 2&quot;, &quot;Line 2 edit\nLine 2.5&quot;);
 610             updated = updated.replaceAll(&quot;Line 13&quot;, &quot;Line 12.5\nLine 13 edit&quot;);
</pre>
<hr />
<pre>
 637         }
 638     }
 639 
 640     @Test
 641     void filterComments(TestInfo testInfo) throws IOException {
 642         try (var credentials = new HostCredentials(testInfo);
 643              var tempFolder = new TemporaryDirectory();
 644              var archiveFolder = new TemporaryDirectory();
 645              var listServer = new TestMailmanServer()) {
 646             var author = credentials.getHostedRepository();
 647             var archive = credentials.getHostedRepository();
 648             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 649             var censusBuilder = credentials.getCensusBuilder()
 650                                            .addAuthor(author.host().getCurrentUserDetails().id());
 651             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 652             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 653                                                  listAddress, Set.of(), Set.of(),
 654                                                  listServer.getArchive(), listServer.getSMTP(),
 655                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 656                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 657                                                  Set.of(), Map.of(), Map.of());</span>
 658 
 659             // Populate the projects repository
 660             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 661             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 662             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 663             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 664             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 665 
 666             // Make a change with a corresponding PR
 667             var editHash = CheckableRepository.appendAndCommit(localRepo);
 668             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 669             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 670             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
 671                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
 672 
 673             // Make a bunch of comments
 674             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
 675             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment &lt;!-- this is a comment --&gt;\n&quot;);
 676             pr.addComment(&quot;/integrate stuff&quot;);
 677             TestBotRunner.runPeriodicItems(mlBot);
</pre>
<hr />
<pre>
 694     }
 695 
 696     @Test
 697     void incrementalChanges(TestInfo testInfo) throws IOException {
 698         try (var credentials = new HostCredentials(testInfo);
 699              var tempFolder = new TemporaryDirectory();
 700              var archiveFolder = new TemporaryDirectory();
 701              var listServer = new TestMailmanServer()) {
 702             var author = credentials.getHostedRepository();
 703             var archive = credentials.getHostedRepository();
 704             var commenter = credentials.getHostedRepository();
 705             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 706             var censusBuilder = credentials.getCensusBuilder()
 707                                            .addAuthor(author.host().getCurrentUserDetails().id());
 708             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 709             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 710                                                  listAddress, Set.of(), Set.of(),
 711                                                  listServer.getArchive(), listServer.getSMTP(),
 712                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 713                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 714                                                  Set.of(), Map.of(), Map.of());</span>
 715 
 716             // Populate the projects repository
 717             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 718             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 719             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 720             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 721             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 722 
 723             // Make a change with a corresponding PR
 724             var editHash = CheckableRepository.appendAndCommit(localRepo);
 725             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 726             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 727             pr.setBody(&quot;This is now ready&quot;);
 728 
 729             // Run an archive pass
 730             TestBotRunner.runPeriodicItems(mlBot);
 731             listServer.processIncoming();
 732 
 733             var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
 734             localRepo.push(nextHash, author.getUrl(), &quot;edit&quot;);
</pre>
<hr />
<pre>
 813         }
 814     }
 815 
 816     @Test
 817     void rebased(TestInfo testInfo) throws IOException {
 818         try (var credentials = new HostCredentials(testInfo);
 819              var tempFolder = new TemporaryDirectory();
 820              var archiveFolder = new TemporaryDirectory();
 821              var listServer = new TestMailmanServer()) {
 822             var author = credentials.getHostedRepository();
 823             var archive = credentials.getHostedRepository();
 824             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 825             var censusBuilder = credentials.getCensusBuilder()
 826                                            .addAuthor(author.host().getCurrentUserDetails().id());
 827             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 828             var mlBot = new MailingListBridgeBot(sender, author, archive, censusBuilder.build(), &quot;master&quot;,
 829                                                  listAddress, Set.of(), Set.of(),
 830                                                  listServer.getArchive(), listServer.getSMTP(),
 831                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 832                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 833                                                  Set.of(), Map.of(), Map.of());</span>
 834 
 835             // Populate the projects repository
 836             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 837             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.getRepositoryType(), reviewFile);
 838             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 839             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 840             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 841 
 842             // Make a change with a corresponding PR
 843             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
 844             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 845             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 846             pr.setBody(&quot;This is now ready&quot;);
 847 
 848             // Run an archive pass
 849             TestBotRunner.runPeriodicItems(mlBot);
 850             listServer.processIncoming();
 851 
 852             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.getUrl(), &quot;master&quot;);
 853             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
</pre>
<hr />
<pre>
 904     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
 905         try (var credentials = new HostCredentials(testInfo);
 906              var tempFolder = new TemporaryDirectory();
 907              var archiveFolder = new TemporaryDirectory();
 908              var webrevFolder = new TemporaryDirectory();
 909              var listServer = new TestMailmanServer()) {
 910             var author = credentials.getHostedRepository();
 911             var archive = credentials.getHostedRepository();
 912             var ignored = credentials.getHostedRepository();
 913             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 914             var censusBuilder = credentials.getCensusBuilder()
 915                                            .addAuthor(author.host().getCurrentUserDetails().id());
 916             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 917             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 918                                                  listAddress,
 919                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 920                                                  Set.of(),
 921                                                  listServer.getArchive(), listServer.getSMTP(),
 922                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 923                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 924                                                  Set.of(), Map.of(), Map.of());</span>
 925 
 926             // Populate the projects repository
 927             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
 928             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 929             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 930             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 931 
 932             // Make a change with a corresponding PR
 933             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 934                                                                &quot;Change msg\n\nWith several lines&quot;);
 935             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 936             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 937 
 938             // Flag it as ready for review
 939             pr.setBody(&quot;This should now be ready&quot;);
 940 
 941             // Run an archive pass
 942             TestBotRunner.runPeriodicItems(mlBot);
 943 
 944             // The archive should now contain an entry
</pre>
<hr />
<pre>
 975 
 976     @Test
 977     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
 978         try (var credentials = new HostCredentials(testInfo);
 979              var tempFolder = new TemporaryDirectory();
 980              var archiveFolder = new TemporaryDirectory();
 981              var listServer = new TestMailmanServer()) {
 982             var author = credentials.getHostedRepository();
 983             var archive = credentials.getHostedRepository();
 984             var reviewer = credentials.getHostedRepository();
 985             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 986             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 987             var censusBuilder = credentials.getCensusBuilder()
 988                                            .addReviewer(reviewer.host().getCurrentUserDetails().id())
 989                                            .addAuthor(author.host().getCurrentUserDetails().id());
 990             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 991                                                  listAddress, Set.of(), Set.of(),
 992                                                  listServer.getArchive(), listServer.getSMTP(),
 993                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 994                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 995                                                  Set.of(), Map.of(), Map.of());</span>
 996 
 997             // Populate the projects repository
 998             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 999             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
1000             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1001             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
1002             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
1003 
1004             // Make a change with a corresponding PR
1005             var editHash = CheckableRepository.appendAndCommit(localRepo);
1006             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
1007             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1008             pr.setBody(&quot;This is now ready&quot;);
1009 
1010             // Run an archive pass
1011             TestBotRunner.runPeriodicItems(mlBot);
1012 
1013             // First unapprove it
1014             var reviewedPr = reviewer.getPullRequest(pr.getId());
1015             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
</pre>
<hr />
<pre>
1057     @Test
1058     void ignoreComments(TestInfo testInfo) throws IOException {
1059         try (var credentials = new HostCredentials(testInfo);
1060              var tempFolder = new TemporaryDirectory();
1061              var archiveFolder = new TemporaryDirectory();
1062              var listServer = new TestMailmanServer()) {
1063             var author = credentials.getHostedRepository();
1064             var ignored = credentials.getHostedRepository();
1065             var archive = credentials.getHostedRepository();
1066             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1067             var censusBuilder = credentials.getCensusBuilder()
1068                                            .addAuthor(author.host().getCurrentUserDetails().id());
1069             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1070             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
1071                                                  listAddress,
1072                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
1073                                                  Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)),
1074                                                  listServer.getArchive(), listServer.getSMTP(),
1075                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
1076                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified">1077                                                  Set.of(), Map.of(), Map.of());</span>
1078 
1079             // Populate the projects repository
1080             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1081             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
1082             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1083             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
1084             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
1085 
1086             // Make a change with a corresponding PR
1087             var editHash = CheckableRepository.appendAndCommit(localRepo);
1088             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
1089             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1090             pr.setBody(&quot;This is now ready&quot;);
1091 
1092             // Make a bunch of comments
1093             pr.addComment(&quot;Plain comment&quot;);
1094             pr.addComment(&quot;ignore this comment&quot;);
1095             pr.addComment(&quot;I think it is time to\nignore this comment!&quot;);
1096             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review ignore this comment&quot;);
1097 
</pre>
</td>
</tr>
</table>
<center><a href="MailingListArchiveReaderBotTests.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>