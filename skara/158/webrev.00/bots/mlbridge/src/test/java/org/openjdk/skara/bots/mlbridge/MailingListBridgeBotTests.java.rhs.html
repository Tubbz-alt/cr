<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.mlbridge;
  24 
  25 import org.openjdk.skara.email.EmailAddress;
  26 import org.openjdk.skara.host.*;
  27 import org.openjdk.skara.host.network.URIBuilder;
  28 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  29 import org.openjdk.skara.test.*;
  30 import org.openjdk.skara.vcs.Repository;
  31 
  32 import org.junit.jupiter.api.*;
  33 
  34 import java.io.IOException;
  35 import java.nio.charset.StandardCharsets;
  36 import java.nio.file.*;
  37 import java.time.Duration;
  38 import java.util.*;
  39 import java.util.regex.Pattern;
  40 import java.util.stream.Collectors;
  41 
  42 import static org.junit.jupiter.api.Assertions.*;
  43 
  44 class MailingListBridgeBotTests {
  45     private boolean archiveContains(Path archive, String text) {
  46         return archiveContainsCount(archive, text) &gt; 0;
  47     }
  48 
  49     private int archiveContainsCount(Path archive, String text) {
  50         try {
  51             var mbox = Files.find(archive, 50, (path, attrs) -&gt; path.toString().endsWith(&quot;.mbox&quot;)).findAny();
  52             if (mbox.isEmpty()) {
  53                 return 0;
  54             }
  55             var lines = Files.readString(mbox.get(), StandardCharsets.UTF_8);
  56             var pattern = Pattern.compile(text);
  57             int count = 0;
  58             for (var line : lines.split(&quot;\\R&quot;)) {
  59                 var matcher = pattern.matcher(line);
  60                 if (matcher.find()) {
  61                     count++;
  62                 }
  63             }
  64             return count;
  65         } catch (IOException e) {
  66             return 0;
  67         }
  68     }
  69 
  70     private boolean webrevContains(Path webrev, String text) {
  71         try {
  72             var index = Files.find(webrev, 5, (path, attrs) -&gt; path.toString().endsWith(&quot;index.html&quot;)).findAny();
  73             if (index.isEmpty()) {
  74                 return false;
  75             }
  76             var lines = Files.readString(index.get(), StandardCharsets.UTF_8);
  77             return lines.contains(text);
  78         } catch (IOException e) {
  79             return false;
  80         }
  81     }
  82 
  83     private long countSubstrings(String string, String substring) {
  84         return Pattern.compile(substring).matcher(string).results().count();
  85     }
  86 
  87     private String noreplyAddress(HostedRepository repository) {
  88         return repository.host().getCurrentUserDetails().id() + &quot;+&quot; +
  89                 repository.host().getCurrentUserDetails().userName() +
  90                 &quot;@users.noreply.test&quot;;
  91     }
  92 
  93     @Test
  94     void simpleArchive(TestInfo testInfo) throws IOException {
  95         try (var credentials = new HostCredentials(testInfo);
  96              var tempFolder = new TemporaryDirectory();
  97              var archiveFolder = new TemporaryDirectory();
  98              var webrevFolder = new TemporaryDirectory();
  99              var listServer = new TestMailmanServer()) {
 100             var author = credentials.getHostedRepository();
 101             var archive = credentials.getHostedRepository();
 102             var ignored = credentials.getHostedRepository();
 103             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 104             var censusBuilder = credentials.getCensusBuilder()
 105                                            .addAuthor(author.host().getCurrentUserDetails().id());
 106             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 107             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,
 108                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 109                                                  Set.of(),
 110                                                  listServer.getArchive(), listServer.getSMTP(),
 111                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 112                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 113                                                  Set.of(&quot;rfr&quot;), Map.of(ignored.host().getCurrentUserDetails().userName(),
<a name="1" id="anc1"></a><span class="line-modified"> 114                                                                        Pattern.compile(&quot;ready&quot;)),</span>
<span class="line-added"> 115                                                  Map.of(&quot;Extra1&quot;, &quot;val1&quot;, &quot;Extra2&quot;, &quot;val2&quot;));</span>
 116 
 117             // Populate the projects repository
 118             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
 119             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 120             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 121             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 122 
 123             // Make a change with a corresponding PR
 124             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 125                                                                &quot;Change msg\n\nWith several lines&quot;);
 126             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 127             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 128             pr.setBody(&quot;This should not be ready&quot;);
 129 
 130             // Run an archive pass
 131             TestBotRunner.runPeriodicItems(mlBot);
 132 
 133             // A PR that isn&#39;t ready for review should not be archived
 134             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 135             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 136 
 137             // Flag it as ready for review
 138             pr.setBody(&quot;This should now be ready&quot;);
 139             pr.addLabel(&quot;rfr&quot;);
 140 
 141             // Run another archive pass
 142             TestBotRunner.runPeriodicItems(mlBot);
 143 
 144             // But it should still not be archived
 145             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 146             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 147 
 148             // Now post a general comment - not a ready marker
 149             var ignoredPr = ignored.getPullRequest(pr.getId());
 150             ignoredPr.addComment(&quot;hello there&quot;);
 151 
 152             // Run another archive pass
 153             TestBotRunner.runPeriodicItems(mlBot);
 154 
 155             // It should still not be archived
 156             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 157             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 158 
 159             // Now post a ready comment
 160             ignoredPr.addComment(&quot;ready&quot;);
 161 
 162             // Run another archive pass
 163             TestBotRunner.runPeriodicItems(mlBot);
 164 
 165             // The archive should now contain an entry
 166             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 167             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 168             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
 169             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
 170             assertTrue(archiveContains(archiveFolder.path(), &quot;Changes:&quot;));
 171             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
 172             assertTrue(archiveContains(archiveFolder.path(), &quot;http://www.test.test/&quot;));
 173             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));
 174             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch:&quot;));
 175             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - &quot; + editHash.abbreviate() + &quot;: Change msg&quot;));
 176             assertFalse(archiveContains(archiveFolder.path(), &quot;With several lines&quot;));
 177 
 178             // The mailing list as well
 179             listServer.processIncoming();
 180             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 181             var mailmanList = mailmanServer.getList(listAddress.address());
 182             var conversations = mailmanList.conversations(Duration.ofDays(1));
 183             assertEquals(1, conversations.size());
 184             var mail = conversations.get(0).first();
 185             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 186             assertEquals(pr.getAuthor().fullName(), mail.author().fullName().orElseThrow());
 187             assertEquals(noreplyAddress(archive), mail.author().address());
 188             assertEquals(from, mail.sender());
<a name="2" id="anc2"></a><span class="line-added"> 189             assertEquals(&quot;val1&quot;, mail.headerValue(&quot;Extra1&quot;));</span>
<span class="line-added"> 190             assertEquals(&quot;val2&quot;, mail.headerValue(&quot;Extra2&quot;));</span>
 191 
 192             // And there should be a webrev
 193             Repository.materialize(webrevFolder.path(), archive.getUrl(), &quot;webrev&quot;);
 194             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
 195             var comments = pr.getComments();
 196             var webrevComments = comments.stream()
 197                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 198                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 199                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 200                                          .collect(Collectors.toList());
 201             assertEquals(1, webrevComments.size());
 202 
 203             // Add a comment
 204             pr.addComment(&quot;This is a comment :smile:&quot;);
 205 
 206             // Add a comment from an ignored user as well
 207             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);
 208 
 209             // Run another archive pass
 210             TestBotRunner.runPeriodicItems(mlBot);
 211 
 212             // The archive should now contain the comment, but not the ignored one
 213             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 214             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a comment&quot;));
 215             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This should now be ready&quot;));
 216             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 217 
 218             listServer.processIncoming();
 219             conversations = mailmanList.conversations(Duration.ofDays(1));
 220             assertEquals(1, conversations.size());
 221             assertEquals(2, conversations.get(0).allMessages().size());
 222 
 223             // Remove the rfr flag and post another comment
 224             pr.addLabel(&quot;rfr&quot;);
 225             pr.addComment(&quot;This is another comment&quot;);
 226 
 227             // Run another archive pass
 228             TestBotRunner.runPeriodicItems(mlBot);
 229 
 230             // The archive should contain the additional comment
 231             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 232             assertTrue(archiveContains(archiveFolder.path(), &quot;This is another comment&quot;));
 233             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This should now be ready&quot;));
 234 
 235             listServer.processIncoming();
 236             conversations = mailmanList.conversations(Duration.ofDays(1));
 237             assertEquals(1, conversations.size());
 238             assertEquals(3, conversations.get(0).allMessages().size());
 239             for (var newMail : conversations.get(0).allMessages()) {
 240                 assertEquals(noreplyAddress(archive), newMail.author().address());
 241                 assertEquals(from, newMail.sender());
 242             }
 243             assertTrue(conversations.get(0).allMessages().get(2).body().contains(&quot;This is a comment 😄&quot;));
 244         }
 245     }
 246 
 247     @Test
 248     void reviewComment(TestInfo testInfo) throws IOException {
 249         try (var credentials = new HostCredentials(testInfo);
 250              var tempFolder = new TemporaryDirectory();
 251              var archiveFolder = new TemporaryDirectory();
 252              var listServer = new TestMailmanServer()) {
 253             var author = credentials.getHostedRepository();
 254             var archive = credentials.getHostedRepository();
 255             var ignored = credentials.getHostedRepository();
 256             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 257             var censusBuilder = credentials.getCensusBuilder()
 258                                            .addAuthor(author.host().getCurrentUserDetails().id());
 259             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 260             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,
 261                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 262                                                  Set.of(),
 263                                                  listServer.getArchive(), listServer.getSMTP(),
 264                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 265                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<a name="3" id="anc3"></a><span class="line-modified"> 266                                                  Set.of(), Map.of(), Map.of());</span>
 267 
 268             // Populate the projects repository
 269             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 270             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 271             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 272             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 273             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 274 
 275             // Make a change with a corresponding PR
 276             var editHash = CheckableRepository.appendAndCommit(localRepo);
 277             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 278             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 279             pr.setBody(&quot;This is now ready&quot;);
 280             TestBotRunner.runPeriodicItems(mlBot);
 281             listServer.processIncoming();
 282 
 283             // And make a file specific comment
 284             var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
 285             var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 286 
 287             // Add one from an ignored user as well
 288             var ignoredPr = ignored.getPullRequest(pr.getId());
 289             ignoredPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Don&#39;t mind me&quot;);
 290 
 291             // Process comments
 292             TestBotRunner.runPeriodicItems(mlBot);
 293             listServer.processIncoming();
 294 
 295             // The archive should now contain an entry
 296             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 297             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 298             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 299             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 300             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This is now ready&quot;));
 301             assertTrue(archiveContains(archiveFolder.path(), reviewFile.toString()));
 302             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 303 
 304             // The mailing list as well
 305             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 306             var mailmanList = mailmanServer.getList(listAddress.address());
 307             var conversations = mailmanList.conversations(Duration.ofDays(1));
 308             assertEquals(1, conversations.size());
 309             var mail = conversations.get(0).first();
 310             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 311 
 312             // Comment on the comment
 313             pr.addReviewCommentReply(comment, &quot;This is a review reply&quot;);
 314             TestBotRunner.runPeriodicItems(mlBot);
 315             listServer.processIncoming();
 316 
 317             // The archive should contain the additional comment (but no quoted footers)
 318             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 319             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a review reply&quot;));
 320             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This is now ready&quot;));
 321             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; PR:&quot;));
 322 
 323             // As well as the mailing list
 324             conversations = mailmanList.conversations(Duration.ofDays(1));
 325             assertEquals(1, conversations.size());
 326             assertEquals(3, conversations.get(0).allMessages().size());
 327             for (var newMail : conversations.get(0).allMessages()) {
 328                 assertEquals(noreplyAddress(archive), newMail.author().address());
 329                 assertEquals(from, newMail.sender());
 330             }
 331         }
 332     }
 333 
 334     @Test
 335     void combineComments(TestInfo testInfo) throws IOException {
 336         try (var credentials = new HostCredentials(testInfo);
 337              var tempFolder = new TemporaryDirectory();
 338              var archiveFolder = new TemporaryDirectory();
 339              var listServer = new TestMailmanServer()) {
 340             var author = credentials.getHostedRepository();
 341             var archive = credentials.getHostedRepository();
 342             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 343             var censusBuilder = credentials.getCensusBuilder()
 344                                            .addAuthor(author.host().getCurrentUserDetails().id());
 345             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 346             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 347                                                  listAddress, Set.of(), Set.of(),
 348                                                  listServer.getArchive(),
 349                                                  listServer.getSMTP(),
 350                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 351                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<a name="4" id="anc4"></a><span class="line-modified"> 352                                                  Set.of(), Map.of(), Map.of());</span>
 353 
 354             // Populate the projects repository
 355             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 356             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 357             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 358             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 359             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 360 
 361             // Make a change with a corresponding PR
 362             var editHash = CheckableRepository.appendAndCommit(localRepo);
 363             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 364             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 365             pr.setBody(&quot;This is now ready&quot;);
 366             pr.addComment(&quot;Avoid combining&quot;);
 367 
 368             TestBotRunner.runPeriodicItems(mlBot);
 369             listServer.processIncoming();
 370             listServer.processIncoming();
 371 
 372             // Make two file specific comments
 373             var first = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 374             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 375             TestBotRunner.runPeriodicItems(mlBot);
 376             listServer.processIncoming();
 377 
 378             // The archive should contain a combined entry
 379             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 380             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 381 
 382             // As well as the mailing list
 383             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 384             var mailmanList = mailmanServer.getList(listAddress.address());
 385             var conversations = mailmanList.conversations(Duration.ofDays(1));
 386             assertEquals(1, conversations.size());
 387             var mail = conversations.get(0).first();
 388             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 389             assertEquals(3, conversations.get(0).allMessages().size());
 390 
 391             var commentReply = conversations.get(0).replies(mail).get(0);
 392             assertEquals(2, commentReply.body().split(&quot;^On.*wrote:&quot;).length);
 393             assertTrue(commentReply.body().contains(&quot;Avoid combining\n\n&quot;), commentReply.body());
 394 
 395             var reviewReply = conversations.get(0).replies(mail).get(1);
 396             assertEquals(2, reviewReply.body().split(&quot;^On.*wrote:&quot;).length);
 397             assertEquals(2, reviewReply.body().split(&quot;&gt; This is now ready&quot;).length, reviewReply.body());
 398             assertEquals(&quot;Re: RFR: This is a pull request&quot;, reviewReply.subject());
 399             assertTrue(reviewReply.body().contains(&quot;Review comment\n\n&quot;), reviewReply.body());
 400             assertTrue(reviewReply.body().contains(&quot;Another review comment&quot;), reviewReply.body());
 401 
 402             // Now reply to the first (collapsed) comment
 403             pr.addReviewCommentReply(first, &quot;I agree&quot;);
 404             TestBotRunner.runPeriodicItems(mlBot);
 405             listServer.processIncoming();
 406 
 407             // The archive should contain a new entry
 408             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 409             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 410         }
 411     }
 412 
 413     @Test
 414     void commentThreading(TestInfo testInfo) throws IOException {
 415         try (var credentials = new HostCredentials(testInfo);
 416              var tempFolder = new TemporaryDirectory();
 417              var archiveFolder = new TemporaryDirectory();
 418              var listServer = new TestMailmanServer()) {
 419             var author = credentials.getHostedRepository();
 420             var reviewer = credentials.getHostedRepository();
 421             var archive = credentials.getHostedRepository();
 422             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 423             var censusBuilder = credentials.getCensusBuilder()
 424                                            .addReviewer(reviewer.host().getCurrentUserDetails().id())
 425                                            .addAuthor(author.host().getCurrentUserDetails().id());
 426             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 427             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 428                                                  listAddress, Set.of(), Set.of(),
 429                                                  listServer.getArchive(),
 430                                                  listServer.getSMTP(),
 431                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 432                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<a name="5" id="anc5"></a><span class="line-modified"> 433                                                  Set.of(), Map.of(), Map.of());</span>
 434 
 435             // Populate the projects repository
 436             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 437             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 438             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 439             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 440             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 441 
 442             // Make a change with a corresponding PR
 443             var editHash = CheckableRepository.appendAndCommit(localRepo);
 444             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 445             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 446             pr.setBody(&quot;This is now ready&quot;);
 447             TestBotRunner.runPeriodicItems(mlBot);
 448             listServer.processIncoming();
 449 
 450             // Make a file specific comment
 451             var reviewPr = reviewer.getPullRequest(pr.getId());
 452             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 453             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 454             reviewPr.addReviewCommentReply(comment1, &quot;Great&quot;);
 455             TestBotRunner.runPeriodicItems(mlBot);
 456             listServer.processIncoming();
 457             listServer.processIncoming();
 458             listServer.processIncoming();
 459 
 460             // And a second one by ourselves
 461             var comment2 = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 462             reviewPr.addReviewCommentReply(comment2, &quot;Sounds good&quot;);
 463             pr.addReviewCommentReply(comment2, &quot;Thanks&quot;);
 464             TestBotRunner.runPeriodicItems(mlBot);
 465             listServer.processIncoming();
 466             listServer.processIncoming();
 467             listServer.processIncoming();
 468 
 469             // Finally some approvals
 470             pr.addReview(Review.Verdict.APPROVED, &quot;Nice&quot;);
 471             reviewPr.addReview(Review.Verdict.APPROVED, &quot;Looks fine&quot;);
 472             TestBotRunner.runPeriodicItems(mlBot);
 473             listServer.processIncoming();
 474             listServer.processIncoming();
 475 
 476             // Sanity check the archive
 477             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 478             assertEquals(8, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 479 
 480             // Check the mailing list
 481             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 482             var mailmanList = mailmanServer.getList(listAddress.address());
 483             var conversations = mailmanList.conversations(Duration.ofDays(1));
 484             assertEquals(1, conversations.size());
 485             var mail = conversations.get(0).first();
 486             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 487             assertEquals(9, conversations.get(0).allMessages().size());
 488 
 489             // There should be four separate threads
 490             var thread1 = conversations.get(0).replies(mail).get(0);
 491             assertEquals(2, thread1.body().split(&quot;^On.*wrote:&quot;).length);
 492             assertEquals(2, thread1.body().split(&quot;&gt; This is now ready&quot;).length, thread1.body());
 493             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread1.subject());
 494             assertTrue(thread1.body().contains(&quot;Review comment\n\n&quot;), thread1.body());
 495             assertFalse(thread1.body().contains(&quot;Another review comment&quot;), thread1.body());
 496             var thread1reply1 = conversations.get(0).replies(thread1).get(0);
 497             assertTrue(thread1reply1.body().contains(&quot;I agree&quot;));
 498             assertEquals(noreplyAddress(archive), thread1reply1.author().address());
 499             assertEquals(archive.host().getCurrentUserDetails().fullName(), thread1reply1.author().fullName().orElseThrow());
 500             var thread1reply2 = conversations.get(0).replies(thread1reply1).get(0);
 501             assertTrue(thread1reply2.body().contains(&quot;Great&quot;));
 502             assertEquals(&quot;integrationreviewer1@openjdk.java.net&quot;, thread1reply2.author().address());
 503             assertEquals(&quot;Generated Reviewer 1&quot;, thread1reply2.author().fullName().orElseThrow());
 504 
 505             var thread2 = conversations.get(0).replies(mail).get(1);
 506             assertEquals(2, thread2.body().split(&quot;^On.*wrote:&quot;).length);
 507             assertEquals(2, thread2.body().split(&quot;&gt; This is now ready&quot;).length, thread2.body());
 508             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread2.subject());
 509             assertFalse(thread2.body().contains(&quot;Review comment\n\n&quot;), thread2.body());
 510             assertTrue(thread2.body().contains(&quot;Another review comment&quot;), thread2.body());
 511             var thread2reply1 = conversations.get(0).replies(thread2).get(0);
 512             assertTrue(thread2reply1.body().contains(&quot;Sounds good&quot;));
 513             var thread2reply2 = conversations.get(0).replies(thread2reply1).get(0);
 514             assertTrue(thread2reply2.body().contains(&quot;Thanks&quot;));
 515 
 516             var thread3 = conversations.get(0).replies(mail).get(2);
 517             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread3.subject());
 518             var thread4 = conversations.get(0).replies(mail).get(3);
 519             assertEquals(&quot;Re: [Approved] RFR: This is a pull request&quot;, thread4.subject());
 520         }
 521     }
 522 
 523     @Test
 524     void reviewContext(TestInfo testInfo) throws IOException {
 525         try (var credentials = new HostCredentials(testInfo);
 526              var tempFolder = new TemporaryDirectory();
 527              var archiveFolder = new TemporaryDirectory();
 528              var listServer = new TestMailmanServer()) {
 529             var author = credentials.getHostedRepository();
 530             var archive = credentials.getHostedRepository();
 531             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 532             var censusBuilder = credentials.getCensusBuilder()
 533                                            .addAuthor(author.host().getCurrentUserDetails().id());
 534             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 535             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 536                                                  listAddress, Set.of(), Set.of(),
 537                                                  listServer.getArchive(),
 538                                                  listServer.getSMTP(),
 539                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 540                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<a name="6" id="anc6"></a><span class="line-modified"> 541                                                  Set.of(), Map.of(), Map.of());</span>
 542 
 543             // Populate the projects repository
 544             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 545             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 546             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 547             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 548             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 549 
 550             // Make a change with a corresponding PR
 551             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
 552             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 553             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 554             pr.setBody(&quot;This is now ready&quot;);
 555             TestBotRunner.runPeriodicItems(mlBot);
 556             listServer.processIncoming();
 557 
 558             // Make a file specific comment
 559             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 560 
 561             TestBotRunner.runPeriodicItems(mlBot);
 562             listServer.processIncoming();
 563 
 564             // The archive should only contain context around line 2
 565             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 566             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
 567             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
 568             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
 569         }
 570     }
 571 
 572     @Test
 573     void multipleReviewContexts(TestInfo testInfo) throws IOException {
 574         try (var credentials = new HostCredentials(testInfo);
 575              var tempFolder = new TemporaryDirectory();
 576              var archiveFolder = new TemporaryDirectory();
 577              var listServer = new TestMailmanServer()) {
 578             var author = credentials.getHostedRepository();
 579             var archive = credentials.getHostedRepository();
 580             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 581             var censusBuilder = credentials.getCensusBuilder()
 582                                            .addAuthor(author.host().getCurrentUserDetails().id());
 583             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 584             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 585                                                  listAddress, Set.of(), Set.of(),
 586                                                  listServer.getArchive(),
 587                                                  listServer.getSMTP(),
 588                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 589                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<a name="7" id="anc7"></a><span class="line-modified"> 590                                                  Set.of(), Map.of(), Map.of());</span>
 591 
 592             // Populate the projects repository
 593             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 594             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 595             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 596             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 597             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 598             var initialHash = CheckableRepository.appendAndCommit(localRepo,
 599                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
 600                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
 601                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
 602                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
 603                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
 604                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
 605             localRepo.push(initialHash, author.getUrl(), &quot;master&quot;);
 606 
 607             // Make a change with a corresponding PR
 608             var current = Files.readString(localRepo.root().resolve(reviewFile), StandardCharsets.UTF_8);
 609             var updated = current.replaceAll(&quot;Line 2&quot;, &quot;Line 2 edit\nLine 2.5&quot;);
 610             updated = updated.replaceAll(&quot;Line 13&quot;, &quot;Line 12.5\nLine 13 edit&quot;);
 611             Files.writeString(localRepo.root().resolve(reviewFile), updated, StandardCharsets.UTF_8);
 612             var editHash = CheckableRepository.appendAndCommit(localRepo);
 613             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 614             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 615             pr.setBody(&quot;This is now ready&quot;);
 616             TestBotRunner.runPeriodicItems(mlBot);
 617             listServer.processIncoming();
 618 
 619             // Make file specific comments
 620             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 7, &quot;Review comment&quot;);
 621             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 24, &quot;Another review comment&quot;);
 622 
 623             TestBotRunner.runPeriodicItems(mlBot);
 624             listServer.processIncoming();
 625 
 626             // The archive should only contain context around line 2 and 20
 627             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 628             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 7&quot;));
 629             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 6: Line 1$&quot;));
 630             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 7: Line 2 edit$&quot;));
 631             assertFalse(archiveContains(archiveFolder.path(), &quot;Line 3&quot;));
 632 
 633             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 24&quot;));
 634             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 23: Line 12.5$&quot;));
 635             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 24: Line 13 edit$&quot;));
 636             assertFalse(archiveContains(archiveFolder.path(), &quot;^Line 15&quot;));
 637         }
 638     }
 639 
 640     @Test
 641     void filterComments(TestInfo testInfo) throws IOException {
 642         try (var credentials = new HostCredentials(testInfo);
 643              var tempFolder = new TemporaryDirectory();
 644              var archiveFolder = new TemporaryDirectory();
 645              var listServer = new TestMailmanServer()) {
 646             var author = credentials.getHostedRepository();
 647             var archive = credentials.getHostedRepository();
 648             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 649             var censusBuilder = credentials.getCensusBuilder()
 650                                            .addAuthor(author.host().getCurrentUserDetails().id());
 651             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 652             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 653                                                  listAddress, Set.of(), Set.of(),
 654                                                  listServer.getArchive(), listServer.getSMTP(),
 655                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 656                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<a name="8" id="anc8"></a><span class="line-modified"> 657                                                  Set.of(), Map.of(), Map.of());</span>
 658 
 659             // Populate the projects repository
 660             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 661             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 662             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 663             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 664             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 665 
 666             // Make a change with a corresponding PR
 667             var editHash = CheckableRepository.appendAndCommit(localRepo);
 668             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 669             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 670             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
 671                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
 672 
 673             // Make a bunch of comments
 674             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
 675             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment &lt;!-- this is a comment --&gt;\n&quot;);
 676             pr.addComment(&quot;/integrate stuff&quot;);
 677             TestBotRunner.runPeriodicItems(mlBot);
 678 
 679             // Run an archive pass
 680             TestBotRunner.runPeriodicItems(mlBot);
 681 
 682             // The archive should not contain the comment
 683             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 684             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 685             assertFalse(archiveContains(archiveFolder.path(), &quot;this is a comment&quot;));
 686             assertFalse(archiveContains(archiveFolder.path(), &quot;Status stuff&quot;));
 687             assertTrue(archiveContains(archiveFolder.path(), &quot;And this is not&quot;));
 688             assertFalse(archiveContains(archiveFolder.path(), &quot;&lt;!--&quot;));
 689             assertFalse(archiveContains(archiveFolder.path(), &quot;--&gt;&quot;));
 690             assertTrue(archiveContains(archiveFolder.path(), &quot;Plain comment&quot;));
 691             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 692             assertFalse(archiveContains(archiveFolder.path(), &quot;/integrate&quot;));
 693         }
 694     }
 695 
 696     @Test
 697     void incrementalChanges(TestInfo testInfo) throws IOException {
 698         try (var credentials = new HostCredentials(testInfo);
 699              var tempFolder = new TemporaryDirectory();
 700              var archiveFolder = new TemporaryDirectory();
 701              var listServer = new TestMailmanServer()) {
 702             var author = credentials.getHostedRepository();
 703             var archive = credentials.getHostedRepository();
 704             var commenter = credentials.getHostedRepository();
 705             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 706             var censusBuilder = credentials.getCensusBuilder()
 707                                            .addAuthor(author.host().getCurrentUserDetails().id());
 708             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 709             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 710                                                  listAddress, Set.of(), Set.of(),
 711                                                  listServer.getArchive(), listServer.getSMTP(),
 712                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 713                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<a name="9" id="anc9"></a><span class="line-modified"> 714                                                  Set.of(), Map.of(), Map.of());</span>
 715 
 716             // Populate the projects repository
 717             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 718             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 719             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 720             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 721             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 722 
 723             // Make a change with a corresponding PR
 724             var editHash = CheckableRepository.appendAndCommit(localRepo);
 725             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 726             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 727             pr.setBody(&quot;This is now ready&quot;);
 728 
 729             // Run an archive pass
 730             TestBotRunner.runPeriodicItems(mlBot);
 731             listServer.processIncoming();
 732 
 733             var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
 734             localRepo.push(nextHash, author.getUrl(), &quot;edit&quot;);
 735 
 736             // Make sure that the push registered
 737             var lastHeadHash = pr.getHeadHash();
 738             var refreshCount = 0;
 739             do {
 740                 pr = author.getPullRequest(pr.getId());
 741                 if (refreshCount++ &gt; 100) {
 742                     fail(&quot;The PR did not update after the new push&quot;);
 743                 }
 744             } while (pr.getHeadHash().equals(lastHeadHash));
 745 
 746             // Run another archive pass
 747             TestBotRunner.runPeriodicItems(mlBot);
 748             TestBotRunner.runPeriodicItems(mlBot);
 749             TestBotRunner.runPeriodicItems(mlBot);
 750             listServer.processIncoming();
 751 
 752             // The archive should reference the updated push
 753             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 754             assertTrue(archiveContains(archiveFolder.path(), &quot;additional changes&quot;));
 755             assertTrue(archiveContains(archiveFolder.path(), &quot;full.*/&quot; + pr.getId() + &quot;/webrev.01&quot;));
 756             assertTrue(archiveContains(archiveFolder.path(), &quot;inc.*/&quot; + pr.getId() + &quot;/webrev.00-01&quot;));
 757             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
 758             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
 759             assertTrue(archiveContains(archiveFolder.path(), &quot;Fixing&quot;));
 760 
 761             // The webrev comment should be updated
 762             var comments = pr.getComments();
 763             var webrevComments = comments.stream()
 764                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 765                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 766                                          .filter(comment -&gt; comment.body().contains(nextHash.hex()))
 767                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 768                                          .collect(Collectors.toList());
 769             assertEquals(1, webrevComments.size());
 770 
 771             // Check that sender address is set properly
 772             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 773             var mailmanList = mailmanServer.getList(listAddress.address());
 774             var conversations = mailmanList.conversations(Duration.ofDays(1));
 775             assertEquals(1, conversations.size());
 776             for (var newMail : conversations.get(0).allMessages()) {
 777                 assertEquals(noreplyAddress(archive), newMail.author().address());
 778                 assertEquals(from, newMail.sender());
 779             }
 780 
 781             // Add a comment
 782             var commenterPr = commenter.getPullRequest(pr.getId());
 783             commenterPr.addReviewComment(masterHash, nextHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 784             TestBotRunner.runPeriodicItems(mlBot);
 785             listServer.processIncoming();
 786 
 787             // Ensure that additional updates are only reported once
 788             for (int i = 0; i &lt; 3; ++i) {
 789                 var anotherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fixing&quot;);
 790                 localRepo.push(anotherHash, author.getUrl(), &quot;edit&quot;);
 791 
 792                 // Make sure that the push registered
 793                 lastHeadHash = pr.getHeadHash();
 794                 refreshCount = 0;
 795                 do {
 796                     pr = author.getPullRequest(pr.getId());
 797                     if (refreshCount++ &gt; 100) {
 798                         fail(&quot;The PR did not update after the new push&quot;);
 799                     }
 800                 } while (pr.getHeadHash().equals(lastHeadHash));
 801 
 802                 TestBotRunner.runPeriodicItems(mlBot);
 803                 TestBotRunner.runPeriodicItems(mlBot);
 804                 listServer.processIncoming();
 805             }
 806             var updatedConversations = mailmanList.conversations(Duration.ofDays(1));
 807             assertEquals(1, updatedConversations.size());
 808             var conversation = updatedConversations.get(0);
 809             assertEquals(6, conversation.allMessages().size());
 810             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(1).subject());
 811             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(2).subject(), conversation.allMessages().get(2).toString());
 812             assertEquals(&quot;Re: [Rev 04] RFR: This is a pull request&quot;, conversation.allMessages().get(5).subject());
 813         }
 814     }
 815 
 816     @Test
 817     void rebased(TestInfo testInfo) throws IOException {
 818         try (var credentials = new HostCredentials(testInfo);
 819              var tempFolder = new TemporaryDirectory();
 820              var archiveFolder = new TemporaryDirectory();
 821              var listServer = new TestMailmanServer()) {
 822             var author = credentials.getHostedRepository();
 823             var archive = credentials.getHostedRepository();
 824             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 825             var censusBuilder = credentials.getCensusBuilder()
 826                                            .addAuthor(author.host().getCurrentUserDetails().id());
 827             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 828             var mlBot = new MailingListBridgeBot(sender, author, archive, censusBuilder.build(), &quot;master&quot;,
 829                                                  listAddress, Set.of(), Set.of(),
 830                                                  listServer.getArchive(), listServer.getSMTP(),
 831                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 832                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<a name="10" id="anc10"></a><span class="line-modified"> 833                                                  Set.of(), Map.of(), Map.of());</span>
 834 
 835             // Populate the projects repository
 836             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 837             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.getRepositoryType(), reviewFile);
 838             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 839             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 840             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 841 
 842             // Make a change with a corresponding PR
 843             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
 844             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 845             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 846             pr.setBody(&quot;This is now ready&quot;);
 847 
 848             // Run an archive pass
 849             TestBotRunner.runPeriodicItems(mlBot);
 850             listServer.processIncoming();
 851 
 852             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.getUrl(), &quot;master&quot;);
 853             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
 854             newLocalRepo.push(newEditHash, author.getUrl(), &quot;edit&quot;, true);
 855 
 856             // Make sure that the push registered
 857             var lastHeadHash = pr.getHeadHash();
 858             var refreshCount = 0;
 859             do {
 860                 pr = author.getPullRequest(pr.getId());
 861                 if (refreshCount++ &gt; 100) {
 862                     fail(&quot;The PR did not update after the new push&quot;);
 863                 }
 864             } while (pr.getHeadHash().equals(lastHeadHash));
 865 
 866             // Run another archive pass
 867             TestBotRunner.runPeriodicItems(mlBot);
 868             listServer.processIncoming();
 869 
 870             // The archive should reference the rebased push
 871             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 872             assertTrue(archiveContains(archiveFolder.path(), &quot;complete new set of changes&quot;));
 873             assertTrue(archiveContains(archiveFolder.path(), pr.getId() + &quot;/webrev.01&quot;));
 874             assertFalse(archiveContains(archiveFolder.path(), &quot;Incremental&quot;));
 875             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
 876             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
 877             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
 878             assertTrue(archiveContains(archiveFolder.path(), &quot;Replaced msg&quot;));
 879 
 880             // The webrev comment should be updated
 881             var comments = pr.getComments();
 882             var webrevComments = comments.stream()
 883                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 884                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 885                                          .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
 886                                          .collect(Collectors.toList());
 887             assertEquals(1, webrevComments.size());
 888 
 889             // Check that sender address is set properly
 890             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 891             var mailmanList = mailmanServer.getList(listAddress.address());
 892             var conversations = mailmanList.conversations(Duration.ofDays(1));
 893             assertEquals(1, conversations.size());
 894             for (var newMail : conversations.get(0).allMessages()) {
 895                 assertEquals(noreplyAddress(archive), newMail.author().address());
 896                 assertEquals(sender, newMail.sender());
 897                 assertFalse(newMail.hasHeader(&quot;PR-Head-Hash&quot;));
 898             }
 899             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversations.get(0).allMessages().get(1).subject());
 900         }
 901     }
 902 
 903     @Test
 904     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
 905         try (var credentials = new HostCredentials(testInfo);
 906              var tempFolder = new TemporaryDirectory();
 907              var archiveFolder = new TemporaryDirectory();
 908              var webrevFolder = new TemporaryDirectory();
 909              var listServer = new TestMailmanServer()) {
 910             var author = credentials.getHostedRepository();
 911             var archive = credentials.getHostedRepository();
 912             var ignored = credentials.getHostedRepository();
 913             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 914             var censusBuilder = credentials.getCensusBuilder()
 915                                            .addAuthor(author.host().getCurrentUserDetails().id());
 916             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 917             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 918                                                  listAddress,
 919                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 920                                                  Set.of(),
 921                                                  listServer.getArchive(), listServer.getSMTP(),
 922                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 923                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<a name="11" id="anc11"></a><span class="line-modified"> 924                                                  Set.of(), Map.of(), Map.of());</span>
 925 
 926             // Populate the projects repository
 927             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
 928             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 929             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 930             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 931 
 932             // Make a change with a corresponding PR
 933             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 934                                                                &quot;Change msg\n\nWith several lines&quot;);
 935             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 936             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 937 
 938             // Flag it as ready for review
 939             pr.setBody(&quot;This should now be ready&quot;);
 940 
 941             // Run an archive pass
 942             TestBotRunner.runPeriodicItems(mlBot);
 943 
 944             // The archive should now contain an entry
 945             var archiveRepo = Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 946             assertTrue(archiveContains(archiveFolder.path(), editHash.abbreviate()));
 947 
 948             // And there should be a webrev comment
 949             var comments = pr.getComments();
 950             var webrevComments = comments.stream()
 951                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 952                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 953                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 954                                          .collect(Collectors.toList());
 955             assertEquals(1, webrevComments.size());
 956             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
 957 
 958             // Pretend the archive didn&#39;t work out
 959             archiveRepo.push(masterHash, archive.getUrl(), &quot;master&quot;, true);
 960 
 961             // Run another archive pass
 962             TestBotRunner.runPeriodicItems(mlBot);
 963 
 964             // The webrev comment should not contain duplicate entries
 965             comments = pr.getComments();
 966             webrevComments = comments.stream()
 967                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 968                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 969                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 970                                          .collect(Collectors.toList());
 971             assertEquals(1, webrevComments.size());
 972             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
 973         }
 974     }
 975 
 976     @Test
 977     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
 978         try (var credentials = new HostCredentials(testInfo);
 979              var tempFolder = new TemporaryDirectory();
 980              var archiveFolder = new TemporaryDirectory();
 981              var listServer = new TestMailmanServer()) {
 982             var author = credentials.getHostedRepository();
 983             var archive = credentials.getHostedRepository();
 984             var reviewer = credentials.getHostedRepository();
 985             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 986             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 987             var censusBuilder = credentials.getCensusBuilder()
 988                                            .addReviewer(reviewer.host().getCurrentUserDetails().id())
 989                                            .addAuthor(author.host().getCurrentUserDetails().id());
 990             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 991                                                  listAddress, Set.of(), Set.of(),
 992                                                  listServer.getArchive(), listServer.getSMTP(),
 993                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 994                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<a name="12" id="anc12"></a><span class="line-modified"> 995                                                  Set.of(), Map.of(), Map.of());</span>
 996 
 997             // Populate the projects repository
 998             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 999             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
1000             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1001             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
1002             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
1003 
1004             // Make a change with a corresponding PR
1005             var editHash = CheckableRepository.appendAndCommit(localRepo);
1006             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
1007             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1008             pr.setBody(&quot;This is now ready&quot;);
1009 
1010             // Run an archive pass
1011             TestBotRunner.runPeriodicItems(mlBot);
1012 
1013             // First unapprove it
1014             var reviewedPr = reviewer.getPullRequest(pr.getId());
1015             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
1016             TestBotRunner.runPeriodicItems(mlBot);
1017             TestBotRunner.runPeriodicItems(mlBot);
1018             TestBotRunner.runPeriodicItems(mlBot);
1019 
1020             // The archive should contain a note
1021             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1022             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Disapproved by &quot;));
1023             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot; by integrationreviewer1&quot;));
1024             if (author.host().supportsReviewBody()) {
1025                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
1026             }
1027 
1028             // Then approve it
1029             reviewedPr.addReview(Review.Verdict.APPROVED, &quot;Reason 2&quot;);
1030             TestBotRunner.runPeriodicItems(mlBot);
1031             TestBotRunner.runPeriodicItems(mlBot);
1032             TestBotRunner.runPeriodicItems(mlBot);
1033 
1034             // The archive should contain another note
1035             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1036             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Approved by &quot;));
1037             if (author.host().supportsReviewBody()) {
1038                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 2&quot;));
1039             }
1040             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Re: \\[Approved\\] RFR:&quot;));
1041 
1042             // Yet another change
1043             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 3&quot;);
1044             TestBotRunner.runPeriodicItems(mlBot);
1045             TestBotRunner.runPeriodicItems(mlBot);
1046             TestBotRunner.runPeriodicItems(mlBot);
1047 
1048             // The archive should contain another note
1049             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1050             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Disapproved by &quot;));
1051             if (author.host().supportsReviewBody()) {
1052                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
1053             }
1054         }
1055     }
1056 
1057     @Test
1058     void ignoreComments(TestInfo testInfo) throws IOException {
1059         try (var credentials = new HostCredentials(testInfo);
1060              var tempFolder = new TemporaryDirectory();
1061              var archiveFolder = new TemporaryDirectory();
1062              var listServer = new TestMailmanServer()) {
1063             var author = credentials.getHostedRepository();
1064             var ignored = credentials.getHostedRepository();
1065             var archive = credentials.getHostedRepository();
1066             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1067             var censusBuilder = credentials.getCensusBuilder()
1068                                            .addAuthor(author.host().getCurrentUserDetails().id());
1069             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1070             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
1071                                                  listAddress,
1072                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
1073                                                  Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)),
1074                                                  listServer.getArchive(), listServer.getSMTP(),
1075                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
1076                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<a name="13" id="anc13"></a><span class="line-modified">1077                                                  Set.of(), Map.of(), Map.of());</span>
1078 
1079             // Populate the projects repository
1080             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1081             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
1082             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1083             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
1084             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
1085 
1086             // Make a change with a corresponding PR
1087             var editHash = CheckableRepository.appendAndCommit(localRepo);
1088             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
1089             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1090             pr.setBody(&quot;This is now ready&quot;);
1091 
1092             // Make a bunch of comments
1093             pr.addComment(&quot;Plain comment&quot;);
1094             pr.addComment(&quot;ignore this comment&quot;);
1095             pr.addComment(&quot;I think it is time to\nignore this comment!&quot;);
1096             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review ignore this comment&quot;);
1097 
1098             var ignoredPR = ignored.getPullRequest(pr.getId());
1099             ignoredPR.addComment(&quot;Don&#39;t mind me&quot;);
1100 
1101             TestBotRunner.runPeriodicItems(mlBot);
1102             TestBotRunner.runPeriodicItems(mlBot);
1103 
1104             // The archive should not contain the ignored comments
1105             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1106             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
1107             assertFalse(archiveContains(archiveFolder.path(), &quot;ignore this comment&quot;));
1108             assertFalse(archiveContains(archiveFolder.path(), &quot;it is time to&quot;));
1109             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
1110             assertFalse(archiveContains(archiveFolder.path(), &quot;Review ignore&quot;));
1111         }
1112     }
1113 }
<a name="14" id="anc14"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="14" type="hidden" />
</body>
</html>