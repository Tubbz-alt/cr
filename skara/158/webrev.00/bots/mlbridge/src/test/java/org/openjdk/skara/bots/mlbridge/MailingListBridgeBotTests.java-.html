<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.mlbridge;
  24 
  25 import org.openjdk.skara.email.EmailAddress;
  26 import org.openjdk.skara.host.*;
  27 import org.openjdk.skara.host.network.URIBuilder;
  28 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  29 import org.openjdk.skara.test.*;
  30 import org.openjdk.skara.vcs.Repository;
  31 
  32 import org.junit.jupiter.api.*;
  33 
  34 import java.io.IOException;
  35 import java.nio.charset.StandardCharsets;
  36 import java.nio.file.*;
  37 import java.time.Duration;
  38 import java.util.*;
  39 import java.util.regex.Pattern;
  40 import java.util.stream.Collectors;
  41 
  42 import static org.junit.jupiter.api.Assertions.*;
  43 
  44 class MailingListBridgeBotTests {
  45     private boolean archiveContains(Path archive, String text) {
  46         return archiveContainsCount(archive, text) &gt; 0;
  47     }
  48 
  49     private int archiveContainsCount(Path archive, String text) {
  50         try {
  51             var mbox = Files.find(archive, 50, (path, attrs) -&gt; path.toString().endsWith(&quot;.mbox&quot;)).findAny();
  52             if (mbox.isEmpty()) {
  53                 return 0;
  54             }
  55             var lines = Files.readString(mbox.get(), StandardCharsets.UTF_8);
  56             var pattern = Pattern.compile(text);
  57             int count = 0;
  58             for (var line : lines.split(&quot;\\R&quot;)) {
  59                 var matcher = pattern.matcher(line);
  60                 if (matcher.find()) {
  61                     count++;
  62                 }
  63             }
  64             return count;
  65         } catch (IOException e) {
  66             return 0;
  67         }
  68     }
  69 
  70     private boolean webrevContains(Path webrev, String text) {
  71         try {
  72             var index = Files.find(webrev, 5, (path, attrs) -&gt; path.toString().endsWith(&quot;index.html&quot;)).findAny();
  73             if (index.isEmpty()) {
  74                 return false;
  75             }
  76             var lines = Files.readString(index.get(), StandardCharsets.UTF_8);
  77             return lines.contains(text);
  78         } catch (IOException e) {
  79             return false;
  80         }
  81     }
  82 
  83     private long countSubstrings(String string, String substring) {
  84         return Pattern.compile(substring).matcher(string).results().count();
  85     }
  86 
  87     private String noreplyAddress(HostedRepository repository) {
  88         return repository.host().getCurrentUserDetails().id() + &quot;+&quot; +
  89                 repository.host().getCurrentUserDetails().userName() +
  90                 &quot;@users.noreply.test&quot;;
  91     }
  92 
  93     @Test
  94     void simpleArchive(TestInfo testInfo) throws IOException {
  95         try (var credentials = new HostCredentials(testInfo);
  96              var tempFolder = new TemporaryDirectory();
  97              var archiveFolder = new TemporaryDirectory();
  98              var webrevFolder = new TemporaryDirectory();
  99              var listServer = new TestMailmanServer()) {
 100             var author = credentials.getHostedRepository();
 101             var archive = credentials.getHostedRepository();
 102             var ignored = credentials.getHostedRepository();
 103             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 104             var censusBuilder = credentials.getCensusBuilder()
 105                                            .addAuthor(author.host().getCurrentUserDetails().id());
 106             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 107             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,
 108                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 109                                                  Set.of(),
 110                                                  listServer.getArchive(), listServer.getSMTP(),
 111                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 112                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 113                                                  Set.of(&quot;rfr&quot;), Map.of(ignored.host().getCurrentUserDetails().userName(),
 114                                                                        Pattern.compile(&quot;ready&quot;)));
 115 
 116             // Populate the projects repository
 117             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
 118             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 119             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 120             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 121 
 122             // Make a change with a corresponding PR
 123             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 124                                                                &quot;Change msg\n\nWith several lines&quot;);
 125             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 126             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 127             pr.setBody(&quot;This should not be ready&quot;);
 128 
 129             // Run an archive pass
 130             TestBotRunner.runPeriodicItems(mlBot);
 131 
 132             // A PR that isn&#39;t ready for review should not be archived
 133             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 134             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 135 
 136             // Flag it as ready for review
 137             pr.setBody(&quot;This should now be ready&quot;);
 138             pr.addLabel(&quot;rfr&quot;);
 139 
 140             // Run another archive pass
 141             TestBotRunner.runPeriodicItems(mlBot);
 142 
 143             // But it should still not be archived
 144             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 145             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 146 
 147             // Now post a general comment - not a ready marker
 148             var ignoredPr = ignored.getPullRequest(pr.getId());
 149             ignoredPr.addComment(&quot;hello there&quot;);
 150 
 151             // Run another archive pass
 152             TestBotRunner.runPeriodicItems(mlBot);
 153 
 154             // It should still not be archived
 155             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 156             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 157 
 158             // Now post a ready comment
 159             ignoredPr.addComment(&quot;ready&quot;);
 160 
 161             // Run another archive pass
 162             TestBotRunner.runPeriodicItems(mlBot);
 163 
 164             // The archive should now contain an entry
 165             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 166             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 167             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
 168             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
 169             assertTrue(archiveContains(archiveFolder.path(), &quot;Changes:&quot;));
 170             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
 171             assertTrue(archiveContains(archiveFolder.path(), &quot;http://www.test.test/&quot;));
 172             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));
 173             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch:&quot;));
 174             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - &quot; + editHash.abbreviate() + &quot;: Change msg&quot;));
 175             assertFalse(archiveContains(archiveFolder.path(), &quot;With several lines&quot;));
 176 
 177             // The mailing list as well
 178             listServer.processIncoming();
 179             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 180             var mailmanList = mailmanServer.getList(listAddress.address());
 181             var conversations = mailmanList.conversations(Duration.ofDays(1));
 182             assertEquals(1, conversations.size());
 183             var mail = conversations.get(0).first();
 184             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 185             assertEquals(pr.getAuthor().fullName(), mail.author().fullName().orElseThrow());
 186             assertEquals(noreplyAddress(archive), mail.author().address());
 187             assertEquals(from, mail.sender());
 188 
 189             // And there should be a webrev
 190             Repository.materialize(webrevFolder.path(), archive.getUrl(), &quot;webrev&quot;);
 191             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
 192             var comments = pr.getComments();
 193             var webrevComments = comments.stream()
 194                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 195                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 196                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 197                                          .collect(Collectors.toList());
 198             assertEquals(1, webrevComments.size());
 199 
 200             // Add a comment
 201             pr.addComment(&quot;This is a comment :smile:&quot;);
 202 
 203             // Add a comment from an ignored user as well
 204             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);
 205 
 206             // Run another archive pass
 207             TestBotRunner.runPeriodicItems(mlBot);
 208 
 209             // The archive should now contain the comment, but not the ignored one
 210             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 211             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a comment&quot;));
 212             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This should now be ready&quot;));
 213             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 214 
 215             listServer.processIncoming();
 216             conversations = mailmanList.conversations(Duration.ofDays(1));
 217             assertEquals(1, conversations.size());
 218             assertEquals(2, conversations.get(0).allMessages().size());
 219 
 220             // Remove the rfr flag and post another comment
 221             pr.addLabel(&quot;rfr&quot;);
 222             pr.addComment(&quot;This is another comment&quot;);
 223 
 224             // Run another archive pass
 225             TestBotRunner.runPeriodicItems(mlBot);
 226 
 227             // The archive should contain the additional comment
 228             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 229             assertTrue(archiveContains(archiveFolder.path(), &quot;This is another comment&quot;));
 230             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This should now be ready&quot;));
 231 
 232             listServer.processIncoming();
 233             conversations = mailmanList.conversations(Duration.ofDays(1));
 234             assertEquals(1, conversations.size());
 235             assertEquals(3, conversations.get(0).allMessages().size());
 236             for (var newMail : conversations.get(0).allMessages()) {
 237                 assertEquals(noreplyAddress(archive), newMail.author().address());
 238                 assertEquals(from, newMail.sender());
 239             }
 240             assertTrue(conversations.get(0).allMessages().get(2).body().contains(&quot;This is a comment 😄&quot;));
 241         }
 242     }
 243 
 244     @Test
 245     void reviewComment(TestInfo testInfo) throws IOException {
 246         try (var credentials = new HostCredentials(testInfo);
 247              var tempFolder = new TemporaryDirectory();
 248              var archiveFolder = new TemporaryDirectory();
 249              var listServer = new TestMailmanServer()) {
 250             var author = credentials.getHostedRepository();
 251             var archive = credentials.getHostedRepository();
 252             var ignored = credentials.getHostedRepository();
 253             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 254             var censusBuilder = credentials.getCensusBuilder()
 255                                            .addAuthor(author.host().getCurrentUserDetails().id());
 256             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 257             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,
 258                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 259                                                  Set.of(),
 260                                                  listServer.getArchive(), listServer.getSMTP(),
 261                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 262                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 263                                                  Set.of(), Map.of());
 264 
 265             // Populate the projects repository
 266             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 267             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 268             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 269             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 270             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 271 
 272             // Make a change with a corresponding PR
 273             var editHash = CheckableRepository.appendAndCommit(localRepo);
 274             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 275             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 276             pr.setBody(&quot;This is now ready&quot;);
 277             TestBotRunner.runPeriodicItems(mlBot);
 278             listServer.processIncoming();
 279 
 280             // And make a file specific comment
 281             var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
 282             var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 283 
 284             // Add one from an ignored user as well
 285             var ignoredPr = ignored.getPullRequest(pr.getId());
 286             ignoredPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Don&#39;t mind me&quot;);
 287 
 288             // Process comments
 289             TestBotRunner.runPeriodicItems(mlBot);
 290             listServer.processIncoming();
 291 
 292             // The archive should now contain an entry
 293             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 294             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 295             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 296             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 297             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This is now ready&quot;));
 298             assertTrue(archiveContains(archiveFolder.path(), reviewFile.toString()));
 299             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 300 
 301             // The mailing list as well
 302             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 303             var mailmanList = mailmanServer.getList(listAddress.address());
 304             var conversations = mailmanList.conversations(Duration.ofDays(1));
 305             assertEquals(1, conversations.size());
 306             var mail = conversations.get(0).first();
 307             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 308 
 309             // Comment on the comment
 310             pr.addReviewCommentReply(comment, &quot;This is a review reply&quot;);
 311             TestBotRunner.runPeriodicItems(mlBot);
 312             listServer.processIncoming();
 313 
 314             // The archive should contain the additional comment (but no quoted footers)
 315             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 316             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a review reply&quot;));
 317             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This is now ready&quot;));
 318             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; PR:&quot;));
 319 
 320             // As well as the mailing list
 321             conversations = mailmanList.conversations(Duration.ofDays(1));
 322             assertEquals(1, conversations.size());
 323             assertEquals(3, conversations.get(0).allMessages().size());
 324             for (var newMail : conversations.get(0).allMessages()) {
 325                 assertEquals(noreplyAddress(archive), newMail.author().address());
 326                 assertEquals(from, newMail.sender());
 327             }
 328         }
 329     }
 330 
 331     @Test
 332     void combineComments(TestInfo testInfo) throws IOException {
 333         try (var credentials = new HostCredentials(testInfo);
 334              var tempFolder = new TemporaryDirectory();
 335              var archiveFolder = new TemporaryDirectory();
 336              var listServer = new TestMailmanServer()) {
 337             var author = credentials.getHostedRepository();
 338             var archive = credentials.getHostedRepository();
 339             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 340             var censusBuilder = credentials.getCensusBuilder()
 341                                            .addAuthor(author.host().getCurrentUserDetails().id());
 342             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 343             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 344                                                  listAddress, Set.of(), Set.of(),
 345                                                  listServer.getArchive(),
 346                                                  listServer.getSMTP(),
 347                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 348                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 349                                                  Set.of(), Map.of());
 350 
 351             // Populate the projects repository
 352             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 353             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 354             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 355             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 356             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 357 
 358             // Make a change with a corresponding PR
 359             var editHash = CheckableRepository.appendAndCommit(localRepo);
 360             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 361             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 362             pr.setBody(&quot;This is now ready&quot;);
 363             pr.addComment(&quot;Avoid combining&quot;);
 364 
 365             TestBotRunner.runPeriodicItems(mlBot);
 366             listServer.processIncoming();
 367             listServer.processIncoming();
 368 
 369             // Make two file specific comments
 370             var first = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 371             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 372             TestBotRunner.runPeriodicItems(mlBot);
 373             listServer.processIncoming();
 374 
 375             // The archive should contain a combined entry
 376             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 377             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 378 
 379             // As well as the mailing list
 380             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 381             var mailmanList = mailmanServer.getList(listAddress.address());
 382             var conversations = mailmanList.conversations(Duration.ofDays(1));
 383             assertEquals(1, conversations.size());
 384             var mail = conversations.get(0).first();
 385             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 386             assertEquals(3, conversations.get(0).allMessages().size());
 387 
 388             var commentReply = conversations.get(0).replies(mail).get(0);
 389             assertEquals(2, commentReply.body().split(&quot;^On.*wrote:&quot;).length);
 390             assertTrue(commentReply.body().contains(&quot;Avoid combining\n\n&quot;), commentReply.body());
 391 
 392             var reviewReply = conversations.get(0).replies(mail).get(1);
 393             assertEquals(2, reviewReply.body().split(&quot;^On.*wrote:&quot;).length);
 394             assertEquals(2, reviewReply.body().split(&quot;&gt; This is now ready&quot;).length, reviewReply.body());
 395             assertEquals(&quot;Re: RFR: This is a pull request&quot;, reviewReply.subject());
 396             assertTrue(reviewReply.body().contains(&quot;Review comment\n\n&quot;), reviewReply.body());
 397             assertTrue(reviewReply.body().contains(&quot;Another review comment&quot;), reviewReply.body());
 398 
 399             // Now reply to the first (collapsed) comment
 400             pr.addReviewCommentReply(first, &quot;I agree&quot;);
 401             TestBotRunner.runPeriodicItems(mlBot);
 402             listServer.processIncoming();
 403 
 404             // The archive should contain a new entry
 405             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 406             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 407         }
 408     }
 409 
 410     @Test
 411     void commentThreading(TestInfo testInfo) throws IOException {
 412         try (var credentials = new HostCredentials(testInfo);
 413              var tempFolder = new TemporaryDirectory();
 414              var archiveFolder = new TemporaryDirectory();
 415              var listServer = new TestMailmanServer()) {
 416             var author = credentials.getHostedRepository();
 417             var reviewer = credentials.getHostedRepository();
 418             var archive = credentials.getHostedRepository();
 419             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 420             var censusBuilder = credentials.getCensusBuilder()
 421                                            .addReviewer(reviewer.host().getCurrentUserDetails().id())
 422                                            .addAuthor(author.host().getCurrentUserDetails().id());
 423             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 424             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 425                                                  listAddress, Set.of(), Set.of(),
 426                                                  listServer.getArchive(),
 427                                                  listServer.getSMTP(),
 428                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 429                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 430                                                  Set.of(), Map.of());
 431 
 432             // Populate the projects repository
 433             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 434             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 435             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 436             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 437             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 438 
 439             // Make a change with a corresponding PR
 440             var editHash = CheckableRepository.appendAndCommit(localRepo);
 441             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 442             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 443             pr.setBody(&quot;This is now ready&quot;);
 444             TestBotRunner.runPeriodicItems(mlBot);
 445             listServer.processIncoming();
 446 
 447             // Make a file specific comment
 448             var reviewPr = reviewer.getPullRequest(pr.getId());
 449             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 450             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 451             reviewPr.addReviewCommentReply(comment1, &quot;Great&quot;);
 452             TestBotRunner.runPeriodicItems(mlBot);
 453             listServer.processIncoming();
 454             listServer.processIncoming();
 455             listServer.processIncoming();
 456 
 457             // And a second one by ourselves
 458             var comment2 = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 459             reviewPr.addReviewCommentReply(comment2, &quot;Sounds good&quot;);
 460             pr.addReviewCommentReply(comment2, &quot;Thanks&quot;);
 461             TestBotRunner.runPeriodicItems(mlBot);
 462             listServer.processIncoming();
 463             listServer.processIncoming();
 464             listServer.processIncoming();
 465 
 466             // Finally some approvals
 467             pr.addReview(Review.Verdict.APPROVED, &quot;Nice&quot;);
 468             reviewPr.addReview(Review.Verdict.APPROVED, &quot;Looks fine&quot;);
 469             TestBotRunner.runPeriodicItems(mlBot);
 470             listServer.processIncoming();
 471             listServer.processIncoming();
 472 
 473             // Sanity check the archive
 474             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 475             assertEquals(8, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 476 
 477             // Check the mailing list
 478             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 479             var mailmanList = mailmanServer.getList(listAddress.address());
 480             var conversations = mailmanList.conversations(Duration.ofDays(1));
 481             assertEquals(1, conversations.size());
 482             var mail = conversations.get(0).first();
 483             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 484             assertEquals(9, conversations.get(0).allMessages().size());
 485 
 486             // There should be four separate threads
 487             var thread1 = conversations.get(0).replies(mail).get(0);
 488             assertEquals(2, thread1.body().split(&quot;^On.*wrote:&quot;).length);
 489             assertEquals(2, thread1.body().split(&quot;&gt; This is now ready&quot;).length, thread1.body());
 490             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread1.subject());
 491             assertTrue(thread1.body().contains(&quot;Review comment\n\n&quot;), thread1.body());
 492             assertFalse(thread1.body().contains(&quot;Another review comment&quot;), thread1.body());
 493             var thread1reply1 = conversations.get(0).replies(thread1).get(0);
 494             assertTrue(thread1reply1.body().contains(&quot;I agree&quot;));
 495             assertEquals(noreplyAddress(archive), thread1reply1.author().address());
 496             assertEquals(archive.host().getCurrentUserDetails().fullName(), thread1reply1.author().fullName().orElseThrow());
 497             var thread1reply2 = conversations.get(0).replies(thread1reply1).get(0);
 498             assertTrue(thread1reply2.body().contains(&quot;Great&quot;));
 499             assertEquals(&quot;integrationreviewer1@openjdk.java.net&quot;, thread1reply2.author().address());
 500             assertEquals(&quot;Generated Reviewer 1&quot;, thread1reply2.author().fullName().orElseThrow());
 501 
 502             var thread2 = conversations.get(0).replies(mail).get(1);
 503             assertEquals(2, thread2.body().split(&quot;^On.*wrote:&quot;).length);
 504             assertEquals(2, thread2.body().split(&quot;&gt; This is now ready&quot;).length, thread2.body());
 505             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread2.subject());
 506             assertFalse(thread2.body().contains(&quot;Review comment\n\n&quot;), thread2.body());
 507             assertTrue(thread2.body().contains(&quot;Another review comment&quot;), thread2.body());
 508             var thread2reply1 = conversations.get(0).replies(thread2).get(0);
 509             assertTrue(thread2reply1.body().contains(&quot;Sounds good&quot;));
 510             var thread2reply2 = conversations.get(0).replies(thread2reply1).get(0);
 511             assertTrue(thread2reply2.body().contains(&quot;Thanks&quot;));
 512 
 513             var thread3 = conversations.get(0).replies(mail).get(2);
 514             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread3.subject());
 515             var thread4 = conversations.get(0).replies(mail).get(3);
 516             assertEquals(&quot;Re: [Approved] RFR: This is a pull request&quot;, thread4.subject());
 517         }
 518     }
 519 
 520     @Test
 521     void reviewContext(TestInfo testInfo) throws IOException {
 522         try (var credentials = new HostCredentials(testInfo);
 523              var tempFolder = new TemporaryDirectory();
 524              var archiveFolder = new TemporaryDirectory();
 525              var listServer = new TestMailmanServer()) {
 526             var author = credentials.getHostedRepository();
 527             var archive = credentials.getHostedRepository();
 528             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 529             var censusBuilder = credentials.getCensusBuilder()
 530                                            .addAuthor(author.host().getCurrentUserDetails().id());
 531             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 532             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 533                                                  listAddress, Set.of(), Set.of(),
 534                                                  listServer.getArchive(),
 535                                                  listServer.getSMTP(),
 536                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 537                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 538                                                  Set.of(), Map.of());
 539 
 540             // Populate the projects repository
 541             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 542             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 543             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 544             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 545             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 546 
 547             // Make a change with a corresponding PR
 548             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
 549             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 550             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 551             pr.setBody(&quot;This is now ready&quot;);
 552             TestBotRunner.runPeriodicItems(mlBot);
 553             listServer.processIncoming();
 554 
 555             // Make a file specific comment
 556             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 557 
 558             TestBotRunner.runPeriodicItems(mlBot);
 559             listServer.processIncoming();
 560 
 561             // The archive should only contain context around line 2
 562             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 563             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
 564             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
 565             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
 566         }
 567     }
 568 
 569     @Test
 570     void multipleReviewContexts(TestInfo testInfo) throws IOException {
 571         try (var credentials = new HostCredentials(testInfo);
 572              var tempFolder = new TemporaryDirectory();
 573              var archiveFolder = new TemporaryDirectory();
 574              var listServer = new TestMailmanServer()) {
 575             var author = credentials.getHostedRepository();
 576             var archive = credentials.getHostedRepository();
 577             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 578             var censusBuilder = credentials.getCensusBuilder()
 579                                            .addAuthor(author.host().getCurrentUserDetails().id());
 580             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 581             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 582                                                  listAddress, Set.of(), Set.of(),
 583                                                  listServer.getArchive(),
 584                                                  listServer.getSMTP(),
 585                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 586                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 587                                                  Set.of(), Map.of());
 588 
 589             // Populate the projects repository
 590             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 591             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 592             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 593             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 594             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 595             var initialHash = CheckableRepository.appendAndCommit(localRepo,
 596                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
 597                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
 598                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
 599                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
 600                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
 601                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
 602             localRepo.push(initialHash, author.getUrl(), &quot;master&quot;);
 603 
 604             // Make a change with a corresponding PR
 605             var current = Files.readString(localRepo.root().resolve(reviewFile), StandardCharsets.UTF_8);
 606             var updated = current.replaceAll(&quot;Line 2&quot;, &quot;Line 2 edit\nLine 2.5&quot;);
 607             updated = updated.replaceAll(&quot;Line 13&quot;, &quot;Line 12.5\nLine 13 edit&quot;);
 608             Files.writeString(localRepo.root().resolve(reviewFile), updated, StandardCharsets.UTF_8);
 609             var editHash = CheckableRepository.appendAndCommit(localRepo);
 610             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 611             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 612             pr.setBody(&quot;This is now ready&quot;);
 613             TestBotRunner.runPeriodicItems(mlBot);
 614             listServer.processIncoming();
 615 
 616             // Make file specific comments
 617             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 7, &quot;Review comment&quot;);
 618             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 24, &quot;Another review comment&quot;);
 619 
 620             TestBotRunner.runPeriodicItems(mlBot);
 621             listServer.processIncoming();
 622 
 623             // The archive should only contain context around line 2 and 20
 624             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 625             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 7&quot;));
 626             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 6: Line 1$&quot;));
 627             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 7: Line 2 edit$&quot;));
 628             assertFalse(archiveContains(archiveFolder.path(), &quot;Line 3&quot;));
 629 
 630             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 24&quot;));
 631             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 23: Line 12.5$&quot;));
 632             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 24: Line 13 edit$&quot;));
 633             assertFalse(archiveContains(archiveFolder.path(), &quot;^Line 15&quot;));
 634         }
 635     }
 636 
 637     @Test
 638     void filterComments(TestInfo testInfo) throws IOException {
 639         try (var credentials = new HostCredentials(testInfo);
 640              var tempFolder = new TemporaryDirectory();
 641              var archiveFolder = new TemporaryDirectory();
 642              var listServer = new TestMailmanServer()) {
 643             var author = credentials.getHostedRepository();
 644             var archive = credentials.getHostedRepository();
 645             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 646             var censusBuilder = credentials.getCensusBuilder()
 647                                            .addAuthor(author.host().getCurrentUserDetails().id());
 648             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 649             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 650                                                  listAddress, Set.of(), Set.of(),
 651                                                  listServer.getArchive(), listServer.getSMTP(),
 652                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 653                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 654                                                  Set.of(), Map.of());
 655 
 656             // Populate the projects repository
 657             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 658             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 659             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 660             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 661             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 662 
 663             // Make a change with a corresponding PR
 664             var editHash = CheckableRepository.appendAndCommit(localRepo);
 665             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 666             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 667             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
 668                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
 669 
 670             // Make a bunch of comments
 671             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
 672             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment &lt;!-- this is a comment --&gt;\n&quot;);
 673             pr.addComment(&quot;/integrate stuff&quot;);
 674             TestBotRunner.runPeriodicItems(mlBot);
 675 
 676             // Run an archive pass
 677             TestBotRunner.runPeriodicItems(mlBot);
 678 
 679             // The archive should not contain the comment
 680             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 681             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 682             assertFalse(archiveContains(archiveFolder.path(), &quot;this is a comment&quot;));
 683             assertFalse(archiveContains(archiveFolder.path(), &quot;Status stuff&quot;));
 684             assertTrue(archiveContains(archiveFolder.path(), &quot;And this is not&quot;));
 685             assertFalse(archiveContains(archiveFolder.path(), &quot;&lt;!--&quot;));
 686             assertFalse(archiveContains(archiveFolder.path(), &quot;--&gt;&quot;));
 687             assertTrue(archiveContains(archiveFolder.path(), &quot;Plain comment&quot;));
 688             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 689             assertFalse(archiveContains(archiveFolder.path(), &quot;/integrate&quot;));
 690         }
 691     }
 692 
 693     @Test
 694     void incrementalChanges(TestInfo testInfo) throws IOException {
 695         try (var credentials = new HostCredentials(testInfo);
 696              var tempFolder = new TemporaryDirectory();
 697              var archiveFolder = new TemporaryDirectory();
 698              var listServer = new TestMailmanServer()) {
 699             var author = credentials.getHostedRepository();
 700             var archive = credentials.getHostedRepository();
 701             var commenter = credentials.getHostedRepository();
 702             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 703             var censusBuilder = credentials.getCensusBuilder()
 704                                            .addAuthor(author.host().getCurrentUserDetails().id());
 705             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 706             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 707                                                  listAddress, Set.of(), Set.of(),
 708                                                  listServer.getArchive(), listServer.getSMTP(),
 709                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 710                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 711                                                  Set.of(), Map.of());
 712 
 713             // Populate the projects repository
 714             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 715             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 716             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 717             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 718             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 719 
 720             // Make a change with a corresponding PR
 721             var editHash = CheckableRepository.appendAndCommit(localRepo);
 722             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 723             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 724             pr.setBody(&quot;This is now ready&quot;);
 725 
 726             // Run an archive pass
 727             TestBotRunner.runPeriodicItems(mlBot);
 728             listServer.processIncoming();
 729 
 730             var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
 731             localRepo.push(nextHash, author.getUrl(), &quot;edit&quot;);
 732 
 733             // Make sure that the push registered
 734             var lastHeadHash = pr.getHeadHash();
 735             var refreshCount = 0;
 736             do {
 737                 pr = author.getPullRequest(pr.getId());
 738                 if (refreshCount++ &gt; 100) {
 739                     fail(&quot;The PR did not update after the new push&quot;);
 740                 }
 741             } while (pr.getHeadHash().equals(lastHeadHash));
 742 
 743             // Run another archive pass
 744             TestBotRunner.runPeriodicItems(mlBot);
 745             TestBotRunner.runPeriodicItems(mlBot);
 746             TestBotRunner.runPeriodicItems(mlBot);
 747             listServer.processIncoming();
 748 
 749             // The archive should reference the updated push
 750             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 751             assertTrue(archiveContains(archiveFolder.path(), &quot;additional changes&quot;));
 752             assertTrue(archiveContains(archiveFolder.path(), &quot;full.*/&quot; + pr.getId() + &quot;/webrev.01&quot;));
 753             assertTrue(archiveContains(archiveFolder.path(), &quot;inc.*/&quot; + pr.getId() + &quot;/webrev.00-01&quot;));
 754             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
 755             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
 756             assertTrue(archiveContains(archiveFolder.path(), &quot;Fixing&quot;));
 757 
 758             // The webrev comment should be updated
 759             var comments = pr.getComments();
 760             var webrevComments = comments.stream()
 761                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 762                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 763                                          .filter(comment -&gt; comment.body().contains(nextHash.hex()))
 764                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 765                                          .collect(Collectors.toList());
 766             assertEquals(1, webrevComments.size());
 767 
 768             // Check that sender address is set properly
 769             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 770             var mailmanList = mailmanServer.getList(listAddress.address());
 771             var conversations = mailmanList.conversations(Duration.ofDays(1));
 772             assertEquals(1, conversations.size());
 773             for (var newMail : conversations.get(0).allMessages()) {
 774                 assertEquals(noreplyAddress(archive), newMail.author().address());
 775                 assertEquals(from, newMail.sender());
 776             }
 777 
 778             // Add a comment
 779             var commenterPr = commenter.getPullRequest(pr.getId());
 780             commenterPr.addReviewComment(masterHash, nextHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 781             TestBotRunner.runPeriodicItems(mlBot);
 782             listServer.processIncoming();
 783 
 784             // Ensure that additional updates are only reported once
 785             for (int i = 0; i &lt; 3; ++i) {
 786                 var anotherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fixing&quot;);
 787                 localRepo.push(anotherHash, author.getUrl(), &quot;edit&quot;);
 788 
 789                 // Make sure that the push registered
 790                 lastHeadHash = pr.getHeadHash();
 791                 refreshCount = 0;
 792                 do {
 793                     pr = author.getPullRequest(pr.getId());
 794                     if (refreshCount++ &gt; 100) {
 795                         fail(&quot;The PR did not update after the new push&quot;);
 796                     }
 797                 } while (pr.getHeadHash().equals(lastHeadHash));
 798 
 799                 TestBotRunner.runPeriodicItems(mlBot);
 800                 TestBotRunner.runPeriodicItems(mlBot);
 801                 listServer.processIncoming();
 802             }
 803             var updatedConversations = mailmanList.conversations(Duration.ofDays(1));
 804             assertEquals(1, updatedConversations.size());
 805             var conversation = updatedConversations.get(0);
 806             assertEquals(6, conversation.allMessages().size());
 807             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(1).subject());
 808             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(2).subject(), conversation.allMessages().get(2).toString());
 809             assertEquals(&quot;Re: [Rev 04] RFR: This is a pull request&quot;, conversation.allMessages().get(5).subject());
 810         }
 811     }
 812 
 813     @Test
 814     void rebased(TestInfo testInfo) throws IOException {
 815         try (var credentials = new HostCredentials(testInfo);
 816              var tempFolder = new TemporaryDirectory();
 817              var archiveFolder = new TemporaryDirectory();
 818              var listServer = new TestMailmanServer()) {
 819             var author = credentials.getHostedRepository();
 820             var archive = credentials.getHostedRepository();
 821             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 822             var censusBuilder = credentials.getCensusBuilder()
 823                                            .addAuthor(author.host().getCurrentUserDetails().id());
 824             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 825             var mlBot = new MailingListBridgeBot(sender, author, archive, censusBuilder.build(), &quot;master&quot;,
 826                                                  listAddress, Set.of(), Set.of(),
 827                                                  listServer.getArchive(), listServer.getSMTP(),
 828                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 829                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 830                                                  Set.of(), Map.of());
 831 
 832             // Populate the projects repository
 833             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 834             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.getRepositoryType(), reviewFile);
 835             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 836             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 837             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 838 
 839             // Make a change with a corresponding PR
 840             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
 841             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 842             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 843             pr.setBody(&quot;This is now ready&quot;);
 844 
 845             // Run an archive pass
 846             TestBotRunner.runPeriodicItems(mlBot);
 847             listServer.processIncoming();
 848 
 849             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.getUrl(), &quot;master&quot;);
 850             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
 851             newLocalRepo.push(newEditHash, author.getUrl(), &quot;edit&quot;, true);
 852 
 853             // Make sure that the push registered
 854             var lastHeadHash = pr.getHeadHash();
 855             var refreshCount = 0;
 856             do {
 857                 pr = author.getPullRequest(pr.getId());
 858                 if (refreshCount++ &gt; 100) {
 859                     fail(&quot;The PR did not update after the new push&quot;);
 860                 }
 861             } while (pr.getHeadHash().equals(lastHeadHash));
 862 
 863             // Run another archive pass
 864             TestBotRunner.runPeriodicItems(mlBot);
 865             listServer.processIncoming();
 866 
 867             // The archive should reference the rebased push
 868             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 869             assertTrue(archiveContains(archiveFolder.path(), &quot;complete new set of changes&quot;));
 870             assertTrue(archiveContains(archiveFolder.path(), pr.getId() + &quot;/webrev.01&quot;));
 871             assertFalse(archiveContains(archiveFolder.path(), &quot;Incremental&quot;));
 872             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
 873             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
 874             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
 875             assertTrue(archiveContains(archiveFolder.path(), &quot;Replaced msg&quot;));
 876 
 877             // The webrev comment should be updated
 878             var comments = pr.getComments();
 879             var webrevComments = comments.stream()
 880                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 881                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 882                                          .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
 883                                          .collect(Collectors.toList());
 884             assertEquals(1, webrevComments.size());
 885 
 886             // Check that sender address is set properly
 887             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 888             var mailmanList = mailmanServer.getList(listAddress.address());
 889             var conversations = mailmanList.conversations(Duration.ofDays(1));
 890             assertEquals(1, conversations.size());
 891             for (var newMail : conversations.get(0).allMessages()) {
 892                 assertEquals(noreplyAddress(archive), newMail.author().address());
 893                 assertEquals(sender, newMail.sender());
 894                 assertFalse(newMail.hasHeader(&quot;PR-Head-Hash&quot;));
 895             }
 896             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversations.get(0).allMessages().get(1).subject());
 897         }
 898     }
 899 
 900     @Test
 901     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
 902         try (var credentials = new HostCredentials(testInfo);
 903              var tempFolder = new TemporaryDirectory();
 904              var archiveFolder = new TemporaryDirectory();
 905              var webrevFolder = new TemporaryDirectory();
 906              var listServer = new TestMailmanServer()) {
 907             var author = credentials.getHostedRepository();
 908             var archive = credentials.getHostedRepository();
 909             var ignored = credentials.getHostedRepository();
 910             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 911             var censusBuilder = credentials.getCensusBuilder()
 912                                            .addAuthor(author.host().getCurrentUserDetails().id());
 913             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 914             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 915                                                  listAddress,
 916                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 917                                                  Set.of(),
 918                                                  listServer.getArchive(), listServer.getSMTP(),
 919                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 920                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 921                                                  Set.of(), Map.of());
 922 
 923             // Populate the projects repository
 924             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
 925             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 926             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 927             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 928 
 929             // Make a change with a corresponding PR
 930             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 931                                                                &quot;Change msg\n\nWith several lines&quot;);
 932             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 933             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 934 
 935             // Flag it as ready for review
 936             pr.setBody(&quot;This should now be ready&quot;);
 937 
 938             // Run an archive pass
 939             TestBotRunner.runPeriodicItems(mlBot);
 940 
 941             // The archive should now contain an entry
 942             var archiveRepo = Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 943             assertTrue(archiveContains(archiveFolder.path(), editHash.abbreviate()));
 944 
 945             // And there should be a webrev comment
 946             var comments = pr.getComments();
 947             var webrevComments = comments.stream()
 948                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 949                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 950                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 951                                          .collect(Collectors.toList());
 952             assertEquals(1, webrevComments.size());
 953             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
 954 
 955             // Pretend the archive didn&#39;t work out
 956             archiveRepo.push(masterHash, archive.getUrl(), &quot;master&quot;, true);
 957 
 958             // Run another archive pass
 959             TestBotRunner.runPeriodicItems(mlBot);
 960 
 961             // The webrev comment should not contain duplicate entries
 962             comments = pr.getComments();
 963             webrevComments = comments.stream()
 964                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 965                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 966                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 967                                          .collect(Collectors.toList());
 968             assertEquals(1, webrevComments.size());
 969             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
 970         }
 971     }
 972 
 973     @Test
 974     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
 975         try (var credentials = new HostCredentials(testInfo);
 976              var tempFolder = new TemporaryDirectory();
 977              var archiveFolder = new TemporaryDirectory();
 978              var listServer = new TestMailmanServer()) {
 979             var author = credentials.getHostedRepository();
 980             var archive = credentials.getHostedRepository();
 981             var reviewer = credentials.getHostedRepository();
 982             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 983             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 984             var censusBuilder = credentials.getCensusBuilder()
 985                                            .addReviewer(reviewer.host().getCurrentUserDetails().id())
 986                                            .addAuthor(author.host().getCurrentUserDetails().id());
 987             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 988                                                  listAddress, Set.of(), Set.of(),
 989                                                  listServer.getArchive(), listServer.getSMTP(),
 990                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 991                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 992                                                  Set.of(), Map.of());
 993 
 994             // Populate the projects repository
 995             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 996             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 997             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 998             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 999             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
1000 
1001             // Make a change with a corresponding PR
1002             var editHash = CheckableRepository.appendAndCommit(localRepo);
1003             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
1004             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1005             pr.setBody(&quot;This is now ready&quot;);
1006 
1007             // Run an archive pass
1008             TestBotRunner.runPeriodicItems(mlBot);
1009 
1010             // First unapprove it
1011             var reviewedPr = reviewer.getPullRequest(pr.getId());
1012             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
1013             TestBotRunner.runPeriodicItems(mlBot);
1014             TestBotRunner.runPeriodicItems(mlBot);
1015             TestBotRunner.runPeriodicItems(mlBot);
1016 
1017             // The archive should contain a note
1018             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1019             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Disapproved by &quot;));
1020             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot; by integrationreviewer1&quot;));
1021             if (author.host().supportsReviewBody()) {
1022                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
1023             }
1024 
1025             // Then approve it
1026             reviewedPr.addReview(Review.Verdict.APPROVED, &quot;Reason 2&quot;);
1027             TestBotRunner.runPeriodicItems(mlBot);
1028             TestBotRunner.runPeriodicItems(mlBot);
1029             TestBotRunner.runPeriodicItems(mlBot);
1030 
1031             // The archive should contain another note
1032             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1033             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Approved by &quot;));
1034             if (author.host().supportsReviewBody()) {
1035                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 2&quot;));
1036             }
1037             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Re: \\[Approved\\] RFR:&quot;));
1038 
1039             // Yet another change
1040             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 3&quot;);
1041             TestBotRunner.runPeriodicItems(mlBot);
1042             TestBotRunner.runPeriodicItems(mlBot);
1043             TestBotRunner.runPeriodicItems(mlBot);
1044 
1045             // The archive should contain another note
1046             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1047             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Disapproved by &quot;));
1048             if (author.host().supportsReviewBody()) {
1049                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
1050             }
1051         }
1052     }
1053 
1054     @Test
1055     void ignoreComments(TestInfo testInfo) throws IOException {
1056         try (var credentials = new HostCredentials(testInfo);
1057              var tempFolder = new TemporaryDirectory();
1058              var archiveFolder = new TemporaryDirectory();
1059              var listServer = new TestMailmanServer()) {
1060             var author = credentials.getHostedRepository();
1061             var ignored = credentials.getHostedRepository();
1062             var archive = credentials.getHostedRepository();
1063             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1064             var censusBuilder = credentials.getCensusBuilder()
1065                                            .addAuthor(author.host().getCurrentUserDetails().id());
1066             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1067             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
1068                                                  listAddress,
1069                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
1070                                                  Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)),
1071                                                  listServer.getArchive(), listServer.getSMTP(),
1072                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
1073                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
1074                                                  Set.of(), Map.of());
1075 
1076             // Populate the projects repository
1077             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1078             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
1079             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1080             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
1081             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
1082 
1083             // Make a change with a corresponding PR
1084             var editHash = CheckableRepository.appendAndCommit(localRepo);
1085             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
1086             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1087             pr.setBody(&quot;This is now ready&quot;);
1088 
1089             // Make a bunch of comments
1090             pr.addComment(&quot;Plain comment&quot;);
1091             pr.addComment(&quot;ignore this comment&quot;);
1092             pr.addComment(&quot;I think it is time to\nignore this comment!&quot;);
1093             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review ignore this comment&quot;);
1094 
1095             var ignoredPR = ignored.getPullRequest(pr.getId());
1096             ignoredPR.addComment(&quot;Don&#39;t mind me&quot;);
1097 
1098             TestBotRunner.runPeriodicItems(mlBot);
1099             TestBotRunner.runPeriodicItems(mlBot);
1100 
1101             // The archive should not contain the ignored comments
1102             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1103             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
1104             assertFalse(archiveContains(archiveFolder.path(), &quot;ignore this comment&quot;));
1105             assertFalse(archiveContains(archiveFolder.path(), &quot;it is time to&quot;));
1106             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
1107             assertFalse(archiveContains(archiveFolder.path(), &quot;Review ignore&quot;));
1108         }
1109     }
1110 }
    </pre>
  </body>
</html>