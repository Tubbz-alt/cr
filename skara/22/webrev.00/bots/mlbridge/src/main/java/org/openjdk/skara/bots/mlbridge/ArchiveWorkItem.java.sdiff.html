<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/ArchiveWorkItem.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/ArchiveWorkItem.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
159         }
160         return filteredBody + &quot;\n\n&quot; +
161                 infoSeparator + &quot;\n\n&quot; +
162                 &quot;Commits:\n&quot; +
163                 commitMessages + &quot;\n\n&quot; +
164                 &quot;Pull request:\n&quot; +
165                 pr.getWebUrl() + &quot;\n\n&quot; +
166                 &quot;Webrev:\n&quot; +
167                 webrev.toString() + &quot;\n\n&quot; +
168                 &quot;Patch:\n&quot; +
169                 prInstance.diffUrl() + &quot;\n\n&quot; +
170                 &quot;Fetch command:\n&quot; +
171                 prInstance.fetchCommand();
172     }
173 
174     private String composeReply(ZonedDateTime date, EmailAddress author, String parentBody, String body) {
175         return &quot;On &quot; + date.format(DateTimeFormatter.RFC_1123_DATE_TIME) + &quot;, &quot; + author.toString() + &quot; wrote:\n&quot; +
176                 &quot;\n&quot; +
177                 quoteBody(parentBody) +
178                 &quot;\n\n&quot; +
<span class="line-modified">179                 filterComments(body);</span>


180     }
181 
182     private String verdictToString(Review.Verdict verdict) {
183         switch (verdict) {
184             case APPROVED:
185                 return &quot;changes are approved&quot;;
186             case DISAPPROVED:
187                 return &quot;more changes are needed&quot;;
188             case NONE:
189                 return &quot;a comment has been added&quot;;
190             default:
191                 throw new RuntimeException(&quot;Unknown verdict: &quot; + verdict);
192         }
193     }
194 
195     private String composeReview(ZonedDateTime date, EmailAddress parentAuthor, String parentBody, Review review) {
196         var body = new StringBuilder();
197         var author = getAuthorAddress(review.reviewer());
198         body.append(&quot;This PR has been reviewed by &quot;);
199         body.append(author.fullName().orElse(author.localPart()));
</pre>
<hr />
<pre>
192         }
193     }
194 
195     private String composeReview(ZonedDateTime date, EmailAddress parentAuthor, String parentBody, Review review) {
196         var body = new StringBuilder();
197         var author = getAuthorAddress(review.reviewer());
198         body.append(&quot;This PR has been reviewed by &quot;);
199         body.append(author.fullName().orElse(author.localPart()));
200         body.append(&quot; - &quot;);
201         body.append(verdictToString(review.verdict()));
202         body.append(&quot;.&quot;);
203         if (review.body().isPresent()) {
204             body.append(&quot; Review comment:\n\n&quot;);
205             body.append(review.body().get());
206         }
207 
208         return &quot;On &quot; + date.format(DateTimeFormatter.RFC_1123_DATE_TIME) + &quot;, &quot; + parentAuthor.toString() + &quot; wrote:\n&quot; +
209                 &quot;\n&quot; +
210                 quoteBody(parentBody) +
211                 &quot;\n\n&quot; +
<span class="line-modified">212                 filterComments(body.toString());</span>


213     }
214 
215     private String composeRebaseComment(Hash lastBase, PullRequestInstance prInstance, URI fullWebrev) {
216         var commitMessages = prInstance.formatCommitMessages(prInstance.baseHash(), prInstance.headHash(), this::formatCommit);
217         return &quot;The pull request has been updated with a complete new set of changes (possibly due to a rebase).\n\n&quot; +
218                 infoSeparator + &quot;\n\n&quot; +
219                 &quot;Commits:\n&quot; +
220                 commitMessages + &quot;\n\n&quot; +
221                 &quot;Pull request:\n&quot; +
222                 pr.getWebUrl() + &quot;\n\n&quot; +
223                 &quot;Webrev:\n&quot; +
224                 fullWebrev.toString() + &quot;\n\n&quot; +
225                 &quot;Updated full patch:\n&quot; +
226                 prInstance.diffUrl() + &quot;\n\n&quot; +
227                 &quot;Fetch command:\n&quot; +
228                 prInstance.fetchCommand();
229     }
230 
231     private String composeIncrementalComment(Hash lastHead, PullRequestInstance prInstance, URI fullWebrev, URI incrementalWebrev) {
232         var newCommitMessages = prInstance.formatCommitMessages(lastHead, prInstance.headHash(), this::formatCommit);
</pre>
<hr />
<pre>
230 
231     private String composeIncrementalComment(Hash lastHead, PullRequestInstance prInstance, URI fullWebrev, URI incrementalWebrev) {
232         var newCommitMessages = prInstance.formatCommitMessages(lastHead, prInstance.headHash(), this::formatCommit);
233         return &quot;The pull request has been updated with additional changes.\n\n&quot; +
234                 infoSeparator + &quot;\n\n&quot; +
235                 &quot;Added commits:\n&quot; +
236                 newCommitMessages + &quot;\n\n&quot; +
237                 &quot;Pull request:\n&quot; +
238                 pr.getWebUrl() + &quot;\n\n&quot; +
239                 &quot;Webrevs:\n&quot; +
240                 &quot; - full: &quot; + fullWebrev.toString() + &quot;\n&quot; +
241                 &quot; - inc: &quot; + incrementalWebrev.toString() + &quot;\n\n&quot; +
242                 &quot;Updated full patch:\n&quot; +
243                 prInstance.diffUrl() + &quot;\n\n&quot; +
244                 &quot;Fetch command:\n&quot; +
245                 prInstance.fetchCommand();
246     }
247 
248     private String composeReadyForIntegrationComment() {
249         return &quot;This PR now fulfills all the requirements for integration, and is only awaiting the final &quot; +
<span class="line-modified">250                 &quot;integration command from the author.&quot;;</span>


251     }
252 
253     private Repository materializeArchive(Path scratchPath) {
254         try {
255             return Repository.materialize(scratchPath, bot.archiveRepo().getUrl(), pr.getTargetRef());
256         } catch (IOException e) {
257             throw new UncheckedIOException(e);
258         }
259     }
260 
261     private final static Pattern commandPattern = Pattern.compile(&quot;^/.*$&quot;);
262 
263     private boolean ignoreComment(HostUserDetails author, String body) {
264         if (pr.repository().host().getCurrentUserDetails().equals(author)) {
265             return true;
266         }
267         if (bot.ignoredUsers().contains(author.userName())) {
268             return true;
269         }
270         var commandMatcher = commandPattern.matcher(body);
</pre>
</td>
<td>
<hr />
<pre>
159         }
160         return filteredBody + &quot;\n\n&quot; +
161                 infoSeparator + &quot;\n\n&quot; +
162                 &quot;Commits:\n&quot; +
163                 commitMessages + &quot;\n\n&quot; +
164                 &quot;Pull request:\n&quot; +
165                 pr.getWebUrl() + &quot;\n\n&quot; +
166                 &quot;Webrev:\n&quot; +
167                 webrev.toString() + &quot;\n\n&quot; +
168                 &quot;Patch:\n&quot; +
169                 prInstance.diffUrl() + &quot;\n\n&quot; +
170                 &quot;Fetch command:\n&quot; +
171                 prInstance.fetchCommand();
172     }
173 
174     private String composeReply(ZonedDateTime date, EmailAddress author, String parentBody, String body) {
175         return &quot;On &quot; + date.format(DateTimeFormatter.RFC_1123_DATE_TIME) + &quot;, &quot; + author.toString() + &quot; wrote:\n&quot; +
176                 &quot;\n&quot; +
177                 quoteBody(parentBody) +
178                 &quot;\n\n&quot; +
<span class="line-modified">179                 filterComments(body) +</span>
<span class="line-added">180                 &quot;\n\n&quot; +</span>
<span class="line-added">181                 &quot;PR: &quot; + pr.getWebUrl();</span>
182     }
183 
184     private String verdictToString(Review.Verdict verdict) {
185         switch (verdict) {
186             case APPROVED:
187                 return &quot;changes are approved&quot;;
188             case DISAPPROVED:
189                 return &quot;more changes are needed&quot;;
190             case NONE:
191                 return &quot;a comment has been added&quot;;
192             default:
193                 throw new RuntimeException(&quot;Unknown verdict: &quot; + verdict);
194         }
195     }
196 
197     private String composeReview(ZonedDateTime date, EmailAddress parentAuthor, String parentBody, Review review) {
198         var body = new StringBuilder();
199         var author = getAuthorAddress(review.reviewer());
200         body.append(&quot;This PR has been reviewed by &quot;);
201         body.append(author.fullName().orElse(author.localPart()));
</pre>
<hr />
<pre>
194         }
195     }
196 
197     private String composeReview(ZonedDateTime date, EmailAddress parentAuthor, String parentBody, Review review) {
198         var body = new StringBuilder();
199         var author = getAuthorAddress(review.reviewer());
200         body.append(&quot;This PR has been reviewed by &quot;);
201         body.append(author.fullName().orElse(author.localPart()));
202         body.append(&quot; - &quot;);
203         body.append(verdictToString(review.verdict()));
204         body.append(&quot;.&quot;);
205         if (review.body().isPresent()) {
206             body.append(&quot; Review comment:\n\n&quot;);
207             body.append(review.body().get());
208         }
209 
210         return &quot;On &quot; + date.format(DateTimeFormatter.RFC_1123_DATE_TIME) + &quot;, &quot; + parentAuthor.toString() + &quot; wrote:\n&quot; +
211                 &quot;\n&quot; +
212                 quoteBody(parentBody) +
213                 &quot;\n\n&quot; +
<span class="line-modified">214                 filterComments(body.toString()) +</span>
<span class="line-added">215                 &quot;\n\n&quot; +</span>
<span class="line-added">216                 &quot;PR: &quot; + pr.getWebUrl();</span>
217     }
218 
219     private String composeRebaseComment(Hash lastBase, PullRequestInstance prInstance, URI fullWebrev) {
220         var commitMessages = prInstance.formatCommitMessages(prInstance.baseHash(), prInstance.headHash(), this::formatCommit);
221         return &quot;The pull request has been updated with a complete new set of changes (possibly due to a rebase).\n\n&quot; +
222                 infoSeparator + &quot;\n\n&quot; +
223                 &quot;Commits:\n&quot; +
224                 commitMessages + &quot;\n\n&quot; +
225                 &quot;Pull request:\n&quot; +
226                 pr.getWebUrl() + &quot;\n\n&quot; +
227                 &quot;Webrev:\n&quot; +
228                 fullWebrev.toString() + &quot;\n\n&quot; +
229                 &quot;Updated full patch:\n&quot; +
230                 prInstance.diffUrl() + &quot;\n\n&quot; +
231                 &quot;Fetch command:\n&quot; +
232                 prInstance.fetchCommand();
233     }
234 
235     private String composeIncrementalComment(Hash lastHead, PullRequestInstance prInstance, URI fullWebrev, URI incrementalWebrev) {
236         var newCommitMessages = prInstance.formatCommitMessages(lastHead, prInstance.headHash(), this::formatCommit);
</pre>
<hr />
<pre>
234 
235     private String composeIncrementalComment(Hash lastHead, PullRequestInstance prInstance, URI fullWebrev, URI incrementalWebrev) {
236         var newCommitMessages = prInstance.formatCommitMessages(lastHead, prInstance.headHash(), this::formatCommit);
237         return &quot;The pull request has been updated with additional changes.\n\n&quot; +
238                 infoSeparator + &quot;\n\n&quot; +
239                 &quot;Added commits:\n&quot; +
240                 newCommitMessages + &quot;\n\n&quot; +
241                 &quot;Pull request:\n&quot; +
242                 pr.getWebUrl() + &quot;\n\n&quot; +
243                 &quot;Webrevs:\n&quot; +
244                 &quot; - full: &quot; + fullWebrev.toString() + &quot;\n&quot; +
245                 &quot; - inc: &quot; + incrementalWebrev.toString() + &quot;\n\n&quot; +
246                 &quot;Updated full patch:\n&quot; +
247                 prInstance.diffUrl() + &quot;\n\n&quot; +
248                 &quot;Fetch command:\n&quot; +
249                 prInstance.fetchCommand();
250     }
251 
252     private String composeReadyForIntegrationComment() {
253         return &quot;This PR now fulfills all the requirements for integration, and is only awaiting the final &quot; +
<span class="line-modified">254                 &quot;integration command from the author.&quot; +</span>
<span class="line-added">255                 &quot;\n\n&quot; +</span>
<span class="line-added">256                 &quot;PR: &quot; + pr.getWebUrl();</span>
257     }
258 
259     private Repository materializeArchive(Path scratchPath) {
260         try {
261             return Repository.materialize(scratchPath, bot.archiveRepo().getUrl(), pr.getTargetRef());
262         } catch (IOException e) {
263             throw new UncheckedIOException(e);
264         }
265     }
266 
267     private final static Pattern commandPattern = Pattern.compile(&quot;^/.*$&quot;);
268 
269     private boolean ignoreComment(HostUserDetails author, String body) {
270         if (pr.repository().host().getCurrentUserDetails().equals(author)) {
271             return true;
272         }
273         if (bot.ignoredUsers().contains(author.userName())) {
274             return true;
275         }
276         var commandMatcher = commandPattern.matcher(body);
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>