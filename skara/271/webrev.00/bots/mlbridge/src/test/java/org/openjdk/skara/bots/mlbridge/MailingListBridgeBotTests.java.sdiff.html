<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="MailingListArchiveReaderBotTests.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../pr/src/main/java/org/openjdk/skara/bots/pr/CensusInstance.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  95     private String noreplyAddress(HostedRepository repository) {
  96         return &quot;test+&quot; + repository.forge().currentUser().id() + &quot;+&quot; +
  97                 repository.forge().currentUser().userName() +
  98                 &quot;@openjdk.java.net&quot;;
  99     }
 100 
 101     @Test
 102     void simpleArchive(TestInfo testInfo) throws IOException {
 103         try (var credentials = new HostCredentials(testInfo);
 104              var tempFolder = new TemporaryDirectory();
 105              var archiveFolder = new TemporaryDirectory();
 106              var webrevFolder = new TemporaryDirectory();
 107              var listServer = new TestMailmanServer()) {
 108             var author = credentials.getHostedRepository();
 109             var archive = credentials.getHostedRepository();
 110             var ignored = credentials.getHostedRepository();
 111             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 112             var censusBuilder = credentials.getCensusBuilder()
 113                                            .addAuthor(author.forge().currentUser().id());
 114             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 115             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,</span>

 116                                                  Set.of(ignored.forge().currentUser().userName()),
 117                                                  Set.of(),
 118                                                  listServer.getArchive(), listServer.getSMTP(),
 119                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 120                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 121                                                  Set.of(&quot;rfr&quot;), Map.of(ignored.forge().currentUser().userName(),
 122                                                                        Pattern.compile(&quot;ready&quot;)),
 123                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 124                                                  Map.of(&quot;Extra1&quot;, &quot;val1&quot;, &quot;Extra2&quot;, &quot;val2&quot;),
 125                                                  Duration.ZERO);
 126 
 127             // Populate the projects repository
 128             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 129             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 130             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 131             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 132 
 133             // Make a change with a corresponding PR
 134             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 135                                                                &quot;Change msg\n\nWith several lines&quot;);
</pre>
<hr />
<pre>
 252                 assertEquals(noreplyAddress(archive), newMail.author().address());
 253                 assertEquals(listAddress, newMail.sender());
 254             }
 255             assertTrue(conversations.get(0).allMessages().get(2).body().contains(&quot;This is a comment ðŸ˜„&quot;));
 256         }
 257     }
 258 
 259     @Test
 260     void reviewComment(TestInfo testInfo) throws IOException {
 261         try (var credentials = new HostCredentials(testInfo);
 262              var tempFolder = new TemporaryDirectory();
 263              var archiveFolder = new TemporaryDirectory();
 264              var listServer = new TestMailmanServer()) {
 265             var author = credentials.getHostedRepository();
 266             var archive = credentials.getHostedRepository();
 267             var ignored = credentials.getHostedRepository();
 268             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 269             var censusBuilder = credentials.getCensusBuilder()
 270                                            .addAuthor(author.forge().currentUser().id());
 271             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 272             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,</span>

 273                                                  Set.of(ignored.forge().currentUser().userName()),
 274                                                  Set.of(),
 275                                                  listServer.getArchive(), listServer.getSMTP(),
 276                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 277                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 278                                                  Set.of(), Map.of(),
 279                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 280                                                  Map.of(), Duration.ZERO);
 281 
 282             // Populate the projects repository
 283             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 284             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 285             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 286             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 287             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 288 
 289             // Make a change with a corresponding PR
 290             var editHash = CheckableRepository.appendAndCommit(localRepo);
 291             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 292             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
</pre>
<hr />
<pre>
 340             assertEquals(3, conversations.get(0).allMessages().size());
 341             for (var newMail : conversations.get(0).allMessages()) {
 342                 assertEquals(noreplyAddress(archive), newMail.author().address());
 343                 assertEquals(listAddress, newMail.sender());
 344             }
 345         }
 346     }
 347 
 348     @Test
 349     void combineComments(TestInfo testInfo) throws IOException {
 350         try (var credentials = new HostCredentials(testInfo);
 351              var tempFolder = new TemporaryDirectory();
 352              var archiveFolder = new TemporaryDirectory();
 353              var listServer = new TestMailmanServer()) {
 354             var author = credentials.getHostedRepository();
 355             var archive = credentials.getHostedRepository();
 356             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 357             var censusBuilder = credentials.getCensusBuilder()
 358                                            .addAuthor(author.forge().currentUser().id());
 359             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 360             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,</span>

 361                                                  listAddress, Set.of(), Set.of(),
 362                                                  listServer.getArchive(),
 363                                                  listServer.getSMTP(),
 364                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 365                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 366                                                  Set.of(), Map.of(),
 367                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 368                                                  Map.of(), Duration.ZERO);
 369 
 370             // Populate the projects repository
 371             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 372             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 373             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 374             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 375             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 376 
 377             // Make a change with a corresponding PR
 378             var editHash = CheckableRepository.appendAndCommit(localRepo);
 379             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 380             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
</pre>
<hr />
<pre>
 428 
 429             // The combined review comments should only appear unquoted once
 430             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^Another review comment&quot;));
 431         }
 432     }
 433 
 434     @Test
 435     void commentThreading(TestInfo testInfo) throws IOException {
 436         try (var credentials = new HostCredentials(testInfo);
 437              var tempFolder = new TemporaryDirectory();
 438              var archiveFolder = new TemporaryDirectory();
 439              var listServer = new TestMailmanServer()) {
 440             var author = credentials.getHostedRepository();
 441             var reviewer = credentials.getHostedRepository();
 442             var archive = credentials.getHostedRepository();
 443             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 444             var censusBuilder = credentials.getCensusBuilder()
 445                                            .addReviewer(reviewer.forge().currentUser().id())
 446                                            .addAuthor(author.forge().currentUser().id());
 447             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 448             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,</span>

 449                                                  listAddress, Set.of(), Set.of(),
 450                                                  listServer.getArchive(),
 451                                                  listServer.getSMTP(),
 452                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 453                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 454                                                  Set.of(), Map.of(),
 455                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 456                                                  Map.of(), Duration.ZERO);
 457 
 458             // Populate the projects repository
 459             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 460             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 461             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 462             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 463             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 464 
 465             // Make a change with a corresponding PR
 466             var editHash = CheckableRepository.appendAndCommit(localRepo);
 467             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 468             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
</pre>
<hr />
<pre>
 549             var thread4 = replies.get(3);
 550             assertEquals(&quot;Re: [Approved] RFR: This is a pull request&quot;, thread4.subject());
 551             assertTrue(thread4.body().contains(&quot;Looks fine&quot;));
 552             assertTrue(thread4.body().contains(&quot;The final review comment&quot;));
 553             assertTrue(thread4.body().contains(&quot;Approved by integrationreviewer1 (Reviewer)&quot;));
 554         }
 555     }
 556 
 557     @Test
 558     void reviewContext(TestInfo testInfo) throws IOException {
 559         try (var credentials = new HostCredentials(testInfo);
 560              var tempFolder = new TemporaryDirectory();
 561              var archiveFolder = new TemporaryDirectory();
 562              var listServer = new TestMailmanServer()) {
 563             var author = credentials.getHostedRepository();
 564             var archive = credentials.getHostedRepository();
 565             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 566             var censusBuilder = credentials.getCensusBuilder()
 567                                            .addAuthor(author.forge().currentUser().id());
 568             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 569             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,</span>

 570                                                  listAddress, Set.of(), Set.of(),
 571                                                  listServer.getArchive(),
 572                                                  listServer.getSMTP(),
 573                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 574                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 575                                                  Set.of(), Map.of(),
 576                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 577                                                  Map.of(), Duration.ZERO);
 578 
 579             // Populate the projects repository
 580             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 581             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 582             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 583             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 584             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 585 
 586             // Make a change with a corresponding PR
 587             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
 588             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 589             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
</pre>
<hr />
<pre>
 600             // The archive should only contain context around line 2
 601             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 602             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
 603             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
 604             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
 605         }
 606     }
 607 
 608     @Test
 609     void multipleReviewContexts(TestInfo testInfo) throws IOException {
 610         try (var credentials = new HostCredentials(testInfo);
 611              var tempFolder = new TemporaryDirectory();
 612              var archiveFolder = new TemporaryDirectory();
 613              var listServer = new TestMailmanServer()) {
 614             var author = credentials.getHostedRepository();
 615             var archive = credentials.getHostedRepository();
 616             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 617             var censusBuilder = credentials.getCensusBuilder()
 618                                            .addAuthor(author.forge().currentUser().id());
 619             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 620             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,</span>

 621                                                  listAddress, Set.of(), Set.of(),
 622                                                  listServer.getArchive(),
 623                                                  listServer.getSMTP(),
 624                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 625                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 626                                                  Set.of(), Map.of(),
 627                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 628                                                  Map.of(), Duration.ZERO);
 629 
 630             // Populate the projects repository
 631             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 632             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 633             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 634             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 635             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 636             var initialHash = CheckableRepository.appendAndCommit(localRepo,
 637                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
 638                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
 639                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
 640                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
</pre>
<hr />
<pre>
 670 
 671             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 24&quot;));
 672             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 23: Line 12.5$&quot;));
 673             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 24: Line 13 edit$&quot;));
 674             assertFalse(archiveContains(archiveFolder.path(), &quot;^Line 15&quot;));
 675         }
 676     }
 677 
 678     @Test
 679     void filterComments(TestInfo testInfo) throws IOException {
 680         try (var credentials = new HostCredentials(testInfo);
 681              var tempFolder = new TemporaryDirectory();
 682              var archiveFolder = new TemporaryDirectory();
 683              var listServer = new TestMailmanServer()) {
 684             var author = credentials.getHostedRepository();
 685             var archive = credentials.getHostedRepository();
 686             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 687             var censusBuilder = credentials.getCensusBuilder()
 688                                            .addAuthor(author.forge().currentUser().id());
 689             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 690             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,</span>

 691                                                  listAddress, Set.of(), Set.of(),
 692                                                  listServer.getArchive(), listServer.getSMTP(),
 693                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 694                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 695                                                  Set.of(), Map.of(),
 696                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 697                                                  Map.of(), Duration.ZERO);
 698 
 699             // Populate the projects repository
 700             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 701             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 702             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 703             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 704             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 705 
 706             // Make a change with a corresponding PR
 707             var editHash = CheckableRepository.appendAndCommit(localRepo);
 708             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 709             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 710             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
</pre>
<hr />
<pre>
 729             assertFalse(archiveContains(archiveFolder.path(), &quot;--&gt;&quot;));
 730             assertTrue(archiveContains(archiveFolder.path(), &quot;Plain comment&quot;));
 731             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 732             assertFalse(archiveContains(archiveFolder.path(), &quot;/integrate&quot;));
 733         }
 734     }
 735 
 736     @Test
 737     void incrementalChanges(TestInfo testInfo) throws IOException {
 738         try (var credentials = new HostCredentials(testInfo);
 739              var tempFolder = new TemporaryDirectory();
 740              var archiveFolder = new TemporaryDirectory();
 741              var listServer = new TestMailmanServer()) {
 742             var author = credentials.getHostedRepository();
 743             var archive = credentials.getHostedRepository();
 744             var commenter = credentials.getHostedRepository();
 745             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 746             var censusBuilder = credentials.getCensusBuilder()
 747                                            .addAuthor(author.forge().currentUser().id());
 748             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 749             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,</span>

 750                                                  listAddress, Set.of(), Set.of(),
 751                                                  listServer.getArchive(), listServer.getSMTP(),
 752                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 753                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 754                                                  Set.of(), Map.of(),
 755                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 756                                                  Map.of(), Duration.ZERO);
 757 
 758             // Populate the projects repository
 759             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 760             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 761             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 762             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 763             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 764 
 765             // Make a change with a corresponding PR
 766             var editHash = CheckableRepository.appendAndCommit(localRepo);
 767             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 768             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 769             pr.setBody(&quot;This is now ready&quot;);
</pre>
<hr />
<pre>
 850             var conversation = updatedConversations.get(0);
 851             assertEquals(6, conversation.allMessages().size());
 852             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(1).subject());
 853             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(2).subject(), conversation.allMessages().get(2).toString());
 854             assertEquals(&quot;Re: [Rev 04] RFR: This is a pull request&quot;, conversation.allMessages().get(5).subject());
 855         }
 856     }
 857 
 858     @Test
 859     void rebased(TestInfo testInfo) throws IOException {
 860         try (var credentials = new HostCredentials(testInfo);
 861              var tempFolder = new TemporaryDirectory();
 862              var archiveFolder = new TemporaryDirectory();
 863              var listServer = new TestMailmanServer()) {
 864             var author = credentials.getHostedRepository();
 865             var archive = credentials.getHostedRepository();
 866             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 867             var censusBuilder = credentials.getCensusBuilder()
 868                                            .addAuthor(author.forge().currentUser().id());
 869             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 870             var mlBot = new MailingListBridgeBot(sender, author, archive, censusBuilder.build(), &quot;master&quot;,</span>

 871                                                  listAddress, Set.of(), Set.of(),
 872                                                  listServer.getArchive(), listServer.getSMTP(),
 873                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 874                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 875                                                  Set.of(), Map.of(),
 876                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 877                                                  Map.of(), Duration.ZERO);
 878 
 879             // Populate the projects repository
 880             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 881             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
 882             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 883             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 884             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 885 
 886             // Make a change with a corresponding PR
 887             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
 888             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 889             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 890             pr.setBody(&quot;This is now ready&quot;);
</pre>
<hr />
<pre>
 941                 assertFalse(newMail.hasHeader(&quot;PR-Head-Hash&quot;));
 942             }
 943             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversations.get(0).allMessages().get(1).subject());
 944         }
 945     }
 946 
 947     @Test
 948     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
 949         try (var credentials = new HostCredentials(testInfo);
 950              var tempFolder = new TemporaryDirectory();
 951              var archiveFolder = new TemporaryDirectory();
 952              var webrevFolder = new TemporaryDirectory();
 953              var listServer = new TestMailmanServer()) {
 954             var author = credentials.getHostedRepository();
 955             var archive = credentials.getHostedRepository();
 956             var ignored = credentials.getHostedRepository();
 957             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 958             var censusBuilder = credentials.getCensusBuilder()
 959                                            .addAuthor(author.forge().currentUser().id());
 960             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 961             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,</span>

 962                                                  listAddress,
 963                                                  Set.of(ignored.forge().currentUser().userName()),
 964                                                  Set.of(),
 965                                                  listServer.getArchive(), listServer.getSMTP(),
 966                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 967                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 968                                                  Set.of(), Map.of(),
 969                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 970                                                  Map.of(), Duration.ZERO);
 971 
 972             // Populate the projects repository
 973             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 974             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 975             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 976             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 977 
 978             // Make a change with a corresponding PR
 979             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 980                                                                &quot;Change msg\n\nWith several lines&quot;);
 981             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
</pre>
<hr />
<pre>
1016                                          .collect(Collectors.toList());
1017             assertEquals(1, webrevComments.size());
1018             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
1019         }
1020     }
1021 
1022     @Test
1023     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
1024         try (var credentials = new HostCredentials(testInfo);
1025              var tempFolder = new TemporaryDirectory();
1026              var archiveFolder = new TemporaryDirectory();
1027              var listServer = new TestMailmanServer()) {
1028             var author = credentials.getHostedRepository();
1029             var archive = credentials.getHostedRepository();
1030             var reviewer = credentials.getHostedRepository();
1031             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1032             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1033             var censusBuilder = credentials.getCensusBuilder()
1034                                            .addReviewer(reviewer.forge().currentUser().id())
1035                                            .addAuthor(author.forge().currentUser().id());
<span class="line-modified">1036             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,</span>

1037                                                  listAddress, Set.of(), Set.of(),
1038                                                  listServer.getArchive(), listServer.getSMTP(),
1039                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
1040                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
1041                                                  Set.of(), Map.of(),
1042                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
1043                                                  Map.of(), Duration.ZERO);
1044 
1045             // Populate the projects repository
1046             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1047             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1048             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1049             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1050             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1051 
1052             // Make a change with a corresponding PR
1053             var editHash = CheckableRepository.appendAndCommit(localRepo);
1054             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1055             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1056             pr.setBody(&quot;This is now ready&quot;);
</pre>
<hr />
<pre>
1098             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
1099             if (author.forge().supportsReviewBody()) {
1100                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
1101             }
1102         }
1103     }
1104 
1105     @Test
1106     void ignoreComments(TestInfo testInfo) throws IOException {
1107         try (var credentials = new HostCredentials(testInfo);
1108              var tempFolder = new TemporaryDirectory();
1109              var archiveFolder = new TemporaryDirectory();
1110              var listServer = new TestMailmanServer()) {
1111             var author = credentials.getHostedRepository();
1112             var ignored = credentials.getHostedRepository();
1113             var archive = credentials.getHostedRepository();
1114             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1115             var censusBuilder = credentials.getCensusBuilder()
1116                                            .addAuthor(author.forge().currentUser().id());
1117             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified">1118             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,</span>

1119                                                  listAddress,
1120                                                  Set.of(ignored.forge().currentUser().userName()),
1121                                                  Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)),
1122                                                  listServer.getArchive(), listServer.getSMTP(),
1123                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
1124                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
1125                                                  Set.of(), Map.of(),
1126                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
1127                                                  Map.of(), Duration.ZERO);
1128 
1129             // Populate the projects repository
1130             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1131             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1132             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1133             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1134             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1135 
1136             // Make a change with a corresponding PR
1137             var editHash = CheckableRepository.appendAndCommit(localRepo);
1138             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
</pre>
</td>
<td>
<hr />
<pre>
  95     private String noreplyAddress(HostedRepository repository) {
  96         return &quot;test+&quot; + repository.forge().currentUser().id() + &quot;+&quot; +
  97                 repository.forge().currentUser().userName() +
  98                 &quot;@openjdk.java.net&quot;;
  99     }
 100 
 101     @Test
 102     void simpleArchive(TestInfo testInfo) throws IOException {
 103         try (var credentials = new HostCredentials(testInfo);
 104              var tempFolder = new TemporaryDirectory();
 105              var archiveFolder = new TemporaryDirectory();
 106              var webrevFolder = new TemporaryDirectory();
 107              var listServer = new TestMailmanServer()) {
 108             var author = credentials.getHostedRepository();
 109             var archive = credentials.getHostedRepository();
 110             var ignored = credentials.getHostedRepository();
 111             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 112             var censusBuilder = credentials.getCensusBuilder()
 113                                            .addAuthor(author.forge().currentUser().id());
 114             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 115             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,</span>
<span class="line-added"> 116                                                  censusBuilder.build(), &quot;master&quot;, listAddress,</span>
 117                                                  Set.of(ignored.forge().currentUser().userName()),
 118                                                  Set.of(),
 119                                                  listServer.getArchive(), listServer.getSMTP(),
 120                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 121                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 122                                                  Set.of(&quot;rfr&quot;), Map.of(ignored.forge().currentUser().userName(),
 123                                                                        Pattern.compile(&quot;ready&quot;)),
 124                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 125                                                  Map.of(&quot;Extra1&quot;, &quot;val1&quot;, &quot;Extra2&quot;, &quot;val2&quot;),
 126                                                  Duration.ZERO);
 127 
 128             // Populate the projects repository
 129             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 130             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 131             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 132             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 133 
 134             // Make a change with a corresponding PR
 135             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 136                                                                &quot;Change msg\n\nWith several lines&quot;);
</pre>
<hr />
<pre>
 253                 assertEquals(noreplyAddress(archive), newMail.author().address());
 254                 assertEquals(listAddress, newMail.sender());
 255             }
 256             assertTrue(conversations.get(0).allMessages().get(2).body().contains(&quot;This is a comment ðŸ˜„&quot;));
 257         }
 258     }
 259 
 260     @Test
 261     void reviewComment(TestInfo testInfo) throws IOException {
 262         try (var credentials = new HostCredentials(testInfo);
 263              var tempFolder = new TemporaryDirectory();
 264              var archiveFolder = new TemporaryDirectory();
 265              var listServer = new TestMailmanServer()) {
 266             var author = credentials.getHostedRepository();
 267             var archive = credentials.getHostedRepository();
 268             var ignored = credentials.getHostedRepository();
 269             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 270             var censusBuilder = credentials.getCensusBuilder()
 271                                            .addAuthor(author.forge().currentUser().id());
 272             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 273             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,</span>
<span class="line-added"> 274                                                  censusBuilder.build(), &quot;master&quot;, listAddress,</span>
 275                                                  Set.of(ignored.forge().currentUser().userName()),
 276                                                  Set.of(),
 277                                                  listServer.getArchive(), listServer.getSMTP(),
 278                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 279                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 280                                                  Set.of(), Map.of(),
 281                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 282                                                  Map.of(), Duration.ZERO);
 283 
 284             // Populate the projects repository
 285             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 286             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 287             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 288             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 289             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 290 
 291             // Make a change with a corresponding PR
 292             var editHash = CheckableRepository.appendAndCommit(localRepo);
 293             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 294             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
</pre>
<hr />
<pre>
 342             assertEquals(3, conversations.get(0).allMessages().size());
 343             for (var newMail : conversations.get(0).allMessages()) {
 344                 assertEquals(noreplyAddress(archive), newMail.author().address());
 345                 assertEquals(listAddress, newMail.sender());
 346             }
 347         }
 348     }
 349 
 350     @Test
 351     void combineComments(TestInfo testInfo) throws IOException {
 352         try (var credentials = new HostCredentials(testInfo);
 353              var tempFolder = new TemporaryDirectory();
 354              var archiveFolder = new TemporaryDirectory();
 355              var listServer = new TestMailmanServer()) {
 356             var author = credentials.getHostedRepository();
 357             var archive = credentials.getHostedRepository();
 358             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 359             var censusBuilder = credentials.getCensusBuilder()
 360                                            .addAuthor(author.forge().currentUser().id());
 361             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 362             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,</span>
<span class="line-added"> 363                                                  censusBuilder.build(), &quot;master&quot;,</span>
 364                                                  listAddress, Set.of(), Set.of(),
 365                                                  listServer.getArchive(),
 366                                                  listServer.getSMTP(),
 367                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 368                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 369                                                  Set.of(), Map.of(),
 370                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 371                                                  Map.of(), Duration.ZERO);
 372 
 373             // Populate the projects repository
 374             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 375             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 376             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 377             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 378             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 379 
 380             // Make a change with a corresponding PR
 381             var editHash = CheckableRepository.appendAndCommit(localRepo);
 382             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 383             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
</pre>
<hr />
<pre>
 431 
 432             // The combined review comments should only appear unquoted once
 433             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^Another review comment&quot;));
 434         }
 435     }
 436 
 437     @Test
 438     void commentThreading(TestInfo testInfo) throws IOException {
 439         try (var credentials = new HostCredentials(testInfo);
 440              var tempFolder = new TemporaryDirectory();
 441              var archiveFolder = new TemporaryDirectory();
 442              var listServer = new TestMailmanServer()) {
 443             var author = credentials.getHostedRepository();
 444             var reviewer = credentials.getHostedRepository();
 445             var archive = credentials.getHostedRepository();
 446             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 447             var censusBuilder = credentials.getCensusBuilder()
 448                                            .addReviewer(reviewer.forge().currentUser().id())
 449                                            .addAuthor(author.forge().currentUser().id());
 450             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 451             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,</span>
<span class="line-added"> 452                                                  censusBuilder.build(), &quot;master&quot;,</span>
 453                                                  listAddress, Set.of(), Set.of(),
 454                                                  listServer.getArchive(),
 455                                                  listServer.getSMTP(),
 456                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 457                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 458                                                  Set.of(), Map.of(),
 459                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 460                                                  Map.of(), Duration.ZERO);
 461 
 462             // Populate the projects repository
 463             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 464             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 465             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 466             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 467             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 468 
 469             // Make a change with a corresponding PR
 470             var editHash = CheckableRepository.appendAndCommit(localRepo);
 471             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 472             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
</pre>
<hr />
<pre>
 553             var thread4 = replies.get(3);
 554             assertEquals(&quot;Re: [Approved] RFR: This is a pull request&quot;, thread4.subject());
 555             assertTrue(thread4.body().contains(&quot;Looks fine&quot;));
 556             assertTrue(thread4.body().contains(&quot;The final review comment&quot;));
 557             assertTrue(thread4.body().contains(&quot;Approved by integrationreviewer1 (Reviewer)&quot;));
 558         }
 559     }
 560 
 561     @Test
 562     void reviewContext(TestInfo testInfo) throws IOException {
 563         try (var credentials = new HostCredentials(testInfo);
 564              var tempFolder = new TemporaryDirectory();
 565              var archiveFolder = new TemporaryDirectory();
 566              var listServer = new TestMailmanServer()) {
 567             var author = credentials.getHostedRepository();
 568             var archive = credentials.getHostedRepository();
 569             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 570             var censusBuilder = credentials.getCensusBuilder()
 571                                            .addAuthor(author.forge().currentUser().id());
 572             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 573             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,</span>
<span class="line-added"> 574                                                  censusBuilder.build(), &quot;master&quot;,</span>
 575                                                  listAddress, Set.of(), Set.of(),
 576                                                  listServer.getArchive(),
 577                                                  listServer.getSMTP(),
 578                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 579                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 580                                                  Set.of(), Map.of(),
 581                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 582                                                  Map.of(), Duration.ZERO);
 583 
 584             // Populate the projects repository
 585             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 586             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 587             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 588             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 589             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 590 
 591             // Make a change with a corresponding PR
 592             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
 593             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 594             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
</pre>
<hr />
<pre>
 605             // The archive should only contain context around line 2
 606             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 607             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
 608             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
 609             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
 610         }
 611     }
 612 
 613     @Test
 614     void multipleReviewContexts(TestInfo testInfo) throws IOException {
 615         try (var credentials = new HostCredentials(testInfo);
 616              var tempFolder = new TemporaryDirectory();
 617              var archiveFolder = new TemporaryDirectory();
 618              var listServer = new TestMailmanServer()) {
 619             var author = credentials.getHostedRepository();
 620             var archive = credentials.getHostedRepository();
 621             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 622             var censusBuilder = credentials.getCensusBuilder()
 623                                            .addAuthor(author.forge().currentUser().id());
 624             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 625             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,</span>
<span class="line-added"> 626                                                  censusBuilder.build(), &quot;master&quot;,</span>
 627                                                  listAddress, Set.of(), Set.of(),
 628                                                  listServer.getArchive(),
 629                                                  listServer.getSMTP(),
 630                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 631                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 632                                                  Set.of(), Map.of(),
 633                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 634                                                  Map.of(), Duration.ZERO);
 635 
 636             // Populate the projects repository
 637             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 638             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 639             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 640             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 641             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 642             var initialHash = CheckableRepository.appendAndCommit(localRepo,
 643                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
 644                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
 645                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
 646                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
</pre>
<hr />
<pre>
 676 
 677             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 24&quot;));
 678             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 23: Line 12.5$&quot;));
 679             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 24: Line 13 edit$&quot;));
 680             assertFalse(archiveContains(archiveFolder.path(), &quot;^Line 15&quot;));
 681         }
 682     }
 683 
 684     @Test
 685     void filterComments(TestInfo testInfo) throws IOException {
 686         try (var credentials = new HostCredentials(testInfo);
 687              var tempFolder = new TemporaryDirectory();
 688              var archiveFolder = new TemporaryDirectory();
 689              var listServer = new TestMailmanServer()) {
 690             var author = credentials.getHostedRepository();
 691             var archive = credentials.getHostedRepository();
 692             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 693             var censusBuilder = credentials.getCensusBuilder()
 694                                            .addAuthor(author.forge().currentUser().id());
 695             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 696             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,</span>
<span class="line-added"> 697                                                  censusBuilder.build(), &quot;master&quot;,</span>
 698                                                  listAddress, Set.of(), Set.of(),
 699                                                  listServer.getArchive(), listServer.getSMTP(),
 700                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 701                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 702                                                  Set.of(), Map.of(),
 703                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 704                                                  Map.of(), Duration.ZERO);
 705 
 706             // Populate the projects repository
 707             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 708             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 709             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 710             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 711             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 712 
 713             // Make a change with a corresponding PR
 714             var editHash = CheckableRepository.appendAndCommit(localRepo);
 715             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 716             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 717             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
</pre>
<hr />
<pre>
 736             assertFalse(archiveContains(archiveFolder.path(), &quot;--&gt;&quot;));
 737             assertTrue(archiveContains(archiveFolder.path(), &quot;Plain comment&quot;));
 738             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 739             assertFalse(archiveContains(archiveFolder.path(), &quot;/integrate&quot;));
 740         }
 741     }
 742 
 743     @Test
 744     void incrementalChanges(TestInfo testInfo) throws IOException {
 745         try (var credentials = new HostCredentials(testInfo);
 746              var tempFolder = new TemporaryDirectory();
 747              var archiveFolder = new TemporaryDirectory();
 748              var listServer = new TestMailmanServer()) {
 749             var author = credentials.getHostedRepository();
 750             var archive = credentials.getHostedRepository();
 751             var commenter = credentials.getHostedRepository();
 752             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 753             var censusBuilder = credentials.getCensusBuilder()
 754                                            .addAuthor(author.forge().currentUser().id());
 755             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 756             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,</span>
<span class="line-added"> 757                                                  censusBuilder.build(), &quot;master&quot;,</span>
 758                                                  listAddress, Set.of(), Set.of(),
 759                                                  listServer.getArchive(), listServer.getSMTP(),
 760                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 761                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 762                                                  Set.of(), Map.of(),
 763                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 764                                                  Map.of(), Duration.ZERO);
 765 
 766             // Populate the projects repository
 767             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 768             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 769             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 770             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 771             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 772 
 773             // Make a change with a corresponding PR
 774             var editHash = CheckableRepository.appendAndCommit(localRepo);
 775             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 776             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 777             pr.setBody(&quot;This is now ready&quot;);
</pre>
<hr />
<pre>
 858             var conversation = updatedConversations.get(0);
 859             assertEquals(6, conversation.allMessages().size());
 860             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(1).subject());
 861             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(2).subject(), conversation.allMessages().get(2).toString());
 862             assertEquals(&quot;Re: [Rev 04] RFR: This is a pull request&quot;, conversation.allMessages().get(5).subject());
 863         }
 864     }
 865 
 866     @Test
 867     void rebased(TestInfo testInfo) throws IOException {
 868         try (var credentials = new HostCredentials(testInfo);
 869              var tempFolder = new TemporaryDirectory();
 870              var archiveFolder = new TemporaryDirectory();
 871              var listServer = new TestMailmanServer()) {
 872             var author = credentials.getHostedRepository();
 873             var archive = credentials.getHostedRepository();
 874             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 875             var censusBuilder = credentials.getCensusBuilder()
 876                                            .addAuthor(author.forge().currentUser().id());
 877             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 878             var mlBot = new MailingListBridgeBot(sender, author, archive, &quot;master&quot;,</span>
<span class="line-added"> 879                                                  censusBuilder.build(), &quot;master&quot;,</span>
 880                                                  listAddress, Set.of(), Set.of(),
 881                                                  listServer.getArchive(), listServer.getSMTP(),
 882                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 883                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 884                                                  Set.of(), Map.of(),
 885                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 886                                                  Map.of(), Duration.ZERO);
 887 
 888             // Populate the projects repository
 889             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 890             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
 891             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 892             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 893             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 894 
 895             // Make a change with a corresponding PR
 896             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
 897             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 898             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 899             pr.setBody(&quot;This is now ready&quot;);
</pre>
<hr />
<pre>
 950                 assertFalse(newMail.hasHeader(&quot;PR-Head-Hash&quot;));
 951             }
 952             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversations.get(0).allMessages().get(1).subject());
 953         }
 954     }
 955 
 956     @Test
 957     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
 958         try (var credentials = new HostCredentials(testInfo);
 959              var tempFolder = new TemporaryDirectory();
 960              var archiveFolder = new TemporaryDirectory();
 961              var webrevFolder = new TemporaryDirectory();
 962              var listServer = new TestMailmanServer()) {
 963             var author = credentials.getHostedRepository();
 964             var archive = credentials.getHostedRepository();
 965             var ignored = credentials.getHostedRepository();
 966             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 967             var censusBuilder = credentials.getCensusBuilder()
 968                                            .addAuthor(author.forge().currentUser().id());
 969             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 970             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,</span>
<span class="line-added"> 971                                                  censusBuilder.build(), &quot;master&quot;,</span>
 972                                                  listAddress,
 973                                                  Set.of(ignored.forge().currentUser().userName()),
 974                                                  Set.of(),
 975                                                  listServer.getArchive(), listServer.getSMTP(),
 976                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 977                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 978                                                  Set.of(), Map.of(),
 979                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
 980                                                  Map.of(), Duration.ZERO);
 981 
 982             // Populate the projects repository
 983             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 984             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 985             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 986             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 987 
 988             // Make a change with a corresponding PR
 989             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 990                                                                &quot;Change msg\n\nWith several lines&quot;);
 991             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
</pre>
<hr />
<pre>
1026                                          .collect(Collectors.toList());
1027             assertEquals(1, webrevComments.size());
1028             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
1029         }
1030     }
1031 
1032     @Test
1033     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
1034         try (var credentials = new HostCredentials(testInfo);
1035              var tempFolder = new TemporaryDirectory();
1036              var archiveFolder = new TemporaryDirectory();
1037              var listServer = new TestMailmanServer()) {
1038             var author = credentials.getHostedRepository();
1039             var archive = credentials.getHostedRepository();
1040             var reviewer = credentials.getHostedRepository();
1041             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1042             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1043             var censusBuilder = credentials.getCensusBuilder()
1044                                            .addReviewer(reviewer.forge().currentUser().id())
1045                                            .addAuthor(author.forge().currentUser().id());
<span class="line-modified">1046             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,</span>
<span class="line-added">1047                                                  censusBuilder.build(), &quot;master&quot;,</span>
1048                                                  listAddress, Set.of(), Set.of(),
1049                                                  listServer.getArchive(), listServer.getSMTP(),
1050                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
1051                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
1052                                                  Set.of(), Map.of(),
1053                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
1054                                                  Map.of(), Duration.ZERO);
1055 
1056             // Populate the projects repository
1057             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1058             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1059             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1060             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1061             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1062 
1063             // Make a change with a corresponding PR
1064             var editHash = CheckableRepository.appendAndCommit(localRepo);
1065             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1066             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1067             pr.setBody(&quot;This is now ready&quot;);
</pre>
<hr />
<pre>
1109             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
1110             if (author.forge().supportsReviewBody()) {
1111                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
1112             }
1113         }
1114     }
1115 
1116     @Test
1117     void ignoreComments(TestInfo testInfo) throws IOException {
1118         try (var credentials = new HostCredentials(testInfo);
1119              var tempFolder = new TemporaryDirectory();
1120              var archiveFolder = new TemporaryDirectory();
1121              var listServer = new TestMailmanServer()) {
1122             var author = credentials.getHostedRepository();
1123             var ignored = credentials.getHostedRepository();
1124             var archive = credentials.getHostedRepository();
1125             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1126             var censusBuilder = credentials.getCensusBuilder()
1127                                            .addAuthor(author.forge().currentUser().id());
1128             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified">1129             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,</span>
<span class="line-added">1130                                                  censusBuilder.build(), &quot;master&quot;,</span>
1131                                                  listAddress,
1132                                                  Set.of(ignored.forge().currentUser().userName()),
1133                                                  Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)),
1134                                                  listServer.getArchive(), listServer.getSMTP(),
1135                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
1136                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
1137                                                  Set.of(), Map.of(),
1138                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
1139                                                  Map.of(), Duration.ZERO);
1140 
1141             // Populate the projects repository
1142             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1143             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1144             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1145             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1146             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1147 
1148             // Make a change with a corresponding PR
1149             var editHash = CheckableRepository.appendAndCommit(localRepo);
1150             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
</pre>
</td>
</tr>
</table>
<center><a href="MailingListArchiveReaderBotTests.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../pr/src/main/java/org/openjdk/skara/bots/pr/CensusInstance.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>