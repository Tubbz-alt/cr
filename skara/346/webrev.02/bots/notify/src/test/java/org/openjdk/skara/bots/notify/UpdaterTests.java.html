<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.notify;
  24 
  25 import org.openjdk.skara.email.*;
  26 import org.openjdk.skara.forge.HostedRepository;
  27 import org.openjdk.skara.json.*;
  28 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  29 import org.openjdk.skara.storage.StorageBuilder;
  30 import org.openjdk.skara.test.*;
  31 import org.openjdk.skara.vcs.Tag;
  32 
  33 import org.junit.jupiter.api.*;
  34 
  35 import java.io.IOException;
  36 import java.net.URI;
  37 import java.nio.charset.StandardCharsets;
  38 import java.nio.file.*;
  39 import java.time.Duration;
  40 import java.util.*;
  41 import java.util.regex.Pattern;
  42 import java.util.stream.Collectors;
  43 
  44 import static org.junit.jupiter.api.Assertions.*;
  45 
  46 class UpdaterTests {
  47     private List&lt;Path&gt; findJsonFiles(Path folder, String partialName) throws IOException {
  48         return Files.walk(folder)
  49                     .filter(path -&gt; path.toString().endsWith(&quot;.json&quot;))
  50                     .filter(path -&gt; path.toString().contains(partialName))
  51                     .collect(Collectors.toList());
  52     }
  53 
  54     private StorageBuilder&lt;Tag&gt; createTagStorage(HostedRepository repository) {
  55         return new StorageBuilder&lt;Tag&gt;(&quot;tags.txt&quot;)
  56                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated tags&quot;);
  57     }
  58 
  59     private StorageBuilder&lt;ResolvedBranch&gt; createBranchStorage(HostedRepository repository) {
  60         return new StorageBuilder&lt;ResolvedBranch&gt;(&quot;branches.txt&quot;)
  61                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated branches&quot;);
  62     }
  63 
  64     private StorageBuilder&lt;PullRequestIssues&gt; createPullRequestIssuesStorage(HostedRepository repository) {
  65         return new StorageBuilder&lt;PullRequestIssues&gt;(&quot;prissues.txt&quot;)
  66                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated prissues&quot;);
  67     }
  68 
  69     @Test
  70     void testJsonUpdaterBranch(TestInfo testInfo) throws IOException {
  71         try (var credentials = new HostCredentials(testInfo);
  72              var tempFolder = new TemporaryDirectory()) {
  73             var repo = credentials.getHostedRepository();
  74             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
  75             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
  76             credentials.commitLock(localRepo);
  77             localRepo.pushAll(repo.url());
  78 
  79             var tagStorage = createTagStorage(repo);
  80             var branchStorage = createBranchStorage(repo);
  81             var prIssuesStorage = createPullRequestIssuesStorage(repo);
  82             var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
  83             Files.createDirectory(jsonFolder);
  84             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
  85 
  86             var updater = new JsonUpdater(jsonFolder, &quot;12&quot;, &quot;team&quot;);
  87             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
  88                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
  89 
  90             TestBotRunner.runPeriodicItems(notifyBot);
  91             assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));
  92 
  93             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;One more line&quot;, &quot;12345678: Fixes&quot;);
  94             localRepo.push(editHash, repo.url(), &quot;master&quot;);
  95             TestBotRunner.runPeriodicItems(notifyBot);
  96             var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);
  97             assertEquals(1, jsonFiles.size());
  98             var jsonData = Files.readString(jsonFiles.get(0), StandardCharsets.UTF_8);
  99             var json = JSON.parse(jsonData);
 100             assertEquals(1, json.asArray().size());
 101             assertEquals(repo.webUrl(editHash).toString(), json.asArray().get(0).get(&quot;url&quot;).asString());
 102             assertEquals(List.of(&quot;12345678&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
 103                                                   .map(JSONValue::asString)
 104                                                   .collect(Collectors.toList()));
 105         }
 106     }
 107 
 108     @Test
 109     void testJsonUpdaterTag(TestInfo testInfo) throws IOException {
 110         try (var credentials = new HostCredentials(testInfo);
 111              var tempFolder = new TemporaryDirectory()) {
 112             var repo = credentials.getHostedRepository();
 113             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 114             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
 115             credentials.commitLock(localRepo);
 116             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 117             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
 118             localRepo.pushAll(repo.url());
 119 
 120             var tagStorage = createTagStorage(repo);
 121             var branchStorage = createBranchStorage(repo);
 122             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 123             var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
 124             Files.createDirectory(jsonFolder);
 125             var storageFolder =tempFolder.path().resolve(&quot;storage&quot;);
 126 
 127             var updater = new JsonUpdater(jsonFolder, &quot;12&quot;, &quot;team&quot;);
 128             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 129                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 130 
 131             TestBotRunner.runPeriodicItems(notifyBot);
 132             assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));
 133 
 134             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 135             localRepo.fetch(repo.url(), &quot;history:history&quot;);
 136             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
 137             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;34567890: Even more fixes&quot;);
 138             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
 139             localRepo.pushAll(repo.url());
 140 
 141             TestBotRunner.runPeriodicItems(notifyBot);
 142             var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);
 143             assertEquals(3, jsonFiles.size());
 144 
 145             for (var file : jsonFiles) {
 146                 var jsonData = Files.readString(file, StandardCharsets.UTF_8);
 147                 var json = JSON.parse(jsonData);
 148 
 149                 if (json.asArray().get(0).contains(&quot;date&quot;)) {
 150                     assertEquals(2, json.asArray().size());
 151                     assertEquals(List.of(&quot;23456789&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
 152                                                           .map(JSONValue::asString)
 153                                                           .collect(Collectors.toList()));
 154                     assertEquals(repo.webUrl(editHash).toString(), json.asArray().get(0).get(&quot;url&quot;).asString());
 155                     assertEquals(&quot;team&quot;, json.asArray().get(0).get(&quot;build&quot;).asString());
 156                     assertEquals(List.of(&quot;34567890&quot;), json.asArray().get(1).get(&quot;issue&quot;).asArray().stream()
 157                                                           .map(JSONValue::asString)
 158                                                           .collect(Collectors.toList()));
 159                     assertEquals(repo.webUrl(editHash2).toString(), json.asArray().get(1).get(&quot;url&quot;).asString());
 160                     assertEquals(&quot;team&quot;, json.asArray().get(1).get(&quot;build&quot;).asString());
 161                 } else {
 162                     assertEquals(1, json.asArray().size());
 163                     if (json.asArray().get(0).get(&quot;build&quot;).asString().equals(&quot;b02&quot;)) {
 164                         assertEquals(List.of(&quot;23456789&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
 165                                                               .map(JSONValue::asString)
 166                                                               .collect(Collectors.toList()));
 167                     } else {
 168                         assertEquals(&quot;b04&quot;, json.asArray().get(0).get(&quot;build&quot;).asString());
 169                         assertEquals(List.of(&quot;34567890&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
 170                                                               .map(JSONValue::asString)
 171                                                               .collect(Collectors.toList()));
 172                     }
 173                 }
 174             }
 175         }
 176     }
 177 
 178     @Test
 179     void testMailingList(TestInfo testInfo) throws IOException {
 180         try (var listServer = new TestMailmanServer();
 181              var credentials = new HostCredentials(testInfo);
 182              var tempFolder = new TemporaryDirectory()) {
 183             var repo = credentials.getHostedRepository();
 184             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 185             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 186             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 187             credentials.commitLock(localRepo);
 188             localRepo.pushAll(repo.url());
 189 
 190             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 191             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 192             var mailmanList = mailmanServer.getList(listAddress.address());
 193             var tagStorage = createTagStorage(repo);
 194             var branchStorage = createBranchStorage(repo);
 195             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 196             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 197 
 198             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 199             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null, false, false, false, false,
 200                                                  MailingListUpdater.Mode.ALL,
 201                                                  Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;), Pattern.compile(&quot;none&quot;));
 202             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 203                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 204 
 205             // No mail should be sent on the first run as there is no history
 206             TestBotRunner.runPeriodicItems(notifyBot);
 207             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 208 
 209             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 210             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 211             TestBotRunner.runPeriodicItems(notifyBot);
 212             listServer.processIncoming();
 213 
 214             var conversations = mailmanList.conversations(Duration.ofDays(1));
 215             var email = conversations.get(0).first();
 216             assertEquals(listAddress, email.sender());
 217             assertEquals(sender, email.author());
 218             assertEquals(email.recipients(), List.of(listAddress));
 219             assertTrue(email.subject().contains(&quot;: 23456789: More fixes&quot;));
 220             assertFalse(email.subject().contains(&quot;master&quot;));
 221             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 222             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 223             assertFalse(email.body().contains(&quot;Committer&quot;));
 224             assertFalse(email.body().contains(masterHash.abbreviate()));
 225             assertTrue(email.hasHeader(&quot;extra1&quot;));
 226             assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
 227             assertTrue(email.hasHeader(&quot;extra2&quot;));
 228             assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
 229         }
 230     }
 231 
 232     @Test
 233     void testMailingListMultiple(TestInfo testInfo) throws IOException {
 234         try (var listServer = new TestMailmanServer();
 235              var credentials = new HostCredentials(testInfo);
 236              var tempFolder = new TemporaryDirectory()) {
 237             var repo = credentials.getHostedRepository();
 238             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 239             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 240             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 241             credentials.commitLock(localRepo);
 242             localRepo.pushAll(repo.url());
 243 
 244             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 245             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 246             var mailmanList = mailmanServer.getList(listAddress.address());
 247             var tagStorage = createTagStorage(repo);
 248             var branchStorage = createBranchStorage(repo);
 249             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 250             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 251 
 252             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 253             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null,
 254                                                  false, false, false, false,
 255                                                  MailingListUpdater.Mode.ALL, Map.of(), Pattern.compile(&quot;.*&quot;));
 256             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 257                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 258 
 259             // No mail should be sent on the first run as there is no history
 260             TestBotRunner.runPeriodicItems(notifyBot);
 261             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 262 
 263             var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
 264                                                                 &quot;first_author&quot;, &quot;first@author.example.com&quot;);
 265             localRepo.push(editHash1, repo.url(), &quot;master&quot;);
 266             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;,
 267                                                                 &quot;another_author&quot;, &quot;another@author.example.com&quot;);
 268             localRepo.push(editHash2, repo.url(), &quot;master&quot;);
 269 
 270             TestBotRunner.runPeriodicItems(notifyBot);
 271             listServer.processIncoming();
 272 
 273             var conversations = mailmanList.conversations(Duration.ofDays(1));
 274             var email = conversations.get(0).first();
 275             assertEquals(listAddress, email.sender());
 276             assertEquals(EmailAddress.from(&quot;another_author&quot;, &quot;another@author.example.com&quot;), email.author());
 277             assertEquals(email.recipients(), List.of(listAddress));
 278             assertTrue(email.subject().contains(&quot;: 2 new changesets&quot;));
 279             assertFalse(email.subject().contains(&quot;master&quot;));
 280             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash1.abbreviate()));
 281             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 282             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));
 283             assertTrue(email.body().contains(&quot;3456789A: Even more fixes&quot;));
 284             assertFalse(email.body().contains(masterHash.abbreviate()));
 285         }
 286     }
 287 
 288     @Test
 289     void testMailingListSponsored(TestInfo testInfo) throws IOException {
 290         try (var listServer = new TestMailmanServer();
 291              var credentials = new HostCredentials(testInfo);
 292              var tempFolder = new TemporaryDirectory()) {
 293             var repo = credentials.getHostedRepository();
 294             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 295             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 296             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 297             credentials.commitLock(localRepo);
 298             localRepo.pushAll(repo.url());
 299 
 300             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 301             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 302             var mailmanList = mailmanServer.getList(listAddress.address());
 303             var tagStorage = createTagStorage(repo);
 304             var branchStorage = createBranchStorage(repo);
 305             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 306             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 307 
 308             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 309             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null,
 310                                                  false, false, false, false,
 311                                                  MailingListUpdater.Mode.ALL, Map.of(), Pattern.compile(&quot;.*&quot;));
 312             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 313                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 314 
 315             // No mail should be sent on the first run as there is no history
 316             TestBotRunner.runPeriodicItems(notifyBot);
 317             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 318 
 319             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
 320                                                                &quot;author&quot;, &quot;author@test.test&quot;,
 321                                                                &quot;committer&quot;, &quot;committer@test.test&quot;);
 322             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 323             TestBotRunner.runPeriodicItems(notifyBot);
 324             listServer.processIncoming();
 325 
 326             var conversations = mailmanList.conversations(Duration.ofDays(1));
 327             var email = conversations.get(0).first();
 328             assertEquals(listAddress, email.sender());
 329             assertEquals(EmailAddress.from(&quot;committer&quot;, &quot;committer@test.test&quot;), email.author());
 330             assertEquals(email.recipients(), List.of(listAddress));
 331             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 332             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 333             assertTrue(email.body().contains(&quot;Author:    author &lt;author@test.test&gt;&quot;));
 334             assertTrue(email.body().contains(&quot;Committer: committer &lt;committer@test.test&gt;&quot;));
 335             assertFalse(email.body().contains(masterHash.abbreviate()));
 336         }
 337     }
 338 
 339     @Test
 340     void testMailingListMultipleBranches(TestInfo testInfo) throws IOException {
 341         try (var listServer = new TestMailmanServer();
 342              var credentials = new HostCredentials(testInfo);
 343              var tempFolder = new TemporaryDirectory()) {
 344             var repo = credentials.getHostedRepository();
 345             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 346             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 347             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 348             credentials.commitLock(localRepo);
 349             var branch = localRepo.branch(masterHash, &quot;another&quot;);
 350             localRepo.pushAll(repo.url());
 351 
 352             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 353             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 354             var mailmanList = mailmanServer.getList(listAddress.address());
 355             var tagStorage = createTagStorage(repo);
 356             var branchStorage = createBranchStorage(repo);
 357             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 358             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 359 
 360             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 361             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);
 362             var updater = new MailingListUpdater(mailmanList, listAddress, sender, author,
 363                                                  true, false, false, false,
 364                                                  MailingListUpdater.Mode.ALL, Map.of(), Pattern.compile(&quot;.*&quot;));
 365             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master|another&quot;), tagStorage, branchStorage,
 366                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 367 
 368             // No mail should be sent on the first run as there is no history
 369             TestBotRunner.runPeriodicItems(notifyBot);
 370             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 371 
 372             var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 373             localRepo.push(editHash1, repo.url(), &quot;master&quot;);
 374             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;);
 375             localRepo.push(editHash2, repo.url(), &quot;master&quot;);
 376 
 377             TestBotRunner.runPeriodicItems(notifyBot);
 378             listServer.processIncoming();
 379 
 380             var conversations = mailmanList.conversations(Duration.ofDays(1));
 381             var email = conversations.get(0).first();
 382             assertEquals(listAddress, email.sender());
 383             assertEquals(author, email.author());
 384             assertEquals(email.recipients(), List.of(listAddress));
 385             assertFalse(email.subject().contains(&quot;another&quot;));
 386             assertTrue(email.subject().contains(&quot;: master: 2 new changesets&quot;));
 387             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash1.abbreviate()));
 388             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 389             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));
 390             assertTrue(email.body().contains(&quot;3456789A: Even more fixes&quot;));
 391             assertFalse(email.body().contains(masterHash.abbreviate()));
 392             assertFalse(email.body().contains(&quot;456789AB: Yet more fixes&quot;));
 393 
 394             localRepo.checkout(branch, true);
 395             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another branch&quot;, &quot;456789AB: Yet more fixes&quot;);
 396             localRepo.push(editHash3, repo.url(), &quot;another&quot;);
 397 
 398             TestBotRunner.runPeriodicItems(notifyBot);
 399             listServer.processIncoming();
 400 
 401             conversations = mailmanList.conversations(Duration.ofDays(1));
 402             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
 403             email = conversations.get(0).first();
 404             assertEquals(author, email.author());
 405             assertEquals(listAddress, email.sender());
 406             assertEquals(email.recipients(), List.of(listAddress));
 407             assertTrue(email.subject().contains(&quot;: another: 456789AB: Yet more fixes&quot;));
 408             assertFalse(email.subject().contains(&quot;master&quot;));
 409             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash3.abbreviate()));
 410             assertTrue(email.body().contains(&quot;456789AB: Yet more fixes&quot;));
 411             assertFalse(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));
 412             assertFalse(email.body().contains(&quot;3456789A: Even more fixes&quot;));
 413         }
 414     }
 415 
 416     @Test
 417     void testMailingListPROnly(TestInfo testInfo) throws IOException {
 418         try (var listServer = new TestMailmanServer();
 419              var credentials = new HostCredentials(testInfo);
 420              var tempFolder = new TemporaryDirectory()) {
 421             var repo = credentials.getHostedRepository();
 422             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 423             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 424             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 425             credentials.commitLock(localRepo);
 426             localRepo.pushAll(repo.url());
 427 
 428             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 429             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 430             var mailmanList = mailmanServer.getList(listAddress.address());
 431             var tagStorage = createTagStorage(repo);
 432             var branchStorage = createBranchStorage(repo);
 433             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 434             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 435 
 436             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 437             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);
 438             var updater = new MailingListUpdater(mailmanList, listAddress, sender, author,
 439                                                  false, false, false, false,
 440                                                  MailingListUpdater.Mode.PR_ONLY, Map.of(&quot;extra1&quot;, &quot;value1&quot;),
 441                                                  Pattern.compile(&quot;.*&quot;));
 442             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 443                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 444 
 445             // No mail should be sent on the first run as there is no history
 446             TestBotRunner.runPeriodicItems(notifyBot);
 447             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 448 
 449             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 450             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 451             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 452 
 453             // Create a potentially conflicting one
 454             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 455             localRepo.push(otherHash, repo.url(), &quot;other&quot;);
 456             var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);
 457 
 458             // PR hasn&#39;t been integrated yet, so there should be no mail
 459             TestBotRunner.runPeriodicItems(notifyBot);
 460             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 461 
 462             // Simulate an RFR email
 463             var rfr = Email.create(sender, &quot;RFR: My PR&quot;, &quot;PR: &quot; + pr.webUrl().toString())
 464                     .recipient(listAddress)
 465                     .build();
 466             mailmanList.post(rfr);
 467             listServer.processIncoming();
 468 
 469             // And an integration
 470             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
 471             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 472             TestBotRunner.runPeriodicItems(notifyBot);
 473             listServer.processIncoming();
 474 
 475             var conversations = mailmanList.conversations(Duration.ofDays(1));
 476             assertEquals(1, conversations.size());
 477             var first = conversations.get(0).first();
 478             var email = conversations.get(0).replies(first).get(0);
 479             assertEquals(listAddress, email.sender());
 480             assertEquals(author, email.author());
 481             assertEquals(email.recipients(), List.of(listAddress));
 482             assertEquals(&quot;Re: [Integrated] RFR: My PR&quot;, email.subject());
 483             assertFalse(email.subject().contains(&quot;master&quot;));
 484             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 485             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 486             assertFalse(email.body().contains(&quot;Committer&quot;));
 487             assertFalse(email.body().contains(masterHash.abbreviate()));
 488             assertTrue(email.hasHeader(&quot;extra1&quot;));
 489             assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
 490 
 491             // Now push the other one without a matching PR - PR_ONLY will not generate a mail
 492             localRepo.push(otherHash, repo.url(), &quot;master&quot;);
 493             TestBotRunner.runPeriodicItems(notifyBot);
 494             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofSeconds(1)));
 495         }
 496     }
 497 
 498     @Test
 499     void testMailingListPR(TestInfo testInfo) throws IOException {
 500         try (var listServer = new TestMailmanServer();
 501              var credentials = new HostCredentials(testInfo);
 502              var tempFolder = new TemporaryDirectory()) {
 503             var repo = credentials.getHostedRepository();
 504             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 505             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 506             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 507             credentials.commitLock(localRepo);
 508             localRepo.pushAll(repo.url());
 509 
 510             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 511             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 512             var mailmanList = mailmanServer.getList(listAddress.address());
 513             var tagStorage = createTagStorage(repo);
 514             var branchStorage = createBranchStorage(repo);
 515             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 516             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 517 
 518             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 519             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null,
 520                                                  false, false, false, false,
 521                                                  MailingListUpdater.Mode.PR, Map.of(), Pattern.compile(&quot;.*&quot;));
 522             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 523                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 524 
 525             // No mail should be sent on the first run as there is no history
 526             TestBotRunner.runPeriodicItems(notifyBot);
 527             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 528 
 529             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 530             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 531             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 532 
 533             // Create a potentially conflicting one
 534             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 535             localRepo.push(otherHash, repo.url(), &quot;other&quot;);
 536             var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);
 537 
 538             // PR hasn&#39;t been integrated yet, so there should be no mail
 539             TestBotRunner.runPeriodicItems(notifyBot);
 540             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 541 
 542             // Simulate an RFR email
 543             var rfr = Email.create(&quot;RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())
 544                            .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))
 545                            .recipient(listAddress)
 546                            .build();
 547             mailmanList.post(rfr);
 548             listServer.processIncoming();
 549 
 550             // And an integration
 551             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
 552             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 553 
 554             // Push the other one without a matching PR
 555             localRepo.push(otherHash, repo.url(), &quot;master&quot;);
 556 
 557             TestBotRunner.runPeriodicItems(notifyBot);
 558             listServer.processIncoming();
 559             listServer.processIncoming();
 560 
 561             var conversations = mailmanList.conversations(Duration.ofDays(1));
 562             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
 563             assertEquals(2, conversations.size());
 564 
 565             var prConversation = conversations.get(0);
 566             var pushConversation = conversations.get(1);
 567 
 568             var prEmail = prConversation.replies(prConversation.first()).get(0);
 569             assertEquals(listAddress, prEmail.sender());
 570             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), prEmail.author());
 571             assertEquals(prEmail.recipients(), List.of(listAddress));
 572             assertEquals(&quot;Re: [Integrated] RFR: My PR&quot;, prEmail.subject());
 573             assertFalse(prEmail.subject().contains(&quot;master&quot;));
 574             assertTrue(prEmail.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 575             assertTrue(prEmail.body().contains(&quot;23456789: More fixes&quot;));
 576             assertFalse(prEmail.body().contains(&quot;Committer&quot;));
 577             assertFalse(prEmail.body().contains(masterHash.abbreviate()));
 578 
 579             var pushEmail = pushConversation.first();
 580             assertEquals(listAddress, pushEmail.sender());
 581             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), pushEmail.author());
 582             assertEquals(pushEmail.recipients(), List.of(listAddress));
 583             assertTrue(pushEmail.subject().contains(&quot;23456789: More fixes&quot;));
 584         }
 585     }
 586 
 587     @Test
 588     void testMailinglistTag(TestInfo testInfo) throws IOException {
 589         try (var credentials = new HostCredentials(testInfo);
 590              var tempFolder = new TemporaryDirectory();
 591              var listServer = new TestMailmanServer()) {
 592             var repo = credentials.getHostedRepository();
 593             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 594             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
 595             credentials.commitLock(localRepo);
 596             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 597             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 598             localRepo.pushAll(repo.url());
 599 
 600             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 601             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 602             var mailmanList = mailmanServer.getList(listAddress.address());
 603             var tagStorage = createTagStorage(repo);
 604             var branchStorage = createBranchStorage(repo);
 605             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 606             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 607 
 608             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 609             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null,
 610                                                  false, true, false, true,
 611                                                  MailingListUpdater.Mode.ALL,
 612                                                  Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;),
 613                                                  Pattern.compile(&quot;.*&quot;));
 614             var prOnlyUpdater = new MailingListUpdater(mailmanList, listAddress, sender, null,
 615                                                        false, false, false, false,
 616                                                        MailingListUpdater.Mode.PR_ONLY, Map.of(), Pattern.compile(&quot;.*&quot;));
 617             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 618                                           prIssuesStorage, List.of(updater, prOnlyUpdater), List.of(), Set.of(), Map.of());
 619 
 620             // No mail should be sent on the first run as there is no history
 621             TestBotRunner.runPeriodicItems(notifyBot);
 622             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 623 
 624             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 625             localRepo.fetch(repo.url(), &quot;history:history&quot;);
 626             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 627             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);
 628             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);
 629             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);
 630             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 631             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);
 632             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);
 633             localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 634             localRepo.pushAll(repo.url());
 635 
 636             TestBotRunner.runPeriodicItems(notifyBot);
 637             listServer.processIncoming();
 638             listServer.processIncoming();
 639             listServer.processIncoming();
 640             listServer.processIncoming();
 641 
 642             var conversations = mailmanList.conversations(Duration.ofDays(1));
 643             assertEquals(4, conversations.size());
 644 
 645             for (var conversation : conversations) {
 646                 var email = conversation.first();
 647                 if (email.subject().equals(&quot;git: test: Added tag jdk-12+2 for changeset &quot; + editHash.abbreviate())) {
 648                     assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 649                     assertFalse(email.body().contains(&quot;34567890: Even more fixes&quot;));
 650                     assertFalse(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
 651                     assertFalse(email.body().contains(&quot;56789012: Still even more fixes&quot;));
 652                     assertFalse(email.body().contains(&quot;67890123: Brand new fixes&quot;));
 653                     assertFalse(email.body().contains(&quot;78901234: More brand new fixes&quot;));
 654                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 655                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-12+4 for changeset &quot; + editHash2.abbreviate())) {
 656                     assertFalse(email.body().contains(&quot;23456789: More fixes&quot;));
 657                     assertTrue(email.body().contains(&quot;34567890: Even more fixes&quot;));
 658                     assertTrue(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
 659                     assertTrue(email.body().contains(&quot;56789012: Still even more fixes&quot;));
 660                     assertFalse(email.body().contains(&quot;67890123: Brand new fixes&quot;));
 661                     assertFalse(email.body().contains(&quot;78901234: More brand new fixes&quot;));
 662                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 663                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-13+0 for changeset &quot; + editHash3.abbreviate())) {
 664                     assertFalse(email.body().contains(&quot;23456789: More fixes&quot;));
 665                     assertFalse(email.body().contains(&quot;34567890: Even more fixes&quot;));
 666                     assertFalse(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
 667                     assertFalse(email.body().contains(&quot;56789012: Still even more fixes&quot;));
 668                     assertFalse(email.body().contains(&quot;67890123: Brand new fixes&quot;));
 669                     assertTrue(email.body().contains(&quot;78901234: More brand new fixes&quot;));
 670                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 671                 } else if (email.subject().equals(&quot;git: test: 6 new changesets&quot;)) {
 672                     assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 673                     assertTrue(email.body().contains(&quot;34567890: Even more fixes&quot;));
 674                     assertTrue(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
 675                     assertTrue(email.body().contains(&quot;56789012: Still even more fixes&quot;));
 676                     assertTrue(email.body().contains(&quot;67890123: Brand new fixes&quot;));
 677                     assertTrue(email.body().contains(&quot;78901234: More brand new fixes&quot;));
 678                     assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());
 679                 } else {
 680                     fail(&quot;Mismatched subject: &quot; + email.subject());
 681                 }
 682                 assertTrue(email.hasHeader(&quot;extra1&quot;));
 683                 assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
 684                 assertTrue(email.hasHeader(&quot;extra2&quot;));
 685                 assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
 686             }
 687         }
 688     }
 689 
 690     @Test
 691     void testMailinglistPlainTags(TestInfo testInfo) throws IOException {
 692         try (var credentials = new HostCredentials(testInfo);
 693              var tempFolder = new TemporaryDirectory();
 694              var listServer = new TestMailmanServer()) {
 695             var repo = credentials.getHostedRepository();
 696             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 697             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
 698             credentials.commitLock(localRepo);
 699             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 700             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 701             localRepo.pushAll(repo.url());
 702 
 703             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 704             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 705             var mailmanList = mailmanServer.getList(listAddress.address());
 706             var tagStorage = createTagStorage(repo);
 707             var branchStorage = createBranchStorage(repo);
 708             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 709             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 710 
 711             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 712             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null,
 713                                                  false, true, false, false,
 714                                                  MailingListUpdater.Mode.ALL,
 715                                                  Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;),
 716                                                  Pattern.compile(&quot;.*&quot;));
 717             var prOnlyUpdater = new MailingListUpdater(mailmanList, listAddress, sender, null,
 718                                                        false, false, false, false,
 719                                                        MailingListUpdater.Mode.PR_ONLY, Map.of(), Pattern.compile(&quot;.*&quot;));
 720             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 721                                           prIssuesStorage, List.of(updater, prOnlyUpdater), List.of(), Set.of(), Map.of());
 722 
 723             // No mail should be sent on the first run as there is no history
 724             TestBotRunner.runPeriodicItems(notifyBot);
 725             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 726 
 727             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 728             localRepo.fetch(repo.url(), &quot;history:history&quot;);
 729             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 730             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);
 731             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);
 732             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);
 733             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 734             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);
 735             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);
 736             localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 737             localRepo.pushAll(repo.url());
 738 
 739             TestBotRunner.runPeriodicItems(notifyBot);
 740             listServer.processIncoming();
 741             listServer.processIncoming();
 742             listServer.processIncoming();
 743             listServer.processIncoming();
 744 
 745             var conversations = mailmanList.conversations(Duration.ofDays(1));
 746             assertEquals(4, conversations.size());
 747 
 748             for (var conversation : conversations) {
 749                 var email = conversation.first();
 750                 if (email.subject().equals(&quot;git: test: Added tag jdk-12+2 for changeset &quot; + editHash.abbreviate())) {
 751                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 752                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-12+4 for changeset &quot; + editHash2.abbreviate())) {
 753                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 754                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-13+0 for changeset &quot; + editHash3.abbreviate())) {
 755                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 756                 } else if (email.subject().equals(&quot;git: test: 6 new changesets&quot;)) {
 757                     assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());
 758                 } else {
 759                     fail(&quot;Mismatched subject: &quot; + email.subject());
 760                 }
 761                 assertTrue(email.hasHeader(&quot;extra1&quot;));
 762                 assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
 763                 assertTrue(email.hasHeader(&quot;extra2&quot;));
 764                 assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
 765             }
 766         }
 767     }
 768 
 769     @Test
 770     void testMailingListBranch(TestInfo testInfo) throws IOException {
 771         try (var listServer = new TestMailmanServer();
 772              var credentials = new HostCredentials(testInfo);
 773              var tempFolder = new TemporaryDirectory()) {
 774             var repo = credentials.getHostedRepository();
 775             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 776             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 777             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 778             credentials.commitLock(localRepo);
 779             localRepo.pushAll(repo.url());
 780 
 781             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 782             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 783             var mailmanList = mailmanServer.getList(listAddress.address());
 784             var tagStorage = createTagStorage(repo);
 785             var branchStorage = createBranchStorage(repo);
 786             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 787             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 788 
 789             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 790             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null,
 791                                                  false, false, true, false,
 792                                                  MailingListUpdater.Mode.ALL,
 793                                                  Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;),
 794                                                  Pattern.compile(&quot;.*&quot;));
 795             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master|newbranch.&quot;), tagStorage, branchStorage,
 796                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 797 
 798             // No mail should be sent on the first run as there is no history
 799             TestBotRunner.runPeriodicItems(notifyBot);
 800             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 801 
 802             CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;12345678: Some fixes&quot;);
 803             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 804             localRepo.push(editHash, repo.url(), &quot;newbranch1&quot;);
 805             TestBotRunner.runPeriodicItems(notifyBot);
 806             listServer.processIncoming();
 807 
 808             var conversations = mailmanList.conversations(Duration.ofDays(1));
 809             var email = conversations.get(0).first();
 810             assertEquals(listAddress, email.sender());
 811             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());
 812             assertEquals(email.recipients(), List.of(listAddress));
 813             assertEquals(&quot;git: test: created branch newbranch1 based on the branch master containing 2 unique commits&quot;, email.subject());
 814             assertTrue(email.body().contains(&quot;12345678: Some fixes&quot;));
 815             assertTrue(email.hasHeader(&quot;extra1&quot;));
 816             assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
 817             assertTrue(email.hasHeader(&quot;extra2&quot;));
 818             assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
 819 
 820             TestBotRunner.runPeriodicItems(notifyBot);
 821             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 822 
 823             localRepo.push(editHash, repo.url(), &quot;newbranch2&quot;);
 824             TestBotRunner.runPeriodicItems(notifyBot);
 825             listServer.processIncoming();
 826 
 827             var newConversation = mailmanList.conversations(Duration.ofDays(1)).stream()
 828                                              .filter(c -&gt; !c.equals(conversations.get(0)))
 829                                              .findFirst().orElseThrow();
 830             email = newConversation.first();
 831             assertEquals(listAddress, email.sender());
 832             assertEquals(sender, email.author());
 833             assertEquals(email.recipients(), List.of(listAddress));
 834             assertEquals(&quot;git: test: created branch newbranch2 based on the branch newbranch1 containing 0 unique commits&quot;, email.subject());
 835             assertEquals(&quot;The new branch newbranch2 is currently identical to the newbranch1 branch.&quot;, email.body());
 836         }
 837     }
 838 
 839     @Test
 840     void testMailingListNoIdempotence(TestInfo testInfo) throws IOException {
 841         try (var listServer = new TestMailmanServer();
 842              var credentials = new HostCredentials(testInfo);
 843              var tempFolder = new TemporaryDirectory()) {
 844             var repo = credentials.getHostedRepository();
 845             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 846             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 847             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 848             credentials.commitLock(localRepo);
 849             localRepo.pushAll(repo.url());
 850 
 851             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 852             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 853             var mailmanList = mailmanServer.getList(listAddress.address());
 854             var tagStorage = createTagStorage(repo);
 855             var branchStorage = createBranchStorage(repo);
 856             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 857             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 858 
 859             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 860             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null,
 861                                                  false, false, false, false,
 862                                                  MailingListUpdater.Mode.ALL,
 863                                                  Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;), Pattern.compile(&quot;none&quot;));
 864             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 865                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 866 
 867             // No mail should be sent on the first run as there is no history
 868             TestBotRunner.runPeriodicItems(notifyBot);
 869             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 870 
 871             // Save history state
 872             var historyHash = localRepo.fetch(repo.url(), &quot;history&quot;);
 873 
 874             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 875             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 876             TestBotRunner.runPeriodicItems(notifyBot);
 877             listServer.processIncoming();
 878 
 879             var conversations = mailmanList.conversations(Duration.ofDays(1));
 880             assertEquals(1, conversations.size());
 881 
 882             // Reset the history
 883             localRepo.push(historyHash, repo.url(), &quot;history&quot;, true);
 884             TestBotRunner.runPeriodicItems(notifyBot);
 885             listServer.processIncoming();
 886 
 887             // There should now be a duplicate mail
 888             conversations = mailmanList.conversations(Duration.ofDays(1));
 889             assertEquals(2, conversations.size());
 890         }
 891     }
 892 
 893     @Test
 894     void testIssue(TestInfo testInfo) throws IOException {
 895         try (var credentials = new HostCredentials(testInfo);
 896              var tempFolder = new TemporaryDirectory()) {
 897             var repo = credentials.getHostedRepository();
 898             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 899             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 900             credentials.commitLock(localRepo);
 901             localRepo.pushAll(repo.url());
 902 
 903             var tagStorage = createTagStorage(repo);
 904             var branchStorage = createBranchStorage(repo);
 905             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 906             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 907 
 908             var issueProject = credentials.getIssueProject();
 909             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
 910             var updater = new IssueUpdater(issueProject, false, null, true, commitIcon, true, null);
 911             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 912                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 913 
 914             // Initialize history
 915             TestBotRunner.runPeriodicItems(notifyBot);
 916 
 917             // Create an issue and commit a fix
 918             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;type&quot;, &quot;Enhancement&quot;));
 919             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
 920             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 921             TestBotRunner.runPeriodicItems(notifyBot);
 922 
 923             // The changeset should be reflected in a comment
 924             var comments = issue.comments();
 925             assertEquals(1, comments.size());
 926             var comment = comments.get(0);
 927             assertTrue(comment.body().contains(editHash.abbreviate()));
 928 
 929             // And in a link
 930             var links = issue.links();
 931             assertEquals(1, links.size());
 932             var link = links.get(0);
 933             assertEquals(commitIcon, link.iconUrl().orElseThrow());
 934             assertEquals(&quot;Commit&quot;, link.title().orElseThrow());
 935             assertEquals(repo.webUrl(editHash), link.uri().orElseThrow());
 936 
 937             // As well as a fixVersion
 938             var fixVersions = issue.fixVersions();
 939             assertEquals(1, fixVersions.size());
 940             var fixVersion = fixVersions.get(0);
 941             assertEquals(&quot;0.1&quot;, fixVersion);
 942         }
 943     }
 944 
 945     @Test
 946     void testIssueNoVersion(TestInfo testInfo) throws IOException {
 947         try (var credentials = new HostCredentials(testInfo);
 948              var tempFolder = new TemporaryDirectory()) {
 949             var repo = credentials.getHostedRepository();
 950             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 951             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
 952             credentials.commitLock(localRepo);
 953             localRepo.pushAll(repo.url());
 954 
 955             var tagStorage = createTagStorage(repo);
 956             var branchStorage = createBranchStorage(repo);
 957             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 958             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 959 
 960             var issueProject = credentials.getIssueProject();
 961             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
 962             var updater = new IssueUpdater(issueProject, false, null, true, commitIcon, true, null);
 963             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 964                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 965 
 966             // Initialize history
 967             TestBotRunner.runPeriodicItems(notifyBot);
 968 
 969             // Create an issue and commit a fix
 970             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;type&quot;, &quot;Enhancement&quot;));
 971             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
 972             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 973             TestBotRunner.runPeriodicItems(notifyBot);
 974 
 975             // The changeset should be reflected in a comment
 976             var comments = issue.comments();
 977             assertEquals(1, comments.size());
 978             var comment = comments.get(0);
 979             assertTrue(comment.body().contains(editHash.abbreviate()));
 980 
 981             // But not in the fixVersion
 982             var fixVersions = issue.fixVersions();
 983             assertEquals(0, fixVersions.size());
 984         }
 985     }
 986 
 987     @Test
 988     void testIssueConfiguredVersionNoCommit(TestInfo testInfo) throws IOException {
 989         try (var credentials = new HostCredentials(testInfo);
 990              var tempFolder = new TemporaryDirectory()) {
 991             var repo = credentials.getHostedRepository();
 992             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 993             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
 994             credentials.commitLock(localRepo);
 995             localRepo.pushAll(repo.url());
 996 
 997             var tagStorage = createTagStorage(repo);
 998             var branchStorage = createBranchStorage(repo);
 999             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1000             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1001 
1002             var issueProject = credentials.getIssueProject();
1003             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
1004             var updater = new IssueUpdater(issueProject, false, null, false, commitIcon, true,&quot;2.0&quot;);
1005             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1006                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1007 
1008             // Initialize history
1009             TestBotRunner.runPeriodicItems(notifyBot);
1010 
1011             // Create an issue and commit a fix
1012             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;type&quot;, &quot;Enhancement&quot;));
1013             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1014             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1015             TestBotRunner.runPeriodicItems(notifyBot);
1016 
1017             // The changeset should not reflected in a comment
1018             var comments = issue.comments();
1019             assertEquals(1, comments.size());
1020             var comment = comments.get(0);
1021             assertTrue(comment.body().contains(editHash.abbreviate()));
1022 
1023             // As well as a fixVersion - but not the one from the repo
1024             var fixVersions = issue.fixVersions();
1025             assertEquals(1, fixVersions.size());
1026             var fixVersion = fixVersions.get(0);
1027             assertEquals(&quot;2.0&quot;, fixVersion);
1028 
1029             // And no commit link
1030             var links = issue.links();
1031             assertEquals(0, links.size());
1032         }
1033     }
1034 
1035     @Test
1036     void testIssueIdempotence(TestInfo testInfo) throws IOException {
1037         try (var credentials = new HostCredentials(testInfo);
1038              var tempFolder = new TemporaryDirectory()) {
1039             var repo = credentials.getHostedRepository();
1040             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1041             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1042             credentials.commitLock(localRepo);
1043             localRepo.pushAll(repo.url());
1044 
1045             var tagStorage = createTagStorage(repo);
1046             var branchStorage = createBranchStorage(repo);
1047             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1048             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1049 
1050             var issueProject = credentials.getIssueProject();
1051             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
1052             var updater = new IssueUpdater(issueProject, false, null, true, commitIcon, true, null);
1053             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1054                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1055 
1056             // Initialize history
1057             TestBotRunner.runPeriodicItems(notifyBot);
1058 
1059             // Save the state
1060             var historyState = localRepo.fetch(repo.url(), &quot;history&quot;);
1061 
1062             // Create an issue and commit a fix
1063             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;type&quot;, &quot;Enhancement&quot;));
1064             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1065             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1066             TestBotRunner.runPeriodicItems(notifyBot);
1067 
1068             // The changeset should be reflected in a comment
1069             var comments = issue.comments();
1070             assertEquals(1, comments.size());
1071             var comment = comments.get(0);
1072             assertTrue(comment.body().contains(editHash.abbreviate()));
1073 
1074             // And in a link
1075             var links = issue.links();
1076             assertEquals(1, links.size());
1077             var link = links.get(0);
1078             assertEquals(commitIcon, link.iconUrl().orElseThrow());
1079             assertEquals(&quot;Commit&quot;, link.title().orElseThrow());
1080             assertEquals(repo.webUrl(editHash), link.uri().orElseThrow());
1081 
1082             // As well as a fixVersion
1083             var fixVersions = issue.fixVersions();
1084             assertEquals(1, fixVersions.size());
1085             var fixVersion = fixVersions.get(0);
1086             assertEquals(&quot;0.1&quot;, fixVersion);
1087 
1088             // Wipe the history
1089             localRepo.push(historyState, repo.url(), &quot;history&quot;, true);
1090 
1091             // Run it again
1092             TestBotRunner.runPeriodicItems(notifyBot);
1093 
1094             // There should be no new comments, links or fixVersions
1095             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1096             assertEquals(1, updatedIssue.comments().size());
1097             assertEquals(1, updatedIssue.links().size());
1098             assertEquals(1, updatedIssue.fixVersions().size());
1099         }
1100     }
1101 
1102     @Test
1103     void testIssuePoolVersion(TestInfo testInfo) throws IOException {
1104         try (var credentials = new HostCredentials(testInfo);
1105              var tempFolder = new TemporaryDirectory()) {
1106             var repo = credentials.getHostedRepository();
1107             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1108             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1109             credentials.commitLock(localRepo);
1110             localRepo.pushAll(repo.url());
1111 
1112             var tagStorage = createTagStorage(repo);
1113             var branchStorage = createBranchStorage(repo);
1114             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1115             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1116 
1117             var issueProject = credentials.getIssueProject();
1118             var updater = new IssueUpdater(issueProject, false, null, false, null, true, &quot;12u14&quot;);
1119             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1120                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1121 
1122             // Initialize history
1123             TestBotRunner.runPeriodicItems(notifyBot);
1124 
1125             // Create an issue and commit a fix
1126             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;type&quot;, &quot;Enhancement&quot;));
1127             issue.addFixVersion(&quot;12-pool&quot;);
1128             issue.addFixVersion(&quot;tbd13&quot;);
1129             issue.addFixVersion(&quot;unknown&quot;);
1130 
1131             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1132             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1133             TestBotRunner.runPeriodicItems(notifyBot);
1134 
1135             // The fixVersion should have been updated
1136             var fixVersions = issue.fixVersions();
1137             assertEquals(1, fixVersions.size());
1138             assertEquals(&quot;12u14&quot;, fixVersions.get(0));
1139         }
1140     }
1141 
1142     @Test
1143     void testIssuePoolOpenVersion(TestInfo testInfo) throws IOException {
1144         try (var credentials = new HostCredentials(testInfo);
1145              var tempFolder = new TemporaryDirectory()) {
1146             var repo = credentials.getHostedRepository();
1147             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1148             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1149             credentials.commitLock(localRepo);
1150             localRepo.pushAll(repo.url());
1151 
1152             var tagStorage = createTagStorage(repo);
1153             var branchStorage = createBranchStorage(repo);
1154             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1155             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1156 
1157             var issueProject = credentials.getIssueProject();
1158             var updater = new IssueUpdater(issueProject, false, null, false, null, true, &quot;12u14&quot;);
1159             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1160                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1161 
1162             // Initialize history
1163             TestBotRunner.runPeriodicItems(notifyBot);
1164 
1165             // Create an issue and commit a fix
1166             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;type&quot;, &quot;Enhancement&quot;));
1167             issue.addFixVersion(&quot;12-open&quot;);
1168             issue.addFixVersion(&quot;tbd13&quot;);
1169             issue.addFixVersion(&quot;unknown&quot;);
1170 
1171             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1172             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1173             TestBotRunner.runPeriodicItems(notifyBot);
1174 
1175             // The fixVersion should have been updated
1176             var fixVersions = issue.fixVersions();
1177             assertEquals(1, fixVersions.size());
1178             assertEquals(&quot;12u14&quot;, fixVersions.get(0));
1179         }
1180     }
1181 
1182     @Test
1183     void testIssueBackport(TestInfo testInfo) throws IOException {
1184         try (var credentials = new HostCredentials(testInfo);
1185              var tempFolder = new TemporaryDirectory()) {
1186             var repo = credentials.getHostedRepository();
1187             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1188             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1189             credentials.commitLock(localRepo);
1190             localRepo.pushAll(repo.url());
1191 
1192             var tagStorage = createTagStorage(repo);
1193             var branchStorage = createBranchStorage(repo);
1194             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1195             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1196 
1197             var issueProject = credentials.getIssueProject();
1198             var updater = new IssueUpdater(issueProject, false, null, false, null, true, &quot;12.0.2&quot;);
1199             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1200                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1201 
1202             // Initialize history
1203             TestBotRunner.runPeriodicItems(notifyBot);
1204 
1205             // Create an issue and commit a fix
1206             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;type&quot;, &quot;Enhancement&quot;));
1207             issue.addFixVersion(&quot;13.0.1&quot;);
1208 
1209             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1210             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1211             TestBotRunner.runPeriodicItems(notifyBot);
1212 
1213             // The fixVersion should not have been updated
1214             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1215             var fixVersions = updatedIssue.fixVersions();
1216             assertEquals(1, fixVersions.size());
1217             assertEquals(&quot;13.0.1&quot;, fixVersions.get(0));
1218 
1219             // There should be a link
1220             var links = updatedIssue.links();
1221             assertEquals(1, links.size());
1222             var link = links.get(0);
1223             var backport = link.issue().orElseThrow();
1224 
1225             // The backport issue should have a correct fixVersion
1226             var backportFixVersions = backport.fixVersions();
1227             assertEquals(1, backportFixVersions.size());
1228             assertEquals(&quot;12.0.2&quot;, backportFixVersions.get(0));
1229             assertEquals(&quot;Backport&quot;, backport.properties().get(&quot;type&quot;));
1230         }
1231     }
1232 
1233     @Test
1234     void testPullRequest(TestInfo testInfo) throws IOException {
1235         try (var credentials = new HostCredentials(testInfo);
1236              var tempFolder = new TemporaryDirectory()) {
1237             var repo = credentials.getHostedRepository();
1238             var reviewer = credentials.getHostedRepository();
1239             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1240             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1241             credentials.commitLock(localRepo);
1242             localRepo.pushAll(repo.url());
1243 
1244             var tagStorage = createTagStorage(repo);
1245             var branchStorage = createBranchStorage(repo);
1246             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1247             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1248 
1249             var issueProject = credentials.getIssueProject();
1250             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
1251             var updater = new IssueUpdater(issueProject, true, reviewIcon, false, null, false, null);
1252             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1253                                           prIssuesStorage, List.of(), List.of(updater), Set.of(&quot;rfr&quot;),
1254                                           Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)));
1255 
1256             // Initialize history
1257             TestBotRunner.runPeriodicItems(notifyBot);
1258 
1259             // Create an issue and a pull request to fix it
1260             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;type&quot;, &quot;Enhancement&quot;));
1261             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
1262             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1263             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
1264             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1265             TestBotRunner.runPeriodicItems(notifyBot);
1266 
1267             // The issue should not yet contain a link to the PR
1268             var links = issue.links();
1269             assertEquals(0, links.size());
1270 
1271             // Just a label isn&#39;t enough
1272             pr.addLabel(&quot;rfr&quot;);
1273             TestBotRunner.runPeriodicItems(notifyBot);
1274             links = issue.links();
1275             assertEquals(0, links.size());
1276 
1277             // Neither is just a comment
1278             pr.removeLabel(&quot;rfr&quot;);
1279             var reviewPr = reviewer.pullRequest(pr.id());
1280             reviewPr.addComment(&quot;This is now ready&quot;);
1281             TestBotRunner.runPeriodicItems(notifyBot);
1282             links = issue.links();
1283             assertEquals(0, links.size());
1284 
1285             // Both are needed
1286             pr.addLabel(&quot;rfr&quot;);
1287             TestBotRunner.runPeriodicItems(notifyBot);
1288 
1289             // The issue should now contain a link to the PR
1290             links = issue.links();
1291             assertEquals(1, links.size());
1292             assertEquals(pr.webUrl(), links.get(0).uri().orElseThrow());
1293             assertEquals(reviewIcon, links.get(0).iconUrl().orElseThrow());
1294 
1295             // Add another issue
1296             var issue2 = issueProject.createIssue(&quot;This is another issue&quot;, List.of(&quot;Yes indeed&quot;), Map.of(&quot;type&quot;, &quot;Enhancement&quot;));
1297             pr.setBody(&quot;\n\n## Issues\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue\n[&quot; + issue2.id() +
1298                                &quot;](http://www.test2.test/): The second issue&quot;);
1299             TestBotRunner.runPeriodicItems(notifyBot);
1300 
1301             // Both issues should contain a link to the PR
1302             var links1 = issue.links();
1303             assertEquals(1, links1.size());
1304             assertEquals(pr.webUrl(), links1.get(0).uri().orElseThrow());
1305             var links2 = issue2.links();
1306             assertEquals(1, links2.size());
1307             assertEquals(pr.webUrl(), links2.get(0).uri().orElseThrow());
1308 
1309             // Drop the first one
1310             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue2.id() + &quot;](http://www.test2.test/): That other issue&quot;);
1311             TestBotRunner.runPeriodicItems(notifyBot);
1312 
1313             // Only the second issue should now contain a link to the PR
1314             links1 = issue.links();
1315             assertEquals(0, links1.size());
1316             links2 = issue2.links();
1317             assertEquals(1, links2.size());
1318             assertEquals(pr.webUrl(), links2.get(0).uri().orElseThrow());
1319         }
1320     }
1321 
1322     @Test
1323     void testPullRequestNoReview(TestInfo testInfo) throws IOException {
1324         try (var credentials = new HostCredentials(testInfo);
1325              var tempFolder = new TemporaryDirectory()) {
1326             var repo = credentials.getHostedRepository();
1327             var reviewer = credentials.getHostedRepository();
1328             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1329             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1330             credentials.commitLock(localRepo);
1331             localRepo.pushAll(repo.url());
1332 
1333             var tagStorage = createTagStorage(repo);
1334             var branchStorage = createBranchStorage(repo);
1335             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1336             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1337 
1338             var issueProject = credentials.getIssueProject();
1339             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
1340             var updater = new IssueUpdater(issueProject, false, reviewIcon, false, null, false,null);
1341             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1342                                           prIssuesStorage, List.of(), List.of(updater), Set.of(&quot;rfr&quot;),
1343                                           Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)));
1344             // Initialize history
1345             TestBotRunner.runPeriodicItems(notifyBot);
1346 
1347             // Create an issue and a pull request to fix it
1348             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;type&quot;, &quot;Enhancement&quot;));
1349             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
1350             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1351             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
1352             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1353             TestBotRunner.runPeriodicItems(notifyBot);
1354 
1355             // Add required label
1356             pr.addLabel(&quot;rfr&quot;);
1357             TestBotRunner.runPeriodicItems(notifyBot);
1358 
1359             // And the required comment
1360             var reviewPr = reviewer.pullRequest(pr.id());
1361             reviewPr.addComment(&quot;This is now ready&quot;);
1362             TestBotRunner.runPeriodicItems(notifyBot);
1363 
1364             // The issue should still not contain a link to the PR
1365             var links = issue.links();
1366             assertEquals(0, links.size());
1367         }
1368     }
1369 }
    </pre>
  </body>
</html>