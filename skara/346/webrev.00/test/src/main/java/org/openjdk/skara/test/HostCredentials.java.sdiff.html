<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/src/main/java/org/openjdk/skara/test/HostCredentials.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../../issuetracker/src/test/java/org/openjdk/skara/issuetracker/IssueTrackerTests.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="IssueData.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/src/main/java/org/openjdk/skara/test/HostCredentials.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.test;
 24 
 25 import org.openjdk.skara.forge.*;
 26 import org.openjdk.skara.host.*;
 27 import org.openjdk.skara.issuetracker.*;
 28 import org.openjdk.skara.json.*;
 29 import org.openjdk.skara.network.URIBuilder;
<span class="line-removed"> 30 import org.openjdk.skara.proxy.HttpProxy;</span>
 31 import org.openjdk.skara.vcs.*;
 32 
 33 import org.junit.jupiter.api.TestInfo;
 34 
 35 import java.io.*;
 36 import java.nio.charset.StandardCharsets;
 37 import java.nio.file.*;
 38 import java.time.*;
 39 import java.time.format.DateTimeFormatter;
 40 import java.util.*;
 41 import java.util.logging.Logger;
 42 
 43 public class HostCredentials implements AutoCloseable {
 44     private final String testName;
 45     private final Credentials credentials;
 46     private final List&lt;PullRequest&gt; pullRequestsToBeClosed = new ArrayList&lt;&gt;();
 47     private final List&lt;Issue&gt; issuesToBeClosed = new ArrayList&lt;&gt;();
 48     private HostedRepository credentialsLock;
 49     private int nextHostIndex;
 50 
</pre>
<hr />
<pre>
127         }
128 
129         @Override
130         public HostedRepository getHostedRepository(Forge host) {
131             return host.repository(config.get(&quot;project&quot;).asString()).orElseThrow();
132         }
133 
134         @Override
135         public IssueProject getIssueProject(IssueTracker host) {
136             return host.project(config.get(&quot;project&quot;).asString());
137         }
138 
139         @Override
140         public String getNamespaceName() {
141             return config.get(&quot;namespace&quot;).asString();
142         }
143     }
144 
145     private static class JiraCredentials implements Credentials {
146         private final JSONObject config;

147 
148         JiraCredentials(JSONObject config) {
149             this.config = config;

150         }
151 
152         @Override
153         public Forge createRepositoryHost(int userIndex) {
<span class="line-modified">154             throw new RuntimeException(&quot;not supported&quot;);</span>
155         }
156 
157         @Override
158         public IssueTracker createIssueHost(int userIndex) {
159             var hostUri = URIBuilder.base(config.get(&quot;host&quot;).asString()).build();
160             var users = config.get(&quot;users&quot;).asArray();
161             var pat = new Credential(users.get(userIndex).get(&quot;name&quot;).asString(),
162                                      users.get(userIndex).get(&quot;pat&quot;).asString());
163             return IssueTracker.from(&quot;jira&quot;, hostUri, pat, config);
164         }
165 
166         @Override
167         public HostedRepository getHostedRepository(Forge host) {
<span class="line-modified">168             return host.repository(config.get(&quot;project&quot;).asString()).orElseThrow();</span>
169         }
170 
171         @Override
172         public IssueProject getIssueProject(IssueTracker host) {
173             return host.project(config.get(&quot;project&quot;).asString());
174         }
175 
176         @Override
177         public String getNamespaceName() {
178             return config.get(&quot;namespace&quot;).asString();
179         }
180     }
181 
182     private static class TestCredentials implements Credentials {
183         private final List&lt;TestHost&gt; hosts = new ArrayList&lt;&gt;();
184         private final List&lt;HostUser&gt; users = List.of(
185                 new HostUser(1, &quot;user1&quot;, &quot;User Number 1&quot;),
186                 new HostUser(2, &quot;user2&quot;, &quot;User Number 2&quot;),
187                 new HostUser(3, &quot;user3&quot;, &quot;User Number 3&quot;),
188                 new HostUser(4, &quot;user4&quot;, &quot;User Number 4&quot;)
</pre>
<hr />
<pre>
346         }
347         return repo;
348     }
349 
350     public IssueProject getIssueProject() {
351         var host = getIssueHost();
352         return credentials.getIssueProject(host);
353     }
354 
355     public PullRequest createPullRequest(HostedRepository hostedRepository, String targetRef, String sourceRef, String title, boolean draft) {
356         var pr = hostedRepository.createPullRequest(hostedRepository, targetRef, sourceRef, title, List.of(), draft);
357         pullRequestsToBeClosed.add(pr);
358         return pr;
359     }
360 
361     public PullRequest createPullRequest(HostedRepository hostedRepository, String targetRef, String sourceRef, String title) {
362         return createPullRequest(hostedRepository, targetRef, sourceRef, title, false);
363     }
364 
365     public Issue createIssue(IssueProject issueProject, String title) {
<span class="line-modified">366         var issue = issueProject.createIssue(title, List.of());</span>
367         issuesToBeClosed.add(issue);
368         return issue;
369     }
370 
371     public CensusBuilder getCensusBuilder() {
372         return CensusBuilder.create(credentials.getNamespaceName());
373     }
374 
375     @Override
376     public void close() {
377         for (var pr : pullRequestsToBeClosed) {
378             pr.setState(PullRequest.State.CLOSED);
379         }
380         for (var issue : issuesToBeClosed) {
381             issue.setState(Issue.State.CLOSED);
382         }
383         if (credentialsLock != null) {
384             try {
385                 releaseLock(credentialsLock);
386                 log.info(&quot;Released credentials lock for &quot; + testName);
</pre>
</td>
<td>
<hr />
<pre>
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.test;
 24 
 25 import org.openjdk.skara.forge.*;
 26 import org.openjdk.skara.host.*;
 27 import org.openjdk.skara.issuetracker.*;
 28 import org.openjdk.skara.json.*;
 29 import org.openjdk.skara.network.URIBuilder;

 30 import org.openjdk.skara.vcs.*;
 31 
 32 import org.junit.jupiter.api.TestInfo;
 33 
 34 import java.io.*;
 35 import java.nio.charset.StandardCharsets;
 36 import java.nio.file.*;
 37 import java.time.*;
 38 import java.time.format.DateTimeFormatter;
 39 import java.util.*;
 40 import java.util.logging.Logger;
 41 
 42 public class HostCredentials implements AutoCloseable {
 43     private final String testName;
 44     private final Credentials credentials;
 45     private final List&lt;PullRequest&gt; pullRequestsToBeClosed = new ArrayList&lt;&gt;();
 46     private final List&lt;Issue&gt; issuesToBeClosed = new ArrayList&lt;&gt;();
 47     private HostedRepository credentialsLock;
 48     private int nextHostIndex;
 49 
</pre>
<hr />
<pre>
126         }
127 
128         @Override
129         public HostedRepository getHostedRepository(Forge host) {
130             return host.repository(config.get(&quot;project&quot;).asString()).orElseThrow();
131         }
132 
133         @Override
134         public IssueProject getIssueProject(IssueTracker host) {
135             return host.project(config.get(&quot;project&quot;).asString());
136         }
137 
138         @Override
139         public String getNamespaceName() {
140             return config.get(&quot;namespace&quot;).asString();
141         }
142     }
143 
144     private static class JiraCredentials implements Credentials {
145         private final JSONObject config;
<span class="line-added">146         private final TestCredentials repoCredentials;</span>
147 
148         JiraCredentials(JSONObject config) {
149             this.config = config;
<span class="line-added">150             this.repoCredentials = new TestCredentials();</span>
151         }
152 
153         @Override
154         public Forge createRepositoryHost(int userIndex) {
<span class="line-modified">155             return repoCredentials.createRepositoryHost(userIndex);</span>
156         }
157 
158         @Override
159         public IssueTracker createIssueHost(int userIndex) {
160             var hostUri = URIBuilder.base(config.get(&quot;host&quot;).asString()).build();
161             var users = config.get(&quot;users&quot;).asArray();
162             var pat = new Credential(users.get(userIndex).get(&quot;name&quot;).asString(),
163                                      users.get(userIndex).get(&quot;pat&quot;).asString());
164             return IssueTracker.from(&quot;jira&quot;, hostUri, pat, config);
165         }
166 
167         @Override
168         public HostedRepository getHostedRepository(Forge host) {
<span class="line-modified">169             return repoCredentials.getHostedRepository(host);</span>
170         }
171 
172         @Override
173         public IssueProject getIssueProject(IssueTracker host) {
174             return host.project(config.get(&quot;project&quot;).asString());
175         }
176 
177         @Override
178         public String getNamespaceName() {
179             return config.get(&quot;namespace&quot;).asString();
180         }
181     }
182 
183     private static class TestCredentials implements Credentials {
184         private final List&lt;TestHost&gt; hosts = new ArrayList&lt;&gt;();
185         private final List&lt;HostUser&gt; users = List.of(
186                 new HostUser(1, &quot;user1&quot;, &quot;User Number 1&quot;),
187                 new HostUser(2, &quot;user2&quot;, &quot;User Number 2&quot;),
188                 new HostUser(3, &quot;user3&quot;, &quot;User Number 3&quot;),
189                 new HostUser(4, &quot;user4&quot;, &quot;User Number 4&quot;)
</pre>
<hr />
<pre>
347         }
348         return repo;
349     }
350 
351     public IssueProject getIssueProject() {
352         var host = getIssueHost();
353         return credentials.getIssueProject(host);
354     }
355 
356     public PullRequest createPullRequest(HostedRepository hostedRepository, String targetRef, String sourceRef, String title, boolean draft) {
357         var pr = hostedRepository.createPullRequest(hostedRepository, targetRef, sourceRef, title, List.of(), draft);
358         pullRequestsToBeClosed.add(pr);
359         return pr;
360     }
361 
362     public PullRequest createPullRequest(HostedRepository hostedRepository, String targetRef, String sourceRef, String title) {
363         return createPullRequest(hostedRepository, targetRef, sourceRef, title, false);
364     }
365 
366     public Issue createIssue(IssueProject issueProject, String title) {
<span class="line-modified">367         var issue = issueProject.createIssue(title, List.of(), Map.of());</span>
368         issuesToBeClosed.add(issue);
369         return issue;
370     }
371 
372     public CensusBuilder getCensusBuilder() {
373         return CensusBuilder.create(credentials.getNamespaceName());
374     }
375 
376     @Override
377     public void close() {
378         for (var pr : pullRequestsToBeClosed) {
379             pr.setState(PullRequest.State.CLOSED);
380         }
381         for (var issue : issuesToBeClosed) {
382             issue.setState(Issue.State.CLOSED);
383         }
384         if (credentialsLock != null) {
385             try {
386                 releaseLock(credentialsLock);
387                 log.info(&quot;Released credentials lock for &quot; + testName);
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../../issuetracker/src/test/java/org/openjdk/skara/issuetracker/IssueTrackerTests.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="IssueData.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>