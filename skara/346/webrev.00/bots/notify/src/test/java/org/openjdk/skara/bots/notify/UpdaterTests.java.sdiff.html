<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/notify/IssueUpdater.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../pr/src/test/java/org/openjdk/skara/bots/pr/CheckTests.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 898             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 899             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 900             credentials.commitLock(localRepo);
 901             localRepo.pushAll(repo.url());
 902 
 903             var tagStorage = createTagStorage(repo);
 904             var branchStorage = createBranchStorage(repo);
 905             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 906             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 907 
 908             var issueProject = credentials.getIssueProject();
 909             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
 910             var updater = new IssueUpdater(issueProject, false, null, true, commitIcon, true, null);
 911             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 912                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 913 
 914             // Initialize history
 915             TestBotRunner.runPeriodicItems(notifyBot);
 916 
 917             // Create an issue and commit a fix
<span class="line-modified"> 918             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;));</span>
 919             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
 920             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 921             TestBotRunner.runPeriodicItems(notifyBot);
 922 
 923             // The changeset should be reflected in a comment
 924             var comments = issue.comments();
 925             assertEquals(1, comments.size());
 926             var comment = comments.get(0);
 927             assertTrue(comment.body().contains(editHash.abbreviate()));
 928 
 929             // And in a link
 930             var links = issue.links();
 931             assertEquals(1, links.size());
 932             var link = links.get(0);
 933             assertEquals(commitIcon, link.iconUrl().orElseThrow());
<span class="line-modified"> 934             assertEquals(&quot;Commit&quot;, link.title());</span>
<span class="line-modified"> 935             assertEquals(repo.webUrl(editHash), link.uri());</span>
 936 
 937             // As well as a fixVersion
 938             var fixVersions = issue.fixVersions();
 939             assertEquals(1, fixVersions.size());
 940             var fixVersion = fixVersions.get(0);
 941             assertEquals(&quot;0.1&quot;, fixVersion);
<span class="line-removed"> 942 </span>
<span class="line-removed"> 943             // There should be no open issues</span>
<span class="line-removed"> 944             assertEquals(0, issueProject.issues().size());</span>
 945         }
 946     }
 947 
 948     @Test
 949     void testIssueNoVersion(TestInfo testInfo) throws IOException {
 950         try (var credentials = new HostCredentials(testInfo);
 951              var tempFolder = new TemporaryDirectory()) {
 952             var repo = credentials.getHostedRepository();
 953             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 954             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
 955             credentials.commitLock(localRepo);
 956             localRepo.pushAll(repo.url());
 957 
 958             var tagStorage = createTagStorage(repo);
 959             var branchStorage = createBranchStorage(repo);
 960             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 961             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 962 
 963             var issueProject = credentials.getIssueProject();
 964             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
 965             var updater = new IssueUpdater(issueProject, false, null, true, commitIcon, true, null);
 966             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 967                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 968 
 969             // Initialize history
 970             TestBotRunner.runPeriodicItems(notifyBot);
 971 
 972             // Create an issue and commit a fix
<span class="line-modified"> 973             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;));</span>
 974             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
 975             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 976             TestBotRunner.runPeriodicItems(notifyBot);
 977 
 978             // The changeset should be reflected in a comment
 979             var comments = issue.comments();
 980             assertEquals(1, comments.size());
 981             var comment = comments.get(0);
 982             assertTrue(comment.body().contains(editHash.abbreviate()));
 983 
 984             // But not in the fixVersion
 985             var fixVersions = issue.fixVersions();
 986             assertEquals(0, fixVersions.size());
<span class="line-removed"> 987 </span>
<span class="line-removed"> 988             // There should be no open issues</span>
<span class="line-removed"> 989             assertEquals(0, issueProject.issues().size());</span>
 990         }
 991     }
 992 
 993     @Test
 994     void testIssueConfiguredVersionNoCommit(TestInfo testInfo) throws IOException {
 995         try (var credentials = new HostCredentials(testInfo);
 996              var tempFolder = new TemporaryDirectory()) {
 997             var repo = credentials.getHostedRepository();
 998             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 999             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1000             credentials.commitLock(localRepo);
1001             localRepo.pushAll(repo.url());
1002 
1003             var tagStorage = createTagStorage(repo);
1004             var branchStorage = createBranchStorage(repo);
1005             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1006             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1007 
1008             var issueProject = credentials.getIssueProject();
1009             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
1010             var updater = new IssueUpdater(issueProject, false, null, false, commitIcon, true,&quot;2.0&quot;);
1011             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1012                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1013 
1014             // Initialize history
1015             TestBotRunner.runPeriodicItems(notifyBot);
1016 
1017             // Create an issue and commit a fix
<span class="line-modified">1018             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;));</span>
1019             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1020             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1021             TestBotRunner.runPeriodicItems(notifyBot);
1022 
1023             // The changeset should not reflected in a comment
1024             var comments = issue.comments();
1025             assertEquals(1, comments.size());
1026             var comment = comments.get(0);
1027             assertTrue(comment.body().contains(editHash.abbreviate()));
1028 
1029             // As well as a fixVersion - but not the one from the repo
1030             var fixVersions = issue.fixVersions();
1031             assertEquals(1, fixVersions.size());
1032             var fixVersion = fixVersions.get(0);
1033             assertEquals(&quot;2.0&quot;, fixVersion);
1034 
1035             // And no commit link
1036             var links = issue.links();
1037             assertEquals(0, links.size());
<span class="line-removed">1038 </span>
<span class="line-removed">1039             // There should be no open issues</span>
<span class="line-removed">1040             assertEquals(0, issueProject.issues().size());</span>
1041         }
1042     }
1043 
1044     @Test
1045     void testIssueIdempotence(TestInfo testInfo) throws IOException {
1046         try (var credentials = new HostCredentials(testInfo);
1047              var tempFolder = new TemporaryDirectory()) {
1048             var repo = credentials.getHostedRepository();
1049             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1050             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1051             credentials.commitLock(localRepo);
1052             localRepo.pushAll(repo.url());
1053 
1054             var tagStorage = createTagStorage(repo);
1055             var branchStorage = createBranchStorage(repo);
1056             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1057             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1058 
1059             var issueProject = credentials.getIssueProject();
1060             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
1061             var updater = new IssueUpdater(issueProject, false, null, true, commitIcon, true, null);
1062             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1063                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1064 
1065             // Initialize history
1066             TestBotRunner.runPeriodicItems(notifyBot);
1067 
1068             // Save the state
1069             var historyState = localRepo.fetch(repo.url(), &quot;history&quot;);
1070 
1071             // Create an issue and commit a fix
<span class="line-modified">1072             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;));</span>
1073             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1074             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1075             TestBotRunner.runPeriodicItems(notifyBot);
1076 
1077             // The changeset should be reflected in a comment
1078             var comments = issue.comments();
1079             assertEquals(1, comments.size());
1080             var comment = comments.get(0);
1081             assertTrue(comment.body().contains(editHash.abbreviate()));
1082 
1083             // And in a link
1084             var links = issue.links();
1085             assertEquals(1, links.size());
1086             var link = links.get(0);
1087             assertEquals(commitIcon, link.iconUrl().orElseThrow());
<span class="line-modified">1088             assertEquals(&quot;Commit&quot;, link.title());</span>
<span class="line-modified">1089             assertEquals(repo.webUrl(editHash), link.uri());</span>
1090 
1091             // As well as a fixVersion
1092             var fixVersions = issue.fixVersions();
1093             assertEquals(1, fixVersions.size());
1094             var fixVersion = fixVersions.get(0);
1095             assertEquals(&quot;0.1&quot;, fixVersion);
1096 
1097             // Wipe the history
1098             localRepo.push(historyState, repo.url(), &quot;history&quot;, true);
1099 
1100             // Run it again
1101             TestBotRunner.runPeriodicItems(notifyBot);
1102 
1103             // There should be no new comments, links or fixVersions
1104             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1105             assertEquals(1, updatedIssue.comments().size());
1106             assertEquals(1, updatedIssue.links().size());
1107             assertEquals(1, updatedIssue.fixVersions().size());





























































































































1108 
<span class="line-modified">1109             // There should be no open issues</span>
<span class="line-modified">1110             assertEquals(0, issueProject.issues().size());</span>



1111         }
1112     }
1113 
1114     @Test
1115     void testPullRequest(TestInfo testInfo) throws IOException {
1116         try (var credentials = new HostCredentials(testInfo);
1117              var tempFolder = new TemporaryDirectory()) {
1118             var repo = credentials.getHostedRepository();
1119             var reviewer = credentials.getHostedRepository();
1120             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1121             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1122             credentials.commitLock(localRepo);
1123             localRepo.pushAll(repo.url());
1124 
1125             var tagStorage = createTagStorage(repo);
1126             var branchStorage = createBranchStorage(repo);
1127             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1128             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1129 
1130             var issueProject = credentials.getIssueProject();
1131             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
1132             var updater = new IssueUpdater(issueProject, true, reviewIcon, false, null, false, null);
1133             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1134                                           prIssuesStorage, List.of(), List.of(updater), Set.of(&quot;rfr&quot;),
1135                                           Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)));
1136 
1137             // Initialize history
1138             TestBotRunner.runPeriodicItems(notifyBot);
1139 
1140             // Create an issue and a pull request to fix it
<span class="line-modified">1141             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;));</span>
1142             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
1143             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1144             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
1145             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1146             TestBotRunner.runPeriodicItems(notifyBot);
1147 
1148             // The issue should not yet contain a link to the PR
1149             var links = issue.links();
1150             assertEquals(0, links.size());
1151 
1152             // Just a label isn&#39;t enough
1153             pr.addLabel(&quot;rfr&quot;);
1154             TestBotRunner.runPeriodicItems(notifyBot);
1155             links = issue.links();
1156             assertEquals(0, links.size());
1157 
1158             // Neither is just a comment
1159             pr.removeLabel(&quot;rfr&quot;);
1160             var reviewPr = reviewer.pullRequest(pr.id());
1161             reviewPr.addComment(&quot;This is now ready&quot;);
1162             TestBotRunner.runPeriodicItems(notifyBot);
1163             links = issue.links();
1164             assertEquals(0, links.size());
1165 
1166             // Both are needed
1167             pr.addLabel(&quot;rfr&quot;);
1168             TestBotRunner.runPeriodicItems(notifyBot);
1169 
1170             // The issue should now contain a link to the PR
1171             links = issue.links();
1172             assertEquals(1, links.size());
<span class="line-modified">1173             assertEquals(pr.webUrl(), links.get(0).uri());</span>
1174             assertEquals(reviewIcon, links.get(0).iconUrl().orElseThrow());
1175 
1176             // Add another issue
<span class="line-modified">1177             var issue2 = issueProject.createIssue(&quot;This is another issue&quot;, List.of(&quot;Yes indeed&quot;));</span>
1178             pr.setBody(&quot;\n\n## Issues\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue\n[&quot; + issue2.id() +
1179                                &quot;](http://www.test2.test/): The second issue&quot;);
1180             TestBotRunner.runPeriodicItems(notifyBot);
1181 
1182             // Both issues should contain a link to the PR
1183             var links1 = issue.links();
1184             assertEquals(1, links1.size());
<span class="line-modified">1185             assertEquals(pr.webUrl(), links1.get(0).uri());</span>
1186             var links2 = issue2.links();
1187             assertEquals(1, links2.size());
<span class="line-modified">1188             assertEquals(pr.webUrl(), links2.get(0).uri());</span>
1189 
1190             // Drop the first one
1191             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue2.id() + &quot;](http://www.test2.test/): That other issue&quot;);
1192             TestBotRunner.runPeriodicItems(notifyBot);
1193 
1194             // Only the second issue should now contain a link to the PR
1195             links1 = issue.links();
1196             assertEquals(0, links1.size());
1197             links2 = issue2.links();
1198             assertEquals(1, links2.size());
<span class="line-modified">1199             assertEquals(pr.webUrl(), links2.get(0).uri());</span>
1200         }
1201     }
1202 
1203     @Test
1204     void testPullRequestNoReview(TestInfo testInfo) throws IOException {
1205         try (var credentials = new HostCredentials(testInfo);
1206              var tempFolder = new TemporaryDirectory()) {
1207             var repo = credentials.getHostedRepository();
1208             var reviewer = credentials.getHostedRepository();
1209             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1210             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1211             credentials.commitLock(localRepo);
1212             localRepo.pushAll(repo.url());
1213 
1214             var tagStorage = createTagStorage(repo);
1215             var branchStorage = createBranchStorage(repo);
1216             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1217             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1218 
1219             var issueProject = credentials.getIssueProject();
1220             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
1221             var updater = new IssueUpdater(issueProject, false, reviewIcon, false, null, false,null);
1222             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1223                                           prIssuesStorage, List.of(), List.of(updater), Set.of(&quot;rfr&quot;),
1224                                           Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)));
1225             // Initialize history
1226             TestBotRunner.runPeriodicItems(notifyBot);
1227 
1228             // Create an issue and a pull request to fix it
<span class="line-modified">1229             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;));</span>
1230             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
1231             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1232             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
1233             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1234             TestBotRunner.runPeriodicItems(notifyBot);
1235 
1236             // Add required label
1237             pr.addLabel(&quot;rfr&quot;);
1238             TestBotRunner.runPeriodicItems(notifyBot);
1239 
1240             // And the required comment
1241             var reviewPr = reviewer.pullRequest(pr.id());
1242             reviewPr.addComment(&quot;This is now ready&quot;);
1243             TestBotRunner.runPeriodicItems(notifyBot);
1244 
1245             // The issue should still not contain a link to the PR
1246             var links = issue.links();
1247             assertEquals(0, links.size());
1248         }
1249     }
</pre>
</td>
<td>
<hr />
<pre>
 898             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 899             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 900             credentials.commitLock(localRepo);
 901             localRepo.pushAll(repo.url());
 902 
 903             var tagStorage = createTagStorage(repo);
 904             var branchStorage = createBranchStorage(repo);
 905             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 906             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 907 
 908             var issueProject = credentials.getIssueProject();
 909             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
 910             var updater = new IssueUpdater(issueProject, false, null, true, commitIcon, true, null);
 911             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 912                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 913 
 914             // Initialize history
 915             TestBotRunner.runPeriodicItems(notifyBot);
 916 
 917             // Create an issue and commit a fix
<span class="line-modified"> 918             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;type&quot;, &quot;Enhancement&quot;));</span>
 919             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
 920             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 921             TestBotRunner.runPeriodicItems(notifyBot);
 922 
 923             // The changeset should be reflected in a comment
 924             var comments = issue.comments();
 925             assertEquals(1, comments.size());
 926             var comment = comments.get(0);
 927             assertTrue(comment.body().contains(editHash.abbreviate()));
 928 
 929             // And in a link
 930             var links = issue.links();
 931             assertEquals(1, links.size());
 932             var link = links.get(0);
 933             assertEquals(commitIcon, link.iconUrl().orElseThrow());
<span class="line-modified"> 934             assertEquals(&quot;Commit&quot;, link.title().orElseThrow());</span>
<span class="line-modified"> 935             assertEquals(repo.webUrl(editHash), link.uri().orElseThrow());</span>
 936 
 937             // As well as a fixVersion
 938             var fixVersions = issue.fixVersions();
 939             assertEquals(1, fixVersions.size());
 940             var fixVersion = fixVersions.get(0);
 941             assertEquals(&quot;0.1&quot;, fixVersion);



 942         }
 943     }
 944 
 945     @Test
 946     void testIssueNoVersion(TestInfo testInfo) throws IOException {
 947         try (var credentials = new HostCredentials(testInfo);
 948              var tempFolder = new TemporaryDirectory()) {
 949             var repo = credentials.getHostedRepository();
 950             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 951             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
 952             credentials.commitLock(localRepo);
 953             localRepo.pushAll(repo.url());
 954 
 955             var tagStorage = createTagStorage(repo);
 956             var branchStorage = createBranchStorage(repo);
 957             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 958             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 959 
 960             var issueProject = credentials.getIssueProject();
 961             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
 962             var updater = new IssueUpdater(issueProject, false, null, true, commitIcon, true, null);
 963             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 964                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 965 
 966             // Initialize history
 967             TestBotRunner.runPeriodicItems(notifyBot);
 968 
 969             // Create an issue and commit a fix
<span class="line-modified"> 970             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;type&quot;, &quot;Enhancement&quot;));</span>
 971             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
 972             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 973             TestBotRunner.runPeriodicItems(notifyBot);
 974 
 975             // The changeset should be reflected in a comment
 976             var comments = issue.comments();
 977             assertEquals(1, comments.size());
 978             var comment = comments.get(0);
 979             assertTrue(comment.body().contains(editHash.abbreviate()));
 980 
 981             // But not in the fixVersion
 982             var fixVersions = issue.fixVersions();
 983             assertEquals(0, fixVersions.size());



 984         }
 985     }
 986 
 987     @Test
 988     void testIssueConfiguredVersionNoCommit(TestInfo testInfo) throws IOException {
 989         try (var credentials = new HostCredentials(testInfo);
 990              var tempFolder = new TemporaryDirectory()) {
 991             var repo = credentials.getHostedRepository();
 992             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 993             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
 994             credentials.commitLock(localRepo);
 995             localRepo.pushAll(repo.url());
 996 
 997             var tagStorage = createTagStorage(repo);
 998             var branchStorage = createBranchStorage(repo);
 999             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1000             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1001 
1002             var issueProject = credentials.getIssueProject();
1003             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
1004             var updater = new IssueUpdater(issueProject, false, null, false, commitIcon, true,&quot;2.0&quot;);
1005             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1006                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1007 
1008             // Initialize history
1009             TestBotRunner.runPeriodicItems(notifyBot);
1010 
1011             // Create an issue and commit a fix
<span class="line-modified">1012             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;type&quot;, &quot;Enhancement&quot;));</span>
1013             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1014             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1015             TestBotRunner.runPeriodicItems(notifyBot);
1016 
1017             // The changeset should not reflected in a comment
1018             var comments = issue.comments();
1019             assertEquals(1, comments.size());
1020             var comment = comments.get(0);
1021             assertTrue(comment.body().contains(editHash.abbreviate()));
1022 
1023             // As well as a fixVersion - but not the one from the repo
1024             var fixVersions = issue.fixVersions();
1025             assertEquals(1, fixVersions.size());
1026             var fixVersion = fixVersions.get(0);
1027             assertEquals(&quot;2.0&quot;, fixVersion);
1028 
1029             // And no commit link
1030             var links = issue.links();
1031             assertEquals(0, links.size());



1032         }
1033     }
1034 
1035     @Test
1036     void testIssueIdempotence(TestInfo testInfo) throws IOException {
1037         try (var credentials = new HostCredentials(testInfo);
1038              var tempFolder = new TemporaryDirectory()) {
1039             var repo = credentials.getHostedRepository();
1040             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1041             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1042             credentials.commitLock(localRepo);
1043             localRepo.pushAll(repo.url());
1044 
1045             var tagStorage = createTagStorage(repo);
1046             var branchStorage = createBranchStorage(repo);
1047             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1048             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1049 
1050             var issueProject = credentials.getIssueProject();
1051             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
1052             var updater = new IssueUpdater(issueProject, false, null, true, commitIcon, true, null);
1053             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1054                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1055 
1056             // Initialize history
1057             TestBotRunner.runPeriodicItems(notifyBot);
1058 
1059             // Save the state
1060             var historyState = localRepo.fetch(repo.url(), &quot;history&quot;);
1061 
1062             // Create an issue and commit a fix
<span class="line-modified">1063             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;type&quot;, &quot;Enhancement&quot;));</span>
1064             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1065             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1066             TestBotRunner.runPeriodicItems(notifyBot);
1067 
1068             // The changeset should be reflected in a comment
1069             var comments = issue.comments();
1070             assertEquals(1, comments.size());
1071             var comment = comments.get(0);
1072             assertTrue(comment.body().contains(editHash.abbreviate()));
1073 
1074             // And in a link
1075             var links = issue.links();
1076             assertEquals(1, links.size());
1077             var link = links.get(0);
1078             assertEquals(commitIcon, link.iconUrl().orElseThrow());
<span class="line-modified">1079             assertEquals(&quot;Commit&quot;, link.title().orElseThrow());</span>
<span class="line-modified">1080             assertEquals(repo.webUrl(editHash), link.uri().orElseThrow());</span>
1081 
1082             // As well as a fixVersion
1083             var fixVersions = issue.fixVersions();
1084             assertEquals(1, fixVersions.size());
1085             var fixVersion = fixVersions.get(0);
1086             assertEquals(&quot;0.1&quot;, fixVersion);
1087 
1088             // Wipe the history
1089             localRepo.push(historyState, repo.url(), &quot;history&quot;, true);
1090 
1091             // Run it again
1092             TestBotRunner.runPeriodicItems(notifyBot);
1093 
1094             // There should be no new comments, links or fixVersions
1095             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1096             assertEquals(1, updatedIssue.comments().size());
1097             assertEquals(1, updatedIssue.links().size());
1098             assertEquals(1, updatedIssue.fixVersions().size());
<span class="line-added">1099         }</span>
<span class="line-added">1100     }</span>
<span class="line-added">1101 </span>
<span class="line-added">1102     @Test</span>
<span class="line-added">1103     void testIssuePoolVersion(TestInfo testInfo) throws IOException {</span>
<span class="line-added">1104         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added">1105              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-added">1106             var repo = credentials.getHostedRepository();</span>
<span class="line-added">1107             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-added">1108             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);</span>
<span class="line-added">1109             credentials.commitLock(localRepo);</span>
<span class="line-added">1110             localRepo.pushAll(repo.url());</span>
<span class="line-added">1111 </span>
<span class="line-added">1112             var tagStorage = createTagStorage(repo);</span>
<span class="line-added">1113             var branchStorage = createBranchStorage(repo);</span>
<span class="line-added">1114             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="line-added">1115             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-added">1116 </span>
<span class="line-added">1117             var issueProject = credentials.getIssueProject();</span>
<span class="line-added">1118             var updater = new IssueUpdater(issueProject, false, null, false, null, true, &quot;12u14&quot;);</span>
<span class="line-added">1119             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-added">1120                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>
<span class="line-added">1121 </span>
<span class="line-added">1122             // Initialize history</span>
<span class="line-added">1123             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">1124 </span>
<span class="line-added">1125             // Create an issue and commit a fix</span>
<span class="line-added">1126             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;type&quot;, &quot;Enhancement&quot;));</span>
<span class="line-added">1127             issue.addFixVersion(&quot;12-pool&quot;);</span>
<span class="line-added">1128             issue.addFixVersion(&quot;tbd13&quot;);</span>
<span class="line-added">1129             issue.addFixVersion(&quot;unknown&quot;);</span>
<span class="line-added">1130 </span>
<span class="line-added">1131             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);</span>
<span class="line-added">1132             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="line-added">1133             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">1134 </span>
<span class="line-added">1135             // The fixVersion should have been updated</span>
<span class="line-added">1136             var fixVersions = issue.fixVersions();</span>
<span class="line-added">1137             assertEquals(1, fixVersions.size());</span>
<span class="line-added">1138             assertEquals(&quot;12u14&quot;, fixVersions.get(0));</span>
<span class="line-added">1139         }</span>
<span class="line-added">1140     }</span>
<span class="line-added">1141 </span>
<span class="line-added">1142     @Test</span>
<span class="line-added">1143     void testIssuePoolOpenVersion(TestInfo testInfo) throws IOException {</span>
<span class="line-added">1144         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added">1145              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-added">1146             var repo = credentials.getHostedRepository();</span>
<span class="line-added">1147             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-added">1148             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);</span>
<span class="line-added">1149             credentials.commitLock(localRepo);</span>
<span class="line-added">1150             localRepo.pushAll(repo.url());</span>
<span class="line-added">1151 </span>
<span class="line-added">1152             var tagStorage = createTagStorage(repo);</span>
<span class="line-added">1153             var branchStorage = createBranchStorage(repo);</span>
<span class="line-added">1154             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="line-added">1155             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-added">1156 </span>
<span class="line-added">1157             var issueProject = credentials.getIssueProject();</span>
<span class="line-added">1158             var updater = new IssueUpdater(issueProject, false, null, false, null, true, &quot;12u14&quot;);</span>
<span class="line-added">1159             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-added">1160                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>
<span class="line-added">1161 </span>
<span class="line-added">1162             // Initialize history</span>
<span class="line-added">1163             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">1164 </span>
<span class="line-added">1165             // Create an issue and commit a fix</span>
<span class="line-added">1166             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;type&quot;, &quot;Enhancement&quot;));</span>
<span class="line-added">1167             issue.addFixVersion(&quot;12-open&quot;);</span>
<span class="line-added">1168             issue.addFixVersion(&quot;tbd13&quot;);</span>
<span class="line-added">1169             issue.addFixVersion(&quot;unknown&quot;);</span>
<span class="line-added">1170 </span>
<span class="line-added">1171             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);</span>
<span class="line-added">1172             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="line-added">1173             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">1174 </span>
<span class="line-added">1175             // The fixVersion should have been updated</span>
<span class="line-added">1176             var fixVersions = issue.fixVersions();</span>
<span class="line-added">1177             assertEquals(1, fixVersions.size());</span>
<span class="line-added">1178             assertEquals(&quot;12u14&quot;, fixVersions.get(0));</span>
<span class="line-added">1179         }</span>
<span class="line-added">1180     }</span>
<span class="line-added">1181 </span>
<span class="line-added">1182     @Test</span>
<span class="line-added">1183     void testIssueBackport(TestInfo testInfo) throws IOException {</span>
<span class="line-added">1184         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added">1185              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-added">1186             var repo = credentials.getHostedRepository();</span>
<span class="line-added">1187             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-added">1188             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);</span>
<span class="line-added">1189             credentials.commitLock(localRepo);</span>
<span class="line-added">1190             localRepo.pushAll(repo.url());</span>
<span class="line-added">1191 </span>
<span class="line-added">1192             var tagStorage = createTagStorage(repo);</span>
<span class="line-added">1193             var branchStorage = createBranchStorage(repo);</span>
<span class="line-added">1194             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="line-added">1195             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-added">1196 </span>
<span class="line-added">1197             var issueProject = credentials.getIssueProject();</span>
<span class="line-added">1198             var updater = new IssueUpdater(issueProject, false, null, false, null, true, &quot;12.0.2&quot;);</span>
<span class="line-added">1199             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-added">1200                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>
<span class="line-added">1201 </span>
<span class="line-added">1202             // Initialize history</span>
<span class="line-added">1203             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">1204 </span>
<span class="line-added">1205             // Create an issue and commit a fix</span>
<span class="line-added">1206             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;type&quot;, &quot;Enhancement&quot;));</span>
<span class="line-added">1207             issue.addFixVersion(&quot;13.0.1&quot;);</span>
<span class="line-added">1208 </span>
<span class="line-added">1209             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);</span>
<span class="line-added">1210             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="line-added">1211             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">1212 </span>
<span class="line-added">1213             // The fixVersion should not have been updated</span>
<span class="line-added">1214             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();</span>
<span class="line-added">1215             var fixVersions = updatedIssue.fixVersions();</span>
<span class="line-added">1216             assertEquals(1, fixVersions.size());</span>
<span class="line-added">1217             assertEquals(&quot;13.0.1&quot;, fixVersions.get(0));</span>
<span class="line-added">1218 </span>
<span class="line-added">1219             // There should be a link</span>
<span class="line-added">1220             var links = updatedIssue.links();</span>
<span class="line-added">1221             assertEquals(1, links.size());</span>
<span class="line-added">1222             var link = links.get(0);</span>
<span class="line-added">1223             var backport = link.issue().orElseThrow();</span>
1224 
<span class="line-modified">1225             // The backport issue should have a correct fixVersion</span>
<span class="line-modified">1226             var backportFixVersions = backport.fixVersions();</span>
<span class="line-added">1227             assertEquals(1, backportFixVersions.size());</span>
<span class="line-added">1228             assertEquals(&quot;12.0.2&quot;, backportFixVersions.get(0));</span>
<span class="line-added">1229             assertEquals(&quot;Backport&quot;, backport.properties().get(&quot;type&quot;));</span>
1230         }
1231     }
1232 
1233     @Test
1234     void testPullRequest(TestInfo testInfo) throws IOException {
1235         try (var credentials = new HostCredentials(testInfo);
1236              var tempFolder = new TemporaryDirectory()) {
1237             var repo = credentials.getHostedRepository();
1238             var reviewer = credentials.getHostedRepository();
1239             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1240             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1241             credentials.commitLock(localRepo);
1242             localRepo.pushAll(repo.url());
1243 
1244             var tagStorage = createTagStorage(repo);
1245             var branchStorage = createBranchStorage(repo);
1246             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1247             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1248 
1249             var issueProject = credentials.getIssueProject();
1250             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
1251             var updater = new IssueUpdater(issueProject, true, reviewIcon, false, null, false, null);
1252             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1253                                           prIssuesStorage, List.of(), List.of(updater), Set.of(&quot;rfr&quot;),
1254                                           Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)));
1255 
1256             // Initialize history
1257             TestBotRunner.runPeriodicItems(notifyBot);
1258 
1259             // Create an issue and a pull request to fix it
<span class="line-modified">1260             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;type&quot;, &quot;Enhancement&quot;));</span>
1261             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
1262             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1263             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
1264             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1265             TestBotRunner.runPeriodicItems(notifyBot);
1266 
1267             // The issue should not yet contain a link to the PR
1268             var links = issue.links();
1269             assertEquals(0, links.size());
1270 
1271             // Just a label isn&#39;t enough
1272             pr.addLabel(&quot;rfr&quot;);
1273             TestBotRunner.runPeriodicItems(notifyBot);
1274             links = issue.links();
1275             assertEquals(0, links.size());
1276 
1277             // Neither is just a comment
1278             pr.removeLabel(&quot;rfr&quot;);
1279             var reviewPr = reviewer.pullRequest(pr.id());
1280             reviewPr.addComment(&quot;This is now ready&quot;);
1281             TestBotRunner.runPeriodicItems(notifyBot);
1282             links = issue.links();
1283             assertEquals(0, links.size());
1284 
1285             // Both are needed
1286             pr.addLabel(&quot;rfr&quot;);
1287             TestBotRunner.runPeriodicItems(notifyBot);
1288 
1289             // The issue should now contain a link to the PR
1290             links = issue.links();
1291             assertEquals(1, links.size());
<span class="line-modified">1292             assertEquals(pr.webUrl(), links.get(0).uri().orElseThrow());</span>
1293             assertEquals(reviewIcon, links.get(0).iconUrl().orElseThrow());
1294 
1295             // Add another issue
<span class="line-modified">1296             var issue2 = issueProject.createIssue(&quot;This is another issue&quot;, List.of(&quot;Yes indeed&quot;), Map.of(&quot;type&quot;, &quot;Enhancement&quot;));</span>
1297             pr.setBody(&quot;\n\n## Issues\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue\n[&quot; + issue2.id() +
1298                                &quot;](http://www.test2.test/): The second issue&quot;);
1299             TestBotRunner.runPeriodicItems(notifyBot);
1300 
1301             // Both issues should contain a link to the PR
1302             var links1 = issue.links();
1303             assertEquals(1, links1.size());
<span class="line-modified">1304             assertEquals(pr.webUrl(), links1.get(0).uri().orElseThrow());</span>
1305             var links2 = issue2.links();
1306             assertEquals(1, links2.size());
<span class="line-modified">1307             assertEquals(pr.webUrl(), links2.get(0).uri().orElseThrow());</span>
1308 
1309             // Drop the first one
1310             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue2.id() + &quot;](http://www.test2.test/): That other issue&quot;);
1311             TestBotRunner.runPeriodicItems(notifyBot);
1312 
1313             // Only the second issue should now contain a link to the PR
1314             links1 = issue.links();
1315             assertEquals(0, links1.size());
1316             links2 = issue2.links();
1317             assertEquals(1, links2.size());
<span class="line-modified">1318             assertEquals(pr.webUrl(), links2.get(0).uri().orElseThrow());</span>
1319         }
1320     }
1321 
1322     @Test
1323     void testPullRequestNoReview(TestInfo testInfo) throws IOException {
1324         try (var credentials = new HostCredentials(testInfo);
1325              var tempFolder = new TemporaryDirectory()) {
1326             var repo = credentials.getHostedRepository();
1327             var reviewer = credentials.getHostedRepository();
1328             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1329             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1330             credentials.commitLock(localRepo);
1331             localRepo.pushAll(repo.url());
1332 
1333             var tagStorage = createTagStorage(repo);
1334             var branchStorage = createBranchStorage(repo);
1335             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1336             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1337 
1338             var issueProject = credentials.getIssueProject();
1339             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
1340             var updater = new IssueUpdater(issueProject, false, reviewIcon, false, null, false,null);
1341             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1342                                           prIssuesStorage, List.of(), List.of(updater), Set.of(&quot;rfr&quot;),
1343                                           Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)));
1344             // Initialize history
1345             TestBotRunner.runPeriodicItems(notifyBot);
1346 
1347             // Create an issue and a pull request to fix it
<span class="line-modified">1348             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;type&quot;, &quot;Enhancement&quot;));</span>
1349             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
1350             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1351             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
1352             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1353             TestBotRunner.runPeriodicItems(notifyBot);
1354 
1355             // Add required label
1356             pr.addLabel(&quot;rfr&quot;);
1357             TestBotRunner.runPeriodicItems(notifyBot);
1358 
1359             // And the required comment
1360             var reviewPr = reviewer.pullRequest(pr.id());
1361             reviewPr.addComment(&quot;This is now ready&quot;);
1362             TestBotRunner.runPeriodicItems(notifyBot);
1363 
1364             // The issue should still not contain a link to the PR
1365             var links = issue.links();
1366             assertEquals(0, links.size());
1367         }
1368     }
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/notify/IssueUpdater.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../pr/src/test/java/org/openjdk/skara/bots/pr/CheckTests.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>