<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../main/java/module-info.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 67     }
 68 
 69     @Test
 70     void testJsonUpdaterBranch(TestInfo testInfo) throws IOException {
 71         try (var credentials = new HostCredentials(testInfo);
 72              var tempFolder = new TemporaryDirectory()) {
 73             var repo = credentials.getHostedRepository();
 74             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 75             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
 76             credentials.commitLock(localRepo);
 77             localRepo.pushAll(repo.url());
 78 
 79             var tagStorage = createTagStorage(repo);
 80             var branchStorage = createBranchStorage(repo);
 81             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 82             var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
 83             Files.createDirectory(jsonFolder);
 84             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 85 
 86             var updater = new JsonUpdater(jsonFolder, &quot;12&quot;, &quot;team&quot;);
<span class="line-modified"> 87             var notifyBot = new JNotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified"> 88                                            prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>
 89 
 90             TestBotRunner.runPeriodicItems(notifyBot);
 91             assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));
 92 
 93             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;One more line&quot;, &quot;12345678: Fixes&quot;);
 94             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 95             TestBotRunner.runPeriodicItems(notifyBot);
 96             var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);
 97             assertEquals(1, jsonFiles.size());
 98             var jsonData = Files.readString(jsonFiles.get(0), StandardCharsets.UTF_8);
 99             var json = JSON.parse(jsonData);
100             assertEquals(1, json.asArray().size());
101             assertEquals(repo.webUrl(editHash).toString(), json.asArray().get(0).get(&quot;url&quot;).asString());
102             assertEquals(List.of(&quot;12345678&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
103                                                   .map(JSONValue::asString)
104                                                   .collect(Collectors.toList()));
105         }
106     }
107 
108     @Test
109     void testJsonUpdaterTag(TestInfo testInfo) throws IOException {
110         try (var credentials = new HostCredentials(testInfo);
111              var tempFolder = new TemporaryDirectory()) {
112             var repo = credentials.getHostedRepository();
113             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
114             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
115             credentials.commitLock(localRepo);
116             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
117             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
118             localRepo.pushAll(repo.url());
119 
120             var tagStorage = createTagStorage(repo);
121             var branchStorage = createBranchStorage(repo);
122             var prIssuesStorage = createPullRequestIssuesStorage(repo);
123             var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
124             Files.createDirectory(jsonFolder);
125             var storageFolder =tempFolder.path().resolve(&quot;storage&quot;);
126 
127             var updater = new JsonUpdater(jsonFolder, &quot;12&quot;, &quot;team&quot;);
<span class="line-modified">128             var notifyBot = new JNotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified">129                                            prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>
130 
131             TestBotRunner.runPeriodicItems(notifyBot);
132             assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));
133 
134             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
135             localRepo.fetch(repo.url(), &quot;history:history&quot;);
136             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
137             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;34567890: Even more fixes&quot;);
138             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
139             localRepo.pushAll(repo.url());
140 
141             TestBotRunner.runPeriodicItems(notifyBot);
142             var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);
143             assertEquals(3, jsonFiles.size());
144 
145             for (var file : jsonFiles) {
146                 var jsonData = Files.readString(file, StandardCharsets.UTF_8);
147                 var json = JSON.parse(jsonData);
148 
149                 if (json.asArray().get(0).contains(&quot;date&quot;)) {
</pre>
<hr />
<pre>
181              var credentials = new HostCredentials(testInfo);
182              var tempFolder = new TemporaryDirectory()) {
183             var repo = credentials.getHostedRepository();
184             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
185             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
186             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
187             credentials.commitLock(localRepo);
188             localRepo.pushAll(repo.url());
189 
190             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
191             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
192             var mailmanList = mailmanServer.getList(listAddress.address());
193             var tagStorage = createTagStorage(repo);
194             var branchStorage = createBranchStorage(repo);
195             var prIssuesStorage = createPullRequestIssuesStorage(repo);
196             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
197 
198             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
199             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null, false, MailingListUpdater.Mode.ALL,
200                                                  Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;), Pattern.compile(&quot;none&quot;));
<span class="line-modified">201             var notifyBot = new JNotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified">202                                            prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>
203 
204             // No mail should be sent on the first run as there is no history
205             TestBotRunner.runPeriodicItems(notifyBot);
206             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
207 
208             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
209             localRepo.push(editHash, repo.url(), &quot;master&quot;);
210             TestBotRunner.runPeriodicItems(notifyBot);
211             listServer.processIncoming();
212 
213             var conversations = mailmanList.conversations(Duration.ofDays(1));
214             var email = conversations.get(0).first();
215             assertEquals(listAddress, email.sender());
216             assertEquals(sender, email.author());
217             assertEquals(email.recipients(), List.of(listAddress));
218             assertTrue(email.subject().contains(&quot;: 23456789: More fixes&quot;));
219             assertFalse(email.subject().contains(&quot;master&quot;));
220             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
221             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
222             assertFalse(email.body().contains(&quot;Committer&quot;));
</pre>
<hr />
<pre>
234              var credentials = new HostCredentials(testInfo);
235              var tempFolder = new TemporaryDirectory()) {
236             var repo = credentials.getHostedRepository();
237             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
238             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
239             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
240             credentials.commitLock(localRepo);
241             localRepo.pushAll(repo.url());
242 
243             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
244             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
245             var mailmanList = mailmanServer.getList(listAddress.address());
246             var tagStorage = createTagStorage(repo);
247             var branchStorage = createBranchStorage(repo);
248             var prIssuesStorage = createPullRequestIssuesStorage(repo);
249             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
250 
251             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
252             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null, false,
253                                                  MailingListUpdater.Mode.ALL, Map.of(), Pattern.compile(&quot;.*&quot;));
<span class="line-modified">254             var notifyBot = new JNotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified">255                                            prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>
256 
257             // No mail should be sent on the first run as there is no history
258             TestBotRunner.runPeriodicItems(notifyBot);
259             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
260 
261             var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
262                                                                 &quot;first_author&quot;, &quot;first@author.example.com&quot;);
263             localRepo.push(editHash1, repo.url(), &quot;master&quot;);
264             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;,
265                                                                 &quot;another_author&quot;, &quot;another@author.example.com&quot;);
266             localRepo.push(editHash2, repo.url(), &quot;master&quot;);
267 
268             TestBotRunner.runPeriodicItems(notifyBot);
269             listServer.processIncoming();
270 
271             var conversations = mailmanList.conversations(Duration.ofDays(1));
272             var email = conversations.get(0).first();
273             assertEquals(listAddress, email.sender());
274             assertEquals(EmailAddress.from(&quot;another_author&quot;, &quot;another@author.example.com&quot;), email.author());
275             assertEquals(email.recipients(), List.of(listAddress));
</pre>
<hr />
<pre>
289              var credentials = new HostCredentials(testInfo);
290              var tempFolder = new TemporaryDirectory()) {
291             var repo = credentials.getHostedRepository();
292             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
293             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
294             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
295             credentials.commitLock(localRepo);
296             localRepo.pushAll(repo.url());
297 
298             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
299             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
300             var mailmanList = mailmanServer.getList(listAddress.address());
301             var tagStorage = createTagStorage(repo);
302             var branchStorage = createBranchStorage(repo);
303             var prIssuesStorage = createPullRequestIssuesStorage(repo);
304             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
305 
306             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
307             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null, false,
308                                                  MailingListUpdater.Mode.ALL, Map.of(), Pattern.compile(&quot;.*&quot;));
<span class="line-modified">309             var notifyBot = new JNotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified">310                                            prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>
311 
312             // No mail should be sent on the first run as there is no history
313             TestBotRunner.runPeriodicItems(notifyBot);
314             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
315 
316             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
317                                                                &quot;author&quot;, &quot;author@test.test&quot;,
318                                                                &quot;committer&quot;, &quot;committer@test.test&quot;);
319             localRepo.push(editHash, repo.url(), &quot;master&quot;);
320             TestBotRunner.runPeriodicItems(notifyBot);
321             listServer.processIncoming();
322 
323             var conversations = mailmanList.conversations(Duration.ofDays(1));
324             var email = conversations.get(0).first();
325             assertEquals(listAddress, email.sender());
326             assertEquals(EmailAddress.from(&quot;committer&quot;, &quot;committer@test.test&quot;), email.author());
327             assertEquals(email.recipients(), List.of(listAddress));
328             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
329             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
330             assertTrue(email.body().contains(&quot;Author:    author &lt;author@test.test&gt;&quot;));
</pre>
<hr />
<pre>
341             var repo = credentials.getHostedRepository();
342             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
343             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
344             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
345             credentials.commitLock(localRepo);
346             var branch = localRepo.branch(masterHash, &quot;another&quot;);
347             localRepo.pushAll(repo.url());
348 
349             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
350             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
351             var mailmanList = mailmanServer.getList(listAddress.address());
352             var tagStorage = createTagStorage(repo);
353             var branchStorage = createBranchStorage(repo);
354             var prIssuesStorage = createPullRequestIssuesStorage(repo);
355             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
356 
357             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
358             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);
359             var updater = new MailingListUpdater(mailmanList, listAddress, sender, author, true,
360                                                  MailingListUpdater.Mode.ALL, Map.of(), Pattern.compile(&quot;.*&quot;));
<span class="line-modified">361             var notifyBot = new JNotifyBot(repo, storageFolder, Pattern.compile(&quot;master|another&quot;), tagStorage, branchStorage,</span>
<span class="line-modified">362                                            prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>
363 
364             // No mail should be sent on the first run as there is no history
365             TestBotRunner.runPeriodicItems(notifyBot);
366             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
367 
368             var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
369             localRepo.push(editHash1, repo.url(), &quot;master&quot;);
370             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;);
371             localRepo.push(editHash2, repo.url(), &quot;master&quot;);
372 
373             TestBotRunner.runPeriodicItems(notifyBot);
374             listServer.processIncoming();
375 
376             var conversations = mailmanList.conversations(Duration.ofDays(1));
377             var email = conversations.get(0).first();
378             assertEquals(listAddress, email.sender());
379             assertEquals(author, email.author());
380             assertEquals(email.recipients(), List.of(listAddress));
381             assertFalse(email.subject().contains(&quot;another&quot;));
382             assertTrue(email.subject().contains(&quot;: master: 2 new changesets&quot;));
</pre>
<hr />
<pre>
417             var repo = credentials.getHostedRepository();
418             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
419             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
420             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
421             credentials.commitLock(localRepo);
422             localRepo.pushAll(repo.url());
423 
424             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
425             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
426             var mailmanList = mailmanServer.getList(listAddress.address());
427             var tagStorage = createTagStorage(repo);
428             var branchStorage = createBranchStorage(repo);
429             var prIssuesStorage = createPullRequestIssuesStorage(repo);
430             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
431 
432             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
433             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);
434             var updater = new MailingListUpdater(mailmanList, listAddress, sender, author, false,
435                                                  MailingListUpdater.Mode.PR_ONLY, Map.of(&quot;extra1&quot;, &quot;value1&quot;),
436                                                  Pattern.compile(&quot;.*&quot;));
<span class="line-modified">437             var notifyBot = new JNotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified">438                                            prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>
439 
440             // No mail should be sent on the first run as there is no history
441             TestBotRunner.runPeriodicItems(notifyBot);
442             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
443 
444             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
445             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
446             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
447 
448             // Create a potentially conflicting one
449             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
450             localRepo.push(otherHash, repo.url(), &quot;other&quot;);
451             var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);
452 
453             // PR hasn&#39;t been integrated yet, so there should be no mail
454             TestBotRunner.runPeriodicItems(notifyBot);
455             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
456 
457             // Simulate an RFR email
458             var rfr = Email.create(sender, &quot;RFR: My PR&quot;, &quot;PR: &quot; + pr.webUrl().toString())
</pre>
<hr />
<pre>
496              var credentials = new HostCredentials(testInfo);
497              var tempFolder = new TemporaryDirectory()) {
498             var repo = credentials.getHostedRepository();
499             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
500             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
501             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
502             credentials.commitLock(localRepo);
503             localRepo.pushAll(repo.url());
504 
505             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
506             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
507             var mailmanList = mailmanServer.getList(listAddress.address());
508             var tagStorage = createTagStorage(repo);
509             var branchStorage = createBranchStorage(repo);
510             var prIssuesStorage = createPullRequestIssuesStorage(repo);
511             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
512 
513             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
514             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null, false,
515                                                  MailingListUpdater.Mode.PR, Map.of(), Pattern.compile(&quot;.*&quot;));
<span class="line-modified">516             var notifyBot = new JNotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified">517                                            prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>
518 
519             // No mail should be sent on the first run as there is no history
520             TestBotRunner.runPeriodicItems(notifyBot);
521             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
522 
523             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
524             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
525             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
526 
527             // Create a potentially conflicting one
528             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
529             localRepo.push(otherHash, repo.url(), &quot;other&quot;);
530             var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);
531 
532             // PR hasn&#39;t been integrated yet, so there should be no mail
533             TestBotRunner.runPeriodicItems(notifyBot);
534             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
535 
536             // Simulate an RFR email
537             var rfr = Email.create(&quot;RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())
</pre>
<hr />
<pre>
588             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
589             credentials.commitLock(localRepo);
590             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
591             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
592             localRepo.pushAll(repo.url());
593 
594             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
595             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
596             var mailmanList = mailmanServer.getList(listAddress.address());
597             var tagStorage = createTagStorage(repo);
598             var branchStorage = createBranchStorage(repo);
599             var prIssuesStorage = createPullRequestIssuesStorage(repo);
600             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
601 
602             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
603             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null, false, MailingListUpdater.Mode.ALL,
604                                                  Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;),
605                                                  Pattern.compile(&quot;.*&quot;));
606             var prOnlyUpdater = new MailingListUpdater(mailmanList, listAddress, sender, null, false,
607                                                        MailingListUpdater.Mode.PR_ONLY, Map.of(), Pattern.compile(&quot;.*&quot;));
<span class="line-modified">608             var notifyBot = new JNotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified">609                                            prIssuesStorage, List.of(updater, prOnlyUpdater), List.of(), Set.of(), Map.of());</span>
610 
611             // No mail should be sent on the first run as there is no history
612             TestBotRunner.runPeriodicItems(notifyBot);
613             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
614 
615             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
616             localRepo.fetch(repo.url(), &quot;history:history&quot;);
617             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
618             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);
619             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);
620             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);
621             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
622             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);
623             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);
624             localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
625             localRepo.pushAll(repo.url());
626 
627             TestBotRunner.runPeriodicItems(notifyBot);
628             listServer.processIncoming();
629             listServer.processIncoming();
</pre>
<hr />
<pre>
685              var tempFolder = new TemporaryDirectory()) {
686             var repo = credentials.getHostedRepository();
687             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
688             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
689             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
690             credentials.commitLock(localRepo);
691             localRepo.pushAll(repo.url());
692 
693             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
694             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
695             var mailmanList = mailmanServer.getList(listAddress.address());
696             var tagStorage = createTagStorage(repo);
697             var branchStorage = createBranchStorage(repo);
698             var prIssuesStorage = createPullRequestIssuesStorage(repo);
699             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
700 
701             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
702             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null, false, MailingListUpdater.Mode.ALL,
703                                                  Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;),
704                                                  Pattern.compile(&quot;.*&quot;));
<span class="line-modified">705             var notifyBot = new JNotifyBot(repo, storageFolder, Pattern.compile(&quot;master|newbranch.&quot;), tagStorage, branchStorage,</span>
<span class="line-modified">706                                            prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>
707 
708             // No mail should be sent on the first run as there is no history
709             TestBotRunner.runPeriodicItems(notifyBot);
710             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
711 
712             CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;12345678: Some fixes&quot;);
713             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
714             localRepo.push(editHash, repo.url(), &quot;newbranch1&quot;);
715             TestBotRunner.runPeriodicItems(notifyBot);
716             listServer.processIncoming();
717 
718             var conversations = mailmanList.conversations(Duration.ofDays(1));
719             var email = conversations.get(0).first();
720             assertEquals(listAddress, email.sender());
721             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());
722             assertEquals(email.recipients(), List.of(listAddress));
723             assertEquals(&quot;git: test: created branch newbranch1 based on the branch master containing 2 unique commits&quot;, email.subject());
724             assertTrue(email.body().contains(&quot;12345678: Some fixes&quot;));
725             assertTrue(email.hasHeader(&quot;extra1&quot;));
726             assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
</pre>
<hr />
<pre>
746         }
747     }
748 
749     @Test
750     void testIssue(TestInfo testInfo) throws IOException {
751         try (var credentials = new HostCredentials(testInfo);
752              var tempFolder = new TemporaryDirectory()) {
753             var repo = credentials.getHostedRepository();
754             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
755             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
756             credentials.commitLock(localRepo);
757             localRepo.pushAll(repo.url());
758 
759             var tagStorage = createTagStorage(repo);
760             var branchStorage = createBranchStorage(repo);
761             var prIssuesStorage = createPullRequestIssuesStorage(repo);
762             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
763 
764             var issueProject = credentials.getIssueProject();
765             var updater = new IssueUpdater(issueProject, null);
<span class="line-modified">766             var notifyBot = new JNotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified">767                                            prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>
768 
769             // Initialize history
770             TestBotRunner.runPeriodicItems(notifyBot);
771 
772             // Create an issue and commit a fix
773             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;));
774             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
775             localRepo.push(editHash, repo.url(), &quot;master&quot;);
776             TestBotRunner.runPeriodicItems(notifyBot);
777 
778             // The changeset should be reflected in a comment
779             var comments = issue.comments();
780             assertEquals(1, comments.size());
781             var comment = comments.get(0);
782             assertTrue(comment.body().contains(editHash.abbreviate()));
783 
784             // There should be no open issues
785             assertEquals(0, issueProject.issues().size());
786         }
787     }
788 
789     @Test
790     void testPullRequest(TestInfo testInfo) throws IOException {
791         try (var credentials = new HostCredentials(testInfo);
792              var tempFolder = new TemporaryDirectory()) {
793             var repo = credentials.getHostedRepository();
794             var reviewer = credentials.getHostedRepository();
795             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
796             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
797             credentials.commitLock(localRepo);
798             localRepo.pushAll(repo.url());
799 
800             var tagStorage = createTagStorage(repo);
801             var branchStorage = createBranchStorage(repo);
802             var prIssuesStorage = createPullRequestIssuesStorage(repo);
803             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
804 
805             var issueProject = credentials.getIssueProject();
806             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
807             var updater = new IssueUpdater(issueProject, reviewIcon);
<span class="line-modified">808             var notifyBot = new JNotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified">809                                            prIssuesStorage, List.of(), List.of(updater), Set.of(&quot;rfr&quot;),</span>
<span class="line-modified">810                                            Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)));</span>
811 
812             // Initialize history
813             TestBotRunner.runPeriodicItems(notifyBot);
814 
815             // Create an issue and a pull request to fix it
816             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;));
817             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
818             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
819             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
820             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
821             TestBotRunner.runPeriodicItems(notifyBot);
822 
823             // The issue should not yet contain a link to the PR
824             var links = issue.links();
825             assertEquals(0, links.size());
826 
827             // Just a label isn&#39;t enough
828             pr.addLabel(&quot;rfr&quot;);
829             TestBotRunner.runPeriodicItems(notifyBot);
830             links = issue.links();
</pre>
</td>
<td>
<hr />
<pre>
 67     }
 68 
 69     @Test
 70     void testJsonUpdaterBranch(TestInfo testInfo) throws IOException {
 71         try (var credentials = new HostCredentials(testInfo);
 72              var tempFolder = new TemporaryDirectory()) {
 73             var repo = credentials.getHostedRepository();
 74             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 75             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
 76             credentials.commitLock(localRepo);
 77             localRepo.pushAll(repo.url());
 78 
 79             var tagStorage = createTagStorage(repo);
 80             var branchStorage = createBranchStorage(repo);
 81             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 82             var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
 83             Files.createDirectory(jsonFolder);
 84             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 85 
 86             var updater = new JsonUpdater(jsonFolder, &quot;12&quot;, &quot;team&quot;);
<span class="line-modified"> 87             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified"> 88                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>
 89 
 90             TestBotRunner.runPeriodicItems(notifyBot);
 91             assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));
 92 
 93             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;One more line&quot;, &quot;12345678: Fixes&quot;);
 94             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 95             TestBotRunner.runPeriodicItems(notifyBot);
 96             var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);
 97             assertEquals(1, jsonFiles.size());
 98             var jsonData = Files.readString(jsonFiles.get(0), StandardCharsets.UTF_8);
 99             var json = JSON.parse(jsonData);
100             assertEquals(1, json.asArray().size());
101             assertEquals(repo.webUrl(editHash).toString(), json.asArray().get(0).get(&quot;url&quot;).asString());
102             assertEquals(List.of(&quot;12345678&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
103                                                   .map(JSONValue::asString)
104                                                   .collect(Collectors.toList()));
105         }
106     }
107 
108     @Test
109     void testJsonUpdaterTag(TestInfo testInfo) throws IOException {
110         try (var credentials = new HostCredentials(testInfo);
111              var tempFolder = new TemporaryDirectory()) {
112             var repo = credentials.getHostedRepository();
113             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
114             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
115             credentials.commitLock(localRepo);
116             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
117             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
118             localRepo.pushAll(repo.url());
119 
120             var tagStorage = createTagStorage(repo);
121             var branchStorage = createBranchStorage(repo);
122             var prIssuesStorage = createPullRequestIssuesStorage(repo);
123             var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
124             Files.createDirectory(jsonFolder);
125             var storageFolder =tempFolder.path().resolve(&quot;storage&quot;);
126 
127             var updater = new JsonUpdater(jsonFolder, &quot;12&quot;, &quot;team&quot;);
<span class="line-modified">128             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified">129                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>
130 
131             TestBotRunner.runPeriodicItems(notifyBot);
132             assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));
133 
134             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
135             localRepo.fetch(repo.url(), &quot;history:history&quot;);
136             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
137             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;34567890: Even more fixes&quot;);
138             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
139             localRepo.pushAll(repo.url());
140 
141             TestBotRunner.runPeriodicItems(notifyBot);
142             var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);
143             assertEquals(3, jsonFiles.size());
144 
145             for (var file : jsonFiles) {
146                 var jsonData = Files.readString(file, StandardCharsets.UTF_8);
147                 var json = JSON.parse(jsonData);
148 
149                 if (json.asArray().get(0).contains(&quot;date&quot;)) {
</pre>
<hr />
<pre>
181              var credentials = new HostCredentials(testInfo);
182              var tempFolder = new TemporaryDirectory()) {
183             var repo = credentials.getHostedRepository();
184             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
185             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
186             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
187             credentials.commitLock(localRepo);
188             localRepo.pushAll(repo.url());
189 
190             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
191             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
192             var mailmanList = mailmanServer.getList(listAddress.address());
193             var tagStorage = createTagStorage(repo);
194             var branchStorage = createBranchStorage(repo);
195             var prIssuesStorage = createPullRequestIssuesStorage(repo);
196             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
197 
198             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
199             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null, false, MailingListUpdater.Mode.ALL,
200                                                  Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;), Pattern.compile(&quot;none&quot;));
<span class="line-modified">201             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified">202                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>
203 
204             // No mail should be sent on the first run as there is no history
205             TestBotRunner.runPeriodicItems(notifyBot);
206             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
207 
208             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
209             localRepo.push(editHash, repo.url(), &quot;master&quot;);
210             TestBotRunner.runPeriodicItems(notifyBot);
211             listServer.processIncoming();
212 
213             var conversations = mailmanList.conversations(Duration.ofDays(1));
214             var email = conversations.get(0).first();
215             assertEquals(listAddress, email.sender());
216             assertEquals(sender, email.author());
217             assertEquals(email.recipients(), List.of(listAddress));
218             assertTrue(email.subject().contains(&quot;: 23456789: More fixes&quot;));
219             assertFalse(email.subject().contains(&quot;master&quot;));
220             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
221             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
222             assertFalse(email.body().contains(&quot;Committer&quot;));
</pre>
<hr />
<pre>
234              var credentials = new HostCredentials(testInfo);
235              var tempFolder = new TemporaryDirectory()) {
236             var repo = credentials.getHostedRepository();
237             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
238             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
239             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
240             credentials.commitLock(localRepo);
241             localRepo.pushAll(repo.url());
242 
243             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
244             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
245             var mailmanList = mailmanServer.getList(listAddress.address());
246             var tagStorage = createTagStorage(repo);
247             var branchStorage = createBranchStorage(repo);
248             var prIssuesStorage = createPullRequestIssuesStorage(repo);
249             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
250 
251             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
252             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null, false,
253                                                  MailingListUpdater.Mode.ALL, Map.of(), Pattern.compile(&quot;.*&quot;));
<span class="line-modified">254             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified">255                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>
256 
257             // No mail should be sent on the first run as there is no history
258             TestBotRunner.runPeriodicItems(notifyBot);
259             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
260 
261             var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
262                                                                 &quot;first_author&quot;, &quot;first@author.example.com&quot;);
263             localRepo.push(editHash1, repo.url(), &quot;master&quot;);
264             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;,
265                                                                 &quot;another_author&quot;, &quot;another@author.example.com&quot;);
266             localRepo.push(editHash2, repo.url(), &quot;master&quot;);
267 
268             TestBotRunner.runPeriodicItems(notifyBot);
269             listServer.processIncoming();
270 
271             var conversations = mailmanList.conversations(Duration.ofDays(1));
272             var email = conversations.get(0).first();
273             assertEquals(listAddress, email.sender());
274             assertEquals(EmailAddress.from(&quot;another_author&quot;, &quot;another@author.example.com&quot;), email.author());
275             assertEquals(email.recipients(), List.of(listAddress));
</pre>
<hr />
<pre>
289              var credentials = new HostCredentials(testInfo);
290              var tempFolder = new TemporaryDirectory()) {
291             var repo = credentials.getHostedRepository();
292             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
293             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
294             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
295             credentials.commitLock(localRepo);
296             localRepo.pushAll(repo.url());
297 
298             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
299             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
300             var mailmanList = mailmanServer.getList(listAddress.address());
301             var tagStorage = createTagStorage(repo);
302             var branchStorage = createBranchStorage(repo);
303             var prIssuesStorage = createPullRequestIssuesStorage(repo);
304             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
305 
306             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
307             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null, false,
308                                                  MailingListUpdater.Mode.ALL, Map.of(), Pattern.compile(&quot;.*&quot;));
<span class="line-modified">309             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified">310                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>
311 
312             // No mail should be sent on the first run as there is no history
313             TestBotRunner.runPeriodicItems(notifyBot);
314             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
315 
316             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
317                                                                &quot;author&quot;, &quot;author@test.test&quot;,
318                                                                &quot;committer&quot;, &quot;committer@test.test&quot;);
319             localRepo.push(editHash, repo.url(), &quot;master&quot;);
320             TestBotRunner.runPeriodicItems(notifyBot);
321             listServer.processIncoming();
322 
323             var conversations = mailmanList.conversations(Duration.ofDays(1));
324             var email = conversations.get(0).first();
325             assertEquals(listAddress, email.sender());
326             assertEquals(EmailAddress.from(&quot;committer&quot;, &quot;committer@test.test&quot;), email.author());
327             assertEquals(email.recipients(), List.of(listAddress));
328             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
329             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
330             assertTrue(email.body().contains(&quot;Author:    author &lt;author@test.test&gt;&quot;));
</pre>
<hr />
<pre>
341             var repo = credentials.getHostedRepository();
342             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
343             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
344             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
345             credentials.commitLock(localRepo);
346             var branch = localRepo.branch(masterHash, &quot;another&quot;);
347             localRepo.pushAll(repo.url());
348 
349             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
350             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
351             var mailmanList = mailmanServer.getList(listAddress.address());
352             var tagStorage = createTagStorage(repo);
353             var branchStorage = createBranchStorage(repo);
354             var prIssuesStorage = createPullRequestIssuesStorage(repo);
355             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
356 
357             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
358             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);
359             var updater = new MailingListUpdater(mailmanList, listAddress, sender, author, true,
360                                                  MailingListUpdater.Mode.ALL, Map.of(), Pattern.compile(&quot;.*&quot;));
<span class="line-modified">361             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master|another&quot;), tagStorage, branchStorage,</span>
<span class="line-modified">362                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>
363 
364             // No mail should be sent on the first run as there is no history
365             TestBotRunner.runPeriodicItems(notifyBot);
366             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
367 
368             var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
369             localRepo.push(editHash1, repo.url(), &quot;master&quot;);
370             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;);
371             localRepo.push(editHash2, repo.url(), &quot;master&quot;);
372 
373             TestBotRunner.runPeriodicItems(notifyBot);
374             listServer.processIncoming();
375 
376             var conversations = mailmanList.conversations(Duration.ofDays(1));
377             var email = conversations.get(0).first();
378             assertEquals(listAddress, email.sender());
379             assertEquals(author, email.author());
380             assertEquals(email.recipients(), List.of(listAddress));
381             assertFalse(email.subject().contains(&quot;another&quot;));
382             assertTrue(email.subject().contains(&quot;: master: 2 new changesets&quot;));
</pre>
<hr />
<pre>
417             var repo = credentials.getHostedRepository();
418             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
419             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
420             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
421             credentials.commitLock(localRepo);
422             localRepo.pushAll(repo.url());
423 
424             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
425             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
426             var mailmanList = mailmanServer.getList(listAddress.address());
427             var tagStorage = createTagStorage(repo);
428             var branchStorage = createBranchStorage(repo);
429             var prIssuesStorage = createPullRequestIssuesStorage(repo);
430             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
431 
432             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
433             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);
434             var updater = new MailingListUpdater(mailmanList, listAddress, sender, author, false,
435                                                  MailingListUpdater.Mode.PR_ONLY, Map.of(&quot;extra1&quot;, &quot;value1&quot;),
436                                                  Pattern.compile(&quot;.*&quot;));
<span class="line-modified">437             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified">438                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>
439 
440             // No mail should be sent on the first run as there is no history
441             TestBotRunner.runPeriodicItems(notifyBot);
442             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
443 
444             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
445             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
446             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
447 
448             // Create a potentially conflicting one
449             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
450             localRepo.push(otherHash, repo.url(), &quot;other&quot;);
451             var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);
452 
453             // PR hasn&#39;t been integrated yet, so there should be no mail
454             TestBotRunner.runPeriodicItems(notifyBot);
455             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
456 
457             // Simulate an RFR email
458             var rfr = Email.create(sender, &quot;RFR: My PR&quot;, &quot;PR: &quot; + pr.webUrl().toString())
</pre>
<hr />
<pre>
496              var credentials = new HostCredentials(testInfo);
497              var tempFolder = new TemporaryDirectory()) {
498             var repo = credentials.getHostedRepository();
499             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
500             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
501             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
502             credentials.commitLock(localRepo);
503             localRepo.pushAll(repo.url());
504 
505             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
506             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
507             var mailmanList = mailmanServer.getList(listAddress.address());
508             var tagStorage = createTagStorage(repo);
509             var branchStorage = createBranchStorage(repo);
510             var prIssuesStorage = createPullRequestIssuesStorage(repo);
511             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
512 
513             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
514             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null, false,
515                                                  MailingListUpdater.Mode.PR, Map.of(), Pattern.compile(&quot;.*&quot;));
<span class="line-modified">516             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified">517                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>
518 
519             // No mail should be sent on the first run as there is no history
520             TestBotRunner.runPeriodicItems(notifyBot);
521             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
522 
523             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
524             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
525             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
526 
527             // Create a potentially conflicting one
528             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
529             localRepo.push(otherHash, repo.url(), &quot;other&quot;);
530             var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);
531 
532             // PR hasn&#39;t been integrated yet, so there should be no mail
533             TestBotRunner.runPeriodicItems(notifyBot);
534             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
535 
536             // Simulate an RFR email
537             var rfr = Email.create(&quot;RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())
</pre>
<hr />
<pre>
588             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
589             credentials.commitLock(localRepo);
590             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
591             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
592             localRepo.pushAll(repo.url());
593 
594             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
595             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
596             var mailmanList = mailmanServer.getList(listAddress.address());
597             var tagStorage = createTagStorage(repo);
598             var branchStorage = createBranchStorage(repo);
599             var prIssuesStorage = createPullRequestIssuesStorage(repo);
600             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
601 
602             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
603             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null, false, MailingListUpdater.Mode.ALL,
604                                                  Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;),
605                                                  Pattern.compile(&quot;.*&quot;));
606             var prOnlyUpdater = new MailingListUpdater(mailmanList, listAddress, sender, null, false,
607                                                        MailingListUpdater.Mode.PR_ONLY, Map.of(), Pattern.compile(&quot;.*&quot;));
<span class="line-modified">608             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified">609                                           prIssuesStorage, List.of(updater, prOnlyUpdater), List.of(), Set.of(), Map.of());</span>
610 
611             // No mail should be sent on the first run as there is no history
612             TestBotRunner.runPeriodicItems(notifyBot);
613             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
614 
615             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
616             localRepo.fetch(repo.url(), &quot;history:history&quot;);
617             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
618             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);
619             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);
620             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);
621             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
622             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);
623             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);
624             localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
625             localRepo.pushAll(repo.url());
626 
627             TestBotRunner.runPeriodicItems(notifyBot);
628             listServer.processIncoming();
629             listServer.processIncoming();
</pre>
<hr />
<pre>
685              var tempFolder = new TemporaryDirectory()) {
686             var repo = credentials.getHostedRepository();
687             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
688             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
689             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
690             credentials.commitLock(localRepo);
691             localRepo.pushAll(repo.url());
692 
693             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
694             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
695             var mailmanList = mailmanServer.getList(listAddress.address());
696             var tagStorage = createTagStorage(repo);
697             var branchStorage = createBranchStorage(repo);
698             var prIssuesStorage = createPullRequestIssuesStorage(repo);
699             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
700 
701             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
702             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null, false, MailingListUpdater.Mode.ALL,
703                                                  Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;),
704                                                  Pattern.compile(&quot;.*&quot;));
<span class="line-modified">705             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master|newbranch.&quot;), tagStorage, branchStorage,</span>
<span class="line-modified">706                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>
707 
708             // No mail should be sent on the first run as there is no history
709             TestBotRunner.runPeriodicItems(notifyBot);
710             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
711 
712             CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;12345678: Some fixes&quot;);
713             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
714             localRepo.push(editHash, repo.url(), &quot;newbranch1&quot;);
715             TestBotRunner.runPeriodicItems(notifyBot);
716             listServer.processIncoming();
717 
718             var conversations = mailmanList.conversations(Duration.ofDays(1));
719             var email = conversations.get(0).first();
720             assertEquals(listAddress, email.sender());
721             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());
722             assertEquals(email.recipients(), List.of(listAddress));
723             assertEquals(&quot;git: test: created branch newbranch1 based on the branch master containing 2 unique commits&quot;, email.subject());
724             assertTrue(email.body().contains(&quot;12345678: Some fixes&quot;));
725             assertTrue(email.hasHeader(&quot;extra1&quot;));
726             assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
</pre>
<hr />
<pre>
746         }
747     }
748 
749     @Test
750     void testIssue(TestInfo testInfo) throws IOException {
751         try (var credentials = new HostCredentials(testInfo);
752              var tempFolder = new TemporaryDirectory()) {
753             var repo = credentials.getHostedRepository();
754             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
755             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
756             credentials.commitLock(localRepo);
757             localRepo.pushAll(repo.url());
758 
759             var tagStorage = createTagStorage(repo);
760             var branchStorage = createBranchStorage(repo);
761             var prIssuesStorage = createPullRequestIssuesStorage(repo);
762             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
763 
764             var issueProject = credentials.getIssueProject();
765             var updater = new IssueUpdater(issueProject, null);
<span class="line-modified">766             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified">767                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>
768 
769             // Initialize history
770             TestBotRunner.runPeriodicItems(notifyBot);
771 
772             // Create an issue and commit a fix
773             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;));
774             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
775             localRepo.push(editHash, repo.url(), &quot;master&quot;);
776             TestBotRunner.runPeriodicItems(notifyBot);
777 
778             // The changeset should be reflected in a comment
779             var comments = issue.comments();
780             assertEquals(1, comments.size());
781             var comment = comments.get(0);
782             assertTrue(comment.body().contains(editHash.abbreviate()));
783 
784             // There should be no open issues
785             assertEquals(0, issueProject.issues().size());
786         }
787     }
788 
789     @Test
790     void testPullRequest(TestInfo testInfo) throws IOException {
791         try (var credentials = new HostCredentials(testInfo);
792              var tempFolder = new TemporaryDirectory()) {
793             var repo = credentials.getHostedRepository();
794             var reviewer = credentials.getHostedRepository();
795             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
796             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
797             credentials.commitLock(localRepo);
798             localRepo.pushAll(repo.url());
799 
800             var tagStorage = createTagStorage(repo);
801             var branchStorage = createBranchStorage(repo);
802             var prIssuesStorage = createPullRequestIssuesStorage(repo);
803             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
804 
805             var issueProject = credentials.getIssueProject();
806             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
807             var updater = new IssueUpdater(issueProject, reviewIcon);
<span class="line-modified">808             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified">809                                           prIssuesStorage, List.of(), List.of(updater), Set.of(&quot;rfr&quot;),</span>
<span class="line-modified">810                                           Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)));</span>
811 
812             // Initialize history
813             TestBotRunner.runPeriodicItems(notifyBot);
814 
815             // Create an issue and a pull request to fix it
816             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;));
817             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
818             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
819             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
820             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
821             TestBotRunner.runPeriodicItems(notifyBot);
822 
823             // The issue should not yet contain a link to the PR
824             var links = issue.links();
825             assertEquals(0, links.size());
826 
827             // Just a label isn&#39;t enough
828             pr.addLabel(&quot;rfr&quot;);
829             TestBotRunner.runPeriodicItems(notifyBot);
830             links = issue.links();
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../main/java/module-info.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>