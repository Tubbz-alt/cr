<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff forge/src/main/java/org/openjdk/skara/forge/github/GitHubRepository.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>forge/src/main/java/org/openjdk/skara/forge/github/GitHubRepository.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.forge.github;
 24 
 25 import org.openjdk.skara.forge.*;
 26 import org.openjdk.skara.json.*;
 27 import org.openjdk.skara.network.*;
 28 import org.openjdk.skara.vcs.*;
 29 
 30 import java.net.URI;
 31 import java.nio.charset.StandardCharsets;
 32 import java.util.*;
 33 import java.util.regex.Pattern;
 34 import java.util.stream.Collectors;
 35 
 36 public class GitHubRepository implements HostedRepository {
 37     private final GitHubHost gitHubHost;
 38     private final String repository;
 39     private final RestRequest request;
<span class="line-removed"> 40     private final JSONValue json;</span>
 41     private final Pattern pullRequestPattern;
 42 


 43     GitHubRepository(GitHubHost gitHubHost, String repository) {
 44         this.gitHubHost = gitHubHost;
 45         this.repository = repository;
 46 
 47         var apiBase = URIBuilder
 48                 .base(gitHubHost.getURI())
 49                 .appendSubDomain(&quot;api&quot;)
 50                 .setPath(&quot;/repos/&quot; + repository + &quot;/&quot;)
 51                 .build();
 52         request = new RestRequest(apiBase, () -&gt; {
 53             var headers = new ArrayList&lt;&gt;(List.of(
 54                 &quot;Accept&quot;, &quot;application/vnd.github.machine-man-preview+json&quot;,
 55                 &quot;Accept&quot;, &quot;application/vnd.github.antiope-preview+json&quot;,
 56                 &quot;Accept&quot;, &quot;application/vnd.github.shadow-cat-preview+json&quot;,
 57                 &quot;Accept&quot;, &quot;application/vnd.github.comfort-fade-preview+json&quot;));
 58             var token = gitHubHost.getInstallationToken();
 59             if (token.isPresent()) {
 60                 headers.add(&quot;Authorization&quot;);
 61                 headers.add(&quot;token &quot; + token.get());
 62             }
 63             return headers;
 64         });
<span class="line-modified"> 65         json = gitHubHost.getProjectInfo(repository);</span>
 66         var urlPattern = gitHubHost.getWebURI(&quot;/&quot; + repository + &quot;/pull/&quot;).toString();
 67         pullRequestPattern = Pattern.compile(urlPattern + &quot;(\\d+)&quot;);
 68     }
 69 







 70     @Override
 71     public Optional&lt;HostedRepository&gt; parent() {
<span class="line-modified"> 72         if (json.get(&quot;fork&quot;).asBoolean()) {</span>
<span class="line-modified"> 73             var parent = json.get(&quot;parent&quot;).get(&quot;full_name&quot;).asString();</span>
 74             return Optional.of(new GitHubRepository(gitHubHost, parent));
 75         }
 76         return Optional.empty();
 77     }
 78 
 79     @Override
 80     public Forge forge() {
 81         return gitHubHost;
 82     }
 83 
 84     @Override
 85     public PullRequest createPullRequest(HostedRepository target,
 86                                          String targetRef,
 87                                          String sourceRef,
 88                                          String title,
 89                                          List&lt;String&gt; body,
 90                                          boolean draft) {
 91         if (!(target instanceof GitHubRepository)) {
 92             throw new IllegalArgumentException(&quot;target repository must be a GitHub repository&quot;);
 93         }
</pre>
<hr />
<pre>
188     }
189 
190     @Override
191     public String namespace() {
192         return URIBuilder.base(gitHubHost.getURI()).build().getHost();
193     }
194 
195     @Override
196     public Optional&lt;WebHook&gt; parseWebHook(JSONValue body) {
197         throw new RuntimeException(&quot;not implemented yet&quot;);
198     }
199 
200     @Override
201     public HostedRepository fork() {
202         var response = request.post(&quot;forks&quot;).execute();
203         return gitHubHost.repository(response.get(&quot;full_name&quot;).asString()).orElseThrow(RuntimeException::new);
204     }
205 
206     @Override
207     public long id() {
<span class="line-modified">208         return json.get(&quot;id&quot;).asLong();</span>
209     }
210 
211     @Override
212     public Hash branchHash(String ref) {
213         var branch = request.get(&quot;branches/&quot; + ref).execute();
214         return new Hash(branch.get(&quot;commit&quot;).get(&quot;sha&quot;).asString());
215     }
216 }
</pre>
</td>
<td>
<hr />
<pre>
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.forge.github;
 24 
 25 import org.openjdk.skara.forge.*;
 26 import org.openjdk.skara.json.*;
 27 import org.openjdk.skara.network.*;
 28 import org.openjdk.skara.vcs.*;
 29 
 30 import java.net.URI;
 31 import java.nio.charset.StandardCharsets;
 32 import java.util.*;
 33 import java.util.regex.Pattern;
 34 import java.util.stream.Collectors;
 35 
 36 public class GitHubRepository implements HostedRepository {
 37     private final GitHubHost gitHubHost;
 38     private final String repository;
 39     private final RestRequest request;

 40     private final Pattern pullRequestPattern;
 41 
<span class="line-added"> 42     private JSONValue cachedJSON;</span>
<span class="line-added"> 43 </span>
 44     GitHubRepository(GitHubHost gitHubHost, String repository) {
 45         this.gitHubHost = gitHubHost;
 46         this.repository = repository;
 47 
 48         var apiBase = URIBuilder
 49                 .base(gitHubHost.getURI())
 50                 .appendSubDomain(&quot;api&quot;)
 51                 .setPath(&quot;/repos/&quot; + repository + &quot;/&quot;)
 52                 .build();
 53         request = new RestRequest(apiBase, () -&gt; {
 54             var headers = new ArrayList&lt;&gt;(List.of(
 55                 &quot;Accept&quot;, &quot;application/vnd.github.machine-man-preview+json&quot;,
 56                 &quot;Accept&quot;, &quot;application/vnd.github.antiope-preview+json&quot;,
 57                 &quot;Accept&quot;, &quot;application/vnd.github.shadow-cat-preview+json&quot;,
 58                 &quot;Accept&quot;, &quot;application/vnd.github.comfort-fade-preview+json&quot;));
 59             var token = gitHubHost.getInstallationToken();
 60             if (token.isPresent()) {
 61                 headers.add(&quot;Authorization&quot;);
 62                 headers.add(&quot;token &quot; + token.get());
 63             }
 64             return headers;
 65         });
<span class="line-modified"> 66         this.cachedJSON = null;</span>
 67         var urlPattern = gitHubHost.getWebURI(&quot;/&quot; + repository + &quot;/pull/&quot;).toString();
 68         pullRequestPattern = Pattern.compile(urlPattern + &quot;(\\d+)&quot;);
 69     }
 70 
<span class="line-added"> 71     private JSONValue json() {</span>
<span class="line-added"> 72         if (cachedJSON == null) {</span>
<span class="line-added"> 73             cachedJSON = gitHubHost.getProjectInfo(repository);</span>
<span class="line-added"> 74         }</span>
<span class="line-added"> 75         return cachedJSON;</span>
<span class="line-added"> 76     }</span>
<span class="line-added"> 77 </span>
 78     @Override
 79     public Optional&lt;HostedRepository&gt; parent() {
<span class="line-modified"> 80         if (json().get(&quot;fork&quot;).asBoolean()) {</span>
<span class="line-modified"> 81             var parent = json().get(&quot;parent&quot;).get(&quot;full_name&quot;).asString();</span>
 82             return Optional.of(new GitHubRepository(gitHubHost, parent));
 83         }
 84         return Optional.empty();
 85     }
 86 
 87     @Override
 88     public Forge forge() {
 89         return gitHubHost;
 90     }
 91 
 92     @Override
 93     public PullRequest createPullRequest(HostedRepository target,
 94                                          String targetRef,
 95                                          String sourceRef,
 96                                          String title,
 97                                          List&lt;String&gt; body,
 98                                          boolean draft) {
 99         if (!(target instanceof GitHubRepository)) {
100             throw new IllegalArgumentException(&quot;target repository must be a GitHub repository&quot;);
101         }
</pre>
<hr />
<pre>
196     }
197 
198     @Override
199     public String namespace() {
200         return URIBuilder.base(gitHubHost.getURI()).build().getHost();
201     }
202 
203     @Override
204     public Optional&lt;WebHook&gt; parseWebHook(JSONValue body) {
205         throw new RuntimeException(&quot;not implemented yet&quot;);
206     }
207 
208     @Override
209     public HostedRepository fork() {
210         var response = request.post(&quot;forks&quot;).execute();
211         return gitHubHost.repository(response.get(&quot;full_name&quot;).asString()).orElseThrow(RuntimeException::new);
212     }
213 
214     @Override
215     public long id() {
<span class="line-modified">216         return json().get(&quot;id&quot;).asLong();</span>
217     }
218 
219     @Override
220     public Hash branchHash(String ref) {
221         var branch = request.get(&quot;branches/&quot; + ref).execute();
222         return new Hash(branch.get(&quot;commit&quot;).get(&quot;sha&quot;).asString());
223     }
224 }
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>