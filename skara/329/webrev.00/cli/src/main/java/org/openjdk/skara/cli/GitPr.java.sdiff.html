<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff cli/src/main/java/org/openjdk/skara/cli/GitPr.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>cli/src/main/java/org/openjdk/skara/cli/GitPr.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  27 import org.openjdk.skara.host.*;
  28 import org.openjdk.skara.issuetracker.IssueTracker;
  29 import org.openjdk.skara.issuetracker.Issue;
  30 import org.openjdk.skara.jcheck.JCheckConfiguration;
  31 import org.openjdk.skara.proxy.HttpProxy;
  32 import org.openjdk.skara.vcs.*;
  33 import org.openjdk.skara.vcs.openjdk.CommitMessageParsers;
  34 
  35 import java.io.IOException;
  36 import java.net.URI;
  37 import java.nio.charset.StandardCharsets;
  38 import java.nio.file.*;
  39 import java.util.*;
  40 import java.util.regex.Pattern;
  41 import java.util.concurrent.TimeUnit;
  42 import java.util.function.Supplier;
  43 import java.util.logging.Level;
  44 import java.util.stream.Collectors;
  45 
  46 public class GitPr {


  47     private static void exit(String fmt, Object...args) {
  48         System.err.println(String.format(fmt, args));
  49         System.exit(1);
  50     }
  51 
  52     private static &lt;T&gt; Supplier&lt;T&gt; die(String fmt, Object... args) {
  53         return () -&gt; {
  54             exit(fmt, args);
  55             return null;
  56         };
  57     }
  58 











  59     private static String format(Issue issue) {
  60         var parts = issue.id().split(&quot;-&quot;);
  61         var id = parts.length == 2 ? parts[1] : issue.id();
  62         return id + &quot;: &quot; + issue.title();
  63     }
  64 
  65     private static String jbsProjectFromJcheckConf(Repository repo) throws IOException {
  66         var conf = JCheckConfiguration.from(repo, repo.resolve(&quot;master&quot;).orElseThrow(() -&gt;
  67             new IOException(&quot;Could not resolve &#39;master&#39; branch&quot;)
  68         ));
  69 
  70         return conf.general().jbs();
  71     }
  72 
  73     private static Optional&lt;Issue&gt; getIssue(Commit commit, String project) throws IOException {
  74         var message = CommitMessageParsers.v1.parse(commit.message());
  75         var issues = message.issues();
  76         if (issues.isEmpty()) {
  77             return getIssue(message.title(), project);
  78         } else if (issues.size() == 1) {
</pre>
<hr />
<pre>
 691 
 692             var targetBranch = arguments.get(&quot;branch&quot;).orString(&quot;master&quot;);
 693             var commits = repo.commits(targetBranch + &quot;..&quot; + upstream.get()).asList();
 694             if (commits.isEmpty()) {
 695                 System.err.println(&quot;error: no difference between branches &quot; + targetBranch + &quot; and &quot; + currentBranch.name());
 696                 System.err.println(&quot;       Cannot create an empty pull request, have you committed?&quot;);
 697                 System.exit(1);
 698             }
 699 
 700             var remoteRepo = host.repository(projectName(uri)).orElseThrow(() -&gt;
 701                     new IOException(&quot;Could not find repository at &quot; + uri.toString())
 702             );
 703             if (token == null) {
 704                 GitCredentials.approve(credentials);
 705             }
 706             var parentRepo = remoteRepo.parent().orElseThrow(() -&gt;
 707                     new IOException(&quot;error: remote repository &quot; + remotePullPath + &quot; is not a fork of any repository&quot;));
 708 
 709             var project = jbsProjectFromJcheckConf(repo);
 710             var issue = getIssue(currentBranch, project);
<span class="line-modified"> 711             var file = Files.createTempFile(&quot;PULL_REQUEST_&quot;, &quot;.txt&quot;);</span>
 712             if (issue.isPresent()) {
 713                 Files.writeString(file, format(issue.get()) + &quot;\n\n&quot;);
 714             } else if (commits.size() == 1) {
 715                 var commit = commits.get(0);
 716                 issue = getIssue(commit, project);
 717                 if (issue.isPresent()) {
 718                     Files.writeString(file, format(issue.get()) + &quot;\n\n&quot;);
 719                 } else {
 720                     var message = CommitMessageParsers.v1.parse(commit.message());
 721                     Files.writeString(file, message.title() + &quot;\n&quot;);
 722                     if (!message.summaries().isEmpty()) {
 723                         Files.write(file, message.summaries(), StandardOpenOption.APPEND);
 724                     }
 725                     if (!message.additional().isEmpty()) {
 726                         Files.write(file, message.additional(), StandardOpenOption.APPEND);
 727                     }
 728                 }
 729             } else {
 730                 Files.write(file, List.of(&quot;&quot;));
 731             }
<span class="line-modified"> 732             Files.write(file, List.of(</span>
<span class="line-modified"> 733                 &quot;# Please enter the pull request message for your changes. Lines starting&quot;,</span>
<span class="line-modified"> 734                 &quot;# with &#39;#&#39; will be ignored, and an empty message aborts the pull request.&quot;,</span>
<span class="line-modified"> 735                 &quot;# The first line will be considered the subject, use a blank line to separate&quot;,</span>
<span class="line-modified"> 736                 &quot;# the subject from the body.&quot;,</span>
<span class="line-modified"> 737                 &quot;#&quot;,</span>
<span class="line-modified"> 738                 &quot;# Commits to be included from branch &#39;&quot; + currentBranch.name() + &quot;&#39;&quot;</span>
<span class="line-removed"> 739                 ),</span>
<span class="line-removed"> 740                 StandardOpenOption.APPEND</span>
<span class="line-removed"> 741             );</span>
 742             for (var commit : commits) {
 743                 var desc = commit.hash().abbreviate() + &quot;: &quot; + commit.message().get(0);
<span class="line-modified"> 744                 Files.writeString(file, &quot;# - &quot; + desc + &quot;\n&quot;, StandardOpenOption.APPEND);</span>



















 745             }
<span class="line-modified"> 746             Files.writeString(file, &quot;#\n&quot;, StandardOpenOption.APPEND);</span>
<span class="line-modified"> 747             Files.writeString(file, &quot;# Target repository: &quot; + remotePullPath + &quot;\n&quot;, StandardOpenOption.APPEND);</span>
<span class="line-modified"> 748             Files.writeString(file, &quot;# Target branch: &quot; + targetBranch + &quot;\n&quot;, StandardOpenOption.APPEND);</span>




 749             var success = spawnEditor(repo, file);
 750             if (!success) {
 751                 System.err.println(&quot;error: editor exited with non-zero status code, aborting&quot;);
 752                 System.exit(1);
 753             }
 754             var lines = Files.readAllLines(file)
 755                              .stream()
<span class="line-modified"> 756                              .filter(l -&gt; !l.startsWith(&quot;#&quot;))</span>
 757                              .collect(Collectors.toList());
 758             var isEmpty = lines.stream().allMatch(String::isEmpty);
 759             if (isEmpty) {
 760                 System.err.println(&quot;error: no message present, aborting&quot;);
 761                 System.exit(1);
 762             }
 763 
 764             var title = lines.get(0);
 765             List&lt;String&gt; body = null;
 766             if (lines.size() &gt; 1) {
 767                 body = lines.subList(1, lines.size())
 768                             .stream()
 769                             .dropWhile(String::isEmpty)
 770                             .collect(Collectors.toList());
 771             } else {
 772                 body = Collections.emptyList();
 773             }
 774 
 775             var pr = remoteRepo.createPullRequest(parentRepo, targetBranch, currentBranch.name(), title, body);
 776             if (arguments.contains(&quot;assignees&quot;)) {
</pre>
</td>
<td>
<hr />
<pre>
  27 import org.openjdk.skara.host.*;
  28 import org.openjdk.skara.issuetracker.IssueTracker;
  29 import org.openjdk.skara.issuetracker.Issue;
  30 import org.openjdk.skara.jcheck.JCheckConfiguration;
  31 import org.openjdk.skara.proxy.HttpProxy;
  32 import org.openjdk.skara.vcs.*;
  33 import org.openjdk.skara.vcs.openjdk.CommitMessageParsers;
  34 
  35 import java.io.IOException;
  36 import java.net.URI;
  37 import java.nio.charset.StandardCharsets;
  38 import java.nio.file.*;
  39 import java.util.*;
  40 import java.util.regex.Pattern;
  41 import java.util.concurrent.TimeUnit;
  42 import java.util.function.Supplier;
  43 import java.util.logging.Level;
  44 import java.util.stream.Collectors;
  45 
  46 public class GitPr {
<span class="line-added">  47     private static final StandardOpenOption APPEND = StandardOpenOption.APPEND;</span>
<span class="line-added">  48 </span>
  49     private static void exit(String fmt, Object...args) {
  50         System.err.println(String.format(fmt, args));
  51         System.exit(1);
  52     }
  53 
  54     private static &lt;T&gt; Supplier&lt;T&gt; die(String fmt, Object... args) {
  55         return () -&gt; {
  56             exit(fmt, args);
  57             return null;
  58         };
  59     }
  60 
<span class="line-added">  61     private static String rightPad(String s, int length) {</span>
<span class="line-added">  62         return String.format(&quot;%-&quot; + length + &quot;s&quot;, s);</span>
<span class="line-added">  63     }</span>
<span class="line-added">  64 </span>
<span class="line-added">  65     private static void appendPaddedHTMLComment(Path file, String line) throws IOException {</span>
<span class="line-added">  66         var end = &quot; --&gt;&quot;;</span>
<span class="line-added">  67         var pad = 79 - end.length();</span>
<span class="line-added">  68         var newLine = &quot;\n&quot;;</span>
<span class="line-added">  69         Files.writeString(file, rightPad(&quot;&lt;!-- &quot; + line, pad) + end + newLine, StandardOpenOption.APPEND);</span>
<span class="line-added">  70     }</span>
<span class="line-added">  71 </span>
  72     private static String format(Issue issue) {
  73         var parts = issue.id().split(&quot;-&quot;);
  74         var id = parts.length == 2 ? parts[1] : issue.id();
  75         return id + &quot;: &quot; + issue.title();
  76     }
  77 
  78     private static String jbsProjectFromJcheckConf(Repository repo) throws IOException {
  79         var conf = JCheckConfiguration.from(repo, repo.resolve(&quot;master&quot;).orElseThrow(() -&gt;
  80             new IOException(&quot;Could not resolve &#39;master&#39; branch&quot;)
  81         ));
  82 
  83         return conf.general().jbs();
  84     }
  85 
  86     private static Optional&lt;Issue&gt; getIssue(Commit commit, String project) throws IOException {
  87         var message = CommitMessageParsers.v1.parse(commit.message());
  88         var issues = message.issues();
  89         if (issues.isEmpty()) {
  90             return getIssue(message.title(), project);
  91         } else if (issues.size() == 1) {
</pre>
<hr />
<pre>
 704 
 705             var targetBranch = arguments.get(&quot;branch&quot;).orString(&quot;master&quot;);
 706             var commits = repo.commits(targetBranch + &quot;..&quot; + upstream.get()).asList();
 707             if (commits.isEmpty()) {
 708                 System.err.println(&quot;error: no difference between branches &quot; + targetBranch + &quot; and &quot; + currentBranch.name());
 709                 System.err.println(&quot;       Cannot create an empty pull request, have you committed?&quot;);
 710                 System.exit(1);
 711             }
 712 
 713             var remoteRepo = host.repository(projectName(uri)).orElseThrow(() -&gt;
 714                     new IOException(&quot;Could not find repository at &quot; + uri.toString())
 715             );
 716             if (token == null) {
 717                 GitCredentials.approve(credentials);
 718             }
 719             var parentRepo = remoteRepo.parent().orElseThrow(() -&gt;
 720                     new IOException(&quot;error: remote repository &quot; + remotePullPath + &quot; is not a fork of any repository&quot;));
 721 
 722             var project = jbsProjectFromJcheckConf(repo);
 723             var issue = getIssue(currentBranch, project);
<span class="line-modified"> 724             var file = Files.createTempFile(&quot;PULL_REQUEST_&quot;, &quot;.md&quot;);</span>
 725             if (issue.isPresent()) {
 726                 Files.writeString(file, format(issue.get()) + &quot;\n\n&quot;);
 727             } else if (commits.size() == 1) {
 728                 var commit = commits.get(0);
 729                 issue = getIssue(commit, project);
 730                 if (issue.isPresent()) {
 731                     Files.writeString(file, format(issue.get()) + &quot;\n\n&quot;);
 732                 } else {
 733                     var message = CommitMessageParsers.v1.parse(commit.message());
 734                     Files.writeString(file, message.title() + &quot;\n&quot;);
 735                     if (!message.summaries().isEmpty()) {
 736                         Files.write(file, message.summaries(), StandardOpenOption.APPEND);
 737                     }
 738                     if (!message.additional().isEmpty()) {
 739                         Files.write(file, message.additional(), StandardOpenOption.APPEND);
 740                     }
 741                 }
 742             } else {
 743                 Files.write(file, List.of(&quot;&quot;));
 744             }
<span class="line-modified"> 745 </span>
<span class="line-modified"> 746             appendPaddedHTMLComment(file, &quot;Please enter the pull request message for your changes.&quot;);</span>
<span class="line-modified"> 747             appendPaddedHTMLComment(file, &quot;The first line will be considered the subject, use a blank line to&quot;);</span>
<span class="line-modified"> 748             appendPaddedHTMLComment(file, &quot;separate the subject from the body. These HTML comment lines will&quot;);</span>
<span class="line-modified"> 749             appendPaddedHTMLComment(file, &quot;be removed automatically. An empty message aborts the pull request.&quot;);</span>
<span class="line-modified"> 750             appendPaddedHTMLComment(file, &quot;&quot;);</span>
<span class="line-modified"> 751             appendPaddedHTMLComment(file, &quot;Commits to be included from branch &#39;&quot; + currentBranch.name() + &quot;&#39;:&quot;);</span>



 752             for (var commit : commits) {
 753                 var desc = commit.hash().abbreviate() + &quot;: &quot; + commit.message().get(0);
<span class="line-modified"> 754                 appendPaddedHTMLComment(file, &quot;- &quot; + desc);</span>
<span class="line-added"> 755                 if (!commit.isMerge()) {</span>
<span class="line-added"> 756                     var diff = commit.parentDiffs().get(0);</span>
<span class="line-added"> 757                     for (var patch : diff.patches()) {</span>
<span class="line-added"> 758                         var status = patch.status();</span>
<span class="line-added"> 759                         if (status.isModified()) {</span>
<span class="line-added"> 760                             appendPaddedHTMLComment(file, &quot;  M  &quot; + patch.target().path().get().toString());</span>
<span class="line-added"> 761                         } else if (status.isAdded()) {</span>
<span class="line-added"> 762                             appendPaddedHTMLComment(file, &quot;  A  &quot; + patch.target().path().get().toString());</span>
<span class="line-added"> 763                         } else if (status.isDeleted()) {</span>
<span class="line-added"> 764                             appendPaddedHTMLComment(file, &quot;  D  &quot; + patch.source().path().get().toString());</span>
<span class="line-added"> 765                         } else if (status.isRenamed()) {</span>
<span class="line-added"> 766                             appendPaddedHTMLComment(file, &quot;  R  &quot; + patch.target().path().get().toString());</span>
<span class="line-added"> 767                             appendPaddedHTMLComment(file, &quot;      (&quot; + patch.source().path().get().toString() + &quot;)&quot;);</span>
<span class="line-added"> 768                         } else if (status.isCopied()) {</span>
<span class="line-added"> 769                             appendPaddedHTMLComment(file, &quot;  C  &quot; + patch.target().path().get().toString());</span>
<span class="line-added"> 770                             appendPaddedHTMLComment(file, &quot;      (&quot; + patch.source().path().get().toString() + &quot;)&quot;);</span>
<span class="line-added"> 771                         }</span>
<span class="line-added"> 772                     }</span>
<span class="line-added"> 773                 }</span>
 774             }
<span class="line-modified"> 775             appendPaddedHTMLComment(file, &quot;&quot;);</span>
<span class="line-modified"> 776             if (issue.isPresent()) {</span>
<span class="line-modified"> 777                 appendPaddedHTMLComment(file, &quot;Issue:      &quot; + issue.get().webUrl());</span>
<span class="line-added"> 778             }</span>
<span class="line-added"> 779             appendPaddedHTMLComment(file, &quot;Repository: &quot; + parentRepo.webUrl());</span>
<span class="line-added"> 780             appendPaddedHTMLComment(file, &quot;Branch:     &quot; + targetBranch);</span>
<span class="line-added"> 781 </span>
 782             var success = spawnEditor(repo, file);
 783             if (!success) {
 784                 System.err.println(&quot;error: editor exited with non-zero status code, aborting&quot;);
 785                 System.exit(1);
 786             }
 787             var lines = Files.readAllLines(file)
 788                              .stream()
<span class="line-modified"> 789                              .filter(l -&gt; !(l.startsWith(&quot;&lt;!--&quot;) &amp;&amp; l.endsWith(&quot;--&gt;&quot;)))</span>
 790                              .collect(Collectors.toList());
 791             var isEmpty = lines.stream().allMatch(String::isEmpty);
 792             if (isEmpty) {
 793                 System.err.println(&quot;error: no message present, aborting&quot;);
 794                 System.exit(1);
 795             }
 796 
 797             var title = lines.get(0);
 798             List&lt;String&gt; body = null;
 799             if (lines.size() &gt; 1) {
 800                 body = lines.subList(1, lines.size())
 801                             .stream()
 802                             .dropWhile(String::isEmpty)
 803                             .collect(Collectors.toList());
 804             } else {
 805                 body = Collections.emptyList();
 806             }
 807 
 808             var pr = remoteRepo.createPullRequest(parentRepo, targetBranch, currentBranch.name(), title, body);
 809             if (arguments.contains(&quot;assignees&quot;)) {
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>