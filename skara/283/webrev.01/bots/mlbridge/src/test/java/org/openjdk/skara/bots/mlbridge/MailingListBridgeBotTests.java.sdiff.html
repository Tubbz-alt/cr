<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/mlbridge/WebrevStorage.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="WebrevStorageTests.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 534             var thread1reply2 = conversations.get(0).replies(thread1reply1).get(0);
 535             assertTrue(thread1reply2.body().contains(&quot;Great&quot;));
 536             assertEquals(&quot;integrationreviewer1@openjdk.java.net&quot;, thread1reply2.author().address());
 537             assertEquals(&quot;Generated Reviewer 1&quot;, thread1reply2.author().fullName().orElseThrow());
 538 
 539             var thread2 = conversations.get(0).replies(mail).get(1);
 540             assertEquals(2, thread2.body().split(&quot;^On.*wrote:&quot;).length);
 541             assertEquals(2, thread2.body().split(&quot;&gt; This is now ready&quot;).length, thread2.body());
 542             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread2.subject());
 543             assertFalse(thread2.body().contains(&quot;Review comment\n\n&quot;), thread2.body());
 544             assertTrue(thread2.body().contains(&quot;Another review comment&quot;), thread2.body());
 545             var thread2reply1 = conversations.get(0).replies(thread2).get(0);
 546             assertTrue(thread2reply1.body().contains(&quot;Sounds good&quot;));
 547             var thread2reply2 = conversations.get(0).replies(thread2reply1).get(0);
 548             assertTrue(thread2reply2.body().contains(&quot;Thanks&quot;));
 549 
 550             var replies = conversations.get(0).replies(mail);
 551             var thread3 = replies.get(2);
 552             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread3.subject());
 553             var thread4 = replies.get(3);
<span class="line-modified"> 554             assertEquals(&quot;Re: [Approved] RFR: This is a pull request&quot;, thread4.subject());</span>
 555             assertTrue(thread4.body().contains(&quot;Looks fine&quot;));
 556             assertTrue(thread4.body().contains(&quot;The final review comment&quot;));
 557             assertTrue(thread4.body().contains(&quot;Approved by integrationreviewer1 (Reviewer)&quot;));
 558         }
 559     }
 560 

























































 561     @Test
 562     void reviewContext(TestInfo testInfo) throws IOException {
 563         try (var credentials = new HostCredentials(testInfo);
 564              var tempFolder = new TemporaryDirectory();
 565              var archiveFolder = new TemporaryDirectory();
 566              var listServer = new TestMailmanServer()) {
 567             var author = credentials.getHostedRepository();
 568             var archive = credentials.getHostedRepository();
 569             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 570             var censusBuilder = credentials.getCensusBuilder()
 571                                            .addAuthor(author.forge().currentUser().id());
 572             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 573             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 574                                                  censusBuilder.build(), &quot;master&quot;,
 575                                                  listAddress, Set.of(), Set.of(),
 576                                                  listServer.getArchive(),
 577                                                  listServer.getSMTP(),
 578                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 579                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 580                                                  Set.of(), Map.of(),
</pre>
<hr />
<pre>
 784             localRepo.push(nextHash, author.url(), &quot;edit&quot;);
 785 
 786             // Make sure that the push registered
 787             var lastHeadHash = pr.headHash();
 788             var refreshCount = 0;
 789             do {
 790                 pr = author.pullRequest(pr.id());
 791                 if (refreshCount++ &gt; 100) {
 792                     fail(&quot;The PR did not update after the new push&quot;);
 793                 }
 794             } while (pr.headHash().equals(lastHeadHash));
 795 
 796             // Run another archive pass
 797             TestBotRunner.runPeriodicItems(mlBot);
 798             TestBotRunner.runPeriodicItems(mlBot);
 799             TestBotRunner.runPeriodicItems(mlBot);
 800             listServer.processIncoming();
 801 
 802             // The archive should reference the updated push
 803             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
<span class="line-modified"> 804             assertTrue(archiveContains(archiveFolder.path(), &quot;additional changes&quot;));</span>
 805             assertTrue(archiveContains(archiveFolder.path(), &quot;full.*/&quot; + pr.id() + &quot;/webrev.01&quot;));
 806             assertTrue(archiveContains(archiveFolder.path(), &quot;inc.*/&quot; + pr.id() + &quot;/webrev.00-01&quot;));
 807             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
 808             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
 809             assertTrue(archiveContains(archiveFolder.path(), &quot;Fixing&quot;));
 810 
 811             // The webrev comment should be updated
 812             var comments = pr.comments();
 813             var webrevComments = comments.stream()
 814                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
 815                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 816                                          .filter(comment -&gt; comment.body().contains(nextHash.hex()))
 817                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 818                                          .collect(Collectors.toList());
 819             assertEquals(1, webrevComments.size());
 820 
 821             // Check that sender address is set properly
 822             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 823             var mailmanList = mailmanServer.getList(listAddress.address());
 824             var conversations = mailmanList.conversations(Duration.ofDays(1));
</pre>
<hr />
<pre>
 905             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.url(), &quot;master&quot;);
 906             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
 907             newLocalRepo.push(newEditHash, author.url(), &quot;edit&quot;, true);
 908 
 909             // Make sure that the push registered
 910             var lastHeadHash = pr.headHash();
 911             var refreshCount = 0;
 912             do {
 913                 pr = author.pullRequest(pr.id());
 914                 if (refreshCount++ &gt; 100) {
 915                     fail(&quot;The PR did not update after the new push&quot;);
 916                 }
 917             } while (pr.headHash().equals(lastHeadHash));
 918 
 919             // Run another archive pass
 920             TestBotRunner.runPeriodicItems(mlBot);
 921             listServer.processIncoming();
 922 
 923             // The archive should reference the rebased push
 924             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
<span class="line-modified"> 925             assertTrue(archiveContains(archiveFolder.path(), &quot;complete new set of changes&quot;));</span>
 926             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.01&quot;));
 927             assertFalse(archiveContains(archiveFolder.path(), &quot;Incremental&quot;));
 928             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
 929             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
 930             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
 931             assertTrue(archiveContains(archiveFolder.path(), &quot;Replaced msg&quot;));
 932 
 933             // The webrev comment should be updated
 934             var comments = pr.comments();
 935             var webrevComments = comments.stream()
 936                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
 937                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 938                                          .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
 939                                          .collect(Collectors.toList());
 940             assertEquals(1, webrevComments.size());
 941 
 942             // Check that sender address is set properly
 943             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 944             var mailmanList = mailmanServer.getList(listAddress.address());
 945             var conversations = mailmanList.conversations(Duration.ofDays(1));
</pre>
<hr />
<pre>
1079             // The archive should contain a note
1080             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1081             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
1082             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot; by integrationreviewer1&quot;));
1083             if (author.forge().supportsReviewBody()) {
1084                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
1085             }
1086 
1087             // Then approve it
1088             reviewedPr.addReview(Review.Verdict.APPROVED, &quot;Reason 2&quot;);
1089             TestBotRunner.runPeriodicItems(mlBot);
1090             TestBotRunner.runPeriodicItems(mlBot);
1091             TestBotRunner.runPeriodicItems(mlBot);
1092 
1093             // The archive should contain another note
1094             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1095             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Approved by &quot;));
1096             if (author.forge().supportsReviewBody()) {
1097                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 2&quot;));
1098             }
<span class="line-modified">1099             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Re: \\[Approved\\] RFR:&quot;));</span>
1100 
1101             // Yet another change
1102             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 3&quot;);
1103             TestBotRunner.runPeriodicItems(mlBot);
1104             TestBotRunner.runPeriodicItems(mlBot);
1105             TestBotRunner.runPeriodicItems(mlBot);
1106 
1107             // The archive should contain another note
1108             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1109             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
1110             if (author.forge().supportsReviewBody()) {
1111                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
1112             }
1113         }
1114     }
1115 
1116     @Test
1117     void ignoreComments(TestInfo testInfo) throws IOException {
1118         try (var credentials = new HostCredentials(testInfo);
1119              var tempFolder = new TemporaryDirectory();
</pre>
</td>
<td>
<hr />
<pre>
 534             var thread1reply2 = conversations.get(0).replies(thread1reply1).get(0);
 535             assertTrue(thread1reply2.body().contains(&quot;Great&quot;));
 536             assertEquals(&quot;integrationreviewer1@openjdk.java.net&quot;, thread1reply2.author().address());
 537             assertEquals(&quot;Generated Reviewer 1&quot;, thread1reply2.author().fullName().orElseThrow());
 538 
 539             var thread2 = conversations.get(0).replies(mail).get(1);
 540             assertEquals(2, thread2.body().split(&quot;^On.*wrote:&quot;).length);
 541             assertEquals(2, thread2.body().split(&quot;&gt; This is now ready&quot;).length, thread2.body());
 542             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread2.subject());
 543             assertFalse(thread2.body().contains(&quot;Review comment\n\n&quot;), thread2.body());
 544             assertTrue(thread2.body().contains(&quot;Another review comment&quot;), thread2.body());
 545             var thread2reply1 = conversations.get(0).replies(thread2).get(0);
 546             assertTrue(thread2reply1.body().contains(&quot;Sounds good&quot;));
 547             var thread2reply2 = conversations.get(0).replies(thread2reply1).get(0);
 548             assertTrue(thread2reply2.body().contains(&quot;Thanks&quot;));
 549 
 550             var replies = conversations.get(0).replies(mail);
 551             var thread3 = replies.get(2);
 552             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread3.subject());
 553             var thread4 = replies.get(3);
<span class="line-modified"> 554             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread4.subject());</span>
 555             assertTrue(thread4.body().contains(&quot;Looks fine&quot;));
 556             assertTrue(thread4.body().contains(&quot;The final review comment&quot;));
 557             assertTrue(thread4.body().contains(&quot;Approved by integrationreviewer1 (Reviewer)&quot;));
 558         }
 559     }
 560 
<span class="line-added"> 561     @Test</span>
<span class="line-added"> 562     void commentThreadingSeparated(TestInfo testInfo) throws IOException {</span>
<span class="line-added"> 563         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added"> 564              var tempFolder = new TemporaryDirectory();</span>
<span class="line-added"> 565              var archiveFolder = new TemporaryDirectory();</span>
<span class="line-added"> 566              var listServer = new TestMailmanServer()) {</span>
<span class="line-added"> 567             var author = credentials.getHostedRepository();</span>
<span class="line-added"> 568             var reviewer = credentials.getHostedRepository();</span>
<span class="line-added"> 569             var archive = credentials.getHostedRepository();</span>
<span class="line-added"> 570             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="line-added"> 571             var censusBuilder = credentials.getCensusBuilder()</span>
<span class="line-added"> 572                                            .addReviewer(reviewer.forge().currentUser().id())</span>
<span class="line-added"> 573                                            .addAuthor(author.forge().currentUser().id());</span>
<span class="line-added"> 574             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);</span>
<span class="line-added"> 575             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;, censusBuilder.build(), &quot;master&quot;,</span>
<span class="line-added"> 576                                                  listAddress, Set.of(), Set.of(),</span>
<span class="line-added"> 577                                                  listServer.getArchive(),</span>
<span class="line-added"> 578                                                  listServer.getSMTP(),</span>
<span class="line-added"> 579                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),</span>
<span class="line-added"> 580                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),</span>
<span class="line-added"> 581                                                  Set.of(), Map.of(),</span>
<span class="line-added"> 582                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),</span>
<span class="line-added"> 583                                                  Map.of(), Duration.ZERO);</span>
<span class="line-added"> 584 </span>
<span class="line-added"> 585             // Populate the projects repository</span>
<span class="line-added"> 586             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);</span>
<span class="line-added"> 587             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);</span>
<span class="line-added"> 588             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="line-added"> 589             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
<span class="line-added"> 590             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);</span>
<span class="line-added"> 591 </span>
<span class="line-added"> 592             // Make a change with a corresponding PR</span>
<span class="line-added"> 593             var editHash = CheckableRepository.appendAndCommit(localRepo);</span>
<span class="line-added"> 594             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);</span>
<span class="line-added"> 595             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);</span>
<span class="line-added"> 596             pr.setBody(&quot;This is now ready&quot;);</span>
<span class="line-added"> 597             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added"> 598             listServer.processIncoming();</span>
<span class="line-added"> 599 </span>
<span class="line-added"> 600             // Make two file specific comments</span>
<span class="line-added"> 601             var reviewPr = reviewer.pullRequest(pr.id());</span>
<span class="line-added"> 602             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);</span>
<span class="line-added"> 603             var comment2 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);</span>
<span class="line-added"> 604             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added"> 605             listServer.processIncoming();</span>
<span class="line-added"> 606 </span>
<span class="line-added"> 607             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);</span>
<span class="line-added"> 608             pr.addReviewCommentReply(comment2, &quot;I don&#39;t agree&quot;);</span>
<span class="line-added"> 609             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added"> 610             listServer.processIncoming();</span>
<span class="line-added"> 611 </span>
<span class="line-added"> 612             // Sanity check the archive</span>
<span class="line-added"> 613             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
<span class="line-added"> 614             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));</span>
<span class="line-added"> 615         }</span>
<span class="line-added"> 616     }</span>
<span class="line-added"> 617 </span>
 618     @Test
 619     void reviewContext(TestInfo testInfo) throws IOException {
 620         try (var credentials = new HostCredentials(testInfo);
 621              var tempFolder = new TemporaryDirectory();
 622              var archiveFolder = new TemporaryDirectory();
 623              var listServer = new TestMailmanServer()) {
 624             var author = credentials.getHostedRepository();
 625             var archive = credentials.getHostedRepository();
 626             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 627             var censusBuilder = credentials.getCensusBuilder()
 628                                            .addAuthor(author.forge().currentUser().id());
 629             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 630             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,
 631                                                  censusBuilder.build(), &quot;master&quot;,
 632                                                  listAddress, Set.of(), Set.of(),
 633                                                  listServer.getArchive(),
 634                                                  listServer.getSMTP(),
 635                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 636                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 637                                                  Set.of(), Map.of(),
</pre>
<hr />
<pre>
 841             localRepo.push(nextHash, author.url(), &quot;edit&quot;);
 842 
 843             // Make sure that the push registered
 844             var lastHeadHash = pr.headHash();
 845             var refreshCount = 0;
 846             do {
 847                 pr = author.pullRequest(pr.id());
 848                 if (refreshCount++ &gt; 100) {
 849                     fail(&quot;The PR did not update after the new push&quot;);
 850                 }
 851             } while (pr.headHash().equals(lastHeadHash));
 852 
 853             // Run another archive pass
 854             TestBotRunner.runPeriodicItems(mlBot);
 855             TestBotRunner.runPeriodicItems(mlBot);
 856             TestBotRunner.runPeriodicItems(mlBot);
 857             listServer.processIncoming();
 858 
 859             // The archive should reference the updated push
 860             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
<span class="line-modified"> 861             assertTrue(archiveContains(archiveFolder.path(), &quot;1 additional commit&quot;));</span>
 862             assertTrue(archiveContains(archiveFolder.path(), &quot;full.*/&quot; + pr.id() + &quot;/webrev.01&quot;));
 863             assertTrue(archiveContains(archiveFolder.path(), &quot;inc.*/&quot; + pr.id() + &quot;/webrev.00-01&quot;));
 864             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
 865             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
 866             assertTrue(archiveContains(archiveFolder.path(), &quot;Fixing&quot;));
 867 
 868             // The webrev comment should be updated
 869             var comments = pr.comments();
 870             var webrevComments = comments.stream()
 871                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
 872                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 873                                          .filter(comment -&gt; comment.body().contains(nextHash.hex()))
 874                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 875                                          .collect(Collectors.toList());
 876             assertEquals(1, webrevComments.size());
 877 
 878             // Check that sender address is set properly
 879             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 880             var mailmanList = mailmanServer.getList(listAddress.address());
 881             var conversations = mailmanList.conversations(Duration.ofDays(1));
</pre>
<hr />
<pre>
 962             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.url(), &quot;master&quot;);
 963             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
 964             newLocalRepo.push(newEditHash, author.url(), &quot;edit&quot;, true);
 965 
 966             // Make sure that the push registered
 967             var lastHeadHash = pr.headHash();
 968             var refreshCount = 0;
 969             do {
 970                 pr = author.pullRequest(pr.id());
 971                 if (refreshCount++ &gt; 100) {
 972                     fail(&quot;The PR did not update after the new push&quot;);
 973                 }
 974             } while (pr.headHash().equals(lastHeadHash));
 975 
 976             // Run another archive pass
 977             TestBotRunner.runPeriodicItems(mlBot);
 978             listServer.processIncoming();
 979 
 980             // The archive should reference the rebased push
 981             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
<span class="line-modified"> 982             assertTrue(archiveContains(archiveFolder.path(), &quot;updated with a new target base&quot;));</span>
 983             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.01&quot;));
 984             assertFalse(archiveContains(archiveFolder.path(), &quot;Incremental&quot;));
 985             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
 986             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
 987             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
 988             assertTrue(archiveContains(archiveFolder.path(), &quot;Replaced msg&quot;));
 989 
 990             // The webrev comment should be updated
 991             var comments = pr.comments();
 992             var webrevComments = comments.stream()
 993                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
 994                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 995                                          .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
 996                                          .collect(Collectors.toList());
 997             assertEquals(1, webrevComments.size());
 998 
 999             // Check that sender address is set properly
1000             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1001             var mailmanList = mailmanServer.getList(listAddress.address());
1002             var conversations = mailmanList.conversations(Duration.ofDays(1));
</pre>
<hr />
<pre>
1136             // The archive should contain a note
1137             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1138             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
1139             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot; by integrationreviewer1&quot;));
1140             if (author.forge().supportsReviewBody()) {
1141                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
1142             }
1143 
1144             // Then approve it
1145             reviewedPr.addReview(Review.Verdict.APPROVED, &quot;Reason 2&quot;);
1146             TestBotRunner.runPeriodicItems(mlBot);
1147             TestBotRunner.runPeriodicItems(mlBot);
1148             TestBotRunner.runPeriodicItems(mlBot);
1149 
1150             // The archive should contain another note
1151             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1152             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Approved by &quot;));
1153             if (author.forge().supportsReviewBody()) {
1154                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 2&quot;));
1155             }
<span class="line-modified">1156             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Re: RFR:&quot;));</span>
1157 
1158             // Yet another change
1159             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 3&quot;);
1160             TestBotRunner.runPeriodicItems(mlBot);
1161             TestBotRunner.runPeriodicItems(mlBot);
1162             TestBotRunner.runPeriodicItems(mlBot);
1163 
1164             // The archive should contain another note
1165             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1166             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Changes requested by &quot;));
1167             if (author.forge().supportsReviewBody()) {
1168                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
1169             }
1170         }
1171     }
1172 
1173     @Test
1174     void ignoreComments(TestInfo testInfo) throws IOException {
1175         try (var credentials = new HostCredentials(testInfo);
1176              var tempFolder = new TemporaryDirectory();
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/mlbridge/WebrevStorage.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="WebrevStorageTests.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>