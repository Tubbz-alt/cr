<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff vcs/src/main/java/org/openjdk/skara/vcs/git/GitRepository.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>vcs/src/main/java/org/openjdk/skara/vcs/git/GitRepository.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 23 package org.openjdk.skara.vcs.git;
 24 
 25 import org.openjdk.skara.process.*;
 26 import org.openjdk.skara.process.Process;
 27 import org.openjdk.skara.vcs.*;
 28 import org.openjdk.skara.vcs.tools.*;
 29 
 30 import java.io.*;
 31 import java.net.URI;
 32 import java.nio.file.*;
 33 import java.nio.charset.StandardCharsets;
 34 import java.time.*;
 35 import java.time.format.DateTimeFormatter;
 36 import java.util.*;
 37 import java.util.logging.Logger;
 38 import java.util.stream.Collectors;
 39 
 40 public class GitRepository implements Repository {
 41     private final Path dir;
 42     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.vcs.git&quot;);

 43 
 44     private java.lang.Process start(String... cmd) throws IOException {
 45         return start(Arrays.asList(cmd));
 46     }
 47 
 48     private java.lang.Process start(List&lt;String&gt; cmd) throws IOException {
 49         log.fine(&quot;Executing &quot; + String.join(&quot; &quot;, cmd));
 50         var pb = new ProcessBuilder(cmd);
 51         pb.directory(dir.toFile());
 52         pb.redirectError(ProcessBuilder.Redirect.DISCARD);
 53         return pb.start();
 54     }
 55 
 56     private static void stop(java.lang.Process p) throws IOException {
 57         if (p != null &amp;&amp; p.isAlive()) {
 58             var stream = p.getInputStream();
 59             var read = 0;
 60             var buf = new byte[128];
 61             while (read != -1) {
 62                 read = stream.read(buf);
</pre>
<hr />
<pre>
258             return true;
259         }
260 
261         var name = &quot;health-check&quot;;
262         try (var p = capture(&quot;git&quot;, &quot;branch&quot;, name, &quot;HEAD&quot;)) {
263             if (p.await().status() != 0) {
264                 return false;
265             }
266         }
267         try (var p = capture(&quot;git&quot;, &quot;branch&quot;, &quot;-D&quot;, name)) {
268             if (p.await().status() != 0) {
269                 return false;
270             }
271         }
272 
273         return true;
274     }
275 
276     @Override
277     public void clean() throws IOException {


278         try (var p = capture(&quot;git&quot;, &quot;clean&quot;, &quot;-x&quot;, &quot;-d&quot;, &quot;--force&quot;, &quot;--force&quot;)) {
279             await(p);
280         }
281 
282         try (var p = capture(&quot;git&quot;, &quot;reset&quot;, &quot;--hard&quot;)) {
283             await(p);
284         }
285 
286         try (var p = capture(&quot;git&quot;, &quot;rebase&quot;, &quot;--quit&quot;)) {
287             p.await(); // Don&#39;t care about the result.
288         }
289     }
290 
291     @Override
292     public Repository reinitialize() throws IOException {


293         Files.walk(dir)
294              .map(Path::toFile)
295              .sorted(Comparator.reverseOrder())
296              .forEach(File::delete);
297 
298         return init();
299     }
300 
301     @Override
302     public Hash fetch(URI uri, String refspec) throws IOException {
303         try (var p = capture(&quot;git&quot;, &quot;fetch&quot;, &quot;--tags&quot;, uri.toString(), refspec)) {
304             await(p);
305             return resolve(&quot;FETCH_HEAD&quot;).get();
306         }
307     }
308 
309     @Override
310     public void fetchAll() throws IOException {
311         try (var p = capture(&quot;git&quot;, &quot;fetch&quot;, &quot;--tags&quot;, &quot;--prune&quot;, &quot;--prune-tags&quot;, &quot;--all&quot;)) {
312             await(p);
</pre>
<hr />
<pre>
320             cmd.add(&quot;--force&quot;);
321         }
322         cmd.add(ref);
323         try (var p = capture(cmd)) {
324             await(p);
325         }
326     }
327 
328     @Override
329     public void checkout(Hash h, boolean force) throws IOException {
330         checkout(h.hex(), force);
331     }
332 
333     @Override
334     public void checkout(Branch b, boolean force) throws IOException {
335         checkout(b.name(), force);
336     }
337 
338     @Override
339     public Repository init() throws IOException {


340         if (!Files.exists(dir)) {
341             Files.createDirectories(dir);
342         }
343 
344         try (var p = capture(&quot;git&quot;, &quot;init&quot;)) {
345             await(p);
346             return this;
347         }
348     }
349 
350     @Override
351     public void pushAll(URI uri) throws IOException {
352         try (var p = capture(&quot;git&quot;, &quot;push&quot;, &quot;--mirror&quot;, uri.toString())) {
353             await(p);
354         }
355     }
356 
357     @Override
358     public void push(Hash hash, URI uri, String ref, boolean force) throws IOException {
359         String refspec = force ? &quot;+&quot; : &quot;&quot;;
</pre>
<hr />
<pre>
384     public boolean isClean() throws IOException {
385         try (var p = capture(&quot;git&quot;, &quot;status&quot;, &quot;--porcelain&quot;)) {
386             var output = await(p);
387             return output.stdout().size() == 0;
388         }
389     }
390 
391     @Override
392     public boolean exists() throws IOException {
393         if (!Files.exists(dir)) {
394             return false;
395         }
396 
397         try (var p = capture(&quot;git&quot;, &quot;rev-parse&quot;, &quot;--git-dir&quot;)) {
398             return p.await().status() == 0;
399         }
400     }
401 
402     @Override
403     public Path root() throws IOException {




404         try (var p = capture(&quot;git&quot;, &quot;rev-parse&quot;, &quot;--show-toplevel&quot;)) {
405             var res = await(p);
406             if (res.stdout().size() != 1) {
407                 // Perhaps this is a bare repository
408                 try (var p2 = capture(&quot;git&quot;, &quot;rev-parse&quot;, &quot;--git-dir&quot;)) {
409                     var res2 = await(p2);
410                     if (res2.stdout().size() != 1) {
411                         throw new IOException(&quot;Unexpected output\n&quot; + res2);
412                     }
<span class="line-modified">413                     return dir.resolve(Path.of(res2.stdout().get(0)));</span>

414                 }
415             }
<span class="line-modified">416             return Path.of(res.stdout().get(0));</span>


417         }
418     }
419 
420     @Override
421     public void squash(Hash h) throws IOException {
422         try (var p = capture(&quot;git&quot;, &quot;merge&quot;, &quot;--squash&quot;, h.hex())) {
423             await(p);
424         }
425     }
426 
427     @Override
428     public void add(List&lt;Path&gt; paths) throws IOException {
429         var cmd = new ArrayList&lt;&gt;(List.of(&quot;git&quot;, &quot;add&quot;));
430         for (var path : paths) {
431             cmd.add(path.toString());
432         }
433         try (var p = capture(cmd)) {
434             await(p);
435         }
436     }
</pre>
</td>
<td>
<hr />
<pre>
 23 package org.openjdk.skara.vcs.git;
 24 
 25 import org.openjdk.skara.process.*;
 26 import org.openjdk.skara.process.Process;
 27 import org.openjdk.skara.vcs.*;
 28 import org.openjdk.skara.vcs.tools.*;
 29 
 30 import java.io.*;
 31 import java.net.URI;
 32 import java.nio.file.*;
 33 import java.nio.charset.StandardCharsets;
 34 import java.time.*;
 35 import java.time.format.DateTimeFormatter;
 36 import java.util.*;
 37 import java.util.logging.Logger;
 38 import java.util.stream.Collectors;
 39 
 40 public class GitRepository implements Repository {
 41     private final Path dir;
 42     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.vcs.git&quot;);
<span class="line-added"> 43     private Path cachedRoot = null;</span>
 44 
 45     private java.lang.Process start(String... cmd) throws IOException {
 46         return start(Arrays.asList(cmd));
 47     }
 48 
 49     private java.lang.Process start(List&lt;String&gt; cmd) throws IOException {
 50         log.fine(&quot;Executing &quot; + String.join(&quot; &quot;, cmd));
 51         var pb = new ProcessBuilder(cmd);
 52         pb.directory(dir.toFile());
 53         pb.redirectError(ProcessBuilder.Redirect.DISCARD);
 54         return pb.start();
 55     }
 56 
 57     private static void stop(java.lang.Process p) throws IOException {
 58         if (p != null &amp;&amp; p.isAlive()) {
 59             var stream = p.getInputStream();
 60             var read = 0;
 61             var buf = new byte[128];
 62             while (read != -1) {
 63                 read = stream.read(buf);
</pre>
<hr />
<pre>
259             return true;
260         }
261 
262         var name = &quot;health-check&quot;;
263         try (var p = capture(&quot;git&quot;, &quot;branch&quot;, name, &quot;HEAD&quot;)) {
264             if (p.await().status() != 0) {
265                 return false;
266             }
267         }
268         try (var p = capture(&quot;git&quot;, &quot;branch&quot;, &quot;-D&quot;, name)) {
269             if (p.await().status() != 0) {
270                 return false;
271             }
272         }
273 
274         return true;
275     }
276 
277     @Override
278     public void clean() throws IOException {
<span class="line-added">279         cachedRoot = null;</span>
<span class="line-added">280 </span>
281         try (var p = capture(&quot;git&quot;, &quot;clean&quot;, &quot;-x&quot;, &quot;-d&quot;, &quot;--force&quot;, &quot;--force&quot;)) {
282             await(p);
283         }
284 
285         try (var p = capture(&quot;git&quot;, &quot;reset&quot;, &quot;--hard&quot;)) {
286             await(p);
287         }
288 
289         try (var p = capture(&quot;git&quot;, &quot;rebase&quot;, &quot;--quit&quot;)) {
290             p.await(); // Don&#39;t care about the result.
291         }
292     }
293 
294     @Override
295     public Repository reinitialize() throws IOException {
<span class="line-added">296         cachedRoot = null;</span>
<span class="line-added">297 </span>
298         Files.walk(dir)
299              .map(Path::toFile)
300              .sorted(Comparator.reverseOrder())
301              .forEach(File::delete);
302 
303         return init();
304     }
305 
306     @Override
307     public Hash fetch(URI uri, String refspec) throws IOException {
308         try (var p = capture(&quot;git&quot;, &quot;fetch&quot;, &quot;--tags&quot;, uri.toString(), refspec)) {
309             await(p);
310             return resolve(&quot;FETCH_HEAD&quot;).get();
311         }
312     }
313 
314     @Override
315     public void fetchAll() throws IOException {
316         try (var p = capture(&quot;git&quot;, &quot;fetch&quot;, &quot;--tags&quot;, &quot;--prune&quot;, &quot;--prune-tags&quot;, &quot;--all&quot;)) {
317             await(p);
</pre>
<hr />
<pre>
325             cmd.add(&quot;--force&quot;);
326         }
327         cmd.add(ref);
328         try (var p = capture(cmd)) {
329             await(p);
330         }
331     }
332 
333     @Override
334     public void checkout(Hash h, boolean force) throws IOException {
335         checkout(h.hex(), force);
336     }
337 
338     @Override
339     public void checkout(Branch b, boolean force) throws IOException {
340         checkout(b.name(), force);
341     }
342 
343     @Override
344     public Repository init() throws IOException {
<span class="line-added">345         cachedRoot = null;</span>
<span class="line-added">346 </span>
347         if (!Files.exists(dir)) {
348             Files.createDirectories(dir);
349         }
350 
351         try (var p = capture(&quot;git&quot;, &quot;init&quot;)) {
352             await(p);
353             return this;
354         }
355     }
356 
357     @Override
358     public void pushAll(URI uri) throws IOException {
359         try (var p = capture(&quot;git&quot;, &quot;push&quot;, &quot;--mirror&quot;, uri.toString())) {
360             await(p);
361         }
362     }
363 
364     @Override
365     public void push(Hash hash, URI uri, String ref, boolean force) throws IOException {
366         String refspec = force ? &quot;+&quot; : &quot;&quot;;
</pre>
<hr />
<pre>
391     public boolean isClean() throws IOException {
392         try (var p = capture(&quot;git&quot;, &quot;status&quot;, &quot;--porcelain&quot;)) {
393             var output = await(p);
394             return output.stdout().size() == 0;
395         }
396     }
397 
398     @Override
399     public boolean exists() throws IOException {
400         if (!Files.exists(dir)) {
401             return false;
402         }
403 
404         try (var p = capture(&quot;git&quot;, &quot;rev-parse&quot;, &quot;--git-dir&quot;)) {
405             return p.await().status() == 0;
406         }
407     }
408 
409     @Override
410     public Path root() throws IOException {
<span class="line-added">411         if (cachedRoot != null) {</span>
<span class="line-added">412             return cachedRoot;</span>
<span class="line-added">413         }</span>
<span class="line-added">414 </span>
415         try (var p = capture(&quot;git&quot;, &quot;rev-parse&quot;, &quot;--show-toplevel&quot;)) {
416             var res = await(p);
417             if (res.stdout().size() != 1) {
418                 // Perhaps this is a bare repository
419                 try (var p2 = capture(&quot;git&quot;, &quot;rev-parse&quot;, &quot;--git-dir&quot;)) {
420                     var res2 = await(p2);
421                     if (res2.stdout().size() != 1) {
422                         throw new IOException(&quot;Unexpected output\n&quot; + res2);
423                     }
<span class="line-modified">424                     cachedRoot = dir.resolve(Path.of(res2.stdout().get(0)));</span>
<span class="line-added">425                     return cachedRoot;</span>
426                 }
427             }
<span class="line-modified">428 </span>
<span class="line-added">429             cachedRoot = Path.of(res.stdout().get(0));</span>
<span class="line-added">430             return cachedRoot;</span>
431         }
432     }
433 
434     @Override
435     public void squash(Hash h) throws IOException {
436         try (var p = capture(&quot;git&quot;, &quot;merge&quot;, &quot;--squash&quot;, h.hex())) {
437             await(p);
438         }
439     }
440 
441     @Override
442     public void add(List&lt;Path&gt; paths) throws IOException {
443         var cmd = new ArrayList&lt;&gt;(List.of(&quot;git&quot;, &quot;add&quot;));
444         for (var path : paths) {
445             cmd.add(path.toString());
446         }
447         try (var p = capture(cmd)) {
448             await(p);
449         }
450     }
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>