<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames vcs/src/main/java/org/openjdk/skara/vcs/git/GitRepository.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.vcs.git;
 24 
 25 import org.openjdk.skara.process.*;
 26 import org.openjdk.skara.process.Process;
 27 import org.openjdk.skara.vcs.*;
 28 import org.openjdk.skara.vcs.tools.*;
 29 
 30 import java.io.*;
 31 import java.net.URI;
 32 import java.nio.file.*;
 33 import java.nio.charset.StandardCharsets;
 34 import java.time.*;
 35 import java.time.format.DateTimeFormatter;
 36 import java.util.*;
 37 import java.util.logging.Logger;
 38 import java.util.stream.Collectors;
 39 
 40 public class GitRepository implements Repository {
 41     private final Path dir;
 42     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.vcs.git&quot;);
<a name="1" id="anc1"></a>
 43 
 44     private java.lang.Process start(String... cmd) throws IOException {
 45         return start(Arrays.asList(cmd));
 46     }
 47 
 48     private java.lang.Process start(List&lt;String&gt; cmd) throws IOException {
 49         log.fine(&quot;Executing &quot; + String.join(&quot; &quot;, cmd));
 50         var pb = new ProcessBuilder(cmd);
 51         pb.directory(dir.toFile());
 52         pb.redirectError(ProcessBuilder.Redirect.DISCARD);
 53         return pb.start();
 54     }
 55 
 56     private static void stop(java.lang.Process p) throws IOException {
 57         if (p != null &amp;&amp; p.isAlive()) {
 58             var stream = p.getInputStream();
 59             var read = 0;
 60             var buf = new byte[128];
 61             while (read != -1) {
 62                 read = stream.read(buf);
 63             }
 64             try {
 65                 p.waitFor();
 66             } catch (InterruptedException e) {
 67                 throw new IOException(e);
 68             }
 69         }
 70     }
 71 
 72     private Execution capture(List&lt;String&gt; cmd) {
 73         return capture(cmd.toArray(new String[0]));
 74     }
 75 
 76     private Execution capture(String... cmd) {
 77         return capture(dir, cmd);
 78     }
 79 
 80     private static Execution capture(Path cwd, String... cmd) {
 81         return Process.capture(cmd)
 82                       .workdir(cwd)
 83                       .execute();
 84     }
 85 
 86     private static Execution capture(Path cwd, List&lt;String&gt; cmd) {
 87         return capture(cwd, cmd.toArray(new String[0]));
 88     }
 89 
 90     private static Execution.Result await(Execution e) throws IOException {
 91         var result = e.await();
 92         if (result.status() != 0) {
 93             throw new IOException(&quot;Unexpected exit code\n&quot; + result);
 94         }
 95         return result;
 96     }
 97 
 98     private static void await(java.lang.Process p) throws IOException {
 99         try {
100             var res = p.waitFor();
101             if (res != 0) {
102                 throw new IOException(&quot;Unexpected exit code: &quot; + res);
103             }
104         } catch (InterruptedException e) {
105             throw new IOException(e);
106         }
107     }
108 
109     public GitRepository(Path dir) {
110         this.dir = dir.toAbsolutePath();
111     }
112 
113     public List&lt;Branch&gt; branches() throws IOException {
114         try (var p = capture(&quot;git&quot;, &quot;for-each-ref&quot;, &quot;--format=%(refname:short)&quot;, &quot;refs/heads&quot;)) {
115             return await(p).stdout()
116                            .stream()
117                            .map(Branch::new)
118                            .collect(Collectors.toList());
119         }
120     }
121 
122     public List&lt;Tag&gt; tags() throws IOException {
123         try (var p = capture(&quot;git&quot;, &quot;for-each-ref&quot;, &quot;--format=%(refname:short)&quot;, &quot;refs/tags&quot;)) {
124             return await(p).stdout()
125                            .stream()
126                            .map(Tag::new)
127                            .collect(Collectors.toList());
128         }
129     }
130 
131     @Override
132     public Commits commits() throws IOException {
133         return new GitCommits(dir, &quot;--all&quot;, false, -1);
134     }
135 
136     @Override
137     public Commits commits(int n) throws IOException {
138         return new GitCommits(dir, &quot;--all&quot;, false, n);
139     }
140 
141     @Override
142     public Commits commits(boolean reverse) throws IOException {
143         return new GitCommits(dir, &quot;--all&quot;, reverse, -1);
144     }
145 
146     @Override
147     public Commits commits(int n, boolean reverse) throws IOException {
148         return new GitCommits(dir, &quot;--all&quot;, reverse, n);
149     }
150 
151     @Override
152     public Commits commits(String range) throws IOException {
153         return new GitCommits(dir, range, false, -1);
154     }
155 
156     @Override
157     public Commits commits(String range, int n) throws IOException {
158         return new GitCommits(dir, range, false, n);
159     }
160 
161     @Override
162     public Commits commits(String range, boolean reverse) throws IOException {
163         return new GitCommits(dir, range, reverse, -1);
164     }
165 
166     @Override
167     public Commits commits(String range, int n, boolean reverse) throws IOException {
168         return new GitCommits(dir, range, reverse, n);
169     }
170 
171     @Override
172     public Optional&lt;Commit&gt; lookup(Hash h) throws IOException {
173         var commits = commits(h.hex(), 1).asList();
174         if (commits.size() != 1) {
175             return Optional.empty();
176         }
177         return Optional.of(commits.get(0));
178     }
179 
180     @Override
181     public Optional&lt;Commit&gt; lookup(Branch b) throws IOException {
182         var hash = resolve(b.name()).orElseThrow(() -&gt; new IOException(&quot;Branch &quot; + b.name() + &quot; not found&quot;));
183         return lookup(hash);
184     }
185 
186     @Override
187     public Optional&lt;Commit&gt; lookup(Tag t) throws IOException {
188         var hash = resolve(t.name()).orElseThrow(() -&gt; new IOException(&quot;Tag &quot; + t.name() + &quot; not found&quot;));
189         return lookup(hash);
190     }
191 
192     public List&lt;CommitMetadata&gt; commitMetadata() throws IOException {
193         var revisions = &quot;--all&quot;;
194         var p = start(&quot;git&quot;, &quot;rev-list&quot;, &quot;--format=&quot; + GitCommitMetadata.FORMAT, &quot;--no-abbrev&quot;, &quot;--reverse&quot;, &quot;--no-color&quot;, revisions);
195         var reader = new UnixStreamReader(p.getInputStream());
196         var result = new ArrayList&lt;CommitMetadata&gt;();
197 
198         var line = reader.readLine();
199         while (line != null) {
200             if (!line.startsWith(&quot;commit&quot;)) {
201                 throw new IOException(&quot;Unexpected line: &quot; + line);
202             }
203 
204             result.add(GitCommitMetadata.read(reader));
205             line = reader.readLine();
206         }
207 
208         await(p);
209         return result;
210     }
211 
212     @Override
213     public boolean isEmpty() throws IOException {
214         int numLooseObjects = -1;
215         int numPackedObjects = -1;
216         int numRefs = -1;
217 
218         try (var p = capture(&quot;git&quot;, &quot;count-objects&quot;, &quot;-v&quot;)) {
219             var res = await(p);
220             var stdout = res.stdout();
221 
222             for (var line : stdout) {
223                 if (line.startsWith(&quot;count: &quot;)) {
224                     try {
225                         numLooseObjects = Integer.parseUnsignedInt(line.split(&quot; &quot;)[1]);
226                     } catch (NumberFormatException e) {
227                         throw new IOException(&quot;Unexpected &#39;count&#39; value\n&quot; + res, e);
228                     }
229 
230                 } else if (line.startsWith(&quot;in-pack: &quot;)) {
231                     try {
232                         numPackedObjects = Integer.parseUnsignedInt(line.split(&quot; &quot;)[1]);
233                     } catch (NumberFormatException e) {
234                         throw new IOException(&quot;Unexpected &#39;in-pack&#39; value\n&quot; + res, e);
235                     }
236                 }
237             }
238         }
239 
240         try (var p = capture(&quot;git&quot;, &quot;show-ref&quot;, &quot;--hash&quot;, &quot;--abbrev&quot;)) {
241             var res = p.await();
242             if (res.status() == -1) {
243                 if (res.stdout().size() != 0) {
244                     throw new IOException(&quot;Unexpected output\n&quot; + res);
245                 }
246                 numRefs = 0;
247             } else {
248                 numRefs = res.stdout().size();
249             }
250         }
251 
252         return numLooseObjects == 0 &amp;&amp; numPackedObjects == 0 &amp;&amp; numRefs == 0;
253     }
254 
255     @Override
256     public boolean isHealthy() throws IOException {
257         if (isEmpty()) {
258             return true;
259         }
260 
261         var name = &quot;health-check&quot;;
262         try (var p = capture(&quot;git&quot;, &quot;branch&quot;, name, &quot;HEAD&quot;)) {
263             if (p.await().status() != 0) {
264                 return false;
265             }
266         }
267         try (var p = capture(&quot;git&quot;, &quot;branch&quot;, &quot;-D&quot;, name)) {
268             if (p.await().status() != 0) {
269                 return false;
270             }
271         }
272 
273         return true;
274     }
275 
276     @Override
277     public void clean() throws IOException {
<a name="2" id="anc2"></a>

278         try (var p = capture(&quot;git&quot;, &quot;clean&quot;, &quot;-x&quot;, &quot;-d&quot;, &quot;--force&quot;, &quot;--force&quot;)) {
279             await(p);
280         }
281 
282         try (var p = capture(&quot;git&quot;, &quot;reset&quot;, &quot;--hard&quot;)) {
283             await(p);
284         }
285 
286         try (var p = capture(&quot;git&quot;, &quot;rebase&quot;, &quot;--quit&quot;)) {
287             p.await(); // Don&#39;t care about the result.
288         }
289     }
290 
291     @Override
292     public Repository reinitialize() throws IOException {
<a name="3" id="anc3"></a>

293         Files.walk(dir)
294              .map(Path::toFile)
295              .sorted(Comparator.reverseOrder())
296              .forEach(File::delete);
297 
298         return init();
299     }
300 
301     @Override
302     public Hash fetch(URI uri, String refspec) throws IOException {
303         try (var p = capture(&quot;git&quot;, &quot;fetch&quot;, &quot;--tags&quot;, uri.toString(), refspec)) {
304             await(p);
305             return resolve(&quot;FETCH_HEAD&quot;).get();
306         }
307     }
308 
309     @Override
310     public void fetchAll() throws IOException {
311         try (var p = capture(&quot;git&quot;, &quot;fetch&quot;, &quot;--tags&quot;, &quot;--prune&quot;, &quot;--prune-tags&quot;, &quot;--all&quot;)) {
312             await(p);
313         }
314     }
315 
316     private void checkout(String ref, boolean force) throws IOException {
317         var cmd = new ArrayList&lt;String&gt;();
318         cmd.addAll(List.of(&quot;git&quot;, &quot;-c&quot;, &quot;advice.detachedHead=false&quot;, &quot;checkout&quot;));
319         if (force) {
320             cmd.add(&quot;--force&quot;);
321         }
322         cmd.add(ref);
323         try (var p = capture(cmd)) {
324             await(p);
325         }
326     }
327 
328     @Override
329     public void checkout(Hash h, boolean force) throws IOException {
330         checkout(h.hex(), force);
331     }
332 
333     @Override
334     public void checkout(Branch b, boolean force) throws IOException {
335         checkout(b.name(), force);
336     }
337 
338     @Override
339     public Repository init() throws IOException {
<a name="4" id="anc4"></a>

340         if (!Files.exists(dir)) {
341             Files.createDirectories(dir);
342         }
343 
344         try (var p = capture(&quot;git&quot;, &quot;init&quot;)) {
345             await(p);
346             return this;
347         }
348     }
349 
350     @Override
351     public void pushAll(URI uri) throws IOException {
352         try (var p = capture(&quot;git&quot;, &quot;push&quot;, &quot;--mirror&quot;, uri.toString())) {
353             await(p);
354         }
355     }
356 
357     @Override
358     public void push(Hash hash, URI uri, String ref, boolean force) throws IOException {
359         String refspec = force ? &quot;+&quot; : &quot;&quot;;
360         if (!ref.startsWith(&quot;refs/&quot;)) {
361             ref = &quot;refs/heads/&quot; + ref;
362         }
363         refspec += hash.hex() + &quot;:&quot; + ref;
364 
365         try (var p = capture(&quot;git&quot;, &quot;push&quot;, uri.toString(), refspec)) {
366             await(p);
367         }
368     }
369 
370     @Override
371     public void push(Branch branch, String remote, boolean setUpstream) throws IOException {
372         var cmd = new ArrayList&lt;String&gt;();
373         cmd.addAll(List.of(&quot;git&quot;, &quot;push&quot;, remote, branch.name()));
374         if (setUpstream) {
375             cmd.add(&quot;--set-upstream&quot;);
376         }
377 
378         try (var p = capture(cmd)) {
379             await(p);
380         }
381     }
382 
383     @Override
384     public boolean isClean() throws IOException {
385         try (var p = capture(&quot;git&quot;, &quot;status&quot;, &quot;--porcelain&quot;)) {
386             var output = await(p);
387             return output.stdout().size() == 0;
388         }
389     }
390 
391     @Override
392     public boolean exists() throws IOException {
393         if (!Files.exists(dir)) {
394             return false;
395         }
396 
397         try (var p = capture(&quot;git&quot;, &quot;rev-parse&quot;, &quot;--git-dir&quot;)) {
398             return p.await().status() == 0;
399         }
400     }
401 
402     @Override
403     public Path root() throws IOException {
<a name="5" id="anc5"></a>



404         try (var p = capture(&quot;git&quot;, &quot;rev-parse&quot;, &quot;--show-toplevel&quot;)) {
405             var res = await(p);
406             if (res.stdout().size() != 1) {
407                 // Perhaps this is a bare repository
408                 try (var p2 = capture(&quot;git&quot;, &quot;rev-parse&quot;, &quot;--git-dir&quot;)) {
409                     var res2 = await(p2);
410                     if (res2.stdout().size() != 1) {
411                         throw new IOException(&quot;Unexpected output\n&quot; + res2);
412                     }
<a name="6" id="anc6"></a><span class="line-modified">413                     return dir.resolve(Path.of(res2.stdout().get(0)));</span>

414                 }
415             }
<a name="7" id="anc7"></a><span class="line-modified">416             return Path.of(res.stdout().get(0));</span>


417         }
418     }
419 
420     @Override
421     public void squash(Hash h) throws IOException {
422         try (var p = capture(&quot;git&quot;, &quot;merge&quot;, &quot;--squash&quot;, h.hex())) {
423             await(p);
424         }
425     }
426 
427     @Override
428     public void add(List&lt;Path&gt; paths) throws IOException {
429         var cmd = new ArrayList&lt;&gt;(List.of(&quot;git&quot;, &quot;add&quot;));
430         for (var path : paths) {
431             cmd.add(path.toString());
432         }
433         try (var p = capture(cmd)) {
434             await(p);
435         }
436     }
437 
438     @Override
439     public void remove(List&lt;Path&gt; paths) throws IOException {
440         var cmd = new ArrayList&lt;&gt;(List.of(&quot;git&quot;, &quot;rm&quot;));
441         for (var path : paths) {
442             cmd.add(path.toString());
443         }
444         try (var p = capture(cmd)) {
445             await(p);
446         }
447     }
448 
449     @Override
450     public void delete(Branch b) throws IOException {
451         try (var p = capture(&quot;git&quot;, &quot;branch&quot;, &quot;-D&quot;, b.name())) {
452             await(p);
453         }
454     }
455 
456     @Override
457     public void addremove() throws IOException {
458         try (var p = capture(&quot;git&quot;, &quot;add&quot;, &quot;--all&quot;)) {
459             await(p);
460         }
461     }
462 
463     @Override
464     public Hash commit(String message, String authorName, String authorEmail)  throws IOException {
465         return commit(message, authorName, authorEmail, null);
466     }
467 
468     @Override
469     public Hash commit(String message, String authorName, String authorEmail, ZonedDateTime authorDate)  throws IOException {
470         return commit(message, authorName, authorEmail, authorDate, authorName, authorEmail, authorDate);
471     }
472 
473     @Override
474     public Hash commit(String message,
475                        String authorName,
476                        String authorEmail,
477                        String committerName,
478                        String committerEmail) throws IOException {
479         return commit(message, authorName, authorEmail, null, committerName, committerEmail, null);
480     }
481 
482     @Override
483     public Hash commit(String message,
484                        String authorName,
485                        String authorEmail,
486                        ZonedDateTime authorDate,
487                        String committerName,
488                        String committerEmail,
489                        ZonedDateTime committerDate) throws IOException {
490         var cmd = Process.capture(&quot;git&quot;, &quot;commit&quot;, &quot;--message=&quot; + message)
491                          .workdir(dir)
492                          .environ(&quot;GIT_AUTHOR_NAME&quot;, authorName)
493                          .environ(&quot;GIT_AUTHOR_EMAIL&quot;, authorEmail)
494                          .environ(&quot;GIT_COMMITTER_NAME&quot;, committerName)
495                          .environ(&quot;GIT_COMMITTER_EMAIL&quot;, committerEmail);
496         if (authorDate != null) {
497             cmd = cmd.environ(&quot;GIT_AUTHOR_DATE&quot;,
498                               authorDate.format(DateTimeFormatter.ISO_OFFSET_DATE_TIME));
499         }
500         if (committerDate != null) {
501             cmd = cmd.environ(&quot;GIT_COMMITTER_DATE&quot;,
502                               committerDate.format(DateTimeFormatter.ISO_OFFSET_DATE_TIME));
503         }
504         try (var p = cmd.execute()) {
505             await(p);
506             return head();
507         }
508     }
509 
510     @Override
511     public Hash amend(String message, String authorName, String authorEmail) throws IOException {
512         return amend(message, authorName, authorEmail, null, null);
513     }
514 
515     @Override
516     public Hash amend(String message, String authorName, String authorEmail, String committerName, String committerEmail) throws IOException {
517         if (committerName == null) {
518             committerName = authorName;
519             committerEmail = authorEmail;
520         }
521         var cmd = Process.capture(&quot;git&quot;, &quot;commit&quot;, &quot;--amend&quot;, &quot;--reset-author&quot;, &quot;--message=&quot; + message)
522                          .workdir(dir)
523                          .environ(&quot;GIT_AUTHOR_NAME&quot;, authorName)
524                          .environ(&quot;GIT_AUTHOR_EMAIL&quot;, authorEmail)
525                          .environ(&quot;GIT_COMMITTER_NAME&quot;, committerName)
526                          .environ(&quot;GIT_COMMITTER_EMAIL&quot;, committerEmail);
527         try (var p = cmd.execute()) {
528             await(p);
529             return head();
530         }
531     }
532 
533     @Override
534     public Tag tag(Hash hash, String name, String message, String authorName, String authorEmail) throws IOException {
535         var cmd = Process.capture(&quot;git&quot;, &quot;tag&quot;, &quot;--annotate&quot;, &quot;--message=&quot; + message, name, hash.hex())
536                          .workdir(dir)
537                          .environ(&quot;GIT_AUTHOR_NAME&quot;, authorName)
538                          .environ(&quot;GIT_AUTHOR_EMAIL&quot;, authorEmail)
539                          .environ(&quot;GIT_COMMITTER_NAME&quot;, authorName)
540                          .environ(&quot;GIT_COMMITTER_EMAIL&quot;, authorEmail);
541         try (var p = cmd.execute()) {
542             await(p);
543         }
544 
545         return new Tag(name);
546     }
547 
548     @Override
549     public Branch branch(Hash hash, String name) throws IOException {
550         try (var p = capture(&quot;git&quot;, &quot;branch&quot;, name, hash.hex())) {
551             await(p);
552         }
553 
554         return new Branch(name);
555     }
556 
557     @Override
558     public Hash mergeBase(Hash first, Hash second) throws IOException {
559         try (var p = capture(&quot;git&quot;, &quot;merge-base&quot;, first.hex(), second.hex())) {
560             var res = await(p);
561             if (res.stdout().size() != 1) {
562                  throw new IOException(&quot;Unexpected output\n&quot; + res);
563             }
564             return new Hash(res.stdout().get(0));
565         }
566     }
567 
568     @Override
569     public boolean isAncestor(Hash ancestor, Hash descendant) throws IOException {
570         try (var p = capture(&quot;git&quot;, &quot;merge-base&quot;, &quot;--is-ancestor&quot;, ancestor.hex(), descendant.hex())) {
571             var res = p.await();
572             return res.status() == 0;
573         }
574     }
575 
576     @Override
577     public void rebase(Hash hash, String committerName, String committerEmail) throws IOException {
578         try (var p = Process.capture(&quot;git&quot;, &quot;rebase&quot;, &quot;--onto&quot;, hash.hex(), &quot;--root&quot;, &quot;--rebase-merges&quot;)
579                             .environ(&quot;GIT_COMMITTER_NAME&quot;, committerName)
580                             .environ(&quot;GIT_COMMITTER_EMAIL&quot;, committerEmail)
581                             .workdir(dir)
582                             .execute()) {
583             await(p);
584         }
585     }
586 
587     @Override
588     public Optional&lt;Hash&gt; resolve(String ref) throws IOException {
589         try (var p = capture(&quot;git&quot;, &quot;rev-parse&quot;, ref + &quot;^{commit}&quot;)) {
590             var res = p.await();
591             if (res.status() == 0 &amp;&amp; res.stdout().size() == 1) {
592                 return Optional.of(new Hash(res.stdout().get(0)));
593             }
594             return Optional.empty();
595         }
596     }
597 
598     @Override
599     public Branch currentBranch() throws IOException {
600         try (var p = capture(&quot;git&quot;, &quot;symbolic-ref&quot;, &quot;--short&quot;, &quot;HEAD&quot;)) {
601             var res = await(p);
602             if (res.stdout().size() != 1) {
603                 throw new IOException(&quot;Unexpected output\n&quot; + res);
604             }
605             return new Branch(res.stdout().get(0));
606         }
607     }
608 
609     @Override
610     public Branch defaultBranch() throws IOException {
611         try (var p = capture(&quot;git&quot;, &quot;symbolic-ref&quot;, &quot;--short&quot;, &quot;refs/remotes/origin/HEAD&quot;)) {
612             var res = p.await();
613             if (res.status() == 0 &amp;&amp; res.stdout().size() == 1) {
614                 var ref = res.stdout().get(0).substring(&quot;origin/&quot;.length());
615                 return new Branch(ref);
616             } else {
617                 return new Branch(&quot;master&quot;);
618             }
619         }
620     }
621 
622     @Override
623     public Optional&lt;Tag&gt; defaultTag() throws IOException {
624         return Optional.empty();
625     }
626 
627     @Override
628     public Optional&lt;String&gt; username() throws IOException {
629         var lines = config(&quot;user.name&quot;);
630         return lines.size() == 1 ? Optional.of(lines.get(0)) : Optional.empty();
631     }
632 
633     private String treeEntry(Path path, Hash hash) throws IOException {
634         try (var p = Process.capture(&quot;git&quot;, &quot;ls-tree&quot;, hash.hex(), path.toString())
635                             .workdir(root())
636                             .execute()) {
637             var res = await(p);
638             if (res.stdout().size() == 0) {
639                 return null;
640             }
641             if (res.stdout().size() &gt; 1) {
642                 throw new IOException(&quot;Unexpected output\n&quot; + res);
643             }
644             return res.stdout().get(0);
645         }
646     }
647 
648     @Override
649     public Optional&lt;byte[]&gt; show(Path path, Hash hash) throws IOException {
650         var entry = treeEntry(path, hash);
651         if (entry == null) {
652             return Optional.empty();
653         }
654 
655         var parts = entry.split(&quot; &quot;);
656         var mode = parts[0];
657         if (mode.equals(&quot;160000&quot;)) {
658             // submodule
659             var hashAndName = parts[2].split(&quot;\t&quot;);
660             return Optional.of((&quot;Subproject commit &quot; + hashAndName[0]).getBytes(StandardCharsets.UTF_8));
661         } else if (mode.equals(&quot;100644&quot;) || mode.equals(&quot;100755&quot;)) {
662             // blob
663             var blobAndName = parts[2].split(&quot;\t&quot;);
664             var blob = blobAndName[0];
665             try (var p = capture(&quot;git&quot;, &quot;unpack-file&quot;, blob)) {
666                 var res = await(p);
667                 if (res.stdout().size() != 1) {
668                     throw new IOException(&quot;Unexpected output\n&quot; + res);
669                 }
670 
671                 var file = Path.of(root().toString(), res.stdout().get(0));
672                 if (Files.exists(file)) {
673                     var bytes = Files.readAllBytes(file);
674                     Files.delete(file);
675                     return Optional.of(bytes);
676                 }
677             }
678         }
679         return Optional.empty();
680     }
681 
682     @Override
683     public Diff diff(Hash from) throws IOException {
684         return diff(from, null);
685     }
686 
687     @Override
688     public Diff diff(Hash from, Hash to) throws IOException {
689         var cmd = new ArrayList&lt;&gt;(List.of(&quot;git&quot;, &quot;diff&quot;, &quot;--patch&quot;,
690                                                          &quot;--find-renames=99%&quot;,
691                                                          &quot;--find-copies=99%&quot;,
692                                                          &quot;--find-copies-harder&quot;,
693                                                          &quot;--binary&quot;,
694                                                          &quot;--raw&quot;,
695                                                          &quot;--no-abbrev&quot;,
696                                                          &quot;--unified=0&quot;,
697                                                          &quot;--no-color&quot;,
698                                                          from.hex()));
699         if (to != null) {
700             cmd.add(to.hex());
701         }
702 
703         var p = start(cmd);
704         try {
705             var patches = UnifiedDiffParser.parseGitRaw(p.getInputStream());
706             await(p);
707             return new Diff(from, to, patches);
708         } catch (Throwable t) {
709             stop(p);
710             throw t;
711         }
712     }
713 
714     @Override
715     public List&lt;String&gt; config(String key) throws IOException {
716         try (var p = capture(&quot;git&quot;, &quot;config&quot;, key)) {
717             var res = p.await();
718             return res.status() == 0 ? res.stdout() : List.of();
719         }
720     }
721 
722     @Override
723     public Hash head() throws IOException {
724         return resolve(&quot;HEAD&quot;).orElseThrow(() -&gt; new IllegalStateException(&quot;HEAD ref is not present&quot;));
725     }
726 
727     public static Optional&lt;Repository&gt; get(Path p) throws IOException {
728         if (!Files.exists(p)) {
729             return Optional.empty();
730         }
731 
732         var r = new GitRepository(p);
733         return r.exists() ? Optional.of(new GitRepository(r.root())) : Optional.empty();
734     }
735 
736     @Override
737     public Repository copyTo(Path destination) throws IOException {
738         try (var p = capture(&quot;git&quot;, &quot;clone&quot;, root().toString(), destination.toString())) {
739             await(p);
740         }
741 
742         return new GitRepository(destination);
743     }
744 
745     @Override
746     public void merge(Hash h) throws IOException {
747         merge(h, null);
748     }
749 
750     @Override
751     public void merge(Hash h, String strategy) throws IOException {
752         var cmd = new ArrayList&lt;String&gt;();
753         cmd.addAll(List.of(&quot;git&quot;, &quot;-c&quot;, &quot;user.name=unused&quot;, &quot;-c&quot;, &quot;user.email=unused&quot;,
754                            &quot;merge&quot;, &quot;--no-commit&quot;));
755         if (strategy != null) {
756             cmd.add(&quot;-s&quot;);
757             cmd.add(strategy);
758         }
759         cmd.add(h.hex());
760         try (var p = capture(cmd)) {
761             await(p);
762         }
763     }
764 
765     @Override
766     public void addRemote(String name, String pullPath) throws IOException {
767         try (var p = capture(&quot;git&quot;, &quot;remote&quot;, &quot;add&quot;, name, pullPath)) {
768             await(p);
769         }
770     }
771 
772     @Override
773     public void setPaths(String remote, String pullPath, String pushPath) throws IOException {
774         pullPath = pullPath == null ? &quot;&quot; : pullPath;
775         try (var p = capture(&quot;git&quot;, &quot;config&quot;, &quot;remote.&quot; + remote + &quot;.url&quot;, pullPath)) {
776             await(p);
777         }
778 
779         pushPath = pushPath == null ? &quot;&quot; : pushPath;
780         try (var p = capture(&quot;git&quot;, &quot;config&quot;, &quot;remote.&quot; + remote + &quot;.pushurl&quot;, pushPath)) {
781             await(p);
782         }
783     }
784 
785     @Override
786     public String pullPath(String remote) throws IOException {
787         var lines = config(&quot;remote.&quot; + remote + &quot;.url&quot;);
788         if (lines.size() != 1) {
789             throw new IOException(&quot;No pull path found for remote &quot; + remote);
790         }
791         return lines.get(0);
792     }
793 
794     @Override
795     public String pushPath(String remote) throws IOException {
796         var lines = config(&quot;remote.&quot; + remote + &quot;.pushurl&quot;);
797         if (lines.size() != 1) {
798             return pullPath(remote);
799         }
800         return lines.get(0);
801     }
802 
803     @Override
804     public boolean isValidRevisionRange(String expression) throws IOException {
805         try (var p = capture(&quot;git&quot;, &quot;rev-parse&quot;, expression)) {
806             return p.await().status() == 0;
807         }
808     }
809 
810     private void applyPatch(Patch patch) throws IOException {
811         if (patch.isEmpty()) {
812             return;
813         }
814 
815         if (patch.isTextual()) {
816         } else {
817             throw new IllegalArgumentException(&quot;Cannot handle binary patches yet&quot;);
818         }
819     }
820 
821     @Override
822     public void apply(Diff diff, boolean force) throws IOException {
823         // ignore force, no such concept in git
824         var patchFile = Files.createTempFile(&quot;apply&quot;, &quot;.patch&quot;);
825         diff.toFile(patchFile);
826         var cmd = new ArrayList&lt;String&gt;();
827         cmd.addAll(List.of(&quot;git&quot;, &quot;apply&quot;, &quot;--index&quot;, &quot;--unidiff-zero&quot;));
828         cmd.add(patchFile.toAbsolutePath().toString());
829         try (var p = capture(cmd)) {
830             await(p);
831             Files.delete(patchFile);
832         }
833     }
834 
835     @Override
836     public void copy(Path from, Path to) throws IOException {
837         Files.copy(from, to);
838         add(to);
839     }
840 
841     @Override
842     public void move(Path from, Path to) throws IOException {
843         try (var p = capture(&quot;git&quot;, &quot;mv&quot;, from.toString(), to.toString())) {
844             await(p);
845         }
846     }
847 
848     @Override
849     public Optional&lt;String&gt; upstreamFor(Branch b) throws IOException {
850         try (var p = capture(&quot;git&quot;, &quot;for-each-ref&quot;, &quot;--format=%(upstream:short)&quot;, &quot;refs/heads/&quot; + b.name())) {
851             var lines = await(p).stdout();
852             return lines.size() == 1 &amp;&amp; !lines.get(0).isEmpty()? Optional.of(lines.get(0)) : Optional.empty();
853         }
854     }
855 
856     public static Repository clone(URI from, Path to, boolean isBare) throws IOException {
857         var cmd = new ArrayList&lt;String&gt;();
858         cmd.addAll(List.of(&quot;git&quot;, &quot;clone&quot;));
859         if (isBare) {
860             cmd.add(&quot;--bare&quot;);
861         }
862         cmd.addAll(List.of(from.toString(), to.toString()));
863         try (var p = capture(Path.of(&quot;&quot;).toAbsolutePath(), cmd)) {
864             await(p);
865         }
866         return new GitRepository(to);
867     }
868 
869     public static Repository mirror(URI from, Path to) throws IOException {
870         var cwd = Path.of(&quot;&quot;).toAbsolutePath();
871         try (var p = capture(cwd, &quot;git&quot;, &quot;clone&quot;, &quot;--mirror&quot;, from.toString(), to.toString())) {
872             await(p);
873         }
874         return new GitRepository(to);
875     }
876 
877     @Override
878     public void pull() throws IOException {
879         pull(null, null);
880     }
881 
882     @Override
883     public void pull(String remote) throws IOException {
884         pull(remote, null);
885     }
886 
887 
888     @Override
889     public void pull(String remote, String refspec) throws IOException {
890         var cmd = new ArrayList&lt;String&gt;();
891         cmd.add(&quot;git&quot;);
892         cmd.add(&quot;pull&quot;);
893         if (remote != null) {
894             cmd.add(remote);
895         }
896         if (refspec != null) {
897             cmd.add(refspec);
898         }
899         try (var p = capture(cmd)) {
900             await(p);
901         }
902     }
903 }
<a name="8" id="anc8"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="8" type="hidden" />
</body>
</html>