<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames cli/src/main/java/org/openjdk/skara/cli/GitPr.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.cli;
 24 
 25 import org.openjdk.skara.args.*;
 26 import org.openjdk.skara.forge.*;
 27 import org.openjdk.skara.host.*;
 28 import org.openjdk.skara.proxy.HttpProxy;
 29 import org.openjdk.skara.vcs.*;
 30 import org.openjdk.skara.vcs.openjdk.CommitMessageParsers;
 31 
 32 import java.io.IOException;
 33 import java.net.URI;
 34 import java.nio.charset.StandardCharsets;
 35 import java.nio.file.*;
 36 import java.util.*;
 37 import java.util.concurrent.TimeUnit;
 38 import java.util.function.Supplier;
 39 import java.util.logging.Level;
 40 import java.util.stream.Collectors;
 41 
 42 public class GitPr {
 43     private static void exit(String fmt, Object...args) {
 44         System.err.println(String.format(fmt, args));
 45         System.exit(1);
 46     }
 47 
 48     private static &lt;T&gt; Supplier&lt;T&gt; die(String fmt, Object... args) {
 49         return () -&gt; {
 50             exit(fmt, args);
 51             return null;
 52         };
 53     }
 54 
 55     private static void await(Process p) throws IOException {
 56         try {
 57             var res = p.waitFor();
 58             if (res != 0) {
 59                 throw new IOException(&quot;Unexpected exit code &quot; + res);
 60             }
 61         } catch (InterruptedException e) {
 62             throw new IOException(e);
 63         }
 64     }
 65 
 66     private static boolean spawnEditor(ReadOnlyRepository repo, Path file) throws IOException {
 67         String editor = null;
 68         var lines = repo.config(&quot;core.editor&quot;);
 69         if (lines.size() == 1) {
 70             editor = lines.get(0);
 71         }
 72         if (editor == null) {
 73             editor = System.getenv(&quot;GIT_EDITOR&quot;);
 74         }
 75         if (editor == null) {
 76             editor = System.getenv(&quot;EDITOR&quot;);
 77         }
 78         if (editor == null) {
 79             editor = System.getenv(&quot;VISUAL&quot;);
 80         }
 81         if (editor == null) {
 82             editor = &quot;vi&quot;;
 83         }
 84 
 85         var pb = new ProcessBuilder(editor, file.toString());
 86         pb.inheritIO();
 87         var p = pb.start();
 88         try {
 89             return p.waitFor() == 0;
 90         } catch (InterruptedException e) {
 91             throw new IOException(e);
 92         }
 93     }
 94 
 95     private static String projectName(URI uri) {
 96         var name = uri.getPath().toString().substring(1);
 97         if (name.endsWith(&quot;.git&quot;)) {
 98             name = name.substring(0, name.length() - &quot;.git&quot;.length());
 99         }
100         return name;
101     }
102 
<a name="1" id="anc1"></a><span class="line-modified">103     private static HostedRepository getHostedRepositoryFor(URI uri, GitCredentials credentials) throws IOException {</span>
<span class="line-modified">104         var host = Forge.from(uri, new Credential(credentials.username(), credentials.password()));</span>
<span class="line-removed">105         if (System.getenv(&quot;GIT_TOKEN&quot;) == null) {</span>
<span class="line-removed">106             GitCredentials.approve(credentials);</span>
<span class="line-removed">107         }</span>
<span class="line-removed">108         if (host.isEmpty() || !host.get().isValid()) {</span>
<span class="line-removed">109             exit(&quot;error: failed to connect to host &quot; + uri);</span>
<span class="line-removed">110         }</span>
<span class="line-removed">111         var remoteRepo = host.get().repository(projectName(uri)).orElseThrow(() -&gt;</span>
112                 new IOException(&quot;Could not find repository at: &quot; + uri.toString())
113         );
114         var parentRepo = remoteRepo.parent();
115         var targetRepo = parentRepo.isPresent() ? parentRepo.get() : remoteRepo;
116         return targetRepo;
117     }
118 
<a name="2" id="anc2"></a><span class="line-modified">119     private static PullRequest getPullRequest(URI uri, GitCredentials credentials, Argument prId) throws IOException {</span>
120         if (!prId.isPresent()) {
121             exit(&quot;error: missing pull request identifier&quot;);
122         }
123 
<a name="3" id="anc3"></a><span class="line-modified">124         var pr = getHostedRepositoryFor(uri, credentials).pullRequest(prId.asString());</span>
125         if (pr == null) {
126             exit(&quot;error: could not fetch PR information&quot;);
127         }
128 
129         return pr;
130     }
131 
132     private static void show(String ref, Hash hash) throws IOException {
133         show(ref, hash, null);
134     }
135     private static void show(String ref, Hash hash, Path dir) throws IOException {
136         var pb = new ProcessBuilder(&quot;git&quot;, &quot;diff&quot;, &quot;--binary&quot;,
137                                                    &quot;--patch&quot;,
138                                                    &quot;--find-renames=50%&quot;,
139                                                    &quot;--find-copies=50%&quot;,
140                                                    &quot;--find-copies-harder&quot;,
141                                                    &quot;--abbrev&quot;,
142                                                    ref + &quot;...&quot; + hash.hex());
143         if (dir != null) {
144             pb.directory(dir.toFile());
145         }
146         pb.inheritIO();
147         await(pb.start());
148     }
149 
150     private static void gimport() throws IOException {
151         var pb = new ProcessBuilder(&quot;hg&quot;, &quot;gimport&quot;);
152         pb.inheritIO();
153         await(pb.start());
154     }
155 
156     private static void hgImport(Path patch) throws IOException {
157         var pb = new ProcessBuilder(&quot;hg&quot;, &quot;import&quot;, &quot;--no-commit&quot;, patch.toAbsolutePath().toString());
158         pb.inheritIO();
159         await(pb.start());
160     }
161 
162     private static List&lt;String&gt; hgTags() throws IOException, InterruptedException {
163         var pb = new ProcessBuilder(&quot;hg&quot;, &quot;tags&quot;, &quot;--quiet&quot;);
164         pb.redirectOutput(ProcessBuilder.Redirect.PIPE);
165         pb.redirectError(ProcessBuilder.Redirect.INHERIT);
166         var p = pb.start();
167         var bytes = p.getInputStream().readAllBytes();
168         var exited = p.waitFor(1, TimeUnit.MINUTES);
169         var exitValue = p.exitValue();
170         if (!exited || exitValue != 0) {
171             throw new IOException(&quot;&#39;hg tags&#39; exited with value: &quot; + exitValue);
172         }
173 
174         return Arrays.asList(new String(bytes, StandardCharsets.UTF_8).split(&quot;\n&quot;));
175     }
176 
177     private static String hgResolve(String ref) throws IOException, InterruptedException {
178         var pb = new ProcessBuilder(&quot;hg&quot;, &quot;log&quot;, &quot;-r&quot;, ref, &quot;--template&quot;, &quot;{node}&quot;);
179         pb.redirectOutput(ProcessBuilder.Redirect.PIPE);
180         pb.redirectError(ProcessBuilder.Redirect.INHERIT);
181         var p = pb.start();
182         var bytes = p.getInputStream().readAllBytes();
183         var exited = p.waitFor(1, TimeUnit.MINUTES);
184         var exitValue = p.exitValue();
185         if (!exited || exitValue != 0) {
186             throw new IOException(&quot;&#39;hg log&#39; exited with value: &quot; + exitValue);
187         }
188 
189         return new String(bytes, StandardCharsets.UTF_8);
190     }
191 
192     private static Path diff(String ref, Hash hash) throws IOException {
193         return diff(ref, hash, null);
194     }
195 
196     private static Path diff(String ref, Hash hash, Path dir) throws IOException {
197         var patch = Files.createTempFile(hash.hex(), &quot;.patch&quot;);
198         var pb = new ProcessBuilder(&quot;git&quot;, &quot;diff&quot;, &quot;--binary&quot;,
199                                                    &quot;--patch&quot;,
200                                                    &quot;--find-renames=50%&quot;,
201                                                    &quot;--find-copies=50%&quot;,
202                                                    &quot;--find-copies-harder&quot;,
203                                                    &quot;--abbrev&quot;,
204                                                    ref + &quot;...&quot; + hash.hex());
205         if (dir != null) {
206             pb.directory(dir.toFile());
207         }
208         pb.redirectOutput(patch.toFile());
209         pb.redirectError(ProcessBuilder.Redirect.INHERIT);
210         await(pb.start());
211         return patch;
212     }
213 
214     private static void apply(Path patch) throws IOException {
215         var pb = new ProcessBuilder(&quot;git&quot;, &quot;apply&quot;, &quot;--no-commit&quot;, patch.toString());
216         pb.inheritIO();
217         await(pb.start());
218     }
219 
220     private static int longest(List&lt;String&gt; strings) {
221         return strings.stream().mapToInt(String::length).max().orElse(0);
222     }
223 
224     public static void main(String[] args) throws IOException, InterruptedException {
225         var flags = List.of(
226             Option.shortcut(&quot;u&quot;)
227                   .fullname(&quot;username&quot;)
228                   .describe(&quot;NAME&quot;)
229                   .helptext(&quot;Username on host&quot;)
230                   .optional(),
231             Option.shortcut(&quot;r&quot;)
232                   .fullname(&quot;remote&quot;)
233                   .describe(&quot;NAME&quot;)
234                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)
235                   .optional(),
236             Option.shortcut(&quot;b&quot;)
237                   .fullname(&quot;branch&quot;)
238                   .describe(&quot;NAME&quot;)
239                   .helptext(&quot;Name of target branch, defaults to &#39;master&#39;&quot;)
240                   .optional(),
241             Option.shortcut(&quot;&quot;)
242                   .fullname(&quot;authors&quot;)
243                   .describe(&quot;LIST&quot;)
244                   .helptext(&quot;Comma separated list of authors&quot;)
245                   .optional(),
246             Option.shortcut(&quot;&quot;)
247                   .fullname(&quot;assignees&quot;)
248                   .describe(&quot;LIST&quot;)
249                   .helptext(&quot;Comma separated list of assignees&quot;)
250                   .optional(),
251             Option.shortcut(&quot;&quot;)
252                   .fullname(&quot;labels&quot;)
253                   .describe(&quot;LIST&quot;)
254                   .helptext(&quot;Comma separated list of labels&quot;)
255                   .optional(),
256             Option.shortcut(&quot;&quot;)
257                   .fullname(&quot;columns&quot;)
258                   .describe(&quot;id,title,author,assignees,labels&quot;)
259                   .helptext(&quot;Comma separated list of columns to show&quot;)
260                   .optional(),
261             Switch.shortcut(&quot;&quot;)
262                   .fullname(&quot;no-decoration&quot;)
263                   .helptext(&quot;Hide any decorations when listing PRs&quot;)
264                   .optional(),
<a name="4" id="anc4"></a>



265             Switch.shortcut(&quot;&quot;)
266                   .fullname(&quot;mercurial&quot;)
267                   .helptext(&quot;Force use of Mercurial (hg)&quot;)
268                   .optional(),
269             Switch.shortcut(&quot;&quot;)
270                   .fullname(&quot;verbose&quot;)
271                   .helptext(&quot;Turn on verbose output&quot;)
272                   .optional(),
273             Switch.shortcut(&quot;&quot;)
274                   .fullname(&quot;debug&quot;)
275                   .helptext(&quot;Turn on debugging output&quot;)
276                   .optional(),
277             Switch.shortcut(&quot;&quot;)
278                   .fullname(&quot;version&quot;)
279                   .helptext(&quot;Print the version of this tool&quot;)
280                   .optional());
281 
282         var inputs = List.of(
283             Input.position(0)
284                  .describe(&quot;list|fetch|show|checkout|apply|integrate|approve|create|close|update&quot;)
285                  .singular()
286                  .required(),
287             Input.position(1)
288                  .describe(&quot;ID&quot;)
289                  .singular()
290                  .optional()
291         );
292 
293         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);
294         var arguments = parser.parse(args);
295 
296         if (arguments.contains(&quot;version&quot;)) {
297             System.out.println(&quot;git-pr version: &quot; + Version.fromManifest().orElse(&quot;unknown&quot;));
298             System.exit(0);
299         }
300 
301         if (arguments.contains(&quot;verbose&quot;) || arguments.contains(&quot;debug&quot;)) {
302             var level = arguments.contains(&quot;debug&quot;) ? Level.FINER : Level.FINE;
303             Logging.setup(level);
304         }
305 
306         HttpProxy.setup();
307 
308         var isMercurial = arguments.contains(&quot;mercurial&quot;);
309         var cwd = Path.of(&quot;&quot;).toAbsolutePath();
310         var repo = Repository.get(cwd).orElseThrow(() -&gt; new IOException(&quot;no git repository found at &quot; + cwd.toString()));
311         var remote = arguments.get(&quot;remote&quot;).orString(isMercurial ? &quot;default&quot; : &quot;origin&quot;);
312         var remotePullPath = repo.pullPath(remote);
313         var username = arguments.contains(&quot;username&quot;) ? arguments.get(&quot;username&quot;).asString() : null;
314         var token = isMercurial ? System.getenv(&quot;HG_TOKEN&quot;) :  System.getenv(&quot;GIT_TOKEN&quot;);
315         var uri = Remote.toWebURI(remotePullPath);
<a name="5" id="anc5"></a><span class="line-modified">316         var credentials = GitCredentials.fill(uri.getHost(), uri.getPath(), username, token, uri.getScheme());</span>
<span class="line-modified">317         var host = Forge.from(uri, new Credential(credentials.username(), credentials.password()));</span>
<span class="line-modified">318         if (host.isEmpty() || !host.get().isValid()) {</span>
<span class="line-modified">319             exit(&quot;error: failed to connect to host &quot; + uri);</span>
















320         }
<a name="6" id="anc6"></a>
321 
322         var action = arguments.at(0).asString();
<a name="7" id="anc7"></a>





323         if (action.equals(&quot;create&quot;)) {
324             if (isMercurial) {
325                 var currentBookmark = repo.currentBookmark();
326                 if (!currentBookmark.isPresent()) {
327                     System.err.println(&quot;error: no bookmark is active, you must be on an active bookmark&quot;);
328                     System.err.println(&quot;&quot;);
329                     System.err.println(&quot;To create a bookmark and activate it, run:&quot;);
330                     System.err.println(&quot;&quot;);
331                     System.err.println(&quot;    hg bookmark NAME-FOR-YOUR-BOOKMARK&quot;);
332                     System.err.println(&quot;&quot;);
333                     System.exit(1);
334                 }
335 
336                 var bookmark = currentBookmark.get();
337                 if (bookmark.equals(new Bookmark(&quot;master&quot;))) {
338                     System.err.println(&quot;error: you should not create pull requests from the &#39;master&#39; bookmark&quot;);
339                     System.err.println(&quot;To create a bookmark and activate it, run:&quot;);
340                     System.err.println(&quot;&quot;);
341                     System.err.println(&quot;    hg bookmark NAME-FOR-YOUR-BOOKMARK&quot;);
342                     System.err.println(&quot;&quot;);
343                     System.exit(1);
344                 }
345 
346                 var tags = hgTags();
347                 var upstreams = tags.stream()
348                                     .filter(t -&gt; t.endsWith(bookmark.name()))
349                                     .collect(Collectors.toList());
350                 if (upstreams.isEmpty()) {
351                     System.err.println(&quot;error: there is no remote branch for the local bookmark &#39;&quot; + bookmark.name() + &quot;&#39;&quot;);
352                     System.err.println(&quot;&quot;);
353                     System.err.println(&quot;To create a remote branch and push the commits for your local branch, run:&quot;);
354                     System.err.println(&quot;&quot;);
355                     System.err.println(&quot;    hg push --bookmark &quot; + bookmark.name());
356                     System.err.println(&quot;&quot;);
357                     System.exit(1);
358                 }
359 
360                 var tagsAndHashes = new HashMap&lt;String, String&gt;();
361                 for (var tag : tags) {
362                     tagsAndHashes.put(tag, hgResolve(tag));
363                 }
364                 var bookmarkHash = hgResolve(bookmark.name());
365                 if (!tagsAndHashes.containsValue(bookmarkHash)) {
366                     System.err.println(&quot;error: there are local commits on bookmark &#39;&quot; + bookmark.name() + &quot;&#39; not present in a remote repository&quot;);
367                     System.err.println(&quot;&quot;);
368 
369                     if (upstreams.size() == 1) {
370                         System.err.println(&quot;To push the local commits to the remote repository, run:&quot;);
371                         System.err.println(&quot;&quot;);
372                         System.err.println(&quot;    hg push --bookmark &quot; + bookmark.name() + &quot; &quot; + upstreams.get(0));
373                         System.err.println(&quot;&quot;);
374                     } else {
375                         System.err.println(&quot;The following paths contains the &quot; + bookmark.name() + &quot; bookmark:&quot;);
376                         System.err.println(&quot;&quot;);
377                         for (var upstream : upstreams) {
378                             System.err.println(&quot;- &quot; + upstream.replace(&quot;/&quot; + bookmark.name(), &quot;&quot;));
379                         }
380                         System.err.println(&quot;&quot;);
381                         System.err.println(&quot;To push the local commits to a remote repository, run:&quot;);
382                         System.err.println(&quot;&quot;);
383                         System.err.println(&quot;    hg push --bookmark &quot; + bookmark.name() + &quot; &lt;PATH&gt;&quot;);
384                         System.err.println(&quot;&quot;);
385                     }
386                     System.exit(1);
387                 }
388 
389                 var targetBranch = arguments.get(&quot;branch&quot;).orString(&quot;master&quot;);
390                 var targetHash = hgResolve(targetBranch);
391                 var commits = repo.commits(targetHash + &quot;..&quot; + bookmarkHash + &quot;-&quot; + targetHash).asList();
392                 if (commits.isEmpty()) {
393                     System.err.println(&quot;error: no difference between bookmarks &quot; + targetBranch + &quot; and &quot; + bookmark.name());
394                     System.err.println(&quot;       Cannot create an empty pull request, have you committed?&quot;);
395                     System.exit(1);
396                 }
397 
398                 var diff = repo.diff(repo.head());
399                 if (!diff.patches().isEmpty()) {
400                     System.err.println(&quot;error: there are uncommitted changes in your working tree:&quot;);
401                     System.err.println(&quot;&quot;);
402                     for (var patch : diff.patches()) {
403                         var path = patch.target().path().isPresent() ?
404                             patch.target().path().get() : patch.source().path().get();
405                         System.err.println(&quot;    &quot; + patch.status().toString() + &quot; &quot; + path.toString());
406                     }
407                     System.err.println(&quot;&quot;);
408                     System.err.println(&quot;If these changes are meant to be part of the pull request, run:&quot;);
409                     System.err.println(&quot;&quot;);
410                     System.err.println(&quot;    hg commit --amend&quot;);
411                     System.err.println(&quot;    hg git-cleanup&quot;);
412                     System.err.println(&quot;    hg push --bookmark &quot; + bookmark.name() + &quot; &lt;PATH&gt;&quot;);
413                     System.err.println(&quot;    hg gimport&quot;);
414                     System.err.println(&quot;&quot;);
415                     System.err.println(&quot;If these changes are *not* meant to be part of the pull request, run:&quot;);
416                     System.err.println(&quot;&quot;);
417                     System.err.println(&quot;    hg shelve&quot;);
418                     System.err.println(&quot;&quot;);
419                     System.err.println(&quot;(You can later restore the changes by running: hg unshelve)&quot;);
420                     System.exit(1);
421                 }
422 
<a name="8" id="anc8"></a><span class="line-modified">423                 var remoteRepo = host.get().repository(projectName(uri)).orElseThrow(() -&gt;</span>
424                         new IOException(&quot;Could not find repository at &quot; + uri.toString())
425                 );
426                 if (token == null) {
427                     GitCredentials.approve(credentials);
428                 }
429                 var parentRepo = remoteRepo.parent().orElseThrow(() -&gt;
430                         new IOException(&quot;error: remote repository &quot; + remotePullPath + &quot; is not a fork of any repository&quot;));
431 
432                 var file = Files.createTempFile(&quot;PULL_REQUEST_&quot;, &quot;.txt&quot;);
433                 if (commits.size() == 1) {
434                     var commit = commits.get(0);
435                     var message = CommitMessageParsers.v1.parse(commit.message());
436                     Files.writeString(file, message.title() + &quot;\n&quot;);
437                     if (!message.summaries().isEmpty()) {
438                         Files.write(file, message.summaries(), StandardOpenOption.APPEND);
439                     }
440                     if (!message.additional().isEmpty()) {
441                         Files.write(file, message.additional(), StandardOpenOption.APPEND);
442                     }
443                 } else {
444                     Files.write(file, List.of(&quot;&quot;));
445                 }
446                 Files.write(file, List.of(
447                     &quot;# Please enter the pull request message for your changes. Lines starting&quot;,
448                     &quot;# with &#39;#&#39; will be ignored, and an empty message aborts the pull request.&quot;,
449                     &quot;# The first line will be considered the subject, use a blank line to separate&quot;,
450                     &quot;# the subject from the body.&quot;,
451                     &quot;#&quot;,
452                     &quot;# Commits to be included from branch &#39;&quot; + bookmark.name() + &quot;&#39;&quot;
453                     ),
454                     StandardOpenOption.APPEND
455                 );
456                 for (var commit : commits) {
457                     var desc = commit.hash().abbreviate() + &quot;: &quot; + commit.message().get(0);
458                     Files.writeString(file, &quot;# - &quot; + desc + &quot;\n&quot;, StandardOpenOption.APPEND);
459                 }
460                 Files.writeString(file, &quot;#\n&quot;, StandardOpenOption.APPEND);
461                 Files.writeString(file, &quot;# Target repository: &quot; + remotePullPath + &quot;\n&quot;, StandardOpenOption.APPEND);
462                 Files.writeString(file, &quot;# Target branch: &quot; + targetBranch + &quot;\n&quot;, StandardOpenOption.APPEND);
463                 var success = spawnEditor(repo, file);
464                 if (!success) {
465                     System.err.println(&quot;error: editor exited with non-zero status code, aborting&quot;);
466                     System.exit(1);
467                 }
468                 var lines = Files.readAllLines(file)
469                                  .stream()
470                                  .filter(l -&gt; !l.startsWith(&quot;#&quot;))
471                                  .collect(Collectors.toList());
472                 var isEmpty = lines.stream().allMatch(String::isEmpty);
473                 if (isEmpty) {
474                     System.err.println(&quot;error: no message present, aborting&quot;);
475                     System.exit(1);
476                 }
477 
478                 var title = lines.get(0);
479                 List&lt;String&gt; body = null;
480                 if (lines.size() &gt; 1) {
481                     body = lines.subList(1, lines.size())
482                                 .stream()
483                                 .dropWhile(String::isEmpty)
484                                 .collect(Collectors.toList());
485                 } else {
486                     body = Collections.emptyList();
487                 }
488 
489                 var pr = remoteRepo.createPullRequest(parentRepo, targetBranch, bookmark.name(), title, body);
490                 if (arguments.contains(&quot;assignees&quot;)) {
491                     var usernames = Arrays.asList(arguments.get(&quot;assignees&quot;).asString().split(&quot;,&quot;));
492                     var assignees = usernames.stream()
<a name="9" id="anc9"></a><span class="line-modified">493                                              .map(u -&gt; host.get().user(u))</span>
494                                              .collect(Collectors.toList());
495                     pr.setAssignees(assignees);
496                 }
497                 System.out.println(pr.webUrl().toString());
498                 Files.deleteIfExists(file);
499 
500                 System.exit(0);
501             }
502             var currentBranch = repo.currentBranch();
503             if (currentBranch.equals(repo.defaultBranch())) {
504                 System.err.println(&quot;error: you should not create pull requests from the &#39;master&#39; branch&quot;);
505                 System.err.println(&quot;&quot;);
506                 System.err.println(&quot;To create a local branch for your changes and restore the &#39;master&#39; branch, run:&quot;);
507                 System.err.println(&quot;&quot;);
508                 System.err.println(&quot;    git checkout -b NAME-FOR-YOUR-LOCAL-BRANCH&quot;);
509                 System.err.println(&quot;    git branch --force master origin/master&quot;);
510                 System.err.println(&quot;&quot;);
511                 System.exit(1);
512             }
513 
514             var upstream = repo.upstreamFor(currentBranch);
515             if (upstream.isEmpty()) {
516                 System.err.println(&quot;error: there is no remote branch for the local branch &#39;&quot; + currentBranch.name() + &quot;&#39;&quot;);
517                 System.err.println(&quot;&quot;);
518                 System.err.println(&quot;A remote branch must be present at &quot; + remotePullPath + &quot; to create a pull request&quot;);
519                 System.err.println(&quot;To create a remote branch and push the commits for your local branch, run:&quot;);
520                 System.err.println(&quot;&quot;);
521                 System.err.println(&quot;    git push --set-upstream &quot; + remote + &quot; &quot; + currentBranch.name());
522                 System.err.println(&quot;&quot;);
523                 System.err.println(&quot;If you created the remote branch from another client, you must update this repository.&quot;);
524                 System.err.println(&quot;To update remote information for this repository, run:&quot;);
525                 System.err.println(&quot;&quot;);
526                 System.err.println(&quot;    git fetch &quot; + remote);
527                 System.err.println(&quot;    git branch --set-upstream &quot; + currentBranch + &quot; &quot; + remote + &quot;/&quot; + currentBranch);
528                 System.err.println(&quot;&quot;);
529                 System.exit(1);
530             }
531 
532             var upstreamRefName = upstream.get().substring(remote.length() + 1);
533             repo.fetch(uri, upstreamRefName);
534             var branchCommits = repo.commits(upstream.get() + &quot;..&quot; + currentBranch.name()).asList();
535             if (!branchCommits.isEmpty()) {
536                 System.err.println(&quot;error: there are local commits on branch &#39;&quot; + currentBranch.name() + &quot;&#39; not present in the remote repository &quot; + remotePullPath);
537                 System.err.println(&quot;&quot;);
538                 System.err.println(&quot;All commits must be present in the remote repository to be part of the pull request&quot;);
539                 System.err.println(&quot;The following commits are not present in the remote repository:&quot;);
540                 System.err.println(&quot;&quot;);
541                 for (var commit : branchCommits) {
542                     System.err.println(&quot;- &quot; + commit.hash().abbreviate() + &quot;: &quot; + commit.message().get(0));
543                 }
544                 System.err.println(&quot;&quot;);
545                 System.err.println(&quot;To push the above local commits to the remote repository, run:&quot;);
546                 System.err.println(&quot;&quot;);
547                 System.err.println(&quot;    git push &quot; + remote + &quot; &quot; + currentBranch.name());
548                 System.err.println(&quot;&quot;);
549                 System.exit(1);
550             }
551 
552             var targetBranch = arguments.get(&quot;branch&quot;).orString(&quot;master&quot;);
553             var commits = repo.commits(targetBranch + &quot;..&quot; + currentBranch.name()).asList();
554             if (commits.isEmpty()) {
555                 System.err.println(&quot;error: no difference between branches &quot; + targetBranch + &quot; and &quot; + currentBranch.name());
556                 System.err.println(&quot;       Cannot create an empty pull request, have you committed?&quot;);
557                 System.exit(1);
558             }
559 
560             var diff = repo.diff(repo.head());
561             if (!diff.patches().isEmpty()) {
562                 System.err.println(&quot;error: there are uncommitted changes in your working tree:&quot;);
563                 System.err.println(&quot;&quot;);
564                 for (var patch : diff.patches()) {
565                     var path = patch.target().path().isPresent() ?
566                         patch.target().path().get() : patch.source().path().get();
567                     System.err.println(&quot;    &quot; + patch.status().toString() + &quot; &quot; + path.toString());
568                 }
569                 System.err.println(&quot;&quot;);
570                 System.err.println(&quot;If these changes are meant to be part of the pull request, run:&quot;);
571                 System.err.println(&quot;&quot;);
572                 System.err.println(&quot;    git commit -am &#39;Forgot to add some changes&#39;&quot;);
573                 System.err.println(&quot;&quot;);
574                 System.err.println(&quot;If these changes are *not* meant to be part of the pull request, run:&quot;);
575                 System.err.println(&quot;&quot;);
576                 System.err.println(&quot;    git stash&quot;);
577                 System.err.println(&quot;&quot;);
578                 System.err.println(&quot;(You can later restore the changes by running: git stash pop)&quot;);
579                 System.exit(1);
580             }
581 
<a name="10" id="anc10"></a><span class="line-modified">582             var remoteRepo = host.get().repository(projectName(uri)).orElseThrow(() -&gt;</span>
583                     new IOException(&quot;Could not find repository at &quot; + uri.toString())
584             );
585             if (token == null) {
586                 GitCredentials.approve(credentials);
587             }
588             var parentRepo = remoteRepo.parent().orElseThrow(() -&gt;
589                     new IOException(&quot;error: remote repository &quot; + remotePullPath + &quot; is not a fork of any repository&quot;));
590 
591             var file = Files.createTempFile(&quot;PULL_REQUEST_&quot;, &quot;.txt&quot;);
592             if (commits.size() == 1) {
593                 var commit = commits.get(0);
594                 var message = CommitMessageParsers.v1.parse(commit.message());
595                 Files.writeString(file, message.title() + &quot;\n&quot;);
596                 if (!message.summaries().isEmpty()) {
597                     Files.write(file, message.summaries(), StandardOpenOption.APPEND);
598                 }
599                 if (!message.additional().isEmpty()) {
600                     Files.write(file, message.additional(), StandardOpenOption.APPEND);
601                 }
602             } else {
603                 Files.write(file, List.of(&quot;&quot;));
604             }
605             Files.write(file, List.of(
606                 &quot;# Please enter the pull request message for your changes. Lines starting&quot;,
607                 &quot;# with &#39;#&#39; will be ignored, and an empty message aborts the pull request.&quot;,
608                 &quot;# The first line will be considered the subject, use a blank line to separate&quot;,
609                 &quot;# the subject from the body.&quot;,
610                 &quot;#&quot;,
611                 &quot;# Commits to be included from branch &#39;&quot; + currentBranch.name() + &quot;&#39;&quot;
612                 ),
613                 StandardOpenOption.APPEND
614             );
615             for (var commit : commits) {
616                 var desc = commit.hash().abbreviate() + &quot;: &quot; + commit.message().get(0);
617                 Files.writeString(file, &quot;# - &quot; + desc + &quot;\n&quot;, StandardOpenOption.APPEND);
618             }
619             Files.writeString(file, &quot;#\n&quot;, StandardOpenOption.APPEND);
620             Files.writeString(file, &quot;# Target repository: &quot; + remotePullPath + &quot;\n&quot;, StandardOpenOption.APPEND);
621             Files.writeString(file, &quot;# Target branch: &quot; + targetBranch + &quot;\n&quot;, StandardOpenOption.APPEND);
622             var success = spawnEditor(repo, file);
623             if (!success) {
624                 System.err.println(&quot;error: editor exited with non-zero status code, aborting&quot;);
625                 System.exit(1);
626             }
627             var lines = Files.readAllLines(file)
628                              .stream()
629                              .filter(l -&gt; !l.startsWith(&quot;#&quot;))
630                              .collect(Collectors.toList());
631             var isEmpty = lines.stream().allMatch(String::isEmpty);
632             if (isEmpty) {
633                 System.err.println(&quot;error: no message present, aborting&quot;);
634                 System.exit(1);
635             }
636 
637             var title = lines.get(0);
638             List&lt;String&gt; body = null;
639             if (lines.size() &gt; 1) {
640                 body = lines.subList(1, lines.size())
641                             .stream()
642                             .dropWhile(String::isEmpty)
643                             .collect(Collectors.toList());
644             } else {
645                 body = Collections.emptyList();
646             }
647 
648             var pr = remoteRepo.createPullRequest(parentRepo, targetBranch, currentBranch.name(), title, body);
649             if (arguments.contains(&quot;assignees&quot;)) {
650                 var usernames = Arrays.asList(arguments.get(&quot;assignees&quot;).asString().split(&quot;,&quot;));
651                 var assignees = usernames.stream()
<a name="11" id="anc11"></a><span class="line-modified">652                                          .map(u -&gt; host.get().user(u))</span>
653                                          .collect(Collectors.toList());
654                 pr.setAssignees(assignees);
655             }
656             System.out.println(pr.webUrl().toString());
657             Files.deleteIfExists(file);
658         } else if (action.equals(&quot;integrate&quot;) || action.equals(&quot;approve&quot;)) {
<a name="12" id="anc12"></a><span class="line-modified">659             var pr = getPullRequest(uri, credentials, arguments.at(1));</span>
660 
661             if (action.equals(&quot;integrate&quot;)) {
662                 pr.addComment(&quot;/integrate&quot;);
663             } else if (action.equals(&quot;approve&quot;)) {
664                 pr.addReview(Review.Verdict.APPROVED, &quot;Looks good!&quot;);
665             } else {
666                 throw new IllegalStateException(&quot;unexpected action: &quot; + action);
667             }
668         } else if (action.equals(&quot;list&quot;)) {
<a name="13" id="anc13"></a><span class="line-modified">669             var remoteRepo = getHostedRepositoryFor(uri, credentials);</span>
670             var prs = remoteRepo.pullRequests();
671 
672             var ids = new ArrayList&lt;String&gt;();
673             var titles = new ArrayList&lt;String&gt;();
674             var authors = new ArrayList&lt;String&gt;();
675             var assignees = new ArrayList&lt;String&gt;();
676             var labels = new ArrayList&lt;String&gt;();
677 
678             var filterAuthors = arguments.contains(&quot;authors&quot;) ?
679                 new HashSet&lt;&gt;(Arrays.asList(arguments.get(&quot;authors&quot;).asString().split(&quot;,&quot;))) :
680                 Set.of();
681             var filterAssignees = arguments.contains(&quot;assignees&quot;) ?
682                 Arrays.asList(arguments.get(&quot;assignees&quot;).asString().split(&quot;,&quot;)) :
683                 Set.of();
684             var filterLabels = arguments.contains(&quot;labels&quot;) ?
685                 Arrays.asList(arguments.get(&quot;labels&quot;).asString().split(&quot;,&quot;)) :
686                 Set.of();
687 
688             var defaultColumns = List.of(&quot;id&quot;, &quot;title&quot;, &quot;authors&quot;, &quot;assignees&quot;, &quot;labels&quot;);
689             var columnValues = Map.of(defaultColumns.get(0), ids,
690                                       defaultColumns.get(1), titles,
691                                       defaultColumns.get(2), authors,
692                                       defaultColumns.get(3), assignees,
693                                       defaultColumns.get(4), labels);
694             var columns = arguments.contains(&quot;columns&quot;) ?
695                 Arrays.asList(arguments.get(&quot;columns&quot;).asString().split(&quot;,&quot;)) :
696                 defaultColumns;
697             if (columns != defaultColumns) {
698                 for (var column : columns) {
699                     if (!defaultColumns.contains(column)) {
700                         System.err.println(&quot;error: unknown column: &quot; + column);
701                         System.err.println(&quot;       available columns are: &quot; + String.join(&quot;,&quot;, defaultColumns));
702                         System.exit(1);
703                     }
704                 }
705             }
706 
707             for (var pr : remoteRepo.pullRequests()) {
708                 var prAuthor = pr.author().userName();
709                 if (!filterAuthors.isEmpty() &amp;&amp; !filterAuthors.contains(prAuthor)) {
710                     continue;
711                 }
712 
713                 var prAssignees = pr.assignees().stream()
714                                     .map(HostUser::userName)
715                                     .collect(Collectors.toSet());
716                 if (!filterAssignees.isEmpty() &amp;&amp; !filterAssignees.stream().anyMatch(prAssignees::contains)) {
717                     continue;
718                 }
719 
720                 var prLabels = new HashSet&lt;&gt;(pr.labels());
721                 if (!filterLabels.isEmpty() &amp;&amp; !filterLabels.stream().anyMatch(prLabels::contains)) {
722                     continue;
723                 }
724 
725                 ids.add(pr.id());
726                 titles.add(pr.title());
727                 authors.add(prAuthor);
728                 assignees.add(String.join(&quot;,&quot;, prAssignees));
729                 labels.add(String.join(&quot;,&quot;, prLabels));
730             }
731 
732 
733             String fmt = &quot;&quot;;
734             for (var column : columns.subList(0, columns.size() - 1)) {
735                 var values = columnValues.get(column);
736                 var n = Math.max(column.length(), longest(values));
737                 fmt += &quot;%-&quot; + n + &quot;s\t&quot;;
738             }
739             fmt += &quot;%s\n&quot;;
740 
741             if (!ids.isEmpty() &amp;&amp; !arguments.contains(&quot;no-decoration&quot;)) {
742                 var upperCase = columns.stream()
743                                        .map(String::toUpperCase)
744                                        .collect(Collectors.toList());
745                 System.out.format(fmt, (Object[]) upperCase.toArray(new String[0]));
746             }
747             for (var i = 0; i &lt; ids.size(); i++) {
748                 final int n = i;
749                 var row = columns.stream()
750                                  .map(columnValues::get)
751                                  .map(values -&gt; values.get(n))
752                                  .collect(Collectors.toList());
753                 System.out.format(fmt, (Object[]) row.toArray(new String[0]));
754             }
755         } else if (action.equals(&quot;fetch&quot;) || action.equals(&quot;checkout&quot;) || action.equals(&quot;show&quot;) || action.equals(&quot;apply&quot;)) {
756             var prId = arguments.at(1);
757             if (!prId.isPresent()) {
758                 exit(&quot;error: missing pull request identifier&quot;);
759             }
760 
<a name="14" id="anc14"></a><span class="line-modified">761             var remoteRepo = getHostedRepositoryFor(uri, credentials);</span>
762             var pr = remoteRepo.pullRequest(prId.asString());
763             var repoUrl = remoteRepo.webUrl();
764             var prHeadRef = pr.sourceRef();
765             var isHgGit = isMercurial &amp;&amp; Repository.exists(repo.root().resolve(&quot;.hg&quot;).resolve(&quot;git&quot;));
766             if (isHgGit) {
767                 var hgGitRepo = Repository.get(repo.root().resolve(&quot;.hg&quot;).resolve(&quot;git&quot;)).get();
768                 var hgGitFetchHead = hgGitRepo.fetch(repoUrl, prHeadRef);
769 
770                 if (action.equals(&quot;show&quot;) || action.equals(&quot;apply&quot;)) {
771                     var target = hgGitRepo.fetch(repoUrl, pr.targetRef());
772                     var hgGitMergeBase = hgGitRepo.mergeBase(target, hgGitFetchHead);
773 
774                     if (action.equals(&quot;show&quot;)) {
775                         show(hgGitMergeBase.hex(), hgGitFetchHead, hgGitRepo.root());
776                     } else {
777                         var patch = diff(hgGitMergeBase.hex(), hgGitFetchHead, hgGitRepo.root());
778                         hgImport(patch);
779                         Files.delete(patch);
780                     }
781                 } else if (action.equals(&quot;fetch&quot;) || action.equals(&quot;checkout&quot;)) {
782                     var hgGitRef = prHeadRef.endsWith(&quot;/head&quot;) ? prHeadRef.replace(&quot;/head&quot;, &quot;&quot;) : prHeadRef;
783                     var hgGitBranches = hgGitRepo.branches();
784                     if (hgGitBranches.contains(new Branch(hgGitRef))) {
785                         hgGitRepo.delete(new Branch(hgGitRef));
786                     }
787                     hgGitRepo.branch(hgGitFetchHead, hgGitRef);
788                     gimport();
789                     var hgFetchHead = repo.resolve(hgGitRef).get();
790 
791                     if (action.equals(&quot;fetch&quot;) &amp;&amp; arguments.contains(&quot;branch&quot;)) {
792                         repo.branch(hgFetchHead, arguments.get(&quot;branch&quot;).asString());
793                     } else if (action.equals(&quot;checkout&quot;)) {
794                         repo.checkout(hgFetchHead);
795                         if (arguments.contains(&quot;branch&quot;)) {
796                             repo.branch(hgFetchHead, arguments.get(&quot;branch&quot;).asString());
797                         }
798                     }
799                 } else {
800                     exit(&quot;Unexpected action: &quot; + action);
801                 }
802 
803                 return;
804             }
805 
806             var fetchHead = repo.fetch(repoUrl, pr.sourceRef());
807             if (action.equals(&quot;fetch&quot;)) {
808                 if (arguments.contains(&quot;branch&quot;)) {
809                     var branchName = arguments.get(&quot;branch&quot;).asString();
810                     repo.branch(fetchHead, branchName);
811                 } else {
812                     System.out.println(fetchHead.hex());
813                 }
814             } else if (action.equals(&quot;checkout&quot;)) {
815                 if (arguments.contains(&quot;branch&quot;)) {
816                     var branchName = arguments.get(&quot;branch&quot;).asString();
817                     var branch = repo.branch(fetchHead, branchName);
818                     repo.checkout(branch, false);
819                 } else {
820                     repo.checkout(fetchHead, false);
821                 }
822             } else if (action.equals(&quot;show&quot;)) {
823                 show(pr.targetRef(), fetchHead);
824             } else if (action.equals(&quot;apply&quot;)) {
825                 var patch = diff(pr.targetRef(), fetchHead);
826                 apply(patch);
827                 Files.deleteIfExists(patch);
828             }
829         } else if (action.equals(&quot;close&quot;)) {
830             var prId = arguments.at(1);
831             if (!prId.isPresent()) {
832                 exit(&quot;error: missing pull request identifier&quot;);
833             }
834 
<a name="15" id="anc15"></a><span class="line-modified">835             var remoteRepo = getHostedRepositoryFor(uri, credentials);</span>
836             var pr = remoteRepo.pullRequest(prId.asString());
837             pr.setState(PullRequest.State.CLOSED);
838         } else if (action.equals(&quot;update&quot;)) {
839             var prId = arguments.at(1);
840             if (!prId.isPresent()) {
841                 exit(&quot;error: missing pull request identifier&quot;);
842             }
843 
<a name="16" id="anc16"></a><span class="line-modified">844             var remoteRepo = getHostedRepositoryFor(uri, credentials);</span>
845             var pr = remoteRepo.pullRequest(prId.asString());
846             if (arguments.contains(&quot;assignees&quot;)) {
847                 var usernames = Arrays.asList(arguments.get(&quot;assignees&quot;).asString().split(&quot;,&quot;));
848                 var assignees = usernames.stream()
<a name="17" id="anc17"></a><span class="line-modified">849                     .map(u -&gt; host.get().user(u))</span>
850                     .collect(Collectors.toList());
851                 pr.setAssignees(assignees);
852             }
853         } else {
854             exit(&quot;error: unexpected action: &quot; + action);
855         }
856     }
857 }
<a name="18" id="anc18"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="18" type="hidden" />
</body>
</html>