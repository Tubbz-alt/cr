<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff cli/src/main/java/org/openjdk/skara/cli/GitPr.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../forge/src/main/java/org/openjdk/skara/forge/github/GitHubHost.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>cli/src/main/java/org/openjdk/skara/cli/GitPr.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 83         }
 84 
 85         var pb = new ProcessBuilder(editor, file.toString());
 86         pb.inheritIO();
 87         var p = pb.start();
 88         try {
 89             return p.waitFor() == 0;
 90         } catch (InterruptedException e) {
 91             throw new IOException(e);
 92         }
 93     }
 94 
 95     private static String projectName(URI uri) {
 96         var name = uri.getPath().toString().substring(1);
 97         if (name.endsWith(&quot;.git&quot;)) {
 98             name = name.substring(0, name.length() - &quot;.git&quot;.length());
 99         }
100         return name;
101     }
102 
<span class="line-modified">103     private static HostedRepository getHostedRepositoryFor(URI uri, GitCredentials credentials) throws IOException {</span>
<span class="line-modified">104         var host = Forge.from(uri, new Credential(credentials.username(), credentials.password()));</span>
<span class="line-removed">105         if (System.getenv(&quot;GIT_TOKEN&quot;) == null) {</span>
<span class="line-removed">106             GitCredentials.approve(credentials);</span>
<span class="line-removed">107         }</span>
<span class="line-removed">108         if (host.isEmpty() || !host.get().isValid()) {</span>
<span class="line-removed">109             exit(&quot;error: failed to connect to host &quot; + uri);</span>
<span class="line-removed">110         }</span>
<span class="line-removed">111         var remoteRepo = host.get().repository(projectName(uri)).orElseThrow(() -&gt;</span>
112                 new IOException(&quot;Could not find repository at: &quot; + uri.toString())
113         );
114         var parentRepo = remoteRepo.parent();
115         var targetRepo = parentRepo.isPresent() ? parentRepo.get() : remoteRepo;
116         return targetRepo;
117     }
118 
<span class="line-modified">119     private static PullRequest getPullRequest(URI uri, GitCredentials credentials, Argument prId) throws IOException {</span>
120         if (!prId.isPresent()) {
121             exit(&quot;error: missing pull request identifier&quot;);
122         }
123 
<span class="line-modified">124         var pr = getHostedRepositoryFor(uri, credentials).pullRequest(prId.asString());</span>
125         if (pr == null) {
126             exit(&quot;error: could not fetch PR information&quot;);
127         }
128 
129         return pr;
130     }
131 
132     private static void show(String ref, Hash hash) throws IOException {
133         show(ref, hash, null);
134     }
135     private static void show(String ref, Hash hash, Path dir) throws IOException {
136         var pb = new ProcessBuilder(&quot;git&quot;, &quot;diff&quot;, &quot;--binary&quot;,
137                                                    &quot;--patch&quot;,
138                                                    &quot;--find-renames=50%&quot;,
139                                                    &quot;--find-copies=50%&quot;,
140                                                    &quot;--find-copies-harder&quot;,
141                                                    &quot;--abbrev&quot;,
142                                                    ref + &quot;...&quot; + hash.hex());
143         if (dir != null) {
144             pb.directory(dir.toFile());
</pre>
<hr />
<pre>
245                   .optional(),
246             Option.shortcut(&quot;&quot;)
247                   .fullname(&quot;assignees&quot;)
248                   .describe(&quot;LIST&quot;)
249                   .helptext(&quot;Comma separated list of assignees&quot;)
250                   .optional(),
251             Option.shortcut(&quot;&quot;)
252                   .fullname(&quot;labels&quot;)
253                   .describe(&quot;LIST&quot;)
254                   .helptext(&quot;Comma separated list of labels&quot;)
255                   .optional(),
256             Option.shortcut(&quot;&quot;)
257                   .fullname(&quot;columns&quot;)
258                   .describe(&quot;id,title,author,assignees,labels&quot;)
259                   .helptext(&quot;Comma separated list of columns to show&quot;)
260                   .optional(),
261             Switch.shortcut(&quot;&quot;)
262                   .fullname(&quot;no-decoration&quot;)
263                   .helptext(&quot;Hide any decorations when listing PRs&quot;)
264                   .optional(),




265             Switch.shortcut(&quot;&quot;)
266                   .fullname(&quot;mercurial&quot;)
267                   .helptext(&quot;Force use of Mercurial (hg)&quot;)
268                   .optional(),
269             Switch.shortcut(&quot;&quot;)
270                   .fullname(&quot;verbose&quot;)
271                   .helptext(&quot;Turn on verbose output&quot;)
272                   .optional(),
273             Switch.shortcut(&quot;&quot;)
274                   .fullname(&quot;debug&quot;)
275                   .helptext(&quot;Turn on debugging output&quot;)
276                   .optional(),
277             Switch.shortcut(&quot;&quot;)
278                   .fullname(&quot;version&quot;)
279                   .helptext(&quot;Print the version of this tool&quot;)
280                   .optional());
281 
282         var inputs = List.of(
283             Input.position(0)
284                  .describe(&quot;list|fetch|show|checkout|apply|integrate|approve|create|close|update&quot;)
</pre>
<hr />
<pre>
296         if (arguments.contains(&quot;version&quot;)) {
297             System.out.println(&quot;git-pr version: &quot; + Version.fromManifest().orElse(&quot;unknown&quot;));
298             System.exit(0);
299         }
300 
301         if (arguments.contains(&quot;verbose&quot;) || arguments.contains(&quot;debug&quot;)) {
302             var level = arguments.contains(&quot;debug&quot;) ? Level.FINER : Level.FINE;
303             Logging.setup(level);
304         }
305 
306         HttpProxy.setup();
307 
308         var isMercurial = arguments.contains(&quot;mercurial&quot;);
309         var cwd = Path.of(&quot;&quot;).toAbsolutePath();
310         var repo = Repository.get(cwd).orElseThrow(() -&gt; new IOException(&quot;no git repository found at &quot; + cwd.toString()));
311         var remote = arguments.get(&quot;remote&quot;).orString(isMercurial ? &quot;default&quot; : &quot;origin&quot;);
312         var remotePullPath = repo.pullPath(remote);
313         var username = arguments.contains(&quot;username&quot;) ? arguments.get(&quot;username&quot;).asString() : null;
314         var token = isMercurial ? System.getenv(&quot;HG_TOKEN&quot;) :  System.getenv(&quot;GIT_TOKEN&quot;);
315         var uri = Remote.toWebURI(remotePullPath);
<span class="line-modified">316         var credentials = GitCredentials.fill(uri.getHost(), uri.getPath(), username, token, uri.getScheme());</span>
<span class="line-modified">317         var host = Forge.from(uri, new Credential(credentials.username(), credentials.password()));</span>
<span class="line-modified">318         if (host.isEmpty() || !host.get().isValid()) {</span>
<span class="line-modified">319             exit(&quot;error: failed to connect to host &quot; + uri);</span>
















320         }

321 
322         var action = arguments.at(0).asString();






323         if (action.equals(&quot;create&quot;)) {
324             if (isMercurial) {
325                 var currentBookmark = repo.currentBookmark();
326                 if (!currentBookmark.isPresent()) {
327                     System.err.println(&quot;error: no bookmark is active, you must be on an active bookmark&quot;);
328                     System.err.println(&quot;&quot;);
329                     System.err.println(&quot;To create a bookmark and activate it, run:&quot;);
330                     System.err.println(&quot;&quot;);
331                     System.err.println(&quot;    hg bookmark NAME-FOR-YOUR-BOOKMARK&quot;);
332                     System.err.println(&quot;&quot;);
333                     System.exit(1);
334                 }
335 
336                 var bookmark = currentBookmark.get();
337                 if (bookmark.equals(new Bookmark(&quot;master&quot;))) {
338                     System.err.println(&quot;error: you should not create pull requests from the &#39;master&#39; bookmark&quot;);
339                     System.err.println(&quot;To create a bookmark and activate it, run:&quot;);
340                     System.err.println(&quot;&quot;);
341                     System.err.println(&quot;    hg bookmark NAME-FOR-YOUR-BOOKMARK&quot;);
342                     System.err.println(&quot;&quot;);
</pre>
<hr />
<pre>
403                         var path = patch.target().path().isPresent() ?
404                             patch.target().path().get() : patch.source().path().get();
405                         System.err.println(&quot;    &quot; + patch.status().toString() + &quot; &quot; + path.toString());
406                     }
407                     System.err.println(&quot;&quot;);
408                     System.err.println(&quot;If these changes are meant to be part of the pull request, run:&quot;);
409                     System.err.println(&quot;&quot;);
410                     System.err.println(&quot;    hg commit --amend&quot;);
411                     System.err.println(&quot;    hg git-cleanup&quot;);
412                     System.err.println(&quot;    hg push --bookmark &quot; + bookmark.name() + &quot; &lt;PATH&gt;&quot;);
413                     System.err.println(&quot;    hg gimport&quot;);
414                     System.err.println(&quot;&quot;);
415                     System.err.println(&quot;If these changes are *not* meant to be part of the pull request, run:&quot;);
416                     System.err.println(&quot;&quot;);
417                     System.err.println(&quot;    hg shelve&quot;);
418                     System.err.println(&quot;&quot;);
419                     System.err.println(&quot;(You can later restore the changes by running: hg unshelve)&quot;);
420                     System.exit(1);
421                 }
422 
<span class="line-modified">423                 var remoteRepo = host.get().repository(projectName(uri)).orElseThrow(() -&gt;</span>
424                         new IOException(&quot;Could not find repository at &quot; + uri.toString())
425                 );
426                 if (token == null) {
427                     GitCredentials.approve(credentials);
428                 }
429                 var parentRepo = remoteRepo.parent().orElseThrow(() -&gt;
430                         new IOException(&quot;error: remote repository &quot; + remotePullPath + &quot; is not a fork of any repository&quot;));
431 
432                 var file = Files.createTempFile(&quot;PULL_REQUEST_&quot;, &quot;.txt&quot;);
433                 if (commits.size() == 1) {
434                     var commit = commits.get(0);
435                     var message = CommitMessageParsers.v1.parse(commit.message());
436                     Files.writeString(file, message.title() + &quot;\n&quot;);
437                     if (!message.summaries().isEmpty()) {
438                         Files.write(file, message.summaries(), StandardOpenOption.APPEND);
439                     }
440                     if (!message.additional().isEmpty()) {
441                         Files.write(file, message.additional(), StandardOpenOption.APPEND);
442                     }
443                 } else {
</pre>
<hr />
<pre>
473                 if (isEmpty) {
474                     System.err.println(&quot;error: no message present, aborting&quot;);
475                     System.exit(1);
476                 }
477 
478                 var title = lines.get(0);
479                 List&lt;String&gt; body = null;
480                 if (lines.size() &gt; 1) {
481                     body = lines.subList(1, lines.size())
482                                 .stream()
483                                 .dropWhile(String::isEmpty)
484                                 .collect(Collectors.toList());
485                 } else {
486                     body = Collections.emptyList();
487                 }
488 
489                 var pr = remoteRepo.createPullRequest(parentRepo, targetBranch, bookmark.name(), title, body);
490                 if (arguments.contains(&quot;assignees&quot;)) {
491                     var usernames = Arrays.asList(arguments.get(&quot;assignees&quot;).asString().split(&quot;,&quot;));
492                     var assignees = usernames.stream()
<span class="line-modified">493                                              .map(u -&gt; host.get().user(u))</span>
494                                              .collect(Collectors.toList());
495                     pr.setAssignees(assignees);
496                 }
497                 System.out.println(pr.webUrl().toString());
498                 Files.deleteIfExists(file);
499 
500                 System.exit(0);
501             }
502             var currentBranch = repo.currentBranch();
503             if (currentBranch.equals(repo.defaultBranch())) {
504                 System.err.println(&quot;error: you should not create pull requests from the &#39;master&#39; branch&quot;);
505                 System.err.println(&quot;&quot;);
506                 System.err.println(&quot;To create a local branch for your changes and restore the &#39;master&#39; branch, run:&quot;);
507                 System.err.println(&quot;&quot;);
508                 System.err.println(&quot;    git checkout -b NAME-FOR-YOUR-LOCAL-BRANCH&quot;);
509                 System.err.println(&quot;    git branch --force master origin/master&quot;);
510                 System.err.println(&quot;&quot;);
511                 System.exit(1);
512             }
513 
</pre>
<hr />
<pre>
562                 System.err.println(&quot;error: there are uncommitted changes in your working tree:&quot;);
563                 System.err.println(&quot;&quot;);
564                 for (var patch : diff.patches()) {
565                     var path = patch.target().path().isPresent() ?
566                         patch.target().path().get() : patch.source().path().get();
567                     System.err.println(&quot;    &quot; + patch.status().toString() + &quot; &quot; + path.toString());
568                 }
569                 System.err.println(&quot;&quot;);
570                 System.err.println(&quot;If these changes are meant to be part of the pull request, run:&quot;);
571                 System.err.println(&quot;&quot;);
572                 System.err.println(&quot;    git commit -am &#39;Forgot to add some changes&#39;&quot;);
573                 System.err.println(&quot;&quot;);
574                 System.err.println(&quot;If these changes are *not* meant to be part of the pull request, run:&quot;);
575                 System.err.println(&quot;&quot;);
576                 System.err.println(&quot;    git stash&quot;);
577                 System.err.println(&quot;&quot;);
578                 System.err.println(&quot;(You can later restore the changes by running: git stash pop)&quot;);
579                 System.exit(1);
580             }
581 
<span class="line-modified">582             var remoteRepo = host.get().repository(projectName(uri)).orElseThrow(() -&gt;</span>
583                     new IOException(&quot;Could not find repository at &quot; + uri.toString())
584             );
585             if (token == null) {
586                 GitCredentials.approve(credentials);
587             }
588             var parentRepo = remoteRepo.parent().orElseThrow(() -&gt;
589                     new IOException(&quot;error: remote repository &quot; + remotePullPath + &quot; is not a fork of any repository&quot;));
590 
591             var file = Files.createTempFile(&quot;PULL_REQUEST_&quot;, &quot;.txt&quot;);
592             if (commits.size() == 1) {
593                 var commit = commits.get(0);
594                 var message = CommitMessageParsers.v1.parse(commit.message());
595                 Files.writeString(file, message.title() + &quot;\n&quot;);
596                 if (!message.summaries().isEmpty()) {
597                     Files.write(file, message.summaries(), StandardOpenOption.APPEND);
598                 }
599                 if (!message.additional().isEmpty()) {
600                     Files.write(file, message.additional(), StandardOpenOption.APPEND);
601                 }
602             } else {
</pre>
<hr />
<pre>
632             if (isEmpty) {
633                 System.err.println(&quot;error: no message present, aborting&quot;);
634                 System.exit(1);
635             }
636 
637             var title = lines.get(0);
638             List&lt;String&gt; body = null;
639             if (lines.size() &gt; 1) {
640                 body = lines.subList(1, lines.size())
641                             .stream()
642                             .dropWhile(String::isEmpty)
643                             .collect(Collectors.toList());
644             } else {
645                 body = Collections.emptyList();
646             }
647 
648             var pr = remoteRepo.createPullRequest(parentRepo, targetBranch, currentBranch.name(), title, body);
649             if (arguments.contains(&quot;assignees&quot;)) {
650                 var usernames = Arrays.asList(arguments.get(&quot;assignees&quot;).asString().split(&quot;,&quot;));
651                 var assignees = usernames.stream()
<span class="line-modified">652                                          .map(u -&gt; host.get().user(u))</span>
653                                          .collect(Collectors.toList());
654                 pr.setAssignees(assignees);
655             }
656             System.out.println(pr.webUrl().toString());
657             Files.deleteIfExists(file);
658         } else if (action.equals(&quot;integrate&quot;) || action.equals(&quot;approve&quot;)) {
<span class="line-modified">659             var pr = getPullRequest(uri, credentials, arguments.at(1));</span>
660 
661             if (action.equals(&quot;integrate&quot;)) {
662                 pr.addComment(&quot;/integrate&quot;);
663             } else if (action.equals(&quot;approve&quot;)) {
664                 pr.addReview(Review.Verdict.APPROVED, &quot;Looks good!&quot;);
665             } else {
666                 throw new IllegalStateException(&quot;unexpected action: &quot; + action);
667             }
668         } else if (action.equals(&quot;list&quot;)) {
<span class="line-modified">669             var remoteRepo = getHostedRepositoryFor(uri, credentials);</span>
670             var prs = remoteRepo.pullRequests();
671 
672             var ids = new ArrayList&lt;String&gt;();
673             var titles = new ArrayList&lt;String&gt;();
674             var authors = new ArrayList&lt;String&gt;();
675             var assignees = new ArrayList&lt;String&gt;();
676             var labels = new ArrayList&lt;String&gt;();
677 
678             var filterAuthors = arguments.contains(&quot;authors&quot;) ?
679                 new HashSet&lt;&gt;(Arrays.asList(arguments.get(&quot;authors&quot;).asString().split(&quot;,&quot;))) :
680                 Set.of();
681             var filterAssignees = arguments.contains(&quot;assignees&quot;) ?
682                 Arrays.asList(arguments.get(&quot;assignees&quot;).asString().split(&quot;,&quot;)) :
683                 Set.of();
684             var filterLabels = arguments.contains(&quot;labels&quot;) ?
685                 Arrays.asList(arguments.get(&quot;labels&quot;).asString().split(&quot;,&quot;)) :
686                 Set.of();
687 
688             var defaultColumns = List.of(&quot;id&quot;, &quot;title&quot;, &quot;authors&quot;, &quot;assignees&quot;, &quot;labels&quot;);
689             var columnValues = Map.of(defaultColumns.get(0), ids,
</pre>
<hr />
<pre>
741             if (!ids.isEmpty() &amp;&amp; !arguments.contains(&quot;no-decoration&quot;)) {
742                 var upperCase = columns.stream()
743                                        .map(String::toUpperCase)
744                                        .collect(Collectors.toList());
745                 System.out.format(fmt, (Object[]) upperCase.toArray(new String[0]));
746             }
747             for (var i = 0; i &lt; ids.size(); i++) {
748                 final int n = i;
749                 var row = columns.stream()
750                                  .map(columnValues::get)
751                                  .map(values -&gt; values.get(n))
752                                  .collect(Collectors.toList());
753                 System.out.format(fmt, (Object[]) row.toArray(new String[0]));
754             }
755         } else if (action.equals(&quot;fetch&quot;) || action.equals(&quot;checkout&quot;) || action.equals(&quot;show&quot;) || action.equals(&quot;apply&quot;)) {
756             var prId = arguments.at(1);
757             if (!prId.isPresent()) {
758                 exit(&quot;error: missing pull request identifier&quot;);
759             }
760 
<span class="line-modified">761             var remoteRepo = getHostedRepositoryFor(uri, credentials);</span>
762             var pr = remoteRepo.pullRequest(prId.asString());
763             var repoUrl = remoteRepo.webUrl();
764             var prHeadRef = pr.sourceRef();
765             var isHgGit = isMercurial &amp;&amp; Repository.exists(repo.root().resolve(&quot;.hg&quot;).resolve(&quot;git&quot;));
766             if (isHgGit) {
767                 var hgGitRepo = Repository.get(repo.root().resolve(&quot;.hg&quot;).resolve(&quot;git&quot;)).get();
768                 var hgGitFetchHead = hgGitRepo.fetch(repoUrl, prHeadRef);
769 
770                 if (action.equals(&quot;show&quot;) || action.equals(&quot;apply&quot;)) {
771                     var target = hgGitRepo.fetch(repoUrl, pr.targetRef());
772                     var hgGitMergeBase = hgGitRepo.mergeBase(target, hgGitFetchHead);
773 
774                     if (action.equals(&quot;show&quot;)) {
775                         show(hgGitMergeBase.hex(), hgGitFetchHead, hgGitRepo.root());
776                     } else {
777                         var patch = diff(hgGitMergeBase.hex(), hgGitFetchHead, hgGitRepo.root());
778                         hgImport(patch);
779                         Files.delete(patch);
780                     }
781                 } else if (action.equals(&quot;fetch&quot;) || action.equals(&quot;checkout&quot;)) {
</pre>
<hr />
<pre>
815                 if (arguments.contains(&quot;branch&quot;)) {
816                     var branchName = arguments.get(&quot;branch&quot;).asString();
817                     var branch = repo.branch(fetchHead, branchName);
818                     repo.checkout(branch, false);
819                 } else {
820                     repo.checkout(fetchHead, false);
821                 }
822             } else if (action.equals(&quot;show&quot;)) {
823                 show(pr.targetRef(), fetchHead);
824             } else if (action.equals(&quot;apply&quot;)) {
825                 var patch = diff(pr.targetRef(), fetchHead);
826                 apply(patch);
827                 Files.deleteIfExists(patch);
828             }
829         } else if (action.equals(&quot;close&quot;)) {
830             var prId = arguments.at(1);
831             if (!prId.isPresent()) {
832                 exit(&quot;error: missing pull request identifier&quot;);
833             }
834 
<span class="line-modified">835             var remoteRepo = getHostedRepositoryFor(uri, credentials);</span>
836             var pr = remoteRepo.pullRequest(prId.asString());
837             pr.setState(PullRequest.State.CLOSED);
838         } else if (action.equals(&quot;update&quot;)) {
839             var prId = arguments.at(1);
840             if (!prId.isPresent()) {
841                 exit(&quot;error: missing pull request identifier&quot;);
842             }
843 
<span class="line-modified">844             var remoteRepo = getHostedRepositoryFor(uri, credentials);</span>
845             var pr = remoteRepo.pullRequest(prId.asString());
846             if (arguments.contains(&quot;assignees&quot;)) {
847                 var usernames = Arrays.asList(arguments.get(&quot;assignees&quot;).asString().split(&quot;,&quot;));
848                 var assignees = usernames.stream()
<span class="line-modified">849                     .map(u -&gt; host.get().user(u))</span>
850                     .collect(Collectors.toList());
851                 pr.setAssignees(assignees);
852             }
853         } else {
854             exit(&quot;error: unexpected action: &quot; + action);
855         }
856     }
857 }
</pre>
</td>
<td>
<hr />
<pre>
 83         }
 84 
 85         var pb = new ProcessBuilder(editor, file.toString());
 86         pb.inheritIO();
 87         var p = pb.start();
 88         try {
 89             return p.waitFor() == 0;
 90         } catch (InterruptedException e) {
 91             throw new IOException(e);
 92         }
 93     }
 94 
 95     private static String projectName(URI uri) {
 96         var name = uri.getPath().toString().substring(1);
 97         if (name.endsWith(&quot;.git&quot;)) {
 98             name = name.substring(0, name.length() - &quot;.git&quot;.length());
 99         }
100         return name;
101     }
102 
<span class="line-modified">103     private static HostedRepository getHostedRepositoryFor(URI uri, Forge host) throws IOException {</span>
<span class="line-modified">104         var remoteRepo = host.repository(projectName(uri)).orElseThrow(() -&gt;</span>







105                 new IOException(&quot;Could not find repository at: &quot; + uri.toString())
106         );
107         var parentRepo = remoteRepo.parent();
108         var targetRepo = parentRepo.isPresent() ? parentRepo.get() : remoteRepo;
109         return targetRepo;
110     }
111 
<span class="line-modified">112     private static PullRequest getPullRequest(URI uri, Forge host, Argument prId) throws IOException {</span>
113         if (!prId.isPresent()) {
114             exit(&quot;error: missing pull request identifier&quot;);
115         }
116 
<span class="line-modified">117         var pr = getHostedRepositoryFor(uri, host).pullRequest(prId.asString());</span>
118         if (pr == null) {
119             exit(&quot;error: could not fetch PR information&quot;);
120         }
121 
122         return pr;
123     }
124 
125     private static void show(String ref, Hash hash) throws IOException {
126         show(ref, hash, null);
127     }
128     private static void show(String ref, Hash hash, Path dir) throws IOException {
129         var pb = new ProcessBuilder(&quot;git&quot;, &quot;diff&quot;, &quot;--binary&quot;,
130                                                    &quot;--patch&quot;,
131                                                    &quot;--find-renames=50%&quot;,
132                                                    &quot;--find-copies=50%&quot;,
133                                                    &quot;--find-copies-harder&quot;,
134                                                    &quot;--abbrev&quot;,
135                                                    ref + &quot;...&quot; + hash.hex());
136         if (dir != null) {
137             pb.directory(dir.toFile());
</pre>
<hr />
<pre>
238                   .optional(),
239             Option.shortcut(&quot;&quot;)
240                   .fullname(&quot;assignees&quot;)
241                   .describe(&quot;LIST&quot;)
242                   .helptext(&quot;Comma separated list of assignees&quot;)
243                   .optional(),
244             Option.shortcut(&quot;&quot;)
245                   .fullname(&quot;labels&quot;)
246                   .describe(&quot;LIST&quot;)
247                   .helptext(&quot;Comma separated list of labels&quot;)
248                   .optional(),
249             Option.shortcut(&quot;&quot;)
250                   .fullname(&quot;columns&quot;)
251                   .describe(&quot;id,title,author,assignees,labels&quot;)
252                   .helptext(&quot;Comma separated list of columns to show&quot;)
253                   .optional(),
254             Switch.shortcut(&quot;&quot;)
255                   .fullname(&quot;no-decoration&quot;)
256                   .helptext(&quot;Hide any decorations when listing PRs&quot;)
257                   .optional(),
<span class="line-added">258             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">259                   .fullname(&quot;no-token&quot;)</span>
<span class="line-added">260                   .helptext(&quot;Do not use a personal access token (PAT). Only works for read-only operations.&quot;)</span>
<span class="line-added">261                   .optional(),</span>
262             Switch.shortcut(&quot;&quot;)
263                   .fullname(&quot;mercurial&quot;)
264                   .helptext(&quot;Force use of Mercurial (hg)&quot;)
265                   .optional(),
266             Switch.shortcut(&quot;&quot;)
267                   .fullname(&quot;verbose&quot;)
268                   .helptext(&quot;Turn on verbose output&quot;)
269                   .optional(),
270             Switch.shortcut(&quot;&quot;)
271                   .fullname(&quot;debug&quot;)
272                   .helptext(&quot;Turn on debugging output&quot;)
273                   .optional(),
274             Switch.shortcut(&quot;&quot;)
275                   .fullname(&quot;version&quot;)
276                   .helptext(&quot;Print the version of this tool&quot;)
277                   .optional());
278 
279         var inputs = List.of(
280             Input.position(0)
281                  .describe(&quot;list|fetch|show|checkout|apply|integrate|approve|create|close|update&quot;)
</pre>
<hr />
<pre>
293         if (arguments.contains(&quot;version&quot;)) {
294             System.out.println(&quot;git-pr version: &quot; + Version.fromManifest().orElse(&quot;unknown&quot;));
295             System.exit(0);
296         }
297 
298         if (arguments.contains(&quot;verbose&quot;) || arguments.contains(&quot;debug&quot;)) {
299             var level = arguments.contains(&quot;debug&quot;) ? Level.FINER : Level.FINE;
300             Logging.setup(level);
301         }
302 
303         HttpProxy.setup();
304 
305         var isMercurial = arguments.contains(&quot;mercurial&quot;);
306         var cwd = Path.of(&quot;&quot;).toAbsolutePath();
307         var repo = Repository.get(cwd).orElseThrow(() -&gt; new IOException(&quot;no git repository found at &quot; + cwd.toString()));
308         var remote = arguments.get(&quot;remote&quot;).orString(isMercurial ? &quot;default&quot; : &quot;origin&quot;);
309         var remotePullPath = repo.pullPath(remote);
310         var username = arguments.contains(&quot;username&quot;) ? arguments.get(&quot;username&quot;).asString() : null;
311         var token = isMercurial ? System.getenv(&quot;HG_TOKEN&quot;) :  System.getenv(&quot;GIT_TOKEN&quot;);
312         var uri = Remote.toWebURI(remotePullPath);
<span class="line-modified">313         var shouldUseToken = !arguments.contains(&quot;no-token&quot;);</span>
<span class="line-modified">314         var credentials = !shouldUseToken ?</span>
<span class="line-modified">315             null :</span>
<span class="line-modified">316             GitCredentials.fill(uri.getHost(), uri.getPath(), username, token, uri.getScheme());</span>
<span class="line-added">317         var forgeURI = URI.create(uri.getScheme() + &quot;://&quot; + uri.getHost());</span>
<span class="line-added">318         var forge = credentials == null ?</span>
<span class="line-added">319             Forge.from(forgeURI) :</span>
<span class="line-added">320             Forge.from(forgeURI, new Credential(credentials.username(), credentials.password()));</span>
<span class="line-added">321         if (forge.isEmpty() || !forge.get().isValid()) {</span>
<span class="line-added">322             if (!shouldUseToken) {</span>
<span class="line-added">323                 if (arguments.contains(&quot;verbose&quot;)) {</span>
<span class="line-added">324                     System.err.println(&quot;&quot;);</span>
<span class="line-added">325                 }</span>
<span class="line-added">326                 System.err.println(&quot;warning: using git-pr with --no-token may result in rate limiting from &quot; + forgeURI);</span>
<span class="line-added">327                 if (!arguments.contains(&quot;verbose&quot;)) {</span>
<span class="line-added">328                     System.err.println(&quot;         Re-run git-pr with --verbose to see if you are being rate limited&quot;);</span>
<span class="line-added">329                     System.err.println(&quot;&quot;);</span>
<span class="line-added">330                 }</span>
<span class="line-added">331             }</span>
<span class="line-added">332             exit(&quot;error: failed to connect to host: &quot; + forgeURI);</span>
333         }
<span class="line-added">334         var host = forge.get();</span>
335 
336         var action = arguments.at(0).asString();
<span class="line-added">337         if (!shouldUseToken &amp;&amp;</span>
<span class="line-added">338             !List.of(&quot;list&quot;, &quot;fetch&quot;, &quot;show&quot;, &quot;checkout&quot;, &quot;apply&quot;).contains(action)) {</span>
<span class="line-added">339             System.err.println(&quot;error: --no-token can only be used with read-only operations&quot;);</span>
<span class="line-added">340             System.exit(1);</span>
<span class="line-added">341         }</span>
<span class="line-added">342 </span>
343         if (action.equals(&quot;create&quot;)) {
344             if (isMercurial) {
345                 var currentBookmark = repo.currentBookmark();
346                 if (!currentBookmark.isPresent()) {
347                     System.err.println(&quot;error: no bookmark is active, you must be on an active bookmark&quot;);
348                     System.err.println(&quot;&quot;);
349                     System.err.println(&quot;To create a bookmark and activate it, run:&quot;);
350                     System.err.println(&quot;&quot;);
351                     System.err.println(&quot;    hg bookmark NAME-FOR-YOUR-BOOKMARK&quot;);
352                     System.err.println(&quot;&quot;);
353                     System.exit(1);
354                 }
355 
356                 var bookmark = currentBookmark.get();
357                 if (bookmark.equals(new Bookmark(&quot;master&quot;))) {
358                     System.err.println(&quot;error: you should not create pull requests from the &#39;master&#39; bookmark&quot;);
359                     System.err.println(&quot;To create a bookmark and activate it, run:&quot;);
360                     System.err.println(&quot;&quot;);
361                     System.err.println(&quot;    hg bookmark NAME-FOR-YOUR-BOOKMARK&quot;);
362                     System.err.println(&quot;&quot;);
</pre>
<hr />
<pre>
423                         var path = patch.target().path().isPresent() ?
424                             patch.target().path().get() : patch.source().path().get();
425                         System.err.println(&quot;    &quot; + patch.status().toString() + &quot; &quot; + path.toString());
426                     }
427                     System.err.println(&quot;&quot;);
428                     System.err.println(&quot;If these changes are meant to be part of the pull request, run:&quot;);
429                     System.err.println(&quot;&quot;);
430                     System.err.println(&quot;    hg commit --amend&quot;);
431                     System.err.println(&quot;    hg git-cleanup&quot;);
432                     System.err.println(&quot;    hg push --bookmark &quot; + bookmark.name() + &quot; &lt;PATH&gt;&quot;);
433                     System.err.println(&quot;    hg gimport&quot;);
434                     System.err.println(&quot;&quot;);
435                     System.err.println(&quot;If these changes are *not* meant to be part of the pull request, run:&quot;);
436                     System.err.println(&quot;&quot;);
437                     System.err.println(&quot;    hg shelve&quot;);
438                     System.err.println(&quot;&quot;);
439                     System.err.println(&quot;(You can later restore the changes by running: hg unshelve)&quot;);
440                     System.exit(1);
441                 }
442 
<span class="line-modified">443                 var remoteRepo = host.repository(projectName(uri)).orElseThrow(() -&gt;</span>
444                         new IOException(&quot;Could not find repository at &quot; + uri.toString())
445                 );
446                 if (token == null) {
447                     GitCredentials.approve(credentials);
448                 }
449                 var parentRepo = remoteRepo.parent().orElseThrow(() -&gt;
450                         new IOException(&quot;error: remote repository &quot; + remotePullPath + &quot; is not a fork of any repository&quot;));
451 
452                 var file = Files.createTempFile(&quot;PULL_REQUEST_&quot;, &quot;.txt&quot;);
453                 if (commits.size() == 1) {
454                     var commit = commits.get(0);
455                     var message = CommitMessageParsers.v1.parse(commit.message());
456                     Files.writeString(file, message.title() + &quot;\n&quot;);
457                     if (!message.summaries().isEmpty()) {
458                         Files.write(file, message.summaries(), StandardOpenOption.APPEND);
459                     }
460                     if (!message.additional().isEmpty()) {
461                         Files.write(file, message.additional(), StandardOpenOption.APPEND);
462                     }
463                 } else {
</pre>
<hr />
<pre>
493                 if (isEmpty) {
494                     System.err.println(&quot;error: no message present, aborting&quot;);
495                     System.exit(1);
496                 }
497 
498                 var title = lines.get(0);
499                 List&lt;String&gt; body = null;
500                 if (lines.size() &gt; 1) {
501                     body = lines.subList(1, lines.size())
502                                 .stream()
503                                 .dropWhile(String::isEmpty)
504                                 .collect(Collectors.toList());
505                 } else {
506                     body = Collections.emptyList();
507                 }
508 
509                 var pr = remoteRepo.createPullRequest(parentRepo, targetBranch, bookmark.name(), title, body);
510                 if (arguments.contains(&quot;assignees&quot;)) {
511                     var usernames = Arrays.asList(arguments.get(&quot;assignees&quot;).asString().split(&quot;,&quot;));
512                     var assignees = usernames.stream()
<span class="line-modified">513                                              .map(u -&gt; host.user(u))</span>
514                                              .collect(Collectors.toList());
515                     pr.setAssignees(assignees);
516                 }
517                 System.out.println(pr.webUrl().toString());
518                 Files.deleteIfExists(file);
519 
520                 System.exit(0);
521             }
522             var currentBranch = repo.currentBranch();
523             if (currentBranch.equals(repo.defaultBranch())) {
524                 System.err.println(&quot;error: you should not create pull requests from the &#39;master&#39; branch&quot;);
525                 System.err.println(&quot;&quot;);
526                 System.err.println(&quot;To create a local branch for your changes and restore the &#39;master&#39; branch, run:&quot;);
527                 System.err.println(&quot;&quot;);
528                 System.err.println(&quot;    git checkout -b NAME-FOR-YOUR-LOCAL-BRANCH&quot;);
529                 System.err.println(&quot;    git branch --force master origin/master&quot;);
530                 System.err.println(&quot;&quot;);
531                 System.exit(1);
532             }
533 
</pre>
<hr />
<pre>
582                 System.err.println(&quot;error: there are uncommitted changes in your working tree:&quot;);
583                 System.err.println(&quot;&quot;);
584                 for (var patch : diff.patches()) {
585                     var path = patch.target().path().isPresent() ?
586                         patch.target().path().get() : patch.source().path().get();
587                     System.err.println(&quot;    &quot; + patch.status().toString() + &quot; &quot; + path.toString());
588                 }
589                 System.err.println(&quot;&quot;);
590                 System.err.println(&quot;If these changes are meant to be part of the pull request, run:&quot;);
591                 System.err.println(&quot;&quot;);
592                 System.err.println(&quot;    git commit -am &#39;Forgot to add some changes&#39;&quot;);
593                 System.err.println(&quot;&quot;);
594                 System.err.println(&quot;If these changes are *not* meant to be part of the pull request, run:&quot;);
595                 System.err.println(&quot;&quot;);
596                 System.err.println(&quot;    git stash&quot;);
597                 System.err.println(&quot;&quot;);
598                 System.err.println(&quot;(You can later restore the changes by running: git stash pop)&quot;);
599                 System.exit(1);
600             }
601 
<span class="line-modified">602             var remoteRepo = host.repository(projectName(uri)).orElseThrow(() -&gt;</span>
603                     new IOException(&quot;Could not find repository at &quot; + uri.toString())
604             );
605             if (token == null) {
606                 GitCredentials.approve(credentials);
607             }
608             var parentRepo = remoteRepo.parent().orElseThrow(() -&gt;
609                     new IOException(&quot;error: remote repository &quot; + remotePullPath + &quot; is not a fork of any repository&quot;));
610 
611             var file = Files.createTempFile(&quot;PULL_REQUEST_&quot;, &quot;.txt&quot;);
612             if (commits.size() == 1) {
613                 var commit = commits.get(0);
614                 var message = CommitMessageParsers.v1.parse(commit.message());
615                 Files.writeString(file, message.title() + &quot;\n&quot;);
616                 if (!message.summaries().isEmpty()) {
617                     Files.write(file, message.summaries(), StandardOpenOption.APPEND);
618                 }
619                 if (!message.additional().isEmpty()) {
620                     Files.write(file, message.additional(), StandardOpenOption.APPEND);
621                 }
622             } else {
</pre>
<hr />
<pre>
652             if (isEmpty) {
653                 System.err.println(&quot;error: no message present, aborting&quot;);
654                 System.exit(1);
655             }
656 
657             var title = lines.get(0);
658             List&lt;String&gt; body = null;
659             if (lines.size() &gt; 1) {
660                 body = lines.subList(1, lines.size())
661                             .stream()
662                             .dropWhile(String::isEmpty)
663                             .collect(Collectors.toList());
664             } else {
665                 body = Collections.emptyList();
666             }
667 
668             var pr = remoteRepo.createPullRequest(parentRepo, targetBranch, currentBranch.name(), title, body);
669             if (arguments.contains(&quot;assignees&quot;)) {
670                 var usernames = Arrays.asList(arguments.get(&quot;assignees&quot;).asString().split(&quot;,&quot;));
671                 var assignees = usernames.stream()
<span class="line-modified">672                                          .map(u -&gt; host.user(u))</span>
673                                          .collect(Collectors.toList());
674                 pr.setAssignees(assignees);
675             }
676             System.out.println(pr.webUrl().toString());
677             Files.deleteIfExists(file);
678         } else if (action.equals(&quot;integrate&quot;) || action.equals(&quot;approve&quot;)) {
<span class="line-modified">679             var pr = getPullRequest(uri, host, arguments.at(1));</span>
680 
681             if (action.equals(&quot;integrate&quot;)) {
682                 pr.addComment(&quot;/integrate&quot;);
683             } else if (action.equals(&quot;approve&quot;)) {
684                 pr.addReview(Review.Verdict.APPROVED, &quot;Looks good!&quot;);
685             } else {
686                 throw new IllegalStateException(&quot;unexpected action: &quot; + action);
687             }
688         } else if (action.equals(&quot;list&quot;)) {
<span class="line-modified">689             var remoteRepo = getHostedRepositoryFor(uri, host);</span>
690             var prs = remoteRepo.pullRequests();
691 
692             var ids = new ArrayList&lt;String&gt;();
693             var titles = new ArrayList&lt;String&gt;();
694             var authors = new ArrayList&lt;String&gt;();
695             var assignees = new ArrayList&lt;String&gt;();
696             var labels = new ArrayList&lt;String&gt;();
697 
698             var filterAuthors = arguments.contains(&quot;authors&quot;) ?
699                 new HashSet&lt;&gt;(Arrays.asList(arguments.get(&quot;authors&quot;).asString().split(&quot;,&quot;))) :
700                 Set.of();
701             var filterAssignees = arguments.contains(&quot;assignees&quot;) ?
702                 Arrays.asList(arguments.get(&quot;assignees&quot;).asString().split(&quot;,&quot;)) :
703                 Set.of();
704             var filterLabels = arguments.contains(&quot;labels&quot;) ?
705                 Arrays.asList(arguments.get(&quot;labels&quot;).asString().split(&quot;,&quot;)) :
706                 Set.of();
707 
708             var defaultColumns = List.of(&quot;id&quot;, &quot;title&quot;, &quot;authors&quot;, &quot;assignees&quot;, &quot;labels&quot;);
709             var columnValues = Map.of(defaultColumns.get(0), ids,
</pre>
<hr />
<pre>
761             if (!ids.isEmpty() &amp;&amp; !arguments.contains(&quot;no-decoration&quot;)) {
762                 var upperCase = columns.stream()
763                                        .map(String::toUpperCase)
764                                        .collect(Collectors.toList());
765                 System.out.format(fmt, (Object[]) upperCase.toArray(new String[0]));
766             }
767             for (var i = 0; i &lt; ids.size(); i++) {
768                 final int n = i;
769                 var row = columns.stream()
770                                  .map(columnValues::get)
771                                  .map(values -&gt; values.get(n))
772                                  .collect(Collectors.toList());
773                 System.out.format(fmt, (Object[]) row.toArray(new String[0]));
774             }
775         } else if (action.equals(&quot;fetch&quot;) || action.equals(&quot;checkout&quot;) || action.equals(&quot;show&quot;) || action.equals(&quot;apply&quot;)) {
776             var prId = arguments.at(1);
777             if (!prId.isPresent()) {
778                 exit(&quot;error: missing pull request identifier&quot;);
779             }
780 
<span class="line-modified">781             var remoteRepo = getHostedRepositoryFor(uri, host);</span>
782             var pr = remoteRepo.pullRequest(prId.asString());
783             var repoUrl = remoteRepo.webUrl();
784             var prHeadRef = pr.sourceRef();
785             var isHgGit = isMercurial &amp;&amp; Repository.exists(repo.root().resolve(&quot;.hg&quot;).resolve(&quot;git&quot;));
786             if (isHgGit) {
787                 var hgGitRepo = Repository.get(repo.root().resolve(&quot;.hg&quot;).resolve(&quot;git&quot;)).get();
788                 var hgGitFetchHead = hgGitRepo.fetch(repoUrl, prHeadRef);
789 
790                 if (action.equals(&quot;show&quot;) || action.equals(&quot;apply&quot;)) {
791                     var target = hgGitRepo.fetch(repoUrl, pr.targetRef());
792                     var hgGitMergeBase = hgGitRepo.mergeBase(target, hgGitFetchHead);
793 
794                     if (action.equals(&quot;show&quot;)) {
795                         show(hgGitMergeBase.hex(), hgGitFetchHead, hgGitRepo.root());
796                     } else {
797                         var patch = diff(hgGitMergeBase.hex(), hgGitFetchHead, hgGitRepo.root());
798                         hgImport(patch);
799                         Files.delete(patch);
800                     }
801                 } else if (action.equals(&quot;fetch&quot;) || action.equals(&quot;checkout&quot;)) {
</pre>
<hr />
<pre>
835                 if (arguments.contains(&quot;branch&quot;)) {
836                     var branchName = arguments.get(&quot;branch&quot;).asString();
837                     var branch = repo.branch(fetchHead, branchName);
838                     repo.checkout(branch, false);
839                 } else {
840                     repo.checkout(fetchHead, false);
841                 }
842             } else if (action.equals(&quot;show&quot;)) {
843                 show(pr.targetRef(), fetchHead);
844             } else if (action.equals(&quot;apply&quot;)) {
845                 var patch = diff(pr.targetRef(), fetchHead);
846                 apply(patch);
847                 Files.deleteIfExists(patch);
848             }
849         } else if (action.equals(&quot;close&quot;)) {
850             var prId = arguments.at(1);
851             if (!prId.isPresent()) {
852                 exit(&quot;error: missing pull request identifier&quot;);
853             }
854 
<span class="line-modified">855             var remoteRepo = getHostedRepositoryFor(uri, host);</span>
856             var pr = remoteRepo.pullRequest(prId.asString());
857             pr.setState(PullRequest.State.CLOSED);
858         } else if (action.equals(&quot;update&quot;)) {
859             var prId = arguments.at(1);
860             if (!prId.isPresent()) {
861                 exit(&quot;error: missing pull request identifier&quot;);
862             }
863 
<span class="line-modified">864             var remoteRepo = getHostedRepositoryFor(uri, host);</span>
865             var pr = remoteRepo.pullRequest(prId.asString());
866             if (arguments.contains(&quot;assignees&quot;)) {
867                 var usernames = Arrays.asList(arguments.get(&quot;assignees&quot;).asString().split(&quot;,&quot;));
868                 var assignees = usernames.stream()
<span class="line-modified">869                     .map(u -&gt; host.user(u))</span>
870                     .collect(Collectors.toList());
871                 pr.setAssignees(assignees);
872             }
873         } else {
874             exit(&quot;error: unexpected action: &quot; + action);
875         }
876     }
877 }
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../forge/src/main/java/org/openjdk/skara/forge/github/GitHubHost.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>