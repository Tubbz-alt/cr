<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/ArchiveMessages.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/ArchiveMessages.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 45     private static String quoteBody(String body) {
 46         return Arrays.stream(body.strip().split(&quot;\\R&quot;))
 47                      .map(line -&gt; line.length() &gt; 0 ? line.charAt(0) == &#39;&gt;&#39; ? &quot;&gt;&quot; + line : &quot;&gt; &quot; + line : &quot;&gt; &quot;)
 48                      .collect(Collectors.joining(&quot;\n&quot;));
 49     }
 50 
 51     private static String replyFooter(PullRequestInstance prInstance) {
 52         return &quot;PR: &quot; + prInstance.pr().getWebUrl();
 53     }
 54 
 55     static String composeConversation(PullRequestInstance prInstance, URI webrev) {
 56         var commitMessages = prInstance.formatCommitMessages(prInstance.baseHash(), prInstance.headHash(), ArchiveMessages::formatCommit);
 57         var filteredBody = filterComments(prInstance.pr().getBody());
 58         if (filteredBody.isEmpty()) {
 59             filteredBody = prInstance.pr().getTitle().strip();
 60         }
 61         return filteredBody + &quot;\n\n&quot; +
 62                 infoSeparator + &quot;\n\n&quot; +
 63                 &quot;Commits:\n&quot; +
 64                 commitMessages + &quot;\n\n&quot; +
<span class="line-removed"> 65                 &quot;  Stats: &quot; + prInstance.stats(prInstance.baseHash(), prInstance.headHash()) + &quot;\n&quot; +</span>
 66                 &quot;Changes: &quot; + prInstance.changeUrl() + &quot;\n&quot; +
 67                 &quot; Webrev: &quot; + webrev.toString() + &quot;\n&quot; +

 68                 &quot;  Patch: &quot; + prInstance.diffUrl() + &quot;\n&quot; +
 69                 &quot;  Fetch: &quot; + prInstance.fetchCommand() + &quot;\n\n&quot; +
 70                 replyFooter(prInstance);
 71     }
 72 
 73     static String composeRebaseComment(PullRequestInstance prInstance, URI fullWebrev) {
 74         var commitMessages = prInstance.formatCommitMessages(prInstance.baseHash(), prInstance.headHash(), ArchiveMessages::formatCommit);
 75         return &quot;The pull request has been updated with a complete new set of changes (possibly due to a rebase).\n\n&quot; +
 76                 infoSeparator + &quot;\n\n&quot; +
 77                 &quot;Commits:\n&quot; +
 78                 commitMessages + &quot;\n\n&quot; +
<span class="line-removed"> 79                 &quot;  Stats: &quot; + prInstance.stats(prInstance.baseHash(), prInstance.headHash()) + &quot;\n&quot; +</span>
 80                 &quot;Changes: &quot; + prInstance.changeUrl() + &quot;\n&quot; +
 81                 &quot; Webrev: &quot; + fullWebrev.toString() + &quot;\n&quot; +

 82                 &quot;  Patch: &quot; + prInstance.diffUrl() + &quot;\n&quot; +
 83                 &quot;  Fetch: &quot; + prInstance.fetchCommand() + &quot;\n\n&quot; +
 84                 replyFooter(prInstance);    }
 85 
 86     static String composeIncrementalComment(Hash lastHead, PullRequestInstance prInstance, URI fullWebrev, URI incrementalWebrev) {
 87         var newCommitMessages = prInstance.formatCommitMessages(lastHead, prInstance.headHash(), ArchiveMessages::formatCommit);
 88         return &quot;The pull request has been updated with additional changes.\n\n&quot; +
 89                 infoSeparator + &quot;\n\n&quot; +
 90                 &quot;Added commits:\n&quot; +
 91                 newCommitMessages + &quot;\n\n&quot; +
<span class="line-modified"> 92                 &quot;  Stats: &quot; + prInstance.stats(lastHead, prInstance.headHash()) + &quot;\n&quot; +</span>
<span class="line-removed"> 93                 &quot;Changes:\n\n&quot; +</span>
 94                 &quot;  - all: &quot; + prInstance.pr().getWebUrl() + &quot;/files\n&quot; +
<span class="line-modified"> 95                 &quot;  - new: &quot; + prInstance.changeUrl(lastHead, prInstance.headHash()) + &quot;\n&quot; +</span>
 96                 &quot;Webrevs:\n&quot; +
 97                 &quot; - full: &quot; + fullWebrev.toString() + &quot;\n&quot; +
<span class="line-modified"> 98                 &quot; - incr: &quot; + incrementalWebrev.toString() + &quot;\n&quot; +</span>

 99                 &quot;  Patch: &quot; + prInstance.diffUrl() + &quot;\n&quot; +
100                 &quot;  Fetch: &quot; + prInstance.fetchCommand() + &quot;\n\n&quot; +
101                 replyFooter(prInstance);
102     }
103 
104     private static String filterParentBody(Email parent, PullRequestInstance prInstance) {
105         var parentFooter = ArchiveMessages.replyFooter(prInstance);
106         var filteredParentBody = parent.body().strip();
107         if (filteredParentBody.endsWith(parentFooter)) {
108             return filteredParentBody.substring(0, filteredParentBody.length() - parentFooter.length()).strip();
109         } else {
110             return filteredParentBody;
111         }
112     }
113 
114     static String composeReply(Email parent, String body, PullRequestInstance prInstance) {
115         return &quot;On &quot; + parent.date().format(DateTimeFormatter.RFC_1123_DATE_TIME) + &quot;, &quot; + parent.author().toString() + &quot; wrote:\n&quot; +
116                 &quot;\n&quot; +
117                 quoteBody(filterParentBody(parent, prInstance)) +
118                 &quot;\n\n&quot; +
</pre>
</td>
<td>
<hr />
<pre>
 45     private static String quoteBody(String body) {
 46         return Arrays.stream(body.strip().split(&quot;\\R&quot;))
 47                      .map(line -&gt; line.length() &gt; 0 ? line.charAt(0) == &#39;&gt;&#39; ? &quot;&gt;&quot; + line : &quot;&gt; &quot; + line : &quot;&gt; &quot;)
 48                      .collect(Collectors.joining(&quot;\n&quot;));
 49     }
 50 
 51     private static String replyFooter(PullRequestInstance prInstance) {
 52         return &quot;PR: &quot; + prInstance.pr().getWebUrl();
 53     }
 54 
 55     static String composeConversation(PullRequestInstance prInstance, URI webrev) {
 56         var commitMessages = prInstance.formatCommitMessages(prInstance.baseHash(), prInstance.headHash(), ArchiveMessages::formatCommit);
 57         var filteredBody = filterComments(prInstance.pr().getBody());
 58         if (filteredBody.isEmpty()) {
 59             filteredBody = prInstance.pr().getTitle().strip();
 60         }
 61         return filteredBody + &quot;\n\n&quot; +
 62                 infoSeparator + &quot;\n\n&quot; +
 63                 &quot;Commits:\n&quot; +
 64                 commitMessages + &quot;\n\n&quot; +

 65                 &quot;Changes: &quot; + prInstance.changeUrl() + &quot;\n&quot; +
 66                 &quot; Webrev: &quot; + webrev.toString() + &quot;\n&quot; +
<span class="line-added"> 67                 &quot;  Stats: &quot; + prInstance.stats(prInstance.baseHash(), prInstance.headHash()) + &quot;\n&quot; +</span>
 68                 &quot;  Patch: &quot; + prInstance.diffUrl() + &quot;\n&quot; +
 69                 &quot;  Fetch: &quot; + prInstance.fetchCommand() + &quot;\n\n&quot; +
 70                 replyFooter(prInstance);
 71     }
 72 
 73     static String composeRebaseComment(PullRequestInstance prInstance, URI fullWebrev) {
 74         var commitMessages = prInstance.formatCommitMessages(prInstance.baseHash(), prInstance.headHash(), ArchiveMessages::formatCommit);
 75         return &quot;The pull request has been updated with a complete new set of changes (possibly due to a rebase).\n\n&quot; +
 76                 infoSeparator + &quot;\n\n&quot; +
 77                 &quot;Commits:\n&quot; +
 78                 commitMessages + &quot;\n\n&quot; +

 79                 &quot;Changes: &quot; + prInstance.changeUrl() + &quot;\n&quot; +
 80                 &quot; Webrev: &quot; + fullWebrev.toString() + &quot;\n&quot; +
<span class="line-added"> 81                 &quot;  Stats: &quot; + prInstance.stats(prInstance.baseHash(), prInstance.headHash()) + &quot;\n&quot; +</span>
 82                 &quot;  Patch: &quot; + prInstance.diffUrl() + &quot;\n&quot; +
 83                 &quot;  Fetch: &quot; + prInstance.fetchCommand() + &quot;\n\n&quot; +
 84                 replyFooter(prInstance);    }
 85 
 86     static String composeIncrementalComment(Hash lastHead, PullRequestInstance prInstance, URI fullWebrev, URI incrementalWebrev) {
 87         var newCommitMessages = prInstance.formatCommitMessages(lastHead, prInstance.headHash(), ArchiveMessages::formatCommit);
 88         return &quot;The pull request has been updated with additional changes.\n\n&quot; +
 89                 infoSeparator + &quot;\n\n&quot; +
 90                 &quot;Added commits:\n&quot; +
 91                 newCommitMessages + &quot;\n\n&quot; +
<span class="line-modified"> 92                 &quot;Changes:\n&quot; +</span>

 93                 &quot;  - all: &quot; + prInstance.pr().getWebUrl() + &quot;/files\n&quot; +
<span class="line-modified"> 94                 &quot;  - new: &quot; + prInstance.changeUrl(lastHead, prInstance.headHash()) + &quot;\n\n&quot; +</span>
 95                 &quot;Webrevs:\n&quot; +
 96                 &quot; - full: &quot; + fullWebrev.toString() + &quot;\n&quot; +
<span class="line-modified"> 97                 &quot; - incr: &quot; + incrementalWebrev.toString() + &quot;\n\n&quot; +</span>
<span class="line-added"> 98                 &quot;  Stats: &quot; + prInstance.stats(lastHead, prInstance.headHash()) + &quot;\n&quot; +</span>
 99                 &quot;  Patch: &quot; + prInstance.diffUrl() + &quot;\n&quot; +
100                 &quot;  Fetch: &quot; + prInstance.fetchCommand() + &quot;\n\n&quot; +
101                 replyFooter(prInstance);
102     }
103 
104     private static String filterParentBody(Email parent, PullRequestInstance prInstance) {
105         var parentFooter = ArchiveMessages.replyFooter(prInstance);
106         var filteredParentBody = parent.body().strip();
107         if (filteredParentBody.endsWith(parentFooter)) {
108             return filteredParentBody.substring(0, filteredParentBody.length() - parentFooter.length()).strip();
109         } else {
110             return filteredParentBody;
111         }
112     }
113 
114     static String composeReply(Email parent, String body, PullRequestInstance prInstance) {
115         return &quot;On &quot; + parent.date().format(DateTimeFormatter.RFC_1123_DATE_TIME) + &quot;, &quot; + parent.author().toString() + &quot; wrote:\n&quot; +
116                 &quot;\n&quot; +
117                 quoteBody(filterParentBody(parent, prInstance)) +
118                 &quot;\n\n&quot; +
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>