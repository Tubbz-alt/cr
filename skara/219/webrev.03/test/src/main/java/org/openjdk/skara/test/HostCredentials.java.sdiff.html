<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff test/src/main/java/org/openjdk/skara/test/HostCredentials.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../../bots/pr/src/test/java/org/openjdk/skara/bots/pr/CheckTests.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="TestHost.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>test/src/main/java/org/openjdk/skara/test/HostCredentials.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
258     }
259 
260     public HostCredentials(TestInfo testInfo) throws IOException  {
261         HttpProxy.setup();
262 
263         var credentialsFile = System.getProperty(&quot;credentials&quot;);
264         testName = testInfo.getDisplayName();
265 
266         // If no credentials have been specified, use the test host implementation
267         if (credentialsFile == null) {
268             credentials = new TestCredentials();
269         } else {
270             var credentialsPath = Paths.get(credentialsFile);
271             var credentialsData = Files.readAllBytes(credentialsPath);
272             var credentialsJson = JSON.parse(new String(credentialsData, StandardCharsets.UTF_8));
273             credentials = parseEntry(credentialsJson.asObject(), credentialsPath.getParent());
274         }
275     }
276 
277     private boolean getLock(HostedRepository repo) throws IOException {




278         try (var tempFolder = new TemporaryDirectory()) {
279             var repoFolder = tempFolder.path().resolve(&quot;lock&quot;);
280             var lockFile = repoFolder.resolve(&quot;lock.txt&quot;);
281             Repository localRepo;
282             try {
283                 localRepo = Repository.materialize(repoFolder, repo.url(), &quot;testlock&quot;);
284             } catch (IOException e) {
285                 // If the branch does not exist, we&#39;ll try to create it
286                 localRepo = Repository.init(repoFolder, VCS.GIT);
287             }
288 
289             if (Files.exists(lockFile)) {
290                 var currentLock = Files.readString(lockFile, StandardCharsets.UTF_8).strip();
291                 var lockTime = ZonedDateTime.parse(currentLock, DateTimeFormatter.ISO_DATE_TIME);
292                 if (lockTime.isBefore(ZonedDateTime.now().minus(Duration.ofMinutes(10)))) {
293                     log.info(&quot;Stale lock encountered - overwriting it&quot;);
294                 } else {
295                     log.info(&quot;Active lock encountered - waiting&quot;);
296                     return false;
297                 }
298             }
299 
300             // The lock either doesn&#39;t exist or is stale, try to grab it
301             var lockHash = commitLock(localRepo);
302             localRepo.push(lockHash, repo.url(), &quot;testlock&quot;);
303             log.info(&quot;Obtained credentials lock&quot;);
304 
305             // If no exception occurs (such as the push fails), we have obtained the lock
306             return true;
307         }
308     }
309 
310     private void releaseLock(HostedRepository repo) throws IOException {



311         try (var tempFolder = new TemporaryDirectory()) {
312             var repoFolder = tempFolder.path().resolve(&quot;lock&quot;);
313             var lockFile = repoFolder.resolve(&quot;lock.txt&quot;);
314             Repository localRepo;
315             localRepo = Repository.materialize(repoFolder, repo.url(), &quot;testlock&quot;);
316             localRepo.remove(lockFile);
317             var lockHash = localRepo.commit(&quot;Unlock&quot;, &quot;test&quot;, &quot;test@test.test&quot;);
318             localRepo.push(lockHash, repo.url(), &quot;testlock&quot;);

319         }
320     }
321 
322     public Hash commitLock(Repository localRepo) throws IOException {
323         var lockFile = localRepo.root().resolve(&quot;lock.txt&quot;);
324         Files.writeString(lockFile, ZonedDateTime.now().format(DateTimeFormatter.ISO_DATE_TIME), StandardCharsets.UTF_8);
325         localRepo.add(lockFile);
326         var lockHash = localRepo.commit(&quot;Lock&quot;, &quot;test&quot;, &quot;test@test.test&quot;);
327         localRepo.branch(lockHash, &quot;testlock&quot;);
328         return lockHash;
329     }
330 
331     public HostedRepository getHostedRepository() {
332         var host = getRepositoryHost();
333         var repo = credentials.getHostedRepository(host);
334 
335         while (credentialsLock == null) {
336             try {
337                 if (getLock(repo)) {
338                     credentialsLock = repo;
</pre>
<hr />
<pre>
366         var issue = issueProject.createIssue(title, List.of());
367         issuesToBeClosed.add(issue);
368         return issue;
369     }
370 
371     public CensusBuilder getCensusBuilder() {
372         return CensusBuilder.create(credentials.getNamespaceName());
373     }
374 
375     @Override
376     public void close() {
377         for (var pr : pullRequestsToBeClosed) {
378             pr.setState(PullRequest.State.CLOSED);
379         }
380         for (var issue : issuesToBeClosed) {
381             issue.setState(Issue.State.CLOSED);
382         }
383         if (credentialsLock != null) {
384             try {
385                 releaseLock(credentialsLock);
<span class="line-removed">386                 log.info(&quot;Released credentials lock for &quot; + testName);</span>
387             } catch (IOException e) {
388                 throw new UncheckedIOException(e);
389             }
390             credentialsLock = null;
391         }
392 
393         credentials.close();
394     }
395 }
</pre>
</td>
<td>
<hr />
<pre>
258     }
259 
260     public HostCredentials(TestInfo testInfo) throws IOException  {
261         HttpProxy.setup();
262 
263         var credentialsFile = System.getProperty(&quot;credentials&quot;);
264         testName = testInfo.getDisplayName();
265 
266         // If no credentials have been specified, use the test host implementation
267         if (credentialsFile == null) {
268             credentials = new TestCredentials();
269         } else {
270             var credentialsPath = Paths.get(credentialsFile);
271             var credentialsData = Files.readAllBytes(credentialsPath);
272             var credentialsJson = JSON.parse(new String(credentialsData, StandardCharsets.UTF_8));
273             credentials = parseEntry(credentialsJson.asObject(), credentialsPath.getParent());
274         }
275     }
276 
277     private boolean getLock(HostedRepository repo) throws IOException {
<span class="line-added">278         if (repo instanceof TestHostedRepository) {</span>
<span class="line-added">279             return true;</span>
<span class="line-added">280         }</span>
<span class="line-added">281 </span>
282         try (var tempFolder = new TemporaryDirectory()) {
283             var repoFolder = tempFolder.path().resolve(&quot;lock&quot;);
284             var lockFile = repoFolder.resolve(&quot;lock.txt&quot;);
285             Repository localRepo;
286             try {
287                 localRepo = Repository.materialize(repoFolder, repo.url(), &quot;testlock&quot;);
288             } catch (IOException e) {
289                 // If the branch does not exist, we&#39;ll try to create it
290                 localRepo = Repository.init(repoFolder, VCS.GIT);
291             }
292 
293             if (Files.exists(lockFile)) {
294                 var currentLock = Files.readString(lockFile, StandardCharsets.UTF_8).strip();
295                 var lockTime = ZonedDateTime.parse(currentLock, DateTimeFormatter.ISO_DATE_TIME);
296                 if (lockTime.isBefore(ZonedDateTime.now().minus(Duration.ofMinutes(10)))) {
297                     log.info(&quot;Stale lock encountered - overwriting it&quot;);
298                 } else {
299                     log.info(&quot;Active lock encountered - waiting&quot;);
300                     return false;
301                 }
302             }
303 
304             // The lock either doesn&#39;t exist or is stale, try to grab it
305             var lockHash = commitLock(localRepo);
306             localRepo.push(lockHash, repo.url(), &quot;testlock&quot;);
307             log.info(&quot;Obtained credentials lock&quot;);
308 
309             // If no exception occurs (such as the push fails), we have obtained the lock
310             return true;
311         }
312     }
313 
314     private void releaseLock(HostedRepository repo) throws IOException {
<span class="line-added">315         if (repo instanceof TestHostedRepository) {</span>
<span class="line-added">316             return;</span>
<span class="line-added">317         }</span>
318         try (var tempFolder = new TemporaryDirectory()) {
319             var repoFolder = tempFolder.path().resolve(&quot;lock&quot;);
320             var lockFile = repoFolder.resolve(&quot;lock.txt&quot;);
321             Repository localRepo;
322             localRepo = Repository.materialize(repoFolder, repo.url(), &quot;testlock&quot;);
323             localRepo.remove(lockFile);
324             var lockHash = localRepo.commit(&quot;Unlock&quot;, &quot;test&quot;, &quot;test@test.test&quot;);
325             localRepo.push(lockHash, repo.url(), &quot;testlock&quot;);
<span class="line-added">326             log.info(&quot;Released credentials lock for &quot; + testName);</span>
327         }
328     }
329 
330     public Hash commitLock(Repository localRepo) throws IOException {
331         var lockFile = localRepo.root().resolve(&quot;lock.txt&quot;);
332         Files.writeString(lockFile, ZonedDateTime.now().format(DateTimeFormatter.ISO_DATE_TIME), StandardCharsets.UTF_8);
333         localRepo.add(lockFile);
334         var lockHash = localRepo.commit(&quot;Lock&quot;, &quot;test&quot;, &quot;test@test.test&quot;);
335         localRepo.branch(lockHash, &quot;testlock&quot;);
336         return lockHash;
337     }
338 
339     public HostedRepository getHostedRepository() {
340         var host = getRepositoryHost();
341         var repo = credentials.getHostedRepository(host);
342 
343         while (credentialsLock == null) {
344             try {
345                 if (getLock(repo)) {
346                     credentialsLock = repo;
</pre>
<hr />
<pre>
374         var issue = issueProject.createIssue(title, List.of());
375         issuesToBeClosed.add(issue);
376         return issue;
377     }
378 
379     public CensusBuilder getCensusBuilder() {
380         return CensusBuilder.create(credentials.getNamespaceName());
381     }
382 
383     @Override
384     public void close() {
385         for (var pr : pullRequestsToBeClosed) {
386             pr.setState(PullRequest.State.CLOSED);
387         }
388         for (var issue : issuesToBeClosed) {
389             issue.setState(Issue.State.CLOSED);
390         }
391         if (credentialsLock != null) {
392             try {
393                 releaseLock(credentialsLock);

394             } catch (IOException e) {
395                 throw new UncheckedIOException(e);
396             }
397             credentialsLock = null;
398         }
399 
400         credentials.close();
401     }
402 }
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../../bots/pr/src/test/java/org/openjdk/skara/bots/pr/CheckTests.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="TestHost.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>