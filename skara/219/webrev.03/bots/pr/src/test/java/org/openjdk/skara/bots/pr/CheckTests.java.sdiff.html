<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/pr/src/test/java/org/openjdk/skara/bots/pr/CheckTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../../test/src/main/java/org/openjdk/skara/test/HostCredentials.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/pr/src/test/java/org/openjdk/skara/bots/pr/CheckTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.pr;
  24 
  25 import org.openjdk.skara.forge.*;
  26 import org.openjdk.skara.test.*;
  27 
  28 import org.junit.jupiter.api.*;
  29 
  30 import java.io.IOException;
  31 import java.nio.charset.StandardCharsets;
  32 import java.nio.file.*;
  33 import java.util.*;

  34 import java.util.regex.Pattern;
  35 
  36 import static org.junit.jupiter.api.Assertions.*;
  37 import static org.junit.jupiter.api.Assumptions.assumeTrue;
  38 
  39 class CheckTests {
  40     @Test
  41     void simpleCommit(TestInfo testInfo) throws IOException {
  42         try (var credentials = new HostCredentials(testInfo);
  43              var tempFolder = new TemporaryDirectory()) {
  44             var author = credentials.getHostedRepository();
  45             var reviewer = credentials.getHostedRepository();
  46 
  47             var censusBuilder = credentials.getCensusBuilder()
  48                                            .addAuthor(author.forge().currentUser().id())
  49                                            .addReviewer(reviewer.forge().currentUser().id());
  50             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
  51 
  52             // Populate the projects repository
  53             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
</pre>
<hr />
<pre>
 955 
 956             // Verify that the check failed
 957             var checks = pr.checks(editHash);
 958             assertEquals(1, checks.size());
 959             var check = checks.get(&quot;jcheck&quot;);
 960             assertTrue(check.summary().orElseThrow().contains(&quot;commit message does not reference any issue&quot;));
 961             assertEquals(CheckStatus.FAILURE, check.status());
 962 
 963             // Adjust the title to conform and check the status again
 964             pr.setTitle(&quot;12345: This is a pull request&quot;);
 965             TestBotRunner.runPeriodicItems(checkBot);
 966 
 967             // Verify that the check passed
 968             checks = pr.checks(editHash);
 969             assertEquals(1, checks.size());
 970             check = checks.get(&quot;jcheck&quot;);
 971             assertEquals(CheckStatus.SUCCESS, check.status());
 972         }
 973     }
 974 







 975     @Test
 976     void draft(TestInfo testInfo) throws IOException {









 977         try (var credentials = new HostCredentials(testInfo);
 978              var tempFolder = new TemporaryDirectory()) {
 979             var author = credentials.getHostedRepository();
 980             var reviewer = credentials.getHostedRepository();
 981 
 982             var censusBuilder = credentials.getCensusBuilder()
 983                                            .addAuthor(author.forge().currentUser().id())
 984                                            .addReviewer(reviewer.forge().currentUser().id());
 985             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
 986 


 987             // Populate the projects repository
 988             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 989             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 990             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 991 
 992             // Make a change with a corresponding PR
 993             var editHash = CheckableRepository.appendAndCommit(localRepo);
 994             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 995             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;,
 996                                                    &quot;This is a pull request&quot;, true);
 997 
 998             // Check the status
 999             TestBotRunner.runPeriodicItems(checkBot);
1000 
1001             // Verify that the check succeeded
1002             var checks = pr.checks(editHash);
1003             assertEquals(1, checks.size());
1004             var check = checks.get(&quot;jcheck&quot;);
1005             assertEquals(CheckStatus.SUCCESS, check.status());
1006 
</pre>
</td>
<td>
<hr />
<pre>
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.pr;
  24 
  25 import org.openjdk.skara.forge.*;
  26 import org.openjdk.skara.test.*;
  27 
  28 import org.junit.jupiter.api.*;
  29 
  30 import java.io.IOException;
  31 import java.nio.charset.StandardCharsets;
  32 import java.nio.file.*;
  33 import java.util.*;
<span class="line-added">  34 import java.util.logging.*;</span>
  35 import java.util.regex.Pattern;
  36 
  37 import static org.junit.jupiter.api.Assertions.*;
  38 import static org.junit.jupiter.api.Assumptions.assumeTrue;
  39 
  40 class CheckTests {
  41     @Test
  42     void simpleCommit(TestInfo testInfo) throws IOException {
  43         try (var credentials = new HostCredentials(testInfo);
  44              var tempFolder = new TemporaryDirectory()) {
  45             var author = credentials.getHostedRepository();
  46             var reviewer = credentials.getHostedRepository();
  47 
  48             var censusBuilder = credentials.getCensusBuilder()
  49                                            .addAuthor(author.forge().currentUser().id())
  50                                            .addReviewer(reviewer.forge().currentUser().id());
  51             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
  52 
  53             // Populate the projects repository
  54             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
</pre>
<hr />
<pre>
 956 
 957             // Verify that the check failed
 958             var checks = pr.checks(editHash);
 959             assertEquals(1, checks.size());
 960             var check = checks.get(&quot;jcheck&quot;);
 961             assertTrue(check.summary().orElseThrow().contains(&quot;commit message does not reference any issue&quot;));
 962             assertEquals(CheckStatus.FAILURE, check.status());
 963 
 964             // Adjust the title to conform and check the status again
 965             pr.setTitle(&quot;12345: This is a pull request&quot;);
 966             TestBotRunner.runPeriodicItems(checkBot);
 967 
 968             // Verify that the check passed
 969             checks = pr.checks(editHash);
 970             assertEquals(1, checks.size());
 971             check = checks.get(&quot;jcheck&quot;);
 972             assertEquals(CheckStatus.SUCCESS, check.status());
 973         }
 974     }
 975 
<span class="line-added"> 976     class MyHandler extends StreamHandler {</span>
<span class="line-added"> 977         @Override</span>
<span class="line-added"> 978         public synchronized void publish(LogRecord record) {</span>
<span class="line-added"> 979             System.out.println(record.getInstant() + &quot;: &quot; + record.getMessage());</span>
<span class="line-added"> 980         }</span>
<span class="line-added"> 981     }</span>
<span class="line-added"> 982 </span>
 983     @Test
 984     void draft(TestInfo testInfo) throws IOException {
<span class="line-added"> 985         Logger log = Logger.getGlobal();</span>
<span class="line-added"> 986         log.setLevel(Level.FINER);</span>
<span class="line-added"> 987         log = Logger.getLogger(&quot;org.openjdk&quot;);</span>
<span class="line-added"> 988         log.setLevel(Level.FINER);</span>
<span class="line-added"> 989         var handler = new MyHandler();</span>
<span class="line-added"> 990         handler.setLevel(Level.FINER);</span>
<span class="line-added"> 991         log.addHandler(handler);</span>
<span class="line-added"> 992 </span>
<span class="line-added"> 993 </span>
 994         try (var credentials = new HostCredentials(testInfo);
 995              var tempFolder = new TemporaryDirectory()) {
 996             var author = credentials.getHostedRepository();
 997             var reviewer = credentials.getHostedRepository();
 998 
 999             var censusBuilder = credentials.getCensusBuilder()
1000                                            .addAuthor(author.forge().currentUser().id())
1001                                            .addReviewer(reviewer.forge().currentUser().id());
1002             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
1003 
<span class="line-added">1004             log.info(&quot;STEP 1&quot;);</span>
<span class="line-added">1005 </span>
1006             // Populate the projects repository
1007             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1008             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1009             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1010 
1011             // Make a change with a corresponding PR
1012             var editHash = CheckableRepository.appendAndCommit(localRepo);
1013             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
1014             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;,
1015                                                    &quot;This is a pull request&quot;, true);
1016 
1017             // Check the status
1018             TestBotRunner.runPeriodicItems(checkBot);
1019 
1020             // Verify that the check succeeded
1021             var checks = pr.checks(editHash);
1022             assertEquals(1, checks.size());
1023             var check = checks.get(&quot;jcheck&quot;);
1024             assertEquals(CheckStatus.SUCCESS, check.status());
1025 
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../../test/src/main/java/org/openjdk/skara/test/HostCredentials.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>