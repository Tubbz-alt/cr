<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New bots/pr/src/test/java/org/openjdk/skara/bots/pr/CheckTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.pr;
  24 
  25 import org.openjdk.skara.forge.*;
  26 import org.openjdk.skara.test.*;
  27 
  28 import org.junit.jupiter.api.*;
  29 
  30 import java.io.IOException;
  31 import java.nio.charset.StandardCharsets;
  32 import java.nio.file.*;
  33 import java.util.*;
  34 import java.util.logging.*;
  35 import java.util.regex.Pattern;
  36 
  37 import static org.junit.jupiter.api.Assertions.*;
  38 import static org.junit.jupiter.api.Assumptions.assumeTrue;
  39 
  40 class CheckTests {
  41     @Test
  42     void simpleCommit(TestInfo testInfo) throws IOException {
  43         try (var credentials = new HostCredentials(testInfo);
  44              var tempFolder = new TemporaryDirectory()) {
  45             var author = credentials.getHostedRepository();
  46             var reviewer = credentials.getHostedRepository();
  47 
  48             var censusBuilder = credentials.getCensusBuilder()
  49                                            .addAuthor(author.forge().currentUser().id())
  50                                            .addReviewer(reviewer.forge().currentUser().id());
  51             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
  52 
  53             // Populate the projects repository
  54             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
  55             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
  56             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
  57 
  58             // Make a change with a corresponding PR
  59             var editHash = CheckableRepository.appendAndCommit(localRepo);
  60             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
  61             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
  62 
  63             // Check the status
  64             TestBotRunner.runPeriodicItems(checkBot);
  65 
  66             // Verify that the check succeeded
  67             var checks = pr.checks(editHash);
  68             assertEquals(1, checks.size());
  69             var check = checks.get(&quot;jcheck&quot;);
  70             assertEquals(CheckStatus.SUCCESS, check.status());
  71 
  72             // The PR should now be ready for review
  73             assertTrue(pr.labels().contains(&quot;rfr&quot;));
  74             assertFalse(pr.labels().contains(&quot;ready&quot;));
  75 
  76             // Approve it as another user
  77             var approvalPr = reviewer.pullRequest(pr.id());
  78             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
  79 
  80             // Check the status again
  81             TestBotRunner.runPeriodicItems(checkBot);
  82 
  83             // The check should now be successful
  84             checks = pr.checks(editHash);
  85             assertEquals(1, checks.size());
  86             check = checks.get(&quot;jcheck&quot;);
  87             assertEquals(CheckStatus.SUCCESS, check.status());
  88 
  89             // The PR should not be flagged as ready for review, at it is already reviewed
  90             assertFalse(pr.labels().contains(&quot;rfr&quot;));
  91             assertTrue(pr.labels().contains(&quot;ready&quot;));
  92         }
  93     }
  94 
  95     @Test
  96     void whitespaceIssue(TestInfo testInfo) throws IOException {
  97         try (var credentials = new HostCredentials(testInfo);
  98              var tempFolder = new TemporaryDirectory()) {
  99 
 100             var author = credentials.getHostedRepository();
 101             var reviewer = credentials.getHostedRepository();
 102 
 103             var censusBuilder = credentials.getCensusBuilder()
 104                                            .addAuthor(author.forge().currentUser().id())
 105                                            .addReviewer(reviewer.forge().currentUser().id());
 106             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
 107 
 108             // Populate the projects repository
 109             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 110             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 111             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 112 
 113             // Make a change with a corresponding PR
 114             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line with a trailing whitespace   &quot;);
 115             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 116             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 117 
 118             // Check the status
 119             TestBotRunner.runPeriodicItems(checkBot);
 120 
 121             // The PR should not be flagged as ready for review
 122             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 123 
 124             // Approve it as another user
 125             var approvalPr = reviewer.pullRequest(pr.id());
 126             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 127 
 128             // Check the status
 129             TestBotRunner.runPeriodicItems(checkBot);
 130 
 131             // Verify that the check failed
 132             var checks = pr.checks(editHash);
 133             assertEquals(1, checks.size());
 134             var check = checks.get(&quot;jcheck&quot;);
 135             assertEquals(CheckStatus.FAILURE, check.status());
 136 
 137             // The PR should not still not be flagged as ready for review
 138             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 139 
 140             // Remove the trailing whitespace in a new commit
 141             editHash = CheckableRepository.replaceAndCommit(localRepo, &quot;A line without a trailing whitespace&quot;);
 142             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 143 
 144             // Make sure that the push registered
 145             var lastHeadHash = pr.headHash();
 146             var refreshCount = 0;
 147             do {
 148                 pr = author.pullRequest(pr.id());
 149                 if (refreshCount++ &gt; 100) {
 150                     fail(&quot;The PR did not update after the new push&quot;);
 151                 }
 152             } while (pr.headHash().equals(lastHeadHash));
 153 
 154             // Check the status again
 155             TestBotRunner.runPeriodicItems(checkBot);
 156 
 157             // The PR should not be flagged as ready for review, at it is already reviewed
 158             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 159 
 160             // The check should now be successful
 161             checks = pr.checks(editHash);
 162             assertEquals(1, checks.size());
 163             check = checks.get(&quot;jcheck&quot;);
 164             assertEquals(CheckStatus.SUCCESS, check.status());
 165         }
 166     }
 167 
 168     @Test
 169     void multipleReviews(TestInfo testInfo) throws IOException {
 170         try (var credentials = new HostCredentials(testInfo);
 171              var tempFolder = new TemporaryDirectory()) {
 172 
 173             var author = credentials.getHostedRepository();
 174             var reviewer = credentials.getHostedRepository();
 175             var commenter = credentials.getHostedRepository();
 176 
 177             var censusBuilder = credentials.getCensusBuilder()
 178                                            .addAuthor(author.forge().currentUser().id())
 179                                            .addReviewer(reviewer.forge().currentUser().id())
 180                                            .addReviewer(commenter.forge().currentUser().id());
 181 
 182             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
 183 
 184             // Populate the projects repository
 185             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 186             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 187             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 188 
 189             // Make a change with a corresponding PR
 190             var editHash = CheckableRepository.appendAndCommit(localRepo);
 191             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 192             var authorPr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 193 
 194             // Let the status bot inspect the PR
 195             TestBotRunner.runPeriodicItems(checkBot);
 196             assertFalse(authorPr.body().contains(&quot;Approvers&quot;));
 197 
 198             // Approve it
 199             var reviewerPr = reviewer.pullRequest(authorPr.id());
 200             reviewerPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 201             TestBotRunner.runPeriodicItems(checkBot);
 202 
 203             // Refresh the PR and check that it has been approved
 204             authorPr = author.pullRequest(authorPr.id());
 205             assertTrue(authorPr.body().contains(&quot;Approvers&quot;));
 206 
 207             // Update the file after approval
 208             editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Now I&#39;ve gone and changed it&quot;);
 209             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 210 
 211             // Make sure that the push registered
 212             var lastHeadHash = authorPr.headHash();
 213             var refreshCount = 0;
 214             do {
 215                 authorPr = author.pullRequest(authorPr.id());
 216                 if (refreshCount++ &gt; 100) {
 217                     fail(&quot;The PR did not update after the new push&quot;);
 218                 }
 219             } while (authorPr.headHash().equals(lastHeadHash));
 220 
 221             // Check that the review is flagged as stale
 222             TestBotRunner.runPeriodicItems(checkBot);
 223             authorPr = author.pullRequest(authorPr.id());
 224             assertTrue(authorPr.body().contains(&quot;Note&quot;));
 225 
 226             // Now we can approve it again
 227             reviewerPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 228             TestBotRunner.runPeriodicItems(checkBot);
 229 
 230             // Refresh the PR and check that it has been approved (once) and is no longer stale
 231             authorPr = author.pullRequest(authorPr.id());
 232             assertTrue(authorPr.body().contains(&quot;Approvers&quot;));
 233             assertEquals(1, authorPr.body().split(&quot;Generated Reviewer&quot;, -1).length - 1);
 234             assertTrue(authorPr.reviews().size() &gt;= 1);
 235             assertFalse(authorPr.body().contains(&quot;Note&quot;));
 236 
 237             // Add a review with disapproval
 238             var commenterPr = commenter.pullRequest(authorPr.id());
 239             commenterPr.addReview(Review.Verdict.DISAPPROVED, &quot;Disapproved&quot;);
 240             TestBotRunner.runPeriodicItems(checkBot);
 241 
 242             // Refresh the PR and check that it still only approved once (but two reviews) and is no longer stale
 243             authorPr = author.pullRequest(authorPr.id());
 244             assertTrue(authorPr.body().contains(&quot;Approvers&quot;));
 245             assertEquals(1, authorPr.body().split(&quot;Generated Reviewer&quot;, -1).length - 1);
 246             assertTrue(authorPr.reviews().size() &gt;= 2);
 247             assertFalse(authorPr.body().contains(&quot;Note&quot;));
 248         }
 249     }
 250 
 251     @Test
 252     void selfReview(TestInfo testInfo) throws IOException {
 253         try (var credentials = new HostCredentials(testInfo);
 254              var tempFolder = new TemporaryDirectory()) {
 255 
 256             var author = credentials.getHostedRepository();
 257 
 258             var censusBuilder = credentials.getCensusBuilder()
 259                                            .addReviewer(author.forge().currentUser().id());
 260 
 261             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
 262 
 263             // Populate the projects repository
 264             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 265             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 266             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 267 
 268             // Make a change with a corresponding PR
 269             var editHash = CheckableRepository.appendAndCommit(localRepo);
 270             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 271             var authorPr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 272 
 273             // Let the status bot inspect the PR
 274             TestBotRunner.runPeriodicItems(checkBot);
 275             assertFalse(authorPr.body().contains(&quot;Approvers&quot;));
 276 
 277             // Approve it
 278             authorPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 279             TestBotRunner.runPeriodicItems(checkBot);
 280 
 281             // Refresh the PR and check that it has been approved
 282             authorPr = author.pullRequest(authorPr.id());
 283             assertTrue(authorPr.body().contains(&quot;Approvers&quot;));
 284 
 285             // Verify that the check failed
 286             var checks = authorPr.checks(editHash);
 287             assertEquals(1, checks.size());
 288             var check = checks.get(&quot;jcheck&quot;);
 289             assertEquals(CheckStatus.FAILURE, check.status());
 290         }
 291     }
 292 
 293     @Test
 294     void multipleCommitters(TestInfo testInfo) throws IOException {
 295         try (var credentials = new HostCredentials(testInfo);
 296              var tempFolder = new TemporaryDirectory()) {
 297             var author = credentials.getHostedRepository();
 298             var reviewer = credentials.getHostedRepository();
 299 
 300             var censusBuilder = credentials.getCensusBuilder()
 301                                            .addReviewer(reviewer.forge().currentUser().id());
 302             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
 303 
 304             // Populate the projects repository
 305             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 306             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 307             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 308 
 309             // Make two changes with different authors
 310             CheckableRepository.appendAndCommit(localRepo, &quot;First edit&quot;, &quot;Edit by number 1&quot;,
 311                                                 &quot;number1&quot;, &quot;number1@none.none&quot;);
 312             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Second edit&quot;, &quot;Edit by number 2&quot;,
 313                                                                &quot;number2&quot;, &quot;number2@none.none&quot;);
 314             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 315             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 316 
 317             // Check the status
 318             TestBotRunner.runPeriodicItems(checkBot);
 319 
 320             // Verify that the check failed
 321             var checks = pr.checks(editHash);
 322             assertEquals(1, checks.size());
 323             var check = checks.get(&quot;jcheck&quot;);
 324             assertEquals(CheckStatus.FAILURE, check.status());
 325 
 326             // Approve it as another user
 327             var approvalPr = reviewer.pullRequest(pr.id());
 328             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 329 
 330             // Check the status again
 331             TestBotRunner.runPeriodicItems(checkBot);
 332 
 333             // The check should still be failing
 334             checks = pr.checks(editHash);
 335             assertEquals(1, checks.size());
 336             check = checks.get(&quot;jcheck&quot;);
 337             assertEquals(CheckStatus.FAILURE, check.status());
 338 
 339             // The PR should not be flagged as ready for review, as multiple committers is a problem
 340             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 341         }
 342     }
 343 
 344     @Test
 345     void updatedContentFailsCheck(TestInfo testInfo) throws IOException {
 346         try (var credentials = new HostCredentials(testInfo);
 347              var tempFolder = new TemporaryDirectory()) {
 348             var author = credentials.getHostedRepository();
 349             var reviewer = credentials.getHostedRepository();
 350 
 351             var censusBuilder = credentials.getCensusBuilder()
 352                                            .addAuthor(author.forge().currentUser().id())
 353                                            .addReviewer(reviewer.forge().currentUser().id());
 354             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
 355 
 356             // Populate the projects repository
 357             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 358             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 359             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 360 
 361             // Make a change with a corresponding PR
 362             var editHash = CheckableRepository.appendAndCommit(localRepo);
 363             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 364             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 365 
 366             // Check the status
 367             TestBotRunner.runPeriodicItems(checkBot);
 368 
 369             // Verify that the check passed
 370             var checks = pr.checks(editHash);
 371             assertEquals(1, checks.size());
 372             var check = checks.get(&quot;jcheck&quot;);
 373             assertEquals(CheckStatus.SUCCESS, check.status());
 374 
 375             // The PR should now be ready for review
 376             assertTrue(pr.labels().contains(&quot;rfr&quot;));
 377             assertFalse(pr.labels().contains(&quot;ready&quot;));
 378 
 379             // Approve it as another user
 380             var approvalPr = reviewer.pullRequest(pr.id());
 381             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 382 
 383             // Check the status again
 384             TestBotRunner.runPeriodicItems(checkBot);
 385 
 386             // The check should now be successful
 387             checks = pr.checks(editHash);
 388             assertEquals(1, checks.size());
 389             check = checks.get(&quot;jcheck&quot;);
 390             assertEquals(CheckStatus.SUCCESS, check.status());
 391 
 392             // The PR should not be flagged as ready for review, at it is already reviewed
 393             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 394             assertTrue(pr.labels().contains(&quot;ready&quot;));
 395 
 396             var addedHash = CheckableRepository.appendAndCommit(localRepo, &quot;trailing whitespace   &quot;);
 397             localRepo.push(addedHash, author.url(), &quot;edit&quot;);
 398 
 399             // Make sure that the push registered
 400             var lastHeadHash = pr.headHash();
 401             var refreshCount = 0;
 402             do {
 403                 pr = author.pullRequest(pr.id());
 404                 if (refreshCount++ &gt; 100) {
 405                     fail(&quot;The PR did not update after the new push&quot;);
 406                 }
 407             } while (pr.headHash().equals(lastHeadHash));
 408 
 409             // Check the status
 410             TestBotRunner.runPeriodicItems(checkBot);
 411 
 412             // The PR is now neither ready for review nor integration
 413             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 414             assertFalse(pr.labels().contains(&quot;ready&quot;));
 415 
 416             // The check should now be failing
 417             checks = pr.checks(addedHash);
 418             assertEquals(1, checks.size());
 419             check = checks.get(&quot;jcheck&quot;);
 420             assertEquals(CheckStatus.FAILURE, check.status());
 421         }
 422     }
 423 
 424     @Test
 425     void individualReviewComments(TestInfo testInfo) throws IOException {
 426         try (var credentials = new HostCredentials(testInfo);
 427              var tempFolder = new TemporaryDirectory()) {
 428             var author = credentials.getHostedRepository();
 429             var reviewer = credentials.getHostedRepository();
 430 
 431             // This test is only relevant on hosts not supporting proper review comment bodies
 432             assumeTrue(!author.forge().supportsReviewBody());
 433 
 434             var censusBuilder = credentials.getCensusBuilder()
 435                                            .addAuthor(author.forge().currentUser().id())
 436                                            .addReviewer(reviewer.forge().currentUser().id());
 437             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
 438 
 439             // Populate the projects repository
 440             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 441             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 442             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 443 
 444             // Make a change with a corresponding PR
 445             var editHash = CheckableRepository.appendAndCommit(localRepo);
 446             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 447             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 448 
 449             // Check the status
 450             TestBotRunner.runPeriodicItems(checkBot);
 451             var comments = pr.comments();
 452             var commentCount = comments.size();
 453 
 454             // Approve it as another user
 455             var approvalPr = reviewer.pullRequest(pr.id());
 456             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 457 
 458             // Check the status again
 459             TestBotRunner.runPeriodicItems(checkBot);
 460 
 461             // There should now be two additional comments
 462             comments = pr.comments();
 463             assertEquals(commentCount + 2, comments.size());
 464             var comment = comments.get(commentCount);
 465             assertTrue(comment.body().contains(reviewer.forge().currentUser().userName()));
 466             assertTrue(comment.body().contains(&quot;approved&quot;));
 467 
 468             // Drop the review
 469             approvalPr.addReview(Review.Verdict.NONE, &quot;Unreviewed&quot;);
 470 
 471             // Check the status again
 472             TestBotRunner.runPeriodicItems(checkBot);
 473 
 474             // There should now be yet another comment
 475             comments = pr.comments();
 476             assertEquals(commentCount + 3, comments.size());
 477             comment = comments.get(commentCount + 2);
 478             assertTrue(comment.body().contains(reviewer.forge().currentUser().userName()));
 479             assertTrue(comment.body().contains(&quot;comment&quot;));
 480 
 481             // No changes should not generate additional comments
 482             TestBotRunner.runPeriodicItems(checkBot);
 483             comments = pr.comments();
 484             assertEquals(commentCount + 3, comments.size());
 485         }
 486     }
 487 
 488     @Test
 489     void mergeMessage(TestInfo testInfo) throws IOException {
 490         try (var credentials = new HostCredentials(testInfo);
 491              var tempFolder = new TemporaryDirectory();
 492              var pushedFolder = new TemporaryDirectory()) {
 493 
 494             var author = credentials.getHostedRepository();
 495             var integrator = credentials.getHostedRepository();
 496             var censusBuilder = credentials.getCensusBuilder()
 497                                            .addCommitter(author.forge().currentUser().id())
 498                                            .addReviewer(integrator.forge().currentUser().id());
 499             var mergeBot = new PullRequestBot(integrator, censusBuilder.build(), &quot;master&quot;);
 500 
 501             // Populate the projects repository
 502             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 503             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 504             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
 505             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 506 
 507             // Make a change with a corresponding PR
 508             var editHash = CheckableRepository.appendAndCommit(localRepo);
 509             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 510             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 511 
 512             // Approve it as another user
 513             var approvalPr = integrator.pullRequest(pr.id());
 514             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 515 
 516             // Get all messages up to date
 517             TestBotRunner.runPeriodicItems(mergeBot);
 518 
 519             // Push something unrelated to master
 520             localRepo.checkout(masterHash, true);
 521             var unrelated = localRepo.root().resolve(&quot;unrelated.txt&quot;);
 522             Files.writeString(unrelated, &quot;Hello&quot;);
 523             localRepo.add(unrelated);
 524             var unrelatedHash = localRepo.commit(&quot;Unrelated&quot;, &quot;X&quot;, &quot;x@y.z&quot;);
 525             localRepo.push(unrelatedHash, author.url(), &quot;master&quot;);
 526 
 527             // Let the bot see the changes
 528             TestBotRunner.runPeriodicItems(mergeBot);
 529 
 530             // The bot should reply with an ok message
 531             var updated = pr.comments().stream()
 532                             .filter(comment -&gt; comment.body().contains(&quot;there has been 1 commit&quot;))
 533                             .filter(comment -&gt; comment.body().contains(&quot;please merge&quot;))
 534                             .count();
 535             assertEquals(1, updated);
 536         }
 537     }
 538 
 539     @Test
 540     void cannotRebase(TestInfo testInfo) throws IOException {
 541         try (var credentials = new HostCredentials(testInfo);
 542              var tempFolder = new TemporaryDirectory();
 543              var pushedFolder = new TemporaryDirectory()) {
 544 
 545             var author = credentials.getHostedRepository();
 546             var integrator = credentials.getHostedRepository();
 547             var censusBuilder = credentials.getCensusBuilder()
 548                                            .addCommitter(author.forge().currentUser().id())
 549                                            .addReviewer(integrator.forge().currentUser().id());
 550             var mergeBot = new PullRequestBot(integrator, censusBuilder.build(), &quot;master&quot;);
 551 
 552             // Populate the projects repository
 553             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 554             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 555             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
 556             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 557 
 558             // Make a change with a corresponding PR
 559             var editHash = CheckableRepository.appendAndCommit(localRepo);
 560             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 561             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 562 
 563             // Approve it as another user
 564             var approvalPr = integrator.pullRequest(pr.id());
 565             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 566 
 567             // Get all messages up to date
 568             TestBotRunner.runPeriodicItems(mergeBot);
 569 
 570             // Push something conflicting to master
 571             localRepo.checkout(masterHash, true);
 572             var conflictingHash = CheckableRepository.appendAndCommit(localRepo, &quot;This looks like a conflict&quot;);
 573             localRepo.push(conflictingHash, author.url(), &quot;master&quot;);
 574 
 575             // Let the bot see the changes
 576             TestBotRunner.runPeriodicItems(mergeBot);
 577 
 578             // The bot should reply with that there is a conflict
 579             var updated = pr.comments().stream()
 580                             .filter(comment -&gt; comment.body().contains(&quot;there has been 1 commit&quot;))
 581                             .filter(comment -&gt; comment.body().contains(&quot;cannot be rebased automatically&quot;))
 582                             .count();
 583             assertEquals(1, updated);
 584 
 585             // The PR should be flagged as outdated
 586             assertTrue(pr.labels().contains(&quot;outdated&quot;));
 587 
 588             // But it should still pass jcheck
 589             var checks = pr.checks(editHash);
 590             assertEquals(1, checks.size());
 591             var check = checks.get(&quot;jcheck&quot;);
 592             assertEquals(CheckStatus.SUCCESS, check.status());
 593 
 594             // Restore the master branch
 595             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 596 
 597             // Let the bot see the changes
 598             TestBotRunner.runPeriodicItems(mergeBot);
 599 
 600             // The bot should no longer detect a conflict
 601             updated = pr.comments().stream()
 602                         .filter(comment -&gt; comment.body().contains(&quot;change can now be integrated&quot;))
 603                         .count();
 604             assertEquals(1, updated);
 605 
 606             // The PR should not be flagged as outdated
 607             assertFalse(pr.labels().contains(&quot;outdated&quot;));
 608         }
 609     }
 610 
 611     @Test
 612     void blockingLabel(TestInfo testInfo) throws IOException {
 613         try (var credentials = new HostCredentials(testInfo);
 614              var tempFolder = new TemporaryDirectory()) {
 615             var author = credentials.getHostedRepository();
 616             var reviewer = credentials.getHostedRepository();
 617 
 618             var censusBuilder = credentials.getCensusBuilder()
 619                                            .addAuthor(author.forge().currentUser().id())
 620                                            .addReviewer(reviewer.forge().currentUser().id());
 621             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;, Map.of(), Map.of(),
 622                                               Map.of(&quot;block&quot;, &quot;Test Blocker&quot;), Set.of(), Map.of());
 623 
 624             // Populate the projects repository
 625             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 626             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 627             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 628 
 629             // Make a change with a corresponding PR
 630             var editHash = CheckableRepository.appendAndCommit(localRepo);
 631             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 632             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 633             pr.addLabel(&quot;block&quot;);
 634 
 635             // Check the status
 636             TestBotRunner.runPeriodicItems(checkBot);
 637 
 638             // Verify that the check failed
 639             var checks = pr.checks(editHash);
 640             assertEquals(1, checks.size());
 641             var check = checks.get(&quot;jcheck&quot;);
 642             assertEquals(CheckStatus.FAILURE, check.status());
 643             assertTrue(check.summary().orElseThrow().contains(&quot;Test Blocker&quot;));
 644 
 645             // The PR should not yet be ready for review
 646             assertTrue(pr.labels().contains(&quot;block&quot;));
 647             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 648             assertFalse(pr.labels().contains(&quot;ready&quot;));
 649 
 650             // Check the status again
 651             pr.removeLabel(&quot;block&quot;);
 652             TestBotRunner.runPeriodicItems(checkBot);
 653 
 654             // The PR should now be ready for review
 655             assertTrue(pr.labels().contains(&quot;rfr&quot;));
 656             assertFalse(pr.labels().contains(&quot;ready&quot;));
 657         }
 658     }
 659 
 660     @Test
 661     void missingReadyLabel(TestInfo testInfo) throws IOException {
 662         try (var credentials = new HostCredentials(testInfo);
 663              var tempFolder = new TemporaryDirectory()) {
 664             var author = credentials.getHostedRepository();
 665             var reviewer = credentials.getHostedRepository();
 666 
 667             var censusBuilder = credentials.getCensusBuilder()
 668                                            .addAuthor(author.forge().currentUser().id())
 669                                            .addReviewer(reviewer.forge().currentUser().id());
 670             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;, Map.of(), Map.of(),
 671                                               Map.of(), Set.of(&quot;good-to-go&quot;), Map.of());
 672 
 673             // Populate the projects repository
 674             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 675             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 676             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 677 
 678             // Make a change with a corresponding PR
 679             var editHash = CheckableRepository.appendAndCommit(localRepo);
 680             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 681             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 682 
 683             // Check the status
 684             TestBotRunner.runPeriodicItems(checkBot);
 685 
 686             // Verify that no checks have been run
 687             var checks = pr.checks(editHash);
 688             assertEquals(0, checks.size());
 689 
 690             // The PR should not yet be ready for review
 691             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 692 
 693             // Check the status again
 694             pr.addLabel(&quot;good-to-go&quot;);
 695             TestBotRunner.runPeriodicItems(checkBot);
 696 
 697             // The PR should now be ready for review
 698             assertTrue(pr.labels().contains(&quot;rfr&quot;));
 699         }
 700     }
 701 
 702     @Test
 703     void missingReadyComment(TestInfo testInfo) throws IOException {
 704         try (var credentials = new HostCredentials(testInfo);
 705              var tempFolder = new TemporaryDirectory()) {
 706             var author = credentials.getHostedRepository();
 707             var reviewer = credentials.getHostedRepository();
 708 
 709             var censusBuilder = credentials.getCensusBuilder()
 710                                            .addAuthor(author.forge().currentUser().id())
 711                                            .addReviewer(reviewer.forge().currentUser().id());
 712             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;, Map.of(), Map.of(),
 713                                               Map.of(), Set.of(), Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;proceed&quot;)));
 714 
 715             // Populate the projects repository
 716             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 717             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 718             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 719 
 720             // Make a change with a corresponding PR
 721             var editHash = CheckableRepository.appendAndCommit(localRepo);
 722             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 723             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 724 
 725             // Check the status
 726             TestBotRunner.runPeriodicItems(checkBot);
 727 
 728             // Verify that no checks have been run
 729             var checks = pr.checks(editHash);
 730             assertEquals(0, checks.size());
 731 
 732             // The PR should not yet be ready for review
 733             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 734 
 735             // Check the status again
 736             var reviewerPr = reviewer.pullRequest(pr.id());
 737             reviewerPr.addComment(&quot;proceed&quot;);
 738             TestBotRunner.runPeriodicItems(checkBot);
 739 
 740             // The PR should now be ready for review
 741             assertTrue(pr.labels().contains(&quot;rfr&quot;));
 742         }
 743     }
 744 
 745     @Test
 746     void issueIssue(TestInfo testInfo) throws IOException {
 747         try (var credentials = new HostCredentials(testInfo);
 748              var tempFolder = new TemporaryDirectory()) {
 749             var author = credentials.getHostedRepository();
 750             var reviewer = credentials.getHostedRepository();
 751 
 752             var censusBuilder = credentials.getCensusBuilder()
 753                                            .addAuthor(author.forge().currentUser().id())
 754                                            .addReviewer(reviewer.forge().currentUser().id());
 755             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;, Map.of(), Map.of(),
 756                                               Map.of(), Set.of(), Map.of());
 757 
 758             // Populate the projects repository
 759             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), Path.of(&quot;appendable.txt&quot;),
 760                                                      Set.of(&quot;issues&quot;));
 761             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 762             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 763 
 764             // Make a change with a corresponding PR
 765             var editHash = CheckableRepository.appendAndCommit(localRepo);
 766             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 767             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 768 
 769             // Check the status
 770             TestBotRunner.runPeriodicItems(checkBot);
 771 
 772             // Verify that the check failed
 773             var checks = pr.checks(editHash);
 774             assertEquals(1, checks.size());
 775             var check = checks.get(&quot;jcheck&quot;);
 776             assertEquals(CheckStatus.FAILURE, check.status());
 777 
 778             // Add an issue to the title
 779             pr.setTitle(&quot;1234: This is a pull request&quot;);
 780 
 781             // Check the status again
 782             TestBotRunner.runPeriodicItems(checkBot);
 783 
 784             // The check should now be successful
 785             checks = pr.checks(editHash);
 786             assertEquals(1, checks.size());
 787             check = checks.get(&quot;jcheck&quot;);
 788             assertEquals(CheckStatus.SUCCESS, check.status());
 789         }
 790     }
 791 
 792     @Test
 793     void issueInSummary(TestInfo testInfo) throws IOException {
 794         try (var credentials = new HostCredentials(testInfo);
 795              var tempFolder = new TemporaryDirectory()) {
 796             var author = credentials.getHostedRepository();
 797             var reviewer = credentials.getHostedRepository();
 798             var issues = credentials.getIssueProject();
 799 
 800             var censusBuilder = credentials.getCensusBuilder()
 801                                            .addAuthor(author.forge().currentUser().id())
 802                                            .addReviewer(reviewer.forge().currentUser().id());
 803             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;, Map.of(), Map.of(),
 804                                               Map.of(), Set.of(), Map.of(), issues);
 805 
 806             // Populate the projects repository
 807             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), Path.of(&quot;appendable.txt&quot;),
 808                                                      Set.of(&quot;issues&quot;));
 809             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 810             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 811 
 812             var issue1 = issues.createIssue(&quot;My first issue&quot;, List.of(&quot;Hello&quot;));
 813 
 814             // Make a change with a corresponding PR
 815             var editHash = CheckableRepository.appendAndCommit(localRepo);
 816             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 817             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, issue1.id() + &quot;: This is a pull request&quot;);
 818 
 819             // Check the status
 820             TestBotRunner.runPeriodicItems(checkBot);
 821 
 822             // The check should be successful
 823             var checks = pr.checks(editHash);
 824             assertEquals(1, checks.size());
 825             var check = checks.get(&quot;jcheck&quot;);
 826             assertEquals(CheckStatus.SUCCESS, check.status());
 827 
 828             // And the body should contain the issue title
 829             assertTrue(pr.body().contains(&quot;My first issue&quot;));
 830 
 831             // Change the issue
 832             var issue2 = issues.createIssue(&quot;My second issue&quot;, List.of(&quot;Body&quot;));
 833             pr.setTitle(issue2.id() + &quot;: This is a pull request&quot;);
 834 
 835             // Check the status again
 836             TestBotRunner.runPeriodicItems(checkBot);
 837 
 838             // The body should contain the updated issue title
 839             assertFalse(pr.body().contains(&quot;My first issue&quot;));
 840             assertTrue(pr.body().contains(&quot;My second issue&quot;));
 841 
 842             // Use an invalid issue key
 843             var issueKey = issue1.id().replace(&quot;TEST&quot;, &quot;BADPROJECT&quot;);
 844             pr.setTitle(issueKey + &quot;: This is a pull request&quot;);
 845 
 846             // Check the status again
 847             TestBotRunner.runPeriodicItems(checkBot);
 848             assertFalse(pr.body().contains(&quot;My first issue&quot;));
 849             assertFalse(pr.body().contains(&quot;My second issue&quot;));
 850             assertTrue(pr.body().contains(&quot;Failed to retrieve&quot;));
 851 
 852             // Now drop the issue key
 853             issueKey = issue1.id().replace(&quot;TEST-&quot;, &quot;&quot;);
 854             pr.setTitle(issueKey + &quot;: This is a pull request&quot;);
 855 
 856             // The body should now contain the updated issue title
 857             TestBotRunner.runPeriodicItems(checkBot);
 858             assertTrue(pr.body().contains(&quot;My first issue&quot;));
 859             assertFalse(pr.body().contains(&quot;My second issue&quot;));
 860 
 861             // Now enter an invalid issue id
 862             pr.setTitle(&quot;2384848: This is a pull request&quot;);
 863 
 864             // Check the status again
 865             TestBotRunner.runPeriodicItems(checkBot);
 866             assertFalse(pr.body().contains(&quot;My first issue&quot;));
 867             assertFalse(pr.body().contains(&quot;My second issue&quot;));
 868             assertTrue(pr.body().contains(&quot;Failed to retrieve&quot;));
 869 
 870             // The check should still be successful though
 871             checks = pr.checks(editHash);
 872             assertEquals(1, checks.size());
 873             check = checks.get(&quot;jcheck&quot;);
 874             assertEquals(CheckStatus.SUCCESS, check.status());
 875         }
 876     }
 877 
 878     @Test
 879     void cancelCheck(TestInfo testInfo) throws IOException {
 880         try (var credentials = new HostCredentials(testInfo);
 881              var tempFolder = new TemporaryDirectory()) {
 882             var author = credentials.getHostedRepository();
 883 
 884             // Populate the projects repository
 885             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 886             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 887             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 888 
 889             // Make a change with a corresponding PR
 890             var editHash = CheckableRepository.appendAndCommit(localRepo);
 891             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 892             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 893 
 894             // Verify no checks exists
 895             var checks = pr.checks(editHash);
 896             assertEquals(0, checks.size());
 897 
 898             // Create a check that is running
 899             var original = CheckBuilder.create(&quot;jcheck&quot;, editHash)
 900                                        .title(&quot;jcheck title&quot;)
 901                                        .summary(&quot;jcheck summary&quot;)
 902                                        .build();
 903             pr.createCheck(original);
 904 
 905             // Verify check is created
 906             checks = pr.checks(editHash);
 907             assertEquals(1, checks.size());
 908             var retrieved = checks.get(&quot;jcheck&quot;);
 909             assertEquals(&quot;jcheck title&quot;, retrieved.title().get());
 910             assertEquals(&quot;jcheck summary&quot;, retrieved.summary().get());
 911             assertEquals(CheckStatus.IN_PROGRESS, retrieved.status());
 912 
 913             // Cancel the check
 914             var cancelled = CheckBuilder.from(retrieved).cancel().build();
 915             pr.updateCheck(cancelled);
 916             checks = pr.checks(editHash);
 917             assertEquals(1, checks.size());
 918             retrieved = checks.get(&quot;jcheck&quot;);
 919             assertEquals(&quot;jcheck title&quot;, retrieved.title().get());
 920             assertEquals(&quot;jcheck summary&quot;, retrieved.summary().get());
 921             assertEquals(CheckStatus.CANCELLED, retrieved.status());
 922         }
 923     }
 924 
 925     @Test
 926     void rebaseBeforeCheck(TestInfo testInfo) throws IOException {
 927         try (var credentials = new HostCredentials(testInfo);
 928              var tempFolder = new TemporaryDirectory()) {
 929             var author = credentials.getHostedRepository();
 930             var reviewer = credentials.getHostedRepository();
 931 
 932             var censusBuilder = credentials.getCensusBuilder()
 933                                            .addAuthor(author.forge().currentUser().id())
 934                                            .addReviewer(reviewer.forge().currentUser().id());
 935             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
 936 
 937             // Populate the projects repository
 938             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 939             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 940             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 941 
 942             // Make a change with a corresponding PR
 943             var editHash = CheckableRepository.appendAndCommit(localRepo);
 944             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 945             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 946 
 947             // Enable a new check in the target branch
 948             localRepo.checkout(masterHash, true);
 949             CheckableRepository.init(tempFolder.path(), author.repositoryType(), Path.of(&quot;appendable.txt&quot;),
 950                                      Set.of(&quot;author&quot;, &quot;reviewers&quot;, &quot;whitespace&quot;, &quot;issues&quot;));
 951             var headHash = localRepo.resolve(&quot;HEAD&quot;).orElseThrow();
 952             localRepo.push(headHash, author.url(), &quot;master&quot;, true);
 953 
 954             // Check the status
 955             TestBotRunner.runPeriodicItems(checkBot);
 956 
 957             // Verify that the check failed
 958             var checks = pr.checks(editHash);
 959             assertEquals(1, checks.size());
 960             var check = checks.get(&quot;jcheck&quot;);
 961             assertTrue(check.summary().orElseThrow().contains(&quot;commit message does not reference any issue&quot;));
 962             assertEquals(CheckStatus.FAILURE, check.status());
 963 
 964             // Adjust the title to conform and check the status again
 965             pr.setTitle(&quot;12345: This is a pull request&quot;);
 966             TestBotRunner.runPeriodicItems(checkBot);
 967 
 968             // Verify that the check passed
 969             checks = pr.checks(editHash);
 970             assertEquals(1, checks.size());
 971             check = checks.get(&quot;jcheck&quot;);
 972             assertEquals(CheckStatus.SUCCESS, check.status());
 973         }
 974     }
 975 
 976     class MyHandler extends StreamHandler {
 977         @Override
 978         public synchronized void publish(LogRecord record) {
 979             System.out.println(record.getInstant() + &quot;: &quot; + record.getMessage());
 980         }
 981     }
 982 
 983     @Test
 984     void draft(TestInfo testInfo) throws IOException {
 985         Logger log = Logger.getGlobal();
 986         log.setLevel(Level.FINER);
 987         log = Logger.getLogger(&quot;org.openjdk&quot;);
 988         log.setLevel(Level.FINER);
 989         var handler = new MyHandler();
 990         handler.setLevel(Level.FINER);
 991         log.addHandler(handler);
 992 
 993 
 994         try (var credentials = new HostCredentials(testInfo);
 995              var tempFolder = new TemporaryDirectory()) {
 996             var author = credentials.getHostedRepository();
 997             var reviewer = credentials.getHostedRepository();
 998 
 999             var censusBuilder = credentials.getCensusBuilder()
1000                                            .addAuthor(author.forge().currentUser().id())
1001                                            .addReviewer(reviewer.forge().currentUser().id());
1002             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
1003 
1004             log.info(&quot;STEP 1&quot;);
1005 
1006             // Populate the projects repository
1007             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1008             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1009             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1010 
1011             // Make a change with a corresponding PR
1012             var editHash = CheckableRepository.appendAndCommit(localRepo);
1013             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
1014             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;,
1015                                                    &quot;This is a pull request&quot;, true);
1016 
1017             // Check the status
1018             TestBotRunner.runPeriodicItems(checkBot);
1019 
1020             // Verify that the check succeeded
1021             var checks = pr.checks(editHash);
1022             assertEquals(1, checks.size());
1023             var check = checks.get(&quot;jcheck&quot;);
1024             assertEquals(CheckStatus.SUCCESS, check.status());
1025 
1026             // The PR should still not be ready for review as it is a draft
1027             assertFalse(pr.labels().contains(&quot;rfr&quot;));
1028             assertFalse(pr.labels().contains(&quot;ready&quot;));
1029         }
1030     }
1031 
1032     @Test
1033     void excessiveFailures(TestInfo testInfo) throws IOException {
1034         try (var credentials = new HostCredentials(testInfo);
1035              var tempFolder = new TemporaryDirectory()) {
1036             var author = credentials.getHostedRepository();
1037             var reviewer = credentials.getHostedRepository();
1038 
1039             var censusBuilder = credentials.getCensusBuilder()
1040                                            .addAuthor(author.forge().currentUser().id())
1041                                            .addReviewer(reviewer.forge().currentUser().id());
1042             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
1043 
1044             // Populate the projects repository
1045             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1046             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1047             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1048 
1049             // Make a change with a corresponding PR containing more errors than at least GitHub can handle in a check
1050             var badContent = &quot;\tline   \n&quot;.repeat(200);
1051             var editHash = CheckableRepository.appendAndCommit(localRepo, badContent);
1052             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
1053             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;,
1054                                                    &quot;This is a pull request&quot;, true);
1055 
1056             // Check the status
1057             TestBotRunner.runPeriodicItems(checkBot);
1058 
1059             // Verify that the check failed
1060             var checks = pr.checks(editHash);
1061             assertEquals(1, checks.size());
1062             var check = checks.get(&quot;jcheck&quot;);
1063             assertEquals(CheckStatus.FAILURE, check.status());
1064         }
1065     }
1066 
1067     @Test
1068     void retryOnException(TestInfo testInfo) throws IOException {
1069         try (var credentials = new HostCredentials(testInfo);
1070              var tempFolder = new TemporaryDirectory()) {
1071             var author = credentials.getHostedRepository();
1072             var reviewer = credentials.getHostedRepository();
1073 
1074             var censusBuilder = credentials.getCensusBuilder()
1075                                            .addAuthor(author.forge().currentUser().id())
1076                                            .addReviewer(reviewer.forge().currentUser().id());
1077             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
1078 
1079             // Populate the projects repository
1080             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1081             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1082             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1083 
1084             // Break the jcheck configuration
1085             var confPath = tempFolder.path().resolve(&quot;.jcheck/conf&quot;);
1086             var oldConf = Files.readString(confPath, StandardCharsets.UTF_8);
1087             Files.writeString(confPath, &quot;Hello there!&quot;, StandardCharsets.UTF_8);
1088             localRepo.add(confPath);
1089             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A change&quot;);
1090             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1091             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;,
1092                                                    &quot;This is a pull request&quot;, true);
1093 
1094             // Check the status - should throw every time
1095             assertThrows(RuntimeException.class, () -&gt; TestBotRunner.runPeriodicItems(checkBot));
1096             assertThrows(RuntimeException.class, () -&gt; TestBotRunner.runPeriodicItems(checkBot));
1097             assertThrows(RuntimeException.class, () -&gt; TestBotRunner.runPeriodicItems(checkBot));
1098 
1099             // Verify that the check failed
1100             var checks = pr.checks(editHash);
1101             assertEquals(1, checks.size());
1102             var check = checks.get(&quot;jcheck&quot;);
1103             assertEquals(CheckStatus.FAILURE, check.status());
1104 
1105             Files.writeString(confPath, oldConf, StandardCharsets.UTF_8);
1106             localRepo.add(confPath);
1107             editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another change&quot;);
1108             localRepo.push(editHash, author.url(), &quot;edit&quot;);
1109 
1110             TestBotRunner.runPeriodicItems(checkBot);
1111 
1112             // Verify that the check now passes
1113             checks = pr.checks(editHash);
1114             assertEquals(1, checks.size());
1115             check = checks.get(&quot;jcheck&quot;);
1116             assertEquals(CheckStatus.SUCCESS, check.status());
1117         }
1118     }
1119 
1120     @Test
1121     void noCommit(TestInfo testInfo) throws IOException {
1122         try (var credentials = new HostCredentials(testInfo);
1123              var tempFolder = new TemporaryDirectory()) {
1124             var author = credentials.getHostedRepository();
1125             var reviewer = credentials.getHostedRepository();
1126 
1127             var censusBuilder = credentials.getCensusBuilder()
1128                                            .addAuthor(author.forge().currentUser().id())
1129                                            .addReviewer(reviewer.forge().currentUser().id());
1130             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
1131 
1132             // Populate the projects repository
1133             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1134             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1135             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1136 
1137             // Make a change with a corresponding PR
1138             var editHash = CheckableRepository.appendAndCommit(localRepo);
1139             localRepo.push(editHash, author.url(), &quot;master&quot;);
1140             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1141             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1142 
1143             // Check the status
1144             TestBotRunner.runPeriodicItems(checkBot);
1145 
1146             // Verify that the check failed
1147             var checks = pr.checks(editHash);
1148             assertEquals(1, checks.size());
1149             var check = checks.get(&quot;jcheck&quot;);
1150             assertEquals(CheckStatus.FAILURE, check.status());
1151         }
1152     }
1153 }
    </pre>
  </body>
</html>