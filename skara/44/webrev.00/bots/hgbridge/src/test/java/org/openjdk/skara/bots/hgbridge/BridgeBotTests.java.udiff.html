<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff bots/hgbridge/src/test/java/org/openjdk/skara/bots/hgbridge/BridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/hgbridge/JBridgeBotFactory.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../../vcs/src/main/java/org/openjdk/skara/vcs/openjdk/convert/HgToGitConverter.java.udiff.html" target="_top">next &gt;</a></center>    <h2>bots/hgbridge/src/test/java/org/openjdk/skara/bots/hgbridge/BridgeBotTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -20,11 +20,11 @@</span>
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  package org.openjdk.skara.bots.hgbridge;
  
<span class="udiff-line-modified-removed">- import org.openjdk.skara.host.HostedRepository;</span>
<span class="udiff-line-modified-added">+ import org.openjdk.skara.host.*;</span>
  import org.openjdk.skara.host.network.URIBuilder;
  import org.openjdk.skara.process.Process;
  import org.openjdk.skara.test.*;
  import org.openjdk.skara.vcs.Tag;
  import org.openjdk.skara.vcs.*;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -61,13 +61,30 @@</span>
      }
  
      static class TestExporterConfig extends ExporterConfig {
          private boolean badAuthors = false;
  
<span class="udiff-line-modified-removed">-         TestExporterConfig(URI source, HostedRepository destination) {</span>
<span class="udiff-line-modified-added">+         TestExporterConfig(URI source, HostedRepository destination, Path marksRepoPath) throws IOException {</span>
              this.source(source);
              this.destinations(List.of(destination));
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var host = TestHost.createNew(List.of(new HostUserDetails(0, &quot;duke&quot;, &quot;J. Duke&quot;)));</span>
<span class="udiff-line-added">+             var marksLocalRepo = Repository.init(marksRepoPath.resolve(&quot;marks.git&quot;), VCS.GIT);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var initialFile = marksLocalRepo.root().resolve(&quot;init.txt&quot;);</span>
<span class="udiff-line-added">+             if (!Files.exists(initialFile)) {</span>
<span class="udiff-line-added">+                 Files.writeString(initialFile, &quot;Hello&quot;, StandardCharsets.UTF_8);</span>
<span class="udiff-line-added">+                 marksLocalRepo.add(initialFile);</span>
<span class="udiff-line-added">+                 var hash = marksLocalRepo.commit(&quot;First&quot;, &quot;duke&quot;, &quot;duke@duke.duke&quot;);</span>
<span class="udiff-line-added">+                 marksLocalRepo.checkout(hash, true); // Have to move away from the master branch to allow pushes</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var marksHostedRepo = new TestHostedRepository(host, &quot;test&quot;, marksLocalRepo);</span>
<span class="udiff-line-added">+             this.marksRepo(marksHostedRepo);</span>
<span class="udiff-line-added">+             this.marksRef(&quot;master&quot;);</span>
<span class="udiff-line-added">+             this.marksAuthorName(&quot;J. Duke&quot;);</span>
<span class="udiff-line-added">+             this.marksAuthorEmail(&quot;j@duke.duke&quot;);</span>
          }
  
          void setBadAuthors() {
              this.badAuthors = true;
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -137,16 +154,17 @@</span>
      void bridgeTest(TestInfo testInfo) throws IOException {
          try (var credentials = new HostCredentials(testInfo);
               var hgFolder = new TemporaryDirectory();
               var gitFolder = new TemporaryDirectory();
               var storageFolder = new TemporaryDirectory();
<span class="udiff-line-modified-removed">-              var storageFolder2 = new TemporaryDirectory()) {</span>
<span class="udiff-line-modified-added">+              var storageFolder2 = new TemporaryDirectory();</span>
<span class="udiff-line-added">+              var marksFolder = new TemporaryDirectory()) {</span>
              // Export a partial version of a hg repository
              var localHgRepo = Repository.materialize(hgFolder.path(), source, &quot;default&quot;);
              localHgRepo.fetch(source, &quot;testlock&quot;);
              var destinationRepo = credentials.getHostedRepository();
<span class="udiff-line-modified-removed">-             var config = new TestExporterConfig(localHgRepo.root().toUri(), destinationRepo);</span>
<span class="udiff-line-modified-added">+             var config = new TestExporterConfig(localHgRepo.root().toUri(), destinationRepo, marksFolder.path());</span>
              var bridge = new JBridgeBot(config, storageFolder.path());
  
              runHgCommand(localHgRepo, &quot;strip&quot;, &quot;-r&quot;, &quot;bd7a3ed1210f&quot;);
              TestBotRunner.runPeriodicItems(bridge);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -186,15 +204,16 @@</span>
  
      @Test
      void bridgeCorruptedStorageHg(TestInfo testInfo) throws IOException {
          try (var credentials = new HostCredentials(testInfo);
               var storageFolder = new TemporaryDirectory();
<span class="udiff-line-modified-removed">-              var gitFolder = new TemporaryDirectory()) {</span>
<span class="udiff-line-modified-added">+              var gitFolder = new TemporaryDirectory();</span>
<span class="udiff-line-added">+              var marksFolder = new TemporaryDirectory()) {</span>
              var destinationRepo = credentials.getHostedRepository();
  
              // Export an hg repository as is
<span class="udiff-line-modified-removed">-             var config = new TestExporterConfig(source, destinationRepo);</span>
<span class="udiff-line-modified-added">+             var config = new TestExporterConfig(source, destinationRepo, marksFolder.path());</span>
              var bridge = new JBridgeBot(config, storageFolder.path());
              TestBotRunner.runPeriodicItems(bridge);
  
              // Materialize it and ensure that it contains a known commit
              var localGitRepo = Repository.materialize(gitFolder.path(), destinationRepo.getUrl(), &quot;master&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -224,21 +243,22 @@</span>
      @Test
      void bridgeExportScriptFailure(TestInfo testInfo) throws IOException {
          try (var credentials = new HostCredentials(testInfo);
               var storageFolder = new TemporaryDirectory();
               var storageFolder2 = new TemporaryDirectory();
<span class="udiff-line-modified-removed">-              var gitFolder = new TemporaryDirectory()) {</span>
<span class="udiff-line-modified-added">+              var gitFolder = new TemporaryDirectory();</span>
<span class="udiff-line-added">+              var marksFolder = new TemporaryDirectory()) {</span>
              var destinationRepo = credentials.getHostedRepository();
  
              // Export an hg repository but with an empty authors list
<span class="udiff-line-modified-removed">-             var config = new TestExporterConfig(source, destinationRepo);</span>
<span class="udiff-line-modified-added">+             var config = new TestExporterConfig(source, destinationRepo, marksFolder.path());</span>
              config.setBadAuthors();
              var badBridge = new JBridgeBot(config, storageFolder.path());
              assertThrows(RuntimeException.class, () -&gt; TestBotRunner.runPeriodicItems(badBridge));
  
              // Now once again with a correct configuration
<span class="udiff-line-modified-removed">-             config = new TestExporterConfig(source, destinationRepo);</span>
<span class="udiff-line-modified-added">+             config = new TestExporterConfig(source, destinationRepo, marksFolder.path());</span>
              var goodBridge = new JBridgeBot(config, storageFolder2.path());
              TestBotRunner.runPeriodicItems(goodBridge);
  
              // Verify that it now contains a known commit
              var localGitRepo = Repository.materialize(gitFolder.path(), destinationRepo.getUrl(), &quot;master&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -252,13 +272,14 @@</span>
          try (var credentials = new HostCredentials(testInfo);
               var storageFolder = new TemporaryDirectory();
               var gitFolder = new TemporaryDirectory();
               var gitFolder2 = new TemporaryDirectory();
               var gitFolder3 = new TemporaryDirectory();
<span class="udiff-line-modified-removed">-              var gitFolder4 = new TemporaryDirectory()) {</span>
<span class="udiff-line-modified-added">+              var gitFolder4 = new TemporaryDirectory();</span>
<span class="udiff-line-added">+              var marksFolder = new TemporaryDirectory()) {</span>
              var destinationRepo = credentials.getHostedRepository();
<span class="udiff-line-modified-removed">-             var config = new TestExporterConfig(source, destinationRepo);</span>
<span class="udiff-line-modified-added">+             var config = new TestExporterConfig(source, destinationRepo, marksFolder.path());</span>
  
              // Export an hg repository as is
              var bridge = new JBridgeBot(config, storageFolder.path());
              TestBotRunner.runPeriodicItems(bridge);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -293,13 +314,14 @@</span>
               var storageFolder = new TemporaryDirectory();
               var gitFolder = new TemporaryDirectory();
               var gitFolder2 = new TemporaryDirectory();
               var gitFolder3 = new TemporaryDirectory();
               var gitFolder4 = new TemporaryDirectory();
<span class="udiff-line-modified-removed">-              var gitFolder5 = new TemporaryDirectory()) {</span>
<span class="udiff-line-modified-added">+              var gitFolder5 = new TemporaryDirectory();</span>
<span class="udiff-line-added">+              var marksFolder = new TemporaryDirectory()) {</span>
              var destinationRepo = credentials.getHostedRepository();
<span class="udiff-line-modified-removed">-             var config = new TestExporterConfig(source, destinationRepo);</span>
<span class="udiff-line-modified-added">+             var config = new TestExporterConfig(source, destinationRepo, marksFolder.path());</span>
  
              // Export an hg repository as is
              var bridge = new JBridgeBot(config, storageFolder.path());
              TestBotRunner.runPeriodicItems(bridge);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -349,18 +371,17 @@</span>
  
      @Test
      void filterUnreachable(TestInfo testInfo) throws IOException {
          try (var credentials = new HostCredentials(testInfo);
               var hgFolder = new TemporaryDirectory();
<span class="udiff-line-removed">-              var gitFolder = new TemporaryDirectory();</span>
               var storageFolder = new TemporaryDirectory();
<span class="udiff-line-modified-removed">-              var storageFolder2 = new TemporaryDirectory()) {</span>
<span class="udiff-line-modified-added">+              var marksFolder = new TemporaryDirectory()) {</span>
              // Export a hg repository with unreachable commits
              var localHgRepo = Repository.materialize(hgFolder.path(), source, &quot;default&quot;);
              localHgRepo.fetch(source, &quot;testlock&quot;);
              var destinationRepo = credentials.getHostedRepository();
<span class="udiff-line-modified-removed">-             var config = new TestExporterConfig(localHgRepo.root().toUri(), destinationRepo);</span>
<span class="udiff-line-modified-added">+             var config = new TestExporterConfig(localHgRepo.root().toUri(), destinationRepo, marksFolder.path());</span>
              var bridge = new JBridgeBot(config, storageFolder.path());
  
              runHgCommand(localHgRepo, &quot;update&quot;, &quot;-r&quot;, &quot;5&quot;);
              var other = localHgRepo.root().resolve(&quot;other.txt&quot;);
              Files.writeString(other, &quot;Hello&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -373,6 +394,41 @@</span>
  
              // The second conversion should not encounter unreachable commits in the marks file
              TestBotRunner.runPeriodicItems(bridge);
          }
      }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Test</span>
<span class="udiff-line-added">+     void changedMarks(TestInfo testInfo) throws IOException {</span>
<span class="udiff-line-added">+         try (var credentials = new HostCredentials(testInfo);</span>
<span class="udiff-line-added">+              var hgFolder = new TemporaryDirectory();</span>
<span class="udiff-line-added">+              var storageFolder = new TemporaryDirectory();</span>
<span class="udiff-line-added">+              var storageFolder2 = new TemporaryDirectory();</span>
<span class="udiff-line-added">+              var marksFolder = new TemporaryDirectory()) {</span>
<span class="udiff-line-added">+             // Export a hg repository</span>
<span class="udiff-line-added">+             var localHgRepo = Repository.materialize(hgFolder.path(), source, &quot;default&quot;);</span>
<span class="udiff-line-added">+             localHgRepo.fetch(source, &quot;testlock&quot;);</span>
<span class="udiff-line-added">+             var destinationRepo = credentials.getHostedRepository();</span>
<span class="udiff-line-added">+             var config = new TestExporterConfig(localHgRepo.root().toUri(), destinationRepo, marksFolder.path());</span>
<span class="udiff-line-added">+             var bridge = new JBridgeBot(config, storageFolder.path());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             runHgCommand(localHgRepo, &quot;update&quot;, &quot;-r&quot;, &quot;5&quot;);</span>
<span class="udiff-line-added">+             var other = localHgRepo.root().resolve(&quot;other.txt&quot;);</span>
<span class="udiff-line-added">+             Files.writeString(other, &quot;Hello&quot;);</span>
<span class="udiff-line-added">+             localHgRepo.add(other);</span>
<span class="udiff-line-added">+             localHgRepo.commit(&quot;First&quot;, &quot;duke&quot;, &quot;&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Do an initial conversion</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(bridge);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Now roll back and commit something else</span>
<span class="udiff-line-added">+             runHgCommand(localHgRepo, &quot;update&quot;, &quot;-r&quot;, &quot;5&quot;);</span>
<span class="udiff-line-added">+             Files.writeString(other, &quot;There&quot;);</span>
<span class="udiff-line-added">+             localHgRepo.add(other);</span>
<span class="udiff-line-added">+             localHgRepo.commit(&quot;Second&quot;, &quot;duke&quot;, &quot;&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // The second conversion (with fresh storage) should detect that marks have changed</span>
<span class="udiff-line-added">+             var newBridge = new JBridgeBot(config, storageFolder2.path());</span>
<span class="udiff-line-added">+             assertThrows(RuntimeException.class, () -&gt; TestBotRunner.runPeriodicItems(newBridge));</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
  }
</pre>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/hgbridge/JBridgeBotFactory.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../../vcs/src/main/java/org/openjdk/skara/vcs/openjdk/convert/HgToGitConverter.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>