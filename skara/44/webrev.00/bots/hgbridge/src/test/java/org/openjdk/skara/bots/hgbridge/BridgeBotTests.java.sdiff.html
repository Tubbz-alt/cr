<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/hgbridge/src/test/java/org/openjdk/skara/bots/hgbridge/BridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/hgbridge/JBridgeBotFactory.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../../vcs/src/main/java/org/openjdk/skara/vcs/openjdk/convert/HgToGitConverter.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/hgbridge/src/test/java/org/openjdk/skara/bots/hgbridge/BridgeBotTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.bots.hgbridge;
 24 
<span class="line-modified"> 25 import org.openjdk.skara.host.HostedRepository;</span>
 26 import org.openjdk.skara.host.network.URIBuilder;
 27 import org.openjdk.skara.process.Process;
 28 import org.openjdk.skara.test.*;
 29 import org.openjdk.skara.vcs.Tag;
 30 import org.openjdk.skara.vcs.*;
 31 import org.openjdk.skara.vcs.openjdk.convert.*;
 32 
 33 import org.junit.jupiter.api.*;
 34 
 35 import java.io.*;
 36 import java.net.URI;
 37 import java.nio.charset.StandardCharsets;
 38 import java.nio.file.*;
 39 import java.time.ZonedDateTime;
 40 import java.time.format.DateTimeFormatter;
 41 import java.util.*;
 42 import java.util.stream.Collectors;
 43 
 44 import static org.junit.jupiter.api.Assertions.*;
 45 
</pre>
<hr />
<pre>
 46 @TestInstance(TestInstance.Lifecycle.PER_CLASS)
 47 class BridgeBotTests {
 48     private List&lt;String&gt; runHgCommand(Repository repository, String... params) throws IOException {
 49         List&lt;String&gt; finalParams = new ArrayList&lt;&gt;();
 50         finalParams.add(&quot;hg&quot;);
 51         finalParams.addAll(List.of(&quot;--config&quot;, &quot;extensions.strip=&quot;));
 52 
 53         finalParams.addAll(List.of(params));
 54         try (var p = Process.capture(finalParams.toArray(new String[0]))
 55                             .workdir(repository.root().toString())
 56                             .environ(&quot;HGRCPATH&quot;, &quot;&quot;)
 57                             .environ(&quot;HGPLAIN&quot;, &quot;&quot;)
 58                             .execute()) {
 59             return p.check().stdout();
 60         }
 61     }
 62 
 63     static class TestExporterConfig extends ExporterConfig {
 64         private boolean badAuthors = false;
 65 
<span class="line-modified"> 66         TestExporterConfig(URI source, HostedRepository destination) {</span>
 67             this.source(source);
 68             this.destinations(List.of(destination));

















 69         }
 70 
 71         void setBadAuthors() {
 72             this.badAuthors = true;
 73         }
 74 
 75         @Override
 76         public Converter resolve(Path scratchPath) {
 77             var replacements = new HashMap&lt;Hash, List&lt;String&gt;&gt;();
 78             var corrections = new HashMap&lt;Hash, Map&lt;String, String&gt;&gt;();
 79             var lowercase = new HashSet&lt;Hash&gt;();
 80             var punctuated = new HashSet&lt;Hash&gt;();
 81 
 82             var authors = Map.of(&quot;jjg&quot;, &quot;JJG &lt;jjg@openjdk.java.net&gt;&quot;,
 83                                  &quot;duke&quot;, &quot;Duke &lt;duke@openjdk.java.net&gt;&quot;);
 84             var contributors = new HashMap&lt;String, String&gt;();
 85             var sponsors = new HashMap&lt;String, List&lt;String&gt;&gt;();
 86 
 87             return new HgToGitConverter(replacements, corrections, lowercase, punctuated, badAuthors ? Map.of() : authors, contributors, sponsors);
 88         }
</pre>
<hr />
<pre>
122             Files.writeString(lockFile, ZonedDateTime.now().format(DateTimeFormatter.ISO_DATE_TIME), StandardCharsets.UTF_8);
123             localRepo.add(lockFile);
124             localRepo.commit(&quot;Lock&quot;, &quot;duke&quot;, &quot;Duke &lt;duke@openjdk.java.net&gt;&quot;);
125         } catch (IOException e) {
126             Assumptions.assumeTrue(false, &quot;Failed to connect to hg.openjdk.java.net - skipping tests&quot;);
127         }
128         this.source = sourceFolder.path().toUri();
129     }
130 
131     @AfterAll
132     void teardown() {
133         sourceFolder.close();
134     }
135 
136     @Test
137     void bridgeTest(TestInfo testInfo) throws IOException {
138         try (var credentials = new HostCredentials(testInfo);
139              var hgFolder = new TemporaryDirectory();
140              var gitFolder = new TemporaryDirectory();
141              var storageFolder = new TemporaryDirectory();
<span class="line-modified">142              var storageFolder2 = new TemporaryDirectory()) {</span>

143             // Export a partial version of a hg repository
144             var localHgRepo = Repository.materialize(hgFolder.path(), source, &quot;default&quot;);
145             localHgRepo.fetch(source, &quot;testlock&quot;);
146             var destinationRepo = credentials.getHostedRepository();
<span class="line-modified">147             var config = new TestExporterConfig(localHgRepo.root().toUri(), destinationRepo);</span>
148             var bridge = new JBridgeBot(config, storageFolder.path());
149 
150             runHgCommand(localHgRepo, &quot;strip&quot;, &quot;-r&quot;, &quot;bd7a3ed1210f&quot;);
151             TestBotRunner.runPeriodicItems(bridge);
152 
153             var localGitRepo = Repository.materialize(gitFolder.path(), destinationRepo.getUrl(), &quot;master&quot;);
154 
155             // Only a subset of known tags should be present
156             var localGitTags = getTagNames(localGitRepo);
157             assertEquals(getTagNames(localHgRepo), localGitTags);
158             assertTrue(localGitTags.contains(&quot;jtreg4.1-b02&quot;));
159             assertFalse(localGitTags.contains(&quot;jtreg4.1-b05&quot;));
160 
161             // Import more revisions into the local hg repository and export again
162             localHgRepo.fetch(source, &quot;default&quot;);
163             TestBotRunner.runPeriodicItems(bridge);
164 
165             // There should now be more tags present
166             Repository.materialize(gitFolder.path(), destinationRepo.getUrl(), &quot;master&quot;);
167             localGitTags = getTagNames(localGitRepo);
</pre>
<hr />
<pre>
171 
172             // Export it again with different storage to force an export from scratch
173             bridge = new JBridgeBot(config, storageFolder2.path());
174             TestBotRunner.runPeriodicItems(bridge);
175             Repository.materialize(gitFolder.path(), destinationRepo.getUrl(), &quot;master&quot;);
176             var newLocalGitTags = getTagNames(localGitRepo);
177             assertEquals(localGitTags, newLocalGitTags);
178 
179             // Export it once more when nothing has changed
180             TestBotRunner.runPeriodicItems(bridge);
181             Repository.materialize(gitFolder.path(), destinationRepo.getUrl(), &quot;master&quot;);
182             newLocalGitTags = getTagNames(localGitRepo);
183             assertEquals(localGitTags, newLocalGitTags);
184         }
185     }
186 
187     @Test
188     void bridgeCorruptedStorageHg(TestInfo testInfo) throws IOException {
189         try (var credentials = new HostCredentials(testInfo);
190              var storageFolder = new TemporaryDirectory();
<span class="line-modified">191              var gitFolder = new TemporaryDirectory()) {</span>

192             var destinationRepo = credentials.getHostedRepository();
193 
194             // Export an hg repository as is
<span class="line-modified">195             var config = new TestExporterConfig(source, destinationRepo);</span>
196             var bridge = new JBridgeBot(config, storageFolder.path());
197             TestBotRunner.runPeriodicItems(bridge);
198 
199             // Materialize it and ensure that it contains a known commit
200             var localGitRepo = Repository.materialize(gitFolder.path(), destinationRepo.getUrl(), &quot;master&quot;);
201             var localGitCommits = getCommitHashes(localGitRepo);
202             assertTrue(localGitCommits.contains(&quot;9cb6a5b843c0e9f6d45273a1a6f5c98979ab0766&quot;));
203 
204             // Now corrupt the .hg folder in the permanent storage
205             Files.walk(storageFolder.path())
206                  .filter(p -&gt; p.toString().contains(&quot;/.hg/&quot;))
207                  .filter(p -&gt; p.toFile().isFile())
208                  .forEach(p -&gt; {
209                      try {
210                          Files.delete(p);
211                      } catch (IOException e) {
212                          throw new UncheckedIOException(e);
213                      }
214                  });
215 
</pre>
<hr />
<pre>
209                      try {
210                          Files.delete(p);
211                      } catch (IOException e) {
212                          throw new UncheckedIOException(e);
213                      }
214                  });
215 
216             // Now export it again - should still be intact
217             TestBotRunner.runPeriodicItems(bridge);
218             Repository.materialize(gitFolder.path(), destinationRepo.getUrl(), &quot;master&quot;);
219             localGitCommits = getCommitHashes(localGitRepo);
220             assertTrue(localGitCommits.contains(&quot;9cb6a5b843c0e9f6d45273a1a6f5c98979ab0766&quot;));
221         }
222     }
223 
224     @Test
225     void bridgeExportScriptFailure(TestInfo testInfo) throws IOException {
226         try (var credentials = new HostCredentials(testInfo);
227              var storageFolder = new TemporaryDirectory();
228              var storageFolder2 = new TemporaryDirectory();
<span class="line-modified">229              var gitFolder = new TemporaryDirectory()) {</span>

230             var destinationRepo = credentials.getHostedRepository();
231 
232             // Export an hg repository but with an empty authors list
<span class="line-modified">233             var config = new TestExporterConfig(source, destinationRepo);</span>
234             config.setBadAuthors();
235             var badBridge = new JBridgeBot(config, storageFolder.path());
236             assertThrows(RuntimeException.class, () -&gt; TestBotRunner.runPeriodicItems(badBridge));
237 
238             // Now once again with a correct configuration
<span class="line-modified">239             config = new TestExporterConfig(source, destinationRepo);</span>
240             var goodBridge = new JBridgeBot(config, storageFolder2.path());
241             TestBotRunner.runPeriodicItems(goodBridge);
242 
243             // Verify that it now contains a known commit
244             var localGitRepo = Repository.materialize(gitFolder.path(), destinationRepo.getUrl(), &quot;master&quot;);
245             var localGitCommits = getCommitHashes(localGitRepo);
246             assertTrue(localGitCommits.contains(&quot;9cb6a5b843c0e9f6d45273a1a6f5c98979ab0766&quot;));
247         }
248     }
249 
250     @Test
251     void bridgeReuseMarks(TestInfo testInfo) throws IOException {
252         try (var credentials = new HostCredentials(testInfo);
253              var storageFolder = new TemporaryDirectory();
254              var gitFolder = new TemporaryDirectory();
255              var gitFolder2 = new TemporaryDirectory();
256              var gitFolder3 = new TemporaryDirectory();
<span class="line-modified">257              var gitFolder4 = new TemporaryDirectory()) {</span>

258             var destinationRepo = credentials.getHostedRepository();
<span class="line-modified">259             var config = new TestExporterConfig(source, destinationRepo);</span>
260 
261             // Export an hg repository as is
262             var bridge = new JBridgeBot(config, storageFolder.path());
263             TestBotRunner.runPeriodicItems(bridge);
264 
265             // Materialize it and ensure that it contains a known commit
266             var localGitRepo = Repository.materialize(gitFolder.path(), destinationRepo.getUrl(), &quot;master&quot;);
267             var localGitCommits = getCommitHashes(localGitRepo);
268             assertTrue(localGitCommits.contains(&quot;9cb6a5b843c0e9f6d45273a1a6f5c98979ab0766&quot;));
269 
270             // Push something else to overwrite it (but retain the lock)
271             var localRepo = CheckableRepository.init(gitFolder2.path(), destinationRepo.getRepositoryType());
272             credentials.commitLock(localRepo);
273             localRepo.pushAll(destinationRepo.getUrl());
274 
275             // Materialize it again and ensure that the known commit is now gone
276             localGitRepo = Repository.materialize(gitFolder3.path(), destinationRepo.getUrl(), &quot;master&quot;);
277             localGitCommits = getCommitHashes(localGitRepo);
278             assertFalse(localGitCommits.contains(&quot;9cb6a5b843c0e9f6d45273a1a6f5c98979ab0766&quot;));
279 
</pre>
<hr />
<pre>
278             assertFalse(localGitCommits.contains(&quot;9cb6a5b843c0e9f6d45273a1a6f5c98979ab0766&quot;));
279 
280             // Now run the exporter again - nothing should happen
281             TestBotRunner.runPeriodicItems(bridge);
282 
283             // Materialize it yet again and ensure that the known commit is still gone
284             localGitRepo = Repository.materialize(gitFolder4.path(), destinationRepo.getUrl(), &quot;master&quot;);
285             localGitCommits = getCommitHashes(localGitRepo);
286             assertFalse(localGitCommits.contains(&quot;9cb6a5b843c0e9f6d45273a1a6f5c98979ab0766&quot;));
287         }
288     }
289 
290     @Test
291     void retryFailedPush(TestInfo testInfo) throws IOException {
292         try (var credentials = new HostCredentials(testInfo);
293              var storageFolder = new TemporaryDirectory();
294              var gitFolder = new TemporaryDirectory();
295              var gitFolder2 = new TemporaryDirectory();
296              var gitFolder3 = new TemporaryDirectory();
297              var gitFolder4 = new TemporaryDirectory();
<span class="line-modified">298              var gitFolder5 = new TemporaryDirectory()) {</span>

299             var destinationRepo = credentials.getHostedRepository();
<span class="line-modified">300             var config = new TestExporterConfig(source, destinationRepo);</span>
301 
302             // Export an hg repository as is
303             var bridge = new JBridgeBot(config, storageFolder.path());
304             TestBotRunner.runPeriodicItems(bridge);
305 
306             // Materialize it and ensure that it contains a known commit
307             var localGitRepo = Repository.materialize(gitFolder.path(), destinationRepo.getUrl(), &quot;master&quot;);
308             var localGitCommits = getCommitHashes(localGitRepo);
309             assertTrue(localGitCommits.contains(&quot;9cb6a5b843c0e9f6d45273a1a6f5c98979ab0766&quot;));
310 
311             // Push something else to overwrite it
312             var localRepo = CheckableRepository.init(gitFolder2.path(), destinationRepo.getRepositoryType());
313             localRepo.pushAll(destinationRepo.getUrl());
314 
315             // Materialize it again and ensure that the known commit is now gone
316             localGitRepo = Repository.materialize(gitFolder3.path(), destinationRepo.getUrl(), &quot;master&quot;);
317             localGitCommits = getCommitHashes(localGitRepo);
318             assertFalse(localGitCommits.contains(&quot;9cb6a5b843c0e9f6d45273a1a6f5c98979ab0766&quot;));
319 
320             // Now run the exporter again - nothing should happen
</pre>
<hr />
<pre>
334                          Files.delete(p);
335                      } catch (IOException e) {
336                          throw new UncheckedIOException(e);
337                      }
338                  });
339 
340             // Now run the exporter again - it should do the push again
341             TestBotRunner.runPeriodicItems(bridge);
342 
343             // Materialize it and ensure that the known commit is back
344             localGitRepo = Repository.materialize(gitFolder5.path(), destinationRepo.getUrl(), &quot;master&quot;);
345             localGitCommits = getCommitHashes(localGitRepo);
346             assertTrue(localGitCommits.contains(&quot;9cb6a5b843c0e9f6d45273a1a6f5c98979ab0766&quot;));
347         }
348     }
349 
350     @Test
351     void filterUnreachable(TestInfo testInfo) throws IOException {
352         try (var credentials = new HostCredentials(testInfo);
353              var hgFolder = new TemporaryDirectory();
<span class="line-removed">354              var gitFolder = new TemporaryDirectory();</span>
355              var storageFolder = new TemporaryDirectory();
<span class="line-modified">356              var storageFolder2 = new TemporaryDirectory()) {</span>
357             // Export a hg repository with unreachable commits
358             var localHgRepo = Repository.materialize(hgFolder.path(), source, &quot;default&quot;);
359             localHgRepo.fetch(source, &quot;testlock&quot;);
360             var destinationRepo = credentials.getHostedRepository();
<span class="line-modified">361             var config = new TestExporterConfig(localHgRepo.root().toUri(), destinationRepo);</span>
362             var bridge = new JBridgeBot(config, storageFolder.path());
363 
364             runHgCommand(localHgRepo, &quot;update&quot;, &quot;-r&quot;, &quot;5&quot;);
365             var other = localHgRepo.root().resolve(&quot;other.txt&quot;);
366             Files.writeString(other, &quot;Hello&quot;);
367             localHgRepo.add(other);
368             localHgRepo.commit(&quot;Another head&quot;, &quot;duke&quot;, &quot;&quot;);
369             runHgCommand(localHgRepo, &quot;commit&quot;, &quot;--close-branch&quot;, &quot;--user=duke&quot;, &quot;-m&quot;, &quot;closing head&quot;);
370 
371             // Do an initial conversion, it will drop the closed head
372             TestBotRunner.runPeriodicItems(bridge);
373 
374             // The second conversion should not encounter unreachable commits in the marks file
375             TestBotRunner.runPeriodicItems(bridge);
376         }
377     }



































378 }
</pre>
</td>
<td>
<hr />
<pre>
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.bots.hgbridge;
 24 
<span class="line-modified"> 25 import org.openjdk.skara.host.*;</span>
 26 import org.openjdk.skara.host.network.URIBuilder;
 27 import org.openjdk.skara.process.Process;
 28 import org.openjdk.skara.test.*;
 29 import org.openjdk.skara.vcs.Tag;
 30 import org.openjdk.skara.vcs.*;
 31 import org.openjdk.skara.vcs.openjdk.convert.*;
 32 
 33 import org.junit.jupiter.api.*;
 34 
 35 import java.io.*;
 36 import java.net.URI;
 37 import java.nio.charset.StandardCharsets;
 38 import java.nio.file.*;
 39 import java.time.ZonedDateTime;
 40 import java.time.format.DateTimeFormatter;
 41 import java.util.*;
 42 import java.util.stream.Collectors;
 43 
 44 import static org.junit.jupiter.api.Assertions.*;
 45 
</pre>
<hr />
<pre>
 46 @TestInstance(TestInstance.Lifecycle.PER_CLASS)
 47 class BridgeBotTests {
 48     private List&lt;String&gt; runHgCommand(Repository repository, String... params) throws IOException {
 49         List&lt;String&gt; finalParams = new ArrayList&lt;&gt;();
 50         finalParams.add(&quot;hg&quot;);
 51         finalParams.addAll(List.of(&quot;--config&quot;, &quot;extensions.strip=&quot;));
 52 
 53         finalParams.addAll(List.of(params));
 54         try (var p = Process.capture(finalParams.toArray(new String[0]))
 55                             .workdir(repository.root().toString())
 56                             .environ(&quot;HGRCPATH&quot;, &quot;&quot;)
 57                             .environ(&quot;HGPLAIN&quot;, &quot;&quot;)
 58                             .execute()) {
 59             return p.check().stdout();
 60         }
 61     }
 62 
 63     static class TestExporterConfig extends ExporterConfig {
 64         private boolean badAuthors = false;
 65 
<span class="line-modified"> 66         TestExporterConfig(URI source, HostedRepository destination, Path marksRepoPath) throws IOException {</span>
 67             this.source(source);
 68             this.destinations(List.of(destination));
<span class="line-added"> 69 </span>
<span class="line-added"> 70             var host = TestHost.createNew(List.of(new HostUserDetails(0, &quot;duke&quot;, &quot;J. Duke&quot;)));</span>
<span class="line-added"> 71             var marksLocalRepo = Repository.init(marksRepoPath.resolve(&quot;marks.git&quot;), VCS.GIT);</span>
<span class="line-added"> 72 </span>
<span class="line-added"> 73             var initialFile = marksLocalRepo.root().resolve(&quot;init.txt&quot;);</span>
<span class="line-added"> 74             if (!Files.exists(initialFile)) {</span>
<span class="line-added"> 75                 Files.writeString(initialFile, &quot;Hello&quot;, StandardCharsets.UTF_8);</span>
<span class="line-added"> 76                 marksLocalRepo.add(initialFile);</span>
<span class="line-added"> 77                 var hash = marksLocalRepo.commit(&quot;First&quot;, &quot;duke&quot;, &quot;duke@duke.duke&quot;);</span>
<span class="line-added"> 78                 marksLocalRepo.checkout(hash, true); // Have to move away from the master branch to allow pushes</span>
<span class="line-added"> 79             }</span>
<span class="line-added"> 80 </span>
<span class="line-added"> 81             var marksHostedRepo = new TestHostedRepository(host, &quot;test&quot;, marksLocalRepo);</span>
<span class="line-added"> 82             this.marksRepo(marksHostedRepo);</span>
<span class="line-added"> 83             this.marksRef(&quot;master&quot;);</span>
<span class="line-added"> 84             this.marksAuthorName(&quot;J. Duke&quot;);</span>
<span class="line-added"> 85             this.marksAuthorEmail(&quot;j@duke.duke&quot;);</span>
 86         }
 87 
 88         void setBadAuthors() {
 89             this.badAuthors = true;
 90         }
 91 
 92         @Override
 93         public Converter resolve(Path scratchPath) {
 94             var replacements = new HashMap&lt;Hash, List&lt;String&gt;&gt;();
 95             var corrections = new HashMap&lt;Hash, Map&lt;String, String&gt;&gt;();
 96             var lowercase = new HashSet&lt;Hash&gt;();
 97             var punctuated = new HashSet&lt;Hash&gt;();
 98 
 99             var authors = Map.of(&quot;jjg&quot;, &quot;JJG &lt;jjg@openjdk.java.net&gt;&quot;,
100                                  &quot;duke&quot;, &quot;Duke &lt;duke@openjdk.java.net&gt;&quot;);
101             var contributors = new HashMap&lt;String, String&gt;();
102             var sponsors = new HashMap&lt;String, List&lt;String&gt;&gt;();
103 
104             return new HgToGitConverter(replacements, corrections, lowercase, punctuated, badAuthors ? Map.of() : authors, contributors, sponsors);
105         }
</pre>
<hr />
<pre>
139             Files.writeString(lockFile, ZonedDateTime.now().format(DateTimeFormatter.ISO_DATE_TIME), StandardCharsets.UTF_8);
140             localRepo.add(lockFile);
141             localRepo.commit(&quot;Lock&quot;, &quot;duke&quot;, &quot;Duke &lt;duke@openjdk.java.net&gt;&quot;);
142         } catch (IOException e) {
143             Assumptions.assumeTrue(false, &quot;Failed to connect to hg.openjdk.java.net - skipping tests&quot;);
144         }
145         this.source = sourceFolder.path().toUri();
146     }
147 
148     @AfterAll
149     void teardown() {
150         sourceFolder.close();
151     }
152 
153     @Test
154     void bridgeTest(TestInfo testInfo) throws IOException {
155         try (var credentials = new HostCredentials(testInfo);
156              var hgFolder = new TemporaryDirectory();
157              var gitFolder = new TemporaryDirectory();
158              var storageFolder = new TemporaryDirectory();
<span class="line-modified">159              var storageFolder2 = new TemporaryDirectory();</span>
<span class="line-added">160              var marksFolder = new TemporaryDirectory()) {</span>
161             // Export a partial version of a hg repository
162             var localHgRepo = Repository.materialize(hgFolder.path(), source, &quot;default&quot;);
163             localHgRepo.fetch(source, &quot;testlock&quot;);
164             var destinationRepo = credentials.getHostedRepository();
<span class="line-modified">165             var config = new TestExporterConfig(localHgRepo.root().toUri(), destinationRepo, marksFolder.path());</span>
166             var bridge = new JBridgeBot(config, storageFolder.path());
167 
168             runHgCommand(localHgRepo, &quot;strip&quot;, &quot;-r&quot;, &quot;bd7a3ed1210f&quot;);
169             TestBotRunner.runPeriodicItems(bridge);
170 
171             var localGitRepo = Repository.materialize(gitFolder.path(), destinationRepo.getUrl(), &quot;master&quot;);
172 
173             // Only a subset of known tags should be present
174             var localGitTags = getTagNames(localGitRepo);
175             assertEquals(getTagNames(localHgRepo), localGitTags);
176             assertTrue(localGitTags.contains(&quot;jtreg4.1-b02&quot;));
177             assertFalse(localGitTags.contains(&quot;jtreg4.1-b05&quot;));
178 
179             // Import more revisions into the local hg repository and export again
180             localHgRepo.fetch(source, &quot;default&quot;);
181             TestBotRunner.runPeriodicItems(bridge);
182 
183             // There should now be more tags present
184             Repository.materialize(gitFolder.path(), destinationRepo.getUrl(), &quot;master&quot;);
185             localGitTags = getTagNames(localGitRepo);
</pre>
<hr />
<pre>
189 
190             // Export it again with different storage to force an export from scratch
191             bridge = new JBridgeBot(config, storageFolder2.path());
192             TestBotRunner.runPeriodicItems(bridge);
193             Repository.materialize(gitFolder.path(), destinationRepo.getUrl(), &quot;master&quot;);
194             var newLocalGitTags = getTagNames(localGitRepo);
195             assertEquals(localGitTags, newLocalGitTags);
196 
197             // Export it once more when nothing has changed
198             TestBotRunner.runPeriodicItems(bridge);
199             Repository.materialize(gitFolder.path(), destinationRepo.getUrl(), &quot;master&quot;);
200             newLocalGitTags = getTagNames(localGitRepo);
201             assertEquals(localGitTags, newLocalGitTags);
202         }
203     }
204 
205     @Test
206     void bridgeCorruptedStorageHg(TestInfo testInfo) throws IOException {
207         try (var credentials = new HostCredentials(testInfo);
208              var storageFolder = new TemporaryDirectory();
<span class="line-modified">209              var gitFolder = new TemporaryDirectory();</span>
<span class="line-added">210              var marksFolder = new TemporaryDirectory()) {</span>
211             var destinationRepo = credentials.getHostedRepository();
212 
213             // Export an hg repository as is
<span class="line-modified">214             var config = new TestExporterConfig(source, destinationRepo, marksFolder.path());</span>
215             var bridge = new JBridgeBot(config, storageFolder.path());
216             TestBotRunner.runPeriodicItems(bridge);
217 
218             // Materialize it and ensure that it contains a known commit
219             var localGitRepo = Repository.materialize(gitFolder.path(), destinationRepo.getUrl(), &quot;master&quot;);
220             var localGitCommits = getCommitHashes(localGitRepo);
221             assertTrue(localGitCommits.contains(&quot;9cb6a5b843c0e9f6d45273a1a6f5c98979ab0766&quot;));
222 
223             // Now corrupt the .hg folder in the permanent storage
224             Files.walk(storageFolder.path())
225                  .filter(p -&gt; p.toString().contains(&quot;/.hg/&quot;))
226                  .filter(p -&gt; p.toFile().isFile())
227                  .forEach(p -&gt; {
228                      try {
229                          Files.delete(p);
230                      } catch (IOException e) {
231                          throw new UncheckedIOException(e);
232                      }
233                  });
234 
</pre>
<hr />
<pre>
228                      try {
229                          Files.delete(p);
230                      } catch (IOException e) {
231                          throw new UncheckedIOException(e);
232                      }
233                  });
234 
235             // Now export it again - should still be intact
236             TestBotRunner.runPeriodicItems(bridge);
237             Repository.materialize(gitFolder.path(), destinationRepo.getUrl(), &quot;master&quot;);
238             localGitCommits = getCommitHashes(localGitRepo);
239             assertTrue(localGitCommits.contains(&quot;9cb6a5b843c0e9f6d45273a1a6f5c98979ab0766&quot;));
240         }
241     }
242 
243     @Test
244     void bridgeExportScriptFailure(TestInfo testInfo) throws IOException {
245         try (var credentials = new HostCredentials(testInfo);
246              var storageFolder = new TemporaryDirectory();
247              var storageFolder2 = new TemporaryDirectory();
<span class="line-modified">248              var gitFolder = new TemporaryDirectory();</span>
<span class="line-added">249              var marksFolder = new TemporaryDirectory()) {</span>
250             var destinationRepo = credentials.getHostedRepository();
251 
252             // Export an hg repository but with an empty authors list
<span class="line-modified">253             var config = new TestExporterConfig(source, destinationRepo, marksFolder.path());</span>
254             config.setBadAuthors();
255             var badBridge = new JBridgeBot(config, storageFolder.path());
256             assertThrows(RuntimeException.class, () -&gt; TestBotRunner.runPeriodicItems(badBridge));
257 
258             // Now once again with a correct configuration
<span class="line-modified">259             config = new TestExporterConfig(source, destinationRepo, marksFolder.path());</span>
260             var goodBridge = new JBridgeBot(config, storageFolder2.path());
261             TestBotRunner.runPeriodicItems(goodBridge);
262 
263             // Verify that it now contains a known commit
264             var localGitRepo = Repository.materialize(gitFolder.path(), destinationRepo.getUrl(), &quot;master&quot;);
265             var localGitCommits = getCommitHashes(localGitRepo);
266             assertTrue(localGitCommits.contains(&quot;9cb6a5b843c0e9f6d45273a1a6f5c98979ab0766&quot;));
267         }
268     }
269 
270     @Test
271     void bridgeReuseMarks(TestInfo testInfo) throws IOException {
272         try (var credentials = new HostCredentials(testInfo);
273              var storageFolder = new TemporaryDirectory();
274              var gitFolder = new TemporaryDirectory();
275              var gitFolder2 = new TemporaryDirectory();
276              var gitFolder3 = new TemporaryDirectory();
<span class="line-modified">277              var gitFolder4 = new TemporaryDirectory();</span>
<span class="line-added">278              var marksFolder = new TemporaryDirectory()) {</span>
279             var destinationRepo = credentials.getHostedRepository();
<span class="line-modified">280             var config = new TestExporterConfig(source, destinationRepo, marksFolder.path());</span>
281 
282             // Export an hg repository as is
283             var bridge = new JBridgeBot(config, storageFolder.path());
284             TestBotRunner.runPeriodicItems(bridge);
285 
286             // Materialize it and ensure that it contains a known commit
287             var localGitRepo = Repository.materialize(gitFolder.path(), destinationRepo.getUrl(), &quot;master&quot;);
288             var localGitCommits = getCommitHashes(localGitRepo);
289             assertTrue(localGitCommits.contains(&quot;9cb6a5b843c0e9f6d45273a1a6f5c98979ab0766&quot;));
290 
291             // Push something else to overwrite it (but retain the lock)
292             var localRepo = CheckableRepository.init(gitFolder2.path(), destinationRepo.getRepositoryType());
293             credentials.commitLock(localRepo);
294             localRepo.pushAll(destinationRepo.getUrl());
295 
296             // Materialize it again and ensure that the known commit is now gone
297             localGitRepo = Repository.materialize(gitFolder3.path(), destinationRepo.getUrl(), &quot;master&quot;);
298             localGitCommits = getCommitHashes(localGitRepo);
299             assertFalse(localGitCommits.contains(&quot;9cb6a5b843c0e9f6d45273a1a6f5c98979ab0766&quot;));
300 
</pre>
<hr />
<pre>
299             assertFalse(localGitCommits.contains(&quot;9cb6a5b843c0e9f6d45273a1a6f5c98979ab0766&quot;));
300 
301             // Now run the exporter again - nothing should happen
302             TestBotRunner.runPeriodicItems(bridge);
303 
304             // Materialize it yet again and ensure that the known commit is still gone
305             localGitRepo = Repository.materialize(gitFolder4.path(), destinationRepo.getUrl(), &quot;master&quot;);
306             localGitCommits = getCommitHashes(localGitRepo);
307             assertFalse(localGitCommits.contains(&quot;9cb6a5b843c0e9f6d45273a1a6f5c98979ab0766&quot;));
308         }
309     }
310 
311     @Test
312     void retryFailedPush(TestInfo testInfo) throws IOException {
313         try (var credentials = new HostCredentials(testInfo);
314              var storageFolder = new TemporaryDirectory();
315              var gitFolder = new TemporaryDirectory();
316              var gitFolder2 = new TemporaryDirectory();
317              var gitFolder3 = new TemporaryDirectory();
318              var gitFolder4 = new TemporaryDirectory();
<span class="line-modified">319              var gitFolder5 = new TemporaryDirectory();</span>
<span class="line-added">320              var marksFolder = new TemporaryDirectory()) {</span>
321             var destinationRepo = credentials.getHostedRepository();
<span class="line-modified">322             var config = new TestExporterConfig(source, destinationRepo, marksFolder.path());</span>
323 
324             // Export an hg repository as is
325             var bridge = new JBridgeBot(config, storageFolder.path());
326             TestBotRunner.runPeriodicItems(bridge);
327 
328             // Materialize it and ensure that it contains a known commit
329             var localGitRepo = Repository.materialize(gitFolder.path(), destinationRepo.getUrl(), &quot;master&quot;);
330             var localGitCommits = getCommitHashes(localGitRepo);
331             assertTrue(localGitCommits.contains(&quot;9cb6a5b843c0e9f6d45273a1a6f5c98979ab0766&quot;));
332 
333             // Push something else to overwrite it
334             var localRepo = CheckableRepository.init(gitFolder2.path(), destinationRepo.getRepositoryType());
335             localRepo.pushAll(destinationRepo.getUrl());
336 
337             // Materialize it again and ensure that the known commit is now gone
338             localGitRepo = Repository.materialize(gitFolder3.path(), destinationRepo.getUrl(), &quot;master&quot;);
339             localGitCommits = getCommitHashes(localGitRepo);
340             assertFalse(localGitCommits.contains(&quot;9cb6a5b843c0e9f6d45273a1a6f5c98979ab0766&quot;));
341 
342             // Now run the exporter again - nothing should happen
</pre>
<hr />
<pre>
356                          Files.delete(p);
357                      } catch (IOException e) {
358                          throw new UncheckedIOException(e);
359                      }
360                  });
361 
362             // Now run the exporter again - it should do the push again
363             TestBotRunner.runPeriodicItems(bridge);
364 
365             // Materialize it and ensure that the known commit is back
366             localGitRepo = Repository.materialize(gitFolder5.path(), destinationRepo.getUrl(), &quot;master&quot;);
367             localGitCommits = getCommitHashes(localGitRepo);
368             assertTrue(localGitCommits.contains(&quot;9cb6a5b843c0e9f6d45273a1a6f5c98979ab0766&quot;));
369         }
370     }
371 
372     @Test
373     void filterUnreachable(TestInfo testInfo) throws IOException {
374         try (var credentials = new HostCredentials(testInfo);
375              var hgFolder = new TemporaryDirectory();

376              var storageFolder = new TemporaryDirectory();
<span class="line-modified">377              var marksFolder = new TemporaryDirectory()) {</span>
378             // Export a hg repository with unreachable commits
379             var localHgRepo = Repository.materialize(hgFolder.path(), source, &quot;default&quot;);
380             localHgRepo.fetch(source, &quot;testlock&quot;);
381             var destinationRepo = credentials.getHostedRepository();
<span class="line-modified">382             var config = new TestExporterConfig(localHgRepo.root().toUri(), destinationRepo, marksFolder.path());</span>
383             var bridge = new JBridgeBot(config, storageFolder.path());
384 
385             runHgCommand(localHgRepo, &quot;update&quot;, &quot;-r&quot;, &quot;5&quot;);
386             var other = localHgRepo.root().resolve(&quot;other.txt&quot;);
387             Files.writeString(other, &quot;Hello&quot;);
388             localHgRepo.add(other);
389             localHgRepo.commit(&quot;Another head&quot;, &quot;duke&quot;, &quot;&quot;);
390             runHgCommand(localHgRepo, &quot;commit&quot;, &quot;--close-branch&quot;, &quot;--user=duke&quot;, &quot;-m&quot;, &quot;closing head&quot;);
391 
392             // Do an initial conversion, it will drop the closed head
393             TestBotRunner.runPeriodicItems(bridge);
394 
395             // The second conversion should not encounter unreachable commits in the marks file
396             TestBotRunner.runPeriodicItems(bridge);
397         }
398     }
<span class="line-added">399 </span>
<span class="line-added">400     @Test</span>
<span class="line-added">401     void changedMarks(TestInfo testInfo) throws IOException {</span>
<span class="line-added">402         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added">403              var hgFolder = new TemporaryDirectory();</span>
<span class="line-added">404              var storageFolder = new TemporaryDirectory();</span>
<span class="line-added">405              var storageFolder2 = new TemporaryDirectory();</span>
<span class="line-added">406              var marksFolder = new TemporaryDirectory()) {</span>
<span class="line-added">407             // Export a hg repository</span>
<span class="line-added">408             var localHgRepo = Repository.materialize(hgFolder.path(), source, &quot;default&quot;);</span>
<span class="line-added">409             localHgRepo.fetch(source, &quot;testlock&quot;);</span>
<span class="line-added">410             var destinationRepo = credentials.getHostedRepository();</span>
<span class="line-added">411             var config = new TestExporterConfig(localHgRepo.root().toUri(), destinationRepo, marksFolder.path());</span>
<span class="line-added">412             var bridge = new JBridgeBot(config, storageFolder.path());</span>
<span class="line-added">413 </span>
<span class="line-added">414             runHgCommand(localHgRepo, &quot;update&quot;, &quot;-r&quot;, &quot;5&quot;);</span>
<span class="line-added">415             var other = localHgRepo.root().resolve(&quot;other.txt&quot;);</span>
<span class="line-added">416             Files.writeString(other, &quot;Hello&quot;);</span>
<span class="line-added">417             localHgRepo.add(other);</span>
<span class="line-added">418             localHgRepo.commit(&quot;First&quot;, &quot;duke&quot;, &quot;&quot;);</span>
<span class="line-added">419 </span>
<span class="line-added">420             // Do an initial conversion</span>
<span class="line-added">421             TestBotRunner.runPeriodicItems(bridge);</span>
<span class="line-added">422 </span>
<span class="line-added">423             // Now roll back and commit something else</span>
<span class="line-added">424             runHgCommand(localHgRepo, &quot;update&quot;, &quot;-r&quot;, &quot;5&quot;);</span>
<span class="line-added">425             Files.writeString(other, &quot;There&quot;);</span>
<span class="line-added">426             localHgRepo.add(other);</span>
<span class="line-added">427             localHgRepo.commit(&quot;Second&quot;, &quot;duke&quot;, &quot;&quot;);</span>
<span class="line-added">428 </span>
<span class="line-added">429             // The second conversion (with fresh storage) should detect that marks have changed</span>
<span class="line-added">430             var newBridge = new JBridgeBot(config, storageFolder2.path());</span>
<span class="line-added">431             assertThrows(RuntimeException.class, () -&gt; TestBotRunner.runPeriodicItems(newBridge));</span>
<span class="line-added">432         }</span>
<span class="line-added">433     }</span>
434 }
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/hgbridge/JBridgeBotFactory.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../../vcs/src/main/java/org/openjdk/skara/vcs/openjdk/convert/HgToGitConverter.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>