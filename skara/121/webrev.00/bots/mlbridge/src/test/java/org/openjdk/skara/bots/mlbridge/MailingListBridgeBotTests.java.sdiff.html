<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="MailingListArchiveReaderBotTests.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../../email/src/main/java/org/openjdk/skara/email/Email.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  81     }
  82 
  83     private long countSubstrings(String string, String substring) {
  84         return Pattern.compile(substring).matcher(string).results().count();
  85     }
  86 
  87     @Test
  88     void simpleArchive(TestInfo testInfo) throws IOException {
  89         try (var credentials = new HostCredentials(testInfo);
  90              var tempFolder = new TemporaryDirectory();
  91              var archiveFolder = new TemporaryDirectory();
  92              var webrevFolder = new TemporaryDirectory();
  93              var listServer = new TestMailmanServer()) {
  94             var author = credentials.getHostedRepository();
  95             var archive = credentials.getHostedRepository();
  96             var ignored = credentials.getHostedRepository();
  97             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
  98             var censusBuilder = credentials.getCensusBuilder()
  99                                            .addAuthor(author.host().getCurrentUserDetails().id());
 100             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 101             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress,</span>
 102                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),

 103                                                  listServer.getArchive(), listServer.getSMTP(),
 104                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 105                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 106                                                  Set.of(&quot;rfr&quot;), Map.of(ignored.host().getCurrentUserDetails().userName(),
 107                                                                        Pattern.compile(&quot;ready&quot;)));
 108 
 109             // Populate the projects repository
 110             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
 111             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 112             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 113             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 114 
 115             // Make a change with a corresponding PR
 116             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 117                                                                &quot;Change msg\n\nWith several lines&quot;);
 118             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 119             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 120             pr.setBody(&quot;This should not be ready&quot;);
 121 
 122             // Run an archive pass
</pre>
<hr />
<pre>
 229             for (var newMail : conversations.get(0).allMessages()) {
 230                 assertEquals(from.address(), newMail.author().address());
 231                 assertEquals(from, newMail.sender());
 232             }
 233         }
 234     }
 235 
 236     @Test
 237     void reviewComment(TestInfo testInfo) throws IOException {
 238         try (var credentials = new HostCredentials(testInfo);
 239              var tempFolder = new TemporaryDirectory();
 240              var archiveFolder = new TemporaryDirectory();
 241              var listServer = new TestMailmanServer()) {
 242             var author = credentials.getHostedRepository();
 243             var archive = credentials.getHostedRepository();
 244             var ignored = credentials.getHostedRepository();
 245             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 246             var censusBuilder = credentials.getCensusBuilder()
 247                                            .addAuthor(author.host().getCurrentUserDetails().id());
 248             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 249             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress,</span>
 250                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),

 251                                                  listServer.getArchive(), listServer.getSMTP(),
 252                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 253                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 254                                                  Set.of(), Map.of());
 255 
 256             // Populate the projects repository
 257             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 258             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 259             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 260             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 261             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 262 
 263             // Make a change with a corresponding PR
 264             var editHash = CheckableRepository.appendAndCommit(localRepo);
 265             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 266             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 267             pr.setBody(&quot;This is now ready&quot;);
 268             TestBotRunner.runPeriodicItems(mlBot);
 269             listServer.processIncoming();
 270 
</pre>
<hr />
<pre>
 313             assertEquals(3, conversations.get(0).allMessages().size());
 314             for (var newMail : conversations.get(0).allMessages()) {
 315                 assertEquals(from.address(), newMail.author().address());
 316                 assertEquals(from, newMail.sender());
 317             }
 318         }
 319     }
 320 
 321     @Test
 322     void combineComments(TestInfo testInfo) throws IOException {
 323         try (var credentials = new HostCredentials(testInfo);
 324              var tempFolder = new TemporaryDirectory();
 325              var archiveFolder = new TemporaryDirectory();
 326              var listServer = new TestMailmanServer()) {
 327             var author = credentials.getHostedRepository();
 328             var archive = credentials.getHostedRepository();
 329             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 330             var censusBuilder = credentials.getCensusBuilder()
 331                                            .addAuthor(author.host().getCurrentUserDetails().id());
 332             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 333             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress, Set.of(), listServer.getArchive(),</span>


 334                                                  listServer.getSMTP(),
 335                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 336                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 337                                                  Set.of(), Map.of());
 338 
 339             // Populate the projects repository
 340             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 341             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 342             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 343             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 344             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 345 
 346             // Make a change with a corresponding PR
 347             var editHash = CheckableRepository.appendAndCommit(localRepo);
 348             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 349             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 350             pr.setBody(&quot;This is now ready&quot;);
 351             TestBotRunner.runPeriodicItems(mlBot);
 352             listServer.processIncoming();
 353 
 354             // Make two file specific comments
 355             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 356             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 357             TestBotRunner.runPeriodicItems(mlBot);
 358             listServer.processIncoming();
 359 
<span class="line-modified"> 360             // The archive should not contain a combined entry</span>
 361             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
<span class="line-modified"> 362             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));</span>
 363 
<span class="line-modified"> 364             // But the mailing list should</span>
 365             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 366             var mailmanList = mailmanServer.getList(listAddress.address());
 367             var conversations = mailmanList.conversations(Duration.ofDays(1));
 368             assertEquals(1, conversations.size());
 369             var mail = conversations.get(0).first();
 370             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 371             assertEquals(2, conversations.get(0).allMessages().size());
 372 
 373             var reply = conversations.get(0).replies(mail).get(0);
 374             assertEquals(2, reply.body().split(&quot;^On.*wrote:&quot;).length);
 375             assertEquals(2, reply.body().split(&quot;&gt; This is now ready&quot;).length, reply.body());
 376             assertEquals(&quot;Re: RFR: This is a pull request&quot;, reply.subject());
 377             assertTrue(reply.body().contains(&quot;Review comment\n\n&quot;), reply.body());
 378             assertTrue(reply.body().contains(&quot;Another review comment&quot;), reply.body());
 379         }
 380     }
 381 






























































































 382     @Test
 383     void reviewContext(TestInfo testInfo) throws IOException {
 384         try (var credentials = new HostCredentials(testInfo);
 385              var tempFolder = new TemporaryDirectory();
 386              var archiveFolder = new TemporaryDirectory();
 387              var listServer = new TestMailmanServer()) {
 388             var author = credentials.getHostedRepository();
 389             var archive = credentials.getHostedRepository();
 390             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 391             var censusBuilder = credentials.getCensusBuilder()
 392                                            .addAuthor(author.host().getCurrentUserDetails().id());
 393             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 394             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress, Set.of(), listServer.getArchive(),</span>


 395                                                  listServer.getSMTP(),
 396                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 397                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 398                                                  Set.of(), Map.of());
 399 
 400             // Populate the projects repository
 401             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 402             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 403             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 404             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 405             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 406 
 407             // Make a change with a corresponding PR
 408             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
 409             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 410             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 411             pr.setBody(&quot;This is now ready&quot;);
 412             TestBotRunner.runPeriodicItems(mlBot);
 413             listServer.processIncoming();
 414 
</pre>
<hr />
<pre>
 421             // The archive should only contain context around line 2
 422             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 423             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
 424             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
 425             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
 426         }
 427     }
 428 
 429     @Test
 430     void multipleReviewContexts(TestInfo testInfo) throws IOException {
 431         try (var credentials = new HostCredentials(testInfo);
 432              var tempFolder = new TemporaryDirectory();
 433              var archiveFolder = new TemporaryDirectory();
 434              var listServer = new TestMailmanServer()) {
 435             var author = credentials.getHostedRepository();
 436             var archive = credentials.getHostedRepository();
 437             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 438             var censusBuilder = credentials.getCensusBuilder()
 439                                            .addAuthor(author.host().getCurrentUserDetails().id());
 440             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 441             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress, Set.of(), listServer.getArchive(),</span>


 442                                                  listServer.getSMTP(),
 443                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 444                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 445                                                  Set.of(), Map.of());
 446 
 447             // Populate the projects repository
 448             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 449             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 450             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 451             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 452             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 453             var initialHash = CheckableRepository.appendAndCommit(localRepo,
 454                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
 455                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
 456                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
 457                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
 458                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
 459                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
 460             localRepo.push(initialHash, author.getUrl(), &quot;master&quot;);
 461 
</pre>
<hr />
<pre>
 487 
 488             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 24&quot;));
 489             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 23: Line 12.5$&quot;));
 490             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 24: Line 13 edit$&quot;));
 491             assertFalse(archiveContains(archiveFolder.path(), &quot;^Line 15&quot;));
 492         }
 493     }
 494 
 495     @Test
 496     void filterComments(TestInfo testInfo) throws IOException {
 497         try (var credentials = new HostCredentials(testInfo);
 498              var tempFolder = new TemporaryDirectory();
 499              var archiveFolder = new TemporaryDirectory();
 500              var listServer = new TestMailmanServer()) {
 501             var author = credentials.getHostedRepository();
 502             var archive = credentials.getHostedRepository();
 503             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 504             var censusBuilder = credentials.getCensusBuilder()
 505                                            .addAuthor(author.host().getCurrentUserDetails().id());
 506             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 507             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress, Set.of(),</span>

 508                                                  listServer.getArchive(), listServer.getSMTP(),
 509                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 510                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 511                                                  Set.of(), Map.of());
 512 
 513             // Populate the projects repository
 514             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 515             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 516             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 517             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 518             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 519 
 520             // Make a change with a corresponding PR
 521             var editHash = CheckableRepository.appendAndCommit(localRepo);
 522             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 523             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 524             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
 525                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
 526 
 527             // Make a bunch of comments
</pre>
<hr />
<pre>
 542             assertFalse(archiveContains(archiveFolder.path(), &quot;&lt;!--&quot;));
 543             assertFalse(archiveContains(archiveFolder.path(), &quot;--&gt;&quot;));
 544             assertTrue(archiveContains(archiveFolder.path(), &quot;Plain comment&quot;));
 545             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 546             assertFalse(archiveContains(archiveFolder.path(), &quot;/integrate&quot;));
 547         }
 548     }
 549 
 550     @Test
 551     void incrementalChanges(TestInfo testInfo) throws IOException {
 552         try (var credentials = new HostCredentials(testInfo);
 553              var tempFolder = new TemporaryDirectory();
 554              var archiveFolder = new TemporaryDirectory();
 555              var listServer = new TestMailmanServer()) {
 556             var author = credentials.getHostedRepository();
 557             var archive = credentials.getHostedRepository();
 558             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 559             var censusBuilder = credentials.getCensusBuilder()
 560                                            .addAuthor(author.host().getCurrentUserDetails().id());
 561             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 562             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress, Set.of(),</span>

 563                                                  listServer.getArchive(), listServer.getSMTP(),
 564                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 565                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 566                                                  Set.of(), Map.of());
 567 
 568             // Populate the projects repository
 569             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 570             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 571             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 572             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 573             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 574 
 575             // Make a change with a corresponding PR
 576             var editHash = CheckableRepository.appendAndCommit(localRepo);
 577             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 578             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 579             pr.setBody(&quot;This is now ready&quot;);
 580 
 581             // Run an archive pass
 582             TestBotRunner.runPeriodicItems(mlBot);
</pre>
<hr />
<pre>
 651             }
 652             var updatedConversations = mailmanList.conversations(Duration.ofDays(1));
 653             assertEquals(1, updatedConversations.size());
 654             var conversation = updatedConversations.get(0);
 655             assertEquals(5, conversation.allMessages().size());
 656         }
 657     }
 658 
 659     @Test
 660     void rebased(TestInfo testInfo) throws IOException {
 661         try (var credentials = new HostCredentials(testInfo);
 662              var tempFolder = new TemporaryDirectory();
 663              var archiveFolder = new TemporaryDirectory();
 664              var listServer = new TestMailmanServer()) {
 665             var author = credentials.getHostedRepository();
 666             var archive = credentials.getHostedRepository();
 667             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 668             var censusBuilder = credentials.getCensusBuilder()
 669                                            .addAuthor(author.host().getCurrentUserDetails().id());
 670             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 671             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress, Set.of(),</span>

 672                                                  listServer.getArchive(), listServer.getSMTP(),
 673                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 674                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 675                                                  Set.of(), Map.of());
 676 
 677             // Populate the projects repository
 678             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 679             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.getRepositoryType(), reviewFile);
 680             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 681             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 682             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 683 
 684             // Make a change with a corresponding PR
 685             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
 686             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 687             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 688             pr.setBody(&quot;This is now ready&quot;);
 689 
 690             // Run an archive pass
 691             TestBotRunner.runPeriodicItems(mlBot);
</pre>
<hr />
<pre>
 737                 assertEquals(from.address(), newMail.author().address());
 738                 assertEquals(from, newMail.sender());
 739             }
 740         }
 741     }
 742 
 743     @Test
 744     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
 745         try (var credentials = new HostCredentials(testInfo);
 746              var tempFolder = new TemporaryDirectory();
 747              var archiveFolder = new TemporaryDirectory();
 748              var webrevFolder = new TemporaryDirectory();
 749              var listServer = new TestMailmanServer()) {
 750             var author = credentials.getHostedRepository();
 751             var archive = credentials.getHostedRepository();
 752             var ignored = credentials.getHostedRepository();
 753             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 754             var censusBuilder = credentials.getCensusBuilder()
 755                                            .addAuthor(author.host().getCurrentUserDetails().id());
 756             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 757             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress,</span>

 758                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),

 759                                                  listServer.getArchive(), listServer.getSMTP(),
 760                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 761                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 762                                                  Set.of(), Map.of());
 763 
 764             // Populate the projects repository
 765             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
 766             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 767             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 768             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 769 
 770             // Make a change with a corresponding PR
 771             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 772                                                                &quot;Change msg\n\nWith several lines&quot;);
 773             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 774             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 775 
 776             // Flag it as ready for review
 777             pr.setBody(&quot;This should now be ready&quot;);
 778 
</pre>
<hr />
<pre>
 802             // The webrev comment should not contain duplicate entries
 803             comments = pr.getComments();
 804             webrevComments = comments.stream()
 805                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 806                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 807                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 808                                          .collect(Collectors.toList());
 809             assertEquals(1, webrevComments.size());
 810             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
 811         }
 812     }
 813 
 814     @Test
 815     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
 816         try (var credentials = new HostCredentials(testInfo);
 817              var tempFolder = new TemporaryDirectory();
 818              var archiveFolder = new TemporaryDirectory();
 819              var listServer = new TestMailmanServer()) {
 820             var author = credentials.getHostedRepository();
 821             var archive = credentials.getHostedRepository();

 822             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 823             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 824             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress, Set.of(),</span>




 825                                                  listServer.getArchive(), listServer.getSMTP(),
 826                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 827                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 828                                                  Set.of(), Map.of());
 829 
 830             // Populate the projects repository
 831             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 832             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 833             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 834             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 835             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 836 
 837             // Make a change with a corresponding PR
 838             var editHash = CheckableRepository.appendAndCommit(localRepo);
 839             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 840             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 841             pr.setBody(&quot;This is now ready&quot;);
 842 
 843             // Run an archive pass
 844             TestBotRunner.runPeriodicItems(mlBot);
 845 
 846             // First unapprove it
<span class="line-modified"> 847             var reviewedPr = credentials.getHostedRepository().getPullRequest(pr.getId());</span>
 848             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
 849             TestBotRunner.runPeriodicItems(mlBot);
 850             TestBotRunner.runPeriodicItems(mlBot);
 851             TestBotRunner.runPeriodicItems(mlBot);
 852 
 853             // The archive should contain a note
 854             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
<span class="line-modified"> 855             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;This PR has been reviewed.*more changes are needed&quot;));</span>

 856             if (author.host().supportsReviewBody()) {
 857                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
 858             }
 859 
 860             // Then approve it
 861             reviewedPr.addReview(Review.Verdict.APPROVED, &quot;Reason 2&quot;);
 862             TestBotRunner.runPeriodicItems(mlBot);
 863             TestBotRunner.runPeriodicItems(mlBot);
 864             TestBotRunner.runPeriodicItems(mlBot);
 865 
 866             // The archive should contain another note
 867             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
<span class="line-modified"> 868             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;This PR.*approved&quot;));</span>
 869             if (author.host().supportsReviewBody()) {
 870                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 2&quot;));
 871             }

 872 
 873             // Yet another change
 874             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 3&quot;);
 875             TestBotRunner.runPeriodicItems(mlBot);
 876             TestBotRunner.runPeriodicItems(mlBot);
 877             TestBotRunner.runPeriodicItems(mlBot);
 878 
 879             // The archive should contain another note
 880             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
<span class="line-modified"> 881             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;This PR.*more changes&quot;));</span>
 882             if (author.host().supportsReviewBody()) {
 883                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
 884             }
 885         }
 886     }

























































 887 }
</pre>
</td>
<td>
<hr />
<pre>
  81     }
  82 
  83     private long countSubstrings(String string, String substring) {
  84         return Pattern.compile(substring).matcher(string).results().count();
  85     }
  86 
  87     @Test
  88     void simpleArchive(TestInfo testInfo) throws IOException {
  89         try (var credentials = new HostCredentials(testInfo);
  90              var tempFolder = new TemporaryDirectory();
  91              var archiveFolder = new TemporaryDirectory();
  92              var webrevFolder = new TemporaryDirectory();
  93              var listServer = new TestMailmanServer()) {
  94             var author = credentials.getHostedRepository();
  95             var archive = credentials.getHostedRepository();
  96             var ignored = credentials.getHostedRepository();
  97             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
  98             var censusBuilder = credentials.getCensusBuilder()
  99                                            .addAuthor(author.host().getCurrentUserDetails().id());
 100             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 101             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,</span>
 102                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
<span class="line-added"> 103                                                  Set.of(),</span>
 104                                                  listServer.getArchive(), listServer.getSMTP(),
 105                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 106                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 107                                                  Set.of(&quot;rfr&quot;), Map.of(ignored.host().getCurrentUserDetails().userName(),
 108                                                                        Pattern.compile(&quot;ready&quot;)));
 109 
 110             // Populate the projects repository
 111             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
 112             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 113             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 114             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 115 
 116             // Make a change with a corresponding PR
 117             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 118                                                                &quot;Change msg\n\nWith several lines&quot;);
 119             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 120             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 121             pr.setBody(&quot;This should not be ready&quot;);
 122 
 123             // Run an archive pass
</pre>
<hr />
<pre>
 230             for (var newMail : conversations.get(0).allMessages()) {
 231                 assertEquals(from.address(), newMail.author().address());
 232                 assertEquals(from, newMail.sender());
 233             }
 234         }
 235     }
 236 
 237     @Test
 238     void reviewComment(TestInfo testInfo) throws IOException {
 239         try (var credentials = new HostCredentials(testInfo);
 240              var tempFolder = new TemporaryDirectory();
 241              var archiveFolder = new TemporaryDirectory();
 242              var listServer = new TestMailmanServer()) {
 243             var author = credentials.getHostedRepository();
 244             var archive = credentials.getHostedRepository();
 245             var ignored = credentials.getHostedRepository();
 246             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 247             var censusBuilder = credentials.getCensusBuilder()
 248                                            .addAuthor(author.host().getCurrentUserDetails().id());
 249             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 250             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,</span>
 251                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
<span class="line-added"> 252                                                  Set.of(),</span>
 253                                                  listServer.getArchive(), listServer.getSMTP(),
 254                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 255                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 256                                                  Set.of(), Map.of());
 257 
 258             // Populate the projects repository
 259             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 260             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 261             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 262             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 263             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 264 
 265             // Make a change with a corresponding PR
 266             var editHash = CheckableRepository.appendAndCommit(localRepo);
 267             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 268             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 269             pr.setBody(&quot;This is now ready&quot;);
 270             TestBotRunner.runPeriodicItems(mlBot);
 271             listServer.processIncoming();
 272 
</pre>
<hr />
<pre>
 315             assertEquals(3, conversations.get(0).allMessages().size());
 316             for (var newMail : conversations.get(0).allMessages()) {
 317                 assertEquals(from.address(), newMail.author().address());
 318                 assertEquals(from, newMail.sender());
 319             }
 320         }
 321     }
 322 
 323     @Test
 324     void combineComments(TestInfo testInfo) throws IOException {
 325         try (var credentials = new HostCredentials(testInfo);
 326              var tempFolder = new TemporaryDirectory();
 327              var archiveFolder = new TemporaryDirectory();
 328              var listServer = new TestMailmanServer()) {
 329             var author = credentials.getHostedRepository();
 330             var archive = credentials.getHostedRepository();
 331             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 332             var censusBuilder = credentials.getCensusBuilder()
 333                                            .addAuthor(author.host().getCurrentUserDetails().id());
 334             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 335             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,</span>
<span class="line-added"> 336                                                  listAddress, Set.of(), Set.of(),</span>
<span class="line-added"> 337                                                  listServer.getArchive(),</span>
 338                                                  listServer.getSMTP(),
 339                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 340                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 341                                                  Set.of(), Map.of());
 342 
 343             // Populate the projects repository
 344             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 345             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 346             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 347             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 348             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 349 
 350             // Make a change with a corresponding PR
 351             var editHash = CheckableRepository.appendAndCommit(localRepo);
 352             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 353             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 354             pr.setBody(&quot;This is now ready&quot;);
 355             TestBotRunner.runPeriodicItems(mlBot);
 356             listServer.processIncoming();
 357 
 358             // Make two file specific comments
 359             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 360             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 361             TestBotRunner.runPeriodicItems(mlBot);
 362             listServer.processIncoming();
 363 
<span class="line-modified"> 364             // The archive should contain a combined entry</span>
 365             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
<span class="line-modified"> 366             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));</span>
 367 
<span class="line-modified"> 368             // As well as the mailing list</span>
 369             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 370             var mailmanList = mailmanServer.getList(listAddress.address());
 371             var conversations = mailmanList.conversations(Duration.ofDays(1));
 372             assertEquals(1, conversations.size());
 373             var mail = conversations.get(0).first();
 374             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 375             assertEquals(2, conversations.get(0).allMessages().size());
 376 
 377             var reply = conversations.get(0).replies(mail).get(0);
 378             assertEquals(2, reply.body().split(&quot;^On.*wrote:&quot;).length);
 379             assertEquals(2, reply.body().split(&quot;&gt; This is now ready&quot;).length, reply.body());
 380             assertEquals(&quot;Re: RFR: This is a pull request&quot;, reply.subject());
 381             assertTrue(reply.body().contains(&quot;Review comment\n\n&quot;), reply.body());
 382             assertTrue(reply.body().contains(&quot;Another review comment&quot;), reply.body());
 383         }
 384     }
 385 
<span class="line-added"> 386     @Test</span>
<span class="line-added"> 387     void commentThreading(TestInfo testInfo) throws IOException {</span>
<span class="line-added"> 388         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added"> 389              var tempFolder = new TemporaryDirectory();</span>
<span class="line-added"> 390              var archiveFolder = new TemporaryDirectory();</span>
<span class="line-added"> 391              var listServer = new TestMailmanServer()) {</span>
<span class="line-added"> 392             var author = credentials.getHostedRepository();</span>
<span class="line-added"> 393             var reviewer = credentials.getHostedRepository();</span>
<span class="line-added"> 394             var archive = credentials.getHostedRepository();</span>
<span class="line-added"> 395             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="line-added"> 396             var censusBuilder = credentials.getCensusBuilder()</span>
<span class="line-added"> 397                                            .addReviewer(reviewer.host().getCurrentUserDetails().id())</span>
<span class="line-added"> 398                                            .addAuthor(author.host().getCurrentUserDetails().id());</span>
<span class="line-added"> 399             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);</span>
<span class="line-added"> 400             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,</span>
<span class="line-added"> 401                                                  listAddress, Set.of(), Set.of(),</span>
<span class="line-added"> 402                                                  listServer.getArchive(),</span>
<span class="line-added"> 403                                                  listServer.getSMTP(),</span>
<span class="line-added"> 404                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),</span>
<span class="line-added"> 405                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),</span>
<span class="line-added"> 406                                                  Set.of(), Map.of());</span>
<span class="line-added"> 407 </span>
<span class="line-added"> 408             // Populate the projects repository</span>
<span class="line-added"> 409             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);</span>
<span class="line-added"> 410             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);</span>
<span class="line-added"> 411             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="line-added"> 412             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);</span>
<span class="line-added"> 413             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);</span>
<span class="line-added"> 414 </span>
<span class="line-added"> 415             // Make a change with a corresponding PR</span>
<span class="line-added"> 416             var editHash = CheckableRepository.appendAndCommit(localRepo);</span>
<span class="line-added"> 417             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);</span>
<span class="line-added"> 418             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);</span>
<span class="line-added"> 419             pr.setBody(&quot;This is now ready&quot;);</span>
<span class="line-added"> 420             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added"> 421             listServer.processIncoming();</span>
<span class="line-added"> 422 </span>
<span class="line-added"> 423             // Make a file specific comment</span>
<span class="line-added"> 424             var reviewPr = reviewer.getPullRequest(pr.getId());</span>
<span class="line-added"> 425             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);</span>
<span class="line-added"> 426             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);</span>
<span class="line-added"> 427             reviewPr.addReviewCommentReply(comment1, &quot;Great&quot;);</span>
<span class="line-added"> 428             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added"> 429             listServer.processIncoming();</span>
<span class="line-added"> 430             listServer.processIncoming();</span>
<span class="line-added"> 431             listServer.processIncoming();</span>
<span class="line-added"> 432 </span>
<span class="line-added"> 433             // And a second one by ourselves</span>
<span class="line-added"> 434             var comment2 = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);</span>
<span class="line-added"> 435             reviewPr.addReviewCommentReply(comment2, &quot;Sounds good&quot;);</span>
<span class="line-added"> 436             pr.addReviewCommentReply(comment2, &quot;Thanks&quot;);</span>
<span class="line-added"> 437             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added"> 438             listServer.processIncoming();</span>
<span class="line-added"> 439             listServer.processIncoming();</span>
<span class="line-added"> 440             listServer.processIncoming();</span>
<span class="line-added"> 441 </span>
<span class="line-added"> 442             // Sanity check the archive</span>
<span class="line-added"> 443             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);</span>
<span class="line-added"> 444             assertEquals(6, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));</span>
<span class="line-added"> 445 </span>
<span class="line-added"> 446             // Check the mailing list</span>
<span class="line-added"> 447             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());</span>
<span class="line-added"> 448             var mailmanList = mailmanServer.getList(listAddress.address());</span>
<span class="line-added"> 449             var conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="line-added"> 450             assertEquals(1, conversations.size());</span>
<span class="line-added"> 451             var mail = conversations.get(0).first();</span>
<span class="line-added"> 452             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());</span>
<span class="line-added"> 453             assertEquals(7, conversations.get(0).allMessages().size());</span>
<span class="line-added"> 454 </span>
<span class="line-added"> 455             // There should be two separate threads</span>
<span class="line-added"> 456             var thread1 = conversations.get(0).replies(mail).get(0);</span>
<span class="line-added"> 457             assertEquals(2, thread1.body().split(&quot;^On.*wrote:&quot;).length);</span>
<span class="line-added"> 458             assertEquals(2, thread1.body().split(&quot;&gt; This is now ready&quot;).length, thread1.body());</span>
<span class="line-added"> 459             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread1.subject());</span>
<span class="line-added"> 460             assertTrue(thread1.body().contains(&quot;Review comment\n\n&quot;), thread1.body());</span>
<span class="line-added"> 461             assertFalse(thread1.body().contains(&quot;Another review comment&quot;), thread1.body());</span>
<span class="line-added"> 462             var thread1reply1 = conversations.get(0).replies(thread1).get(0);</span>
<span class="line-added"> 463             assertTrue(thread1reply1.body().contains(&quot;I agree&quot;));</span>
<span class="line-added"> 464             var thread1reply2 = conversations.get(0).replies(thread1reply1).get(0);</span>
<span class="line-added"> 465             assertTrue(thread1reply2.body().contains(&quot;Great&quot;));</span>
<span class="line-added"> 466 </span>
<span class="line-added"> 467             var thread2 = conversations.get(0).replies(mail).get(1);</span>
<span class="line-added"> 468             assertEquals(2, thread2.body().split(&quot;^On.*wrote:&quot;).length);</span>
<span class="line-added"> 469             assertEquals(2, thread2.body().split(&quot;&gt; This is now ready&quot;).length, thread2.body());</span>
<span class="line-added"> 470             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread2.subject());</span>
<span class="line-added"> 471             assertFalse(thread2.body().contains(&quot;Review comment\n\n&quot;), thread2.body());</span>
<span class="line-added"> 472             assertTrue(thread2.body().contains(&quot;Another review comment&quot;), thread2.body());</span>
<span class="line-added"> 473             var thread2reply1 = conversations.get(0).replies(thread2).get(0);</span>
<span class="line-added"> 474             assertTrue(thread2reply1.body().contains(&quot;Sounds good&quot;));</span>
<span class="line-added"> 475             var thread2reply2 = conversations.get(0).replies(thread2reply1).get(0);</span>
<span class="line-added"> 476             assertTrue(thread2reply2.body().contains(&quot;Thanks&quot;));</span>
<span class="line-added"> 477         }</span>
<span class="line-added"> 478     }</span>
<span class="line-added"> 479 </span>
 480     @Test
 481     void reviewContext(TestInfo testInfo) throws IOException {
 482         try (var credentials = new HostCredentials(testInfo);
 483              var tempFolder = new TemporaryDirectory();
 484              var archiveFolder = new TemporaryDirectory();
 485              var listServer = new TestMailmanServer()) {
 486             var author = credentials.getHostedRepository();
 487             var archive = credentials.getHostedRepository();
 488             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 489             var censusBuilder = credentials.getCensusBuilder()
 490                                            .addAuthor(author.host().getCurrentUserDetails().id());
 491             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 492             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,</span>
<span class="line-added"> 493                                                  listAddress, Set.of(), Set.of(),</span>
<span class="line-added"> 494                                                  listServer.getArchive(),</span>
 495                                                  listServer.getSMTP(),
 496                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 497                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 498                                                  Set.of(), Map.of());
 499 
 500             // Populate the projects repository
 501             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 502             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 503             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 504             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 505             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 506 
 507             // Make a change with a corresponding PR
 508             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
 509             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 510             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 511             pr.setBody(&quot;This is now ready&quot;);
 512             TestBotRunner.runPeriodicItems(mlBot);
 513             listServer.processIncoming();
 514 
</pre>
<hr />
<pre>
 521             // The archive should only contain context around line 2
 522             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 523             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
 524             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
 525             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
 526         }
 527     }
 528 
 529     @Test
 530     void multipleReviewContexts(TestInfo testInfo) throws IOException {
 531         try (var credentials = new HostCredentials(testInfo);
 532              var tempFolder = new TemporaryDirectory();
 533              var archiveFolder = new TemporaryDirectory();
 534              var listServer = new TestMailmanServer()) {
 535             var author = credentials.getHostedRepository();
 536             var archive = credentials.getHostedRepository();
 537             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 538             var censusBuilder = credentials.getCensusBuilder()
 539                                            .addAuthor(author.host().getCurrentUserDetails().id());
 540             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 541             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,</span>
<span class="line-added"> 542                                                  listAddress, Set.of(), Set.of(),</span>
<span class="line-added"> 543                                                  listServer.getArchive(),</span>
 544                                                  listServer.getSMTP(),
 545                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 546                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 547                                                  Set.of(), Map.of());
 548 
 549             // Populate the projects repository
 550             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 551             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 552             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 553             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 554             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 555             var initialHash = CheckableRepository.appendAndCommit(localRepo,
 556                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
 557                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
 558                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
 559                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
 560                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
 561                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
 562             localRepo.push(initialHash, author.getUrl(), &quot;master&quot;);
 563 
</pre>
<hr />
<pre>
 589 
 590             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 24&quot;));
 591             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 23: Line 12.5$&quot;));
 592             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 24: Line 13 edit$&quot;));
 593             assertFalse(archiveContains(archiveFolder.path(), &quot;^Line 15&quot;));
 594         }
 595     }
 596 
 597     @Test
 598     void filterComments(TestInfo testInfo) throws IOException {
 599         try (var credentials = new HostCredentials(testInfo);
 600              var tempFolder = new TemporaryDirectory();
 601              var archiveFolder = new TemporaryDirectory();
 602              var listServer = new TestMailmanServer()) {
 603             var author = credentials.getHostedRepository();
 604             var archive = credentials.getHostedRepository();
 605             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 606             var censusBuilder = credentials.getCensusBuilder()
 607                                            .addAuthor(author.host().getCurrentUserDetails().id());
 608             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 609             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,</span>
<span class="line-added"> 610                                                  listAddress, Set.of(), Set.of(),</span>
 611                                                  listServer.getArchive(), listServer.getSMTP(),
 612                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 613                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 614                                                  Set.of(), Map.of());
 615 
 616             // Populate the projects repository
 617             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 618             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 619             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 620             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 621             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 622 
 623             // Make a change with a corresponding PR
 624             var editHash = CheckableRepository.appendAndCommit(localRepo);
 625             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 626             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 627             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
 628                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
 629 
 630             // Make a bunch of comments
</pre>
<hr />
<pre>
 645             assertFalse(archiveContains(archiveFolder.path(), &quot;&lt;!--&quot;));
 646             assertFalse(archiveContains(archiveFolder.path(), &quot;--&gt;&quot;));
 647             assertTrue(archiveContains(archiveFolder.path(), &quot;Plain comment&quot;));
 648             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 649             assertFalse(archiveContains(archiveFolder.path(), &quot;/integrate&quot;));
 650         }
 651     }
 652 
 653     @Test
 654     void incrementalChanges(TestInfo testInfo) throws IOException {
 655         try (var credentials = new HostCredentials(testInfo);
 656              var tempFolder = new TemporaryDirectory();
 657              var archiveFolder = new TemporaryDirectory();
 658              var listServer = new TestMailmanServer()) {
 659             var author = credentials.getHostedRepository();
 660             var archive = credentials.getHostedRepository();
 661             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 662             var censusBuilder = credentials.getCensusBuilder()
 663                                            .addAuthor(author.host().getCurrentUserDetails().id());
 664             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 665             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,</span>
<span class="line-added"> 666                                                  listAddress, Set.of(), Set.of(),</span>
 667                                                  listServer.getArchive(), listServer.getSMTP(),
 668                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 669                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 670                                                  Set.of(), Map.of());
 671 
 672             // Populate the projects repository
 673             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 674             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 675             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 676             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 677             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 678 
 679             // Make a change with a corresponding PR
 680             var editHash = CheckableRepository.appendAndCommit(localRepo);
 681             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 682             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 683             pr.setBody(&quot;This is now ready&quot;);
 684 
 685             // Run an archive pass
 686             TestBotRunner.runPeriodicItems(mlBot);
</pre>
<hr />
<pre>
 755             }
 756             var updatedConversations = mailmanList.conversations(Duration.ofDays(1));
 757             assertEquals(1, updatedConversations.size());
 758             var conversation = updatedConversations.get(0);
 759             assertEquals(5, conversation.allMessages().size());
 760         }
 761     }
 762 
 763     @Test
 764     void rebased(TestInfo testInfo) throws IOException {
 765         try (var credentials = new HostCredentials(testInfo);
 766              var tempFolder = new TemporaryDirectory();
 767              var archiveFolder = new TemporaryDirectory();
 768              var listServer = new TestMailmanServer()) {
 769             var author = credentials.getHostedRepository();
 770             var archive = credentials.getHostedRepository();
 771             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 772             var censusBuilder = credentials.getCensusBuilder()
 773                                            .addAuthor(author.host().getCurrentUserDetails().id());
 774             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 775             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,</span>
<span class="line-added"> 776                                                  listAddress, Set.of(), Set.of(),</span>
 777                                                  listServer.getArchive(), listServer.getSMTP(),
 778                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 779                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 780                                                  Set.of(), Map.of());
 781 
 782             // Populate the projects repository
 783             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 784             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.getRepositoryType(), reviewFile);
 785             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 786             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 787             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 788 
 789             // Make a change with a corresponding PR
 790             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
 791             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 792             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 793             pr.setBody(&quot;This is now ready&quot;);
 794 
 795             // Run an archive pass
 796             TestBotRunner.runPeriodicItems(mlBot);
</pre>
<hr />
<pre>
 842                 assertEquals(from.address(), newMail.author().address());
 843                 assertEquals(from, newMail.sender());
 844             }
 845         }
 846     }
 847 
 848     @Test
 849     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
 850         try (var credentials = new HostCredentials(testInfo);
 851              var tempFolder = new TemporaryDirectory();
 852              var archiveFolder = new TemporaryDirectory();
 853              var webrevFolder = new TemporaryDirectory();
 854              var listServer = new TestMailmanServer()) {
 855             var author = credentials.getHostedRepository();
 856             var archive = credentials.getHostedRepository();
 857             var ignored = credentials.getHostedRepository();
 858             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 859             var censusBuilder = credentials.getCensusBuilder()
 860                                            .addAuthor(author.host().getCurrentUserDetails().id());
 861             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 862             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,</span>
<span class="line-added"> 863                                                  listAddress,</span>
 864                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
<span class="line-added"> 865                                                  Set.of(),</span>
 866                                                  listServer.getArchive(), listServer.getSMTP(),
 867                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 868                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 869                                                  Set.of(), Map.of());
 870 
 871             // Populate the projects repository
 872             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
 873             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 874             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 875             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 876 
 877             // Make a change with a corresponding PR
 878             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 879                                                                &quot;Change msg\n\nWith several lines&quot;);
 880             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 881             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 882 
 883             // Flag it as ready for review
 884             pr.setBody(&quot;This should now be ready&quot;);
 885 
</pre>
<hr />
<pre>
 909             // The webrev comment should not contain duplicate entries
 910             comments = pr.getComments();
 911             webrevComments = comments.stream()
 912                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 913                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 914                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 915                                          .collect(Collectors.toList());
 916             assertEquals(1, webrevComments.size());
 917             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
 918         }
 919     }
 920 
 921     @Test
 922     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
 923         try (var credentials = new HostCredentials(testInfo);
 924              var tempFolder = new TemporaryDirectory();
 925              var archiveFolder = new TemporaryDirectory();
 926              var listServer = new TestMailmanServer()) {
 927             var author = credentials.getHostedRepository();
 928             var archive = credentials.getHostedRepository();
<span class="line-added"> 929             var reviewer = credentials.getHostedRepository();</span>
 930             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 931             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 932             var censusBuilder = credentials.getCensusBuilder()</span>
<span class="line-added"> 933                                            .addReviewer(reviewer.host().getCurrentUserDetails().id())</span>
<span class="line-added"> 934                                            .addAuthor(author.host().getCurrentUserDetails().id());</span>
<span class="line-added"> 935             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,</span>
<span class="line-added"> 936                                                  listAddress, Set.of(), Set.of(),</span>
 937                                                  listServer.getArchive(), listServer.getSMTP(),
 938                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 939                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 940                                                  Set.of(), Map.of());
 941 
 942             // Populate the projects repository
 943             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 944             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 945             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 946             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 947             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 948 
 949             // Make a change with a corresponding PR
 950             var editHash = CheckableRepository.appendAndCommit(localRepo);
 951             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 952             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 953             pr.setBody(&quot;This is now ready&quot;);
 954 
 955             // Run an archive pass
 956             TestBotRunner.runPeriodicItems(mlBot);
 957 
 958             // First unapprove it
<span class="line-modified"> 959             var reviewedPr = reviewer.getPullRequest(pr.getId());</span>
 960             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
 961             TestBotRunner.runPeriodicItems(mlBot);
 962             TestBotRunner.runPeriodicItems(mlBot);
 963             TestBotRunner.runPeriodicItems(mlBot);
 964 
 965             // The archive should contain a note
 966             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
<span class="line-modified"> 967             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Review status set to Disapproved&quot;));</span>
<span class="line-added"> 968             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot; by integrationreviewer1&quot;));</span>
 969             if (author.host().supportsReviewBody()) {
 970                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
 971             }
 972 
 973             // Then approve it
 974             reviewedPr.addReview(Review.Verdict.APPROVED, &quot;Reason 2&quot;);
 975             TestBotRunner.runPeriodicItems(mlBot);
 976             TestBotRunner.runPeriodicItems(mlBot);
 977             TestBotRunner.runPeriodicItems(mlBot);
 978 
 979             // The archive should contain another note
 980             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
<span class="line-modified"> 981             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Review status set to Approved&quot;));</span>
 982             if (author.host().supportsReviewBody()) {
 983                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 2&quot;));
 984             }
<span class="line-added"> 985             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;This PR has been marked as Reviewed by integrationreviewer1.&quot;));</span>
 986 
 987             // Yet another change
 988             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 3&quot;);
 989             TestBotRunner.runPeriodicItems(mlBot);
 990             TestBotRunner.runPeriodicItems(mlBot);
 991             TestBotRunner.runPeriodicItems(mlBot);
 992 
 993             // The archive should contain another note
 994             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
<span class="line-modified"> 995             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Review status set to Disapproved&quot;));</span>
 996             if (author.host().supportsReviewBody()) {
 997                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
 998             }
 999         }
1000     }
<span class="line-added">1001 </span>
<span class="line-added">1002     @Test</span>
<span class="line-added">1003     void ignoreComments(TestInfo testInfo) throws IOException {</span>
<span class="line-added">1004         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added">1005              var tempFolder = new TemporaryDirectory();</span>
<span class="line-added">1006              var archiveFolder = new TemporaryDirectory();</span>
<span class="line-added">1007              var listServer = new TestMailmanServer()) {</span>
<span class="line-added">1008             var author = credentials.getHostedRepository();</span>
<span class="line-added">1009             var ignored = credentials.getHostedRepository();</span>
<span class="line-added">1010             var archive = credentials.getHostedRepository();</span>
<span class="line-added">1011             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="line-added">1012             var censusBuilder = credentials.getCensusBuilder()</span>
<span class="line-added">1013                                            .addAuthor(author.host().getCurrentUserDetails().id());</span>
<span class="line-added">1014             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);</span>
<span class="line-added">1015             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,</span>
<span class="line-added">1016                                                  listAddress,</span>
<span class="line-added">1017                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),</span>
<span class="line-added">1018                                                  Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)),</span>
<span class="line-added">1019                                                  listServer.getArchive(), listServer.getSMTP(),</span>
<span class="line-added">1020                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),</span>
<span class="line-added">1021                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),</span>
<span class="line-added">1022                                                  Set.of(), Map.of());</span>
<span class="line-added">1023 </span>
<span class="line-added">1024             // Populate the projects repository</span>
<span class="line-added">1025             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);</span>
<span class="line-added">1026             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);</span>
<span class="line-added">1027             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="line-added">1028             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);</span>
<span class="line-added">1029             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);</span>
<span class="line-added">1030 </span>
<span class="line-added">1031             // Make a change with a corresponding PR</span>
<span class="line-added">1032             var editHash = CheckableRepository.appendAndCommit(localRepo);</span>
<span class="line-added">1033             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);</span>
<span class="line-added">1034             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);</span>
<span class="line-added">1035             pr.setBody(&quot;This is now ready&quot;);</span>
<span class="line-added">1036 </span>
<span class="line-added">1037             // Make a bunch of comments</span>
<span class="line-added">1038             pr.addComment(&quot;Plain comment&quot;);</span>
<span class="line-added">1039             pr.addComment(&quot;ignore this comment&quot;);</span>
<span class="line-added">1040             pr.addComment(&quot;I think it is time to\nignore this comment!&quot;);</span>
<span class="line-added">1041             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review ignore this comment&quot;);</span>
<span class="line-added">1042 </span>
<span class="line-added">1043             var ignoredPR = ignored.getPullRequest(pr.getId());</span>
<span class="line-added">1044             ignoredPR.addComment(&quot;Don&#39;t mind me&quot;);</span>
<span class="line-added">1045 </span>
<span class="line-added">1046             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added">1047             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added">1048 </span>
<span class="line-added">1049             // The archive should not contain the ignored comments</span>
<span class="line-added">1050             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);</span>
<span class="line-added">1051             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));</span>
<span class="line-added">1052             assertFalse(archiveContains(archiveFolder.path(), &quot;ignore this comment&quot;));</span>
<span class="line-added">1053             assertFalse(archiveContains(archiveFolder.path(), &quot;it is time to&quot;));</span>
<span class="line-added">1054             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));</span>
<span class="line-added">1055             assertFalse(archiveContains(archiveFolder.path(), &quot;Review ignore&quot;));</span>
<span class="line-added">1056         }</span>
<span class="line-added">1057     }</span>
1058 }
</pre>
</td>
</tr>
</table>
<center><a href="MailingListArchiveReaderBotTests.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../../email/src/main/java/org/openjdk/skara/email/Email.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>