<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.bots.mlbridge;
 24 
 25 import org.openjdk.skara.email.EmailAddress;
 26 import org.openjdk.skara.host.Review;
 27 import org.openjdk.skara.host.network.URIBuilder;
 28 import org.openjdk.skara.mailinglist.MailingListServerFactory;
 29 import org.openjdk.skara.test.*;
 30 import org.openjdk.skara.vcs.Repository;
 31 
 32 import org.junit.jupiter.api.*;
 33 
 34 import java.io.IOException;
 35 import java.nio.charset.StandardCharsets;
 36 import java.nio.file.*;
 37 import java.time.Duration;
 38 import java.util.*;
 39 import java.util.regex.Pattern;
 40 import java.util.stream.Collectors;
 41 
 42 import static org.junit.jupiter.api.Assertions.*;
 43 
 44 class MailingListBridgeBotTests {
 45     private boolean archiveContains(Path archive, String text) {
 46         return archiveContainsCount(archive, text) &gt; 0;
 47     }
 48 
 49     private int archiveContainsCount(Path archive, String text) {
 50         try {
 51             var mbox = Files.find(archive, 50, (path, attrs) -&gt; path.toString().endsWith(&quot;.mbox&quot;)).findAny();
 52             if (mbox.isEmpty()) {
 53                 return 0;
 54             }
 55             var lines = Files.readString(mbox.get(), StandardCharsets.UTF_8);
 56             var pattern = Pattern.compile(text);
 57             int count = 0;
 58             for (var line : lines.split(&quot;\\R&quot;)) {
 59                 var matcher = pattern.matcher(line);
 60                 if (matcher.find()) {
 61                     count++;
 62                 }
 63             }
 64             return count;
 65         } catch (IOException e) {
 66             return 0;
 67         }
 68     }
 69 
 70     private boolean webrevContains(Path webrev, String text) {
 71         try {
 72             var index = Files.find(webrev, 5, (path, attrs) -&gt; path.toString().endsWith(&quot;index.html&quot;)).findAny();
 73             if (index.isEmpty()) {
 74                 return false;
 75             }
 76             var lines = Files.readString(index.get(), StandardCharsets.UTF_8);
 77             return lines.contains(text);
 78         } catch (IOException e) {
 79             return false;
 80         }
 81     }
 82 
 83     private long countSubstrings(String string, String substring) {
 84         return Pattern.compile(substring).matcher(string).results().count();
 85     }
 86 
 87     @Test
 88     void simpleArchive(TestInfo testInfo) throws IOException {
 89         try (var credentials = new HostCredentials(testInfo);
 90              var tempFolder = new TemporaryDirectory();
 91              var archiveFolder = new TemporaryDirectory();
 92              var webrevFolder = new TemporaryDirectory();
 93              var listServer = new TestMailmanServer()) {
 94             var author = credentials.getHostedRepository();
 95             var archive = credentials.getHostedRepository();
 96             var ignored = credentials.getHostedRepository();
 97             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 98             var censusBuilder = credentials.getCensusBuilder()
 99                                            .addAuthor(author.host().getCurrentUserDetails().id());
100             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
101             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress,
102                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
103                                                  listServer.getArchive(), listServer.getSMTP(),
104                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
105                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
106                                                  Set.of(&quot;rfr&quot;), Map.of(ignored.host().getCurrentUserDetails().userName(),
107                                                                        Pattern.compile(&quot;ready&quot;)));
108 
109             // Populate the projects repository
110             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
111             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
112             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
113             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
114 
115             // Make a change with a corresponding PR
116             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
117                                                                &quot;Change msg\n\nWith several lines&quot;);
118             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
119             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
120             pr.setBody(&quot;This should not be ready&quot;);
121 
122             // Run an archive pass
123             TestBotRunner.runPeriodicItems(mlBot);
124 
125             // A PR that isn&#39;t ready for review should not be archived
126             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
127             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
128 
129             // Flag it as ready for review
130             pr.setBody(&quot;This should now be ready&quot;);
131             pr.addLabel(&quot;rfr&quot;);
132 
133             // Run another archive pass
134             TestBotRunner.runPeriodicItems(mlBot);
135 
136             // But it should still not be archived
137             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
138             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
139 
140             // Now post a general comment - not a ready marker
141             var ignoredPr = ignored.getPullRequest(pr.getId());
142             ignoredPr.addComment(&quot;hello there&quot;);
143 
144             // Run another archive pass
145             TestBotRunner.runPeriodicItems(mlBot);
146 
147             // It should still not be archived
148             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
149             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
150 
151             // Now post a ready comment
152             ignoredPr.addComment(&quot;ready&quot;);
153 
154             // Run another archive pass
155             TestBotRunner.runPeriodicItems(mlBot);
156 
157             // The archive should now contain an entry
158             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
159             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
160             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
161             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
162             assertTrue(archiveContains(archiveFolder.path(), &quot;Pull request:&quot;));
163             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
164             assertTrue(archiveContains(archiveFolder.path(), &quot;http://www.test.test/&quot;));
165             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));
166             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch command:&quot;));
167             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - &quot; + editHash.abbreviate() + &quot;:\tChange msg&quot;));
168             assertTrue(archiveContains(archiveFolder.path(), &quot;^\t\t\tWith several lines&quot;));
169 
170             // The mailing list as well
171             listServer.processIncoming();
172             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
173             var mailmanList = mailmanServer.getList(listAddress.address());
174             var conversations = mailmanList.conversations(Duration.ofDays(1));
175             assertEquals(1, conversations.size());
176             var mail = conversations.get(0).first();
177             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
178             assertEquals(pr.getAuthor().fullName() + &quot; via &quot; + pr.repository().getUrl().getHost(), mail.author().fullName().orElseThrow());
179             assertEquals(from.address(), mail.author().address());
180             assertEquals(from, mail.sender());
181 
182             // And there should be a webrev
183             Repository.materialize(webrevFolder.path(), archive.getUrl(), &quot;webrev&quot;);
184             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
185             var comments = pr.getComments();
186             var webrevComments = comments.stream()
187                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
188                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
189                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
190                                          .collect(Collectors.toList());
191             assertEquals(1, webrevComments.size());
192 
193             // Add a comment
194             pr.addComment(&quot;This is a comment&quot;);
195 
196             // Add a comment from an ignored user as well
197             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);
198 
199             // Run another archive pass
200             TestBotRunner.runPeriodicItems(mlBot);
201 
202             // The archive should now contain the comment, but not the ignored one
203             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
204             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a comment&quot;));
205             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This should now be ready&quot;));
206             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
207 
208             listServer.processIncoming();
209             conversations = mailmanList.conversations(Duration.ofDays(1));
210             assertEquals(1, conversations.size());
211             assertEquals(2, conversations.get(0).allMessages().size());
212 
213             // Remove the rfr flag and post another comment
214             pr.addLabel(&quot;rfr&quot;);
215             pr.addComment(&quot;This is another comment&quot;);
216 
217             // Run another archive pass
218             TestBotRunner.runPeriodicItems(mlBot);
219 
220             // The archive should contain the additional comment
221             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
222             assertTrue(archiveContains(archiveFolder.path(), &quot;This is another comment&quot;));
223             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This should now be ready&quot;));
224 
225             listServer.processIncoming();
226             conversations = mailmanList.conversations(Duration.ofDays(1));
227             assertEquals(1, conversations.size());
228             assertEquals(3, conversations.get(0).allMessages().size());
229             for (var newMail : conversations.get(0).allMessages()) {
230                 assertEquals(from.address(), newMail.author().address());
231                 assertEquals(from, newMail.sender());
232             }
233         }
234     }
235 
236     @Test
237     void reviewComment(TestInfo testInfo) throws IOException {
238         try (var credentials = new HostCredentials(testInfo);
239              var tempFolder = new TemporaryDirectory();
240              var archiveFolder = new TemporaryDirectory();
241              var listServer = new TestMailmanServer()) {
242             var author = credentials.getHostedRepository();
243             var archive = credentials.getHostedRepository();
244             var ignored = credentials.getHostedRepository();
245             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
246             var censusBuilder = credentials.getCensusBuilder()
247                                            .addAuthor(author.host().getCurrentUserDetails().id());
248             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
249             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress,
250                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
251                                                  listServer.getArchive(), listServer.getSMTP(),
252                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
253                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
254                                                  Set.of(), Map.of());
255 
256             // Populate the projects repository
257             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
258             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
259             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
260             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
261             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
262 
263             // Make a change with a corresponding PR
264             var editHash = CheckableRepository.appendAndCommit(localRepo);
265             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
266             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
267             pr.setBody(&quot;This is now ready&quot;);
268             TestBotRunner.runPeriodicItems(mlBot);
269             listServer.processIncoming();
270 
271             // And make a file specific comment
272             var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
273             var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
274 
275             // Add one from an ignored user as well
276             var ignoredPr = ignored.getPullRequest(pr.getId());
277             ignoredPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Don&#39;t mind me&quot;);
278 
279             // Process comments
280             TestBotRunner.runPeriodicItems(mlBot);
281             listServer.processIncoming();
282 
283             // The archive should now contain an entry
284             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
285             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
286             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
287             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
288             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This is now ready&quot;));
289             assertTrue(archiveContains(archiveFolder.path(), reviewFile.toString()));
290             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
291 
292             // The mailing list as well
293             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
294             var mailmanList = mailmanServer.getList(listAddress.address());
295             var conversations = mailmanList.conversations(Duration.ofDays(1));
296             assertEquals(1, conversations.size());
297             var mail = conversations.get(0).first();
298             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
299 
300             // Comment on the comment
301             pr.addReviewCommentReply(comment, &quot;This is a review reply&quot;);
302             TestBotRunner.runPeriodicItems(mlBot);
303             listServer.processIncoming();
304 
305             // The archive should contain the additional comment
306             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
307             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a review reply&quot;));
308             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This is now ready&quot;));
309 
310             // As well as the mailing list
311             conversations = mailmanList.conversations(Duration.ofDays(1));
312             assertEquals(1, conversations.size());
313             assertEquals(3, conversations.get(0).allMessages().size());
314             for (var newMail : conversations.get(0).allMessages()) {
315                 assertEquals(from.address(), newMail.author().address());
316                 assertEquals(from, newMail.sender());
317             }
318         }
319     }
320 
321     @Test
322     void combineComments(TestInfo testInfo) throws IOException {
323         try (var credentials = new HostCredentials(testInfo);
324              var tempFolder = new TemporaryDirectory();
325              var archiveFolder = new TemporaryDirectory();
326              var listServer = new TestMailmanServer()) {
327             var author = credentials.getHostedRepository();
328             var archive = credentials.getHostedRepository();
329             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
330             var censusBuilder = credentials.getCensusBuilder()
331                                            .addAuthor(author.host().getCurrentUserDetails().id());
332             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
333             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress, Set.of(), listServer.getArchive(),
334                                                  listServer.getSMTP(),
335                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
336                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
337                                                  Set.of(), Map.of());
338 
339             // Populate the projects repository
340             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
341             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
342             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
343             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
344             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
345 
346             // Make a change with a corresponding PR
347             var editHash = CheckableRepository.appendAndCommit(localRepo);
348             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
349             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
350             pr.setBody(&quot;This is now ready&quot;);
351             TestBotRunner.runPeriodicItems(mlBot);
352             listServer.processIncoming();
353 
354             // Make two file specific comments
355             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
356             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
357             TestBotRunner.runPeriodicItems(mlBot);
358             listServer.processIncoming();
359 
360             // The archive should not contain a combined entry
361             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
362             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
363 
364             // But the mailing list should
365             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
366             var mailmanList = mailmanServer.getList(listAddress.address());
367             var conversations = mailmanList.conversations(Duration.ofDays(1));
368             assertEquals(1, conversations.size());
369             var mail = conversations.get(0).first();
370             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
371             assertEquals(2, conversations.get(0).allMessages().size());
372 
373             var reply = conversations.get(0).replies(mail).get(0);
374             assertEquals(2, reply.body().split(&quot;^On.*wrote:&quot;).length);
375             assertEquals(2, reply.body().split(&quot;&gt; This is now ready&quot;).length, reply.body());
376             assertEquals(&quot;Re: RFR: This is a pull request&quot;, reply.subject());
377             assertTrue(reply.body().contains(&quot;Review comment\n\n&quot;), reply.body());
378             assertTrue(reply.body().contains(&quot;Another review comment&quot;), reply.body());
379         }
380     }
381 
382     @Test
383     void reviewContext(TestInfo testInfo) throws IOException {
384         try (var credentials = new HostCredentials(testInfo);
385              var tempFolder = new TemporaryDirectory();
386              var archiveFolder = new TemporaryDirectory();
387              var listServer = new TestMailmanServer()) {
388             var author = credentials.getHostedRepository();
389             var archive = credentials.getHostedRepository();
390             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
391             var censusBuilder = credentials.getCensusBuilder()
392                                            .addAuthor(author.host().getCurrentUserDetails().id());
393             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
394             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress, Set.of(), listServer.getArchive(),
395                                                  listServer.getSMTP(),
396                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
397                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
398                                                  Set.of(), Map.of());
399 
400             // Populate the projects repository
401             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
402             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
403             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
404             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
405             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
406 
407             // Make a change with a corresponding PR
408             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
409             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
410             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
411             pr.setBody(&quot;This is now ready&quot;);
412             TestBotRunner.runPeriodicItems(mlBot);
413             listServer.processIncoming();
414 
415             // Make a file specific comment
416             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
417 
418             TestBotRunner.runPeriodicItems(mlBot);
419             listServer.processIncoming();
420 
421             // The archive should only contain context around line 2
422             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
423             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
424             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
425             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
426         }
427     }
428 
429     @Test
430     void multipleReviewContexts(TestInfo testInfo) throws IOException {
431         try (var credentials = new HostCredentials(testInfo);
432              var tempFolder = new TemporaryDirectory();
433              var archiveFolder = new TemporaryDirectory();
434              var listServer = new TestMailmanServer()) {
435             var author = credentials.getHostedRepository();
436             var archive = credentials.getHostedRepository();
437             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
438             var censusBuilder = credentials.getCensusBuilder()
439                                            .addAuthor(author.host().getCurrentUserDetails().id());
440             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
441             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress, Set.of(), listServer.getArchive(),
442                                                  listServer.getSMTP(),
443                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
444                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
445                                                  Set.of(), Map.of());
446 
447             // Populate the projects repository
448             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
449             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
450             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
451             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
452             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
453             var initialHash = CheckableRepository.appendAndCommit(localRepo,
454                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
455                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
456                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
457                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
458                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
459                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
460             localRepo.push(initialHash, author.getUrl(), &quot;master&quot;);
461 
462             // Make a change with a corresponding PR
463             var current = Files.readString(localRepo.root().resolve(reviewFile), StandardCharsets.UTF_8);
464             var updated = current.replaceAll(&quot;Line 2&quot;, &quot;Line 2 edit\nLine 2.5&quot;);
465             updated = updated.replaceAll(&quot;Line 13&quot;, &quot;Line 12.5\nLine 13 edit&quot;);
466             Files.writeString(localRepo.root().resolve(reviewFile), updated, StandardCharsets.UTF_8);
467             var editHash = CheckableRepository.appendAndCommit(localRepo);
468             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
469             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
470             pr.setBody(&quot;This is now ready&quot;);
471             TestBotRunner.runPeriodicItems(mlBot);
472             listServer.processIncoming();
473 
474             // Make file specific comments
475             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 7, &quot;Review comment&quot;);
476             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 24, &quot;Another review comment&quot;);
477 
478             TestBotRunner.runPeriodicItems(mlBot);
479             listServer.processIncoming();
480 
481             // The archive should only contain context around line 2 and 20
482             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
483             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 7&quot;));
484             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 6: Line 1$&quot;));
485             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 7: Line 2 edit$&quot;));
486             assertFalse(archiveContains(archiveFolder.path(), &quot;Line 3&quot;));
487 
488             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 24&quot;));
489             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 23: Line 12.5$&quot;));
490             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 24: Line 13 edit$&quot;));
491             assertFalse(archiveContains(archiveFolder.path(), &quot;^Line 15&quot;));
492         }
493     }
494 
495     @Test
496     void filterComments(TestInfo testInfo) throws IOException {
497         try (var credentials = new HostCredentials(testInfo);
498              var tempFolder = new TemporaryDirectory();
499              var archiveFolder = new TemporaryDirectory();
500              var listServer = new TestMailmanServer()) {
501             var author = credentials.getHostedRepository();
502             var archive = credentials.getHostedRepository();
503             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
504             var censusBuilder = credentials.getCensusBuilder()
505                                            .addAuthor(author.host().getCurrentUserDetails().id());
506             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
507             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress, Set.of(),
508                                                  listServer.getArchive(), listServer.getSMTP(),
509                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
510                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
511                                                  Set.of(), Map.of());
512 
513             // Populate the projects repository
514             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
515             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
516             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
517             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
518             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
519 
520             // Make a change with a corresponding PR
521             var editHash = CheckableRepository.appendAndCommit(localRepo);
522             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
523             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
524             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
525                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
526 
527             // Make a bunch of comments
528             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
529             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment &lt;!-- this is a comment --&gt;\n&quot;);
530             pr.addComment(&quot;/integrate stuff&quot;);
531             TestBotRunner.runPeriodicItems(mlBot);
532 
533             // Run an archive pass
534             TestBotRunner.runPeriodicItems(mlBot);
535 
536             // The archive should not contain the comment
537             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
538             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
539             assertFalse(archiveContains(archiveFolder.path(), &quot;this is a comment&quot;));
540             assertFalse(archiveContains(archiveFolder.path(), &quot;Status stuff&quot;));
541             assertTrue(archiveContains(archiveFolder.path(), &quot;And this is not&quot;));
542             assertFalse(archiveContains(archiveFolder.path(), &quot;&lt;!--&quot;));
543             assertFalse(archiveContains(archiveFolder.path(), &quot;--&gt;&quot;));
544             assertTrue(archiveContains(archiveFolder.path(), &quot;Plain comment&quot;));
545             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
546             assertFalse(archiveContains(archiveFolder.path(), &quot;/integrate&quot;));
547         }
548     }
549 
550     @Test
551     void incrementalChanges(TestInfo testInfo) throws IOException {
552         try (var credentials = new HostCredentials(testInfo);
553              var tempFolder = new TemporaryDirectory();
554              var archiveFolder = new TemporaryDirectory();
555              var listServer = new TestMailmanServer()) {
556             var author = credentials.getHostedRepository();
557             var archive = credentials.getHostedRepository();
558             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
559             var censusBuilder = credentials.getCensusBuilder()
560                                            .addAuthor(author.host().getCurrentUserDetails().id());
561             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
562             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress, Set.of(),
563                                                  listServer.getArchive(), listServer.getSMTP(),
564                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
565                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
566                                                  Set.of(), Map.of());
567 
568             // Populate the projects repository
569             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
570             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
571             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
572             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
573             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
574 
575             // Make a change with a corresponding PR
576             var editHash = CheckableRepository.appendAndCommit(localRepo);
577             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
578             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
579             pr.setBody(&quot;This is now ready&quot;);
580 
581             // Run an archive pass
582             TestBotRunner.runPeriodicItems(mlBot);
583             listServer.processIncoming();
584 
585             var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
586             localRepo.push(nextHash, author.getUrl(), &quot;edit&quot;);
587 
588             // Make sure that the push registered
589             var lastHeadHash = pr.getHeadHash();
590             var refreshCount = 0;
591             do {
592                 pr = author.getPullRequest(pr.getId());
593                 if (refreshCount++ &gt; 100) {
594                     fail(&quot;The PR did not update after the new push&quot;);
595                 }
596             } while (pr.getHeadHash().equals(lastHeadHash));
597 
598             // Run another archive pass
599             TestBotRunner.runPeriodicItems(mlBot);
600             TestBotRunner.runPeriodicItems(mlBot);
601             TestBotRunner.runPeriodicItems(mlBot);
602             listServer.processIncoming();
603 
604             // The archive should reference the updated push
605             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
606             assertTrue(archiveContains(archiveFolder.path(), &quot;additional changes&quot;));
607             assertTrue(archiveContains(archiveFolder.path(), &quot;full.*/&quot; + pr.getId() + &quot;/webrev.01&quot;));
608             assertTrue(archiveContains(archiveFolder.path(), &quot;inc.*/&quot; + pr.getId() + &quot;/webrev.00-01&quot;));
609             assertTrue(archiveContains(archiveFolder.path(), &quot;Updated full patch&quot;));
610             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
611             assertTrue(archiveContains(archiveFolder.path(), &quot;Fixing&quot;));
612 
613             // The webrev comment should be updated
614             var comments = pr.getComments();
615             var webrevComments = comments.stream()
616                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
617                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
618                                          .filter(comment -&gt; comment.body().contains(nextHash.hex()))
619                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
620                                          .collect(Collectors.toList());
621             assertEquals(1, webrevComments.size());
622 
623             // Check that sender address is set properly
624             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
625             var mailmanList = mailmanServer.getList(listAddress.address());
626             var conversations = mailmanList.conversations(Duration.ofDays(1));
627             assertEquals(1, conversations.size());
628             for (var newMail : conversations.get(0).allMessages()) {
629                 assertEquals(from.address(), newMail.author().address());
630                 assertEquals(from, newMail.sender());
631             }
632 
633             // Ensure that additional updates are only reported once
634             for (int i = 0; i &lt; 3; ++i) {
635                 var anotherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fixing&quot;);
636                 localRepo.push(anotherHash, author.getUrl(), &quot;edit&quot;);
637 
638                 // Make sure that the push registered
639                 lastHeadHash = pr.getHeadHash();
640                 refreshCount = 0;
641                 do {
642                     pr = author.getPullRequest(pr.getId());
643                     if (refreshCount++ &gt; 100) {
644                         fail(&quot;The PR did not update after the new push&quot;);
645                     }
646                 } while (pr.getHeadHash().equals(lastHeadHash));
647 
648                 TestBotRunner.runPeriodicItems(mlBot);
649                 TestBotRunner.runPeriodicItems(mlBot);
650                 listServer.processIncoming();
651             }
652             var updatedConversations = mailmanList.conversations(Duration.ofDays(1));
653             assertEquals(1, updatedConversations.size());
654             var conversation = updatedConversations.get(0);
655             assertEquals(5, conversation.allMessages().size());
656         }
657     }
658 
659     @Test
660     void rebased(TestInfo testInfo) throws IOException {
661         try (var credentials = new HostCredentials(testInfo);
662              var tempFolder = new TemporaryDirectory();
663              var archiveFolder = new TemporaryDirectory();
664              var listServer = new TestMailmanServer()) {
665             var author = credentials.getHostedRepository();
666             var archive = credentials.getHostedRepository();
667             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
668             var censusBuilder = credentials.getCensusBuilder()
669                                            .addAuthor(author.host().getCurrentUserDetails().id());
670             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
671             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress, Set.of(),
672                                                  listServer.getArchive(), listServer.getSMTP(),
673                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
674                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
675                                                  Set.of(), Map.of());
676 
677             // Populate the projects repository
678             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
679             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.getRepositoryType(), reviewFile);
680             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
681             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
682             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
683 
684             // Make a change with a corresponding PR
685             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
686             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
687             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
688             pr.setBody(&quot;This is now ready&quot;);
689 
690             // Run an archive pass
691             TestBotRunner.runPeriodicItems(mlBot);
692             listServer.processIncoming();
693 
694             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.getUrl(), &quot;master&quot;);
695             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
696             newLocalRepo.push(newEditHash, author.getUrl(), &quot;edit&quot;, true);
697 
698             // Make sure that the push registered
699             var lastHeadHash = pr.getHeadHash();
700             var refreshCount = 0;
701             do {
702                 pr = author.getPullRequest(pr.getId());
703                 if (refreshCount++ &gt; 100) {
704                     fail(&quot;The PR did not update after the new push&quot;);
705                 }
706             } while (pr.getHeadHash().equals(lastHeadHash));
707 
708             // Run another archive pass
709             TestBotRunner.runPeriodicItems(mlBot);
710             listServer.processIncoming();
711 
712             // The archive should reference the rebased push
713             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
714             assertTrue(archiveContains(archiveFolder.path(), &quot;complete new set of changes&quot;));
715             assertTrue(archiveContains(archiveFolder.path(), pr.getId() + &quot;/webrev.01&quot;));
716             assertFalse(archiveContains(archiveFolder.path(), &quot;Incremental&quot;));
717             assertTrue(archiveContains(archiveFolder.path(), &quot;Updated full patch&quot;));
718             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
719             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
720             assertTrue(archiveContains(archiveFolder.path(), &quot;Replaced msg&quot;));
721 
722             // The webrev comment should be updated
723             var comments = pr.getComments();
724             var webrevComments = comments.stream()
725                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
726                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
727                                          .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
728                                          .collect(Collectors.toList());
729             assertEquals(1, webrevComments.size());
730 
731             // Check that sender address is set properly
732             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
733             var mailmanList = mailmanServer.getList(listAddress.address());
734             var conversations = mailmanList.conversations(Duration.ofDays(1));
735             assertEquals(1, conversations.size());
736             for (var newMail : conversations.get(0).allMessages()) {
737                 assertEquals(from.address(), newMail.author().address());
738                 assertEquals(from, newMail.sender());
739             }
740         }
741     }
742 
743     @Test
744     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
745         try (var credentials = new HostCredentials(testInfo);
746              var tempFolder = new TemporaryDirectory();
747              var archiveFolder = new TemporaryDirectory();
748              var webrevFolder = new TemporaryDirectory();
749              var listServer = new TestMailmanServer()) {
750             var author = credentials.getHostedRepository();
751             var archive = credentials.getHostedRepository();
752             var ignored = credentials.getHostedRepository();
753             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
754             var censusBuilder = credentials.getCensusBuilder()
755                                            .addAuthor(author.host().getCurrentUserDetails().id());
756             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
757             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress,
758                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
759                                                  listServer.getArchive(), listServer.getSMTP(),
760                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
761                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
762                                                  Set.of(), Map.of());
763 
764             // Populate the projects repository
765             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
766             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
767             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
768             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
769 
770             // Make a change with a corresponding PR
771             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
772                                                                &quot;Change msg\n\nWith several lines&quot;);
773             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
774             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
775 
776             // Flag it as ready for review
777             pr.setBody(&quot;This should now be ready&quot;);
778 
779             // Run an archive pass
780             TestBotRunner.runPeriodicItems(mlBot);
781 
782             // The archive should now contain an entry
783             var archiveRepo = Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
784             assertTrue(archiveContains(archiveFolder.path(), editHash.abbreviate()));
785 
786             // And there should be a webrev comment
787             var comments = pr.getComments();
788             var webrevComments = comments.stream()
789                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
790                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
791                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
792                                          .collect(Collectors.toList());
793             assertEquals(1, webrevComments.size());
794             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
795 
796             // Pretend the archive didn&#39;t work out
797             archiveRepo.push(masterHash, archive.getUrl(), &quot;master&quot;, true);
798 
799             // Run another archive pass
800             TestBotRunner.runPeriodicItems(mlBot);
801 
802             // The webrev comment should not contain duplicate entries
803             comments = pr.getComments();
804             webrevComments = comments.stream()
805                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
806                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
807                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
808                                          .collect(Collectors.toList());
809             assertEquals(1, webrevComments.size());
810             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
811         }
812     }
813 
814     @Test
815     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
816         try (var credentials = new HostCredentials(testInfo);
817              var tempFolder = new TemporaryDirectory();
818              var archiveFolder = new TemporaryDirectory();
819              var listServer = new TestMailmanServer()) {
820             var author = credentials.getHostedRepository();
821             var archive = credentials.getHostedRepository();
822             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
823             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
824             var mlBot = new MailingListBridgeBot(from, author, archive, listAddress, Set.of(),
825                                                  listServer.getArchive(), listServer.getSMTP(),
826                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
827                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
828                                                  Set.of(), Map.of());
829 
830             // Populate the projects repository
831             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
832             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
833             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
834             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
835             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
836 
837             // Make a change with a corresponding PR
838             var editHash = CheckableRepository.appendAndCommit(localRepo);
839             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
840             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
841             pr.setBody(&quot;This is now ready&quot;);
842 
843             // Run an archive pass
844             TestBotRunner.runPeriodicItems(mlBot);
845 
846             // First unapprove it
847             var reviewedPr = credentials.getHostedRepository().getPullRequest(pr.getId());
848             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
849             TestBotRunner.runPeriodicItems(mlBot);
850             TestBotRunner.runPeriodicItems(mlBot);
851             TestBotRunner.runPeriodicItems(mlBot);
852 
853             // The archive should contain a note
854             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
855             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;This PR has been reviewed.*more changes are needed&quot;));
856             if (author.host().supportsReviewBody()) {
857                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
858             }
859 
860             // Then approve it
861             reviewedPr.addReview(Review.Verdict.APPROVED, &quot;Reason 2&quot;);
862             TestBotRunner.runPeriodicItems(mlBot);
863             TestBotRunner.runPeriodicItems(mlBot);
864             TestBotRunner.runPeriodicItems(mlBot);
865 
866             // The archive should contain another note
867             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
868             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;This PR.*approved&quot;));
869             if (author.host().supportsReviewBody()) {
870                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 2&quot;));
871             }
872 
873             // Yet another change
874             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 3&quot;);
875             TestBotRunner.runPeriodicItems(mlBot);
876             TestBotRunner.runPeriodicItems(mlBot);
877             TestBotRunner.runPeriodicItems(mlBot);
878 
879             // The archive should contain another note
880             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
881             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;This PR.*more changes&quot;));
882             if (author.host().supportsReviewBody()) {
883                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
884             }
885         }
886     }
887 }
    </pre>
  </body>
</html>