<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/ArchiveWorkItem.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="CensusInstance.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/ArchiveWorkItem.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 24,24 ***</span>
  
  import org.openjdk.skara.bot.WorkItem;
  import org.openjdk.skara.email.*;
  import org.openjdk.skara.host.*;
  import org.openjdk.skara.mailinglist.*;
<span class="line-modified">! import org.openjdk.skara.vcs.*;</span>
  
  import java.io.*;
  import java.net.URI;
<span class="line-removed">- import java.nio.charset.StandardCharsets;</span>
  import java.nio.file.Path;
<span class="line-modified">! import java.security.*;</span>
<span class="line-removed">- import java.time.*;</span>
<span class="line-removed">- import java.time.format.DateTimeFormatter;</span>
  import java.util.*;
<span class="line-modified">! import java.util.function.*;</span>
  import java.util.logging.Logger;
  import java.util.regex.Pattern;
<span class="line-removed">- import java.util.stream.Collectors;</span>
  
  class ArchiveWorkItem implements WorkItem {
      private final PullRequest pr;
      private final MailingListBridgeBot bot;
      private final Consumer&lt;RuntimeException&gt; exceptionConsumer;
<span class="line-new-header">--- 24,20 ---</span>
  
  import org.openjdk.skara.bot.WorkItem;
  import org.openjdk.skara.email.*;
  import org.openjdk.skara.host.*;
  import org.openjdk.skara.mailinglist.*;
<span class="line-modified">! import org.openjdk.skara.vcs.Repository;</span>
  
  import java.io.*;
  import java.net.URI;
  import java.nio.file.Path;
<span class="line-modified">! import java.time.Duration;</span>
  import java.util.*;
<span class="line-modified">! import java.util.function.Consumer;</span>
  import java.util.logging.Logger;
  import java.util.regex.Pattern;
  
  class ArchiveWorkItem implements WorkItem {
      private final PullRequest pr;
      private final MailingListBridgeBot bot;
      private final Consumer&lt;RuntimeException&gt; exceptionConsumer;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 109,157 ***</span>
          }
  
          return Optional.empty();
      }
  
<span class="line-removed">-     private String quoteBody(String body) {</span>
<span class="line-removed">-         return Arrays.stream(body.strip().split(&quot;\\R&quot;))</span>
<span class="line-removed">-                      .map(line -&gt; line.length() &gt; 0 ? line.charAt(0) == &#39;&gt;&#39; ? &quot;&gt;&quot; + line : &quot;&gt; &quot; + line : &quot;&gt; &quot;)</span>
<span class="line-removed">-                      .collect(Collectors.joining(&quot;\n&quot;));</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private static final Pattern commentPattern = Pattern.compile(&quot;&lt;!--.*?--&gt;&quot;,</span>
<span class="line-removed">-                                                                   Pattern.DOTALL | Pattern.MULTILINE);</span>
<span class="line-removed">-     private static final Pattern cutoffPattern = Pattern.compile(&quot;(.*?)&lt;!-- Anything below this marker will be .*? --&gt;&quot;,</span>
<span class="line-removed">-                                                                  Pattern.DOTALL | Pattern.MULTILINE);</span>
<span class="line-removed">-     private String filterComments(String body) {</span>
<span class="line-removed">-         var cutoffMatcher = cutoffPattern.matcher(body);</span>
<span class="line-removed">-         if (cutoffMatcher.find()) {</span>
<span class="line-removed">-             body = cutoffMatcher.group(1);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         var commentMatcher = commentPattern.matcher(body);</span>
<span class="line-removed">-         body = commentMatcher.replaceAll(&quot;&quot;);</span>
<span class="line-removed">- </span>
<span class="line-removed">-         return body.strip();</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private String formatCommit(Commit commit) {</span>
<span class="line-removed">-         var ret = new StringBuilder();</span>
<span class="line-removed">-         var message = commit.message();</span>
<span class="line-removed">-         if (message.size() == 0) {</span>
<span class="line-removed">-             ret.append(&quot;&lt;no commit message found&gt;&quot;);</span>
<span class="line-removed">-         } else {</span>
<span class="line-removed">-             var abbrev = commit.hash().abbreviate();</span>
<span class="line-removed">-             var filler = &quot;\t&quot;.repeat(((abbrev.length() + 4 /* additional spacing */) / 8 /* tab size */) + 1 /* rounding */);</span>
<span class="line-removed">-             ret.append(&quot; - &quot;).append(abbrev).append(&quot;:\t&quot;).append(message.get(0).strip());</span>
<span class="line-removed">-             message.stream()</span>
<span class="line-removed">-                    .skip(1)</span>
<span class="line-removed">-                    .map(String::strip)</span>
<span class="line-removed">-                    .filter(Predicate.not(String::isEmpty))</span>
<span class="line-removed">-                    .forEach(line -&gt; ret.append(&quot;\n&quot;).append(filler).append(&quot;\t&quot;).append(line));</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         return ret.toString();</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private static final String infoSeparator = &quot;----------------&quot;;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private String composeConversation(String body, PullRequestInstance prInstance, URI webrev) {</span>
<span class="line-removed">-         var commitMessages = prInstance.formatCommitMessages(prInstance.baseHash(), prInstance.headHash(), this::formatCommit);</span>
<span class="line-removed">-         var filteredBody = filterComments(body);</span>
<span class="line-removed">-         if (filteredBody.isEmpty()) {</span>
<span class="line-removed">-             filteredBody = pr.getTitle().strip();</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         return filteredBody + &quot;\n\n&quot; +</span>
<span class="line-removed">-                 infoSeparator + &quot;\n\n&quot; +</span>
<span class="line-removed">-                 &quot;Commits:\n&quot; +</span>
<span class="line-removed">-                 commitMessages + &quot;\n\n&quot; +</span>
<span class="line-removed">-                 &quot;Pull request:\n&quot; +</span>
<span class="line-removed">-                 pr.getWebUrl() + &quot;\n\n&quot; +</span>
<span class="line-removed">-                 &quot;Webrev:\n&quot; +</span>
<span class="line-removed">-                 webrev.toString() + &quot;\n\n&quot; +</span>
<span class="line-removed">-                 &quot;Patch:\n&quot; +</span>
<span class="line-removed">-                 prInstance.diffUrl() + &quot;\n\n&quot; +</span>
<span class="line-removed">-                 &quot;Fetch command:\n&quot; +</span>
<span class="line-removed">-                 prInstance.fetchCommand();</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private String composeReply(ZonedDateTime date, EmailAddress author, String parentBody, String body) {</span>
<span class="line-removed">-         return &quot;On &quot; + date.format(DateTimeFormatter.RFC_1123_DATE_TIME) + &quot;, &quot; + author.toString() + &quot; wrote:\n&quot; +</span>
<span class="line-removed">-                 &quot;\n&quot; +</span>
<span class="line-removed">-                 quoteBody(parentBody) +</span>
<span class="line-removed">-                 &quot;\n\n&quot; +</span>
<span class="line-removed">-                 filterComments(body) +</span>
<span class="line-removed">-                 &quot;\n\n&quot; +</span>
<span class="line-removed">-                 &quot;PR: &quot; + pr.getWebUrl();</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private String verdictToString(Review.Verdict verdict) {</span>
<span class="line-removed">-         switch (verdict) {</span>
<span class="line-removed">-             case APPROVED:</span>
<span class="line-removed">-                 return &quot;changes are approved&quot;;</span>
<span class="line-removed">-             case DISAPPROVED:</span>
<span class="line-removed">-                 return &quot;more changes are needed&quot;;</span>
<span class="line-removed">-             case NONE:</span>
<span class="line-removed">-                 return &quot;a comment has been added&quot;;</span>
<span class="line-removed">-             default:</span>
<span class="line-removed">-                 throw new RuntimeException(&quot;Unknown verdict: &quot; + verdict);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private String composeReview(ZonedDateTime date, EmailAddress parentAuthor, String parentBody, Review review) {</span>
<span class="line-removed">-         var body = new StringBuilder();</span>
<span class="line-removed">-         var author = getAuthorAddress(review.reviewer());</span>
<span class="line-removed">-         body.append(&quot;This PR has been reviewed by &quot;);</span>
<span class="line-removed">-         body.append(author.fullName().orElse(author.localPart()));</span>
<span class="line-removed">-         body.append(&quot; - &quot;);</span>
<span class="line-removed">-         body.append(verdictToString(review.verdict()));</span>
<span class="line-removed">-         body.append(&quot;.&quot;);</span>
<span class="line-removed">-         if (review.body().isPresent()) {</span>
<span class="line-removed">-             body.append(&quot; Review comment:\n\n&quot;);</span>
<span class="line-removed">-             body.append(review.body().get());</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         return &quot;On &quot; + date.format(DateTimeFormatter.RFC_1123_DATE_TIME) + &quot;, &quot; + parentAuthor.toString() + &quot; wrote:\n&quot; +</span>
<span class="line-removed">-                 &quot;\n&quot; +</span>
<span class="line-removed">-                 quoteBody(parentBody) +</span>
<span class="line-removed">-                 &quot;\n\n&quot; +</span>
<span class="line-removed">-                 filterComments(body.toString()) +</span>
<span class="line-removed">-                 &quot;\n\n&quot; +</span>
<span class="line-removed">-                 &quot;PR: &quot; + pr.getWebUrl();</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private String composeRebaseComment(Hash lastBase, PullRequestInstance prInstance, URI fullWebrev) {</span>
<span class="line-removed">-         var commitMessages = prInstance.formatCommitMessages(prInstance.baseHash(), prInstance.headHash(), this::formatCommit);</span>
<span class="line-removed">-         return &quot;The pull request has been updated with a complete new set of changes (possibly due to a rebase).\n\n&quot; +</span>
<span class="line-removed">-                 infoSeparator + &quot;\n\n&quot; +</span>
<span class="line-removed">-                 &quot;Commits:\n&quot; +</span>
<span class="line-removed">-                 commitMessages + &quot;\n\n&quot; +</span>
<span class="line-removed">-                 &quot;Pull request:\n&quot; +</span>
<span class="line-removed">-                 pr.getWebUrl() + &quot;\n\n&quot; +</span>
<span class="line-removed">-                 &quot;Webrev:\n&quot; +</span>
<span class="line-removed">-                 fullWebrev.toString() + &quot;\n\n&quot; +</span>
<span class="line-removed">-                 &quot;Updated full patch:\n&quot; +</span>
<span class="line-removed">-                 prInstance.diffUrl() + &quot;\n\n&quot; +</span>
<span class="line-removed">-                 &quot;Fetch command:\n&quot; +</span>
<span class="line-removed">-                 prInstance.fetchCommand();</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private String composeIncrementalComment(Hash lastHead, PullRequestInstance prInstance, URI fullWebrev, URI incrementalWebrev) {</span>
<span class="line-removed">-         var newCommitMessages = prInstance.formatCommitMessages(lastHead, prInstance.headHash(), this::formatCommit);</span>
<span class="line-removed">-         return &quot;The pull request has been updated with additional changes.\n\n&quot; +</span>
<span class="line-removed">-                 infoSeparator + &quot;\n\n&quot; +</span>
<span class="line-removed">-                 &quot;Added commits:\n&quot; +</span>
<span class="line-removed">-                 newCommitMessages + &quot;\n\n&quot; +</span>
<span class="line-removed">-                 &quot;Pull request:\n&quot; +</span>
<span class="line-removed">-                 pr.getWebUrl() + &quot;\n\n&quot; +</span>
<span class="line-removed">-                 &quot;Webrevs:\n&quot; +</span>
<span class="line-removed">-                 &quot; - full: &quot; + fullWebrev.toString() + &quot;\n&quot; +</span>
<span class="line-removed">-                 &quot; - inc: &quot; + incrementalWebrev.toString() + &quot;\n\n&quot; +</span>
<span class="line-removed">-                 &quot;Updated full patch:\n&quot; +</span>
<span class="line-removed">-                 prInstance.diffUrl() + &quot;\n\n&quot; +</span>
<span class="line-removed">-                 &quot;Fetch command:\n&quot; +</span>
<span class="line-removed">-                 prInstance.fetchCommand();</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private String composeReadyForIntegrationComment() {</span>
<span class="line-removed">-         return &quot;This PR now fulfills all the requirements for integration, and is only awaiting the final &quot; +</span>
<span class="line-removed">-                 &quot;integration command from the author.&quot; +</span>
<span class="line-removed">-                 &quot;\n\n&quot; +</span>
<span class="line-removed">-                 &quot;PR: &quot; + pr.getWebUrl();</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
      private Repository materializeArchive(Path scratchPath) {
          try {
              return Repository.materialize(scratchPath, bot.archiveRepo().getUrl(), pr.getTargetRef());
          } catch (IOException e) {
              throw new UncheckedIOException(e);
<span class="line-new-header">--- 105,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 277,238 ***</span>
          }
          var commandMatcher = commandPattern.matcher(body);
          if (commandMatcher.matches()) {
              return true;
          }
<span class="line-modified">!         return false;</span>
<span class="line-modified">!     }</span>
<span class="line-modified">! </span>
<span class="line-modified">!     private EmailAddress getUniqueMessageId(String identifier) {</span>
<span class="line-removed">-         try {</span>
<span class="line-removed">-             var prSpecific = pr.repository().getName().replace(&quot;/&quot;, &quot;.&quot;) + &quot;.&quot; + pr.getId();</span>
<span class="line-removed">-             var digest = MessageDigest.getInstance(&quot;SHA-256&quot;);</span>
<span class="line-removed">-             digest.update(prSpecific.getBytes(StandardCharsets.UTF_8));</span>
<span class="line-removed">-             digest.update(identifier.getBytes(StandardCharsets.UTF_8));</span>
<span class="line-removed">-             var encodedCommon = Base64.getUrlEncoder().encodeToString(digest.digest());</span>
<span class="line-removed">- </span>
<span class="line-removed">-             return EmailAddress.from(encodedCommon + &quot;.&quot; + UUID.randomUUID() + &quot;@&quot; + pr.repository().getUrl().getHost());</span>
<span class="line-removed">-         } catch (NoSuchAlgorithmException e) {</span>
<span class="line-removed">-             throw new RuntimeException(&quot;Cannot find SHA-256&quot;);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private String getStableMessageId(EmailAddress uniqueMessageId) {</span>
<span class="line-removed">-         return uniqueMessageId.localPart().split(&quot;\\.&quot;)[0];</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private EmailAddress getMessageId() {</span>
<span class="line-removed">-         return getUniqueMessageId(&quot;fc&quot;);</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private EmailAddress getMessageId(Comment comment) {</span>
<span class="line-removed">-         return getUniqueMessageId(&quot;pc&quot; + comment.id());</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private EmailAddress getMessageId(ReviewComment comment) {</span>
<span class="line-removed">-         return getUniqueMessageId(&quot;rc&quot; + comment.id());</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private EmailAddress getMessageId(Hash hash) {</span>
<span class="line-removed">-         return getUniqueMessageId(&quot;ha&quot; + hash.hex());</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private EmailAddress getMessageId(String raw) {</span>
<span class="line-removed">-         return getUniqueMessageId(&quot;rw&quot; + raw);</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private EmailAddress getMessageId(Review review) {</span>
<span class="line-removed">-         return getUniqueMessageId(&quot;rv&quot; + review.id());</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private EmailAddress getAuthorAddress(HostUserDetails originalAuthor) {</span>
<span class="line-removed">-         return EmailAddress.from(originalAuthor.fullName() + &quot; via &quot; + pr.repository().getUrl().getHost(),</span>
<span class="line-removed">-                                  bot.emailAddress().address());</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private Email newConversation(PullRequestInstance prInstance, URI webrev) {</span>
<span class="line-removed">-         var body = composeConversation(pr.getBody(), prInstance, webrev);</span>
<span class="line-removed">-         var email = Email.create(getAuthorAddress(pr.getAuthor()), &quot;RFR: &quot; + pr.getTitle(), body)</span>
<span class="line-removed">-                          .sender(bot.emailAddress())</span>
<span class="line-removed">-                          .id(getMessageId())</span>
<span class="line-removed">-                          .header(&quot;PR-Head-Hash&quot;, prInstance.headHash().hex())</span>
<span class="line-removed">-                          .header(&quot;PR-Base-Hash&quot;, prInstance.baseHash().hex())</span>
<span class="line-removed">-                          .build();</span>
<span class="line-removed">-         return email;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">- </span>
<span class="line-removed">-     private Email comment(Email parent, Comment comment) {</span>
<span class="line-removed">-         var reply = composeReply(parent.date(), parent.author(), parent.body(), comment.body());</span>
<span class="line-removed">-         var references = parent.id().toString();</span>
<span class="line-removed">-         if (parent.hasHeader(&quot;References&quot;)) {</span>
<span class="line-removed">-             references = parent.headerValue(&quot;References&quot;) + &quot; &quot; + references;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         var email = Email.create(getAuthorAddress(comment.author()), &quot;Re: RFR: &quot; + pr.getTitle(), reply)</span>
<span class="line-removed">-                          .sender(bot.emailAddress())</span>
<span class="line-removed">-                          .recipient(parent.author())</span>
<span class="line-removed">-                          .id(getMessageId(comment))</span>
<span class="line-removed">-                          .header(&quot;In-Reply-To&quot;, parent.id().toString())</span>
<span class="line-removed">-                          .header(&quot;References&quot;, references)</span>
<span class="line-removed">-                          .build();</span>
<span class="line-removed">-         return email;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private Email review(Email parent, Review review) {</span>
<span class="line-removed">-         var body = composeReview(parent.date(), parent.author(), parent.body(), review);</span>
<span class="line-removed">-         var email = Email.create(getAuthorAddress(review.reviewer()), &quot;Re: RFR: &quot; + pr.getTitle(), body)</span>
<span class="line-removed">-                          .sender(bot.emailAddress())</span>
<span class="line-removed">-                          .recipient(parent.author())</span>
<span class="line-removed">-                          .id(getMessageId(review))</span>
<span class="line-removed">-                          .header(&quot;In-Reply-To&quot;, parent.id().toString())</span>
<span class="line-removed">-                          .header(&quot;References&quot;, parent.id().toString())</span>
<span class="line-removed">-                          .build();</span>
<span class="line-removed">-         return email;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private Email reviewComment(Email parent, ReviewComment comment) {</span>
<span class="line-removed">-         var body = new StringBuilder();</span>
<span class="line-removed">- </span>
<span class="line-removed">-         // Add some context to the first post</span>
<span class="line-removed">-         if (comment.parent().isEmpty()) {</span>
<span class="line-removed">-             var contents = pr.repository().getFileContents(comment.path(), comment.hash().hex()).lines().collect(Collectors.toList());</span>
<span class="line-removed">- </span>
<span class="line-removed">-             body.append(comment.path()).append(&quot; line &quot;).append(comment.line()).append(&quot;:\n\n&quot;);</span>
<span class="line-removed">-             for (int i = Math.max(0, comment.line() - 2); i &lt; Math.min(contents.size(), comment.line() + 1); ++i) {</span>
<span class="line-removed">-                 body.append(&quot;&gt; &quot;).append(i + 1).append(&quot;: &quot;).append(contents.get(i)).append(&quot;\n&quot;);</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-             body.append(&quot;\n&quot;);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         body.append(comment.body());</span>
<span class="line-removed">- </span>
<span class="line-removed">-         var reply = composeReply(parent.date(), parent.author(), parent.body(), body.toString());</span>
<span class="line-removed">-         var references = parent.id().toString();</span>
<span class="line-removed">-         if (parent.hasHeader(&quot;References&quot;)) {</span>
<span class="line-removed">-             references = parent.headerValue(&quot;References&quot;) + &quot; &quot; + references;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         var email = Email.create(getAuthorAddress(comment.author()), &quot;Re: RFR: &quot; + pr.getTitle(), reply)</span>
<span class="line-removed">-                          .sender(bot.emailAddress())</span>
<span class="line-removed">-                          .recipient(parent.author())</span>
<span class="line-removed">-                          .id(getMessageId(comment))</span>
<span class="line-removed">-                          .header(&quot;In-Reply-To&quot;, parent.id().toString())</span>
<span class="line-removed">-                          .header(&quot;References&quot;, references)</span>
<span class="line-removed">-                          .build();</span>
<span class="line-removed">-         return email;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private Email rebaseComment(Email parent, Hash lastBase, PullRequestInstance prInstance, URI fullWebrev) {</span>
<span class="line-removed">-         var body = composeRebaseComment(lastBase, prInstance, fullWebrev);</span>
<span class="line-removed">-         var email = Email.create(getAuthorAddress(pr.getAuthor()), &quot;Re: RFR: &quot; + pr.getTitle(), body)</span>
<span class="line-removed">-                          .sender(bot.emailAddress())</span>
<span class="line-removed">-                          .recipient(parent.author())</span>
<span class="line-removed">-                          .id(getMessageId(prInstance.headHash()))</span>
<span class="line-removed">-                          .header(&quot;In-Reply-To&quot;, parent.id().toString())</span>
<span class="line-removed">-                          .header(&quot;References&quot;, parent.id().toString())</span>
<span class="line-removed">-                          .header(&quot;PR-Head-Hash&quot;, prInstance.headHash().hex())</span>
<span class="line-removed">-                          .header(&quot;PR-Base-Hash&quot;, prInstance.baseHash().hex())</span>
<span class="line-removed">-                          .build();</span>
<span class="line-removed">-         return email;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private Email incrementalComment(Email parent, Hash lastHead, PullRequestInstance prInstance, URI fullWebrev, URI incrementalWebrev) {</span>
<span class="line-removed">-         var body = composeIncrementalComment(lastHead, prInstance, fullWebrev, incrementalWebrev);</span>
<span class="line-removed">-         var email = Email.create(getAuthorAddress(pr.getAuthor()), &quot;Re: RFR: &quot; + pr.getTitle(), body)</span>
<span class="line-removed">-                          .sender(bot.emailAddress())</span>
<span class="line-removed">-                          .recipient(parent.author())</span>
<span class="line-removed">-                          .id(getMessageId(prInstance.headHash()))</span>
<span class="line-removed">-                          .header(&quot;In-Reply-To&quot;, parent.id().toString())</span>
<span class="line-removed">-                          .header(&quot;References&quot;, parent.id().toString())</span>
<span class="line-removed">-                          .header(&quot;PR-Head-Hash&quot;, prInstance.headHash().hex())</span>
<span class="line-removed">-                          .header(&quot;PR-Base-Hash&quot;, prInstance.baseHash().hex())</span>
<span class="line-removed">-                          .build();</span>
<span class="line-removed">-         return email;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private Email readyForIntegrationComment(Email parent, Set&lt;String&gt; currentLabels, int numLabelComments) {</span>
<span class="line-removed">-         var body = composeReadyForIntegrationComment();</span>
<span class="line-removed">-         var email = Email.create(getAuthorAddress(pr.getAuthor()), &quot;Re: RFR: &quot; + pr.getTitle(), body)</span>
<span class="line-removed">-                          .sender(bot.emailAddress())</span>
<span class="line-removed">-                          .recipient(parent.author())</span>
<span class="line-removed">-                          .id(getMessageId(&quot;labelcomment&quot; + numLabelComments))</span>
<span class="line-removed">-                          .header(&quot;In-Reply-To&quot;, parent.id().toString())</span>
<span class="line-removed">-                          .header(&quot;References&quot;, parent.id().toString())</span>
<span class="line-removed">-                          .header(&quot;PR-Labels&quot;, String.join(&quot;;&quot;, currentLabels))</span>
<span class="line-removed">-                          .build();</span>
<span class="line-removed">-         return email;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private List&lt;Email&gt; parseArchive(MailingList archive) {</span>
<span class="line-removed">-         var conversations = archive.conversations(Duration.ofDays(365));</span>
<span class="line-removed">- </span>
<span class="line-removed">-         if (conversations.size() == 0) {</span>
<span class="line-removed">-             return new ArrayList&lt;&gt;();</span>
<span class="line-removed">-         } else if (conversations.size() == 1) {</span>
<span class="line-removed">-             var conversation = conversations.get(0);</span>
<span class="line-removed">-             return conversation.allMessages();</span>
<span class="line-removed">-         } else {</span>
<span class="line-removed">-             throw new RuntimeException(&quot;Something is wrong with the mbox&quot;);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private Map&lt;Email, Email&gt; findParents(Map&lt;EmailAddress, Email&gt; emailIds) {</span>
<span class="line-removed">-         var parents = new HashMap&lt;Email, Email&gt;();</span>
<span class="line-removed">-         for (var entry : emailIds.entrySet()) {</span>
<span class="line-removed">-             if (entry.getValue().hasHeader(&quot;In-Reply-To&quot;)) {</span>
<span class="line-removed">-                 var replyId = EmailAddress.parse(entry.getValue().headerValue(&quot;In-Reply-To&quot;));</span>
              }
          }
<span class="line-modified">!         return parents;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private final Pattern replyHeaderPattern = Pattern.compile(&quot;^On .* &lt;(.*)&gt; wrote:$.*&quot;,</span>
<span class="line-removed">-                                                                Pattern.DOTALL | Pattern.MULTILINE);</span>
<span class="line-removed">- </span>
<span class="line-removed">-     // Combine mails from the same author, directed at the same person, into a single mail</span>
<span class="line-removed">-     private List&lt;Email&gt; combineMails(List&lt;Email&gt; emails) {</span>
<span class="line-removed">-         var byAuthor = emails.stream().collect(Collectors.groupingBy(Email::author));</span>
<span class="line-removed">-         var ret = new ArrayList&lt;Email&gt;();</span>
<span class="line-removed">-         for (var authorMails : byAuthor.entrySet()) {</span>
<span class="line-removed">-             var byTarget = authorMails.getValue().stream()</span>
<span class="line-removed">-                                       .collect(Collectors.groupingBy(email -&gt; {</span>
<span class="line-removed">-                                           var matcher = replyHeaderPattern.matcher(email.body());</span>
<span class="line-removed">-                                           if (matcher.matches()) {</span>
<span class="line-removed">-                                               return matcher.group(1);</span>
<span class="line-removed">-                                           } else {</span>
<span class="line-removed">-                                               // No grouping of undirected messages</span>
<span class="line-removed">-                                               return &quot;&quot;;</span>
<span class="line-removed">-                                           }</span>
<span class="line-removed">-                                       }));</span>
<span class="line-removed">- </span>
<span class="line-removed">-             for (var targetMails : byTarget.entrySet()) {</span>
<span class="line-removed">-                 if (!targetMails.getKey().isEmpty()) {</span>
<span class="line-removed">-                     var first = targetMails.getValue().get(0);</span>
<span class="line-removed">-                     var body = new StringBuilder(first.body());</span>
<span class="line-removed">-                     for (int i = 1; i &lt; targetMails.getValue().size(); ++i) {</span>
<span class="line-removed">-                         var addon = targetMails.getValue().get(i).body().lines()</span>
<span class="line-removed">-                                                .skip(2)</span>
<span class="line-removed">-                                                .dropWhile(line -&gt; line.startsWith(&quot;&gt;&quot;))</span>
<span class="line-removed">-                                                .skip(1)</span>
<span class="line-removed">-                                                .collect(Collectors.joining(&quot;\n&quot;));</span>
<span class="line-removed">-                         body.append(&quot;\n\n&quot;).append(addon);</span>
<span class="line-removed">-                     }</span>
<span class="line-removed">-                     var combined = Email.from(first).body(body.toString()).build();</span>
<span class="line-removed">-                     ret.add(combined);</span>
<span class="line-removed">- </span>
<span class="line-removed">-                 } else {</span>
<span class="line-removed">-                     ret.addAll(targetMails.getValue());</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         return ret;</span>
      }
  
      private static final String webrevCommentMarker = &quot;&lt;!-- mlbridge webrev comment --&gt;&quot;;
      private static final String webrevHeaderMarker = &quot;&lt;!-- mlbridge webrev header --&gt;&quot;;
      private static final String webrevListMarker = &quot;&lt;!-- mlbridge webrev list --&gt;&quot;;
<span class="line-new-header">--- 126,17 ---</span>
          }
          var commandMatcher = commandPattern.matcher(body);
          if (commandMatcher.matches()) {
              return true;
          }
<span class="line-modified">!         for (var ignoredCommentPattern : bot.ignoredComments()) {</span>
<span class="line-modified">!             var ignoredCommentMatcher = ignoredCommentPattern.matcher(body);</span>
<span class="line-modified">!             if (ignoredCommentMatcher.find()) {</span>
<span class="line-modified">!                 return true;</span>
              }
          }
<span class="line-modified">!         return false;</span>
      }
  
      private static final String webrevCommentMarker = &quot;&lt;!-- mlbridge webrev comment --&gt;&quot;;
      private static final String webrevHeaderMarker = &quot;&lt;!-- mlbridge webrev header --&gt;&quot;;
      private static final String webrevListMarker = &quot;&lt;!-- mlbridge webrev list --&gt;&quot;;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 540,21 ***</span>
          } else {
              pr.addComment(comment);
          }
      }
  
      @Override
      public void run(Path scratchPath) {
          var path = scratchPath.resolve(&quot;mlbridge&quot;);
          var archiveRepo = materializeArchive(path);
          var mboxBasePath = path.resolve(bot.codeRepo().getName());
          var mbox = MailingListServerFactory.createMboxFileServer(mboxBasePath);
<span class="line-modified">!         var archive = mbox.getList(pr.getId());</span>
<span class="line-modified">!         var archiveMails = parseArchive(archive);</span>
  
          // First determine if this PR should be inspected further or not
<span class="line-modified">!         if (archiveMails.isEmpty()) {</span>
              var labels = new HashSet&lt;&gt;(pr.getLabels());
              for (var readyLabel : bot.readyLabels()) {
                  if (!labels.contains(readyLabel)) {
                      log.fine(&quot;PR is not yet ready - missing label &#39;&quot; + readyLabel + &quot;&#39;&quot;);
                      return;
<span class="line-new-header">--- 168,34 ---</span>
          } else {
              pr.addComment(comment);
          }
      }
  
<span class="line-added">+     private List&lt;Email&gt; parseArchive(MailingList archive) {</span>
<span class="line-added">+         var conversations = archive.conversations(Duration.ofDays(365));</span>
<span class="line-added">+ </span>
<span class="line-added">+         if (conversations.size() == 0) {</span>
<span class="line-added">+             return new ArrayList&lt;&gt;();</span>
<span class="line-added">+         } else if (conversations.size() == 1) {</span>
<span class="line-added">+             var conversation = conversations.get(0);</span>
<span class="line-added">+             return conversation.allMessages();</span>
<span class="line-added">+         } else {</span>
<span class="line-added">+             throw new RuntimeException(&quot;Something is wrong with the mbox&quot;);</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      @Override
      public void run(Path scratchPath) {
          var path = scratchPath.resolve(&quot;mlbridge&quot;);
          var archiveRepo = materializeArchive(path);
          var mboxBasePath = path.resolve(bot.codeRepo().getName());
          var mbox = MailingListServerFactory.createMboxFileServer(mboxBasePath);
<span class="line-modified">!         var reviewArchiveList = mbox.getList(pr.getId());</span>
<span class="line-modified">!         var sentMails = parseArchive(reviewArchiveList);</span>
  
          // First determine if this PR should be inspected further or not
<span class="line-modified">!         if (sentMails.isEmpty()) {</span>
              var labels = new HashSet&lt;&gt;(pr.getLabels());
              for (var readyLabel : bot.readyLabels()) {
                  if (!labels.contains(readyLabel)) {
                      log.fine(&quot;PR is not yet ready - missing label &#39;&quot; + readyLabel + &quot;&#39;&quot;);
                      return;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 562,11 ***</span>
              }
          }
  
          // Also inspect comments before making the first post
          var comments = pr.getComments();
<span class="line-modified">!         if (archiveMails.isEmpty()) {</span>
              for (var readyComment : bot.readyComments().entrySet()) {
                  var commentFound = false;
                  for (var comment : comments) {
                      if (comment.author().userName().equals(readyComment.getKey())) {
                          var matcher = readyComment.getValue().matcher(comment.body());
<span class="line-new-header">--- 203,11 ---</span>
              }
          }
  
          // Also inspect comments before making the first post
          var comments = pr.getComments();
<span class="line-modified">!         if (sentMails.isEmpty()) {</span>
              for (var readyComment : bot.readyComments().entrySet()) {
                  var commentFound = false;
                  for (var comment : comments) {
                      if (comment.author().userName().equals(readyComment.getKey())) {
                          var matcher = readyComment.getValue().matcher(comment.body());
</pre>
<hr />
<pre>
<span class="line-old-header">*** 582,145 ***</span>
                      return;
                  }
              }
          }
  
          var webrevPath = scratchPath.resolve(&quot;mlbridge-webrevs&quot;);
          var listServer = MailingListServerFactory.createMailmanServer(bot.listArchive(), bot.smtpServer());
          var list = listServer.getList(bot.listAddress().address());
<span class="line-removed">-         var newMails = new ArrayList&lt;Email&gt;();</span>
<span class="line-removed">-         var stableIdToMail = archiveMails.stream().collect(Collectors.toMap(email -&gt; getStableMessageId(email.id()),</span>
<span class="line-removed">-                                                                             Function.identity()));</span>
<span class="line-removed">-         var prInstance = new PullRequestInstance(scratchPath.resolve(&quot;mlbridge-mergebase&quot;), pr);</span>
  
          // First post
<span class="line-modified">!         if (archiveMails.isEmpty()) {</span>
              var webrev = bot.webrevStorage().createAndArchive(prInstance, webrevPath, prInstance.baseHash(),
                                                                prInstance.headHash(), &quot;00&quot;);
<span class="line-modified">!             var firstMail = newConversation(prInstance, webrev);</span>
<span class="line-removed">-             archive.post(firstMail);</span>
<span class="line-removed">-             newMails.add(firstMail);</span>
<span class="line-removed">-             stableIdToMail.put(getStableMessageId(firstMail.id()), firstMail);</span>
              updateWebrevComment(comments, 0, webrev, null);
<span class="line-removed">-             log.fine(&quot;Posting new PR conversation&quot;);</span>
          } else {
<span class="line-modified">!             // Determine the latest head hash reported</span>
<span class="line-removed">-             var reportedHeads = archiveMails.stream()</span>
<span class="line-removed">-                                             .filter(email -&gt; email.hasHeader(&quot;PR-Head-Hash&quot;))</span>
<span class="line-removed">-                                             .map(email -&gt; email.headerValue(&quot;PR-Head-Hash&quot;))</span>
<span class="line-removed">-                                             .map(Hash::new)</span>
<span class="line-removed">-                                             .collect(Collectors.toList());</span>
<span class="line-removed">-             var latestHead = reportedHeads.size() &gt; 0 ? reportedHeads.get(reportedHeads.size() - 1) : pr.getHeadHash();</span>
  
              // Check if the head has changed
              if (!pr.getHeadHash().equals(latestHead)) {
<span class="line-modified">!                 log.fine(&quot;Head hash change detected: current: &quot; + pr.getHeadHash() + &quot; - existing: &quot; + reportedHeads);</span>
<span class="line-modified">! </span>
<span class="line-modified">!                 // Determine the latest base hash reported</span>
<span class="line-removed">-                 var reportedBases = archiveMails.stream()</span>
<span class="line-removed">-                                                 .filter(email -&gt; email.hasHeader(&quot;PR-Base-Hash&quot;))</span>
<span class="line-removed">-                                                 .map(email -&gt; email.headerValue(&quot;PR-Base-Hash&quot;))</span>
<span class="line-removed">-                                                 .map(Hash::new)</span>
<span class="line-removed">-                                                 .collect(Collectors.toList());</span>
<span class="line-removed">-                 if (reportedBases.size() == 0) {</span>
<span class="line-removed">-                     throw new RuntimeException(&quot;No previous bases found?&quot;);</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-                 var latestBase = reportedBases.get(reportedBases.size() - 1);</span>
<span class="line-removed">-                 var firstMail = archiveMails.get(0);</span>
<span class="line-removed">-                 Email commentMail;</span>
                  if (!prInstance.baseHash().equals(latestBase)) {
                      var fullWebrev = bot.webrevStorage().createAndArchive(prInstance, webrevPath, prInstance.baseHash(),
<span class="line-modified">!                                                                           prInstance.headHash(), String.format(&quot;%02d&quot;, reportedHeads.size()));</span>
<span class="line-modified">!                     commentMail = rebaseComment(firstMail, latestBase, prInstance, fullWebrev);</span>
<span class="line-modified">!                     updateWebrevComment(comments, reportedHeads.size(), fullWebrev, null);</span>
                  } else {
<span class="line-modified">!                     var index = reportedHeads.size();</span>
                      var fullWebrev = bot.webrevStorage().createAndArchive(prInstance, webrevPath, prInstance.baseHash(),
                                                                            prInstance.headHash(), String.format(&quot;%02d&quot;, index));
                      var incrementalWebrev = bot.webrevStorage().createAndArchive(prInstance, webrevPath, latestHead,
                                                                                   prInstance.headHash(), String.format(&quot;%02d-%02d&quot;, index - 1, index));
<span class="line-modified">!                     commentMail = incrementalComment(firstMail, latestHead, prInstance, fullWebrev, incrementalWebrev);</span>
                      updateWebrevComment(comments, index, fullWebrev, incrementalWebrev);
                  }
<span class="line-removed">-                 archive.post(commentMail);</span>
<span class="line-removed">-                 newMails.add(commentMail);</span>
<span class="line-removed">-                 stableIdToMail.put(getStableMessageId(commentMail.id()), commentMail);</span>
              }
          }
  
          // Regular comments
<span class="line-removed">-         var previous = archiveMails.size() &gt; 0 ? archiveMails.get(0) : newMails.get(0);</span>
          for (var comment : comments) {
<span class="line-removed">-             var id = getStableMessageId(getMessageId(comment));</span>
<span class="line-removed">-             if (stableIdToMail.containsKey(id)) {</span>
<span class="line-removed">-                 previous = stableIdToMail.get(id);</span>
<span class="line-removed">-                 continue;</span>
<span class="line-removed">-             }</span>
              if (ignoreComment(comment.author(), comment.body())) {
                  continue;
              }
<span class="line-modified">! </span>
<span class="line-removed">-             // Try to determine a parent post from @mentions</span>
<span class="line-removed">-             var parentComment = getParentPost(comment, comments);</span>
<span class="line-removed">-             var parent = parentComment.map(c -&gt; stableIdToMail.get(getStableMessageId(getMessageId(c)))).orElse(previous);</span>
<span class="line-removed">- </span>
<span class="line-removed">-             var commentMail = comment(parent, comment);</span>
<span class="line-removed">-             archive.post(commentMail);</span>
<span class="line-removed">-             newMails.add(commentMail);</span>
<span class="line-removed">-             stableIdToMail.put(getStableMessageId(commentMail.id()), commentMail);</span>
<span class="line-removed">-             previous = commentMail;</span>
          }
  
          // Review comments
<span class="line-removed">-         final var first = archiveMails.size() &gt; 0 ? archiveMails.get(0) : newMails.get(0);</span>
          var reviews = pr.getReviews();
          for (var review : reviews) {
<span class="line-removed">-             var id = getStableMessageId(getMessageId(review));</span>
<span class="line-removed">-             if (stableIdToMail.containsKey(id)) {</span>
<span class="line-removed">-                 continue;</span>
<span class="line-removed">-             }</span>
              if (ignoreComment(review.reviewer(), review.body().orElse(&quot;&quot;))) {
                  continue;
              }
<span class="line-modified">! </span>
<span class="line-removed">-             var commentMail = review(first, review);</span>
<span class="line-removed">-             archive.post(commentMail);</span>
<span class="line-removed">-             newMails.add(commentMail);</span>
<span class="line-removed">-             stableIdToMail.put(getStableMessageId(commentMail.id()), commentMail);</span>
          }
  
<span class="line-removed">- </span>
          // File specific comments
          var reviewComments = pr.getReviewComments();
          for (var reviewComment : reviewComments) {
<span class="line-removed">-             var id = getStableMessageId(getMessageId(reviewComment));</span>
<span class="line-removed">-             if (stableIdToMail.containsKey(id)) {</span>
<span class="line-removed">-                 continue;</span>
<span class="line-removed">-             }</span>
              if (ignoreComment(reviewComment.author(), reviewComment.body())) {
                  continue;
              }
<span class="line-modified">! </span>
<span class="line-removed">-             var parent = reviewComment.parent().map(c -&gt; stableIdToMail.get(getStableMessageId(getMessageId(c)))).orElse(first);</span>
<span class="line-removed">-             var commentMail = reviewComment(parent, reviewComment);</span>
<span class="line-removed">-             archive.post(commentMail);</span>
<span class="line-removed">-             newMails.add(commentMail);</span>
<span class="line-removed">-             stableIdToMail.put(getStableMessageId(commentMail.id()), commentMail);</span>
          }
  
          if (newMails.isEmpty()) {
              return;
          }
  
          // Push all new mails to the archive repository
          pushMbox(archiveRepo, &quot;Adding comments for PR &quot; + bot.codeRepo().getName() + &quot;/&quot; + pr.getId());
  
<span class="line-modified">!         // Combine and post all new mails to the list</span>
<span class="line-modified">!         var listMails = combineMails(newMails);</span>
<span class="line-removed">-         for (var mail : listMails) {</span>
<span class="line-removed">-             list.post(mail);</span>
<span class="line-removed">-         }</span>
      }
  
      @Override
      public void handleRuntimeException(RuntimeException e) {
          exceptionConsumer.accept(e);
<span class="line-new-header">--- 223,88 ---</span>
                      return;
                  }
              }
          }
  
<span class="line-added">+         var census = CensusInstance.create(bot.censusRepo(), bot.censusRef(), scratchPath.resolve(&quot;census&quot;), pr);</span>
<span class="line-added">+         var prInstance = new PullRequestInstance(scratchPath.resolve(&quot;mlbridge-mergebase&quot;), pr);</span>
<span class="line-added">+         var reviewArchive = new ReviewArchive(bot.emailAddress(), prInstance, sentMails,</span>
<span class="line-added">+                                               &quot; via &quot; + pr.repository().getUrl().getHost());</span>
          var webrevPath = scratchPath.resolve(&quot;mlbridge-webrevs&quot;);
          var listServer = MailingListServerFactory.createMailmanServer(bot.listArchive(), bot.smtpServer());
          var list = listServer.getList(bot.listAddress().address());
  
          // First post
<span class="line-modified">!         if (sentMails.isEmpty()) {</span>
<span class="line-added">+             log.fine(&quot;Creating new PR review archive&quot;);</span>
              var webrev = bot.webrevStorage().createAndArchive(prInstance, webrevPath, prInstance.baseHash(),
                                                                prInstance.headHash(), &quot;00&quot;);
<span class="line-modified">!             reviewArchive.create(webrev);</span>
              updateWebrevComment(comments, 0, webrev, null);
          } else {
<span class="line-modified">!             var latestHead = reviewArchive.latestHead();</span>
  
              // Check if the head has changed
              if (!pr.getHeadHash().equals(latestHead)) {
<span class="line-modified">!                 log.fine(&quot;Head hash change detected: current: &quot; + pr.getHeadHash() + &quot; - last: &quot; + latestHead);</span>
<span class="line-modified">! </span>
<span class="line-modified">!                 var latestBase = reviewArchive.latestBase();</span>
                  if (!prInstance.baseHash().equals(latestBase)) {
<span class="line-added">+                     // FIXME: Could try harder to make an incremental</span>
                      var fullWebrev = bot.webrevStorage().createAndArchive(prInstance, webrevPath, prInstance.baseHash(),
<span class="line-modified">!                                                                           prInstance.headHash(), String.format(&quot;%02d&quot;, reviewArchive.revisionCount()));</span>
<span class="line-modified">!                     reviewArchive.addFull(fullWebrev);</span>
<span class="line-modified">!                     updateWebrevComment(comments, reviewArchive.revisionCount(), fullWebrev, null);</span>
                  } else {
<span class="line-modified">!                     var index = reviewArchive.revisionCount();</span>
                      var fullWebrev = bot.webrevStorage().createAndArchive(prInstance, webrevPath, prInstance.baseHash(),
                                                                            prInstance.headHash(), String.format(&quot;%02d&quot;, index));
                      var incrementalWebrev = bot.webrevStorage().createAndArchive(prInstance, webrevPath, latestHead,
                                                                                   prInstance.headHash(), String.format(&quot;%02d-%02d&quot;, index - 1, index));
<span class="line-modified">!                     reviewArchive.addIncremental(fullWebrev, incrementalWebrev);</span>
                      updateWebrevComment(comments, index, fullWebrev, incrementalWebrev);
                  }
              }
          }
  
          // Regular comments
          for (var comment : comments) {
              if (ignoreComment(comment.author(), comment.body())) {
                  continue;
              }
<span class="line-modified">!             reviewArchive.addComment(comment);</span>
          }
  
          // Review comments
          var reviews = pr.getReviews();
          for (var review : reviews) {
              if (ignoreComment(review.reviewer(), review.body().orElse(&quot;&quot;))) {
                  continue;
              }
<span class="line-modified">!             reviewArchive.addReview(review, census);</span>
          }
  
          // File specific comments
          var reviewComments = pr.getReviewComments();
          for (var reviewComment : reviewComments) {
              if (ignoreComment(reviewComment.author(), reviewComment.body())) {
                  continue;
              }
<span class="line-modified">!             reviewArchive.addReviewComment(reviewComment);</span>
          }
  
<span class="line-added">+         var newMails = reviewArchive.generatedEmails();</span>
          if (newMails.isEmpty()) {
              return;
          }
  
          // Push all new mails to the archive repository
<span class="line-added">+         newMails.forEach(reviewArchiveList::post);</span>
          pushMbox(archiveRepo, &quot;Adding comments for PR &quot; + bot.codeRepo().getName() + &quot;/&quot; + pr.getId());
  
<span class="line-modified">!         // Finally post all new mails to the actual list</span>
<span class="line-modified">!         newMails.forEach(list::post);</span>
      }
  
      @Override
      public void handleRuntimeException(RuntimeException e) {
          exceptionConsumer.accept(e);
</pre>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="CensusInstance.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>