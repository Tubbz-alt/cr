<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/ArchiveWorkItem.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.bots.mlbridge;
 24 
 25 import org.openjdk.skara.bot.WorkItem;
 26 import org.openjdk.skara.email.*;
 27 import org.openjdk.skara.host.*;
 28 import org.openjdk.skara.mailinglist.*;
<a name="1" id="anc1"></a><span class="line-modified"> 29 import org.openjdk.skara.vcs.*;</span>
 30 
 31 import java.io.*;
 32 import java.net.URI;
<a name="2" id="anc2"></a><span class="line-removed"> 33 import java.nio.charset.StandardCharsets;</span>
 34 import java.nio.file.Path;
<a name="3" id="anc3"></a><span class="line-modified"> 35 import java.security.*;</span>
<span class="line-removed"> 36 import java.time.*;</span>
<span class="line-removed"> 37 import java.time.format.DateTimeFormatter;</span>
 38 import java.util.*;
<a name="4" id="anc4"></a><span class="line-modified"> 39 import java.util.function.*;</span>
 40 import java.util.logging.Logger;
 41 import java.util.regex.Pattern;
<a name="5" id="anc5"></a><span class="line-removed"> 42 import java.util.stream.Collectors;</span>
 43 
 44 class ArchiveWorkItem implements WorkItem {
 45     private final PullRequest pr;
 46     private final MailingListBridgeBot bot;
 47     private final Consumer&lt;RuntimeException&gt; exceptionConsumer;
 48     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.bots.mlbridge&quot;);
 49 
 50     ArchiveWorkItem(PullRequest pr, MailingListBridgeBot bot, Consumer&lt;RuntimeException&gt; exceptionConsumer) {
 51         this.pr = pr;
 52         this.bot = bot;
 53         this.exceptionConsumer = exceptionConsumer;
 54     }
 55 
 56     @Override
 57     public String toString() {
 58         return &quot;ArchiveWorkItem@&quot; + bot.codeRepo().getName() + &quot;#&quot; + pr.getId();
 59     }
 60 
 61     @Override
 62     public boolean concurrentWith(WorkItem other) {
 63         if (!(other instanceof ArchiveWorkItem)) {
 64             return true;
 65         }
 66         ArchiveWorkItem otherItem = (ArchiveWorkItem)other;
 67         if (!pr.getId().equals(otherItem.pr.getId())) {
 68             return true;
 69         }
 70         if (!bot.codeRepo().getName().equals(otherItem.bot.codeRepo().getName())) {
 71             return true;
 72         }
 73         return false;
 74     }
 75 
 76     private void pushMbox(Repository localRepo, String message) {
 77         try {
 78             localRepo.add(localRepo.root().resolve(&quot;.&quot;));
 79             var hash = localRepo.commit(message, bot.emailAddress().fullName().orElseThrow(), bot.emailAddress().address());
 80             localRepo.push(hash, bot.archiveRepo().getUrl(), &quot;master&quot;);
 81         } catch (IOException e) {
 82             throw new UncheckedIOException(e);
 83         }
 84     }
 85 
 86     private static final Pattern replyToPattern = Pattern.compile(&quot;^\\s*@([-A-Za-z0-9]+)&quot;);
 87 
 88     private Optional&lt;Comment&gt; getParentPost(Comment post, List&lt;Comment&gt; all) {
 89         var matcher = replyToPattern.matcher(post.body());
 90         if (matcher.find()) {
 91             var replyToName = matcher.group(1);
 92             var replyToNamePattern = Pattern.compile(&quot;^&quot; + replyToName + &quot;$&quot;);
 93 
 94             var postIterator = all.listIterator();
 95             while (postIterator.hasNext()) {
 96                 var cur = postIterator.next();
 97                 if (cur == post) {
 98                     break;
 99                 }
100             }
101 
102             while (postIterator.hasPrevious()) {
103                 var cur = postIterator.previous();
104                 var userMatcher = replyToNamePattern.matcher(cur.author().userName());
105                 if (userMatcher.matches()) {
106                     return Optional.of(cur);
107                 }
108             }
109         }
110 
111         return Optional.empty();
112     }
113 
<a name="6" id="anc6"></a><span class="line-removed">114     private String quoteBody(String body) {</span>
<span class="line-removed">115         return Arrays.stream(body.strip().split(&quot;\\R&quot;))</span>
<span class="line-removed">116                      .map(line -&gt; line.length() &gt; 0 ? line.charAt(0) == &#39;&gt;&#39; ? &quot;&gt;&quot; + line : &quot;&gt; &quot; + line : &quot;&gt; &quot;)</span>
<span class="line-removed">117                      .collect(Collectors.joining(&quot;\n&quot;));</span>
<span class="line-removed">118     }</span>
<span class="line-removed">119 </span>
<span class="line-removed">120     private static final Pattern commentPattern = Pattern.compile(&quot;&lt;!--.*?--&gt;&quot;,</span>
<span class="line-removed">121                                                                   Pattern.DOTALL | Pattern.MULTILINE);</span>
<span class="line-removed">122     private static final Pattern cutoffPattern = Pattern.compile(&quot;(.*?)&lt;!-- Anything below this marker will be .*? --&gt;&quot;,</span>
<span class="line-removed">123                                                                  Pattern.DOTALL | Pattern.MULTILINE);</span>
<span class="line-removed">124     private String filterComments(String body) {</span>
<span class="line-removed">125         var cutoffMatcher = cutoffPattern.matcher(body);</span>
<span class="line-removed">126         if (cutoffMatcher.find()) {</span>
<span class="line-removed">127             body = cutoffMatcher.group(1);</span>
<span class="line-removed">128         }</span>
<span class="line-removed">129 </span>
<span class="line-removed">130         var commentMatcher = commentPattern.matcher(body);</span>
<span class="line-removed">131         body = commentMatcher.replaceAll(&quot;&quot;);</span>
<span class="line-removed">132 </span>
<span class="line-removed">133         return body.strip();</span>
<span class="line-removed">134     }</span>
<span class="line-removed">135 </span>
<span class="line-removed">136     private String formatCommit(Commit commit) {</span>
<span class="line-removed">137         var ret = new StringBuilder();</span>
<span class="line-removed">138         var message = commit.message();</span>
<span class="line-removed">139         if (message.size() == 0) {</span>
<span class="line-removed">140             ret.append(&quot;&lt;no commit message found&gt;&quot;);</span>
<span class="line-removed">141         } else {</span>
<span class="line-removed">142             var abbrev = commit.hash().abbreviate();</span>
<span class="line-removed">143             var filler = &quot;\t&quot;.repeat(((abbrev.length() + 4 /* additional spacing */) / 8 /* tab size */) + 1 /* rounding */);</span>
<span class="line-removed">144             ret.append(&quot; - &quot;).append(abbrev).append(&quot;:\t&quot;).append(message.get(0).strip());</span>
<span class="line-removed">145             message.stream()</span>
<span class="line-removed">146                    .skip(1)</span>
<span class="line-removed">147                    .map(String::strip)</span>
<span class="line-removed">148                    .filter(Predicate.not(String::isEmpty))</span>
<span class="line-removed">149                    .forEach(line -&gt; ret.append(&quot;\n&quot;).append(filler).append(&quot;\t&quot;).append(line));</span>
<span class="line-removed">150         }</span>
<span class="line-removed">151         return ret.toString();</span>
<span class="line-removed">152     }</span>
<span class="line-removed">153 </span>
<span class="line-removed">154     private static final String infoSeparator = &quot;----------------&quot;;</span>
<span class="line-removed">155 </span>
<span class="line-removed">156     private String composeConversation(String body, PullRequestInstance prInstance, URI webrev) {</span>
<span class="line-removed">157         var commitMessages = prInstance.formatCommitMessages(prInstance.baseHash(), prInstance.headHash(), this::formatCommit);</span>
<span class="line-removed">158         var filteredBody = filterComments(body);</span>
<span class="line-removed">159         if (filteredBody.isEmpty()) {</span>
<span class="line-removed">160             filteredBody = pr.getTitle().strip();</span>
<span class="line-removed">161         }</span>
<span class="line-removed">162         return filteredBody + &quot;\n\n&quot; +</span>
<span class="line-removed">163                 infoSeparator + &quot;\n\n&quot; +</span>
<span class="line-removed">164                 &quot;Commits:\n&quot; +</span>
<span class="line-removed">165                 commitMessages + &quot;\n\n&quot; +</span>
<span class="line-removed">166                 &quot;Pull request:\n&quot; +</span>
<span class="line-removed">167                 pr.getWebUrl() + &quot;\n\n&quot; +</span>
<span class="line-removed">168                 &quot;Webrev:\n&quot; +</span>
<span class="line-removed">169                 webrev.toString() + &quot;\n\n&quot; +</span>
<span class="line-removed">170                 &quot;Patch:\n&quot; +</span>
<span class="line-removed">171                 prInstance.diffUrl() + &quot;\n\n&quot; +</span>
<span class="line-removed">172                 &quot;Fetch command:\n&quot; +</span>
<span class="line-removed">173                 prInstance.fetchCommand();</span>
<span class="line-removed">174     }</span>
<span class="line-removed">175 </span>
<span class="line-removed">176     private String composeReply(ZonedDateTime date, EmailAddress author, String parentBody, String body) {</span>
<span class="line-removed">177         return &quot;On &quot; + date.format(DateTimeFormatter.RFC_1123_DATE_TIME) + &quot;, &quot; + author.toString() + &quot; wrote:\n&quot; +</span>
<span class="line-removed">178                 &quot;\n&quot; +</span>
<span class="line-removed">179                 quoteBody(parentBody) +</span>
<span class="line-removed">180                 &quot;\n\n&quot; +</span>
<span class="line-removed">181                 filterComments(body) +</span>
<span class="line-removed">182                 &quot;\n\n&quot; +</span>
<span class="line-removed">183                 &quot;PR: &quot; + pr.getWebUrl();</span>
<span class="line-removed">184     }</span>
<span class="line-removed">185 </span>
<span class="line-removed">186     private String verdictToString(Review.Verdict verdict) {</span>
<span class="line-removed">187         switch (verdict) {</span>
<span class="line-removed">188             case APPROVED:</span>
<span class="line-removed">189                 return &quot;changes are approved&quot;;</span>
<span class="line-removed">190             case DISAPPROVED:</span>
<span class="line-removed">191                 return &quot;more changes are needed&quot;;</span>
<span class="line-removed">192             case NONE:</span>
<span class="line-removed">193                 return &quot;a comment has been added&quot;;</span>
<span class="line-removed">194             default:</span>
<span class="line-removed">195                 throw new RuntimeException(&quot;Unknown verdict: &quot; + verdict);</span>
<span class="line-removed">196         }</span>
<span class="line-removed">197     }</span>
<span class="line-removed">198 </span>
<span class="line-removed">199     private String composeReview(ZonedDateTime date, EmailAddress parentAuthor, String parentBody, Review review) {</span>
<span class="line-removed">200         var body = new StringBuilder();</span>
<span class="line-removed">201         var author = getAuthorAddress(review.reviewer());</span>
<span class="line-removed">202         body.append(&quot;This PR has been reviewed by &quot;);</span>
<span class="line-removed">203         body.append(author.fullName().orElse(author.localPart()));</span>
<span class="line-removed">204         body.append(&quot; - &quot;);</span>
<span class="line-removed">205         body.append(verdictToString(review.verdict()));</span>
<span class="line-removed">206         body.append(&quot;.&quot;);</span>
<span class="line-removed">207         if (review.body().isPresent()) {</span>
<span class="line-removed">208             body.append(&quot; Review comment:\n\n&quot;);</span>
<span class="line-removed">209             body.append(review.body().get());</span>
<span class="line-removed">210         }</span>
<span class="line-removed">211 </span>
<span class="line-removed">212         return &quot;On &quot; + date.format(DateTimeFormatter.RFC_1123_DATE_TIME) + &quot;, &quot; + parentAuthor.toString() + &quot; wrote:\n&quot; +</span>
<span class="line-removed">213                 &quot;\n&quot; +</span>
<span class="line-removed">214                 quoteBody(parentBody) +</span>
<span class="line-removed">215                 &quot;\n\n&quot; +</span>
<span class="line-removed">216                 filterComments(body.toString()) +</span>
<span class="line-removed">217                 &quot;\n\n&quot; +</span>
<span class="line-removed">218                 &quot;PR: &quot; + pr.getWebUrl();</span>
<span class="line-removed">219     }</span>
<span class="line-removed">220 </span>
<span class="line-removed">221     private String composeRebaseComment(Hash lastBase, PullRequestInstance prInstance, URI fullWebrev) {</span>
<span class="line-removed">222         var commitMessages = prInstance.formatCommitMessages(prInstance.baseHash(), prInstance.headHash(), this::formatCommit);</span>
<span class="line-removed">223         return &quot;The pull request has been updated with a complete new set of changes (possibly due to a rebase).\n\n&quot; +</span>
<span class="line-removed">224                 infoSeparator + &quot;\n\n&quot; +</span>
<span class="line-removed">225                 &quot;Commits:\n&quot; +</span>
<span class="line-removed">226                 commitMessages + &quot;\n\n&quot; +</span>
<span class="line-removed">227                 &quot;Pull request:\n&quot; +</span>
<span class="line-removed">228                 pr.getWebUrl() + &quot;\n\n&quot; +</span>
<span class="line-removed">229                 &quot;Webrev:\n&quot; +</span>
<span class="line-removed">230                 fullWebrev.toString() + &quot;\n\n&quot; +</span>
<span class="line-removed">231                 &quot;Updated full patch:\n&quot; +</span>
<span class="line-removed">232                 prInstance.diffUrl() + &quot;\n\n&quot; +</span>
<span class="line-removed">233                 &quot;Fetch command:\n&quot; +</span>
<span class="line-removed">234                 prInstance.fetchCommand();</span>
<span class="line-removed">235     }</span>
<span class="line-removed">236 </span>
<span class="line-removed">237     private String composeIncrementalComment(Hash lastHead, PullRequestInstance prInstance, URI fullWebrev, URI incrementalWebrev) {</span>
<span class="line-removed">238         var newCommitMessages = prInstance.formatCommitMessages(lastHead, prInstance.headHash(), this::formatCommit);</span>
<span class="line-removed">239         return &quot;The pull request has been updated with additional changes.\n\n&quot; +</span>
<span class="line-removed">240                 infoSeparator + &quot;\n\n&quot; +</span>
<span class="line-removed">241                 &quot;Added commits:\n&quot; +</span>
<span class="line-removed">242                 newCommitMessages + &quot;\n\n&quot; +</span>
<span class="line-removed">243                 &quot;Pull request:\n&quot; +</span>
<span class="line-removed">244                 pr.getWebUrl() + &quot;\n\n&quot; +</span>
<span class="line-removed">245                 &quot;Webrevs:\n&quot; +</span>
<span class="line-removed">246                 &quot; - full: &quot; + fullWebrev.toString() + &quot;\n&quot; +</span>
<span class="line-removed">247                 &quot; - inc: &quot; + incrementalWebrev.toString() + &quot;\n\n&quot; +</span>
<span class="line-removed">248                 &quot;Updated full patch:\n&quot; +</span>
<span class="line-removed">249                 prInstance.diffUrl() + &quot;\n\n&quot; +</span>
<span class="line-removed">250                 &quot;Fetch command:\n&quot; +</span>
<span class="line-removed">251                 prInstance.fetchCommand();</span>
<span class="line-removed">252     }</span>
<span class="line-removed">253 </span>
<span class="line-removed">254     private String composeReadyForIntegrationComment() {</span>
<span class="line-removed">255         return &quot;This PR now fulfills all the requirements for integration, and is only awaiting the final &quot; +</span>
<span class="line-removed">256                 &quot;integration command from the author.&quot; +</span>
<span class="line-removed">257                 &quot;\n\n&quot; +</span>
<span class="line-removed">258                 &quot;PR: &quot; + pr.getWebUrl();</span>
<span class="line-removed">259     }</span>
<span class="line-removed">260 </span>
261     private Repository materializeArchive(Path scratchPath) {
262         try {
263             return Repository.materialize(scratchPath, bot.archiveRepo().getUrl(), pr.getTargetRef());
264         } catch (IOException e) {
265             throw new UncheckedIOException(e);
266         }
267     }
268 
269     private final static Pattern commandPattern = Pattern.compile(&quot;^/.*$&quot;);
270 
271     private boolean ignoreComment(HostUserDetails author, String body) {
272         if (pr.repository().host().getCurrentUserDetails().equals(author)) {
273             return true;
274         }
275         if (bot.ignoredUsers().contains(author.userName())) {
276             return true;
277         }
278         var commandMatcher = commandPattern.matcher(body);
279         if (commandMatcher.matches()) {
280             return true;
281         }
<a name="7" id="anc7"></a><span class="line-modified">282         return false;</span>
<span class="line-modified">283     }</span>
<span class="line-modified">284 </span>
<span class="line-modified">285     private EmailAddress getUniqueMessageId(String identifier) {</span>
<span class="line-removed">286         try {</span>
<span class="line-removed">287             var prSpecific = pr.repository().getName().replace(&quot;/&quot;, &quot;.&quot;) + &quot;.&quot; + pr.getId();</span>
<span class="line-removed">288             var digest = MessageDigest.getInstance(&quot;SHA-256&quot;);</span>
<span class="line-removed">289             digest.update(prSpecific.getBytes(StandardCharsets.UTF_8));</span>
<span class="line-removed">290             digest.update(identifier.getBytes(StandardCharsets.UTF_8));</span>
<span class="line-removed">291             var encodedCommon = Base64.getUrlEncoder().encodeToString(digest.digest());</span>
<span class="line-removed">292 </span>
<span class="line-removed">293             return EmailAddress.from(encodedCommon + &quot;.&quot; + UUID.randomUUID() + &quot;@&quot; + pr.repository().getUrl().getHost());</span>
<span class="line-removed">294         } catch (NoSuchAlgorithmException e) {</span>
<span class="line-removed">295             throw new RuntimeException(&quot;Cannot find SHA-256&quot;);</span>
<span class="line-removed">296         }</span>
<span class="line-removed">297     }</span>
<span class="line-removed">298 </span>
<span class="line-removed">299     private String getStableMessageId(EmailAddress uniqueMessageId) {</span>
<span class="line-removed">300         return uniqueMessageId.localPart().split(&quot;\\.&quot;)[0];</span>
<span class="line-removed">301     }</span>
<span class="line-removed">302 </span>
<span class="line-removed">303     private EmailAddress getMessageId() {</span>
<span class="line-removed">304         return getUniqueMessageId(&quot;fc&quot;);</span>
<span class="line-removed">305     }</span>
<span class="line-removed">306 </span>
<span class="line-removed">307     private EmailAddress getMessageId(Comment comment) {</span>
<span class="line-removed">308         return getUniqueMessageId(&quot;pc&quot; + comment.id());</span>
<span class="line-removed">309     }</span>
<span class="line-removed">310 </span>
<span class="line-removed">311     private EmailAddress getMessageId(ReviewComment comment) {</span>
<span class="line-removed">312         return getUniqueMessageId(&quot;rc&quot; + comment.id());</span>
<span class="line-removed">313     }</span>
<span class="line-removed">314 </span>
<span class="line-removed">315     private EmailAddress getMessageId(Hash hash) {</span>
<span class="line-removed">316         return getUniqueMessageId(&quot;ha&quot; + hash.hex());</span>
<span class="line-removed">317     }</span>
<span class="line-removed">318 </span>
<span class="line-removed">319     private EmailAddress getMessageId(String raw) {</span>
<span class="line-removed">320         return getUniqueMessageId(&quot;rw&quot; + raw);</span>
<span class="line-removed">321     }</span>
<span class="line-removed">322 </span>
<span class="line-removed">323     private EmailAddress getMessageId(Review review) {</span>
<span class="line-removed">324         return getUniqueMessageId(&quot;rv&quot; + review.id());</span>
<span class="line-removed">325     }</span>
<span class="line-removed">326 </span>
<span class="line-removed">327     private EmailAddress getAuthorAddress(HostUserDetails originalAuthor) {</span>
<span class="line-removed">328         return EmailAddress.from(originalAuthor.fullName() + &quot; via &quot; + pr.repository().getUrl().getHost(),</span>
<span class="line-removed">329                                  bot.emailAddress().address());</span>
<span class="line-removed">330     }</span>
<span class="line-removed">331 </span>
<span class="line-removed">332     private Email newConversation(PullRequestInstance prInstance, URI webrev) {</span>
<span class="line-removed">333         var body = composeConversation(pr.getBody(), prInstance, webrev);</span>
<span class="line-removed">334         var email = Email.create(getAuthorAddress(pr.getAuthor()), &quot;RFR: &quot; + pr.getTitle(), body)</span>
<span class="line-removed">335                          .sender(bot.emailAddress())</span>
<span class="line-removed">336                          .id(getMessageId())</span>
<span class="line-removed">337                          .header(&quot;PR-Head-Hash&quot;, prInstance.headHash().hex())</span>
<span class="line-removed">338                          .header(&quot;PR-Base-Hash&quot;, prInstance.baseHash().hex())</span>
<span class="line-removed">339                          .build();</span>
<span class="line-removed">340         return email;</span>
<span class="line-removed">341     }</span>
<span class="line-removed">342 </span>
<span class="line-removed">343 </span>
<span class="line-removed">344     private Email comment(Email parent, Comment comment) {</span>
<span class="line-removed">345         var reply = composeReply(parent.date(), parent.author(), parent.body(), comment.body());</span>
<span class="line-removed">346         var references = parent.id().toString();</span>
<span class="line-removed">347         if (parent.hasHeader(&quot;References&quot;)) {</span>
<span class="line-removed">348             references = parent.headerValue(&quot;References&quot;) + &quot; &quot; + references;</span>
<span class="line-removed">349         }</span>
<span class="line-removed">350 </span>
<span class="line-removed">351         var email = Email.create(getAuthorAddress(comment.author()), &quot;Re: RFR: &quot; + pr.getTitle(), reply)</span>
<span class="line-removed">352                          .sender(bot.emailAddress())</span>
<span class="line-removed">353                          .recipient(parent.author())</span>
<span class="line-removed">354                          .id(getMessageId(comment))</span>
<span class="line-removed">355                          .header(&quot;In-Reply-To&quot;, parent.id().toString())</span>
<span class="line-removed">356                          .header(&quot;References&quot;, references)</span>
<span class="line-removed">357                          .build();</span>
<span class="line-removed">358         return email;</span>
<span class="line-removed">359     }</span>
<span class="line-removed">360 </span>
<span class="line-removed">361     private Email review(Email parent, Review review) {</span>
<span class="line-removed">362         var body = composeReview(parent.date(), parent.author(), parent.body(), review);</span>
<span class="line-removed">363         var email = Email.create(getAuthorAddress(review.reviewer()), &quot;Re: RFR: &quot; + pr.getTitle(), body)</span>
<span class="line-removed">364                          .sender(bot.emailAddress())</span>
<span class="line-removed">365                          .recipient(parent.author())</span>
<span class="line-removed">366                          .id(getMessageId(review))</span>
<span class="line-removed">367                          .header(&quot;In-Reply-To&quot;, parent.id().toString())</span>
<span class="line-removed">368                          .header(&quot;References&quot;, parent.id().toString())</span>
<span class="line-removed">369                          .build();</span>
<span class="line-removed">370         return email;</span>
<span class="line-removed">371 </span>
<span class="line-removed">372     }</span>
<span class="line-removed">373 </span>
<span class="line-removed">374     private Email reviewComment(Email parent, ReviewComment comment) {</span>
<span class="line-removed">375         var body = new StringBuilder();</span>
<span class="line-removed">376 </span>
<span class="line-removed">377         // Add some context to the first post</span>
<span class="line-removed">378         if (comment.parent().isEmpty()) {</span>
<span class="line-removed">379             var contents = pr.repository().getFileContents(comment.path(), comment.hash().hex()).lines().collect(Collectors.toList());</span>
<span class="line-removed">380 </span>
<span class="line-removed">381             body.append(comment.path()).append(&quot; line &quot;).append(comment.line()).append(&quot;:\n\n&quot;);</span>
<span class="line-removed">382             for (int i = Math.max(0, comment.line() - 2); i &lt; Math.min(contents.size(), comment.line() + 1); ++i) {</span>
<span class="line-removed">383                 body.append(&quot;&gt; &quot;).append(i + 1).append(&quot;: &quot;).append(contents.get(i)).append(&quot;\n&quot;);</span>
<span class="line-removed">384             }</span>
<span class="line-removed">385             body.append(&quot;\n&quot;);</span>
<span class="line-removed">386         }</span>
<span class="line-removed">387         body.append(comment.body());</span>
<span class="line-removed">388 </span>
<span class="line-removed">389         var reply = composeReply(parent.date(), parent.author(), parent.body(), body.toString());</span>
<span class="line-removed">390         var references = parent.id().toString();</span>
<span class="line-removed">391         if (parent.hasHeader(&quot;References&quot;)) {</span>
<span class="line-removed">392             references = parent.headerValue(&quot;References&quot;) + &quot; &quot; + references;</span>
<span class="line-removed">393         }</span>
<span class="line-removed">394 </span>
<span class="line-removed">395         var email = Email.create(getAuthorAddress(comment.author()), &quot;Re: RFR: &quot; + pr.getTitle(), reply)</span>
<span class="line-removed">396                          .sender(bot.emailAddress())</span>
<span class="line-removed">397                          .recipient(parent.author())</span>
<span class="line-removed">398                          .id(getMessageId(comment))</span>
<span class="line-removed">399                          .header(&quot;In-Reply-To&quot;, parent.id().toString())</span>
<span class="line-removed">400                          .header(&quot;References&quot;, references)</span>
<span class="line-removed">401                          .build();</span>
<span class="line-removed">402         return email;</span>
<span class="line-removed">403     }</span>
<span class="line-removed">404 </span>
<span class="line-removed">405     private Email rebaseComment(Email parent, Hash lastBase, PullRequestInstance prInstance, URI fullWebrev) {</span>
<span class="line-removed">406         var body = composeRebaseComment(lastBase, prInstance, fullWebrev);</span>
<span class="line-removed">407         var email = Email.create(getAuthorAddress(pr.getAuthor()), &quot;Re: RFR: &quot; + pr.getTitle(), body)</span>
<span class="line-removed">408                          .sender(bot.emailAddress())</span>
<span class="line-removed">409                          .recipient(parent.author())</span>
<span class="line-removed">410                          .id(getMessageId(prInstance.headHash()))</span>
<span class="line-removed">411                          .header(&quot;In-Reply-To&quot;, parent.id().toString())</span>
<span class="line-removed">412                          .header(&quot;References&quot;, parent.id().toString())</span>
<span class="line-removed">413                          .header(&quot;PR-Head-Hash&quot;, prInstance.headHash().hex())</span>
<span class="line-removed">414                          .header(&quot;PR-Base-Hash&quot;, prInstance.baseHash().hex())</span>
<span class="line-removed">415                          .build();</span>
<span class="line-removed">416         return email;</span>
<span class="line-removed">417     }</span>
<span class="line-removed">418 </span>
<span class="line-removed">419     private Email incrementalComment(Email parent, Hash lastHead, PullRequestInstance prInstance, URI fullWebrev, URI incrementalWebrev) {</span>
<span class="line-removed">420         var body = composeIncrementalComment(lastHead, prInstance, fullWebrev, incrementalWebrev);</span>
<span class="line-removed">421         var email = Email.create(getAuthorAddress(pr.getAuthor()), &quot;Re: RFR: &quot; + pr.getTitle(), body)</span>
<span class="line-removed">422                          .sender(bot.emailAddress())</span>
<span class="line-removed">423                          .recipient(parent.author())</span>
<span class="line-removed">424                          .id(getMessageId(prInstance.headHash()))</span>
<span class="line-removed">425                          .header(&quot;In-Reply-To&quot;, parent.id().toString())</span>
<span class="line-removed">426                          .header(&quot;References&quot;, parent.id().toString())</span>
<span class="line-removed">427                          .header(&quot;PR-Head-Hash&quot;, prInstance.headHash().hex())</span>
<span class="line-removed">428                          .header(&quot;PR-Base-Hash&quot;, prInstance.baseHash().hex())</span>
<span class="line-removed">429                          .build();</span>
<span class="line-removed">430         return email;</span>
<span class="line-removed">431     }</span>
<span class="line-removed">432 </span>
<span class="line-removed">433     private Email readyForIntegrationComment(Email parent, Set&lt;String&gt; currentLabels, int numLabelComments) {</span>
<span class="line-removed">434         var body = composeReadyForIntegrationComment();</span>
<span class="line-removed">435         var email = Email.create(getAuthorAddress(pr.getAuthor()), &quot;Re: RFR: &quot; + pr.getTitle(), body)</span>
<span class="line-removed">436                          .sender(bot.emailAddress())</span>
<span class="line-removed">437                          .recipient(parent.author())</span>
<span class="line-removed">438                          .id(getMessageId(&quot;labelcomment&quot; + numLabelComments))</span>
<span class="line-removed">439                          .header(&quot;In-Reply-To&quot;, parent.id().toString())</span>
<span class="line-removed">440                          .header(&quot;References&quot;, parent.id().toString())</span>
<span class="line-removed">441                          .header(&quot;PR-Labels&quot;, String.join(&quot;;&quot;, currentLabels))</span>
<span class="line-removed">442                          .build();</span>
<span class="line-removed">443         return email;</span>
<span class="line-removed">444     }</span>
<span class="line-removed">445 </span>
<span class="line-removed">446     private List&lt;Email&gt; parseArchive(MailingList archive) {</span>
<span class="line-removed">447         var conversations = archive.conversations(Duration.ofDays(365));</span>
<span class="line-removed">448 </span>
<span class="line-removed">449         if (conversations.size() == 0) {</span>
<span class="line-removed">450             return new ArrayList&lt;&gt;();</span>
<span class="line-removed">451         } else if (conversations.size() == 1) {</span>
<span class="line-removed">452             var conversation = conversations.get(0);</span>
<span class="line-removed">453             return conversation.allMessages();</span>
<span class="line-removed">454         } else {</span>
<span class="line-removed">455             throw new RuntimeException(&quot;Something is wrong with the mbox&quot;);</span>
<span class="line-removed">456         }</span>
<span class="line-removed">457     }</span>
<span class="line-removed">458 </span>
<span class="line-removed">459     private Map&lt;Email, Email&gt; findParents(Map&lt;EmailAddress, Email&gt; emailIds) {</span>
<span class="line-removed">460         var parents = new HashMap&lt;Email, Email&gt;();</span>
<span class="line-removed">461         for (var entry : emailIds.entrySet()) {</span>
<span class="line-removed">462             if (entry.getValue().hasHeader(&quot;In-Reply-To&quot;)) {</span>
<span class="line-removed">463                 var replyId = EmailAddress.parse(entry.getValue().headerValue(&quot;In-Reply-To&quot;));</span>
464             }
465         }
<a name="8" id="anc8"></a><span class="line-modified">466         return parents;</span>
<span class="line-removed">467     }</span>
<span class="line-removed">468 </span>
<span class="line-removed">469     private final Pattern replyHeaderPattern = Pattern.compile(&quot;^On .* &lt;(.*)&gt; wrote:$.*&quot;,</span>
<span class="line-removed">470                                                                Pattern.DOTALL | Pattern.MULTILINE);</span>
<span class="line-removed">471 </span>
<span class="line-removed">472     // Combine mails from the same author, directed at the same person, into a single mail</span>
<span class="line-removed">473     private List&lt;Email&gt; combineMails(List&lt;Email&gt; emails) {</span>
<span class="line-removed">474         var byAuthor = emails.stream().collect(Collectors.groupingBy(Email::author));</span>
<span class="line-removed">475         var ret = new ArrayList&lt;Email&gt;();</span>
<span class="line-removed">476         for (var authorMails : byAuthor.entrySet()) {</span>
<span class="line-removed">477             var byTarget = authorMails.getValue().stream()</span>
<span class="line-removed">478                                       .collect(Collectors.groupingBy(email -&gt; {</span>
<span class="line-removed">479                                           var matcher = replyHeaderPattern.matcher(email.body());</span>
<span class="line-removed">480                                           if (matcher.matches()) {</span>
<span class="line-removed">481                                               return matcher.group(1);</span>
<span class="line-removed">482                                           } else {</span>
<span class="line-removed">483                                               // No grouping of undirected messages</span>
<span class="line-removed">484                                               return &quot;&quot;;</span>
<span class="line-removed">485                                           }</span>
<span class="line-removed">486                                       }));</span>
<span class="line-removed">487 </span>
<span class="line-removed">488             for (var targetMails : byTarget.entrySet()) {</span>
<span class="line-removed">489                 if (!targetMails.getKey().isEmpty()) {</span>
<span class="line-removed">490                     var first = targetMails.getValue().get(0);</span>
<span class="line-removed">491                     var body = new StringBuilder(first.body());</span>
<span class="line-removed">492                     for (int i = 1; i &lt; targetMails.getValue().size(); ++i) {</span>
<span class="line-removed">493                         var addon = targetMails.getValue().get(i).body().lines()</span>
<span class="line-removed">494                                                .skip(2)</span>
<span class="line-removed">495                                                .dropWhile(line -&gt; line.startsWith(&quot;&gt;&quot;))</span>
<span class="line-removed">496                                                .skip(1)</span>
<span class="line-removed">497                                                .collect(Collectors.joining(&quot;\n&quot;));</span>
<span class="line-removed">498                         body.append(&quot;\n\n&quot;).append(addon);</span>
<span class="line-removed">499                     }</span>
<span class="line-removed">500                     var combined = Email.from(first).body(body.toString()).build();</span>
<span class="line-removed">501                     ret.add(combined);</span>
<span class="line-removed">502 </span>
<span class="line-removed">503                 } else {</span>
<span class="line-removed">504                     ret.addAll(targetMails.getValue());</span>
<span class="line-removed">505                 }</span>
<span class="line-removed">506             }</span>
<span class="line-removed">507         }</span>
<span class="line-removed">508 </span>
<span class="line-removed">509         return ret;</span>
510     }
511 
512     private static final String webrevCommentMarker = &quot;&lt;!-- mlbridge webrev comment --&gt;&quot;;
513     private static final String webrevHeaderMarker = &quot;&lt;!-- mlbridge webrev header --&gt;&quot;;
514     private static final String webrevListMarker = &quot;&lt;!-- mlbridge webrev list --&gt;&quot;;
515 
516     private void updateWebrevComment(List&lt;Comment&gt; comments, int index, URI fullWebrev, URI incWebrev) {
517         var existing = comments.stream()
518                                .filter(comment -&gt; comment.author().equals(pr.repository().host().getCurrentUserDetails()))
519                                .filter(comment -&gt; comment.body().contains(webrevCommentMarker))
520                                .findAny();
521         var comment = webrevCommentMarker + &quot;\n&quot;;
522         comment += webrevHeaderMarker + &quot;\n&quot;;
523         comment += &quot;### Webrevs&quot; + &quot;\n&quot;;
524         comment += webrevListMarker + &quot;\n&quot;;
525         comment += &quot; * &quot; + String.format(&quot;%02d&quot;, index) + &quot;: [Full](&quot; + fullWebrev.toString() + &quot;)&quot;;
526         if (incWebrev != null) {
527             comment += &quot; - [Incremental](&quot; + incWebrev.toString() + &quot;)&quot;;
528         }
529         comment += &quot; (&quot; + pr.getHeadHash() + &quot;)\n&quot;;
530 
531         if (existing.isPresent()) {
532             if (existing.get().body().contains(fullWebrev.toString())) {
533                 log.fine(&quot;Webrev link already posted - skipping update&quot;);
534                 return;
535             }
536             var previousListStart = existing.get().body().indexOf(webrevListMarker) + webrevListMarker.length() + 1;
537             var previousList = existing.get().body().substring(previousListStart);
538             comment += previousList;
539             pr.updateComment(existing.get().id(), comment);
540         } else {
541             pr.addComment(comment);
542         }
543     }
544 
<a name="9" id="anc9"></a>












545     @Override
546     public void run(Path scratchPath) {
547         var path = scratchPath.resolve(&quot;mlbridge&quot;);
548         var archiveRepo = materializeArchive(path);
549         var mboxBasePath = path.resolve(bot.codeRepo().getName());
550         var mbox = MailingListServerFactory.createMboxFileServer(mboxBasePath);
<a name="10" id="anc10"></a><span class="line-modified">551         var archive = mbox.getList(pr.getId());</span>
<span class="line-modified">552         var archiveMails = parseArchive(archive);</span>
553 
554         // First determine if this PR should be inspected further or not
<a name="11" id="anc11"></a><span class="line-modified">555         if (archiveMails.isEmpty()) {</span>
556             var labels = new HashSet&lt;&gt;(pr.getLabels());
557             for (var readyLabel : bot.readyLabels()) {
558                 if (!labels.contains(readyLabel)) {
559                     log.fine(&quot;PR is not yet ready - missing label &#39;&quot; + readyLabel + &quot;&#39;&quot;);
560                     return;
561                 }
562             }
563         }
564 
565         // Also inspect comments before making the first post
566         var comments = pr.getComments();
<a name="12" id="anc12"></a><span class="line-modified">567         if (archiveMails.isEmpty()) {</span>
568             for (var readyComment : bot.readyComments().entrySet()) {
569                 var commentFound = false;
570                 for (var comment : comments) {
571                     if (comment.author().userName().equals(readyComment.getKey())) {
572                         var matcher = readyComment.getValue().matcher(comment.body());
573                         if (matcher.find()) {
574                             commentFound = true;
575                             break;
576                         }
577                     }
578                 }
579                 if (!commentFound) {
580                     log.fine(&quot;PR is not yet ready - missing ready comment from &#39;&quot; + readyComment.getKey() +
581                                      &quot;containing &#39;&quot; + readyComment.getValue().pattern() + &quot;&#39;&quot;);
582                     return;
583                 }
584             }
585         }
586 
<a name="13" id="anc13"></a>



587         var webrevPath = scratchPath.resolve(&quot;mlbridge-webrevs&quot;);
588         var listServer = MailingListServerFactory.createMailmanServer(bot.listArchive(), bot.smtpServer());
589         var list = listServer.getList(bot.listAddress().address());
<a name="14" id="anc14"></a><span class="line-removed">590         var newMails = new ArrayList&lt;Email&gt;();</span>
<span class="line-removed">591         var stableIdToMail = archiveMails.stream().collect(Collectors.toMap(email -&gt; getStableMessageId(email.id()),</span>
<span class="line-removed">592                                                                             Function.identity()));</span>
<span class="line-removed">593         var prInstance = new PullRequestInstance(scratchPath.resolve(&quot;mlbridge-mergebase&quot;), pr);</span>
594 
595         // First post
<a name="15" id="anc15"></a><span class="line-modified">596         if (archiveMails.isEmpty()) {</span>

597             var webrev = bot.webrevStorage().createAndArchive(prInstance, webrevPath, prInstance.baseHash(),
598                                                               prInstance.headHash(), &quot;00&quot;);
<a name="16" id="anc16"></a><span class="line-modified">599             var firstMail = newConversation(prInstance, webrev);</span>
<span class="line-removed">600             archive.post(firstMail);</span>
<span class="line-removed">601             newMails.add(firstMail);</span>
<span class="line-removed">602             stableIdToMail.put(getStableMessageId(firstMail.id()), firstMail);</span>
603             updateWebrevComment(comments, 0, webrev, null);
<a name="17" id="anc17"></a><span class="line-removed">604             log.fine(&quot;Posting new PR conversation&quot;);</span>
605         } else {
<a name="18" id="anc18"></a><span class="line-modified">606             // Determine the latest head hash reported</span>
<span class="line-removed">607             var reportedHeads = archiveMails.stream()</span>
<span class="line-removed">608                                             .filter(email -&gt; email.hasHeader(&quot;PR-Head-Hash&quot;))</span>
<span class="line-removed">609                                             .map(email -&gt; email.headerValue(&quot;PR-Head-Hash&quot;))</span>
<span class="line-removed">610                                             .map(Hash::new)</span>
<span class="line-removed">611                                             .collect(Collectors.toList());</span>
<span class="line-removed">612             var latestHead = reportedHeads.size() &gt; 0 ? reportedHeads.get(reportedHeads.size() - 1) : pr.getHeadHash();</span>
613 
614             // Check if the head has changed
615             if (!pr.getHeadHash().equals(latestHead)) {
<a name="19" id="anc19"></a><span class="line-modified">616                 log.fine(&quot;Head hash change detected: current: &quot; + pr.getHeadHash() + &quot; - existing: &quot; + reportedHeads);</span>
<span class="line-modified">617 </span>
<span class="line-modified">618                 // Determine the latest base hash reported</span>
<span class="line-removed">619                 var reportedBases = archiveMails.stream()</span>
<span class="line-removed">620                                                 .filter(email -&gt; email.hasHeader(&quot;PR-Base-Hash&quot;))</span>
<span class="line-removed">621                                                 .map(email -&gt; email.headerValue(&quot;PR-Base-Hash&quot;))</span>
<span class="line-removed">622                                                 .map(Hash::new)</span>
<span class="line-removed">623                                                 .collect(Collectors.toList());</span>
<span class="line-removed">624                 if (reportedBases.size() == 0) {</span>
<span class="line-removed">625                     throw new RuntimeException(&quot;No previous bases found?&quot;);</span>
<span class="line-removed">626                 }</span>
<span class="line-removed">627                 var latestBase = reportedBases.get(reportedBases.size() - 1);</span>
<span class="line-removed">628                 var firstMail = archiveMails.get(0);</span>
<span class="line-removed">629                 Email commentMail;</span>
630                 if (!prInstance.baseHash().equals(latestBase)) {
<a name="20" id="anc20"></a>
631                     var fullWebrev = bot.webrevStorage().createAndArchive(prInstance, webrevPath, prInstance.baseHash(),
<a name="21" id="anc21"></a><span class="line-modified">632                                                                           prInstance.headHash(), String.format(&quot;%02d&quot;, reportedHeads.size()));</span>
<span class="line-modified">633                     commentMail = rebaseComment(firstMail, latestBase, prInstance, fullWebrev);</span>
<span class="line-modified">634                     updateWebrevComment(comments, reportedHeads.size(), fullWebrev, null);</span>
635                 } else {
<a name="22" id="anc22"></a><span class="line-modified">636                     var index = reportedHeads.size();</span>
637                     var fullWebrev = bot.webrevStorage().createAndArchive(prInstance, webrevPath, prInstance.baseHash(),
638                                                                           prInstance.headHash(), String.format(&quot;%02d&quot;, index));
639                     var incrementalWebrev = bot.webrevStorage().createAndArchive(prInstance, webrevPath, latestHead,
640                                                                                  prInstance.headHash(), String.format(&quot;%02d-%02d&quot;, index - 1, index));
<a name="23" id="anc23"></a><span class="line-modified">641                     commentMail = incrementalComment(firstMail, latestHead, prInstance, fullWebrev, incrementalWebrev);</span>
642                     updateWebrevComment(comments, index, fullWebrev, incrementalWebrev);
643                 }
<a name="24" id="anc24"></a><span class="line-removed">644                 archive.post(commentMail);</span>
<span class="line-removed">645                 newMails.add(commentMail);</span>
<span class="line-removed">646                 stableIdToMail.put(getStableMessageId(commentMail.id()), commentMail);</span>
647             }
648         }
649 
650         // Regular comments
<a name="25" id="anc25"></a><span class="line-removed">651         var previous = archiveMails.size() &gt; 0 ? archiveMails.get(0) : newMails.get(0);</span>
652         for (var comment : comments) {
<a name="26" id="anc26"></a><span class="line-removed">653             var id = getStableMessageId(getMessageId(comment));</span>
<span class="line-removed">654             if (stableIdToMail.containsKey(id)) {</span>
<span class="line-removed">655                 previous = stableIdToMail.get(id);</span>
<span class="line-removed">656                 continue;</span>
<span class="line-removed">657             }</span>
658             if (ignoreComment(comment.author(), comment.body())) {
659                 continue;
660             }
<a name="27" id="anc27"></a><span class="line-modified">661 </span>
<span class="line-removed">662             // Try to determine a parent post from @mentions</span>
<span class="line-removed">663             var parentComment = getParentPost(comment, comments);</span>
<span class="line-removed">664             var parent = parentComment.map(c -&gt; stableIdToMail.get(getStableMessageId(getMessageId(c)))).orElse(previous);</span>
<span class="line-removed">665 </span>
<span class="line-removed">666             var commentMail = comment(parent, comment);</span>
<span class="line-removed">667             archive.post(commentMail);</span>
<span class="line-removed">668             newMails.add(commentMail);</span>
<span class="line-removed">669             stableIdToMail.put(getStableMessageId(commentMail.id()), commentMail);</span>
<span class="line-removed">670             previous = commentMail;</span>
671         }
672 
673         // Review comments
<a name="28" id="anc28"></a><span class="line-removed">674         final var first = archiveMails.size() &gt; 0 ? archiveMails.get(0) : newMails.get(0);</span>
675         var reviews = pr.getReviews();
676         for (var review : reviews) {
<a name="29" id="anc29"></a><span class="line-removed">677             var id = getStableMessageId(getMessageId(review));</span>
<span class="line-removed">678             if (stableIdToMail.containsKey(id)) {</span>
<span class="line-removed">679                 continue;</span>
<span class="line-removed">680             }</span>
681             if (ignoreComment(review.reviewer(), review.body().orElse(&quot;&quot;))) {
682                 continue;
683             }
<a name="30" id="anc30"></a><span class="line-modified">684 </span>
<span class="line-removed">685             var commentMail = review(first, review);</span>
<span class="line-removed">686             archive.post(commentMail);</span>
<span class="line-removed">687             newMails.add(commentMail);</span>
<span class="line-removed">688             stableIdToMail.put(getStableMessageId(commentMail.id()), commentMail);</span>
689         }
690 
<a name="31" id="anc31"></a><span class="line-removed">691 </span>
692         // File specific comments
693         var reviewComments = pr.getReviewComments();
694         for (var reviewComment : reviewComments) {
<a name="32" id="anc32"></a><span class="line-removed">695             var id = getStableMessageId(getMessageId(reviewComment));</span>
<span class="line-removed">696             if (stableIdToMail.containsKey(id)) {</span>
<span class="line-removed">697                 continue;</span>
<span class="line-removed">698             }</span>
699             if (ignoreComment(reviewComment.author(), reviewComment.body())) {
700                 continue;
701             }
<a name="33" id="anc33"></a><span class="line-modified">702 </span>
<span class="line-removed">703             var parent = reviewComment.parent().map(c -&gt; stableIdToMail.get(getStableMessageId(getMessageId(c)))).orElse(first);</span>
<span class="line-removed">704             var commentMail = reviewComment(parent, reviewComment);</span>
<span class="line-removed">705             archive.post(commentMail);</span>
<span class="line-removed">706             newMails.add(commentMail);</span>
<span class="line-removed">707             stableIdToMail.put(getStableMessageId(commentMail.id()), commentMail);</span>
708         }
709 
<a name="34" id="anc34"></a>
710         if (newMails.isEmpty()) {
711             return;
712         }
713 
714         // Push all new mails to the archive repository
<a name="35" id="anc35"></a>
715         pushMbox(archiveRepo, &quot;Adding comments for PR &quot; + bot.codeRepo().getName() + &quot;/&quot; + pr.getId());
716 
<a name="36" id="anc36"></a><span class="line-modified">717         // Combine and post all new mails to the list</span>
<span class="line-modified">718         var listMails = combineMails(newMails);</span>
<span class="line-removed">719         for (var mail : listMails) {</span>
<span class="line-removed">720             list.post(mail);</span>
<span class="line-removed">721         }</span>
722     }
723 
724     @Override
725     public void handleRuntimeException(RuntimeException e) {
726         exceptionConsumer.accept(e);
727     }
728 }
<a name="37" id="anc37"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="37" type="hidden" />
</body>
</html>