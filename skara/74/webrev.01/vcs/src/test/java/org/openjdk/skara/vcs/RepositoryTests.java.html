<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New vcs/src/test/java/org/openjdk/skara/vcs/RepositoryTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.vcs;
  24 
  25 import org.openjdk.skara.test.TemporaryDirectory;
  26 
  27 import org.junit.jupiter.api.Test;
  28 import org.junit.jupiter.params.ParameterizedTest;
  29 import org.junit.jupiter.params.provider.EnumSource;
  30 
  31 import java.io.IOException;
  32 import java.net.URI;
  33 import java.nio.file.*;
  34 import java.nio.file.attribute.*;
  35 import java.util.*;
  36 import java.util.stream.Collectors;
  37 
  38 import static java.nio.file.StandardOpenOption.*;
  39 import static org.junit.jupiter.api.Assertions.*;
  40 
  41 public class RepositoryTests {
  42 
  43     @ParameterizedTest
  44     @EnumSource(VCS.class)
  45     void testExistsOnMissingDirectory(VCS vcs) throws IOException {
  46         var d = Paths.get(&quot;/&quot;, &quot;this&quot;, &quot;path&quot;, &quot;does&quot;, &quot;not&quot;, &quot;exist&quot;);
  47         var r = Repository.get(d);
  48         assertTrue(r.isEmpty());
  49     }
  50 
  51     @ParameterizedTest
  52     @EnumSource(VCS.class)
  53     void testExistsOnEmptyDirectory(VCS vcs) throws IOException {
  54         try (var dir = new TemporaryDirectory()) {
  55             var r = Repository.get(dir.path());
  56             assertTrue(r.isEmpty());
  57         }
  58     }
  59 
  60     @ParameterizedTest
  61     @EnumSource(VCS.class)
  62     void testExistsOnInitializedRepository(VCS vcs) throws IOException {
  63         try (var dir = new TemporaryDirectory()) {
  64             var r = Repository.init(dir.path(), vcs);
  65             assertTrue(r.exists());
  66         }
  67     }
  68 
  69     @ParameterizedTest
  70     @EnumSource(VCS.class)
  71     void testExistsOnSubdir() throws IOException {
  72         try (var dir = new TemporaryDirectory()) {
  73             var r = Repository.init(dir.path(), VCS.GIT);
  74             assertTrue(r.exists());
  75 
  76             var subdir = Paths.get(dir.toString(), &quot;test&quot;);
  77             Files.createDirectories(subdir);
  78             var r2 = Repository.get(subdir);
  79             assertTrue(r2.get().exists());
  80         }
  81     }
  82 
  83     @ParameterizedTest
  84     @EnumSource(VCS.class)
  85     void testRootOnTopLevel() throws IOException {
  86         try (var dir = new TemporaryDirectory()) {
  87             var r = Repository.init(dir.path(), VCS.GIT);
  88             assertEquals(dir.toString(), r.root().toString());
  89         }
  90     }
  91 
  92     @ParameterizedTest
  93     @EnumSource(VCS.class)
  94     void testRootOnSubdirectory(VCS vcs) throws IOException {
  95         try (var dir = new TemporaryDirectory()) {
  96             var r = Repository.init(dir.path(), vcs);
  97             assertEquals(dir.toString(), r.root().toString());
  98 
  99             var subdir = Paths.get(dir.toString(), &quot;sub&quot;);
 100             Files.createDirectories(subdir);
 101 
 102             var r2 = Repository.get(subdir);
 103             assertEquals(dir.toString(), r2.get().root().toString());
 104         }
 105     }
 106 
 107     @ParameterizedTest
 108     @EnumSource(VCS.class)
 109     void testResolveOnEmptyRepository(VCS vcs) throws IOException {
 110         try (var dir = new TemporaryDirectory()) {
 111             var r = Repository.init(dir.path(), vcs);
 112             assertTrue(r.resolve(&quot;HEAD&quot;).isEmpty());
 113         }
 114     }
 115 
 116     @ParameterizedTest
 117     @EnumSource(VCS.class)
 118     void testResolveWithHEAD(VCS vcs) throws IOException {
 119         try (var dir = new TemporaryDirectory()) {
 120             var r = Repository.init(dir.path(), vcs);
 121 
 122             var readme = dir.path().resolve(&quot;README&quot;);
 123             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 124 
 125             r.add(readme);
 126             var head = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 127             assertEquals(head, r.head());
 128         }
 129     }
 130 
 131     @ParameterizedTest
 132     @EnumSource(VCS.class)
 133     void testConfig(VCS vcs) throws IOException {
 134         try (var dir = new TemporaryDirectory()) {
 135             var r = Repository.init(dir.path(), vcs);
 136 
 137             if (vcs == VCS.GIT) {
 138                 var config = dir.path().resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 139                 Files.write(config, List.of(&quot;[user]&quot;, &quot;name = duke&quot;), WRITE, APPEND);
 140                 assertEquals(List.of(&quot;duke&quot;), r.config(&quot;user.name&quot;));
 141             } else if (vcs == VCS.HG) {
 142                 var config = dir.path().resolve(&quot;.hg&quot;).resolve(&quot;hgrc&quot;);
 143                 Files.write(config, List.of(&quot;[ui]&quot;, &quot;username = duke&quot;), WRITE, CREATE);
 144                 assertEquals(List.of(&quot;duke&quot;), r.config(&quot;ui.username&quot;));
 145             }
 146 
 147             assertEquals(&quot;duke&quot;, r.username().get());
 148         }
 149     }
 150 
 151     @ParameterizedTest
 152     @EnumSource(VCS.class)
 153     void testCurrentBranchOnEmptyRepository(VCS vcs) throws IOException {
 154         try (var dir = new TemporaryDirectory()) {
 155             var r = Repository.init(dir.path(), vcs);
 156             assertEquals(r.defaultBranch(), r.currentBranch());
 157         }
 158     }
 159 
 160     @ParameterizedTest
 161     @EnumSource(VCS.class)
 162     void testCheckout(VCS vcs) throws IOException {
 163         try (var dir = new TemporaryDirectory()) {
 164             var r = Repository.init(dir.path(), vcs);
 165 
 166             var readme = dir.path().resolve(&quot;README&quot;);
 167             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 168             r.add(readme);
 169 
 170             var head1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 171             assertEquals(head1, r.head());
 172 
 173             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 174             r.add(readme);
 175 
 176             var head2 = r.commit(&quot;Add one more line&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 177             assertEquals(head2, r.head());
 178 
 179             r.checkout(head1, false);
 180             assertEquals(head1, r.head());
 181 
 182             r.checkout(head2, false);
 183             assertEquals(head2, r.head());
 184         }
 185     }
 186 
 187     @ParameterizedTest
 188     @EnumSource(VCS.class)
 189     void testLines(VCS vcs) throws IOException {
 190         try (var dir = new TemporaryDirectory()) {
 191             var r = Repository.init(dir.path(), vcs);
 192 
 193             var readme = dir.path().resolve(&quot;README&quot;);
 194             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 195             r.add(readme);
 196 
 197             var head1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 198             assertEquals(List.of(&quot;Hello, readme!&quot;),
 199                          r.lines(readme, head1).orElseThrow());
 200 
 201             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 202             r.add(readme);
 203 
 204             var head2 = r.commit(&quot;Add one more line&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 205             assertEquals(List.of(&quot;Hello, readme!&quot;, &quot;Another line&quot;),
 206                          r.lines(readme, head2).orElseThrow());
 207         }
 208     }
 209 
 210     @ParameterizedTest
 211     @EnumSource(VCS.class)
 212     void testLinesInSubdir(VCS vcs) throws IOException {
 213         try (var dir = new TemporaryDirectory()) {
 214             Repository.init(dir.path(), vcs);
 215 
 216             var subdir = dir.path().resolve(&quot;sub&quot;);
 217             Files.createDirectories(subdir);
 218             var r = Repository.get(subdir).get();
 219 
 220             var readme = subdir.getParent().resolve(&quot;README&quot;);
 221             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 222             r.add(readme);
 223 
 224             var head = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 225             assertEquals(List.of(&quot;Hello, readme!&quot;),
 226                          r.lines(readme, head).orElseThrow());
 227 
 228             var example = subdir.resolve(&quot;EXAMPLE&quot;);
 229             Files.write(example, List.of(&quot;An example&quot;));
 230             r.add(example);
 231 
 232             var head2 = r.commit(&quot;Add EXAMPLE&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 233             assertEquals(List.of(&quot;An example&quot;),
 234                          r.lines(example, head2).orElseThrow());
 235         }
 236     }
 237 
 238     @ParameterizedTest
 239     @EnumSource(VCS.class)
 240     void testCommitListingOnEmptyRepo(VCS vcs) throws IOException {
 241         try (var dir = new TemporaryDirectory()) {
 242             var r = Repository.init(dir.path(), vcs);
 243             assertTrue(r.commits().asList().isEmpty());
 244         }
 245     }
 246 
 247     @ParameterizedTest
 248     @EnumSource(VCS.class)
 249     void testCommitListingWithSingleCommit(VCS vcs) throws IOException {
 250         try (var dir = new TemporaryDirectory()) {
 251             var r = Repository.init(dir.path(), vcs);
 252 
 253             var readme = dir.path().resolve(&quot;README&quot;);
 254             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 255 
 256             r.add(readme);
 257 
 258             var committerName = vcs == VCS.GIT ? &quot;bot&quot; : &quot;duke&quot;;
 259             var committerEmail = vcs == VCS.GIT ? &quot;bot@openjdk.java.net&quot; : &quot;duke@openjdk.java.net&quot;;
 260             var hash = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;, committerName, committerEmail);
 261 
 262             var commits = r.commits().asList();
 263             assertEquals(1, commits.size());
 264 
 265             var commit = commits.get(0);
 266             assertEquals(&quot;duke&quot;, commit.author().name());
 267             assertEquals(&quot;duke@openjdk.java.net&quot;, commit.author().email());
 268             assertEquals(committerName, commit.committer().name());
 269             assertEquals(committerEmail, commit.committer().email());
 270 
 271             assertEquals(List.of(&quot;Add README&quot;), commit.message());
 272 
 273             assertEquals(1, commit.numParents());
 274             assertEquals(1, commit.parents().size());
 275 
 276             var nullHash = &quot;0&quot;.repeat(40);
 277             var parent = commit.parents().get(0);
 278             assertEquals(nullHash, parent.hex());
 279 
 280             assertTrue(commit.isInitialCommit());
 281             assertFalse(commit.isMerge());
 282             assertEquals(hash, commit.hash());
 283 
 284             var diffs = commit.parentDiffs();
 285             assertEquals(1, diffs.size());
 286 
 287             var diff = diffs.get(0);
 288             assertEquals(nullHash, diff.from().hex());
 289             assertEquals(hash, diff.to());
 290 
 291             assertEquals(0, diff.removed());
 292             assertEquals(0, diff.modified());
 293             assertEquals(1, diff.added());
 294 
 295             var patches = diff.patches();
 296             assertEquals(1, patches.size());
 297 
 298             var patch = patches.get(0).asTextualPatch();
 299             assertTrue(patch.status().isAdded());
 300 
 301             assertTrue(patch.source().path().isEmpty());
 302             assertTrue(patch.source().type().isEmpty());
 303 
 304             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 305             assertTrue(patch.target().type().get().isRegularNonExecutable());
 306 
 307             var hunks = patch.hunks();
 308             assertEquals(1, hunks.size());
 309 
 310             var hunk = hunks.get(0);
 311             assertEquals(new Range(0, 0), hunk.source().range());
 312             assertEquals(new Range(1, 1), hunk.target().range());
 313 
 314             assertEquals(List.of(), hunk.source().lines());
 315             assertLinesEquals(List.of(&quot;Hello, readme!&quot;), hunk.target().lines());
 316         }
 317     }
 318 
 319     static void assertLinesEquals(List&lt;String&gt; expected, List&lt;String&gt; actual) {
 320         var newLine = System.lineSeparator();
 321         var suffix = newLine.endsWith(&quot;\n&quot;)
 322                 ? newLine.substring(0, newLine.length() - 1) // drop trailing &#39;\n&#39; (keeping any &#39;\r&#39;)
 323                 : newLine;
 324         assertEquals(expected.stream().map(l -&gt; l + suffix).collect(Collectors.toList()), actual);
 325     }
 326 
 327     @ParameterizedTest
 328     @EnumSource(VCS.class)
 329     void testCommitListingWithMultipleCommits(VCS vcs) throws IOException {
 330         try (var dir = new TemporaryDirectory()) {
 331             var r = Repository.init(dir.path(), vcs);
 332 
 333             var readme = dir.path().resolve(&quot;README&quot;);
 334             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 335 
 336             r.add(readme);
 337             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 338 
 339             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 340             r.add(readme);
 341             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 342 
 343             var commits = r.commits().asList();
 344             assertEquals(2, commits.size());
 345 
 346             var commit = commits.get(0);
 347             assertEquals(&quot;duke&quot;, commit.author().name());
 348             assertEquals(&quot;duke@openjdk.java.net&quot;, commit.author().email());
 349 
 350             assertEquals(List.of(&quot;Modify README&quot;), commit.message());
 351 
 352             assertEquals(1, commit.numParents());
 353             assertEquals(1, commit.parents().size());
 354 
 355             var parent = commit.parents().get(0);
 356             assertEquals(hash1, parent);
 357 
 358             assertFalse(commit.isInitialCommit());
 359             assertFalse(commit.isMerge());
 360             assertEquals(hash2, commit.hash());
 361 
 362             var diffs = commit.parentDiffs();
 363             assertEquals(1, diffs.size());
 364 
 365             var diff = diffs.get(0);
 366             assertEquals(hash1, diff.from());
 367             assertEquals(hash2, diff.to());
 368 
 369             assertEquals(0, diff.removed());
 370             assertEquals(0, diff.modified());
 371             assertEquals(1, diff.added());
 372 
 373             var patches = diff.patches();
 374             assertEquals(1, patches.size());
 375 
 376             var patch = patches.get(0).asTextualPatch();
 377             assertTrue(patch.status().isModified());
 378             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 379             assertTrue(patch.source().type().get().isRegularNonExecutable());
 380             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 381             assertTrue(patch.target().type().get().isRegularNonExecutable());
 382 
 383             var hunks = patch.hunks();
 384             assertEquals(1, hunks.size());
 385 
 386             var hunk = hunks.get(0);
 387             assertEquals(new Range(2, 0), hunk.source().range());
 388             assertEquals(new Range(2, 1), hunk.target().range());
 389 
 390             assertEquals(List.of(), hunk.source().lines());
 391             assertLinesEquals(List.of(&quot;Another line&quot;), hunk.target().lines());
 392         }
 393     }
 394 
 395     @ParameterizedTest
 396     @EnumSource(VCS.class)
 397     void testSquashDeletes(VCS vcs) throws IOException {
 398         try (var dir = new TemporaryDirectory()) {
 399             var r = Repository.init(dir.path(), vcs);
 400 
 401             var file1 = dir.path().resolve(&quot;file1.txt&quot;);
 402             Files.write(file1, List.of(&quot;Hello, file 1!&quot;));
 403             var file2 = dir.path().resolve(&quot;file2.txt&quot;);
 404             Files.write(file2, List.of(&quot;Hello, file 2!&quot;));
 405             var file3 = dir.path().resolve(&quot;file3.txt&quot;);
 406             Files.write(file3, List.of(&quot;Hello, file 3!&quot;));
 407 
 408             r.add(file1, file2, file3);
 409             var hash1 = r.commit(&quot;Add files&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 410 
 411             Files.delete(file2);
 412             r.remove(file2);
 413             var hash2 = r.commit(&quot;Remove file 2&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 414 
 415             Files.delete(file3);
 416             r.remove(file3);
 417             var hash3 = r.commit(&quot;Remove file 3&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 418 
 419             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 420             assertEquals(3, r.commits(refspec).asList().size());
 421 
 422             r.checkout(hash1, false);
 423             r.squash(hash3);
 424             r.commit(&quot;Squashed remove of file 2 and 3&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 425 
 426             refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 427             var commits = r.commits(refspec).asList();
 428             assertEquals(2, commits.size());
 429 
 430             assertEquals(hash1, commits.get(1).hash());
 431 
 432             var head = commits.get(0);
 433             assertNotEquals(hash2, head);
 434             assertNotEquals(hash3, head);
 435 
 436             assertEquals(hash1, head.parents().get(0));
 437             assertFalse(head.isInitialCommit());
 438             assertFalse(head.isMerge());
 439 
 440             var diffs = head.parentDiffs();
 441             assertEquals(1, diffs.size());
 442 
 443             var diff = diffs.get(0);
 444             assertEquals(hash1, diff.from());
 445             assertEquals(head.hash(), diff.to());
 446 
 447             assertEquals(2, diff.removed());
 448             assertEquals(0, diff.modified());
 449             assertEquals(0, diff.added());
 450         }
 451     }
 452 
 453     @ParameterizedTest
 454     @EnumSource(VCS.class)
 455     void testSquash(VCS vcs) throws IOException {
 456         try (var dir = new TemporaryDirectory()) {
 457             var r = Repository.init(dir.path(), vcs);
 458 
 459             var readme = dir.path().resolve(&quot;README&quot;);
 460             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 461 
 462             r.add(readme);
 463             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 464 
 465             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 466             r.add(readme);
 467             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 468 
 469             Files.write(readme, List.of(&quot;A final line&quot;), WRITE, APPEND);
 470             r.add(readme);
 471             var hash3 = r.commit(&quot;Modify README again&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 472 
 473             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 474             assertEquals(3, r.commits(refspec).asList().size());
 475 
 476             r.checkout(hash1, false);
 477             r.squash(hash3);
 478             r.commit(&quot;Squashed commits 2 and 3&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 479 
 480             refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 481             var commits = r.commits(refspec).asList();
 482             assertEquals(2, commits.size());
 483 
 484             assertEquals(hash1, commits.get(1).hash());
 485 
 486             var head = commits.get(0);
 487             assertNotEquals(hash2, head);
 488             assertNotEquals(hash3, head);
 489 
 490             assertEquals(hash1, head.parents().get(0));
 491             assertFalse(head.isInitialCommit());
 492             assertFalse(head.isMerge());
 493 
 494             var diffs = head.parentDiffs();
 495             assertEquals(1, diffs.size());
 496 
 497             var diff = diffs.get(0);
 498             assertEquals(hash1, diff.from());
 499             assertEquals(head.hash(), diff.to());
 500 
 501             assertEquals(0, diff.removed());
 502             assertEquals(0, diff.modified());
 503             assertEquals(2, diff.added());
 504 
 505             var patches = diff.patches();
 506             assertEquals(1, patches.size());
 507 
 508             var patch = patches.get(0).asTextualPatch();
 509             assertTrue(patch.status().isModified());
 510             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 511             assertTrue(patch.source().type().get().isRegularNonExecutable());
 512             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 513             assertTrue(patch.target().type().get().isRegularNonExecutable());
 514 
 515             var hunks = patch.hunks();
 516             assertEquals(1, hunks.size());
 517 
 518             var hunk = hunks.get(0);
 519             assertEquals(new Range(2, 0), hunk.source().range());
 520             assertEquals(new Range(2, 2), hunk.target().range());
 521 
 522             assertEquals(List.of(), hunk.source().lines());
 523             assertLinesEquals(List.of(&quot;Another line&quot;, &quot;A final line&quot;), hunk.target().lines());
 524         }
 525     }
 526 
 527     @ParameterizedTest
 528     @EnumSource(VCS.class)
 529     void testMergeBase(VCS vcs) throws IOException {
 530         try (var dir = new TemporaryDirectory()) {
 531             var r = Repository.init(dir.path(), vcs);
 532 
 533             var readme = dir.path().resolve(&quot;README&quot;);
 534             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 535 
 536             r.add(readme);
 537             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 538 
 539             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 540             r.add(readme);
 541             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 542 
 543             r.checkout(hash1, false);
 544             Files.write(readme, List.of(&quot;A conflicting line&quot;), WRITE, APPEND);
 545             r.add(readme);
 546             var hash3 = r.commit(&quot;Branching README modification&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 547 
 548             assertEquals(hash1, r.mergeBase(hash2, hash3));
 549         }
 550     }
 551 
 552     @ParameterizedTest
 553     @EnumSource(VCS.class)
 554     void testRebase(VCS vcs) throws IOException {
 555         try (var dir = new TemporaryDirectory()) {
 556             var r = Repository.init(dir.path(), vcs);
 557 
 558             var readme = dir.path().resolve(&quot;README&quot;);
 559             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 560 
 561             r.add(readme);
 562             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 563 
 564             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 565             r.add(readme);
 566             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 567 
 568             r.checkout(hash1, false);
 569 
 570             var contributing = dir.path().resolve(&quot;CONTRIBUTING&quot;);
 571             Files.write(contributing, List.of(&quot;Keep the patches coming&quot;));
 572             r.add(contributing);
 573             var hash3 = r.commit(&quot;Add independent change&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 574 
 575             var committerName = vcs == VCS.GIT ? &quot;bot&quot; : &quot;duke&quot;;
 576             var committerEmail = vcs == VCS.GIT ? &quot;bot@openjdk.java.net&quot; : &quot;duke@openjdk.java.net&quot;;
 577             r.rebase(hash2, committerName, committerEmail);
 578 
 579             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 580             var commits = r.commits(refspec).asList();
 581             assertEquals(3, commits.size());
 582             assertEquals(hash2, commits.get(1).hash());
 583             assertEquals(hash1, commits.get(2).hash());
 584 
 585             assertEquals(&quot;duke&quot;, commits.get(0).author().name());
 586             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(0).author().email());
 587             assertEquals(committerName, commits.get(0).committer().name());
 588             assertEquals(committerEmail, commits.get(0).committer().email());
 589 
 590             assertEquals(&quot;duke&quot;, commits.get(1).author().name());
 591             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(1).author().email());
 592             assertEquals(&quot;duke&quot;, commits.get(1).committer().name());
 593             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(1).committer().email());
 594 
 595             assertEquals(&quot;duke&quot;, commits.get(2).author().name());
 596             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(2).author().email());
 597             assertEquals(&quot;duke&quot;, commits.get(2).committer().name());
 598             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(2).committer().email());
 599 
 600             var head = commits.get(0);
 601             assertEquals(hash2, head.parents().get(0));
 602             assertEquals(List.of(&quot;Add independent change&quot;), head.message());
 603 
 604             var diffs = head.parentDiffs();
 605             assertEquals(1, diffs.size());
 606             var diff = diffs.get(0);
 607 
 608             assertEquals(0, diff.removed());
 609             assertEquals(0, diff.modified());
 610             assertEquals(1, diff.added());
 611 
 612             var patches = diff.patches();
 613             assertEquals(1, patches.size());
 614             var patch = patches.get(0).asTextualPatch();
 615             assertEquals(Path.of(&quot;CONTRIBUTING&quot;), patch.target().path().get());
 616 
 617             var hunks = patch.hunks();
 618             assertEquals(1, hunks.size());
 619             var hunk = hunks.get(0);
 620             assertLinesEquals(List.of(&quot;Keep the patches coming&quot;), hunk.target().lines());
 621         }
 622     }
 623 
 624     @ParameterizedTest
 625     @EnumSource(VCS.class)
 626     void testInitializedRepositoryIsEmpty(VCS vcs) throws IOException {
 627         try (var dir = new TemporaryDirectory()) {
 628             var r = Repository.init(dir.path(), vcs);
 629             assertTrue(r.isEmpty());
 630         }
 631     }
 632 
 633     @ParameterizedTest
 634     @EnumSource(VCS.class)
 635     void testRepositoryWithCommitIsNonEmpty(VCS vcs) throws IOException {
 636         try (var dir = new TemporaryDirectory()) {
 637             var r = Repository.init(dir.path(), vcs);
 638 
 639             var readme = dir.path().resolve(&quot;README&quot;);
 640             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 641 
 642             r.add(readme);
 643             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 644 
 645             assertFalse(r.isEmpty());
 646         }
 647     }
 648 
 649     @ParameterizedTest
 650     @EnumSource(VCS.class)
 651     void testEmptyRepositoryIsHealthy(VCS vcs) throws IOException {
 652         try (var dir = new TemporaryDirectory()) {
 653             var r = Repository.init(dir.path(), vcs);
 654             assertTrue(r.isHealthy());
 655         }
 656     }
 657 
 658     @ParameterizedTest
 659     @EnumSource(VCS.class)
 660     void testNonEmptyRepositoryIsHealthy(VCS vcs) throws IOException {
 661         try (var dir = new TemporaryDirectory()) {
 662             var r = Repository.init(dir.path(), vcs);
 663 
 664             var readme = dir.path().resolve(&quot;README&quot;);
 665             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 666 
 667             r.add(readme);
 668             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 669 
 670             assertTrue(r.isHealthy());
 671         }
 672     }
 673 
 674     @ParameterizedTest
 675     @EnumSource(VCS.class)
 676     void testNonCheckedOutRepositoryIsHealthy(VCS vcs) throws IOException {
 677         try (var dir1 = new TemporaryDirectory();
 678              var dir2 = new TemporaryDirectory()) {
 679             var r1 = Repository.init(dir1.path(), vcs);
 680 
 681             var readme = dir1.path().resolve(&quot;README&quot;);
 682             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 683 
 684             r1.add(readme);
 685             var hash = r1.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 686             r1.tag(hash, &quot;tag&quot;, &quot;tagging&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 687 
 688             var r2 = Repository.init(dir2.path(), vcs);
 689             r2.fetch(r1.root().toUri(), r1.defaultBranch().name());
 690 
 691             assertTrue(r2.isHealthy());
 692         }
 693     }
 694 
 695     @ParameterizedTest
 696     @EnumSource(VCS.class)
 697     void testBranchesOnEmptyRepository(VCS vcs) throws IOException {
 698         try (var dir = new TemporaryDirectory()) {
 699             var r = Repository.init(dir.path(), vcs);
 700             var expected = vcs == VCS.GIT ? List.of() : List.of(new Branch(&quot;default&quot;));
 701             assertEquals(List.of(), r.branches());
 702         }
 703     }
 704 
 705     @ParameterizedTest
 706     @EnumSource(VCS.class)
 707     void testBranchesOnNonEmptyRepository(VCS vcs) throws IOException {
 708         try (var dir = new TemporaryDirectory()) {
 709             var r = Repository.init(dir.path(), vcs);
 710 
 711             var readme = dir.path().resolve(&quot;README&quot;);
 712             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 713 
 714             r.add(readme);
 715             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 716 
 717             assertEquals(List.of(r.defaultBranch()), r.branches());
 718         }
 719     }
 720 
 721     @ParameterizedTest
 722     @EnumSource(VCS.class)
 723     void testTagsOnEmptyRepository(VCS vcs) throws IOException {
 724         try (var dir = new TemporaryDirectory()) {
 725             var r = Repository.init(dir.path(), vcs);
 726             var expected = vcs == VCS.GIT ? List.of() : List.of(new Tag(&quot;tip&quot;));
 727             assertEquals(expected, r.tags());
 728         }
 729     }
 730 
 731     @ParameterizedTest
 732     @EnumSource(VCS.class)
 733     void testTagsOnNonEmptyRepository(VCS vcs) throws IOException {
 734         try (var dir = new TemporaryDirectory()) {
 735             var r = Repository.init(dir.path(), vcs);
 736 
 737             var readme = dir.path().resolve(&quot;README&quot;);
 738             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 739 
 740             r.add(readme);
 741             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 742 
 743             var expected = vcs == VCS.GIT ? List.of() : List.of(new Tag(&quot;tip&quot;));
 744             assertEquals(expected, r.tags());
 745         }
 746     }
 747 
 748     @ParameterizedTest
 749     @EnumSource(VCS.class)
 750     void testFetchAndPush(VCS vcs) throws IOException {
 751         try (var dir = new TemporaryDirectory()) {
 752             var upstream = Repository.init(dir.path(), vcs);
 753 
 754             if (vcs == VCS.GIT) {
 755                 Files.write(upstream.root().resolve(&quot;.git&quot;).resolve(&quot;config&quot;),
 756                             List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch=ignore&quot;),
 757                             WRITE, APPEND);
 758             }
 759 
 760             var readme = dir.path().resolve(&quot;README&quot;);
 761             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 762 
 763             upstream.add(readme);
 764             upstream.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 765 
 766             try (var dir2 = new TemporaryDirectory()) {
 767                 var downstream = Repository.init(dir2.path(), vcs);
 768 
 769                  // note: forcing unix path separators for URI
 770                 var upstreamURI = URI.create(&quot;file:///&quot; + dir.toString().replace(&#39;\\&#39;, &#39;/&#39;));
 771 
 772                 var fetchHead = downstream.fetch(upstreamURI, downstream.defaultBranch().name());
 773                 downstream.checkout(fetchHead, false);
 774 
 775                 var downstreamReadme = dir2.path().resolve(&quot;README&quot;);
 776                 Files.write(downstreamReadme, List.of(&quot;Downstream change&quot;), WRITE, APPEND);
 777 
 778                 downstream.add(downstreamReadme);
 779                 var head = downstream.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 780 
 781                 downstream.push(head, upstreamURI, downstream.defaultBranch().name());
 782             }
 783 
 784             upstream.checkout(upstream.resolve(upstream.defaultBranch().name()).get(), false);
 785 
 786             var commits = upstream.commits().asList();
 787             assertEquals(2, commits.size());
 788         }
 789     }
 790 
 791     @ParameterizedTest
 792     @EnumSource(VCS.class)
 793     void testClean(VCS vcs) throws IOException {
 794         try (var dir = new TemporaryDirectory()) {
 795             var r = Repository.init(dir.path(), vcs);
 796             r.clean();
 797 
 798             var readme = dir.path().resolve(&quot;README&quot;);
 799             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 800 
 801             r.add(readme);
 802             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 803 
 804             r.clean();
 805 
 806             assertEquals(hash1, r.head());
 807 
 808             Files.write(readme, List.of(&quot;A random change&quot;), WRITE, APPEND);
 809 
 810             r.clean();
 811 
 812             assertEquals(List.of(&quot;Hello, readme!&quot;), Files.readAllLines(readme));
 813 
 814             var untracked = dir.path().resolve(&quot;UNTRACKED&quot;);
 815             Files.write(untracked, List.of(&quot;Random text&quot;));
 816 
 817             r.clean();
 818 
 819             assertFalse(Files.exists(untracked));
 820 
 821             // Mercurial cannot currently deal with this situation
 822             if (vcs != VCS.HG) {
 823                 var subRepo = Repository.init(dir.path().resolve(&quot;submodule&quot;), vcs);
 824                 var subRepoFile = subRepo.root().resolve(&quot;file.txt&quot;);
 825                 Files.write(subRepoFile, List.of(&quot;Looks like a file in a submodule&quot;));
 826 
 827                 r.clean();
 828 
 829                 assertFalse(Files.exists(subRepoFile));
 830             }
 831         }
 832     }
 833 
 834     @ParameterizedTest
 835     @EnumSource(VCS.class)
 836     void testCleanIgnored(VCS vcs) throws IOException {
 837         try (var dir = new TemporaryDirectory()) {
 838             var r = Repository.init(dir.path(), vcs);
 839             r.clean();
 840 
 841             var readme = dir.path().resolve(&quot;README&quot;);
 842             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 843             Files.write(dir.path().resolve(&quot;.gitignore&quot;), List.of(&quot;*.txt&quot;));
 844             Files.write(dir.path().resolve(&quot;.hgignore&quot;), List.of(&quot;.*txt&quot;));
 845 
 846             r.add(readme);
 847             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 848 
 849             var ignored = dir.path().resolve(&quot;ignored.txt&quot;);
 850             Files.write(ignored, List.of(&quot;Random text&quot;));
 851 
 852             r.clean();
 853 
 854             assertFalse(Files.exists(ignored));
 855         }
 856     }
 857 
 858     @ParameterizedTest
 859     @EnumSource(VCS.class)
 860     void testDiffBetweenCommits(VCS vcs) throws IOException {
 861         try (var dir = new TemporaryDirectory()) {
 862             var r = Repository.init(dir.path(), vcs);
 863 
 864             var readme = dir.path().resolve(&quot;README&quot;);
 865             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 866 
 867             r.add(readme);
 868             var first = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 869 
 870             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
 871             r.add(readme);
 872             var second = r.commit(&quot;Add one more line&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 873 
 874             var diff = r.diff(first, second);
 875             assertEquals(first, diff.from());
 876             assertEquals(second, diff.to());
 877 
 878             var patches = diff.patches();
 879             assertEquals(1, patches.size());
 880 
 881             var patch = patches.get(0).asTextualPatch();
 882             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 883             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 884             assertTrue(patch.source().type().get().isRegularNonExecutable());
 885             assertTrue(patch.target().type().get().isRegularNonExecutable());
 886             assertTrue(patch.status().isModified());
 887 
 888             var hunks = patch.hunks();
 889             assertEquals(1, hunks.size());
 890 
 891             var hunk = hunks.get(0);
 892             assertEquals(2, hunk.source().range().start());
 893             assertEquals(0, hunk.source().range().count());
 894             assertEquals(0, hunk.source().lines().size());
 895 
 896             assertEquals(2, hunk.target().range().start());
 897             assertEquals(1, hunk.target().range().count());
 898             assertLinesEquals(List.of(&quot;One more line&quot;), hunk.target().lines());
 899 
 900             assertEquals(1, hunk.added());
 901             assertEquals(0, hunk.removed());
 902             assertEquals(0, hunk.modified());
 903         }
 904     }
 905 
 906     @ParameterizedTest
 907     @EnumSource(VCS.class)
 908     void testDiffBetweenCommitsWithMultiplePatches(VCS vcs) throws IOException {
 909         try (var dir = new TemporaryDirectory()) {
 910             var r = Repository.init(dir.path(), vcs);
 911 
 912             var readme = dir.path().resolve(&quot;README&quot;);
 913             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 914 
 915             var building = dir.path().resolve(&quot;BUILDING&quot;);
 916             Files.write(building, List.of(&quot;make&quot;));
 917 
 918             r.add(readme);
 919             r.add(building);
 920             var first = r.commit(&quot;Add README and BUILDING&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 921 
 922             Files.write(readme, List.of(&quot;Hello, Skara!&quot;), WRITE, TRUNCATE_EXISTING);
 923             Files.write(building, List.of(&quot;make images&quot;), WRITE, TRUNCATE_EXISTING);
 924             r.add(readme);
 925             r.add(building);
 926             var second = r.commit(&quot;Modify README and BUILDING&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 927 
 928             var diff = r.diff(first, second);
 929             assertEquals(first, diff.from());
 930             assertEquals(second, diff.to());
 931 
 932             var patches = diff.patches();
 933             assertEquals(2, patches.size());
 934 
 935             var patch1 = patches.get(0).asTextualPatch();
 936             assertEquals(Path.of(&quot;BUILDING&quot;), patch1.source().path().get());
 937             assertEquals(Path.of(&quot;BUILDING&quot;), patch1.target().path().get());
 938             assertTrue(patch1.source().type().get().isRegularNonExecutable());
 939             assertTrue(patch1.target().type().get().isRegularNonExecutable());
 940             assertTrue(patch1.status().isModified());
 941 
 942             var hunks1 = patch1.hunks();
 943             assertEquals(1, hunks1.size());
 944 
 945             var hunk1 = hunks1.get(0);
 946             assertEquals(1, hunk1.source().range().start());
 947             assertEquals(1, hunk1.source().range().count());
 948             assertLinesEquals(List.of(&quot;make&quot;), hunk1.source().lines());
 949 
 950             assertEquals(1, hunk1.target().range().start());
 951             assertEquals(1, hunk1.target().range().count());
 952             assertLinesEquals(List.of(&quot;make images&quot;), hunk1.target().lines());
 953 
 954             var patch2 = patches.get(1).asTextualPatch();
 955             assertEquals(Path.of(&quot;README&quot;), patch2.source().path().get());
 956             assertEquals(Path.of(&quot;README&quot;), patch2.target().path().get());
 957             assertTrue(patch2.source().type().get().isRegularNonExecutable());
 958             assertTrue(patch2.target().type().get().isRegularNonExecutable());
 959             assertTrue(patch2.status().isModified());
 960 
 961             var hunks2 = patch2.hunks();
 962             assertEquals(1, hunks2.size());
 963 
 964             var hunk2 = hunks2.get(0);
 965             assertEquals(1, hunk2.source().range().start());
 966             assertEquals(1, hunk2.source().range().count());
 967             assertLinesEquals(List.of(&quot;Hello, readme!&quot;), hunk2.source().lines());
 968 
 969             assertEquals(1, hunk2.target().range().start());
 970             assertEquals(1, hunk2.target().range().count());
 971             assertLinesEquals(List.of(&quot;Hello, Skara!&quot;), hunk2.target().lines());
 972         }
 973     }
 974 
 975     @ParameterizedTest
 976     @EnumSource(VCS.class)
 977     void testDiffBetweenCommitsWithMultipleHunks(VCS vcs) throws IOException {
 978         try (var dir = new TemporaryDirectory()) {
 979             var r = Repository.init(dir.path(), vcs);
 980 
 981             var abc = dir.path().resolve(&quot;abc.txt&quot;);
 982             Files.write(abc, List.of(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;));
 983 
 984             r.add(abc);
 985             var first = r.commit(&quot;Added ABC&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 986 
 987             Files.write(abc, List.of(&quot;1&quot;, &quot;2&quot;, &quot;B&quot;, &quot;3&quot;), WRITE, TRUNCATE_EXISTING);
 988             r.add(abc);
 989             var second = r.commit(&quot;Modify A and C&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 990 
 991             var diff = r.diff(first, second);
 992             assertEquals(first, diff.from());
 993             assertEquals(second, diff.to());
 994 
 995             var patches = diff.patches();
 996             assertEquals(1, patches.size());
 997 
 998             var patch = patches.get(0).asTextualPatch();
 999             assertEquals(Path.of(&quot;abc.txt&quot;), patch.source().path().get());
1000             assertEquals(Path.of(&quot;abc.txt&quot;), patch.target().path().get());
1001             assertTrue(patch.source().type().get().isRegularNonExecutable());
1002             assertTrue(patch.target().type().get().isRegularNonExecutable());
1003             assertTrue(patch.status().isModified());
1004 
1005             var hunks = patch.hunks();
1006             assertEquals(2, hunks.size());
1007 
1008             var hunk1 = hunks.get(0);
1009             assertEquals(1, hunk1.source().range().start());
1010             assertEquals(1, hunk1.source().range().count());
1011             assertLinesEquals(List.of(&quot;A&quot;), hunk1.source().lines());
1012 
1013             assertEquals(1, hunk1.target().range().start());
1014             assertEquals(2, hunk1.target().range().count());
1015             assertLinesEquals(List.of(&quot;1&quot;, &quot;2&quot;), hunk1.target().lines());
1016 
1017             assertEquals(1, hunk1.added());
1018             assertEquals(0, hunk1.removed());
1019             assertEquals(1, hunk1.modified());
1020 
1021             var hunk2 = hunks.get(1);
1022             assertEquals(3, hunk2.source().range().start());
1023             assertEquals(1, hunk2.source().range().count());
1024             assertLinesEquals(List.of(&quot;C&quot;), hunk2.source().lines());
1025 
1026             assertEquals(4, hunk2.target().range().start());
1027             assertEquals(1, hunk2.target().range().count());
1028             assertLinesEquals(List.of(&quot;3&quot;), hunk2.target().lines());
1029 
1030             assertEquals(0, hunk2.added());
1031             assertEquals(0, hunk2.removed());
1032             assertEquals(1, hunk2.modified());
1033         }
1034     }
1035 
1036     @ParameterizedTest
1037     @EnumSource(VCS.class)
1038     void testDiffWithRemoval(VCS vcs) throws IOException {
1039         try (var dir = new TemporaryDirectory()) {
1040             var r = Repository.init(dir.path(), vcs);
1041 
1042             var readme = dir.path().resolve(&quot;README&quot;);
1043             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1044 
1045             r.add(readme);
1046             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1047 
1048             Files.delete(readme);
1049             r.remove(readme);
1050             var second = r.commit(&quot;Removed README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1051 
1052             var diff = r.diff(first, second);
1053             assertEquals(first, diff.from());
1054             assertEquals(second, diff.to());
1055 
1056             var patches = diff.patches();
1057             assertEquals(1, patches.size());
1058 
1059             var patch = patches.get(0).asTextualPatch();
1060             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
1061             assertTrue(patch.target().path().isEmpty());
1062             assertTrue(patch.source().type().get().isRegularNonExecutable());
1063             assertTrue(patch.target().type().isEmpty());
1064             assertTrue(patch.status().isDeleted());
1065 
1066             var hunks = patch.hunks();
1067             assertEquals(1, hunks.size());
1068 
1069             var hunk = hunks.get(0);
1070             assertEquals(1, hunk.source().range().start());
1071             assertEquals(1, hunk.source().range().count());
1072             assertLinesEquals(List.of(&quot;Hello, world!&quot;), hunk.source().lines());
1073 
1074             assertEquals(0, hunk.target().range().start());
1075             assertEquals(0, hunk.target().range().count());
1076             assertEquals(List.of(), hunk.target().lines());
1077 
1078             assertEquals(0, hunk.added());
1079             assertEquals(1, hunk.removed());
1080             assertEquals(0, hunk.modified());
1081         }
1082     }
1083 
1084     @ParameterizedTest
1085     @EnumSource(VCS.class)
1086     void testDiffWithAddition(VCS vcs) throws IOException {
1087         try (var dir = new TemporaryDirectory()) {
1088             var r = Repository.init(dir.path(), vcs);
1089 
1090             var readme = dir.path().resolve(&quot;README&quot;);
1091             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1092 
1093             r.add(readme);
1094             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1095 
1096             var building = dir.path().resolve(&quot;BUILDING&quot;);
1097             Files.write(building, List.of(&quot;make&quot;));
1098             r.add(building);
1099             var second = r.commit(&quot;Added BUILDING&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1100 
1101             var diff = r.diff(first, second);
1102             assertEquals(first, diff.from());
1103             assertEquals(second, diff.to());
1104 
1105             var patches = diff.patches();
1106             assertEquals(1, patches.size());
1107 
1108             var patch = patches.get(0).asTextualPatch();
1109             assertTrue(patch.source().path().isEmpty());
1110             assertEquals(Path.of(&quot;BUILDING&quot;), patch.target().path().get());
1111             assertTrue(patch.source().type().isEmpty());
1112             assertTrue(patch.target().type().get().isRegularNonExecutable());
1113             assertTrue(patch.status().isAdded());
1114 
1115             var hunks = patch.hunks();
1116             assertEquals(1, hunks.size());
1117 
1118             var hunk = hunks.get(0);
1119             assertEquals(0, hunk.source().range().start());
1120             assertEquals(0, hunk.source().range().count());
1121             assertEquals(List.of(), hunk.source().lines());
1122 
1123             assertEquals(1, hunk.target().range().start());
1124             assertEquals(1, hunk.target().range().count());
1125             assertLinesEquals(List.of(&quot;make&quot;), hunk.target().lines());
1126 
1127             assertEquals(1, hunk.added());
1128             assertEquals(0, hunk.removed());
1129             assertEquals(0, hunk.modified());
1130         }
1131     }
1132 
1133     @ParameterizedTest
1134     @EnumSource(VCS.class)
1135     void testDiffWithWorkingDir(VCS vcs) throws IOException {
1136         try (var dir = new TemporaryDirectory()) {
1137             var r = Repository.init(dir.path(), vcs);
1138 
1139             var readme = dir.path().resolve(&quot;README&quot;);
1140             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1141 
1142             r.add(readme);
1143             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1144 
1145             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1146             var diff = r.diff(first);
1147 
1148             assertEquals(first, diff.from());
1149             assertNull(diff.to());
1150 
1151             var patches = diff.patches();
1152             assertEquals(1, patches.size());
1153 
1154             var patch = patches.get(0).asTextualPatch();
1155             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
1156             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
1157             assertTrue(patch.source().type().get().isRegularNonExecutable());
1158             assertTrue(patch.target().type().get().isRegularNonExecutable());
1159             assertTrue(patch.status().isModified());
1160 
1161             var hunks = patch.hunks();
1162             assertEquals(1, hunks.size());
1163 
1164             var hunk = hunks.get(0);
1165             assertEquals(2, hunk.source().range().start());
1166             assertEquals(0, hunk.source().range().count());
1167             assertEquals(List.of(), hunk.source().lines());
1168 
1169             assertEquals(2, hunk.target().range().start());
1170             assertEquals(1, hunk.target().range().count());
1171             assertLinesEquals(List.of(&quot;One more line&quot;), hunk.target().lines());
1172 
1173             assertEquals(1, hunk.added());
1174             assertEquals(0, hunk.removed());
1175             assertEquals(0, hunk.modified());
1176         }
1177     }
1178 
1179     @ParameterizedTest
1180     @EnumSource(VCS.class)
1181     void testCommitMetadata(VCS vcs) throws IOException {
1182         try (var dir = new TemporaryDirectory()) {
1183             var r = Repository.init(dir.path(), vcs);
1184 
1185             var readme = dir.path().resolve(&quot;README&quot;);
1186             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1187             r.add(readme);
1188             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1189 
1190             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1191             r.add(readme);
1192             var second = r.commit(&quot;Modified README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1193 
1194             var metadata = r.commitMetadata();
1195             assertEquals(2, metadata.size());
1196 
1197             assertEquals(first, metadata.get(0).hash());
1198             assertEquals(List.of(&quot;Added README&quot;), metadata.get(0).message());
1199 
1200             assertEquals(second, metadata.get(1).hash());
1201             assertEquals(List.of(&quot;Modified README&quot;), metadata.get(1).message());
1202         }
1203     }
1204 
1205     @ParameterizedTest
1206     @EnumSource(VCS.class)
1207     void testTrivialMerge(VCS vcs) throws IOException {
1208         try (var dir = new TemporaryDirectory()) {
1209             var r = Repository.init(dir.path(), vcs);
1210 
1211             var readme = dir.path().resolve(&quot;README&quot;);
1212             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1213             r.add(readme);
1214             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1215 
1216             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1217             r.add(readme);
1218             var second = r.commit(&quot;Modified README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1219 
1220             r.checkout(first, false);
1221 
1222             var contributing = dir.path().resolve(&quot;CONTRIBUTING&quot;);
1223             Files.write(contributing, List.of(&quot;Send those patches!&quot;));
1224             r.add(contributing);
1225             var third = r.commit(&quot;Added contributing&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1226 
1227             r.merge(second);
1228             r.commit(&quot;Merge&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1229 
1230             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
1231             var commits = r.commits(refspec).asList();
1232 
1233             assertEquals(4, commits.size());
1234 
1235             var merge = commits.get(0);
1236             assertEquals(List.of(&quot;Merge&quot;), merge.message());
1237 
1238             var parents = new HashSet&lt;&gt;(merge.parents());
1239             assertEquals(2, parents.size());
1240             assertTrue(parents.contains(second));
1241             assertTrue(parents.contains(third));
1242 
1243             var diffs = merge.parentDiffs();
1244             assertEquals(2, diffs.size());
1245 
1246             var diff1 = diffs.get(0);
1247             assertEquals(merge.hash(), diff1.to());
1248             assertEquals(0, diff1.patches().size());
1249             assertTrue(parents.contains(diff1.from()));
1250 
1251             var diff2 = diffs.get(1);
1252             assertEquals(merge.hash(), diff2.to());
1253             assertEquals(0, diff2.patches().size());
1254             assertTrue(parents.contains(diff2.from()));
1255         }
1256     }
1257 
1258     @ParameterizedTest
1259     @EnumSource(VCS.class)
1260     void testMergeWithEdit(VCS vcs) throws IOException {
1261         try (var dir = new TemporaryDirectory()) {
1262             var r = Repository.init(dir.path(), vcs);
1263 
1264             var readme = dir.path().resolve(&quot;README&quot;);
1265             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1266             r.add(readme);
1267             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1268 
1269             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1270             r.add(readme);
1271             var second = r.commit(&quot;Modified README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1272 
1273             r.checkout(first, false);
1274 
1275             var contributing = dir.path().resolve(&quot;CONTRIBUTING&quot;);
1276             Files.write(contributing, List.of(&quot;Send those patches!&quot;));
1277             r.add(contributing);
1278             var third = r.commit(&quot;Added contributing&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1279 
1280             r.merge(second);
1281 
1282             Files.write(readme, List.of(&quot;One last line&quot;), WRITE, APPEND);
1283             r.add(readme);
1284             r.commit(&quot;Merge&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1285 
1286             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
1287             var commits = r.commits(refspec).asList();
1288 
1289             assertEquals(4, commits.size());
1290 
1291             var merge = commits.get(0);
1292             assertEquals(List.of(&quot;Merge&quot;), merge.message());
1293 
1294             var parents = new HashSet&lt;&gt;(merge.parents());
1295             assertEquals(2, parents.size());
1296             assertTrue(parents.contains(second));
1297             assertTrue(parents.contains(third));
1298 
1299             var diffs = merge.parentDiffs();
1300             assertEquals(2, diffs.size());
1301 
1302             var secondDiff = diffs.stream().filter(d -&gt; d.from().equals(second)).findFirst().get();
1303             assertEquals(merge.hash(), secondDiff.to());
1304             assertEquals(1, secondDiff.patches().size());
1305             var secondPatch = secondDiff.patches().get(0).asTextualPatch();
1306 
1307             assertEquals(Path.of(&quot;README&quot;), secondPatch.source().path().get());
1308             assertEquals(Path.of(&quot;README&quot;), secondPatch.target().path().get());
1309             assertTrue(secondPatch.status().isModified());
1310             assertEquals(1, secondPatch.hunks().size());
1311 
1312             var secondHunk = secondPatch.hunks().get(0);
1313             assertEquals(List.of(), secondHunk.source().lines());
1314             assertLinesEquals(List.of(&quot;One last line&quot;), secondHunk.target().lines());
1315 
1316             assertEquals(3, secondHunk.source().range().start());
1317             assertEquals(0, secondHunk.source().range().count());
1318             assertEquals(3, secondHunk.target().range().start());
1319             assertEquals(1, secondHunk.target().range().count());
1320 
1321             var thirdDiff = diffs.stream().filter(d -&gt; d.from().equals(third)).findFirst().get();
1322             assertEquals(merge.hash(), thirdDiff.to());
1323             assertEquals(1, thirdDiff.patches().size());
1324             var thirdPatch = thirdDiff.patches().get(0).asTextualPatch();
1325 
1326             assertEquals(Path.of(&quot;README&quot;), thirdPatch.source().path().get());
1327             assertEquals(Path.of(&quot;README&quot;), thirdPatch.target().path().get());
1328             assertTrue(thirdPatch.status().isModified());
1329             assertEquals(1, thirdPatch.hunks().size());
1330 
1331             var thirdHunk = thirdPatch.hunks().get(0);
1332             assertEquals(List.of(), thirdHunk.source().lines());
1333             assertLinesEquals(List.of(&quot;One more line&quot;, &quot;One last line&quot;), thirdHunk.target().lines());
1334 
1335             assertEquals(2, thirdHunk.source().range().start());
1336             assertEquals(0, thirdHunk.source().range().count());
1337             assertEquals(2, thirdHunk.target().range().start());
1338             assertEquals(2, thirdHunk.target().range().count());
1339         }
1340     }
1341 
1342     @ParameterizedTest
1343     @EnumSource(VCS.class)
1344     void testDefaultBranch(VCS vcs) throws IOException {
1345         try (var dir = new TemporaryDirectory()) {
1346             var r = Repository.init(dir.path(), vcs);
1347             var expected = vcs == VCS.GIT ? &quot;master&quot; : &quot;default&quot;;
1348             assertEquals(expected, r.defaultBranch().name());
1349         }
1350     }
1351 
1352     @ParameterizedTest
1353     @EnumSource(VCS.class)
1354     void testPaths(VCS vcs) throws IOException {
1355         try (var dir = new TemporaryDirectory()) {
1356             var r = Repository.init(dir.path(), vcs);
1357             var remote = vcs == VCS.GIT ? &quot;origin&quot; : &quot;default&quot;;
1358             r.setPaths(remote, &quot;http://pull&quot;, &quot;http://push&quot;);
1359             assertEquals(&quot;http://pull&quot;, r.pullPath(remote));
1360             assertEquals(&quot;http://push&quot;, r.pushPath(remote));
1361         }
1362     }
1363 
1364     @ParameterizedTest
1365     @EnumSource(VCS.class)
1366     void testIsValidRevisionRange(VCS vcs) throws IOException {
1367         try (var dir = new TemporaryDirectory()) {
1368             var r = Repository.init(dir.path(), vcs);
1369             assertFalse(r.isValidRevisionRange(&quot;foo&quot;));
1370 
1371             var readme = dir.path().resolve(&quot;README&quot;);
1372             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1373             r.add(readme);
1374             r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1375 
1376             assertTrue(r.isValidRevisionRange(r.defaultBranch().toString()));
1377         }
1378     }
1379 
1380     @ParameterizedTest
1381     @EnumSource(VCS.class)
1382     void testDefaultTag(VCS vcs) throws IOException {
1383         try (var dir = new TemporaryDirectory()) {
1384             var r = Repository.init(dir.path(), vcs);
1385             var expected = vcs == VCS.GIT ? Optional.empty() : Optional.of(new Tag(&quot;tip&quot;));
1386             assertEquals(expected, r.defaultTag());
1387         }
1388     }
1389 
1390     @ParameterizedTest
1391     @EnumSource(VCS.class)
1392     void testTag(VCS vcs) throws IOException {
1393         try (var dir = new TemporaryDirectory()) {
1394             var r = Repository.init(dir.path(), vcs);
1395 
1396             var readme = dir.path().resolve(&quot;README&quot;);
1397             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1398             r.add(readme);
1399             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1400 
1401             r.tag(first, &quot;test&quot;, &quot;Tagging test&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1402             var defaultTag = r.defaultTag().orElse(null);
1403             var nonDefaultTags = r.tags().stream()
1404                                   .filter(tag -&gt; !tag.equals(defaultTag))
1405                                   .map(Tag::toString)
1406                                   .collect(Collectors.toList());
1407             assertEquals(List.of(&quot;test&quot;), nonDefaultTags);
1408         }
1409     }
1410 
1411     @ParameterizedTest
1412     @EnumSource(VCS.class)
1413     void testIsClean(VCS vcs) throws IOException {
1414         try (var dir = new TemporaryDirectory()) {
1415             var r = Repository.init(dir.path(), vcs);
1416             assertTrue(r.isClean());
1417 
1418             var readme = dir.path().resolve(&quot;README&quot;);
1419             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1420             assertFalse(r.isClean());
1421 
1422             r.add(readme);
1423             assertFalse(r.isClean());
1424 
1425             r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1426             assertTrue(r.isClean());
1427 
1428             Files.delete(readme);
1429             assertFalse(r.isClean());
1430 
1431             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1432             assertTrue(r.isClean());
1433         }
1434     }
1435 
1436     @ParameterizedTest
1437     @EnumSource(VCS.class)
1438     void testShowOnExecutableFiles(VCS vcs) throws IOException {
1439         try (var dir = new TemporaryDirectory()) {
1440             var r = Repository.init(dir.path(), vcs);
1441             assertTrue(r.isClean());
1442 
1443             var readOnlyExecutableFile = dir.path().resolve(&quot;hello.sh&quot;);
1444             Files.write(readOnlyExecutableFile, List.of(&quot;echo &#39;hello&#39;&quot;));
1445             if (readOnlyExecutableFile.getFileSystem().supportedFileAttributeViews().contains(&quot;posix&quot;)) {
1446                 var permissions = PosixFilePermissions.fromString(&quot;r-xr-xr-x&quot;);
1447                 Files.setPosixFilePermissions(readOnlyExecutableFile, permissions);
1448             }
1449             r.add(readOnlyExecutableFile);
1450             var hash = r.commit(&quot;Added read only executable file&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1451             assertEquals(Optional.of(List.of(&quot;echo &#39;hello&#39;&quot;)), r.lines(readOnlyExecutableFile, hash));
1452 
1453             var readWriteExecutableFile = dir.path().resolve(&quot;goodbye.sh&quot;);
1454             Files.write(readWriteExecutableFile, List.of(&quot;echo &#39;goodbye&#39;&quot;));
1455             if (readOnlyExecutableFile.getFileSystem().supportedFileAttributeViews().contains(&quot;posix&quot;)) {
1456                 var permissions = PosixFilePermissions.fromString(&quot;rwxrwxrwx&quot;);
1457                 Files.setPosixFilePermissions(readWriteExecutableFile, permissions);
1458             }
1459             r.add(readWriteExecutableFile);
1460             var hash2 = r.commit(&quot;Added read-write executable file&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1461             assertEquals(Optional.of(List.of(&quot;echo &#39;goodbye&#39;&quot;)), r.lines(readWriteExecutableFile, hash2));
1462         }
1463     }
1464 
1465     @Test
1466     void testGetAndExistsOnNonExistingDirectory() throws IOException {
1467         var nonExistingDirectory = Path.of(&quot;this&quot;, &quot;does&quot;, &quot;not&quot;, &quot;exist&quot;);
1468         assertEquals(Optional.empty(), Repository.get(nonExistingDirectory));
1469         assertEquals(false, Repository.exists(nonExistingDirectory));
1470     }
1471 
1472     @ParameterizedTest
1473     @EnumSource(VCS.class)
1474     void testDiffOnFilenamesWithSpace(VCS vcs) throws IOException {
1475         try (var dir = new TemporaryDirectory()) {
1476             var r = Repository.init(dir.path(), vcs);
1477             assertTrue(r.isClean());
1478 
1479             var fileWithSpaceInName = dir.path().resolve(&quot;hello world.txt&quot;);
1480             Files.writeString(fileWithSpaceInName, &quot;Hello world\n&quot;);
1481             r.add(fileWithSpaceInName);
1482             var hash1 = r.commit(&quot;Added file with space in name&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1483             Files.writeString(fileWithSpaceInName, &quot;Goodbye world\n&quot;);
1484             r.add(fileWithSpaceInName);
1485             var hash2 = r.commit(&quot;Modified file with space in name&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1486             var diff = r.diff(hash1, hash2);
1487             var patches = diff.patches();
1488             assertEquals(1, patches.size());
1489             var patch = patches.get(0);
1490             assertTrue(patch.target().path().isPresent());
1491             var path = patch.target().path().get();
1492             assertEquals(Path.of(&quot;hello world.txt&quot;), path);
1493         }
1494     }
1495 
1496     @Test
1497     void testSingleEmptyCommit() throws IOException, InterruptedException {
1498         try (var dir = new TemporaryDirectory()) {
1499             var r = Repository.init(dir.path(), VCS.GIT);
1500             assertTrue(r.isClean());
1501 
1502             // must ust git directly to be able to pass --allow-empty
1503             var pb = new ProcessBuilder(&quot;git&quot;, &quot;commit&quot;, &quot;--message&quot;, &quot;An empty commit&quot;, &quot;--allow-empty&quot;);
1504             pb.environment().put(&quot;GIT_AUTHOR_NAME&quot;, &quot;duke&quot;);
1505             pb.environment().put(&quot;GIT_AUTHOR_EMAIL&quot;, &quot;duke@openjdk.org&quot;);
1506             pb.environment().put(&quot;GIT_COMMITTER_NAME&quot;, &quot;duke&quot;);
1507             pb.environment().put(&quot;GIT_COMMITTER_EMAIL&quot;, &quot;duke@openjdk.org&quot;);
1508             pb.directory(dir.path().toFile());
1509 
1510             var res = pb.start().waitFor();
1511             assertEquals(0, res);
1512 
1513             var commits = r.commits().asList();
1514             assertEquals(1, commits.size());
1515             var commit = commits.get(0);
1516             assertEquals(&quot;duke&quot;, commit.author().name());
1517             assertEquals(&quot;duke@openjdk.org&quot;, commit.author().email());
1518             assertEquals(&quot;duke&quot;, commit.committer().name());
1519             assertEquals(&quot;duke@openjdk.org&quot;, commit.committer().email());
1520             assertEquals(List.of(&quot;An empty commit&quot;), commit.message());
1521         }
1522     }
1523 
1524     @Test
1525     void testEmptyCommitWithParent() throws IOException, InterruptedException {
1526         try (var dir = new TemporaryDirectory()) {
1527             var r = Repository.init(dir.path(), VCS.GIT);
1528             assertTrue(r.isClean());
1529 
1530             var f = Files.createFile(dir.path().resolve(&quot;hello.txt&quot;));
1531             Files.writeString(f, &quot;Hello world\n&quot;);
1532             r.add(f);
1533             r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1534 
1535             // must ust git directly to be able to pass --allow-empty
1536             var pb = new ProcessBuilder(&quot;git&quot;, &quot;commit&quot;, &quot;--message&quot;, &quot;An empty commit&quot;, &quot;--allow-empty&quot;);
1537             pb.environment().put(&quot;GIT_AUTHOR_NAME&quot;, &quot;duke&quot;);
1538             pb.environment().put(&quot;GIT_AUTHOR_EMAIL&quot;, &quot;duke@openjdk.org&quot;);
1539             pb.environment().put(&quot;GIT_COMMITTER_NAME&quot;, &quot;duke&quot;);
1540             pb.environment().put(&quot;GIT_COMMITTER_EMAIL&quot;, &quot;duke@openjdk.org&quot;);
1541             pb.directory(dir.path().toFile());
1542 
1543             var res = pb.start().waitFor();
1544             assertEquals(0, res);
1545 
1546             var commits = r.commits().asList();
1547             assertEquals(2, commits.size());
1548             var commit = commits.get(0);
1549             assertEquals(&quot;duke&quot;, commit.author().name());
1550             assertEquals(&quot;duke@openjdk.org&quot;, commit.author().email());
1551             assertEquals(&quot;duke&quot;, commit.committer().name());
1552             assertEquals(&quot;duke@openjdk.org&quot;, commit.committer().email());
1553             assertEquals(List.of(&quot;An empty commit&quot;), commit.message());
1554         }
1555     }
1556 
1557     @ParameterizedTest
1558     @EnumSource(VCS.class)
1559     void testAmend(VCS vcs) throws IOException {
1560         try (var dir = new TemporaryDirectory()) {
1561             var r = Repository.init(dir.path(), vcs);
1562             assertTrue(r.isClean());
1563 
1564             var f = dir.path().resolve(&quot;README&quot;);
1565             Files.writeString(f, &quot;Hello\n&quot;);
1566             r.add(f);
1567             r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1568 
1569             Files.writeString(f, &quot;Hello, world\n&quot;);
1570             r.add(f);
1571             r.amend(&quot;Initial commit corrected&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1572             var commits = r.commits().asList();
1573             assertEquals(1, commits.size());
1574             var commit = commits.get(0);
1575             assertEquals(List.of(&quot;Initial commit corrected&quot;), commit.message());
1576         }
1577     }
1578 
1579     @ParameterizedTest
1580     @EnumSource(VCS.class)
1581     void testRevert(VCS vcs) throws IOException {
1582         try (var dir = new TemporaryDirectory()) {
1583             var r = Repository.init(dir.path(), vcs);
1584             assertTrue(r.isClean());
1585 
1586             var f = dir.path().resolve(&quot;README&quot;);
1587             Files.writeString(f, &quot;Hello\n&quot;);
1588             r.add(f);
1589             var initial = r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1590 
1591             Files.writeString(f, &quot;Hello, world\n&quot;);
1592             r.revert(initial);
1593             Files.writeString(f, &quot;Goodbye, world\n&quot;);
1594             r.add(f);
1595             var hash = r.commit(&quot;Second commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1596             var commit = r.lookup(hash).orElseThrow();
1597             var patches = commit.parentDiffs().get(0).patches();
1598             assertEquals(1, patches.size());
1599             var patch = patches.get(0).asTextualPatch();
1600             assertEquals(1, patch.hunks().size());
1601             var hunk = patch.hunks().get(0);
1602             assertEquals(List.of(&quot;Goodbye, world&quot;), hunk.target().lines());
1603         }
1604     }
1605 }
    </pre>
  </body>
</html>