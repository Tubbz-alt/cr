<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff vcs/src/test/java/org/openjdk/skara/vcs/RepositoryTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>vcs/src/test/java/org/openjdk/skara/vcs/RepositoryTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 294 
 295             var patches = diff.patches();
 296             assertEquals(1, patches.size());
 297 
 298             var patch = patches.get(0).asTextualPatch();
 299             assertTrue(patch.status().isAdded());
 300 
 301             assertTrue(patch.source().path().isEmpty());
 302             assertTrue(patch.source().type().isEmpty());
 303 
 304             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 305             assertTrue(patch.target().type().get().isRegularNonExecutable());
 306 
 307             var hunks = patch.hunks();
 308             assertEquals(1, hunks.size());
 309 
 310             var hunk = hunks.get(0);
 311             assertEquals(new Range(0, 0), hunk.source().range());
 312             assertEquals(new Range(1, 1), hunk.target().range());
 313 
<span class="line-modified"> 314             assertEquals(List.of(), hunk.source().lines());</span>
<span class="line-modified"> 315             assertEquals(List.of(&quot;Hello, readme!&quot;), hunk.target().lines());</span>
 316         }
 317     }
 318 








 319     @ParameterizedTest
 320     @EnumSource(VCS.class)
 321     void testCommitListingWithMultipleCommits(VCS vcs) throws IOException {
 322         try (var dir = new TemporaryDirectory()) {
 323             var r = Repository.init(dir.path(), vcs);
 324 
 325             var readme = dir.path().resolve(&quot;README&quot;);
 326             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 327 
 328             r.add(readme);
 329             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 330 
 331             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 332             r.add(readme);
 333             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 334 
 335             var commits = r.commits().asList();
 336             assertEquals(2, commits.size());
 337 
 338             var commit = commits.get(0);
</pre>
<hr />
<pre>
 362             assertEquals(0, diff.modified());
 363             assertEquals(1, diff.added());
 364 
 365             var patches = diff.patches();
 366             assertEquals(1, patches.size());
 367 
 368             var patch = patches.get(0).asTextualPatch();
 369             assertTrue(patch.status().isModified());
 370             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 371             assertTrue(patch.source().type().get().isRegularNonExecutable());
 372             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 373             assertTrue(patch.target().type().get().isRegularNonExecutable());
 374 
 375             var hunks = patch.hunks();
 376             assertEquals(1, hunks.size());
 377 
 378             var hunk = hunks.get(0);
 379             assertEquals(new Range(2, 0), hunk.source().range());
 380             assertEquals(new Range(2, 1), hunk.target().range());
 381 
<span class="line-modified"> 382             assertEquals(List.of(), hunk.source().lines());</span>
<span class="line-modified"> 383             assertEquals(List.of(&quot;Another line&quot;), hunk.target().lines());</span>
 384         }
 385     }
 386 
 387     @ParameterizedTest
 388     @EnumSource(VCS.class)
 389     void testSquashDeletes(VCS vcs) throws IOException {
 390         try (var dir = new TemporaryDirectory()) {
 391             var r = Repository.init(dir.path(), vcs);
 392 
 393             var file1 = dir.path().resolve(&quot;file1.txt&quot;);
 394             Files.write(file1, List.of(&quot;Hello, file 1!&quot;));
 395             var file2 = dir.path().resolve(&quot;file2.txt&quot;);
 396             Files.write(file2, List.of(&quot;Hello, file 2!&quot;));
 397             var file3 = dir.path().resolve(&quot;file3.txt&quot;);
 398             Files.write(file3, List.of(&quot;Hello, file 3!&quot;));
 399 
 400             r.add(file1, file2, file3);
 401             var hash1 = r.commit(&quot;Add files&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 402 
 403             Files.delete(file2);
</pre>
<hr />
<pre>
 494             assertEquals(0, diff.modified());
 495             assertEquals(2, diff.added());
 496 
 497             var patches = diff.patches();
 498             assertEquals(1, patches.size());
 499 
 500             var patch = patches.get(0).asTextualPatch();
 501             assertTrue(patch.status().isModified());
 502             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 503             assertTrue(patch.source().type().get().isRegularNonExecutable());
 504             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 505             assertTrue(patch.target().type().get().isRegularNonExecutable());
 506 
 507             var hunks = patch.hunks();
 508             assertEquals(1, hunks.size());
 509 
 510             var hunk = hunks.get(0);
 511             assertEquals(new Range(2, 0), hunk.source().range());
 512             assertEquals(new Range(2, 2), hunk.target().range());
 513 
<span class="line-modified"> 514             assertEquals(List.of(), hunk.source().lines());</span>
<span class="line-modified"> 515             assertEquals(List.of(&quot;Another line&quot;, &quot;A final line&quot;), hunk.target().lines());</span>
 516         }
 517     }
 518 
 519     @ParameterizedTest
 520     @EnumSource(VCS.class)
 521     void testMergeBase(VCS vcs) throws IOException {
 522         try (var dir = new TemporaryDirectory()) {
 523             var r = Repository.init(dir.path(), vcs);
 524 
 525             var readme = dir.path().resolve(&quot;README&quot;);
 526             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 527 
 528             r.add(readme);
 529             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 530 
 531             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 532             r.add(readme);
 533             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 534 
 535             r.checkout(hash1, false);
</pre>
<hr />
<pre>
 592             var head = commits.get(0);
 593             assertEquals(hash2, head.parents().get(0));
 594             assertEquals(List.of(&quot;Add independent change&quot;), head.message());
 595 
 596             var diffs = head.parentDiffs();
 597             assertEquals(1, diffs.size());
 598             var diff = diffs.get(0);
 599 
 600             assertEquals(0, diff.removed());
 601             assertEquals(0, diff.modified());
 602             assertEquals(1, diff.added());
 603 
 604             var patches = diff.patches();
 605             assertEquals(1, patches.size());
 606             var patch = patches.get(0).asTextualPatch();
 607             assertEquals(Path.of(&quot;CONTRIBUTING&quot;), patch.target().path().get());
 608 
 609             var hunks = patch.hunks();
 610             assertEquals(1, hunks.size());
 611             var hunk = hunks.get(0);
<span class="line-modified"> 612             assertEquals(List.of(&quot;Keep the patches coming&quot;), hunk.target().lines());</span>
 613         }
 614     }
 615 
 616     @ParameterizedTest
 617     @EnumSource(VCS.class)
 618     void testInitializedRepositoryIsEmpty(VCS vcs) throws IOException {
 619         try (var dir = new TemporaryDirectory()) {
 620             var r = Repository.init(dir.path(), vcs);
 621             assertTrue(r.isEmpty());
 622         }
 623     }
 624 
 625     @ParameterizedTest
 626     @EnumSource(VCS.class)
 627     void testRepositoryWithCommitIsNonEmpty(VCS vcs) throws IOException {
 628         try (var dir = new TemporaryDirectory()) {
 629             var r = Repository.init(dir.path(), vcs);
 630 
 631             var readme = dir.path().resolve(&quot;README&quot;);
 632             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
</pre>
<hr />
<pre>
 870             var patches = diff.patches();
 871             assertEquals(1, patches.size());
 872 
 873             var patch = patches.get(0).asTextualPatch();
 874             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 875             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 876             assertTrue(patch.source().type().get().isRegularNonExecutable());
 877             assertTrue(patch.target().type().get().isRegularNonExecutable());
 878             assertTrue(patch.status().isModified());
 879 
 880             var hunks = patch.hunks();
 881             assertEquals(1, hunks.size());
 882 
 883             var hunk = hunks.get(0);
 884             assertEquals(2, hunk.source().range().start());
 885             assertEquals(0, hunk.source().range().count());
 886             assertEquals(0, hunk.source().lines().size());
 887 
 888             assertEquals(2, hunk.target().range().start());
 889             assertEquals(1, hunk.target().range().count());
<span class="line-modified"> 890             assertEquals(List.of(&quot;One more line&quot;), hunk.target().lines());</span>
 891 
 892             assertEquals(1, hunk.added());
 893             assertEquals(0, hunk.removed());
 894             assertEquals(0, hunk.modified());
 895         }
 896     }
 897 
 898     @ParameterizedTest
 899     @EnumSource(VCS.class)
 900     void testDiffBetweenCommitsWithMultiplePatches(VCS vcs) throws IOException {
 901         try (var dir = new TemporaryDirectory()) {
 902             var r = Repository.init(dir.path(), vcs);
 903 
 904             var readme = dir.path().resolve(&quot;README&quot;);
 905             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 906 
 907             var building = dir.path().resolve(&quot;BUILDING&quot;);
 908             Files.write(building, List.of(&quot;make&quot;));
 909 
 910             r.add(readme);
</pre>
<hr />
<pre>
 920             var diff = r.diff(first, second);
 921             assertEquals(first, diff.from());
 922             assertEquals(second, diff.to());
 923 
 924             var patches = diff.patches();
 925             assertEquals(2, patches.size());
 926 
 927             var patch1 = patches.get(0).asTextualPatch();
 928             assertEquals(Path.of(&quot;BUILDING&quot;), patch1.source().path().get());
 929             assertEquals(Path.of(&quot;BUILDING&quot;), patch1.target().path().get());
 930             assertTrue(patch1.source().type().get().isRegularNonExecutable());
 931             assertTrue(patch1.target().type().get().isRegularNonExecutable());
 932             assertTrue(patch1.status().isModified());
 933 
 934             var hunks1 = patch1.hunks();
 935             assertEquals(1, hunks1.size());
 936 
 937             var hunk1 = hunks1.get(0);
 938             assertEquals(1, hunk1.source().range().start());
 939             assertEquals(1, hunk1.source().range().count());
<span class="line-modified"> 940             assertEquals(List.of(&quot;make&quot;), hunk1.source().lines());</span>
 941 
 942             assertEquals(1, hunk1.target().range().start());
 943             assertEquals(1, hunk1.target().range().count());
<span class="line-modified"> 944             assertEquals(List.of(&quot;make images&quot;), hunk1.target().lines());</span>
 945 
 946             var patch2 = patches.get(1).asTextualPatch();
 947             assertEquals(Path.of(&quot;README&quot;), patch2.source().path().get());
 948             assertEquals(Path.of(&quot;README&quot;), patch2.target().path().get());
 949             assertTrue(patch2.source().type().get().isRegularNonExecutable());
 950             assertTrue(patch2.target().type().get().isRegularNonExecutable());
 951             assertTrue(patch2.status().isModified());
 952 
 953             var hunks2 = patch2.hunks();
 954             assertEquals(1, hunks2.size());
 955 
 956             var hunk2 = hunks2.get(0);
 957             assertEquals(1, hunk2.source().range().start());
 958             assertEquals(1, hunk2.source().range().count());
<span class="line-modified"> 959             assertEquals(List.of(&quot;Hello, readme!&quot;), hunk2.source().lines());</span>
 960 
 961             assertEquals(1, hunk2.target().range().start());
 962             assertEquals(1, hunk2.target().range().count());
<span class="line-modified"> 963             assertEquals(List.of(&quot;Hello, Skara!&quot;), hunk2.target().lines());</span>
 964         }
 965     }
 966 
 967     @ParameterizedTest
 968     @EnumSource(VCS.class)
 969     void testDiffBetweenCommitsWithMultipleHunks(VCS vcs) throws IOException {
 970         try (var dir = new TemporaryDirectory()) {
 971             var r = Repository.init(dir.path(), vcs);
 972 
 973             var abc = dir.path().resolve(&quot;abc.txt&quot;);
 974             Files.write(abc, List.of(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;));
 975 
 976             r.add(abc);
 977             var first = r.commit(&quot;Added ABC&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 978 
 979             Files.write(abc, List.of(&quot;1&quot;, &quot;2&quot;, &quot;B&quot;, &quot;3&quot;), WRITE, TRUNCATE_EXISTING);
 980             r.add(abc);
 981             var second = r.commit(&quot;Modify A and C&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 982 
 983             var diff = r.diff(first, second);
</pre>
<hr />
<pre>
 983             var diff = r.diff(first, second);
 984             assertEquals(first, diff.from());
 985             assertEquals(second, diff.to());
 986 
 987             var patches = diff.patches();
 988             assertEquals(1, patches.size());
 989 
 990             var patch = patches.get(0).asTextualPatch();
 991             assertEquals(Path.of(&quot;abc.txt&quot;), patch.source().path().get());
 992             assertEquals(Path.of(&quot;abc.txt&quot;), patch.target().path().get());
 993             assertTrue(patch.source().type().get().isRegularNonExecutable());
 994             assertTrue(patch.target().type().get().isRegularNonExecutable());
 995             assertTrue(patch.status().isModified());
 996 
 997             var hunks = patch.hunks();
 998             assertEquals(2, hunks.size());
 999 
1000             var hunk1 = hunks.get(0);
1001             assertEquals(1, hunk1.source().range().start());
1002             assertEquals(1, hunk1.source().range().count());
<span class="line-modified">1003             assertEquals(List.of(&quot;A&quot;), hunk1.source().lines());</span>
1004 
1005             assertEquals(1, hunk1.target().range().start());
1006             assertEquals(2, hunk1.target().range().count());
<span class="line-modified">1007             assertEquals(List.of(&quot;1&quot;, &quot;2&quot;), hunk1.target().lines());</span>
1008 
1009             assertEquals(1, hunk1.added());
1010             assertEquals(0, hunk1.removed());
1011             assertEquals(1, hunk1.modified());
1012 
1013             var hunk2 = hunks.get(1);
1014             assertEquals(3, hunk2.source().range().start());
1015             assertEquals(1, hunk2.source().range().count());
<span class="line-modified">1016             assertEquals(List.of(&quot;C&quot;), hunk2.source().lines());</span>
1017 
1018             assertEquals(4, hunk2.target().range().start());
1019             assertEquals(1, hunk2.target().range().count());
<span class="line-modified">1020             assertEquals(List.of(&quot;3&quot;), hunk2.target().lines());</span>
1021 
1022             assertEquals(0, hunk2.added());
1023             assertEquals(0, hunk2.removed());
1024             assertEquals(1, hunk2.modified());
1025         }
1026     }
1027 
1028     @ParameterizedTest
1029     @EnumSource(VCS.class)
1030     void testDiffWithRemoval(VCS vcs) throws IOException {
1031         try (var dir = new TemporaryDirectory()) {
1032             var r = Repository.init(dir.path(), vcs);
1033 
1034             var readme = dir.path().resolve(&quot;README&quot;);
1035             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1036 
1037             r.add(readme);
1038             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1039 
1040             Files.delete(readme);
</pre>
<hr />
<pre>
1044             var diff = r.diff(first, second);
1045             assertEquals(first, diff.from());
1046             assertEquals(second, diff.to());
1047 
1048             var patches = diff.patches();
1049             assertEquals(1, patches.size());
1050 
1051             var patch = patches.get(0).asTextualPatch();
1052             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
1053             assertTrue(patch.target().path().isEmpty());
1054             assertTrue(patch.source().type().get().isRegularNonExecutable());
1055             assertTrue(patch.target().type().isEmpty());
1056             assertTrue(patch.status().isDeleted());
1057 
1058             var hunks = patch.hunks();
1059             assertEquals(1, hunks.size());
1060 
1061             var hunk = hunks.get(0);
1062             assertEquals(1, hunk.source().range().start());
1063             assertEquals(1, hunk.source().range().count());
<span class="line-modified">1064             assertEquals(List.of(&quot;Hello, world!&quot;), hunk.source().lines());</span>
1065 
1066             assertEquals(0, hunk.target().range().start());
1067             assertEquals(0, hunk.target().range().count());
<span class="line-modified">1068             assertEquals(List.of(), hunk.target().lines());</span>
1069 
1070             assertEquals(0, hunk.added());
1071             assertEquals(1, hunk.removed());
1072             assertEquals(0, hunk.modified());
1073         }
1074     }
1075 
1076     @ParameterizedTest
1077     @EnumSource(VCS.class)
1078     void testDiffWithAddition(VCS vcs) throws IOException {
1079         try (var dir = new TemporaryDirectory()) {
1080             var r = Repository.init(dir.path(), vcs);
1081 
1082             var readme = dir.path().resolve(&quot;README&quot;);
1083             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1084 
1085             r.add(readme);
1086             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1087 
1088             var building = dir.path().resolve(&quot;BUILDING&quot;);
</pre>
<hr />
<pre>
1093             var diff = r.diff(first, second);
1094             assertEquals(first, diff.from());
1095             assertEquals(second, diff.to());
1096 
1097             var patches = diff.patches();
1098             assertEquals(1, patches.size());
1099 
1100             var patch = patches.get(0).asTextualPatch();
1101             assertTrue(patch.source().path().isEmpty());
1102             assertEquals(Path.of(&quot;BUILDING&quot;), patch.target().path().get());
1103             assertTrue(patch.source().type().isEmpty());
1104             assertTrue(patch.target().type().get().isRegularNonExecutable());
1105             assertTrue(patch.status().isAdded());
1106 
1107             var hunks = patch.hunks();
1108             assertEquals(1, hunks.size());
1109 
1110             var hunk = hunks.get(0);
1111             assertEquals(0, hunk.source().range().start());
1112             assertEquals(0, hunk.source().range().count());
<span class="line-modified">1113             assertEquals(List.of(), hunk.source().lines());</span>
1114 
1115             assertEquals(1, hunk.target().range().start());
1116             assertEquals(1, hunk.target().range().count());
<span class="line-modified">1117             assertEquals(List.of(&quot;make&quot;), hunk.target().lines());</span>
1118 
1119             assertEquals(1, hunk.added());
1120             assertEquals(0, hunk.removed());
1121             assertEquals(0, hunk.modified());
1122         }
1123     }
1124 
1125     @ParameterizedTest
1126     @EnumSource(VCS.class)
1127     void testDiffWithWorkingDir(VCS vcs) throws IOException {
1128         try (var dir = new TemporaryDirectory()) {
1129             var r = Repository.init(dir.path(), vcs);
1130 
1131             var readme = dir.path().resolve(&quot;README&quot;);
1132             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1133 
1134             r.add(readme);
1135             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1136 
1137             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
</pre>
<hr />
<pre>
1139 
1140             assertEquals(first, diff.from());
1141             assertNull(diff.to());
1142 
1143             var patches = diff.patches();
1144             assertEquals(1, patches.size());
1145 
1146             var patch = patches.get(0).asTextualPatch();
1147             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
1148             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
1149             assertTrue(patch.source().type().get().isRegularNonExecutable());
1150             assertTrue(patch.target().type().get().isRegularNonExecutable());
1151             assertTrue(patch.status().isModified());
1152 
1153             var hunks = patch.hunks();
1154             assertEquals(1, hunks.size());
1155 
1156             var hunk = hunks.get(0);
1157             assertEquals(2, hunk.source().range().start());
1158             assertEquals(0, hunk.source().range().count());
<span class="line-modified">1159             assertEquals(List.of(), hunk.source().lines());</span>
1160 
1161             assertEquals(2, hunk.target().range().start());
1162             assertEquals(1, hunk.target().range().count());
<span class="line-modified">1163             assertEquals(List.of(&quot;One more line&quot;), hunk.target().lines());</span>
1164 
1165             assertEquals(1, hunk.added());
1166             assertEquals(0, hunk.removed());
1167             assertEquals(0, hunk.modified());
1168         }
1169     }
1170 
1171     @ParameterizedTest
1172     @EnumSource(VCS.class)
1173     void testCommitMetadata(VCS vcs) throws IOException {
1174         try (var dir = new TemporaryDirectory()) {
1175             var r = Repository.init(dir.path(), vcs);
1176 
1177             var readme = dir.path().resolve(&quot;README&quot;);
1178             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1179             r.add(readme);
1180             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1181 
1182             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1183             r.add(readme);
</pre>
<hr />
<pre>
1285 
1286             var parents = new HashSet&lt;&gt;(merge.parents());
1287             assertEquals(2, parents.size());
1288             assertTrue(parents.contains(second));
1289             assertTrue(parents.contains(third));
1290 
1291             var diffs = merge.parentDiffs();
1292             assertEquals(2, diffs.size());
1293 
1294             var secondDiff = diffs.stream().filter(d -&gt; d.from().equals(second)).findFirst().get();
1295             assertEquals(merge.hash(), secondDiff.to());
1296             assertEquals(1, secondDiff.patches().size());
1297             var secondPatch = secondDiff.patches().get(0).asTextualPatch();
1298 
1299             assertEquals(Path.of(&quot;README&quot;), secondPatch.source().path().get());
1300             assertEquals(Path.of(&quot;README&quot;), secondPatch.target().path().get());
1301             assertTrue(secondPatch.status().isModified());
1302             assertEquals(1, secondPatch.hunks().size());
1303 
1304             var secondHunk = secondPatch.hunks().get(0);
<span class="line-modified">1305             assertEquals(List.of(), secondHunk.source().lines());</span>
<span class="line-modified">1306             assertEquals(List.of(&quot;One last line&quot;), secondHunk.target().lines());</span>
1307 
1308             assertEquals(3, secondHunk.source().range().start());
1309             assertEquals(0, secondHunk.source().range().count());
1310             assertEquals(3, secondHunk.target().range().start());
1311             assertEquals(1, secondHunk.target().range().count());
1312 
1313             var thirdDiff = diffs.stream().filter(d -&gt; d.from().equals(third)).findFirst().get();
1314             assertEquals(merge.hash(), thirdDiff.to());
1315             assertEquals(1, thirdDiff.patches().size());
1316             var thirdPatch = thirdDiff.patches().get(0).asTextualPatch();
1317 
1318             assertEquals(Path.of(&quot;README&quot;), thirdPatch.source().path().get());
1319             assertEquals(Path.of(&quot;README&quot;), thirdPatch.target().path().get());
1320             assertTrue(thirdPatch.status().isModified());
1321             assertEquals(1, thirdPatch.hunks().size());
1322 
1323             var thirdHunk = thirdPatch.hunks().get(0);
<span class="line-modified">1324             assertEquals(List.of(), thirdHunk.source().lines());</span>
<span class="line-modified">1325             assertEquals(List.of(&quot;One more line&quot;, &quot;One last line&quot;), thirdHunk.target().lines());</span>
1326 
1327             assertEquals(2, thirdHunk.source().range().start());
1328             assertEquals(0, thirdHunk.source().range().count());
1329             assertEquals(2, thirdHunk.target().range().start());
1330             assertEquals(2, thirdHunk.target().range().count());
1331         }
1332     }
1333 
1334     @ParameterizedTest
1335     @EnumSource(VCS.class)
1336     void testDefaultBranch(VCS vcs) throws IOException {
1337         try (var dir = new TemporaryDirectory()) {
1338             var r = Repository.init(dir.path(), vcs);
1339             var expected = vcs == VCS.GIT ? &quot;master&quot; : &quot;default&quot;;
1340             assertEquals(expected, r.defaultBranch().name());
1341         }
1342     }
1343 
1344     @ParameterizedTest
1345     @EnumSource(VCS.class)
</pre>
</td>
<td>
<hr />
<pre>
 294 
 295             var patches = diff.patches();
 296             assertEquals(1, patches.size());
 297 
 298             var patch = patches.get(0).asTextualPatch();
 299             assertTrue(patch.status().isAdded());
 300 
 301             assertTrue(patch.source().path().isEmpty());
 302             assertTrue(patch.source().type().isEmpty());
 303 
 304             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 305             assertTrue(patch.target().type().get().isRegularNonExecutable());
 306 
 307             var hunks = patch.hunks();
 308             assertEquals(1, hunks.size());
 309 
 310             var hunk = hunks.get(0);
 311             assertEquals(new Range(0, 0), hunk.source().range());
 312             assertEquals(new Range(1, 1), hunk.target().range());
 313 
<span class="line-modified"> 314             assertLinesEquals(List.of(), hunk.source().lines());</span>
<span class="line-modified"> 315             assertLinesEquals(List.of(&quot;Hello, readme!&quot;), hunk.target().lines());</span>
 316         }
 317     }
 318 
<span class="line-added"> 319     static void assertLinesEquals(List&lt;String&gt; expected, List&lt;String&gt; actual) {</span>
<span class="line-added"> 320         var newLine = System.lineSeparator();</span>
<span class="line-added"> 321         var suffix = newLine.endsWith(&quot;\n&quot;)</span>
<span class="line-added"> 322                 ? newLine.substring(0, newLine.length() - 1) // drop trailing &#39;\n&#39; (keeping any &#39;\r&#39;)</span>
<span class="line-added"> 323                 : newLine;</span>
<span class="line-added"> 324         assertEquals(expected.stream().map(l -&gt; l + suffix).collect(Collectors.toList()), actual);</span>
<span class="line-added"> 325     }</span>
<span class="line-added"> 326 </span>
 327     @ParameterizedTest
 328     @EnumSource(VCS.class)
 329     void testCommitListingWithMultipleCommits(VCS vcs) throws IOException {
 330         try (var dir = new TemporaryDirectory()) {
 331             var r = Repository.init(dir.path(), vcs);
 332 
 333             var readme = dir.path().resolve(&quot;README&quot;);
 334             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 335 
 336             r.add(readme);
 337             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 338 
 339             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 340             r.add(readme);
 341             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 342 
 343             var commits = r.commits().asList();
 344             assertEquals(2, commits.size());
 345 
 346             var commit = commits.get(0);
</pre>
<hr />
<pre>
 370             assertEquals(0, diff.modified());
 371             assertEquals(1, diff.added());
 372 
 373             var patches = diff.patches();
 374             assertEquals(1, patches.size());
 375 
 376             var patch = patches.get(0).asTextualPatch();
 377             assertTrue(patch.status().isModified());
 378             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 379             assertTrue(patch.source().type().get().isRegularNonExecutable());
 380             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 381             assertTrue(patch.target().type().get().isRegularNonExecutable());
 382 
 383             var hunks = patch.hunks();
 384             assertEquals(1, hunks.size());
 385 
 386             var hunk = hunks.get(0);
 387             assertEquals(new Range(2, 0), hunk.source().range());
 388             assertEquals(new Range(2, 1), hunk.target().range());
 389 
<span class="line-modified"> 390             assertLinesEquals(List.of(), hunk.source().lines());</span>
<span class="line-modified"> 391             assertLinesEquals(List.of(&quot;Another line&quot;), hunk.target().lines());</span>
 392         }
 393     }
 394 
 395     @ParameterizedTest
 396     @EnumSource(VCS.class)
 397     void testSquashDeletes(VCS vcs) throws IOException {
 398         try (var dir = new TemporaryDirectory()) {
 399             var r = Repository.init(dir.path(), vcs);
 400 
 401             var file1 = dir.path().resolve(&quot;file1.txt&quot;);
 402             Files.write(file1, List.of(&quot;Hello, file 1!&quot;));
 403             var file2 = dir.path().resolve(&quot;file2.txt&quot;);
 404             Files.write(file2, List.of(&quot;Hello, file 2!&quot;));
 405             var file3 = dir.path().resolve(&quot;file3.txt&quot;);
 406             Files.write(file3, List.of(&quot;Hello, file 3!&quot;));
 407 
 408             r.add(file1, file2, file3);
 409             var hash1 = r.commit(&quot;Add files&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 410 
 411             Files.delete(file2);
</pre>
<hr />
<pre>
 502             assertEquals(0, diff.modified());
 503             assertEquals(2, diff.added());
 504 
 505             var patches = diff.patches();
 506             assertEquals(1, patches.size());
 507 
 508             var patch = patches.get(0).asTextualPatch();
 509             assertTrue(patch.status().isModified());
 510             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 511             assertTrue(patch.source().type().get().isRegularNonExecutable());
 512             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 513             assertTrue(patch.target().type().get().isRegularNonExecutable());
 514 
 515             var hunks = patch.hunks();
 516             assertEquals(1, hunks.size());
 517 
 518             var hunk = hunks.get(0);
 519             assertEquals(new Range(2, 0), hunk.source().range());
 520             assertEquals(new Range(2, 2), hunk.target().range());
 521 
<span class="line-modified"> 522             assertLinesEquals(List.of(), hunk.source().lines());</span>
<span class="line-modified"> 523             assertLinesEquals(List.of(&quot;Another line&quot;, &quot;A final line&quot;), hunk.target().lines());</span>
 524         }
 525     }
 526 
 527     @ParameterizedTest
 528     @EnumSource(VCS.class)
 529     void testMergeBase(VCS vcs) throws IOException {
 530         try (var dir = new TemporaryDirectory()) {
 531             var r = Repository.init(dir.path(), vcs);
 532 
 533             var readme = dir.path().resolve(&quot;README&quot;);
 534             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 535 
 536             r.add(readme);
 537             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 538 
 539             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 540             r.add(readme);
 541             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 542 
 543             r.checkout(hash1, false);
</pre>
<hr />
<pre>
 600             var head = commits.get(0);
 601             assertEquals(hash2, head.parents().get(0));
 602             assertEquals(List.of(&quot;Add independent change&quot;), head.message());
 603 
 604             var diffs = head.parentDiffs();
 605             assertEquals(1, diffs.size());
 606             var diff = diffs.get(0);
 607 
 608             assertEquals(0, diff.removed());
 609             assertEquals(0, diff.modified());
 610             assertEquals(1, diff.added());
 611 
 612             var patches = diff.patches();
 613             assertEquals(1, patches.size());
 614             var patch = patches.get(0).asTextualPatch();
 615             assertEquals(Path.of(&quot;CONTRIBUTING&quot;), patch.target().path().get());
 616 
 617             var hunks = patch.hunks();
 618             assertEquals(1, hunks.size());
 619             var hunk = hunks.get(0);
<span class="line-modified"> 620             assertLinesEquals(List.of(&quot;Keep the patches coming&quot;), hunk.target().lines());</span>
 621         }
 622     }
 623 
 624     @ParameterizedTest
 625     @EnumSource(VCS.class)
 626     void testInitializedRepositoryIsEmpty(VCS vcs) throws IOException {
 627         try (var dir = new TemporaryDirectory()) {
 628             var r = Repository.init(dir.path(), vcs);
 629             assertTrue(r.isEmpty());
 630         }
 631     }
 632 
 633     @ParameterizedTest
 634     @EnumSource(VCS.class)
 635     void testRepositoryWithCommitIsNonEmpty(VCS vcs) throws IOException {
 636         try (var dir = new TemporaryDirectory()) {
 637             var r = Repository.init(dir.path(), vcs);
 638 
 639             var readme = dir.path().resolve(&quot;README&quot;);
 640             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
</pre>
<hr />
<pre>
 878             var patches = diff.patches();
 879             assertEquals(1, patches.size());
 880 
 881             var patch = patches.get(0).asTextualPatch();
 882             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 883             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 884             assertTrue(patch.source().type().get().isRegularNonExecutable());
 885             assertTrue(patch.target().type().get().isRegularNonExecutable());
 886             assertTrue(patch.status().isModified());
 887 
 888             var hunks = patch.hunks();
 889             assertEquals(1, hunks.size());
 890 
 891             var hunk = hunks.get(0);
 892             assertEquals(2, hunk.source().range().start());
 893             assertEquals(0, hunk.source().range().count());
 894             assertEquals(0, hunk.source().lines().size());
 895 
 896             assertEquals(2, hunk.target().range().start());
 897             assertEquals(1, hunk.target().range().count());
<span class="line-modified"> 898             assertLinesEquals(List.of(&quot;One more line&quot;), hunk.target().lines());</span>
 899 
 900             assertEquals(1, hunk.added());
 901             assertEquals(0, hunk.removed());
 902             assertEquals(0, hunk.modified());
 903         }
 904     }
 905 
 906     @ParameterizedTest
 907     @EnumSource(VCS.class)
 908     void testDiffBetweenCommitsWithMultiplePatches(VCS vcs) throws IOException {
 909         try (var dir = new TemporaryDirectory()) {
 910             var r = Repository.init(dir.path(), vcs);
 911 
 912             var readme = dir.path().resolve(&quot;README&quot;);
 913             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 914 
 915             var building = dir.path().resolve(&quot;BUILDING&quot;);
 916             Files.write(building, List.of(&quot;make&quot;));
 917 
 918             r.add(readme);
</pre>
<hr />
<pre>
 928             var diff = r.diff(first, second);
 929             assertEquals(first, diff.from());
 930             assertEquals(second, diff.to());
 931 
 932             var patches = diff.patches();
 933             assertEquals(2, patches.size());
 934 
 935             var patch1 = patches.get(0).asTextualPatch();
 936             assertEquals(Path.of(&quot;BUILDING&quot;), patch1.source().path().get());
 937             assertEquals(Path.of(&quot;BUILDING&quot;), patch1.target().path().get());
 938             assertTrue(patch1.source().type().get().isRegularNonExecutable());
 939             assertTrue(patch1.target().type().get().isRegularNonExecutable());
 940             assertTrue(patch1.status().isModified());
 941 
 942             var hunks1 = patch1.hunks();
 943             assertEquals(1, hunks1.size());
 944 
 945             var hunk1 = hunks1.get(0);
 946             assertEquals(1, hunk1.source().range().start());
 947             assertEquals(1, hunk1.source().range().count());
<span class="line-modified"> 948             assertLinesEquals(List.of(&quot;make&quot;), hunk1.source().lines());</span>
 949 
 950             assertEquals(1, hunk1.target().range().start());
 951             assertEquals(1, hunk1.target().range().count());
<span class="line-modified"> 952             assertLinesEquals(List.of(&quot;make images&quot;), hunk1.target().lines());</span>
 953 
 954             var patch2 = patches.get(1).asTextualPatch();
 955             assertEquals(Path.of(&quot;README&quot;), patch2.source().path().get());
 956             assertEquals(Path.of(&quot;README&quot;), patch2.target().path().get());
 957             assertTrue(patch2.source().type().get().isRegularNonExecutable());
 958             assertTrue(patch2.target().type().get().isRegularNonExecutable());
 959             assertTrue(patch2.status().isModified());
 960 
 961             var hunks2 = patch2.hunks();
 962             assertEquals(1, hunks2.size());
 963 
 964             var hunk2 = hunks2.get(0);
 965             assertEquals(1, hunk2.source().range().start());
 966             assertEquals(1, hunk2.source().range().count());
<span class="line-modified"> 967             assertLinesEquals(List.of(&quot;Hello, readme!&quot;), hunk2.source().lines());</span>
 968 
 969             assertEquals(1, hunk2.target().range().start());
 970             assertEquals(1, hunk2.target().range().count());
<span class="line-modified"> 971             assertLinesEquals(List.of(&quot;Hello, Skara!&quot;), hunk2.target().lines());</span>
 972         }
 973     }
 974 
 975     @ParameterizedTest
 976     @EnumSource(VCS.class)
 977     void testDiffBetweenCommitsWithMultipleHunks(VCS vcs) throws IOException {
 978         try (var dir = new TemporaryDirectory()) {
 979             var r = Repository.init(dir.path(), vcs);
 980 
 981             var abc = dir.path().resolve(&quot;abc.txt&quot;);
 982             Files.write(abc, List.of(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;));
 983 
 984             r.add(abc);
 985             var first = r.commit(&quot;Added ABC&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 986 
 987             Files.write(abc, List.of(&quot;1&quot;, &quot;2&quot;, &quot;B&quot;, &quot;3&quot;), WRITE, TRUNCATE_EXISTING);
 988             r.add(abc);
 989             var second = r.commit(&quot;Modify A and C&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 990 
 991             var diff = r.diff(first, second);
</pre>
<hr />
<pre>
 991             var diff = r.diff(first, second);
 992             assertEquals(first, diff.from());
 993             assertEquals(second, diff.to());
 994 
 995             var patches = diff.patches();
 996             assertEquals(1, patches.size());
 997 
 998             var patch = patches.get(0).asTextualPatch();
 999             assertEquals(Path.of(&quot;abc.txt&quot;), patch.source().path().get());
1000             assertEquals(Path.of(&quot;abc.txt&quot;), patch.target().path().get());
1001             assertTrue(patch.source().type().get().isRegularNonExecutable());
1002             assertTrue(patch.target().type().get().isRegularNonExecutable());
1003             assertTrue(patch.status().isModified());
1004 
1005             var hunks = patch.hunks();
1006             assertEquals(2, hunks.size());
1007 
1008             var hunk1 = hunks.get(0);
1009             assertEquals(1, hunk1.source().range().start());
1010             assertEquals(1, hunk1.source().range().count());
<span class="line-modified">1011             assertLinesEquals(List.of(&quot;A&quot;), hunk1.source().lines());</span>
1012 
1013             assertEquals(1, hunk1.target().range().start());
1014             assertEquals(2, hunk1.target().range().count());
<span class="line-modified">1015             assertLinesEquals(List.of(&quot;1&quot;, &quot;2&quot;), hunk1.target().lines());</span>
1016 
1017             assertEquals(1, hunk1.added());
1018             assertEquals(0, hunk1.removed());
1019             assertEquals(1, hunk1.modified());
1020 
1021             var hunk2 = hunks.get(1);
1022             assertEquals(3, hunk2.source().range().start());
1023             assertEquals(1, hunk2.source().range().count());
<span class="line-modified">1024             assertLinesEquals(List.of(&quot;C&quot;), hunk2.source().lines());</span>
1025 
1026             assertEquals(4, hunk2.target().range().start());
1027             assertEquals(1, hunk2.target().range().count());
<span class="line-modified">1028             assertLinesEquals(List.of(&quot;3&quot;), hunk2.target().lines());</span>
1029 
1030             assertEquals(0, hunk2.added());
1031             assertEquals(0, hunk2.removed());
1032             assertEquals(1, hunk2.modified());
1033         }
1034     }
1035 
1036     @ParameterizedTest
1037     @EnumSource(VCS.class)
1038     void testDiffWithRemoval(VCS vcs) throws IOException {
1039         try (var dir = new TemporaryDirectory()) {
1040             var r = Repository.init(dir.path(), vcs);
1041 
1042             var readme = dir.path().resolve(&quot;README&quot;);
1043             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1044 
1045             r.add(readme);
1046             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1047 
1048             Files.delete(readme);
</pre>
<hr />
<pre>
1052             var diff = r.diff(first, second);
1053             assertEquals(first, diff.from());
1054             assertEquals(second, diff.to());
1055 
1056             var patches = diff.patches();
1057             assertEquals(1, patches.size());
1058 
1059             var patch = patches.get(0).asTextualPatch();
1060             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
1061             assertTrue(patch.target().path().isEmpty());
1062             assertTrue(patch.source().type().get().isRegularNonExecutable());
1063             assertTrue(patch.target().type().isEmpty());
1064             assertTrue(patch.status().isDeleted());
1065 
1066             var hunks = patch.hunks();
1067             assertEquals(1, hunks.size());
1068 
1069             var hunk = hunks.get(0);
1070             assertEquals(1, hunk.source().range().start());
1071             assertEquals(1, hunk.source().range().count());
<span class="line-modified">1072             assertLinesEquals(List.of(&quot;Hello, world!&quot;), hunk.source().lines());</span>
1073 
1074             assertEquals(0, hunk.target().range().start());
1075             assertEquals(0, hunk.target().range().count());
<span class="line-modified">1076             assertLinesEquals(List.of(), hunk.target().lines());</span>
1077 
1078             assertEquals(0, hunk.added());
1079             assertEquals(1, hunk.removed());
1080             assertEquals(0, hunk.modified());
1081         }
1082     }
1083 
1084     @ParameterizedTest
1085     @EnumSource(VCS.class)
1086     void testDiffWithAddition(VCS vcs) throws IOException {
1087         try (var dir = new TemporaryDirectory()) {
1088             var r = Repository.init(dir.path(), vcs);
1089 
1090             var readme = dir.path().resolve(&quot;README&quot;);
1091             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1092 
1093             r.add(readme);
1094             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1095 
1096             var building = dir.path().resolve(&quot;BUILDING&quot;);
</pre>
<hr />
<pre>
1101             var diff = r.diff(first, second);
1102             assertEquals(first, diff.from());
1103             assertEquals(second, diff.to());
1104 
1105             var patches = diff.patches();
1106             assertEquals(1, patches.size());
1107 
1108             var patch = patches.get(0).asTextualPatch();
1109             assertTrue(patch.source().path().isEmpty());
1110             assertEquals(Path.of(&quot;BUILDING&quot;), patch.target().path().get());
1111             assertTrue(patch.source().type().isEmpty());
1112             assertTrue(patch.target().type().get().isRegularNonExecutable());
1113             assertTrue(patch.status().isAdded());
1114 
1115             var hunks = patch.hunks();
1116             assertEquals(1, hunks.size());
1117 
1118             var hunk = hunks.get(0);
1119             assertEquals(0, hunk.source().range().start());
1120             assertEquals(0, hunk.source().range().count());
<span class="line-modified">1121             assertLinesEquals(List.of(), hunk.source().lines());</span>
1122 
1123             assertEquals(1, hunk.target().range().start());
1124             assertEquals(1, hunk.target().range().count());
<span class="line-modified">1125             assertLinesEquals(List.of(&quot;make&quot;), hunk.target().lines());</span>
1126 
1127             assertEquals(1, hunk.added());
1128             assertEquals(0, hunk.removed());
1129             assertEquals(0, hunk.modified());
1130         }
1131     }
1132 
1133     @ParameterizedTest
1134     @EnumSource(VCS.class)
1135     void testDiffWithWorkingDir(VCS vcs) throws IOException {
1136         try (var dir = new TemporaryDirectory()) {
1137             var r = Repository.init(dir.path(), vcs);
1138 
1139             var readme = dir.path().resolve(&quot;README&quot;);
1140             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1141 
1142             r.add(readme);
1143             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1144 
1145             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
</pre>
<hr />
<pre>
1147 
1148             assertEquals(first, diff.from());
1149             assertNull(diff.to());
1150 
1151             var patches = diff.patches();
1152             assertEquals(1, patches.size());
1153 
1154             var patch = patches.get(0).asTextualPatch();
1155             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
1156             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
1157             assertTrue(patch.source().type().get().isRegularNonExecutable());
1158             assertTrue(patch.target().type().get().isRegularNonExecutable());
1159             assertTrue(patch.status().isModified());
1160 
1161             var hunks = patch.hunks();
1162             assertEquals(1, hunks.size());
1163 
1164             var hunk = hunks.get(0);
1165             assertEquals(2, hunk.source().range().start());
1166             assertEquals(0, hunk.source().range().count());
<span class="line-modified">1167             assertLinesEquals(List.of(), hunk.source().lines());</span>
1168 
1169             assertEquals(2, hunk.target().range().start());
1170             assertEquals(1, hunk.target().range().count());
<span class="line-modified">1171             assertLinesEquals(List.of(&quot;One more line&quot;), hunk.target().lines());</span>
1172 
1173             assertEquals(1, hunk.added());
1174             assertEquals(0, hunk.removed());
1175             assertEquals(0, hunk.modified());
1176         }
1177     }
1178 
1179     @ParameterizedTest
1180     @EnumSource(VCS.class)
1181     void testCommitMetadata(VCS vcs) throws IOException {
1182         try (var dir = new TemporaryDirectory()) {
1183             var r = Repository.init(dir.path(), vcs);
1184 
1185             var readme = dir.path().resolve(&quot;README&quot;);
1186             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1187             r.add(readme);
1188             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1189 
1190             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1191             r.add(readme);
</pre>
<hr />
<pre>
1293 
1294             var parents = new HashSet&lt;&gt;(merge.parents());
1295             assertEquals(2, parents.size());
1296             assertTrue(parents.contains(second));
1297             assertTrue(parents.contains(third));
1298 
1299             var diffs = merge.parentDiffs();
1300             assertEquals(2, diffs.size());
1301 
1302             var secondDiff = diffs.stream().filter(d -&gt; d.from().equals(second)).findFirst().get();
1303             assertEquals(merge.hash(), secondDiff.to());
1304             assertEquals(1, secondDiff.patches().size());
1305             var secondPatch = secondDiff.patches().get(0).asTextualPatch();
1306 
1307             assertEquals(Path.of(&quot;README&quot;), secondPatch.source().path().get());
1308             assertEquals(Path.of(&quot;README&quot;), secondPatch.target().path().get());
1309             assertTrue(secondPatch.status().isModified());
1310             assertEquals(1, secondPatch.hunks().size());
1311 
1312             var secondHunk = secondPatch.hunks().get(0);
<span class="line-modified">1313             assertLinesEquals(List.of(), secondHunk.source().lines());</span>
<span class="line-modified">1314             assertLinesEquals(List.of(&quot;One last line&quot;), secondHunk.target().lines());</span>
1315 
1316             assertEquals(3, secondHunk.source().range().start());
1317             assertEquals(0, secondHunk.source().range().count());
1318             assertEquals(3, secondHunk.target().range().start());
1319             assertEquals(1, secondHunk.target().range().count());
1320 
1321             var thirdDiff = diffs.stream().filter(d -&gt; d.from().equals(third)).findFirst().get();
1322             assertEquals(merge.hash(), thirdDiff.to());
1323             assertEquals(1, thirdDiff.patches().size());
1324             var thirdPatch = thirdDiff.patches().get(0).asTextualPatch();
1325 
1326             assertEquals(Path.of(&quot;README&quot;), thirdPatch.source().path().get());
1327             assertEquals(Path.of(&quot;README&quot;), thirdPatch.target().path().get());
1328             assertTrue(thirdPatch.status().isModified());
1329             assertEquals(1, thirdPatch.hunks().size());
1330 
1331             var thirdHunk = thirdPatch.hunks().get(0);
<span class="line-modified">1332             assertLinesEquals(List.of(), thirdHunk.source().lines());</span>
<span class="line-modified">1333             assertLinesEquals(List.of(&quot;One more line&quot;, &quot;One last line&quot;), thirdHunk.target().lines());</span>
1334 
1335             assertEquals(2, thirdHunk.source().range().start());
1336             assertEquals(0, thirdHunk.source().range().count());
1337             assertEquals(2, thirdHunk.target().range().start());
1338             assertEquals(2, thirdHunk.target().range().count());
1339         }
1340     }
1341 
1342     @ParameterizedTest
1343     @EnumSource(VCS.class)
1344     void testDefaultBranch(VCS vcs) throws IOException {
1345         try (var dir = new TemporaryDirectory()) {
1346             var r = Repository.init(dir.path(), vcs);
1347             var expected = vcs == VCS.GIT ? &quot;master&quot; : &quot;default&quot;;
1348             assertEquals(expected, r.defaultBranch().name());
1349         }
1350     }
1351 
1352     @ParameterizedTest
1353     @EnumSource(VCS.class)
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>