<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff vcs/src/test/java/org/openjdk/skara/vcs/RepositoryTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>vcs/src/test/java/org/openjdk/skara/vcs/RepositoryTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 295             var patches = diff.patches();
 296             assertEquals(1, patches.size());
 297 
 298             var patch = patches.get(0).asTextualPatch();
 299             assertTrue(patch.status().isAdded());
 300 
 301             assertTrue(patch.source().path().isEmpty());
 302             assertTrue(patch.source().type().isEmpty());
 303 
 304             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 305             assertTrue(patch.target().type().get().isRegularNonExecutable());
 306 
 307             var hunks = patch.hunks();
 308             assertEquals(1, hunks.size());
 309 
 310             var hunk = hunks.get(0);
 311             assertEquals(new Range(0, 0), hunk.source().range());
 312             assertEquals(new Range(1, 1), hunk.target().range());
 313 
 314             assertEquals(List.of(), hunk.source().lines());
<span class="line-modified"> 315             assertEquals(suffixPlatformLineEndings(&quot;Hello, readme!&quot;), hunk.target().lines());</span>
 316         }
 317     }
 318 
<span class="line-modified"> 319     static List&lt;String&gt; suffixPlatformLineEndings(String... lines) {</span>
 320         var newLine = System.lineSeparator();
 321         var suffix = newLine.endsWith(&quot;\n&quot;)
 322                 ? newLine.substring(0, newLine.length() - 1) // drop trailing &#39;\n&#39; (keeping any &#39;\r&#39;)
 323                 : newLine;
<span class="line-modified"> 324         return Arrays.stream(lines).map(l -&gt; l + suffix).collect(Collectors.toList());</span>
 325     }
 326 
 327     @ParameterizedTest
 328     @EnumSource(VCS.class)
 329     void testCommitListingWithMultipleCommits(VCS vcs) throws IOException {
 330         try (var dir = new TemporaryDirectory()) {
 331             var r = Repository.init(dir.path(), vcs);
 332 
 333             var readme = dir.path().resolve(&quot;README&quot;);
 334             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 335 
 336             r.add(readme);
 337             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 338 
 339             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 340             r.add(readme);
 341             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 342 
 343             var commits = r.commits().asList();
 344             assertEquals(2, commits.size());
</pre>
<hr />
<pre>
 371             assertEquals(1, diff.added());
 372 
 373             var patches = diff.patches();
 374             assertEquals(1, patches.size());
 375 
 376             var patch = patches.get(0).asTextualPatch();
 377             assertTrue(patch.status().isModified());
 378             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 379             assertTrue(patch.source().type().get().isRegularNonExecutable());
 380             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 381             assertTrue(patch.target().type().get().isRegularNonExecutable());
 382 
 383             var hunks = patch.hunks();
 384             assertEquals(1, hunks.size());
 385 
 386             var hunk = hunks.get(0);
 387             assertEquals(new Range(2, 0), hunk.source().range());
 388             assertEquals(new Range(2, 1), hunk.target().range());
 389 
 390             assertEquals(List.of(), hunk.source().lines());
<span class="line-modified"> 391             assertEquals(suffixPlatformLineEndings(&quot;Another line&quot;), hunk.target().lines());</span>
 392         }
 393     }
 394 
 395     @ParameterizedTest
 396     @EnumSource(VCS.class)
 397     void testSquashDeletes(VCS vcs) throws IOException {
 398         try (var dir = new TemporaryDirectory()) {
 399             var r = Repository.init(dir.path(), vcs);
 400 
 401             var file1 = dir.path().resolve(&quot;file1.txt&quot;);
 402             Files.write(file1, List.of(&quot;Hello, file 1!&quot;));
 403             var file2 = dir.path().resolve(&quot;file2.txt&quot;);
 404             Files.write(file2, List.of(&quot;Hello, file 2!&quot;));
 405             var file3 = dir.path().resolve(&quot;file3.txt&quot;);
 406             Files.write(file3, List.of(&quot;Hello, file 3!&quot;));
 407 
 408             r.add(file1, file2, file3);
 409             var hash1 = r.commit(&quot;Add files&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 410 
 411             Files.delete(file2);
</pre>
<hr />
<pre>
 503             assertEquals(2, diff.added());
 504 
 505             var patches = diff.patches();
 506             assertEquals(1, patches.size());
 507 
 508             var patch = patches.get(0).asTextualPatch();
 509             assertTrue(patch.status().isModified());
 510             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 511             assertTrue(patch.source().type().get().isRegularNonExecutable());
 512             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 513             assertTrue(patch.target().type().get().isRegularNonExecutable());
 514 
 515             var hunks = patch.hunks();
 516             assertEquals(1, hunks.size());
 517 
 518             var hunk = hunks.get(0);
 519             assertEquals(new Range(2, 0), hunk.source().range());
 520             assertEquals(new Range(2, 2), hunk.target().range());
 521 
 522             assertEquals(List.of(), hunk.source().lines());
<span class="line-modified"> 523             assertEquals(suffixPlatformLineEndings(&quot;Another line&quot;, &quot;A final line&quot;), hunk.target().lines());</span>
 524         }
 525     }
 526 
 527     @ParameterizedTest
 528     @EnumSource(VCS.class)
 529     void testMergeBase(VCS vcs) throws IOException {
 530         try (var dir = new TemporaryDirectory()) {
 531             var r = Repository.init(dir.path(), vcs);
 532 
 533             var readme = dir.path().resolve(&quot;README&quot;);
 534             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 535 
 536             r.add(readme);
 537             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 538 
 539             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 540             r.add(readme);
 541             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 542 
 543             r.checkout(hash1, false);
</pre>
<hr />
<pre>
 600             var head = commits.get(0);
 601             assertEquals(hash2, head.parents().get(0));
 602             assertEquals(List.of(&quot;Add independent change&quot;), head.message());
 603 
 604             var diffs = head.parentDiffs();
 605             assertEquals(1, diffs.size());
 606             var diff = diffs.get(0);
 607 
 608             assertEquals(0, diff.removed());
 609             assertEquals(0, diff.modified());
 610             assertEquals(1, diff.added());
 611 
 612             var patches = diff.patches();
 613             assertEquals(1, patches.size());
 614             var patch = patches.get(0).asTextualPatch();
 615             assertEquals(Path.of(&quot;CONTRIBUTING&quot;), patch.target().path().get());
 616 
 617             var hunks = patch.hunks();
 618             assertEquals(1, hunks.size());
 619             var hunk = hunks.get(0);
<span class="line-modified"> 620             assertEquals(suffixPlatformLineEndings(&quot;Keep the patches coming&quot;), hunk.target().lines());</span>
 621         }
 622     }
 623 
 624     @ParameterizedTest
 625     @EnumSource(VCS.class)
 626     void testInitializedRepositoryIsEmpty(VCS vcs) throws IOException {
 627         try (var dir = new TemporaryDirectory()) {
 628             var r = Repository.init(dir.path(), vcs);
 629             assertTrue(r.isEmpty());
 630         }
 631     }
 632 
 633     @ParameterizedTest
 634     @EnumSource(VCS.class)
 635     void testRepositoryWithCommitIsNonEmpty(VCS vcs) throws IOException {
 636         try (var dir = new TemporaryDirectory()) {
 637             var r = Repository.init(dir.path(), vcs);
 638 
 639             var readme = dir.path().resolve(&quot;README&quot;);
 640             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
</pre>
<hr />
<pre>
 878             var patches = diff.patches();
 879             assertEquals(1, patches.size());
 880 
 881             var patch = patches.get(0).asTextualPatch();
 882             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 883             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 884             assertTrue(patch.source().type().get().isRegularNonExecutable());
 885             assertTrue(patch.target().type().get().isRegularNonExecutable());
 886             assertTrue(patch.status().isModified());
 887 
 888             var hunks = patch.hunks();
 889             assertEquals(1, hunks.size());
 890 
 891             var hunk = hunks.get(0);
 892             assertEquals(2, hunk.source().range().start());
 893             assertEquals(0, hunk.source().range().count());
 894             assertEquals(0, hunk.source().lines().size());
 895 
 896             assertEquals(2, hunk.target().range().start());
 897             assertEquals(1, hunk.target().range().count());
<span class="line-modified"> 898             assertEquals(suffixPlatformLineEndings(&quot;One more line&quot;), hunk.target().lines());</span>
 899 
 900             assertEquals(1, hunk.added());
 901             assertEquals(0, hunk.removed());
 902             assertEquals(0, hunk.modified());
 903         }
 904     }
 905 
 906     @ParameterizedTest
 907     @EnumSource(VCS.class)
 908     void testDiffBetweenCommitsWithMultiplePatches(VCS vcs) throws IOException {
 909         try (var dir = new TemporaryDirectory()) {
 910             var r = Repository.init(dir.path(), vcs);
 911 
 912             var readme = dir.path().resolve(&quot;README&quot;);
 913             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 914 
 915             var building = dir.path().resolve(&quot;BUILDING&quot;);
 916             Files.write(building, List.of(&quot;make&quot;));
 917 
 918             r.add(readme);
</pre>
<hr />
<pre>
 928             var diff = r.diff(first, second);
 929             assertEquals(first, diff.from());
 930             assertEquals(second, diff.to());
 931 
 932             var patches = diff.patches();
 933             assertEquals(2, patches.size());
 934 
 935             var patch1 = patches.get(0).asTextualPatch();
 936             assertEquals(Path.of(&quot;BUILDING&quot;), patch1.source().path().get());
 937             assertEquals(Path.of(&quot;BUILDING&quot;), patch1.target().path().get());
 938             assertTrue(patch1.source().type().get().isRegularNonExecutable());
 939             assertTrue(patch1.target().type().get().isRegularNonExecutable());
 940             assertTrue(patch1.status().isModified());
 941 
 942             var hunks1 = patch1.hunks();
 943             assertEquals(1, hunks1.size());
 944 
 945             var hunk1 = hunks1.get(0);
 946             assertEquals(1, hunk1.source().range().start());
 947             assertEquals(1, hunk1.source().range().count());
<span class="line-modified"> 948             assertEquals(suffixPlatformLineEndings(&quot;make&quot;), hunk1.source().lines());</span>
 949 
 950             assertEquals(1, hunk1.target().range().start());
 951             assertEquals(1, hunk1.target().range().count());
<span class="line-modified"> 952             assertEquals(suffixPlatformLineEndings(&quot;make images&quot;), hunk1.target().lines());</span>
 953 
 954             var patch2 = patches.get(1).asTextualPatch();
 955             assertEquals(Path.of(&quot;README&quot;), patch2.source().path().get());
 956             assertEquals(Path.of(&quot;README&quot;), patch2.target().path().get());
 957             assertTrue(patch2.source().type().get().isRegularNonExecutable());
 958             assertTrue(patch2.target().type().get().isRegularNonExecutable());
 959             assertTrue(patch2.status().isModified());
 960 
 961             var hunks2 = patch2.hunks();
 962             assertEquals(1, hunks2.size());
 963 
 964             var hunk2 = hunks2.get(0);
 965             assertEquals(1, hunk2.source().range().start());
 966             assertEquals(1, hunk2.source().range().count());
<span class="line-modified"> 967             assertEquals(suffixPlatformLineEndings(&quot;Hello, readme!&quot;), hunk2.source().lines());</span>
 968 
 969             assertEquals(1, hunk2.target().range().start());
 970             assertEquals(1, hunk2.target().range().count());
<span class="line-modified"> 971             assertEquals(suffixPlatformLineEndings(&quot;Hello, Skara!&quot;), hunk2.target().lines());</span>
 972         }
 973     }
 974 
 975     @ParameterizedTest
 976     @EnumSource(VCS.class)
 977     void testDiffBetweenCommitsWithMultipleHunks(VCS vcs) throws IOException {
 978         try (var dir = new TemporaryDirectory()) {
 979             var r = Repository.init(dir.path(), vcs);
 980 
 981             var abc = dir.path().resolve(&quot;abc.txt&quot;);
 982             Files.write(abc, List.of(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;));
 983 
 984             r.add(abc);
 985             var first = r.commit(&quot;Added ABC&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 986 
 987             Files.write(abc, List.of(&quot;1&quot;, &quot;2&quot;, &quot;B&quot;, &quot;3&quot;), WRITE, TRUNCATE_EXISTING);
 988             r.add(abc);
 989             var second = r.commit(&quot;Modify A and C&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 990 
 991             var diff = r.diff(first, second);
</pre>
<hr />
<pre>
 991             var diff = r.diff(first, second);
 992             assertEquals(first, diff.from());
 993             assertEquals(second, diff.to());
 994 
 995             var patches = diff.patches();
 996             assertEquals(1, patches.size());
 997 
 998             var patch = patches.get(0).asTextualPatch();
 999             assertEquals(Path.of(&quot;abc.txt&quot;), patch.source().path().get());
1000             assertEquals(Path.of(&quot;abc.txt&quot;), patch.target().path().get());
1001             assertTrue(patch.source().type().get().isRegularNonExecutable());
1002             assertTrue(patch.target().type().get().isRegularNonExecutable());
1003             assertTrue(patch.status().isModified());
1004 
1005             var hunks = patch.hunks();
1006             assertEquals(2, hunks.size());
1007 
1008             var hunk1 = hunks.get(0);
1009             assertEquals(1, hunk1.source().range().start());
1010             assertEquals(1, hunk1.source().range().count());
<span class="line-modified">1011             assertEquals(suffixPlatformLineEndings(&quot;A&quot;), hunk1.source().lines());</span>
1012 
1013             assertEquals(1, hunk1.target().range().start());
1014             assertEquals(2, hunk1.target().range().count());
<span class="line-modified">1015             assertEquals(suffixPlatformLineEndings(&quot;1&quot;, &quot;2&quot;), hunk1.target().lines());</span>
1016 
1017             assertEquals(1, hunk1.added());
1018             assertEquals(0, hunk1.removed());
1019             assertEquals(1, hunk1.modified());
1020 
1021             var hunk2 = hunks.get(1);
1022             assertEquals(3, hunk2.source().range().start());
1023             assertEquals(1, hunk2.source().range().count());
<span class="line-modified">1024             assertEquals(suffixPlatformLineEndings(&quot;C&quot;), hunk2.source().lines());</span>
1025 
1026             assertEquals(4, hunk2.target().range().start());
1027             assertEquals(1, hunk2.target().range().count());
<span class="line-modified">1028             assertEquals(suffixPlatformLineEndings(&quot;3&quot;), hunk2.target().lines());</span>
1029 
1030             assertEquals(0, hunk2.added());
1031             assertEquals(0, hunk2.removed());
1032             assertEquals(1, hunk2.modified());
1033         }
1034     }
1035 
1036     @ParameterizedTest
1037     @EnumSource(VCS.class)
1038     void testDiffWithRemoval(VCS vcs) throws IOException {
1039         try (var dir = new TemporaryDirectory()) {
1040             var r = Repository.init(dir.path(), vcs);
1041 
1042             var readme = dir.path().resolve(&quot;README&quot;);
1043             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1044 
1045             r.add(readme);
1046             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1047 
1048             Files.delete(readme);
</pre>
<hr />
<pre>
1052             var diff = r.diff(first, second);
1053             assertEquals(first, diff.from());
1054             assertEquals(second, diff.to());
1055 
1056             var patches = diff.patches();
1057             assertEquals(1, patches.size());
1058 
1059             var patch = patches.get(0).asTextualPatch();
1060             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
1061             assertTrue(patch.target().path().isEmpty());
1062             assertTrue(patch.source().type().get().isRegularNonExecutable());
1063             assertTrue(patch.target().type().isEmpty());
1064             assertTrue(patch.status().isDeleted());
1065 
1066             var hunks = patch.hunks();
1067             assertEquals(1, hunks.size());
1068 
1069             var hunk = hunks.get(0);
1070             assertEquals(1, hunk.source().range().start());
1071             assertEquals(1, hunk.source().range().count());
<span class="line-modified">1072             assertEquals(suffixPlatformLineEndings(&quot;Hello, world!&quot;), hunk.source().lines());</span>
1073 
1074             assertEquals(0, hunk.target().range().start());
1075             assertEquals(0, hunk.target().range().count());
1076             assertEquals(List.of(), hunk.target().lines());
1077 
1078             assertEquals(0, hunk.added());
1079             assertEquals(1, hunk.removed());
1080             assertEquals(0, hunk.modified());
1081         }
1082     }
1083 
1084     @ParameterizedTest
1085     @EnumSource(VCS.class)
1086     void testDiffWithAddition(VCS vcs) throws IOException {
1087         try (var dir = new TemporaryDirectory()) {
1088             var r = Repository.init(dir.path(), vcs);
1089 
1090             var readme = dir.path().resolve(&quot;README&quot;);
1091             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1092 
</pre>
<hr />
<pre>
1105             var patches = diff.patches();
1106             assertEquals(1, patches.size());
1107 
1108             var patch = patches.get(0).asTextualPatch();
1109             assertTrue(patch.source().path().isEmpty());
1110             assertEquals(Path.of(&quot;BUILDING&quot;), patch.target().path().get());
1111             assertTrue(patch.source().type().isEmpty());
1112             assertTrue(patch.target().type().get().isRegularNonExecutable());
1113             assertTrue(patch.status().isAdded());
1114 
1115             var hunks = patch.hunks();
1116             assertEquals(1, hunks.size());
1117 
1118             var hunk = hunks.get(0);
1119             assertEquals(0, hunk.source().range().start());
1120             assertEquals(0, hunk.source().range().count());
1121             assertEquals(List.of(), hunk.source().lines());
1122 
1123             assertEquals(1, hunk.target().range().start());
1124             assertEquals(1, hunk.target().range().count());
<span class="line-modified">1125             assertEquals(suffixPlatformLineEndings(&quot;make&quot;), hunk.target().lines());</span>
1126 
1127             assertEquals(1, hunk.added());
1128             assertEquals(0, hunk.removed());
1129             assertEquals(0, hunk.modified());
1130         }
1131     }
1132 
1133     @ParameterizedTest
1134     @EnumSource(VCS.class)
1135     void testDiffWithWorkingDir(VCS vcs) throws IOException {
1136         try (var dir = new TemporaryDirectory()) {
1137             var r = Repository.init(dir.path(), vcs);
1138 
1139             var readme = dir.path().resolve(&quot;README&quot;);
1140             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1141 
1142             r.add(readme);
1143             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1144 
1145             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
</pre>
<hr />
<pre>
1151             var patches = diff.patches();
1152             assertEquals(1, patches.size());
1153 
1154             var patch = patches.get(0).asTextualPatch();
1155             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
1156             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
1157             assertTrue(patch.source().type().get().isRegularNonExecutable());
1158             assertTrue(patch.target().type().get().isRegularNonExecutable());
1159             assertTrue(patch.status().isModified());
1160 
1161             var hunks = patch.hunks();
1162             assertEquals(1, hunks.size());
1163 
1164             var hunk = hunks.get(0);
1165             assertEquals(2, hunk.source().range().start());
1166             assertEquals(0, hunk.source().range().count());
1167             assertEquals(List.of(), hunk.source().lines());
1168 
1169             assertEquals(2, hunk.target().range().start());
1170             assertEquals(1, hunk.target().range().count());
<span class="line-modified">1171             assertEquals(suffixPlatformLineEndings(&quot;One more line&quot;), hunk.target().lines());</span>
1172 
1173             assertEquals(1, hunk.added());
1174             assertEquals(0, hunk.removed());
1175             assertEquals(0, hunk.modified());
1176         }
1177     }
1178 
1179     @ParameterizedTest
1180     @EnumSource(VCS.class)
1181     void testCommitMetadata(VCS vcs) throws IOException {
1182         try (var dir = new TemporaryDirectory()) {
1183             var r = Repository.init(dir.path(), vcs);
1184 
1185             var readme = dir.path().resolve(&quot;README&quot;);
1186             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1187             r.add(readme);
1188             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1189 
1190             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1191             r.add(readme);
</pre>
<hr />
<pre>
1294             var parents = new HashSet&lt;&gt;(merge.parents());
1295             assertEquals(2, parents.size());
1296             assertTrue(parents.contains(second));
1297             assertTrue(parents.contains(third));
1298 
1299             var diffs = merge.parentDiffs();
1300             assertEquals(2, diffs.size());
1301 
1302             var secondDiff = diffs.stream().filter(d -&gt; d.from().equals(second)).findFirst().get();
1303             assertEquals(merge.hash(), secondDiff.to());
1304             assertEquals(1, secondDiff.patches().size());
1305             var secondPatch = secondDiff.patches().get(0).asTextualPatch();
1306 
1307             assertEquals(Path.of(&quot;README&quot;), secondPatch.source().path().get());
1308             assertEquals(Path.of(&quot;README&quot;), secondPatch.target().path().get());
1309             assertTrue(secondPatch.status().isModified());
1310             assertEquals(1, secondPatch.hunks().size());
1311 
1312             var secondHunk = secondPatch.hunks().get(0);
1313             assertEquals(List.of(), secondHunk.source().lines());
<span class="line-modified">1314             assertEquals(suffixPlatformLineEndings(&quot;One last line&quot;), secondHunk.target().lines());</span>
1315 
1316             assertEquals(3, secondHunk.source().range().start());
1317             assertEquals(0, secondHunk.source().range().count());
1318             assertEquals(3, secondHunk.target().range().start());
1319             assertEquals(1, secondHunk.target().range().count());
1320 
1321             var thirdDiff = diffs.stream().filter(d -&gt; d.from().equals(third)).findFirst().get();
1322             assertEquals(merge.hash(), thirdDiff.to());
1323             assertEquals(1, thirdDiff.patches().size());
1324             var thirdPatch = thirdDiff.patches().get(0).asTextualPatch();
1325 
1326             assertEquals(Path.of(&quot;README&quot;), thirdPatch.source().path().get());
1327             assertEquals(Path.of(&quot;README&quot;), thirdPatch.target().path().get());
1328             assertTrue(thirdPatch.status().isModified());
1329             assertEquals(1, thirdPatch.hunks().size());
1330 
1331             var thirdHunk = thirdPatch.hunks().get(0);
1332             assertEquals(List.of(), thirdHunk.source().lines());
<span class="line-modified">1333             assertEquals(suffixPlatformLineEndings(&quot;One more line&quot;, &quot;One last line&quot;), thirdHunk.target().lines());</span>
1334 
1335             assertEquals(2, thirdHunk.source().range().start());
1336             assertEquals(0, thirdHunk.source().range().count());
1337             assertEquals(2, thirdHunk.target().range().start());
1338             assertEquals(2, thirdHunk.target().range().count());
1339         }
1340     }
1341 
1342     @ParameterizedTest
1343     @EnumSource(VCS.class)
1344     void testDefaultBranch(VCS vcs) throws IOException {
1345         try (var dir = new TemporaryDirectory()) {
1346             var r = Repository.init(dir.path(), vcs);
1347             var expected = vcs == VCS.GIT ? &quot;master&quot; : &quot;default&quot;;
1348             assertEquals(expected, r.defaultBranch().name());
1349         }
1350     }
1351 
1352     @ParameterizedTest
1353     @EnumSource(VCS.class)
</pre>
</td>
<td>
<hr />
<pre>
 295             var patches = diff.patches();
 296             assertEquals(1, patches.size());
 297 
 298             var patch = patches.get(0).asTextualPatch();
 299             assertTrue(patch.status().isAdded());
 300 
 301             assertTrue(patch.source().path().isEmpty());
 302             assertTrue(patch.source().type().isEmpty());
 303 
 304             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 305             assertTrue(patch.target().type().get().isRegularNonExecutable());
 306 
 307             var hunks = patch.hunks();
 308             assertEquals(1, hunks.size());
 309 
 310             var hunk = hunks.get(0);
 311             assertEquals(new Range(0, 0), hunk.source().range());
 312             assertEquals(new Range(1, 1), hunk.target().range());
 313 
 314             assertEquals(List.of(), hunk.source().lines());
<span class="line-modified"> 315             assertLinesEquals(List.of(&quot;Hello, readme!&quot;), hunk.target().lines());</span>
 316         }
 317     }
 318 
<span class="line-modified"> 319     static void assertLinesEquals(List&lt;String&gt; expected, List&lt;String&gt; actual) {</span>
 320         var newLine = System.lineSeparator();
 321         var suffix = newLine.endsWith(&quot;\n&quot;)
 322                 ? newLine.substring(0, newLine.length() - 1) // drop trailing &#39;\n&#39; (keeping any &#39;\r&#39;)
 323                 : newLine;
<span class="line-modified"> 324         assertEquals(expected.stream().map(l -&gt; l + suffix).collect(Collectors.toList()), actual);</span>
 325     }
 326 
 327     @ParameterizedTest
 328     @EnumSource(VCS.class)
 329     void testCommitListingWithMultipleCommits(VCS vcs) throws IOException {
 330         try (var dir = new TemporaryDirectory()) {
 331             var r = Repository.init(dir.path(), vcs);
 332 
 333             var readme = dir.path().resolve(&quot;README&quot;);
 334             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 335 
 336             r.add(readme);
 337             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 338 
 339             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 340             r.add(readme);
 341             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 342 
 343             var commits = r.commits().asList();
 344             assertEquals(2, commits.size());
</pre>
<hr />
<pre>
 371             assertEquals(1, diff.added());
 372 
 373             var patches = diff.patches();
 374             assertEquals(1, patches.size());
 375 
 376             var patch = patches.get(0).asTextualPatch();
 377             assertTrue(patch.status().isModified());
 378             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 379             assertTrue(patch.source().type().get().isRegularNonExecutable());
 380             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 381             assertTrue(patch.target().type().get().isRegularNonExecutable());
 382 
 383             var hunks = patch.hunks();
 384             assertEquals(1, hunks.size());
 385 
 386             var hunk = hunks.get(0);
 387             assertEquals(new Range(2, 0), hunk.source().range());
 388             assertEquals(new Range(2, 1), hunk.target().range());
 389 
 390             assertEquals(List.of(), hunk.source().lines());
<span class="line-modified"> 391             assertLinesEquals(List.of(&quot;Another line&quot;), hunk.target().lines());</span>
 392         }
 393     }
 394 
 395     @ParameterizedTest
 396     @EnumSource(VCS.class)
 397     void testSquashDeletes(VCS vcs) throws IOException {
 398         try (var dir = new TemporaryDirectory()) {
 399             var r = Repository.init(dir.path(), vcs);
 400 
 401             var file1 = dir.path().resolve(&quot;file1.txt&quot;);
 402             Files.write(file1, List.of(&quot;Hello, file 1!&quot;));
 403             var file2 = dir.path().resolve(&quot;file2.txt&quot;);
 404             Files.write(file2, List.of(&quot;Hello, file 2!&quot;));
 405             var file3 = dir.path().resolve(&quot;file3.txt&quot;);
 406             Files.write(file3, List.of(&quot;Hello, file 3!&quot;));
 407 
 408             r.add(file1, file2, file3);
 409             var hash1 = r.commit(&quot;Add files&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 410 
 411             Files.delete(file2);
</pre>
<hr />
<pre>
 503             assertEquals(2, diff.added());
 504 
 505             var patches = diff.patches();
 506             assertEquals(1, patches.size());
 507 
 508             var patch = patches.get(0).asTextualPatch();
 509             assertTrue(patch.status().isModified());
 510             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 511             assertTrue(patch.source().type().get().isRegularNonExecutable());
 512             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 513             assertTrue(patch.target().type().get().isRegularNonExecutable());
 514 
 515             var hunks = patch.hunks();
 516             assertEquals(1, hunks.size());
 517 
 518             var hunk = hunks.get(0);
 519             assertEquals(new Range(2, 0), hunk.source().range());
 520             assertEquals(new Range(2, 2), hunk.target().range());
 521 
 522             assertEquals(List.of(), hunk.source().lines());
<span class="line-modified"> 523             assertLinesEquals(List.of(&quot;Another line&quot;, &quot;A final line&quot;), hunk.target().lines());</span>
 524         }
 525     }
 526 
 527     @ParameterizedTest
 528     @EnumSource(VCS.class)
 529     void testMergeBase(VCS vcs) throws IOException {
 530         try (var dir = new TemporaryDirectory()) {
 531             var r = Repository.init(dir.path(), vcs);
 532 
 533             var readme = dir.path().resolve(&quot;README&quot;);
 534             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 535 
 536             r.add(readme);
 537             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 538 
 539             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 540             r.add(readme);
 541             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 542 
 543             r.checkout(hash1, false);
</pre>
<hr />
<pre>
 600             var head = commits.get(0);
 601             assertEquals(hash2, head.parents().get(0));
 602             assertEquals(List.of(&quot;Add independent change&quot;), head.message());
 603 
 604             var diffs = head.parentDiffs();
 605             assertEquals(1, diffs.size());
 606             var diff = diffs.get(0);
 607 
 608             assertEquals(0, diff.removed());
 609             assertEquals(0, diff.modified());
 610             assertEquals(1, diff.added());
 611 
 612             var patches = diff.patches();
 613             assertEquals(1, patches.size());
 614             var patch = patches.get(0).asTextualPatch();
 615             assertEquals(Path.of(&quot;CONTRIBUTING&quot;), patch.target().path().get());
 616 
 617             var hunks = patch.hunks();
 618             assertEquals(1, hunks.size());
 619             var hunk = hunks.get(0);
<span class="line-modified"> 620             assertLinesEquals(List.of(&quot;Keep the patches coming&quot;), hunk.target().lines());</span>
 621         }
 622     }
 623 
 624     @ParameterizedTest
 625     @EnumSource(VCS.class)
 626     void testInitializedRepositoryIsEmpty(VCS vcs) throws IOException {
 627         try (var dir = new TemporaryDirectory()) {
 628             var r = Repository.init(dir.path(), vcs);
 629             assertTrue(r.isEmpty());
 630         }
 631     }
 632 
 633     @ParameterizedTest
 634     @EnumSource(VCS.class)
 635     void testRepositoryWithCommitIsNonEmpty(VCS vcs) throws IOException {
 636         try (var dir = new TemporaryDirectory()) {
 637             var r = Repository.init(dir.path(), vcs);
 638 
 639             var readme = dir.path().resolve(&quot;README&quot;);
 640             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
</pre>
<hr />
<pre>
 878             var patches = diff.patches();
 879             assertEquals(1, patches.size());
 880 
 881             var patch = patches.get(0).asTextualPatch();
 882             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 883             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 884             assertTrue(patch.source().type().get().isRegularNonExecutable());
 885             assertTrue(patch.target().type().get().isRegularNonExecutable());
 886             assertTrue(patch.status().isModified());
 887 
 888             var hunks = patch.hunks();
 889             assertEquals(1, hunks.size());
 890 
 891             var hunk = hunks.get(0);
 892             assertEquals(2, hunk.source().range().start());
 893             assertEquals(0, hunk.source().range().count());
 894             assertEquals(0, hunk.source().lines().size());
 895 
 896             assertEquals(2, hunk.target().range().start());
 897             assertEquals(1, hunk.target().range().count());
<span class="line-modified"> 898             assertLinesEquals(List.of(&quot;One more line&quot;), hunk.target().lines());</span>
 899 
 900             assertEquals(1, hunk.added());
 901             assertEquals(0, hunk.removed());
 902             assertEquals(0, hunk.modified());
 903         }
 904     }
 905 
 906     @ParameterizedTest
 907     @EnumSource(VCS.class)
 908     void testDiffBetweenCommitsWithMultiplePatches(VCS vcs) throws IOException {
 909         try (var dir = new TemporaryDirectory()) {
 910             var r = Repository.init(dir.path(), vcs);
 911 
 912             var readme = dir.path().resolve(&quot;README&quot;);
 913             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 914 
 915             var building = dir.path().resolve(&quot;BUILDING&quot;);
 916             Files.write(building, List.of(&quot;make&quot;));
 917 
 918             r.add(readme);
</pre>
<hr />
<pre>
 928             var diff = r.diff(first, second);
 929             assertEquals(first, diff.from());
 930             assertEquals(second, diff.to());
 931 
 932             var patches = diff.patches();
 933             assertEquals(2, patches.size());
 934 
 935             var patch1 = patches.get(0).asTextualPatch();
 936             assertEquals(Path.of(&quot;BUILDING&quot;), patch1.source().path().get());
 937             assertEquals(Path.of(&quot;BUILDING&quot;), patch1.target().path().get());
 938             assertTrue(patch1.source().type().get().isRegularNonExecutable());
 939             assertTrue(patch1.target().type().get().isRegularNonExecutable());
 940             assertTrue(patch1.status().isModified());
 941 
 942             var hunks1 = patch1.hunks();
 943             assertEquals(1, hunks1.size());
 944 
 945             var hunk1 = hunks1.get(0);
 946             assertEquals(1, hunk1.source().range().start());
 947             assertEquals(1, hunk1.source().range().count());
<span class="line-modified"> 948             assertLinesEquals(List.of(&quot;make&quot;), hunk1.source().lines());</span>
 949 
 950             assertEquals(1, hunk1.target().range().start());
 951             assertEquals(1, hunk1.target().range().count());
<span class="line-modified"> 952             assertLinesEquals(List.of(&quot;make images&quot;), hunk1.target().lines());</span>
 953 
 954             var patch2 = patches.get(1).asTextualPatch();
 955             assertEquals(Path.of(&quot;README&quot;), patch2.source().path().get());
 956             assertEquals(Path.of(&quot;README&quot;), patch2.target().path().get());
 957             assertTrue(patch2.source().type().get().isRegularNonExecutable());
 958             assertTrue(patch2.target().type().get().isRegularNonExecutable());
 959             assertTrue(patch2.status().isModified());
 960 
 961             var hunks2 = patch2.hunks();
 962             assertEquals(1, hunks2.size());
 963 
 964             var hunk2 = hunks2.get(0);
 965             assertEquals(1, hunk2.source().range().start());
 966             assertEquals(1, hunk2.source().range().count());
<span class="line-modified"> 967             assertLinesEquals(List.of(&quot;Hello, readme!&quot;), hunk2.source().lines());</span>
 968 
 969             assertEquals(1, hunk2.target().range().start());
 970             assertEquals(1, hunk2.target().range().count());
<span class="line-modified"> 971             assertLinesEquals(List.of(&quot;Hello, Skara!&quot;), hunk2.target().lines());</span>
 972         }
 973     }
 974 
 975     @ParameterizedTest
 976     @EnumSource(VCS.class)
 977     void testDiffBetweenCommitsWithMultipleHunks(VCS vcs) throws IOException {
 978         try (var dir = new TemporaryDirectory()) {
 979             var r = Repository.init(dir.path(), vcs);
 980 
 981             var abc = dir.path().resolve(&quot;abc.txt&quot;);
 982             Files.write(abc, List.of(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;));
 983 
 984             r.add(abc);
 985             var first = r.commit(&quot;Added ABC&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 986 
 987             Files.write(abc, List.of(&quot;1&quot;, &quot;2&quot;, &quot;B&quot;, &quot;3&quot;), WRITE, TRUNCATE_EXISTING);
 988             r.add(abc);
 989             var second = r.commit(&quot;Modify A and C&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 990 
 991             var diff = r.diff(first, second);
</pre>
<hr />
<pre>
 991             var diff = r.diff(first, second);
 992             assertEquals(first, diff.from());
 993             assertEquals(second, diff.to());
 994 
 995             var patches = diff.patches();
 996             assertEquals(1, patches.size());
 997 
 998             var patch = patches.get(0).asTextualPatch();
 999             assertEquals(Path.of(&quot;abc.txt&quot;), patch.source().path().get());
1000             assertEquals(Path.of(&quot;abc.txt&quot;), patch.target().path().get());
1001             assertTrue(patch.source().type().get().isRegularNonExecutable());
1002             assertTrue(patch.target().type().get().isRegularNonExecutable());
1003             assertTrue(patch.status().isModified());
1004 
1005             var hunks = patch.hunks();
1006             assertEquals(2, hunks.size());
1007 
1008             var hunk1 = hunks.get(0);
1009             assertEquals(1, hunk1.source().range().start());
1010             assertEquals(1, hunk1.source().range().count());
<span class="line-modified">1011             assertLinesEquals(List.of(&quot;A&quot;), hunk1.source().lines());</span>
1012 
1013             assertEquals(1, hunk1.target().range().start());
1014             assertEquals(2, hunk1.target().range().count());
<span class="line-modified">1015             assertLinesEquals(List.of(&quot;1&quot;, &quot;2&quot;), hunk1.target().lines());</span>
1016 
1017             assertEquals(1, hunk1.added());
1018             assertEquals(0, hunk1.removed());
1019             assertEquals(1, hunk1.modified());
1020 
1021             var hunk2 = hunks.get(1);
1022             assertEquals(3, hunk2.source().range().start());
1023             assertEquals(1, hunk2.source().range().count());
<span class="line-modified">1024             assertLinesEquals(List.of(&quot;C&quot;), hunk2.source().lines());</span>
1025 
1026             assertEquals(4, hunk2.target().range().start());
1027             assertEquals(1, hunk2.target().range().count());
<span class="line-modified">1028             assertLinesEquals(List.of(&quot;3&quot;), hunk2.target().lines());</span>
1029 
1030             assertEquals(0, hunk2.added());
1031             assertEquals(0, hunk2.removed());
1032             assertEquals(1, hunk2.modified());
1033         }
1034     }
1035 
1036     @ParameterizedTest
1037     @EnumSource(VCS.class)
1038     void testDiffWithRemoval(VCS vcs) throws IOException {
1039         try (var dir = new TemporaryDirectory()) {
1040             var r = Repository.init(dir.path(), vcs);
1041 
1042             var readme = dir.path().resolve(&quot;README&quot;);
1043             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1044 
1045             r.add(readme);
1046             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1047 
1048             Files.delete(readme);
</pre>
<hr />
<pre>
1052             var diff = r.diff(first, second);
1053             assertEquals(first, diff.from());
1054             assertEquals(second, diff.to());
1055 
1056             var patches = diff.patches();
1057             assertEquals(1, patches.size());
1058 
1059             var patch = patches.get(0).asTextualPatch();
1060             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
1061             assertTrue(patch.target().path().isEmpty());
1062             assertTrue(patch.source().type().get().isRegularNonExecutable());
1063             assertTrue(patch.target().type().isEmpty());
1064             assertTrue(patch.status().isDeleted());
1065 
1066             var hunks = patch.hunks();
1067             assertEquals(1, hunks.size());
1068 
1069             var hunk = hunks.get(0);
1070             assertEquals(1, hunk.source().range().start());
1071             assertEquals(1, hunk.source().range().count());
<span class="line-modified">1072             assertLinesEquals(List.of(&quot;Hello, world!&quot;), hunk.source().lines());</span>
1073 
1074             assertEquals(0, hunk.target().range().start());
1075             assertEquals(0, hunk.target().range().count());
1076             assertEquals(List.of(), hunk.target().lines());
1077 
1078             assertEquals(0, hunk.added());
1079             assertEquals(1, hunk.removed());
1080             assertEquals(0, hunk.modified());
1081         }
1082     }
1083 
1084     @ParameterizedTest
1085     @EnumSource(VCS.class)
1086     void testDiffWithAddition(VCS vcs) throws IOException {
1087         try (var dir = new TemporaryDirectory()) {
1088             var r = Repository.init(dir.path(), vcs);
1089 
1090             var readme = dir.path().resolve(&quot;README&quot;);
1091             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1092 
</pre>
<hr />
<pre>
1105             var patches = diff.patches();
1106             assertEquals(1, patches.size());
1107 
1108             var patch = patches.get(0).asTextualPatch();
1109             assertTrue(patch.source().path().isEmpty());
1110             assertEquals(Path.of(&quot;BUILDING&quot;), patch.target().path().get());
1111             assertTrue(patch.source().type().isEmpty());
1112             assertTrue(patch.target().type().get().isRegularNonExecutable());
1113             assertTrue(patch.status().isAdded());
1114 
1115             var hunks = patch.hunks();
1116             assertEquals(1, hunks.size());
1117 
1118             var hunk = hunks.get(0);
1119             assertEquals(0, hunk.source().range().start());
1120             assertEquals(0, hunk.source().range().count());
1121             assertEquals(List.of(), hunk.source().lines());
1122 
1123             assertEquals(1, hunk.target().range().start());
1124             assertEquals(1, hunk.target().range().count());
<span class="line-modified">1125             assertLinesEquals(List.of(&quot;make&quot;), hunk.target().lines());</span>
1126 
1127             assertEquals(1, hunk.added());
1128             assertEquals(0, hunk.removed());
1129             assertEquals(0, hunk.modified());
1130         }
1131     }
1132 
1133     @ParameterizedTest
1134     @EnumSource(VCS.class)
1135     void testDiffWithWorkingDir(VCS vcs) throws IOException {
1136         try (var dir = new TemporaryDirectory()) {
1137             var r = Repository.init(dir.path(), vcs);
1138 
1139             var readme = dir.path().resolve(&quot;README&quot;);
1140             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1141 
1142             r.add(readme);
1143             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1144 
1145             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
</pre>
<hr />
<pre>
1151             var patches = diff.patches();
1152             assertEquals(1, patches.size());
1153 
1154             var patch = patches.get(0).asTextualPatch();
1155             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
1156             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
1157             assertTrue(patch.source().type().get().isRegularNonExecutable());
1158             assertTrue(patch.target().type().get().isRegularNonExecutable());
1159             assertTrue(patch.status().isModified());
1160 
1161             var hunks = patch.hunks();
1162             assertEquals(1, hunks.size());
1163 
1164             var hunk = hunks.get(0);
1165             assertEquals(2, hunk.source().range().start());
1166             assertEquals(0, hunk.source().range().count());
1167             assertEquals(List.of(), hunk.source().lines());
1168 
1169             assertEquals(2, hunk.target().range().start());
1170             assertEquals(1, hunk.target().range().count());
<span class="line-modified">1171             assertLinesEquals(List.of(&quot;One more line&quot;), hunk.target().lines());</span>
1172 
1173             assertEquals(1, hunk.added());
1174             assertEquals(0, hunk.removed());
1175             assertEquals(0, hunk.modified());
1176         }
1177     }
1178 
1179     @ParameterizedTest
1180     @EnumSource(VCS.class)
1181     void testCommitMetadata(VCS vcs) throws IOException {
1182         try (var dir = new TemporaryDirectory()) {
1183             var r = Repository.init(dir.path(), vcs);
1184 
1185             var readme = dir.path().resolve(&quot;README&quot;);
1186             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1187             r.add(readme);
1188             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1189 
1190             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1191             r.add(readme);
</pre>
<hr />
<pre>
1294             var parents = new HashSet&lt;&gt;(merge.parents());
1295             assertEquals(2, parents.size());
1296             assertTrue(parents.contains(second));
1297             assertTrue(parents.contains(third));
1298 
1299             var diffs = merge.parentDiffs();
1300             assertEquals(2, diffs.size());
1301 
1302             var secondDiff = diffs.stream().filter(d -&gt; d.from().equals(second)).findFirst().get();
1303             assertEquals(merge.hash(), secondDiff.to());
1304             assertEquals(1, secondDiff.patches().size());
1305             var secondPatch = secondDiff.patches().get(0).asTextualPatch();
1306 
1307             assertEquals(Path.of(&quot;README&quot;), secondPatch.source().path().get());
1308             assertEquals(Path.of(&quot;README&quot;), secondPatch.target().path().get());
1309             assertTrue(secondPatch.status().isModified());
1310             assertEquals(1, secondPatch.hunks().size());
1311 
1312             var secondHunk = secondPatch.hunks().get(0);
1313             assertEquals(List.of(), secondHunk.source().lines());
<span class="line-modified">1314             assertLinesEquals(List.of(&quot;One last line&quot;), secondHunk.target().lines());</span>
1315 
1316             assertEquals(3, secondHunk.source().range().start());
1317             assertEquals(0, secondHunk.source().range().count());
1318             assertEquals(3, secondHunk.target().range().start());
1319             assertEquals(1, secondHunk.target().range().count());
1320 
1321             var thirdDiff = diffs.stream().filter(d -&gt; d.from().equals(third)).findFirst().get();
1322             assertEquals(merge.hash(), thirdDiff.to());
1323             assertEquals(1, thirdDiff.patches().size());
1324             var thirdPatch = thirdDiff.patches().get(0).asTextualPatch();
1325 
1326             assertEquals(Path.of(&quot;README&quot;), thirdPatch.source().path().get());
1327             assertEquals(Path.of(&quot;README&quot;), thirdPatch.target().path().get());
1328             assertTrue(thirdPatch.status().isModified());
1329             assertEquals(1, thirdPatch.hunks().size());
1330 
1331             var thirdHunk = thirdPatch.hunks().get(0);
1332             assertEquals(List.of(), thirdHunk.source().lines());
<span class="line-modified">1333             assertLinesEquals(List.of(&quot;One more line&quot;, &quot;One last line&quot;), thirdHunk.target().lines());</span>
1334 
1335             assertEquals(2, thirdHunk.source().range().start());
1336             assertEquals(0, thirdHunk.source().range().count());
1337             assertEquals(2, thirdHunk.target().range().start());
1338             assertEquals(2, thirdHunk.target().range().count());
1339         }
1340     }
1341 
1342     @ParameterizedTest
1343     @EnumSource(VCS.class)
1344     void testDefaultBranch(VCS vcs) throws IOException {
1345         try (var dir = new TemporaryDirectory()) {
1346             var r = Repository.init(dir.path(), vcs);
1347             var expected = vcs == VCS.GIT ? &quot;master&quot; : &quot;default&quot;;
1348             assertEquals(expected, r.defaultBranch().name());
1349         }
1350     }
1351 
1352     @ParameterizedTest
1353     @EnumSource(VCS.class)
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>