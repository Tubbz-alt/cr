<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/merge/src/test/java/org/openjdk/skara/bots/merge/MergeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/merge/MergeBotFactory.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../../test/src/main/java/org/openjdk/skara/test/TestHost.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/merge/src/test/java/org/openjdk/skara/bots/merge/MergeBotTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 24 
 25 import org.openjdk.skara.host.*;
 26 import org.openjdk.skara.test.*;
 27 import org.openjdk.skara.vcs.*;
 28 
 29 import org.junit.jupiter.api.Test;
 30 import org.junit.jupiter.api.TestInfo;
 31 
 32 import java.io.IOException;
 33 import java.nio.file.Files;
 34 import java.nio.file.StandardOpenOption;
 35 import java.util.*;
 36 import java.util.stream.Collectors;
 37 import java.time.ZonedDateTime;
 38 
 39 import static org.junit.jupiter.api.Assertions.*;
 40 
 41 class MergeBotTests {
 42     @Test
 43     void mergeMasterBranch(TestInfo testInfo) throws IOException {
<span class="line-modified"> 44         try (var temp = new TemporaryDirectory()) {</span>
 45             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 46 
 47             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 48             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 49             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 50 
 51             var toDir = temp.path().resolve(&quot;to.git&quot;);
 52             var toLocalRepo = Repository.init(toDir, VCS.GIT);
<span class="line-modified"> 53             var gitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="line-modified"> 54             Files.write(gitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
 55                         StandardOpenOption.APPEND);
 56             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 57 







 58             var now = ZonedDateTime.now();
 59             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 60             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 61             fromLocalRepo.add(fromFileA);
 62             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 63             var fromCommits = fromLocalRepo.commits().asList();
 64             assertEquals(1, fromCommits.size());
 65             assertEquals(fromHashA, fromCommits.get(0).hash());
 66 
 67             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 68             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 69             toLocalRepo.add(toFileA);
 70             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 71             var toCommits = toLocalRepo.commits().asList();
 72             assertEquals(1, toCommits.size());
 73             assertEquals(toHashA, toCommits.get(0).hash());
 74             assertEquals(fromHashA, toHashA);
 75 
 76             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 77             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
 78             fromLocalRepo.add(fromFileB);
 79             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 80 
 81             var toFileC = toDir.resolve(&quot;c.txt&quot;);
 82             Files.writeString(toFileC, &quot;Hello C\n&quot;);
 83             toLocalRepo.add(toFileC);
 84             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 85 
 86             var storage = temp.path().resolve(&quot;storage&quot;);
 87             var master = new Branch(&quot;master&quot;);
<span class="line-modified"> 88             var bot = new MergeBot(storage, fromHostedRepo, master, toHostedRepo, master);</span>
 89             TestBotRunner.runPeriodicItems(bot);
 90 
 91             toCommits = toLocalRepo.commits().asList();
 92             assertEquals(4, toCommits.size());
 93             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 94             assertTrue(hashes.contains(toHashA));
 95             assertTrue(hashes.contains(fromHashB));
 96             assertTrue(hashes.contains(toHashC));
 97 
 98             var known = Set.of(toHashA, fromHashB, toHashC);
 99             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
100             assertTrue(merge.isMerge());
101             assertEquals(List.of(&quot;Merge&quot;), merge.message());
102             assertEquals(&quot;duke&quot;, merge.author().name());
103             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
104 
105             assertEquals(0, toHostedRepo.pullRequests().size());
106         }
107     }
108 
109     @Test
110     void failingMergeTest(TestInfo testInfo) throws IOException {
<span class="line-modified">111         try (var temp = new TemporaryDirectory()) {</span>
112             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
113 
114             var fromDir = temp.path().resolve(&quot;from.git&quot;);
115             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
116             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
117 
118             var toDir = temp.path().resolve(&quot;to.git&quot;);
119             var toLocalRepo = Repository.init(toDir, VCS.GIT);
<span class="line-modified">120             var gitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="line-modified">121             Files.write(gitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
122                         StandardOpenOption.APPEND);
123             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
124 







125             var now = ZonedDateTime.now();
126             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
127             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
128             fromLocalRepo.add(fromFileA);
129             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
130             var fromCommits = fromLocalRepo.commits().asList();
131             assertEquals(1, fromCommits.size());
132             assertEquals(fromHashA, fromCommits.get(0).hash());
133 
134             var toFileA = toDir.resolve(&quot;a.txt&quot;);
135             Files.writeString(toFileA, &quot;Hello A\n&quot;);
136             toLocalRepo.add(toFileA);
137             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
138             var toCommits = toLocalRepo.commits().asList();
139             assertEquals(1, toCommits.size());
140             assertEquals(toHashA, toCommits.get(0).hash());
141             assertEquals(fromHashA, toHashA);
142 
143             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
144             Files.writeString(fromFileB, &quot;Hello B1\n&quot;);
145             fromLocalRepo.add(fromFileB);
146             var fromHashB = fromLocalRepo.commit(&quot;Adding b1.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
147 
148             var toFileB = toDir.resolve(&quot;b.txt&quot;);
149             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
150             toLocalRepo.add(toFileB);
151             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
152 
153             var storage = temp.path().resolve(&quot;storage&quot;);
154             var master = new Branch(&quot;master&quot;);
<span class="line-modified">155             var bot = new MergeBot(storage, fromHostedRepo, master, toHostedRepo, master);</span>
156             TestBotRunner.runPeriodicItems(bot);
157 
158             toCommits = toLocalRepo.commits().asList();
159             assertEquals(2, toCommits.size());
160             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
161             assertTrue(toHashes.contains(toHashA));
162             assertTrue(toHashes.contains(toHashB));
163 
164             var pullRequests = toHostedRepo.pullRequests();
165             assertEquals(1, pullRequests.size());
166             var pr = pullRequests.get(0);
167             assertEquals(&quot;Cannot automatically merge test:master&quot;, pr.title());
168         }
169     }
170 
171     @Test
172     void failingMergeShouldResultInOnlyOnePR(TestInfo testInfo) throws IOException {
<span class="line-modified">173         try (var temp = new TemporaryDirectory()) {</span>
174             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
175 
176             var fromDir = temp.path().resolve(&quot;from.git&quot;);
177             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
178             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
179 
180             var toDir = temp.path().resolve(&quot;to.git&quot;);
181             var toLocalRepo = Repository.init(toDir, VCS.GIT);
<span class="line-modified">182             var gitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="line-modified">183             Files.write(gitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
184                         StandardOpenOption.APPEND);
185             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
186 







187             var now = ZonedDateTime.now();
188             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
189             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
190             fromLocalRepo.add(fromFileA);
191             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
192             var fromCommits = fromLocalRepo.commits().asList();
193             assertEquals(1, fromCommits.size());
194             assertEquals(fromHashA, fromCommits.get(0).hash());
195 
196             var toFileA = toDir.resolve(&quot;a.txt&quot;);
197             Files.writeString(toFileA, &quot;Hello A\n&quot;);
198             toLocalRepo.add(toFileA);
199             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
200             var toCommits = toLocalRepo.commits().asList();
201             assertEquals(1, toCommits.size());
202             assertEquals(toHashA, toCommits.get(0).hash());
203             assertEquals(fromHashA, toHashA);
204 
205             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
206             Files.writeString(fromFileB, &quot;Hello B1\n&quot;);
207             fromLocalRepo.add(fromFileB);
208             var fromHashB = fromLocalRepo.commit(&quot;Adding b1.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
209 
210             var toFileB = toDir.resolve(&quot;b.txt&quot;);
211             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
212             toLocalRepo.add(toFileB);
213             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
214 
215             var storage = temp.path().resolve(&quot;storage&quot;);
216             var master = new Branch(&quot;master&quot;);
<span class="line-modified">217             var bot = new MergeBot(storage, fromHostedRepo, master, toHostedRepo, master);</span>
218             TestBotRunner.runPeriodicItems(bot);
219             TestBotRunner.runPeriodicItems(bot);
220 
221             toCommits = toLocalRepo.commits().asList();
222             assertEquals(2, toCommits.size());
223             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
224             assertTrue(toHashes.contains(toHashA));
225             assertTrue(toHashes.contains(toHashB));
226 
227             var pullRequests = toHostedRepo.pullRequests();
228             assertEquals(1, pullRequests.size());
229             var pr = pullRequests.get(0);
230             assertEquals(&quot;Cannot automatically merge test:master&quot;, pr.title());
231         }
232     }
233 
234     @Test
235     void resolvedMergeConflictShouldResultInClosedPR(TestInfo testInfo) throws IOException {
236         try (var temp = new TemporaryDirectory(false)) {
237             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
238 
239             var fromDir = temp.path().resolve(&quot;from.git&quot;);
240             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
241             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
242 
243             var toDir = temp.path().resolve(&quot;to.git&quot;);
244             var toLocalRepo = Repository.init(toDir, VCS.GIT);
<span class="line-modified">245             var gitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="line-modified">246             Files.write(gitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
247                         StandardOpenOption.APPEND);
248             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
249 







250             var now = ZonedDateTime.now();
251             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
252             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
253             fromLocalRepo.add(fromFileA);
254             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
255             var fromCommits = fromLocalRepo.commits().asList();
256             assertEquals(1, fromCommits.size());
257             assertEquals(fromHashA, fromCommits.get(0).hash());
258 
259             var toFileA = toDir.resolve(&quot;a.txt&quot;);
260             Files.writeString(toFileA, &quot;Hello A\n&quot;);
261             toLocalRepo.add(toFileA);
262             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
263             var toCommits = toLocalRepo.commits().asList();
264             assertEquals(1, toCommits.size());
265             assertEquals(toHashA, toCommits.get(0).hash());
266             assertEquals(fromHashA, toHashA);
267 
268             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
269             Files.writeString(fromFileB, &quot;Hello B1\n&quot;);
270             fromLocalRepo.add(fromFileB);
271             var fromHashB = fromLocalRepo.commit(&quot;Adding b1.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
272 
273             var toFileB = toDir.resolve(&quot;b.txt&quot;);
274             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
275             toLocalRepo.add(toFileB);
276             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
277 
278             var storage = temp.path().resolve(&quot;storage&quot;);
279             var master = new Branch(&quot;master&quot;);
<span class="line-modified">280             var bot = new MergeBot(storage, fromHostedRepo, master, toHostedRepo, master);</span>
281             TestBotRunner.runPeriodicItems(bot);
282             TestBotRunner.runPeriodicItems(bot);
283 
284             toCommits = toLocalRepo.commits().asList();
285             assertEquals(2, toCommits.size());
286             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
287             assertTrue(toHashes.contains(toHashA));
288             assertTrue(toHashes.contains(toHashB));
289 
290             var pullRequests = toHostedRepo.pullRequests();
291             assertEquals(1, pullRequests.size());
292             var pr = pullRequests.get(0);
293             assertEquals(&quot;Cannot automatically merge test:master&quot;, pr.title());
294 
295             var fetchHead = toLocalRepo.fetch(fromHostedRepo.webUrl(), &quot;master&quot;);
296             toLocalRepo.merge(fetchHead, &quot;ours&quot;);
297             toLocalRepo.commit(&quot;Merge&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
298 
299             toCommits = toLocalRepo.commits().asList();
300             assertEquals(4, toCommits.size());
301 
302             TestBotRunner.runPeriodicItems(bot);
303             pullRequests = toHostedRepo.pullRequests();
304             assertEquals(0, pullRequests.size());
305         }
306     }
307 
308     @Test
309     void resolvedMergeConflictAndThenNewConflict(TestInfo testInfo) throws IOException {
310         try (var temp = new TemporaryDirectory(false)) {
311             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
312 
313             var fromDir = temp.path().resolve(&quot;from.git&quot;);
314             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
315             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
316 
317             var toDir = temp.path().resolve(&quot;to.git&quot;);
318             var toLocalRepo = Repository.init(toDir, VCS.GIT);
<span class="line-modified">319             var gitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="line-modified">320             Files.write(gitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
321                         StandardOpenOption.APPEND);
322             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
323 







324             var now = ZonedDateTime.now();
325             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
326             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
327             fromLocalRepo.add(fromFileA);
328             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
329             var fromCommits = fromLocalRepo.commits().asList();
330             assertEquals(1, fromCommits.size());
331             assertEquals(fromHashA, fromCommits.get(0).hash());
332 
333             var toFileA = toDir.resolve(&quot;a.txt&quot;);
334             Files.writeString(toFileA, &quot;Hello A\n&quot;);
335             toLocalRepo.add(toFileA);
336             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
337             var toCommits = toLocalRepo.commits().asList();
338             assertEquals(1, toCommits.size());
339             assertEquals(toHashA, toCommits.get(0).hash());
340             assertEquals(fromHashA, toHashA);
341 
342             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
343             Files.writeString(fromFileB, &quot;Hello B1\n&quot;);
344             fromLocalRepo.add(fromFileB);
345             var fromHashB = fromLocalRepo.commit(&quot;Adding b1.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
346 
347             var toFileB = toDir.resolve(&quot;b.txt&quot;);
348             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
349             toLocalRepo.add(toFileB);
350             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
351 
352             var storage = temp.path().resolve(&quot;storage&quot;);
353             var master = new Branch(&quot;master&quot;);
<span class="line-modified">354             var bot = new MergeBot(storage, fromHostedRepo, master, toHostedRepo, master);</span>
355             TestBotRunner.runPeriodicItems(bot);
356             TestBotRunner.runPeriodicItems(bot);
357 
358             toCommits = toLocalRepo.commits().asList();
359             assertEquals(2, toCommits.size());
360             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
361             assertTrue(toHashes.contains(toHashA));
362             assertTrue(toHashes.contains(toHashB));
363 
364             var pullRequests = toHostedRepo.pullRequests();
365             assertEquals(1, pullRequests.size());
366             var pr = pullRequests.get(0);
367             assertEquals(&quot;Cannot automatically merge test:master&quot;, pr.title());
368 
369             var fetchHead = toLocalRepo.fetch(fromHostedRepo.webUrl(), &quot;master&quot;);
370             toLocalRepo.merge(fetchHead, &quot;ours&quot;);
371             toLocalRepo.commit(&quot;Merge&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
372 
373             toCommits = toLocalRepo.commits().asList();
374             assertEquals(4, toCommits.size());
</pre>
</td>
<td>
<hr />
<pre>
 24 
 25 import org.openjdk.skara.host.*;
 26 import org.openjdk.skara.test.*;
 27 import org.openjdk.skara.vcs.*;
 28 
 29 import org.junit.jupiter.api.Test;
 30 import org.junit.jupiter.api.TestInfo;
 31 
 32 import java.io.IOException;
 33 import java.nio.file.Files;
 34 import java.nio.file.StandardOpenOption;
 35 import java.util.*;
 36 import java.util.stream.Collectors;
 37 import java.time.ZonedDateTime;
 38 
 39 import static org.junit.jupiter.api.Assertions.*;
 40 
 41 class MergeBotTests {
 42     @Test
 43     void mergeMasterBranch(TestInfo testInfo) throws IOException {
<span class="line-modified"> 44         try (var temp = new TemporaryDirectory(false)) {</span>
 45             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 46 
 47             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 48             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 49             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 50 
 51             var toDir = temp.path().resolve(&quot;to.git&quot;);
 52             var toLocalRepo = Repository.init(toDir, VCS.GIT);
<span class="line-modified"> 53             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="line-modified"> 54             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
 55                         StandardOpenOption.APPEND);
 56             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 57 
<span class="line-added"> 58             var forkDir = temp.path().resolve(&quot;fork.git&quot;);</span>
<span class="line-added"> 59             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);</span>
<span class="line-added"> 60             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="line-added"> 61             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
<span class="line-added"> 62                         StandardOpenOption.APPEND);</span>
<span class="line-added"> 63             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);</span>
<span class="line-added"> 64 </span>
 65             var now = ZonedDateTime.now();
 66             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 67             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 68             fromLocalRepo.add(fromFileA);
 69             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 70             var fromCommits = fromLocalRepo.commits().asList();
 71             assertEquals(1, fromCommits.size());
 72             assertEquals(fromHashA, fromCommits.get(0).hash());
 73 
 74             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 75             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 76             toLocalRepo.add(toFileA);
 77             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 78             var toCommits = toLocalRepo.commits().asList();
 79             assertEquals(1, toCommits.size());
 80             assertEquals(toHashA, toCommits.get(0).hash());
 81             assertEquals(fromHashA, toHashA);
 82 
 83             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 84             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
 85             fromLocalRepo.add(fromFileB);
 86             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 87 
 88             var toFileC = toDir.resolve(&quot;c.txt&quot;);
 89             Files.writeString(toFileC, &quot;Hello C\n&quot;);
 90             toLocalRepo.add(toFileC);
 91             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 92 
 93             var storage = temp.path().resolve(&quot;storage&quot;);
 94             var master = new Branch(&quot;master&quot;);
<span class="line-modified"> 95             var bot = new MergeBot(storage, fromHostedRepo, master, toHostedRepo, master, toFork);</span>
 96             TestBotRunner.runPeriodicItems(bot);
 97 
 98             toCommits = toLocalRepo.commits().asList();
 99             assertEquals(4, toCommits.size());
100             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
101             assertTrue(hashes.contains(toHashA));
102             assertTrue(hashes.contains(fromHashB));
103             assertTrue(hashes.contains(toHashC));
104 
105             var known = Set.of(toHashA, fromHashB, toHashC);
106             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
107             assertTrue(merge.isMerge());
108             assertEquals(List.of(&quot;Merge&quot;), merge.message());
109             assertEquals(&quot;duke&quot;, merge.author().name());
110             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
111 
112             assertEquals(0, toHostedRepo.pullRequests().size());
113         }
114     }
115 
116     @Test
117     void failingMergeTest(TestInfo testInfo) throws IOException {
<span class="line-modified">118         try (var temp = new TemporaryDirectory(false)) {</span>
119             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
120 
121             var fromDir = temp.path().resolve(&quot;from.git&quot;);
122             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
123             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
124 
125             var toDir = temp.path().resolve(&quot;to.git&quot;);
126             var toLocalRepo = Repository.init(toDir, VCS.GIT);
<span class="line-modified">127             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="line-modified">128             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
129                         StandardOpenOption.APPEND);
130             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
131 
<span class="line-added">132             var forkDir = temp.path().resolve(&quot;fork.git&quot;);</span>
<span class="line-added">133             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);</span>
<span class="line-added">134             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="line-added">135             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
<span class="line-added">136                         StandardOpenOption.APPEND);</span>
<span class="line-added">137             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);</span>
<span class="line-added">138 </span>
139             var now = ZonedDateTime.now();
140             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
141             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
142             fromLocalRepo.add(fromFileA);
143             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
144             var fromCommits = fromLocalRepo.commits().asList();
145             assertEquals(1, fromCommits.size());
146             assertEquals(fromHashA, fromCommits.get(0).hash());
147 
148             var toFileA = toDir.resolve(&quot;a.txt&quot;);
149             Files.writeString(toFileA, &quot;Hello A\n&quot;);
150             toLocalRepo.add(toFileA);
151             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
152             var toCommits = toLocalRepo.commits().asList();
153             assertEquals(1, toCommits.size());
154             assertEquals(toHashA, toCommits.get(0).hash());
155             assertEquals(fromHashA, toHashA);
156 
157             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
158             Files.writeString(fromFileB, &quot;Hello B1\n&quot;);
159             fromLocalRepo.add(fromFileB);
160             var fromHashB = fromLocalRepo.commit(&quot;Adding b1.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
161 
162             var toFileB = toDir.resolve(&quot;b.txt&quot;);
163             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
164             toLocalRepo.add(toFileB);
165             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
166 
167             var storage = temp.path().resolve(&quot;storage&quot;);
168             var master = new Branch(&quot;master&quot;);
<span class="line-modified">169             var bot = new MergeBot(storage, fromHostedRepo, master, toHostedRepo, master, toFork);</span>
170             TestBotRunner.runPeriodicItems(bot);
171 
172             toCommits = toLocalRepo.commits().asList();
173             assertEquals(2, toCommits.size());
174             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
175             assertTrue(toHashes.contains(toHashA));
176             assertTrue(toHashes.contains(toHashB));
177 
178             var pullRequests = toHostedRepo.pullRequests();
179             assertEquals(1, pullRequests.size());
180             var pr = pullRequests.get(0);
181             assertEquals(&quot;Cannot automatically merge test:master&quot;, pr.title());
182         }
183     }
184 
185     @Test
186     void failingMergeShouldResultInOnlyOnePR(TestInfo testInfo) throws IOException {
<span class="line-modified">187         try (var temp = new TemporaryDirectory(false)) {</span>
188             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
189 
190             var fromDir = temp.path().resolve(&quot;from.git&quot;);
191             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
192             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
193 
194             var toDir = temp.path().resolve(&quot;to.git&quot;);
195             var toLocalRepo = Repository.init(toDir, VCS.GIT);
<span class="line-modified">196             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="line-modified">197             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
198                         StandardOpenOption.APPEND);
199             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
200 
<span class="line-added">201             var forkDir = temp.path().resolve(&quot;fork.git&quot;);</span>
<span class="line-added">202             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);</span>
<span class="line-added">203             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="line-added">204             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
<span class="line-added">205                         StandardOpenOption.APPEND);</span>
<span class="line-added">206             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);</span>
<span class="line-added">207 </span>
208             var now = ZonedDateTime.now();
209             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
210             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
211             fromLocalRepo.add(fromFileA);
212             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
213             var fromCommits = fromLocalRepo.commits().asList();
214             assertEquals(1, fromCommits.size());
215             assertEquals(fromHashA, fromCommits.get(0).hash());
216 
217             var toFileA = toDir.resolve(&quot;a.txt&quot;);
218             Files.writeString(toFileA, &quot;Hello A\n&quot;);
219             toLocalRepo.add(toFileA);
220             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
221             var toCommits = toLocalRepo.commits().asList();
222             assertEquals(1, toCommits.size());
223             assertEquals(toHashA, toCommits.get(0).hash());
224             assertEquals(fromHashA, toHashA);
225 
226             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
227             Files.writeString(fromFileB, &quot;Hello B1\n&quot;);
228             fromLocalRepo.add(fromFileB);
229             var fromHashB = fromLocalRepo.commit(&quot;Adding b1.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
230 
231             var toFileB = toDir.resolve(&quot;b.txt&quot;);
232             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
233             toLocalRepo.add(toFileB);
234             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
235 
236             var storage = temp.path().resolve(&quot;storage&quot;);
237             var master = new Branch(&quot;master&quot;);
<span class="line-modified">238             var bot = new MergeBot(storage, fromHostedRepo, master, toHostedRepo, master, toFork);</span>
239             TestBotRunner.runPeriodicItems(bot);
240             TestBotRunner.runPeriodicItems(bot);
241 
242             toCommits = toLocalRepo.commits().asList();
243             assertEquals(2, toCommits.size());
244             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
245             assertTrue(toHashes.contains(toHashA));
246             assertTrue(toHashes.contains(toHashB));
247 
248             var pullRequests = toHostedRepo.pullRequests();
249             assertEquals(1, pullRequests.size());
250             var pr = pullRequests.get(0);
251             assertEquals(&quot;Cannot automatically merge test:master&quot;, pr.title());
252         }
253     }
254 
255     @Test
256     void resolvedMergeConflictShouldResultInClosedPR(TestInfo testInfo) throws IOException {
257         try (var temp = new TemporaryDirectory(false)) {
258             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
259 
260             var fromDir = temp.path().resolve(&quot;from.git&quot;);
261             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
262             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
263 
264             var toDir = temp.path().resolve(&quot;to.git&quot;);
265             var toLocalRepo = Repository.init(toDir, VCS.GIT);
<span class="line-modified">266             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="line-modified">267             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
268                         StandardOpenOption.APPEND);
269             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
270 
<span class="line-added">271             var forkDir = temp.path().resolve(&quot;fork.git&quot;);</span>
<span class="line-added">272             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);</span>
<span class="line-added">273             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="line-added">274             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
<span class="line-added">275                         StandardOpenOption.APPEND);</span>
<span class="line-added">276             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);</span>
<span class="line-added">277 </span>
278             var now = ZonedDateTime.now();
279             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
280             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
281             fromLocalRepo.add(fromFileA);
282             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
283             var fromCommits = fromLocalRepo.commits().asList();
284             assertEquals(1, fromCommits.size());
285             assertEquals(fromHashA, fromCommits.get(0).hash());
286 
287             var toFileA = toDir.resolve(&quot;a.txt&quot;);
288             Files.writeString(toFileA, &quot;Hello A\n&quot;);
289             toLocalRepo.add(toFileA);
290             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
291             var toCommits = toLocalRepo.commits().asList();
292             assertEquals(1, toCommits.size());
293             assertEquals(toHashA, toCommits.get(0).hash());
294             assertEquals(fromHashA, toHashA);
295 
296             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
297             Files.writeString(fromFileB, &quot;Hello B1\n&quot;);
298             fromLocalRepo.add(fromFileB);
299             var fromHashB = fromLocalRepo.commit(&quot;Adding b1.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
300 
301             var toFileB = toDir.resolve(&quot;b.txt&quot;);
302             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
303             toLocalRepo.add(toFileB);
304             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
305 
306             var storage = temp.path().resolve(&quot;storage&quot;);
307             var master = new Branch(&quot;master&quot;);
<span class="line-modified">308             var bot = new MergeBot(storage, fromHostedRepo, master, toHostedRepo, master, toFork);</span>
309             TestBotRunner.runPeriodicItems(bot);
310             TestBotRunner.runPeriodicItems(bot);
311 
312             toCommits = toLocalRepo.commits().asList();
313             assertEquals(2, toCommits.size());
314             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
315             assertTrue(toHashes.contains(toHashA));
316             assertTrue(toHashes.contains(toHashB));
317 
318             var pullRequests = toHostedRepo.pullRequests();
319             assertEquals(1, pullRequests.size());
320             var pr = pullRequests.get(0);
321             assertEquals(&quot;Cannot automatically merge test:master&quot;, pr.title());
322 
323             var fetchHead = toLocalRepo.fetch(fromHostedRepo.webUrl(), &quot;master&quot;);
324             toLocalRepo.merge(fetchHead, &quot;ours&quot;);
325             toLocalRepo.commit(&quot;Merge&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
326 
327             toCommits = toLocalRepo.commits().asList();
328             assertEquals(4, toCommits.size());
329 
330             TestBotRunner.runPeriodicItems(bot);
331             pullRequests = toHostedRepo.pullRequests();
332             assertEquals(0, pullRequests.size());
333         }
334     }
335 
336     @Test
337     void resolvedMergeConflictAndThenNewConflict(TestInfo testInfo) throws IOException {
338         try (var temp = new TemporaryDirectory(false)) {
339             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
340 
341             var fromDir = temp.path().resolve(&quot;from.git&quot;);
342             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
343             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
344 
345             var toDir = temp.path().resolve(&quot;to.git&quot;);
346             var toLocalRepo = Repository.init(toDir, VCS.GIT);
<span class="line-modified">347             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="line-modified">348             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
349                         StandardOpenOption.APPEND);
350             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
351 
<span class="line-added">352             var forkDir = temp.path().resolve(&quot;fork.git&quot;);</span>
<span class="line-added">353             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);</span>
<span class="line-added">354             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);</span>
<span class="line-added">355             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),</span>
<span class="line-added">356                         StandardOpenOption.APPEND);</span>
<span class="line-added">357             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);</span>
<span class="line-added">358 </span>
359             var now = ZonedDateTime.now();
360             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
361             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
362             fromLocalRepo.add(fromFileA);
363             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
364             var fromCommits = fromLocalRepo.commits().asList();
365             assertEquals(1, fromCommits.size());
366             assertEquals(fromHashA, fromCommits.get(0).hash());
367 
368             var toFileA = toDir.resolve(&quot;a.txt&quot;);
369             Files.writeString(toFileA, &quot;Hello A\n&quot;);
370             toLocalRepo.add(toFileA);
371             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
372             var toCommits = toLocalRepo.commits().asList();
373             assertEquals(1, toCommits.size());
374             assertEquals(toHashA, toCommits.get(0).hash());
375             assertEquals(fromHashA, toHashA);
376 
377             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
378             Files.writeString(fromFileB, &quot;Hello B1\n&quot;);
379             fromLocalRepo.add(fromFileB);
380             var fromHashB = fromLocalRepo.commit(&quot;Adding b1.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
381 
382             var toFileB = toDir.resolve(&quot;b.txt&quot;);
383             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
384             toLocalRepo.add(toFileB);
385             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
386 
387             var storage = temp.path().resolve(&quot;storage&quot;);
388             var master = new Branch(&quot;master&quot;);
<span class="line-modified">389             var bot = new MergeBot(storage, fromHostedRepo, master, toHostedRepo, master, toFork);</span>
390             TestBotRunner.runPeriodicItems(bot);
391             TestBotRunner.runPeriodicItems(bot);
392 
393             toCommits = toLocalRepo.commits().asList();
394             assertEquals(2, toCommits.size());
395             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
396             assertTrue(toHashes.contains(toHashA));
397             assertTrue(toHashes.contains(toHashB));
398 
399             var pullRequests = toHostedRepo.pullRequests();
400             assertEquals(1, pullRequests.size());
401             var pr = pullRequests.get(0);
402             assertEquals(&quot;Cannot automatically merge test:master&quot;, pr.title());
403 
404             var fetchHead = toLocalRepo.fetch(fromHostedRepo.webUrl(), &quot;master&quot;);
405             toLocalRepo.merge(fetchHead, &quot;ours&quot;);
406             toLocalRepo.commit(&quot;Merge&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
407 
408             toCommits = toLocalRepo.commits().asList();
409             assertEquals(4, toCommits.size());
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/merge/MergeBotFactory.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../../test/src/main/java/org/openjdk/skara/test/TestHost.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>