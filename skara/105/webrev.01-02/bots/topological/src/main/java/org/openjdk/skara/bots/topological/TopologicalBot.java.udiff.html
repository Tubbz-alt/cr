<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff bots/topological/src/main/java/org/openjdk/skara/bots/topological/TopologicalBot.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/topological/src/main/java/org/openjdk/skara/bots/topological/TopologicalBot.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -152,12 +152,13 @@</span>
              .collect(Collectors.toList());
      }
  
      private void mergeIfAhead(Repository repo, Branch branch, Branch parent) throws IOException {
          var fromHash = repo.resolve(parent.name()).orElseThrow();
<span class="udiff-line-added">+         var oldHead = repo.head();</span>
          if (!repo.contains(branch, fromHash)) {
<span class="udiff-line-modified-removed">-             var isFastForward = repo.isAncestor(repo.head(), fromHash);</span>
<span class="udiff-line-modified-added">+             var isFastForward = repo.isAncestor(oldHead, fromHash);</span>
              repo.merge(fromHash);
              if (!isFastForward) {
                  log.info(&quot;Merged &quot; + parent + &quot; into &quot; + branch);
                  repo.commit(&quot;Automatic merge with &quot; + parent, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
              } else {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -167,21 +168,35 @@</span>
                      + log(repo, &quot;origin/&quot; + branch.name(), branch.name()).collect(Collectors.joining(&quot;\n&quot;, &quot;\n&quot;, &quot;\n&quot;)));
              try {
                  repo.push(repo.head(), hostedRepo.getUrl(), branch.name());
              } catch (IOException e) {
                  log.severe(&quot;Pusing failed! Aborting...&quot;);
<span class="udiff-line-modified-removed">-                 repo.abortMerge();</span>
<span class="udiff-line-modified-added">+                 hardReset(repo, oldHead);</span>
                  throw e;
              }
          }
      }
  
<span class="udiff-line-added">+     private void hardReset(Repository repo, Hash oldHead) throws IOException {</span>
<span class="udiff-line-added">+         var process = new ProcessBuilder()</span>
<span class="udiff-line-added">+             .command(&quot;git&quot;, &quot;reset&quot;, &quot;--hard&quot;, oldHead.hex())</span>
<span class="udiff-line-added">+             .directory(repo.root().toFile())</span>
<span class="udiff-line-added">+             .start();</span>
<span class="udiff-line-added">+         await(process);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      private static Stream&lt;String&gt; log(Repository repo, String targetRef, String fromRef) throws IOException {
          var process = new ProcessBuilder()
                  .command(&quot;git&quot;, &quot;log&quot;, targetRef + &quot;..&quot; + fromRef, &quot;--&quot;)
                  .directory(repo.root().toFile())
                  .start();
<span class="udiff-line-added">+         await(process);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         return new BufferedReader(new InputStreamReader(process.getInputStream())).lines();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     private static void await(Process process) throws IOException {</span>
          try {
              int exit = process.waitFor();
              if (exit != 0) {
                  throw new IOException(&quot;Unexpected exit code: &quot; + exit + &quot;\n\n&quot;
                          + new BufferedReader(new InputStreamReader(process.getErrorStream()))
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -189,12 +204,10 @@</span>
                              .collect(Collectors.joining(&quot;\n&quot;)));
              }
          } catch (InterruptedException e) {
              throw new IOException(e);
          }
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         return new BufferedReader(new InputStreamReader(process.getInputStream())).lines();</span>
      }
  
      @Override
      public String toString() {
          return &quot;TopoBot@(&quot; + hostedRepo + &quot;)&quot;;
</pre>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>