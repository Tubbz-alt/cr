<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff bots/topological/src/main/java/org/openjdk/skara/bots/topological/TopologicalBot.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/java/org/openjdk/skara/bots/topological/TopologicalBotTests.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>bots/topological/src/main/java/org/openjdk/skara/bots/topological/TopologicalBot.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 33,12 ***</span>
  import java.nio.charset.StandardCharsets;
  import java.nio.file.Path;
  import java.nio.file.Files;
  import java.net.URLEncoder;
  import java.util.ArrayList;
  import java.util.HashSet;
<span class="line-removed">- import java.util.Iterator;</span>
  import java.util.List;
  import java.util.Set;
  import java.util.logging.Logger;
  import java.util.stream.Collectors;
  import java.util.stream.Stream;
<span class="line-new-header">--- 33,12 ---</span>
  import java.nio.charset.StandardCharsets;
  import java.nio.file.Path;
  import java.nio.file.Files;
  import java.net.URLEncoder;
  import java.util.ArrayList;
<span class="line-added">+ import java.util.Arrays;</span>
  import java.util.HashSet;
  import java.util.List;
  import java.util.Set;
  import java.util.logging.Logger;
  import java.util.stream.Collectors;
  import java.util.stream.Stream;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 87,17 ***</span>
              }
  
              repo.fetchAll();
              var depsFile = repo.root().resolve(depsFileName);
  
<span class="line-modified">!             List&lt;Branch&gt; ordered = orderedBranches(repo, depsFile);</span>
<span class="line-modified">!             log.info(&quot;Merge order &quot; + ordered);</span>
<span class="line-modified">!             for (Branch branch : ordered) {</span>
                  log.info(&quot;Processing branch &quot; + branch + &quot;...&quot;);
                  repo.checkout(branch);
<span class="line-modified">!                 Set&lt;String&gt; parents = new HashSet&lt;&gt;(</span>
<span class="line-removed">-                         Files.exists(depsFile) ? Files.readAllLines(depsFile) : List.of(&quot;master&quot;));</span>
                  List&lt;String&gt; failedMerges = new ArrayList&lt;&gt;();
                  boolean progress;
                  boolean failed;
                  do {
                      // We need to attempt merge parents in any order that works. Keep merging
<span class="line-new-header">--- 87,16 ---</span>
              }
  
              repo.fetchAll();
              var depsFile = repo.root().resolve(depsFileName);
  
<span class="line-modified">!             var orderedBranches = orderedBranches(repo, depsFile);</span>
<span class="line-modified">!             log.info(&quot;Merge order &quot; + orderedBranches);</span>
<span class="line-modified">!             for (var branch : orderedBranches) {</span>
                  log.info(&quot;Processing branch &quot; + branch + &quot;...&quot;);
                  repo.checkout(branch);
<span class="line-modified">!                 var parents = dependencies(depsFile).collect(Collectors.toSet());</span>
                  List&lt;String&gt; failedMerges = new ArrayList&lt;&gt;();
                  boolean progress;
                  boolean failed;
                  do {
                      // We need to attempt merge parents in any order that works. Keep merging
</pre>
<hr />
<pre>
<span class="line-old-header">*** 103,11 ***</span>
                      // We need to attempt merge parents in any order that works. Keep merging
                      // and pushing, until no further progress can be made.
                      progress = false;
                      failed = false;
                      for (var parentsIt = parents.iterator(); parentsIt.hasNext();) {
<span class="line-modified">!                         String parent = parentsIt.next();</span>
                          try {
                              mergeIfAhead(repo, branch, parent);
                              progress = true;
                              parentsIt.remove(); // avoid doing pointless merges
                          } catch(IOException e) {
<span class="line-new-header">--- 102,11 ---</span>
                      // We need to attempt merge parents in any order that works. Keep merging
                      // and pushing, until no further progress can be made.
                      progress = false;
                      failed = false;
                      for (var parentsIt = parents.iterator(); parentsIt.hasNext();) {
<span class="line-modified">!                         var parent = parentsIt.next();</span>
                          try {
                              mergeIfAhead(repo, branch, parent);
                              progress = true;
                              parentsIt.remove(); // avoid doing pointless merges
                          } catch(IOException e) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 127,34 ***</span>
              throw new UncheckedIOException(e);
          }
          log.info(&quot;Ending topobot run&quot;);
      }
  
      private List&lt;Branch&gt; orderedBranches(Repository repo, Path depsFile) throws IOException {
          List&lt;Edge&gt; deps = new ArrayList&lt;&gt;();
<span class="line-modified">!         for (Branch branch : branches) {</span>
              repo.checkout(branch);
<span class="line-modified">!             if (Files.exists(depsFile)) {</span>
<span class="line-removed">-                 Files.lines(depsFile)</span>
<span class="line-removed">-                         .forEach(dep -&gt; deps.add(new Edge(new Branch(dep), branch)));</span>
<span class="line-removed">-             } else {</span>
<span class="line-removed">-                 deps.add(new Edge(new Branch(&quot;master&quot;), branch));</span>
<span class="line-removed">-             }</span>
          }
<span class="line-modified">!         return tsort(deps).stream()</span>
              .filter(branch -&gt; !branch.name().equals(&quot;master&quot;))
              .collect(Collectors.toList());
      }
  
<span class="line-modified">!     private void mergeIfAhead(Repository repo, Branch branch, String parent) throws IOException {</span>
<span class="line-modified">!         if (log(repo, branch.name(), parent).count() != 0) {</span>
<span class="line-modified">!             var fromHash = repo.resolve(parent).orElseThrow();</span>
              var isFastForward = repo.isAncestor(repo.head(), fromHash);
              repo.merge(fromHash);
              if (!isFastForward) {
                  log.info(&quot;Merged &quot; + parent + &quot; into &quot; + branch);
<span class="line-modified">!                 repo.commit(&quot;Automatic merge with &quot; + parent, &quot;topobot&quot;, &quot;&quot;);</span>
              } else {
                  log.info(&quot;Fast forwarded &quot; + branch + &quot; to &quot; + parent);
              }
              log.info(&quot;merge with &quot; + parent + &quot; succeeded. The following commits will be pushed:\n&quot;
                      + log(repo, &quot;origin/&quot; + branch.name(), branch.name()).collect(Collectors.joining(&quot;\n&quot;, &quot;\n&quot;, &quot;\n&quot;)));
<span class="line-new-header">--- 126,42 ---</span>
              throw new UncheckedIOException(e);
          }
          log.info(&quot;Ending topobot run&quot;);
      }
  
<span class="line-added">+     private static Stream&lt;Branch&gt; dependencies(Path depsFile) throws IOException {</span>
<span class="line-added">+         if (Files.exists(depsFile)) {</span>
<span class="line-added">+             var lines = Files.readAllLines(depsFile).stream().filter(s -&gt; !s.isEmpty()).collect(Collectors.toList());</span>
<span class="line-added">+             if (lines.size() &gt; 1) {</span>
<span class="line-added">+                 throw new IllegalStateException(&quot;Multiple non-empty lines in &quot; + depsFile.toString() + &quot;: &quot;</span>
<span class="line-added">+                         + String.join(&quot;\n&quot;, lines));</span>
<span class="line-added">+             }</span>
<span class="line-added">+             return Stream.of(lines.get(0).split(&quot; &quot;)).map(Branch::new);</span>
<span class="line-added">+         } else {</span>
<span class="line-added">+             return Stream.of(new Branch(&quot;master&quot;));</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      private List&lt;Branch&gt; orderedBranches(Repository repo, Path depsFile) throws IOException {
          List&lt;Edge&gt; deps = new ArrayList&lt;&gt;();
<span class="line-modified">!         for (var branch : branches) {</span>
              repo.checkout(branch);
<span class="line-modified">!             dependencies(depsFile).forEach(dep -&gt; deps.add(new Edge(dep, branch)));</span>
          }
<span class="line-modified">!         return TopologicalSort.tsort(deps).stream()</span>
              .filter(branch -&gt; !branch.name().equals(&quot;master&quot;))
              .collect(Collectors.toList());
      }
  
<span class="line-modified">!     private void mergeIfAhead(Repository repo, Branch branch, Branch parent) throws IOException {</span>
<span class="line-modified">!         var fromHash = repo.resolve(parent.name()).orElseThrow();</span>
<span class="line-modified">!         if (!repo.contains(branch, fromHash)) {</span>
              var isFastForward = repo.isAncestor(repo.head(), fromHash);
              repo.merge(fromHash);
              if (!isFastForward) {
                  log.info(&quot;Merged &quot; + parent + &quot; into &quot; + branch);
<span class="line-modified">!                 repo.commit(&quot;Automatic merge with &quot; + parent, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);</span>
              } else {
                  log.info(&quot;Fast forwarded &quot; + branch + &quot; to &quot; + parent);
              }
              log.info(&quot;merge with &quot; + parent + &quot; succeeded. The following commits will be pushed:\n&quot;
                      + log(repo, &quot;origin/&quot; + branch.name(), branch.name()).collect(Collectors.joining(&quot;\n&quot;, &quot;\n&quot;, &quot;\n&quot;)));
</pre>
<hr />
<pre>
<span class="line-old-header">*** 186,54 ***</span>
          }
  
          return new BufferedReader(new InputStreamReader(process.getInputStream())).lines();
      }
  
<span class="line-removed">-     private static class Edge {</span>
<span class="line-removed">-         final Branch from;</span>
<span class="line-removed">-         final Branch to;</span>
<span class="line-removed">- </span>
<span class="line-removed">-         Edge(Branch from, Branch to) {</span>
<span class="line-removed">-             this.from = from;</span>
<span class="line-removed">-             this.to = to;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         @Override</span>
<span class="line-removed">-         public String toString() {</span>
<span class="line-removed">-             return &quot;Edge{&quot; +</span>
<span class="line-removed">-                     &quot;from=&#39;&quot; + from + &#39;\&#39;&#39; +</span>
<span class="line-removed">-                     &quot;, to=&#39;&quot; + to + &#39;\&#39;&#39; +</span>
<span class="line-removed">-                     &#39;}&#39;;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private static List&lt;Branch&gt; tsort(List&lt;Edge&gt; edges) {</span>
<span class="line-removed">-         List&lt;Edge&gt; eCopy = new ArrayList&lt;&gt;(edges);</span>
<span class="line-removed">-         List&lt;Branch&gt; result = new ArrayList&lt;&gt;();</span>
<span class="line-removed">-         while (!eCopy.isEmpty()) {</span>
<span class="line-removed">-             Set&lt;Branch&gt; orphans = eCopy.stream()</span>
<span class="line-removed">-                     .map(e -&gt; e.from)</span>
<span class="line-removed">-                     .filter(f -&gt; eCopy.stream().map(e -&gt; e.to).noneMatch(f::equals))</span>
<span class="line-removed">-                     .collect(Collectors.toSet());</span>
<span class="line-removed">-             if (orphans.isEmpty()) {</span>
<span class="line-removed">-                 throw new IllegalStateException(&quot;Detected a cycle! &quot; + edges);</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-             orphans.forEach(o -&gt; {</span>
<span class="line-removed">-                 result.add(o);</span>
<span class="line-removed">-                 eCopy.removeIf(e -&gt; o.equals(e.from));</span>
<span class="line-removed">-             });</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         // add all leaves</span>
<span class="line-removed">-         edges.stream()</span>
<span class="line-removed">-             .map(e -&gt; e.to)</span>
<span class="line-removed">-             .filter(f -&gt; edges.stream().map(e -&gt; e.from).noneMatch(f::equals))</span>
<span class="line-removed">-             .forEach(result::add);</span>
<span class="line-removed">- </span>
<span class="line-removed">-         return result;</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
      @Override
      public String toString() {
          return &quot;TopoBot@(&quot; + hostedRepo + &quot;)&quot;;
      }
  
<span class="line-new-header">--- 193,10 ---</span>
</pre>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/java/org/openjdk/skara/bots/topological/TopologicalBotTests.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>