<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff cli/src/main/java/org/openjdk/skara/cli/GitPr.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>cli/src/main/java/org/openjdk/skara/cli/GitPr.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 115     }
 116 
 117     private static String rightPad(String s, int length) {
 118         return String.format(&quot;%-&quot; + length + &quot;s&quot;, s);
 119     }
 120 
 121     private static void appendPaddedHTMLComment(Path file, String line) throws IOException {
 122         var end = &quot; --&gt;&quot;;
 123         var pad = 79 - end.length();
 124         var newLine = &quot;\n&quot;;
 125         Files.writeString(file, rightPad(&quot;&lt;!-- &quot; + line, pad) + end + newLine, StandardOpenOption.APPEND);
 126     }
 127 
 128     private static String format(Issue issue) {
 129         var parts = issue.id().split(&quot;-&quot;);
 130         var id = parts.length == 2 ? parts[1] : issue.id();
 131         return id + &quot;: &quot; + issue.title();
 132     }
 133 
 134 
<span class="line-modified"> 135     private static String pullRequestIdArgument(Arguments arguments, ReadOnlyRepository repo) throws IOException {</span>
<span class="line-modified"> 136         if (arguments.at(1).isPresent()) {</span>
<span class="line-modified"> 137             return arguments.at(1).asString();</span>
 138         }
 139 
 140         var currentBranch = repo.currentBranch();
 141         if (currentBranch.isPresent()) {
 142             var lines = repo.config(&quot;pr.&quot; + currentBranch.get().name() + &quot;.id&quot;);
 143             if (lines.size() == 1) {
 144                 return lines.get(0);
 145             }
 146         }
 147 
 148         exit(&quot;error: you must provide a pull request id&quot;);
 149         return null;
 150     }
 151 
 152     private static String statusForPullRequest(PullRequest pr) {
 153         var labels = pr.labels();
 154         if (pr.isDraft()) {
 155             return &quot;DRAFT&quot;;
 156         } else if (labels.contains(&quot;integrated&quot;)) {
 157             return &quot;INTEGRATED&quot;;
</pre>
<hr />
<pre>
 359     }
 360     private static void show(String ref, Hash hash, Path dir) throws IOException {
 361         var pb = new ProcessBuilder(&quot;git&quot;, &quot;diff&quot;, &quot;--binary&quot;,
 362                                                    &quot;--patch&quot;,
 363                                                    &quot;--find-renames=50%&quot;,
 364                                                    &quot;--find-copies=50%&quot;,
 365                                                    &quot;--find-copies-harder&quot;,
 366                                                    &quot;--abbrev&quot;,
 367                                                    ref + &quot;...&quot; + hash.hex());
 368         if (dir != null) {
 369             pb.directory(dir.toFile());
 370         }
 371         pb.inheritIO();
 372 
 373         // git will return 141 (128 + 13) when it receive SIGPIPE (signal 13) from
 374         // e.g. less when a user exits less when looking at a large diff. Therefore
 375         // must allow 141 as a valid exit code.
 376         await(pb.start(), 141);
 377     }
 378 
<span class="line-removed"> 379     private static void gimport() throws IOException {</span>
<span class="line-removed"> 380         var pb = new ProcessBuilder(&quot;hg&quot;, &quot;gimport&quot;);</span>
<span class="line-removed"> 381         pb.inheritIO();</span>
<span class="line-removed"> 382         await(pb.start());</span>
<span class="line-removed"> 383     }</span>
<span class="line-removed"> 384 </span>
<span class="line-removed"> 385     private static void hgImport(Path patch) throws IOException {</span>
<span class="line-removed"> 386         var pb = new ProcessBuilder(&quot;hg&quot;, &quot;import&quot;, &quot;--no-commit&quot;, patch.toAbsolutePath().toString());</span>
<span class="line-removed"> 387         pb.inheritIO();</span>
<span class="line-removed"> 388         await(pb.start());</span>
<span class="line-removed"> 389     }</span>
<span class="line-removed"> 390 </span>
<span class="line-removed"> 391     private static List&lt;String&gt; hgTags() throws IOException, InterruptedException {</span>
<span class="line-removed"> 392         var pb = new ProcessBuilder(&quot;hg&quot;, &quot;tags&quot;, &quot;--quiet&quot;);</span>
<span class="line-removed"> 393         pb.redirectOutput(ProcessBuilder.Redirect.PIPE);</span>
<span class="line-removed"> 394         pb.redirectError(ProcessBuilder.Redirect.INHERIT);</span>
<span class="line-removed"> 395         var p = pb.start();</span>
<span class="line-removed"> 396         var bytes = p.getInputStream().readAllBytes();</span>
<span class="line-removed"> 397         var exited = p.waitFor(1, TimeUnit.MINUTES);</span>
<span class="line-removed"> 398         var exitValue = p.exitValue();</span>
<span class="line-removed"> 399         if (!exited || exitValue != 0) {</span>
<span class="line-removed"> 400             throw new IOException(&quot;&#39;hg tags&#39; exited with value: &quot; + exitValue);</span>
<span class="line-removed"> 401         }</span>
<span class="line-removed"> 402 </span>
<span class="line-removed"> 403         return Arrays.asList(new String(bytes, StandardCharsets.UTF_8).split(&quot;\n&quot;));</span>
<span class="line-removed"> 404     }</span>
<span class="line-removed"> 405 </span>
<span class="line-removed"> 406     private static String hgResolve(String ref) throws IOException, InterruptedException {</span>
<span class="line-removed"> 407         var pb = new ProcessBuilder(&quot;hg&quot;, &quot;log&quot;, &quot;-r&quot;, ref, &quot;--template&quot;, &quot;{node}&quot;);</span>
<span class="line-removed"> 408         pb.redirectOutput(ProcessBuilder.Redirect.PIPE);</span>
<span class="line-removed"> 409         pb.redirectError(ProcessBuilder.Redirect.INHERIT);</span>
<span class="line-removed"> 410         var p = pb.start();</span>
<span class="line-removed"> 411         var bytes = p.getInputStream().readAllBytes();</span>
<span class="line-removed"> 412         var exited = p.waitFor(1, TimeUnit.MINUTES);</span>
<span class="line-removed"> 413         var exitValue = p.exitValue();</span>
<span class="line-removed"> 414         if (!exited || exitValue != 0) {</span>
<span class="line-removed"> 415             throw new IOException(&quot;&#39;hg log&#39; exited with value: &quot; + exitValue);</span>
<span class="line-removed"> 416         }</span>
<span class="line-removed"> 417 </span>
<span class="line-removed"> 418         return new String(bytes, StandardCharsets.UTF_8);</span>
<span class="line-removed"> 419     }</span>
<span class="line-removed"> 420 </span>
 421     private static Path diff(String ref, Hash hash) throws IOException {
 422         return diff(ref, hash, null);
 423     }
 424 
 425     private static Path diff(String ref, Hash hash, Path dir) throws IOException {
 426         var patch = Files.createTempFile(hash.hex(), &quot;.patch&quot;);
 427         var pb = new ProcessBuilder(&quot;git&quot;, &quot;diff&quot;, &quot;--binary&quot;,
 428                                                    &quot;--patch&quot;,
 429                                                    &quot;--find-renames=50%&quot;,
 430                                                    &quot;--find-copies=50%&quot;,
 431                                                    &quot;--find-copies-harder&quot;,
 432                                                    &quot;--abbrev&quot;,
 433                                                    ref + &quot;...&quot; + hash.hex());
 434         if (dir != null) {
 435             pb.directory(dir.toFile());
 436         }
 437         pb.redirectOutput(patch.toFile());
 438         pb.redirectError(ProcessBuilder.Redirect.INHERIT);
 439         await(pb.start());
 440         return patch;
 441     }
 442 
 443     private static void apply(Path patch) throws IOException {
 444         var pb = new ProcessBuilder(&quot;git&quot;, &quot;apply&quot;, &quot;--no-commit&quot;, patch.toString());
 445         pb.inheritIO();
 446         await(pb.start());
 447     }
 448 
 449     private static int longest(List&lt;String&gt; strings) {
 450         return strings.stream().mapToInt(String::length).max().orElse(0);
 451     }
 452 
 453     private static String removeTrailing(String s, String trail) {
 454         return s.endsWith(trail) ?
 455             s.substring(0, s.length() - trail.length()) :
 456             s;
 457     }
 458 
<span class="line-modified"> 459     public static void main(String[] args) throws IOException, InterruptedException {</span>























































 460         var flags = List.of(
 461             Option.shortcut(&quot;u&quot;)
 462                   .fullname(&quot;username&quot;)
 463                   .describe(&quot;NAME&quot;)
 464                   .helptext(&quot;Username on host&quot;)
 465                   .optional(),
 466             Option.shortcut(&quot;r&quot;)
 467                   .fullname(&quot;remote&quot;)
 468                   .describe(&quot;NAME&quot;)
 469                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)
 470                   .optional(),
 471             Option.shortcut(&quot;b&quot;)
 472                   .fullname(&quot;branch&quot;)
 473                   .describe(&quot;NAME&quot;)
 474                   .helptext(&quot;Name of target branch, defaults to &#39;master&#39;&quot;)
 475                   .optional(),
<span class="line-removed"> 476             Option.shortcut(&quot;&quot;)</span>
<span class="line-removed"> 477                   .fullname(&quot;authors&quot;)</span>
<span class="line-removed"> 478                   .describe(&quot;LIST&quot;)</span>
<span class="line-removed"> 479                   .helptext(&quot;Comma separated list of authors&quot;)</span>
<span class="line-removed"> 480                   .optional(),</span>
<span class="line-removed"> 481             Option.shortcut(&quot;&quot;)</span>
<span class="line-removed"> 482                   .fullname(&quot;assignees&quot;)</span>
<span class="line-removed"> 483                   .describe(&quot;LIST&quot;)</span>
<span class="line-removed"> 484                   .helptext(&quot;Comma separated list of assignees&quot;)</span>
<span class="line-removed"> 485                   .optional(),</span>
<span class="line-removed"> 486             Option.shortcut(&quot;&quot;)</span>
<span class="line-removed"> 487                   .fullname(&quot;labels&quot;)</span>
<span class="line-removed"> 488                   .describe(&quot;LIST&quot;)</span>
<span class="line-removed"> 489                   .helptext(&quot;Comma separated list of labels&quot;)</span>
<span class="line-removed"> 490                   .optional(),</span>
<span class="line-removed"> 491             Option.shortcut(&quot;&quot;)</span>
<span class="line-removed"> 492                   .fullname(&quot;issues&quot;)</span>
<span class="line-removed"> 493                   .describe(&quot;LIST&quot;)</span>
<span class="line-removed"> 494                   .helptext(&quot;Comma separated list of issues&quot;)</span>
<span class="line-removed"> 495                   .optional(),</span>
<span class="line-removed"> 496             Option.shortcut(&quot;&quot;)</span>
<span class="line-removed"> 497                   .fullname(&quot;columns&quot;)</span>
<span class="line-removed"> 498                   .describe(&quot;id,title,author,assignees,labels&quot;)</span>
<span class="line-removed"> 499                   .helptext(&quot;Comma separated list of columns to show&quot;)</span>
<span class="line-removed"> 500                   .optional(),</span>
<span class="line-removed"> 501             Switch.shortcut(&quot;&quot;)</span>
<span class="line-removed"> 502                   .fullname(&quot;no-decoration&quot;)</span>
<span class="line-removed"> 503                   .helptext(&quot;Hide any decorations when listing PRs&quot;)</span>
<span class="line-removed"> 504                   .optional(),</span>
<span class="line-removed"> 505             Switch.shortcut(&quot;&quot;)</span>
<span class="line-removed"> 506                   .fullname(&quot;no-draft&quot;)</span>
<span class="line-removed"> 507                   .helptext(&quot;Hide all pull requests in draft state&quot;)</span>
<span class="line-removed"> 508                   .optional(),</span>
 509             Switch.shortcut(&quot;&quot;)
 510                   .fullname(&quot;ignore-workspace&quot;)
 511                   .helptext(&quot;Ignore local changes in worktree and staging area when creating pull request&quot;)
 512                   .optional(),
 513             Switch.shortcut(&quot;&quot;)
 514                   .fullname(&quot;ignore-local-commits&quot;)
 515                   .helptext(&quot;Ignore local commits not pushed when creating pull request&quot;)
 516                   .optional(),
 517             Switch.shortcut(&quot;&quot;)
 518                   .fullname(&quot;publish&quot;)
 519                   .helptext(&quot;Publish the local branch before creating the pull request&quot;)
 520                   .optional(),
<span class="line-removed"> 521             Switch.shortcut(&quot;&quot;)</span>
<span class="line-removed"> 522                   .fullname(&quot;atomic&quot;)</span>
<span class="line-removed"> 523                   .helptext(&quot;Integrate the pull request atomically&quot;)</span>
<span class="line-removed"> 524                   .optional(),</span>
 525             Switch.shortcut(&quot;&quot;)
 526                   .fullname(&quot;jcheck&quot;)
 527                   .helptext(&quot;Run jcheck before creating the pull request&quot;)
 528                   .optional(),
<span class="line-removed"> 529             Switch.shortcut(&quot;&quot;)</span>
<span class="line-removed"> 530                   .fullname(&quot;no-token&quot;)</span>
<span class="line-removed"> 531                   .helptext(&quot;Do not use a personal access token (PAT). Only works for read-only operations.&quot;)</span>
<span class="line-removed"> 532                   .optional(),</span>
<span class="line-removed"> 533             Switch.shortcut(&quot;&quot;)</span>
<span class="line-removed"> 534                   .fullname(&quot;no-checks&quot;)</span>
<span class="line-removed"> 535                   .helptext(&quot;Do not show check status as part of the &#39;git pr status&#39; output&quot;)</span>
<span class="line-removed"> 536                   .optional(),</span>
<span class="line-removed"> 537             Switch.shortcut(&quot;&quot;)</span>
<span class="line-removed"> 538                   .fullname(&quot;mercurial&quot;)</span>
<span class="line-removed"> 539                   .helptext(&quot;Force use of Mercurial (hg)&quot;)</span>
<span class="line-removed"> 540                   .optional(),</span>
 541             Switch.shortcut(&quot;&quot;)
 542                   .fullname(&quot;verbose&quot;)
 543                   .helptext(&quot;Turn on verbose output&quot;)
 544                   .optional(),
 545             Switch.shortcut(&quot;&quot;)
 546                   .fullname(&quot;debug&quot;)
 547                   .helptext(&quot;Turn on debugging output&quot;)
 548                   .optional(),
 549             Switch.shortcut(&quot;&quot;)
 550                   .fullname(&quot;version&quot;)
 551                   .helptext(&quot;Print the version of this tool&quot;)
<span class="line-modified"> 552                   .optional());</span>

 553 
<span class="line-removed"> 554         var actions = List.of(&quot;list&quot;, &quot;fetch&quot;, &quot;show&quot;, &quot;checkout&quot;, &quot;apply&quot;, &quot;integrate&quot;,</span>
<span class="line-removed"> 555                               &quot;approve&quot;, &quot;create&quot;, &quot;close&quot;, &quot;set&quot;, &quot;test&quot;, &quot;status&quot;);</span>
 556         var inputs = List.of(
 557             Input.position(0)
<span class="line-removed"> 558                  .describe(String.join(&quot;|&quot;, actions))</span>
<span class="line-removed"> 559                  .singular()</span>
<span class="line-removed"> 560                  .optional(),</span>
<span class="line-removed"> 561             Input.position(1)</span>
 562                  .describe(&quot;ID&quot;)
 563                  .singular()
 564                  .optional()
 565         );
 566 
 567         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);
<span class="line-modified"> 568         var arguments = parser.parse(args);</span>
<span class="line-modified"> 569 </span>
<span class="line-modified"> 570         if (arguments.contains(&quot;version&quot;)) {</span>
<span class="line-modified"> 571             System.out.println(&quot;git-pr version: &quot; + Version.fromManifest().orElse(&quot;unknown&quot;));</span>
<span class="line-modified"> 572             System.exit(0);</span>
<span class="line-modified"> 573         }</span>
<span class="line-modified"> 574 </span>
<span class="line-modified"> 575         if (arguments.contains(&quot;verbose&quot;) || arguments.contains(&quot;debug&quot;)) {</span>
<span class="line-modified"> 576             var level = arguments.contains(&quot;debug&quot;) ? Level.FINER : Level.FINE;</span>
<span class="line-modified"> 577             Logging.setup(level);</span>









 578         }
 579 
<span class="line-modified"> 580         HttpProxy.setup();</span>
<span class="line-modified"> 581 </span>
<span class="line-modified"> 582         var isMercurial = getSwitch(&quot;mercurial&quot;, arguments);</span>
<span class="line-modified"> 583         var cwd = Path.of(&quot;&quot;).toAbsolutePath();</span>
<span class="line-modified"> 584         var repo = Repository.get(cwd).orElseThrow(() -&gt; new IOException(&quot;no git repository found at &quot; + cwd.toString()));</span>
<span class="line-modified"> 585         var remote = getOption(&quot;remote&quot;, arguments);</span>
<span class="line-modified"> 586         if (remote == null) {</span>
<span class="line-modified"> 587             remote = isMercurial ? &quot;default&quot; : &quot;origin&quot;;</span>
<span class="line-modified"> 588         }</span>
<span class="line-modified"> 589         var remotePullPath = repo.pullPath(remote);</span>
<span class="line-removed"> 590         var username = getOption(&quot;username&quot;, arguments);</span>
<span class="line-removed"> 591         var token = isMercurial ? System.getenv(&quot;HG_TOKEN&quot;) : System.getenv(&quot;GIT_TOKEN&quot;);</span>
<span class="line-removed"> 592         var uri = Remote.toWebURI(remotePullPath);</span>
<span class="line-removed"> 593         var shouldUseToken = !getSwitch(&quot;no-token&quot;, arguments);</span>
<span class="line-removed"> 594         var credentials = !shouldUseToken ?</span>
<span class="line-removed"> 595             null :</span>
<span class="line-removed"> 596             GitCredentials.fill(uri.getHost(), uri.getPath(), username, token, uri.getScheme());</span>
<span class="line-removed"> 597         var forgeURI = URI.create(uri.getScheme() + &quot;://&quot; + uri.getHost());</span>
<span class="line-removed"> 598         var forge = credentials == null ?</span>
<span class="line-removed"> 599             Forge.from(forgeURI) :</span>
<span class="line-removed"> 600             Forge.from(forgeURI, new Credential(credentials.username(), credentials.password()));</span>
<span class="line-removed"> 601         if (forge.isEmpty()) {</span>
<span class="line-removed"> 602             if (!shouldUseToken) {</span>
<span class="line-removed"> 603                 if (arguments.contains(&quot;verbose&quot;)) {</span>
<span class="line-removed"> 604                     System.err.println(&quot;&quot;);</span>
<span class="line-removed"> 605                 }</span>
<span class="line-removed"> 606                 System.err.println(&quot;warning: using git-pr with --no-token may result in rate limiting from &quot; + forgeURI);</span>
<span class="line-removed"> 607                 if (!arguments.contains(&quot;verbose&quot;)) {</span>
<span class="line-removed"> 608                     System.err.println(&quot;         Re-run git-pr with --verbose to see if you are being rate limited&quot;);</span>
<span class="line-removed"> 609                     System.err.println(&quot;&quot;);</span>
 610                 }
<span class="line-modified"> 611             }</span>
<span class="line-modified"> 612             exit(&quot;error: failed to connect to host: &quot; + forgeURI);</span>
<span class="line-modified"> 613         }</span>
<span class="line-modified"> 614         var host = forge.get();</span>
<span class="line-modified"> 615 </span>
<span class="line-modified"> 616         var action = arguments.at(0).isPresent() ? arguments.at(0).asString() : null;</span>
<span class="line-modified"> 617         if (action == null) {</span>
<span class="line-modified"> 618             var lines = repo.config(&quot;pr.default&quot;);</span>
<span class="line-modified"> 619             if (lines.size() == 1) {</span>
<span class="line-modified"> 620                 action = lines.get(0);</span>

 621             }
 622         }
 623 
<span class="line-modified"> 624         if (action == null) {</span>
<span class="line-modified"> 625             System.err.println(&quot;error: you must supply a valid action:&quot;);</span>
<span class="line-modified"> 626             for (var a : actions) {</span>
<span class="line-modified"> 627                 System.err.println(&quot;       - &quot; + a);</span>

















 628             }
<span class="line-removed"> 629             System.err.println(&quot;You can also configure a default action by running &#39;git configure --global pr.default &lt;action&gt;&#39;&quot;);</span>
<span class="line-removed"> 630             System.exit(1);</span>
 631         }
 632 
<span class="line-modified"> 633         if (!shouldUseToken &amp;&amp;</span>
<span class="line-modified"> 634             !List.of(&quot;list&quot;, &quot;fetch&quot;, &quot;show&quot;, &quot;checkout&quot;, &quot;apply&quot;).contains(action)) {</span>
<span class="line-removed"> 635             System.err.println(&quot;error: --no-token can only be used with read-only operations&quot;);</span>
<span class="line-removed"> 636             System.exit(1);</span>
<span class="line-removed"> 637         }</span>
<span class="line-removed"> 638 </span>
<span class="line-removed"> 639         if (action.equals(&quot;create&quot;)) {</span>
<span class="line-removed"> 640             if (isMercurial) {</span>
<span class="line-removed"> 641                 var currentBookmark = repo.currentBookmark();</span>
<span class="line-removed"> 642                 if (!currentBookmark.isPresent()) {</span>
<span class="line-removed"> 643                     System.err.println(&quot;error: no bookmark is active, you must be on an active bookmark&quot;);</span>
<span class="line-removed"> 644                     System.err.println(&quot;&quot;);</span>
<span class="line-removed"> 645                     System.err.println(&quot;To create a bookmark and activate it, run:&quot;);</span>
<span class="line-removed"> 646                     System.err.println(&quot;&quot;);</span>
<span class="line-removed"> 647                     System.err.println(&quot;    hg bookmark NAME-FOR-YOUR-BOOKMARK&quot;);</span>
<span class="line-removed"> 648                     System.err.println(&quot;&quot;);</span>
<span class="line-removed"> 649                     System.exit(1);</span>
<span class="line-removed"> 650                 }</span>
<span class="line-removed"> 651 </span>
<span class="line-removed"> 652                 var bookmark = currentBookmark.get();</span>
<span class="line-removed"> 653                 if (bookmark.equals(new Bookmark(&quot;master&quot;))) {</span>
<span class="line-removed"> 654                     System.err.println(&quot;error: you should not create pull requests from the &#39;master&#39; bookmark&quot;);</span>
<span class="line-removed"> 655                     System.err.println(&quot;To create a bookmark and activate it, run:&quot;);</span>
<span class="line-removed"> 656                     System.err.println(&quot;&quot;);</span>
<span class="line-removed"> 657                     System.err.println(&quot;    hg bookmark NAME-FOR-YOUR-BOOKMARK&quot;);</span>
<span class="line-removed"> 658                     System.err.println(&quot;&quot;);</span>
<span class="line-removed"> 659                     System.exit(1);</span>
<span class="line-removed"> 660                 }</span>
<span class="line-removed"> 661 </span>
<span class="line-removed"> 662                 var tags = hgTags();</span>
<span class="line-removed"> 663                 var upstreams = tags.stream()</span>
<span class="line-removed"> 664                                     .filter(t -&gt; t.endsWith(bookmark.name()))</span>
<span class="line-removed"> 665                                     .collect(Collectors.toList());</span>
<span class="line-removed"> 666                 if (upstreams.isEmpty()) {</span>
<span class="line-removed"> 667                     System.err.println(&quot;error: there is no remote branch for the local bookmark &#39;&quot; + bookmark.name() + &quot;&#39;&quot;);</span>
<span class="line-removed"> 668                     System.err.println(&quot;&quot;);</span>
<span class="line-removed"> 669                     System.err.println(&quot;To create a remote branch and push the commits for your local branch, run:&quot;);</span>
<span class="line-removed"> 670                     System.err.println(&quot;&quot;);</span>
<span class="line-removed"> 671                     System.err.println(&quot;    hg push --bookmark &quot; + bookmark.name());</span>
<span class="line-removed"> 672                     System.err.println(&quot;&quot;);</span>
<span class="line-removed"> 673                     System.exit(1);</span>
<span class="line-removed"> 674                 }</span>
 675 
<span class="line-modified"> 676                 var tagsAndHashes = new HashMap&lt;String, String&gt;();</span>
<span class="line-modified"> 677                 for (var tag : tags) {</span>
<span class="line-modified"> 678                     tagsAndHashes.put(tag, hgResolve(tag));</span>
<span class="line-modified"> 679                 }</span>
<span class="line-modified"> 680                 var bookmarkHash = hgResolve(bookmark.name());</span>
<span class="line-modified"> 681                 if (!tagsAndHashes.containsValue(bookmarkHash)) {</span>
<span class="line-modified"> 682                     System.err.println(&quot;error: there are local commits on bookmark &#39;&quot; + bookmark.name() + &quot;&#39; not present in a remote repository&quot;);</span>
<span class="line-modified"> 683                     System.err.println(&quot;&quot;);</span>
<span class="line-modified"> 684 </span>
<span class="line-modified"> 685                     if (upstreams.size() == 1) {</span>
<span class="line-modified"> 686                         System.err.println(&quot;To push the local commits to the remote repository, run:&quot;);</span>
<span class="line-removed"> 687                         System.err.println(&quot;&quot;);</span>
<span class="line-removed"> 688                         System.err.println(&quot;    hg push --bookmark &quot; + bookmark.name() + &quot; &quot; + upstreams.get(0));</span>
<span class="line-removed"> 689                         System.err.println(&quot;&quot;);</span>
<span class="line-removed"> 690                     } else {</span>
<span class="line-removed"> 691                         System.err.println(&quot;The following paths contains the &quot; + bookmark.name() + &quot; bookmark:&quot;);</span>
<span class="line-removed"> 692                         System.err.println(&quot;&quot;);</span>
<span class="line-removed"> 693                         for (var upstream : upstreams) {</span>
<span class="line-removed"> 694                             System.err.println(&quot;- &quot; + upstream.replace(&quot;/&quot; + bookmark.name(), &quot;&quot;));</span>
<span class="line-removed"> 695                         }</span>
<span class="line-removed"> 696                         System.err.println(&quot;&quot;);</span>
<span class="line-removed"> 697                         System.err.println(&quot;To push the local commits to a remote repository, run:&quot;);</span>
<span class="line-removed"> 698                         System.err.println(&quot;&quot;);</span>
<span class="line-removed"> 699                         System.err.println(&quot;    hg push --bookmark &quot; + bookmark.name() + &quot; &lt;PATH&gt;&quot;);</span>
<span class="line-removed"> 700                         System.err.println(&quot;&quot;);</span>
<span class="line-removed"> 701                     }</span>
<span class="line-removed"> 702                     System.exit(1);</span>
 703                 }








 704 
<span class="line-modified"> 705                 var targetBranch = arguments.get(&quot;branch&quot;).orString(&quot;master&quot;);</span>
<span class="line-modified"> 706                 var targetHash = hgResolve(targetBranch);</span>
<span class="line-modified"> 707                 var commits = repo.commits(targetHash + &quot;..&quot; + bookmarkHash + &quot;-&quot; + targetHash).asList();</span>
<span class="line-modified"> 708                 if (commits.isEmpty()) {</span>
<span class="line-modified"> 709                     System.err.println(&quot;error: no difference between bookmarks &quot; + targetBranch + &quot; and &quot; + bookmark.name());</span>
<span class="line-modified"> 710                     System.err.println(&quot;       Cannot create an empty pull request, have you committed?&quot;);</span>
<span class="line-removed"> 711                     System.exit(1);</span>
<span class="line-removed"> 712                 }</span>
 713 
<span class="line-modified"> 714                 var diff = repo.diff(repo.head());</span>
<span class="line-modified"> 715                 if (!diff.patches().isEmpty()) {</span>
<span class="line-modified"> 716                     System.err.println(&quot;error: there are uncommitted changes in your working tree:&quot;);</span>
<span class="line-modified"> 717                     System.err.println(&quot;&quot;);</span>
<span class="line-modified"> 718                     for (var patch : diff.patches()) {</span>
<span class="line-modified"> 719                         var path = patch.target().path().isPresent() ?</span>
<span class="line-modified"> 720                             patch.target().path().get() : patch.source().path().get();</span>
<span class="line-modified"> 721                         System.err.println(&quot;    &quot; + patch.status().toString() + &quot; &quot; + path.toString());</span>
<span class="line-modified"> 722                     }</span>
<span class="line-modified"> 723                     System.err.println(&quot;&quot;);</span>
<span class="line-modified"> 724                     System.err.println(&quot;If these changes are meant to be part of the pull request, run:&quot;);</span>
<span class="line-modified"> 725                     System.err.println(&quot;&quot;);</span>
<span class="line-removed"> 726                     System.err.println(&quot;    hg commit --amend&quot;);</span>
<span class="line-removed"> 727                     System.err.println(&quot;    hg git-cleanup&quot;);</span>
<span class="line-removed"> 728                     System.err.println(&quot;    hg push --bookmark &quot; + bookmark.name() + &quot; &lt;PATH&gt;&quot;);</span>
<span class="line-removed"> 729                     System.err.println(&quot;    hg gimport&quot;);</span>
<span class="line-removed"> 730                     System.err.println(&quot;&quot;);</span>
<span class="line-removed"> 731                     System.err.println(&quot;If these changes are *not* meant to be part of the pull request, run:&quot;);</span>
<span class="line-removed"> 732                     System.err.println(&quot;&quot;);</span>
<span class="line-removed"> 733                     System.err.println(&quot;    hg shelve&quot;);</span>
<span class="line-removed"> 734                     System.err.println(&quot;&quot;);</span>
<span class="line-removed"> 735                     System.err.println(&quot;(You can later restore the changes by running: hg unshelve)&quot;);</span>
<span class="line-removed"> 736                     System.exit(1);</span>
 737                 }

 738 
<span class="line-modified"> 739                 var remoteRepo = host.repository(projectName(uri)).orElseThrow(() -&gt;</span>
<span class="line-modified"> 740                         new IOException(&quot;Could not find repository at &quot; + uri.toString())</span>
<span class="line-modified"> 741                 );</span>
<span class="line-modified"> 742                 if (token == null) {</span>
<span class="line-modified"> 743                     GitCredentials.approve(credentials);</span>
<span class="line-modified"> 744                 }</span>
<span class="line-modified"> 745                 var parentRepo = remoteRepo.parent().orElseThrow(() -&gt;</span>
<span class="line-modified"> 746                         new IOException(&quot;error: remote repository &quot; + remotePullPath + &quot; is not a fork of any repository&quot;));</span>
<span class="line-modified"> 747 </span>
<span class="line-modified"> 748                 var file = Files.createTempFile(&quot;PULL_REQUEST_&quot;, &quot;.txt&quot;);</span>
<span class="line-removed"> 749                 if (commits.size() == 1) {</span>
<span class="line-removed"> 750                     var commit = commits.get(0);</span>
<span class="line-removed"> 751                     var message = CommitMessageParsers.v1.parse(commit.message());</span>
<span class="line-removed"> 752                     Files.writeString(file, message.title() + &quot;\n&quot;);</span>
<span class="line-removed"> 753                     if (!message.summaries().isEmpty()) {</span>
<span class="line-removed"> 754                         Files.write(file, message.summaries(), StandardOpenOption.APPEND);</span>
<span class="line-removed"> 755                     }</span>
<span class="line-removed"> 756                     if (!message.additional().isEmpty()) {</span>
<span class="line-removed"> 757                         Files.write(file, message.additional(), StandardOpenOption.APPEND);</span>
 758                     }
<span class="line-removed"> 759                 } else {</span>
<span class="line-removed"> 760                     Files.write(file, List.of(&quot;&quot;));</span>
<span class="line-removed"> 761                 }</span>
<span class="line-removed"> 762                 Files.write(file, List.of(</span>
<span class="line-removed"> 763                     &quot;# Please enter the pull request message for your changes. Lines starting&quot;,</span>
<span class="line-removed"> 764                     &quot;# with &#39;#&#39; will be ignored, and an empty message aborts the pull request.&quot;,</span>
<span class="line-removed"> 765                     &quot;# The first line will be considered the subject, use a blank line to separate&quot;,</span>
<span class="line-removed"> 766                     &quot;# the subject from the body.&quot;,</span>
<span class="line-removed"> 767                     &quot;#&quot;,</span>
<span class="line-removed"> 768                     &quot;# Commits to be included from branch &#39;&quot; + bookmark.name() + &quot;&#39;&quot;</span>
<span class="line-removed"> 769                     ),</span>
<span class="line-removed"> 770                     StandardOpenOption.APPEND</span>
<span class="line-removed"> 771                 );</span>
<span class="line-removed"> 772                 for (var commit : commits) {</span>
<span class="line-removed"> 773                     var desc = commit.hash().abbreviate() + &quot;: &quot; + commit.message().get(0);</span>
<span class="line-removed"> 774                     Files.writeString(file, &quot;# - &quot; + desc + &quot;\n&quot;, StandardOpenOption.APPEND);</span>
<span class="line-removed"> 775                 }</span>
<span class="line-removed"> 776                 Files.writeString(file, &quot;#\n&quot;, StandardOpenOption.APPEND);</span>
<span class="line-removed"> 777                 Files.writeString(file, &quot;# Target repository: &quot; + remotePullPath + &quot;\n&quot;, StandardOpenOption.APPEND);</span>
<span class="line-removed"> 778                 Files.writeString(file, &quot;# Target branch: &quot; + targetBranch + &quot;\n&quot;, StandardOpenOption.APPEND);</span>
<span class="line-removed"> 779                 var success = spawnEditor(repo, file);</span>
<span class="line-removed"> 780                 if (!success) {</span>
<span class="line-removed"> 781                     System.err.println(&quot;error: editor exited with non-zero status code, aborting&quot;);</span>
<span class="line-removed"> 782                     System.exit(1);</span>
 783                 }
<span class="line-modified"> 784                 var lines = Files.readAllLines(file)</span>
<span class="line-modified"> 785                                  .stream()</span>
<span class="line-modified"> 786                                  .filter(l -&gt; !l.startsWith(&quot;#&quot;))</span>
<span class="line-modified"> 787                                  .collect(Collectors.toList());</span>
<span class="line-removed"> 788                 var isEmpty = lines.stream().allMatch(String::isEmpty);</span>
<span class="line-removed"> 789                 if (isEmpty) {</span>
<span class="line-removed"> 790                     System.err.println(&quot;error: no message present, aborting&quot;);</span>
<span class="line-removed"> 791                     System.exit(1);</span>
<span class="line-removed"> 792                 }</span>
<span class="line-removed"> 793 </span>
<span class="line-removed"> 794                 var title = lines.get(0);</span>
<span class="line-removed"> 795                 List&lt;String&gt; body = null;</span>
<span class="line-removed"> 796                 if (lines.size() &gt; 1) {</span>
<span class="line-removed"> 797                     body = lines.subList(1, lines.size())</span>
<span class="line-removed"> 798                                 .stream()</span>
<span class="line-removed"> 799                                 .dropWhile(String::isEmpty)</span>
<span class="line-removed"> 800                                 .collect(Collectors.toList());</span>
<span class="line-removed"> 801                 } else {</span>
<span class="line-removed"> 802                     body = Collections.emptyList();</span>
<span class="line-removed"> 803                 }</span>
<span class="line-removed"> 804 </span>
<span class="line-removed"> 805                 var pr = remoteRepo.createPullRequest(parentRepo, targetBranch, bookmark.name(), title, body);</span>
<span class="line-removed"> 806                 if (arguments.contains(&quot;assignees&quot;)) {</span>
<span class="line-removed"> 807                     var usernames = Arrays.asList(arguments.get(&quot;assignees&quot;).asString().split(&quot;,&quot;));</span>
<span class="line-removed"> 808                     var assignees = usernames.stream()</span>
<span class="line-removed"> 809                                              .map(u -&gt; host.user(u))</span>
<span class="line-removed"> 810                                              .filter(Optional::isPresent)</span>
<span class="line-removed"> 811                                              .map(Optional::get)</span>
<span class="line-removed"> 812                                              .collect(Collectors.toList());</span>
<span class="line-removed"> 813                     pr.setAssignees(assignees);</span>
 814                 }
<span class="line-removed"> 815                 System.out.println(pr.webUrl().toString());</span>
<span class="line-removed"> 816                 Files.deleteIfExists(file);</span>
<span class="line-removed"> 817 </span>
<span class="line-removed"> 818                 System.exit(0);</span>
 819             }
<span class="line-modified"> 820             var currentBranch = repo.currentBranch().orElseGet(() -&gt; {</span>
<span class="line-modified"> 821                     System.err.println(&quot;error: the repository is in a detached HEAD state&quot;);</span>
<span class="line-modified"> 822                     System.exit(1);</span>
<span class="line-modified"> 823                     return null;</span>
<span class="line-modified"> 824             });</span>
<span class="line-modified"> 825             if (currentBranch.equals(repo.defaultBranch())) {</span>
<span class="line-removed"> 826                 System.err.println(&quot;error: you should not create pull requests from the &#39;master&#39; branch&quot;);</span>
<span class="line-removed"> 827                 System.err.println(&quot;&quot;);</span>
<span class="line-removed"> 828                 System.err.println(&quot;To create a local branch for your changes and restore the &#39;master&#39; branch, run:&quot;);</span>
<span class="line-removed"> 829                 System.err.println(&quot;&quot;);</span>
<span class="line-removed"> 830                 System.err.println(&quot;    git checkout -b NAME-FOR-YOUR-LOCAL-BRANCH&quot;);</span>
<span class="line-removed"> 831                 System.err.println(&quot;    git branch --force master origin/master&quot;);</span>
<span class="line-removed"> 832                 System.err.println(&quot;&quot;);</span>
 833                 System.exit(1);
 834             }







 835 
<span class="line-modified"> 836             var ignoreWorkspace = getSwitch(&quot;ignore-workspace&quot;, &quot;create&quot;, arguments);</span>
<span class="line-modified"> 837             if (!ignoreWorkspace) {</span>
<span class="line-modified"> 838                 var diff = repo.diff(repo.head());</span>
<span class="line-modified"> 839                 if (!diff.patches().isEmpty()) {</span>
<span class="line-modified"> 840                     System.err.println(&quot;error: there are uncommitted changes in your working tree:&quot;);</span>
<span class="line-modified"> 841                     System.err.println(&quot;&quot;);</span>
<span class="line-removed"> 842                     for (var patch : diff.patches()) {</span>
<span class="line-removed"> 843                         var path = patch.target().path().isPresent() ?</span>
<span class="line-removed"> 844                             patch.target().path().get() : patch.source().path().get();</span>
<span class="line-removed"> 845                         System.err.println(&quot;    &quot; + patch.status().toString() + &quot; &quot; + path.toString());</span>
<span class="line-removed"> 846                     }</span>
<span class="line-removed"> 847                     System.err.println(&quot;&quot;);</span>
<span class="line-removed"> 848                     System.err.println(&quot;If these changes are meant to be part of the pull request, run:&quot;);</span>
<span class="line-removed"> 849                     System.err.println(&quot;&quot;);</span>
<span class="line-removed"> 850                     System.err.println(&quot;    git commit -am &#39;Forgot to add some changes&#39;&quot;);</span>
<span class="line-removed"> 851                     System.err.println(&quot;&quot;);</span>
<span class="line-removed"> 852                     System.err.println(&quot;If these changes are *not* meant to be part of the pull request, run:&quot;);</span>
<span class="line-removed"> 853                     System.err.println(&quot;&quot;);</span>
<span class="line-removed"> 854                     System.err.println(&quot;    git stash&quot;);</span>
<span class="line-removed"> 855                     System.err.println(&quot;&quot;);</span>
<span class="line-removed"> 856                     System.err.println(&quot;(You can later restore the changes by running: git stash pop)&quot;);</span>
<span class="line-removed"> 857                     System.exit(1);</span>
<span class="line-removed"> 858                 }</span>
 859             }

 860 
<span class="line-modified"> 861             var upstream = repo.upstreamFor(currentBranch);</span>
<span class="line-modified"> 862             if (upstream.isEmpty()) {</span>
<span class="line-modified"> 863                 var shouldPublish = getSwitch(&quot;publish&quot;, &quot;create&quot;, arguments);</span>
<span class="line-modified"> 864                 if (shouldPublish) {</span>
<span class="line-modified"> 865                     GitPublish.main(new String[] { &quot;--quiet&quot;, remote });</span>
<span class="line-modified"> 866                     upstream = repo.upstreamFor(currentBranch);</span>
<span class="line-modified"> 867                 } else {</span>
<span class="line-modified"> 868                     System.err.println(&quot;error: there is no remote branch for the local branch &#39;&quot; + currentBranch.name() + &quot;&#39;&quot;);</span>
<span class="line-modified"> 869                     System.err.println(&quot;&quot;);</span>
<span class="line-modified"> 870                     System.err.println(&quot;A remote branch must be present at &quot; + remotePullPath + &quot; to create a pull request&quot;);</span>
<span class="line-modified"> 871                     System.err.println(&quot;To create a remote branch and push the commits for your local branch, run:&quot;);</span>
<span class="line-modified"> 872                     System.err.println(&quot;&quot;);</span>
<span class="line-modified"> 873                     System.err.println(&quot;    git publish&quot;);</span>
<span class="line-modified"> 874                     System.err.println(&quot;&quot;);</span>
<span class="line-modified"> 875                     System.err.println(&quot;If you created the remote branch from another client, you must update this repository.&quot;);</span>
<span class="line-modified"> 876                     System.err.println(&quot;To update remote information for this repository, run:&quot;);</span>
<span class="line-modified"> 877                     System.err.println(&quot;&quot;);</span>
<span class="line-modified"> 878                     System.err.println(&quot;    git fetch &quot; + remote);</span>
<span class="line-removed"> 879                     System.err.println(&quot;    git branch --set-upstream &quot; + currentBranch + &quot; &quot; + remote + &quot;/&quot; + currentBranch);</span>
<span class="line-removed"> 880                     System.err.println(&quot;&quot;);</span>
<span class="line-removed"> 881                     System.exit(1);</span>
 882                 }
 883             }



 884 
<span class="line-modified"> 885             var upstreamRefName = upstream.get().substring(remote.length() + 1);</span>
<span class="line-modified"> 886             repo.fetch(uri, upstreamRefName);</span>
<span class="line-modified"> 887 </span>
<span class="line-modified"> 888             var shouldIgnoreLocalCommits = getSwitch(&quot;ignore-local-commits&quot;, &quot;create&quot;, arguments);</span>
<span class="line-modified"> 889             if (!shouldIgnoreLocalCommits) {</span>
<span class="line-modified"> 890                 var branchCommits = repo.commits(upstream.get() + &quot;..&quot; + currentBranch.name()).asList();</span>
<span class="line-modified"> 891                 if (!branchCommits.isEmpty()) {</span>
<span class="line-modified"> 892                     System.err.println(&quot;error: there are local commits on branch &#39;&quot; + currentBranch.name() + &quot;&#39; not present in the remote repository &quot; + remotePullPath);</span>
<span class="line-modified"> 893                     System.err.println(&quot;&quot;);</span>
<span class="line-modified"> 894                     System.err.println(&quot;All commits must be present in the remote repository to be part of the pull request&quot;);</span>
<span class="line-modified"> 895                     System.err.println(&quot;The following commits are not present in the remote repository:&quot;);</span>
<span class="line-modified"> 896                     System.err.println(&quot;&quot;);</span>
<span class="line-modified"> 897                     for (var commit : branchCommits) {</span>
<span class="line-modified"> 898                         System.err.println(&quot;- &quot; + commit.hash().abbreviate() + &quot;: &quot; + commit.message().get(0));</span>











 899                     }
<span class="line-removed"> 900                     System.err.println(&quot;&quot;);</span>
<span class="line-removed"> 901                     System.err.println(&quot;To push the above local commits to the remote repository, run:&quot;);</span>
<span class="line-removed"> 902                     System.err.println(&quot;&quot;);</span>
<span class="line-removed"> 903                     System.err.println(&quot;    git push &quot; + remote + &quot; &quot; + currentBranch.name());</span>
<span class="line-removed"> 904                     System.err.println(&quot;&quot;);</span>
<span class="line-removed"> 905                     System.exit(1);</span>
 906                 }
 907             }







 908 
<span class="line-modified"> 909             var remoteRepo = host.repository(projectName(uri)).orElseThrow(() -&gt;</span>
<span class="line-modified"> 910                     new IOException(&quot;Could not find repository at &quot; + uri.toString())</span>
<span class="line-modified"> 911             );</span>
<span class="line-modified"> 912             if (token == null) {</span>
<span class="line-modified"> 913                 GitCredentials.approve(credentials);</span>
<span class="line-modified"> 914             }</span>
<span class="line-modified"> 915             var parentRepo = remoteRepo.parent().orElseThrow(() -&gt;</span>
<span class="line-modified"> 916                     new IOException(&quot;error: remote repository &quot; + remotePullPath + &quot; is not a fork of any repository&quot;)</span>
<span class="line-modified"> 917             );</span>
<span class="line-modified"> 918 </span>
<span class="line-modified"> 919             var targetBranch = getOption(&quot;branch&quot;, &quot;create&quot;, arguments);</span>
<span class="line-modified"> 920             if (targetBranch == null) {</span>
<span class="line-modified"> 921                 var upstreamBranchNames = repo.remoteBranches(parentRepo.webUrl().toString())</span>
<span class="line-modified"> 922                                               .stream()</span>
<span class="line-removed"> 923                                               .map(r -&gt; r.name())</span>
<span class="line-removed"> 924                                               .collect(Collectors.toSet());</span>
<span class="line-removed"> 925                 var remoteBranches = repo.branches(remote);</span>
<span class="line-removed"> 926                 var candidates = new ArrayList&lt;Branch&gt;();</span>
<span class="line-removed"> 927                 for (var b : remoteBranches) {</span>
<span class="line-removed"> 928                     var withoutRemotePrefix = b.name().substring(remote.length() + 1);</span>
<span class="line-removed"> 929                     if (upstreamBranchNames.contains(withoutRemotePrefix)) {</span>
<span class="line-removed"> 930                         candidates.add(b);</span>
<span class="line-removed"> 931                     }</span>
<span class="line-removed"> 932                 }</span>
<span class="line-removed"> 933 </span>
<span class="line-removed"> 934                 var localBranches = repo.branches();</span>
<span class="line-removed"> 935                 Branch closest = null;</span>
<span class="line-removed"> 936                 var shortestDistance = Integer.MAX_VALUE;</span>
<span class="line-removed"> 937                 for (var b : candidates) {</span>
<span class="line-removed"> 938                     var from = b.name();</span>
<span class="line-removed"> 939                     for (var localBranch : localBranches) {</span>
<span class="line-removed"> 940                         var trackingBranch = repo.upstreamFor(localBranch);</span>
<span class="line-removed"> 941                         if (trackingBranch.isPresent() &amp;&amp;</span>
<span class="line-removed"> 942                             trackingBranch.get().equals(b.name())) {</span>
<span class="line-removed"> 943                             from = localBranch.name();</span>
<span class="line-removed"> 944                         }</span>
<span class="line-removed"> 945                     }</span>
<span class="line-removed"> 946                     var distance = repo.commitMetadata(from + &quot;...&quot; + currentBranch.name()).size();</span>
<span class="line-removed"> 947                     if (distance &lt; shortestDistance) {</span>
<span class="line-removed"> 948                         closest = b;</span>
<span class="line-removed"> 949                         shortestDistance = distance;</span>
<span class="line-removed"> 950                     }</span>
<span class="line-removed"> 951                 }</span>
<span class="line-removed"> 952 </span>
<span class="line-removed"> 953                 if (closest != null) {</span>
<span class="line-removed"> 954                     targetBranch = closest.name().substring(remote.length() + 1);</span>
<span class="line-removed"> 955                 } else {</span>
<span class="line-removed"> 956                     System.err.println(&quot;error: cannot automatically infer target branch&quot;);</span>
<span class="line-removed"> 957                     System.err.println(&quot;       use --branch to specify target branch&quot;);</span>
<span class="line-removed"> 958                     System.exit(1);</span>
<span class="line-removed"> 959                 }</span>
<span class="line-removed"> 960             }</span>
<span class="line-removed"> 961             var commits = repo.commits(targetBranch + &quot;..&quot; + upstream.get()).asList();</span>
<span class="line-removed"> 962             if (commits.isEmpty()) {</span>
<span class="line-removed"> 963                 System.err.println(&quot;error: no difference between branches &quot; + targetBranch + &quot; and &quot; + currentBranch.name());</span>
<span class="line-removed"> 964                 System.err.println(&quot;       Cannot create an empty pull request, have you committed?&quot;);</span>
<span class="line-removed"> 965                 System.exit(1);</span>
<span class="line-removed"> 966             }</span>
 967 
<span class="line-modified"> 968             var shouldRunJCheck = getSwitch(&quot;jcheck&quot;, &quot;create&quot;, arguments);</span>
<span class="line-modified"> 969             if (shouldRunJCheck) {</span>
<span class="line-modified"> 970                 var jcheckArgs = new String[]{ &quot;--pull-request&quot;, &quot;--rev&quot;, targetBranch + &quot;..&quot; + upstream.get() };</span>
<span class="line-modified"> 971                 var err = GitJCheck.run(jcheckArgs);</span>
<span class="line-modified"> 972                 if (err != 0) {</span>
<span class="line-modified"> 973                     System.exit(err);</span>
<span class="line-modified"> 974                 }</span>
<span class="line-modified"> 975             }</span>


 976 
<span class="line-modified"> 977             var project = jbsProjectFromJcheckConf(repo, targetBranch);</span>
<span class="line-modified"> 978             var issue = getIssue(currentBranch, project);</span>
<span class="line-modified"> 979             var file = Files.createTempFile(&quot;PULL_REQUEST_&quot;, &quot;.md&quot;);</span>
<span class="line-modified"> 980             if (issue.isPresent()) {</span>
<span class="line-modified"> 981                 Files.writeString(file, format(issue.get()) + &quot;\n\n&quot;);</span>
<span class="line-modified"> 982             } else if (commits.size() == 1) {</span>
<span class="line-modified"> 983                 var commit = commits.get(0);</span>
<span class="line-modified"> 984                 issue = getIssue(commit, project);</span>
<span class="line-modified"> 985                 if (issue.isPresent()) {</span>
<span class="line-modified"> 986                     Files.writeString(file, format(issue.get()) + &quot;\n\n&quot;);</span>
<span class="line-modified"> 987                 } else {</span>
<span class="line-modified"> 988                     var message = CommitMessageParsers.v1.parse(commit.message());</span>
<span class="line-modified"> 989                     Files.writeString(file, message.title() + &quot;\n&quot;);</span>
<span class="line-removed"> 990                     if (!message.summaries().isEmpty()) {</span>
<span class="line-removed"> 991                         Files.write(file, message.summaries(), StandardOpenOption.APPEND);</span>
<span class="line-removed"> 992                     }</span>
<span class="line-removed"> 993                     if (!message.additional().isEmpty()) {</span>
<span class="line-removed"> 994                         Files.write(file, message.additional(), StandardOpenOption.APPEND);</span>
<span class="line-removed"> 995                     }</span>
<span class="line-removed"> 996                 }</span>
<span class="line-removed"> 997             } else {</span>
<span class="line-removed"> 998                 Files.write(file, List.of(&quot;&quot;));</span>
<span class="line-removed"> 999             }</span>
1000 
<span class="line-modified">1001             appendPaddedHTMLComment(file, &quot;Please enter the pull request message for your changes.&quot;);</span>
<span class="line-modified">1002             appendPaddedHTMLComment(file, &quot;The first line will be considered the subject, use a blank line to&quot;);</span>
<span class="line-removed">1003             appendPaddedHTMLComment(file, &quot;separate the subject from the body. These HTML comment lines will&quot;);</span>
<span class="line-removed">1004             appendPaddedHTMLComment(file, &quot;be removed automatically. An empty message aborts the pull request.&quot;);</span>
<span class="line-removed">1005             appendPaddedHTMLComment(file, &quot;&quot;);</span>
<span class="line-removed">1006             appendPaddedHTMLComment(file, &quot;Commits to be included from branch &#39;&quot; + currentBranch.name() + &quot;&#39;:&quot;);</span>
<span class="line-removed">1007             for (var commit : commits) {</span>
<span class="line-removed">1008                 var desc = commit.hash().abbreviate() + &quot;: &quot; + commit.message().get(0);</span>
<span class="line-removed">1009                 appendPaddedHTMLComment(file, &quot;- &quot; + desc);</span>
<span class="line-removed">1010                 if (!commit.isMerge()) {</span>
<span class="line-removed">1011                     var diff = commit.parentDiffs().get(0);</span>
<span class="line-removed">1012                     for (var patch : diff.patches()) {</span>
<span class="line-removed">1013                         var status = patch.status();</span>
<span class="line-removed">1014                         if (status.isModified()) {</span>
<span class="line-removed">1015                             appendPaddedHTMLComment(file, &quot;  M  &quot; + patch.target().path().get().toString());</span>
<span class="line-removed">1016                         } else if (status.isAdded()) {</span>
<span class="line-removed">1017                             appendPaddedHTMLComment(file, &quot;  A  &quot; + patch.target().path().get().toString());</span>
<span class="line-removed">1018                         } else if (status.isDeleted()) {</span>
<span class="line-removed">1019                             appendPaddedHTMLComment(file, &quot;  D  &quot; + patch.source().path().get().toString());</span>
<span class="line-removed">1020                         } else if (status.isRenamed()) {</span>
<span class="line-removed">1021                             appendPaddedHTMLComment(file, &quot;  R  &quot; + patch.target().path().get().toString());</span>
<span class="line-removed">1022                             appendPaddedHTMLComment(file, &quot;      (&quot; + patch.source().path().get().toString() + &quot;)&quot;);</span>
<span class="line-removed">1023                         } else if (status.isCopied()) {</span>
<span class="line-removed">1024                             appendPaddedHTMLComment(file, &quot;  C  &quot; + patch.target().path().get().toString());</span>
<span class="line-removed">1025                             appendPaddedHTMLComment(file, &quot;      (&quot; + patch.source().path().get().toString() + &quot;)&quot;);</span>
<span class="line-removed">1026                         }</span>
<span class="line-removed">1027                     }</span>
<span class="line-removed">1028                 }</span>
<span class="line-removed">1029             }</span>
<span class="line-removed">1030             appendPaddedHTMLComment(file, &quot;&quot;);</span>
<span class="line-removed">1031             if (issue.isPresent()) {</span>
<span class="line-removed">1032                 appendPaddedHTMLComment(file, &quot;Issue:      &quot; + issue.get().webUrl());</span>
<span class="line-removed">1033             }</span>
<span class="line-removed">1034             appendPaddedHTMLComment(file, &quot;Repository: &quot; + parentRepo.webUrl());</span>
<span class="line-removed">1035             appendPaddedHTMLComment(file, &quot;Branch:     &quot; + targetBranch);</span>
1036 
<span class="line-modified">1037             var success = spawnEditor(repo, file);</span>
<span class="line-modified">1038             if (!success) {</span>
<span class="line-modified">1039                 System.err.println(&quot;error: editor exited with non-zero status code, aborting&quot;);</span>
<span class="line-modified">1040                 System.exit(1);</span>
<span class="line-modified">1041             }</span>
<span class="line-modified">1042             var lines = Files.readAllLines(file)</span>
<span class="line-modified">1043                              .stream()</span>
<span class="line-modified">1044                              .filter(l -&gt; !(l.startsWith(&quot;&lt;!--&quot;) &amp;&amp; l.endsWith(&quot;--&gt;&quot;)))</span>
<span class="line-modified">1045                              .collect(Collectors.toList());</span>
<span class="line-modified">1046             var isEmpty = lines.stream().allMatch(String::isEmpty);</span>
<span class="line-modified">1047             if (isEmpty) {</span>
<span class="line-modified">1048                 System.err.println(&quot;error: no message present, aborting&quot;);</span>
<span class="line-modified">1049                 System.exit(1);</span>
<span class="line-modified">1050             }</span>















1051 
<span class="line-modified">1052             var title = lines.get(0);</span>
<span class="line-modified">1053             List&lt;String&gt; body = null;</span>
<span class="line-modified">1054             if (lines.size() &gt; 1) {</span>
<span class="line-modified">1055                 body = lines.subList(1, lines.size())</span>
<span class="line-modified">1056                             .stream()</span>
<span class="line-modified">1057                             .dropWhile(String::isEmpty)</span>
<span class="line-removed">1058                             .collect(Collectors.toList());</span>
<span class="line-removed">1059             } else {</span>
<span class="line-removed">1060                 body = Collections.emptyList();</span>
<span class="line-removed">1061             }</span>
1062 
<span class="line-modified">1063             var pr = remoteRepo.createPullRequest(parentRepo, targetBranch, currentBranch.name(), title, body);</span>
<span class="line-modified">1064             var assigneesOption = getOption(&quot;assignees&quot;, &quot;create&quot;, arguments);</span>
<span class="line-modified">1065             if (assigneesOption != null) {</span>
<span class="line-modified">1066                 var usernames = Arrays.asList(assigneesOption.split(&quot;,&quot;));</span>
<span class="line-modified">1067                 var assignees = usernames.stream()</span>
<span class="line-modified">1068                                          .map(u -&gt; host.user(u))</span>
<span class="line-modified">1069                                          .filter(Optional::isPresent)</span>
<span class="line-modified">1070                                          .map(Optional::get)</span>
<span class="line-modified">1071                                          .collect(Collectors.toList());</span>
<span class="line-modified">1072                 pr.setAssignees(assignees);</span>
<span class="line-modified">1073             }</span>
<span class="line-modified">1074             System.out.println(pr.webUrl().toString());</span>
<span class="line-modified">1075             Files.deleteIfExists(file);</span>
<span class="line-modified">1076 </span>
<span class="line-removed">1077             repo.config(&quot;pr.&quot; + currentBranch.name(), &quot;id&quot;, pr.id().toString());</span>
<span class="line-removed">1078         } else if (action.equals(&quot;integrate&quot;)) {</span>
<span class="line-removed">1079             var id = pullRequestIdArgument(arguments, repo);</span>
<span class="line-removed">1080             var pr = getPullRequest(uri, repo, host, id);</span>
<span class="line-removed">1081             var isAtomic = getSwitch(&quot;atomic&quot;, &quot;integrate&quot;, arguments);</span>
<span class="line-removed">1082 </span>
<span class="line-removed">1083             var message = &quot;/integrate&quot;;</span>
<span class="line-removed">1084             if (isAtomic) {</span>
<span class="line-removed">1085                 var targetHash = repo.resolve(pr.targetRef());</span>
<span class="line-removed">1086                 if (!targetHash.isPresent()) {</span>
<span class="line-removed">1087                     exit(&quot;error: cannot resolve target branch &quot; + pr.targetRef());</span>
<span class="line-removed">1088                 }</span>
<span class="line-removed">1089                 var sourceHash = repo.fetch(pr.repository().webUrl(), pr.fetchRef());</span>
<span class="line-removed">1090                 var mergeBase = repo.mergeBase(sourceHash, targetHash.get());</span>
<span class="line-removed">1091                 message += &quot; &quot; + mergeBase.hex();</span>
1092             }




1093 
<span class="line-modified">1094             var integrateComment = pr.addComment(message);</span>
1095 
<span class="line-modified">1096             var seenIntegrateComment = false;</span>
<span class="line-modified">1097             var expected = &quot;&lt;!-- Jmerge command reply message (&quot; + integrateComment.id() + &quot;) --&gt;&quot;;</span>
<span class="line-modified">1098             for (var i = 0; i &lt; 90; i++) {</span>
<span class="line-modified">1099                 var comments = pr.comments();</span>
<span class="line-modified">1100                 for (var comment : comments) {</span>
<span class="line-modified">1101                     if (!seenIntegrateComment) {</span>
<span class="line-modified">1102                         if (comment.id().equals(integrateComment.id())) {</span>
<span class="line-modified">1103                             seenIntegrateComment = true;</span>
<span class="line-removed">1104                         }</span>
<span class="line-removed">1105                         continue;</span>
<span class="line-removed">1106                     }</span>
<span class="line-removed">1107                     var lines = comment.body().split(&quot;\n&quot;);</span>
<span class="line-removed">1108                     if (lines.length &gt; 0 &amp;&amp; lines[0].equals(expected)) {</span>
<span class="line-removed">1109                         for (var line : lines) {</span>
<span class="line-removed">1110                             if (line.startsWith(&quot;Pushed as commit&quot;)) {</span>
<span class="line-removed">1111                                 var output = removeTrailing(line, &quot;.&quot;);</span>
<span class="line-removed">1112                                 System.out.println(output);</span>
<span class="line-removed">1113                                 System.exit(0);</span>
<span class="line-removed">1114                             }</span>
<span class="line-removed">1115                         }</span>
1116                     }

1117                 }
<span class="line-modified">1118 </span>
<span class="line-modified">1119                 Thread.sleep(2000);</span>
<span class="line-modified">1120             }</span>
<span class="line-modified">1121 </span>
<span class="line-modified">1122             System.err.println(&quot;error: timed out waiting for response to /integrate command&quot;);</span>
<span class="line-removed">1123             System.exit(1);</span>
<span class="line-removed">1124         } else if (action.equals(&quot;test&quot;)) {</span>
<span class="line-removed">1125             var id = pullRequestIdArgument(arguments, repo);</span>
<span class="line-removed">1126             var pr = getPullRequest(uri, repo, host, id);</span>
<span class="line-removed">1127             var head = pr.headHash();</span>
<span class="line-removed">1128             var testComment = pr.addComment(&quot;/test&quot;);</span>
<span class="line-removed">1129 </span>
<span class="line-removed">1130             var seenTestComment = false;</span>
<span class="line-removed">1131             for (var i = 0; i &lt; 90; i++) {</span>
<span class="line-removed">1132                 var comments = pr.comments();</span>
<span class="line-removed">1133                 for (var comment : comments) {</span>
<span class="line-removed">1134                     if (!seenTestComment) {</span>
<span class="line-removed">1135                         if (comment.id().equals(testComment.id())) {</span>
<span class="line-removed">1136                             seenTestComment = true;</span>
<span class="line-removed">1137                         }</span>
<span class="line-removed">1138                         continue;</span>
<span class="line-removed">1139                     }</span>
<span class="line-removed">1140                     var lines = comment.body().split(&quot;\n&quot;);</span>
<span class="line-removed">1141                     var n = lines.length;</span>
<span class="line-removed">1142                     if (n &gt; 0) {</span>
<span class="line-removed">1143                         if (n == 4 &amp;&amp;</span>
<span class="line-removed">1144                             lines[0].equals(&quot;&lt;!-- TEST STARTED --&gt;&quot;) &amp;&amp;</span>
<span class="line-removed">1145                             lines[1].startsWith(&quot;&lt;!-- github.com-&quot;) &amp;&amp;</span>
<span class="line-removed">1146                             lines[2].equals(&quot;&lt;!-- &quot; + head.hex() + &quot; --&gt;&quot;)) {</span>
<span class="line-removed">1147                             var output = removeTrailing(lines[3], &quot;.&quot;);</span>
<span class="line-removed">1148                             System.out.println(output);</span>
<span class="line-removed">1149                             System.exit(0);</span>
<span class="line-removed">1150                         } else if (n == 2 &amp;&amp;</span>
<span class="line-removed">1151                                    lines[0].equals(&quot;&lt;!-- TEST ERROR --&gt;&quot;)) {</span>
<span class="line-removed">1152                             var output = removeTrailing(lines[1], &quot;.&quot;);</span>
<span class="line-removed">1153                             System.out.println(output);</span>
<span class="line-removed">1154                             System.exit(1);</span>
<span class="line-removed">1155                         } else if (n == 4 &amp;&amp;</span>
<span class="line-removed">1156                                    lines[0].equals(&quot;&lt;!-- TEST PENDING --&gt;&quot;) &amp;&amp;</span>
<span class="line-removed">1157                                    lines[1].equals(&quot;&lt;!--- &quot; + head.hex() + &quot; --&gt;&quot;)) {</span>
<span class="line-removed">1158                             var output = removeTrailing(lines[3], &quot;.&quot;);</span>
1159                             System.out.println(output);
1160                             System.exit(0);
1161                         }
1162                     }
1163                 }
<span class="line-removed">1164 </span>
<span class="line-removed">1165                 Thread.sleep(2000);</span>
1166             }
1167 
<span class="line-modified">1168         } else if (action.equals(&quot;approve&quot;)) {</span>
<span class="line-modified">1169             var id = arguments.at(1).isPresent() ? arguments.at(1).asString() : null;</span>
<span class="line-removed">1170             if (id == null) {</span>
<span class="line-removed">1171                 exit(&quot;error: you must provide a pull request id&quot;);</span>
<span class="line-removed">1172             }</span>
<span class="line-removed">1173             var pr = getPullRequest(uri, repo, host, id);</span>
<span class="line-removed">1174             pr.addReview(Review.Verdict.APPROVED, &quot;Looks good!&quot;);</span>
<span class="line-removed">1175         } else if (action.equals(&quot;list&quot;)) {</span>
<span class="line-removed">1176             var remoteRepo = getHostedRepositoryFor(uri, repo, host);</span>
<span class="line-removed">1177             var prs = remoteRepo.pullRequests();</span>
<span class="line-removed">1178             var ids = new ArrayList&lt;String&gt;();</span>
<span class="line-removed">1179             var titles = new ArrayList&lt;String&gt;();</span>
<span class="line-removed">1180             var authors = new ArrayList&lt;String&gt;();</span>
<span class="line-removed">1181             var assignees = new ArrayList&lt;String&gt;();</span>
<span class="line-removed">1182             var labels = new ArrayList&lt;String&gt;();</span>
<span class="line-removed">1183             var issues = new ArrayList&lt;String&gt;();</span>
<span class="line-removed">1184             var branches = new ArrayList&lt;String&gt;();</span>
<span class="line-removed">1185             var statuses = new ArrayList&lt;String&gt;();</span>
<span class="line-removed">1186             var noDraft = getSwitch(&quot;no-draft&quot;, &quot;list&quot;, arguments);</span>
<span class="line-removed">1187 </span>
<span class="line-removed">1188             var authorsOption = getOption(&quot;authors&quot;, &quot;list&quot;, arguments);</span>
<span class="line-removed">1189             var filterAuthors = authorsOption == null ?</span>
<span class="line-removed">1190                 Set.of() :</span>
<span class="line-removed">1191                 new HashSet&lt;&gt;(Arrays.asList(authorsOption.split(&quot;,&quot;)));</span>
<span class="line-removed">1192 </span>
<span class="line-removed">1193             var assigneesOption = getOption(&quot;assignees&quot;, &quot;list&quot;, arguments);</span>
<span class="line-removed">1194             var filterAssignees = assigneesOption == null ?</span>
<span class="line-removed">1195                 Set.of() :</span>
<span class="line-removed">1196                 Arrays.asList(assigneesOption.split(&quot;,&quot;));</span>
<span class="line-removed">1197 </span>
<span class="line-removed">1198             var labelsOption = getOption(&quot;labels&quot;, &quot;list&quot;, arguments);</span>
<span class="line-removed">1199             var filterLabels = labelsOption == null ?</span>
<span class="line-removed">1200                 Set.of() :</span>
<span class="line-removed">1201                 Arrays.asList(labelsOption.split(&quot;,&quot;));</span>
<span class="line-removed">1202 </span>
<span class="line-removed">1203             var issuesOption = getOption(&quot;issues&quot;, &quot;list&quot;, arguments);</span>
<span class="line-removed">1204             var filterIssues = issuesOption == null ?</span>
<span class="line-removed">1205                 Set.of() :</span>
<span class="line-removed">1206                 Arrays.asList(issuesOption.split(&quot;,&quot;));</span>
<span class="line-removed">1207 </span>
<span class="line-removed">1208             var columnTitles = List.of(&quot;id&quot;, &quot;title&quot;, &quot;authors&quot;, &quot;assignees&quot;, &quot;labels&quot;, &quot;issues&quot;, &quot;branch&quot;, &quot;status&quot;);</span>
<span class="line-removed">1209             var columnValues = Map.of(columnTitles.get(0), ids,</span>
<span class="line-removed">1210                                       columnTitles.get(1), titles,</span>
<span class="line-removed">1211                                       columnTitles.get(2), authors,</span>
<span class="line-removed">1212                                       columnTitles.get(3), assignees,</span>
<span class="line-removed">1213                                       columnTitles.get(4), labels,</span>
<span class="line-removed">1214                                       columnTitles.get(5), issues,</span>
<span class="line-removed">1215                                       columnTitles.get(6), branches,</span>
<span class="line-removed">1216                                       columnTitles.get(7), statuses);</span>
<span class="line-removed">1217             var columnsOption = getOption(&quot;columns&quot;, &quot;list&quot;, arguments);</span>
<span class="line-removed">1218             var columns = columnsOption == null ?</span>
<span class="line-removed">1219                 List.of(&quot;id&quot;, &quot;title&quot;, &quot;authors&quot;, &quot;status&quot;) :</span>
<span class="line-removed">1220                 Arrays.asList(columnsOption.split(&quot;,&quot;));</span>
<span class="line-removed">1221 </span>
<span class="line-removed">1222             for (var column : columns) {</span>
<span class="line-removed">1223                 if (!columnTitles.contains(column)) {</span>
<span class="line-removed">1224                     System.err.println(&quot;error: unknown column: &quot; + column);</span>
<span class="line-removed">1225                     System.err.println(&quot;       available columns are: &quot; + String.join(&quot;,&quot;, columnTitles));</span>
<span class="line-removed">1226                     System.exit(1);</span>
<span class="line-removed">1227                 }</span>
<span class="line-removed">1228             }</span>
1229 
<span class="line-modified">1230             for (var pr : prs) {</span>
<span class="line-modified">1231                 if (pr.isDraft() &amp;&amp; noDraft) {</span>
<span class="line-modified">1232                     continue;</span>
<span class="line-removed">1233                 }</span>
1234 
<span class="line-modified">1235                 var prAuthor = pr.author().userName();</span>
<span class="line-modified">1236                 if (!filterAuthors.isEmpty() &amp;&amp; !filterAuthors.contains(prAuthor)) {</span>
<span class="line-modified">1237                     continue;</span>
<span class="line-modified">1238                 }</span>





















1239 
<span class="line-modified">1240                 var prAssignees = pr.assignees().stream()</span>
<span class="line-modified">1241                                     .map(HostUser::userName)</span>
<span class="line-modified">1242                                     .collect(Collectors.toSet());</span>
<span class="line-modified">1243                 if (!filterAssignees.isEmpty() &amp;&amp; !filterAssignees.stream().anyMatch(prAssignees::contains)) {</span>




















1244                     continue;
1245                 }
<span class="line-modified">1246 </span>
<span class="line-modified">1247                 var prLabels = new HashSet&lt;&gt;(pr.labels());</span>
<span class="line-modified">1248                 if (!filterLabels.isEmpty() &amp;&amp; !filterLabels.stream().anyMatch(prLabels::contains)) {</span>
<span class="line-modified">1249                     continue;</span>


















1250                 }

1251 
<span class="line-modified">1252                 var prIssues = new HashSet&lt;&gt;(issuesFromPullRequest(pr));</span>
<span class="line-modified">1253                 if (!filterIssues.isEmpty() &amp;&amp; !filterIssues.stream().anyMatch(prIssues::contains)) {</span>
<span class="line-modified">1254                     continue;</span>
<span class="line-removed">1255                 }</span>
1256 

























1257 
<span class="line-modified">1258                 ids.add(pr.id());</span>
<span class="line-modified">1259                 titles.add(pr.title());</span>
<span class="line-modified">1260                 authors.add(prAuthor);</span>
<span class="line-modified">1261                 assignees.add(String.join(&quot;,&quot;, prAssignees));</span>
<span class="line-modified">1262                 labels.add(String.join(&quot;,&quot;, prLabels));</span>
<span class="line-modified">1263                 issues.add(String.join(&quot;,&quot;, prIssues));</span>









1264 
<span class="line-modified">1265                 if (pr.author().userName().equals(credentials.username()) &amp;&amp;</span>
<span class="line-modified">1266                     pr.sourceRepository().webUrl().equals(uri)) {</span>
<span class="line-modified">1267                     branches.add(pr.sourceRef());</span>
<span class="line-modified">1268                 } else {</span>
<span class="line-modified">1269                     branches.add(&quot;&quot;);</span>
<span class="line-modified">1270                 }</span>























































1271 
<span class="line-modified">1272                 if (columns.contains(&quot;status&quot;)) {</span>
<span class="line-modified">1273                     statuses.add(statusForPullRequest(pr).toLowerCase());</span>
<span class="line-modified">1274                 } else {</span>
<span class="line-modified">1275                     statuses.add(&quot;&quot;);</span>
<span class="line-modified">1276                 }</span>



























































1277             }

1278 




1279 
<span class="line-modified">1280             String fmt = &quot;&quot;;</span>
<span class="line-modified">1281             for (var column : columns.subList(0, columns.size() - 1)) {</span>
<span class="line-modified">1282                 var values = columnValues.get(column);</span>
<span class="line-removed">1283                 var n = Math.max(column.length(), longest(values));</span>
<span class="line-removed">1284                 fmt += &quot;%-&quot; + n + &quot;s    &quot;;</span>
1285             }
<span class="line-modified">1286             fmt += &quot;%s\n&quot;;</span>
<span class="line-modified">1287 </span>
<span class="line-modified">1288             var noDecoration = getSwitch(&quot;no-decoration&quot;, &quot;list&quot;, arguments);</span>
<span class="line-modified">1289             if (!ids.isEmpty() &amp;&amp; !noDecoration) {</span>
<span class="line-modified">1290                 var upperCase = columns.stream()</span>
<span class="line-modified">1291                                        .map(String::toUpperCase)</span>
<span class="line-removed">1292                                        .collect(Collectors.toList());</span>
<span class="line-removed">1293                 System.out.format(fmt, (Object[]) upperCase.toArray(new String[0]));</span>
1294             }
<span class="line-modified">1295             for (var i = 0; i &lt; ids.size(); i++) {</span>
<span class="line-modified">1296                 final int n = i;</span>
<span class="line-modified">1297                 var row = columns.stream()</span>
<span class="line-modified">1298                                  .map(columnValues::get)</span>
<span class="line-removed">1299                                  .map(values -&gt; values.get(n))</span>
<span class="line-removed">1300                                  .collect(Collectors.toList());</span>
<span class="line-removed">1301                 System.out.format(fmt, (Object[]) row.toArray(new String[0]));</span>
1302             }
<span class="line-modified">1303         } else if (action.equals(&quot;fetch&quot;) || action.equals(&quot;checkout&quot;) || action.equals(&quot;show&quot;) || action.equals(&quot;apply&quot;)) {</span>
<span class="line-modified">1304             var prId = arguments.at(1);</span>
<span class="line-modified">1305             if (!prId.isPresent()) {</span>
<span class="line-modified">1306                 exit(&quot;error: missing pull request identifier&quot;);</span>
1307             }
1308 
<span class="line-removed">1309             var remoteRepo = getHostedRepositoryFor(uri, repo, host);</span>
<span class="line-removed">1310             var pr = remoteRepo.pullRequest(prId.asString());</span>
<span class="line-removed">1311             var repoUrl = remoteRepo.webUrl();</span>
<span class="line-removed">1312             var prHeadRef = pr.fetchRef();</span>
<span class="line-removed">1313             var isHgGit = isMercurial &amp;&amp; Repository.exists(repo.root().resolve(&quot;.hg&quot;).resolve(&quot;git&quot;));</span>
<span class="line-removed">1314             if (isHgGit) {</span>
<span class="line-removed">1315                 var hgGitRepo = Repository.get(repo.root().resolve(&quot;.hg&quot;).resolve(&quot;git&quot;)).get();</span>
<span class="line-removed">1316                 var hgGitFetchHead = hgGitRepo.fetch(repoUrl, prHeadRef);</span>
<span class="line-removed">1317 </span>
<span class="line-removed">1318                 if (action.equals(&quot;show&quot;) || action.equals(&quot;apply&quot;)) {</span>
<span class="line-removed">1319                     var target = hgGitRepo.fetch(repoUrl, pr.targetRef());</span>
<span class="line-removed">1320                     var hgGitMergeBase = hgGitRepo.mergeBase(target, hgGitFetchHead);</span>
<span class="line-removed">1321 </span>
<span class="line-removed">1322                     if (action.equals(&quot;show&quot;)) {</span>
<span class="line-removed">1323                         show(hgGitMergeBase.hex(), hgGitFetchHead, hgGitRepo.root());</span>
<span class="line-removed">1324                     } else {</span>
<span class="line-removed">1325                         var patch = diff(hgGitMergeBase.hex(), hgGitFetchHead, hgGitRepo.root());</span>
<span class="line-removed">1326                         hgImport(patch);</span>
<span class="line-removed">1327                         Files.delete(patch);</span>
<span class="line-removed">1328                     }</span>
<span class="line-removed">1329                 } else if (action.equals(&quot;fetch&quot;) || action.equals(&quot;checkout&quot;)) {</span>
<span class="line-removed">1330                     var hgGitRef = prHeadRef.endsWith(&quot;/head&quot;) ? prHeadRef.replace(&quot;/head&quot;, &quot;&quot;) : prHeadRef;</span>
<span class="line-removed">1331                     var hgGitBranches = hgGitRepo.branches();</span>
<span class="line-removed">1332                     if (hgGitBranches.contains(new Branch(hgGitRef))) {</span>
<span class="line-removed">1333                         hgGitRepo.delete(new Branch(hgGitRef));</span>
<span class="line-removed">1334                     }</span>
<span class="line-removed">1335                     hgGitRepo.branch(hgGitFetchHead, hgGitRef);</span>
<span class="line-removed">1336                     gimport();</span>
<span class="line-removed">1337                     var hgFetchHead = repo.resolve(hgGitRef).get();</span>
<span class="line-removed">1338 </span>
<span class="line-removed">1339                     if (action.equals(&quot;fetch&quot;) &amp;&amp; arguments.contains(&quot;branch&quot;)) {</span>
<span class="line-removed">1340                         repo.branch(hgFetchHead, arguments.get(&quot;branch&quot;).asString());</span>
<span class="line-removed">1341                     } else if (action.equals(&quot;checkout&quot;)) {</span>
<span class="line-removed">1342                         repo.checkout(hgFetchHead);</span>
<span class="line-removed">1343                         if (arguments.contains(&quot;branch&quot;)) {</span>
<span class="line-removed">1344                             repo.branch(hgFetchHead, arguments.get(&quot;branch&quot;).asString());</span>
<span class="line-removed">1345                         }</span>
<span class="line-removed">1346                     }</span>
<span class="line-removed">1347                 } else {</span>
<span class="line-removed">1348                     exit(&quot;Unexpected action: &quot; + action);</span>
<span class="line-removed">1349                 }</span>
1350 
<span class="line-modified">1351                 return;</span>
<span class="line-modified">1352             }</span>




1353 
<span class="line-modified">1354             var fetchHead = repo.fetch(repoUrl, pr.fetchRef());</span>
<span class="line-modified">1355             if (action.equals(&quot;fetch&quot;)) {</span>
<span class="line-modified">1356                 var branchName = getOption(&quot;branch&quot;, &quot;fetch&quot;, arguments);</span>
<span class="line-modified">1357                 if (branchName != null) {</span>
<span class="line-removed">1358                     repo.branch(fetchHead, branchName);</span>
<span class="line-removed">1359                 } else {</span>
<span class="line-removed">1360                     System.out.println(fetchHead.hex());</span>
<span class="line-removed">1361                 }</span>
<span class="line-removed">1362             } else if (action.equals(&quot;checkout&quot;)) {</span>
<span class="line-removed">1363                 var branchName = getOption(&quot;branch&quot;, &quot;checkout&quot;, arguments);</span>
<span class="line-removed">1364                 if (branchName != null) {</span>
<span class="line-removed">1365                     var branch = repo.branch(fetchHead, branchName);</span>
<span class="line-removed">1366                     repo.checkout(branch, false);</span>
<span class="line-removed">1367                 } else {</span>
<span class="line-removed">1368                     repo.checkout(fetchHead, false);</span>
<span class="line-removed">1369                 }</span>
<span class="line-removed">1370             } else if (action.equals(&quot;show&quot;)) {</span>
<span class="line-removed">1371                 show(pr.targetRef(), fetchHead);</span>
<span class="line-removed">1372             } else if (action.equals(&quot;apply&quot;)) {</span>
<span class="line-removed">1373                 var patch = diff(pr.targetRef(), fetchHead);</span>
<span class="line-removed">1374                 apply(patch);</span>
<span class="line-removed">1375                 Files.deleteIfExists(patch);</span>
<span class="line-removed">1376             }</span>
<span class="line-removed">1377         } else if (action.equals(&quot;close&quot;)) {</span>
<span class="line-removed">1378             var prId = arguments.at(1);</span>
<span class="line-removed">1379             if (!prId.isPresent()) {</span>
<span class="line-removed">1380                 exit(&quot;error: missing pull request identifier&quot;);</span>
1381             }
1382 
<span class="line-modified">1383             var remoteRepo = getHostedRepositoryFor(uri, repo, host);</span>
<span class="line-modified">1384             var pr = remoteRepo.pullRequest(prId.asString());</span>
<span class="line-modified">1385             pr.setState(PullRequest.State.CLOSED);</span>
<span class="line-modified">1386         } else if (action.equals(&quot;set&quot;)) {</span>
<span class="line-removed">1387             var prId = arguments.at(1);</span>
<span class="line-removed">1388             if (!prId.isPresent()) {</span>
<span class="line-removed">1389                 exit(&quot;error: missing pull request identifier&quot;);</span>
1390             }

1391 
<span class="line-modified">1392             var remoteRepo = getHostedRepositoryFor(uri, repo, host);</span>
<span class="line-modified">1393             var pr = remoteRepo.pullRequest(prId.asString());</span>
<span class="line-modified">1394             var assigneesOption = getOption(&quot;assignees&quot;, &quot;set&quot;, arguments);</span>
<span class="line-modified">1395             if (assigneesOption != null) {</span>
<span class="line-modified">1396                 var usernames = Arrays.asList(assigneesOption.split(&quot;,&quot;));</span>
<span class="line-modified">1397                 var assignees = usernames.stream()</span>
<span class="line-modified">1398                     .map(u -&gt; host.user(u))</span>
<span class="line-modified">1399                     .filter(Optional::isPresent)</span>
<span class="line-modified">1400                     .map(Optional::get)</span>
<span class="line-modified">1401                     .collect(Collectors.toList());</span>
<span class="line-modified">1402                 pr.setAssignees(assignees);</span>
<span class="line-modified">1403             }</span>
<span class="line-modified">1404         } else if (action.equals(&quot;status&quot;)) {</span>
<span class="line-modified">1405             String id = pullRequestIdArgument(arguments, repo);</span>
<span class="line-modified">1406             var pr = getPullRequest(uri, repo, host, id);</span>
<span class="line-modified">1407             var noDecoration = getSwitch(&quot;no-decoration&quot;, &quot;status&quot;, arguments);</span>
<span class="line-modified">1408             var decoration = noDecoration ? &quot;&quot; : &quot;Status: &quot;;</span>
<span class="line-modified">1409             System.out.println(decoration + statusForPullRequest(pr));</span>
<span class="line-modified">1410 </span>
<span class="line-modified">1411             var noChecks = getSwitch(&quot;no-checks&quot;, &quot;status&quot;, arguments);</span>
<span class="line-modified">1412             if (!noChecks) {</span>
<span class="line-modified">1413                 var checks = pr.checks(pr.headHash());</span>
<span class="line-modified">1414                 var jcheck = Optional.ofNullable(checks.get(&quot;jcheck&quot;));</span>
<span class="line-modified">1415                 var submit = Optional.ofNullable(checks.get(&quot;submit&quot;));</span>
<span class="line-modified">1416                 var showChecks = jcheck.isPresent() || submit.isPresent();</span>
<span class="line-modified">1417                 if (showChecks) {</span>
<span class="line-modified">1418                     System.out.println(&quot;Checks:&quot;);</span>
<span class="line-modified">1419                     if (jcheck.isPresent()) {</span>
<span class="line-modified">1420                         System.out.println(&quot;- jcheck: &quot; + statusForCheck(jcheck.get()));</span>
<span class="line-modified">1421                     }</span>
<span class="line-modified">1422                     if (submit.isPresent()) {</span>
<span class="line-modified">1423                         System.out.println(&quot;- submit: &quot; + statusForCheck(submit.get()));</span>
<span class="line-modified">1424                     }</span>





































































































































































1425                 }
1426             }






































































































































































1427         } else {
<span class="line-modified">1428             exit(&quot;error: unexpected action: &quot; + action);</span>
1429         }
1430     }


































































































1431 }
</pre>
</td>
<td>
<hr />
<pre>
 115     }
 116 
 117     private static String rightPad(String s, int length) {
 118         return String.format(&quot;%-&quot; + length + &quot;s&quot;, s);
 119     }
 120 
 121     private static void appendPaddedHTMLComment(Path file, String line) throws IOException {
 122         var end = &quot; --&gt;&quot;;
 123         var pad = 79 - end.length();
 124         var newLine = &quot;\n&quot;;
 125         Files.writeString(file, rightPad(&quot;&lt;!-- &quot; + line, pad) + end + newLine, StandardOpenOption.APPEND);
 126     }
 127 
 128     private static String format(Issue issue) {
 129         var parts = issue.id().split(&quot;-&quot;);
 130         var id = parts.length == 2 ? parts[1] : issue.id();
 131         return id + &quot;: &quot; + issue.title();
 132     }
 133 
 134 
<span class="line-modified"> 135     private static String pullRequestIdArgument(ReadOnlyRepository repo, Arguments arguments) throws IOException {</span>
<span class="line-modified"> 136         if (arguments.at(0).isPresent()) {</span>
<span class="line-modified"> 137             return arguments.at(0).asString();</span>
 138         }
 139 
 140         var currentBranch = repo.currentBranch();
 141         if (currentBranch.isPresent()) {
 142             var lines = repo.config(&quot;pr.&quot; + currentBranch.get().name() + &quot;.id&quot;);
 143             if (lines.size() == 1) {
 144                 return lines.get(0);
 145             }
 146         }
 147 
 148         exit(&quot;error: you must provide a pull request id&quot;);
 149         return null;
 150     }
 151 
 152     private static String statusForPullRequest(PullRequest pr) {
 153         var labels = pr.labels();
 154         if (pr.isDraft()) {
 155             return &quot;DRAFT&quot;;
 156         } else if (labels.contains(&quot;integrated&quot;)) {
 157             return &quot;INTEGRATED&quot;;
</pre>
<hr />
<pre>
 359     }
 360     private static void show(String ref, Hash hash, Path dir) throws IOException {
 361         var pb = new ProcessBuilder(&quot;git&quot;, &quot;diff&quot;, &quot;--binary&quot;,
 362                                                    &quot;--patch&quot;,
 363                                                    &quot;--find-renames=50%&quot;,
 364                                                    &quot;--find-copies=50%&quot;,
 365                                                    &quot;--find-copies-harder&quot;,
 366                                                    &quot;--abbrev&quot;,
 367                                                    ref + &quot;...&quot; + hash.hex());
 368         if (dir != null) {
 369             pb.directory(dir.toFile());
 370         }
 371         pb.inheritIO();
 372 
 373         // git will return 141 (128 + 13) when it receive SIGPIPE (signal 13) from
 374         // e.g. less when a user exits less when looking at a large diff. Therefore
 375         // must allow 141 as a valid exit code.
 376         await(pb.start(), 141);
 377     }
 378 










































 379     private static Path diff(String ref, Hash hash) throws IOException {
 380         return diff(ref, hash, null);
 381     }
 382 
 383     private static Path diff(String ref, Hash hash, Path dir) throws IOException {
 384         var patch = Files.createTempFile(hash.hex(), &quot;.patch&quot;);
 385         var pb = new ProcessBuilder(&quot;git&quot;, &quot;diff&quot;, &quot;--binary&quot;,
 386                                                    &quot;--patch&quot;,
 387                                                    &quot;--find-renames=50%&quot;,
 388                                                    &quot;--find-copies=50%&quot;,
 389                                                    &quot;--find-copies-harder&quot;,
 390                                                    &quot;--abbrev&quot;,
 391                                                    ref + &quot;...&quot; + hash.hex());
 392         if (dir != null) {
 393             pb.directory(dir.toFile());
 394         }
 395         pb.redirectOutput(patch.toFile());
 396         pb.redirectError(ProcessBuilder.Redirect.INHERIT);
 397         await(pb.start());
 398         return patch;
 399     }
 400 
 401     private static void apply(Path patch) throws IOException {
 402         var pb = new ProcessBuilder(&quot;git&quot;, &quot;apply&quot;, &quot;--no-commit&quot;, patch.toString());
 403         pb.inheritIO();
 404         await(pb.start());
 405     }
 406 
 407     private static int longest(List&lt;String&gt; strings) {
 408         return strings.stream().mapToInt(String::length).max().orElse(0);
 409     }
 410 
 411     private static String removeTrailing(String s, String trail) {
 412         return s.endsWith(trail) ?
 413             s.substring(0, s.length() - trail.length()) :
 414             s;
 415     }
 416 
<span class="line-modified"> 417     private static Repository getRepo() throws IOException {</span>
<span class="line-added"> 418         var cwd = Path.of(&quot;&quot;).toAbsolutePath();</span>
<span class="line-added"> 419         return Repository.get(cwd).orElseThrow(() -&gt; new IOException(&quot;no git repository found at &quot; + cwd.toString()));</span>
<span class="line-added"> 420     }</span>
<span class="line-added"> 421 </span>
<span class="line-added"> 422     private static Arguments parse(ArgumentParser parser, String[] args) {</span>
<span class="line-added"> 423         var arguments = parser.parse(args);</span>
<span class="line-added"> 424         if (arguments.contains(&quot;version&quot;)) {</span>
<span class="line-added"> 425             System.out.println(&quot;git-pr version: &quot; + Version.fromManifest().orElse(&quot;unknown&quot;));</span>
<span class="line-added"> 426             System.exit(0);</span>
<span class="line-added"> 427         }</span>
<span class="line-added"> 428         if (arguments.contains(&quot;verbose&quot;) || arguments.contains(&quot;debug&quot;)) {</span>
<span class="line-added"> 429             var level = arguments.contains(&quot;debug&quot;) ? Level.FINER : Level.FINE;</span>
<span class="line-added"> 430             Logging.setup(level);</span>
<span class="line-added"> 431         }</span>
<span class="line-added"> 432         return arguments;</span>
<span class="line-added"> 433     }</span>
<span class="line-added"> 434 </span>
<span class="line-added"> 435     private static String getRemote(ReadOnlyRepository repo, Arguments arguments) throws IOException {</span>
<span class="line-added"> 436         var remote = getOption(&quot;remote&quot;, arguments);</span>
<span class="line-added"> 437         return remote == null ? &quot;origin&quot; : remote;</span>
<span class="line-added"> 438     }</span>
<span class="line-added"> 439 </span>
<span class="line-added"> 440     private static URI getURI(ReadOnlyRepository repo, Arguments arguments) throws IOException {</span>
<span class="line-added"> 441         var remotePullPath = repo.pullPath(getRemote(repo, arguments));</span>
<span class="line-added"> 442         return Remote.toWebURI(remotePullPath);</span>
<span class="line-added"> 443     }</span>
<span class="line-added"> 444 </span>
<span class="line-added"> 445     private static Forge getForge(URI uri, ReadOnlyRepository repo, Arguments arguments) throws IOException {</span>
<span class="line-added"> 446         var username = getOption(&quot;username&quot;, arguments);</span>
<span class="line-added"> 447         var token = System.getenv(&quot;GIT_TOKEN&quot;);</span>
<span class="line-added"> 448         var shouldUseToken = !getSwitch(&quot;no-token&quot;, arguments);</span>
<span class="line-added"> 449         var credentials = !shouldUseToken ?</span>
<span class="line-added"> 450             null :</span>
<span class="line-added"> 451             GitCredentials.fill(uri.getHost(), uri.getPath(), username, token, uri.getScheme());</span>
<span class="line-added"> 452         var forgeURI = URI.create(uri.getScheme() + &quot;://&quot; + uri.getHost());</span>
<span class="line-added"> 453         var forge = credentials == null ?</span>
<span class="line-added"> 454             Forge.from(forgeURI) :</span>
<span class="line-added"> 455             Forge.from(forgeURI, new Credential(credentials.username(), credentials.password()));</span>
<span class="line-added"> 456         if (forge.isEmpty()) {</span>
<span class="line-added"> 457             if (!shouldUseToken) {</span>
<span class="line-added"> 458                 if (arguments.contains(&quot;verbose&quot;)) {</span>
<span class="line-added"> 459                     System.err.println(&quot;&quot;);</span>
<span class="line-added"> 460                 }</span>
<span class="line-added"> 461                 System.err.println(&quot;warning: using git-pr with --no-token may result in rate limiting from &quot; + forgeURI);</span>
<span class="line-added"> 462                 if (!arguments.contains(&quot;verbose&quot;)) {</span>
<span class="line-added"> 463                     System.err.println(&quot;         Re-run git-pr with --verbose to see if you are being rate limited&quot;);</span>
<span class="line-added"> 464                     System.err.println(&quot;&quot;);</span>
<span class="line-added"> 465                 }</span>
<span class="line-added"> 466             }</span>
<span class="line-added"> 467             exit(&quot;error: failed to connect to host: &quot; + forgeURI);</span>
<span class="line-added"> 468         }</span>
<span class="line-added"> 469         return forge.get();</span>
<span class="line-added"> 470     }</span>
<span class="line-added"> 471 </span>
<span class="line-added"> 472     private static void create(String[] args) throws IOException, InterruptedException {</span>
 473         var flags = List.of(
 474             Option.shortcut(&quot;u&quot;)
 475                   .fullname(&quot;username&quot;)
 476                   .describe(&quot;NAME&quot;)
 477                   .helptext(&quot;Username on host&quot;)
 478                   .optional(),
 479             Option.shortcut(&quot;r&quot;)
 480                   .fullname(&quot;remote&quot;)
 481                   .describe(&quot;NAME&quot;)
 482                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)
 483                   .optional(),
 484             Option.shortcut(&quot;b&quot;)
 485                   .fullname(&quot;branch&quot;)
 486                   .describe(&quot;NAME&quot;)
 487                   .helptext(&quot;Name of target branch, defaults to &#39;master&#39;&quot;)
 488                   .optional(),

































 489             Switch.shortcut(&quot;&quot;)
 490                   .fullname(&quot;ignore-workspace&quot;)
 491                   .helptext(&quot;Ignore local changes in worktree and staging area when creating pull request&quot;)
 492                   .optional(),
 493             Switch.shortcut(&quot;&quot;)
 494                   .fullname(&quot;ignore-local-commits&quot;)
 495                   .helptext(&quot;Ignore local commits not pushed when creating pull request&quot;)
 496                   .optional(),
 497             Switch.shortcut(&quot;&quot;)
 498                   .fullname(&quot;publish&quot;)
 499                   .helptext(&quot;Publish the local branch before creating the pull request&quot;)
 500                   .optional(),




 501             Switch.shortcut(&quot;&quot;)
 502                   .fullname(&quot;jcheck&quot;)
 503                   .helptext(&quot;Run jcheck before creating the pull request&quot;)
 504                   .optional(),












 505             Switch.shortcut(&quot;&quot;)
 506                   .fullname(&quot;verbose&quot;)
 507                   .helptext(&quot;Turn on verbose output&quot;)
 508                   .optional(),
 509             Switch.shortcut(&quot;&quot;)
 510                   .fullname(&quot;debug&quot;)
 511                   .helptext(&quot;Turn on debugging output&quot;)
 512                   .optional(),
 513             Switch.shortcut(&quot;&quot;)
 514                   .fullname(&quot;version&quot;)
 515                   .helptext(&quot;Print the version of this tool&quot;)
<span class="line-modified"> 516                   .optional()</span>
<span class="line-added"> 517         );</span>
 518 


 519         var inputs = List.of(
 520             Input.position(0)




 521                  .describe(&quot;ID&quot;)
 522                  .singular()
 523                  .optional()
 524         );
 525 
 526         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);
<span class="line-modified"> 527         var arguments = parse(parser, args);</span>
<span class="line-modified"> 528         var repo = getRepo();</span>
<span class="line-modified"> 529         var uri = getURI(repo, arguments);</span>
<span class="line-modified"> 530         var host = getForge(uri, repo, arguments);</span>
<span class="line-modified"> 531         var remote = getRemote(repo, arguments);</span>
<span class="line-modified"> 532         var currentBranch = repo.currentBranch().orElseGet(() -&gt; {</span>
<span class="line-modified"> 533                 System.err.println(&quot;error: the repository is in a detached HEAD state&quot;);</span>
<span class="line-modified"> 534                 System.exit(1);</span>
<span class="line-modified"> 535                 return null;</span>
<span class="line-modified"> 536         });</span>
<span class="line-added"> 537         if (currentBranch.equals(repo.defaultBranch())) {</span>
<span class="line-added"> 538             System.err.println(&quot;error: you should not create pull requests from the &#39;master&#39; branch&quot;);</span>
<span class="line-added"> 539             System.err.println(&quot;&quot;);</span>
<span class="line-added"> 540             System.err.println(&quot;To create a local branch for your changes and restore the &#39;master&#39; branch, run:&quot;);</span>
<span class="line-added"> 541             System.err.println(&quot;&quot;);</span>
<span class="line-added"> 542             System.err.println(&quot;    git checkout -b NAME-FOR-YOUR-LOCAL-BRANCH&quot;);</span>
<span class="line-added"> 543             System.err.println(&quot;    git branch --force master origin/master&quot;);</span>
<span class="line-added"> 544             System.err.println(&quot;&quot;);</span>
<span class="line-added"> 545             System.exit(1);</span>
 546         }
 547 
<span class="line-modified"> 548         var ignoreWorkspace = getSwitch(&quot;ignore-workspace&quot;, &quot;create&quot;, arguments);</span>
<span class="line-modified"> 549         if (!ignoreWorkspace) {</span>
<span class="line-modified"> 550             var diff = repo.diff(repo.head());</span>
<span class="line-modified"> 551             if (!diff.patches().isEmpty()) {</span>
<span class="line-modified"> 552                 System.err.println(&quot;error: there are uncommitted changes in your working tree:&quot;);</span>
<span class="line-modified"> 553                 System.err.println(&quot;&quot;);</span>
<span class="line-modified"> 554                 for (var patch : diff.patches()) {</span>
<span class="line-modified"> 555                     var path = patch.target().path().isPresent() ?</span>
<span class="line-modified"> 556                         patch.target().path().get() : patch.source().path().get();</span>
<span class="line-modified"> 557                     System.err.println(&quot;    &quot; + patch.status().toString() + &quot; &quot; + path.toString());</span>




















 558                 }
<span class="line-modified"> 559                 System.err.println(&quot;&quot;);</span>
<span class="line-modified"> 560                 System.err.println(&quot;If these changes are meant to be part of the pull request, run:&quot;);</span>
<span class="line-modified"> 561                 System.err.println(&quot;&quot;);</span>
<span class="line-modified"> 562                 System.err.println(&quot;    git commit -am &#39;Forgot to add some changes&#39;&quot;);</span>
<span class="line-modified"> 563                 System.err.println(&quot;&quot;);</span>
<span class="line-modified"> 564                 System.err.println(&quot;If these changes are *not* meant to be part of the pull request, run:&quot;);</span>
<span class="line-modified"> 565                 System.err.println(&quot;&quot;);</span>
<span class="line-modified"> 566                 System.err.println(&quot;    git stash&quot;);</span>
<span class="line-modified"> 567                 System.err.println(&quot;&quot;);</span>
<span class="line-modified"> 568                 System.err.println(&quot;(You can later restore the changes by running: git stash pop)&quot;);</span>
<span class="line-added"> 569                 System.exit(1);</span>
 570             }
 571         }
 572 
<span class="line-modified"> 573         var upstream = repo.upstreamFor(currentBranch);</span>
<span class="line-modified"> 574         if (upstream.isEmpty()) {</span>
<span class="line-modified"> 575             var shouldPublish = getSwitch(&quot;publish&quot;, &quot;create&quot;, arguments);</span>
<span class="line-modified"> 576             if (shouldPublish) {</span>
<span class="line-added"> 577                 GitPublish.main(new String[] { &quot;--quiet&quot;, remote });</span>
<span class="line-added"> 578                 upstream = repo.upstreamFor(currentBranch);</span>
<span class="line-added"> 579             } else {</span>
<span class="line-added"> 580                 System.err.println(&quot;error: there is no remote branch for the local branch &#39;&quot; + currentBranch.name() + &quot;&#39;&quot;);</span>
<span class="line-added"> 581                 System.err.println(&quot;&quot;);</span>
<span class="line-added"> 582                 System.err.println(&quot;A remote branch must be present at &quot; + uri + &quot; to create a pull request&quot;);</span>
<span class="line-added"> 583                 System.err.println(&quot;To create a remote branch and push the commits for your local branch, run:&quot;);</span>
<span class="line-added"> 584                 System.err.println(&quot;&quot;);</span>
<span class="line-added"> 585                 System.err.println(&quot;    git publish&quot;);</span>
<span class="line-added"> 586                 System.err.println(&quot;&quot;);</span>
<span class="line-added"> 587                 System.err.println(&quot;If you created the remote branch from another client, you must update this repository.&quot;);</span>
<span class="line-added"> 588                 System.err.println(&quot;To update remote information for this repository, run:&quot;);</span>
<span class="line-added"> 589                 System.err.println(&quot;&quot;);</span>
<span class="line-added"> 590                 System.err.println(&quot;    git fetch &quot; + remote);</span>
<span class="line-added"> 591                 System.err.println(&quot;    git branch --set-upstream &quot; + currentBranch + &quot; &quot; + remote + &quot;/&quot; + currentBranch);</span>
<span class="line-added"> 592                 System.err.println(&quot;&quot;);</span>
<span class="line-added"> 593                 System.exit(1);</span>
 594             }


 595         }
 596 
<span class="line-modified"> 597         var upstreamRefName = upstream.get().substring(remote.length() + 1);</span>
<span class="line-modified"> 598         repo.fetch(uri, upstreamRefName);</span>








































 599 
<span class="line-modified"> 600         var shouldIgnoreLocalCommits = getSwitch(&quot;ignore-local-commits&quot;, &quot;create&quot;, arguments);</span>
<span class="line-modified"> 601         if (!shouldIgnoreLocalCommits) {</span>
<span class="line-modified"> 602             var branchCommits = repo.commits(upstream.get() + &quot;..&quot; + currentBranch.name()).asList();</span>
<span class="line-modified"> 603             if (!branchCommits.isEmpty()) {</span>
<span class="line-modified"> 604                 System.err.println(&quot;error: there are local commits on branch &#39;&quot; + currentBranch.name() + &quot;&#39; not present in the remote repository &quot; + uri);</span>
<span class="line-modified"> 605                 System.err.println(&quot;&quot;);</span>
<span class="line-modified"> 606                 System.err.println(&quot;All commits must be present in the remote repository to be part of the pull request&quot;);</span>
<span class="line-modified"> 607                 System.err.println(&quot;The following commits are not present in the remote repository:&quot;);</span>
<span class="line-modified"> 608                 System.err.println(&quot;&quot;);</span>
<span class="line-modified"> 609                 for (var commit : branchCommits) {</span>
<span class="line-modified"> 610                     System.err.println(&quot;- &quot; + commit.hash().abbreviate() + &quot;: &quot; + commit.message().get(0));</span>
















 611                 }
<span class="line-added"> 612                 System.err.println(&quot;&quot;);</span>
<span class="line-added"> 613                 System.err.println(&quot;To push the above local commits to the remote repository, run:&quot;);</span>
<span class="line-added"> 614                 System.err.println(&quot;&quot;);</span>
<span class="line-added"> 615                 System.err.println(&quot;    git push &quot; + remote + &quot; &quot; + currentBranch.name());</span>
<span class="line-added"> 616                 System.err.println(&quot;&quot;);</span>
<span class="line-added"> 617                 System.exit(1);</span>
<span class="line-added"> 618             }</span>
<span class="line-added"> 619         }</span>
 620 
<span class="line-modified"> 621         var remoteRepo = host.repository(projectName(uri)).orElseThrow(() -&gt;</span>
<span class="line-modified"> 622                 new IOException(&quot;Could not find repository at &quot; + uri.toString())</span>
<span class="line-modified"> 623         );</span>
<span class="line-modified"> 624         var parentRepo = remoteRepo.parent().orElseThrow(() -&gt;</span>
<span class="line-modified"> 625                 new IOException(&quot;error: remote repository &quot; + uri + &quot; is not a fork of any repository&quot;)</span>
<span class="line-modified"> 626         );</span>


 627 
<span class="line-modified"> 628         var targetBranch = getOption(&quot;branch&quot;, &quot;create&quot;, arguments);</span>
<span class="line-modified"> 629         if (targetBranch == null) {</span>
<span class="line-modified"> 630             var upstreamBranchNames = repo.remoteBranches(parentRepo.webUrl().toString())</span>
<span class="line-modified"> 631                                           .stream()</span>
<span class="line-modified"> 632                                           .map(r -&gt; r.name())</span>
<span class="line-modified"> 633                                           .collect(Collectors.toSet());</span>
<span class="line-modified"> 634             var remoteBranches = repo.branches(remote);</span>
<span class="line-modified"> 635             var candidates = new ArrayList&lt;Branch&gt;();</span>
<span class="line-modified"> 636             for (var b : remoteBranches) {</span>
<span class="line-modified"> 637                 var withoutRemotePrefix = b.name().substring(remote.length() + 1);</span>
<span class="line-modified"> 638                 if (upstreamBranchNames.contains(withoutRemotePrefix)) {</span>
<span class="line-modified"> 639                     candidates.add(b);</span>











 640                 }
<span class="line-added"> 641             }</span>
 642 
<span class="line-modified"> 643             var localBranches = repo.branches();</span>
<span class="line-modified"> 644             Branch closest = null;</span>
<span class="line-modified"> 645             var shortestDistance = Integer.MAX_VALUE;</span>
<span class="line-modified"> 646             for (var b : candidates) {</span>
<span class="line-modified"> 647                 var from = b.name();</span>
<span class="line-modified"> 648                 for (var localBranch : localBranches) {</span>
<span class="line-modified"> 649                     var trackingBranch = repo.upstreamFor(localBranch);</span>
<span class="line-modified"> 650                     if (trackingBranch.isPresent() &amp;&amp;</span>
<span class="line-modified"> 651                         trackingBranch.get().equals(b.name())) {</span>
<span class="line-modified"> 652                         from = localBranch.name();</span>









 653                     }
























 654                 }
<span class="line-modified"> 655                 var distance = repo.commitMetadata(from + &quot;...&quot; + currentBranch.name()).size();</span>
<span class="line-modified"> 656                 if (distance &lt; shortestDistance) {</span>
<span class="line-modified"> 657                     closest = b;</span>
<span class="line-modified"> 658                     shortestDistance = distance;</span>


























 659                 }




 660             }
<span class="line-modified"> 661 </span>
<span class="line-modified"> 662             if (closest != null) {</span>
<span class="line-modified"> 663                 targetBranch = closest.name().substring(remote.length() + 1);</span>
<span class="line-modified"> 664             } else {</span>
<span class="line-modified"> 665                 System.err.println(&quot;error: cannot automatically infer target branch&quot;);</span>
<span class="line-modified"> 666                 System.err.println(&quot;       use --branch to specify target branch&quot;);</span>







 667                 System.exit(1);
 668             }
<span class="line-added"> 669         }</span>
<span class="line-added"> 670         var commits = repo.commits(targetBranch + &quot;..&quot; + upstream.get()).asList();</span>
<span class="line-added"> 671         if (commits.isEmpty()) {</span>
<span class="line-added"> 672             System.err.println(&quot;error: no difference between branches &quot; + targetBranch + &quot; and &quot; + currentBranch.name());</span>
<span class="line-added"> 673             System.err.println(&quot;       Cannot create an empty pull request, have you committed?&quot;);</span>
<span class="line-added"> 674             System.exit(1);</span>
<span class="line-added"> 675         }</span>
 676 
<span class="line-modified"> 677         var shouldRunJCheck = getSwitch(&quot;jcheck&quot;, &quot;create&quot;, arguments);</span>
<span class="line-modified"> 678         if (shouldRunJCheck) {</span>
<span class="line-modified"> 679             var jcheckArgs = new String[]{ &quot;--pull-request&quot;, &quot;--rev&quot;, targetBranch + &quot;..&quot; + upstream.get() };</span>
<span class="line-modified"> 680             var err = GitJCheck.run(jcheckArgs);</span>
<span class="line-modified"> 681             if (err != 0) {</span>
<span class="line-modified"> 682                 System.exit(err);</span>

















 683             }
<span class="line-added"> 684         }</span>
 685 
<span class="line-modified"> 686         var project = jbsProjectFromJcheckConf(repo, targetBranch);</span>
<span class="line-modified"> 687         var issue = getIssue(currentBranch, project);</span>
<span class="line-modified"> 688         var file = Files.createTempFile(&quot;PULL_REQUEST_&quot;, &quot;.md&quot;);</span>
<span class="line-modified"> 689         if (issue.isPresent()) {</span>
<span class="line-modified"> 690             Files.writeString(file, format(issue.get()) + &quot;\n\n&quot;);</span>
<span class="line-modified"> 691         } else if (commits.size() == 1) {</span>
<span class="line-modified"> 692             var commit = commits.get(0);</span>
<span class="line-modified"> 693             issue = getIssue(commit, project);</span>
<span class="line-modified"> 694             if (issue.isPresent()) {</span>
<span class="line-modified"> 695                 Files.writeString(file, format(issue.get()) + &quot;\n\n&quot;);</span>
<span class="line-modified"> 696             } else {</span>
<span class="line-modified"> 697                 var message = CommitMessageParsers.v1.parse(commit.message());</span>
<span class="line-modified"> 698                 Files.writeString(file, message.title() + &quot;\n&quot;);</span>
<span class="line-modified"> 699                 if (!message.summaries().isEmpty()) {</span>
<span class="line-modified"> 700                     Files.write(file, message.summaries(), StandardOpenOption.APPEND);</span>
<span class="line-modified"> 701                 }</span>
<span class="line-modified"> 702                 if (!message.additional().isEmpty()) {</span>
<span class="line-modified"> 703                     Files.write(file, message.additional(), StandardOpenOption.APPEND);</span>



 704                 }
 705             }
<span class="line-added"> 706         } else {</span>
<span class="line-added"> 707             Files.write(file, List.of(&quot;&quot;));</span>
<span class="line-added"> 708         }</span>
 709 
<span class="line-modified"> 710         appendPaddedHTMLComment(file, &quot;Please enter the pull request message for your changes.&quot;);</span>
<span class="line-modified"> 711         appendPaddedHTMLComment(file, &quot;The first line will be considered the subject, use a blank line to&quot;);</span>
<span class="line-modified"> 712         appendPaddedHTMLComment(file, &quot;separate the subject from the body. These HTML comment lines will&quot;);</span>
<span class="line-modified"> 713         appendPaddedHTMLComment(file, &quot;be removed automatically. An empty message aborts the pull request.&quot;);</span>
<span class="line-modified"> 714         appendPaddedHTMLComment(file, &quot;&quot;);</span>
<span class="line-modified"> 715         appendPaddedHTMLComment(file, &quot;Commits to be included from branch &#39;&quot; + currentBranch.name() + &quot;&#39;:&quot;);</span>
<span class="line-modified"> 716         for (var commit : commits) {</span>
<span class="line-modified"> 717             var desc = commit.hash().abbreviate() + &quot;: &quot; + commit.message().get(0);</span>
<span class="line-modified"> 718             appendPaddedHTMLComment(file, &quot;- &quot; + desc);</span>
<span class="line-modified"> 719             if (!commit.isMerge()) {</span>
<span class="line-modified"> 720                 var diff = commit.parentDiffs().get(0);</span>
<span class="line-modified"> 721                 for (var patch : diff.patches()) {</span>
<span class="line-modified"> 722                     var status = patch.status();</span>
<span class="line-modified"> 723                     if (status.isModified()) {</span>
<span class="line-added"> 724                         appendPaddedHTMLComment(file, &quot;  M  &quot; + patch.target().path().get().toString());</span>
<span class="line-added"> 725                     } else if (status.isAdded()) {</span>
<span class="line-added"> 726                         appendPaddedHTMLComment(file, &quot;  A  &quot; + patch.target().path().get().toString());</span>
<span class="line-added"> 727                     } else if (status.isDeleted()) {</span>
<span class="line-added"> 728                         appendPaddedHTMLComment(file, &quot;  D  &quot; + patch.source().path().get().toString());</span>
<span class="line-added"> 729                     } else if (status.isRenamed()) {</span>
<span class="line-added"> 730                         appendPaddedHTMLComment(file, &quot;  R  &quot; + patch.target().path().get().toString());</span>
<span class="line-added"> 731                         appendPaddedHTMLComment(file, &quot;      (&quot; + patch.source().path().get().toString() + &quot;)&quot;);</span>
<span class="line-added"> 732                     } else if (status.isCopied()) {</span>
<span class="line-added"> 733                         appendPaddedHTMLComment(file, &quot;  C  &quot; + patch.target().path().get().toString());</span>
<span class="line-added"> 734                         appendPaddedHTMLComment(file, &quot;      (&quot; + patch.source().path().get().toString() + &quot;)&quot;);</span>
 735                     }






 736                 }
 737             }
<span class="line-added"> 738         }</span>
<span class="line-added"> 739         appendPaddedHTMLComment(file, &quot;&quot;);</span>
<span class="line-added"> 740         if (issue.isPresent()) {</span>
<span class="line-added"> 741             appendPaddedHTMLComment(file, &quot;Issue:      &quot; + issue.get().webUrl());</span>
<span class="line-added"> 742         }</span>
<span class="line-added"> 743         appendPaddedHTMLComment(file, &quot;Repository: &quot; + parentRepo.webUrl());</span>
<span class="line-added"> 744         appendPaddedHTMLComment(file, &quot;Branch:     &quot; + targetBranch);</span>
 745 
<span class="line-modified"> 746         var success = spawnEditor(repo, file);</span>
<span class="line-modified"> 747         if (!success) {</span>
<span class="line-modified"> 748             System.err.println(&quot;error: editor exited with non-zero status code, aborting&quot;);</span>
<span class="line-modified"> 749             System.exit(1);</span>
<span class="line-modified"> 750         }</span>
<span class="line-modified"> 751         var lines = Files.readAllLines(file)</span>
<span class="line-modified"> 752                          .stream()</span>
<span class="line-modified"> 753                          .filter(l -&gt; !(l.startsWith(&quot;&lt;!--&quot;) &amp;&amp; l.endsWith(&quot;--&gt;&quot;)))</span>
<span class="line-modified"> 754                          .collect(Collectors.toList());</span>
<span class="line-modified"> 755         var isEmpty = lines.stream().allMatch(String::isEmpty);</span>
<span class="line-modified"> 756         if (isEmpty) {</span>
<span class="line-modified"> 757             System.err.println(&quot;error: no message present, aborting&quot;);</span>
<span class="line-modified"> 758             System.exit(1);</span>
<span class="line-modified"> 759         }</span>












































 760 
<span class="line-modified"> 761         var title = lines.get(0);</span>
<span class="line-modified"> 762         List&lt;String&gt; body = null;</span>
<span class="line-modified"> 763         if (lines.size() &gt; 1) {</span>
<span class="line-modified"> 764             body = lines.subList(1, lines.size())</span>
<span class="line-modified"> 765                         .stream()</span>
<span class="line-modified"> 766                         .dropWhile(String::isEmpty)</span>
<span class="line-modified"> 767                         .collect(Collectors.toList());</span>
<span class="line-modified"> 768         } else {</span>
<span class="line-added"> 769             body = Collections.emptyList();</span>
<span class="line-added"> 770         }</span>
 771 
<span class="line-modified"> 772         var pr = remoteRepo.createPullRequest(parentRepo, targetBranch, currentBranch.name(), title, body);</span>
<span class="line-modified"> 773         var assigneesOption = getOption(&quot;assignees&quot;, &quot;create&quot;, arguments);</span>
<span class="line-modified"> 774         if (assigneesOption != null) {</span>
<span class="line-modified"> 775             var usernames = Arrays.asList(assigneesOption.split(&quot;,&quot;));</span>
<span class="line-modified"> 776             var assignees = usernames.stream()</span>
<span class="line-modified"> 777                                      .map(u -&gt; host.user(u))</span>
<span class="line-modified"> 778                                      .filter(Optional::isPresent)</span>
<span class="line-modified"> 779                                      .map(Optional::get)</span>
<span class="line-modified"> 780                                      .collect(Collectors.toList());</span>
<span class="line-modified"> 781             pr.setAssignees(assignees);</span>
<span class="line-modified"> 782         }</span>
<span class="line-modified"> 783         System.out.println(pr.webUrl().toString());</span>
<span class="line-modified"> 784         Files.deleteIfExists(file);</span>










 785 
<span class="line-modified"> 786         repo.config(&quot;pr.&quot; + currentBranch.name(), &quot;id&quot;, pr.id().toString());</span>
<span class="line-modified"> 787     }</span>

































 788 
<span class="line-modified"> 789     private static void integrate(String[] args) throws IOException, InterruptedException {</span>
<span class="line-modified"> 790         var flags = List.of(</span>
<span class="line-modified"> 791             Option.shortcut(&quot;u&quot;)</span>
<span class="line-modified"> 792                   .fullname(&quot;username&quot;)</span>
<span class="line-modified"> 793                   .describe(&quot;NAME&quot;)</span>
<span class="line-modified"> 794                   .helptext(&quot;Username on host&quot;)</span>
<span class="line-modified"> 795                   .optional(),</span>
<span class="line-modified"> 796             Option.shortcut(&quot;r&quot;)</span>
<span class="line-modified"> 797                   .fullname(&quot;remote&quot;)</span>
<span class="line-modified"> 798                   .describe(&quot;NAME&quot;)</span>
<span class="line-modified"> 799                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)</span>
<span class="line-modified"> 800                   .optional(),</span>
<span class="line-modified"> 801             Switch.shortcut(&quot;&quot;)</span>
<span class="line-modified"> 802                   .fullname(&quot;atomic&quot;)</span>
<span class="line-added"> 803                   .helptext(&quot;Integrate the pull request atomically&quot;)</span>
<span class="line-added"> 804                   .optional(),</span>
<span class="line-added"> 805             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added"> 806                   .fullname(&quot;verbose&quot;)</span>
<span class="line-added"> 807                   .helptext(&quot;Turn on verbose output&quot;)</span>
<span class="line-added"> 808                   .optional(),</span>
<span class="line-added"> 809             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added"> 810                   .fullname(&quot;debug&quot;)</span>
<span class="line-added"> 811                   .helptext(&quot;Turn on debugging output&quot;)</span>
<span class="line-added"> 812                   .optional(),</span>
<span class="line-added"> 813             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added"> 814                   .fullname(&quot;version&quot;)</span>
<span class="line-added"> 815                   .helptext(&quot;Print the version of this tool&quot;)</span>
<span class="line-added"> 816                   .optional()</span>
<span class="line-added"> 817         );</span>
 818 
<span class="line-modified"> 819         var inputs = List.of(</span>
<span class="line-modified"> 820             Input.position(0)</span>
<span class="line-modified"> 821                  .describe(&quot;ID&quot;)</span>
<span class="line-modified"> 822                  .singular()</span>
<span class="line-modified"> 823                  .optional()</span>
<span class="line-modified"> 824         );</span>




 825 
<span class="line-modified"> 826         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);</span>
<span class="line-modified"> 827         var arguments = parse(parser, args);</span>
<span class="line-modified"> 828         var repo = getRepo();</span>
<span class="line-modified"> 829         var uri = getURI(repo, arguments);</span>
<span class="line-modified"> 830         var host = getForge(uri, repo, arguments);</span>
<span class="line-modified"> 831         var id = pullRequestIdArgument(repo, arguments);</span>
<span class="line-modified"> 832         var pr = getPullRequest(uri, repo, host, id);</span>
<span class="line-modified"> 833         var isAtomic = getSwitch(&quot;atomic&quot;, &quot;integrate&quot;, arguments);</span>
<span class="line-modified"> 834 </span>
<span class="line-modified"> 835         var message = &quot;/integrate&quot;;</span>
<span class="line-modified"> 836         if (isAtomic) {</span>
<span class="line-modified"> 837             var targetHash = repo.resolve(pr.targetRef());</span>
<span class="line-modified"> 838             if (!targetHash.isPresent()) {</span>
<span class="line-modified"> 839                 exit(&quot;error: cannot resolve target branch &quot; + pr.targetRef());</span>















 840             }
<span class="line-added"> 841             var sourceHash = repo.fetch(pr.repository().webUrl(), pr.fetchRef());</span>
<span class="line-added"> 842             var mergeBase = repo.mergeBase(sourceHash, targetHash.get());</span>
<span class="line-added"> 843             message += &quot; &quot; + mergeBase.hex();</span>
<span class="line-added"> 844         }</span>
 845 
<span class="line-modified"> 846         var integrateComment = pr.addComment(message);</span>
 847 
<span class="line-modified"> 848         var seenIntegrateComment = false;</span>
<span class="line-modified"> 849         var expected = &quot;&lt;!-- Jmerge command reply message (&quot; + integrateComment.id() + &quot;) --&gt;&quot;;</span>
<span class="line-modified"> 850         for (var i = 0; i &lt; 90; i++) {</span>
<span class="line-modified"> 851             var comments = pr.comments();</span>
<span class="line-modified"> 852             for (var comment : comments) {</span>
<span class="line-modified"> 853                 if (!seenIntegrateComment) {</span>
<span class="line-modified"> 854                     if (comment.id().equals(integrateComment.id())) {</span>
<span class="line-modified"> 855                         seenIntegrateComment = true;</span>












 856                     }
<span class="line-added"> 857                     continue;</span>
 858                 }
<span class="line-modified"> 859                 var lines = comment.body().split(&quot;\n&quot;);</span>
<span class="line-modified"> 860                 if (lines.length &gt; 0 &amp;&amp; lines[0].equals(expected)) {</span>
<span class="line-modified"> 861                     for (var line : lines) {</span>
<span class="line-modified"> 862                         if (line.startsWith(&quot;Pushed as commit&quot;)) {</span>
<span class="line-modified"> 863                             var output = removeTrailing(line, &quot;.&quot;);</span>




































 864                             System.out.println(output);
 865                             System.exit(0);
 866                         }
 867                     }
 868                 }


 869             }
 870 
<span class="line-modified"> 871             Thread.sleep(2000);</span>
<span class="line-modified"> 872         }</span>



























































 873 
<span class="line-modified"> 874         System.err.println(&quot;error: timed out waiting for response to /integrate command&quot;);</span>
<span class="line-modified"> 875         System.exit(1);</span>
<span class="line-modified"> 876     }</span>

 877 
<span class="line-modified"> 878     private static void test(String[] args) throws IOException, InterruptedException {</span>
<span class="line-modified"> 879         var flags = List.of(</span>
<span class="line-modified"> 880             Option.shortcut(&quot;u&quot;)</span>
<span class="line-modified"> 881                   .fullname(&quot;username&quot;)</span>
<span class="line-added"> 882                   .describe(&quot;NAME&quot;)</span>
<span class="line-added"> 883                   .helptext(&quot;Username on host&quot;)</span>
<span class="line-added"> 884                   .optional(),</span>
<span class="line-added"> 885             Option.shortcut(&quot;r&quot;)</span>
<span class="line-added"> 886                   .fullname(&quot;remote&quot;)</span>
<span class="line-added"> 887                   .describe(&quot;NAME&quot;)</span>
<span class="line-added"> 888                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)</span>
<span class="line-added"> 889                   .optional(),</span>
<span class="line-added"> 890             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added"> 891                   .fullname(&quot;verbose&quot;)</span>
<span class="line-added"> 892                   .helptext(&quot;Turn on verbose output&quot;)</span>
<span class="line-added"> 893                   .optional(),</span>
<span class="line-added"> 894             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added"> 895                   .fullname(&quot;debug&quot;)</span>
<span class="line-added"> 896                   .helptext(&quot;Turn on debugging output&quot;)</span>
<span class="line-added"> 897                   .optional(),</span>
<span class="line-added"> 898             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added"> 899                   .fullname(&quot;version&quot;)</span>
<span class="line-added"> 900                   .helptext(&quot;Print the version of this tool&quot;)</span>
<span class="line-added"> 901                   .optional()</span>
<span class="line-added"> 902         );</span>
 903 
<span class="line-modified"> 904         var inputs = List.of(</span>
<span class="line-modified"> 905             Input.position(0)</span>
<span class="line-modified"> 906                  .describe(&quot;ID&quot;)</span>
<span class="line-modified"> 907                  .singular()</span>
<span class="line-added"> 908                  .optional()</span>
<span class="line-added"> 909         );</span>
<span class="line-added"> 910         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);</span>
<span class="line-added"> 911         var arguments = parse(parser, args);</span>
<span class="line-added"> 912         var repo = getRepo();</span>
<span class="line-added"> 913         var uri = getURI(repo, arguments);</span>
<span class="line-added"> 914         var host = getForge(uri, repo, arguments);</span>
<span class="line-added"> 915         var id = pullRequestIdArgument(repo, arguments);</span>
<span class="line-added"> 916         var pr = getPullRequest(uri, repo, host, id);</span>
<span class="line-added"> 917         var head = pr.headHash();</span>
<span class="line-added"> 918         var testComment = pr.addComment(&quot;/test&quot;);</span>
<span class="line-added"> 919 </span>
<span class="line-added"> 920         var seenTestComment = false;</span>
<span class="line-added"> 921         for (var i = 0; i &lt; 90; i++) {</span>
<span class="line-added"> 922             var comments = pr.comments();</span>
<span class="line-added"> 923             for (var comment : comments) {</span>
<span class="line-added"> 924                 if (!seenTestComment) {</span>
<span class="line-added"> 925                     if (comment.id().equals(testComment.id())) {</span>
<span class="line-added"> 926                         seenTestComment = true;</span>
<span class="line-added"> 927                     }</span>
 928                     continue;
 929                 }
<span class="line-modified"> 930                 var lines = comment.body().split(&quot;\n&quot;);</span>
<span class="line-modified"> 931                 var n = lines.length;</span>
<span class="line-modified"> 932                 if (n &gt; 0) {</span>
<span class="line-modified"> 933                     if (n == 4 &amp;&amp;</span>
<span class="line-added"> 934                         lines[0].equals(&quot;&lt;!-- TEST STARTED --&gt;&quot;) &amp;&amp;</span>
<span class="line-added"> 935                         lines[1].startsWith(&quot;&lt;!-- github.com-&quot;) &amp;&amp;</span>
<span class="line-added"> 936                         lines[2].equals(&quot;&lt;!-- &quot; + head.hex() + &quot; --&gt;&quot;)) {</span>
<span class="line-added"> 937                         var output = removeTrailing(lines[3], &quot;.&quot;);</span>
<span class="line-added"> 938                         System.out.println(output);</span>
<span class="line-added"> 939                         System.exit(0);</span>
<span class="line-added"> 940                     } else if (n == 2 &amp;&amp;</span>
<span class="line-added"> 941                                lines[0].equals(&quot;&lt;!-- TEST ERROR --&gt;&quot;)) {</span>
<span class="line-added"> 942                         var output = removeTrailing(lines[1], &quot;.&quot;);</span>
<span class="line-added"> 943                         System.out.println(output);</span>
<span class="line-added"> 944                         System.exit(1);</span>
<span class="line-added"> 945                     } else if (n == 4 &amp;&amp;</span>
<span class="line-added"> 946                                lines[0].equals(&quot;&lt;!-- TEST PENDING --&gt;&quot;) &amp;&amp;</span>
<span class="line-added"> 947                                lines[1].equals(&quot;&lt;!--- &quot; + head.hex() + &quot; --&gt;&quot;)) {</span>
<span class="line-added"> 948                         var output = removeTrailing(lines[3], &quot;.&quot;);</span>
<span class="line-added"> 949                         System.out.println(output);</span>
<span class="line-added"> 950                         System.exit(0);</span>
<span class="line-added"> 951                     }</span>
 952                 }
<span class="line-added"> 953             }</span>
 954 
<span class="line-modified"> 955             Thread.sleep(2000);</span>
<span class="line-modified"> 956         }</span>
<span class="line-modified"> 957     }</span>

 958 
<span class="line-added"> 959     private static void approve(String[] args) throws IOException, InterruptedException {</span>
<span class="line-added"> 960         var flags = List.of(</span>
<span class="line-added"> 961             Option.shortcut(&quot;u&quot;)</span>
<span class="line-added"> 962                   .fullname(&quot;username&quot;)</span>
<span class="line-added"> 963                   .describe(&quot;NAME&quot;)</span>
<span class="line-added"> 964                   .helptext(&quot;Username on host&quot;)</span>
<span class="line-added"> 965                   .optional(),</span>
<span class="line-added"> 966             Option.shortcut(&quot;r&quot;)</span>
<span class="line-added"> 967                   .fullname(&quot;remote&quot;)</span>
<span class="line-added"> 968                   .describe(&quot;NAME&quot;)</span>
<span class="line-added"> 969                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)</span>
<span class="line-added"> 970                   .optional(),</span>
<span class="line-added"> 971             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added"> 972                   .fullname(&quot;verbose&quot;)</span>
<span class="line-added"> 973                   .helptext(&quot;Turn on verbose output&quot;)</span>
<span class="line-added"> 974                   .optional(),</span>
<span class="line-added"> 975             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added"> 976                   .fullname(&quot;debug&quot;)</span>
<span class="line-added"> 977                   .helptext(&quot;Turn on debugging output&quot;)</span>
<span class="line-added"> 978                   .optional(),</span>
<span class="line-added"> 979             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added"> 980                   .fullname(&quot;version&quot;)</span>
<span class="line-added"> 981                   .helptext(&quot;Print the version of this tool&quot;)</span>
<span class="line-added"> 982                   .optional()</span>
<span class="line-added"> 983         );</span>
 984 
<span class="line-modified"> 985         var inputs = List.of(</span>
<span class="line-modified"> 986             Input.position(0)</span>
<span class="line-modified"> 987                  .describe(&quot;ID&quot;)</span>
<span class="line-modified"> 988                  .singular()</span>
<span class="line-modified"> 989                  .optional()</span>
<span class="line-modified"> 990         );</span>
<span class="line-added"> 991         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);</span>
<span class="line-added"> 992         var arguments = parse(parser, args);</span>
<span class="line-added"> 993         var repo = getRepo();</span>
<span class="line-added"> 994         var uri = getURI(repo, arguments);</span>
<span class="line-added"> 995         var host = getForge(uri, repo, arguments);</span>
<span class="line-added"> 996         var id = pullRequestIdArgument(repo, arguments);</span>
<span class="line-added"> 997         var pr = getPullRequest(uri, repo, host, id);</span>
<span class="line-added"> 998         pr.addReview(Review.Verdict.APPROVED, &quot;Looks good!&quot;);</span>
<span class="line-added"> 999     }</span>
1000 
<span class="line-modified">1001     private static void list(String[] args) throws IOException, InterruptedException {</span>
<span class="line-modified">1002         var flags = List.of(</span>
<span class="line-modified">1003             Option.shortcut(&quot;u&quot;)</span>
<span class="line-modified">1004                   .fullname(&quot;username&quot;)</span>
<span class="line-modified">1005                   .describe(&quot;NAME&quot;)</span>
<span class="line-modified">1006                   .helptext(&quot;Username on host&quot;)</span>
<span class="line-added">1007                   .optional(),</span>
<span class="line-added">1008             Option.shortcut(&quot;r&quot;)</span>
<span class="line-added">1009                   .fullname(&quot;remote&quot;)</span>
<span class="line-added">1010                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">1011                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)</span>
<span class="line-added">1012                   .optional(),</span>
<span class="line-added">1013             Option.shortcut(&quot;&quot;)</span>
<span class="line-added">1014                   .fullname(&quot;authors&quot;)</span>
<span class="line-added">1015                   .describe(&quot;LIST&quot;)</span>
<span class="line-added">1016                   .helptext(&quot;Comma separated list of authors&quot;)</span>
<span class="line-added">1017                   .optional(),</span>
<span class="line-added">1018             Option.shortcut(&quot;&quot;)</span>
<span class="line-added">1019                   .fullname(&quot;assignees&quot;)</span>
<span class="line-added">1020                   .describe(&quot;LIST&quot;)</span>
<span class="line-added">1021                   .helptext(&quot;Comma separated list of assignees&quot;)</span>
<span class="line-added">1022                   .optional(),</span>
<span class="line-added">1023             Option.shortcut(&quot;&quot;)</span>
<span class="line-added">1024                   .fullname(&quot;labels&quot;)</span>
<span class="line-added">1025                   .describe(&quot;LIST&quot;)</span>
<span class="line-added">1026                   .helptext(&quot;Comma separated list of labels&quot;)</span>
<span class="line-added">1027                   .optional(),</span>
<span class="line-added">1028             Option.shortcut(&quot;&quot;)</span>
<span class="line-added">1029                   .fullname(&quot;issues&quot;)</span>
<span class="line-added">1030                   .describe(&quot;LIST&quot;)</span>
<span class="line-added">1031                   .helptext(&quot;Comma separated list of issues&quot;)</span>
<span class="line-added">1032                   .optional(),</span>
<span class="line-added">1033             Option.shortcut(&quot;&quot;)</span>
<span class="line-added">1034                   .fullname(&quot;columns&quot;)</span>
<span class="line-added">1035                   .describe(&quot;id,title,author,assignees,labels&quot;)</span>
<span class="line-added">1036                   .helptext(&quot;Comma separated list of columns to show&quot;)</span>
<span class="line-added">1037                   .optional(),</span>
<span class="line-added">1038             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">1039                   .fullname(&quot;no-decoration&quot;)</span>
<span class="line-added">1040                   .helptext(&quot;Hide any decorations when listing PRs&quot;)</span>
<span class="line-added">1041                   .optional(),</span>
<span class="line-added">1042             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">1043                   .fullname(&quot;no-draft&quot;)</span>
<span class="line-added">1044                   .helptext(&quot;Hide all pull requests in draft state&quot;)</span>
<span class="line-added">1045                   .optional(),</span>
<span class="line-added">1046             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">1047                   .fullname(&quot;no-token&quot;)</span>
<span class="line-added">1048                   .helptext(&quot;Do not use a personal access token (PAT)&quot;)</span>
<span class="line-added">1049                   .optional(),</span>
<span class="line-added">1050             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">1051                   .fullname(&quot;verbose&quot;)</span>
<span class="line-added">1052                   .helptext(&quot;Turn on verbose output&quot;)</span>
<span class="line-added">1053                   .optional(),</span>
<span class="line-added">1054             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">1055                   .fullname(&quot;debug&quot;)</span>
<span class="line-added">1056                   .helptext(&quot;Turn on debugging output&quot;)</span>
<span class="line-added">1057                   .optional(),</span>
<span class="line-added">1058             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">1059                   .fullname(&quot;version&quot;)</span>
<span class="line-added">1060                   .helptext(&quot;Print the version of this tool&quot;)</span>
<span class="line-added">1061                   .optional());</span>
1062 
<span class="line-modified">1063         var inputs = List.of(</span>
<span class="line-modified">1064             Input.position(0)</span>
<span class="line-modified">1065                  .describe(&quot;ID&quot;)</span>
<span class="line-modified">1066                  .singular()</span>
<span class="line-modified">1067                  .optional()</span>
<span class="line-added">1068         );</span>
<span class="line-added">1069 </span>
<span class="line-added">1070         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);</span>
<span class="line-added">1071         var arguments = parse(parser, args);</span>
<span class="line-added">1072         var repo = getRepo();</span>
<span class="line-added">1073         var uri = getURI(repo, arguments);</span>
<span class="line-added">1074         var host = getForge(uri, repo, arguments);</span>
<span class="line-added">1075         var remoteRepo = getHostedRepositoryFor(uri, repo, host);</span>
<span class="line-added">1076 </span>
<span class="line-added">1077         var prs = remoteRepo.pullRequests();</span>
<span class="line-added">1078         var ids = new ArrayList&lt;String&gt;();</span>
<span class="line-added">1079         var titles = new ArrayList&lt;String&gt;();</span>
<span class="line-added">1080         var authors = new ArrayList&lt;String&gt;();</span>
<span class="line-added">1081         var assignees = new ArrayList&lt;String&gt;();</span>
<span class="line-added">1082         var labels = new ArrayList&lt;String&gt;();</span>
<span class="line-added">1083         var issues = new ArrayList&lt;String&gt;();</span>
<span class="line-added">1084         var branches = new ArrayList&lt;String&gt;();</span>
<span class="line-added">1085         var statuses = new ArrayList&lt;String&gt;();</span>
<span class="line-added">1086         var noDraft = getSwitch(&quot;no-draft&quot;, &quot;list&quot;, arguments);</span>
<span class="line-added">1087 </span>
<span class="line-added">1088         var authorsOption = getOption(&quot;authors&quot;, &quot;list&quot;, arguments);</span>
<span class="line-added">1089         var filterAuthors = authorsOption == null ?</span>
<span class="line-added">1090             Set.of() :</span>
<span class="line-added">1091             new HashSet&lt;&gt;(Arrays.asList(authorsOption.split(&quot;,&quot;)));</span>
<span class="line-added">1092 </span>
<span class="line-added">1093         var assigneesOption = getOption(&quot;assignees&quot;, &quot;list&quot;, arguments);</span>
<span class="line-added">1094         var filterAssignees = assigneesOption == null ?</span>
<span class="line-added">1095             Set.of() :</span>
<span class="line-added">1096             Arrays.asList(assigneesOption.split(&quot;,&quot;));</span>
<span class="line-added">1097 </span>
<span class="line-added">1098         var labelsOption = getOption(&quot;labels&quot;, &quot;list&quot;, arguments);</span>
<span class="line-added">1099         var filterLabels = labelsOption == null ?</span>
<span class="line-added">1100             Set.of() :</span>
<span class="line-added">1101             Arrays.asList(labelsOption.split(&quot;,&quot;));</span>
<span class="line-added">1102 </span>
<span class="line-added">1103         var issuesOption = getOption(&quot;issues&quot;, &quot;list&quot;, arguments);</span>
<span class="line-added">1104         var filterIssues = issuesOption == null ?</span>
<span class="line-added">1105             Set.of() :</span>
<span class="line-added">1106             Arrays.asList(issuesOption.split(&quot;,&quot;));</span>
<span class="line-added">1107 </span>
<span class="line-added">1108         var columnTitles = List.of(&quot;id&quot;, &quot;title&quot;, &quot;authors&quot;, &quot;assignees&quot;, &quot;labels&quot;, &quot;issues&quot;, &quot;branch&quot;, &quot;status&quot;);</span>
<span class="line-added">1109         var columnValues = Map.of(columnTitles.get(0), ids,</span>
<span class="line-added">1110                                   columnTitles.get(1), titles,</span>
<span class="line-added">1111                                   columnTitles.get(2), authors,</span>
<span class="line-added">1112                                   columnTitles.get(3), assignees,</span>
<span class="line-added">1113                                   columnTitles.get(4), labels,</span>
<span class="line-added">1114                                   columnTitles.get(5), issues,</span>
<span class="line-added">1115                                   columnTitles.get(6), branches,</span>
<span class="line-added">1116                                   columnTitles.get(7), statuses);</span>
<span class="line-added">1117         var columnsOption = getOption(&quot;columns&quot;, &quot;list&quot;, arguments);</span>
<span class="line-added">1118         var columns = columnsOption == null ?</span>
<span class="line-added">1119             List.of(&quot;id&quot;, &quot;title&quot;, &quot;authors&quot;, &quot;status&quot;) :</span>
<span class="line-added">1120             Arrays.asList(columnsOption.split(&quot;,&quot;));</span>
<span class="line-added">1121 </span>
<span class="line-added">1122         for (var column : columns) {</span>
<span class="line-added">1123             if (!columnTitles.contains(column)) {</span>
<span class="line-added">1124                 System.err.println(&quot;error: unknown column: &quot; + column);</span>
<span class="line-added">1125                 System.err.println(&quot;       available columns are: &quot; + String.join(&quot;,&quot;, columnTitles));</span>
<span class="line-added">1126                 System.exit(1);</span>
1127             }
<span class="line-added">1128         }</span>
1129 
<span class="line-added">1130         for (var pr : prs) {</span>
<span class="line-added">1131             if (pr.isDraft() &amp;&amp; noDraft) {</span>
<span class="line-added">1132                 continue;</span>
<span class="line-added">1133             }</span>
1134 
<span class="line-modified">1135             var prAuthor = pr.author().userName();</span>
<span class="line-modified">1136             if (!filterAuthors.isEmpty() &amp;&amp; !filterAuthors.contains(prAuthor)) {</span>
<span class="line-modified">1137                 continue;</span>


1138             }
<span class="line-modified">1139 </span>
<span class="line-modified">1140             var prAssignees = pr.assignees().stream()</span>
<span class="line-modified">1141                                 .map(HostUser::userName)</span>
<span class="line-modified">1142                                 .collect(Collectors.toSet());</span>
<span class="line-modified">1143             if (!filterAssignees.isEmpty() &amp;&amp; !filterAssignees.stream().anyMatch(prAssignees::contains)) {</span>
<span class="line-modified">1144                 continue;</span>


1145             }
<span class="line-modified">1146 </span>
<span class="line-modified">1147             var prLabels = new HashSet&lt;&gt;(pr.labels());</span>
<span class="line-modified">1148             if (!filterLabels.isEmpty() &amp;&amp; !filterLabels.stream().anyMatch(prLabels::contains)) {</span>
<span class="line-modified">1149                 continue;</span>



1150             }
<span class="line-modified">1151 </span>
<span class="line-modified">1152             var prIssues = new HashSet&lt;&gt;(issuesFromPullRequest(pr));</span>
<span class="line-modified">1153             if (!filterIssues.isEmpty() &amp;&amp; !filterIssues.stream().anyMatch(prIssues::contains)) {</span>
<span class="line-modified">1154                 continue;</span>
1155             }
1156 









































1157 
<span class="line-modified">1158             ids.add(pr.id());</span>
<span class="line-modified">1159             titles.add(pr.title());</span>
<span class="line-added">1160             authors.add(prAuthor);</span>
<span class="line-added">1161             assignees.add(String.join(&quot;,&quot;, prAssignees));</span>
<span class="line-added">1162             labels.add(String.join(&quot;,&quot;, prLabels));</span>
<span class="line-added">1163             issues.add(String.join(&quot;,&quot;, prIssues));</span>
1164 
<span class="line-modified">1165             if (pr.sourceRepository().webUrl().equals(uri)) {</span>
<span class="line-modified">1166                 branches.add(pr.sourceRef());</span>
<span class="line-modified">1167             } else {</span>
<span class="line-modified">1168                 branches.add(&quot;&quot;);</span>























1169             }
1170 
<span class="line-modified">1171             if (columns.contains(&quot;status&quot;)) {</span>
<span class="line-modified">1172                 statuses.add(statusForPullRequest(pr).toLowerCase());</span>
<span class="line-modified">1173             } else {</span>
<span class="line-modified">1174                 statuses.add(&quot;&quot;);</span>



1175             }
<span class="line-added">1176         }</span>
1177 
<span class="line-modified">1178 </span>
<span class="line-modified">1179         String fmt = &quot;&quot;;</span>
<span class="line-modified">1180         for (var column : columns.subList(0, columns.size() - 1)) {</span>
<span class="line-modified">1181             var values = columnValues.get(column);</span>
<span class="line-modified">1182             var n = Math.max(column.length(), longest(values));</span>
<span class="line-modified">1183             fmt += &quot;%-&quot; + n + &quot;s    &quot;;</span>
<span class="line-modified">1184         }</span>
<span class="line-modified">1185         fmt += &quot;%s\n&quot;;</span>
<span class="line-modified">1186 </span>
<span class="line-modified">1187         var noDecoration = getSwitch(&quot;no-decoration&quot;, &quot;list&quot;, arguments);</span>
<span class="line-modified">1188         if (!ids.isEmpty() &amp;&amp; !noDecoration) {</span>
<span class="line-modified">1189             var upperCase = columns.stream()</span>
<span class="line-modified">1190                                    .map(String::toUpperCase)</span>
<span class="line-modified">1191                                    .collect(Collectors.toList());</span>
<span class="line-modified">1192             System.out.format(fmt, (Object[]) upperCase.toArray(new String[0]));</span>
<span class="line-modified">1193         }</span>
<span class="line-modified">1194         for (var i = 0; i &lt; ids.size(); i++) {</span>
<span class="line-modified">1195             final int n = i;</span>
<span class="line-modified">1196             var row = columns.stream()</span>
<span class="line-modified">1197                              .map(columnValues::get)</span>
<span class="line-modified">1198                              .map(values -&gt; values.get(n))</span>
<span class="line-modified">1199                              .collect(Collectors.toList());</span>
<span class="line-modified">1200             System.out.format(fmt, (Object[]) row.toArray(new String[0]));</span>
<span class="line-modified">1201         }</span>
<span class="line-modified">1202     }</span>
<span class="line-modified">1203 </span>
<span class="line-modified">1204     private static void close(String[] args) throws IOException, InterruptedException {</span>
<span class="line-modified">1205         var flags = List.of(</span>
<span class="line-modified">1206             Option.shortcut(&quot;u&quot;)</span>
<span class="line-modified">1207                   .fullname(&quot;username&quot;)</span>
<span class="line-modified">1208                   .describe(&quot;NAME&quot;)</span>
<span class="line-modified">1209                   .helptext(&quot;Username on host&quot;)</span>
<span class="line-modified">1210                   .optional(),</span>
<span class="line-added">1211             Option.shortcut(&quot;r&quot;)</span>
<span class="line-added">1212                   .fullname(&quot;remote&quot;)</span>
<span class="line-added">1213                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">1214                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)</span>
<span class="line-added">1215                   .optional(),</span>
<span class="line-added">1216             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">1217                   .fullname(&quot;verbose&quot;)</span>
<span class="line-added">1218                   .helptext(&quot;Turn on verbose output&quot;)</span>
<span class="line-added">1219                   .optional(),</span>
<span class="line-added">1220             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">1221                   .fullname(&quot;debug&quot;)</span>
<span class="line-added">1222                   .helptext(&quot;Turn on debugging output&quot;)</span>
<span class="line-added">1223                   .optional(),</span>
<span class="line-added">1224             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">1225                   .fullname(&quot;version&quot;)</span>
<span class="line-added">1226                   .helptext(&quot;Print the version of this tool&quot;)</span>
<span class="line-added">1227                   .optional()</span>
<span class="line-added">1228         );</span>
<span class="line-added">1229 </span>
<span class="line-added">1230         var inputs = List.of(</span>
<span class="line-added">1231             Input.position(0)</span>
<span class="line-added">1232                  .describe(&quot;ID&quot;)</span>
<span class="line-added">1233                  .singular()</span>
<span class="line-added">1234                  .optional()</span>
<span class="line-added">1235         );</span>
<span class="line-added">1236 </span>
<span class="line-added">1237         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);</span>
<span class="line-added">1238         var arguments = parse(parser, args);</span>
<span class="line-added">1239         var repo = getRepo();</span>
<span class="line-added">1240         var uri = getURI(repo, arguments);</span>
<span class="line-added">1241         var host = getForge(uri, repo, arguments);</span>
<span class="line-added">1242         var id = pullRequestIdArgument(repo, arguments);</span>
<span class="line-added">1243         var pr = getPullRequest(uri, repo, host, id);</span>
<span class="line-added">1244 </span>
<span class="line-added">1245         pr.setState(PullRequest.State.CLOSED);</span>
<span class="line-added">1246     }</span>
<span class="line-added">1247 </span>
<span class="line-added">1248     private static void set(String[] args) throws IOException, InterruptedException {</span>
<span class="line-added">1249         var flags = List.of(</span>
<span class="line-added">1250             Option.shortcut(&quot;u&quot;)</span>
<span class="line-added">1251                   .fullname(&quot;username&quot;)</span>
<span class="line-added">1252                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">1253                   .helptext(&quot;Username on host&quot;)</span>
<span class="line-added">1254                   .optional(),</span>
<span class="line-added">1255             Option.shortcut(&quot;r&quot;)</span>
<span class="line-added">1256                   .fullname(&quot;remote&quot;)</span>
<span class="line-added">1257                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">1258                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)</span>
<span class="line-added">1259                   .optional(),</span>
<span class="line-added">1260             Option.shortcut(&quot;&quot;)</span>
<span class="line-added">1261                   .fullname(&quot;assignees&quot;)</span>
<span class="line-added">1262                   .describe(&quot;LIST&quot;)</span>
<span class="line-added">1263                   .helptext(&quot;Comma separated list of assignees&quot;)</span>
<span class="line-added">1264                   .optional(),</span>
<span class="line-added">1265             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">1266                   .fullname(&quot;verbose&quot;)</span>
<span class="line-added">1267                   .helptext(&quot;Turn on verbose output&quot;)</span>
<span class="line-added">1268                   .optional(),</span>
<span class="line-added">1269             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">1270                   .fullname(&quot;debug&quot;)</span>
<span class="line-added">1271                   .helptext(&quot;Turn on debugging output&quot;)</span>
<span class="line-added">1272                   .optional(),</span>
<span class="line-added">1273             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">1274                   .fullname(&quot;version&quot;)</span>
<span class="line-added">1275                   .helptext(&quot;Print the version of this tool&quot;)</span>
<span class="line-added">1276                   .optional()</span>
<span class="line-added">1277         );</span>
<span class="line-added">1278 </span>
<span class="line-added">1279         var inputs = List.of(</span>
<span class="line-added">1280             Input.position(0)</span>
<span class="line-added">1281                  .describe(&quot;ID&quot;)</span>
<span class="line-added">1282                  .singular()</span>
<span class="line-added">1283                  .optional()</span>
<span class="line-added">1284         );</span>
<span class="line-added">1285 </span>
<span class="line-added">1286         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);</span>
<span class="line-added">1287         var arguments = parse(parser, args);</span>
<span class="line-added">1288         var repo = getRepo();</span>
<span class="line-added">1289         var uri = getURI(repo, arguments);</span>
<span class="line-added">1290         var host = getForge(uri, repo, arguments);</span>
<span class="line-added">1291         var id = pullRequestIdArgument(repo, arguments);</span>
<span class="line-added">1292         var pr = getPullRequest(uri, repo, host, id);</span>
<span class="line-added">1293 </span>
<span class="line-added">1294         var assigneesOption = getOption(&quot;assignees&quot;, &quot;set&quot;, arguments);</span>
<span class="line-added">1295         if (assigneesOption != null) {</span>
<span class="line-added">1296             var usernames = Arrays.asList(assigneesOption.split(&quot;,&quot;));</span>
<span class="line-added">1297             var assignees = usernames.stream()</span>
<span class="line-added">1298                 .map(u -&gt; host.user(u))</span>
<span class="line-added">1299                 .filter(Optional::isPresent)</span>
<span class="line-added">1300                 .map(Optional::get)</span>
<span class="line-added">1301                 .collect(Collectors.toList());</span>
<span class="line-added">1302             pr.setAssignees(assignees);</span>
<span class="line-added">1303         }</span>
<span class="line-added">1304     }</span>
<span class="line-added">1305 </span>
<span class="line-added">1306     private static void status(String[] args) throws IOException, InterruptedException {</span>
<span class="line-added">1307         var flags = List.of(</span>
<span class="line-added">1308             Option.shortcut(&quot;u&quot;)</span>
<span class="line-added">1309                   .fullname(&quot;username&quot;)</span>
<span class="line-added">1310                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">1311                   .helptext(&quot;Username on host&quot;)</span>
<span class="line-added">1312                   .optional(),</span>
<span class="line-added">1313             Option.shortcut(&quot;r&quot;)</span>
<span class="line-added">1314                   .fullname(&quot;remote&quot;)</span>
<span class="line-added">1315                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">1316                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)</span>
<span class="line-added">1317                   .optional(),</span>
<span class="line-added">1318             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">1319                   .fullname(&quot;no-decoration&quot;)</span>
<span class="line-added">1320                   .helptext(&quot;Hide any decorations when listing PRs&quot;)</span>
<span class="line-added">1321                   .optional(),</span>
<span class="line-added">1322             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">1323                   .fullname(&quot;no-token&quot;)</span>
<span class="line-added">1324                   .helptext(&quot;Do not use a personal access token (PAT)&quot;)</span>
<span class="line-added">1325                   .optional(),</span>
<span class="line-added">1326             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">1327                   .fullname(&quot;no-checks&quot;)</span>
<span class="line-added">1328                   .helptext(&quot;Do not show check status as part of the &#39;git pr status&#39; output&quot;)</span>
<span class="line-added">1329                   .optional(),</span>
<span class="line-added">1330             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">1331                   .fullname(&quot;verbose&quot;)</span>
<span class="line-added">1332                   .helptext(&quot;Turn on verbose output&quot;)</span>
<span class="line-added">1333                   .optional(),</span>
<span class="line-added">1334             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">1335                   .fullname(&quot;debug&quot;)</span>
<span class="line-added">1336                   .helptext(&quot;Turn on debugging output&quot;)</span>
<span class="line-added">1337                   .optional(),</span>
<span class="line-added">1338             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">1339                   .fullname(&quot;version&quot;)</span>
<span class="line-added">1340                   .helptext(&quot;Print the version of this tool&quot;)</span>
<span class="line-added">1341                   .optional()</span>
<span class="line-added">1342         );</span>
<span class="line-added">1343 </span>
<span class="line-added">1344         var inputs = List.of(</span>
<span class="line-added">1345             Input.position(0)</span>
<span class="line-added">1346                  .describe(&quot;ID&quot;)</span>
<span class="line-added">1347                  .singular()</span>
<span class="line-added">1348                  .optional()</span>
<span class="line-added">1349         );</span>
<span class="line-added">1350 </span>
<span class="line-added">1351         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);</span>
<span class="line-added">1352         var arguments = parse(parser, args);</span>
<span class="line-added">1353         var repo = getRepo();</span>
<span class="line-added">1354         var uri = getURI(repo, arguments);</span>
<span class="line-added">1355         var host = getForge(uri, repo, arguments);</span>
<span class="line-added">1356         var id = pullRequestIdArgument(repo, arguments);</span>
<span class="line-added">1357         var pr = getPullRequest(uri, repo, host, id);</span>
<span class="line-added">1358 </span>
<span class="line-added">1359         var noDecoration = getSwitch(&quot;no-decoration&quot;, &quot;status&quot;, arguments);</span>
<span class="line-added">1360         var decoration = noDecoration ? &quot;&quot; : &quot;Status: &quot;;</span>
<span class="line-added">1361         System.out.println(decoration + statusForPullRequest(pr));</span>
<span class="line-added">1362 </span>
<span class="line-added">1363         var noChecks = getSwitch(&quot;no-checks&quot;, &quot;status&quot;, arguments);</span>
<span class="line-added">1364         if (!noChecks) {</span>
<span class="line-added">1365             var checks = pr.checks(pr.headHash());</span>
<span class="line-added">1366             var jcheck = Optional.ofNullable(checks.get(&quot;jcheck&quot;));</span>
<span class="line-added">1367             var submit = Optional.ofNullable(checks.get(&quot;submit&quot;));</span>
<span class="line-added">1368             var showChecks = jcheck.isPresent() || submit.isPresent();</span>
<span class="line-added">1369             if (showChecks) {</span>
<span class="line-added">1370                 System.out.println(&quot;Checks:&quot;);</span>
<span class="line-added">1371                 if (jcheck.isPresent()) {</span>
<span class="line-added">1372                     System.out.println(&quot;- jcheck: &quot; + statusForCheck(jcheck.get()));</span>
<span class="line-added">1373                 }</span>
<span class="line-added">1374                 if (submit.isPresent()) {</span>
<span class="line-added">1375                     System.out.println(&quot;- submit: &quot; + statusForCheck(submit.get()));</span>
1376                 }
1377             }
<span class="line-added">1378         }</span>
<span class="line-added">1379     }</span>
<span class="line-added">1380 </span>
<span class="line-added">1381     private static void fetch(String[] args) throws IOException, InterruptedException {</span>
<span class="line-added">1382         var flags = List.of(</span>
<span class="line-added">1383             Option.shortcut(&quot;u&quot;)</span>
<span class="line-added">1384                   .fullname(&quot;username&quot;)</span>
<span class="line-added">1385                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">1386                   .helptext(&quot;Username on host&quot;)</span>
<span class="line-added">1387                   .optional(),</span>
<span class="line-added">1388             Option.shortcut(&quot;r&quot;)</span>
<span class="line-added">1389                   .fullname(&quot;remote&quot;)</span>
<span class="line-added">1390                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">1391                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)</span>
<span class="line-added">1392                   .optional(),</span>
<span class="line-added">1393             Option.shortcut(&quot;b&quot;)</span>
<span class="line-added">1394                   .fullname(&quot;branch&quot;)</span>
<span class="line-added">1395                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">1396                   .helptext(&quot;Name of target branch, defaults to &#39;master&#39;&quot;)</span>
<span class="line-added">1397                   .optional(),</span>
<span class="line-added">1398             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">1399                   .fullname(&quot;no-token&quot;)</span>
<span class="line-added">1400                   .helptext(&quot;Do not use a personal access token (PAT)&quot;)</span>
<span class="line-added">1401                   .optional(),</span>
<span class="line-added">1402             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">1403                   .fullname(&quot;verbose&quot;)</span>
<span class="line-added">1404                   .helptext(&quot;Turn on verbose output&quot;)</span>
<span class="line-added">1405                   .optional(),</span>
<span class="line-added">1406             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">1407                   .fullname(&quot;debug&quot;)</span>
<span class="line-added">1408                   .helptext(&quot;Turn on debugging output&quot;)</span>
<span class="line-added">1409                   .optional(),</span>
<span class="line-added">1410             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">1411                   .fullname(&quot;version&quot;)</span>
<span class="line-added">1412                   .helptext(&quot;Print the version of this tool&quot;)</span>
<span class="line-added">1413                   .optional()</span>
<span class="line-added">1414         );</span>
<span class="line-added">1415 </span>
<span class="line-added">1416         var inputs = List.of(</span>
<span class="line-added">1417             Input.position(0)</span>
<span class="line-added">1418                  .describe(&quot;ID&quot;)</span>
<span class="line-added">1419                  .singular()</span>
<span class="line-added">1420                  .optional()</span>
<span class="line-added">1421         );</span>
<span class="line-added">1422 </span>
<span class="line-added">1423         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);</span>
<span class="line-added">1424         var arguments = parse(parser, args);</span>
<span class="line-added">1425         var repo = getRepo();</span>
<span class="line-added">1426         var uri = getURI(repo, arguments);</span>
<span class="line-added">1427         var host = getForge(uri, repo, arguments);</span>
<span class="line-added">1428         var id = pullRequestIdArgument(repo, arguments);</span>
<span class="line-added">1429         var pr = getPullRequest(uri, repo, host, id);</span>
<span class="line-added">1430 </span>
<span class="line-added">1431         var fetchHead = repo.fetch(pr.repository().webUrl(), pr.fetchRef());</span>
<span class="line-added">1432         var branchName = getOption(&quot;branch&quot;, &quot;fetch&quot;, arguments);</span>
<span class="line-added">1433         if (branchName != null) {</span>
<span class="line-added">1434             repo.branch(fetchHead, branchName);</span>
<span class="line-added">1435         } else {</span>
<span class="line-added">1436             System.out.println(fetchHead.hex());</span>
<span class="line-added">1437         }</span>
<span class="line-added">1438     }</span>
<span class="line-added">1439 </span>
<span class="line-added">1440     private static void show(String[] args) throws IOException, InterruptedException {</span>
<span class="line-added">1441         var flags = List.of(</span>
<span class="line-added">1442             Option.shortcut(&quot;u&quot;)</span>
<span class="line-added">1443                   .fullname(&quot;username&quot;)</span>
<span class="line-added">1444                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">1445                   .helptext(&quot;Username on host&quot;)</span>
<span class="line-added">1446                   .optional(),</span>
<span class="line-added">1447             Option.shortcut(&quot;r&quot;)</span>
<span class="line-added">1448                   .fullname(&quot;remote&quot;)</span>
<span class="line-added">1449                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">1450                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)</span>
<span class="line-added">1451                   .optional(),</span>
<span class="line-added">1452             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">1453                   .fullname(&quot;no-token&quot;)</span>
<span class="line-added">1454                   .helptext(&quot;Do not use a personal access token (PAT)&quot;)</span>
<span class="line-added">1455                   .optional(),</span>
<span class="line-added">1456             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">1457                   .fullname(&quot;verbose&quot;)</span>
<span class="line-added">1458                   .helptext(&quot;Turn on verbose output&quot;)</span>
<span class="line-added">1459                   .optional(),</span>
<span class="line-added">1460             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">1461                   .fullname(&quot;debug&quot;)</span>
<span class="line-added">1462                   .helptext(&quot;Turn on debugging output&quot;)</span>
<span class="line-added">1463                   .optional(),</span>
<span class="line-added">1464             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">1465                   .fullname(&quot;version&quot;)</span>
<span class="line-added">1466                   .helptext(&quot;Print the version of this tool&quot;)</span>
<span class="line-added">1467                   .optional()</span>
<span class="line-added">1468         );</span>
<span class="line-added">1469 </span>
<span class="line-added">1470         var inputs = List.of(</span>
<span class="line-added">1471             Input.position(0)</span>
<span class="line-added">1472                  .describe(&quot;ID&quot;)</span>
<span class="line-added">1473                  .singular()</span>
<span class="line-added">1474                  .optional()</span>
<span class="line-added">1475         );</span>
<span class="line-added">1476 </span>
<span class="line-added">1477         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);</span>
<span class="line-added">1478         var arguments = parse(parser, args);</span>
<span class="line-added">1479         var repo = getRepo();</span>
<span class="line-added">1480         var uri = getURI(repo, arguments);</span>
<span class="line-added">1481         var host = getForge(uri, repo, arguments);</span>
<span class="line-added">1482         var id = pullRequestIdArgument(repo, arguments);</span>
<span class="line-added">1483         var pr = getPullRequest(uri, repo, host, id);</span>
<span class="line-added">1484 </span>
<span class="line-added">1485         var fetchHead = repo.fetch(pr.repository().webUrl(), pr.fetchRef());</span>
<span class="line-added">1486         show(pr.targetRef(), fetchHead);</span>
<span class="line-added">1487     }</span>
<span class="line-added">1488 </span>
<span class="line-added">1489     private static void checkout(String[] args) throws IOException, InterruptedException {</span>
<span class="line-added">1490         var flags = List.of(</span>
<span class="line-added">1491             Option.shortcut(&quot;u&quot;)</span>
<span class="line-added">1492                   .fullname(&quot;username&quot;)</span>
<span class="line-added">1493                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">1494                   .helptext(&quot;Username on host&quot;)</span>
<span class="line-added">1495                   .optional(),</span>
<span class="line-added">1496             Option.shortcut(&quot;r&quot;)</span>
<span class="line-added">1497                   .fullname(&quot;remote&quot;)</span>
<span class="line-added">1498                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">1499                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)</span>
<span class="line-added">1500                   .optional(),</span>
<span class="line-added">1501             Option.shortcut(&quot;b&quot;)</span>
<span class="line-added">1502                   .fullname(&quot;branch&quot;)</span>
<span class="line-added">1503                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">1504                   .helptext(&quot;Name of target branch, defaults to &#39;master&#39;&quot;)</span>
<span class="line-added">1505                   .optional(),</span>
<span class="line-added">1506             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">1507                   .fullname(&quot;no-token&quot;)</span>
<span class="line-added">1508                   .helptext(&quot;Do not use a personal access token (PAT)&quot;)</span>
<span class="line-added">1509                   .optional(),</span>
<span class="line-added">1510             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">1511                   .fullname(&quot;verbose&quot;)</span>
<span class="line-added">1512                   .helptext(&quot;Turn on verbose output&quot;)</span>
<span class="line-added">1513                   .optional(),</span>
<span class="line-added">1514             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">1515                   .fullname(&quot;debug&quot;)</span>
<span class="line-added">1516                   .helptext(&quot;Turn on debugging output&quot;)</span>
<span class="line-added">1517                   .optional(),</span>
<span class="line-added">1518             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">1519                   .fullname(&quot;version&quot;)</span>
<span class="line-added">1520                   .helptext(&quot;Print the version of this tool&quot;)</span>
<span class="line-added">1521                   .optional()</span>
<span class="line-added">1522         );</span>
<span class="line-added">1523 </span>
<span class="line-added">1524         var inputs = List.of(</span>
<span class="line-added">1525             Input.position(0)</span>
<span class="line-added">1526                  .describe(&quot;ID&quot;)</span>
<span class="line-added">1527                  .singular()</span>
<span class="line-added">1528                  .optional()</span>
<span class="line-added">1529         );</span>
<span class="line-added">1530 </span>
<span class="line-added">1531         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);</span>
<span class="line-added">1532         var arguments = parse(parser, args);</span>
<span class="line-added">1533         var repo = getRepo();</span>
<span class="line-added">1534         var uri = getURI(repo, arguments);</span>
<span class="line-added">1535         var host = getForge(uri, repo, arguments);</span>
<span class="line-added">1536         var id = pullRequestIdArgument(repo, arguments);</span>
<span class="line-added">1537         var pr = getPullRequest(uri, repo, host, id);</span>
<span class="line-added">1538 </span>
<span class="line-added">1539         var fetchHead = repo.fetch(pr.repository().webUrl(), pr.fetchRef());</span>
<span class="line-added">1540         var branchName = getOption(&quot;branch&quot;, &quot;checkout&quot;, arguments);</span>
<span class="line-added">1541         if (branchName != null) {</span>
<span class="line-added">1542             var branch = repo.branch(fetchHead, branchName);</span>
<span class="line-added">1543             repo.checkout(branch, false);</span>
1544         } else {
<span class="line-modified">1545             repo.checkout(fetchHead, false);</span>
1546         }
1547     }
<span class="line-added">1548 </span>
<span class="line-added">1549     private static void apply(String[] args) throws IOException, InterruptedException {</span>
<span class="line-added">1550         var flags = List.of(</span>
<span class="line-added">1551             Option.shortcut(&quot;u&quot;)</span>
<span class="line-added">1552                   .fullname(&quot;username&quot;)</span>
<span class="line-added">1553                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">1554                   .helptext(&quot;Username on host&quot;)</span>
<span class="line-added">1555                   .optional(),</span>
<span class="line-added">1556             Option.shortcut(&quot;r&quot;)</span>
<span class="line-added">1557                   .fullname(&quot;remote&quot;)</span>
<span class="line-added">1558                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">1559                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)</span>
<span class="line-added">1560                   .optional(),</span>
<span class="line-added">1561             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">1562                   .fullname(&quot;no-token&quot;)</span>
<span class="line-added">1563                   .helptext(&quot;Do not use a personal access token (PAT)&quot;)</span>
<span class="line-added">1564                   .optional(),</span>
<span class="line-added">1565             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">1566                   .fullname(&quot;verbose&quot;)</span>
<span class="line-added">1567                   .helptext(&quot;Turn on verbose output&quot;)</span>
<span class="line-added">1568                   .optional(),</span>
<span class="line-added">1569             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">1570                   .fullname(&quot;debug&quot;)</span>
<span class="line-added">1571                   .helptext(&quot;Turn on debugging output&quot;)</span>
<span class="line-added">1572                   .optional(),</span>
<span class="line-added">1573             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">1574                   .fullname(&quot;version&quot;)</span>
<span class="line-added">1575                   .helptext(&quot;Print the version of this tool&quot;)</span>
<span class="line-added">1576                   .optional()</span>
<span class="line-added">1577         );</span>
<span class="line-added">1578 </span>
<span class="line-added">1579         var inputs = List.of(</span>
<span class="line-added">1580             Input.position(0)</span>
<span class="line-added">1581                  .describe(&quot;ID&quot;)</span>
<span class="line-added">1582                  .singular()</span>
<span class="line-added">1583                  .optional()</span>
<span class="line-added">1584         );</span>
<span class="line-added">1585 </span>
<span class="line-added">1586         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);</span>
<span class="line-added">1587         var arguments = parse(parser, args);</span>
<span class="line-added">1588         var repo = getRepo();</span>
<span class="line-added">1589         var uri = getURI(repo, arguments);</span>
<span class="line-added">1590         var host = getForge(uri, repo, arguments);</span>
<span class="line-added">1591         var id = pullRequestIdArgument(repo, arguments);</span>
<span class="line-added">1592         var pr = getPullRequest(uri, repo, host, id);</span>
<span class="line-added">1593 </span>
<span class="line-added">1594         var fetchHead = repo.fetch(pr.repository().webUrl(), pr.fetchRef());</span>
<span class="line-added">1595         var patch = diff(pr.targetRef(), fetchHead);</span>
<span class="line-added">1596         apply(patch);</span>
<span class="line-added">1597         Files.deleteIfExists(patch);</span>
<span class="line-added">1598     }</span>
<span class="line-added">1599 </span>
<span class="line-added">1600     public static void main(String[] args) throws Exception {</span>
<span class="line-added">1601         var commands = List.of(</span>
<span class="line-added">1602                     Default.name(&quot;list&quot;)</span>
<span class="line-added">1603                            .helptext(&quot;list open pull requests&quot;)</span>
<span class="line-added">1604                            .main(GitPr::list),</span>
<span class="line-added">1605                     Command.name(&quot;fetch&quot;)</span>
<span class="line-added">1606                            .helptext(&quot;fetch a pull request&quot;)</span>
<span class="line-added">1607                            .main(GitPr::fetch),</span>
<span class="line-added">1608                     Command.name(&quot;show&quot;)</span>
<span class="line-added">1609                            .helptext(&quot;show a pull request&quot;)</span>
<span class="line-added">1610                            .main(GitPr::show),</span>
<span class="line-added">1611                     Command.name(&quot;checkout&quot;)</span>
<span class="line-added">1612                            .helptext(&quot;checkout a pull request&quot;)</span>
<span class="line-added">1613                            .main(GitPr::checkout),</span>
<span class="line-added">1614                     Command.name(&quot;apply&quot;)</span>
<span class="line-added">1615                            .helptext(&quot;apply a pull request&quot;)</span>
<span class="line-added">1616                            .main(GitPr::apply),</span>
<span class="line-added">1617                     Command.name(&quot;integrate&quot;)</span>
<span class="line-added">1618                            .helptext(&quot;integrate a pull request&quot;)</span>
<span class="line-added">1619                            .main(GitPr::integrate),</span>
<span class="line-added">1620                     Command.name(&quot;approve&quot;)</span>
<span class="line-added">1621                            .helptext(&quot;approve a pull request&quot;)</span>
<span class="line-added">1622                            .main(GitPr::approve),</span>
<span class="line-added">1623                     Command.name(&quot;create&quot;)</span>
<span class="line-added">1624                            .helptext(&quot;create a pull request&quot;)</span>
<span class="line-added">1625                            .main(GitPr::create),</span>
<span class="line-added">1626                     Command.name(&quot;close&quot;)</span>
<span class="line-added">1627                            .helptext(&quot;close a pull request&quot;)</span>
<span class="line-added">1628                            .main(GitPr::close),</span>
<span class="line-added">1629                     Command.name(&quot;set&quot;)</span>
<span class="line-added">1630                            .helptext(&quot;set properties of a pull request&quot;)</span>
<span class="line-added">1631                            .main(GitPr::set),</span>
<span class="line-added">1632                     Command.name(&quot;test&quot;)</span>
<span class="line-added">1633                            .helptext(&quot;test a pull request&quot;)</span>
<span class="line-added">1634                            .main(GitPr::test),</span>
<span class="line-added">1635                     Command.name(&quot;status&quot;)</span>
<span class="line-added">1636                            .helptext(&quot;show status of a pull request&quot;)</span>
<span class="line-added">1637                            .main(GitPr::status)</span>
<span class="line-added">1638         );</span>
<span class="line-added">1639 </span>
<span class="line-added">1640         HttpProxy.setup();</span>
<span class="line-added">1641 </span>
<span class="line-added">1642         var parser = new MultiCommandParser(&quot;git pr&quot;, commands);</span>
<span class="line-added">1643         var command = parser.parse(args);</span>
<span class="line-added">1644         command.execute();</span>
<span class="line-added">1645     }</span>
1646 }
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>