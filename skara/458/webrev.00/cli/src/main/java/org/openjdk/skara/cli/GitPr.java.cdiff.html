<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff cli/src/main/java/org/openjdk/skara/cli/GitPr.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>cli/src/main/java/org/openjdk/skara/cli/GitPr.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 130,13 ***</span>
          var id = parts.length == 2 ? parts[1] : issue.id();
          return id + &quot;: &quot; + issue.title();
      }
  
  
<span class="line-modified">!     private static String pullRequestIdArgument(Arguments arguments, ReadOnlyRepository repo) throws IOException {</span>
<span class="line-modified">!         if (arguments.at(1).isPresent()) {</span>
<span class="line-modified">!             return arguments.at(1).asString();</span>
          }
  
          var currentBranch = repo.currentBranch();
          if (currentBranch.isPresent()) {
              var lines = repo.config(&quot;pr.&quot; + currentBranch.get().name() + &quot;.id&quot;);
<span class="line-new-header">--- 130,13 ---</span>
          var id = parts.length == 2 ? parts[1] : issue.id();
          return id + &quot;: &quot; + issue.title();
      }
  
  
<span class="line-modified">!     private static String pullRequestIdArgument(ReadOnlyRepository repo, Arguments arguments) throws IOException {</span>
<span class="line-modified">!         if (arguments.at(0).isPresent()) {</span>
<span class="line-modified">!             return arguments.at(0).asString();</span>
          }
  
          var currentBranch = repo.currentBranch();
          if (currentBranch.isPresent()) {
              var lines = repo.config(&quot;pr.&quot; + currentBranch.get().name() + &quot;.id&quot;);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 374,52 ***</span>
          // e.g. less when a user exits less when looking at a large diff. Therefore
          // must allow 141 as a valid exit code.
          await(pb.start(), 141);
      }
  
<span class="line-removed">-     private static void gimport() throws IOException {</span>
<span class="line-removed">-         var pb = new ProcessBuilder(&quot;hg&quot;, &quot;gimport&quot;);</span>
<span class="line-removed">-         pb.inheritIO();</span>
<span class="line-removed">-         await(pb.start());</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private static void hgImport(Path patch) throws IOException {</span>
<span class="line-removed">-         var pb = new ProcessBuilder(&quot;hg&quot;, &quot;import&quot;, &quot;--no-commit&quot;, patch.toAbsolutePath().toString());</span>
<span class="line-removed">-         pb.inheritIO();</span>
<span class="line-removed">-         await(pb.start());</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private static List&lt;String&gt; hgTags() throws IOException, InterruptedException {</span>
<span class="line-removed">-         var pb = new ProcessBuilder(&quot;hg&quot;, &quot;tags&quot;, &quot;--quiet&quot;);</span>
<span class="line-removed">-         pb.redirectOutput(ProcessBuilder.Redirect.PIPE);</span>
<span class="line-removed">-         pb.redirectError(ProcessBuilder.Redirect.INHERIT);</span>
<span class="line-removed">-         var p = pb.start();</span>
<span class="line-removed">-         var bytes = p.getInputStream().readAllBytes();</span>
<span class="line-removed">-         var exited = p.waitFor(1, TimeUnit.MINUTES);</span>
<span class="line-removed">-         var exitValue = p.exitValue();</span>
<span class="line-removed">-         if (!exited || exitValue != 0) {</span>
<span class="line-removed">-             throw new IOException(&quot;&#39;hg tags&#39; exited with value: &quot; + exitValue);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         return Arrays.asList(new String(bytes, StandardCharsets.UTF_8).split(&quot;\n&quot;));</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     private static String hgResolve(String ref) throws IOException, InterruptedException {</span>
<span class="line-removed">-         var pb = new ProcessBuilder(&quot;hg&quot;, &quot;log&quot;, &quot;-r&quot;, ref, &quot;--template&quot;, &quot;{node}&quot;);</span>
<span class="line-removed">-         pb.redirectOutput(ProcessBuilder.Redirect.PIPE);</span>
<span class="line-removed">-         pb.redirectError(ProcessBuilder.Redirect.INHERIT);</span>
<span class="line-removed">-         var p = pb.start();</span>
<span class="line-removed">-         var bytes = p.getInputStream().readAllBytes();</span>
<span class="line-removed">-         var exited = p.waitFor(1, TimeUnit.MINUTES);</span>
<span class="line-removed">-         var exitValue = p.exitValue();</span>
<span class="line-removed">-         if (!exited || exitValue != 0) {</span>
<span class="line-removed">-             throw new IOException(&quot;&#39;hg log&#39; exited with value: &quot; + exitValue);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         return new String(bytes, StandardCharsets.UTF_8);</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
      private static Path diff(String ref, Hash hash) throws IOException {
          return diff(ref, hash, null);
      }
  
      private static Path diff(String ref, Hash hash, Path dir) throws IOException {
<span class="line-new-header">--- 374,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 454,11 ***</span>
          return s.endsWith(trail) ?
              s.substring(0, s.length() - trail.length()) :
              s;
      }
  
<span class="line-modified">!     public static void main(String[] args) throws IOException, InterruptedException {</span>
          var flags = List.of(
              Option.shortcut(&quot;u&quot;)
                    .fullname(&quot;username&quot;)
                    .describe(&quot;NAME&quot;)
                    .helptext(&quot;Username on host&quot;)
<span class="line-new-header">--- 412,66 ---</span>
          return s.endsWith(trail) ?
              s.substring(0, s.length() - trail.length()) :
              s;
      }
  
<span class="line-modified">!     private static Repository getRepo() throws IOException {</span>
<span class="line-added">+         var cwd = Path.of(&quot;&quot;).toAbsolutePath();</span>
<span class="line-added">+         return Repository.get(cwd).orElseThrow(() -&gt; new IOException(&quot;no git repository found at &quot; + cwd.toString()));</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     private static Arguments parse(ArgumentParser parser, String[] args) {</span>
<span class="line-added">+         var arguments = parser.parse(args);</span>
<span class="line-added">+         if (arguments.contains(&quot;version&quot;)) {</span>
<span class="line-added">+             System.out.println(&quot;git-pr version: &quot; + Version.fromManifest().orElse(&quot;unknown&quot;));</span>
<span class="line-added">+             System.exit(0);</span>
<span class="line-added">+         }</span>
<span class="line-added">+         if (arguments.contains(&quot;verbose&quot;) || arguments.contains(&quot;debug&quot;)) {</span>
<span class="line-added">+             var level = arguments.contains(&quot;debug&quot;) ? Level.FINER : Level.FINE;</span>
<span class="line-added">+             Logging.setup(level);</span>
<span class="line-added">+         }</span>
<span class="line-added">+         return arguments;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     private static String getRemote(ReadOnlyRepository repo, Arguments arguments) throws IOException {</span>
<span class="line-added">+         var remote = getOption(&quot;remote&quot;, arguments);</span>
<span class="line-added">+         return remote == null ? &quot;origin&quot; : remote;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     private static URI getURI(ReadOnlyRepository repo, Arguments arguments) throws IOException {</span>
<span class="line-added">+         var remotePullPath = repo.pullPath(getRemote(repo, arguments));</span>
<span class="line-added">+         return Remote.toWebURI(remotePullPath);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     private static Forge getForge(URI uri, ReadOnlyRepository repo, Arguments arguments) throws IOException {</span>
<span class="line-added">+         var username = getOption(&quot;username&quot;, arguments);</span>
<span class="line-added">+         var token = System.getenv(&quot;GIT_TOKEN&quot;);</span>
<span class="line-added">+         var shouldUseToken = !getSwitch(&quot;no-token&quot;, arguments);</span>
<span class="line-added">+         var credentials = !shouldUseToken ?</span>
<span class="line-added">+             null :</span>
<span class="line-added">+             GitCredentials.fill(uri.getHost(), uri.getPath(), username, token, uri.getScheme());</span>
<span class="line-added">+         var forgeURI = URI.create(uri.getScheme() + &quot;://&quot; + uri.getHost());</span>
<span class="line-added">+         var forge = credentials == null ?</span>
<span class="line-added">+             Forge.from(forgeURI) :</span>
<span class="line-added">+             Forge.from(forgeURI, new Credential(credentials.username(), credentials.password()));</span>
<span class="line-added">+         if (forge.isEmpty()) {</span>
<span class="line-added">+             if (!shouldUseToken) {</span>
<span class="line-added">+                 if (arguments.contains(&quot;verbose&quot;)) {</span>
<span class="line-added">+                     System.err.println(&quot;&quot;);</span>
<span class="line-added">+                 }</span>
<span class="line-added">+                 System.err.println(&quot;warning: using git-pr with --no-token may result in rate limiting from &quot; + forgeURI);</span>
<span class="line-added">+                 if (!arguments.contains(&quot;verbose&quot;)) {</span>
<span class="line-added">+                     System.err.println(&quot;         Re-run git-pr with --verbose to see if you are being rate limited&quot;);</span>
<span class="line-added">+                     System.err.println(&quot;&quot;);</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             }</span>
<span class="line-added">+             exit(&quot;error: failed to connect to host: &quot; + forgeURI);</span>
<span class="line-added">+         }</span>
<span class="line-added">+         return forge.get();</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     private static void create(String[] args) throws IOException, InterruptedException {</span>
          var flags = List.of(
              Option.shortcut(&quot;u&quot;)
                    .fullname(&quot;username&quot;)
                    .describe(&quot;NAME&quot;)
                    .helptext(&quot;Username on host&quot;)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 471,43 ***</span>
              Option.shortcut(&quot;b&quot;)
                    .fullname(&quot;branch&quot;)
                    .describe(&quot;NAME&quot;)
                    .helptext(&quot;Name of target branch, defaults to &#39;master&#39;&quot;)
                    .optional(),
<span class="line-removed">-             Option.shortcut(&quot;&quot;)</span>
<span class="line-removed">-                   .fullname(&quot;authors&quot;)</span>
<span class="line-removed">-                   .describe(&quot;LIST&quot;)</span>
<span class="line-removed">-                   .helptext(&quot;Comma separated list of authors&quot;)</span>
<span class="line-removed">-                   .optional(),</span>
<span class="line-removed">-             Option.shortcut(&quot;&quot;)</span>
<span class="line-removed">-                   .fullname(&quot;assignees&quot;)</span>
<span class="line-removed">-                   .describe(&quot;LIST&quot;)</span>
<span class="line-removed">-                   .helptext(&quot;Comma separated list of assignees&quot;)</span>
<span class="line-removed">-                   .optional(),</span>
<span class="line-removed">-             Option.shortcut(&quot;&quot;)</span>
<span class="line-removed">-                   .fullname(&quot;labels&quot;)</span>
<span class="line-removed">-                   .describe(&quot;LIST&quot;)</span>
<span class="line-removed">-                   .helptext(&quot;Comma separated list of labels&quot;)</span>
<span class="line-removed">-                   .optional(),</span>
<span class="line-removed">-             Option.shortcut(&quot;&quot;)</span>
<span class="line-removed">-                   .fullname(&quot;issues&quot;)</span>
<span class="line-removed">-                   .describe(&quot;LIST&quot;)</span>
<span class="line-removed">-                   .helptext(&quot;Comma separated list of issues&quot;)</span>
<span class="line-removed">-                   .optional(),</span>
<span class="line-removed">-             Option.shortcut(&quot;&quot;)</span>
<span class="line-removed">-                   .fullname(&quot;columns&quot;)</span>
<span class="line-removed">-                   .describe(&quot;id,title,author,assignees,labels&quot;)</span>
<span class="line-removed">-                   .helptext(&quot;Comma separated list of columns to show&quot;)</span>
<span class="line-removed">-                   .optional(),</span>
<span class="line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="line-removed">-                   .fullname(&quot;no-decoration&quot;)</span>
<span class="line-removed">-                   .helptext(&quot;Hide any decorations when listing PRs&quot;)</span>
<span class="line-removed">-                   .optional(),</span>
<span class="line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="line-removed">-                   .fullname(&quot;no-draft&quot;)</span>
<span class="line-removed">-                   .helptext(&quot;Hide all pull requests in draft state&quot;)</span>
<span class="line-removed">-                   .optional(),</span>
              Switch.shortcut(&quot;&quot;)
                    .fullname(&quot;ignore-workspace&quot;)
                    .helptext(&quot;Ignore local changes in worktree and staging area when creating pull request&quot;)
                    .optional(),
              Switch.shortcut(&quot;&quot;)
<span class="line-new-header">--- 484,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 516,30 ***</span>
                    .optional(),
              Switch.shortcut(&quot;&quot;)
                    .fullname(&quot;publish&quot;)
                    .helptext(&quot;Publish the local branch before creating the pull request&quot;)
                    .optional(),
<span class="line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="line-removed">-                   .fullname(&quot;atomic&quot;)</span>
<span class="line-removed">-                   .helptext(&quot;Integrate the pull request atomically&quot;)</span>
<span class="line-removed">-                   .optional(),</span>
              Switch.shortcut(&quot;&quot;)
                    .fullname(&quot;jcheck&quot;)
                    .helptext(&quot;Run jcheck before creating the pull request&quot;)
                    .optional(),
<span class="line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="line-removed">-                   .fullname(&quot;no-token&quot;)</span>
<span class="line-removed">-                   .helptext(&quot;Do not use a personal access token (PAT). Only works for read-only operations.&quot;)</span>
<span class="line-removed">-                   .optional(),</span>
<span class="line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="line-removed">-                   .fullname(&quot;no-checks&quot;)</span>
<span class="line-removed">-                   .helptext(&quot;Do not show check status as part of the &#39;git pr status&#39; output&quot;)</span>
<span class="line-removed">-                   .optional(),</span>
<span class="line-removed">-             Switch.shortcut(&quot;&quot;)</span>
<span class="line-removed">-                   .fullname(&quot;mercurial&quot;)</span>
<span class="line-removed">-                   .helptext(&quot;Force use of Mercurial (hg)&quot;)</span>
<span class="line-removed">-                   .optional(),</span>
              Switch.shortcut(&quot;&quot;)
                    .fullname(&quot;verbose&quot;)
                    .helptext(&quot;Turn on verbose output&quot;)
                    .optional(),
              Switch.shortcut(&quot;&quot;)
<span class="line-new-header">--- 496,14 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 547,885 ***</span>
                    .helptext(&quot;Turn on debugging output&quot;)
                    .optional(),
              Switch.shortcut(&quot;&quot;)
                    .fullname(&quot;version&quot;)
                    .helptext(&quot;Print the version of this tool&quot;)
<span class="line-modified">!                   .optional());</span>
  
<span class="line-removed">-         var actions = List.of(&quot;list&quot;, &quot;fetch&quot;, &quot;show&quot;, &quot;checkout&quot;, &quot;apply&quot;, &quot;integrate&quot;,</span>
<span class="line-removed">-                               &quot;approve&quot;, &quot;create&quot;, &quot;close&quot;, &quot;set&quot;, &quot;test&quot;, &quot;status&quot;);</span>
          var inputs = List.of(
              Input.position(0)
<span class="line-removed">-                  .describe(String.join(&quot;|&quot;, actions))</span>
<span class="line-removed">-                  .singular()</span>
<span class="line-removed">-                  .optional(),</span>
<span class="line-removed">-             Input.position(1)</span>
                   .describe(&quot;ID&quot;)
                   .singular()
                   .optional()
          );
  
          var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);
<span class="line-modified">!         var arguments = parser.parse(args);</span>
<span class="line-modified">! </span>
<span class="line-modified">!         if (arguments.contains(&quot;version&quot;)) {</span>
<span class="line-modified">!             System.out.println(&quot;git-pr version: &quot; + Version.fromManifest().orElse(&quot;unknown&quot;));</span>
<span class="line-modified">!             System.exit(0);</span>
<span class="line-modified">!         }</span>
<span class="line-modified">! </span>
<span class="line-modified">!         if (arguments.contains(&quot;verbose&quot;) || arguments.contains(&quot;debug&quot;)) {</span>
<span class="line-modified">!             var level = arguments.contains(&quot;debug&quot;) ? Level.FINER : Level.FINE;</span>
<span class="line-modified">!             Logging.setup(level);</span>
          }
  
<span class="line-modified">!         HttpProxy.setup();</span>
<span class="line-modified">! </span>
<span class="line-modified">!         var isMercurial = getSwitch(&quot;mercurial&quot;, arguments);</span>
<span class="line-modified">!         var cwd = Path.of(&quot;&quot;).toAbsolutePath();</span>
<span class="line-modified">!         var repo = Repository.get(cwd).orElseThrow(() -&gt; new IOException(&quot;no git repository found at &quot; + cwd.toString()));</span>
<span class="line-modified">!         var remote = getOption(&quot;remote&quot;, arguments);</span>
<span class="line-modified">!         if (remote == null) {</span>
<span class="line-modified">!             remote = isMercurial ? &quot;default&quot; : &quot;origin&quot;;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         var remotePullPath = repo.pullPath(remote);</span>
<span class="line-removed">-         var username = getOption(&quot;username&quot;, arguments);</span>
<span class="line-removed">-         var token = isMercurial ? System.getenv(&quot;HG_TOKEN&quot;) : System.getenv(&quot;GIT_TOKEN&quot;);</span>
<span class="line-removed">-         var uri = Remote.toWebURI(remotePullPath);</span>
<span class="line-removed">-         var shouldUseToken = !getSwitch(&quot;no-token&quot;, arguments);</span>
<span class="line-removed">-         var credentials = !shouldUseToken ?</span>
<span class="line-removed">-             null :</span>
<span class="line-removed">-             GitCredentials.fill(uri.getHost(), uri.getPath(), username, token, uri.getScheme());</span>
<span class="line-removed">-         var forgeURI = URI.create(uri.getScheme() + &quot;://&quot; + uri.getHost());</span>
<span class="line-removed">-         var forge = credentials == null ?</span>
<span class="line-removed">-             Forge.from(forgeURI) :</span>
<span class="line-removed">-             Forge.from(forgeURI, new Credential(credentials.username(), credentials.password()));</span>
<span class="line-removed">-         if (forge.isEmpty()) {</span>
<span class="line-removed">-             if (!shouldUseToken) {</span>
<span class="line-removed">-                 if (arguments.contains(&quot;verbose&quot;)) {</span>
<span class="line-removed">-                     System.err.println(&quot;&quot;);</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-                 System.err.println(&quot;warning: using git-pr with --no-token may result in rate limiting from &quot; + forgeURI);</span>
<span class="line-removed">-                 if (!arguments.contains(&quot;verbose&quot;)) {</span>
<span class="line-removed">-                     System.err.println(&quot;         Re-run git-pr with --verbose to see if you are being rate limited&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;&quot;);</span>
                  }
<span class="line-modified">!             }</span>
<span class="line-modified">!             exit(&quot;error: failed to connect to host: &quot; + forgeURI);</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         var host = forge.get();</span>
<span class="line-modified">! </span>
<span class="line-modified">!         var action = arguments.at(0).isPresent() ? arguments.at(0).asString() : null;</span>
<span class="line-modified">!         if (action == null) {</span>
<span class="line-modified">!             var lines = repo.config(&quot;pr.default&quot;);</span>
<span class="line-modified">!             if (lines.size() == 1) {</span>
<span class="line-modified">!                 action = lines.get(0);</span>
              }
          }
  
<span class="line-modified">!         if (action == null) {</span>
<span class="line-modified">!             System.err.println(&quot;error: you must supply a valid action:&quot;);</span>
<span class="line-modified">!             for (var a : actions) {</span>
<span class="line-modified">!                 System.err.println(&quot;       - &quot; + a);</span>
              }
<span class="line-removed">-             System.err.println(&quot;You can also configure a default action by running &#39;git configure --global pr.default &lt;action&gt;&#39;&quot;);</span>
<span class="line-removed">-             System.exit(1);</span>
          }
  
<span class="line-modified">!         if (!shouldUseToken &amp;&amp;</span>
<span class="line-modified">!             !List.of(&quot;list&quot;, &quot;fetch&quot;, &quot;show&quot;, &quot;checkout&quot;, &quot;apply&quot;).contains(action)) {</span>
<span class="line-removed">-             System.err.println(&quot;error: --no-token can only be used with read-only operations&quot;);</span>
<span class="line-removed">-             System.exit(1);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">- </span>
<span class="line-removed">-         if (action.equals(&quot;create&quot;)) {</span>
<span class="line-removed">-             if (isMercurial) {</span>
<span class="line-removed">-                 var currentBookmark = repo.currentBookmark();</span>
<span class="line-removed">-                 if (!currentBookmark.isPresent()) {</span>
<span class="line-removed">-                     System.err.println(&quot;error: no bookmark is active, you must be on an active bookmark&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;To create a bookmark and activate it, run:&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;    hg bookmark NAME-FOR-YOUR-BOOKMARK&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;&quot;);</span>
<span class="line-removed">-                     System.exit(1);</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">- </span>
<span class="line-removed">-                 var bookmark = currentBookmark.get();</span>
<span class="line-removed">-                 if (bookmark.equals(new Bookmark(&quot;master&quot;))) {</span>
<span class="line-removed">-                     System.err.println(&quot;error: you should not create pull requests from the &#39;master&#39; bookmark&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;To create a bookmark and activate it, run:&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;    hg bookmark NAME-FOR-YOUR-BOOKMARK&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;&quot;);</span>
<span class="line-removed">-                     System.exit(1);</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">- </span>
<span class="line-removed">-                 var tags = hgTags();</span>
<span class="line-removed">-                 var upstreams = tags.stream()</span>
<span class="line-removed">-                                     .filter(t -&gt; t.endsWith(bookmark.name()))</span>
<span class="line-removed">-                                     .collect(Collectors.toList());</span>
<span class="line-removed">-                 if (upstreams.isEmpty()) {</span>
<span class="line-removed">-                     System.err.println(&quot;error: there is no remote branch for the local bookmark &#39;&quot; + bookmark.name() + &quot;&#39;&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;To create a remote branch and push the commits for your local branch, run:&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;    hg push --bookmark &quot; + bookmark.name());</span>
<span class="line-removed">-                     System.err.println(&quot;&quot;);</span>
<span class="line-removed">-                     System.exit(1);</span>
<span class="line-removed">-                 }</span>
  
<span class="line-modified">!                 var tagsAndHashes = new HashMap&lt;String, String&gt;();</span>
<span class="line-modified">!                 for (var tag : tags) {</span>
<span class="line-modified">!                     tagsAndHashes.put(tag, hgResolve(tag));</span>
<span class="line-modified">!                 }</span>
<span class="line-modified">!                 var bookmarkHash = hgResolve(bookmark.name());</span>
<span class="line-modified">!                 if (!tagsAndHashes.containsValue(bookmarkHash)) {</span>
<span class="line-modified">!                     System.err.println(&quot;error: there are local commits on bookmark &#39;&quot; + bookmark.name() + &quot;&#39; not present in a remote repository&quot;);</span>
<span class="line-modified">!                     System.err.println(&quot;&quot;);</span>
<span class="line-modified">! </span>
<span class="line-modified">!                     if (upstreams.size() == 1) {</span>
<span class="line-modified">!                         System.err.println(&quot;To push the local commits to the remote repository, run:&quot;);</span>
<span class="line-removed">-                         System.err.println(&quot;&quot;);</span>
<span class="line-removed">-                         System.err.println(&quot;    hg push --bookmark &quot; + bookmark.name() + &quot; &quot; + upstreams.get(0));</span>
<span class="line-removed">-                         System.err.println(&quot;&quot;);</span>
<span class="line-removed">-                     } else {</span>
<span class="line-removed">-                         System.err.println(&quot;The following paths contains the &quot; + bookmark.name() + &quot; bookmark:&quot;);</span>
<span class="line-removed">-                         System.err.println(&quot;&quot;);</span>
<span class="line-removed">-                         for (var upstream : upstreams) {</span>
<span class="line-removed">-                             System.err.println(&quot;- &quot; + upstream.replace(&quot;/&quot; + bookmark.name(), &quot;&quot;));</span>
<span class="line-removed">-                         }</span>
<span class="line-removed">-                         System.err.println(&quot;&quot;);</span>
<span class="line-removed">-                         System.err.println(&quot;To push the local commits to a remote repository, run:&quot;);</span>
<span class="line-removed">-                         System.err.println(&quot;&quot;);</span>
<span class="line-removed">-                         System.err.println(&quot;    hg push --bookmark &quot; + bookmark.name() + &quot; &lt;PATH&gt;&quot;);</span>
<span class="line-removed">-                         System.err.println(&quot;&quot;);</span>
<span class="line-removed">-                     }</span>
<span class="line-removed">-                     System.exit(1);</span>
                  }
  
<span class="line-modified">!                 var targetBranch = arguments.get(&quot;branch&quot;).orString(&quot;master&quot;);</span>
<span class="line-modified">!                 var targetHash = hgResolve(targetBranch);</span>
<span class="line-modified">!                 var commits = repo.commits(targetHash + &quot;..&quot; + bookmarkHash + &quot;-&quot; + targetHash).asList();</span>
<span class="line-modified">!                 if (commits.isEmpty()) {</span>
<span class="line-modified">!                     System.err.println(&quot;error: no difference between bookmarks &quot; + targetBranch + &quot; and &quot; + bookmark.name());</span>
<span class="line-modified">!                     System.err.println(&quot;       Cannot create an empty pull request, have you committed?&quot;);</span>
<span class="line-removed">-                     System.exit(1);</span>
<span class="line-removed">-                 }</span>
  
<span class="line-modified">!                 var diff = repo.diff(repo.head());</span>
<span class="line-modified">!                 if (!diff.patches().isEmpty()) {</span>
<span class="line-modified">!                     System.err.println(&quot;error: there are uncommitted changes in your working tree:&quot;);</span>
<span class="line-modified">!                     System.err.println(&quot;&quot;);</span>
<span class="line-modified">!                     for (var patch : diff.patches()) {</span>
<span class="line-modified">!                         var path = patch.target().path().isPresent() ?</span>
<span class="line-modified">!                             patch.target().path().get() : patch.source().path().get();</span>
<span class="line-modified">!                         System.err.println(&quot;    &quot; + patch.status().toString() + &quot; &quot; + path.toString());</span>
<span class="line-modified">!                     }</span>
<span class="line-modified">!                     System.err.println(&quot;&quot;);</span>
<span class="line-modified">!                     System.err.println(&quot;If these changes are meant to be part of the pull request, run:&quot;);</span>
<span class="line-modified">!                     System.err.println(&quot;&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;    hg commit --amend&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;    hg git-cleanup&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;    hg push --bookmark &quot; + bookmark.name() + &quot; &lt;PATH&gt;&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;    hg gimport&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;If these changes are *not* meant to be part of the pull request, run:&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;    hg shelve&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;(You can later restore the changes by running: hg unshelve)&quot;);</span>
<span class="line-removed">-                     System.exit(1);</span>
                  }
  
<span class="line-modified">!                 var remoteRepo = host.repository(projectName(uri)).orElseThrow(() -&gt;</span>
<span class="line-modified">!                         new IOException(&quot;Could not find repository at &quot; + uri.toString())</span>
<span class="line-modified">!                 );</span>
<span class="line-modified">!                 if (token == null) {</span>
<span class="line-modified">!                     GitCredentials.approve(credentials);</span>
<span class="line-modified">!                 }</span>
<span class="line-modified">!                 var parentRepo = remoteRepo.parent().orElseThrow(() -&gt;</span>
<span class="line-modified">!                         new IOException(&quot;error: remote repository &quot; + remotePullPath + &quot; is not a fork of any repository&quot;));</span>
<span class="line-modified">! </span>
<span class="line-modified">!                 var file = Files.createTempFile(&quot;PULL_REQUEST_&quot;, &quot;.txt&quot;);</span>
<span class="line-removed">-                 if (commits.size() == 1) {</span>
<span class="line-removed">-                     var commit = commits.get(0);</span>
<span class="line-removed">-                     var message = CommitMessageParsers.v1.parse(commit.message());</span>
<span class="line-removed">-                     Files.writeString(file, message.title() + &quot;\n&quot;);</span>
<span class="line-removed">-                     if (!message.summaries().isEmpty()) {</span>
<span class="line-removed">-                         Files.write(file, message.summaries(), StandardOpenOption.APPEND);</span>
<span class="line-removed">-                     }</span>
<span class="line-removed">-                     if (!message.additional().isEmpty()) {</span>
<span class="line-removed">-                         Files.write(file, message.additional(), StandardOpenOption.APPEND);</span>
                      }
<span class="line-removed">-                 } else {</span>
<span class="line-removed">-                     Files.write(file, List.of(&quot;&quot;));</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-                 Files.write(file, List.of(</span>
<span class="line-removed">-                     &quot;# Please enter the pull request message for your changes. Lines starting&quot;,</span>
<span class="line-removed">-                     &quot;# with &#39;#&#39; will be ignored, and an empty message aborts the pull request.&quot;,</span>
<span class="line-removed">-                     &quot;# The first line will be considered the subject, use a blank line to separate&quot;,</span>
<span class="line-removed">-                     &quot;# the subject from the body.&quot;,</span>
<span class="line-removed">-                     &quot;#&quot;,</span>
<span class="line-removed">-                     &quot;# Commits to be included from branch &#39;&quot; + bookmark.name() + &quot;&#39;&quot;</span>
<span class="line-removed">-                     ),</span>
<span class="line-removed">-                     StandardOpenOption.APPEND</span>
<span class="line-removed">-                 );</span>
<span class="line-removed">-                 for (var commit : commits) {</span>
<span class="line-removed">-                     var desc = commit.hash().abbreviate() + &quot;: &quot; + commit.message().get(0);</span>
<span class="line-removed">-                     Files.writeString(file, &quot;# - &quot; + desc + &quot;\n&quot;, StandardOpenOption.APPEND);</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-                 Files.writeString(file, &quot;#\n&quot;, StandardOpenOption.APPEND);</span>
<span class="line-removed">-                 Files.writeString(file, &quot;# Target repository: &quot; + remotePullPath + &quot;\n&quot;, StandardOpenOption.APPEND);</span>
<span class="line-removed">-                 Files.writeString(file, &quot;# Target branch: &quot; + targetBranch + &quot;\n&quot;, StandardOpenOption.APPEND);</span>
<span class="line-removed">-                 var success = spawnEditor(repo, file);</span>
<span class="line-removed">-                 if (!success) {</span>
<span class="line-removed">-                     System.err.println(&quot;error: editor exited with non-zero status code, aborting&quot;);</span>
<span class="line-removed">-                     System.exit(1);</span>
                  }
<span class="line-modified">!                 var lines = Files.readAllLines(file)</span>
<span class="line-modified">!                                  .stream()</span>
<span class="line-modified">!                                  .filter(l -&gt; !l.startsWith(&quot;#&quot;))</span>
<span class="line-modified">!                                  .collect(Collectors.toList());</span>
<span class="line-removed">-                 var isEmpty = lines.stream().allMatch(String::isEmpty);</span>
<span class="line-removed">-                 if (isEmpty) {</span>
<span class="line-removed">-                     System.err.println(&quot;error: no message present, aborting&quot;);</span>
<span class="line-removed">-                     System.exit(1);</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">- </span>
<span class="line-removed">-                 var title = lines.get(0);</span>
<span class="line-removed">-                 List&lt;String&gt; body = null;</span>
<span class="line-removed">-                 if (lines.size() &gt; 1) {</span>
<span class="line-removed">-                     body = lines.subList(1, lines.size())</span>
<span class="line-removed">-                                 .stream()</span>
<span class="line-removed">-                                 .dropWhile(String::isEmpty)</span>
<span class="line-removed">-                                 .collect(Collectors.toList());</span>
<span class="line-removed">-                 } else {</span>
<span class="line-removed">-                     body = Collections.emptyList();</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">- </span>
<span class="line-removed">-                 var pr = remoteRepo.createPullRequest(parentRepo, targetBranch, bookmark.name(), title, body);</span>
<span class="line-removed">-                 if (arguments.contains(&quot;assignees&quot;)) {</span>
<span class="line-removed">-                     var usernames = Arrays.asList(arguments.get(&quot;assignees&quot;).asString().split(&quot;,&quot;));</span>
<span class="line-removed">-                     var assignees = usernames.stream()</span>
<span class="line-removed">-                                              .map(u -&gt; host.user(u))</span>
<span class="line-removed">-                                              .filter(Optional::isPresent)</span>
<span class="line-removed">-                                              .map(Optional::get)</span>
<span class="line-removed">-                                              .collect(Collectors.toList());</span>
<span class="line-removed">-                     pr.setAssignees(assignees);</span>
                  }
<span class="line-removed">-                 System.out.println(pr.webUrl().toString());</span>
<span class="line-removed">-                 Files.deleteIfExists(file);</span>
<span class="line-removed">- </span>
<span class="line-removed">-                 System.exit(0);</span>
              }
<span class="line-modified">!             var currentBranch = repo.currentBranch().orElseGet(() -&gt; {</span>
<span class="line-modified">!                     System.err.println(&quot;error: the repository is in a detached HEAD state&quot;);</span>
<span class="line-modified">!                     System.exit(1);</span>
<span class="line-modified">!                     return null;</span>
<span class="line-modified">!             });</span>
<span class="line-modified">!             if (currentBranch.equals(repo.defaultBranch())) {</span>
<span class="line-removed">-                 System.err.println(&quot;error: you should not create pull requests from the &#39;master&#39; branch&quot;);</span>
<span class="line-removed">-                 System.err.println(&quot;&quot;);</span>
<span class="line-removed">-                 System.err.println(&quot;To create a local branch for your changes and restore the &#39;master&#39; branch, run:&quot;);</span>
<span class="line-removed">-                 System.err.println(&quot;&quot;);</span>
<span class="line-removed">-                 System.err.println(&quot;    git checkout -b NAME-FOR-YOUR-LOCAL-BRANCH&quot;);</span>
<span class="line-removed">-                 System.err.println(&quot;    git branch --force master origin/master&quot;);</span>
<span class="line-removed">-                 System.err.println(&quot;&quot;);</span>
                  System.exit(1);
              }
  
<span class="line-modified">!             var ignoreWorkspace = getSwitch(&quot;ignore-workspace&quot;, &quot;create&quot;, arguments);</span>
<span class="line-modified">!             if (!ignoreWorkspace) {</span>
<span class="line-modified">!                 var diff = repo.diff(repo.head());</span>
<span class="line-modified">!                 if (!diff.patches().isEmpty()) {</span>
<span class="line-modified">!                     System.err.println(&quot;error: there are uncommitted changes in your working tree:&quot;);</span>
<span class="line-modified">!                     System.err.println(&quot;&quot;);</span>
<span class="line-removed">-                     for (var patch : diff.patches()) {</span>
<span class="line-removed">-                         var path = patch.target().path().isPresent() ?</span>
<span class="line-removed">-                             patch.target().path().get() : patch.source().path().get();</span>
<span class="line-removed">-                         System.err.println(&quot;    &quot; + patch.status().toString() + &quot; &quot; + path.toString());</span>
<span class="line-removed">-                     }</span>
<span class="line-removed">-                     System.err.println(&quot;&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;If these changes are meant to be part of the pull request, run:&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;    git commit -am &#39;Forgot to add some changes&#39;&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;If these changes are *not* meant to be part of the pull request, run:&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;    git stash&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;(You can later restore the changes by running: git stash pop)&quot;);</span>
<span class="line-removed">-                     System.exit(1);</span>
<span class="line-removed">-                 }</span>
              }
  
<span class="line-modified">!             var upstream = repo.upstreamFor(currentBranch);</span>
<span class="line-modified">!             if (upstream.isEmpty()) {</span>
<span class="line-modified">!                 var shouldPublish = getSwitch(&quot;publish&quot;, &quot;create&quot;, arguments);</span>
<span class="line-modified">!                 if (shouldPublish) {</span>
<span class="line-modified">!                     GitPublish.main(new String[] { &quot;--quiet&quot;, remote });</span>
<span class="line-modified">!                     upstream = repo.upstreamFor(currentBranch);</span>
<span class="line-modified">!                 } else {</span>
<span class="line-modified">!                     System.err.println(&quot;error: there is no remote branch for the local branch &#39;&quot; + currentBranch.name() + &quot;&#39;&quot;);</span>
<span class="line-modified">!                     System.err.println(&quot;&quot;);</span>
<span class="line-modified">!                     System.err.println(&quot;A remote branch must be present at &quot; + remotePullPath + &quot; to create a pull request&quot;);</span>
<span class="line-modified">!                     System.err.println(&quot;To create a remote branch and push the commits for your local branch, run:&quot;);</span>
<span class="line-modified">!                     System.err.println(&quot;&quot;);</span>
<span class="line-modified">!                     System.err.println(&quot;    git publish&quot;);</span>
<span class="line-modified">!                     System.err.println(&quot;&quot;);</span>
<span class="line-modified">!                     System.err.println(&quot;If you created the remote branch from another client, you must update this repository.&quot;);</span>
<span class="line-modified">!                     System.err.println(&quot;To update remote information for this repository, run:&quot;);</span>
<span class="line-modified">!                     System.err.println(&quot;&quot;);</span>
<span class="line-modified">!                     System.err.println(&quot;    git fetch &quot; + remote);</span>
<span class="line-removed">-                     System.err.println(&quot;    git branch --set-upstream &quot; + currentBranch + &quot; &quot; + remote + &quot;/&quot; + currentBranch);</span>
<span class="line-removed">-                     System.err.println(&quot;&quot;);</span>
<span class="line-removed">-                     System.exit(1);</span>
                  }
              }
  
<span class="line-modified">!             var upstreamRefName = upstream.get().substring(remote.length() + 1);</span>
<span class="line-modified">!             repo.fetch(uri, upstreamRefName);</span>
<span class="line-modified">! </span>
<span class="line-modified">!             var shouldIgnoreLocalCommits = getSwitch(&quot;ignore-local-commits&quot;, &quot;create&quot;, arguments);</span>
<span class="line-modified">!             if (!shouldIgnoreLocalCommits) {</span>
<span class="line-modified">!                 var branchCommits = repo.commits(upstream.get() + &quot;..&quot; + currentBranch.name()).asList();</span>
<span class="line-modified">!                 if (!branchCommits.isEmpty()) {</span>
<span class="line-modified">!                     System.err.println(&quot;error: there are local commits on branch &#39;&quot; + currentBranch.name() + &quot;&#39; not present in the remote repository &quot; + remotePullPath);</span>
<span class="line-modified">!                     System.err.println(&quot;&quot;);</span>
<span class="line-modified">!                     System.err.println(&quot;All commits must be present in the remote repository to be part of the pull request&quot;);</span>
<span class="line-modified">!                     System.err.println(&quot;The following commits are not present in the remote repository:&quot;);</span>
<span class="line-modified">!                     System.err.println(&quot;&quot;);</span>
<span class="line-modified">!                     for (var commit : branchCommits) {</span>
<span class="line-modified">!                         System.err.println(&quot;- &quot; + commit.hash().abbreviate() + &quot;: &quot; + commit.message().get(0));</span>
                      }
<span class="line-removed">-                     System.err.println(&quot;&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;To push the above local commits to the remote repository, run:&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;    git push &quot; + remote + &quot; &quot; + currentBranch.name());</span>
<span class="line-removed">-                     System.err.println(&quot;&quot;);</span>
<span class="line-removed">-                     System.exit(1);</span>
                  }
              }
  
<span class="line-modified">!             var remoteRepo = host.repository(projectName(uri)).orElseThrow(() -&gt;</span>
<span class="line-modified">!                     new IOException(&quot;Could not find repository at &quot; + uri.toString())</span>
<span class="line-modified">!             );</span>
<span class="line-modified">!             if (token == null) {</span>
<span class="line-modified">!                 GitCredentials.approve(credentials);</span>
<span class="line-modified">!             }</span>
<span class="line-modified">!             var parentRepo = remoteRepo.parent().orElseThrow(() -&gt;</span>
<span class="line-modified">!                     new IOException(&quot;error: remote repository &quot; + remotePullPath + &quot; is not a fork of any repository&quot;)</span>
<span class="line-modified">!             );</span>
<span class="line-modified">! </span>
<span class="line-modified">!             var targetBranch = getOption(&quot;branch&quot;, &quot;create&quot;, arguments);</span>
<span class="line-modified">!             if (targetBranch == null) {</span>
<span class="line-modified">!                 var upstreamBranchNames = repo.remoteBranches(parentRepo.webUrl().toString())</span>
<span class="line-modified">!                                               .stream()</span>
<span class="line-removed">-                                               .map(r -&gt; r.name())</span>
<span class="line-removed">-                                               .collect(Collectors.toSet());</span>
<span class="line-removed">-                 var remoteBranches = repo.branches(remote);</span>
<span class="line-removed">-                 var candidates = new ArrayList&lt;Branch&gt;();</span>
<span class="line-removed">-                 for (var b : remoteBranches) {</span>
<span class="line-removed">-                     var withoutRemotePrefix = b.name().substring(remote.length() + 1);</span>
<span class="line-removed">-                     if (upstreamBranchNames.contains(withoutRemotePrefix)) {</span>
<span class="line-removed">-                         candidates.add(b);</span>
<span class="line-removed">-                     }</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">- </span>
<span class="line-removed">-                 var localBranches = repo.branches();</span>
<span class="line-removed">-                 Branch closest = null;</span>
<span class="line-removed">-                 var shortestDistance = Integer.MAX_VALUE;</span>
<span class="line-removed">-                 for (var b : candidates) {</span>
<span class="line-removed">-                     var from = b.name();</span>
<span class="line-removed">-                     for (var localBranch : localBranches) {</span>
<span class="line-removed">-                         var trackingBranch = repo.upstreamFor(localBranch);</span>
<span class="line-removed">-                         if (trackingBranch.isPresent() &amp;&amp;</span>
<span class="line-removed">-                             trackingBranch.get().equals(b.name())) {</span>
<span class="line-removed">-                             from = localBranch.name();</span>
<span class="line-removed">-                         }</span>
<span class="line-removed">-                     }</span>
<span class="line-removed">-                     var distance = repo.commitMetadata(from + &quot;...&quot; + currentBranch.name()).size();</span>
<span class="line-removed">-                     if (distance &lt; shortestDistance) {</span>
<span class="line-removed">-                         closest = b;</span>
<span class="line-removed">-                         shortestDistance = distance;</span>
<span class="line-removed">-                     }</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">- </span>
<span class="line-removed">-                 if (closest != null) {</span>
<span class="line-removed">-                     targetBranch = closest.name().substring(remote.length() + 1);</span>
<span class="line-removed">-                 } else {</span>
<span class="line-removed">-                     System.err.println(&quot;error: cannot automatically infer target branch&quot;);</span>
<span class="line-removed">-                     System.err.println(&quot;       use --branch to specify target branch&quot;);</span>
<span class="line-removed">-                     System.exit(1);</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-             var commits = repo.commits(targetBranch + &quot;..&quot; + upstream.get()).asList();</span>
<span class="line-removed">-             if (commits.isEmpty()) {</span>
<span class="line-removed">-                 System.err.println(&quot;error: no difference between branches &quot; + targetBranch + &quot; and &quot; + currentBranch.name());</span>
<span class="line-removed">-                 System.err.println(&quot;       Cannot create an empty pull request, have you committed?&quot;);</span>
<span class="line-removed">-                 System.exit(1);</span>
<span class="line-removed">-             }</span>
  
<span class="line-modified">!             var shouldRunJCheck = getSwitch(&quot;jcheck&quot;, &quot;create&quot;, arguments);</span>
<span class="line-modified">!             if (shouldRunJCheck) {</span>
<span class="line-modified">!                 var jcheckArgs = new String[]{ &quot;--pull-request&quot;, &quot;--rev&quot;, targetBranch + &quot;..&quot; + upstream.get() };</span>
<span class="line-modified">!                 var err = GitJCheck.run(jcheckArgs);</span>
<span class="line-modified">!                 if (err != 0) {</span>
<span class="line-modified">!                     System.exit(err);</span>
<span class="line-modified">!                 }</span>
<span class="line-modified">!             }</span>
  
<span class="line-modified">!             var project = jbsProjectFromJcheckConf(repo, targetBranch);</span>
<span class="line-modified">!             var issue = getIssue(currentBranch, project);</span>
<span class="line-modified">!             var file = Files.createTempFile(&quot;PULL_REQUEST_&quot;, &quot;.md&quot;);</span>
<span class="line-modified">!             if (issue.isPresent()) {</span>
<span class="line-modified">!                 Files.writeString(file, format(issue.get()) + &quot;\n\n&quot;);</span>
<span class="line-modified">!             } else if (commits.size() == 1) {</span>
<span class="line-modified">!                 var commit = commits.get(0);</span>
<span class="line-modified">!                 issue = getIssue(commit, project);</span>
<span class="line-modified">!                 if (issue.isPresent()) {</span>
<span class="line-modified">!                     Files.writeString(file, format(issue.get()) + &quot;\n\n&quot;);</span>
<span class="line-modified">!                 } else {</span>
<span class="line-modified">!                     var message = CommitMessageParsers.v1.parse(commit.message());</span>
<span class="line-modified">!                     Files.writeString(file, message.title() + &quot;\n&quot;);</span>
<span class="line-removed">-                     if (!message.summaries().isEmpty()) {</span>
<span class="line-removed">-                         Files.write(file, message.summaries(), StandardOpenOption.APPEND);</span>
<span class="line-removed">-                     }</span>
<span class="line-removed">-                     if (!message.additional().isEmpty()) {</span>
<span class="line-removed">-                         Files.write(file, message.additional(), StandardOpenOption.APPEND);</span>
<span class="line-removed">-                     }</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-             } else {</span>
<span class="line-removed">-                 Files.write(file, List.of(&quot;&quot;));</span>
<span class="line-removed">-             }</span>
  
<span class="line-modified">!             appendPaddedHTMLComment(file, &quot;Please enter the pull request message for your changes.&quot;);</span>
<span class="line-modified">!             appendPaddedHTMLComment(file, &quot;The first line will be considered the subject, use a blank line to&quot;);</span>
<span class="line-removed">-             appendPaddedHTMLComment(file, &quot;separate the subject from the body. These HTML comment lines will&quot;);</span>
<span class="line-removed">-             appendPaddedHTMLComment(file, &quot;be removed automatically. An empty message aborts the pull request.&quot;);</span>
<span class="line-removed">-             appendPaddedHTMLComment(file, &quot;&quot;);</span>
<span class="line-removed">-             appendPaddedHTMLComment(file, &quot;Commits to be included from branch &#39;&quot; + currentBranch.name() + &quot;&#39;:&quot;);</span>
<span class="line-removed">-             for (var commit : commits) {</span>
<span class="line-removed">-                 var desc = commit.hash().abbreviate() + &quot;: &quot; + commit.message().get(0);</span>
<span class="line-removed">-                 appendPaddedHTMLComment(file, &quot;- &quot; + desc);</span>
<span class="line-removed">-                 if (!commit.isMerge()) {</span>
<span class="line-removed">-                     var diff = commit.parentDiffs().get(0);</span>
<span class="line-removed">-                     for (var patch : diff.patches()) {</span>
<span class="line-removed">-                         var status = patch.status();</span>
<span class="line-removed">-                         if (status.isModified()) {</span>
<span class="line-removed">-                             appendPaddedHTMLComment(file, &quot;  M  &quot; + patch.target().path().get().toString());</span>
<span class="line-removed">-                         } else if (status.isAdded()) {</span>
<span class="line-removed">-                             appendPaddedHTMLComment(file, &quot;  A  &quot; + patch.target().path().get().toString());</span>
<span class="line-removed">-                         } else if (status.isDeleted()) {</span>
<span class="line-removed">-                             appendPaddedHTMLComment(file, &quot;  D  &quot; + patch.source().path().get().toString());</span>
<span class="line-removed">-                         } else if (status.isRenamed()) {</span>
<span class="line-removed">-                             appendPaddedHTMLComment(file, &quot;  R  &quot; + patch.target().path().get().toString());</span>
<span class="line-removed">-                             appendPaddedHTMLComment(file, &quot;      (&quot; + patch.source().path().get().toString() + &quot;)&quot;);</span>
<span class="line-removed">-                         } else if (status.isCopied()) {</span>
<span class="line-removed">-                             appendPaddedHTMLComment(file, &quot;  C  &quot; + patch.target().path().get().toString());</span>
<span class="line-removed">-                             appendPaddedHTMLComment(file, &quot;      (&quot; + patch.source().path().get().toString() + &quot;)&quot;);</span>
<span class="line-removed">-                         }</span>
<span class="line-removed">-                     }</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-             appendPaddedHTMLComment(file, &quot;&quot;);</span>
<span class="line-removed">-             if (issue.isPresent()) {</span>
<span class="line-removed">-                 appendPaddedHTMLComment(file, &quot;Issue:      &quot; + issue.get().webUrl());</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-             appendPaddedHTMLComment(file, &quot;Repository: &quot; + parentRepo.webUrl());</span>
<span class="line-removed">-             appendPaddedHTMLComment(file, &quot;Branch:     &quot; + targetBranch);</span>
  
<span class="line-modified">!             var success = spawnEditor(repo, file);</span>
<span class="line-modified">!             if (!success) {</span>
<span class="line-modified">!                 System.err.println(&quot;error: editor exited with non-zero status code, aborting&quot;);</span>
<span class="line-modified">!                 System.exit(1);</span>
<span class="line-modified">!             }</span>
<span class="line-modified">!             var lines = Files.readAllLines(file)</span>
<span class="line-modified">!                              .stream()</span>
<span class="line-modified">!                              .filter(l -&gt; !(l.startsWith(&quot;&lt;!--&quot;) &amp;&amp; l.endsWith(&quot;--&gt;&quot;)))</span>
<span class="line-modified">!                              .collect(Collectors.toList());</span>
<span class="line-modified">!             var isEmpty = lines.stream().allMatch(String::isEmpty);</span>
<span class="line-modified">!             if (isEmpty) {</span>
<span class="line-modified">!                 System.err.println(&quot;error: no message present, aborting&quot;);</span>
<span class="line-modified">!                 System.exit(1);</span>
<span class="line-modified">!             }</span>
  
<span class="line-modified">!             var title = lines.get(0);</span>
<span class="line-modified">!             List&lt;String&gt; body = null;</span>
<span class="line-modified">!             if (lines.size() &gt; 1) {</span>
<span class="line-modified">!                 body = lines.subList(1, lines.size())</span>
<span class="line-modified">!                             .stream()</span>
<span class="line-modified">!                             .dropWhile(String::isEmpty)</span>
<span class="line-removed">-                             .collect(Collectors.toList());</span>
<span class="line-removed">-             } else {</span>
<span class="line-removed">-                 body = Collections.emptyList();</span>
<span class="line-removed">-             }</span>
  
<span class="line-modified">!             var pr = remoteRepo.createPullRequest(parentRepo, targetBranch, currentBranch.name(), title, body);</span>
<span class="line-modified">!             var assigneesOption = getOption(&quot;assignees&quot;, &quot;create&quot;, arguments);</span>
<span class="line-modified">!             if (assigneesOption != null) {</span>
<span class="line-modified">!                 var usernames = Arrays.asList(assigneesOption.split(&quot;,&quot;));</span>
<span class="line-modified">!                 var assignees = usernames.stream()</span>
<span class="line-modified">!                                          .map(u -&gt; host.user(u))</span>
<span class="line-modified">!                                          .filter(Optional::isPresent)</span>
<span class="line-modified">!                                          .map(Optional::get)</span>
<span class="line-modified">!                                          .collect(Collectors.toList());</span>
<span class="line-modified">!                 pr.setAssignees(assignees);</span>
<span class="line-modified">!             }</span>
<span class="line-modified">!             System.out.println(pr.webUrl().toString());</span>
<span class="line-modified">!             Files.deleteIfExists(file);</span>
<span class="line-modified">! </span>
<span class="line-removed">-             repo.config(&quot;pr.&quot; + currentBranch.name(), &quot;id&quot;, pr.id().toString());</span>
<span class="line-removed">-         } else if (action.equals(&quot;integrate&quot;)) {</span>
<span class="line-removed">-             var id = pullRequestIdArgument(arguments, repo);</span>
<span class="line-removed">-             var pr = getPullRequest(uri, repo, host, id);</span>
<span class="line-removed">-             var isAtomic = getSwitch(&quot;atomic&quot;, &quot;integrate&quot;, arguments);</span>
<span class="line-removed">- </span>
<span class="line-removed">-             var message = &quot;/integrate&quot;;</span>
<span class="line-removed">-             if (isAtomic) {</span>
<span class="line-removed">-                 var targetHash = repo.resolve(pr.targetRef());</span>
<span class="line-removed">-                 if (!targetHash.isPresent()) {</span>
<span class="line-removed">-                     exit(&quot;error: cannot resolve target branch &quot; + pr.targetRef());</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-                 var sourceHash = repo.fetch(pr.repository().webUrl(), pr.fetchRef());</span>
<span class="line-removed">-                 var mergeBase = repo.mergeBase(sourceHash, targetHash.get());</span>
<span class="line-removed">-                 message += &quot; &quot; + mergeBase.hex();</span>
              }
  
<span class="line-modified">!             var integrateComment = pr.addComment(message);</span>
  
<span class="line-modified">!             var seenIntegrateComment = false;</span>
<span class="line-modified">!             var expected = &quot;&lt;!-- Jmerge command reply message (&quot; + integrateComment.id() + &quot;) --&gt;&quot;;</span>
<span class="line-modified">!             for (var i = 0; i &lt; 90; i++) {</span>
<span class="line-modified">!                 var comments = pr.comments();</span>
<span class="line-modified">!                 for (var comment : comments) {</span>
<span class="line-modified">!                     if (!seenIntegrateComment) {</span>
<span class="line-modified">!                         if (comment.id().equals(integrateComment.id())) {</span>
<span class="line-modified">!                             seenIntegrateComment = true;</span>
<span class="line-removed">-                         }</span>
<span class="line-removed">-                         continue;</span>
<span class="line-removed">-                     }</span>
<span class="line-removed">-                     var lines = comment.body().split(&quot;\n&quot;);</span>
<span class="line-removed">-                     if (lines.length &gt; 0 &amp;&amp; lines[0].equals(expected)) {</span>
<span class="line-removed">-                         for (var line : lines) {</span>
<span class="line-removed">-                             if (line.startsWith(&quot;Pushed as commit&quot;)) {</span>
<span class="line-removed">-                                 var output = removeTrailing(line, &quot;.&quot;);</span>
<span class="line-removed">-                                 System.out.println(output);</span>
<span class="line-removed">-                                 System.exit(0);</span>
<span class="line-removed">-                             }</span>
<span class="line-removed">-                         }</span>
                      }
                  }
<span class="line-modified">! </span>
<span class="line-modified">!                 Thread.sleep(2000);</span>
<span class="line-modified">!             }</span>
<span class="line-modified">! </span>
<span class="line-modified">!             System.err.println(&quot;error: timed out waiting for response to /integrate command&quot;);</span>
<span class="line-removed">-             System.exit(1);</span>
<span class="line-removed">-         } else if (action.equals(&quot;test&quot;)) {</span>
<span class="line-removed">-             var id = pullRequestIdArgument(arguments, repo);</span>
<span class="line-removed">-             var pr = getPullRequest(uri, repo, host, id);</span>
<span class="line-removed">-             var head = pr.headHash();</span>
<span class="line-removed">-             var testComment = pr.addComment(&quot;/test&quot;);</span>
<span class="line-removed">- </span>
<span class="line-removed">-             var seenTestComment = false;</span>
<span class="line-removed">-             for (var i = 0; i &lt; 90; i++) {</span>
<span class="line-removed">-                 var comments = pr.comments();</span>
<span class="line-removed">-                 for (var comment : comments) {</span>
<span class="line-removed">-                     if (!seenTestComment) {</span>
<span class="line-removed">-                         if (comment.id().equals(testComment.id())) {</span>
<span class="line-removed">-                             seenTestComment = true;</span>
<span class="line-removed">-                         }</span>
<span class="line-removed">-                         continue;</span>
<span class="line-removed">-                     }</span>
<span class="line-removed">-                     var lines = comment.body().split(&quot;\n&quot;);</span>
<span class="line-removed">-                     var n = lines.length;</span>
<span class="line-removed">-                     if (n &gt; 0) {</span>
<span class="line-removed">-                         if (n == 4 &amp;&amp;</span>
<span class="line-removed">-                             lines[0].equals(&quot;&lt;!-- TEST STARTED --&gt;&quot;) &amp;&amp;</span>
<span class="line-removed">-                             lines[1].startsWith(&quot;&lt;!-- github.com-&quot;) &amp;&amp;</span>
<span class="line-removed">-                             lines[2].equals(&quot;&lt;!-- &quot; + head.hex() + &quot; --&gt;&quot;)) {</span>
<span class="line-removed">-                             var output = removeTrailing(lines[3], &quot;.&quot;);</span>
<span class="line-removed">-                             System.out.println(output);</span>
<span class="line-removed">-                             System.exit(0);</span>
<span class="line-removed">-                         } else if (n == 2 &amp;&amp;</span>
<span class="line-removed">-                                    lines[0].equals(&quot;&lt;!-- TEST ERROR --&gt;&quot;)) {</span>
<span class="line-removed">-                             var output = removeTrailing(lines[1], &quot;.&quot;);</span>
<span class="line-removed">-                             System.out.println(output);</span>
<span class="line-removed">-                             System.exit(1);</span>
<span class="line-removed">-                         } else if (n == 4 &amp;&amp;</span>
<span class="line-removed">-                                    lines[0].equals(&quot;&lt;!-- TEST PENDING --&gt;&quot;) &amp;&amp;</span>
<span class="line-removed">-                                    lines[1].equals(&quot;&lt;!--- &quot; + head.hex() + &quot; --&gt;&quot;)) {</span>
<span class="line-removed">-                             var output = removeTrailing(lines[3], &quot;.&quot;);</span>
                              System.out.println(output);
                              System.exit(0);
                          }
                      }
                  }
<span class="line-removed">- </span>
<span class="line-removed">-                 Thread.sleep(2000);</span>
              }
  
<span class="line-modified">!         } else if (action.equals(&quot;approve&quot;)) {</span>
<span class="line-modified">!             var id = arguments.at(1).isPresent() ? arguments.at(1).asString() : null;</span>
<span class="line-removed">-             if (id == null) {</span>
<span class="line-removed">-                 exit(&quot;error: you must provide a pull request id&quot;);</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-             var pr = getPullRequest(uri, repo, host, id);</span>
<span class="line-removed">-             pr.addReview(Review.Verdict.APPROVED, &quot;Looks good!&quot;);</span>
<span class="line-removed">-         } else if (action.equals(&quot;list&quot;)) {</span>
<span class="line-removed">-             var remoteRepo = getHostedRepositoryFor(uri, repo, host);</span>
<span class="line-removed">-             var prs = remoteRepo.pullRequests();</span>
<span class="line-removed">-             var ids = new ArrayList&lt;String&gt;();</span>
<span class="line-removed">-             var titles = new ArrayList&lt;String&gt;();</span>
<span class="line-removed">-             var authors = new ArrayList&lt;String&gt;();</span>
<span class="line-removed">-             var assignees = new ArrayList&lt;String&gt;();</span>
<span class="line-removed">-             var labels = new ArrayList&lt;String&gt;();</span>
<span class="line-removed">-             var issues = new ArrayList&lt;String&gt;();</span>
<span class="line-removed">-             var branches = new ArrayList&lt;String&gt;();</span>
<span class="line-removed">-             var statuses = new ArrayList&lt;String&gt;();</span>
<span class="line-removed">-             var noDraft = getSwitch(&quot;no-draft&quot;, &quot;list&quot;, arguments);</span>
<span class="line-removed">- </span>
<span class="line-removed">-             var authorsOption = getOption(&quot;authors&quot;, &quot;list&quot;, arguments);</span>
<span class="line-removed">-             var filterAuthors = authorsOption == null ?</span>
<span class="line-removed">-                 Set.of() :</span>
<span class="line-removed">-                 new HashSet&lt;&gt;(Arrays.asList(authorsOption.split(&quot;,&quot;)));</span>
<span class="line-removed">- </span>
<span class="line-removed">-             var assigneesOption = getOption(&quot;assignees&quot;, &quot;list&quot;, arguments);</span>
<span class="line-removed">-             var filterAssignees = assigneesOption == null ?</span>
<span class="line-removed">-                 Set.of() :</span>
<span class="line-removed">-                 Arrays.asList(assigneesOption.split(&quot;,&quot;));</span>
<span class="line-removed">- </span>
<span class="line-removed">-             var labelsOption = getOption(&quot;labels&quot;, &quot;list&quot;, arguments);</span>
<span class="line-removed">-             var filterLabels = labelsOption == null ?</span>
<span class="line-removed">-                 Set.of() :</span>
<span class="line-removed">-                 Arrays.asList(labelsOption.split(&quot;,&quot;));</span>
<span class="line-removed">- </span>
<span class="line-removed">-             var issuesOption = getOption(&quot;issues&quot;, &quot;list&quot;, arguments);</span>
<span class="line-removed">-             var filterIssues = issuesOption == null ?</span>
<span class="line-removed">-                 Set.of() :</span>
<span class="line-removed">-                 Arrays.asList(issuesOption.split(&quot;,&quot;));</span>
<span class="line-removed">- </span>
<span class="line-removed">-             var columnTitles = List.of(&quot;id&quot;, &quot;title&quot;, &quot;authors&quot;, &quot;assignees&quot;, &quot;labels&quot;, &quot;issues&quot;, &quot;branch&quot;, &quot;status&quot;);</span>
<span class="line-removed">-             var columnValues = Map.of(columnTitles.get(0), ids,</span>
<span class="line-removed">-                                       columnTitles.get(1), titles,</span>
<span class="line-removed">-                                       columnTitles.get(2), authors,</span>
<span class="line-removed">-                                       columnTitles.get(3), assignees,</span>
<span class="line-removed">-                                       columnTitles.get(4), labels,</span>
<span class="line-removed">-                                       columnTitles.get(5), issues,</span>
<span class="line-removed">-                                       columnTitles.get(6), branches,</span>
<span class="line-removed">-                                       columnTitles.get(7), statuses);</span>
<span class="line-removed">-             var columnsOption = getOption(&quot;columns&quot;, &quot;list&quot;, arguments);</span>
<span class="line-removed">-             var columns = columnsOption == null ?</span>
<span class="line-removed">-                 List.of(&quot;id&quot;, &quot;title&quot;, &quot;authors&quot;, &quot;status&quot;) :</span>
<span class="line-removed">-                 Arrays.asList(columnsOption.split(&quot;,&quot;));</span>
<span class="line-removed">- </span>
<span class="line-removed">-             for (var column : columns) {</span>
<span class="line-removed">-                 if (!columnTitles.contains(column)) {</span>
<span class="line-removed">-                     System.err.println(&quot;error: unknown column: &quot; + column);</span>
<span class="line-removed">-                     System.err.println(&quot;       available columns are: &quot; + String.join(&quot;,&quot;, columnTitles));</span>
<span class="line-removed">-                     System.exit(1);</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-             }</span>
  
<span class="line-modified">!             for (var pr : prs) {</span>
<span class="line-modified">!                 if (pr.isDraft() &amp;&amp; noDraft) {</span>
<span class="line-modified">!                     continue;</span>
<span class="line-removed">-                 }</span>
  
<span class="line-modified">!                 var prAuthor = pr.author().userName();</span>
<span class="line-modified">!                 if (!filterAuthors.isEmpty() &amp;&amp; !filterAuthors.contains(prAuthor)) {</span>
<span class="line-modified">!                     continue;</span>
<span class="line-modified">!                 }</span>
  
<span class="line-modified">!                 var prAssignees = pr.assignees().stream()</span>
<span class="line-modified">!                                     .map(HostUser::userName)</span>
<span class="line-modified">!                                     .collect(Collectors.toSet());</span>
<span class="line-modified">!                 if (!filterAssignees.isEmpty() &amp;&amp; !filterAssignees.stream().anyMatch(prAssignees::contains)) {</span>
                      continue;
                  }
<span class="line-modified">! </span>
<span class="line-modified">!                 var prLabels = new HashSet&lt;&gt;(pr.labels());</span>
<span class="line-modified">!                 if (!filterLabels.isEmpty() &amp;&amp; !filterLabels.stream().anyMatch(prLabels::contains)) {</span>
<span class="line-modified">!                     continue;</span>
                  }
  
<span class="line-modified">!                 var prIssues = new HashSet&lt;&gt;(issuesFromPullRequest(pr));</span>
<span class="line-modified">!                 if (!filterIssues.isEmpty() &amp;&amp; !filterIssues.stream().anyMatch(prIssues::contains)) {</span>
<span class="line-modified">!                     continue;</span>
<span class="line-removed">-                 }</span>
  
  
<span class="line-modified">!                 ids.add(pr.id());</span>
<span class="line-modified">!                 titles.add(pr.title());</span>
<span class="line-modified">!                 authors.add(prAuthor);</span>
<span class="line-modified">!                 assignees.add(String.join(&quot;,&quot;, prAssignees));</span>
<span class="line-modified">!                 labels.add(String.join(&quot;,&quot;, prLabels));</span>
<span class="line-modified">!                 issues.add(String.join(&quot;,&quot;, prIssues));</span>
  
<span class="line-modified">!                 if (pr.author().userName().equals(credentials.username()) &amp;&amp;</span>
<span class="line-modified">!                     pr.sourceRepository().webUrl().equals(uri)) {</span>
<span class="line-modified">!                     branches.add(pr.sourceRef());</span>
<span class="line-modified">!                 } else {</span>
<span class="line-modified">!                     branches.add(&quot;&quot;);</span>
<span class="line-modified">!                 }</span>
  
<span class="line-modified">!                 if (columns.contains(&quot;status&quot;)) {</span>
<span class="line-modified">!                     statuses.add(statusForPullRequest(pr).toLowerCase());</span>
<span class="line-modified">!                 } else {</span>
<span class="line-modified">!                     statuses.add(&quot;&quot;);</span>
<span class="line-modified">!                 }</span>
              }
  
  
<span class="line-modified">!             String fmt = &quot;&quot;;</span>
<span class="line-modified">!             for (var column : columns.subList(0, columns.size() - 1)) {</span>
<span class="line-modified">!                 var values = columnValues.get(column);</span>
<span class="line-removed">-                 var n = Math.max(column.length(), longest(values));</span>
<span class="line-removed">-                 fmt += &quot;%-&quot; + n + &quot;s    &quot;;</span>
              }
<span class="line-modified">!             fmt += &quot;%s\n&quot;;</span>
<span class="line-modified">! </span>
<span class="line-modified">!             var noDecoration = getSwitch(&quot;no-decoration&quot;, &quot;list&quot;, arguments);</span>
<span class="line-modified">!             if (!ids.isEmpty() &amp;&amp; !noDecoration) {</span>
<span class="line-modified">!                 var upperCase = columns.stream()</span>
<span class="line-modified">!                                        .map(String::toUpperCase)</span>
<span class="line-removed">-                                        .collect(Collectors.toList());</span>
<span class="line-removed">-                 System.out.format(fmt, (Object[]) upperCase.toArray(new String[0]));</span>
              }
<span class="line-modified">!             for (var i = 0; i &lt; ids.size(); i++) {</span>
<span class="line-modified">!                 final int n = i;</span>
<span class="line-modified">!                 var row = columns.stream()</span>
<span class="line-modified">!                                  .map(columnValues::get)</span>
<span class="line-removed">-                                  .map(values -&gt; values.get(n))</span>
<span class="line-removed">-                                  .collect(Collectors.toList());</span>
<span class="line-removed">-                 System.out.format(fmt, (Object[]) row.toArray(new String[0]));</span>
              }
<span class="line-modified">!         } else if (action.equals(&quot;fetch&quot;) || action.equals(&quot;checkout&quot;) || action.equals(&quot;show&quot;) || action.equals(&quot;apply&quot;)) {</span>
<span class="line-modified">!             var prId = arguments.at(1);</span>
<span class="line-modified">!             if (!prId.isPresent()) {</span>
<span class="line-modified">!                 exit(&quot;error: missing pull request identifier&quot;);</span>
              }
  
<span class="line-removed">-             var remoteRepo = getHostedRepositoryFor(uri, repo, host);</span>
<span class="line-removed">-             var pr = remoteRepo.pullRequest(prId.asString());</span>
<span class="line-removed">-             var repoUrl = remoteRepo.webUrl();</span>
<span class="line-removed">-             var prHeadRef = pr.fetchRef();</span>
<span class="line-removed">-             var isHgGit = isMercurial &amp;&amp; Repository.exists(repo.root().resolve(&quot;.hg&quot;).resolve(&quot;git&quot;));</span>
<span class="line-removed">-             if (isHgGit) {</span>
<span class="line-removed">-                 var hgGitRepo = Repository.get(repo.root().resolve(&quot;.hg&quot;).resolve(&quot;git&quot;)).get();</span>
<span class="line-removed">-                 var hgGitFetchHead = hgGitRepo.fetch(repoUrl, prHeadRef);</span>
<span class="line-removed">- </span>
<span class="line-removed">-                 if (action.equals(&quot;show&quot;) || action.equals(&quot;apply&quot;)) {</span>
<span class="line-removed">-                     var target = hgGitRepo.fetch(repoUrl, pr.targetRef());</span>
<span class="line-removed">-                     var hgGitMergeBase = hgGitRepo.mergeBase(target, hgGitFetchHead);</span>
<span class="line-removed">- </span>
<span class="line-removed">-                     if (action.equals(&quot;show&quot;)) {</span>
<span class="line-removed">-                         show(hgGitMergeBase.hex(), hgGitFetchHead, hgGitRepo.root());</span>
<span class="line-removed">-                     } else {</span>
<span class="line-removed">-                         var patch = diff(hgGitMergeBase.hex(), hgGitFetchHead, hgGitRepo.root());</span>
<span class="line-removed">-                         hgImport(patch);</span>
<span class="line-removed">-                         Files.delete(patch);</span>
<span class="line-removed">-                     }</span>
<span class="line-removed">-                 } else if (action.equals(&quot;fetch&quot;) || action.equals(&quot;checkout&quot;)) {</span>
<span class="line-removed">-                     var hgGitRef = prHeadRef.endsWith(&quot;/head&quot;) ? prHeadRef.replace(&quot;/head&quot;, &quot;&quot;) : prHeadRef;</span>
<span class="line-removed">-                     var hgGitBranches = hgGitRepo.branches();</span>
<span class="line-removed">-                     if (hgGitBranches.contains(new Branch(hgGitRef))) {</span>
<span class="line-removed">-                         hgGitRepo.delete(new Branch(hgGitRef));</span>
<span class="line-removed">-                     }</span>
<span class="line-removed">-                     hgGitRepo.branch(hgGitFetchHead, hgGitRef);</span>
<span class="line-removed">-                     gimport();</span>
<span class="line-removed">-                     var hgFetchHead = repo.resolve(hgGitRef).get();</span>
<span class="line-removed">- </span>
<span class="line-removed">-                     if (action.equals(&quot;fetch&quot;) &amp;&amp; arguments.contains(&quot;branch&quot;)) {</span>
<span class="line-removed">-                         repo.branch(hgFetchHead, arguments.get(&quot;branch&quot;).asString());</span>
<span class="line-removed">-                     } else if (action.equals(&quot;checkout&quot;)) {</span>
<span class="line-removed">-                         repo.checkout(hgFetchHead);</span>
<span class="line-removed">-                         if (arguments.contains(&quot;branch&quot;)) {</span>
<span class="line-removed">-                             repo.branch(hgFetchHead, arguments.get(&quot;branch&quot;).asString());</span>
<span class="line-removed">-                         }</span>
<span class="line-removed">-                     }</span>
<span class="line-removed">-                 } else {</span>
<span class="line-removed">-                     exit(&quot;Unexpected action: &quot; + action);</span>
<span class="line-removed">-                 }</span>
  
<span class="line-modified">!                 return;</span>
<span class="line-modified">!             }</span>
  
<span class="line-modified">!             var fetchHead = repo.fetch(repoUrl, pr.fetchRef());</span>
<span class="line-modified">!             if (action.equals(&quot;fetch&quot;)) {</span>
<span class="line-modified">!                 var branchName = getOption(&quot;branch&quot;, &quot;fetch&quot;, arguments);</span>
<span class="line-modified">!                 if (branchName != null) {</span>
<span class="line-removed">-                     repo.branch(fetchHead, branchName);</span>
<span class="line-removed">-                 } else {</span>
<span class="line-removed">-                     System.out.println(fetchHead.hex());</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-             } else if (action.equals(&quot;checkout&quot;)) {</span>
<span class="line-removed">-                 var branchName = getOption(&quot;branch&quot;, &quot;checkout&quot;, arguments);</span>
<span class="line-removed">-                 if (branchName != null) {</span>
<span class="line-removed">-                     var branch = repo.branch(fetchHead, branchName);</span>
<span class="line-removed">-                     repo.checkout(branch, false);</span>
<span class="line-removed">-                 } else {</span>
<span class="line-removed">-                     repo.checkout(fetchHead, false);</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-             } else if (action.equals(&quot;show&quot;)) {</span>
<span class="line-removed">-                 show(pr.targetRef(), fetchHead);</span>
<span class="line-removed">-             } else if (action.equals(&quot;apply&quot;)) {</span>
<span class="line-removed">-                 var patch = diff(pr.targetRef(), fetchHead);</span>
<span class="line-removed">-                 apply(patch);</span>
<span class="line-removed">-                 Files.deleteIfExists(patch);</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-         } else if (action.equals(&quot;close&quot;)) {</span>
<span class="line-removed">-             var prId = arguments.at(1);</span>
<span class="line-removed">-             if (!prId.isPresent()) {</span>
<span class="line-removed">-                 exit(&quot;error: missing pull request identifier&quot;);</span>
              }
  
<span class="line-modified">!             var remoteRepo = getHostedRepositoryFor(uri, repo, host);</span>
<span class="line-modified">!             var pr = remoteRepo.pullRequest(prId.asString());</span>
<span class="line-modified">!             pr.setState(PullRequest.State.CLOSED);</span>
<span class="line-modified">!         } else if (action.equals(&quot;set&quot;)) {</span>
<span class="line-removed">-             var prId = arguments.at(1);</span>
<span class="line-removed">-             if (!prId.isPresent()) {</span>
<span class="line-removed">-                 exit(&quot;error: missing pull request identifier&quot;);</span>
              }
  
<span class="line-modified">!             var remoteRepo = getHostedRepositoryFor(uri, repo, host);</span>
<span class="line-modified">!             var pr = remoteRepo.pullRequest(prId.asString());</span>
<span class="line-modified">!             var assigneesOption = getOption(&quot;assignees&quot;, &quot;set&quot;, arguments);</span>
<span class="line-modified">!             if (assigneesOption != null) {</span>
<span class="line-modified">!                 var usernames = Arrays.asList(assigneesOption.split(&quot;,&quot;));</span>
<span class="line-modified">!                 var assignees = usernames.stream()</span>
<span class="line-modified">!                     .map(u -&gt; host.user(u))</span>
<span class="line-modified">!                     .filter(Optional::isPresent)</span>
<span class="line-modified">!                     .map(Optional::get)</span>
<span class="line-modified">!                     .collect(Collectors.toList());</span>
<span class="line-modified">!                 pr.setAssignees(assignees);</span>
<span class="line-modified">!             }</span>
<span class="line-modified">!         } else if (action.equals(&quot;status&quot;)) {</span>
<span class="line-modified">!             String id = pullRequestIdArgument(arguments, repo);</span>
<span class="line-modified">!             var pr = getPullRequest(uri, repo, host, id);</span>
<span class="line-modified">!             var noDecoration = getSwitch(&quot;no-decoration&quot;, &quot;status&quot;, arguments);</span>
<span class="line-modified">!             var decoration = noDecoration ? &quot;&quot; : &quot;Status: &quot;;</span>
<span class="line-modified">!             System.out.println(decoration + statusForPullRequest(pr));</span>
<span class="line-modified">! </span>
<span class="line-modified">!             var noChecks = getSwitch(&quot;no-checks&quot;, &quot;status&quot;, arguments);</span>
<span class="line-modified">!             if (!noChecks) {</span>
<span class="line-modified">!                 var checks = pr.checks(pr.headHash());</span>
<span class="line-modified">!                 var jcheck = Optional.ofNullable(checks.get(&quot;jcheck&quot;));</span>
<span class="line-modified">!                 var submit = Optional.ofNullable(checks.get(&quot;submit&quot;));</span>
<span class="line-modified">!                 var showChecks = jcheck.isPresent() || submit.isPresent();</span>
<span class="line-modified">!                 if (showChecks) {</span>
<span class="line-modified">!                     System.out.println(&quot;Checks:&quot;);</span>
<span class="line-modified">!                     if (jcheck.isPresent()) {</span>
<span class="line-modified">!                         System.out.println(&quot;- jcheck: &quot; + statusForCheck(jcheck.get()));</span>
<span class="line-modified">!                     }</span>
<span class="line-modified">!                     if (submit.isPresent()) {</span>
<span class="line-modified">!                         System.out.println(&quot;- submit: &quot; + statusForCheck(submit.get()));</span>
<span class="line-modified">!                     }</span>
                  }
              }
          } else {
<span class="line-modified">!             exit(&quot;error: unexpected action: &quot; + action);</span>
          }
      }
  }
<span class="line-new-header">--- 511,1136 ---</span>
                    .helptext(&quot;Turn on debugging output&quot;)
                    .optional(),
              Switch.shortcut(&quot;&quot;)
                    .fullname(&quot;version&quot;)
                    .helptext(&quot;Print the version of this tool&quot;)
<span class="line-modified">!                   .optional()</span>
<span class="line-added">+         );</span>
  
          var inputs = List.of(
              Input.position(0)
                   .describe(&quot;ID&quot;)
                   .singular()
                   .optional()
          );
  
          var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);
<span class="line-modified">!         var arguments = parse(parser, args);</span>
<span class="line-modified">!         var repo = getRepo();</span>
<span class="line-modified">!         var uri = getURI(repo, arguments);</span>
<span class="line-modified">!         var host = getForge(uri, repo, arguments);</span>
<span class="line-modified">!         var remote = getRemote(repo, arguments);</span>
<span class="line-modified">!         var currentBranch = repo.currentBranch().orElseGet(() -&gt; {</span>
<span class="line-modified">!                 System.err.println(&quot;error: the repository is in a detached HEAD state&quot;);</span>
<span class="line-modified">!                 System.exit(1);</span>
<span class="line-modified">!                 return null;</span>
<span class="line-modified">!         });</span>
<span class="line-added">+         if (currentBranch.equals(repo.defaultBranch())) {</span>
<span class="line-added">+             System.err.println(&quot;error: you should not create pull requests from the &#39;master&#39; branch&quot;);</span>
<span class="line-added">+             System.err.println(&quot;&quot;);</span>
<span class="line-added">+             System.err.println(&quot;To create a local branch for your changes and restore the &#39;master&#39; branch, run:&quot;);</span>
<span class="line-added">+             System.err.println(&quot;&quot;);</span>
<span class="line-added">+             System.err.println(&quot;    git checkout -b NAME-FOR-YOUR-LOCAL-BRANCH&quot;);</span>
<span class="line-added">+             System.err.println(&quot;    git branch --force master origin/master&quot;);</span>
<span class="line-added">+             System.err.println(&quot;&quot;);</span>
<span class="line-added">+             System.exit(1);</span>
          }
  
<span class="line-modified">!         var ignoreWorkspace = getSwitch(&quot;ignore-workspace&quot;, &quot;create&quot;, arguments);</span>
<span class="line-modified">!         if (!ignoreWorkspace) {</span>
<span class="line-modified">!             var diff = repo.diff(repo.head());</span>
<span class="line-modified">!             if (!diff.patches().isEmpty()) {</span>
<span class="line-modified">!                 System.err.println(&quot;error: there are uncommitted changes in your working tree:&quot;);</span>
<span class="line-modified">!                 System.err.println(&quot;&quot;);</span>
<span class="line-modified">!                 for (var patch : diff.patches()) {</span>
<span class="line-modified">!                     var path = patch.target().path().isPresent() ?</span>
<span class="line-modified">!                         patch.target().path().get() : patch.source().path().get();</span>
<span class="line-modified">!                     System.err.println(&quot;    &quot; + patch.status().toString() + &quot; &quot; + path.toString());</span>
                  }
<span class="line-modified">!                 System.err.println(&quot;&quot;);</span>
<span class="line-modified">!                 System.err.println(&quot;If these changes are meant to be part of the pull request, run:&quot;);</span>
<span class="line-modified">!                 System.err.println(&quot;&quot;);</span>
<span class="line-modified">!                 System.err.println(&quot;    git commit -am &#39;Forgot to add some changes&#39;&quot;);</span>
<span class="line-modified">!                 System.err.println(&quot;&quot;);</span>
<span class="line-modified">!                 System.err.println(&quot;If these changes are *not* meant to be part of the pull request, run:&quot;);</span>
<span class="line-modified">!                 System.err.println(&quot;&quot;);</span>
<span class="line-modified">!                 System.err.println(&quot;    git stash&quot;);</span>
<span class="line-modified">!                 System.err.println(&quot;&quot;);</span>
<span class="line-modified">!                 System.err.println(&quot;(You can later restore the changes by running: git stash pop)&quot;);</span>
<span class="line-added">+                 System.exit(1);</span>
              }
          }
  
<span class="line-modified">!         var upstream = repo.upstreamFor(currentBranch);</span>
<span class="line-modified">!         if (upstream.isEmpty()) {</span>
<span class="line-modified">!             var shouldPublish = getSwitch(&quot;publish&quot;, &quot;create&quot;, arguments);</span>
<span class="line-modified">!             if (shouldPublish) {</span>
<span class="line-added">+                 GitPublish.main(new String[] { &quot;--quiet&quot;, remote });</span>
<span class="line-added">+                 upstream = repo.upstreamFor(currentBranch);</span>
<span class="line-added">+             } else {</span>
<span class="line-added">+                 System.err.println(&quot;error: there is no remote branch for the local branch &#39;&quot; + currentBranch.name() + &quot;&#39;&quot;);</span>
<span class="line-added">+                 System.err.println(&quot;&quot;);</span>
<span class="line-added">+                 System.err.println(&quot;A remote branch must be present at &quot; + uri + &quot; to create a pull request&quot;);</span>
<span class="line-added">+                 System.err.println(&quot;To create a remote branch and push the commits for your local branch, run:&quot;);</span>
<span class="line-added">+                 System.err.println(&quot;&quot;);</span>
<span class="line-added">+                 System.err.println(&quot;    git publish&quot;);</span>
<span class="line-added">+                 System.err.println(&quot;&quot;);</span>
<span class="line-added">+                 System.err.println(&quot;If you created the remote branch from another client, you must update this repository.&quot;);</span>
<span class="line-added">+                 System.err.println(&quot;To update remote information for this repository, run:&quot;);</span>
<span class="line-added">+                 System.err.println(&quot;&quot;);</span>
<span class="line-added">+                 System.err.println(&quot;    git fetch &quot; + remote);</span>
<span class="line-added">+                 System.err.println(&quot;    git branch --set-upstream &quot; + currentBranch + &quot; &quot; + remote + &quot;/&quot; + currentBranch);</span>
<span class="line-added">+                 System.err.println(&quot;&quot;);</span>
<span class="line-added">+                 System.exit(1);</span>
              }
          }
  
<span class="line-modified">!         var upstreamRefName = upstream.get().substring(remote.length() + 1);</span>
<span class="line-modified">!         repo.fetch(uri, upstreamRefName);</span>
  
<span class="line-modified">!         var shouldIgnoreLocalCommits = getSwitch(&quot;ignore-local-commits&quot;, &quot;create&quot;, arguments);</span>
<span class="line-modified">!         if (!shouldIgnoreLocalCommits) {</span>
<span class="line-modified">!             var branchCommits = repo.commits(upstream.get() + &quot;..&quot; + currentBranch.name()).asList();</span>
<span class="line-modified">!             if (!branchCommits.isEmpty()) {</span>
<span class="line-modified">!                 System.err.println(&quot;error: there are local commits on branch &#39;&quot; + currentBranch.name() + &quot;&#39; not present in the remote repository &quot; + uri);</span>
<span class="line-modified">!                 System.err.println(&quot;&quot;);</span>
<span class="line-modified">!                 System.err.println(&quot;All commits must be present in the remote repository to be part of the pull request&quot;);</span>
<span class="line-modified">!                 System.err.println(&quot;The following commits are not present in the remote repository:&quot;);</span>
<span class="line-modified">!                 System.err.println(&quot;&quot;);</span>
<span class="line-modified">!                 for (var commit : branchCommits) {</span>
<span class="line-modified">!                     System.err.println(&quot;- &quot; + commit.hash().abbreviate() + &quot;: &quot; + commit.message().get(0));</span>
                  }
<span class="line-added">+                 System.err.println(&quot;&quot;);</span>
<span class="line-added">+                 System.err.println(&quot;To push the above local commits to the remote repository, run:&quot;);</span>
<span class="line-added">+                 System.err.println(&quot;&quot;);</span>
<span class="line-added">+                 System.err.println(&quot;    git push &quot; + remote + &quot; &quot; + currentBranch.name());</span>
<span class="line-added">+                 System.err.println(&quot;&quot;);</span>
<span class="line-added">+                 System.exit(1);</span>
<span class="line-added">+             }</span>
<span class="line-added">+         }</span>
  
<span class="line-modified">!         var remoteRepo = host.repository(projectName(uri)).orElseThrow(() -&gt;</span>
<span class="line-modified">!                 new IOException(&quot;Could not find repository at &quot; + uri.toString())</span>
<span class="line-modified">!         );</span>
<span class="line-modified">!         var parentRepo = remoteRepo.parent().orElseThrow(() -&gt;</span>
<span class="line-modified">!                 new IOException(&quot;error: remote repository &quot; + uri + &quot; is not a fork of any repository&quot;)</span>
<span class="line-modified">!         );</span>
  
<span class="line-modified">!         var targetBranch = getOption(&quot;branch&quot;, &quot;create&quot;, arguments);</span>
<span class="line-modified">!         if (targetBranch == null) {</span>
<span class="line-modified">!             var upstreamBranchNames = repo.remoteBranches(parentRepo.webUrl().toString())</span>
<span class="line-modified">!                                           .stream()</span>
<span class="line-modified">!                                           .map(r -&gt; r.name())</span>
<span class="line-modified">!                                           .collect(Collectors.toSet());</span>
<span class="line-modified">!             var remoteBranches = repo.branches(remote);</span>
<span class="line-modified">!             var candidates = new ArrayList&lt;Branch&gt;();</span>
<span class="line-modified">!             for (var b : remoteBranches) {</span>
<span class="line-modified">!                 var withoutRemotePrefix = b.name().substring(remote.length() + 1);</span>
<span class="line-modified">!                 if (upstreamBranchNames.contains(withoutRemotePrefix)) {</span>
<span class="line-modified">!                     candidates.add(b);</span>
                  }
<span class="line-added">+             }</span>
  
<span class="line-modified">!             var localBranches = repo.branches();</span>
<span class="line-modified">!             Branch closest = null;</span>
<span class="line-modified">!             var shortestDistance = Integer.MAX_VALUE;</span>
<span class="line-modified">!             for (var b : candidates) {</span>
<span class="line-modified">!                 var from = b.name();</span>
<span class="line-modified">!                 for (var localBranch : localBranches) {</span>
<span class="line-modified">!                     var trackingBranch = repo.upstreamFor(localBranch);</span>
<span class="line-modified">!                     if (trackingBranch.isPresent() &amp;&amp;</span>
<span class="line-modified">!                         trackingBranch.get().equals(b.name())) {</span>
<span class="line-modified">!                         from = localBranch.name();</span>
                      }
                  }
<span class="line-modified">!                 var distance = repo.commitMetadata(from + &quot;...&quot; + currentBranch.name()).size();</span>
<span class="line-modified">!                 if (distance &lt; shortestDistance) {</span>
<span class="line-modified">!                     closest = b;</span>
<span class="line-modified">!                     shortestDistance = distance;</span>
                  }
              }
<span class="line-modified">! </span>
<span class="line-modified">!             if (closest != null) {</span>
<span class="line-modified">!                 targetBranch = closest.name().substring(remote.length() + 1);</span>
<span class="line-modified">!             } else {</span>
<span class="line-modified">!                 System.err.println(&quot;error: cannot automatically infer target branch&quot;);</span>
<span class="line-modified">!                 System.err.println(&quot;       use --branch to specify target branch&quot;);</span>
                  System.exit(1);
              }
<span class="line-added">+         }</span>
<span class="line-added">+         var commits = repo.commits(targetBranch + &quot;..&quot; + upstream.get()).asList();</span>
<span class="line-added">+         if (commits.isEmpty()) {</span>
<span class="line-added">+             System.err.println(&quot;error: no difference between branches &quot; + targetBranch + &quot; and &quot; + currentBranch.name());</span>
<span class="line-added">+             System.err.println(&quot;       Cannot create an empty pull request, have you committed?&quot;);</span>
<span class="line-added">+             System.exit(1);</span>
<span class="line-added">+         }</span>
  
<span class="line-modified">!         var shouldRunJCheck = getSwitch(&quot;jcheck&quot;, &quot;create&quot;, arguments);</span>
<span class="line-modified">!         if (shouldRunJCheck) {</span>
<span class="line-modified">!             var jcheckArgs = new String[]{ &quot;--pull-request&quot;, &quot;--rev&quot;, targetBranch + &quot;..&quot; + upstream.get() };</span>
<span class="line-modified">!             var err = GitJCheck.run(jcheckArgs);</span>
<span class="line-modified">!             if (err != 0) {</span>
<span class="line-modified">!                 System.exit(err);</span>
              }
<span class="line-added">+         }</span>
  
<span class="line-modified">!         var project = jbsProjectFromJcheckConf(repo, targetBranch);</span>
<span class="line-modified">!         var issue = getIssue(currentBranch, project);</span>
<span class="line-modified">!         var file = Files.createTempFile(&quot;PULL_REQUEST_&quot;, &quot;.md&quot;);</span>
<span class="line-modified">!         if (issue.isPresent()) {</span>
<span class="line-modified">!             Files.writeString(file, format(issue.get()) + &quot;\n\n&quot;);</span>
<span class="line-modified">!         } else if (commits.size() == 1) {</span>
<span class="line-modified">!             var commit = commits.get(0);</span>
<span class="line-modified">!             issue = getIssue(commit, project);</span>
<span class="line-modified">!             if (issue.isPresent()) {</span>
<span class="line-modified">!                 Files.writeString(file, format(issue.get()) + &quot;\n\n&quot;);</span>
<span class="line-modified">!             } else {</span>
<span class="line-modified">!                 var message = CommitMessageParsers.v1.parse(commit.message());</span>
<span class="line-modified">!                 Files.writeString(file, message.title() + &quot;\n&quot;);</span>
<span class="line-modified">!                 if (!message.summaries().isEmpty()) {</span>
<span class="line-modified">!                     Files.write(file, message.summaries(), StandardOpenOption.APPEND);</span>
<span class="line-modified">!                 }</span>
<span class="line-modified">!                 if (!message.additional().isEmpty()) {</span>
<span class="line-modified">!                     Files.write(file, message.additional(), StandardOpenOption.APPEND);</span>
                  }
              }
<span class="line-added">+         } else {</span>
<span class="line-added">+             Files.write(file, List.of(&quot;&quot;));</span>
<span class="line-added">+         }</span>
  
<span class="line-modified">!         appendPaddedHTMLComment(file, &quot;Please enter the pull request message for your changes.&quot;);</span>
<span class="line-modified">!         appendPaddedHTMLComment(file, &quot;The first line will be considered the subject, use a blank line to&quot;);</span>
<span class="line-modified">!         appendPaddedHTMLComment(file, &quot;separate the subject from the body. These HTML comment lines will&quot;);</span>
<span class="line-modified">!         appendPaddedHTMLComment(file, &quot;be removed automatically. An empty message aborts the pull request.&quot;);</span>
<span class="line-modified">!         appendPaddedHTMLComment(file, &quot;&quot;);</span>
<span class="line-modified">!         appendPaddedHTMLComment(file, &quot;Commits to be included from branch &#39;&quot; + currentBranch.name() + &quot;&#39;:&quot;);</span>
<span class="line-modified">!         for (var commit : commits) {</span>
<span class="line-modified">!             var desc = commit.hash().abbreviate() + &quot;: &quot; + commit.message().get(0);</span>
<span class="line-modified">!             appendPaddedHTMLComment(file, &quot;- &quot; + desc);</span>
<span class="line-modified">!             if (!commit.isMerge()) {</span>
<span class="line-modified">!                 var diff = commit.parentDiffs().get(0);</span>
<span class="line-modified">!                 for (var patch : diff.patches()) {</span>
<span class="line-modified">!                     var status = patch.status();</span>
<span class="line-modified">!                     if (status.isModified()) {</span>
<span class="line-added">+                         appendPaddedHTMLComment(file, &quot;  M  &quot; + patch.target().path().get().toString());</span>
<span class="line-added">+                     } else if (status.isAdded()) {</span>
<span class="line-added">+                         appendPaddedHTMLComment(file, &quot;  A  &quot; + patch.target().path().get().toString());</span>
<span class="line-added">+                     } else if (status.isDeleted()) {</span>
<span class="line-added">+                         appendPaddedHTMLComment(file, &quot;  D  &quot; + patch.source().path().get().toString());</span>
<span class="line-added">+                     } else if (status.isRenamed()) {</span>
<span class="line-added">+                         appendPaddedHTMLComment(file, &quot;  R  &quot; + patch.target().path().get().toString());</span>
<span class="line-added">+                         appendPaddedHTMLComment(file, &quot;      (&quot; + patch.source().path().get().toString() + &quot;)&quot;);</span>
<span class="line-added">+                     } else if (status.isCopied()) {</span>
<span class="line-added">+                         appendPaddedHTMLComment(file, &quot;  C  &quot; + patch.target().path().get().toString());</span>
<span class="line-added">+                         appendPaddedHTMLComment(file, &quot;      (&quot; + patch.source().path().get().toString() + &quot;)&quot;);</span>
                      }
                  }
              }
<span class="line-added">+         }</span>
<span class="line-added">+         appendPaddedHTMLComment(file, &quot;&quot;);</span>
<span class="line-added">+         if (issue.isPresent()) {</span>
<span class="line-added">+             appendPaddedHTMLComment(file, &quot;Issue:      &quot; + issue.get().webUrl());</span>
<span class="line-added">+         }</span>
<span class="line-added">+         appendPaddedHTMLComment(file, &quot;Repository: &quot; + parentRepo.webUrl());</span>
<span class="line-added">+         appendPaddedHTMLComment(file, &quot;Branch:     &quot; + targetBranch);</span>
  
<span class="line-modified">!         var success = spawnEditor(repo, file);</span>
<span class="line-modified">!         if (!success) {</span>
<span class="line-modified">!             System.err.println(&quot;error: editor exited with non-zero status code, aborting&quot;);</span>
<span class="line-modified">!             System.exit(1);</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         var lines = Files.readAllLines(file)</span>
<span class="line-modified">!                          .stream()</span>
<span class="line-modified">!                          .filter(l -&gt; !(l.startsWith(&quot;&lt;!--&quot;) &amp;&amp; l.endsWith(&quot;--&gt;&quot;)))</span>
<span class="line-modified">!                          .collect(Collectors.toList());</span>
<span class="line-modified">!         var isEmpty = lines.stream().allMatch(String::isEmpty);</span>
<span class="line-modified">!         if (isEmpty) {</span>
<span class="line-modified">!             System.err.println(&quot;error: no message present, aborting&quot;);</span>
<span class="line-modified">!             System.exit(1);</span>
<span class="line-modified">!         }</span>
  
<span class="line-modified">!         var title = lines.get(0);</span>
<span class="line-modified">!         List&lt;String&gt; body = null;</span>
<span class="line-modified">!         if (lines.size() &gt; 1) {</span>
<span class="line-modified">!             body = lines.subList(1, lines.size())</span>
<span class="line-modified">!                         .stream()</span>
<span class="line-modified">!                         .dropWhile(String::isEmpty)</span>
<span class="line-modified">!                         .collect(Collectors.toList());</span>
<span class="line-modified">!         } else {</span>
<span class="line-added">+             body = Collections.emptyList();</span>
<span class="line-added">+         }</span>
  
<span class="line-modified">!         var pr = remoteRepo.createPullRequest(parentRepo, targetBranch, currentBranch.name(), title, body);</span>
<span class="line-modified">!         var assigneesOption = getOption(&quot;assignees&quot;, &quot;create&quot;, arguments);</span>
<span class="line-modified">!         if (assigneesOption != null) {</span>
<span class="line-modified">!             var usernames = Arrays.asList(assigneesOption.split(&quot;,&quot;));</span>
<span class="line-modified">!             var assignees = usernames.stream()</span>
<span class="line-modified">!                                      .map(u -&gt; host.user(u))</span>
<span class="line-modified">!                                      .filter(Optional::isPresent)</span>
<span class="line-modified">!                                      .map(Optional::get)</span>
<span class="line-modified">!                                      .collect(Collectors.toList());</span>
<span class="line-modified">!             pr.setAssignees(assignees);</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         System.out.println(pr.webUrl().toString());</span>
<span class="line-modified">!         Files.deleteIfExists(file);</span>
  
<span class="line-modified">!         repo.config(&quot;pr.&quot; + currentBranch.name(), &quot;id&quot;, pr.id().toString());</span>
<span class="line-modified">!     }</span>
  
<span class="line-modified">!     private static void integrate(String[] args) throws IOException, InterruptedException {</span>
<span class="line-modified">!         var flags = List.of(</span>
<span class="line-modified">!             Option.shortcut(&quot;u&quot;)</span>
<span class="line-modified">!                   .fullname(&quot;username&quot;)</span>
<span class="line-modified">!                   .describe(&quot;NAME&quot;)</span>
<span class="line-modified">!                   .helptext(&quot;Username on host&quot;)</span>
<span class="line-modified">!                   .optional(),</span>
<span class="line-modified">!             Option.shortcut(&quot;r&quot;)</span>
<span class="line-modified">!                   .fullname(&quot;remote&quot;)</span>
<span class="line-modified">!                   .describe(&quot;NAME&quot;)</span>
<span class="line-modified">!                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)</span>
<span class="line-modified">!                   .optional(),</span>
<span class="line-modified">!             Switch.shortcut(&quot;&quot;)</span>
<span class="line-modified">!                   .fullname(&quot;atomic&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Integrate the pull request atomically&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;verbose&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Turn on verbose output&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;debug&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Turn on debugging output&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;version&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Print the version of this tool&quot;)</span>
<span class="line-added">+                   .optional()</span>
<span class="line-added">+         );</span>
  
<span class="line-modified">!         var inputs = List.of(</span>
<span class="line-modified">!             Input.position(0)</span>
<span class="line-modified">!                  .describe(&quot;ID&quot;)</span>
<span class="line-modified">!                  .singular()</span>
<span class="line-modified">!                  .optional()</span>
<span class="line-modified">!         );</span>
  
<span class="line-modified">!         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);</span>
<span class="line-modified">!         var arguments = parse(parser, args);</span>
<span class="line-modified">!         var repo = getRepo();</span>
<span class="line-modified">!         var uri = getURI(repo, arguments);</span>
<span class="line-modified">!         var host = getForge(uri, repo, arguments);</span>
<span class="line-modified">!         var id = pullRequestIdArgument(repo, arguments);</span>
<span class="line-modified">!         var pr = getPullRequest(uri, repo, host, id);</span>
<span class="line-modified">!         var isAtomic = getSwitch(&quot;atomic&quot;, &quot;integrate&quot;, arguments);</span>
<span class="line-modified">! </span>
<span class="line-modified">!         var message = &quot;/integrate&quot;;</span>
<span class="line-modified">!         if (isAtomic) {</span>
<span class="line-modified">!             var targetHash = repo.resolve(pr.targetRef());</span>
<span class="line-modified">!             if (!targetHash.isPresent()) {</span>
<span class="line-modified">!                 exit(&quot;error: cannot resolve target branch &quot; + pr.targetRef());</span>
              }
<span class="line-added">+             var sourceHash = repo.fetch(pr.repository().webUrl(), pr.fetchRef());</span>
<span class="line-added">+             var mergeBase = repo.mergeBase(sourceHash, targetHash.get());</span>
<span class="line-added">+             message += &quot; &quot; + mergeBase.hex();</span>
<span class="line-added">+         }</span>
  
<span class="line-modified">!         var integrateComment = pr.addComment(message);</span>
  
<span class="line-modified">!         var seenIntegrateComment = false;</span>
<span class="line-modified">!         var expected = &quot;&lt;!-- Jmerge command reply message (&quot; + integrateComment.id() + &quot;) --&gt;&quot;;</span>
<span class="line-modified">!         for (var i = 0; i &lt; 90; i++) {</span>
<span class="line-modified">!             var comments = pr.comments();</span>
<span class="line-modified">!             for (var comment : comments) {</span>
<span class="line-modified">!                 if (!seenIntegrateComment) {</span>
<span class="line-modified">!                     if (comment.id().equals(integrateComment.id())) {</span>
<span class="line-modified">!                         seenIntegrateComment = true;</span>
                      }
<span class="line-added">+                     continue;</span>
                  }
<span class="line-modified">!                 var lines = comment.body().split(&quot;\n&quot;);</span>
<span class="line-modified">!                 if (lines.length &gt; 0 &amp;&amp; lines[0].equals(expected)) {</span>
<span class="line-modified">!                     for (var line : lines) {</span>
<span class="line-modified">!                         if (line.startsWith(&quot;Pushed as commit&quot;)) {</span>
<span class="line-modified">!                             var output = removeTrailing(line, &quot;.&quot;);</span>
                              System.out.println(output);
                              System.exit(0);
                          }
                      }
                  }
              }
  
<span class="line-modified">!             Thread.sleep(2000);</span>
<span class="line-modified">!         }</span>
  
<span class="line-modified">!         System.err.println(&quot;error: timed out waiting for response to /integrate command&quot;);</span>
<span class="line-modified">!         System.exit(1);</span>
<span class="line-modified">!     }</span>
  
<span class="line-modified">!     private static void test(String[] args) throws IOException, InterruptedException {</span>
<span class="line-modified">!         var flags = List.of(</span>
<span class="line-modified">!             Option.shortcut(&quot;u&quot;)</span>
<span class="line-modified">!                   .fullname(&quot;username&quot;)</span>
<span class="line-added">+                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Username on host&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Option.shortcut(&quot;r&quot;)</span>
<span class="line-added">+                   .fullname(&quot;remote&quot;)</span>
<span class="line-added">+                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;verbose&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Turn on verbose output&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;debug&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Turn on debugging output&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;version&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Print the version of this tool&quot;)</span>
<span class="line-added">+                   .optional()</span>
<span class="line-added">+         );</span>
  
<span class="line-modified">!         var inputs = List.of(</span>
<span class="line-modified">!             Input.position(0)</span>
<span class="line-modified">!                  .describe(&quot;ID&quot;)</span>
<span class="line-modified">!                  .singular()</span>
<span class="line-added">+                  .optional()</span>
<span class="line-added">+         );</span>
<span class="line-added">+         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);</span>
<span class="line-added">+         var arguments = parse(parser, args);</span>
<span class="line-added">+         var repo = getRepo();</span>
<span class="line-added">+         var uri = getURI(repo, arguments);</span>
<span class="line-added">+         var host = getForge(uri, repo, arguments);</span>
<span class="line-added">+         var id = pullRequestIdArgument(repo, arguments);</span>
<span class="line-added">+         var pr = getPullRequest(uri, repo, host, id);</span>
<span class="line-added">+         var head = pr.headHash();</span>
<span class="line-added">+         var testComment = pr.addComment(&quot;/test&quot;);</span>
<span class="line-added">+ </span>
<span class="line-added">+         var seenTestComment = false;</span>
<span class="line-added">+         for (var i = 0; i &lt; 90; i++) {</span>
<span class="line-added">+             var comments = pr.comments();</span>
<span class="line-added">+             for (var comment : comments) {</span>
<span class="line-added">+                 if (!seenTestComment) {</span>
<span class="line-added">+                     if (comment.id().equals(testComment.id())) {</span>
<span class="line-added">+                         seenTestComment = true;</span>
<span class="line-added">+                     }</span>
                      continue;
                  }
<span class="line-modified">!                 var lines = comment.body().split(&quot;\n&quot;);</span>
<span class="line-modified">!                 var n = lines.length;</span>
<span class="line-modified">!                 if (n &gt; 0) {</span>
<span class="line-modified">!                     if (n == 4 &amp;&amp;</span>
<span class="line-added">+                         lines[0].equals(&quot;&lt;!-- TEST STARTED --&gt;&quot;) &amp;&amp;</span>
<span class="line-added">+                         lines[1].startsWith(&quot;&lt;!-- github.com-&quot;) &amp;&amp;</span>
<span class="line-added">+                         lines[2].equals(&quot;&lt;!-- &quot; + head.hex() + &quot; --&gt;&quot;)) {</span>
<span class="line-added">+                         var output = removeTrailing(lines[3], &quot;.&quot;);</span>
<span class="line-added">+                         System.out.println(output);</span>
<span class="line-added">+                         System.exit(0);</span>
<span class="line-added">+                     } else if (n == 2 &amp;&amp;</span>
<span class="line-added">+                                lines[0].equals(&quot;&lt;!-- TEST ERROR --&gt;&quot;)) {</span>
<span class="line-added">+                         var output = removeTrailing(lines[1], &quot;.&quot;);</span>
<span class="line-added">+                         System.out.println(output);</span>
<span class="line-added">+                         System.exit(1);</span>
<span class="line-added">+                     } else if (n == 4 &amp;&amp;</span>
<span class="line-added">+                                lines[0].equals(&quot;&lt;!-- TEST PENDING --&gt;&quot;) &amp;&amp;</span>
<span class="line-added">+                                lines[1].equals(&quot;&lt;!--- &quot; + head.hex() + &quot; --&gt;&quot;)) {</span>
<span class="line-added">+                         var output = removeTrailing(lines[3], &quot;.&quot;);</span>
<span class="line-added">+                         System.out.println(output);</span>
<span class="line-added">+                         System.exit(0);</span>
<span class="line-added">+                     }</span>
                  }
<span class="line-added">+             }</span>
  
<span class="line-modified">!             Thread.sleep(2000);</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!     }</span>
  
<span class="line-added">+     private static void approve(String[] args) throws IOException, InterruptedException {</span>
<span class="line-added">+         var flags = List.of(</span>
<span class="line-added">+             Option.shortcut(&quot;u&quot;)</span>
<span class="line-added">+                   .fullname(&quot;username&quot;)</span>
<span class="line-added">+                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Username on host&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Option.shortcut(&quot;r&quot;)</span>
<span class="line-added">+                   .fullname(&quot;remote&quot;)</span>
<span class="line-added">+                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;verbose&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Turn on verbose output&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;debug&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Turn on debugging output&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;version&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Print the version of this tool&quot;)</span>
<span class="line-added">+                   .optional()</span>
<span class="line-added">+         );</span>
  
<span class="line-modified">!         var inputs = List.of(</span>
<span class="line-modified">!             Input.position(0)</span>
<span class="line-modified">!                  .describe(&quot;ID&quot;)</span>
<span class="line-modified">!                  .singular()</span>
<span class="line-modified">!                  .optional()</span>
<span class="line-modified">!         );</span>
<span class="line-added">+         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);</span>
<span class="line-added">+         var arguments = parse(parser, args);</span>
<span class="line-added">+         var repo = getRepo();</span>
<span class="line-added">+         var uri = getURI(repo, arguments);</span>
<span class="line-added">+         var host = getForge(uri, repo, arguments);</span>
<span class="line-added">+         var id = pullRequestIdArgument(repo, arguments);</span>
<span class="line-added">+         var pr = getPullRequest(uri, repo, host, id);</span>
<span class="line-added">+         pr.addReview(Review.Verdict.APPROVED, &quot;Looks good!&quot;);</span>
<span class="line-added">+     }</span>
  
<span class="line-modified">!     private static void list(String[] args) throws IOException, InterruptedException {</span>
<span class="line-modified">!         var flags = List.of(</span>
<span class="line-modified">!             Option.shortcut(&quot;u&quot;)</span>
<span class="line-modified">!                   .fullname(&quot;username&quot;)</span>
<span class="line-modified">!                   .describe(&quot;NAME&quot;)</span>
<span class="line-modified">!                   .helptext(&quot;Username on host&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Option.shortcut(&quot;r&quot;)</span>
<span class="line-added">+                   .fullname(&quot;remote&quot;)</span>
<span class="line-added">+                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Option.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;authors&quot;)</span>
<span class="line-added">+                   .describe(&quot;LIST&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Comma separated list of authors&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Option.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;assignees&quot;)</span>
<span class="line-added">+                   .describe(&quot;LIST&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Comma separated list of assignees&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Option.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;labels&quot;)</span>
<span class="line-added">+                   .describe(&quot;LIST&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Comma separated list of labels&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Option.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;issues&quot;)</span>
<span class="line-added">+                   .describe(&quot;LIST&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Comma separated list of issues&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Option.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;columns&quot;)</span>
<span class="line-added">+                   .describe(&quot;id,title,author,assignees,labels&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Comma separated list of columns to show&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;no-decoration&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Hide any decorations when listing PRs&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;no-draft&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Hide all pull requests in draft state&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;no-token&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Do not use a personal access token (PAT)&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;verbose&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Turn on verbose output&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;debug&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Turn on debugging output&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;version&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Print the version of this tool&quot;)</span>
<span class="line-added">+                   .optional());</span>
  
<span class="line-modified">!         var inputs = List.of(</span>
<span class="line-modified">!             Input.position(0)</span>
<span class="line-modified">!                  .describe(&quot;ID&quot;)</span>
<span class="line-modified">!                  .singular()</span>
<span class="line-modified">!                  .optional()</span>
<span class="line-added">+         );</span>
<span class="line-added">+ </span>
<span class="line-added">+         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);</span>
<span class="line-added">+         var arguments = parse(parser, args);</span>
<span class="line-added">+         var repo = getRepo();</span>
<span class="line-added">+         var uri = getURI(repo, arguments);</span>
<span class="line-added">+         var host = getForge(uri, repo, arguments);</span>
<span class="line-added">+         var remoteRepo = getHostedRepositoryFor(uri, repo, host);</span>
<span class="line-added">+ </span>
<span class="line-added">+         var prs = remoteRepo.pullRequests();</span>
<span class="line-added">+         var ids = new ArrayList&lt;String&gt;();</span>
<span class="line-added">+         var titles = new ArrayList&lt;String&gt;();</span>
<span class="line-added">+         var authors = new ArrayList&lt;String&gt;();</span>
<span class="line-added">+         var assignees = new ArrayList&lt;String&gt;();</span>
<span class="line-added">+         var labels = new ArrayList&lt;String&gt;();</span>
<span class="line-added">+         var issues = new ArrayList&lt;String&gt;();</span>
<span class="line-added">+         var branches = new ArrayList&lt;String&gt;();</span>
<span class="line-added">+         var statuses = new ArrayList&lt;String&gt;();</span>
<span class="line-added">+         var noDraft = getSwitch(&quot;no-draft&quot;, &quot;list&quot;, arguments);</span>
<span class="line-added">+ </span>
<span class="line-added">+         var authorsOption = getOption(&quot;authors&quot;, &quot;list&quot;, arguments);</span>
<span class="line-added">+         var filterAuthors = authorsOption == null ?</span>
<span class="line-added">+             Set.of() :</span>
<span class="line-added">+             new HashSet&lt;&gt;(Arrays.asList(authorsOption.split(&quot;,&quot;)));</span>
<span class="line-added">+ </span>
<span class="line-added">+         var assigneesOption = getOption(&quot;assignees&quot;, &quot;list&quot;, arguments);</span>
<span class="line-added">+         var filterAssignees = assigneesOption == null ?</span>
<span class="line-added">+             Set.of() :</span>
<span class="line-added">+             Arrays.asList(assigneesOption.split(&quot;,&quot;));</span>
<span class="line-added">+ </span>
<span class="line-added">+         var labelsOption = getOption(&quot;labels&quot;, &quot;list&quot;, arguments);</span>
<span class="line-added">+         var filterLabels = labelsOption == null ?</span>
<span class="line-added">+             Set.of() :</span>
<span class="line-added">+             Arrays.asList(labelsOption.split(&quot;,&quot;));</span>
<span class="line-added">+ </span>
<span class="line-added">+         var issuesOption = getOption(&quot;issues&quot;, &quot;list&quot;, arguments);</span>
<span class="line-added">+         var filterIssues = issuesOption == null ?</span>
<span class="line-added">+             Set.of() :</span>
<span class="line-added">+             Arrays.asList(issuesOption.split(&quot;,&quot;));</span>
<span class="line-added">+ </span>
<span class="line-added">+         var columnTitles = List.of(&quot;id&quot;, &quot;title&quot;, &quot;authors&quot;, &quot;assignees&quot;, &quot;labels&quot;, &quot;issues&quot;, &quot;branch&quot;, &quot;status&quot;);</span>
<span class="line-added">+         var columnValues = Map.of(columnTitles.get(0), ids,</span>
<span class="line-added">+                                   columnTitles.get(1), titles,</span>
<span class="line-added">+                                   columnTitles.get(2), authors,</span>
<span class="line-added">+                                   columnTitles.get(3), assignees,</span>
<span class="line-added">+                                   columnTitles.get(4), labels,</span>
<span class="line-added">+                                   columnTitles.get(5), issues,</span>
<span class="line-added">+                                   columnTitles.get(6), branches,</span>
<span class="line-added">+                                   columnTitles.get(7), statuses);</span>
<span class="line-added">+         var columnsOption = getOption(&quot;columns&quot;, &quot;list&quot;, arguments);</span>
<span class="line-added">+         var columns = columnsOption == null ?</span>
<span class="line-added">+             List.of(&quot;id&quot;, &quot;title&quot;, &quot;authors&quot;, &quot;status&quot;) :</span>
<span class="line-added">+             Arrays.asList(columnsOption.split(&quot;,&quot;));</span>
<span class="line-added">+ </span>
<span class="line-added">+         for (var column : columns) {</span>
<span class="line-added">+             if (!columnTitles.contains(column)) {</span>
<span class="line-added">+                 System.err.println(&quot;error: unknown column: &quot; + column);</span>
<span class="line-added">+                 System.err.println(&quot;       available columns are: &quot; + String.join(&quot;,&quot;, columnTitles));</span>
<span class="line-added">+                 System.exit(1);</span>
              }
<span class="line-added">+         }</span>
  
<span class="line-added">+         for (var pr : prs) {</span>
<span class="line-added">+             if (pr.isDraft() &amp;&amp; noDraft) {</span>
<span class="line-added">+                 continue;</span>
<span class="line-added">+             }</span>
  
<span class="line-modified">!             var prAuthor = pr.author().userName();</span>
<span class="line-modified">!             if (!filterAuthors.isEmpty() &amp;&amp; !filterAuthors.contains(prAuthor)) {</span>
<span class="line-modified">!                 continue;</span>
              }
<span class="line-modified">! </span>
<span class="line-modified">!             var prAssignees = pr.assignees().stream()</span>
<span class="line-modified">!                                 .map(HostUser::userName)</span>
<span class="line-modified">!                                 .collect(Collectors.toSet());</span>
<span class="line-modified">!             if (!filterAssignees.isEmpty() &amp;&amp; !filterAssignees.stream().anyMatch(prAssignees::contains)) {</span>
<span class="line-modified">!                 continue;</span>
              }
<span class="line-modified">! </span>
<span class="line-modified">!             var prLabels = new HashSet&lt;&gt;(pr.labels());</span>
<span class="line-modified">!             if (!filterLabels.isEmpty() &amp;&amp; !filterLabels.stream().anyMatch(prLabels::contains)) {</span>
<span class="line-modified">!                 continue;</span>
              }
<span class="line-modified">! </span>
<span class="line-modified">!             var prIssues = new HashSet&lt;&gt;(issuesFromPullRequest(pr));</span>
<span class="line-modified">!             if (!filterIssues.isEmpty() &amp;&amp; !filterIssues.stream().anyMatch(prIssues::contains)) {</span>
<span class="line-modified">!                 continue;</span>
              }
  
  
<span class="line-modified">!             ids.add(pr.id());</span>
<span class="line-modified">!             titles.add(pr.title());</span>
<span class="line-added">+             authors.add(prAuthor);</span>
<span class="line-added">+             assignees.add(String.join(&quot;,&quot;, prAssignees));</span>
<span class="line-added">+             labels.add(String.join(&quot;,&quot;, prLabels));</span>
<span class="line-added">+             issues.add(String.join(&quot;,&quot;, prIssues));</span>
  
<span class="line-modified">!             if (pr.sourceRepository().webUrl().equals(uri)) {</span>
<span class="line-modified">!                 branches.add(pr.sourceRef());</span>
<span class="line-modified">!             } else {</span>
<span class="line-modified">!                 branches.add(&quot;&quot;);</span>
              }
  
<span class="line-modified">!             if (columns.contains(&quot;status&quot;)) {</span>
<span class="line-modified">!                 statuses.add(statusForPullRequest(pr).toLowerCase());</span>
<span class="line-modified">!             } else {</span>
<span class="line-modified">!                 statuses.add(&quot;&quot;);</span>
              }
<span class="line-added">+         }</span>
  
<span class="line-modified">! </span>
<span class="line-modified">!         String fmt = &quot;&quot;;</span>
<span class="line-modified">!         for (var column : columns.subList(0, columns.size() - 1)) {</span>
<span class="line-modified">!             var values = columnValues.get(column);</span>
<span class="line-modified">!             var n = Math.max(column.length(), longest(values));</span>
<span class="line-modified">!             fmt += &quot;%-&quot; + n + &quot;s    &quot;;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         fmt += &quot;%s\n&quot;;</span>
<span class="line-modified">! </span>
<span class="line-modified">!         var noDecoration = getSwitch(&quot;no-decoration&quot;, &quot;list&quot;, arguments);</span>
<span class="line-modified">!         if (!ids.isEmpty() &amp;&amp; !noDecoration) {</span>
<span class="line-modified">!             var upperCase = columns.stream()</span>
<span class="line-modified">!                                    .map(String::toUpperCase)</span>
<span class="line-modified">!                                    .collect(Collectors.toList());</span>
<span class="line-modified">!             System.out.format(fmt, (Object[]) upperCase.toArray(new String[0]));</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         for (var i = 0; i &lt; ids.size(); i++) {</span>
<span class="line-modified">!             final int n = i;</span>
<span class="line-modified">!             var row = columns.stream()</span>
<span class="line-modified">!                              .map(columnValues::get)</span>
<span class="line-modified">!                              .map(values -&gt; values.get(n))</span>
<span class="line-modified">!                              .collect(Collectors.toList());</span>
<span class="line-modified">!             System.out.format(fmt, (Object[]) row.toArray(new String[0]));</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!     }</span>
<span class="line-modified">! </span>
<span class="line-modified">!     private static void close(String[] args) throws IOException, InterruptedException {</span>
<span class="line-modified">!         var flags = List.of(</span>
<span class="line-modified">!             Option.shortcut(&quot;u&quot;)</span>
<span class="line-modified">!                   .fullname(&quot;username&quot;)</span>
<span class="line-modified">!                   .describe(&quot;NAME&quot;)</span>
<span class="line-modified">!                   .helptext(&quot;Username on host&quot;)</span>
<span class="line-modified">!                   .optional(),</span>
<span class="line-added">+             Option.shortcut(&quot;r&quot;)</span>
<span class="line-added">+                   .fullname(&quot;remote&quot;)</span>
<span class="line-added">+                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;verbose&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Turn on verbose output&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;debug&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Turn on debugging output&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;version&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Print the version of this tool&quot;)</span>
<span class="line-added">+                   .optional()</span>
<span class="line-added">+         );</span>
<span class="line-added">+ </span>
<span class="line-added">+         var inputs = List.of(</span>
<span class="line-added">+             Input.position(0)</span>
<span class="line-added">+                  .describe(&quot;ID&quot;)</span>
<span class="line-added">+                  .singular()</span>
<span class="line-added">+                  .optional()</span>
<span class="line-added">+         );</span>
<span class="line-added">+ </span>
<span class="line-added">+         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);</span>
<span class="line-added">+         var arguments = parse(parser, args);</span>
<span class="line-added">+         var repo = getRepo();</span>
<span class="line-added">+         var uri = getURI(repo, arguments);</span>
<span class="line-added">+         var host = getForge(uri, repo, arguments);</span>
<span class="line-added">+         var id = pullRequestIdArgument(repo, arguments);</span>
<span class="line-added">+         var pr = getPullRequest(uri, repo, host, id);</span>
<span class="line-added">+ </span>
<span class="line-added">+         pr.setState(PullRequest.State.CLOSED);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     private static void set(String[] args) throws IOException, InterruptedException {</span>
<span class="line-added">+         var flags = List.of(</span>
<span class="line-added">+             Option.shortcut(&quot;u&quot;)</span>
<span class="line-added">+                   .fullname(&quot;username&quot;)</span>
<span class="line-added">+                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Username on host&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Option.shortcut(&quot;r&quot;)</span>
<span class="line-added">+                   .fullname(&quot;remote&quot;)</span>
<span class="line-added">+                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Option.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;assignees&quot;)</span>
<span class="line-added">+                   .describe(&quot;LIST&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Comma separated list of assignees&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;verbose&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Turn on verbose output&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;debug&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Turn on debugging output&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;version&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Print the version of this tool&quot;)</span>
<span class="line-added">+                   .optional()</span>
<span class="line-added">+         );</span>
<span class="line-added">+ </span>
<span class="line-added">+         var inputs = List.of(</span>
<span class="line-added">+             Input.position(0)</span>
<span class="line-added">+                  .describe(&quot;ID&quot;)</span>
<span class="line-added">+                  .singular()</span>
<span class="line-added">+                  .optional()</span>
<span class="line-added">+         );</span>
<span class="line-added">+ </span>
<span class="line-added">+         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);</span>
<span class="line-added">+         var arguments = parse(parser, args);</span>
<span class="line-added">+         var repo = getRepo();</span>
<span class="line-added">+         var uri = getURI(repo, arguments);</span>
<span class="line-added">+         var host = getForge(uri, repo, arguments);</span>
<span class="line-added">+         var id = pullRequestIdArgument(repo, arguments);</span>
<span class="line-added">+         var pr = getPullRequest(uri, repo, host, id);</span>
<span class="line-added">+ </span>
<span class="line-added">+         var assigneesOption = getOption(&quot;assignees&quot;, &quot;set&quot;, arguments);</span>
<span class="line-added">+         if (assigneesOption != null) {</span>
<span class="line-added">+             var usernames = Arrays.asList(assigneesOption.split(&quot;,&quot;));</span>
<span class="line-added">+             var assignees = usernames.stream()</span>
<span class="line-added">+                 .map(u -&gt; host.user(u))</span>
<span class="line-added">+                 .filter(Optional::isPresent)</span>
<span class="line-added">+                 .map(Optional::get)</span>
<span class="line-added">+                 .collect(Collectors.toList());</span>
<span class="line-added">+             pr.setAssignees(assignees);</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     private static void status(String[] args) throws IOException, InterruptedException {</span>
<span class="line-added">+         var flags = List.of(</span>
<span class="line-added">+             Option.shortcut(&quot;u&quot;)</span>
<span class="line-added">+                   .fullname(&quot;username&quot;)</span>
<span class="line-added">+                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Username on host&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Option.shortcut(&quot;r&quot;)</span>
<span class="line-added">+                   .fullname(&quot;remote&quot;)</span>
<span class="line-added">+                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;no-decoration&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Hide any decorations when listing PRs&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;no-token&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Do not use a personal access token (PAT)&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;no-checks&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Do not show check status as part of the &#39;git pr status&#39; output&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;verbose&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Turn on verbose output&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;debug&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Turn on debugging output&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;version&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Print the version of this tool&quot;)</span>
<span class="line-added">+                   .optional()</span>
<span class="line-added">+         );</span>
<span class="line-added">+ </span>
<span class="line-added">+         var inputs = List.of(</span>
<span class="line-added">+             Input.position(0)</span>
<span class="line-added">+                  .describe(&quot;ID&quot;)</span>
<span class="line-added">+                  .singular()</span>
<span class="line-added">+                  .optional()</span>
<span class="line-added">+         );</span>
<span class="line-added">+ </span>
<span class="line-added">+         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);</span>
<span class="line-added">+         var arguments = parse(parser, args);</span>
<span class="line-added">+         var repo = getRepo();</span>
<span class="line-added">+         var uri = getURI(repo, arguments);</span>
<span class="line-added">+         var host = getForge(uri, repo, arguments);</span>
<span class="line-added">+         var id = pullRequestIdArgument(repo, arguments);</span>
<span class="line-added">+         var pr = getPullRequest(uri, repo, host, id);</span>
<span class="line-added">+ </span>
<span class="line-added">+         var noDecoration = getSwitch(&quot;no-decoration&quot;, &quot;status&quot;, arguments);</span>
<span class="line-added">+         var decoration = noDecoration ? &quot;&quot; : &quot;Status: &quot;;</span>
<span class="line-added">+         System.out.println(decoration + statusForPullRequest(pr));</span>
<span class="line-added">+ </span>
<span class="line-added">+         var noChecks = getSwitch(&quot;no-checks&quot;, &quot;status&quot;, arguments);</span>
<span class="line-added">+         if (!noChecks) {</span>
<span class="line-added">+             var checks = pr.checks(pr.headHash());</span>
<span class="line-added">+             var jcheck = Optional.ofNullable(checks.get(&quot;jcheck&quot;));</span>
<span class="line-added">+             var submit = Optional.ofNullable(checks.get(&quot;submit&quot;));</span>
<span class="line-added">+             var showChecks = jcheck.isPresent() || submit.isPresent();</span>
<span class="line-added">+             if (showChecks) {</span>
<span class="line-added">+                 System.out.println(&quot;Checks:&quot;);</span>
<span class="line-added">+                 if (jcheck.isPresent()) {</span>
<span class="line-added">+                     System.out.println(&quot;- jcheck: &quot; + statusForCheck(jcheck.get()));</span>
<span class="line-added">+                 }</span>
<span class="line-added">+                 if (submit.isPresent()) {</span>
<span class="line-added">+                     System.out.println(&quot;- submit: &quot; + statusForCheck(submit.get()));</span>
                  }
              }
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     private static void fetch(String[] args) throws IOException, InterruptedException {</span>
<span class="line-added">+         var flags = List.of(</span>
<span class="line-added">+             Option.shortcut(&quot;u&quot;)</span>
<span class="line-added">+                   .fullname(&quot;username&quot;)</span>
<span class="line-added">+                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Username on host&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Option.shortcut(&quot;r&quot;)</span>
<span class="line-added">+                   .fullname(&quot;remote&quot;)</span>
<span class="line-added">+                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Option.shortcut(&quot;b&quot;)</span>
<span class="line-added">+                   .fullname(&quot;branch&quot;)</span>
<span class="line-added">+                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Name of target branch, defaults to &#39;master&#39;&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;no-token&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Do not use a personal access token (PAT)&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;verbose&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Turn on verbose output&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;debug&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Turn on debugging output&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;version&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Print the version of this tool&quot;)</span>
<span class="line-added">+                   .optional()</span>
<span class="line-added">+         );</span>
<span class="line-added">+ </span>
<span class="line-added">+         var inputs = List.of(</span>
<span class="line-added">+             Input.position(0)</span>
<span class="line-added">+                  .describe(&quot;ID&quot;)</span>
<span class="line-added">+                  .singular()</span>
<span class="line-added">+                  .optional()</span>
<span class="line-added">+         );</span>
<span class="line-added">+ </span>
<span class="line-added">+         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);</span>
<span class="line-added">+         var arguments = parse(parser, args);</span>
<span class="line-added">+         var repo = getRepo();</span>
<span class="line-added">+         var uri = getURI(repo, arguments);</span>
<span class="line-added">+         var host = getForge(uri, repo, arguments);</span>
<span class="line-added">+         var id = pullRequestIdArgument(repo, arguments);</span>
<span class="line-added">+         var pr = getPullRequest(uri, repo, host, id);</span>
<span class="line-added">+ </span>
<span class="line-added">+         var fetchHead = repo.fetch(pr.repository().webUrl(), pr.fetchRef());</span>
<span class="line-added">+         var branchName = getOption(&quot;branch&quot;, &quot;fetch&quot;, arguments);</span>
<span class="line-added">+         if (branchName != null) {</span>
<span class="line-added">+             repo.branch(fetchHead, branchName);</span>
<span class="line-added">+         } else {</span>
<span class="line-added">+             System.out.println(fetchHead.hex());</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     private static void show(String[] args) throws IOException, InterruptedException {</span>
<span class="line-added">+         var flags = List.of(</span>
<span class="line-added">+             Option.shortcut(&quot;u&quot;)</span>
<span class="line-added">+                   .fullname(&quot;username&quot;)</span>
<span class="line-added">+                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Username on host&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Option.shortcut(&quot;r&quot;)</span>
<span class="line-added">+                   .fullname(&quot;remote&quot;)</span>
<span class="line-added">+                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;no-token&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Do not use a personal access token (PAT)&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;verbose&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Turn on verbose output&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;debug&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Turn on debugging output&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;version&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Print the version of this tool&quot;)</span>
<span class="line-added">+                   .optional()</span>
<span class="line-added">+         );</span>
<span class="line-added">+ </span>
<span class="line-added">+         var inputs = List.of(</span>
<span class="line-added">+             Input.position(0)</span>
<span class="line-added">+                  .describe(&quot;ID&quot;)</span>
<span class="line-added">+                  .singular()</span>
<span class="line-added">+                  .optional()</span>
<span class="line-added">+         );</span>
<span class="line-added">+ </span>
<span class="line-added">+         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);</span>
<span class="line-added">+         var arguments = parse(parser, args);</span>
<span class="line-added">+         var repo = getRepo();</span>
<span class="line-added">+         var uri = getURI(repo, arguments);</span>
<span class="line-added">+         var host = getForge(uri, repo, arguments);</span>
<span class="line-added">+         var id = pullRequestIdArgument(repo, arguments);</span>
<span class="line-added">+         var pr = getPullRequest(uri, repo, host, id);</span>
<span class="line-added">+ </span>
<span class="line-added">+         var fetchHead = repo.fetch(pr.repository().webUrl(), pr.fetchRef());</span>
<span class="line-added">+         show(pr.targetRef(), fetchHead);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     private static void checkout(String[] args) throws IOException, InterruptedException {</span>
<span class="line-added">+         var flags = List.of(</span>
<span class="line-added">+             Option.shortcut(&quot;u&quot;)</span>
<span class="line-added">+                   .fullname(&quot;username&quot;)</span>
<span class="line-added">+                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Username on host&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Option.shortcut(&quot;r&quot;)</span>
<span class="line-added">+                   .fullname(&quot;remote&quot;)</span>
<span class="line-added">+                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Option.shortcut(&quot;b&quot;)</span>
<span class="line-added">+                   .fullname(&quot;branch&quot;)</span>
<span class="line-added">+                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Name of target branch, defaults to &#39;master&#39;&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;no-token&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Do not use a personal access token (PAT)&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;verbose&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Turn on verbose output&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;debug&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Turn on debugging output&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;version&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Print the version of this tool&quot;)</span>
<span class="line-added">+                   .optional()</span>
<span class="line-added">+         );</span>
<span class="line-added">+ </span>
<span class="line-added">+         var inputs = List.of(</span>
<span class="line-added">+             Input.position(0)</span>
<span class="line-added">+                  .describe(&quot;ID&quot;)</span>
<span class="line-added">+                  .singular()</span>
<span class="line-added">+                  .optional()</span>
<span class="line-added">+         );</span>
<span class="line-added">+ </span>
<span class="line-added">+         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);</span>
<span class="line-added">+         var arguments = parse(parser, args);</span>
<span class="line-added">+         var repo = getRepo();</span>
<span class="line-added">+         var uri = getURI(repo, arguments);</span>
<span class="line-added">+         var host = getForge(uri, repo, arguments);</span>
<span class="line-added">+         var id = pullRequestIdArgument(repo, arguments);</span>
<span class="line-added">+         var pr = getPullRequest(uri, repo, host, id);</span>
<span class="line-added">+ </span>
<span class="line-added">+         var fetchHead = repo.fetch(pr.repository().webUrl(), pr.fetchRef());</span>
<span class="line-added">+         var branchName = getOption(&quot;branch&quot;, &quot;checkout&quot;, arguments);</span>
<span class="line-added">+         if (branchName != null) {</span>
<span class="line-added">+             var branch = repo.branch(fetchHead, branchName);</span>
<span class="line-added">+             repo.checkout(branch, false);</span>
          } else {
<span class="line-modified">!             repo.checkout(fetchHead, false);</span>
          }
      }
<span class="line-added">+ </span>
<span class="line-added">+     private static void apply(String[] args) throws IOException, InterruptedException {</span>
<span class="line-added">+         var flags = List.of(</span>
<span class="line-added">+             Option.shortcut(&quot;u&quot;)</span>
<span class="line-added">+                   .fullname(&quot;username&quot;)</span>
<span class="line-added">+                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Username on host&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Option.shortcut(&quot;r&quot;)</span>
<span class="line-added">+                   .fullname(&quot;remote&quot;)</span>
<span class="line-added">+                   .describe(&quot;NAME&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;no-token&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Do not use a personal access token (PAT)&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;verbose&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Turn on verbose output&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;debug&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Turn on debugging output&quot;)</span>
<span class="line-added">+                   .optional(),</span>
<span class="line-added">+             Switch.shortcut(&quot;&quot;)</span>
<span class="line-added">+                   .fullname(&quot;version&quot;)</span>
<span class="line-added">+                   .helptext(&quot;Print the version of this tool&quot;)</span>
<span class="line-added">+                   .optional()</span>
<span class="line-added">+         );</span>
<span class="line-added">+ </span>
<span class="line-added">+         var inputs = List.of(</span>
<span class="line-added">+             Input.position(0)</span>
<span class="line-added">+                  .describe(&quot;ID&quot;)</span>
<span class="line-added">+                  .singular()</span>
<span class="line-added">+                  .optional()</span>
<span class="line-added">+         );</span>
<span class="line-added">+ </span>
<span class="line-added">+         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);</span>
<span class="line-added">+         var arguments = parse(parser, args);</span>
<span class="line-added">+         var repo = getRepo();</span>
<span class="line-added">+         var uri = getURI(repo, arguments);</span>
<span class="line-added">+         var host = getForge(uri, repo, arguments);</span>
<span class="line-added">+         var id = pullRequestIdArgument(repo, arguments);</span>
<span class="line-added">+         var pr = getPullRequest(uri, repo, host, id);</span>
<span class="line-added">+ </span>
<span class="line-added">+         var fetchHead = repo.fetch(pr.repository().webUrl(), pr.fetchRef());</span>
<span class="line-added">+         var patch = diff(pr.targetRef(), fetchHead);</span>
<span class="line-added">+         apply(patch);</span>
<span class="line-added">+         Files.deleteIfExists(patch);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     public static void main(String[] args) throws Exception {</span>
<span class="line-added">+         var commands = List.of(</span>
<span class="line-added">+                     Default.name(&quot;list&quot;)</span>
<span class="line-added">+                            .helptext(&quot;list open pull requests&quot;)</span>
<span class="line-added">+                            .main(GitPr::list),</span>
<span class="line-added">+                     Command.name(&quot;fetch&quot;)</span>
<span class="line-added">+                            .helptext(&quot;fetch a pull request&quot;)</span>
<span class="line-added">+                            .main(GitPr::fetch),</span>
<span class="line-added">+                     Command.name(&quot;show&quot;)</span>
<span class="line-added">+                            .helptext(&quot;show a pull request&quot;)</span>
<span class="line-added">+                            .main(GitPr::show),</span>
<span class="line-added">+                     Command.name(&quot;checkout&quot;)</span>
<span class="line-added">+                            .helptext(&quot;checkout a pull request&quot;)</span>
<span class="line-added">+                            .main(GitPr::checkout),</span>
<span class="line-added">+                     Command.name(&quot;apply&quot;)</span>
<span class="line-added">+                            .helptext(&quot;apply a pull request&quot;)</span>
<span class="line-added">+                            .main(GitPr::apply),</span>
<span class="line-added">+                     Command.name(&quot;integrate&quot;)</span>
<span class="line-added">+                            .helptext(&quot;integrate a pull request&quot;)</span>
<span class="line-added">+                            .main(GitPr::integrate),</span>
<span class="line-added">+                     Command.name(&quot;approve&quot;)</span>
<span class="line-added">+                            .helptext(&quot;approve a pull request&quot;)</span>
<span class="line-added">+                            .main(GitPr::approve),</span>
<span class="line-added">+                     Command.name(&quot;create&quot;)</span>
<span class="line-added">+                            .helptext(&quot;create a pull request&quot;)</span>
<span class="line-added">+                            .main(GitPr::create),</span>
<span class="line-added">+                     Command.name(&quot;close&quot;)</span>
<span class="line-added">+                            .helptext(&quot;close a pull request&quot;)</span>
<span class="line-added">+                            .main(GitPr::close),</span>
<span class="line-added">+                     Command.name(&quot;set&quot;)</span>
<span class="line-added">+                            .helptext(&quot;set properties of a pull request&quot;)</span>
<span class="line-added">+                            .main(GitPr::set),</span>
<span class="line-added">+                     Command.name(&quot;test&quot;)</span>
<span class="line-added">+                            .helptext(&quot;test a pull request&quot;)</span>
<span class="line-added">+                            .main(GitPr::test),</span>
<span class="line-added">+                     Command.name(&quot;status&quot;)</span>
<span class="line-added">+                            .helptext(&quot;show status of a pull request&quot;)</span>
<span class="line-added">+                            .main(GitPr::status)</span>
<span class="line-added">+         );</span>
<span class="line-added">+ </span>
<span class="line-added">+         HttpProxy.setup();</span>
<span class="line-added">+ </span>
<span class="line-added">+         var parser = new MultiCommandParser(&quot;git pr&quot;, commands);</span>
<span class="line-added">+         var command = parser.parse(args);</span>
<span class="line-added">+         command.execute();</span>
<span class="line-added">+     }</span>
  }
</pre>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>