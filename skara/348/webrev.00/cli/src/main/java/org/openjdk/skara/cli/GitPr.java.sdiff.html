<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff cli/src/main/java/org/openjdk/skara/cli/GitPr.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>cli/src/main/java/org/openjdk/skara/cli/GitPr.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 423                                                    ref + &quot;...&quot; + hash.hex());
 424         if (dir != null) {
 425             pb.directory(dir.toFile());
 426         }
 427         pb.redirectOutput(patch.toFile());
 428         pb.redirectError(ProcessBuilder.Redirect.INHERIT);
 429         await(pb.start());
 430         return patch;
 431     }
 432 
 433     private static void apply(Path patch) throws IOException {
 434         var pb = new ProcessBuilder(&quot;git&quot;, &quot;apply&quot;, &quot;--no-commit&quot;, patch.toString());
 435         pb.inheritIO();
 436         await(pb.start());
 437     }
 438 
 439     private static int longest(List&lt;String&gt; strings) {
 440         return strings.stream().mapToInt(String::length).max().orElse(0);
 441     }
 442 






 443     public static void main(String[] args) throws IOException, InterruptedException {
 444         var flags = List.of(
 445             Option.shortcut(&quot;u&quot;)
 446                   .fullname(&quot;username&quot;)
 447                   .describe(&quot;NAME&quot;)
 448                   .helptext(&quot;Username on host&quot;)
 449                   .optional(),
 450             Option.shortcut(&quot;r&quot;)
 451                   .fullname(&quot;remote&quot;)
 452                   .describe(&quot;NAME&quot;)
 453                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)
 454                   .optional(),
 455             Option.shortcut(&quot;b&quot;)
 456                   .fullname(&quot;branch&quot;)
 457                   .describe(&quot;NAME&quot;)
 458                   .helptext(&quot;Name of target branch, defaults to &#39;master&#39;&quot;)
 459                   .optional(),
 460             Option.shortcut(&quot;&quot;)
 461                   .fullname(&quot;authors&quot;)
 462                   .describe(&quot;LIST&quot;)
</pre>
<hr />
<pre>
 980                             .stream()
 981                             .dropWhile(String::isEmpty)
 982                             .collect(Collectors.toList());
 983             } else {
 984                 body = Collections.emptyList();
 985             }
 986 
 987             var pr = remoteRepo.createPullRequest(parentRepo, targetBranch, currentBranch.name(), title, body);
 988             var assigneesOption = getOption(&quot;assignees&quot;, &quot;create&quot;, arguments);
 989             if (assigneesOption != null) {
 990                 var usernames = Arrays.asList(assigneesOption.split(&quot;,&quot;));
 991                 var assignees = usernames.stream()
 992                                          .map(u -&gt; host.user(u))
 993                                          .collect(Collectors.toList());
 994                 pr.setAssignees(assignees);
 995             }
 996             System.out.println(pr.webUrl().toString());
 997             Files.deleteIfExists(file);
 998 
 999             repo.config(&quot;pr.&quot; + currentBranch.name(), &quot;id&quot;, pr.id().toString());
<span class="line-modified">1000         } else if (action.equals(&quot;integrate&quot;) || action.equals(&quot;test&quot;)) {</span>
1001             var id = pullRequestIdArgument(arguments, repo);
1002             var pr = getPullRequest(uri, repo, host, id);






















1003 
<span class="line-modified">1004             if (action.equals(&quot;integrate&quot;)) {</span>
<span class="line-removed">1005                 pr.addComment(&quot;/integrate&quot;);</span>
<span class="line-removed">1006             } else if (action.equals(&quot;test&quot;)) {</span>
<span class="line-removed">1007                 pr.addComment(&quot;/test&quot;);</span>
<span class="line-removed">1008             } else {</span>
<span class="line-removed">1009                 throw new IllegalStateException(&quot;unexpected action: &quot; + action);</span>
1010             }















































1011         } else if (action.equals(&quot;approve&quot;)) {
1012             var id = arguments.at(1).isPresent() ? arguments.at(1).asString() : null;
1013             if (id == null) {
1014                 exit(&quot;error: you must provide a pull request id&quot;);
1015             }
1016             var pr = getPullRequest(uri, repo, host, id);
1017             pr.addReview(Review.Verdict.APPROVED, &quot;Looks good!&quot;);
1018         } else if (action.equals(&quot;list&quot;)) {
1019             var remoteRepo = getHostedRepositoryFor(uri, repo, host);
1020             var prs = remoteRepo.pullRequests();
1021             var ids = new ArrayList&lt;String&gt;();
1022             var titles = new ArrayList&lt;String&gt;();
1023             var authors = new ArrayList&lt;String&gt;();
1024             var assignees = new ArrayList&lt;String&gt;();
1025             var labels = new ArrayList&lt;String&gt;();
1026             var issues = new ArrayList&lt;String&gt;();
1027             var branches = new ArrayList&lt;String&gt;();
1028             var statuses = new ArrayList&lt;String&gt;();
1029 
1030             var authorsOption = getOption(&quot;authors&quot;, &quot;list&quot;, arguments);
</pre>
<hr />
<pre>
1240             }
1241         } else if (action.equals(&quot;status&quot;)) {
1242             String id = pullRequestIdArgument(arguments, repo);
1243             var pr = getPullRequest(uri, repo, host, id);
1244             var noDecoration = getSwitch(&quot;no-decoration&quot;, &quot;status&quot;, arguments);
1245             var decoration = noDecoration ? &quot;&quot; : &quot;Status: &quot;;
1246             System.out.println(decoration + statusForPullRequest(pr));
1247 
1248             var noChecks = getSwitch(&quot;no-checks&quot;, &quot;status&quot;, arguments);
1249             if (!noChecks) {
1250                 var checks = pr.checks(pr.headHash());
1251                 var jcheck = Optional.ofNullable(checks.get(&quot;jcheck&quot;));
1252                 var submit = Optional.ofNullable(checks.get(&quot;submit&quot;));
1253                 var showChecks = jcheck.isPresent() || submit.isPresent();
1254                 if (showChecks) {
1255                     System.out.println(&quot;Checks:&quot;);
1256                     if (jcheck.isPresent()) {
1257                         System.out.println(&quot;- jcheck: &quot; + statusForCheck(jcheck.get()));
1258                     }
1259                     if (submit.isPresent()) {
<span class="line-modified">1260                         System.out.println(&quot;- jcheck: &quot; + statusForCheck(jcheck.get()));</span>
1261                     }
1262                 }
1263             }
1264         } else {
1265             exit(&quot;error: unexpected action: &quot; + action);
1266         }
1267     }
1268 }
</pre>
</td>
<td>
<hr />
<pre>
 423                                                    ref + &quot;...&quot; + hash.hex());
 424         if (dir != null) {
 425             pb.directory(dir.toFile());
 426         }
 427         pb.redirectOutput(patch.toFile());
 428         pb.redirectError(ProcessBuilder.Redirect.INHERIT);
 429         await(pb.start());
 430         return patch;
 431     }
 432 
 433     private static void apply(Path patch) throws IOException {
 434         var pb = new ProcessBuilder(&quot;git&quot;, &quot;apply&quot;, &quot;--no-commit&quot;, patch.toString());
 435         pb.inheritIO();
 436         await(pb.start());
 437     }
 438 
 439     private static int longest(List&lt;String&gt; strings) {
 440         return strings.stream().mapToInt(String::length).max().orElse(0);
 441     }
 442 
<span class="line-added"> 443     private static String removeTrailing(String s, String trail) {</span>
<span class="line-added"> 444         return s.endsWith(trail) ?</span>
<span class="line-added"> 445             s.substring(0, s.length() - trail.length()) :</span>
<span class="line-added"> 446             s;</span>
<span class="line-added"> 447     }</span>
<span class="line-added"> 448 </span>
 449     public static void main(String[] args) throws IOException, InterruptedException {
 450         var flags = List.of(
 451             Option.shortcut(&quot;u&quot;)
 452                   .fullname(&quot;username&quot;)
 453                   .describe(&quot;NAME&quot;)
 454                   .helptext(&quot;Username on host&quot;)
 455                   .optional(),
 456             Option.shortcut(&quot;r&quot;)
 457                   .fullname(&quot;remote&quot;)
 458                   .describe(&quot;NAME&quot;)
 459                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)
 460                   .optional(),
 461             Option.shortcut(&quot;b&quot;)
 462                   .fullname(&quot;branch&quot;)
 463                   .describe(&quot;NAME&quot;)
 464                   .helptext(&quot;Name of target branch, defaults to &#39;master&#39;&quot;)
 465                   .optional(),
 466             Option.shortcut(&quot;&quot;)
 467                   .fullname(&quot;authors&quot;)
 468                   .describe(&quot;LIST&quot;)
</pre>
<hr />
<pre>
 986                             .stream()
 987                             .dropWhile(String::isEmpty)
 988                             .collect(Collectors.toList());
 989             } else {
 990                 body = Collections.emptyList();
 991             }
 992 
 993             var pr = remoteRepo.createPullRequest(parentRepo, targetBranch, currentBranch.name(), title, body);
 994             var assigneesOption = getOption(&quot;assignees&quot;, &quot;create&quot;, arguments);
 995             if (assigneesOption != null) {
 996                 var usernames = Arrays.asList(assigneesOption.split(&quot;,&quot;));
 997                 var assignees = usernames.stream()
 998                                          .map(u -&gt; host.user(u))
 999                                          .collect(Collectors.toList());
1000                 pr.setAssignees(assignees);
1001             }
1002             System.out.println(pr.webUrl().toString());
1003             Files.deleteIfExists(file);
1004 
1005             repo.config(&quot;pr.&quot; + currentBranch.name(), &quot;id&quot;, pr.id().toString());
<span class="line-modified">1006         } else if (action.equals(&quot;integrate&quot;)) {</span>
1007             var id = pullRequestIdArgument(arguments, repo);
1008             var pr = getPullRequest(uri, repo, host, id);
<span class="line-added">1009             var integrateComment = pr.addComment(&quot;/integrate&quot;);</span>
<span class="line-added">1010 </span>
<span class="line-added">1011             var seenIntegrateComment = false;</span>
<span class="line-added">1012             var expected = &quot;&lt;!-- Jmerge command reply message (&quot; + integrateComment.id() + &quot;) --&gt;&quot;;</span>
<span class="line-added">1013             for (var i = 0; i &lt; 20; i++) {</span>
<span class="line-added">1014                 var comments = pr.comments();</span>
<span class="line-added">1015                 for (var comment : comments) {</span>
<span class="line-added">1016                     if (!seenIntegrateComment) {</span>
<span class="line-added">1017                         if (comment.id().equals(integrateComment.id())) {</span>
<span class="line-added">1018                             seenIntegrateComment = true;</span>
<span class="line-added">1019                         }</span>
<span class="line-added">1020                         continue;</span>
<span class="line-added">1021                     }</span>
<span class="line-added">1022                     var lines = comment.body().split(&quot;\n&quot;);</span>
<span class="line-added">1023                     if (lines.length &gt; 0 &amp;&amp; lines[0].equals(expected)) {</span>
<span class="line-added">1024                         if (lines.length == 3 &amp;&amp; lines[2].startsWith(&quot;Pushed as commit&quot;)) {</span>
<span class="line-added">1025                             var output = removeTrailing(lines[2], &quot;.&quot;);</span>
<span class="line-added">1026                             System.out.println(output);</span>
<span class="line-added">1027                             System.exit(0);</span>
<span class="line-added">1028                         }</span>
<span class="line-added">1029                     }</span>
<span class="line-added">1030                 }</span>
1031 
<span class="line-modified">1032                 Thread.sleep(1000);</span>





1033             }
<span class="line-added">1034 </span>
<span class="line-added">1035             System.err.println(&quot;error: timed out waiting for response to /integrate command&quot;);</span>
<span class="line-added">1036             System.exit(1);</span>
<span class="line-added">1037         } else if (action.equals(&quot;test&quot;)) {</span>
<span class="line-added">1038             var id = pullRequestIdArgument(arguments, repo);</span>
<span class="line-added">1039             var pr = getPullRequest(uri, repo, host, id);</span>
<span class="line-added">1040             var head = pr.headHash();</span>
<span class="line-added">1041             var testComment = pr.addComment(&quot;/test&quot;);</span>
<span class="line-added">1042 </span>
<span class="line-added">1043             var seenTestComment = false;</span>
<span class="line-added">1044             for (var i = 0; i &lt; 20; i++) {</span>
<span class="line-added">1045                 var comments = pr.comments();</span>
<span class="line-added">1046                 for (var comment : comments) {</span>
<span class="line-added">1047                     if (!seenTestComment) {</span>
<span class="line-added">1048                         if (comment.id().equals(testComment.id())) {</span>
<span class="line-added">1049                             seenTestComment = true;</span>
<span class="line-added">1050                         }</span>
<span class="line-added">1051                         continue;</span>
<span class="line-added">1052                     }</span>
<span class="line-added">1053                     var lines = comment.body().split(&quot;\n&quot;);</span>
<span class="line-added">1054                     var n = lines.length;</span>
<span class="line-added">1055                     if (n &gt; 0) {</span>
<span class="line-added">1056                         if (n == 4 &amp;&amp;</span>
<span class="line-added">1057                             lines[0].equals(&quot;&lt;!-- TEST STARTED --&gt;&quot;) &amp;&amp;</span>
<span class="line-added">1058                             lines[1].startsWith(&quot;&lt;!-- github.com-&quot;) &amp;&amp;</span>
<span class="line-added">1059                             lines[2].equals(&quot;&lt;!-- &quot; + head.hex() + &quot; --&gt;&quot;)) {</span>
<span class="line-added">1060                             var output = removeTrailing(lines[3], &quot;.&quot;);</span>
<span class="line-added">1061                             System.out.println(output);</span>
<span class="line-added">1062                             System.exit(0);</span>
<span class="line-added">1063                         } else if (n == 2 &amp;&amp;</span>
<span class="line-added">1064                                    lines[0].equals(&quot;&lt;!-- TEST ERROR --&gt;&quot;)) {</span>
<span class="line-added">1065                             var output = removeTrailing(lines[1], &quot;.&quot;);</span>
<span class="line-added">1066                             System.out.println(output);</span>
<span class="line-added">1067                             System.exit(1);</span>
<span class="line-added">1068                         } else if (n == 4 &amp;&amp;</span>
<span class="line-added">1069                                    lines[0].equals(&quot;&lt;!-- TEST PENDING --&gt;&quot;) &amp;&amp;</span>
<span class="line-added">1070                                    lines[1].equals(&quot;&lt;!--- &quot; + head.hex() + &quot; --&gt;&quot;)) {</span>
<span class="line-added">1071                             var output = removeTrailing(lines[3], &quot;.&quot;);</span>
<span class="line-added">1072                             System.out.println(output);</span>
<span class="line-added">1073                             System.exit(0);</span>
<span class="line-added">1074                         }</span>
<span class="line-added">1075                     }</span>
<span class="line-added">1076                 }</span>
<span class="line-added">1077 </span>
<span class="line-added">1078                 Thread.sleep(1000);</span>
<span class="line-added">1079             }</span>
<span class="line-added">1080 </span>
1081         } else if (action.equals(&quot;approve&quot;)) {
1082             var id = arguments.at(1).isPresent() ? arguments.at(1).asString() : null;
1083             if (id == null) {
1084                 exit(&quot;error: you must provide a pull request id&quot;);
1085             }
1086             var pr = getPullRequest(uri, repo, host, id);
1087             pr.addReview(Review.Verdict.APPROVED, &quot;Looks good!&quot;);
1088         } else if (action.equals(&quot;list&quot;)) {
1089             var remoteRepo = getHostedRepositoryFor(uri, repo, host);
1090             var prs = remoteRepo.pullRequests();
1091             var ids = new ArrayList&lt;String&gt;();
1092             var titles = new ArrayList&lt;String&gt;();
1093             var authors = new ArrayList&lt;String&gt;();
1094             var assignees = new ArrayList&lt;String&gt;();
1095             var labels = new ArrayList&lt;String&gt;();
1096             var issues = new ArrayList&lt;String&gt;();
1097             var branches = new ArrayList&lt;String&gt;();
1098             var statuses = new ArrayList&lt;String&gt;();
1099 
1100             var authorsOption = getOption(&quot;authors&quot;, &quot;list&quot;, arguments);
</pre>
<hr />
<pre>
1310             }
1311         } else if (action.equals(&quot;status&quot;)) {
1312             String id = pullRequestIdArgument(arguments, repo);
1313             var pr = getPullRequest(uri, repo, host, id);
1314             var noDecoration = getSwitch(&quot;no-decoration&quot;, &quot;status&quot;, arguments);
1315             var decoration = noDecoration ? &quot;&quot; : &quot;Status: &quot;;
1316             System.out.println(decoration + statusForPullRequest(pr));
1317 
1318             var noChecks = getSwitch(&quot;no-checks&quot;, &quot;status&quot;, arguments);
1319             if (!noChecks) {
1320                 var checks = pr.checks(pr.headHash());
1321                 var jcheck = Optional.ofNullable(checks.get(&quot;jcheck&quot;));
1322                 var submit = Optional.ofNullable(checks.get(&quot;submit&quot;));
1323                 var showChecks = jcheck.isPresent() || submit.isPresent();
1324                 if (showChecks) {
1325                     System.out.println(&quot;Checks:&quot;);
1326                     if (jcheck.isPresent()) {
1327                         System.out.println(&quot;- jcheck: &quot; + statusForCheck(jcheck.get()));
1328                     }
1329                     if (submit.isPresent()) {
<span class="line-modified">1330                         System.out.println(&quot;- submit: &quot; + statusForCheck(submit.get()));</span>
1331                     }
1332                 }
1333             }
1334         } else {
1335             exit(&quot;error: unexpected action: &quot; + action);
1336         }
1337     }
1338 }
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>