<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff vcs/src/main/java/org/openjdk/skara/vcs/git/GitCombinedDiffParser.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../Range.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../tools/UnifiedDiffParser.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>vcs/src/main/java/org/openjdk/skara/vcs/git/GitCombinedDiffParser.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 26 import org.openjdk.skara.vcs.tools.*;
 27 
 28 import java.io.IOException;
 29 import java.nio.file.Path;
 30 import java.util.*;
 31 
 32 class GitCombinedDiffParser {
 33     private final List&lt;Hash&gt; bases;
 34     private final int numParents;
 35     private final Hash head;
 36     private final String delimiter;
 37     private String line = null;
 38 
 39     public GitCombinedDiffParser(List&lt;Hash&gt; bases, Hash head, String delimiter) {
 40         this.bases = bases;
 41         this.numParents = bases.size();
 42         this.head = head;
 43         this.delimiter = delimiter;
 44     }
 45 
<span class="line-modified"> 46     private List&lt;List&lt;Hunk&gt;&gt; parseSingleFileMultiParentDiff(UnixStreamReader reader) throws IOException {</span>
 47         assert line.startsWith(&quot;diff --combined&quot;);
 48 
 49         while ((line = reader.readLine()) != null &amp;&amp;
 50                 !line.startsWith(&quot;@@@&quot;) &amp;&amp;
 51                 !line.startsWith(&quot;diff --combined&quot;) &amp;&amp;
 52                 !line.equals(delimiter)) {
 53             // Skip all diff header lines (we already have them via the raw headers)
 54             // Note: this will also skip &#39;Binary files differ...&#39; on purpose
 55         }
 56 
 57         var hunksPerParent = new ArrayList&lt;List&lt;Hunk&gt;&gt;(numParents);
 58         for (int i = 0; i &lt; numParents; i++) {
 59             hunksPerParent.add(new ArrayList&lt;Hunk&gt;());
 60         }
 61 
 62         while (line != null &amp;&amp; line.startsWith(&quot;@@@&quot;)) {
 63             var words = line.split(&quot;\\s&quot;);
 64             assert words[0].startsWith(&quot;@@@&quot;);
 65             var sourceRangesPerParent = new ArrayList&lt;Range&gt;(numParents);
 66             for (int i = 1; i &lt;= numParents; i++) {
<span class="line-modified"> 67                 sourceRangesPerParent.add(Range.fromString(words[i].substring(1))); // skip initial &#39;-&#39;</span>







 68             }
 69             var targetRange = Range.fromString(words[numParents + 1].substring(1)); // skip initial &#39;+&#39;
 70 
 71             var linesPerParent = new ArrayList&lt;List&lt;String&gt;&gt;(numParents);
 72             for (int i = 0; i &lt; numParents; i++) {
 73                 linesPerParent.add(new ArrayList&lt;String&gt;());
 74             }
 75 
 76             while ((line = reader.readLine()) != null &amp;&amp;
 77                    !line.startsWith(&quot;@@@&quot;) &amp;&amp;
 78                    !line.startsWith(&quot;diff --combined&quot;) &amp;&amp;
 79                    !line.equals(delimiter)) {
 80                 if (line.equals(&quot;\\ No newline at end of file&quot;)) {
 81                     continue;
 82                 }
 83 
 84                 var signs = line.substring(0, numParents);
 85                 var content = line.substring(numParents);
 86                 for (int i = 0; i &lt; numParents; i++) {
 87                     char sign = line.charAt(i);
</pre>
<hr />
<pre>
157         return headers;
158     }
159 
160     public List&lt;Diff&gt; parse(UnixStreamReader reader) throws IOException {
161         line = reader.readLine();
162 
163         if (line == null || line.equals(delimiter)) {
164             // Not all merge commits contains non-trivial changes
165             var diffsPerParent = new ArrayList&lt;Diff&gt;(numParents);
166             for (int i = 0; i &lt; numParents; i++) {
167                 diffsPerParent.add(new Diff(bases.get(i), head, new ArrayList&lt;Patch&gt;()));
168             }
169             return diffsPerParent;
170         }
171 
172         var headersPerParent = new ArrayList&lt;List&lt;PatchHeader&gt;&gt;(numParents);
173         for (int i = 0; i &lt; numParents; i++) {
174             headersPerParent.add(new ArrayList&lt;PatchHeader&gt;());
175         }
176 

177         while (line != null &amp;&amp; line.startsWith(&quot;::&quot;)) {
178             var headersForFile = parseCombinedRawLine(line);

179             assert headersForFile.size() == numParents;
180 
181             for (int i = 0; i &lt; numParents; i++) {
182                 headersPerParent.get(i).add(headersForFile.get(i));
183             }
184 
185             line = reader.readLine();
186         }
187 
188         // skip empty newline added by git
189         assert line.equals(&quot;&quot;);
190         line = reader.readLine();
191 
192         var hunksPerFilePerParent = new ArrayList&lt;List&lt;List&lt;Hunk&gt;&gt;&gt;(numParents);
193         for (int i = 0; i &lt; numParents; i++) {
194             hunksPerFilePerParent.add(new ArrayList&lt;List&lt;Hunk&gt;&gt;());
195         }


196         while (line != null &amp;&amp; !line.equals(delimiter)) {
<span class="line-modified">197             var hunksPerParentForFile = parseSingleFileMultiParentDiff(reader);</span>

198             assert hunksPerParentForFile.size() == numParents;
199 
200             for (int i = 0; i &lt; numParents; i++) {
201                 hunksPerFilePerParent.get(i).add(hunksPerParentForFile.get(i));
202             }


203         }
204 
205         var patchesPerParent = new ArrayList&lt;List&lt;Patch&gt;&gt;(numParents);
206         for (int i = 0; i &lt; numParents; i++) {
207             var headers = headersPerParent.get(i);
208             var hunks = hunksPerFilePerParent.get(i);
209             var patches = new ArrayList&lt;Patch&gt;();
210             for (int j = 0; j &lt; headers.size(); j++) {
211                 var h = headers.get(j);
212                 patches.add(new TextualPatch(h.sourcePath(), h.sourceFileType(), h.sourceHash(),
213                                              h.targetPath(), h.targetFileType(), h.targetHash(),
214                                              h.status(), hunks.get(j)));
215             }
216             patchesPerParent.add(patches);
217         }
218 
219         var diffs = new ArrayList&lt;Diff&gt;(numParents);
220         for (int i = 0; i &lt; numParents; i++) {
221             diffs.add(new Diff(bases.get(i), head, patchesPerParent.get(i)));
222         }
</pre>
</td>
<td>
<hr />
<pre>
 26 import org.openjdk.skara.vcs.tools.*;
 27 
 28 import java.io.IOException;
 29 import java.nio.file.Path;
 30 import java.util.*;
 31 
 32 class GitCombinedDiffParser {
 33     private final List&lt;Hash&gt; bases;
 34     private final int numParents;
 35     private final Hash head;
 36     private final String delimiter;
 37     private String line = null;
 38 
 39     public GitCombinedDiffParser(List&lt;Hash&gt; bases, Hash head, String delimiter) {
 40         this.bases = bases;
 41         this.numParents = bases.size();
 42         this.head = head;
 43         this.delimiter = delimiter;
 44     }
 45 
<span class="line-modified"> 46     private List&lt;List&lt;Hunk&gt;&gt; parseSingleFileMultiParentDiff(UnixStreamReader reader, List&lt;PatchHeader&gt; headers) throws IOException {</span>
 47         assert line.startsWith(&quot;diff --combined&quot;);
 48 
 49         while ((line = reader.readLine()) != null &amp;&amp;
 50                 !line.startsWith(&quot;@@@&quot;) &amp;&amp;
 51                 !line.startsWith(&quot;diff --combined&quot;) &amp;&amp;
 52                 !line.equals(delimiter)) {
 53             // Skip all diff header lines (we already have them via the raw headers)
 54             // Note: this will also skip &#39;Binary files differ...&#39; on purpose
 55         }
 56 
 57         var hunksPerParent = new ArrayList&lt;List&lt;Hunk&gt;&gt;(numParents);
 58         for (int i = 0; i &lt; numParents; i++) {
 59             hunksPerParent.add(new ArrayList&lt;Hunk&gt;());
 60         }
 61 
 62         while (line != null &amp;&amp; line.startsWith(&quot;@@@&quot;)) {
 63             var words = line.split(&quot;\\s&quot;);
 64             assert words[0].startsWith(&quot;@@@&quot;);
 65             var sourceRangesPerParent = new ArrayList&lt;Range&gt;(numParents);
 66             for (int i = 1; i &lt;= numParents; i++) {
<span class="line-modified"> 67                 var header = headers.get(i - 1);</span>
<span class="line-added"> 68                 if (header.status().isAdded()) {</span>
<span class="line-added"> 69                     // git reports wrong start for added files, they should</span>
<span class="line-added"> 70                     // always have range (0,0), but git reports (1,0)</span>
<span class="line-added"> 71                     sourceRangesPerParent.add(new Range(0, 0));</span>
<span class="line-added"> 72                 } else {</span>
<span class="line-added"> 73                     sourceRangesPerParent.add(Range.fromString(words[i].substring(1))); // skip initial &#39;-&#39;</span>
<span class="line-added"> 74                 }</span>
 75             }
 76             var targetRange = Range.fromString(words[numParents + 1].substring(1)); // skip initial &#39;+&#39;
 77 
 78             var linesPerParent = new ArrayList&lt;List&lt;String&gt;&gt;(numParents);
 79             for (int i = 0; i &lt; numParents; i++) {
 80                 linesPerParent.add(new ArrayList&lt;String&gt;());
 81             }
 82 
 83             while ((line = reader.readLine()) != null &amp;&amp;
 84                    !line.startsWith(&quot;@@@&quot;) &amp;&amp;
 85                    !line.startsWith(&quot;diff --combined&quot;) &amp;&amp;
 86                    !line.equals(delimiter)) {
 87                 if (line.equals(&quot;\\ No newline at end of file&quot;)) {
 88                     continue;
 89                 }
 90 
 91                 var signs = line.substring(0, numParents);
 92                 var content = line.substring(numParents);
 93                 for (int i = 0; i &lt; numParents; i++) {
 94                     char sign = line.charAt(i);
</pre>
<hr />
<pre>
164         return headers;
165     }
166 
167     public List&lt;Diff&gt; parse(UnixStreamReader reader) throws IOException {
168         line = reader.readLine();
169 
170         if (line == null || line.equals(delimiter)) {
171             // Not all merge commits contains non-trivial changes
172             var diffsPerParent = new ArrayList&lt;Diff&gt;(numParents);
173             for (int i = 0; i &lt; numParents; i++) {
174                 diffsPerParent.add(new Diff(bases.get(i), head, new ArrayList&lt;Patch&gt;()));
175             }
176             return diffsPerParent;
177         }
178 
179         var headersPerParent = new ArrayList&lt;List&lt;PatchHeader&gt;&gt;(numParents);
180         for (int i = 0; i &lt; numParents; i++) {
181             headersPerParent.add(new ArrayList&lt;PatchHeader&gt;());
182         }
183 
<span class="line-added">184         var headersForFiles = new ArrayList&lt;List&lt;PatchHeader&gt;&gt;();</span>
185         while (line != null &amp;&amp; line.startsWith(&quot;::&quot;)) {
186             var headersForFile = parseCombinedRawLine(line);
<span class="line-added">187             headersForFiles.add(headersForFile);</span>
188             assert headersForFile.size() == numParents;
189 
190             for (int i = 0; i &lt; numParents; i++) {
191                 headersPerParent.get(i).add(headersForFile.get(i));
192             }
193 
194             line = reader.readLine();
195         }
196 
197         // skip empty newline added by git
198         assert line.equals(&quot;&quot;);
199         line = reader.readLine();
200 
201         var hunksPerFilePerParent = new ArrayList&lt;List&lt;List&lt;Hunk&gt;&gt;&gt;(numParents);
202         for (int i = 0; i &lt; numParents; i++) {
203             hunksPerFilePerParent.add(new ArrayList&lt;List&lt;Hunk&gt;&gt;());
204         }
<span class="line-added">205 </span>
<span class="line-added">206         int headerIndex = 0;</span>
207         while (line != null &amp;&amp; !line.equals(delimiter)) {
<span class="line-modified">208             var headersForFile = headersForFiles.get(headerIndex);</span>
<span class="line-added">209             var hunksPerParentForFile = parseSingleFileMultiParentDiff(reader, headersForFile);</span>
210             assert hunksPerParentForFile.size() == numParents;
211 
212             for (int i = 0; i &lt; numParents; i++) {
213                 hunksPerFilePerParent.get(i).add(hunksPerParentForFile.get(i));
214             }
<span class="line-added">215 </span>
<span class="line-added">216             headerIndex++;</span>
217         }
218 
219         var patchesPerParent = new ArrayList&lt;List&lt;Patch&gt;&gt;(numParents);
220         for (int i = 0; i &lt; numParents; i++) {
221             var headers = headersPerParent.get(i);
222             var hunks = hunksPerFilePerParent.get(i);
223             var patches = new ArrayList&lt;Patch&gt;();
224             for (int j = 0; j &lt; headers.size(); j++) {
225                 var h = headers.get(j);
226                 patches.add(new TextualPatch(h.sourcePath(), h.sourceFileType(), h.sourceHash(),
227                                              h.targetPath(), h.targetFileType(), h.targetHash(),
228                                              h.status(), hunks.get(j)));
229             }
230             patchesPerParent.add(patches);
231         }
232 
233         var diffs = new ArrayList&lt;Diff&gt;(numParents);
234         for (int i = 0; i &lt; numParents; i++) {
235             diffs.add(new Diff(bases.get(i), head, patchesPerParent.get(i)));
236         }
</pre>
</td>
</tr>
</table>
<center><a href="../Range.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../tools/UnifiedDiffParser.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>