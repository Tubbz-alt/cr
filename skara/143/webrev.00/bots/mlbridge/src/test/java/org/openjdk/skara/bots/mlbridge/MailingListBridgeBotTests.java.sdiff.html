<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/mlbridge/PullRequestInstance.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 149             ignoredPr.addComment(&quot;hello there&quot;);
 150 
 151             // Run another archive pass
 152             TestBotRunner.runPeriodicItems(mlBot);
 153 
 154             // It should still not be archived
 155             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 156             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 157 
 158             // Now post a ready comment
 159             ignoredPr.addComment(&quot;ready&quot;);
 160 
 161             // Run another archive pass
 162             TestBotRunner.runPeriodicItems(mlBot);
 163 
 164             // The archive should now contain an entry
 165             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 166             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 167             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
 168             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
<span class="line-modified"> 169             assertTrue(archiveContains(archiveFolder.path(), &quot;Pull request:&quot;));</span>
 170             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
 171             assertTrue(archiveContains(archiveFolder.path(), &quot;http://www.test.test/&quot;));
 172             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));
<span class="line-modified"> 173             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch command:&quot;));</span>
<span class="line-modified"> 174             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - &quot; + editHash.abbreviate() + &quot;:\tChange msg&quot;));</span>
<span class="line-modified"> 175             assertTrue(archiveContains(archiveFolder.path(), &quot;^\t\t\tWith several lines&quot;));</span>
 176 
 177             // The mailing list as well
 178             listServer.processIncoming();
 179             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 180             var mailmanList = mailmanServer.getList(listAddress.address());
 181             var conversations = mailmanList.conversations(Duration.ofDays(1));
 182             assertEquals(1, conversations.size());
 183             var mail = conversations.get(0).first();
 184             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 185             assertEquals(pr.getAuthor().fullName(), mail.author().fullName().orElseThrow());
 186             assertEquals(noreplyAddress(archive), mail.author().address());
 187             assertEquals(from, mail.sender());
 188 
 189             // And there should be a webrev
 190             Repository.materialize(webrevFolder.path(), archive.getUrl(), &quot;webrev&quot;);
 191             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
 192             var comments = pr.getComments();
 193             var webrevComments = comments.stream()
 194                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 195                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
</pre>
<hr />
<pre>
 725             var lastHeadHash = pr.getHeadHash();
 726             var refreshCount = 0;
 727             do {
 728                 pr = author.getPullRequest(pr.getId());
 729                 if (refreshCount++ &gt; 100) {
 730                     fail(&quot;The PR did not update after the new push&quot;);
 731                 }
 732             } while (pr.getHeadHash().equals(lastHeadHash));
 733 
 734             // Run another archive pass
 735             TestBotRunner.runPeriodicItems(mlBot);
 736             TestBotRunner.runPeriodicItems(mlBot);
 737             TestBotRunner.runPeriodicItems(mlBot);
 738             listServer.processIncoming();
 739 
 740             // The archive should reference the updated push
 741             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 742             assertTrue(archiveContains(archiveFolder.path(), &quot;additional changes&quot;));
 743             assertTrue(archiveContains(archiveFolder.path(), &quot;full.*/&quot; + pr.getId() + &quot;/webrev.01&quot;));
 744             assertTrue(archiveContains(archiveFolder.path(), &quot;inc.*/&quot; + pr.getId() + &quot;/webrev.00-01&quot;));
<span class="line-modified"> 745             assertTrue(archiveContains(archiveFolder.path(), &quot;Updated full patch&quot;));</span>
 746             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
 747             assertTrue(archiveContains(archiveFolder.path(), &quot;Fixing&quot;));
 748 
 749             // The webrev comment should be updated
 750             var comments = pr.getComments();
 751             var webrevComments = comments.stream()
 752                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 753                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 754                                          .filter(comment -&gt; comment.body().contains(nextHash.hex()))
 755                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 756                                          .collect(Collectors.toList());
 757             assertEquals(1, webrevComments.size());
 758 
 759             // Check that sender address is set properly
 760             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 761             var mailmanList = mailmanServer.getList(listAddress.address());
 762             var conversations = mailmanList.conversations(Duration.ofDays(1));
 763             assertEquals(1, conversations.size());
 764             for (var newMail : conversations.get(0).allMessages()) {
 765                 assertEquals(noreplyAddress(archive), newMail.author().address());
</pre>
<hr />
<pre>
 843 
 844             // Make sure that the push registered
 845             var lastHeadHash = pr.getHeadHash();
 846             var refreshCount = 0;
 847             do {
 848                 pr = author.getPullRequest(pr.getId());
 849                 if (refreshCount++ &gt; 100) {
 850                     fail(&quot;The PR did not update after the new push&quot;);
 851                 }
 852             } while (pr.getHeadHash().equals(lastHeadHash));
 853 
 854             // Run another archive pass
 855             TestBotRunner.runPeriodicItems(mlBot);
 856             listServer.processIncoming();
 857 
 858             // The archive should reference the rebased push
 859             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 860             assertTrue(archiveContains(archiveFolder.path(), &quot;complete new set of changes&quot;));
 861             assertTrue(archiveContains(archiveFolder.path(), pr.getId() + &quot;/webrev.01&quot;));
 862             assertFalse(archiveContains(archiveFolder.path(), &quot;Incremental&quot;));
<span class="line-modified"> 863             assertTrue(archiveContains(archiveFolder.path(), &quot;Updated full patch&quot;));</span>
 864             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
 865             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
 866             assertTrue(archiveContains(archiveFolder.path(), &quot;Replaced msg&quot;));
 867 
 868             // The webrev comment should be updated
 869             var comments = pr.getComments();
 870             var webrevComments = comments.stream()
 871                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 872                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 873                                          .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
 874                                          .collect(Collectors.toList());
 875             assertEquals(1, webrevComments.size());
 876 
 877             // Check that sender address is set properly
 878             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 879             var mailmanList = mailmanServer.getList(listAddress.address());
 880             var conversations = mailmanList.conversations(Duration.ofDays(1));
 881             assertEquals(1, conversations.size());
 882             for (var newMail : conversations.get(0).allMessages()) {
 883                 assertEquals(noreplyAddress(archive), newMail.author().address());
</pre>
</td>
<td>
<hr />
<pre>
 149             ignoredPr.addComment(&quot;hello there&quot;);
 150 
 151             // Run another archive pass
 152             TestBotRunner.runPeriodicItems(mlBot);
 153 
 154             // It should still not be archived
 155             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 156             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 157 
 158             // Now post a ready comment
 159             ignoredPr.addComment(&quot;ready&quot;);
 160 
 161             // Run another archive pass
 162             TestBotRunner.runPeriodicItems(mlBot);
 163 
 164             // The archive should now contain an entry
 165             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 166             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 167             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
 168             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
<span class="line-modified"> 169             assertTrue(archiveContains(archiveFolder.path(), &quot;Changes:&quot;));</span>
 170             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
 171             assertTrue(archiveContains(archiveFolder.path(), &quot;http://www.test.test/&quot;));
 172             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));
<span class="line-modified"> 173             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch:&quot;));</span>
<span class="line-modified"> 174             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - &quot; + editHash.abbreviate() + &quot;: Change msg&quot;));</span>
<span class="line-modified"> 175             assertFalse(archiveContains(archiveFolder.path(), &quot;With several lines&quot;));</span>
 176 
 177             // The mailing list as well
 178             listServer.processIncoming();
 179             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 180             var mailmanList = mailmanServer.getList(listAddress.address());
 181             var conversations = mailmanList.conversations(Duration.ofDays(1));
 182             assertEquals(1, conversations.size());
 183             var mail = conversations.get(0).first();
 184             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 185             assertEquals(pr.getAuthor().fullName(), mail.author().fullName().orElseThrow());
 186             assertEquals(noreplyAddress(archive), mail.author().address());
 187             assertEquals(from, mail.sender());
 188 
 189             // And there should be a webrev
 190             Repository.materialize(webrevFolder.path(), archive.getUrl(), &quot;webrev&quot;);
 191             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
 192             var comments = pr.getComments();
 193             var webrevComments = comments.stream()
 194                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 195                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
</pre>
<hr />
<pre>
 725             var lastHeadHash = pr.getHeadHash();
 726             var refreshCount = 0;
 727             do {
 728                 pr = author.getPullRequest(pr.getId());
 729                 if (refreshCount++ &gt; 100) {
 730                     fail(&quot;The PR did not update after the new push&quot;);
 731                 }
 732             } while (pr.getHeadHash().equals(lastHeadHash));
 733 
 734             // Run another archive pass
 735             TestBotRunner.runPeriodicItems(mlBot);
 736             TestBotRunner.runPeriodicItems(mlBot);
 737             TestBotRunner.runPeriodicItems(mlBot);
 738             listServer.processIncoming();
 739 
 740             // The archive should reference the updated push
 741             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 742             assertTrue(archiveContains(archiveFolder.path(), &quot;additional changes&quot;));
 743             assertTrue(archiveContains(archiveFolder.path(), &quot;full.*/&quot; + pr.getId() + &quot;/webrev.01&quot;));
 744             assertTrue(archiveContains(archiveFolder.path(), &quot;inc.*/&quot; + pr.getId() + &quot;/webrev.00-01&quot;));
<span class="line-modified"> 745             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));</span>
 746             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
 747             assertTrue(archiveContains(archiveFolder.path(), &quot;Fixing&quot;));
 748 
 749             // The webrev comment should be updated
 750             var comments = pr.getComments();
 751             var webrevComments = comments.stream()
 752                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 753                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 754                                          .filter(comment -&gt; comment.body().contains(nextHash.hex()))
 755                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 756                                          .collect(Collectors.toList());
 757             assertEquals(1, webrevComments.size());
 758 
 759             // Check that sender address is set properly
 760             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 761             var mailmanList = mailmanServer.getList(listAddress.address());
 762             var conversations = mailmanList.conversations(Duration.ofDays(1));
 763             assertEquals(1, conversations.size());
 764             for (var newMail : conversations.get(0).allMessages()) {
 765                 assertEquals(noreplyAddress(archive), newMail.author().address());
</pre>
<hr />
<pre>
 843 
 844             // Make sure that the push registered
 845             var lastHeadHash = pr.getHeadHash();
 846             var refreshCount = 0;
 847             do {
 848                 pr = author.getPullRequest(pr.getId());
 849                 if (refreshCount++ &gt; 100) {
 850                     fail(&quot;The PR did not update after the new push&quot;);
 851                 }
 852             } while (pr.getHeadHash().equals(lastHeadHash));
 853 
 854             // Run another archive pass
 855             TestBotRunner.runPeriodicItems(mlBot);
 856             listServer.processIncoming();
 857 
 858             // The archive should reference the rebased push
 859             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 860             assertTrue(archiveContains(archiveFolder.path(), &quot;complete new set of changes&quot;));
 861             assertTrue(archiveContains(archiveFolder.path(), pr.getId() + &quot;/webrev.01&quot;));
 862             assertFalse(archiveContains(archiveFolder.path(), &quot;Incremental&quot;));
<span class="line-modified"> 863             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));</span>
 864             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
 865             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
 866             assertTrue(archiveContains(archiveFolder.path(), &quot;Replaced msg&quot;));
 867 
 868             // The webrev comment should be updated
 869             var comments = pr.getComments();
 870             var webrevComments = comments.stream()
 871                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 872                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 873                                          .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
 874                                          .collect(Collectors.toList());
 875             assertEquals(1, webrevComments.size());
 876 
 877             // Check that sender address is set properly
 878             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 879             var mailmanList = mailmanServer.getList(listAddress.address());
 880             var conversations = mailmanList.conversations(Duration.ofDays(1));
 881             assertEquals(1, conversations.size());
 882             for (var newMail : conversations.get(0).allMessages()) {
 883                 assertEquals(noreplyAddress(archive), newMail.author().address());
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/mlbridge/PullRequestInstance.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>