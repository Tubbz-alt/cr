<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../../../bridgekeeper/src/test/java/org/openjdk/skara/bots/bridgekeeper/PullRequestCloserBotTests.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../tester/src/test/java/org/openjdk/skara/bots/tester/InMemoryPullRequest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  26 import org.openjdk.skara.forge.HostedRepository;
  27 import org.openjdk.skara.issuetracker.Issue;
  28 import org.openjdk.skara.json.*;
  29 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  30 import org.openjdk.skara.storage.StorageBuilder;
  31 import org.openjdk.skara.test.*;
  32 import org.openjdk.skara.vcs.Tag;
  33 
  34 import org.junit.jupiter.api.*;
  35 
  36 import java.io.IOException;
  37 import java.net.URI;
  38 import java.nio.charset.StandardCharsets;
  39 import java.nio.file.*;
  40 import java.time.Duration;
  41 import java.util.*;
  42 import java.util.regex.Pattern;
  43 import java.util.stream.Collectors;
  44 
  45 import static org.junit.jupiter.api.Assertions.*;

  46 
  47 class UpdaterTests {
  48     private List&lt;Path&gt; findJsonFiles(Path folder, String partialName) throws IOException {
  49         return Files.walk(folder)
  50                     .filter(path -&gt; path.toString().endsWith(&quot;.json&quot;))
  51                     .filter(path -&gt; path.toString().contains(partialName))
  52                     .collect(Collectors.toList());
  53     }
  54 
  55     private StorageBuilder&lt;Tag&gt; createTagStorage(HostedRepository repository) {
  56         return new StorageBuilder&lt;Tag&gt;(&quot;tags.txt&quot;)
  57                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated tags&quot;);
  58     }
  59 
  60     private StorageBuilder&lt;ResolvedBranch&gt; createBranchStorage(HostedRepository repository) {
  61         return new StorageBuilder&lt;ResolvedBranch&gt;(&quot;branches.txt&quot;)
  62                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated branches&quot;);
  63     }
  64 
  65     private StorageBuilder&lt;PullRequestIssues&gt; createPullRequestIssuesStorage(HostedRepository repository) {
</pre>
<hr />
<pre>
1189             var issueProject = credentials.getIssueProject();
1190             var updater = new IssueUpdater(issueProject, false, null, false, null, true, &quot;12.0.2&quot;);
1191             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1192                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1193 
1194             // Initialize history
1195             TestBotRunner.runPeriodicItems(notifyBot);
1196 
1197             // Create an issue and commit a fix
1198             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1199             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;13.0.1&quot;));
1200             issue.setProperty(&quot;priority&quot;, JSON.of(&quot;1&quot;));
1201 
1202             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1203             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1204             TestBotRunner.runPeriodicItems(notifyBot);
1205 
1206             // The fixVersion should not have been updated
1207             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1208             assertEquals(Set.of(&quot;13.0.1&quot;), fixVersions(updatedIssue));

1209 
1210             // There should be a link
1211             var links = updatedIssue.links();
1212             assertEquals(1, links.size());
1213             var link = links.get(0);
1214             var backport = link.issue().orElseThrow();
1215 
1216             // The backport issue should have a correct fixVersion
1217             assertEquals(Set.of(&quot;12.0.2&quot;), fixVersions(backport));

1218 
1219             // Custom properties should also propagate
1220             assertEquals(&quot;1&quot;, backport.properties().get(&quot;priority&quot;).asString());
1221         }
1222     }
1223 
1224     @Test
1225     void testPullRequest(TestInfo testInfo) throws IOException {
1226         try (var credentials = new HostCredentials(testInfo);
1227              var tempFolder = new TemporaryDirectory()) {
1228             var repo = credentials.getHostedRepository();
1229             var reviewer = credentials.getHostedRepository();
1230             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1231             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1232             credentials.commitLock(localRepo);
1233             localRepo.pushAll(repo.url());
1234 
1235             var tagStorage = createTagStorage(repo);
1236             var branchStorage = createBranchStorage(repo);
1237             var prIssuesStorage = createPullRequestIssuesStorage(repo);
</pre>
</td>
<td>
<hr />
<pre>
  26 import org.openjdk.skara.forge.HostedRepository;
  27 import org.openjdk.skara.issuetracker.Issue;
  28 import org.openjdk.skara.json.*;
  29 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  30 import org.openjdk.skara.storage.StorageBuilder;
  31 import org.openjdk.skara.test.*;
  32 import org.openjdk.skara.vcs.Tag;
  33 
  34 import org.junit.jupiter.api.*;
  35 
  36 import java.io.IOException;
  37 import java.net.URI;
  38 import java.nio.charset.StandardCharsets;
  39 import java.nio.file.*;
  40 import java.time.Duration;
  41 import java.util.*;
  42 import java.util.regex.Pattern;
  43 import java.util.stream.Collectors;
  44 
  45 import static org.junit.jupiter.api.Assertions.*;
<span class="line-added">  46 import static org.openjdk.skara.issuetracker.Issue.State.*;</span>
  47 
  48 class UpdaterTests {
  49     private List&lt;Path&gt; findJsonFiles(Path folder, String partialName) throws IOException {
  50         return Files.walk(folder)
  51                     .filter(path -&gt; path.toString().endsWith(&quot;.json&quot;))
  52                     .filter(path -&gt; path.toString().contains(partialName))
  53                     .collect(Collectors.toList());
  54     }
  55 
  56     private StorageBuilder&lt;Tag&gt; createTagStorage(HostedRepository repository) {
  57         return new StorageBuilder&lt;Tag&gt;(&quot;tags.txt&quot;)
  58                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated tags&quot;);
  59     }
  60 
  61     private StorageBuilder&lt;ResolvedBranch&gt; createBranchStorage(HostedRepository repository) {
  62         return new StorageBuilder&lt;ResolvedBranch&gt;(&quot;branches.txt&quot;)
  63                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated branches&quot;);
  64     }
  65 
  66     private StorageBuilder&lt;PullRequestIssues&gt; createPullRequestIssuesStorage(HostedRepository repository) {
</pre>
<hr />
<pre>
1190             var issueProject = credentials.getIssueProject();
1191             var updater = new IssueUpdater(issueProject, false, null, false, null, true, &quot;12.0.2&quot;);
1192             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1193                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1194 
1195             // Initialize history
1196             TestBotRunner.runPeriodicItems(notifyBot);
1197 
1198             // Create an issue and commit a fix
1199             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1200             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;13.0.1&quot;));
1201             issue.setProperty(&quot;priority&quot;, JSON.of(&quot;1&quot;));
1202 
1203             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1204             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1205             TestBotRunner.runPeriodicItems(notifyBot);
1206 
1207             // The fixVersion should not have been updated
1208             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1209             assertEquals(Set.of(&quot;13.0.1&quot;), fixVersions(updatedIssue));
<span class="line-added">1210             assertEquals(OPEN, updatedIssue.state());</span>
1211 
1212             // There should be a link
1213             var links = updatedIssue.links();
1214             assertEquals(1, links.size());
1215             var link = links.get(0);
1216             var backport = link.issue().orElseThrow();
1217 
1218             // The backport issue should have a correct fixVersion
1219             assertEquals(Set.of(&quot;12.0.2&quot;), fixVersions(backport));
<span class="line-added">1220             assertEquals(RESOLVED, backport.state());</span>
1221 
1222             // Custom properties should also propagate
1223             assertEquals(&quot;1&quot;, backport.properties().get(&quot;priority&quot;).asString());
1224         }
1225     }
1226 
1227     @Test
1228     void testPullRequest(TestInfo testInfo) throws IOException {
1229         try (var credentials = new HostCredentials(testInfo);
1230              var tempFolder = new TemporaryDirectory()) {
1231             var repo = credentials.getHostedRepository();
1232             var reviewer = credentials.getHostedRepository();
1233             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1234             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1235             credentials.commitLock(localRepo);
1236             localRepo.pushAll(repo.url());
1237 
1238             var tagStorage = createTagStorage(repo);
1239             var branchStorage = createBranchStorage(repo);
1240             var prIssuesStorage = createPullRequestIssuesStorage(repo);
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../../../bridgekeeper/src/test/java/org/openjdk/skara/bots/bridgekeeper/PullRequestCloserBotTests.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../tester/src/test/java/org/openjdk/skara/bots/tester/InMemoryPullRequest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>