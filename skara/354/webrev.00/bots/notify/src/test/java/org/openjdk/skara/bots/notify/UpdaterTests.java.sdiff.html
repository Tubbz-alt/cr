<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/notify/NotifyBotFactory.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 990         }
 991     }
 992 
 993     @Test
 994     void testIssueConfiguredVersionNoCommit(TestInfo testInfo) throws IOException {
 995         try (var credentials = new HostCredentials(testInfo);
 996              var tempFolder = new TemporaryDirectory()) {
 997             var repo = credentials.getHostedRepository();
 998             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 999             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1000             credentials.commitLock(localRepo);
1001             localRepo.pushAll(repo.url());
1002 
1003             var tagStorage = createTagStorage(repo);
1004             var branchStorage = createBranchStorage(repo);
1005             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1006             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1007 
1008             var issueProject = credentials.getIssueProject();
1009             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
<span class="line-modified">1010             var updater = new IssueUpdater(issueProject, false, null, false, commitIcon, true,&quot;2.0&quot;);</span>
1011             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1012                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1013 
1014             // Initialize history
1015             TestBotRunner.runPeriodicItems(notifyBot);
1016 
1017             // Create an issue and commit a fix
1018             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1019             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1020             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1021             TestBotRunner.runPeriodicItems(notifyBot);
1022 
1023             // The changeset should not reflected in a comment
1024             var comments = issue.comments();
1025             assertEquals(1, comments.size());
1026             var comment = comments.get(0);
1027             assertTrue(comment.body().contains(editHash.abbreviate()));
1028 
1029             // As well as a fixVersion - but not the one from the repo
1030             assertEquals(Set.of(&quot;2.0&quot;), fixVersions(issue));
</pre>
<hr />
<pre>
1098             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(updatedIssue));
1099         }
1100     }
1101 
1102     @Test
1103     void testIssuePoolVersion(TestInfo testInfo) throws IOException {
1104         try (var credentials = new HostCredentials(testInfo);
1105              var tempFolder = new TemporaryDirectory()) {
1106             var repo = credentials.getHostedRepository();
1107             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1108             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1109             credentials.commitLock(localRepo);
1110             localRepo.pushAll(repo.url());
1111 
1112             var tagStorage = createTagStorage(repo);
1113             var branchStorage = createBranchStorage(repo);
1114             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1115             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1116 
1117             var issueProject = credentials.getIssueProject();
<span class="line-modified">1118             var updater = new IssueUpdater(issueProject, false, null, false, null, true, &quot;12u14&quot;);</span>
1119             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1120                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1121 
1122             // Initialize history
1123             TestBotRunner.runPeriodicItems(notifyBot);
1124 
1125             // Create an issue and commit a fix
1126             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1127             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));
1128 
1129             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1130             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1131             TestBotRunner.runPeriodicItems(notifyBot);
1132 
1133             // The fixVersion should have been updated
1134             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));
1135         }
1136     }
1137 
1138     @Test
1139     void testIssuePoolOpenVersion(TestInfo testInfo) throws IOException {
1140         try (var credentials = new HostCredentials(testInfo);
1141              var tempFolder = new TemporaryDirectory()) {
1142             var repo = credentials.getHostedRepository();
1143             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1144             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1145             credentials.commitLock(localRepo);
1146             localRepo.pushAll(repo.url());
1147 
1148             var tagStorage = createTagStorage(repo);
1149             var branchStorage = createBranchStorage(repo);
1150             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1151             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1152 
1153             var issueProject = credentials.getIssueProject();
<span class="line-modified">1154             var updater = new IssueUpdater(issueProject, false, null, false, null, true, &quot;12u14&quot;);</span>
1155             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1156                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1157 
1158             // Initialize history
1159             TestBotRunner.runPeriodicItems(notifyBot);
1160 
1161             // Create an issue and commit a fix
1162             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1163             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));
1164 
1165             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1166             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1167             TestBotRunner.runPeriodicItems(notifyBot);
1168 
1169             // The fixVersion should have been updated
1170             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));
1171         }
1172     }
1173 
1174     @Test
1175     void testIssueBackport(TestInfo testInfo) throws IOException {
1176         try (var credentials = new HostCredentials(testInfo);
1177              var tempFolder = new TemporaryDirectory()) {
1178             var repo = credentials.getHostedRepository();
1179             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1180             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1181             credentials.commitLock(localRepo);
1182             localRepo.pushAll(repo.url());
1183 
1184             var tagStorage = createTagStorage(repo);
1185             var branchStorage = createBranchStorage(repo);
1186             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1187             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1188 
1189             var issueProject = credentials.getIssueProject();
<span class="line-modified">1190             var updater = new IssueUpdater(issueProject, false, null, false, null, true, &quot;12.0.2&quot;);</span>
1191             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1192                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1193 
1194             // Initialize history
1195             TestBotRunner.runPeriodicItems(notifyBot);
1196 
1197             // Create an issue and commit a fix
1198             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1199             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;13.0.1&quot;));
1200             issue.setProperty(&quot;priority&quot;, JSON.of(&quot;1&quot;));
1201 
1202             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1203             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1204             TestBotRunner.runPeriodicItems(notifyBot);
1205 
1206             // The fixVersion should not have been updated
1207             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1208             assertEquals(Set.of(&quot;13.0.1&quot;), fixVersions(updatedIssue));
1209 
1210             // There should be a link
</pre>
</td>
<td>
<hr />
<pre>
 990         }
 991     }
 992 
 993     @Test
 994     void testIssueConfiguredVersionNoCommit(TestInfo testInfo) throws IOException {
 995         try (var credentials = new HostCredentials(testInfo);
 996              var tempFolder = new TemporaryDirectory()) {
 997             var repo = credentials.getHostedRepository();
 998             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 999             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1000             credentials.commitLock(localRepo);
1001             localRepo.pushAll(repo.url());
1002 
1003             var tagStorage = createTagStorage(repo);
1004             var branchStorage = createBranchStorage(repo);
1005             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1006             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1007 
1008             var issueProject = credentials.getIssueProject();
1009             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
<span class="line-modified">1010             var updater = new IssueUpdater(issueProject, false, null, false, commitIcon, true, Map.of(&quot;master&quot;, &quot;2.0&quot;));</span>
1011             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1012                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1013 
1014             // Initialize history
1015             TestBotRunner.runPeriodicItems(notifyBot);
1016 
1017             // Create an issue and commit a fix
1018             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1019             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1020             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1021             TestBotRunner.runPeriodicItems(notifyBot);
1022 
1023             // The changeset should not reflected in a comment
1024             var comments = issue.comments();
1025             assertEquals(1, comments.size());
1026             var comment = comments.get(0);
1027             assertTrue(comment.body().contains(editHash.abbreviate()));
1028 
1029             // As well as a fixVersion - but not the one from the repo
1030             assertEquals(Set.of(&quot;2.0&quot;), fixVersions(issue));
</pre>
<hr />
<pre>
1098             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(updatedIssue));
1099         }
1100     }
1101 
1102     @Test
1103     void testIssuePoolVersion(TestInfo testInfo) throws IOException {
1104         try (var credentials = new HostCredentials(testInfo);
1105              var tempFolder = new TemporaryDirectory()) {
1106             var repo = credentials.getHostedRepository();
1107             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1108             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1109             credentials.commitLock(localRepo);
1110             localRepo.pushAll(repo.url());
1111 
1112             var tagStorage = createTagStorage(repo);
1113             var branchStorage = createBranchStorage(repo);
1114             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1115             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1116 
1117             var issueProject = credentials.getIssueProject();
<span class="line-modified">1118             var updater = new IssueUpdater(issueProject, false, null, false, null, true, Map.of(&quot;master&quot;, &quot;12u14&quot;));</span>
1119             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1120                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1121 
1122             // Initialize history
1123             TestBotRunner.runPeriodicItems(notifyBot);
1124 
1125             // Create an issue and commit a fix
1126             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1127             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));
1128 
1129             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1130             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1131             TestBotRunner.runPeriodicItems(notifyBot);
1132 
1133             // The fixVersion should have been updated
1134             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));
1135         }
1136     }
1137 
1138     @Test
1139     void testIssuePoolOpenVersion(TestInfo testInfo) throws IOException {
1140         try (var credentials = new HostCredentials(testInfo);
1141              var tempFolder = new TemporaryDirectory()) {
1142             var repo = credentials.getHostedRepository();
1143             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1144             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1145             credentials.commitLock(localRepo);
1146             localRepo.pushAll(repo.url());
1147 
1148             var tagStorage = createTagStorage(repo);
1149             var branchStorage = createBranchStorage(repo);
1150             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1151             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1152 
1153             var issueProject = credentials.getIssueProject();
<span class="line-modified">1154             var updater = new IssueUpdater(issueProject, false, null, false, null, true, Map.of(&quot;master&quot;, &quot;12u14&quot;));</span>
1155             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1156                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1157 
1158             // Initialize history
1159             TestBotRunner.runPeriodicItems(notifyBot);
1160 
1161             // Create an issue and commit a fix
1162             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1163             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));
1164 
1165             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1166             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1167             TestBotRunner.runPeriodicItems(notifyBot);
1168 
1169             // The fixVersion should have been updated
1170             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));
1171         }
1172     }
1173 
1174     @Test
1175     void testIssueBackport(TestInfo testInfo) throws IOException {
1176         try (var credentials = new HostCredentials(testInfo);
1177              var tempFolder = new TemporaryDirectory()) {
1178             var repo = credentials.getHostedRepository();
1179             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1180             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1181             credentials.commitLock(localRepo);
1182             localRepo.pushAll(repo.url());
1183 
1184             var tagStorage = createTagStorage(repo);
1185             var branchStorage = createBranchStorage(repo);
1186             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1187             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1188 
1189             var issueProject = credentials.getIssueProject();
<span class="line-modified">1190             var updater = new IssueUpdater(issueProject, false, null, false, null, true, Map.of(&quot;master&quot;, &quot;12.0.2&quot;));</span>
1191             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1192                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1193 
1194             // Initialize history
1195             TestBotRunner.runPeriodicItems(notifyBot);
1196 
1197             // Create an issue and commit a fix
1198             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1199             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;13.0.1&quot;));
1200             issue.setProperty(&quot;priority&quot;, JSON.of(&quot;1&quot;));
1201 
1202             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1203             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1204             TestBotRunner.runPeriodicItems(notifyBot);
1205 
1206             // The fixVersion should not have been updated
1207             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1208             assertEquals(Set.of(&quot;13.0.1&quot;), fixVersions(updatedIssue));
1209 
1210             // There should be a link
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/notify/NotifyBotFactory.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>