<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff cli/src/main/java/org/openjdk/skara/cli/GitPr.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../../bots/tester/src/test/java/org/openjdk/skara/bots/tester/InMemoryPullRequest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../forge/src/main/java/org/openjdk/skara/forge/PullRequest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>cli/src/main/java/org/openjdk/skara/cli/GitPr.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 949             var pr = getPullRequest(uri, repo, host, id);
 950 
 951             if (action.equals(&quot;integrate&quot;)) {
 952                 pr.addComment(&quot;/integrate&quot;);
 953             } else if (action.equals(&quot;test&quot;)) {
 954                 pr.addComment(&quot;/test&quot;);
 955             } else if (action.equals(&quot;approve&quot;)) {
 956                 pr.addReview(Review.Verdict.APPROVED, &quot;Looks good!&quot;);
 957             } else {
 958                 throw new IllegalStateException(&quot;unexpected action: &quot; + action);
 959             }
 960         } else if (action.equals(&quot;list&quot;)) {
 961             var remoteRepo = getHostedRepositoryFor(uri, repo, host);
 962             var prs = remoteRepo.pullRequests();
 963             var ids = new ArrayList&lt;String&gt;();
 964             var titles = new ArrayList&lt;String&gt;();
 965             var authors = new ArrayList&lt;String&gt;();
 966             var assignees = new ArrayList&lt;String&gt;();
 967             var labels = new ArrayList&lt;String&gt;();
 968             var issues = new ArrayList&lt;String&gt;();

 969 
 970             var authorsOption = getOption(&quot;authors&quot;, &quot;list&quot;, arguments);
 971             var filterAuthors = authorsOption == null ?
 972                 Set.of() :
 973                 new HashSet&lt;&gt;(Arrays.asList(authorsOption.split(&quot;,&quot;)));
 974 
 975             var assigneesOption = getOption(&quot;assignees&quot;, &quot;list&quot;, arguments);
 976             var filterAssignees = assigneesOption == null ?
 977                 Set.of() :
 978                 Arrays.asList(assigneesOption.split(&quot;,&quot;));
 979 
 980             var labelsOption = getOption(&quot;labels&quot;, &quot;list&quot;, arguments);
 981             var filterLabels = labelsOption == null ?
 982                 Set.of() :
 983                 Arrays.asList(labelsOption.split(&quot;,&quot;));
 984 
 985             var issuesOption = getOption(&quot;issues&quot;, &quot;list&quot;, arguments);
 986             var filterIssues = issuesOption == null ?
 987                 Set.of() :
 988                 Arrays.asList(issuesOption.split(&quot;,&quot;));
 989 
<span class="line-modified"> 990             var defaultColumns = List.of(&quot;id&quot;, &quot;title&quot;, &quot;authors&quot;, &quot;assignees&quot;, &quot;labels&quot;, &quot;issues&quot;);</span>
 991             var columnValues = Map.of(defaultColumns.get(0), ids,
 992                                       defaultColumns.get(1), titles,
 993                                       defaultColumns.get(2), authors,
 994                                       defaultColumns.get(3), assignees,
 995                                       defaultColumns.get(4), labels,
<span class="line-modified"> 996                                       defaultColumns.get(5), issues);</span>

 997             var columnsOption = getOption(&quot;columns&quot;, &quot;list&quot;, arguments);
 998             var columns = columnsOption == null ?
 999                 defaultColumns :
1000                 Arrays.asList(columnsOption.split(&quot;,&quot;));
1001             if (columns != defaultColumns) {
1002                 for (var column : columns) {
1003                     if (!defaultColumns.contains(column)) {
1004                         System.err.println(&quot;error: unknown column: &quot; + column);
1005                         System.err.println(&quot;       available columns are: &quot; + String.join(&quot;,&quot;, defaultColumns));
1006                         System.exit(1);
1007                     }
1008                 }
1009             }
1010 
1011             for (var pr : prs) {
1012                 var prAuthor = pr.author().userName();
1013                 if (!filterAuthors.isEmpty() &amp;&amp; !filterAuthors.contains(prAuthor)) {
1014                     continue;
1015                 }
1016 
</pre>
<hr />
<pre>
1021                     continue;
1022                 }
1023 
1024                 var prLabels = new HashSet&lt;&gt;(pr.labels());
1025                 if (!filterLabels.isEmpty() &amp;&amp; !filterLabels.stream().anyMatch(prLabels::contains)) {
1026                     continue;
1027                 }
1028 
1029                 var prIssues = new HashSet&lt;&gt;(issuesFromPullRequest(pr));
1030                 if (!filterIssues.isEmpty() &amp;&amp; !filterIssues.stream().anyMatch(prIssues::contains)) {
1031                     continue;
1032                 }
1033 
1034 
1035                 ids.add(pr.id());
1036                 titles.add(pr.title());
1037                 authors.add(prAuthor);
1038                 assignees.add(String.join(&quot;,&quot;, prAssignees));
1039                 labels.add(String.join(&quot;,&quot;, prLabels));
1040                 issues.add(String.join(&quot;,&quot;, prIssues));







1041             }
1042 
1043 
1044             String fmt = &quot;&quot;;
1045             for (var column : columns.subList(0, columns.size() - 1)) {
1046                 var values = columnValues.get(column);
1047                 var n = Math.max(column.length(), longest(values));
1048                 fmt += &quot;%-&quot; + n + &quot;s\t&quot;;
1049             }
1050             fmt += &quot;%s\n&quot;;
1051 
1052             var noDecoration = getSwitch(&quot;no-decoration&quot;, &quot;list&quot;, arguments);
1053             if (!ids.isEmpty() &amp;&amp; !noDecoration) {
1054                 var upperCase = columns.stream()
1055                                        .map(String::toUpperCase)
1056                                        .collect(Collectors.toList());
1057                 System.out.format(fmt, (Object[]) upperCase.toArray(new String[0]));
1058             }
1059             for (var i = 0; i &lt; ids.size(); i++) {
1060                 final int n = i;
1061                 var row = columns.stream()
1062                                  .map(columnValues::get)
1063                                  .map(values -&gt; values.get(n))
1064                                  .collect(Collectors.toList());
1065                 System.out.format(fmt, (Object[]) row.toArray(new String[0]));
1066             }
1067         } else if (action.equals(&quot;fetch&quot;) || action.equals(&quot;checkout&quot;) || action.equals(&quot;show&quot;) || action.equals(&quot;apply&quot;)) {
1068             var prId = arguments.at(1);
1069             if (!prId.isPresent()) {
1070                 exit(&quot;error: missing pull request identifier&quot;);
1071             }
1072 
1073             var remoteRepo = getHostedRepositoryFor(uri, repo, host);
1074             var pr = remoteRepo.pullRequest(prId.asString());
1075             var repoUrl = remoteRepo.webUrl();
<span class="line-modified">1076             var prHeadRef = pr.sourceRef();</span>
1077             var isHgGit = isMercurial &amp;&amp; Repository.exists(repo.root().resolve(&quot;.hg&quot;).resolve(&quot;git&quot;));
1078             if (isHgGit) {
1079                 var hgGitRepo = Repository.get(repo.root().resolve(&quot;.hg&quot;).resolve(&quot;git&quot;)).get();
1080                 var hgGitFetchHead = hgGitRepo.fetch(repoUrl, prHeadRef);
1081 
1082                 if (action.equals(&quot;show&quot;) || action.equals(&quot;apply&quot;)) {
1083                     var target = hgGitRepo.fetch(repoUrl, pr.targetRef());
1084                     var hgGitMergeBase = hgGitRepo.mergeBase(target, hgGitFetchHead);
1085 
1086                     if (action.equals(&quot;show&quot;)) {
1087                         show(hgGitMergeBase.hex(), hgGitFetchHead, hgGitRepo.root());
1088                     } else {
1089                         var patch = diff(hgGitMergeBase.hex(), hgGitFetchHead, hgGitRepo.root());
1090                         hgImport(patch);
1091                         Files.delete(patch);
1092                     }
1093                 } else if (action.equals(&quot;fetch&quot;) || action.equals(&quot;checkout&quot;)) {
1094                     var hgGitRef = prHeadRef.endsWith(&quot;/head&quot;) ? prHeadRef.replace(&quot;/head&quot;, &quot;&quot;) : prHeadRef;
1095                     var hgGitBranches = hgGitRepo.branches();
1096                     if (hgGitBranches.contains(new Branch(hgGitRef))) {
</pre>
<hr />
<pre>
1098                     }
1099                     hgGitRepo.branch(hgGitFetchHead, hgGitRef);
1100                     gimport();
1101                     var hgFetchHead = repo.resolve(hgGitRef).get();
1102 
1103                     if (action.equals(&quot;fetch&quot;) &amp;&amp; arguments.contains(&quot;branch&quot;)) {
1104                         repo.branch(hgFetchHead, arguments.get(&quot;branch&quot;).asString());
1105                     } else if (action.equals(&quot;checkout&quot;)) {
1106                         repo.checkout(hgFetchHead);
1107                         if (arguments.contains(&quot;branch&quot;)) {
1108                             repo.branch(hgFetchHead, arguments.get(&quot;branch&quot;).asString());
1109                         }
1110                     }
1111                 } else {
1112                     exit(&quot;Unexpected action: &quot; + action);
1113                 }
1114 
1115                 return;
1116             }
1117 
<span class="line-modified">1118             var fetchHead = repo.fetch(repoUrl, pr.sourceRef());</span>
1119             if (action.equals(&quot;fetch&quot;)) {
1120                 var branchName = getOption(&quot;branch&quot;, &quot;fetch&quot;, arguments);
1121                 if (branchName != null) {
1122                     repo.branch(fetchHead, branchName);
1123                 } else {
1124                     System.out.println(fetchHead.hex());
1125                 }
1126             } else if (action.equals(&quot;checkout&quot;)) {
1127                 var branchName = getOption(&quot;branch&quot;, &quot;checkout&quot;, arguments);
1128                 if (branchName != null) {
1129                     var branch = repo.branch(fetchHead, branchName);
1130                     repo.checkout(branch, false);
1131                 } else {
1132                     repo.checkout(fetchHead, false);
1133                 }
1134             } else if (action.equals(&quot;show&quot;)) {
1135                 show(pr.targetRef(), fetchHead);
1136             } else if (action.equals(&quot;apply&quot;)) {
1137                 var patch = diff(pr.targetRef(), fetchHead);
1138                 apply(patch);
</pre>
</td>
<td>
<hr />
<pre>
 949             var pr = getPullRequest(uri, repo, host, id);
 950 
 951             if (action.equals(&quot;integrate&quot;)) {
 952                 pr.addComment(&quot;/integrate&quot;);
 953             } else if (action.equals(&quot;test&quot;)) {
 954                 pr.addComment(&quot;/test&quot;);
 955             } else if (action.equals(&quot;approve&quot;)) {
 956                 pr.addReview(Review.Verdict.APPROVED, &quot;Looks good!&quot;);
 957             } else {
 958                 throw new IllegalStateException(&quot;unexpected action: &quot; + action);
 959             }
 960         } else if (action.equals(&quot;list&quot;)) {
 961             var remoteRepo = getHostedRepositoryFor(uri, repo, host);
 962             var prs = remoteRepo.pullRequests();
 963             var ids = new ArrayList&lt;String&gt;();
 964             var titles = new ArrayList&lt;String&gt;();
 965             var authors = new ArrayList&lt;String&gt;();
 966             var assignees = new ArrayList&lt;String&gt;();
 967             var labels = new ArrayList&lt;String&gt;();
 968             var issues = new ArrayList&lt;String&gt;();
<span class="line-added"> 969             var branches = new ArrayList&lt;String&gt;();</span>
 970 
 971             var authorsOption = getOption(&quot;authors&quot;, &quot;list&quot;, arguments);
 972             var filterAuthors = authorsOption == null ?
 973                 Set.of() :
 974                 new HashSet&lt;&gt;(Arrays.asList(authorsOption.split(&quot;,&quot;)));
 975 
 976             var assigneesOption = getOption(&quot;assignees&quot;, &quot;list&quot;, arguments);
 977             var filterAssignees = assigneesOption == null ?
 978                 Set.of() :
 979                 Arrays.asList(assigneesOption.split(&quot;,&quot;));
 980 
 981             var labelsOption = getOption(&quot;labels&quot;, &quot;list&quot;, arguments);
 982             var filterLabels = labelsOption == null ?
 983                 Set.of() :
 984                 Arrays.asList(labelsOption.split(&quot;,&quot;));
 985 
 986             var issuesOption = getOption(&quot;issues&quot;, &quot;list&quot;, arguments);
 987             var filterIssues = issuesOption == null ?
 988                 Set.of() :
 989                 Arrays.asList(issuesOption.split(&quot;,&quot;));
 990 
<span class="line-modified"> 991             var defaultColumns = List.of(&quot;id&quot;, &quot;title&quot;, &quot;authors&quot;, &quot;assignees&quot;, &quot;labels&quot;, &quot;issues&quot;, &quot;branch&quot;);</span>
 992             var columnValues = Map.of(defaultColumns.get(0), ids,
 993                                       defaultColumns.get(1), titles,
 994                                       defaultColumns.get(2), authors,
 995                                       defaultColumns.get(3), assignees,
 996                                       defaultColumns.get(4), labels,
<span class="line-modified"> 997                                       defaultColumns.get(5), issues,</span>
<span class="line-added"> 998                                       defaultColumns.get(6), branches);</span>
 999             var columnsOption = getOption(&quot;columns&quot;, &quot;list&quot;, arguments);
1000             var columns = columnsOption == null ?
1001                 defaultColumns :
1002                 Arrays.asList(columnsOption.split(&quot;,&quot;));
1003             if (columns != defaultColumns) {
1004                 for (var column : columns) {
1005                     if (!defaultColumns.contains(column)) {
1006                         System.err.println(&quot;error: unknown column: &quot; + column);
1007                         System.err.println(&quot;       available columns are: &quot; + String.join(&quot;,&quot;, defaultColumns));
1008                         System.exit(1);
1009                     }
1010                 }
1011             }
1012 
1013             for (var pr : prs) {
1014                 var prAuthor = pr.author().userName();
1015                 if (!filterAuthors.isEmpty() &amp;&amp; !filterAuthors.contains(prAuthor)) {
1016                     continue;
1017                 }
1018 
</pre>
<hr />
<pre>
1023                     continue;
1024                 }
1025 
1026                 var prLabels = new HashSet&lt;&gt;(pr.labels());
1027                 if (!filterLabels.isEmpty() &amp;&amp; !filterLabels.stream().anyMatch(prLabels::contains)) {
1028                     continue;
1029                 }
1030 
1031                 var prIssues = new HashSet&lt;&gt;(issuesFromPullRequest(pr));
1032                 if (!filterIssues.isEmpty() &amp;&amp; !filterIssues.stream().anyMatch(prIssues::contains)) {
1033                     continue;
1034                 }
1035 
1036 
1037                 ids.add(pr.id());
1038                 titles.add(pr.title());
1039                 authors.add(prAuthor);
1040                 assignees.add(String.join(&quot;,&quot;, prAssignees));
1041                 labels.add(String.join(&quot;,&quot;, prLabels));
1042                 issues.add(String.join(&quot;,&quot;, prIssues));
<span class="line-added">1043 </span>
<span class="line-added">1044                 if (pr.author().userName().equals(credentials.username()) &amp;&amp;</span>
<span class="line-added">1045                     pr.sourceRepository().webUrl().equals(uri)) {</span>
<span class="line-added">1046                     branches.add(pr.sourceRef());</span>
<span class="line-added">1047                 } else {</span>
<span class="line-added">1048                     branches.add(&quot;&quot;);</span>
<span class="line-added">1049                 }</span>
1050             }
1051 
1052 
1053             String fmt = &quot;&quot;;
1054             for (var column : columns.subList(0, columns.size() - 1)) {
1055                 var values = columnValues.get(column);
1056                 var n = Math.max(column.length(), longest(values));
1057                 fmt += &quot;%-&quot; + n + &quot;s\t&quot;;
1058             }
1059             fmt += &quot;%s\n&quot;;
1060 
1061             var noDecoration = getSwitch(&quot;no-decoration&quot;, &quot;list&quot;, arguments);
1062             if (!ids.isEmpty() &amp;&amp; !noDecoration) {
1063                 var upperCase = columns.stream()
1064                                        .map(String::toUpperCase)
1065                                        .collect(Collectors.toList());
1066                 System.out.format(fmt, (Object[]) upperCase.toArray(new String[0]));
1067             }
1068             for (var i = 0; i &lt; ids.size(); i++) {
1069                 final int n = i;
1070                 var row = columns.stream()
1071                                  .map(columnValues::get)
1072                                  .map(values -&gt; values.get(n))
1073                                  .collect(Collectors.toList());
1074                 System.out.format(fmt, (Object[]) row.toArray(new String[0]));
1075             }
1076         } else if (action.equals(&quot;fetch&quot;) || action.equals(&quot;checkout&quot;) || action.equals(&quot;show&quot;) || action.equals(&quot;apply&quot;)) {
1077             var prId = arguments.at(1);
1078             if (!prId.isPresent()) {
1079                 exit(&quot;error: missing pull request identifier&quot;);
1080             }
1081 
1082             var remoteRepo = getHostedRepositoryFor(uri, repo, host);
1083             var pr = remoteRepo.pullRequest(prId.asString());
1084             var repoUrl = remoteRepo.webUrl();
<span class="line-modified">1085             var prHeadRef = pr.fetchRef();</span>
1086             var isHgGit = isMercurial &amp;&amp; Repository.exists(repo.root().resolve(&quot;.hg&quot;).resolve(&quot;git&quot;));
1087             if (isHgGit) {
1088                 var hgGitRepo = Repository.get(repo.root().resolve(&quot;.hg&quot;).resolve(&quot;git&quot;)).get();
1089                 var hgGitFetchHead = hgGitRepo.fetch(repoUrl, prHeadRef);
1090 
1091                 if (action.equals(&quot;show&quot;) || action.equals(&quot;apply&quot;)) {
1092                     var target = hgGitRepo.fetch(repoUrl, pr.targetRef());
1093                     var hgGitMergeBase = hgGitRepo.mergeBase(target, hgGitFetchHead);
1094 
1095                     if (action.equals(&quot;show&quot;)) {
1096                         show(hgGitMergeBase.hex(), hgGitFetchHead, hgGitRepo.root());
1097                     } else {
1098                         var patch = diff(hgGitMergeBase.hex(), hgGitFetchHead, hgGitRepo.root());
1099                         hgImport(patch);
1100                         Files.delete(patch);
1101                     }
1102                 } else if (action.equals(&quot;fetch&quot;) || action.equals(&quot;checkout&quot;)) {
1103                     var hgGitRef = prHeadRef.endsWith(&quot;/head&quot;) ? prHeadRef.replace(&quot;/head&quot;, &quot;&quot;) : prHeadRef;
1104                     var hgGitBranches = hgGitRepo.branches();
1105                     if (hgGitBranches.contains(new Branch(hgGitRef))) {
</pre>
<hr />
<pre>
1107                     }
1108                     hgGitRepo.branch(hgGitFetchHead, hgGitRef);
1109                     gimport();
1110                     var hgFetchHead = repo.resolve(hgGitRef).get();
1111 
1112                     if (action.equals(&quot;fetch&quot;) &amp;&amp; arguments.contains(&quot;branch&quot;)) {
1113                         repo.branch(hgFetchHead, arguments.get(&quot;branch&quot;).asString());
1114                     } else if (action.equals(&quot;checkout&quot;)) {
1115                         repo.checkout(hgFetchHead);
1116                         if (arguments.contains(&quot;branch&quot;)) {
1117                             repo.branch(hgFetchHead, arguments.get(&quot;branch&quot;).asString());
1118                         }
1119                     }
1120                 } else {
1121                     exit(&quot;Unexpected action: &quot; + action);
1122                 }
1123 
1124                 return;
1125             }
1126 
<span class="line-modified">1127             var fetchHead = repo.fetch(repoUrl, pr.fetchRef());</span>
1128             if (action.equals(&quot;fetch&quot;)) {
1129                 var branchName = getOption(&quot;branch&quot;, &quot;fetch&quot;, arguments);
1130                 if (branchName != null) {
1131                     repo.branch(fetchHead, branchName);
1132                 } else {
1133                     System.out.println(fetchHead.hex());
1134                 }
1135             } else if (action.equals(&quot;checkout&quot;)) {
1136                 var branchName = getOption(&quot;branch&quot;, &quot;checkout&quot;, arguments);
1137                 if (branchName != null) {
1138                     var branch = repo.branch(fetchHead, branchName);
1139                     repo.checkout(branch, false);
1140                 } else {
1141                     repo.checkout(fetchHead, false);
1142                 }
1143             } else if (action.equals(&quot;show&quot;)) {
1144                 show(pr.targetRef(), fetchHead);
1145             } else if (action.equals(&quot;apply&quot;)) {
1146                 var patch = diff(pr.targetRef(), fetchHead);
1147                 apply(patch);
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../../bots/tester/src/test/java/org/openjdk/skara/bots/tester/InMemoryPullRequest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../forge/src/main/java/org/openjdk/skara/forge/PullRequest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>