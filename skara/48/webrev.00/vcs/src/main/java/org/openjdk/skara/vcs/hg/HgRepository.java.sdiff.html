<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff vcs/src/main/java/org/openjdk/skara/vcs/hg/HgRepository.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="HgCommitMetadata.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../openjdk/convert/GitToHgConverter.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>vcs/src/main/java/org/openjdk/skara/vcs/hg/HgRepository.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.vcs.hg;
 24 
 25 import org.openjdk.skara.process.Process;
 26 import org.openjdk.skara.process.Execution;
 27 import org.openjdk.skara.vcs.*;
 28 import org.openjdk.skara.vcs.tools.*;
 29 
 30 import java.io.*;
 31 import java.nio.file.*;
<span class="line-modified"> 32 import java.time.Instant;</span>
<span class="line-modified"> 33 import java.time.ZonedDateTime;</span>
<span class="line-removed"> 34 import java.time.ZoneOffset;</span>
 35 import java.util.*;
 36 import java.util.logging.Logger;
 37 import java.util.stream.*;
 38 import java.net.URI;
 39 
 40 public class HgRepository implements Repository {
 41     private static final String EXT_PY = &quot;ext.py&quot;;
 42     private final Path dir;
 43     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.vcs.hg&quot;);
 44 
 45     private void copyResource(String name, Path p) throws IOException {
 46         Files.copy(this.getClass().getResourceAsStream(&quot;/&quot; + name), p, StandardCopyOption.REPLACE_EXISTING);
 47     }
 48 
 49     private java.lang.Process start(String... cmd) throws IOException {
 50         return start(Arrays.asList(cmd));
 51     }
 52 
 53     private java.lang.Process start(List&lt;String&gt; cmd) throws IOException {
 54         log.fine(&quot;Executing &quot; + String.join(&quot; &quot;, cmd));
</pre>
<hr />
<pre>
475         var revset = &quot;.:&quot; + h.hex() + &quot; and not .&quot;;
476         var patch = Files.createTempFile(&quot;squash&quot;, &quot;.patch&quot;);
477         export(revset, patch);
478 
479         try (var p = capture(&quot;hg&quot;, &quot;--config&quot;, &quot;extensions.mq=&quot;, &quot;strip&quot;, &quot;--rev&quot;, revset)) {
480             await(p);
481         }
482 
483         try (var p = capture(&quot;hg&quot;, &quot;import&quot;, &quot;--no-commit&quot;, patch.toString())) {
484             await(p);
485         }
486     }
487 
488 
489     @Override
490     public Hash commit(String message, String authorName, String authorEmail)  throws IOException {
491         return commit(message, authorName, authorEmail, null);
492     }
493 
494     @Override
<span class="line-modified">495     public Hash commit(String message, String authorName, String authorEmail, Instant authorDate)  throws IOException {</span>
496         var user = authorEmail == null ? authorName : authorName + &quot; &lt;&quot; + authorEmail + &quot;&gt;&quot;;
497         var cmd = new ArrayList&lt;String&gt;();
498         cmd.addAll(List.of(&quot;hg&quot;, &quot;commit&quot;, &quot;--message=&quot; + message, &quot;--user=&quot; + user));
499         if (authorDate != null) {
<span class="line-modified">500             var date = ZonedDateTime.ofInstant(authorDate, ZoneOffset.UTC);</span>
<span class="line-modified">501             cmd.add(&quot;--date=&quot; + date.toEpochSecond() + &quot; 0&quot;);</span>
502         }
503         try (var p = capture(cmd)) {
504             await(p);
505         }
506         return resolve(&quot;tip&quot;).orElseThrow(() -&gt; new IOException(&quot;Could not resolve &#39;tip&#39;&quot;));
507     }
508 
509     @Override
510     public Hash commit(String message,
511                        String authorName,
512                        String authorEmail,
513                        String committerName,
514                        String committerEmail) throws IOException {
515         return commit(message, authorName, authorEmail, null, committerName, committerEmail, null);
516     }
517 
518     @Override
519     public Hash commit(String message,
520                        String authorName,
521                        String authorEmail,
<span class="line-modified">522                        Instant authorDate,</span>
523                        String committerName,
524                        String committerEmail,
<span class="line-modified">525                        Instant committerDate) throws IOException {</span>
526         if (!Objects.equals(authorName, committerName) ||
527             !Objects.equals(authorEmail, committerEmail) ||
528             !Objects.equals(authorDate, committerDate)) {
529             throw new IllegalArgumentException(&quot;hg does not support different author and committer data&quot;);
530         }
531 
532         return commit(message, authorName, authorEmail, authorDate);
533     }
534 
535     @Override
536     public Hash amend(String message, String authorName, String authorEmail) throws IOException {
537         throw new RuntimeException(&quot;Not implemented yet&quot;);
538     }
539 
540     @Override
541     public Hash amend(String message, String authorName, String authorEmail, String committerName, String committerEmail) throws IOException {
542         throw new RuntimeException(&quot;Not implemented yet&quot;);
543     }
544 
545     @Override
</pre>
</td>
<td>
<hr />
<pre>
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.vcs.hg;
 24 
 25 import org.openjdk.skara.process.Process;
 26 import org.openjdk.skara.process.Execution;
 27 import org.openjdk.skara.vcs.*;
 28 import org.openjdk.skara.vcs.tools.*;
 29 
 30 import java.io.*;
 31 import java.nio.file.*;
<span class="line-modified"> 32 import java.time.*;</span>
<span class="line-modified"> 33 import java.time.format.DateTimeFormatter;</span>

 34 import java.util.*;
 35 import java.util.logging.Logger;
 36 import java.util.stream.*;
 37 import java.net.URI;
 38 
 39 public class HgRepository implements Repository {
 40     private static final String EXT_PY = &quot;ext.py&quot;;
 41     private final Path dir;
 42     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.vcs.hg&quot;);
 43 
 44     private void copyResource(String name, Path p) throws IOException {
 45         Files.copy(this.getClass().getResourceAsStream(&quot;/&quot; + name), p, StandardCopyOption.REPLACE_EXISTING);
 46     }
 47 
 48     private java.lang.Process start(String... cmd) throws IOException {
 49         return start(Arrays.asList(cmd));
 50     }
 51 
 52     private java.lang.Process start(List&lt;String&gt; cmd) throws IOException {
 53         log.fine(&quot;Executing &quot; + String.join(&quot; &quot;, cmd));
</pre>
<hr />
<pre>
474         var revset = &quot;.:&quot; + h.hex() + &quot; and not .&quot;;
475         var patch = Files.createTempFile(&quot;squash&quot;, &quot;.patch&quot;);
476         export(revset, patch);
477 
478         try (var p = capture(&quot;hg&quot;, &quot;--config&quot;, &quot;extensions.mq=&quot;, &quot;strip&quot;, &quot;--rev&quot;, revset)) {
479             await(p);
480         }
481 
482         try (var p = capture(&quot;hg&quot;, &quot;import&quot;, &quot;--no-commit&quot;, patch.toString())) {
483             await(p);
484         }
485     }
486 
487 
488     @Override
489     public Hash commit(String message, String authorName, String authorEmail)  throws IOException {
490         return commit(message, authorName, authorEmail, null);
491     }
492 
493     @Override
<span class="line-modified">494     public Hash commit(String message, String authorName, String authorEmail, ZonedDateTime authorDate)  throws IOException {</span>
495         var user = authorEmail == null ? authorName : authorName + &quot; &lt;&quot; + authorEmail + &quot;&gt;&quot;;
496         var cmd = new ArrayList&lt;String&gt;();
497         cmd.addAll(List.of(&quot;hg&quot;, &quot;commit&quot;, &quot;--message=&quot; + message, &quot;--user=&quot; + user));
498         if (authorDate != null) {
<span class="line-modified">499             var formatter = DateTimeFormatter.ISO_OFFSET_DATE_TIME;</span>
<span class="line-modified">500             cmd.add(&quot;--date=&quot; + authorDate.format(formatter));</span>
501         }
502         try (var p = capture(cmd)) {
503             await(p);
504         }
505         return resolve(&quot;tip&quot;).orElseThrow(() -&gt; new IOException(&quot;Could not resolve &#39;tip&#39;&quot;));
506     }
507 
508     @Override
509     public Hash commit(String message,
510                        String authorName,
511                        String authorEmail,
512                        String committerName,
513                        String committerEmail) throws IOException {
514         return commit(message, authorName, authorEmail, null, committerName, committerEmail, null);
515     }
516 
517     @Override
518     public Hash commit(String message,
519                        String authorName,
520                        String authorEmail,
<span class="line-modified">521                        ZonedDateTime authorDate,</span>
522                        String committerName,
523                        String committerEmail,
<span class="line-modified">524                        ZonedDateTime committerDate) throws IOException {</span>
525         if (!Objects.equals(authorName, committerName) ||
526             !Objects.equals(authorEmail, committerEmail) ||
527             !Objects.equals(authorDate, committerDate)) {
528             throw new IllegalArgumentException(&quot;hg does not support different author and committer data&quot;);
529         }
530 
531         return commit(message, authorName, authorEmail, authorDate);
532     }
533 
534     @Override
535     public Hash amend(String message, String authorName, String authorEmail) throws IOException {
536         throw new RuntimeException(&quot;Not implemented yet&quot;);
537     }
538 
539     @Override
540     public Hash amend(String message, String authorName, String authorEmail, String committerName, String committerEmail) throws IOException {
541         throw new RuntimeException(&quot;Not implemented yet&quot;);
542     }
543 
544     @Override
</pre>
</td>
</tr>
</table>
<center><a href="HgCommitMetadata.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../openjdk/convert/GitToHgConverter.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>