<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="MailingListArchiveReaderBotTests.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  96         return &quot;test+&quot; + repository.forge().currentUser().id() + &quot;+&quot; +
  97                 repository.forge().currentUser().userName() +
  98                 &quot;@openjdk.java.net&quot;;
  99     }
 100 
 101     @Test
 102     void simpleArchive(TestInfo testInfo) throws IOException {
 103         try (var credentials = new HostCredentials(testInfo);
 104              var tempFolder = new TemporaryDirectory();
 105              var archiveFolder = new TemporaryDirectory();
 106              var webrevFolder = new TemporaryDirectory();
 107              var listServer = new TestMailmanServer();
 108              var webrevServer = new TestWebrevServer()) {
 109             var author = credentials.getHostedRepository();
 110             var archive = credentials.getHostedRepository();
 111             var ignored = credentials.getHostedRepository();
 112             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 113             var censusBuilder = credentials.getCensusBuilder()
 114                                            .addAuthor(author.forge().currentUser().id());
 115             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 116             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,</span>
<span class="line-modified"> 117                                                  censusBuilder.build(), &quot;master&quot;, listAddress,</span>
<span class="line-modified"> 118                                                  Set.of(ignored.forge().currentUser().userName()),</span>
<span class="line-modified"> 119                                                  Set.of(),</span>
<span class="line-modified"> 120                                                  listServer.getArchive(), listServer.getSMTP(),</span>
<span class="line-modified"> 121                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),</span>
<span class="line-modified"> 122                                                  webrevServer.uri(),</span>
<span class="line-modified"> 123                                                  Set.of(&quot;rfr&quot;), Map.of(ignored.forge().currentUser().userName(),</span>
<span class="line-modified"> 124                                                                        Pattern.compile(&quot;ready&quot;)),</span>
<span class="line-modified"> 125                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),</span>
<span class="line-modified"> 126                                                  Map.of(&quot;Extra1&quot;, &quot;val1&quot;, &quot;Extra2&quot;, &quot;val2&quot;),</span>
<span class="line-modified"> 127                                                  Duration.ZERO);</span>








 128 
 129             // Populate the projects repository
 130             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 131             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 132             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 133             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 134 
 135             // Make a change with a corresponding PR
 136             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 137                                                                &quot;Change msg\n\nWith several lines&quot;);
 138             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 139             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 140             pr.setBody(&quot;This should not be ready&quot;);
 141 
 142             // Run an archive pass
 143             TestBotRunner.runPeriodicItems(mlBot);
 144 
 145             // A PR that isn&#39;t ready for review should not be archived
 146             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 147             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
</pre>
<hr />
<pre>
 255                 assertEquals(listAddress, newMail.sender());
 256             }
 257             assertTrue(conversations.get(0).allMessages().get(2).body().contains(&quot;This is a comment ðŸ˜„&quot;));
 258         }
 259     }
 260 
 261     @Test
 262     void reviewComment(TestInfo testInfo) throws IOException {
 263         try (var credentials = new HostCredentials(testInfo);
 264              var tempFolder = new TemporaryDirectory();
 265              var archiveFolder = new TemporaryDirectory();
 266              var listServer = new TestMailmanServer();
 267              var webrevServer = new TestWebrevServer()) {
 268             var author = credentials.getHostedRepository();
 269             var archive = credentials.getHostedRepository();
 270             var ignored = credentials.getHostedRepository();
 271             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 272             var censusBuilder = credentials.getCensusBuilder()
 273                                            .addAuthor(author.forge().currentUser().id());
 274             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 275             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,</span>
<span class="line-modified"> 276                                                  censusBuilder.build(), &quot;master&quot;, listAddress,</span>
<span class="line-modified"> 277                                                  Set.of(ignored.forge().currentUser().userName()),</span>
<span class="line-modified"> 278                                                  Set.of(),</span>
<span class="line-modified"> 279                                                  listServer.getArchive(), listServer.getSMTP(),</span>
<span class="line-modified"> 280                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),</span>
<span class="line-modified"> 281                                                  webrevServer.uri(),</span>
<span class="line-modified"> 282                                                  Set.of(), Map.of(),</span>
<span class="line-modified"> 283                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),</span>
<span class="line-modified"> 284                                                  Map.of(), Duration.ZERO);</span>





 285 
 286             // Populate the projects repository
 287             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 288             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 289             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 290             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 291             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 292 
 293             // Make a change with a corresponding PR
 294             var editHash = CheckableRepository.appendAndCommit(localRepo);
 295             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 296             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 297             pr.setBody(&quot;This is now ready&quot;);
 298             TestBotRunner.runPeriodicItems(mlBot);
 299             listServer.processIncoming();
 300 
 301             // And make a file specific comment
 302             var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
 303             var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 304 
</pre>
<hr />
<pre>
 345             for (var newMail : conversations.get(0).allMessages()) {
 346                 assertEquals(noreplyAddress(archive), newMail.author().address());
 347                 assertEquals(listAddress, newMail.sender());
 348             }
 349         }
 350     }
 351 
 352     @Test
 353     void combineComments(TestInfo testInfo) throws IOException {
 354         try (var credentials = new HostCredentials(testInfo);
 355              var tempFolder = new TemporaryDirectory();
 356              var archiveFolder = new TemporaryDirectory();
 357              var listServer = new TestMailmanServer();
 358              var webrevServer = new TestWebrevServer()) {
 359             var author = credentials.getHostedRepository();
 360             var archive = credentials.getHostedRepository();
 361             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 362             var censusBuilder = credentials.getCensusBuilder()
 363                                            .addAuthor(author.forge().currentUser().id());
 364             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 365             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,</span>
<span class="line-modified"> 366                                                  censusBuilder.build(), &quot;master&quot;,</span>
<span class="line-modified"> 367                                                  listAddress, Set.of(), Set.of(),</span>
<span class="line-modified"> 368                                                  listServer.getArchive(),</span>
<span class="line-modified"> 369                                                  listServer.getSMTP(),</span>
<span class="line-modified"> 370                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),</span>
<span class="line-modified"> 371                                                  webrevServer.uri(),</span>
<span class="line-modified"> 372                                                  Set.of(), Map.of(),</span>
<span class="line-modified"> 373                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),</span>
<span class="line-modified"> 374                                                  Map.of(), Duration.ZERO);</span>




 375 
 376             // Populate the projects repository
 377             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 378             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 379             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 380             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 381             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 382 
 383             // Make a change with a corresponding PR
 384             var editHash = CheckableRepository.appendAndCommit(localRepo);
 385             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 386             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 387             pr.setBody(&quot;This is now ready&quot;);
 388             pr.addComment(&quot;Avoid combining&quot;);
 389 
 390             TestBotRunner.runPeriodicItems(mlBot);
 391             listServer.processIncoming();
 392             listServer.processIncoming();
 393 
 394             // Make several file specific comments
</pre>
<hr />
<pre>
 435             // The combined review comments should only appear unquoted once
 436             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^Another review comment&quot;));
 437         }
 438     }
 439 
 440     @Test
 441     void commentThreading(TestInfo testInfo) throws IOException {
 442         try (var credentials = new HostCredentials(testInfo);
 443              var tempFolder = new TemporaryDirectory();
 444              var archiveFolder = new TemporaryDirectory();
 445              var listServer = new TestMailmanServer();
 446              var webrevServer = new TestWebrevServer()) {
 447             var author = credentials.getHostedRepository();
 448             var reviewer = credentials.getHostedRepository();
 449             var archive = credentials.getHostedRepository();
 450             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 451             var censusBuilder = credentials.getCensusBuilder()
 452                                            .addReviewer(reviewer.forge().currentUser().id())
 453                                            .addAuthor(author.forge().currentUser().id());
 454             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 455             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,</span>
<span class="line-modified"> 456                                                  censusBuilder.build(), &quot;master&quot;,</span>
<span class="line-modified"> 457                                                  listAddress, Set.of(), Set.of(),</span>
<span class="line-modified"> 458                                                  listServer.getArchive(),</span>
<span class="line-modified"> 459                                                  listServer.getSMTP(),</span>
<span class="line-modified"> 460                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),</span>
<span class="line-modified"> 461                                                  webrevServer.uri(),</span>
<span class="line-modified"> 462                                                  Set.of(), Map.of(),</span>
<span class="line-modified"> 463                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),</span>
<span class="line-modified"> 464                                                  Map.of(), Duration.ZERO);</span>




 465 
 466             // Populate the projects repository
 467             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 468             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 469             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 470             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 471             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 472 
 473             // Make a change with a corresponding PR
 474             var editHash = CheckableRepository.appendAndCommit(localRepo);
 475             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 476             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 477             pr.setBody(&quot;This is now ready&quot;);
 478             TestBotRunner.runPeriodicItems(mlBot);
 479             listServer.processIncoming();
 480 
 481             // Make a file specific comment
 482             var reviewPr = reviewer.pullRequest(pr.id());
 483             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 484             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
</pre>
<hr />
<pre>
 560             assertTrue(thread4.body().contains(&quot;The final review comment&quot;));
 561             assertTrue(thread4.body().contains(&quot;Marked as reviewed by integrationreviewer1 (Reviewer)&quot;));
 562         }
 563     }
 564 
 565     @Test
 566     void commentThreadingSeparated(TestInfo testInfo) throws IOException {
 567         try (var credentials = new HostCredentials(testInfo);
 568              var tempFolder = new TemporaryDirectory();
 569              var archiveFolder = new TemporaryDirectory();
 570              var listServer = new TestMailmanServer();
 571              var webrevServer = new TestWebrevServer()) {
 572             var author = credentials.getHostedRepository();
 573             var reviewer = credentials.getHostedRepository();
 574             var archive = credentials.getHostedRepository();
 575             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 576             var censusBuilder = credentials.getCensusBuilder()
 577                                            .addReviewer(reviewer.forge().currentUser().id())
 578                                            .addAuthor(author.forge().currentUser().id());
 579             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 580             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;, censusBuilder.build(), &quot;master&quot;,</span>
<span class="line-modified"> 581                                                  listAddress, Set.of(), Set.of(),</span>
<span class="line-modified"> 582                                                  listServer.getArchive(),</span>
<span class="line-modified"> 583                                                  listServer.getSMTP(),</span>
<span class="line-modified"> 584                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),</span>
<span class="line-modified"> 585                                                  webrevServer.uri(),</span>
<span class="line-modified"> 586                                                  Set.of(), Map.of(),</span>
<span class="line-modified"> 587                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),</span>
<span class="line-modified"> 588                                                  Map.of(), Duration.ZERO);</span>





 589 
 590             // Populate the projects repository
 591             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 592             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 593             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 594             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 595             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 596 
 597             // Make a change with a corresponding PR
 598             var editHash = CheckableRepository.appendAndCommit(localRepo);
 599             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 600             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 601             pr.setBody(&quot;This is now ready&quot;);
 602             TestBotRunner.runPeriodicItems(mlBot);
 603             listServer.processIncoming();
 604 
 605             // Make two file specific comments
 606             var reviewPr = reviewer.pullRequest(pr.id());
 607             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 608             var comment2 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
</pre>
<hr />
<pre>
 616 
 617             // Sanity check the archive
 618             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 619             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 620         }
 621     }
 622 
 623     @Test
 624     void reviewContext(TestInfo testInfo) throws IOException {
 625         try (var credentials = new HostCredentials(testInfo);
 626              var tempFolder = new TemporaryDirectory();
 627              var archiveFolder = new TemporaryDirectory();
 628              var listServer = new TestMailmanServer();
 629              var webrevServer = new TestWebrevServer()) {
 630             var author = credentials.getHostedRepository();
 631             var archive = credentials.getHostedRepository();
 632             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 633             var censusBuilder = credentials.getCensusBuilder()
 634                                            .addAuthor(author.forge().currentUser().id());
 635             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 636             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,</span>
<span class="line-modified"> 637                                                  censusBuilder.build(), &quot;master&quot;,</span>
<span class="line-modified"> 638                                                  listAddress, Set.of(), Set.of(),</span>
<span class="line-modified"> 639                                                  listServer.getArchive(),</span>
<span class="line-modified"> 640                                                  listServer.getSMTP(),</span>
<span class="line-modified"> 641                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),</span>
<span class="line-modified"> 642                                                  webrevServer.uri(),</span>
<span class="line-modified"> 643                                                  Set.of(), Map.of(),</span>
<span class="line-modified"> 644                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),</span>
<span class="line-modified"> 645                                                  Map.of(), Duration.ZERO);</span>




 646 
 647             // Populate the projects repository
 648             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 649             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 650             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 651             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 652             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 653 
 654             // Make a change with a corresponding PR
 655             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
 656             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 657             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 658             pr.setBody(&quot;This is now ready&quot;);
 659             TestBotRunner.runPeriodicItems(mlBot);
 660             listServer.processIncoming();
 661 
 662             // Make a file specific comment
 663             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 664 
 665             TestBotRunner.runPeriodicItems(mlBot);
</pre>
<hr />
<pre>
 669             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 670             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
 671             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
 672             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
 673         }
 674     }
 675 
 676     @Test
 677     void multipleReviewContexts(TestInfo testInfo) throws IOException {
 678         try (var credentials = new HostCredentials(testInfo);
 679              var tempFolder = new TemporaryDirectory();
 680              var archiveFolder = new TemporaryDirectory();
 681              var listServer = new TestMailmanServer();
 682              var webrevServer = new TestWebrevServer()) {
 683             var author = credentials.getHostedRepository();
 684             var archive = credentials.getHostedRepository();
 685             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 686             var censusBuilder = credentials.getCensusBuilder()
 687                                            .addAuthor(author.forge().currentUser().id());
 688             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 689             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,</span>
<span class="line-modified"> 690                                                  censusBuilder.build(), &quot;master&quot;,</span>
<span class="line-modified"> 691                                                  listAddress, Set.of(), Set.of(),</span>
<span class="line-modified"> 692                                                  listServer.getArchive(),</span>
<span class="line-modified"> 693                                                  listServer.getSMTP(),</span>
<span class="line-modified"> 694                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),</span>
<span class="line-modified"> 695                                                  webrevServer.uri(),</span>
<span class="line-modified"> 696                                                  Set.of(), Map.of(),</span>
<span class="line-modified"> 697                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),</span>
<span class="line-modified"> 698                                                  Map.of(), Duration.ZERO);</span>




 699 
 700             // Populate the projects repository
 701             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 702             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 703             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 704             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 705             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 706             var initialHash = CheckableRepository.appendAndCommit(localRepo,
 707                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
 708                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
 709                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
 710                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
 711                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
 712                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
 713             localRepo.push(initialHash, author.url(), &quot;master&quot;);
 714 
 715             // Make a change with a corresponding PR
 716             var current = Files.readString(localRepo.root().resolve(reviewFile), StandardCharsets.UTF_8);
 717             var updated = current.replaceAll(&quot;Line 2&quot;, &quot;Line 2 edit\nLine 2.5&quot;);
 718             updated = updated.replaceAll(&quot;Line 13&quot;, &quot;Line 12.5\nLine 13 edit&quot;);
</pre>
<hr />
<pre>
 741             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 24&quot;));
 742             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 23: Line 12.5$&quot;));
 743             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 24: Line 13 edit$&quot;));
 744             assertFalse(archiveContains(archiveFolder.path(), &quot;^Line 15&quot;));
 745         }
 746     }
 747 
 748     @Test
 749     void filterComments(TestInfo testInfo) throws IOException {
 750         try (var credentials = new HostCredentials(testInfo);
 751              var tempFolder = new TemporaryDirectory();
 752              var archiveFolder = new TemporaryDirectory();
 753              var listServer = new TestMailmanServer();
 754              var webrevServer = new TestWebrevServer()) {
 755             var author = credentials.getHostedRepository();
 756             var archive = credentials.getHostedRepository();
 757             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 758             var censusBuilder = credentials.getCensusBuilder()
 759                                            .addAuthor(author.forge().currentUser().id());
 760             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 761             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,</span>
<span class="line-modified"> 762                                                  censusBuilder.build(), &quot;master&quot;,</span>
<span class="line-modified"> 763                                                  listAddress, Set.of(), Set.of(),</span>
<span class="line-modified"> 764                                                  listServer.getArchive(), listServer.getSMTP(),</span>
<span class="line-modified"> 765                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),</span>
<span class="line-modified"> 766                                                  webrevServer.uri(),</span>
<span class="line-modified"> 767                                                  Set.of(), Map.of(),</span>
<span class="line-modified"> 768                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),</span>
<span class="line-modified"> 769                                                  Map.of(), Duration.ZERO);</span>





 770 
 771             // Populate the projects repository
 772             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 773             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 774             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 775             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 776             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 777 
 778             // Make a change with a corresponding PR
 779             var editHash = CheckableRepository.appendAndCommit(localRepo);
 780             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 781             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 782             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
 783                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
 784 
 785             // Make a bunch of comments
 786             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
 787             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment &lt;!-- this is a comment --&gt;\n&quot;);
 788             pr.addComment(&quot;/integrate stuff&quot;);
 789             TestBotRunner.runPeriodicItems(mlBot);
</pre>
<hr />
<pre>
 802             assertTrue(archiveContains(archiveFolder.path(), &quot;Plain comment&quot;));
 803             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 804             assertFalse(archiveContains(archiveFolder.path(), &quot;/integrate&quot;));
 805         }
 806     }
 807 
 808     @Test
 809     void incrementalChanges(TestInfo testInfo) throws IOException {
 810         try (var credentials = new HostCredentials(testInfo);
 811              var tempFolder = new TemporaryDirectory();
 812              var archiveFolder = new TemporaryDirectory();
 813              var listServer = new TestMailmanServer();
 814              var webrevServer = new TestWebrevServer()) {
 815             var author = credentials.getHostedRepository();
 816             var archive = credentials.getHostedRepository();
 817             var commenter = credentials.getHostedRepository();
 818             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 819             var censusBuilder = credentials.getCensusBuilder()
 820                                            .addAuthor(author.forge().currentUser().id());
 821             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 822             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,</span>
<span class="line-modified"> 823                                                  censusBuilder.build(), &quot;master&quot;,</span>
<span class="line-modified"> 824                                                  listAddress, Set.of(), Set.of(),</span>
<span class="line-modified"> 825                                                  listServer.getArchive(), listServer.getSMTP(),</span>
<span class="line-modified"> 826                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),</span>
<span class="line-modified"> 827                                                  webrevServer.uri(),</span>
<span class="line-modified"> 828                                                  Set.of(), Map.of(),</span>
<span class="line-modified"> 829                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),</span>
<span class="line-modified"> 830                                                  Map.of(), Duration.ZERO);</span>





 831 
 832             // Populate the projects repository
 833             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 834             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 835             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 836             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 837             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 838 
 839             // Make a change with a corresponding PR
 840             var editHash = CheckableRepository.appendAndCommit(localRepo);
 841             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 842             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 843             pr.setBody(&quot;This is now ready&quot;);
 844 
 845             // Run an archive pass
 846             TestBotRunner.runPeriodicItems(mlBot);
 847             listServer.processIncoming();
 848 
 849             var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
 850             localRepo.push(nextHash, author.url(), &quot;edit&quot;);
</pre>
<hr />
<pre>
 927             assertEquals(6, conversation.allMessages().size());
 928             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(1).subject());
 929             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(2).subject(), conversation.allMessages().get(2).toString());
 930             assertEquals(&quot;Re: [Rev 04] RFR: This is a pull request&quot;, conversation.allMessages().get(5).subject());
 931         }
 932     }
 933 
 934     @Test
 935     void rebased(TestInfo testInfo) throws IOException {
 936         try (var credentials = new HostCredentials(testInfo);
 937              var tempFolder = new TemporaryDirectory();
 938              var archiveFolder = new TemporaryDirectory();
 939              var listServer = new TestMailmanServer();
 940              var webrevServer = new TestWebrevServer()) {
 941             var author = credentials.getHostedRepository();
 942             var archive = credentials.getHostedRepository();
 943             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 944             var censusBuilder = credentials.getCensusBuilder()
 945                                            .addAuthor(author.forge().currentUser().id());
 946             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 947             var mlBot = new MailingListBridgeBot(sender, author, archive, &quot;master&quot;,</span>
<span class="line-modified"> 948                                                  censusBuilder.build(), &quot;master&quot;,</span>
<span class="line-modified"> 949                                                  listAddress, Set.of(), Set.of(),</span>
<span class="line-modified"> 950                                                  listServer.getArchive(), listServer.getSMTP(),</span>
<span class="line-modified"> 951                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),</span>
<span class="line-modified"> 952                                                  webrevServer.uri(),</span>
<span class="line-modified"> 953                                                  Set.of(), Map.of(),</span>
<span class="line-modified"> 954                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),</span>
<span class="line-modified"> 955                                                  Map.of(), Duration.ZERO);</span>





 956 
 957             // Populate the projects repository
 958             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 959             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
 960             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 961             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 962             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 963 
 964             // Make a change with a corresponding PR
 965             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
 966             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 967             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 968             pr.setBody(&quot;This is now ready&quot;);
 969 
 970             // Run an archive pass
 971             TestBotRunner.runPeriodicItems(mlBot);
 972             listServer.processIncoming();
 973 
 974             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.url(), &quot;master&quot;);
 975             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
</pre>
<hr />
<pre>
1018                 assertEquals(listAddress, newMail.sender());
1019                 assertFalse(newMail.hasHeader(&quot;PR-Head-Hash&quot;));
1020             }
1021             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversations.get(0).allMessages().get(1).subject());
1022         }
1023     }
1024 
1025     @Test
1026     void incrementalAfterRebase(TestInfo testInfo) throws IOException {
1027         try (var credentials = new HostCredentials(testInfo);
1028              var tempFolder = new TemporaryDirectory();
1029              var archiveFolder = new TemporaryDirectory();
1030              var listServer = new TestMailmanServer();
1031              var webrevServer = new TestWebrevServer()) {
1032             var author = credentials.getHostedRepository();
1033             var archive = credentials.getHostedRepository();
1034             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1035             var censusBuilder = credentials.getCensusBuilder()
1036                                            .addAuthor(author.forge().currentUser().id());
1037             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified">1038             var mlBot = new MailingListBridgeBot(sender, author, archive, &quot;archive&quot;,</span>
<span class="line-modified">1039                                                  censusBuilder.build(), &quot;master&quot;,</span>
<span class="line-modified">1040                                                  listAddress, Set.of(), Set.of(),</span>
<span class="line-modified">1041                                                  listServer.getArchive(), listServer.getSMTP(),</span>
<span class="line-modified">1042                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),</span>
<span class="line-modified">1043                                                  webrevServer.uri(),</span>
<span class="line-modified">1044                                                  Set.of(), Map.of(),</span>
<span class="line-modified">1045                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),</span>
<span class="line-modified">1046                                                  Map.of(), Duration.ZERO);</span>






1047 
1048             // Populate the projects repository
1049             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1050             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1051             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1052             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1053             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1054             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1055 
1056             // Make a change with a corresponding PR
1057             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1058             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1059             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1060             pr.setBody(&quot;This is now ready&quot;);
1061 
1062             // Run an archive pass
1063             TestBotRunner.runPeriodicItems(mlBot);
1064             listServer.processIncoming();
1065 
1066             // Push more stuff to master
</pre>
<hr />
<pre>
1103             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1104             assertTrue(archiveContains(archiveFolder.path(), &quot;More updates&quot;));
1105         }
1106     }
1107 
1108     @Test
1109     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
1110         try (var credentials = new HostCredentials(testInfo);
1111              var tempFolder = new TemporaryDirectory();
1112              var archiveFolder = new TemporaryDirectory();
1113              var webrevFolder = new TemporaryDirectory();
1114              var listServer = new TestMailmanServer();
1115              var webrevServer = new TestWebrevServer()) {
1116             var author = credentials.getHostedRepository();
1117             var archive = credentials.getHostedRepository();
1118             var ignored = credentials.getHostedRepository();
1119             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1120             var censusBuilder = credentials.getCensusBuilder()
1121                                            .addAuthor(author.forge().currentUser().id());
1122             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified">1123             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,</span>
<span class="line-modified">1124                                                  censusBuilder.build(), &quot;master&quot;,</span>
<span class="line-modified">1125                                                  listAddress,</span>
<span class="line-modified">1126                                                  Set.of(ignored.forge().currentUser().userName()),</span>
<span class="line-modified">1127                                                  Set.of(),</span>
<span class="line-modified">1128                                                  listServer.getArchive(), listServer.getSMTP(),</span>
<span class="line-modified">1129                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),</span>
<span class="line-modified">1130                                                  webrevServer.uri(),</span>
<span class="line-modified">1131                                                  Set.of(), Map.of(),</span>
<span class="line-modified">1132                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),</span>
<span class="line-modified">1133                                                  Map.of(), Duration.ZERO);</span>




1134 
1135             // Populate the projects repository
1136             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1137             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1138             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1139             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1140 
1141             // Make a change with a corresponding PR
1142             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
1143                                                                &quot;Change msg\n\nWith several lines&quot;);
1144             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1145             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1146 
1147             // Flag it as ready for review
1148             pr.setBody(&quot;This should now be ready&quot;);
1149 
1150             // Run an archive pass
1151             TestBotRunner.runPeriodicItems(mlBot);
1152 
1153             // The archive should now contain an entry
</pre>
<hr />
<pre>
1156 
1157             // And there should be a webrev comment
1158             var comments = pr.comments();
1159             var webrevComments = comments.stream()
1160                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1161                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1162                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
1163                                          .collect(Collectors.toList());
1164             assertEquals(1, webrevComments.size());
1165             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
1166 
1167             // Pretend the archive didn&#39;t work out
1168             archiveRepo.push(masterHash, archive.url(), &quot;master&quot;, true);
1169 
1170             // Run another archive pass
1171             TestBotRunner.runPeriodicItems(mlBot);
1172 
1173             // The webrev comment should not contain duplicate entries
1174             comments = pr.comments();
1175             webrevComments = comments.stream()
<span class="line-modified">1176                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))</span>
<span class="line-modified">1177                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))</span>
<span class="line-modified">1178                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))</span>
<span class="line-modified">1179                                          .collect(Collectors.toList());</span>
1180             assertEquals(1, webrevComments.size());
1181             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
1182         }
1183     }
1184 
1185     @Test
1186     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
1187         try (var credentials = new HostCredentials(testInfo);
1188              var tempFolder = new TemporaryDirectory();
1189              var archiveFolder = new TemporaryDirectory();
1190              var listServer = new TestMailmanServer();
1191              var webrevServer = new TestWebrevServer()) {
1192             var author = credentials.getHostedRepository();
1193             var archive = credentials.getHostedRepository();
1194             var reviewer = credentials.getHostedRepository();
1195             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1196             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1197             var censusBuilder = credentials.getCensusBuilder()
1198                                            .addReviewer(reviewer.forge().currentUser().id())
1199                                            .addAuthor(author.forge().currentUser().id());
<span class="line-modified">1200             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,</span>
<span class="line-modified">1201                                                  censusBuilder.build(), &quot;master&quot;,</span>
<span class="line-modified">1202                                                  listAddress, Set.of(), Set.of(),</span>
<span class="line-modified">1203                                                  listServer.getArchive(), listServer.getSMTP(),</span>
<span class="line-modified">1204                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),</span>
<span class="line-modified">1205                                                  webrevServer.uri(),</span>
<span class="line-modified">1206                                                  Set.of(), Map.of(),</span>
<span class="line-modified">1207                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),</span>
<span class="line-modified">1208                                                  Map.of(), Duration.ZERO);</span>





1209 
1210             // Populate the projects repository
1211             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1212             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1213             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1214             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1215             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1216 
1217             // Make a change with a corresponding PR
1218             var editHash = CheckableRepository.appendAndCommit(localRepo);
1219             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1220             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1221             pr.setBody(&quot;This is now ready&quot;);
1222 
1223             // Run an archive pass
1224             TestBotRunner.runPeriodicItems(mlBot);
1225 
1226             // First unapprove it
1227             var reviewedPr = reviewer.pullRequest(pr.id());
1228             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
</pre>
<hr />
<pre>
1264             if (author.forge().supportsReviewBody()) {
1265                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
1266             }
1267         }
1268     }
1269 
1270     @Test
1271     void ignoreComments(TestInfo testInfo) throws IOException {
1272         try (var credentials = new HostCredentials(testInfo);
1273              var tempFolder = new TemporaryDirectory();
1274              var archiveFolder = new TemporaryDirectory();
1275              var listServer = new TestMailmanServer();
1276              var webrevServer = new TestWebrevServer()) {
1277             var author = credentials.getHostedRepository();
1278             var ignored = credentials.getHostedRepository();
1279             var archive = credentials.getHostedRepository();
1280             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1281             var censusBuilder = credentials.getCensusBuilder()
1282                                            .addAuthor(author.forge().currentUser().id());
1283             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified">1284             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;,</span>
<span class="line-modified">1285                                                  censusBuilder.build(), &quot;master&quot;,</span>
<span class="line-modified">1286                                                  listAddress,</span>
<span class="line-modified">1287                                                  Set.of(ignored.forge().currentUser().userName()),</span>
<span class="line-modified">1288                                                  Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)),</span>
<span class="line-modified">1289                                                  listServer.getArchive(), listServer.getSMTP(),</span>
<span class="line-modified">1290                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),</span>
<span class="line-modified">1291                                                  webrevServer.uri(),</span>
<span class="line-modified">1292                                                  Set.of(), Map.of(),</span>
<span class="line-modified">1293                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),</span>
<span class="line-modified">1294                                                  Map.of(), Duration.ZERO);</span>





1295 
1296             // Populate the projects repository
1297             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1298             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1299             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1300             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1301             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1302 
1303             // Make a change with a corresponding PR
1304             var editHash = CheckableRepository.appendAndCommit(localRepo);
1305             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1306             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1307             pr.setBody(&quot;This is now ready&quot;);
1308 
1309             // Make a bunch of comments
1310             pr.addComment(&quot;Plain comment&quot;);
1311             pr.addComment(&quot;ignore this comment&quot;);
1312             pr.addComment(&quot;I think it is time to\nignore this comment!&quot;);
1313             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review ignore this comment&quot;);
1314 
</pre>
<hr />
<pre>
1326             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
1327             assertFalse(archiveContains(archiveFolder.path(), &quot;Review ignore&quot;));
1328         }
1329     }
1330 
1331     @Test
1332     void replyToEmptyReview(TestInfo testInfo) throws IOException {
1333         try (var credentials = new HostCredentials(testInfo);
1334              var tempFolder = new TemporaryDirectory();
1335              var archiveFolder = new TemporaryDirectory();
1336              var listServer = new TestMailmanServer();
1337              var webrevServer = new TestWebrevServer()) {
1338             var author = credentials.getHostedRepository();
1339             var reviewer = credentials.getHostedRepository();
1340             var archive = credentials.getHostedRepository();
1341             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1342             var censusBuilder = credentials.getCensusBuilder()
1343                                            .addReviewer(reviewer.forge().currentUser().id())
1344                                            .addAuthor(author.forge().currentUser().id());
1345             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified">1346             var mlBot = new MailingListBridgeBot(from, author, archive, &quot;master&quot;, censusBuilder.build(), &quot;master&quot;,</span>
<span class="line-modified">1347                                                  listAddress, Set.of(), Set.of(),</span>
<span class="line-modified">1348                                                  listServer.getArchive(),</span>
<span class="line-modified">1349                                                  listServer.getSMTP(),</span>
<span class="line-modified">1350                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),</span>
<span class="line-modified">1351                                                  webrevServer.uri(),</span>
<span class="line-modified">1352                                                  Set.of(), Map.of(),</span>
<span class="line-modified">1353                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),</span>
<span class="line-modified">1354                                                  Map.of(), Duration.ZERO);</span>





1355 
1356             // Populate the projects repository
1357             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1358             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1359             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1360             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1361             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1362 
1363             // Make a change with a corresponding PR
1364             var editHash = CheckableRepository.appendAndCommit(localRepo);
1365             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1366             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1367             pr.setBody(&quot;This is now ready&quot;);
1368             TestBotRunner.runPeriodicItems(mlBot);
1369             listServer.processIncoming();
1370 
1371             // Make an empty approval
1372             var reviewPr = reviewer.pullRequest(pr.id());
1373             reviewPr.addReview(Review.Verdict.APPROVED, &quot;&quot;);
1374             TestBotRunner.runPeriodicItems(mlBot);
1375             listServer.processIncoming();
1376 
1377             pr.addComment(&quot;Thanks for the review!&quot;);
1378             TestBotRunner.runPeriodicItems(mlBot);
1379             listServer.processIncoming();
1380 
1381             // The approval text should be included in the quote
1382             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1383             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^&gt; Marked as reviewed&quot;));
1384         }
1385     }

































































1386 }
</pre>
</td>
<td>
<hr />
<pre>
  96         return &quot;test+&quot; + repository.forge().currentUser().id() + &quot;+&quot; +
  97                 repository.forge().currentUser().userName() +
  98                 &quot;@openjdk.java.net&quot;;
  99     }
 100 
 101     @Test
 102     void simpleArchive(TestInfo testInfo) throws IOException {
 103         try (var credentials = new HostCredentials(testInfo);
 104              var tempFolder = new TemporaryDirectory();
 105              var archiveFolder = new TemporaryDirectory();
 106              var webrevFolder = new TemporaryDirectory();
 107              var listServer = new TestMailmanServer();
 108              var webrevServer = new TestWebrevServer()) {
 109             var author = credentials.getHostedRepository();
 110             var archive = credentials.getHostedRepository();
 111             var ignored = credentials.getHostedRepository();
 112             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 113             var censusBuilder = credentials.getCensusBuilder()
 114                                            .addAuthor(author.forge().currentUser().id());
 115             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 116             var mlBot = MailingListBridgeBot.newBuilder()</span>
<span class="line-modified"> 117                                             .from(from)</span>
<span class="line-modified"> 118                                             .repo(author)</span>
<span class="line-modified"> 119                                             .archive(archive)</span>
<span class="line-modified"> 120                                             .censusRepo(censusBuilder.build())</span>
<span class="line-modified"> 121                                             .list(listAddress)</span>
<span class="line-modified"> 122                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))</span>
<span class="line-modified"> 123                                             .ignoredComments(Set.of())</span>
<span class="line-modified"> 124                                             .listArchive(listServer.getArchive())</span>
<span class="line-modified"> 125                                             .smtpServer(listServer.getSMTP())</span>
<span class="line-modified"> 126                                             .webrevStorageRepository(archive)</span>
<span class="line-modified"> 127                                             .webrevStorageRef(&quot;webrev&quot;)</span>
<span class="line-added"> 128                                             .webrevStorageBase(Path.of(&quot;test&quot;))</span>
<span class="line-added"> 129                                             .webrevStorageBaseUri(webrevServer.uri())</span>
<span class="line-added"> 130                                             .readyLabels(Set.of(&quot;rfr&quot;))</span>
<span class="line-added"> 131                                             .readyComments(Map.of(ignored.forge().currentUser().userName(), Pattern.compile(&quot;ready&quot;)))</span>
<span class="line-added"> 132                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())</span>
<span class="line-added"> 133                                             .headers(Map.of(&quot;Extra1&quot;, &quot;val1&quot;, &quot;Extra2&quot;, &quot;val2&quot;))</span>
<span class="line-added"> 134                                             .sendInterval(Duration.ZERO)</span>
<span class="line-added"> 135                                             .build();</span>
 136 
 137             // Populate the projects repository
 138             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 139             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 140             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 141             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 142 
 143             // Make a change with a corresponding PR
 144             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 145                                                                &quot;Change msg\n\nWith several lines&quot;);
 146             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 147             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
 148             pr.setBody(&quot;This should not be ready&quot;);
 149 
 150             // Run an archive pass
 151             TestBotRunner.runPeriodicItems(mlBot);
 152 
 153             // A PR that isn&#39;t ready for review should not be archived
 154             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 155             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
</pre>
<hr />
<pre>
 263                 assertEquals(listAddress, newMail.sender());
 264             }
 265             assertTrue(conversations.get(0).allMessages().get(2).body().contains(&quot;This is a comment ðŸ˜„&quot;));
 266         }
 267     }
 268 
 269     @Test
 270     void reviewComment(TestInfo testInfo) throws IOException {
 271         try (var credentials = new HostCredentials(testInfo);
 272              var tempFolder = new TemporaryDirectory();
 273              var archiveFolder = new TemporaryDirectory();
 274              var listServer = new TestMailmanServer();
 275              var webrevServer = new TestWebrevServer()) {
 276             var author = credentials.getHostedRepository();
 277             var archive = credentials.getHostedRepository();
 278             var ignored = credentials.getHostedRepository();
 279             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 280             var censusBuilder = credentials.getCensusBuilder()
 281                                            .addAuthor(author.forge().currentUser().id());
 282             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 283             var mlBot = MailingListBridgeBot.newBuilder()</span>
<span class="line-modified"> 284                                             .from(from)</span>
<span class="line-modified"> 285                                             .repo(author)</span>
<span class="line-modified"> 286                                             .archive(archive)</span>
<span class="line-modified"> 287                                             .censusRepo(censusBuilder.build())</span>
<span class="line-modified"> 288                                             .list(listAddress)</span>
<span class="line-modified"> 289                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))</span>
<span class="line-modified"> 290                                             .listArchive(listServer.getArchive())</span>
<span class="line-modified"> 291                                             .smtpServer(listServer.getSMTP())</span>
<span class="line-modified"> 292                                             .webrevStorageRepository(archive)</span>
<span class="line-added"> 293                                             .webrevStorageRef(&quot;webrev&quot;)</span>
<span class="line-added"> 294                                             .webrevStorageBase(Path.of(&quot;test&quot;))</span>
<span class="line-added"> 295                                             .webrevStorageBaseUri(webrevServer.uri())</span>
<span class="line-added"> 296                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())</span>
<span class="line-added"> 297                                             .build();</span>
 298 
 299             // Populate the projects repository
 300             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 301             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 302             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 303             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 304             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 305 
 306             // Make a change with a corresponding PR
 307             var editHash = CheckableRepository.appendAndCommit(localRepo);
 308             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 309             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 310             pr.setBody(&quot;This is now ready&quot;);
 311             TestBotRunner.runPeriodicItems(mlBot);
 312             listServer.processIncoming();
 313 
 314             // And make a file specific comment
 315             var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
 316             var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 317 
</pre>
<hr />
<pre>
 358             for (var newMail : conversations.get(0).allMessages()) {
 359                 assertEquals(noreplyAddress(archive), newMail.author().address());
 360                 assertEquals(listAddress, newMail.sender());
 361             }
 362         }
 363     }
 364 
 365     @Test
 366     void combineComments(TestInfo testInfo) throws IOException {
 367         try (var credentials = new HostCredentials(testInfo);
 368              var tempFolder = new TemporaryDirectory();
 369              var archiveFolder = new TemporaryDirectory();
 370              var listServer = new TestMailmanServer();
 371              var webrevServer = new TestWebrevServer()) {
 372             var author = credentials.getHostedRepository();
 373             var archive = credentials.getHostedRepository();
 374             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 375             var censusBuilder = credentials.getCensusBuilder()
 376                                            .addAuthor(author.forge().currentUser().id());
 377             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 378             var mlBot = MailingListBridgeBot.newBuilder()</span>
<span class="line-modified"> 379                                             .from(from)</span>
<span class="line-modified"> 380                                             .repo(author)</span>
<span class="line-modified"> 381                                             .archive(archive)</span>
<span class="line-modified"> 382                                             .censusRepo(censusBuilder.build())</span>
<span class="line-modified"> 383                                             .list(listAddress)</span>
<span class="line-modified"> 384                                             .listArchive(listServer.getArchive())</span>
<span class="line-modified"> 385                                             .smtpServer(listServer.getSMTP())</span>
<span class="line-modified"> 386                                             .webrevStorageRepository(archive)</span>
<span class="line-modified"> 387                                             .webrevStorageRef(&quot;webrev&quot;)</span>
<span class="line-added"> 388                                             .webrevStorageBase(Path.of(&quot;test&quot;))</span>
<span class="line-added"> 389                                             .webrevStorageBaseUri(webrevServer.uri())</span>
<span class="line-added"> 390                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())</span>
<span class="line-added"> 391                                             .build();</span>
 392 
 393             // Populate the projects repository
 394             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 395             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 396             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 397             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 398             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 399 
 400             // Make a change with a corresponding PR
 401             var editHash = CheckableRepository.appendAndCommit(localRepo);
 402             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 403             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 404             pr.setBody(&quot;This is now ready&quot;);
 405             pr.addComment(&quot;Avoid combining&quot;);
 406 
 407             TestBotRunner.runPeriodicItems(mlBot);
 408             listServer.processIncoming();
 409             listServer.processIncoming();
 410 
 411             // Make several file specific comments
</pre>
<hr />
<pre>
 452             // The combined review comments should only appear unquoted once
 453             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^Another review comment&quot;));
 454         }
 455     }
 456 
 457     @Test
 458     void commentThreading(TestInfo testInfo) throws IOException {
 459         try (var credentials = new HostCredentials(testInfo);
 460              var tempFolder = new TemporaryDirectory();
 461              var archiveFolder = new TemporaryDirectory();
 462              var listServer = new TestMailmanServer();
 463              var webrevServer = new TestWebrevServer()) {
 464             var author = credentials.getHostedRepository();
 465             var reviewer = credentials.getHostedRepository();
 466             var archive = credentials.getHostedRepository();
 467             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 468             var censusBuilder = credentials.getCensusBuilder()
 469                                            .addReviewer(reviewer.forge().currentUser().id())
 470                                            .addAuthor(author.forge().currentUser().id());
 471             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 472             var mlBot = MailingListBridgeBot.newBuilder()</span>
<span class="line-modified"> 473                                             .from(from)</span>
<span class="line-modified"> 474                                             .repo(author)</span>
<span class="line-modified"> 475                                             .archive(archive)</span>
<span class="line-modified"> 476                                             .censusRepo(censusBuilder.build())</span>
<span class="line-modified"> 477                                             .list(listAddress)</span>
<span class="line-modified"> 478                                             .listArchive(listServer.getArchive())</span>
<span class="line-modified"> 479                                             .smtpServer(listServer.getSMTP())</span>
<span class="line-modified"> 480                                             .webrevStorageRepository(archive)</span>
<span class="line-modified"> 481                                             .webrevStorageRef(&quot;webrev&quot;)</span>
<span class="line-added"> 482                                             .webrevStorageBase(Path.of(&quot;test&quot;))</span>
<span class="line-added"> 483                                             .webrevStorageBaseUri(webrevServer.uri())</span>
<span class="line-added"> 484                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())</span>
<span class="line-added"> 485                                             .build();</span>
 486 
 487             // Populate the projects repository
 488             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 489             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 490             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 491             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 492             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 493 
 494             // Make a change with a corresponding PR
 495             var editHash = CheckableRepository.appendAndCommit(localRepo);
 496             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 497             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 498             pr.setBody(&quot;This is now ready&quot;);
 499             TestBotRunner.runPeriodicItems(mlBot);
 500             listServer.processIncoming();
 501 
 502             // Make a file specific comment
 503             var reviewPr = reviewer.pullRequest(pr.id());
 504             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 505             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
</pre>
<hr />
<pre>
 581             assertTrue(thread4.body().contains(&quot;The final review comment&quot;));
 582             assertTrue(thread4.body().contains(&quot;Marked as reviewed by integrationreviewer1 (Reviewer)&quot;));
 583         }
 584     }
 585 
 586     @Test
 587     void commentThreadingSeparated(TestInfo testInfo) throws IOException {
 588         try (var credentials = new HostCredentials(testInfo);
 589              var tempFolder = new TemporaryDirectory();
 590              var archiveFolder = new TemporaryDirectory();
 591              var listServer = new TestMailmanServer();
 592              var webrevServer = new TestWebrevServer()) {
 593             var author = credentials.getHostedRepository();
 594             var reviewer = credentials.getHostedRepository();
 595             var archive = credentials.getHostedRepository();
 596             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 597             var censusBuilder = credentials.getCensusBuilder()
 598                                            .addReviewer(reviewer.forge().currentUser().id())
 599                                            .addAuthor(author.forge().currentUser().id());
 600             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 601             var mlBot = MailingListBridgeBot.newBuilder()</span>
<span class="line-modified"> 602                                             .from(from)</span>
<span class="line-modified"> 603                                             .repo(author)</span>
<span class="line-modified"> 604                                             .archive(archive)</span>
<span class="line-modified"> 605                                             .censusRepo(censusBuilder.build())</span>
<span class="line-modified"> 606                                             .list(listAddress)</span>
<span class="line-modified"> 607                                             .listArchive(listServer.getArchive())</span>
<span class="line-modified"> 608                                             .smtpServer(listServer.getSMTP())</span>
<span class="line-modified"> 609                                             .webrevStorageRepository(archive)</span>
<span class="line-added"> 610                                             .webrevStorageRef(&quot;webrev&quot;)</span>
<span class="line-added"> 611                                             .webrevStorageBase(Path.of(&quot;test&quot;))</span>
<span class="line-added"> 612                                             .webrevStorageBaseUri(webrevServer.uri())</span>
<span class="line-added"> 613                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())</span>
<span class="line-added"> 614                                             .build();</span>
 615 
 616             // Populate the projects repository
 617             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 618             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 619             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 620             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 621             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 622 
 623             // Make a change with a corresponding PR
 624             var editHash = CheckableRepository.appendAndCommit(localRepo);
 625             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 626             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 627             pr.setBody(&quot;This is now ready&quot;);
 628             TestBotRunner.runPeriodicItems(mlBot);
 629             listServer.processIncoming();
 630 
 631             // Make two file specific comments
 632             var reviewPr = reviewer.pullRequest(pr.id());
 633             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 634             var comment2 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
</pre>
<hr />
<pre>
 642 
 643             // Sanity check the archive
 644             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 645             assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 646         }
 647     }
 648 
 649     @Test
 650     void reviewContext(TestInfo testInfo) throws IOException {
 651         try (var credentials = new HostCredentials(testInfo);
 652              var tempFolder = new TemporaryDirectory();
 653              var archiveFolder = new TemporaryDirectory();
 654              var listServer = new TestMailmanServer();
 655              var webrevServer = new TestWebrevServer()) {
 656             var author = credentials.getHostedRepository();
 657             var archive = credentials.getHostedRepository();
 658             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 659             var censusBuilder = credentials.getCensusBuilder()
 660                                            .addAuthor(author.forge().currentUser().id());
 661             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 662             var mlBot = MailingListBridgeBot.newBuilder()</span>
<span class="line-modified"> 663                                             .from(from)</span>
<span class="line-modified"> 664                                             .repo(author)</span>
<span class="line-modified"> 665                                             .archive(archive)</span>
<span class="line-modified"> 666                                             .censusRepo(censusBuilder.build())</span>
<span class="line-modified"> 667                                             .list(listAddress)</span>
<span class="line-modified"> 668                                             .listArchive(listServer.getArchive())</span>
<span class="line-modified"> 669                                             .smtpServer(listServer.getSMTP())</span>
<span class="line-modified"> 670                                             .webrevStorageRepository(archive)</span>
<span class="line-modified"> 671                                             .webrevStorageRef(&quot;webrev&quot;)</span>
<span class="line-added"> 672                                             .webrevStorageBase(Path.of(&quot;test&quot;))</span>
<span class="line-added"> 673                                             .webrevStorageBaseUri(webrevServer.uri())</span>
<span class="line-added"> 674                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())</span>
<span class="line-added"> 675                                             .build();</span>
 676 
 677             // Populate the projects repository
 678             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 679             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 680             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 681             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 682             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 683 
 684             // Make a change with a corresponding PR
 685             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
 686             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 687             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 688             pr.setBody(&quot;This is now ready&quot;);
 689             TestBotRunner.runPeriodicItems(mlBot);
 690             listServer.processIncoming();
 691 
 692             // Make a file specific comment
 693             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 694 
 695             TestBotRunner.runPeriodicItems(mlBot);
</pre>
<hr />
<pre>
 699             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
 700             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
 701             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
 702             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
 703         }
 704     }
 705 
 706     @Test
 707     void multipleReviewContexts(TestInfo testInfo) throws IOException {
 708         try (var credentials = new HostCredentials(testInfo);
 709              var tempFolder = new TemporaryDirectory();
 710              var archiveFolder = new TemporaryDirectory();
 711              var listServer = new TestMailmanServer();
 712              var webrevServer = new TestWebrevServer()) {
 713             var author = credentials.getHostedRepository();
 714             var archive = credentials.getHostedRepository();
 715             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 716             var censusBuilder = credentials.getCensusBuilder()
 717                                            .addAuthor(author.forge().currentUser().id());
 718             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 719             var mlBot = MailingListBridgeBot.newBuilder()</span>
<span class="line-modified"> 720                                             .from(from)</span>
<span class="line-modified"> 721                                             .repo(author)</span>
<span class="line-modified"> 722                                             .archive(archive)</span>
<span class="line-modified"> 723                                             .censusRepo(censusBuilder.build())</span>
<span class="line-modified"> 724                                             .list(listAddress)</span>
<span class="line-modified"> 725                                             .listArchive(listServer.getArchive())</span>
<span class="line-modified"> 726                                             .smtpServer(listServer.getSMTP())</span>
<span class="line-modified"> 727                                             .webrevStorageRepository(archive)</span>
<span class="line-modified"> 728                                             .webrevStorageRef(&quot;webrev&quot;)</span>
<span class="line-added"> 729                                             .webrevStorageBase(Path.of(&quot;test&quot;))</span>
<span class="line-added"> 730                                             .webrevStorageBaseUri(webrevServer.uri())</span>
<span class="line-added"> 731                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())</span>
<span class="line-added"> 732                                             .build();</span>
 733 
 734             // Populate the projects repository
 735             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 736             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 737             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 738             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 739             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 740             var initialHash = CheckableRepository.appendAndCommit(localRepo,
 741                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
 742                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
 743                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
 744                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
 745                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
 746                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
 747             localRepo.push(initialHash, author.url(), &quot;master&quot;);
 748 
 749             // Make a change with a corresponding PR
 750             var current = Files.readString(localRepo.root().resolve(reviewFile), StandardCharsets.UTF_8);
 751             var updated = current.replaceAll(&quot;Line 2&quot;, &quot;Line 2 edit\nLine 2.5&quot;);
 752             updated = updated.replaceAll(&quot;Line 13&quot;, &quot;Line 12.5\nLine 13 edit&quot;);
</pre>
<hr />
<pre>
 775             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 24&quot;));
 776             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 23: Line 12.5$&quot;));
 777             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 24: Line 13 edit$&quot;));
 778             assertFalse(archiveContains(archiveFolder.path(), &quot;^Line 15&quot;));
 779         }
 780     }
 781 
 782     @Test
 783     void filterComments(TestInfo testInfo) throws IOException {
 784         try (var credentials = new HostCredentials(testInfo);
 785              var tempFolder = new TemporaryDirectory();
 786              var archiveFolder = new TemporaryDirectory();
 787              var listServer = new TestMailmanServer();
 788              var webrevServer = new TestWebrevServer()) {
 789             var author = credentials.getHostedRepository();
 790             var archive = credentials.getHostedRepository();
 791             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 792             var censusBuilder = credentials.getCensusBuilder()
 793                                            .addAuthor(author.forge().currentUser().id());
 794             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 795             var mlBot = MailingListBridgeBot.newBuilder()</span>
<span class="line-modified"> 796                                             .from(from)</span>
<span class="line-modified"> 797                                             .repo(author)</span>
<span class="line-modified"> 798                                             .archive(archive)</span>
<span class="line-modified"> 799                                             .censusRepo(censusBuilder.build())</span>
<span class="line-modified"> 800                                             .list(listAddress)</span>
<span class="line-modified"> 801                                             .listArchive(listServer.getArchive())</span>
<span class="line-modified"> 802                                             .smtpServer(listServer.getSMTP())</span>
<span class="line-modified"> 803                                             .webrevStorageRepository(archive)</span>
<span class="line-added"> 804                                             .webrevStorageRef(&quot;webrev&quot;)</span>
<span class="line-added"> 805                                             .webrevStorageBase(Path.of(&quot;test&quot;))</span>
<span class="line-added"> 806                                             .webrevStorageBaseUri(webrevServer.uri())</span>
<span class="line-added"> 807                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())</span>
<span class="line-added"> 808                                             .build();</span>
 809 
 810             // Populate the projects repository
 811             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 812             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 813             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 814             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 815             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 816 
 817             // Make a change with a corresponding PR
 818             var editHash = CheckableRepository.appendAndCommit(localRepo);
 819             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 820             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 821             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
 822                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
 823 
 824             // Make a bunch of comments
 825             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
 826             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment &lt;!-- this is a comment --&gt;\n&quot;);
 827             pr.addComment(&quot;/integrate stuff&quot;);
 828             TestBotRunner.runPeriodicItems(mlBot);
</pre>
<hr />
<pre>
 841             assertTrue(archiveContains(archiveFolder.path(), &quot;Plain comment&quot;));
 842             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 843             assertFalse(archiveContains(archiveFolder.path(), &quot;/integrate&quot;));
 844         }
 845     }
 846 
 847     @Test
 848     void incrementalChanges(TestInfo testInfo) throws IOException {
 849         try (var credentials = new HostCredentials(testInfo);
 850              var tempFolder = new TemporaryDirectory();
 851              var archiveFolder = new TemporaryDirectory();
 852              var listServer = new TestMailmanServer();
 853              var webrevServer = new TestWebrevServer()) {
 854             var author = credentials.getHostedRepository();
 855             var archive = credentials.getHostedRepository();
 856             var commenter = credentials.getHostedRepository();
 857             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 858             var censusBuilder = credentials.getCensusBuilder()
 859                                            .addAuthor(author.forge().currentUser().id());
 860             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 861             var mlBot = MailingListBridgeBot.newBuilder()</span>
<span class="line-modified"> 862                                             .from(from)</span>
<span class="line-modified"> 863                                             .repo(author)</span>
<span class="line-modified"> 864                                             .archive(archive)</span>
<span class="line-modified"> 865                                             .censusRepo(censusBuilder.build())</span>
<span class="line-modified"> 866                                             .list(listAddress)</span>
<span class="line-modified"> 867                                             .listArchive(listServer.getArchive())</span>
<span class="line-modified"> 868                                             .smtpServer(listServer.getSMTP())</span>
<span class="line-modified"> 869                                             .webrevStorageRepository(archive)</span>
<span class="line-added"> 870                                             .webrevStorageRef(&quot;webrev&quot;)</span>
<span class="line-added"> 871                                             .webrevStorageBase(Path.of(&quot;test&quot;))</span>
<span class="line-added"> 872                                             .webrevStorageBaseUri(webrevServer.uri())</span>
<span class="line-added"> 873                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())</span>
<span class="line-added"> 874                                             .build();</span>
 875 
 876             // Populate the projects repository
 877             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 878             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
 879             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 880             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 881             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
 882 
 883             // Make a change with a corresponding PR
 884             var editHash = CheckableRepository.appendAndCommit(localRepo);
 885             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 886             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 887             pr.setBody(&quot;This is now ready&quot;);
 888 
 889             // Run an archive pass
 890             TestBotRunner.runPeriodicItems(mlBot);
 891             listServer.processIncoming();
 892 
 893             var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
 894             localRepo.push(nextHash, author.url(), &quot;edit&quot;);
</pre>
<hr />
<pre>
 971             assertEquals(6, conversation.allMessages().size());
 972             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(1).subject());
 973             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversation.allMessages().get(2).subject(), conversation.allMessages().get(2).toString());
 974             assertEquals(&quot;Re: [Rev 04] RFR: This is a pull request&quot;, conversation.allMessages().get(5).subject());
 975         }
 976     }
 977 
 978     @Test
 979     void rebased(TestInfo testInfo) throws IOException {
 980         try (var credentials = new HostCredentials(testInfo);
 981              var tempFolder = new TemporaryDirectory();
 982              var archiveFolder = new TemporaryDirectory();
 983              var listServer = new TestMailmanServer();
 984              var webrevServer = new TestWebrevServer()) {
 985             var author = credentials.getHostedRepository();
 986             var archive = credentials.getHostedRepository();
 987             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 988             var censusBuilder = credentials.getCensusBuilder()
 989                                            .addAuthor(author.forge().currentUser().id());
 990             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified"> 991             var mlBot = MailingListBridgeBot.newBuilder()</span>
<span class="line-modified"> 992                                             .from(sender)</span>
<span class="line-modified"> 993                                             .repo(author)</span>
<span class="line-modified"> 994                                             .archive(archive)</span>
<span class="line-modified"> 995                                             .censusRepo(censusBuilder.build())</span>
<span class="line-modified"> 996                                             .list(listAddress)</span>
<span class="line-modified"> 997                                             .listArchive(listServer.getArchive())</span>
<span class="line-modified"> 998                                             .smtpServer(listServer.getSMTP())</span>
<span class="line-modified"> 999                                             .webrevStorageRepository(archive)</span>
<span class="line-added">1000                                             .webrevStorageRef(&quot;webrev&quot;)</span>
<span class="line-added">1001                                             .webrevStorageBase(Path.of(&quot;test&quot;))</span>
<span class="line-added">1002                                             .webrevStorageBaseUri(webrevServer.uri())</span>
<span class="line-added">1003                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())</span>
<span class="line-added">1004                                             .build();</span>
1005 
1006             // Populate the projects repository
1007             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1008             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1009             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1010             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1011             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1012 
1013             // Make a change with a corresponding PR
1014             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1015             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1016             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1017             pr.setBody(&quot;This is now ready&quot;);
1018 
1019             // Run an archive pass
1020             TestBotRunner.runPeriodicItems(mlBot);
1021             listServer.processIncoming();
1022 
1023             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.url(), &quot;master&quot;);
1024             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
</pre>
<hr />
<pre>
1067                 assertEquals(listAddress, newMail.sender());
1068                 assertFalse(newMail.hasHeader(&quot;PR-Head-Hash&quot;));
1069             }
1070             assertEquals(&quot;Re: [Rev 01] RFR: This is a pull request&quot;, conversations.get(0).allMessages().get(1).subject());
1071         }
1072     }
1073 
1074     @Test
1075     void incrementalAfterRebase(TestInfo testInfo) throws IOException {
1076         try (var credentials = new HostCredentials(testInfo);
1077              var tempFolder = new TemporaryDirectory();
1078              var archiveFolder = new TemporaryDirectory();
1079              var listServer = new TestMailmanServer();
1080              var webrevServer = new TestWebrevServer()) {
1081             var author = credentials.getHostedRepository();
1082             var archive = credentials.getHostedRepository();
1083             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1084             var censusBuilder = credentials.getCensusBuilder()
1085                                            .addAuthor(author.forge().currentUser().id());
1086             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified">1087             var mlBot = MailingListBridgeBot.newBuilder()</span>
<span class="line-modified">1088                                             .from(sender)</span>
<span class="line-modified">1089                                             .repo(author)</span>
<span class="line-modified">1090                                             .archive(archive)</span>
<span class="line-modified">1091                                             .archiveRef(&quot;archive&quot;)</span>
<span class="line-modified">1092                                             .censusRepo(censusBuilder.build())</span>
<span class="line-modified">1093                                             .list(listAddress)</span>
<span class="line-modified">1094                                             .listArchive(listServer.getArchive())</span>
<span class="line-modified">1095                                             .smtpServer(listServer.getSMTP())</span>
<span class="line-added">1096                                             .webrevStorageRepository(archive)</span>
<span class="line-added">1097                                             .webrevStorageRef(&quot;webrev&quot;)</span>
<span class="line-added">1098                                             .webrevStorageBase(Path.of(&quot;test&quot;))</span>
<span class="line-added">1099                                             .webrevStorageBaseUri(webrevServer.uri())</span>
<span class="line-added">1100                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())</span>
<span class="line-added">1101                                             .build();</span>
1102 
1103             // Populate the projects repository
1104             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1105             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);
1106             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1107             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1108             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1109             localRepo.push(masterHash, archive.url(), &quot;archive&quot;, true);
1110 
1111             // Make a change with a corresponding PR
1112             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
1113             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1114             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1115             pr.setBody(&quot;This is now ready&quot;);
1116 
1117             // Run an archive pass
1118             TestBotRunner.runPeriodicItems(mlBot);
1119             listServer.processIncoming();
1120 
1121             // Push more stuff to master
</pre>
<hr />
<pre>
1158             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
1159             assertTrue(archiveContains(archiveFolder.path(), &quot;More updates&quot;));
1160         }
1161     }
1162 
1163     @Test
1164     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
1165         try (var credentials = new HostCredentials(testInfo);
1166              var tempFolder = new TemporaryDirectory();
1167              var archiveFolder = new TemporaryDirectory();
1168              var webrevFolder = new TemporaryDirectory();
1169              var listServer = new TestMailmanServer();
1170              var webrevServer = new TestWebrevServer()) {
1171             var author = credentials.getHostedRepository();
1172             var archive = credentials.getHostedRepository();
1173             var ignored = credentials.getHostedRepository();
1174             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1175             var censusBuilder = credentials.getCensusBuilder()
1176                                            .addAuthor(author.forge().currentUser().id());
1177             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified">1178             var mlBot = MailingListBridgeBot.newBuilder()</span>
<span class="line-modified">1179                                             .from(from)</span>
<span class="line-modified">1180                                             .repo(author)</span>
<span class="line-modified">1181                                             .archive(archive)</span>
<span class="line-modified">1182                                             .censusRepo(censusBuilder.build())</span>
<span class="line-modified">1183                                             .list(listAddress)</span>
<span class="line-modified">1184                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))</span>
<span class="line-modified">1185                                             .listArchive(listServer.getArchive())</span>
<span class="line-modified">1186                                             .smtpServer(listServer.getSMTP())</span>
<span class="line-modified">1187                                             .webrevStorageRepository(archive)</span>
<span class="line-modified">1188                                             .webrevStorageRef(&quot;webrev&quot;)</span>
<span class="line-added">1189                                             .webrevStorageBase(Path.of(&quot;test&quot;))</span>
<span class="line-added">1190                                             .webrevStorageBaseUri(webrevServer.uri())</span>
<span class="line-added">1191                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())</span>
<span class="line-added">1192                                             .build();</span>
1193 
1194             // Populate the projects repository
1195             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1196             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1197             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1198             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1199 
1200             // Make a change with a corresponding PR
1201             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
1202                                                                &quot;Change msg\n\nWith several lines&quot;);
1203             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1204             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1205 
1206             // Flag it as ready for review
1207             pr.setBody(&quot;This should now be ready&quot;);
1208 
1209             // Run an archive pass
1210             TestBotRunner.runPeriodicItems(mlBot);
1211 
1212             // The archive should now contain an entry
</pre>
<hr />
<pre>
1215 
1216             // And there should be a webrev comment
1217             var comments = pr.comments();
1218             var webrevComments = comments.stream()
1219                                          .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))
1220                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
1221                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
1222                                          .collect(Collectors.toList());
1223             assertEquals(1, webrevComments.size());
1224             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
1225 
1226             // Pretend the archive didn&#39;t work out
1227             archiveRepo.push(masterHash, archive.url(), &quot;master&quot;, true);
1228 
1229             // Run another archive pass
1230             TestBotRunner.runPeriodicItems(mlBot);
1231 
1232             // The webrev comment should not contain duplicate entries
1233             comments = pr.comments();
1234             webrevComments = comments.stream()
<span class="line-modified">1235                                      .filter(comment -&gt; comment.author().equals(author.forge().currentUser()))</span>
<span class="line-modified">1236                                      .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))</span>
<span class="line-modified">1237                                      .filter(comment -&gt; comment.body().contains(editHash.hex()))</span>
<span class="line-modified">1238                                      .collect(Collectors.toList());</span>
1239             assertEquals(1, webrevComments.size());
1240             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
1241         }
1242     }
1243 
1244     @Test
1245     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
1246         try (var credentials = new HostCredentials(testInfo);
1247              var tempFolder = new TemporaryDirectory();
1248              var archiveFolder = new TemporaryDirectory();
1249              var listServer = new TestMailmanServer();
1250              var webrevServer = new TestWebrevServer()) {
1251             var author = credentials.getHostedRepository();
1252             var archive = credentials.getHostedRepository();
1253             var reviewer = credentials.getHostedRepository();
1254             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1255             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1256             var censusBuilder = credentials.getCensusBuilder()
1257                                            .addReviewer(reviewer.forge().currentUser().id())
1258                                            .addAuthor(author.forge().currentUser().id());
<span class="line-modified">1259             var mlBot = MailingListBridgeBot.newBuilder()</span>
<span class="line-modified">1260                                             .from(from)</span>
<span class="line-modified">1261                                             .repo(author)</span>
<span class="line-modified">1262                                             .archive(archive)</span>
<span class="line-modified">1263                                             .censusRepo(censusBuilder.build())</span>
<span class="line-modified">1264                                             .list(listAddress)</span>
<span class="line-modified">1265                                             .listArchive(listServer.getArchive())</span>
<span class="line-modified">1266                                             .smtpServer(listServer.getSMTP())</span>
<span class="line-modified">1267                                             .webrevStorageRepository(archive)</span>
<span class="line-added">1268                                             .webrevStorageRef(&quot;webrev&quot;)</span>
<span class="line-added">1269                                             .webrevStorageBase(Path.of(&quot;test&quot;))</span>
<span class="line-added">1270                                             .webrevStorageBaseUri(webrevServer.uri())</span>
<span class="line-added">1271                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())</span>
<span class="line-added">1272                                             .build();</span>
1273 
1274             // Populate the projects repository
1275             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1276             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1277             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1278             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1279             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1280 
1281             // Make a change with a corresponding PR
1282             var editHash = CheckableRepository.appendAndCommit(localRepo);
1283             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1284             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1285             pr.setBody(&quot;This is now ready&quot;);
1286 
1287             // Run an archive pass
1288             TestBotRunner.runPeriodicItems(mlBot);
1289 
1290             // First unapprove it
1291             var reviewedPr = reviewer.pullRequest(pr.id());
1292             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
</pre>
<hr />
<pre>
1328             if (author.forge().supportsReviewBody()) {
1329                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
1330             }
1331         }
1332     }
1333 
1334     @Test
1335     void ignoreComments(TestInfo testInfo) throws IOException {
1336         try (var credentials = new HostCredentials(testInfo);
1337              var tempFolder = new TemporaryDirectory();
1338              var archiveFolder = new TemporaryDirectory();
1339              var listServer = new TestMailmanServer();
1340              var webrevServer = new TestWebrevServer()) {
1341             var author = credentials.getHostedRepository();
1342             var ignored = credentials.getHostedRepository();
1343             var archive = credentials.getHostedRepository();
1344             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1345             var censusBuilder = credentials.getCensusBuilder()
1346                                            .addAuthor(author.forge().currentUser().id());
1347             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified">1348             var mlBot = MailingListBridgeBot.newBuilder()</span>
<span class="line-modified">1349                                             .from(from)</span>
<span class="line-modified">1350                                             .repo(author)</span>
<span class="line-modified">1351                                             .archive(archive)</span>
<span class="line-modified">1352                                             .censusRepo(censusBuilder.build())</span>
<span class="line-modified">1353                                             .list(listAddress)</span>
<span class="line-modified">1354                                             .ignoredUsers(Set.of(ignored.forge().currentUser().userName()))</span>
<span class="line-modified">1355                                             .ignoredComments(Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)))</span>
<span class="line-modified">1356                                             .listArchive(listServer.getArchive())</span>
<span class="line-modified">1357                                             .smtpServer(listServer.getSMTP())</span>
<span class="line-modified">1358                                             .webrevStorageRepository(archive)</span>
<span class="line-added">1359                                             .webrevStorageRef(&quot;webrev&quot;)</span>
<span class="line-added">1360                                             .webrevStorageBase(Path.of(&quot;test&quot;))</span>
<span class="line-added">1361                                             .webrevStorageBaseUri(webrevServer.uri())</span>
<span class="line-added">1362                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())</span>
<span class="line-added">1363                                             .build();</span>
1364 
1365             // Populate the projects repository
1366             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1367             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1368             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1369             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1370             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1371 
1372             // Make a change with a corresponding PR
1373             var editHash = CheckableRepository.appendAndCommit(localRepo);
1374             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1375             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1376             pr.setBody(&quot;This is now ready&quot;);
1377 
1378             // Make a bunch of comments
1379             pr.addComment(&quot;Plain comment&quot;);
1380             pr.addComment(&quot;ignore this comment&quot;);
1381             pr.addComment(&quot;I think it is time to\nignore this comment!&quot;);
1382             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review ignore this comment&quot;);
1383 
</pre>
<hr />
<pre>
1395             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
1396             assertFalse(archiveContains(archiveFolder.path(), &quot;Review ignore&quot;));
1397         }
1398     }
1399 
1400     @Test
1401     void replyToEmptyReview(TestInfo testInfo) throws IOException {
1402         try (var credentials = new HostCredentials(testInfo);
1403              var tempFolder = new TemporaryDirectory();
1404              var archiveFolder = new TemporaryDirectory();
1405              var listServer = new TestMailmanServer();
1406              var webrevServer = new TestWebrevServer()) {
1407             var author = credentials.getHostedRepository();
1408             var reviewer = credentials.getHostedRepository();
1409             var archive = credentials.getHostedRepository();
1410             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1411             var censusBuilder = credentials.getCensusBuilder()
1412                                            .addReviewer(reviewer.forge().currentUser().id())
1413                                            .addAuthor(author.forge().currentUser().id());
1414             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
<span class="line-modified">1415             var mlBot = MailingListBridgeBot.newBuilder()</span>
<span class="line-modified">1416                                             .from(from)</span>
<span class="line-modified">1417                                             .repo(author)</span>
<span class="line-modified">1418                                             .archive(archive)</span>
<span class="line-modified">1419                                             .censusRepo(censusBuilder.build())</span>
<span class="line-modified">1420                                             .list(listAddress)</span>
<span class="line-modified">1421                                             .listArchive(listServer.getArchive())</span>
<span class="line-modified">1422                                             .smtpServer(listServer.getSMTP())</span>
<span class="line-modified">1423                                             .webrevStorageRepository(archive)</span>
<span class="line-added">1424                                             .webrevStorageRef(&quot;webrev&quot;)</span>
<span class="line-added">1425                                             .webrevStorageBase(Path.of(&quot;test&quot;))</span>
<span class="line-added">1426                                             .webrevStorageBaseUri(webrevServer.uri())</span>
<span class="line-added">1427                                             .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build())</span>
<span class="line-added">1428                                             .build();</span>
1429 
1430             // Populate the projects repository
1431             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1432             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);
1433             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1434             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1435             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);
1436 
1437             // Make a change with a corresponding PR
1438             var editHash = CheckableRepository.appendAndCommit(localRepo);
1439             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1440             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1441             pr.setBody(&quot;This is now ready&quot;);
1442             TestBotRunner.runPeriodicItems(mlBot);
1443             listServer.processIncoming();
1444 
1445             // Make an empty approval
1446             var reviewPr = reviewer.pullRequest(pr.id());
1447             reviewPr.addReview(Review.Verdict.APPROVED, &quot;&quot;);
1448             TestBotRunner.runPeriodicItems(mlBot);
1449             listServer.processIncoming();
1450 
1451             pr.addComment(&quot;Thanks for the review!&quot;);
1452             TestBotRunner.runPeriodicItems(mlBot);
1453             listServer.processIncoming();
1454 
1455             // The approval text should be included in the quote
1456             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);
1457             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^&gt; Marked as reviewed&quot;));
1458         }
1459     }
<span class="line-added">1460 </span>
<span class="line-added">1461     @Test</span>
<span class="line-added">1462     void cooldown(TestInfo testInfo) throws IOException {</span>
<span class="line-added">1463         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added">1464              var tempFolder = new TemporaryDirectory();</span>
<span class="line-added">1465              var archiveFolder = new TemporaryDirectory();</span>
<span class="line-added">1466              var listServer = new TestMailmanServer();</span>
<span class="line-added">1467              var webrevServer = new TestWebrevServer()) {</span>
<span class="line-added">1468             var bot = credentials.getHostedRepository();</span>
<span class="line-added">1469             var author = credentials.getHostedRepository();</span>
<span class="line-added">1470             var archive = credentials.getHostedRepository();</span>
<span class="line-added">1471             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="line-added">1472             var censusBuilder = credentials.getCensusBuilder()</span>
<span class="line-added">1473                                            .addAuthor(author.forge().currentUser().id());</span>
<span class="line-added">1474             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);</span>
<span class="line-added">1475             var mlBotBuilder = MailingListBridgeBot.newBuilder()</span>
<span class="line-added">1476                                                    .from(from)</span>
<span class="line-added">1477                                                    .repo(bot)</span>
<span class="line-added">1478                                                    .ignoredUsers(Set.of(bot.forge().currentUser().userName()))</span>
<span class="line-added">1479                                                    .archive(archive)</span>
<span class="line-added">1480                                                    .censusRepo(censusBuilder.build())</span>
<span class="line-added">1481                                                    .list(listAddress)</span>
<span class="line-added">1482                                                    .listArchive(listServer.getArchive())</span>
<span class="line-added">1483                                                    .smtpServer(listServer.getSMTP())</span>
<span class="line-added">1484                                                    .webrevStorageRepository(archive)</span>
<span class="line-added">1485                                                    .webrevStorageRef(&quot;webrev&quot;)</span>
<span class="line-added">1486                                                    .webrevStorageBase(Path.of(&quot;test&quot;))</span>
<span class="line-added">1487                                                    .webrevStorageBaseUri(webrevServer.uri())</span>
<span class="line-added">1488                                                    .issueTracker(URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>
<span class="line-added">1489 </span>
<span class="line-added">1490             // Populate the projects repository</span>
<span class="line-added">1491             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);</span>
<span class="line-added">1492             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);</span>
<span class="line-added">1493             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="line-added">1494             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
<span class="line-added">1495             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);</span>
<span class="line-added">1496 </span>
<span class="line-added">1497             // Make a change with a corresponding PR</span>
<span class="line-added">1498             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);</span>
<span class="line-added">1499             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);</span>
<span class="line-added">1500             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);</span>
<span class="line-added">1501             pr.setBody(&quot;This is now ready&quot;);</span>
<span class="line-added">1502 </span>
<span class="line-added">1503             var mlBot = mlBotBuilder.build();</span>
<span class="line-added">1504             var mlBotWithCooldown = mlBotBuilder.cooldown(Duration.ofDays(1)).build();</span>
<span class="line-added">1505 </span>
<span class="line-added">1506             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added">1507             listServer.processIncoming();</span>
<span class="line-added">1508 </span>
<span class="line-added">1509             // Make a comment</span>
<span class="line-added">1510             pr.addComment(&quot;Looks good&quot;);</span>
<span class="line-added">1511 </span>
<span class="line-added">1512             // Bot with cooldown configured should not bridge the comment</span>
<span class="line-added">1513             TestBotRunner.runPeriodicItems(mlBotWithCooldown);</span>
<span class="line-added">1514             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="line-added">1515 </span>
<span class="line-added">1516             // But without, it should</span>
<span class="line-added">1517             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added">1518             listServer.processIncoming();</span>
<span class="line-added">1519 </span>
<span class="line-added">1520             // Check the archive</span>
<span class="line-added">1521             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
<span class="line-added">1522             assertTrue(archiveContains(archiveFolder.path(), &quot;Looks good&quot;));</span>
<span class="line-added">1523         }</span>
<span class="line-added">1524     }</span>
1525 }
</pre>
</td>
</tr>
</table>
<center><a href="MailingListArchiveReaderBotTests.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>