<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/ReviewArchive.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="MailingListBridgeBotFactory.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/java/org/openjdk/skara/bots/mlbridge/MailingListArchiveReaderBotTests.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/ReviewArchive.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 package org.openjdk.skara.bots.mlbridge;
  2 
  3 import org.openjdk.skara.email.*;
  4 import org.openjdk.skara.forge.*;
  5 import org.openjdk.skara.host.HostUser;
  6 import org.openjdk.skara.issuetracker.Comment;
  7 import org.openjdk.skara.vcs.*;
  8 
  9 import java.net.URI;
 10 import java.nio.charset.StandardCharsets;
 11 import java.security.*;

 12 import java.util.*;

 13 import java.util.stream.*;
 14 
 15 class ReviewArchive {
 16     private final PullRequest pr;
 17     private final EmailAddress sender;
 18     private final Hash base;
 19     private final Hash head;
 20 
 21     private final List&lt;Comment&gt; comments = new ArrayList&lt;&gt;();
 22     private final List&lt;Review&gt; reviews = new ArrayList&lt;&gt;();
 23     private final List&lt;ReviewComment&gt; reviewComments = new ArrayList&lt;&gt;();
 24 


 25     ReviewArchive(PullRequest pr, EmailAddress sender, Hash base, Hash head) {
 26         this.pr = pr;
 27         this.sender = sender;
 28         this.base = base;
 29         this.head = head;
 30     }
 31 
 32     void addComment(Comment comment) {
 33         comments.add(comment);
 34     }
 35 
 36     void addReview(Review review) {
 37         reviews.add(review);
 38     }
 39 
 40     void addReviewComment(ReviewComment reviewComment) {
 41         reviewComments.add(reviewComment);
 42     }
 43 
 44     // Searches for a previous reply to a certain parent by a specific author
</pre>
<hr />
<pre>
155     }
156 
157     private EmailAddress getUniqueMessageId(String identifier) {
158         try {
159             var prSpecific = pr.repository().name().replace(&quot;/&quot;, &quot;.&quot;) + &quot;.&quot; + pr.id();
160             var digest = MessageDigest.getInstance(&quot;SHA-256&quot;);
161             digest.update(prSpecific.getBytes(StandardCharsets.UTF_8));
162             digest.update(identifier.getBytes(StandardCharsets.UTF_8));
163             var encodedCommon = Base64.getUrlEncoder().encodeToString(digest.digest());
164 
165             return EmailAddress.from(encodedCommon + &quot;.&quot; + UUID.randomUUID() + &quot;@&quot; + pr.repository().url().getHost());
166         } catch (NoSuchAlgorithmException e) {
167             throw new RuntimeException(&quot;Cannot find SHA-256&quot;);
168         }
169     }
170 
171     private String getStableMessageId(EmailAddress uniqueMessageId) {
172         return uniqueMessageId.localPart().split(&quot;\\.&quot;)[0];
173     }
174 
<span class="line-modified">175     List&lt;Email&gt; generateNewEmails(List&lt;Email&gt; sentEmails, Repository localRepo, URI issueTracker, String issuePrefix, WebrevStorage.WebrevGenerator webrevGenerator, WebrevNotification webrevNotification, HostUserToEmailAuthor hostUserToEmailAuthor, HostUserToUserName hostUserToUserName, HostUserToRole hostUserToRole) {</span>

176         var allItems = generateArchiveItems(sentEmails, localRepo, issueTracker, issuePrefix, hostUserToEmailAuthor, hostUserToUserName, hostUserToRole, webrevGenerator, webrevNotification);
177         var sentItemIds = sentItemIds(sentEmails);
178         var unsentItems = allItems.stream()
179                                   .filter(item -&gt; !sentItemIds.contains(getStableMessageId(getUniqueMessageId(item.id()))))
180                                   .collect(Collectors.toList());










181 
182         var combinedItems = collapsableItems(unsentItems);
<span class="line-removed">183         var ret = new ArrayList&lt;Email&gt;();</span>
184         for (var itemList : combinedItems) {
185             // Simply combine all message bodies
186             var body = new StringBuilder();
187             for (var item : itemList) {
188                 if (body.length() &gt; 0) {
189                     body.append(&quot;\n\n&quot;);
190                 }
191                 body.append(item.body());
192             }
193 
194             // For footers, we want to combine all unique fragments
195             var footer = new StringBuilder();
196             var includedFooterFragments = new HashSet&lt;String&gt;();
197             for (var item : itemList) {
198                 var newFooterFragments = Stream.of(item.footer().split(&quot;\n\n&quot;))
199                                                .filter(line -&gt; !includedFooterFragments.contains(line))
200                                                .collect(Collectors.toList());
201                 footer.append(String.join(&quot;\n\n&quot;, newFooterFragments));
202                 includedFooterFragments.addAll(newFooterFragments);
203             }
</pre>
</td>
<td>
<hr />
<pre>
  1 package org.openjdk.skara.bots.mlbridge;
  2 
  3 import org.openjdk.skara.email.*;
  4 import org.openjdk.skara.forge.*;
  5 import org.openjdk.skara.host.HostUser;
  6 import org.openjdk.skara.issuetracker.Comment;
  7 import org.openjdk.skara.vcs.*;
  8 
  9 import java.net.URI;
 10 import java.nio.charset.StandardCharsets;
 11 import java.security.*;
<span class="line-added"> 12 import java.time.*;</span>
 13 import java.util.*;
<span class="line-added"> 14 import java.util.logging.Logger;</span>
 15 import java.util.stream.*;
 16 
 17 class ReviewArchive {
 18     private final PullRequest pr;
 19     private final EmailAddress sender;
 20     private final Hash base;
 21     private final Hash head;
 22 
 23     private final List&lt;Comment&gt; comments = new ArrayList&lt;&gt;();
 24     private final List&lt;Review&gt; reviews = new ArrayList&lt;&gt;();
 25     private final List&lt;ReviewComment&gt; reviewComments = new ArrayList&lt;&gt;();
 26 
<span class="line-added"> 27     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.bots.mlbridge&quot;);</span>
<span class="line-added"> 28 </span>
 29     ReviewArchive(PullRequest pr, EmailAddress sender, Hash base, Hash head) {
 30         this.pr = pr;
 31         this.sender = sender;
 32         this.base = base;
 33         this.head = head;
 34     }
 35 
 36     void addComment(Comment comment) {
 37         comments.add(comment);
 38     }
 39 
 40     void addReview(Review review) {
 41         reviews.add(review);
 42     }
 43 
 44     void addReviewComment(ReviewComment reviewComment) {
 45         reviewComments.add(reviewComment);
 46     }
 47 
 48     // Searches for a previous reply to a certain parent by a specific author
</pre>
<hr />
<pre>
159     }
160 
161     private EmailAddress getUniqueMessageId(String identifier) {
162         try {
163             var prSpecific = pr.repository().name().replace(&quot;/&quot;, &quot;.&quot;) + &quot;.&quot; + pr.id();
164             var digest = MessageDigest.getInstance(&quot;SHA-256&quot;);
165             digest.update(prSpecific.getBytes(StandardCharsets.UTF_8));
166             digest.update(identifier.getBytes(StandardCharsets.UTF_8));
167             var encodedCommon = Base64.getUrlEncoder().encodeToString(digest.digest());
168 
169             return EmailAddress.from(encodedCommon + &quot;.&quot; + UUID.randomUUID() + &quot;@&quot; + pr.repository().url().getHost());
170         } catch (NoSuchAlgorithmException e) {
171             throw new RuntimeException(&quot;Cannot find SHA-256&quot;);
172         }
173     }
174 
175     private String getStableMessageId(EmailAddress uniqueMessageId) {
176         return uniqueMessageId.localPart().split(&quot;\\.&quot;)[0];
177     }
178 
<span class="line-modified">179     List&lt;Email&gt; generateNewEmails(List&lt;Email&gt; sentEmails, Duration cooldown, Repository localRepo, URI issueTracker, String issuePrefix, WebrevStorage.WebrevGenerator webrevGenerator, WebrevNotification webrevNotification, HostUserToEmailAuthor hostUserToEmailAuthor, HostUserToUserName hostUserToUserName, HostUserToRole hostUserToRole) {</span>
<span class="line-added">180         var ret = new ArrayList&lt;Email&gt;();</span>
181         var allItems = generateArchiveItems(sentEmails, localRepo, issueTracker, issuePrefix, hostUserToEmailAuthor, hostUserToUserName, hostUserToRole, webrevGenerator, webrevNotification);
182         var sentItemIds = sentItemIds(sentEmails);
183         var unsentItems = allItems.stream()
184                                   .filter(item -&gt; !sentItemIds.contains(getStableMessageId(getUniqueMessageId(item.id()))))
185                                   .collect(Collectors.toList());
<span class="line-added">186         if (unsentItems.isEmpty()) {</span>
<span class="line-added">187             return ret;</span>
<span class="line-added">188         }</span>
<span class="line-added">189         var lastUpdate = unsentItems.stream()</span>
<span class="line-added">190                                     .map(ArchiveItem::updatedAt)</span>
<span class="line-added">191                                     .max(ZonedDateTime::compareTo).orElseThrow();</span>
<span class="line-added">192         if (lastUpdate.plus(cooldown).isAfter(ZonedDateTime.now())) {</span>
<span class="line-added">193             log.info(&quot;Waiting for new content to settle down - last update was at &quot; + lastUpdate);</span>
<span class="line-added">194             return ret;</span>
<span class="line-added">195         }</span>
196 
197         var combinedItems = collapsableItems(unsentItems);

198         for (var itemList : combinedItems) {
199             // Simply combine all message bodies
200             var body = new StringBuilder();
201             for (var item : itemList) {
202                 if (body.length() &gt; 0) {
203                     body.append(&quot;\n\n&quot;);
204                 }
205                 body.append(item.body());
206             }
207 
208             // For footers, we want to combine all unique fragments
209             var footer = new StringBuilder();
210             var includedFooterFragments = new HashSet&lt;String&gt;();
211             for (var item : itemList) {
212                 var newFooterFragments = Stream.of(item.footer().split(&quot;\n\n&quot;))
213                                                .filter(line -&gt; !includedFooterFragments.contains(line))
214                                                .collect(Collectors.toList());
215                 footer.append(String.join(&quot;\n\n&quot;, newFooterFragments));
216                 includedFooterFragments.addAll(newFooterFragments);
217             }
</pre>
</td>
</tr>
</table>
<center><a href="MailingListBridgeBotFactory.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/java/org/openjdk/skara/bots/mlbridge/MailingListArchiveReaderBotTests.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>