<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/pr/src/test/java/org/openjdk/skara/bots/pr/IntegrateTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/pr/SponsorCommand.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="SponsorTests.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/pr/src/test/java/org/openjdk/skara/bots/pr/IntegrateTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 69             TestBotRunner.runPeriodicItems(mergeBot);
 70 
 71             // The bot should reply with an ok message
 72             var pushed = pr.getComments().stream()
 73                            .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
 74                            .count();
 75             assertEquals(1, pushed);
 76 
 77             // The change should now be present on the master branch
 78             var pushedRepo = Repository.materialize(pushedFolder.path(), author.getUrl(), &quot;master&quot;);
 79             assertTrue(CheckableRepository.hasBeenEdited(pushedRepo));
 80 
 81             var headHash = pushedRepo.resolve(&quot;HEAD&quot;).orElseThrow();
 82             var headCommit = pushedRepo.commits(headHash.hex() + &quot;^..&quot; + headHash.hex()).asList().get(0);
 83 
 84             // Author and committer should be the same
 85             assertEquals(&quot;Generated Committer 1&quot;, headCommit.author().name());
 86             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.author().email());
 87             assertEquals(&quot;Generated Committer 1&quot;, headCommit.committer().name());
 88             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.committer().email());

 89         }
 90     }
 91 
 92     @Test
 93     void reviewersRetained(TestInfo testInfo) throws IOException {
 94         try (var credentials = new HostCredentials(testInfo);
 95              var tempFolder = new TemporaryDirectory();
 96              var pushedFolder = new TemporaryDirectory()) {
 97             var author = credentials.getHostedRepository();
 98             var integrator = credentials.getHostedRepository();
 99             var committer = credentials.getHostedRepository();
100 
101             var censusBuilder = credentials.getCensusBuilder()
102                                            .addCommitter(author.host().getCurrentUserDetails().id())
103                                            .addCommitter(committer.host().getCurrentUserDetails().id())
104                                            .addReviewer(integrator.host().getCurrentUserDetails().id());
105             var mergeBot = new PullRequestBot(integrator, censusBuilder.build(), &quot;master&quot;);
106 
107             // Populate the projects repository
108             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
</pre>
</td>
<td>
<hr />
<pre>
 69             TestBotRunner.runPeriodicItems(mergeBot);
 70 
 71             // The bot should reply with an ok message
 72             var pushed = pr.getComments().stream()
 73                            .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
 74                            .count();
 75             assertEquals(1, pushed);
 76 
 77             // The change should now be present on the master branch
 78             var pushedRepo = Repository.materialize(pushedFolder.path(), author.getUrl(), &quot;master&quot;);
 79             assertTrue(CheckableRepository.hasBeenEdited(pushedRepo));
 80 
 81             var headHash = pushedRepo.resolve(&quot;HEAD&quot;).orElseThrow();
 82             var headCommit = pushedRepo.commits(headHash.hex() + &quot;^..&quot; + headHash.hex()).asList().get(0);
 83 
 84             // Author and committer should be the same
 85             assertEquals(&quot;Generated Committer 1&quot;, headCommit.author().name());
 86             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.author().email());
 87             assertEquals(&quot;Generated Committer 1&quot;, headCommit.committer().name());
 88             assertEquals(&quot;integrationcommitter1@openjdk.java.net&quot;, headCommit.committer().email());
<span class="line-added"> 89             assertTrue(pr.getLabels().contains(&quot;integrated&quot;));</span>
 90         }
 91     }
 92 
 93     @Test
 94     void reviewersRetained(TestInfo testInfo) throws IOException {
 95         try (var credentials = new HostCredentials(testInfo);
 96              var tempFolder = new TemporaryDirectory();
 97              var pushedFolder = new TemporaryDirectory()) {
 98             var author = credentials.getHostedRepository();
 99             var integrator = credentials.getHostedRepository();
100             var committer = credentials.getHostedRepository();
101 
102             var censusBuilder = credentials.getCensusBuilder()
103                                            .addCommitter(author.host().getCurrentUserDetails().id())
104                                            .addCommitter(committer.host().getCurrentUserDetails().id())
105                                            .addReviewer(integrator.host().getCurrentUserDetails().id());
106             var mergeBot = new PullRequestBot(integrator, censusBuilder.build(), &quot;master&quot;);
107 
108             // Populate the projects repository
109             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/pr/SponsorCommand.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="SponsorTests.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>