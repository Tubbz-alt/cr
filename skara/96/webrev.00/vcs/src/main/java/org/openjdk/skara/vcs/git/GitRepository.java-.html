<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old vcs/src/main/java/org/openjdk/skara/vcs/git/GitRepository.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.vcs.git;
  24 
  25 import org.openjdk.skara.process.*;
  26 import org.openjdk.skara.process.Process;
  27 import org.openjdk.skara.vcs.*;
  28 import org.openjdk.skara.vcs.tools.*;
  29 
  30 import java.io.*;
  31 import java.net.URI;
  32 import java.nio.file.*;
  33 import java.nio.charset.StandardCharsets;
  34 import java.time.*;
  35 import java.time.format.DateTimeFormatter;
  36 import java.util.*;
  37 import java.util.logging.Logger;
  38 import java.util.stream.Collectors;
  39 
  40 public class GitRepository implements Repository {
  41     private final Path dir;
  42     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.vcs.git&quot;);
  43     private Path cachedRoot = null;
  44 
  45     private java.lang.Process start(String... cmd) throws IOException {
  46         return start(Arrays.asList(cmd));
  47     }
  48 
  49     private java.lang.Process start(List&lt;String&gt; cmd) throws IOException {
  50         log.fine(&quot;Executing &quot; + String.join(&quot; &quot;, cmd));
  51         var pb = new ProcessBuilder(cmd);
  52         pb.directory(dir.toFile());
  53         pb.redirectError(ProcessBuilder.Redirect.DISCARD);
  54         return pb.start();
  55     }
  56 
  57     private static void stop(java.lang.Process p) throws IOException {
  58         if (p != null &amp;&amp; p.isAlive()) {
  59             var stream = p.getInputStream();
  60             var read = 0;
  61             var buf = new byte[128];
  62             while (read != -1) {
  63                 read = stream.read(buf);
  64             }
  65             try {
  66                 p.waitFor();
  67             } catch (InterruptedException e) {
  68                 throw new IOException(e);
  69             }
  70         }
  71     }
  72 
  73     private Execution capture(List&lt;String&gt; cmd) {
  74         return capture(cmd.toArray(new String[0]));
  75     }
  76 
  77     private Execution capture(String... cmd) {
  78         return capture(dir, cmd);
  79     }
  80 
  81     private static Execution capture(Path cwd, String... cmd) {
  82         return Process.capture(cmd)
  83                       .workdir(cwd)
  84                       .execute();
  85     }
  86 
  87     private static Execution capture(Path cwd, List&lt;String&gt; cmd) {
  88         return capture(cwd, cmd.toArray(new String[0]));
  89     }
  90 
  91     private static Execution.Result await(Execution e) throws IOException {
  92         var result = e.await();
  93         if (result.status() != 0) {
  94             throw new IOException(&quot;Unexpected exit code\n&quot; + result);
  95         }
  96         return result;
  97     }
  98 
  99     private static void await(java.lang.Process p) throws IOException {
 100         try {
 101             var res = p.waitFor();
 102             if (res != 0) {
 103                 throw new IOException(&quot;Unexpected exit code: &quot; + res);
 104             }
 105         } catch (InterruptedException e) {
 106             throw new IOException(e);
 107         }
 108     }
 109 
 110     public GitRepository(Path dir) {
 111         this.dir = dir.toAbsolutePath();
 112     }
 113 
 114     public List&lt;Branch&gt; branches() throws IOException {
 115         try (var p = capture(&quot;git&quot;, &quot;for-each-ref&quot;, &quot;--format=%(refname:short)&quot;, &quot;refs/heads&quot;)) {
 116             return await(p).stdout()
 117                            .stream()
 118                            .map(Branch::new)
 119                            .collect(Collectors.toList());
 120         }
 121     }
 122 
 123     public List&lt;Tag&gt; tags() throws IOException {
 124         try (var p = capture(&quot;git&quot;, &quot;for-each-ref&quot;, &quot;--format=%(refname:short)&quot;, &quot;refs/tags&quot;)) {
 125             return await(p).stdout()
 126                            .stream()
 127                            .map(Tag::new)
 128                            .collect(Collectors.toList());
 129         }
 130     }
 131 
 132     @Override
 133     public Commits commits() throws IOException {
 134         return new GitCommits(dir, &quot;--all&quot;, false, -1);
 135     }
 136 
 137     @Override
 138     public Commits commits(int n) throws IOException {
 139         return new GitCommits(dir, &quot;--all&quot;, false, n);
 140     }
 141 
 142     @Override
 143     public Commits commits(boolean reverse) throws IOException {
 144         return new GitCommits(dir, &quot;--all&quot;, reverse, -1);
 145     }
 146 
 147     @Override
 148     public Commits commits(int n, boolean reverse) throws IOException {
 149         return new GitCommits(dir, &quot;--all&quot;, reverse, n);
 150     }
 151 
 152     @Override
 153     public Commits commits(String range) throws IOException {
 154         return new GitCommits(dir, range, false, -1);
 155     }
 156 
 157     @Override
 158     public Commits commits(String range, int n) throws IOException {
 159         return new GitCommits(dir, range, false, n);
 160     }
 161 
 162     @Override
 163     public Commits commits(String range, boolean reverse) throws IOException {
 164         return new GitCommits(dir, range, reverse, -1);
 165     }
 166 
 167     @Override
 168     public Commits commits(String range, int n, boolean reverse) throws IOException {
 169         return new GitCommits(dir, range, reverse, n);
 170     }
 171 
 172     @Override
 173     public Optional&lt;Commit&gt; lookup(Hash h) throws IOException {
 174         var commits = commits(h.hex(), 1).asList();
 175         if (commits.size() != 1) {
 176             return Optional.empty();
 177         }
 178         return Optional.of(commits.get(0));
 179     }
 180 
 181     @Override
 182     public Optional&lt;Commit&gt; lookup(Branch b) throws IOException {
 183         var hash = resolve(b.name()).orElseThrow(() -&gt; new IOException(&quot;Branch &quot; + b.name() + &quot; not found&quot;));
 184         return lookup(hash);
 185     }
 186 
 187     @Override
 188     public Optional&lt;Commit&gt; lookup(Tag t) throws IOException {
 189         var hash = resolve(t.name()).orElseThrow(() -&gt; new IOException(&quot;Tag &quot; + t.name() + &quot; not found&quot;));
 190         return lookup(hash);
 191     }
 192 
 193     public List&lt;CommitMetadata&gt; commitMetadata() throws IOException {
 194         var revisions = &quot;--all&quot;;
 195         var p = start(&quot;git&quot;, &quot;rev-list&quot;, &quot;--format=&quot; + GitCommitMetadata.FORMAT, &quot;--no-abbrev&quot;, &quot;--reverse&quot;, &quot;--no-color&quot;, revisions);
 196         var reader = new UnixStreamReader(p.getInputStream());
 197         var result = new ArrayList&lt;CommitMetadata&gt;();
 198 
 199         var line = reader.readLine();
 200         while (line != null) {
 201             if (!line.startsWith(&quot;commit&quot;)) {
 202                 throw new IOException(&quot;Unexpected line: &quot; + line);
 203             }
 204 
 205             result.add(GitCommitMetadata.read(reader));
 206             line = reader.readLine();
 207         }
 208 
 209         await(p);
 210         return result;
 211     }
 212 
 213     private List&lt;Hash&gt; refs() throws IOException {
 214         try (var p = capture(&quot;git&quot;, &quot;show-ref&quot;, &quot;--hash&quot;, &quot;--abbrev&quot;)) {
 215             var res = p.await();
 216             if (res.status() == -1) {
 217                 if (res.stdout().size() != 0) {
 218                     throw new IOException(&quot;Unexpected output\n&quot; + res);
 219                 }
 220                 return new ArrayList&lt;&gt;();
 221             } else {
 222                 return res.stdout().stream()
 223                           .map(Hash::new)
 224                           .collect(Collectors.toList());
 225             }
 226         }
 227     }
 228 
 229     @Override
 230     public boolean isEmpty() throws IOException {
 231         int numLooseObjects = -1;
 232         int numPackedObjects = -1;
 233 
 234         try (var p = capture(&quot;git&quot;, &quot;count-objects&quot;, &quot;-v&quot;)) {
 235             var res = await(p);
 236             var stdout = res.stdout();
 237 
 238             for (var line : stdout) {
 239                 if (line.startsWith(&quot;count: &quot;)) {
 240                     try {
 241                         numLooseObjects = Integer.parseUnsignedInt(line.split(&quot; &quot;)[1]);
 242                     } catch (NumberFormatException e) {
 243                         throw new IOException(&quot;Unexpected &#39;count&#39; value\n&quot; + res, e);
 244                     }
 245 
 246                 } else if (line.startsWith(&quot;in-pack: &quot;)) {
 247                     try {
 248                         numPackedObjects = Integer.parseUnsignedInt(line.split(&quot; &quot;)[1]);
 249                     } catch (NumberFormatException e) {
 250                         throw new IOException(&quot;Unexpected &#39;in-pack&#39; value\n&quot; + res, e);
 251                     }
 252                 }
 253             }
 254         }
 255 
 256         return numLooseObjects == 0 &amp;&amp; numPackedObjects == 0 &amp;&amp; refs().size() == 0;
 257     }
 258 
 259     @Override
 260     public boolean isHealthy() throws IOException {
 261         var refs = refs();
 262         if (refs.size() == 0) {
 263             return true;
 264         }
 265 
 266         var name = &quot;health-check&quot;;
 267         try (var p = capture(&quot;git&quot;, &quot;branch&quot;, name, refs.get(0).hex())) {
 268             if (p.await().status() != 0) {
 269                 return false;
 270             }
 271         }
 272         try (var p = capture(&quot;git&quot;, &quot;branch&quot;, &quot;-D&quot;, name)) {
 273             if (p.await().status() != 0) {
 274                 return false;
 275             }
 276         }
 277 
 278         return true;
 279     }
 280 
 281     @Override
 282     public void clean() throws IOException {
 283         cachedRoot = null;
 284 
 285         try (var p = capture(&quot;git&quot;, &quot;clean&quot;, &quot;-x&quot;, &quot;-d&quot;, &quot;--force&quot;, &quot;--force&quot;)) {
 286             await(p);
 287         }
 288 
 289         try (var p = capture(&quot;git&quot;, &quot;reset&quot;, &quot;--hard&quot;)) {
 290             await(p);
 291         }
 292 
 293         try (var p = capture(&quot;git&quot;, &quot;rebase&quot;, &quot;--quit&quot;)) {
 294             p.await(); // Don&#39;t care about the result.
 295         }
 296     }
 297 
 298     @Override
 299     public void revert(Hash h) throws IOException {
 300         try (var p = capture(&quot;git&quot;, &quot;checkout&quot;, h.hex(), &quot;--&quot;, &quot;.&quot;)) {
 301             await(p);
 302         }
 303     }
 304 
 305     @Override
 306     public Repository reinitialize() throws IOException {
 307         cachedRoot = null;
 308 
 309         Files.walk(dir)
 310              .map(Path::toFile)
 311              .sorted(Comparator.reverseOrder())
 312              .forEach(File::delete);
 313 
 314         return init();
 315     }
 316 
 317     @Override
 318     public Hash fetch(URI uri, String refspec) throws IOException {
 319         try (var p = capture(&quot;git&quot;, &quot;fetch&quot;, &quot;--tags&quot;, uri.toString(), refspec)) {
 320             await(p);
 321             return resolve(&quot;FETCH_HEAD&quot;).get();
 322         }
 323     }
 324 
 325     @Override
 326     public void fetchAll() throws IOException {
 327         try (var p = capture(&quot;git&quot;, &quot;fetch&quot;, &quot;--tags&quot;, &quot;--prune&quot;, &quot;--prune-tags&quot;, &quot;--all&quot;)) {
 328             await(p);
 329         }
 330     }
 331 
 332     private void checkout(String ref, boolean force) throws IOException {
 333         var cmd = new ArrayList&lt;String&gt;();
 334         cmd.addAll(List.of(&quot;git&quot;, &quot;-c&quot;, &quot;advice.detachedHead=false&quot;, &quot;checkout&quot;));
 335         if (force) {
 336             cmd.add(&quot;--force&quot;);
 337         }
 338         cmd.add(ref);
 339         try (var p = capture(cmd)) {
 340             await(p);
 341         }
 342     }
 343 
 344     @Override
 345     public void checkout(Hash h, boolean force) throws IOException {
 346         checkout(h.hex(), force);
 347     }
 348 
 349     @Override
 350     public void checkout(Branch b, boolean force) throws IOException {
 351         checkout(b.name(), force);
 352     }
 353 
 354     @Override
 355     public Repository init() throws IOException {
 356         cachedRoot = null;
 357 
 358         if (!Files.exists(dir)) {
 359             Files.createDirectories(dir);
 360         }
 361 
 362         try (var p = capture(&quot;git&quot;, &quot;init&quot;)) {
 363             await(p);
 364             return this;
 365         }
 366     }
 367 
 368     @Override
 369     public void pushAll(URI uri) throws IOException {
 370         try (var p = capture(&quot;git&quot;, &quot;push&quot;, &quot;--mirror&quot;, uri.toString())) {
 371             await(p);
 372         }
 373     }
 374 
 375     @Override
 376     public void push(Hash hash, URI uri, String ref, boolean force) throws IOException {
 377         String refspec = force ? &quot;+&quot; : &quot;&quot;;
 378         if (!ref.startsWith(&quot;refs/&quot;)) {
 379             ref = &quot;refs/heads/&quot; + ref;
 380         }
 381         refspec += hash.hex() + &quot;:&quot; + ref;
 382 
 383         try (var p = capture(&quot;git&quot;, &quot;push&quot;, uri.toString(), refspec)) {
 384             await(p);
 385         }
 386     }
 387 
 388     @Override
 389     public void push(Branch branch, String remote, boolean setUpstream) throws IOException {
 390         var cmd = new ArrayList&lt;String&gt;();
 391         cmd.addAll(List.of(&quot;git&quot;, &quot;push&quot;, remote, branch.name()));
 392         if (setUpstream) {
 393             cmd.add(&quot;--set-upstream&quot;);
 394         }
 395 
 396         try (var p = capture(cmd)) {
 397             await(p);
 398         }
 399     }
 400 
 401     @Override
 402     public boolean isClean() throws IOException {
 403         try (var p = capture(&quot;git&quot;, &quot;status&quot;, &quot;--porcelain&quot;)) {
 404             var output = await(p);
 405             return output.stdout().size() == 0;
 406         }
 407     }
 408 
 409     @Override
 410     public boolean exists() throws IOException {
 411         if (!Files.exists(dir)) {
 412             return false;
 413         }
 414 
 415         try (var p = capture(&quot;git&quot;, &quot;rev-parse&quot;, &quot;--git-dir&quot;)) {
 416             return p.await().status() == 0;
 417         }
 418     }
 419 
 420     @Override
 421     public Path root() throws IOException {
 422         if (cachedRoot != null) {
 423             return cachedRoot;
 424         }
 425 
 426         try (var p = capture(&quot;git&quot;, &quot;rev-parse&quot;, &quot;--show-toplevel&quot;)) {
 427             var res = await(p);
 428             if (res.stdout().size() != 1) {
 429                 // Perhaps this is a bare repository
 430                 try (var p2 = capture(&quot;git&quot;, &quot;rev-parse&quot;, &quot;--git-dir&quot;)) {
 431                     var res2 = await(p2);
 432                     if (res2.stdout().size() != 1) {
 433                         throw new IOException(&quot;Unexpected output\n&quot; + res2);
 434                     }
 435                     cachedRoot = dir.resolve(Path.of(res2.stdout().get(0)));
 436                     return cachedRoot;
 437                 }
 438             }
 439 
 440             cachedRoot = Path.of(res.stdout().get(0));
 441             return cachedRoot;
 442         }
 443     }
 444 
 445     @Override
 446     public void squash(Hash h) throws IOException {
 447         try (var p = capture(&quot;git&quot;, &quot;merge&quot;, &quot;--squash&quot;, h.hex())) {
 448             await(p);
 449         }
 450     }
 451 
 452     @FunctionalInterface
 453     private static interface Operation {
 454         void execute(List&lt;Path&gt; args) throws IOException;
 455     }
 456 
 457     private void batch(Operation op, List&lt;Path&gt; args) throws IOException {
 458         var batchSize = 64;
 459         var start = 0;
 460         while (start &lt; args.size()) {
 461             var end = start + batchSize;
 462             if (end &gt; args.size()) {
 463                 end = args.size();
 464             }
 465             op.execute(args.subList(start, end));
 466             start = end;
 467         }
 468     }
 469 
 470     private void addAll(List&lt;Path&gt; paths) throws IOException {
 471         var cmd = new ArrayList&lt;&gt;(List.of(&quot;git&quot;, &quot;add&quot;));
 472         for (var path : paths) {
 473             cmd.add(path.toString());
 474         }
 475         try (var p = capture(cmd)) {
 476             await(p);
 477         }
 478     }
 479 
 480     @Override
 481     public void add(List&lt;Path&gt; paths) throws IOException {
 482         batch(this::addAll, paths);
 483     }
 484 
 485     private void removeAll(List&lt;Path&gt; paths) throws IOException {
 486         var cmd = new ArrayList&lt;&gt;(List.of(&quot;git&quot;, &quot;rm&quot;));
 487         for (var path : paths) {
 488             cmd.add(path.toString());
 489         }
 490         try (var p = capture(cmd)) {
 491             await(p);
 492         }
 493     }
 494 
 495     @Override
 496     public void remove(List&lt;Path&gt; paths) throws IOException {
 497         batch(this::removeAll, paths);
 498     }
 499 
 500     @Override
 501     public void delete(Branch b) throws IOException {
 502         try (var p = capture(&quot;git&quot;, &quot;branch&quot;, &quot;-D&quot;, b.name())) {
 503             await(p);
 504         }
 505     }
 506 
 507     @Override
 508     public void addremove() throws IOException {
 509         try (var p = capture(&quot;git&quot;, &quot;add&quot;, &quot;--all&quot;)) {
 510             await(p);
 511         }
 512     }
 513 
 514     @Override
 515     public Hash commit(String message, String authorName, String authorEmail)  throws IOException {
 516         return commit(message, authorName, authorEmail, null);
 517     }
 518 
 519     @Override
 520     public Hash commit(String message, String authorName, String authorEmail, ZonedDateTime authorDate)  throws IOException {
 521         return commit(message, authorName, authorEmail, authorDate, authorName, authorEmail, authorDate);
 522     }
 523 
 524     @Override
 525     public Hash commit(String message,
 526                        String authorName,
 527                        String authorEmail,
 528                        String committerName,
 529                        String committerEmail) throws IOException {
 530         return commit(message, authorName, authorEmail, null, committerName, committerEmail, null);
 531     }
 532 
 533     @Override
 534     public Hash commit(String message,
 535                        String authorName,
 536                        String authorEmail,
 537                        ZonedDateTime authorDate,
 538                        String committerName,
 539                        String committerEmail,
 540                        ZonedDateTime committerDate) throws IOException {
 541         var cmd = Process.capture(&quot;git&quot;, &quot;commit&quot;, &quot;--message=&quot; + message)
 542                          .workdir(dir)
 543                          .environ(&quot;GIT_AUTHOR_NAME&quot;, authorName)
 544                          .environ(&quot;GIT_AUTHOR_EMAIL&quot;, authorEmail)
 545                          .environ(&quot;GIT_COMMITTER_NAME&quot;, committerName)
 546                          .environ(&quot;GIT_COMMITTER_EMAIL&quot;, committerEmail);
 547         if (authorDate != null) {
 548             cmd = cmd.environ(&quot;GIT_AUTHOR_DATE&quot;,
 549                               authorDate.format(DateTimeFormatter.ISO_OFFSET_DATE_TIME));
 550         }
 551         if (committerDate != null) {
 552             cmd = cmd.environ(&quot;GIT_COMMITTER_DATE&quot;,
 553                               committerDate.format(DateTimeFormatter.ISO_OFFSET_DATE_TIME));
 554         }
 555         try (var p = cmd.execute()) {
 556             await(p);
 557             return head();
 558         }
 559     }
 560 
 561     @Override
 562     public Hash amend(String message, String authorName, String authorEmail) throws IOException {
 563         return amend(message, authorName, authorEmail, null, null);
 564     }
 565 
 566     @Override
 567     public Hash amend(String message, String authorName, String authorEmail, String committerName, String committerEmail) throws IOException {
 568         if (committerName == null) {
 569             committerName = authorName;
 570             committerEmail = authorEmail;
 571         }
 572         var cmd = Process.capture(&quot;git&quot;, &quot;commit&quot;, &quot;--amend&quot;, &quot;--reset-author&quot;, &quot;--message=&quot; + message)
 573                          .workdir(dir)
 574                          .environ(&quot;GIT_AUTHOR_NAME&quot;, authorName)
 575                          .environ(&quot;GIT_AUTHOR_EMAIL&quot;, authorEmail)
 576                          .environ(&quot;GIT_COMMITTER_NAME&quot;, committerName)
 577                          .environ(&quot;GIT_COMMITTER_EMAIL&quot;, committerEmail);
 578         try (var p = cmd.execute()) {
 579             await(p);
 580             return head();
 581         }
 582     }
 583 
 584     @Override
 585     public Tag tag(Hash hash, String name, String message, String authorName, String authorEmail) throws IOException {
 586         var cmd = Process.capture(&quot;git&quot;, &quot;tag&quot;, &quot;--annotate&quot;, &quot;--message=&quot; + message, name, hash.hex())
 587                          .workdir(dir)
 588                          .environ(&quot;GIT_AUTHOR_NAME&quot;, authorName)
 589                          .environ(&quot;GIT_AUTHOR_EMAIL&quot;, authorEmail)
 590                          .environ(&quot;GIT_COMMITTER_NAME&quot;, authorName)
 591                          .environ(&quot;GIT_COMMITTER_EMAIL&quot;, authorEmail);
 592         try (var p = cmd.execute()) {
 593             await(p);
 594         }
 595 
 596         return new Tag(name);
 597     }
 598 
 599     @Override
 600     public Branch branch(Hash hash, String name) throws IOException {
 601         try (var p = capture(&quot;git&quot;, &quot;branch&quot;, name, hash.hex())) {
 602             await(p);
 603         }
 604 
 605         return new Branch(name);
 606     }
 607 
 608     @Override
 609     public Hash mergeBase(Hash first, Hash second) throws IOException {
 610         try (var p = capture(&quot;git&quot;, &quot;merge-base&quot;, first.hex(), second.hex())) {
 611             var res = await(p);
 612             if (res.stdout().size() != 1) {
 613                  throw new IOException(&quot;Unexpected output\n&quot; + res);
 614             }
 615             return new Hash(res.stdout().get(0));
 616         }
 617     }
 618 
 619     @Override
 620     public boolean isAncestor(Hash ancestor, Hash descendant) throws IOException {
 621         try (var p = capture(&quot;git&quot;, &quot;merge-base&quot;, &quot;--is-ancestor&quot;, ancestor.hex(), descendant.hex())) {
 622             var res = p.await();
 623             return res.status() == 0;
 624         }
 625     }
 626 
 627     @Override
 628     public void rebase(Hash hash, String committerName, String committerEmail) throws IOException {
 629         try (var p = Process.capture(&quot;git&quot;, &quot;rebase&quot;, &quot;--onto&quot;, hash.hex(), &quot;--root&quot;, &quot;--rebase-merges&quot;)
 630                             .environ(&quot;GIT_COMMITTER_NAME&quot;, committerName)
 631                             .environ(&quot;GIT_COMMITTER_EMAIL&quot;, committerEmail)
 632                             .workdir(dir)
 633                             .execute()) {
 634             await(p);
 635         }
 636     }
 637 
 638     @Override
 639     public Optional&lt;Hash&gt; resolve(String ref) throws IOException {
 640         try (var p = capture(&quot;git&quot;, &quot;rev-parse&quot;, ref + &quot;^{commit}&quot;)) {
 641             var res = p.await();
 642             if (res.status() == 0 &amp;&amp; res.stdout().size() == 1) {
 643                 return Optional.of(new Hash(res.stdout().get(0)));
 644             }
 645             return Optional.empty();
 646         }
 647     }
 648 
 649     @Override
 650     public Branch currentBranch() throws IOException {
 651         try (var p = capture(&quot;git&quot;, &quot;symbolic-ref&quot;, &quot;--short&quot;, &quot;HEAD&quot;)) {
 652             var res = await(p);
 653             if (res.stdout().size() != 1) {
 654                 throw new IOException(&quot;Unexpected output\n&quot; + res);
 655             }
 656             return new Branch(res.stdout().get(0));
 657         }
 658     }
 659 
 660     @Override
 661     public Branch defaultBranch() throws IOException {
 662         try (var p = capture(&quot;git&quot;, &quot;symbolic-ref&quot;, &quot;--short&quot;, &quot;refs/remotes/origin/HEAD&quot;)) {
 663             var res = p.await();
 664             if (res.status() == 0 &amp;&amp; res.stdout().size() == 1) {
 665                 var ref = res.stdout().get(0).substring(&quot;origin/&quot;.length());
 666                 return new Branch(ref);
 667             } else {
 668                 return new Branch(&quot;master&quot;);
 669             }
 670         }
 671     }
 672 
 673     @Override
 674     public Optional&lt;Tag&gt; defaultTag() throws IOException {
 675         return Optional.empty();
 676     }
 677 
 678     @Override
 679     public Optional&lt;String&gt; username() throws IOException {
 680         var lines = config(&quot;user.name&quot;);
 681         return lines.size() == 1 ? Optional.of(lines.get(0)) : Optional.empty();
 682     }
 683 
 684     private String treeEntry(Path path, Hash hash) throws IOException {
 685         try (var p = Process.capture(&quot;git&quot;, &quot;ls-tree&quot;, hash.hex(), path.toString())
 686                             .workdir(root())
 687                             .execute()) {
 688             var res = await(p);
 689             if (res.stdout().size() == 0) {
 690                 return null;
 691             }
 692             if (res.stdout().size() &gt; 1) {
 693                 throw new IOException(&quot;Unexpected output\n&quot; + res);
 694             }
 695             return res.stdout().get(0);
 696         }
 697     }
 698 
 699     private List&lt;FileEntry&gt; allFiles(Hash hash, List&lt;Path&gt; paths) throws IOException {
 700         var cmd = new ArrayList&lt;String&gt;();
 701         cmd.addAll(List.of(&quot;git&quot;, &quot;ls-tree&quot;, &quot;-r&quot;));
 702         cmd.add(hash.hex());
 703         cmd.addAll(paths.stream().map(Path::toString).collect(Collectors.toList()));
 704         try (var p = Process.capture(cmd.toArray(new String[0]))
 705                             .workdir(root())
 706                             .execute()) {
 707             var res = await(p);
 708             var entries = new ArrayList&lt;FileEntry&gt;();
 709             for (var line : res.stdout()) {
 710                 var parts = line.split(&quot;\t&quot;);
 711                 var metadata = parts[0].split(&quot; &quot;);
 712                 var filename = parts[1];
 713 
 714                 var entry = new FileEntry(hash,
 715                                           FileType.fromOctal(metadata[0]),
 716                                           new Hash(metadata[2]),
 717                                           Path.of(filename));
 718                 entries.add(entry);
 719             }
 720             return entries;
 721         }
 722     }
 723 
 724     @Override
 725     public List&lt;FileEntry&gt; files(Hash hash, List&lt;Path&gt; paths) throws IOException {
 726         if (paths.isEmpty()) {
 727             return allFiles(hash, paths);
 728         }
 729 
 730         var entries = new ArrayList&lt;FileEntry&gt;();
 731         var batchSize = 64;
 732         var start = 0;
 733         while (start &lt; paths.size()) {
 734             var end = start + batchSize;
 735             if (end &gt; paths.size()) {
 736                 end = paths.size();
 737             }
 738             entries.addAll(allFiles(hash, paths.subList(start, end)));
 739             start = end;
 740         }
 741         return entries;
 742     }
 743 
 744     private Path unpackFile(String blob) throws IOException {
 745         try (var p = capture(&quot;git&quot;, &quot;unpack-file&quot;, blob)) {
 746             var res = await(p);
 747             if (res.stdout().size() != 1) {
 748                 throw new IOException(&quot;Unexpected output\n&quot; + res);
 749             }
 750 
 751             return Path.of(root().toString(), res.stdout().get(0));
 752         }
 753     }
 754 
 755     @Override
 756     public Optional&lt;byte[]&gt; show(Path path, Hash hash) throws IOException {
 757         var entries = files(hash, path);
 758         if (entries.size() == 0) {
 759             return Optional.empty();
 760         } else if (entries.size() &gt; 1) {
 761             throw new IOException(&quot;Multiple files match path &quot; + path.toString() + &quot; in commit &quot; + hash.hex());
 762         }
 763 
 764         var entry = entries.get(0);
 765         var type = entry.type();
 766         if (type.isVCSLink()) {
 767             var content = &quot;Subproject commit &quot; + entry.hash().hex() + &quot; &quot; + entry.path().toString();
 768             return Optional.of(content.getBytes(StandardCharsets.UTF_8));
 769         } else if (type.isRegular()) {
 770             var tmp = unpackFile(entry.hash().hex());
 771             var content = Files.readAllBytes(tmp);
 772             Files.delete(tmp);
 773             return Optional.of(content);
 774         }
 775 
 776         return Optional.empty();
 777     }
 778 
 779     @Override
 780     public void dump(FileEntry entry, Path to) throws IOException {
 781         var type = entry.type();
 782         if (type.isRegular()) {
 783             var path = unpackFile(entry.hash().hex());
 784             Files.createDirectories(to.getParent());
 785             Files.move(path, to, StandardCopyOption.REPLACE_EXISTING);
 786         }
 787     }
 788 
 789     @Override
 790     public List&lt;StatusEntry&gt; status(Hash from, Hash to) throws IOException {
 791         try (var p = capture(&quot;git&quot;, &quot;diff&quot;, &quot;--raw&quot;, &quot;--find-renames=99%&quot;, &quot;--find-copies=99%&quot;, &quot;--find-copies-harder&quot;, &quot;--no-abbrev&quot;, &quot;--no-color&quot;, from.hex(), to.hex())) {
 792             var res = await(p);
 793             var entries = new ArrayList&lt;StatusEntry&gt;();
 794             for (var line : res.stdout()) {
 795                 entries.add(StatusEntry.fromRawLine(line));
 796             }
 797             return entries;
 798         }
 799     }
 800 
 801     @Override
 802     public Diff diff(Hash from) throws IOException {
 803         return diff(from, null);
 804     }
 805 
 806     @Override
 807     public Diff diff(Hash from, Hash to) throws IOException {
 808         var cmd = new ArrayList&lt;&gt;(List.of(&quot;git&quot;, &quot;diff&quot;, &quot;--patch&quot;,
 809                                                          &quot;--find-renames=99%&quot;,
 810                                                          &quot;--find-copies=99%&quot;,
 811                                                          &quot;--find-copies-harder&quot;,
 812                                                          &quot;--binary&quot;,
 813                                                          &quot;--raw&quot;,
 814                                                          &quot;--no-abbrev&quot;,
 815                                                          &quot;--unified=0&quot;,
 816                                                          &quot;--no-color&quot;,
 817                                                          from.hex()));
 818         if (to != null) {
 819             cmd.add(to.hex());
 820         }
 821 
 822         var p = start(cmd);
 823         try {
 824             var patches = UnifiedDiffParser.parseGitRaw(p.getInputStream());
 825             await(p);
 826             return new Diff(from, to, patches);
 827         } catch (Throwable t) {
 828             stop(p);
 829             throw t;
 830         }
 831     }
 832 
 833     @Override
 834     public List&lt;String&gt; config(String key) throws IOException {
 835         try (var p = capture(&quot;git&quot;, &quot;config&quot;, key)) {
 836             var res = p.await();
 837             return res.status() == 0 ? res.stdout() : List.of();
 838         }
 839     }
 840 
 841     @Override
 842     public Hash head() throws IOException {
 843         return resolve(&quot;HEAD&quot;).orElseThrow(() -&gt; new IllegalStateException(&quot;HEAD ref is not present&quot;));
 844     }
 845 
 846     public static Optional&lt;Repository&gt; get(Path p) throws IOException {
 847         if (!Files.exists(p)) {
 848             return Optional.empty();
 849         }
 850 
 851         var r = new GitRepository(p);
 852         return r.exists() ? Optional.of(new GitRepository(r.root())) : Optional.empty();
 853     }
 854 
 855     @Override
 856     public Repository copyTo(Path destination) throws IOException {
 857         try (var p = capture(&quot;git&quot;, &quot;clone&quot;, root().toString(), destination.toString())) {
 858             await(p);
 859         }
 860 
 861         return new GitRepository(destination);
 862     }
 863 
 864     @Override
 865     public void merge(Hash h) throws IOException {
 866         merge(h, null);
 867     }
 868 
 869     @Override
 870     public void merge(Hash h, String strategy) throws IOException {
 871         var cmd = new ArrayList&lt;String&gt;();
 872         cmd.addAll(List.of(&quot;git&quot;, &quot;-c&quot;, &quot;user.name=unused&quot;, &quot;-c&quot;, &quot;user.email=unused&quot;,
 873                            &quot;merge&quot;, &quot;--no-commit&quot;));
 874         if (strategy != null) {
 875             cmd.add(&quot;-s&quot;);
 876             cmd.add(strategy);
 877         }
 878         cmd.add(h.hex());
 879         try (var p = capture(cmd)) {
 880             await(p);
 881         }
 882     }
 883 
 884     @Override
 885     public void addRemote(String name, String pullPath) throws IOException {
 886         try (var p = capture(&quot;git&quot;, &quot;remote&quot;, &quot;add&quot;, name, pullPath)) {
 887             await(p);
 888         }
 889     }
 890 
 891     @Override
 892     public void setPaths(String remote, String pullPath, String pushPath) throws IOException {
 893         pullPath = pullPath == null ? &quot;&quot; : pullPath;
 894         try (var p = capture(&quot;git&quot;, &quot;config&quot;, &quot;remote.&quot; + remote + &quot;.url&quot;, pullPath)) {
 895             await(p);
 896         }
 897 
 898         pushPath = pushPath == null ? &quot;&quot; : pushPath;
 899         try (var p = capture(&quot;git&quot;, &quot;config&quot;, &quot;remote.&quot; + remote + &quot;.pushurl&quot;, pushPath)) {
 900             await(p);
 901         }
 902     }
 903 
 904     @Override
 905     public String pullPath(String remote) throws IOException {
 906         var lines = config(&quot;remote.&quot; + remote + &quot;.url&quot;);
 907         if (lines.size() != 1) {
 908             throw new IOException(&quot;No pull path found for remote &quot; + remote);
 909         }
 910         return lines.get(0);
 911     }
 912 
 913     @Override
 914     public String pushPath(String remote) throws IOException {
 915         var lines = config(&quot;remote.&quot; + remote + &quot;.pushurl&quot;);
 916         if (lines.size() != 1) {
 917             return pullPath(remote);
 918         }
 919         return lines.get(0);
 920     }
 921 
 922     @Override
 923     public boolean isValidRevisionRange(String expression) throws IOException {
 924         try (var p = capture(&quot;git&quot;, &quot;rev-parse&quot;, expression)) {
 925             return p.await().status() == 0;
 926         }
 927     }
 928 
 929     private void applyPatch(Patch patch) throws IOException {
 930         if (patch.isEmpty()) {
 931             return;
 932         }
 933 
 934         if (patch.isTextual()) {
 935         } else {
 936             throw new IllegalArgumentException(&quot;Cannot handle binary patches yet&quot;);
 937         }
 938     }
 939 
 940     @Override
 941     public void apply(Diff diff, boolean force) throws IOException {
 942         // ignore force, no such concept in git
 943         var patchFile = Files.createTempFile(&quot;apply&quot;, &quot;.patch&quot;);
 944         diff.toFile(patchFile);
 945         var cmd = new ArrayList&lt;String&gt;();
 946         cmd.addAll(List.of(&quot;git&quot;, &quot;apply&quot;, &quot;--index&quot;, &quot;--unidiff-zero&quot;));
 947         cmd.add(patchFile.toAbsolutePath().toString());
 948         try (var p = capture(cmd)) {
 949             await(p);
 950             Files.delete(patchFile);
 951         }
 952     }
 953 
 954     @Override
 955     public void copy(Path from, Path to) throws IOException {
 956         Files.copy(from, to);
 957         add(to);
 958     }
 959 
 960     @Override
 961     public void move(Path from, Path to) throws IOException {
 962         try (var p = capture(&quot;git&quot;, &quot;mv&quot;, from.toString(), to.toString())) {
 963             await(p);
 964         }
 965     }
 966 
 967     @Override
 968     public Optional&lt;String&gt; upstreamFor(Branch b) throws IOException {
 969         try (var p = capture(&quot;git&quot;, &quot;for-each-ref&quot;, &quot;--format=%(upstream:short)&quot;, &quot;refs/heads/&quot; + b.name())) {
 970             var lines = await(p).stdout();
 971             return lines.size() == 1 &amp;&amp; !lines.get(0).isEmpty()? Optional.of(lines.get(0)) : Optional.empty();
 972         }
 973     }
 974 
 975     public static Repository clone(URI from, Path to, boolean isBare) throws IOException {
 976         var cmd = new ArrayList&lt;String&gt;();
 977         cmd.addAll(List.of(&quot;git&quot;, &quot;clone&quot;));
 978         if (isBare) {
 979             cmd.add(&quot;--bare&quot;);
 980         }
 981         cmd.addAll(List.of(from.toString(), to.toString()));
 982         try (var p = capture(Path.of(&quot;&quot;).toAbsolutePath(), cmd)) {
 983             await(p);
 984         }
 985         return new GitRepository(to);
 986     }
 987 
 988     public static Repository mirror(URI from, Path to) throws IOException {
 989         var cwd = Path.of(&quot;&quot;).toAbsolutePath();
 990         try (var p = capture(cwd, &quot;git&quot;, &quot;clone&quot;, &quot;--mirror&quot;, from.toString(), to.toString())) {
 991             await(p);
 992         }
 993         return new GitRepository(to);
 994     }
 995 
 996     @Override
 997     public void pull() throws IOException {
 998         pull(null, null);
 999     }
1000 
1001     @Override
1002     public void pull(String remote) throws IOException {
1003         pull(remote, null);
1004     }
1005 
1006 
1007     @Override
1008     public void pull(String remote, String refspec) throws IOException {
1009         var cmd = new ArrayList&lt;String&gt;();
1010         cmd.add(&quot;git&quot;);
1011         cmd.add(&quot;pull&quot;);
1012         if (remote != null) {
1013             cmd.add(remote);
1014         }
1015         if (refspec != null) {
1016             cmd.add(refspec);
1017         }
1018         try (var p = capture(cmd)) {
1019             await(p);
1020         }
1021     }
1022 }
    </pre>
  </body>
</html>