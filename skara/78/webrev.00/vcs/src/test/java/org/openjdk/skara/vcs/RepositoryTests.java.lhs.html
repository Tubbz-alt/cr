<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames vcs/src/test/java/org/openjdk/skara/vcs/RepositoryTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.vcs;
  24 
  25 import org.openjdk.skara.test.TemporaryDirectory;
  26 
  27 import org.junit.jupiter.api.Test;
  28 import org.junit.jupiter.params.ParameterizedTest;
  29 import org.junit.jupiter.params.provider.EnumSource;
  30 
  31 import java.io.IOException;
  32 import java.net.URI;
  33 import java.nio.file.*;
  34 import java.nio.file.attribute.*;
  35 import java.util.*;
  36 import java.util.stream.Collectors;
  37 
  38 import static java.nio.file.StandardOpenOption.*;
  39 import static org.junit.jupiter.api.Assertions.*;
  40 
  41 public class RepositoryTests {
  42 
  43     @ParameterizedTest
  44     @EnumSource(VCS.class)
  45     void testExistsOnMissingDirectory(VCS vcs) throws IOException {
  46         var d = Paths.get(&quot;/&quot;, &quot;this&quot;, &quot;path&quot;, &quot;does&quot;, &quot;not&quot;, &quot;exist&quot;);
  47         var r = Repository.get(d);
  48         assertTrue(r.isEmpty());
  49     }
  50 
  51     @ParameterizedTest
  52     @EnumSource(VCS.class)
  53     void testExistsOnEmptyDirectory(VCS vcs) throws IOException {
  54         try (var dir = new TemporaryDirectory()) {
  55             var r = Repository.get(dir.path());
  56             assertTrue(r.isEmpty());
  57         }
  58     }
  59 
  60     @ParameterizedTest
  61     @EnumSource(VCS.class)
  62     void testExistsOnInitializedRepository(VCS vcs) throws IOException {
  63         try (var dir = new TemporaryDirectory()) {
  64             var r = Repository.init(dir.path(), vcs);
  65             assertTrue(r.exists());
  66         }
  67     }
  68 
  69     @ParameterizedTest
  70     @EnumSource(VCS.class)
  71     void testExistsOnSubdir() throws IOException {
  72         try (var dir = new TemporaryDirectory()) {
  73             var r = Repository.init(dir.path(), VCS.GIT);
  74             assertTrue(r.exists());
  75 
  76             var subdir = Paths.get(dir.toString(), &quot;test&quot;);
  77             Files.createDirectories(subdir);
  78             var r2 = Repository.get(subdir);
  79             assertTrue(r2.get().exists());
  80         }
  81     }
  82 
  83     @ParameterizedTest
  84     @EnumSource(VCS.class)
  85     void testRootOnTopLevel() throws IOException {
  86         try (var dir = new TemporaryDirectory()) {
  87             var r = Repository.init(dir.path(), VCS.GIT);
  88             assertEquals(dir.toString(), r.root().toString());
  89         }
  90     }
  91 
  92     @ParameterizedTest
  93     @EnumSource(VCS.class)
  94     void testRootOnSubdirectory(VCS vcs) throws IOException {
  95         try (var dir = new TemporaryDirectory()) {
  96             var r = Repository.init(dir.path(), vcs);
  97             assertEquals(dir.toString(), r.root().toString());
  98 
  99             var subdir = Paths.get(dir.toString(), &quot;sub&quot;);
 100             Files.createDirectories(subdir);
 101 
 102             var r2 = Repository.get(subdir);
 103             assertEquals(dir.toString(), r2.get().root().toString());
 104         }
 105     }
 106 
 107     @ParameterizedTest
 108     @EnumSource(VCS.class)
 109     void testResolveOnEmptyRepository(VCS vcs) throws IOException {
 110         try (var dir = new TemporaryDirectory()) {
 111             var r = Repository.init(dir.path(), vcs);
 112             assertTrue(r.resolve(&quot;HEAD&quot;).isEmpty());
 113         }
 114     }
 115 
 116     @ParameterizedTest
 117     @EnumSource(VCS.class)
 118     void testResolveWithHEAD(VCS vcs) throws IOException {
 119         try (var dir = new TemporaryDirectory()) {
 120             var r = Repository.init(dir.path(), vcs);
 121 
 122             var readme = dir.path().resolve(&quot;README&quot;);
 123             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 124 
 125             r.add(readme);
 126             var head = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 127             assertEquals(head, r.head());
 128         }
 129     }
 130 
 131     @ParameterizedTest
 132     @EnumSource(VCS.class)
 133     void testConfig(VCS vcs) throws IOException {
 134         try (var dir = new TemporaryDirectory()) {
 135             var r = Repository.init(dir.path(), vcs);
 136 
 137             if (vcs == VCS.GIT) {
 138                 var config = dir.path().resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 139                 Files.write(config, List.of(&quot;[user]&quot;, &quot;name = duke&quot;), WRITE, APPEND);
 140                 assertEquals(List.of(&quot;duke&quot;), r.config(&quot;user.name&quot;));
 141             } else if (vcs == VCS.HG) {
 142                 var config = dir.path().resolve(&quot;.hg&quot;).resolve(&quot;hgrc&quot;);
 143                 Files.write(config, List.of(&quot;[ui]&quot;, &quot;username = duke&quot;), WRITE, CREATE);
 144                 assertEquals(List.of(&quot;duke&quot;), r.config(&quot;ui.username&quot;));
 145             }
 146 
 147             assertEquals(&quot;duke&quot;, r.username().get());
 148         }
 149     }
 150 
 151     @ParameterizedTest
 152     @EnumSource(VCS.class)
 153     void testCurrentBranchOnEmptyRepository(VCS vcs) throws IOException {
 154         try (var dir = new TemporaryDirectory()) {
 155             var r = Repository.init(dir.path(), vcs);
 156             assertEquals(r.defaultBranch(), r.currentBranch());
 157         }
 158     }
 159 
 160     @ParameterizedTest
 161     @EnumSource(VCS.class)
 162     void testCheckout(VCS vcs) throws IOException {
 163         try (var dir = new TemporaryDirectory()) {
 164             var r = Repository.init(dir.path(), vcs);
 165 
 166             var readme = dir.path().resolve(&quot;README&quot;);
 167             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 168             r.add(readme);
 169 
 170             var head1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 171             assertEquals(head1, r.head());
 172 
 173             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 174             r.add(readme);
 175 
 176             var head2 = r.commit(&quot;Add one more line&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 177             assertEquals(head2, r.head());
 178 
 179             r.checkout(head1, false);
 180             assertEquals(head1, r.head());
 181 
 182             r.checkout(head2, false);
 183             assertEquals(head2, r.head());
 184         }
 185     }
 186 
 187     @ParameterizedTest
 188     @EnumSource(VCS.class)
 189     void testLines(VCS vcs) throws IOException {
 190         try (var dir = new TemporaryDirectory()) {
 191             var r = Repository.init(dir.path(), vcs);
 192 
 193             var readme = dir.path().resolve(&quot;README&quot;);
 194             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 195             r.add(readme);
 196 
 197             var head1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 198             assertEquals(List.of(&quot;Hello, readme!&quot;),
 199                          r.lines(readme, head1).orElseThrow());
 200 
 201             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 202             r.add(readme);
 203 
 204             var head2 = r.commit(&quot;Add one more line&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 205             assertEquals(List.of(&quot;Hello, readme!&quot;, &quot;Another line&quot;),
 206                          r.lines(readme, head2).orElseThrow());
 207         }
 208     }
 209 
 210     @ParameterizedTest
 211     @EnumSource(VCS.class)
 212     void testLinesInSubdir(VCS vcs) throws IOException {
 213         try (var dir = new TemporaryDirectory()) {
 214             Repository.init(dir.path(), vcs);
 215 
 216             var subdir = dir.path().resolve(&quot;sub&quot;);
 217             Files.createDirectories(subdir);
 218             var r = Repository.get(subdir).get();
 219 
 220             var readme = subdir.getParent().resolve(&quot;README&quot;);
 221             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 222             r.add(readme);
 223 
 224             var head = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 225             assertEquals(List.of(&quot;Hello, readme!&quot;),
 226                          r.lines(readme, head).orElseThrow());
 227 
 228             var example = subdir.resolve(&quot;EXAMPLE&quot;);
 229             Files.write(example, List.of(&quot;An example&quot;));
 230             r.add(example);
 231 
 232             var head2 = r.commit(&quot;Add EXAMPLE&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 233             assertEquals(List.of(&quot;An example&quot;),
 234                          r.lines(example, head2).orElseThrow());
 235         }
 236     }
 237 
 238     @ParameterizedTest
 239     @EnumSource(VCS.class)
 240     void testCommitListingOnEmptyRepo(VCS vcs) throws IOException {
 241         try (var dir = new TemporaryDirectory()) {
 242             var r = Repository.init(dir.path(), vcs);
 243             assertTrue(r.commits().asList().isEmpty());
 244         }
 245     }
 246 
 247     @ParameterizedTest
 248     @EnumSource(VCS.class)
 249     void testCommitListingWithSingleCommit(VCS vcs) throws IOException {
 250         try (var dir = new TemporaryDirectory()) {
 251             var r = Repository.init(dir.path(), vcs);
 252 
 253             var readme = dir.path().resolve(&quot;README&quot;);
 254             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 255 
 256             r.add(readme);
 257 
 258             var committerName = vcs == VCS.GIT ? &quot;bot&quot; : &quot;duke&quot;;
 259             var committerEmail = vcs == VCS.GIT ? &quot;bot@openjdk.java.net&quot; : &quot;duke@openjdk.java.net&quot;;
 260             var hash = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;, committerName, committerEmail);
 261 
 262             var commits = r.commits().asList();
 263             assertEquals(1, commits.size());
 264 
 265             var commit = commits.get(0);
 266             assertEquals(&quot;duke&quot;, commit.author().name());
 267             assertEquals(&quot;duke@openjdk.java.net&quot;, commit.author().email());
 268             assertEquals(committerName, commit.committer().name());
 269             assertEquals(committerEmail, commit.committer().email());
 270 
 271             assertEquals(List.of(&quot;Add README&quot;), commit.message());
 272 
 273             assertEquals(1, commit.numParents());
 274             assertEquals(1, commit.parents().size());
 275 
 276             var nullHash = &quot;0&quot;.repeat(40);
 277             var parent = commit.parents().get(0);
 278             assertEquals(nullHash, parent.hex());
 279 
 280             assertTrue(commit.isInitialCommit());
 281             assertFalse(commit.isMerge());
 282             assertEquals(hash, commit.hash());
 283 
 284             var diffs = commit.parentDiffs();
 285             assertEquals(1, diffs.size());
 286 
 287             var diff = diffs.get(0);
 288             assertEquals(nullHash, diff.from().hex());
 289             assertEquals(hash, diff.to());
 290 
 291             assertEquals(0, diff.removed());
 292             assertEquals(0, diff.modified());
 293             assertEquals(1, diff.added());
 294 
 295             var patches = diff.patches();
 296             assertEquals(1, patches.size());
 297 
 298             var patch = patches.get(0).asTextualPatch();
 299             assertTrue(patch.status().isAdded());
 300 
 301             assertTrue(patch.source().path().isEmpty());
 302             assertTrue(patch.source().type().isEmpty());
 303 
 304             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 305             assertTrue(patch.target().type().get().isRegularNonExecutable());
 306 
 307             var hunks = patch.hunks();
 308             assertEquals(1, hunks.size());
 309 
 310             var hunk = hunks.get(0);
 311             assertEquals(new Range(0, 0), hunk.source().range());
 312             assertEquals(new Range(1, 1), hunk.target().range());
 313 
 314             assertEquals(List.of(), hunk.source().lines());
 315             assertEquals(List.of(&quot;Hello, readme!&quot;), hunk.target().lines());
 316         }
 317     }
 318 
 319     @ParameterizedTest
 320     @EnumSource(VCS.class)
 321     void testCommitListingWithMultipleCommits(VCS vcs) throws IOException {
 322         try (var dir = new TemporaryDirectory()) {
 323             var r = Repository.init(dir.path(), vcs);
 324 
 325             var readme = dir.path().resolve(&quot;README&quot;);
 326             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 327 
 328             r.add(readme);
 329             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 330 
 331             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 332             r.add(readme);
 333             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 334 
 335             var commits = r.commits().asList();
 336             assertEquals(2, commits.size());
 337 
 338             var commit = commits.get(0);
 339             assertEquals(&quot;duke&quot;, commit.author().name());
 340             assertEquals(&quot;duke@openjdk.java.net&quot;, commit.author().email());
 341 
 342             assertEquals(List.of(&quot;Modify README&quot;), commit.message());
 343 
 344             assertEquals(1, commit.numParents());
 345             assertEquals(1, commit.parents().size());
 346 
 347             var parent = commit.parents().get(0);
 348             assertEquals(hash1, parent);
 349 
 350             assertFalse(commit.isInitialCommit());
 351             assertFalse(commit.isMerge());
 352             assertEquals(hash2, commit.hash());
 353 
 354             var diffs = commit.parentDiffs();
 355             assertEquals(1, diffs.size());
 356 
 357             var diff = diffs.get(0);
 358             assertEquals(hash1, diff.from());
 359             assertEquals(hash2, diff.to());
 360 
 361             assertEquals(0, diff.removed());
 362             assertEquals(0, diff.modified());
 363             assertEquals(1, diff.added());
 364 
 365             var patches = diff.patches();
 366             assertEquals(1, patches.size());
 367 
 368             var patch = patches.get(0).asTextualPatch();
 369             assertTrue(patch.status().isModified());
 370             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 371             assertTrue(patch.source().type().get().isRegularNonExecutable());
 372             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 373             assertTrue(patch.target().type().get().isRegularNonExecutable());
 374 
 375             var hunks = patch.hunks();
 376             assertEquals(1, hunks.size());
 377 
 378             var hunk = hunks.get(0);
 379             assertEquals(new Range(2, 0), hunk.source().range());
 380             assertEquals(new Range(2, 1), hunk.target().range());
 381 
 382             assertEquals(List.of(), hunk.source().lines());
 383             assertEquals(List.of(&quot;Another line&quot;), hunk.target().lines());
 384         }
 385     }
 386 
 387     @ParameterizedTest
 388     @EnumSource(VCS.class)
 389     void testSquashDeletes(VCS vcs) throws IOException {
 390         try (var dir = new TemporaryDirectory()) {
 391             var r = Repository.init(dir.path(), vcs);
 392 
 393             var file1 = dir.path().resolve(&quot;file1.txt&quot;);
 394             Files.write(file1, List.of(&quot;Hello, file 1!&quot;));
 395             var file2 = dir.path().resolve(&quot;file2.txt&quot;);
 396             Files.write(file2, List.of(&quot;Hello, file 2!&quot;));
 397             var file3 = dir.path().resolve(&quot;file3.txt&quot;);
 398             Files.write(file3, List.of(&quot;Hello, file 3!&quot;));
 399 
 400             r.add(file1, file2, file3);
 401             var hash1 = r.commit(&quot;Add files&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 402 
 403             Files.delete(file2);
 404             r.remove(file2);
 405             var hash2 = r.commit(&quot;Remove file 2&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 406 
 407             Files.delete(file3);
 408             r.remove(file3);
 409             var hash3 = r.commit(&quot;Remove file 3&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 410 
 411             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 412             assertEquals(3, r.commits(refspec).asList().size());
 413 
 414             r.checkout(hash1, false);
 415             r.squash(hash3);
 416             r.commit(&quot;Squashed remove of file 2 and 3&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 417 
 418             refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 419             var commits = r.commits(refspec).asList();
 420             assertEquals(2, commits.size());
 421 
 422             assertEquals(hash1, commits.get(1).hash());
 423 
 424             var head = commits.get(0);
 425             assertNotEquals(hash2, head);
 426             assertNotEquals(hash3, head);
 427 
 428             assertEquals(hash1, head.parents().get(0));
 429             assertFalse(head.isInitialCommit());
 430             assertFalse(head.isMerge());
 431 
 432             var diffs = head.parentDiffs();
 433             assertEquals(1, diffs.size());
 434 
 435             var diff = diffs.get(0);
 436             assertEquals(hash1, diff.from());
 437             assertEquals(head.hash(), diff.to());
 438 
 439             assertEquals(2, diff.removed());
 440             assertEquals(0, diff.modified());
 441             assertEquals(0, diff.added());
 442         }
 443     }
 444 
 445     @ParameterizedTest
 446     @EnumSource(VCS.class)
 447     void testSquash(VCS vcs) throws IOException {
 448         try (var dir = new TemporaryDirectory()) {
 449             var r = Repository.init(dir.path(), vcs);
 450 
 451             var readme = dir.path().resolve(&quot;README&quot;);
 452             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 453 
 454             r.add(readme);
 455             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 456 
 457             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 458             r.add(readme);
 459             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 460 
 461             Files.write(readme, List.of(&quot;A final line&quot;), WRITE, APPEND);
 462             r.add(readme);
 463             var hash3 = r.commit(&quot;Modify README again&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 464 
 465             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 466             assertEquals(3, r.commits(refspec).asList().size());
 467 
 468             r.checkout(hash1, false);
 469             r.squash(hash3);
 470             r.commit(&quot;Squashed commits 2 and 3&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 471 
 472             refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 473             var commits = r.commits(refspec).asList();
 474             assertEquals(2, commits.size());
 475 
 476             assertEquals(hash1, commits.get(1).hash());
 477 
 478             var head = commits.get(0);
 479             assertNotEquals(hash2, head);
 480             assertNotEquals(hash3, head);
 481 
 482             assertEquals(hash1, head.parents().get(0));
 483             assertFalse(head.isInitialCommit());
 484             assertFalse(head.isMerge());
 485 
 486             var diffs = head.parentDiffs();
 487             assertEquals(1, diffs.size());
 488 
 489             var diff = diffs.get(0);
 490             assertEquals(hash1, diff.from());
 491             assertEquals(head.hash(), diff.to());
 492 
 493             assertEquals(0, diff.removed());
 494             assertEquals(0, diff.modified());
 495             assertEquals(2, diff.added());
 496 
 497             var patches = diff.patches();
 498             assertEquals(1, patches.size());
 499 
 500             var patch = patches.get(0).asTextualPatch();
 501             assertTrue(patch.status().isModified());
 502             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 503             assertTrue(patch.source().type().get().isRegularNonExecutable());
 504             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 505             assertTrue(patch.target().type().get().isRegularNonExecutable());
 506 
 507             var hunks = patch.hunks();
 508             assertEquals(1, hunks.size());
 509 
 510             var hunk = hunks.get(0);
 511             assertEquals(new Range(2, 0), hunk.source().range());
 512             assertEquals(new Range(2, 2), hunk.target().range());
 513 
 514             assertEquals(List.of(), hunk.source().lines());
 515             assertEquals(List.of(&quot;Another line&quot;, &quot;A final line&quot;), hunk.target().lines());
 516         }
 517     }
 518 
 519     @ParameterizedTest
 520     @EnumSource(VCS.class)
 521     void testMergeBase(VCS vcs) throws IOException {
 522         try (var dir = new TemporaryDirectory()) {
 523             var r = Repository.init(dir.path(), vcs);
 524 
 525             var readme = dir.path().resolve(&quot;README&quot;);
 526             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 527 
 528             r.add(readme);
 529             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 530 
 531             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 532             r.add(readme);
 533             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 534 
 535             r.checkout(hash1, false);
 536             Files.write(readme, List.of(&quot;A conflicting line&quot;), WRITE, APPEND);
 537             r.add(readme);
 538             var hash3 = r.commit(&quot;Branching README modification&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 539 
 540             assertEquals(hash1, r.mergeBase(hash2, hash3));
 541         }
 542     }
 543 
 544     @ParameterizedTest
 545     @EnumSource(VCS.class)
 546     void testRebase(VCS vcs) throws IOException {
 547         try (var dir = new TemporaryDirectory()) {
 548             var r = Repository.init(dir.path(), vcs);
 549 
 550             var readme = dir.path().resolve(&quot;README&quot;);
 551             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 552 
 553             r.add(readme);
 554             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 555 
 556             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 557             r.add(readme);
 558             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 559 
 560             r.checkout(hash1, false);
 561 
 562             var contributing = dir.path().resolve(&quot;CONTRIBUTING&quot;);
 563             Files.write(contributing, List.of(&quot;Keep the patches coming&quot;));
 564             r.add(contributing);
 565             var hash3 = r.commit(&quot;Add independent change&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 566 
 567             var committerName = vcs == VCS.GIT ? &quot;bot&quot; : &quot;duke&quot;;
 568             var committerEmail = vcs == VCS.GIT ? &quot;bot@openjdk.java.net&quot; : &quot;duke@openjdk.java.net&quot;;
 569             r.rebase(hash2, committerName, committerEmail);
 570 
 571             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 572             var commits = r.commits(refspec).asList();
 573             assertEquals(3, commits.size());
 574             assertEquals(hash2, commits.get(1).hash());
 575             assertEquals(hash1, commits.get(2).hash());
 576 
 577             assertEquals(&quot;duke&quot;, commits.get(0).author().name());
 578             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(0).author().email());
 579             assertEquals(committerName, commits.get(0).committer().name());
 580             assertEquals(committerEmail, commits.get(0).committer().email());
 581 
 582             assertEquals(&quot;duke&quot;, commits.get(1).author().name());
 583             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(1).author().email());
 584             assertEquals(&quot;duke&quot;, commits.get(1).committer().name());
 585             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(1).committer().email());
 586 
 587             assertEquals(&quot;duke&quot;, commits.get(2).author().name());
 588             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(2).author().email());
 589             assertEquals(&quot;duke&quot;, commits.get(2).committer().name());
 590             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(2).committer().email());
 591 
 592             var head = commits.get(0);
 593             assertEquals(hash2, head.parents().get(0));
 594             assertEquals(List.of(&quot;Add independent change&quot;), head.message());
 595 
 596             var diffs = head.parentDiffs();
 597             assertEquals(1, diffs.size());
 598             var diff = diffs.get(0);
 599 
 600             assertEquals(0, diff.removed());
 601             assertEquals(0, diff.modified());
 602             assertEquals(1, diff.added());
 603 
 604             var patches = diff.patches();
 605             assertEquals(1, patches.size());
 606             var patch = patches.get(0).asTextualPatch();
 607             assertEquals(Path.of(&quot;CONTRIBUTING&quot;), patch.target().path().get());
 608 
 609             var hunks = patch.hunks();
 610             assertEquals(1, hunks.size());
 611             var hunk = hunks.get(0);
 612             assertEquals(List.of(&quot;Keep the patches coming&quot;), hunk.target().lines());
 613         }
 614     }
 615 
 616     @ParameterizedTest
 617     @EnumSource(VCS.class)
 618     void testInitializedRepositoryIsEmpty(VCS vcs) throws IOException {
 619         try (var dir = new TemporaryDirectory()) {
 620             var r = Repository.init(dir.path(), vcs);
 621             assertTrue(r.isEmpty());
 622         }
 623     }
 624 
 625     @ParameterizedTest
 626     @EnumSource(VCS.class)
 627     void testRepositoryWithCommitIsNonEmpty(VCS vcs) throws IOException {
 628         try (var dir = new TemporaryDirectory()) {
 629             var r = Repository.init(dir.path(), vcs);
 630 
 631             var readme = dir.path().resolve(&quot;README&quot;);
 632             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 633 
 634             r.add(readme);
 635             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 636 
 637             assertFalse(r.isEmpty());
 638         }
 639     }
 640 
 641     @ParameterizedTest
 642     @EnumSource(VCS.class)
 643     void testEmptyRepositoryIsHealthy(VCS vcs) throws IOException {
 644         try (var dir = new TemporaryDirectory()) {
 645             var r = Repository.init(dir.path(), vcs);
 646             assertTrue(r.isHealthy());
 647         }
 648     }
 649 
 650     @ParameterizedTest
 651     @EnumSource(VCS.class)
 652     void testNonEmptyRepositoryIsHealthy(VCS vcs) throws IOException {
 653         try (var dir = new TemporaryDirectory()) {
 654             var r = Repository.init(dir.path(), vcs);
 655 
 656             var readme = dir.path().resolve(&quot;README&quot;);
 657             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 658 
 659             r.add(readme);
 660             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 661 
 662             assertTrue(r.isHealthy());
 663         }
 664     }
 665 
 666     @ParameterizedTest
 667     @EnumSource(VCS.class)
 668     void testNonCheckedOutRepositoryIsHealthy(VCS vcs) throws IOException {
 669         try (var dir1 = new TemporaryDirectory();
 670              var dir2 = new TemporaryDirectory()) {
 671             var r1 = Repository.init(dir1.path(), vcs);
 672 
 673             var readme = dir1.path().resolve(&quot;README&quot;);
 674             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 675 
 676             r1.add(readme);
 677             var hash = r1.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 678             r1.tag(hash, &quot;tag&quot;, &quot;tagging&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 679 
 680             var r2 = Repository.init(dir2.path(), vcs);
 681             r2.fetch(r1.root().toUri(), r1.defaultBranch().name());
 682 
 683             assertTrue(r2.isHealthy());
 684         }
 685     }
 686 
 687     @ParameterizedTest
 688     @EnumSource(VCS.class)
 689     void testBranchesOnEmptyRepository(VCS vcs) throws IOException {
 690         try (var dir = new TemporaryDirectory()) {
 691             var r = Repository.init(dir.path(), vcs);
 692             var expected = vcs == VCS.GIT ? List.of() : List.of(new Branch(&quot;default&quot;));
 693             assertEquals(List.of(), r.branches());
 694         }
 695     }
 696 
 697     @ParameterizedTest
 698     @EnumSource(VCS.class)
 699     void testBranchesOnNonEmptyRepository(VCS vcs) throws IOException {
 700         try (var dir = new TemporaryDirectory()) {
 701             var r = Repository.init(dir.path(), vcs);
 702 
 703             var readme = dir.path().resolve(&quot;README&quot;);
 704             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 705 
 706             r.add(readme);
 707             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 708 
 709             assertEquals(List.of(r.defaultBranch()), r.branches());
 710         }
 711     }
 712 
 713     @ParameterizedTest
 714     @EnumSource(VCS.class)
 715     void testTagsOnEmptyRepository(VCS vcs) throws IOException {
 716         try (var dir = new TemporaryDirectory()) {
 717             var r = Repository.init(dir.path(), vcs);
 718             var expected = vcs == VCS.GIT ? List.of() : List.of(new Tag(&quot;tip&quot;));
 719             assertEquals(expected, r.tags());
 720         }
 721     }
 722 
 723     @ParameterizedTest
 724     @EnumSource(VCS.class)
 725     void testTagsOnNonEmptyRepository(VCS vcs) throws IOException {
 726         try (var dir = new TemporaryDirectory()) {
 727             var r = Repository.init(dir.path(), vcs);
 728 
 729             var readme = dir.path().resolve(&quot;README&quot;);
 730             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 731 
 732             r.add(readme);
 733             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 734 
 735             var expected = vcs == VCS.GIT ? List.of() : List.of(new Tag(&quot;tip&quot;));
 736             assertEquals(expected, r.tags());
 737         }
 738     }
 739 
 740     @ParameterizedTest
 741     @EnumSource(VCS.class)
 742     void testFetchAndPush(VCS vcs) throws IOException {
 743         try (var dir = new TemporaryDirectory()) {
 744             var upstream = Repository.init(dir.path(), vcs);
 745 
 746             if (vcs == VCS.GIT) {
 747                 Files.write(upstream.root().resolve(&quot;.git&quot;).resolve(&quot;config&quot;),
 748                             List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch=ignore&quot;),
 749                             WRITE, APPEND);
 750             }
 751 
 752             var readme = dir.path().resolve(&quot;README&quot;);
 753             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 754 
 755             upstream.add(readme);
 756             upstream.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 757 
 758             try (var dir2 = new TemporaryDirectory()) {
 759                 var downstream = Repository.init(dir2.path(), vcs);
 760 
 761                  // note: forcing unix path separators for URI
 762                 var upstreamURI = URI.create(&quot;file:///&quot; + dir.toString().replace(&#39;\\&#39;, &#39;/&#39;));
 763 
 764                 var fetchHead = downstream.fetch(upstreamURI, downstream.defaultBranch().name());
 765                 downstream.checkout(fetchHead, false);
 766 
 767                 var downstreamReadme = dir2.path().resolve(&quot;README&quot;);
 768                 Files.write(downstreamReadme, List.of(&quot;Downstream change&quot;), WRITE, APPEND);
 769 
 770                 downstream.add(downstreamReadme);
 771                 var head = downstream.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 772 
 773                 downstream.push(head, upstreamURI, downstream.defaultBranch().name());
 774             }
 775 
 776             upstream.checkout(upstream.resolve(upstream.defaultBranch().name()).get(), false);
 777 
 778             var commits = upstream.commits().asList();
 779             assertEquals(2, commits.size());
 780         }
 781     }
 782 
 783     @ParameterizedTest
 784     @EnumSource(VCS.class)
 785     void testClean(VCS vcs) throws IOException {
 786         try (var dir = new TemporaryDirectory()) {
 787             var r = Repository.init(dir.path(), vcs);
 788             r.clean();
 789 
 790             var readme = dir.path().resolve(&quot;README&quot;);
 791             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 792 
 793             r.add(readme);
 794             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 795 
 796             r.clean();
 797 
 798             assertEquals(hash1, r.head());
 799 
 800             Files.write(readme, List.of(&quot;A random change&quot;), WRITE, APPEND);
 801 
 802             r.clean();
 803 
 804             assertEquals(List.of(&quot;Hello, readme!&quot;), Files.readAllLines(readme));
 805 
 806             var untracked = dir.path().resolve(&quot;UNTRACKED&quot;);
 807             Files.write(untracked, List.of(&quot;Random text&quot;));
 808 
 809             r.clean();
 810 
 811             assertFalse(Files.exists(untracked));
 812 
 813             // Mercurial cannot currently deal with this situation
 814             if (vcs != VCS.HG) {
 815                 var subRepo = Repository.init(dir.path().resolve(&quot;submodule&quot;), vcs);
 816                 var subRepoFile = subRepo.root().resolve(&quot;file.txt&quot;);
 817                 Files.write(subRepoFile, List.of(&quot;Looks like a file in a submodule&quot;));
 818 
 819                 r.clean();
 820 
 821                 assertFalse(Files.exists(subRepoFile));
 822             }
 823         }
 824     }
 825 
 826     @ParameterizedTest
 827     @EnumSource(VCS.class)
 828     void testCleanIgnored(VCS vcs) throws IOException {
 829         try (var dir = new TemporaryDirectory()) {
 830             var r = Repository.init(dir.path(), vcs);
 831             r.clean();
 832 
 833             var readme = dir.path().resolve(&quot;README&quot;);
 834             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 835             Files.write(dir.path().resolve(&quot;.gitignore&quot;), List.of(&quot;*.txt&quot;));
 836             Files.write(dir.path().resolve(&quot;.hgignore&quot;), List.of(&quot;.*txt&quot;));
 837 
 838             r.add(readme);
 839             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 840 
 841             var ignored = dir.path().resolve(&quot;ignored.txt&quot;);
 842             Files.write(ignored, List.of(&quot;Random text&quot;));
 843 
 844             r.clean();
 845 
 846             assertFalse(Files.exists(ignored));
 847         }
 848     }
 849 
 850     @ParameterizedTest
 851     @EnumSource(VCS.class)
 852     void testDiffBetweenCommits(VCS vcs) throws IOException {
 853         try (var dir = new TemporaryDirectory()) {
 854             var r = Repository.init(dir.path(), vcs);
 855 
 856             var readme = dir.path().resolve(&quot;README&quot;);
 857             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 858 
 859             r.add(readme);
 860             var first = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 861 
 862             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
 863             r.add(readme);
 864             var second = r.commit(&quot;Add one more line&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 865 
 866             var diff = r.diff(first, second);
 867             assertEquals(first, diff.from());
 868             assertEquals(second, diff.to());
 869 
 870             var patches = diff.patches();
 871             assertEquals(1, patches.size());
 872 
 873             var patch = patches.get(0).asTextualPatch();
 874             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 875             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 876             assertTrue(patch.source().type().get().isRegularNonExecutable());
 877             assertTrue(patch.target().type().get().isRegularNonExecutable());
 878             assertTrue(patch.status().isModified());
 879 
 880             var hunks = patch.hunks();
 881             assertEquals(1, hunks.size());
 882 
 883             var hunk = hunks.get(0);
 884             assertEquals(2, hunk.source().range().start());
 885             assertEquals(0, hunk.source().range().count());
 886             assertEquals(0, hunk.source().lines().size());
 887 
 888             assertEquals(2, hunk.target().range().start());
 889             assertEquals(1, hunk.target().range().count());
 890             assertEquals(List.of(&quot;One more line&quot;), hunk.target().lines());
 891 
 892             assertEquals(1, hunk.added());
 893             assertEquals(0, hunk.removed());
 894             assertEquals(0, hunk.modified());
 895         }
 896     }
 897 
 898     @ParameterizedTest
 899     @EnumSource(VCS.class)
 900     void testDiffBetweenCommitsWithMultiplePatches(VCS vcs) throws IOException {
 901         try (var dir = new TemporaryDirectory()) {
 902             var r = Repository.init(dir.path(), vcs);
 903 
 904             var readme = dir.path().resolve(&quot;README&quot;);
 905             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 906 
 907             var building = dir.path().resolve(&quot;BUILDING&quot;);
 908             Files.write(building, List.of(&quot;make&quot;));
 909 
 910             r.add(readme);
 911             r.add(building);
 912             var first = r.commit(&quot;Add README and BUILDING&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 913 
 914             Files.write(readme, List.of(&quot;Hello, Skara!&quot;), WRITE, TRUNCATE_EXISTING);
 915             Files.write(building, List.of(&quot;make images&quot;), WRITE, TRUNCATE_EXISTING);
 916             r.add(readme);
 917             r.add(building);
 918             var second = r.commit(&quot;Modify README and BUILDING&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 919 
 920             var diff = r.diff(first, second);
 921             assertEquals(first, diff.from());
 922             assertEquals(second, diff.to());
 923 
 924             var patches = diff.patches();
 925             assertEquals(2, patches.size());
 926 
 927             var patch1 = patches.get(0).asTextualPatch();
 928             assertEquals(Path.of(&quot;BUILDING&quot;), patch1.source().path().get());
 929             assertEquals(Path.of(&quot;BUILDING&quot;), patch1.target().path().get());
 930             assertTrue(patch1.source().type().get().isRegularNonExecutable());
 931             assertTrue(patch1.target().type().get().isRegularNonExecutable());
 932             assertTrue(patch1.status().isModified());
 933 
 934             var hunks1 = patch1.hunks();
 935             assertEquals(1, hunks1.size());
 936 
 937             var hunk1 = hunks1.get(0);
 938             assertEquals(1, hunk1.source().range().start());
 939             assertEquals(1, hunk1.source().range().count());
 940             assertEquals(List.of(&quot;make&quot;), hunk1.source().lines());
 941 
 942             assertEquals(1, hunk1.target().range().start());
 943             assertEquals(1, hunk1.target().range().count());
 944             assertEquals(List.of(&quot;make images&quot;), hunk1.target().lines());
 945 
 946             var patch2 = patches.get(1).asTextualPatch();
 947             assertEquals(Path.of(&quot;README&quot;), patch2.source().path().get());
 948             assertEquals(Path.of(&quot;README&quot;), patch2.target().path().get());
 949             assertTrue(patch2.source().type().get().isRegularNonExecutable());
 950             assertTrue(patch2.target().type().get().isRegularNonExecutable());
 951             assertTrue(patch2.status().isModified());
 952 
 953             var hunks2 = patch2.hunks();
 954             assertEquals(1, hunks2.size());
 955 
 956             var hunk2 = hunks2.get(0);
 957             assertEquals(1, hunk2.source().range().start());
 958             assertEquals(1, hunk2.source().range().count());
 959             assertEquals(List.of(&quot;Hello, readme!&quot;), hunk2.source().lines());
 960 
 961             assertEquals(1, hunk2.target().range().start());
 962             assertEquals(1, hunk2.target().range().count());
 963             assertEquals(List.of(&quot;Hello, Skara!&quot;), hunk2.target().lines());
 964         }
 965     }
 966 
 967     @ParameterizedTest
 968     @EnumSource(VCS.class)
 969     void testDiffBetweenCommitsWithMultipleHunks(VCS vcs) throws IOException {
 970         try (var dir = new TemporaryDirectory()) {
 971             var r = Repository.init(dir.path(), vcs);
 972 
 973             var abc = dir.path().resolve(&quot;abc.txt&quot;);
 974             Files.write(abc, List.of(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;));
 975 
 976             r.add(abc);
 977             var first = r.commit(&quot;Added ABC&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 978 
 979             Files.write(abc, List.of(&quot;1&quot;, &quot;2&quot;, &quot;B&quot;, &quot;3&quot;), WRITE, TRUNCATE_EXISTING);
 980             r.add(abc);
 981             var second = r.commit(&quot;Modify A and C&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 982 
 983             var diff = r.diff(first, second);
 984             assertEquals(first, diff.from());
 985             assertEquals(second, diff.to());
 986 
 987             var patches = diff.patches();
 988             assertEquals(1, patches.size());
 989 
 990             var patch = patches.get(0).asTextualPatch();
 991             assertEquals(Path.of(&quot;abc.txt&quot;), patch.source().path().get());
 992             assertEquals(Path.of(&quot;abc.txt&quot;), patch.target().path().get());
 993             assertTrue(patch.source().type().get().isRegularNonExecutable());
 994             assertTrue(patch.target().type().get().isRegularNonExecutable());
 995             assertTrue(patch.status().isModified());
 996 
 997             var hunks = patch.hunks();
 998             assertEquals(2, hunks.size());
 999 
1000             var hunk1 = hunks.get(0);
1001             assertEquals(1, hunk1.source().range().start());
1002             assertEquals(1, hunk1.source().range().count());
1003             assertEquals(List.of(&quot;A&quot;), hunk1.source().lines());
1004 
1005             assertEquals(1, hunk1.target().range().start());
1006             assertEquals(2, hunk1.target().range().count());
1007             assertEquals(List.of(&quot;1&quot;, &quot;2&quot;), hunk1.target().lines());
1008 
1009             assertEquals(1, hunk1.added());
1010             assertEquals(0, hunk1.removed());
1011             assertEquals(1, hunk1.modified());
1012 
1013             var hunk2 = hunks.get(1);
1014             assertEquals(3, hunk2.source().range().start());
1015             assertEquals(1, hunk2.source().range().count());
1016             assertEquals(List.of(&quot;C&quot;), hunk2.source().lines());
1017 
1018             assertEquals(4, hunk2.target().range().start());
1019             assertEquals(1, hunk2.target().range().count());
1020             assertEquals(List.of(&quot;3&quot;), hunk2.target().lines());
1021 
1022             assertEquals(0, hunk2.added());
1023             assertEquals(0, hunk2.removed());
1024             assertEquals(1, hunk2.modified());
1025         }
1026     }
1027 
1028     @ParameterizedTest
1029     @EnumSource(VCS.class)
1030     void testDiffWithRemoval(VCS vcs) throws IOException {
1031         try (var dir = new TemporaryDirectory()) {
1032             var r = Repository.init(dir.path(), vcs);
1033 
1034             var readme = dir.path().resolve(&quot;README&quot;);
1035             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1036 
1037             r.add(readme);
1038             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1039 
1040             Files.delete(readme);
1041             r.remove(readme);
1042             var second = r.commit(&quot;Removed README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1043 
1044             var diff = r.diff(first, second);
1045             assertEquals(first, diff.from());
1046             assertEquals(second, diff.to());
1047 
1048             var patches = diff.patches();
1049             assertEquals(1, patches.size());
1050 
1051             var patch = patches.get(0).asTextualPatch();
1052             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
1053             assertTrue(patch.target().path().isEmpty());
1054             assertTrue(patch.source().type().get().isRegularNonExecutable());
1055             assertTrue(patch.target().type().isEmpty());
1056             assertTrue(patch.status().isDeleted());
1057 
1058             var hunks = patch.hunks();
1059             assertEquals(1, hunks.size());
1060 
1061             var hunk = hunks.get(0);
1062             assertEquals(1, hunk.source().range().start());
1063             assertEquals(1, hunk.source().range().count());
1064             assertEquals(List.of(&quot;Hello, world!&quot;), hunk.source().lines());
1065 
1066             assertEquals(0, hunk.target().range().start());
1067             assertEquals(0, hunk.target().range().count());
1068             assertEquals(List.of(), hunk.target().lines());
1069 
1070             assertEquals(0, hunk.added());
1071             assertEquals(1, hunk.removed());
1072             assertEquals(0, hunk.modified());
1073         }
1074     }
1075 
1076     @ParameterizedTest
1077     @EnumSource(VCS.class)
1078     void testDiffWithAddition(VCS vcs) throws IOException {
1079         try (var dir = new TemporaryDirectory()) {
1080             var r = Repository.init(dir.path(), vcs);
1081 
1082             var readme = dir.path().resolve(&quot;README&quot;);
1083             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1084 
1085             r.add(readme);
1086             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1087 
1088             var building = dir.path().resolve(&quot;BUILDING&quot;);
1089             Files.write(building, List.of(&quot;make&quot;));
1090             r.add(building);
1091             var second = r.commit(&quot;Added BUILDING&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1092 
1093             var diff = r.diff(first, second);
1094             assertEquals(first, diff.from());
1095             assertEquals(second, diff.to());
1096 
1097             var patches = diff.patches();
1098             assertEquals(1, patches.size());
1099 
1100             var patch = patches.get(0).asTextualPatch();
1101             assertTrue(patch.source().path().isEmpty());
1102             assertEquals(Path.of(&quot;BUILDING&quot;), patch.target().path().get());
1103             assertTrue(patch.source().type().isEmpty());
1104             assertTrue(patch.target().type().get().isRegularNonExecutable());
1105             assertTrue(patch.status().isAdded());
1106 
1107             var hunks = patch.hunks();
1108             assertEquals(1, hunks.size());
1109 
1110             var hunk = hunks.get(0);
1111             assertEquals(0, hunk.source().range().start());
1112             assertEquals(0, hunk.source().range().count());
1113             assertEquals(List.of(), hunk.source().lines());
1114 
1115             assertEquals(1, hunk.target().range().start());
1116             assertEquals(1, hunk.target().range().count());
1117             assertEquals(List.of(&quot;make&quot;), hunk.target().lines());
1118 
1119             assertEquals(1, hunk.added());
1120             assertEquals(0, hunk.removed());
1121             assertEquals(0, hunk.modified());
1122         }
1123     }
1124 
1125     @ParameterizedTest
1126     @EnumSource(VCS.class)
1127     void testDiffWithWorkingDir(VCS vcs) throws IOException {
1128         try (var dir = new TemporaryDirectory()) {
1129             var r = Repository.init(dir.path(), vcs);
1130 
1131             var readme = dir.path().resolve(&quot;README&quot;);
1132             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1133 
1134             r.add(readme);
1135             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1136 
1137             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1138             var diff = r.diff(first);
1139 
1140             assertEquals(first, diff.from());
1141             assertNull(diff.to());
1142 
1143             var patches = diff.patches();
1144             assertEquals(1, patches.size());
1145 
1146             var patch = patches.get(0).asTextualPatch();
1147             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
1148             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
1149             assertTrue(patch.source().type().get().isRegularNonExecutable());
1150             assertTrue(patch.target().type().get().isRegularNonExecutable());
1151             assertTrue(patch.status().isModified());
1152 
1153             var hunks = patch.hunks();
1154             assertEquals(1, hunks.size());
1155 
1156             var hunk = hunks.get(0);
1157             assertEquals(2, hunk.source().range().start());
1158             assertEquals(0, hunk.source().range().count());
1159             assertEquals(List.of(), hunk.source().lines());
1160 
1161             assertEquals(2, hunk.target().range().start());
1162             assertEquals(1, hunk.target().range().count());
1163             assertEquals(List.of(&quot;One more line&quot;), hunk.target().lines());
1164 
1165             assertEquals(1, hunk.added());
1166             assertEquals(0, hunk.removed());
1167             assertEquals(0, hunk.modified());
1168         }
1169     }
1170 
1171     @ParameterizedTest
1172     @EnumSource(VCS.class)
1173     void testCommitMetadata(VCS vcs) throws IOException {
1174         try (var dir = new TemporaryDirectory()) {
1175             var r = Repository.init(dir.path(), vcs);
1176 
1177             var readme = dir.path().resolve(&quot;README&quot;);
1178             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1179             r.add(readme);
1180             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1181 
1182             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1183             r.add(readme);
1184             var second = r.commit(&quot;Modified README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1185 
1186             var metadata = r.commitMetadata();
1187             assertEquals(2, metadata.size());
1188 
1189             assertEquals(first, metadata.get(0).hash());
1190             assertEquals(List.of(&quot;Added README&quot;), metadata.get(0).message());
1191 
1192             assertEquals(second, metadata.get(1).hash());
1193             assertEquals(List.of(&quot;Modified README&quot;), metadata.get(1).message());
1194         }
1195     }
1196 
1197     @ParameterizedTest
1198     @EnumSource(VCS.class)
1199     void testTrivialMerge(VCS vcs) throws IOException {
1200         try (var dir = new TemporaryDirectory()) {
1201             var r = Repository.init(dir.path(), vcs);
1202 
1203             var readme = dir.path().resolve(&quot;README&quot;);
1204             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1205             r.add(readme);
1206             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1207 
1208             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1209             r.add(readme);
1210             var second = r.commit(&quot;Modified README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1211 
1212             r.checkout(first, false);
1213 
1214             var contributing = dir.path().resolve(&quot;CONTRIBUTING&quot;);
1215             Files.write(contributing, List.of(&quot;Send those patches!&quot;));
1216             r.add(contributing);
1217             var third = r.commit(&quot;Added contributing&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1218 
1219             r.merge(second);
1220             r.commit(&quot;Merge&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1221 
1222             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
1223             var commits = r.commits(refspec).asList();
1224 
1225             assertEquals(4, commits.size());
1226 
1227             var merge = commits.get(0);
1228             assertEquals(List.of(&quot;Merge&quot;), merge.message());
1229 
1230             var parents = new HashSet&lt;&gt;(merge.parents());
1231             assertEquals(2, parents.size());
1232             assertTrue(parents.contains(second));
1233             assertTrue(parents.contains(third));
1234 
1235             var diffs = merge.parentDiffs();
1236             assertEquals(2, diffs.size());
1237 
1238             var diff1 = diffs.get(0);
1239             assertEquals(merge.hash(), diff1.to());
1240             assertEquals(0, diff1.patches().size());
1241             assertTrue(parents.contains(diff1.from()));
1242 
1243             var diff2 = diffs.get(1);
1244             assertEquals(merge.hash(), diff2.to());
1245             assertEquals(0, diff2.patches().size());
1246             assertTrue(parents.contains(diff2.from()));
1247         }
1248     }
1249 
1250     @ParameterizedTest
1251     @EnumSource(VCS.class)
1252     void testMergeWithEdit(VCS vcs) throws IOException {
1253         try (var dir = new TemporaryDirectory()) {
1254             var r = Repository.init(dir.path(), vcs);
1255 
1256             var readme = dir.path().resolve(&quot;README&quot;);
1257             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1258             r.add(readme);
1259             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1260 
1261             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1262             r.add(readme);
1263             var second = r.commit(&quot;Modified README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1264 
1265             r.checkout(first, false);
1266 
1267             var contributing = dir.path().resolve(&quot;CONTRIBUTING&quot;);
1268             Files.write(contributing, List.of(&quot;Send those patches!&quot;));
1269             r.add(contributing);
1270             var third = r.commit(&quot;Added contributing&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1271 
1272             r.merge(second);
1273 
1274             Files.write(readme, List.of(&quot;One last line&quot;), WRITE, APPEND);
1275             r.add(readme);
1276             r.commit(&quot;Merge&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1277 
1278             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
1279             var commits = r.commits(refspec).asList();
1280 
1281             assertEquals(4, commits.size());
1282 
1283             var merge = commits.get(0);
1284             assertEquals(List.of(&quot;Merge&quot;), merge.message());
1285 
1286             var parents = new HashSet&lt;&gt;(merge.parents());
1287             assertEquals(2, parents.size());
1288             assertTrue(parents.contains(second));
1289             assertTrue(parents.contains(third));
1290 
1291             var diffs = merge.parentDiffs();
1292             assertEquals(2, diffs.size());
1293 
1294             var secondDiff = diffs.stream().filter(d -&gt; d.from().equals(second)).findFirst().get();
1295             assertEquals(merge.hash(), secondDiff.to());
1296             assertEquals(1, secondDiff.patches().size());
1297             var secondPatch = secondDiff.patches().get(0).asTextualPatch();
1298 
1299             assertEquals(Path.of(&quot;README&quot;), secondPatch.source().path().get());
1300             assertEquals(Path.of(&quot;README&quot;), secondPatch.target().path().get());
1301             assertTrue(secondPatch.status().isModified());
1302             assertEquals(1, secondPatch.hunks().size());
1303 
1304             var secondHunk = secondPatch.hunks().get(0);
1305             assertEquals(List.of(), secondHunk.source().lines());
1306             assertEquals(List.of(&quot;One last line&quot;), secondHunk.target().lines());
1307 
1308             assertEquals(3, secondHunk.source().range().start());
1309             assertEquals(0, secondHunk.source().range().count());
1310             assertEquals(3, secondHunk.target().range().start());
1311             assertEquals(1, secondHunk.target().range().count());
1312 
1313             var thirdDiff = diffs.stream().filter(d -&gt; d.from().equals(third)).findFirst().get();
1314             assertEquals(merge.hash(), thirdDiff.to());
1315             assertEquals(1, thirdDiff.patches().size());
1316             var thirdPatch = thirdDiff.patches().get(0).asTextualPatch();
1317 
1318             assertEquals(Path.of(&quot;README&quot;), thirdPatch.source().path().get());
1319             assertEquals(Path.of(&quot;README&quot;), thirdPatch.target().path().get());
1320             assertTrue(thirdPatch.status().isModified());
1321             assertEquals(1, thirdPatch.hunks().size());
1322 
1323             var thirdHunk = thirdPatch.hunks().get(0);
1324             assertEquals(List.of(), thirdHunk.source().lines());
1325             assertEquals(List.of(&quot;One more line&quot;, &quot;One last line&quot;), thirdHunk.target().lines());
1326 
1327             assertEquals(2, thirdHunk.source().range().start());
1328             assertEquals(0, thirdHunk.source().range().count());
1329             assertEquals(2, thirdHunk.target().range().start());
1330             assertEquals(2, thirdHunk.target().range().count());
1331         }
1332     }
1333 
1334     @ParameterizedTest
1335     @EnumSource(VCS.class)
1336     void testDefaultBranch(VCS vcs) throws IOException {
1337         try (var dir = new TemporaryDirectory()) {
1338             var r = Repository.init(dir.path(), vcs);
1339             var expected = vcs == VCS.GIT ? &quot;master&quot; : &quot;default&quot;;
1340             assertEquals(expected, r.defaultBranch().name());
1341         }
1342     }
1343 
1344     @ParameterizedTest
1345     @EnumSource(VCS.class)
1346     void testPaths(VCS vcs) throws IOException {
1347         try (var dir = new TemporaryDirectory()) {
1348             var r = Repository.init(dir.path(), vcs);
1349             var remote = vcs == VCS.GIT ? &quot;origin&quot; : &quot;default&quot;;
1350             r.setPaths(remote, &quot;http://pull&quot;, &quot;http://push&quot;);
1351             assertEquals(&quot;http://pull&quot;, r.pullPath(remote));
1352             assertEquals(&quot;http://push&quot;, r.pushPath(remote));
1353         }
1354     }
1355 
1356     @ParameterizedTest
1357     @EnumSource(VCS.class)
1358     void testIsValidRevisionRange(VCS vcs) throws IOException {
1359         try (var dir = new TemporaryDirectory()) {
1360             var r = Repository.init(dir.path(), vcs);
1361             assertFalse(r.isValidRevisionRange(&quot;foo&quot;));
1362 
1363             var readme = dir.path().resolve(&quot;README&quot;);
1364             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1365             r.add(readme);
1366             r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1367 
1368             assertTrue(r.isValidRevisionRange(r.defaultBranch().toString()));
1369         }
1370     }
1371 
1372     @ParameterizedTest
1373     @EnumSource(VCS.class)
1374     void testDefaultTag(VCS vcs) throws IOException {
1375         try (var dir = new TemporaryDirectory()) {
1376             var r = Repository.init(dir.path(), vcs);
1377             var expected = vcs == VCS.GIT ? Optional.empty() : Optional.of(new Tag(&quot;tip&quot;));
1378             assertEquals(expected, r.defaultTag());
1379         }
1380     }
1381 
1382     @ParameterizedTest
1383     @EnumSource(VCS.class)
1384     void testTag(VCS vcs) throws IOException {
1385         try (var dir = new TemporaryDirectory()) {
1386             var r = Repository.init(dir.path(), vcs);
1387 
1388             var readme = dir.path().resolve(&quot;README&quot;);
1389             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1390             r.add(readme);
1391             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1392 
1393             r.tag(first, &quot;test&quot;, &quot;Tagging test&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1394             var defaultTag = r.defaultTag().orElse(null);
1395             var nonDefaultTags = r.tags().stream()
1396                                   .filter(tag -&gt; !tag.equals(defaultTag))
1397                                   .map(Tag::toString)
1398                                   .collect(Collectors.toList());
1399             assertEquals(List.of(&quot;test&quot;), nonDefaultTags);
1400         }
1401     }
1402 
1403     @ParameterizedTest
1404     @EnumSource(VCS.class)
1405     void testIsClean(VCS vcs) throws IOException {
1406         try (var dir = new TemporaryDirectory()) {
1407             var r = Repository.init(dir.path(), vcs);
1408             assertTrue(r.isClean());
1409 
1410             var readme = dir.path().resolve(&quot;README&quot;);
1411             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1412             assertFalse(r.isClean());
1413 
1414             r.add(readme);
1415             assertFalse(r.isClean());
1416 
1417             r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1418             assertTrue(r.isClean());
1419 
1420             Files.delete(readme);
1421             assertFalse(r.isClean());
1422 
1423             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1424             assertTrue(r.isClean());
1425         }
1426     }
1427 
1428     @ParameterizedTest
1429     @EnumSource(VCS.class)
1430     void testShowOnExecutableFiles(VCS vcs) throws IOException {
1431         try (var dir = new TemporaryDirectory()) {
1432             var r = Repository.init(dir.path(), vcs);
1433             assertTrue(r.isClean());
1434 
1435             var readOnlyExecutableFile = dir.path().resolve(&quot;hello.sh&quot;);
1436             Files.write(readOnlyExecutableFile, List.of(&quot;echo &#39;hello&#39;&quot;));
1437             if (readOnlyExecutableFile.getFileSystem().supportedFileAttributeViews().contains(&quot;posix&quot;)) {
1438                 var permissions = PosixFilePermissions.fromString(&quot;r-xr-xr-x&quot;);
1439                 Files.setPosixFilePermissions(readOnlyExecutableFile, permissions);
1440             }
1441             r.add(readOnlyExecutableFile);
1442             var hash = r.commit(&quot;Added read only executable file&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1443             assertEquals(Optional.of(List.of(&quot;echo &#39;hello&#39;&quot;)), r.lines(readOnlyExecutableFile, hash));
1444 
1445             var readWriteExecutableFile = dir.path().resolve(&quot;goodbye.sh&quot;);
1446             Files.write(readWriteExecutableFile, List.of(&quot;echo &#39;goodbye&#39;&quot;));
1447             if (readOnlyExecutableFile.getFileSystem().supportedFileAttributeViews().contains(&quot;posix&quot;)) {
1448                 var permissions = PosixFilePermissions.fromString(&quot;rwxrwxrwx&quot;);
1449                 Files.setPosixFilePermissions(readWriteExecutableFile, permissions);
1450             }
1451             r.add(readWriteExecutableFile);
1452             var hash2 = r.commit(&quot;Added read-write executable file&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1453             assertEquals(Optional.of(List.of(&quot;echo &#39;goodbye&#39;&quot;)), r.lines(readWriteExecutableFile, hash2));
1454         }
1455     }
1456 
1457     @Test
1458     void testGetAndExistsOnNonExistingDirectory() throws IOException {
1459         var nonExistingDirectory = Path.of(&quot;this&quot;, &quot;does&quot;, &quot;not&quot;, &quot;exist&quot;);
1460         assertEquals(Optional.empty(), Repository.get(nonExistingDirectory));
1461         assertEquals(false, Repository.exists(nonExistingDirectory));
1462     }
1463 
1464     @ParameterizedTest
1465     @EnumSource(VCS.class)
1466     void testDiffOnFilenamesWithSpace(VCS vcs) throws IOException {
1467         try (var dir = new TemporaryDirectory()) {
1468             var r = Repository.init(dir.path(), vcs);
1469             assertTrue(r.isClean());
1470 
1471             var fileWithSpaceInName = dir.path().resolve(&quot;hello world.txt&quot;);
1472             Files.writeString(fileWithSpaceInName, &quot;Hello world\n&quot;);
1473             r.add(fileWithSpaceInName);
1474             var hash1 = r.commit(&quot;Added file with space in name&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1475             Files.writeString(fileWithSpaceInName, &quot;Goodbye world\n&quot;);
1476             r.add(fileWithSpaceInName);
1477             var hash2 = r.commit(&quot;Modified file with space in name&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1478             var diff = r.diff(hash1, hash2);
1479             var patches = diff.patches();
1480             assertEquals(1, patches.size());
1481             var patch = patches.get(0);
1482             assertTrue(patch.target().path().isPresent());
1483             var path = patch.target().path().get();
1484             assertEquals(Path.of(&quot;hello world.txt&quot;), path);
1485         }
1486     }
1487 
1488     @Test
1489     void testSingleEmptyCommit() throws IOException, InterruptedException {
1490         try (var dir = new TemporaryDirectory()) {
1491             var r = Repository.init(dir.path(), VCS.GIT);
1492             assertTrue(r.isClean());
1493 
1494             // must ust git directly to be able to pass --allow-empty
1495             var pb = new ProcessBuilder(&quot;git&quot;, &quot;commit&quot;, &quot;--message&quot;, &quot;An empty commit&quot;, &quot;--allow-empty&quot;);
1496             pb.environment().put(&quot;GIT_AUTHOR_NAME&quot;, &quot;duke&quot;);
1497             pb.environment().put(&quot;GIT_AUTHOR_EMAIL&quot;, &quot;duke@openjdk.org&quot;);
1498             pb.environment().put(&quot;GIT_COMMITTER_NAME&quot;, &quot;duke&quot;);
1499             pb.environment().put(&quot;GIT_COMMITTER_EMAIL&quot;, &quot;duke@openjdk.org&quot;);
1500             pb.directory(dir.path().toFile());
1501 
1502             var res = pb.start().waitFor();
1503             assertEquals(0, res);
1504 
1505             var commits = r.commits().asList();
1506             assertEquals(1, commits.size());
1507             var commit = commits.get(0);
1508             assertEquals(&quot;duke&quot;, commit.author().name());
1509             assertEquals(&quot;duke@openjdk.org&quot;, commit.author().email());
1510             assertEquals(&quot;duke&quot;, commit.committer().name());
1511             assertEquals(&quot;duke@openjdk.org&quot;, commit.committer().email());
1512             assertEquals(List.of(&quot;An empty commit&quot;), commit.message());
1513         }
1514     }
1515 
1516     @Test
1517     void testEmptyCommitWithParent() throws IOException, InterruptedException {
1518         try (var dir = new TemporaryDirectory()) {
1519             var r = Repository.init(dir.path(), VCS.GIT);
1520             assertTrue(r.isClean());
1521 
1522             var f = Files.createFile(dir.path().resolve(&quot;hello.txt&quot;));
1523             Files.writeString(f, &quot;Hello world\n&quot;);
1524             r.add(f);
1525             r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1526 
1527             // must ust git directly to be able to pass --allow-empty
1528             var pb = new ProcessBuilder(&quot;git&quot;, &quot;commit&quot;, &quot;--message&quot;, &quot;An empty commit&quot;, &quot;--allow-empty&quot;);
1529             pb.environment().put(&quot;GIT_AUTHOR_NAME&quot;, &quot;duke&quot;);
1530             pb.environment().put(&quot;GIT_AUTHOR_EMAIL&quot;, &quot;duke@openjdk.org&quot;);
1531             pb.environment().put(&quot;GIT_COMMITTER_NAME&quot;, &quot;duke&quot;);
1532             pb.environment().put(&quot;GIT_COMMITTER_EMAIL&quot;, &quot;duke@openjdk.org&quot;);
1533             pb.directory(dir.path().toFile());
1534 
1535             var res = pb.start().waitFor();
1536             assertEquals(0, res);
1537 
1538             var commits = r.commits().asList();
1539             assertEquals(2, commits.size());
1540             var commit = commits.get(0);
1541             assertEquals(&quot;duke&quot;, commit.author().name());
1542             assertEquals(&quot;duke@openjdk.org&quot;, commit.author().email());
1543             assertEquals(&quot;duke&quot;, commit.committer().name());
1544             assertEquals(&quot;duke@openjdk.org&quot;, commit.committer().email());
1545             assertEquals(List.of(&quot;An empty commit&quot;), commit.message());
1546         }
1547     }
1548 
1549     @ParameterizedTest
1550     @EnumSource(VCS.class)
1551     void testAmend(VCS vcs) throws IOException {
1552         try (var dir = new TemporaryDirectory()) {
1553             var r = Repository.init(dir.path(), vcs);
1554             assertTrue(r.isClean());
1555 
1556             var f = dir.path().resolve(&quot;README&quot;);
1557             Files.writeString(f, &quot;Hello\n&quot;);
1558             r.add(f);
1559             r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1560 
1561             Files.writeString(f, &quot;Hello, world\n&quot;);
1562             r.add(f);
1563             r.amend(&quot;Initial commit corrected&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1564             var commits = r.commits().asList();
1565             assertEquals(1, commits.size());
1566             var commit = commits.get(0);
1567             assertEquals(List.of(&quot;Initial commit corrected&quot;), commit.message());
1568         }
1569     }
1570 
1571     @ParameterizedTest
1572     @EnumSource(VCS.class)
1573     void testRevert(VCS vcs) throws IOException {
1574         try (var dir = new TemporaryDirectory()) {
1575             var r = Repository.init(dir.path(), vcs);
1576             assertTrue(r.isClean());
1577 
1578             var f = dir.path().resolve(&quot;README&quot;);
1579             Files.writeString(f, &quot;Hello\n&quot;);
1580             r.add(f);
1581             var initial = r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1582 
1583             Files.writeString(f, &quot;Hello, world\n&quot;);
1584             r.revert(initial);
1585             Files.writeString(f, &quot;Goodbye, world\n&quot;);
1586             r.add(f);
1587             var hash = r.commit(&quot;Second commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1588             var commit = r.lookup(hash).orElseThrow();
1589             var patches = commit.parentDiffs().get(0).patches();
1590             assertEquals(1, patches.size());
1591             var patch = patches.get(0).asTextualPatch();
1592             assertEquals(1, patch.hunks().size());
1593             var hunk = patch.hunks().get(0);
1594             assertEquals(List.of(&quot;Goodbye, world&quot;), hunk.target().lines());
1595         }
1596     }
1597 
1598     @ParameterizedTest
1599     @EnumSource(VCS.class)
1600     void testFiles(VCS vcs) throws IOException {
1601         try (var dir = new TemporaryDirectory()) {
1602             var r = Repository.init(dir.path(), vcs);
1603             assertTrue(r.isClean());
1604 
1605             var f = dir.path().resolve(&quot;README&quot;);
1606             Files.writeString(f, &quot;Hello\n&quot;);
1607             r.add(f);
1608             var initial = r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1609 
1610             var entries = r.files(initial);
1611             assertEquals(1, entries.size());
1612             var entry = entries.get(0);
1613             assertEquals(Path.of(&quot;README&quot;), entry.path());
1614             assertTrue(entry.type().isRegularNonExecutable());
1615 
1616             var f2 = dir.path().resolve(&quot;CONTRIBUTING&quot;);
1617             Files.writeString(f2, &quot;Hello\n&quot;);
1618             r.add(f2);
1619             var second = r.commit(&quot;Second commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1620 
1621             entries = r.files(second);
1622             assertEquals(2, entries.size());
1623             assertTrue(entries.stream().allMatch(e -&gt; e.type().isRegularNonExecutable()));
1624             var paths = entries.stream().map(FileEntry::path).collect(Collectors.toSet());
1625             assertTrue(paths.contains(Path.of(&quot;README&quot;)));
1626             assertTrue(paths.contains(Path.of(&quot;CONTRIBUTING&quot;)));
1627 
1628             entries = r.files(second, Path.of(&quot;README&quot;));
1629             assertEquals(1, entries.size());
1630             entry = entries.get(0);
1631             assertEquals(Path.of(&quot;README&quot;), entry.path());
1632             assertTrue(entry.type().isRegularNonExecutable());
1633         }
1634     }
<a name="1" id="anc1"></a>




















1635 }
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>