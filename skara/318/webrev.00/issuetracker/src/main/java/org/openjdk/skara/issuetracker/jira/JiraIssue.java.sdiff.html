<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff issuetracker/src/main/java/org/openjdk/skara/issuetracker/jira/JiraIssue.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="JiraHost.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="JiraIssueTrackerFactory.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>issuetracker/src/main/java/org/openjdk/skara/issuetracker/jira/JiraIssue.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.issuetracker.jira;
 24 
 25 import org.openjdk.skara.host.HostUser;
 26 import org.openjdk.skara.issuetracker.*;
 27 import org.openjdk.skara.json.*;
 28 import org.openjdk.skara.network.*;
 29 
 30 import java.net.URI;
 31 import java.time.ZonedDateTime;
 32 import java.time.format.DateTimeFormatter;
 33 import java.util.*;

 34 import java.util.stream.Collectors;
 35 
 36 public class JiraIssue implements Issue {
 37     private final JiraProject jiraProject;
 38     private final RestRequest request;
 39     private final JSONValue json;
 40 









 41     private static final DateTimeFormatter dateFormat = DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd&#39;T&#39;HH:mm:ss.SSSZ&quot;);
 42 
 43     JiraIssue(JiraProject jiraProject, RestRequest request, JSONValue json) {
 44         this.jiraProject = jiraProject;
 45         this.request = request;
 46         this.json = json;












 47     }
 48 
 49     @Override
 50     public IssueProject project() {
 51         return jiraProject;
 52     }
 53 
 54     @Override
 55     public String id() {
 56         return json.get(&quot;key&quot;).asString();
 57     }
 58 
 59     @Override
 60     public HostUser author() {
 61         return new HostUser(json.get(&quot;fields&quot;).get(&quot;creator&quot;).get(&quot;key&quot;).asString(),
 62                             json.get(&quot;fields&quot;).get(&quot;creator&quot;).get(&quot;name&quot;).asString(),
 63                             json.get(&quot;fields&quot;).get(&quot;creator&quot;).get(&quot;displayName&quot;).asString());
 64     }
 65 
 66     @Override
 67     public String title() {
 68         return json.get(&quot;fields&quot;).get(&quot;summary&quot;).asString();
 69     }
 70 
 71     @Override
 72     public void setTitle(String title) {




 73         var query = JSON.object()
 74                         .put(&quot;fields&quot;, JSON.object()
 75                                            .put(&quot;summary&quot;, title));
 76         request.put(&quot;&quot;).body(query).execute();
 77     }
 78 
 79     @Override
 80     public String body() {
 81         if (json.get(&quot;fields&quot;).get(&quot;description&quot;).isNull()) {
 82             return &quot;&quot;;
 83         } else {
 84             return json.get(&quot;fields&quot;).get(&quot;description&quot;).asString();
 85         }
 86     }
 87 
 88     @Override
 89     public void setBody(String body) {




 90         var query = JSON.object()
 91                         .put(&quot;fields&quot;, JSON.object()
 92                                            .put(&quot;description&quot;, body));
 93         request.put(&quot;&quot;).body(query).execute();
 94     }
 95 
 96     private Comment parseComment(JSONValue json) {
 97         return new Comment(json.get(&quot;id&quot;).asString(),
 98                            json.get(&quot;body&quot;).asString(),
 99                            new HostUser(json.get(&quot;author&quot;).get(&quot;name&quot;).asString(),
100                                         json.get(&quot;author&quot;).get(&quot;name&quot;).asString(),
101                                         json.get(&quot;author&quot;).get(&quot;displayName&quot;).asString()),
102                            ZonedDateTime.parse(json.get(&quot;created&quot;).asString(), dateFormat),
103                            ZonedDateTime.parse(json.get(&quot;updated&quot;).asString(), dateFormat));
104     }
105 
106     @Override
107     public List&lt;Comment&gt; comments() {
108         var comments = request.get(&quot;/comment&quot;)
109                               .param(&quot;maxResults&quot;, &quot;1000&quot;)
110                               .execute();
111         return comments.get(&quot;comments&quot;).stream()
112                        .map(this::parseComment)
113                        .collect(Collectors.toList());
114     }
115 
116     @Override
117     public Comment addComment(String body) {




118         var json = request.post(&quot;/comment&quot;)
<span class="line-modified">119                           .body(&quot;body&quot;, body)</span>
120                           .execute();
121         return parseComment(json);
122     }
123 
124     @Override
125     public Comment updateComment(String id, String body) {




126         var json = request.put(&quot;/comment/&quot; + id)
<span class="line-modified">127                           .body(&quot;body&quot;, body)</span>
128                           .execute();
129         return parseComment(json);
130     }
131 
132     @Override
133     public ZonedDateTime createdAt() {
134         return ZonedDateTime.parse(json.get(&quot;fields&quot;).get(&quot;created&quot;).asString(), dateFormat);
135     }
136 
137     @Override
138     public ZonedDateTime updatedAt() {
139         return ZonedDateTime.parse(json.get(&quot;fields&quot;).get(&quot;updated&quot;).asString(), dateFormat);
140     }
141 
142     private Map&lt;String, String&gt; availableTransitions() {
143         var transitions = request.get(&quot;/transitions&quot;).execute();
144         return transitions.get(&quot;transitions&quot;).stream()
145                           .collect(Collectors.toMap(v -&gt; v.get(&quot;to&quot;).get(&quot;name&quot;).asString(),
146                                                     v -&gt; v.get(&quot;id&quot;).asString()));
147     }
</pre>
<hr />
<pre>
182                     if (!availableTransitions.containsKey(&quot;Closed&quot;)) {
183                         throw new RuntimeException(&quot;Cannot transition to Closed after Resolved&quot;);
184                     }
185                 } else {
186                     throw new RuntimeException(&quot;Cannot transition to Closed&quot;);
187                 }
188                 performTransition(availableTransitions.get(&quot;Closed&quot;));
189             }
190         } else if (state == State.OPEN) {
191             if (!availableTransitions.containsKey(&quot;Open&quot;)) {
192                 throw new RuntimeException(&quot;Cannot transition to Open&quot;);
193             }
194             performTransition(availableTransitions.get(&quot;Open&quot;));
195         } else {
196             throw new IllegalStateException(&quot;Unknown state &quot; + state);
197         }
198     }
199 
200     @Override
201     public void addLabel(String label) {




202         var query = JSON.object()
203                         .put(&quot;update&quot;, JSON.object()
204                                            .put(&quot;labels&quot;, JSON.array().add(JSON.object()
205                                                                                .put(&quot;add&quot;, label))));
206         request.put(&quot;&quot;).body(query).execute();
207     }
208 
209     @Override
210     public void removeLabel(String label) {
211         var query = JSON.object()
212                         .put(&quot;update&quot;, JSON.object()
213                                            .put(&quot;labels&quot;, JSON.array().add(JSON.object()
214                                                                                .put(&quot;remove&quot;, label))));
215         request.put(&quot;&quot;).body(query).execute();
216     }
217 
218     @Override
219     public List&lt;String&gt; labels() {
220         return json.get(&quot;fields&quot;).get(&quot;labels&quot;).stream()
221                    .map(JSONValue::asString)
</pre>
<hr />
<pre>
283             if (json.get(&quot;object&quot;).get(&quot;status&quot;).get(&quot;icon&quot;).contains(&quot;title&quot;)) {
284                 link.statusIconTitle(json.get(&quot;object&quot;).get(&quot;status&quot;).get(&quot;icon&quot;).get(&quot;title&quot;).asString());
285             }
286         }
287         link.resolved(json.get(&quot;object&quot;).get(&quot;status&quot;).get(&quot;resolved&quot;).asBoolean());
288         return link.build();
289     }
290 
291     @Override
292     public List&lt;Link&gt; links() {
293         var result = request.get(&quot;/remotelink&quot;).execute();
294         return result.stream()
295                      .map(JSONValue::asObject)
296                      .filter(obj -&gt; obj.get(&quot;globalId&quot;).asString().startsWith(&quot;skaralink=&quot;))
297                      .map(this::parseLink)
298                      .collect(Collectors.toList());
299     }
300 
301     @Override
302     public void addLink(Link link) {





303         var query = JSON.object().put(&quot;globalId&quot;, &quot;skaralink=&quot; + link.uri().toString());
304         var object = JSON.object().put(&quot;url&quot;, link.uri().toString()).put(&quot;title&quot;, link.title());
305         var status = JSON.object().put(&quot;resolved&quot;, link.resolved());
306         var icon = JSON.object();
307         var statusIcon = JSON.object();
308 
309         query.put(&quot;object&quot;, object);
310         object.put(&quot;icon&quot;, icon);
311         object.put(&quot;status&quot;, status);
312         status.put(&quot;icon&quot;, statusIcon);
313 
314         link.relationship().ifPresent(relationship -&gt; query.put(&quot;relationship&quot;, relationship));
315         link.summary().ifPresent(summary -&gt; object.put(&quot;summary&quot;, summary));
316         link.iconUrl().ifPresent(iconUrl -&gt; icon.put(&quot;url16x16&quot;, iconUrl.toString()));
317         link.iconTitle().ifPresent(iconTitle -&gt; icon.put(&quot;title&quot;, iconTitle));
318         link.statusIconUrl().ifPresent(statusIconUrl -&gt; statusIcon.put(&quot;url16x16&quot;, statusIconUrl.toString()));
319         link.statusIconTitle().ifPresent(statusIconTitle -&gt; statusIcon.put(&quot;title&quot;, statusIconTitle));
320 
321         request.post(&quot;/remotelink&quot;)
322                .body(query)
</pre>
</td>
<td>
<hr />
<pre>
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.issuetracker.jira;
 24 
 25 import org.openjdk.skara.host.HostUser;
 26 import org.openjdk.skara.issuetracker.*;
 27 import org.openjdk.skara.json.*;
 28 import org.openjdk.skara.network.*;
 29 
 30 import java.net.URI;
 31 import java.time.ZonedDateTime;
 32 import java.time.format.DateTimeFormatter;
 33 import java.util.*;
<span class="line-added"> 34 import java.util.logging.Logger;</span>
 35 import java.util.stream.Collectors;
 36 
 37 public class JiraIssue implements Issue {
 38     private final JiraProject jiraProject;
 39     private final RestRequest request;
 40     private final JSONValue json;
 41 
<span class="line-added"> 42     // If true, the issue has the requested security level as set by the host. This means that fields that do</span>
<span class="line-added"> 43     // not explicitly support a security level (such as labels and links) implicitly get the correct security</span>
<span class="line-added"> 44     // level. If false, such items may not be added or updated.</span>
<span class="line-added"> 45     // Comments are special in that they do explicitly support a visibility level, and can thus be posted and</span>
<span class="line-added"> 46     // updated even if the issue has a different security level than the requested one.</span>
<span class="line-added"> 47     private final boolean secure;</span>
<span class="line-added"> 48 </span>
<span class="line-added"> 49     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.issuetracker.jira&quot;);</span>
<span class="line-added"> 50 </span>
 51     private static final DateTimeFormatter dateFormat = DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd&#39;T&#39;HH:mm:ss.SSSZ&quot;);
 52 
 53     JiraIssue(JiraProject jiraProject, RestRequest request, JSONValue json) {
 54         this.jiraProject = jiraProject;
 55         this.request = request;
 56         this.json = json;
<span class="line-added"> 57 </span>
<span class="line-added"> 58         if (json.get(&quot;fields&quot;).contains(&quot;security&quot;)) {</span>
<span class="line-added"> 59             // Issue has the requested security level -&gt; fine to post fields without role</span>
<span class="line-added"> 60             secure = jiraProject.jiraHost().securityLevel().orElse(&quot;&quot;).equals(json.get(&quot;fields&quot;).get(&quot;security&quot;).get(&quot;id&quot;).asString());</span>
<span class="line-added"> 61         } else {</span>
<span class="line-added"> 62             if (jiraProject.jiraHost().securityLevel().isEmpty()) {</span>
<span class="line-added"> 63                 // No security level on issue, and none requested -&gt; fine to post fields without role</span>
<span class="line-added"> 64                 secure = true;</span>
<span class="line-added"> 65             } else {</span>
<span class="line-added"> 66                 secure = false;</span>
<span class="line-added"> 67             }</span>
<span class="line-added"> 68         }</span>
 69     }
 70 
 71     @Override
 72     public IssueProject project() {
 73         return jiraProject;
 74     }
 75 
 76     @Override
 77     public String id() {
 78         return json.get(&quot;key&quot;).asString();
 79     }
 80 
 81     @Override
 82     public HostUser author() {
 83         return new HostUser(json.get(&quot;fields&quot;).get(&quot;creator&quot;).get(&quot;key&quot;).asString(),
 84                             json.get(&quot;fields&quot;).get(&quot;creator&quot;).get(&quot;name&quot;).asString(),
 85                             json.get(&quot;fields&quot;).get(&quot;creator&quot;).get(&quot;displayName&quot;).asString());
 86     }
 87 
 88     @Override
 89     public String title() {
 90         return json.get(&quot;fields&quot;).get(&quot;summary&quot;).asString();
 91     }
 92 
 93     @Override
 94     public void setTitle(String title) {
<span class="line-added"> 95         if (!secure) {</span>
<span class="line-added"> 96             log.warning(&quot;Ignoring attempt to set title on issue with wrong security level&quot;);</span>
<span class="line-added"> 97             return;</span>
<span class="line-added"> 98         }</span>
 99         var query = JSON.object()
100                         .put(&quot;fields&quot;, JSON.object()
101                                            .put(&quot;summary&quot;, title));
102         request.put(&quot;&quot;).body(query).execute();
103     }
104 
105     @Override
106     public String body() {
107         if (json.get(&quot;fields&quot;).get(&quot;description&quot;).isNull()) {
108             return &quot;&quot;;
109         } else {
110             return json.get(&quot;fields&quot;).get(&quot;description&quot;).asString();
111         }
112     }
113 
114     @Override
115     public void setBody(String body) {
<span class="line-added">116         if (!secure) {</span>
<span class="line-added">117             log.warning(&quot;Ignoring attempt to set body on issue with wrong security level&quot;);</span>
<span class="line-added">118             return;</span>
<span class="line-added">119         }</span>
120         var query = JSON.object()
121                         .put(&quot;fields&quot;, JSON.object()
122                                            .put(&quot;description&quot;, body));
123         request.put(&quot;&quot;).body(query).execute();
124     }
125 
126     private Comment parseComment(JSONValue json) {
127         return new Comment(json.get(&quot;id&quot;).asString(),
128                            json.get(&quot;body&quot;).asString(),
129                            new HostUser(json.get(&quot;author&quot;).get(&quot;name&quot;).asString(),
130                                         json.get(&quot;author&quot;).get(&quot;name&quot;).asString(),
131                                         json.get(&quot;author&quot;).get(&quot;displayName&quot;).asString()),
132                            ZonedDateTime.parse(json.get(&quot;created&quot;).asString(), dateFormat),
133                            ZonedDateTime.parse(json.get(&quot;updated&quot;).asString(), dateFormat));
134     }
135 
136     @Override
137     public List&lt;Comment&gt; comments() {
138         var comments = request.get(&quot;/comment&quot;)
139                               .param(&quot;maxResults&quot;, &quot;1000&quot;)
140                               .execute();
141         return comments.get(&quot;comments&quot;).stream()
142                        .map(this::parseComment)
143                        .collect(Collectors.toList());
144     }
145 
146     @Override
147     public Comment addComment(String body) {
<span class="line-added">148         var query = JSON.object().put(&quot;body&quot;, body);</span>
<span class="line-added">149         jiraProject.jiraHost().visibilityRole().ifPresent(visibility -&gt; query.put(&quot;visibility&quot;, JSON.object()</span>
<span class="line-added">150                                                                                                     .put(&quot;type&quot;, &quot;role&quot;)</span>
<span class="line-added">151                                                                                                     .put(&quot;value&quot;, visibility)));</span>
152         var json = request.post(&quot;/comment&quot;)
<span class="line-modified">153                           .body(query)</span>
154                           .execute();
155         return parseComment(json);
156     }
157 
158     @Override
159     public Comment updateComment(String id, String body) {
<span class="line-added">160         var query = JSON.object().put(&quot;body&quot;, body);</span>
<span class="line-added">161         jiraProject.jiraHost().visibilityRole().ifPresent(visibility -&gt; query.put(&quot;visibility&quot;, JSON.object()</span>
<span class="line-added">162                                                                                                     .put(&quot;type&quot;, &quot;role&quot;)</span>
<span class="line-added">163                                                                                                     .put(&quot;value&quot;, visibility)));</span>
164         var json = request.put(&quot;/comment/&quot; + id)
<span class="line-modified">165                           .body(query)</span>
166                           .execute();
167         return parseComment(json);
168     }
169 
170     @Override
171     public ZonedDateTime createdAt() {
172         return ZonedDateTime.parse(json.get(&quot;fields&quot;).get(&quot;created&quot;).asString(), dateFormat);
173     }
174 
175     @Override
176     public ZonedDateTime updatedAt() {
177         return ZonedDateTime.parse(json.get(&quot;fields&quot;).get(&quot;updated&quot;).asString(), dateFormat);
178     }
179 
180     private Map&lt;String, String&gt; availableTransitions() {
181         var transitions = request.get(&quot;/transitions&quot;).execute();
182         return transitions.get(&quot;transitions&quot;).stream()
183                           .collect(Collectors.toMap(v -&gt; v.get(&quot;to&quot;).get(&quot;name&quot;).asString(),
184                                                     v -&gt; v.get(&quot;id&quot;).asString()));
185     }
</pre>
<hr />
<pre>
220                     if (!availableTransitions.containsKey(&quot;Closed&quot;)) {
221                         throw new RuntimeException(&quot;Cannot transition to Closed after Resolved&quot;);
222                     }
223                 } else {
224                     throw new RuntimeException(&quot;Cannot transition to Closed&quot;);
225                 }
226                 performTransition(availableTransitions.get(&quot;Closed&quot;));
227             }
228         } else if (state == State.OPEN) {
229             if (!availableTransitions.containsKey(&quot;Open&quot;)) {
230                 throw new RuntimeException(&quot;Cannot transition to Open&quot;);
231             }
232             performTransition(availableTransitions.get(&quot;Open&quot;));
233         } else {
234             throw new IllegalStateException(&quot;Unknown state &quot; + state);
235         }
236     }
237 
238     @Override
239     public void addLabel(String label) {
<span class="line-added">240         if (!secure) {</span>
<span class="line-added">241             log.warning(&quot;Ignoring attempt to add label on issue with wrong security level&quot;);</span>
<span class="line-added">242             return;</span>
<span class="line-added">243         }</span>
244         var query = JSON.object()
245                         .put(&quot;update&quot;, JSON.object()
246                                            .put(&quot;labels&quot;, JSON.array().add(JSON.object()
247                                                                                .put(&quot;add&quot;, label))));
248         request.put(&quot;&quot;).body(query).execute();
249     }
250 
251     @Override
252     public void removeLabel(String label) {
253         var query = JSON.object()
254                         .put(&quot;update&quot;, JSON.object()
255                                            .put(&quot;labels&quot;, JSON.array().add(JSON.object()
256                                                                                .put(&quot;remove&quot;, label))));
257         request.put(&quot;&quot;).body(query).execute();
258     }
259 
260     @Override
261     public List&lt;String&gt; labels() {
262         return json.get(&quot;fields&quot;).get(&quot;labels&quot;).stream()
263                    .map(JSONValue::asString)
</pre>
<hr />
<pre>
325             if (json.get(&quot;object&quot;).get(&quot;status&quot;).get(&quot;icon&quot;).contains(&quot;title&quot;)) {
326                 link.statusIconTitle(json.get(&quot;object&quot;).get(&quot;status&quot;).get(&quot;icon&quot;).get(&quot;title&quot;).asString());
327             }
328         }
329         link.resolved(json.get(&quot;object&quot;).get(&quot;status&quot;).get(&quot;resolved&quot;).asBoolean());
330         return link.build();
331     }
332 
333     @Override
334     public List&lt;Link&gt; links() {
335         var result = request.get(&quot;/remotelink&quot;).execute();
336         return result.stream()
337                      .map(JSONValue::asObject)
338                      .filter(obj -&gt; obj.get(&quot;globalId&quot;).asString().startsWith(&quot;skaralink=&quot;))
339                      .map(this::parseLink)
340                      .collect(Collectors.toList());
341     }
342 
343     @Override
344     public void addLink(Link link) {
<span class="line-added">345         if (!secure) {</span>
<span class="line-added">346             log.warning(&quot;Ignoring attempt to add link on issue with wrong security level&quot;);</span>
<span class="line-added">347             return;</span>
<span class="line-added">348         }</span>
<span class="line-added">349 </span>
350         var query = JSON.object().put(&quot;globalId&quot;, &quot;skaralink=&quot; + link.uri().toString());
351         var object = JSON.object().put(&quot;url&quot;, link.uri().toString()).put(&quot;title&quot;, link.title());
352         var status = JSON.object().put(&quot;resolved&quot;, link.resolved());
353         var icon = JSON.object();
354         var statusIcon = JSON.object();
355 
356         query.put(&quot;object&quot;, object);
357         object.put(&quot;icon&quot;, icon);
358         object.put(&quot;status&quot;, status);
359         status.put(&quot;icon&quot;, statusIcon);
360 
361         link.relationship().ifPresent(relationship -&gt; query.put(&quot;relationship&quot;, relationship));
362         link.summary().ifPresent(summary -&gt; object.put(&quot;summary&quot;, summary));
363         link.iconUrl().ifPresent(iconUrl -&gt; icon.put(&quot;url16x16&quot;, iconUrl.toString()));
364         link.iconTitle().ifPresent(iconTitle -&gt; icon.put(&quot;title&quot;, iconTitle));
365         link.statusIconUrl().ifPresent(statusIconUrl -&gt; statusIcon.put(&quot;url16x16&quot;, statusIconUrl.toString()));
366         link.statusIconTitle().ifPresent(statusIconTitle -&gt; statusIcon.put(&quot;title&quot;, statusIconTitle));
367 
368         request.post(&quot;/remotelink&quot;)
369                .body(query)
</pre>
</td>
</tr>
</table>
<center><a href="JiraHost.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="JiraIssueTrackerFactory.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>