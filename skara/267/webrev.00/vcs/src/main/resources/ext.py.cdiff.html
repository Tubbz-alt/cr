<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff vcs/src/main/resources/ext.py</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>vcs/src/main/resources/ext.py</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 27,17 ***</span>
  import mercurial.node
  import difflib
  import sys
  
  # space separated version list
<span class="line-modified">! testedwith = &#39;4.9.2 5.0.2&#39;</span>
  
  def mode(fctx):
      flags = fctx.flags()
<span class="line-modified">!     if flags == &#39;&#39;: return &#39;100644&#39;</span>
<span class="line-modified">!     if flags == &#39;x&#39;: return &#39;100755&#39;</span>
<span class="line-modified">!     if flags == &#39;l&#39;: return &#39;120000&#39;</span>
  
  def ratio(a, b, threshold):
      s = difflib.SequenceMatcher(None, a, b)
      if s.real_quick_ratio() &lt; threshold:
          return 0
<span class="line-new-header">--- 27,17 ---</span>
  import mercurial.node
  import difflib
  import sys
  
  # space separated version list
<span class="line-modified">! testedwith = &#39;4.9.2 5.0.2 5.2.1&#39;</span>
  
  def mode(fctx):
      flags = fctx.flags()
<span class="line-modified">!     if flags == b&#39;&#39;: return b&#39;100644&#39;</span>
<span class="line-modified">!     if flags == b&#39;x&#39;: return b&#39;100755&#39;</span>
<span class="line-modified">!     if flags == b&#39;l&#39;: return b&#39;120000&#39;</span>
  
  def ratio(a, b, threshold):
      s = difflib.SequenceMatcher(None, a, b)
      if s.real_quick_ratio() &lt; threshold:
          return 0
</pre>
<hr />
<pre>
<span class="line-old-header">*** 46,31 ***</span>
      ratio = s.ratio()
      if ratio &lt; threshold:
          return 0
      return ratio
  
<span class="line-removed">- def encode(s):</span>
<span class="line-removed">-     return s.decode(&#39;utf-8&#39;).encode(&#39;utf-8&#39;)</span>
<span class="line-removed">- </span>
  def write(s):
<span class="line-modified">!     sys.stdout.write(encode(s))</span>
  
  def writeln(s):
      write(s)
<span class="line-modified">!     sys.stdout.write(encode(&#39;\n&#39;))</span>
  
  def _match_exact(root, cwd, files, badfn=None):
      &quot;&quot;&quot;
      Wrapper for mercurial.match.exact that ignores some arguments based on the used version
      &quot;&quot;&quot;
<span class="line-modified">!     if mercurial.util.version().startswith(&quot;5&quot;):</span>
          return mercurial.match.exact(files, badfn)
      else:
          return mercurial.match.exact(root, cwd, files, badfn)
  
  def _diff_git_raw(repo, ctx1, ctx2, modified, added, removed, showPatch):
<span class="line-modified">!     nullHash = &#39;0&#39; * 40</span>
      removed_copy = set(removed)
  
      for path in added:
          fctx = ctx2.filectx(path)
          if fctx.renamed():
<span class="line-new-header">--- 46,34 ---</span>
      ratio = s.ratio()
      if ratio &lt; threshold:
          return 0
      return ratio
  
  def write(s):
<span class="line-modified">!     if sys.version_info &gt;= (3, 0):</span>
<span class="line-added">+         sys.stdout.buffer.write(s)</span>
<span class="line-added">+     else:</span>
<span class="line-added">+         sys.stdout.write(s)</span>
  
  def writeln(s):
      write(s)
<span class="line-modified">!     write(b&#39;\n&#39;)</span>
<span class="line-added">+ </span>
<span class="line-added">+ def int_to_str(i):</span>
<span class="line-added">+     return str(i).encode(&#39;ascii&#39;)</span>
  
  def _match_exact(root, cwd, files, badfn=None):
      &quot;&quot;&quot;
      Wrapper for mercurial.match.exact that ignores some arguments based on the used version
      &quot;&quot;&quot;
<span class="line-modified">!     if mercurial.util.version().startswith(b&quot;5&quot;):</span>
          return mercurial.match.exact(files, badfn)
      else:
          return mercurial.match.exact(root, cwd, files, badfn)
  
  def _diff_git_raw(repo, ctx1, ctx2, modified, added, removed, showPatch):
<span class="line-modified">!     nullHash = b&#39;0&#39; * 40</span>
      removed_copy = set(removed)
  
      for path in added:
          fctx = ctx2.filectx(path)
          if fctx.renamed():
</pre>
<hr />
<pre>
<span class="line-old-header">*** 80,37 ***</span>
                  removed_copy.discard(old_path)
  
      for path in sorted(modified | added | removed_copy):
          if path in modified:
              fctx = ctx2.filectx(path)
<span class="line-modified">!             writeln(&#39;:{} {} {} {} M\t{}&#39;.format(mode(ctx1.filectx(path)), mode(fctx), nullHash, nullHash, fctx.path()))</span>
          elif path in added:
              fctx = ctx2.filectx(path)
              if not fctx.renamed():
<span class="line-modified">!                 writeln(&#39;:000000 {} {} {} A\t{}&#39;.format(mode(fctx), nullHash, nullHash, fctx.path()))</span>
              else:
                  parent = fctx.p1()
<span class="line-modified">!                 score = int(ratio(parent.data(), fctx.data(), 0.5) * 100)</span>
                  old_path, _ = fctx.renamed()
  
                  if old_path in removed:
<span class="line-modified">!                     operation = &#39;R&#39;</span>
                  else:
<span class="line-modified">!                     operation = &#39;C&#39;</span>
  
<span class="line-modified">!                 writeln(&#39;:{} {} {} {} {}{}\t{}\t{}&#39;.format(mode(parent), mode(fctx), nullHash, nullHash, operation, score, old_path, path))</span>
          elif path in removed_copy:
              fctx = ctx1.filectx(path)
<span class="line-modified">!             writeln(&#39;:{} 000000 {} {} D\t{}&#39;.format(mode(fctx), nullHash, nullHash, path))</span>
  
      if showPatch:
<span class="line-modified">!         writeln(&#39;&#39;)</span>
  
          match = _match_exact(repo.root, repo.getcwd(), list(modified) + list(added) + list(removed_copy))
          opts = mercurial.mdiff.diffopts(git=True, nodates=True, context=0, showfunc=True)
          for d in mercurial.patch.diff(repo, ctx1.node(), ctx2.node(), match=match, opts=opts):
<span class="line-modified">!             sys.stdout.write(d)</span>
  
  def really_differs(repo, p1, p2, ctx, files):
      # workaround bug in hg (present since forever):
      # `hg status` can, for merge commits, report a file as modififed between one parent
      # and the merge even though it isn&#39;t. `hg diff` works correctly, so remove any &quot;modified&quot;
<span class="line-new-header">--- 83,38 ---</span>
                  removed_copy.discard(old_path)
  
      for path in sorted(modified | added | removed_copy):
          if path in modified:
              fctx = ctx2.filectx(path)
<span class="line-modified">!             writeln(b&#39;:&#39; + mode(ctx1.filectx(path)) + b&#39; &#39; + mode(fctx) + b&#39; &#39; + nullHash + b&#39; &#39; + nullHash + b&#39; M\t&#39; + fctx.path())</span>
          elif path in added:
              fctx = ctx2.filectx(path)
              if not fctx.renamed():
<span class="line-modified">!                 writeln(b&#39;:000000 &#39; + mode(fctx) + b&#39; &#39; + nullHash + b&#39; &#39; + nullHash + b&#39; A\t&#39; + fctx.path())</span>
              else:
                  parent = fctx.p1()
<span class="line-modified">!                 score = int_to_str(int(ratio(parent.data(), fctx.data(), 0.5) * 100))</span>
                  old_path, _ = fctx.renamed()
  
                  if old_path in removed:
<span class="line-modified">!                     operation = b&#39;R&#39;</span>
                  else:
<span class="line-modified">!                     operation = b&#39;C&#39;</span>
  
<span class="line-modified">!                 write(b&#39;:&#39; + mode(parent) + b&#39; &#39; + mode(fctx) + b&#39; &#39; + nullHash + b&#39; &#39; + nullHash + b&#39; &#39;)</span>
<span class="line-added">+                 writeln(operation + score + b&#39;\t&#39; + old_path + b&#39;\t&#39; + path)</span>
          elif path in removed_copy:
              fctx = ctx1.filectx(path)
<span class="line-modified">!             writeln(b&#39;:&#39; + mode(fctx) + b&#39; 000000 &#39; + nullHash + b&#39; &#39; + nullHash + b&#39; D\t&#39; + path)</span>
  
      if showPatch:
<span class="line-modified">!         writeln(b&#39;&#39;)</span>
  
          match = _match_exact(repo.root, repo.getcwd(), list(modified) + list(added) + list(removed_copy))
          opts = mercurial.mdiff.diffopts(git=True, nodates=True, context=0, showfunc=True)
          for d in mercurial.patch.diff(repo, ctx1.node(), ctx2.node(), match=match, opts=opts):
<span class="line-modified">!             write(d)</span>
  
  def really_differs(repo, p1, p2, ctx, files):
      # workaround bug in hg (present since forever):
      # `hg status` can, for merge commits, report a file as modififed between one parent
      # and the merge even though it isn&#39;t. `hg diff` works correctly, so remove any &quot;modified&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 149,11 ***</span>
      revrange = mercurial.scmutil.revrange
  else:
      revsingle = mercurial.cmdutil.revsingle
      revrange = mercurial.cmdutil.revrange
  
<span class="line-modified">! @command(&#39;diff-git-raw&#39;, [(&#39;&#39;, &#39;patch&#39;, False, &#39;&#39;)], &#39;hg diff-git-raw rev1 [rev2]&#39;)</span>
  def diff_git_raw(ui, repo, rev1, rev2=None, **opts):
      ctx1 = revsingle(repo, rev1)
  
      if rev2 != None:
          ctx2 = revsingle(repo, rev2)
<span class="line-new-header">--- 153,11 ---</span>
      revrange = mercurial.scmutil.revrange
  else:
      revsingle = mercurial.cmdutil.revsingle
      revrange = mercurial.cmdutil.revrange
  
<span class="line-modified">! @command(b&#39;diff-git-raw&#39;, [(b&#39;&#39;, b&#39;patch&#39;, False, b&#39;&#39;)], b&#39;hg diff-git-raw rev1 [rev2]&#39;)</span>
  def diff_git_raw(ui, repo, rev1, rev2=None, **opts):
      ctx1 = revsingle(repo, rev1)
  
      if rev2 != None:
          ctx2 = revsingle(repo, rev2)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 163,20 ***</span>
          status = repo.status(ctx1)
  
      modified, added, removed = [set(l) for l in status[:3]]
      _diff_git_raw(repo, ctx1, ctx2, modified, added, removed, opts[&#39;patch&#39;])
  
<span class="line-modified">! @command(&#39;log-git&#39;, [(&#39;&#39;, &#39;reverse&#39;, False, &#39;&#39;), (&#39;l&#39;, &#39;limit&#39;, -1, &#39;&#39;)],  &#39;hg log-git &lt;revisions&gt;&#39;)</span>
  def log_git(ui, repo, revs=None, **opts):
      if len(repo) == 0:
          return
  
      if revs == None:
          if opts[&#39;reverse&#39;]:
<span class="line-modified">!             revs = &#39;0:tip&#39;</span>
          else:
<span class="line-modified">!             revs = &#39;tip:0&#39;</span>
  
      limit = opts[&#39;limit&#39;]
      i = 0
      for r in revrange(repo, [revs]):
          ctx = repo[r]
<span class="line-new-header">--- 167,20 ---</span>
          status = repo.status(ctx1)
  
      modified, added, removed = [set(l) for l in status[:3]]
      _diff_git_raw(repo, ctx1, ctx2, modified, added, removed, opts[&#39;patch&#39;])
  
<span class="line-modified">! @command(b&#39;log-git&#39;, [(b&#39;&#39;, b&#39;reverse&#39;, False, b&#39;&#39;), (b&#39;l&#39;, b&#39;limit&#39;, -1, b&#39;&#39;)],  b&#39;hg log-git &lt;revisions&gt;&#39;)</span>
  def log_git(ui, repo, revs=None, **opts):
      if len(repo) == 0:
          return
  
      if revs == None:
          if opts[&#39;reverse&#39;]:
<span class="line-modified">!             revs = b&#39;0:tip&#39;</span>
          else:
<span class="line-modified">!             revs = b&#39;tip:0&#39;</span>
  
      limit = opts[&#39;limit&#39;]
      i = 0
      for r in revrange(repo, [revs]):
          ctx = repo[r]
</pre>
<hr />
<pre>
<span class="line-old-header">*** 207,95 ***</span>
              combined_added_p1 = really_differs(repo, p1, p2, ctx, combined_added_p1)
              combined_modified_p2 = really_differs(repo, p1, p2, ctx, combined_modified_p2)
              combined_added_p2 = really_differs(repo, p1, p2, ctx, combined_added_p2)
  
              _diff_git_raw(repo, p1, ctx, combined_modified_p1, combined_added_p1, removed_both, True)
<span class="line-modified">!             writeln(&#39;#@!_-=&amp;&#39;)</span>
              _diff_git_raw(repo, p2, ctx, combined_modified_p2, combined_added_p2, removed_both, True)
  
          i += 1
          if i == limit:
              break
  
  def __dump_metadata(ctx):
<span class="line-modified">!         writeln(&#39;#@!_-=&amp;&#39;)</span>
          writeln(ctx.hex())
<span class="line-modified">!         writeln(str(ctx.rev()))</span>
          writeln(ctx.branch())
  
          parents = ctx.parents()
<span class="line-modified">!         writeln(&#39; &#39;.join([str(p.hex()) for p in parents]))</span>
<span class="line-modified">!         writeln(&#39; &#39;.join([str(p.rev()) for p in parents]))</span>
  
          writeln(ctx.user())
<span class="line-modified">!         date = datestr(ctx.date(), format=&#39;%Y-%m-%d %H:%M:%S%z&#39;)</span>
          writeln(date)
  
<span class="line-modified">!         description = encode(ctx.description())</span>
<span class="line-modified">!         writeln(str(len(description)))</span>
          write(description)
  
  def __dump(repo, start, end):
<span class="line-modified">!     for rev in xrange(start, end):</span>
          ctx = revsingle(repo, rev)
  
          __dump_metadata(ctx)
          parents = ctx.parents()
  
          modified, added, removed = repo.status(parents[0], ctx)[:3]
<span class="line-modified">!         writeln(str(len(modified)))</span>
<span class="line-modified">!         writeln(str(len(added)))</span>
<span class="line-modified">!         writeln(str(len(removed)))</span>
  
          for filename in added + modified:
              fctx = ctx.filectx(filename)
  
              writeln(filename)
<span class="line-modified">!             writeln(&#39; &#39;.join(fctx.flags()))</span>
  
              content = fctx.data()
<span class="line-modified">!             writeln(str(len(content)))</span>
<span class="line-modified">!             sys.stdout.write(content)</span>
  
          for filename in removed:
              writeln(filename)
  
  def pretxnclose(ui, repo, **kwargs):
      start = revsingle(repo, kwargs[&#39;node&#39;])
      end = revsingle(repo, kwargs[&#39;node_last&#39;])
      __dump(repo, start.rev(), end.rev() + 1)
  
<span class="line-modified">! @command(&#39;dump&#39;, [],  &#39;hg dump&#39;)</span>
  def dump(ui, repo, **opts):
      __dump(repo, 0, len(repo))
  
<span class="line-modified">! @command(&#39;metadata&#39;, [],  &#39;hg metadata&#39;)</span>
  def dump(ui, repo, revs=None, **opts):
      if revs == None:
<span class="line-modified">!         revs = &quot;0:tip&quot;</span>
  
      for r in revrange(repo, [revs]):
          ctx = repo[r]
          __dump_metadata(ctx)
  
<span class="line-modified">! @command(&#39;ls-tree&#39;, [],  &#39;hg ls-tree&#39;)</span>
  def ls_tree(ui, repo, rev, **opts):
<span class="line-modified">!     nullHash = &#39;0&#39; * 40</span>
      ctx = revsingle(repo, rev)
      for filename in ctx.manifest():
          fctx = ctx.filectx(filename)
<span class="line-modified">!         if &#39;x&#39; in fctx.flags():</span>
<span class="line-modified">!             write(&#39;100755 blob &#39;)</span>
          else:
<span class="line-modified">!             write(&#39;100644 blob &#39;)</span>
          write(nullHash)
<span class="line-modified">!         write(&#39;\t&#39;)</span>
          writeln(filename)
  
<span class="line-modified">! @command(&#39;ls-remote&#39;, [],  &#39;hg ls-remote PATH&#39;)</span>
  def ls_remote(ui, repo, path, **opts):
      peer = mercurial.hg.peer(ui or repo, opts, ui.expandpath(path))
      for branch, heads in peer.branchmap().iteritems():
          for head in heads:
              write(mercurial.node.hex(head))
<span class="line-modified">!             write(&quot;\t&quot;)</span>
              writeln(branch)
<span class="line-new-header">--- 211,95 ---</span>
              combined_added_p1 = really_differs(repo, p1, p2, ctx, combined_added_p1)
              combined_modified_p2 = really_differs(repo, p1, p2, ctx, combined_modified_p2)
              combined_added_p2 = really_differs(repo, p1, p2, ctx, combined_added_p2)
  
              _diff_git_raw(repo, p1, ctx, combined_modified_p1, combined_added_p1, removed_both, True)
<span class="line-modified">!             writeln(b&#39;#@!_-=&amp;&#39;)</span>
              _diff_git_raw(repo, p2, ctx, combined_modified_p2, combined_added_p2, removed_both, True)
  
          i += 1
          if i == limit:
              break
  
  def __dump_metadata(ctx):
<span class="line-modified">!         writeln(b&#39;#@!_-=&amp;&#39;)</span>
          writeln(ctx.hex())
<span class="line-modified">!         writeln(int_to_str(ctx.rev()))</span>
          writeln(ctx.branch())
  
          parents = ctx.parents()
<span class="line-modified">!         writeln(b&#39; &#39;.join([p.hex() for p in parents]))</span>
<span class="line-modified">!         writeln(b&#39; &#39;.join([int_to_str(p.rev()) for p in parents]))</span>
  
          writeln(ctx.user())
<span class="line-modified">!         date = datestr(ctx.date(), format=b&#39;%Y-%m-%d %H:%M:%S%z&#39;)</span>
          writeln(date)
  
<span class="line-modified">!         description = ctx.description()</span>
<span class="line-modified">!         writeln(int_to_str(len(description)))</span>
          write(description)
  
  def __dump(repo, start, end):
<span class="line-modified">!     for rev in range(start, end):</span>
          ctx = revsingle(repo, rev)
  
          __dump_metadata(ctx)
          parents = ctx.parents()
  
          modified, added, removed = repo.status(parents[0], ctx)[:3]
<span class="line-modified">!         writeln(int_to_str(len(modified)))</span>
<span class="line-modified">!         writeln(int_to_str(len(added)))</span>
<span class="line-modified">!         writeln(int_to_str(len(removed)))</span>
  
          for filename in added + modified:
              fctx = ctx.filectx(filename)
  
              writeln(filename)
<span class="line-modified">!             writeln(b&#39; &#39;.join(fctx.flags()))</span>
  
              content = fctx.data()
<span class="line-modified">!             writeln(int_to_str(len(content)))</span>
<span class="line-modified">!             write(content)</span>
  
          for filename in removed:
              writeln(filename)
  
  def pretxnclose(ui, repo, **kwargs):
      start = revsingle(repo, kwargs[&#39;node&#39;])
      end = revsingle(repo, kwargs[&#39;node_last&#39;])
      __dump(repo, start.rev(), end.rev() + 1)
  
<span class="line-modified">! @command(b&#39;dump&#39;, [], b&#39;hg dump&#39;)</span>
  def dump(ui, repo, **opts):
      __dump(repo, 0, len(repo))
  
<span class="line-modified">! @command(b&#39;metadata&#39;, [], b&#39;hg metadata&#39;)</span>
  def dump(ui, repo, revs=None, **opts):
      if revs == None:
<span class="line-modified">!         revs = b&quot;0:tip&quot;</span>
  
      for r in revrange(repo, [revs]):
          ctx = repo[r]
          __dump_metadata(ctx)
  
<span class="line-modified">! @command(b&#39;ls-tree&#39;, [], b&#39;hg ls-tree&#39;)</span>
  def ls_tree(ui, repo, rev, **opts):
<span class="line-modified">!     nullHash = b&#39;0&#39; * 40</span>
      ctx = revsingle(repo, rev)
      for filename in ctx.manifest():
          fctx = ctx.filectx(filename)
<span class="line-modified">!         if b&#39;x&#39; in fctx.flags():</span>
<span class="line-modified">!             write(b&#39;100755 blob &#39;)</span>
          else:
<span class="line-modified">!             write(b&#39;100644 blob &#39;)</span>
          write(nullHash)
<span class="line-modified">!         write(b&#39;\t&#39;)</span>
          writeln(filename)
  
<span class="line-modified">! @command(b&#39;ls-remote&#39;, [], b&#39;hg ls-remote PATH&#39;)</span>
  def ls_remote(ui, repo, path, **opts):
      peer = mercurial.hg.peer(ui or repo, opts, ui.expandpath(path))
      for branch, heads in peer.branchmap().iteritems():
          for head in heads:
              write(mercurial.node.hex(head))
<span class="line-modified">!             write(b&quot;\t&quot;)</span>
              writeln(branch)
</pre>
<center>&lt; prev <a href="../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>