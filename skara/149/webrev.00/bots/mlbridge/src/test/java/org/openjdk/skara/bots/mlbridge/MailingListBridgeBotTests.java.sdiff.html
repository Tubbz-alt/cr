<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="MailingListArchiveReaderBotTests.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="WebrevStorageTests.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  94     void simpleArchive(TestInfo testInfo) throws IOException {
  95         try (var credentials = new HostCredentials(testInfo);
  96              var tempFolder = new TemporaryDirectory();
  97              var archiveFolder = new TemporaryDirectory();
  98              var webrevFolder = new TemporaryDirectory();
  99              var listServer = new TestMailmanServer()) {
 100             var author = credentials.getHostedRepository();
 101             var archive = credentials.getHostedRepository();
 102             var ignored = credentials.getHostedRepository();
 103             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 104             var censusBuilder = credentials.getCensusBuilder()
 105                                            .addAuthor(author.host().getCurrentUserDetails().id());
 106             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 107             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,
 108                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 109                                                  Set.of(),
 110                                                  listServer.getArchive(), listServer.getSMTP(),
 111                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 112                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 113                                                  Set.of(&quot;rfr&quot;), Map.of(ignored.host().getCurrentUserDetails().userName(),
<span class="line-modified"> 114                                                                        Pattern.compile(&quot;ready&quot;)));</span>

 115 
 116             // Populate the projects repository
 117             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
 118             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 119             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 120             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 121 
 122             // Make a change with a corresponding PR
 123             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 124                                                                &quot;Change msg\n\nWith several lines&quot;);
 125             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
<span class="line-modified"> 126             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);</span>
 127             pr.setBody(&quot;This should not be ready&quot;);
 128 
 129             // Run an archive pass
 130             TestBotRunner.runPeriodicItems(mlBot);
 131 
 132             // A PR that isn&#39;t ready for review should not be archived
 133             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 134             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 135 
 136             // Flag it as ready for review
 137             pr.setBody(&quot;This should now be ready&quot;);
 138             pr.addLabel(&quot;rfr&quot;);
 139 
 140             // Run another archive pass
 141             TestBotRunner.runPeriodicItems(mlBot);
 142 
 143             // But it should still not be archived
 144             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 145             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 146 
</pre>
<hr />
<pre>
 153 
 154             // It should still not be archived
 155             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 156             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 157 
 158             // Now post a ready comment
 159             ignoredPr.addComment(&quot;ready&quot;);
 160 
 161             // Run another archive pass
 162             TestBotRunner.runPeriodicItems(mlBot);
 163 
 164             // The archive should now contain an entry
 165             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 166             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 167             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
 168             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
 169             assertTrue(archiveContains(archiveFolder.path(), &quot;Changes:&quot;));
 170             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
 171             assertTrue(archiveContains(archiveFolder.path(), &quot;http://www.test.test/&quot;));
 172             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));


 173             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch:&quot;));
 174             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - &quot; + editHash.abbreviate() + &quot;: Change msg&quot;));
 175             assertFalse(archiveContains(archiveFolder.path(), &quot;With several lines&quot;));
 176 
 177             // The mailing list as well
 178             listServer.processIncoming();
 179             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 180             var mailmanList = mailmanServer.getList(listAddress.address());
 181             var conversations = mailmanList.conversations(Duration.ofDays(1));
 182             assertEquals(1, conversations.size());
 183             var mail = conversations.get(0).first();
<span class="line-modified"> 184             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());</span>
 185             assertEquals(pr.getAuthor().fullName(), mail.author().fullName().orElseThrow());
 186             assertEquals(noreplyAddress(archive), mail.author().address());
 187             assertEquals(from, mail.sender());
 188 
 189             // And there should be a webrev
 190             Repository.materialize(webrevFolder.path(), archive.getUrl(), &quot;webrev&quot;);
 191             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
 192             var comments = pr.getComments();
 193             var webrevComments = comments.stream()
 194                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 195                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 196                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 197                                          .collect(Collectors.toList());
 198             assertEquals(1, webrevComments.size());
 199 
 200             // Add a comment
 201             pr.addComment(&quot;This is a comment :smile:&quot;);
 202 
 203             // Add a comment from an ignored user as well
 204             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);
</pre>
<hr />
<pre>
 243 
 244     @Test
 245     void reviewComment(TestInfo testInfo) throws IOException {
 246         try (var credentials = new HostCredentials(testInfo);
 247              var tempFolder = new TemporaryDirectory();
 248              var archiveFolder = new TemporaryDirectory();
 249              var listServer = new TestMailmanServer()) {
 250             var author = credentials.getHostedRepository();
 251             var archive = credentials.getHostedRepository();
 252             var ignored = credentials.getHostedRepository();
 253             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 254             var censusBuilder = credentials.getCensusBuilder()
 255                                            .addAuthor(author.host().getCurrentUserDetails().id());
 256             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 257             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,
 258                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 259                                                  Set.of(),
 260                                                  listServer.getArchive(), listServer.getSMTP(),
 261                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 262                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 263                                                  Set.of(), Map.of());</span>

 264 
 265             // Populate the projects repository
 266             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 267             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 268             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 269             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 270             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 271 
 272             // Make a change with a corresponding PR
 273             var editHash = CheckableRepository.appendAndCommit(localRepo);
 274             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 275             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 276             pr.setBody(&quot;This is now ready&quot;);
 277             TestBotRunner.runPeriodicItems(mlBot);
 278             listServer.processIncoming();
 279 
 280             // And make a file specific comment
 281             var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
 282             var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 283 
</pre>
<hr />
<pre>
 329     }
 330 
 331     @Test
 332     void combineComments(TestInfo testInfo) throws IOException {
 333         try (var credentials = new HostCredentials(testInfo);
 334              var tempFolder = new TemporaryDirectory();
 335              var archiveFolder = new TemporaryDirectory();
 336              var listServer = new TestMailmanServer()) {
 337             var author = credentials.getHostedRepository();
 338             var archive = credentials.getHostedRepository();
 339             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 340             var censusBuilder = credentials.getCensusBuilder()
 341                                            .addAuthor(author.host().getCurrentUserDetails().id());
 342             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 343             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 344                                                  listAddress, Set.of(), Set.of(),
 345                                                  listServer.getArchive(),
 346                                                  listServer.getSMTP(),
 347                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 348                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 349                                                  Set.of(), Map.of());</span>

 350 
 351             // Populate the projects repository
 352             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 353             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 354             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 355             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 356             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 357 
 358             // Make a change with a corresponding PR
 359             var editHash = CheckableRepository.appendAndCommit(localRepo);
 360             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 361             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 362             pr.setBody(&quot;This is now ready&quot;);
 363             pr.addComment(&quot;Avoid combining&quot;);
 364 
 365             TestBotRunner.runPeriodicItems(mlBot);
 366             listServer.processIncoming();
 367             listServer.processIncoming();
 368 
 369             // Make two file specific comments
</pre>
<hr />
<pre>
 401     @Test
 402     void commentThreading(TestInfo testInfo) throws IOException {
 403         try (var credentials = new HostCredentials(testInfo);
 404              var tempFolder = new TemporaryDirectory();
 405              var archiveFolder = new TemporaryDirectory();
 406              var listServer = new TestMailmanServer()) {
 407             var author = credentials.getHostedRepository();
 408             var reviewer = credentials.getHostedRepository();
 409             var archive = credentials.getHostedRepository();
 410             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 411             var censusBuilder = credentials.getCensusBuilder()
 412                                            .addReviewer(reviewer.host().getCurrentUserDetails().id())
 413                                            .addAuthor(author.host().getCurrentUserDetails().id());
 414             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 415             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 416                                                  listAddress, Set.of(), Set.of(),
 417                                                  listServer.getArchive(),
 418                                                  listServer.getSMTP(),
 419                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 420                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 421                                                  Set.of(), Map.of());</span>

 422 
 423             // Populate the projects repository
 424             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 425             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 426             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 427             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 428             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 429 
 430             // Make a change with a corresponding PR
 431             var editHash = CheckableRepository.appendAndCommit(localRepo);
 432             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 433             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 434             pr.setBody(&quot;This is now ready&quot;);
 435             TestBotRunner.runPeriodicItems(mlBot);
 436             listServer.processIncoming();
 437 
 438             // Make a file specific comment
 439             var reviewPr = reviewer.getPullRequest(pr.getId());
 440             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 441             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
</pre>
<hr />
<pre>
 509     }
 510 
 511     @Test
 512     void reviewContext(TestInfo testInfo) throws IOException {
 513         try (var credentials = new HostCredentials(testInfo);
 514              var tempFolder = new TemporaryDirectory();
 515              var archiveFolder = new TemporaryDirectory();
 516              var listServer = new TestMailmanServer()) {
 517             var author = credentials.getHostedRepository();
 518             var archive = credentials.getHostedRepository();
 519             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 520             var censusBuilder = credentials.getCensusBuilder()
 521                                            .addAuthor(author.host().getCurrentUserDetails().id());
 522             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 523             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 524                                                  listAddress, Set.of(), Set.of(),
 525                                                  listServer.getArchive(),
 526                                                  listServer.getSMTP(),
 527                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 528                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 529                                                  Set.of(), Map.of());</span>

 530 
 531             // Populate the projects repository
 532             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 533             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 534             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 535             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 536             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 537 
 538             // Make a change with a corresponding PR
 539             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
 540             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 541             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 542             pr.setBody(&quot;This is now ready&quot;);
 543             TestBotRunner.runPeriodicItems(mlBot);
 544             listServer.processIncoming();
 545 
 546             // Make a file specific comment
 547             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 548 
 549             TestBotRunner.runPeriodicItems(mlBot);
</pre>
<hr />
<pre>
 558     }
 559 
 560     @Test
 561     void multipleReviewContexts(TestInfo testInfo) throws IOException {
 562         try (var credentials = new HostCredentials(testInfo);
 563              var tempFolder = new TemporaryDirectory();
 564              var archiveFolder = new TemporaryDirectory();
 565              var listServer = new TestMailmanServer()) {
 566             var author = credentials.getHostedRepository();
 567             var archive = credentials.getHostedRepository();
 568             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 569             var censusBuilder = credentials.getCensusBuilder()
 570                                            .addAuthor(author.host().getCurrentUserDetails().id());
 571             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 572             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 573                                                  listAddress, Set.of(), Set.of(),
 574                                                  listServer.getArchive(),
 575                                                  listServer.getSMTP(),
 576                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 577                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 578                                                  Set.of(), Map.of());</span>

 579 
 580             // Populate the projects repository
 581             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 582             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 583             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 584             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 585             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 586             var initialHash = CheckableRepository.appendAndCommit(localRepo,
 587                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
 588                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
 589                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
 590                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
 591                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
 592                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
 593             localRepo.push(initialHash, author.getUrl(), &quot;master&quot;);
 594 
 595             // Make a change with a corresponding PR
 596             var current = Files.readString(localRepo.root().resolve(reviewFile), StandardCharsets.UTF_8);
 597             var updated = current.replaceAll(&quot;Line 2&quot;, &quot;Line 2 edit\nLine 2.5&quot;);
 598             updated = updated.replaceAll(&quot;Line 13&quot;, &quot;Line 12.5\nLine 13 edit&quot;);
</pre>
<hr />
<pre>
 625         }
 626     }
 627 
 628     @Test
 629     void filterComments(TestInfo testInfo) throws IOException {
 630         try (var credentials = new HostCredentials(testInfo);
 631              var tempFolder = new TemporaryDirectory();
 632              var archiveFolder = new TemporaryDirectory();
 633              var listServer = new TestMailmanServer()) {
 634             var author = credentials.getHostedRepository();
 635             var archive = credentials.getHostedRepository();
 636             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 637             var censusBuilder = credentials.getCensusBuilder()
 638                                            .addAuthor(author.host().getCurrentUserDetails().id());
 639             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 640             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 641                                                  listAddress, Set.of(), Set.of(),
 642                                                  listServer.getArchive(), listServer.getSMTP(),
 643                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 644                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 645                                                  Set.of(), Map.of());</span>

 646 
 647             // Populate the projects repository
 648             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 649             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 650             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 651             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 652             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 653 
 654             // Make a change with a corresponding PR
 655             var editHash = CheckableRepository.appendAndCommit(localRepo);
 656             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 657             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 658             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
 659                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
 660 
 661             // Make a bunch of comments
 662             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
 663             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment &lt;!-- this is a comment --&gt;\n&quot;);
 664             pr.addComment(&quot;/integrate stuff&quot;);
 665             TestBotRunner.runPeriodicItems(mlBot);
</pre>
<hr />
<pre>
 682     }
 683 
 684     @Test
 685     void incrementalChanges(TestInfo testInfo) throws IOException {
 686         try (var credentials = new HostCredentials(testInfo);
 687              var tempFolder = new TemporaryDirectory();
 688              var archiveFolder = new TemporaryDirectory();
 689              var listServer = new TestMailmanServer()) {
 690             var author = credentials.getHostedRepository();
 691             var archive = credentials.getHostedRepository();
 692             var commenter = credentials.getHostedRepository();
 693             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 694             var censusBuilder = credentials.getCensusBuilder()
 695                                            .addAuthor(author.host().getCurrentUserDetails().id());
 696             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 697             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 698                                                  listAddress, Set.of(), Set.of(),
 699                                                  listServer.getArchive(), listServer.getSMTP(),
 700                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 701                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 702                                                  Set.of(), Map.of());</span>

 703 
 704             // Populate the projects repository
 705             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 706             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 707             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 708             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 709             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 710 
 711             // Make a change with a corresponding PR
 712             var editHash = CheckableRepository.appendAndCommit(localRepo);
 713             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 714             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 715             pr.setBody(&quot;This is now ready&quot;);
 716 
 717             // Run an archive pass
 718             TestBotRunner.runPeriodicItems(mlBot);
 719             listServer.processIncoming();
 720 
 721             var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
 722             localRepo.push(nextHash, author.getUrl(), &quot;edit&quot;);
</pre>
<hr />
<pre>
 801         }
 802     }
 803 
 804     @Test
 805     void rebased(TestInfo testInfo) throws IOException {
 806         try (var credentials = new HostCredentials(testInfo);
 807              var tempFolder = new TemporaryDirectory();
 808              var archiveFolder = new TemporaryDirectory();
 809              var listServer = new TestMailmanServer()) {
 810             var author = credentials.getHostedRepository();
 811             var archive = credentials.getHostedRepository();
 812             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 813             var censusBuilder = credentials.getCensusBuilder()
 814                                            .addAuthor(author.host().getCurrentUserDetails().id());
 815             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 816             var mlBot = new MailingListBridgeBot(sender, author, archive, censusBuilder.build(), &quot;master&quot;,
 817                                                  listAddress, Set.of(), Set.of(),
 818                                                  listServer.getArchive(), listServer.getSMTP(),
 819                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 820                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 821                                                  Set.of(), Map.of());</span>

 822 
 823             // Populate the projects repository
 824             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 825             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.getRepositoryType(), reviewFile);
 826             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 827             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 828             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 829 
 830             // Make a change with a corresponding PR
 831             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
 832             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 833             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 834             pr.setBody(&quot;This is now ready&quot;);
 835 
 836             // Run an archive pass
 837             TestBotRunner.runPeriodicItems(mlBot);
 838             listServer.processIncoming();
 839 
 840             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.getUrl(), &quot;master&quot;);
 841             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
</pre>
<hr />
<pre>
 892     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
 893         try (var credentials = new HostCredentials(testInfo);
 894              var tempFolder = new TemporaryDirectory();
 895              var archiveFolder = new TemporaryDirectory();
 896              var webrevFolder = new TemporaryDirectory();
 897              var listServer = new TestMailmanServer()) {
 898             var author = credentials.getHostedRepository();
 899             var archive = credentials.getHostedRepository();
 900             var ignored = credentials.getHostedRepository();
 901             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 902             var censusBuilder = credentials.getCensusBuilder()
 903                                            .addAuthor(author.host().getCurrentUserDetails().id());
 904             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 905             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 906                                                  listAddress,
 907                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 908                                                  Set.of(),
 909                                                  listServer.getArchive(), listServer.getSMTP(),
 910                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 911                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 912                                                  Set.of(), Map.of());</span>

 913 
 914             // Populate the projects repository
 915             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
 916             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 917             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 918             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 919 
 920             // Make a change with a corresponding PR
 921             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 922                                                                &quot;Change msg\n\nWith several lines&quot;);
 923             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 924             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 925 
 926             // Flag it as ready for review
 927             pr.setBody(&quot;This should now be ready&quot;);
 928 
 929             // Run an archive pass
 930             TestBotRunner.runPeriodicItems(mlBot);
 931 
 932             // The archive should now contain an entry
</pre>
<hr />
<pre>
 963 
 964     @Test
 965     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
 966         try (var credentials = new HostCredentials(testInfo);
 967              var tempFolder = new TemporaryDirectory();
 968              var archiveFolder = new TemporaryDirectory();
 969              var listServer = new TestMailmanServer()) {
 970             var author = credentials.getHostedRepository();
 971             var archive = credentials.getHostedRepository();
 972             var reviewer = credentials.getHostedRepository();
 973             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 974             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 975             var censusBuilder = credentials.getCensusBuilder()
 976                                            .addReviewer(reviewer.host().getCurrentUserDetails().id())
 977                                            .addAuthor(author.host().getCurrentUserDetails().id());
 978             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 979                                                  listAddress, Set.of(), Set.of(),
 980                                                  listServer.getArchive(), listServer.getSMTP(),
 981                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 982                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 983                                                  Set.of(), Map.of());</span>

 984 
 985             // Populate the projects repository
 986             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 987             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 988             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 989             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 990             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 991 
 992             // Make a change with a corresponding PR
 993             var editHash = CheckableRepository.appendAndCommit(localRepo);
 994             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 995             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 996             pr.setBody(&quot;This is now ready&quot;);
 997 
 998             // Run an archive pass
 999             TestBotRunner.runPeriodicItems(mlBot);
1000 
1001             // First unapprove it
1002             var reviewedPr = reviewer.getPullRequest(pr.getId());
1003             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
</pre>
<hr />
<pre>
1045     @Test
1046     void ignoreComments(TestInfo testInfo) throws IOException {
1047         try (var credentials = new HostCredentials(testInfo);
1048              var tempFolder = new TemporaryDirectory();
1049              var archiveFolder = new TemporaryDirectory();
1050              var listServer = new TestMailmanServer()) {
1051             var author = credentials.getHostedRepository();
1052             var ignored = credentials.getHostedRepository();
1053             var archive = credentials.getHostedRepository();
1054             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1055             var censusBuilder = credentials.getCensusBuilder()
1056                                            .addAuthor(author.host().getCurrentUserDetails().id());
1057             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1058             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
1059                                                  listAddress,
1060                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
1061                                                  Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)),
1062                                                  listServer.getArchive(), listServer.getSMTP(),
1063                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
1064                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified">1065                                                  Set.of(), Map.of());</span>

1066 
1067             // Populate the projects repository
1068             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1069             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
1070             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1071             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
1072             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
1073 
1074             // Make a change with a corresponding PR
1075             var editHash = CheckableRepository.appendAndCommit(localRepo);
1076             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
1077             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1078             pr.setBody(&quot;This is now ready&quot;);
1079 
1080             // Make a bunch of comments
1081             pr.addComment(&quot;Plain comment&quot;);
1082             pr.addComment(&quot;ignore this comment&quot;);
1083             pr.addComment(&quot;I think it is time to\nignore this comment!&quot;);
1084             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review ignore this comment&quot;);
1085 
</pre>
</td>
<td>
<hr />
<pre>
  94     void simpleArchive(TestInfo testInfo) throws IOException {
  95         try (var credentials = new HostCredentials(testInfo);
  96              var tempFolder = new TemporaryDirectory();
  97              var archiveFolder = new TemporaryDirectory();
  98              var webrevFolder = new TemporaryDirectory();
  99              var listServer = new TestMailmanServer()) {
 100             var author = credentials.getHostedRepository();
 101             var archive = credentials.getHostedRepository();
 102             var ignored = credentials.getHostedRepository();
 103             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 104             var censusBuilder = credentials.getCensusBuilder()
 105                                            .addAuthor(author.host().getCurrentUserDetails().id());
 106             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 107             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,
 108                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 109                                                  Set.of(),
 110                                                  listServer.getArchive(), listServer.getSMTP(),
 111                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 112                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 113                                                  Set.of(&quot;rfr&quot;), Map.of(ignored.host().getCurrentUserDetails().userName(),
<span class="line-modified"> 114                                                                        Pattern.compile(&quot;ready&quot;)),</span>
<span class="line-added"> 115                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>
 116 
 117             // Populate the projects repository
 118             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
 119             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 120             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 121             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 122 
 123             // Make a change with a corresponding PR
 124             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 125                                                                &quot;Change msg\n\nWith several lines&quot;);
 126             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
<span class="line-modified"> 127             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);</span>
 128             pr.setBody(&quot;This should not be ready&quot;);
 129 
 130             // Run an archive pass
 131             TestBotRunner.runPeriodicItems(mlBot);
 132 
 133             // A PR that isn&#39;t ready for review should not be archived
 134             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 135             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 136 
 137             // Flag it as ready for review
 138             pr.setBody(&quot;This should now be ready&quot;);
 139             pr.addLabel(&quot;rfr&quot;);
 140 
 141             // Run another archive pass
 142             TestBotRunner.runPeriodicItems(mlBot);
 143 
 144             // But it should still not be archived
 145             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 146             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 147 
</pre>
<hr />
<pre>
 154 
 155             // It should still not be archived
 156             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 157             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 158 
 159             // Now post a ready comment
 160             ignoredPr.addComment(&quot;ready&quot;);
 161 
 162             // Run another archive pass
 163             TestBotRunner.runPeriodicItems(mlBot);
 164 
 165             // The archive should now contain an entry
 166             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 167             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 168             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
 169             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
 170             assertTrue(archiveContains(archiveFolder.path(), &quot;Changes:&quot;));
 171             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
 172             assertTrue(archiveContains(archiveFolder.path(), &quot;http://www.test.test/&quot;));
 173             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));
<span class="line-added"> 174             assertTrue(archiveContains(archiveFolder.path(), &quot;Issue:&quot;));</span>
<span class="line-added"> 175             assertTrue(archiveContains(archiveFolder.path(), &quot;http://issues.test/browse/TSTPRJ-1234&quot;));</span>
 176             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch:&quot;));
 177             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - &quot; + editHash.abbreviate() + &quot;: Change msg&quot;));
 178             assertFalse(archiveContains(archiveFolder.path(), &quot;With several lines&quot;));
 179 
 180             // The mailing list as well
 181             listServer.processIncoming();
 182             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 183             var mailmanList = mailmanServer.getList(listAddress.address());
 184             var conversations = mailmanList.conversations(Duration.ofDays(1));
 185             assertEquals(1, conversations.size());
 186             var mail = conversations.get(0).first();
<span class="line-modified"> 187             assertEquals(&quot;RFR: 1234: This is a pull request&quot;, mail.subject());</span>
 188             assertEquals(pr.getAuthor().fullName(), mail.author().fullName().orElseThrow());
 189             assertEquals(noreplyAddress(archive), mail.author().address());
 190             assertEquals(from, mail.sender());
 191 
 192             // And there should be a webrev
 193             Repository.materialize(webrevFolder.path(), archive.getUrl(), &quot;webrev&quot;);
 194             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
 195             var comments = pr.getComments();
 196             var webrevComments = comments.stream()
 197                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 198                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 199                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 200                                          .collect(Collectors.toList());
 201             assertEquals(1, webrevComments.size());
 202 
 203             // Add a comment
 204             pr.addComment(&quot;This is a comment :smile:&quot;);
 205 
 206             // Add a comment from an ignored user as well
 207             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);
</pre>
<hr />
<pre>
 246 
 247     @Test
 248     void reviewComment(TestInfo testInfo) throws IOException {
 249         try (var credentials = new HostCredentials(testInfo);
 250              var tempFolder = new TemporaryDirectory();
 251              var archiveFolder = new TemporaryDirectory();
 252              var listServer = new TestMailmanServer()) {
 253             var author = credentials.getHostedRepository();
 254             var archive = credentials.getHostedRepository();
 255             var ignored = credentials.getHostedRepository();
 256             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 257             var censusBuilder = credentials.getCensusBuilder()
 258                                            .addAuthor(author.host().getCurrentUserDetails().id());
 259             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 260             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,
 261                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 262                                                  Set.of(),
 263                                                  listServer.getArchive(), listServer.getSMTP(),
 264                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 265                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 266                                                  Set.of(), Map.of(),</span>
<span class="line-added"> 267                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>
 268 
 269             // Populate the projects repository
 270             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 271             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 272             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 273             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 274             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 275 
 276             // Make a change with a corresponding PR
 277             var editHash = CheckableRepository.appendAndCommit(localRepo);
 278             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 279             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 280             pr.setBody(&quot;This is now ready&quot;);
 281             TestBotRunner.runPeriodicItems(mlBot);
 282             listServer.processIncoming();
 283 
 284             // And make a file specific comment
 285             var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
 286             var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 287 
</pre>
<hr />
<pre>
 333     }
 334 
 335     @Test
 336     void combineComments(TestInfo testInfo) throws IOException {
 337         try (var credentials = new HostCredentials(testInfo);
 338              var tempFolder = new TemporaryDirectory();
 339              var archiveFolder = new TemporaryDirectory();
 340              var listServer = new TestMailmanServer()) {
 341             var author = credentials.getHostedRepository();
 342             var archive = credentials.getHostedRepository();
 343             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 344             var censusBuilder = credentials.getCensusBuilder()
 345                                            .addAuthor(author.host().getCurrentUserDetails().id());
 346             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 347             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 348                                                  listAddress, Set.of(), Set.of(),
 349                                                  listServer.getArchive(),
 350                                                  listServer.getSMTP(),
 351                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 352                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 353                                                  Set.of(), Map.of(),</span>
<span class="line-added"> 354                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>
 355 
 356             // Populate the projects repository
 357             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 358             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 359             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 360             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 361             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 362 
 363             // Make a change with a corresponding PR
 364             var editHash = CheckableRepository.appendAndCommit(localRepo);
 365             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 366             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 367             pr.setBody(&quot;This is now ready&quot;);
 368             pr.addComment(&quot;Avoid combining&quot;);
 369 
 370             TestBotRunner.runPeriodicItems(mlBot);
 371             listServer.processIncoming();
 372             listServer.processIncoming();
 373 
 374             // Make two file specific comments
</pre>
<hr />
<pre>
 406     @Test
 407     void commentThreading(TestInfo testInfo) throws IOException {
 408         try (var credentials = new HostCredentials(testInfo);
 409              var tempFolder = new TemporaryDirectory();
 410              var archiveFolder = new TemporaryDirectory();
 411              var listServer = new TestMailmanServer()) {
 412             var author = credentials.getHostedRepository();
 413             var reviewer = credentials.getHostedRepository();
 414             var archive = credentials.getHostedRepository();
 415             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 416             var censusBuilder = credentials.getCensusBuilder()
 417                                            .addReviewer(reviewer.host().getCurrentUserDetails().id())
 418                                            .addAuthor(author.host().getCurrentUserDetails().id());
 419             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 420             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 421                                                  listAddress, Set.of(), Set.of(),
 422                                                  listServer.getArchive(),
 423                                                  listServer.getSMTP(),
 424                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 425                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 426                                                  Set.of(), Map.of(),</span>
<span class="line-added"> 427                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>
 428 
 429             // Populate the projects repository
 430             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 431             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 432             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 433             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 434             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 435 
 436             // Make a change with a corresponding PR
 437             var editHash = CheckableRepository.appendAndCommit(localRepo);
 438             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 439             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 440             pr.setBody(&quot;This is now ready&quot;);
 441             TestBotRunner.runPeriodicItems(mlBot);
 442             listServer.processIncoming();
 443 
 444             // Make a file specific comment
 445             var reviewPr = reviewer.getPullRequest(pr.getId());
 446             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 447             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
</pre>
<hr />
<pre>
 515     }
 516 
 517     @Test
 518     void reviewContext(TestInfo testInfo) throws IOException {
 519         try (var credentials = new HostCredentials(testInfo);
 520              var tempFolder = new TemporaryDirectory();
 521              var archiveFolder = new TemporaryDirectory();
 522              var listServer = new TestMailmanServer()) {
 523             var author = credentials.getHostedRepository();
 524             var archive = credentials.getHostedRepository();
 525             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 526             var censusBuilder = credentials.getCensusBuilder()
 527                                            .addAuthor(author.host().getCurrentUserDetails().id());
 528             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 529             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 530                                                  listAddress, Set.of(), Set.of(),
 531                                                  listServer.getArchive(),
 532                                                  listServer.getSMTP(),
 533                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 534                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 535                                                  Set.of(), Map.of(),</span>
<span class="line-added"> 536                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>
 537 
 538             // Populate the projects repository
 539             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 540             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 541             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 542             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 543             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 544 
 545             // Make a change with a corresponding PR
 546             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
 547             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 548             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 549             pr.setBody(&quot;This is now ready&quot;);
 550             TestBotRunner.runPeriodicItems(mlBot);
 551             listServer.processIncoming();
 552 
 553             // Make a file specific comment
 554             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 555 
 556             TestBotRunner.runPeriodicItems(mlBot);
</pre>
<hr />
<pre>
 565     }
 566 
 567     @Test
 568     void multipleReviewContexts(TestInfo testInfo) throws IOException {
 569         try (var credentials = new HostCredentials(testInfo);
 570              var tempFolder = new TemporaryDirectory();
 571              var archiveFolder = new TemporaryDirectory();
 572              var listServer = new TestMailmanServer()) {
 573             var author = credentials.getHostedRepository();
 574             var archive = credentials.getHostedRepository();
 575             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 576             var censusBuilder = credentials.getCensusBuilder()
 577                                            .addAuthor(author.host().getCurrentUserDetails().id());
 578             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 579             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 580                                                  listAddress, Set.of(), Set.of(),
 581                                                  listServer.getArchive(),
 582                                                  listServer.getSMTP(),
 583                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 584                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 585                                                  Set.of(), Map.of(),</span>
<span class="line-added"> 586                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>
 587 
 588             // Populate the projects repository
 589             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 590             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 591             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 592             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 593             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 594             var initialHash = CheckableRepository.appendAndCommit(localRepo,
 595                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
 596                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
 597                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
 598                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
 599                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
 600                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
 601             localRepo.push(initialHash, author.getUrl(), &quot;master&quot;);
 602 
 603             // Make a change with a corresponding PR
 604             var current = Files.readString(localRepo.root().resolve(reviewFile), StandardCharsets.UTF_8);
 605             var updated = current.replaceAll(&quot;Line 2&quot;, &quot;Line 2 edit\nLine 2.5&quot;);
 606             updated = updated.replaceAll(&quot;Line 13&quot;, &quot;Line 12.5\nLine 13 edit&quot;);
</pre>
<hr />
<pre>
 633         }
 634     }
 635 
 636     @Test
 637     void filterComments(TestInfo testInfo) throws IOException {
 638         try (var credentials = new HostCredentials(testInfo);
 639              var tempFolder = new TemporaryDirectory();
 640              var archiveFolder = new TemporaryDirectory();
 641              var listServer = new TestMailmanServer()) {
 642             var author = credentials.getHostedRepository();
 643             var archive = credentials.getHostedRepository();
 644             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 645             var censusBuilder = credentials.getCensusBuilder()
 646                                            .addAuthor(author.host().getCurrentUserDetails().id());
 647             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 648             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 649                                                  listAddress, Set.of(), Set.of(),
 650                                                  listServer.getArchive(), listServer.getSMTP(),
 651                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 652                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 653                                                  Set.of(), Map.of(),</span>
<span class="line-added"> 654                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>
 655 
 656             // Populate the projects repository
 657             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 658             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 659             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 660             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 661             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 662 
 663             // Make a change with a corresponding PR
 664             var editHash = CheckableRepository.appendAndCommit(localRepo);
 665             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 666             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 667             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
 668                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
 669 
 670             // Make a bunch of comments
 671             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
 672             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment &lt;!-- this is a comment --&gt;\n&quot;);
 673             pr.addComment(&quot;/integrate stuff&quot;);
 674             TestBotRunner.runPeriodicItems(mlBot);
</pre>
<hr />
<pre>
 691     }
 692 
 693     @Test
 694     void incrementalChanges(TestInfo testInfo) throws IOException {
 695         try (var credentials = new HostCredentials(testInfo);
 696              var tempFolder = new TemporaryDirectory();
 697              var archiveFolder = new TemporaryDirectory();
 698              var listServer = new TestMailmanServer()) {
 699             var author = credentials.getHostedRepository();
 700             var archive = credentials.getHostedRepository();
 701             var commenter = credentials.getHostedRepository();
 702             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 703             var censusBuilder = credentials.getCensusBuilder()
 704                                            .addAuthor(author.host().getCurrentUserDetails().id());
 705             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 706             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 707                                                  listAddress, Set.of(), Set.of(),
 708                                                  listServer.getArchive(), listServer.getSMTP(),
 709                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 710                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 711                                                  Set.of(), Map.of(),</span>
<span class="line-added"> 712                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>
 713 
 714             // Populate the projects repository
 715             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 716             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 717             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 718             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 719             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 720 
 721             // Make a change with a corresponding PR
 722             var editHash = CheckableRepository.appendAndCommit(localRepo);
 723             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 724             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 725             pr.setBody(&quot;This is now ready&quot;);
 726 
 727             // Run an archive pass
 728             TestBotRunner.runPeriodicItems(mlBot);
 729             listServer.processIncoming();
 730 
 731             var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
 732             localRepo.push(nextHash, author.getUrl(), &quot;edit&quot;);
</pre>
<hr />
<pre>
 811         }
 812     }
 813 
 814     @Test
 815     void rebased(TestInfo testInfo) throws IOException {
 816         try (var credentials = new HostCredentials(testInfo);
 817              var tempFolder = new TemporaryDirectory();
 818              var archiveFolder = new TemporaryDirectory();
 819              var listServer = new TestMailmanServer()) {
 820             var author = credentials.getHostedRepository();
 821             var archive = credentials.getHostedRepository();
 822             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 823             var censusBuilder = credentials.getCensusBuilder()
 824                                            .addAuthor(author.host().getCurrentUserDetails().id());
 825             var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 826             var mlBot = new MailingListBridgeBot(sender, author, archive, censusBuilder.build(), &quot;master&quot;,
 827                                                  listAddress, Set.of(), Set.of(),
 828                                                  listServer.getArchive(), listServer.getSMTP(),
 829                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 830                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 831                                                  Set.of(), Map.of(),</span>
<span class="line-added"> 832                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>
 833 
 834             // Populate the projects repository
 835             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 836             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.getRepositoryType(), reviewFile);
 837             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 838             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 839             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 840 
 841             // Make a change with a corresponding PR
 842             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
 843             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 844             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 845             pr.setBody(&quot;This is now ready&quot;);
 846 
 847             // Run an archive pass
 848             TestBotRunner.runPeriodicItems(mlBot);
 849             listServer.processIncoming();
 850 
 851             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.getUrl(), &quot;master&quot;);
 852             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
</pre>
<hr />
<pre>
 903     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
 904         try (var credentials = new HostCredentials(testInfo);
 905              var tempFolder = new TemporaryDirectory();
 906              var archiveFolder = new TemporaryDirectory();
 907              var webrevFolder = new TemporaryDirectory();
 908              var listServer = new TestMailmanServer()) {
 909             var author = credentials.getHostedRepository();
 910             var archive = credentials.getHostedRepository();
 911             var ignored = credentials.getHostedRepository();
 912             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 913             var censusBuilder = credentials.getCensusBuilder()
 914                                            .addAuthor(author.host().getCurrentUserDetails().id());
 915             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 916             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 917                                                  listAddress,
 918                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 919                                                  Set.of(),
 920                                                  listServer.getArchive(), listServer.getSMTP(),
 921                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 922                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 923                                                  Set.of(), Map.of(),</span>
<span class="line-added"> 924                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>
 925 
 926             // Populate the projects repository
 927             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
 928             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 929             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 930             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 931 
 932             // Make a change with a corresponding PR
 933             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 934                                                                &quot;Change msg\n\nWith several lines&quot;);
 935             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 936             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 937 
 938             // Flag it as ready for review
 939             pr.setBody(&quot;This should now be ready&quot;);
 940 
 941             // Run an archive pass
 942             TestBotRunner.runPeriodicItems(mlBot);
 943 
 944             // The archive should now contain an entry
</pre>
<hr />
<pre>
 975 
 976     @Test
 977     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
 978         try (var credentials = new HostCredentials(testInfo);
 979              var tempFolder = new TemporaryDirectory();
 980              var archiveFolder = new TemporaryDirectory();
 981              var listServer = new TestMailmanServer()) {
 982             var author = credentials.getHostedRepository();
 983             var archive = credentials.getHostedRepository();
 984             var reviewer = credentials.getHostedRepository();
 985             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 986             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 987             var censusBuilder = credentials.getCensusBuilder()
 988                                            .addReviewer(reviewer.host().getCurrentUserDetails().id())
 989                                            .addAuthor(author.host().getCurrentUserDetails().id());
 990             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 991                                                  listAddress, Set.of(), Set.of(),
 992                                                  listServer.getArchive(), listServer.getSMTP(),
 993                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 994                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified"> 995                                                  Set.of(), Map.of(),</span>
<span class="line-added"> 996                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>
 997 
 998             // Populate the projects repository
 999             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1000             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
1001             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1002             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
1003             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
1004 
1005             // Make a change with a corresponding PR
1006             var editHash = CheckableRepository.appendAndCommit(localRepo);
1007             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
1008             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1009             pr.setBody(&quot;This is now ready&quot;);
1010 
1011             // Run an archive pass
1012             TestBotRunner.runPeriodicItems(mlBot);
1013 
1014             // First unapprove it
1015             var reviewedPr = reviewer.getPullRequest(pr.getId());
1016             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
</pre>
<hr />
<pre>
1058     @Test
1059     void ignoreComments(TestInfo testInfo) throws IOException {
1060         try (var credentials = new HostCredentials(testInfo);
1061              var tempFolder = new TemporaryDirectory();
1062              var archiveFolder = new TemporaryDirectory();
1063              var listServer = new TestMailmanServer()) {
1064             var author = credentials.getHostedRepository();
1065             var ignored = credentials.getHostedRepository();
1066             var archive = credentials.getHostedRepository();
1067             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1068             var censusBuilder = credentials.getCensusBuilder()
1069                                            .addAuthor(author.host().getCurrentUserDetails().id());
1070             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1071             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
1072                                                  listAddress,
1073                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
1074                                                  Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)),
1075                                                  listServer.getArchive(), listServer.getSMTP(),
1076                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
1077                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified">1078                                                  Set.of(), Map.of(),</span>
<span class="line-added">1079                                                  URIBuilder.base(&quot;http://issues.test/browse/&quot;).build());</span>
1080 
1081             // Populate the projects repository
1082             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1083             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
1084             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1085             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
1086             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
1087 
1088             // Make a change with a corresponding PR
1089             var editHash = CheckableRepository.appendAndCommit(localRepo);
1090             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
1091             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1092             pr.setBody(&quot;This is now ready&quot;);
1093 
1094             // Make a bunch of comments
1095             pr.addComment(&quot;Plain comment&quot;);
1096             pr.addComment(&quot;ignore this comment&quot;);
1097             pr.addComment(&quot;I think it is time to\nignore this comment!&quot;);
1098             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review ignore this comment&quot;);
1099 
</pre>
</td>
</tr>
</table>
<center><a href="MailingListArchiveReaderBotTests.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="WebrevStorageTests.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>