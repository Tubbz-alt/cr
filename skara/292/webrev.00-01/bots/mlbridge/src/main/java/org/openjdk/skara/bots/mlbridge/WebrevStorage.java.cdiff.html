<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/WebrevStorage.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/WebrevStorage.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 63,35 ***</span>
                  &quot;  $ git fetch &quot; + pr.repository().webUrl() + &quot; &quot; + pr.sourceRef() + &quot;\n&quot; +
                  &quot;  $ git checkout &quot; + head.hex() + &quot;\n&quot; +
                  &quot;  $ git webrev -r &quot; + base.hex() + &quot;\n&quot;;
      }
  
      private void push(Repository localStorage, Path webrevFolder, String identifier, String placeholder) throws IOException {
          var batchIndex = new AtomicInteger();
  
          // Replace large files (except the index) with placeholders
          try (var files = Files.walk(webrevFolder)) {
<span class="line-modified">!             var largeFiles = files.filter(Files::isRegularFile)</span>
<span class="line-modified">!                                   .filter(file -&gt; {</span>
<span class="line-modified">!                                       try {</span>
<span class="line-removed">-                                           if (file.getFileName().toString().equals(&quot;index.html&quot;)) {</span>
<span class="line-removed">-                                               return false;</span>
<span class="line-removed">-                                           } else {</span>
<span class="line-removed">-                                               return Files.size(file) &gt;= 1000 * 1000;</span>
<span class="line-removed">-                                           }</span>
<span class="line-removed">-                                       } catch (IOException e) {</span>
<span class="line-removed">-                                           return false;</span>
<span class="line-removed">-                                       }</span>
<span class="line-removed">-                                   })</span>
<span class="line-removed">-                                   .collect(Collectors.toList());</span>
<span class="line-removed">-             largeFiles.forEach(file -&gt; {</span>
<span class="line-removed">-                 try {</span>
<span class="line-removed">-                     Files.writeString(file, placeholder);</span>
<span class="line-removed">-                 } catch (IOException e) {</span>
<span class="line-removed">-                     throw new RuntimeException(&quot;Failed to replace large file with placeholder&quot;);</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-             });</span>
          }
  
          // Try to push 1000 files at a time
          try (var files = Files.walk(webrevFolder)) {
              var batches = files.filter(Files::isRegularFile)
<span class="line-new-header">--- 63,49 ---</span>
                  &quot;  $ git fetch &quot; + pr.repository().webUrl() + &quot; &quot; + pr.sourceRef() + &quot;\n&quot; +
                  &quot;  $ git checkout &quot; + head.hex() + &quot;\n&quot; +
                  &quot;  $ git webrev -r &quot; + base.hex() + &quot;\n&quot;;
      }
  
<span class="line-added">+     private void replaceContent(Path file, String placeholder) {</span>
<span class="line-added">+         try {</span>
<span class="line-added">+             if (file.getFileName().toString().endsWith(&quot;.html&quot;)) {</span>
<span class="line-added">+                 var existing = Files.readString(file);</span>
<span class="line-added">+                 var headerEnd = existing.indexOf(&quot;&lt;pre&gt;&quot;);</span>
<span class="line-added">+                 var footerStart = existing.lastIndexOf(&quot;&lt;/pre&gt;&quot;);</span>
<span class="line-added">+                 if ((headerEnd &gt; 0) &amp;&amp; (footerStart &gt; 0)) {</span>
<span class="line-added">+                     var header = existing.substring(0, headerEnd + 5);</span>
<span class="line-added">+                     var footer = existing.substring(footerStart);</span>
<span class="line-added">+                     Files.writeString(file, header + placeholder + footer);</span>
<span class="line-added">+                     return;</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             }</span>
<span class="line-added">+             Files.writeString(file, placeholder);</span>
<span class="line-added">+         } catch (IOException e) {</span>
<span class="line-added">+             throw new RuntimeException(&quot;Failed to replace large file with placeholder&quot;);</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     private boolean shouldBeReplaced(Path file) {</span>
<span class="line-added">+         try {</span>
<span class="line-added">+             if (file.getFileName().toString().equals(&quot;index.html&quot;)) {</span>
<span class="line-added">+                 return false;</span>
<span class="line-added">+             } else {</span>
<span class="line-added">+                 return Files.size(file) &gt;= 1000 * 1000;</span>
<span class="line-added">+             }</span>
<span class="line-added">+         } catch (IOException e) {</span>
<span class="line-added">+             return false;</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      private void push(Repository localStorage, Path webrevFolder, String identifier, String placeholder) throws IOException {
          var batchIndex = new AtomicInteger();
  
          // Replace large files (except the index) with placeholders
          try (var files = Files.walk(webrevFolder)) {
<span class="line-modified">!             files.filter(Files::isRegularFile)</span>
<span class="line-modified">!                  .filter(this::shouldBeReplaced)</span>
<span class="line-modified">!                  .forEach(file -&gt; replaceContent(file, placeholder));</span>
          }
  
          // Try to push 1000 files at a time
          try (var files = Files.walk(webrevFolder)) {
              var batches = files.filter(Files::isRegularFile)
</pre>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>