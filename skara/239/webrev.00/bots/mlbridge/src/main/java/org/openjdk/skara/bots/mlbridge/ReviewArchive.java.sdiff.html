<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/ReviewArchive.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ArchiveWorkItem.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/ReviewArchive.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  4 import org.openjdk.skara.email.*;
  5 import org.openjdk.skara.forge.*;
  6 import org.openjdk.skara.host.*;
  7 import org.openjdk.skara.issuetracker.Comment;
  8 import org.openjdk.skara.vcs.Hash;
  9 
 10 import java.net.URI;
 11 import java.nio.charset.StandardCharsets;
 12 import java.security.*;
 13 import java.util.*;
 14 import java.util.stream.*;
 15 
 16 class ReviewArchive {
 17     private final PullRequestInstance prInstance;
 18     private final CensusInstance censusInstance;
 19     private final EmailAddress sender;
 20     private final List&lt;Email&gt; existing;
 21     private final Map&lt;String, Email&gt; existingIds = new HashMap&lt;&gt;();
 22     private final List&lt;Email&gt; generated = new ArrayList&lt;&gt;();
 23     private final Map&lt;String, Email&gt; generatedIds = new HashMap&lt;&gt;();

 24     private final List&lt;Hash&gt; reportedHeads;
 25     private final List&lt;Hash&gt; reportedBases;
 26 
 27     private EmailAddress getAuthorAddress(HostUser originalAuthor) {
 28         var contributor = censusInstance.namespace().get(originalAuthor.id());
 29         if (contributor == null) {
 30             return EmailAddress.from(originalAuthor.fullName(),
 31                                      censusInstance.namespace().name() + &quot;+&quot; +
 32                                              originalAuthor.id() + &quot;+&quot; + originalAuthor.userName() + &quot;@&quot; +
 33                                              censusInstance.configuration().census().domain());
 34         } else {
 35             return EmailAddress.from(contributor.fullName().orElse(originalAuthor.fullName()),
 36                                      contributor.username() + &quot;@&quot; + censusInstance.configuration().census().domain());
 37         }
 38     }
 39 
 40     private EmailAddress getUniqueMessageId(String identifier) {
 41         try {
 42             var prSpecific = prInstance.pr().repository().name().replace(&quot;/&quot;, &quot;.&quot;) + &quot;.&quot; + prInstance.id();
 43             var digest = MessageDigest.getInstance(&quot;SHA-256&quot;);
</pre>
<hr />
<pre>
310     private String projectRole(Contributor contributor) {
311         var version = censusInstance.configuration().census().version();
312         if (censusInstance.project().isLead(contributor.username(), version)) {
313             return &quot;Lead&quot;;
314         } else if (censusInstance.project().isReviewer(contributor.username(), version)) {
315             return &quot;Reviewer&quot;;
316         } else if (censusInstance.project().isCommitter(contributor.username(), version)) {
317             return &quot;Committer&quot;;
318         } else if (censusInstance.project().isAuthor(contributor.username(), version)) {
319             return &quot;Author&quot;;
320         }
321         return &quot;none&quot;;
322     }
323 
324     void addReview(Review review) {
325         var id = getMessageId(review);
326         if (existingIds.containsKey(getStableMessageId(id))) {
327             return;
328         }
329 















330         var contributor = censusInstance.namespace().get(review.reviewer().id());
331         var isReviewer = contributor != null &amp;&amp; censusInstance.project().isReviewer(contributor.username(), censusInstance.configuration().census().version());
332 
333         // Default parent and subject
334         var parent = topCommentForHash(review.hash());
335         var subject = parent.subject();
336 
337         // Approvals by Reviewers get special treatment - post these as top-level comments
338         if (review.verdict() == Review.Verdict.APPROVED &amp;&amp; isReviewer) {
<span class="line-modified">339             parent = topEmail();</span>
<span class="line-removed">340             subject = &quot;Re: [Approved] &quot; + &quot;RFR: &quot; + prInstance.pr().title();</span>
341         }
342 
343         var userName = contributor != null ? contributor.username() : review.reviewer().userName() + &quot;@&quot; + censusInstance.namespace().name();
344         var userRole = contributor != null ? projectRole(contributor) : &quot;no project role&quot;;
<span class="line-modified">345         var replyBody = ArchiveMessages.reviewCommentBody(review.body().orElse(&quot;&quot;), review.verdict(), userName, userRole);</span>
346 
347         addReplyCommon(parent, review.reviewer(), subject, replyBody, id);
348     }
349 
350     void addReviewComment(ReviewComment reviewComment) {
351         var id = getMessageId(reviewComment);
352         if (existingIds.containsKey(getStableMessageId(id))) {
353             return;
354         }
355 
356         var parent = parentForReviewComment(reviewComment);
357         var body = new StringBuilder();
358 
359         // Add some context to the first post
360         if (reviewComment.parent().isEmpty()) {
361             var contents = prInstance.pr().repository().fileContents(reviewComment.path(), reviewComment.hash().hex()).lines().collect(Collectors.toList());
362 
363             body.append(reviewComment.path()).append(&quot; line &quot;).append(reviewComment.line()).append(&quot;:\n\n&quot;);
364             for (int i = Math.max(0, reviewComment.line() - 2); i &lt; Math.min(contents.size(), reviewComment.line() + 1); ++i) {
365                 body.append(&quot;&gt; &quot;).append(i + 1).append(&quot;: &quot;).append(contents.get(i)).append(&quot;\n&quot;);
366             }
367             body.append(&quot;\n&quot;);
368         }
369         body.append(reviewComment.body());
370 
371         addReplyCommon(parent, reviewComment.author(), parent.subject(), body.toString(), id);
372     }
373 
374     List&lt;Email&gt; generatedEmails() {
<span class="line-modified">375         return generated;</span>














376     }
377 }
</pre>
</td>
<td>
<hr />
<pre>
  4 import org.openjdk.skara.email.*;
  5 import org.openjdk.skara.forge.*;
  6 import org.openjdk.skara.host.*;
  7 import org.openjdk.skara.issuetracker.Comment;
  8 import org.openjdk.skara.vcs.Hash;
  9 
 10 import java.net.URI;
 11 import java.nio.charset.StandardCharsets;
 12 import java.security.*;
 13 import java.util.*;
 14 import java.util.stream.*;
 15 
 16 class ReviewArchive {
 17     private final PullRequestInstance prInstance;
 18     private final CensusInstance censusInstance;
 19     private final EmailAddress sender;
 20     private final List&lt;Email&gt; existing;
 21     private final Map&lt;String, Email&gt; existingIds = new HashMap&lt;&gt;();
 22     private final List&lt;Email&gt; generated = new ArrayList&lt;&gt;();
 23     private final Map&lt;String, Email&gt; generatedIds = new HashMap&lt;&gt;();
<span class="line-added"> 24     private final Set&lt;EmailAddress&gt; approvalIds = new HashSet&lt;&gt;();</span>
 25     private final List&lt;Hash&gt; reportedHeads;
 26     private final List&lt;Hash&gt; reportedBases;
 27 
 28     private EmailAddress getAuthorAddress(HostUser originalAuthor) {
 29         var contributor = censusInstance.namespace().get(originalAuthor.id());
 30         if (contributor == null) {
 31             return EmailAddress.from(originalAuthor.fullName(),
 32                                      censusInstance.namespace().name() + &quot;+&quot; +
 33                                              originalAuthor.id() + &quot;+&quot; + originalAuthor.userName() + &quot;@&quot; +
 34                                              censusInstance.configuration().census().domain());
 35         } else {
 36             return EmailAddress.from(contributor.fullName().orElse(originalAuthor.fullName()),
 37                                      contributor.username() + &quot;@&quot; + censusInstance.configuration().census().domain());
 38         }
 39     }
 40 
 41     private EmailAddress getUniqueMessageId(String identifier) {
 42         try {
 43             var prSpecific = prInstance.pr().repository().name().replace(&quot;/&quot;, &quot;.&quot;) + &quot;.&quot; + prInstance.id();
 44             var digest = MessageDigest.getInstance(&quot;SHA-256&quot;);
</pre>
<hr />
<pre>
311     private String projectRole(Contributor contributor) {
312         var version = censusInstance.configuration().census().version();
313         if (censusInstance.project().isLead(contributor.username(), version)) {
314             return &quot;Lead&quot;;
315         } else if (censusInstance.project().isReviewer(contributor.username(), version)) {
316             return &quot;Reviewer&quot;;
317         } else if (censusInstance.project().isCommitter(contributor.username(), version)) {
318             return &quot;Committer&quot;;
319         } else if (censusInstance.project().isAuthor(contributor.username(), version)) {
320             return &quot;Author&quot;;
321         }
322         return &quot;none&quot;;
323     }
324 
325     void addReview(Review review) {
326         var id = getMessageId(review);
327         if (existingIds.containsKey(getStableMessageId(id))) {
328             return;
329         }
330 
<span class="line-added">331         // Default parent and subject</span>
<span class="line-added">332         var parent = topCommentForHash(review.hash());</span>
<span class="line-added">333         var subject = parent.subject();</span>
<span class="line-added">334 </span>
<span class="line-added">335         var replyBody = ArchiveMessages.reviewCommentBody(review.body().orElse(&quot;&quot;));</span>
<span class="line-added">336 </span>
<span class="line-added">337         addReplyCommon(parent, review.reviewer(), subject, replyBody, id);</span>
<span class="line-added">338     }</span>
<span class="line-added">339 </span>
<span class="line-added">340     void addReviewVerdict(Review review) {</span>
<span class="line-added">341         var id = getMessageId(review);</span>
<span class="line-added">342         if (existingIds.containsKey(getStableMessageId(id))) {</span>
<span class="line-added">343             return;</span>
<span class="line-added">344         }</span>
<span class="line-added">345 </span>
346         var contributor = censusInstance.namespace().get(review.reviewer().id());
347         var isReviewer = contributor != null &amp;&amp; censusInstance.project().isReviewer(contributor.username(), censusInstance.configuration().census().version());
348 
349         // Default parent and subject
350         var parent = topCommentForHash(review.hash());
351         var subject = parent.subject();
352 
353         // Approvals by Reviewers get special treatment - post these as top-level comments
354         if (review.verdict() == Review.Verdict.APPROVED &amp;&amp; isReviewer) {
<span class="line-modified">355             approvalIds.add(id);</span>

356         }
357 
358         var userName = contributor != null ? contributor.username() : review.reviewer().userName() + &quot;@&quot; + censusInstance.namespace().name();
359         var userRole = contributor != null ? projectRole(contributor) : &quot;no project role&quot;;
<span class="line-modified">360         var replyBody = ArchiveMessages.reviewVerdictBody(review.body().orElse(&quot;&quot;), review.verdict(), userName, userRole);</span>
361 
362         addReplyCommon(parent, review.reviewer(), subject, replyBody, id);
363     }
364 
365     void addReviewComment(ReviewComment reviewComment) {
366         var id = getMessageId(reviewComment);
367         if (existingIds.containsKey(getStableMessageId(id))) {
368             return;
369         }
370 
371         var parent = parentForReviewComment(reviewComment);
372         var body = new StringBuilder();
373 
374         // Add some context to the first post
375         if (reviewComment.parent().isEmpty()) {
376             var contents = prInstance.pr().repository().fileContents(reviewComment.path(), reviewComment.hash().hex()).lines().collect(Collectors.toList());
377 
378             body.append(reviewComment.path()).append(&quot; line &quot;).append(reviewComment.line()).append(&quot;:\n\n&quot;);
379             for (int i = Math.max(0, reviewComment.line() - 2); i &lt; Math.min(contents.size(), reviewComment.line() + 1); ++i) {
380                 body.append(&quot;&gt; &quot;).append(i + 1).append(&quot;: &quot;).append(contents.get(i)).append(&quot;\n&quot;);
381             }
382             body.append(&quot;\n&quot;);
383         }
384         body.append(reviewComment.body());
385 
386         addReplyCommon(parent, reviewComment.author(), parent.subject(), body.toString(), id);
387     }
388 
389     List&lt;Email&gt; generatedEmails() {
<span class="line-modified">390         var finalEmails = new ArrayList&lt;Email&gt;();</span>
<span class="line-added">391         for (var email : generated) {</span>
<span class="line-added">392             for (var approvalId : approvalIds) {</span>
<span class="line-added">393                 var collapsed = email.hasHeader(&quot;PR-Collapsed-IDs&quot;) ? email.headerValue(&quot;PR-Collapsed-IDs&quot;) + &quot; &quot; : &quot;&quot;;</span>
<span class="line-added">394                 if (email.id().equals(approvalId) || collapsed.contains(getStableMessageId(approvalId))) {</span>
<span class="line-added">395                     email = Email.reparent(topEmail(), email)</span>
<span class="line-added">396                                  .subject(&quot;Re: [Approved] &quot; + &quot;RFR: &quot; + prInstance.pr().title())</span>
<span class="line-added">397                                  .build();</span>
<span class="line-added">398                     break;</span>
<span class="line-added">399                 }</span>
<span class="line-added">400             }</span>
<span class="line-added">401             finalEmails.add(email);</span>
<span class="line-added">402         }</span>
<span class="line-added">403 </span>
<span class="line-added">404         return finalEmails;</span>
405     }
406 }
</pre>
</td>
</tr>
</table>
<center><a href="ArchiveWorkItem.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>