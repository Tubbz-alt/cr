<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/pr/src/test/java/org/openjdk/skara/bots/pr/CheckTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/pr/SummaryCommand.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="CommandTests.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/pr/src/test/java/org/openjdk/skara/bots/pr/CheckTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  30 import java.io.IOException;
  31 import java.nio.charset.StandardCharsets;
  32 import java.nio.file.*;
  33 import java.util.*;
  34 import java.util.regex.Pattern;
  35 
  36 import static org.junit.jupiter.api.Assertions.*;
  37 import static org.junit.jupiter.api.Assumptions.assumeTrue;
  38 
  39 class CheckTests {
  40     @Test
  41     void simpleCommit(TestInfo testInfo) throws IOException {
  42         try (var credentials = new HostCredentials(testInfo);
  43              var tempFolder = new TemporaryDirectory()) {
  44             var author = credentials.getHostedRepository();
  45             var reviewer = credentials.getHostedRepository();
  46 
  47             var censusBuilder = credentials.getCensusBuilder()
  48                                            .addAuthor(author.forge().currentUser().id())
  49                                            .addReviewer(reviewer.forge().currentUser().id());
<span class="line-modified">  50             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);</span>
  51 
  52             // Populate the projects repository
  53             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
  54             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
  55             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
  56 
  57             // Make a change with a corresponding PR
  58             var editHash = CheckableRepository.appendAndCommit(localRepo);
  59             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
  60             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
  61 
  62             // Check the status
  63             TestBotRunner.runPeriodicItems(checkBot);
  64 
  65             // Verify that the check succeeded
  66             var checks = pr.checks(editHash);
  67             assertEquals(1, checks.size());
  68             var check = checks.get(&quot;jcheck&quot;);
  69             assertEquals(CheckStatus.SUCCESS, check.status());
  70 
  71             // The PR should now be ready for review
  72             assertTrue(pr.labels().contains(&quot;rfr&quot;));
  73             assertFalse(pr.labels().contains(&quot;ready&quot;));
  74 
  75             // Approve it as another user
  76             var approvalPr = reviewer.pullRequest(pr.id());
  77             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
  78 
  79             // Check the status again
  80             TestBotRunner.runPeriodicItems(checkBot);
  81 
  82             // The check should now be successful
  83             checks = pr.checks(editHash);
  84             assertEquals(1, checks.size());
  85             check = checks.get(&quot;jcheck&quot;);
  86             assertEquals(CheckStatus.SUCCESS, check.status());
  87 
<span class="line-modified">  88             // The PR should not be flagged as ready for review, at it is already reviewed</span>
<span class="line-removed">  89             assertFalse(pr.labels().contains(&quot;rfr&quot;));</span>
  90             assertTrue(pr.labels().contains(&quot;ready&quot;));
  91         }
  92     }
  93 
  94     @Test
  95     void whitespaceIssue(TestInfo testInfo) throws IOException {
  96         try (var credentials = new HostCredentials(testInfo);
  97              var tempFolder = new TemporaryDirectory()) {
  98 
  99             var author = credentials.getHostedRepository();
 100             var reviewer = credentials.getHostedRepository();
 101 
 102             var censusBuilder = credentials.getCensusBuilder()
 103                                            .addAuthor(author.forge().currentUser().id())
 104                                            .addReviewer(reviewer.forge().currentUser().id());
<span class="line-modified"> 105             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);</span>
 106 
 107             // Populate the projects repository
 108             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 109             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 110             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 111 
 112             // Make a change with a corresponding PR
 113             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line with a trailing whitespace   &quot;);
 114             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 115             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 116 
 117             // Check the status
 118             TestBotRunner.runPeriodicItems(checkBot);
 119 
 120             // The PR should not be flagged as ready for review
 121             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 122 
 123             // Approve it as another user
 124             var approvalPr = reviewer.pullRequest(pr.id());
 125             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
</pre>
<hr />
<pre>
 136             // The PR should not still not be flagged as ready for review
 137             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 138 
 139             // Remove the trailing whitespace in a new commit
 140             editHash = CheckableRepository.replaceAndCommit(localRepo, &quot;A line without a trailing whitespace&quot;);
 141             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 142 
 143             // Make sure that the push registered
 144             var lastHeadHash = pr.headHash();
 145             var refreshCount = 0;
 146             do {
 147                 pr = author.pullRequest(pr.id());
 148                 if (refreshCount++ &gt; 100) {
 149                     fail(&quot;The PR did not update after the new push&quot;);
 150                 }
 151             } while (pr.headHash().equals(lastHeadHash));
 152 
 153             // Check the status again
 154             TestBotRunner.runPeriodicItems(checkBot);
 155 
<span class="line-modified"> 156             // The PR should not be flagged as ready for review, at it is already reviewed</span>
<span class="line-modified"> 157             assertFalse(pr.labels().contains(&quot;rfr&quot;));</span>
 158 
 159             // The check should now be successful
 160             checks = pr.checks(editHash);
 161             assertEquals(1, checks.size());
 162             check = checks.get(&quot;jcheck&quot;);
 163             assertEquals(CheckStatus.SUCCESS, check.status());
 164         }
 165     }
 166 
 167     @Test
 168     void multipleReviews(TestInfo testInfo) throws IOException {
 169         try (var credentials = new HostCredentials(testInfo);
 170              var tempFolder = new TemporaryDirectory()) {
 171 
 172             var author = credentials.getHostedRepository();
 173             var reviewer = credentials.getHostedRepository();
 174             var commenter = credentials.getHostedRepository();
 175 
 176             var censusBuilder = credentials.getCensusBuilder()
 177                                            .addAuthor(author.forge().currentUser().id())
 178                                            .addReviewer(reviewer.forge().currentUser().id())
 179                                            .addReviewer(commenter.forge().currentUser().id());
 180 
<span class="line-modified"> 181             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);</span>
 182 
 183             // Populate the projects repository
 184             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 185             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 186             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 187 
 188             // Make a change with a corresponding PR
 189             var editHash = CheckableRepository.appendAndCommit(localRepo);
 190             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 191             var authorPr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 192 
 193             // Let the status bot inspect the PR
 194             TestBotRunner.runPeriodicItems(checkBot);
 195             assertFalse(authorPr.body().contains(&quot;Approvers&quot;));
 196 
 197             // Approve it
 198             var reviewerPr = reviewer.pullRequest(authorPr.id());
 199             reviewerPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 200             TestBotRunner.runPeriodicItems(checkBot);
 201 
</pre>
<hr />
<pre>
 240 
 241             // Refresh the PR and check that it still only approved once (but two reviews) and is no longer stale
 242             authorPr = author.pullRequest(authorPr.id());
 243             assertTrue(authorPr.body().contains(&quot;Approvers&quot;));
 244             assertEquals(1, authorPr.body().split(&quot;Generated Reviewer&quot;, -1).length - 1);
 245             assertTrue(authorPr.reviews().size() &gt;= 2);
 246             assertFalse(authorPr.body().contains(&quot;Note&quot;));
 247         }
 248     }
 249 
 250     @Test
 251     void selfReview(TestInfo testInfo) throws IOException {
 252         try (var credentials = new HostCredentials(testInfo);
 253              var tempFolder = new TemporaryDirectory()) {
 254 
 255             var author = credentials.getHostedRepository();
 256 
 257             var censusBuilder = credentials.getCensusBuilder()
 258                                            .addReviewer(author.forge().currentUser().id());
 259 
<span class="line-modified"> 260             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);</span>
 261 
 262             // Populate the projects repository
 263             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 264             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 265             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 266 
 267             // Make a change with a corresponding PR
 268             var editHash = CheckableRepository.appendAndCommit(localRepo);
 269             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 270             var authorPr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 271 
 272             // Let the status bot inspect the PR
 273             TestBotRunner.runPeriodicItems(checkBot);
 274             assertFalse(authorPr.body().contains(&quot;Approvers&quot;));
 275 
 276             // Approve it
 277             authorPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 278             TestBotRunner.runPeriodicItems(checkBot);
 279 
 280             // Refresh the PR and check that it has been approved
 281             authorPr = author.pullRequest(authorPr.id());
 282             assertTrue(authorPr.body().contains(&quot;Approvers&quot;));
 283 
 284             // Verify that the check failed
 285             var checks = authorPr.checks(editHash);
 286             assertEquals(1, checks.size());
 287             var check = checks.get(&quot;jcheck&quot;);
 288             assertEquals(CheckStatus.FAILURE, check.status());
 289         }
 290     }
 291 
 292     @Test
 293     void multipleCommitters(TestInfo testInfo) throws IOException {
 294         try (var credentials = new HostCredentials(testInfo);
 295              var tempFolder = new TemporaryDirectory()) {
 296             var author = credentials.getHostedRepository();
 297             var reviewer = credentials.getHostedRepository();
 298 
 299             var censusBuilder = credentials.getCensusBuilder()
 300                                            .addReviewer(reviewer.forge().currentUser().id());
<span class="line-modified"> 301             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);</span>
 302 
 303             // Populate the projects repository
 304             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 305             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 306             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 307 
 308             // Make two changes with different authors
 309             CheckableRepository.appendAndCommit(localRepo, &quot;First edit&quot;, &quot;Edit by number 1&quot;,
 310                                                 &quot;number1&quot;, &quot;number1@none.none&quot;);
 311             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Second edit&quot;, &quot;Edit by number 2&quot;,
 312                                                                &quot;number2&quot;, &quot;number2@none.none&quot;);
 313             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 314             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 315 
 316             // Check the status
 317             TestBotRunner.runPeriodicItems(checkBot);
 318 
 319             // Verify that the check failed
 320             var checks = pr.checks(editHash);
 321             assertEquals(1, checks.size());
</pre>
<hr />
<pre>
 333             checks = pr.checks(editHash);
 334             assertEquals(1, checks.size());
 335             check = checks.get(&quot;jcheck&quot;);
 336             assertEquals(CheckStatus.FAILURE, check.status());
 337 
 338             // The PR should not be flagged as ready for review, as multiple committers is a problem
 339             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 340         }
 341     }
 342 
 343     @Test
 344     void updatedContentFailsCheck(TestInfo testInfo) throws IOException {
 345         try (var credentials = new HostCredentials(testInfo);
 346              var tempFolder = new TemporaryDirectory()) {
 347             var author = credentials.getHostedRepository();
 348             var reviewer = credentials.getHostedRepository();
 349 
 350             var censusBuilder = credentials.getCensusBuilder()
 351                                            .addAuthor(author.forge().currentUser().id())
 352                                            .addReviewer(reviewer.forge().currentUser().id());
<span class="line-modified"> 353             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);</span>
 354 
 355             // Populate the projects repository
 356             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 357             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 358             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 359 
 360             // Make a change with a corresponding PR
 361             var editHash = CheckableRepository.appendAndCommit(localRepo);
 362             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 363             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 364 
 365             // Check the status
 366             TestBotRunner.runPeriodicItems(checkBot);
 367 
 368             // Verify that the check passed
 369             var checks = pr.checks(editHash);
 370             assertEquals(1, checks.size());
 371             var check = checks.get(&quot;jcheck&quot;);
 372             assertEquals(CheckStatus.SUCCESS, check.status());
 373 
 374             // The PR should now be ready for review
 375             assertTrue(pr.labels().contains(&quot;rfr&quot;));
 376             assertFalse(pr.labels().contains(&quot;ready&quot;));
 377 
 378             // Approve it as another user
 379             var approvalPr = reviewer.pullRequest(pr.id());
 380             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 381 
 382             // Check the status again
 383             TestBotRunner.runPeriodicItems(checkBot);
 384 
 385             // The check should now be successful
 386             checks = pr.checks(editHash);
 387             assertEquals(1, checks.size());
 388             check = checks.get(&quot;jcheck&quot;);
 389             assertEquals(CheckStatus.SUCCESS, check.status());
 390 
<span class="line-modified"> 391             // The PR should not be flagged as ready for review, at it is already reviewed</span>
<span class="line-modified"> 392             assertFalse(pr.labels().contains(&quot;rfr&quot;));</span>
 393             assertTrue(pr.labels().contains(&quot;ready&quot;));
 394 
 395             var addedHash = CheckableRepository.appendAndCommit(localRepo, &quot;trailing whitespace   &quot;);
 396             localRepo.push(addedHash, author.url(), &quot;edit&quot;);
 397 
 398             // Make sure that the push registered
 399             var lastHeadHash = pr.headHash();
 400             var refreshCount = 0;
 401             do {
 402                 pr = author.pullRequest(pr.id());
 403                 if (refreshCount++ &gt; 100) {
 404                     fail(&quot;The PR did not update after the new push&quot;);
 405                 }
 406             } while (pr.headHash().equals(lastHeadHash));
 407 
 408             // Check the status
 409             TestBotRunner.runPeriodicItems(checkBot);
 410 
 411             // The PR is now neither ready for review nor integration
 412             assertFalse(pr.labels().contains(&quot;rfr&quot;));
</pre>
<hr />
<pre>
 416             checks = pr.checks(addedHash);
 417             assertEquals(1, checks.size());
 418             check = checks.get(&quot;jcheck&quot;);
 419             assertEquals(CheckStatus.FAILURE, check.status());
 420         }
 421     }
 422 
 423     @Test
 424     void individualReviewComments(TestInfo testInfo) throws IOException {
 425         try (var credentials = new HostCredentials(testInfo);
 426              var tempFolder = new TemporaryDirectory()) {
 427             var author = credentials.getHostedRepository();
 428             var reviewer = credentials.getHostedRepository();
 429 
 430             // This test is only relevant on hosts not supporting proper review comment bodies
 431             assumeTrue(!author.forge().supportsReviewBody());
 432 
 433             var censusBuilder = credentials.getCensusBuilder()
 434                                            .addAuthor(author.forge().currentUser().id())
 435                                            .addReviewer(reviewer.forge().currentUser().id());
<span class="line-modified"> 436             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);</span>
 437 
 438             // Populate the projects repository
 439             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 440             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 441             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 442 
 443             // Make a change with a corresponding PR
 444             var editHash = CheckableRepository.appendAndCommit(localRepo);
 445             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 446             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 447 
 448             // Check the status
 449             TestBotRunner.runPeriodicItems(checkBot);
 450             var comments = pr.comments();
 451             var commentCount = comments.size();
 452 
 453             // Approve it as another user
 454             var approvalPr = reviewer.pullRequest(pr.id());
 455             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 456 
</pre>
<hr />
<pre>
 478             assertTrue(comment.body().contains(&quot;comment&quot;));
 479 
 480             // No changes should not generate additional comments
 481             TestBotRunner.runPeriodicItems(checkBot);
 482             comments = pr.comments();
 483             assertEquals(commentCount + 3, comments.size());
 484         }
 485     }
 486 
 487     @Test
 488     void mergeMessage(TestInfo testInfo) throws IOException {
 489         try (var credentials = new HostCredentials(testInfo);
 490              var tempFolder = new TemporaryDirectory();
 491              var pushedFolder = new TemporaryDirectory()) {
 492 
 493             var author = credentials.getHostedRepository();
 494             var integrator = credentials.getHostedRepository();
 495             var censusBuilder = credentials.getCensusBuilder()
 496                                            .addCommitter(author.forge().currentUser().id())
 497                                            .addReviewer(integrator.forge().currentUser().id());
<span class="line-modified"> 498             var mergeBot = new PullRequestBot(integrator, censusBuilder.build(), &quot;master&quot;);</span>
 499 
 500             // Populate the projects repository
 501             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 502             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 503             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
 504             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 505 
 506             // Make a change with a corresponding PR
 507             var editHash = CheckableRepository.appendAndCommit(localRepo);
 508             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 509             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 510 
 511             // Approve it as another user
 512             var approvalPr = integrator.pullRequest(pr.id());
 513             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 514 
 515             // Get all messages up to date
 516             TestBotRunner.runPeriodicItems(mergeBot);
 517 
 518             // Push something unrelated to master
</pre>
<hr />
<pre>
 529             // The bot should reply with an ok message
 530             var updated = pr.comments().stream()
 531                             .filter(comment -&gt; comment.body().contains(&quot;there has been 1 commit&quot;))
 532                             .filter(comment -&gt; comment.body().contains(&quot;please merge&quot;))
 533                             .count();
 534             assertEquals(1, updated);
 535         }
 536     }
 537 
 538     @Test
 539     void cannotRebase(TestInfo testInfo) throws IOException {
 540         try (var credentials = new HostCredentials(testInfo);
 541              var tempFolder = new TemporaryDirectory();
 542              var pushedFolder = new TemporaryDirectory()) {
 543 
 544             var author = credentials.getHostedRepository();
 545             var integrator = credentials.getHostedRepository();
 546             var censusBuilder = credentials.getCensusBuilder()
 547                                            .addCommitter(author.forge().currentUser().id())
 548                                            .addReviewer(integrator.forge().currentUser().id());
<span class="line-modified"> 549             var mergeBot = new PullRequestBot(integrator, censusBuilder.build(), &quot;master&quot;);</span>
 550 
 551             // Populate the projects repository
 552             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 553             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 554             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
 555             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 556 
 557             // Make a change with a corresponding PR
 558             var editHash = CheckableRepository.appendAndCommit(localRepo);
 559             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 560             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 561 
 562             // Approve it as another user
 563             var approvalPr = integrator.pullRequest(pr.id());
 564             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 565 
 566             // Get all messages up to date
 567             TestBotRunner.runPeriodicItems(mergeBot);
 568 
 569             // Push something conflicting to master
</pre>
<hr />
<pre>
 600             updated = pr.comments().stream()
 601                         .filter(comment -&gt; comment.body().contains(&quot;change now passes all automated&quot;))
 602                         .count();
 603             assertEquals(1, updated);
 604 
 605             // The PR should not be flagged as outdated
 606             assertFalse(pr.labels().contains(&quot;outdated&quot;));
 607         }
 608     }
 609 
 610     @Test
 611     void blockingLabel(TestInfo testInfo) throws IOException {
 612         try (var credentials = new HostCredentials(testInfo);
 613              var tempFolder = new TemporaryDirectory()) {
 614             var author = credentials.getHostedRepository();
 615             var reviewer = credentials.getHostedRepository();
 616 
 617             var censusBuilder = credentials.getCensusBuilder()
 618                                            .addAuthor(author.forge().currentUser().id())
 619                                            .addReviewer(reviewer.forge().currentUser().id());
<span class="line-modified"> 620             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;, Map.of(), Map.of(),</span>
<span class="line-removed"> 621                                               Map.of(&quot;block&quot;, &quot;Test Blocker&quot;), Set.of(), Map.of());</span>
 622 
 623             // Populate the projects repository
 624             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 625             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 626             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 627 
 628             // Make a change with a corresponding PR
 629             var editHash = CheckableRepository.appendAndCommit(localRepo);
 630             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 631             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 632             pr.addLabel(&quot;block&quot;);
 633 
 634             // Check the status
 635             TestBotRunner.runPeriodicItems(checkBot);
 636 
 637             // Verify that the check failed
 638             var checks = pr.checks(editHash);
 639             assertEquals(1, checks.size());
 640             var check = checks.get(&quot;jcheck&quot;);
 641             assertEquals(CheckStatus.FAILURE, check.status());
</pre>
<hr />
<pre>
 649             // Check the status again
 650             pr.removeLabel(&quot;block&quot;);
 651             TestBotRunner.runPeriodicItems(checkBot);
 652 
 653             // The PR should now be ready for review
 654             assertTrue(pr.labels().contains(&quot;rfr&quot;));
 655             assertFalse(pr.labels().contains(&quot;ready&quot;));
 656         }
 657     }
 658 
 659     @Test
 660     void missingReadyLabel(TestInfo testInfo) throws IOException {
 661         try (var credentials = new HostCredentials(testInfo);
 662              var tempFolder = new TemporaryDirectory()) {
 663             var author = credentials.getHostedRepository();
 664             var reviewer = credentials.getHostedRepository();
 665 
 666             var censusBuilder = credentials.getCensusBuilder()
 667                                            .addAuthor(author.forge().currentUser().id())
 668                                            .addReviewer(reviewer.forge().currentUser().id());
<span class="line-modified"> 669             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;, Map.of(), Map.of(),</span>
<span class="line-removed"> 670                                               Map.of(), Set.of(&quot;good-to-go&quot;), Map.of());</span>
 671 
 672             // Populate the projects repository
 673             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 674             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 675             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 676 
 677             // Make a change with a corresponding PR
 678             var editHash = CheckableRepository.appendAndCommit(localRepo);
 679             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 680             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 681 
 682             // Check the status
 683             TestBotRunner.runPeriodicItems(checkBot);
 684 
 685             // Verify that no checks have been run
 686             var checks = pr.checks(editHash);
 687             assertEquals(0, checks.size());
 688 
 689             // The PR should not yet be ready for review
 690             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 691 
 692             // Check the status again
 693             pr.addLabel(&quot;good-to-go&quot;);
 694             TestBotRunner.runPeriodicItems(checkBot);
 695 
 696             // The PR should now be ready for review
 697             assertTrue(pr.labels().contains(&quot;rfr&quot;));
 698         }
 699     }
 700 
 701     @Test
 702     void missingReadyComment(TestInfo testInfo) throws IOException {
 703         try (var credentials = new HostCredentials(testInfo);
 704              var tempFolder = new TemporaryDirectory()) {
 705             var author = credentials.getHostedRepository();
 706             var reviewer = credentials.getHostedRepository();
 707 
 708             var censusBuilder = credentials.getCensusBuilder()
 709                                            .addAuthor(author.forge().currentUser().id())
 710                                            .addReviewer(reviewer.forge().currentUser().id());
<span class="line-modified"> 711             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;, Map.of(), Map.of(),</span>
<span class="line-removed"> 712                                               Map.of(), Set.of(), Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;proceed&quot;)));</span>
 713 
 714             // Populate the projects repository
 715             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 716             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 717             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 718 
 719             // Make a change with a corresponding PR
 720             var editHash = CheckableRepository.appendAndCommit(localRepo);
 721             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 722             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 723 
 724             // Check the status
 725             TestBotRunner.runPeriodicItems(checkBot);
 726 
 727             // Verify that no checks have been run
 728             var checks = pr.checks(editHash);
 729             assertEquals(0, checks.size());
 730 
 731             // The PR should not yet be ready for review
 732             assertFalse(pr.labels().contains(&quot;rfr&quot;));
</pre>
<hr />
<pre>
 734             // Check the status again
 735             var reviewerPr = reviewer.pullRequest(pr.id());
 736             reviewerPr.addComment(&quot;proceed&quot;);
 737             TestBotRunner.runPeriodicItems(checkBot);
 738 
 739             // The PR should now be ready for review
 740             assertTrue(pr.labels().contains(&quot;rfr&quot;));
 741         }
 742     }
 743 
 744     @Test
 745     void issueIssue(TestInfo testInfo) throws IOException {
 746         try (var credentials = new HostCredentials(testInfo);
 747              var tempFolder = new TemporaryDirectory()) {
 748             var author = credentials.getHostedRepository();
 749             var reviewer = credentials.getHostedRepository();
 750 
 751             var censusBuilder = credentials.getCensusBuilder()
 752                                            .addAuthor(author.forge().currentUser().id())
 753                                            .addReviewer(reviewer.forge().currentUser().id());
<span class="line-modified"> 754             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;, Map.of(), Map.of(),</span>
<span class="line-removed"> 755                                               Map.of(), Set.of(), Map.of());</span>
 756 
 757             // Populate the projects repository
 758             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), Path.of(&quot;appendable.txt&quot;),
 759                                                      Set.of(&quot;issues&quot;), null);
 760             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 761             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 762 
 763             // Make a change with a corresponding PR
 764             var editHash = CheckableRepository.appendAndCommit(localRepo);
 765             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 766             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 767 
 768             // Check the status
 769             TestBotRunner.runPeriodicItems(checkBot);
 770 
 771             // Verify that the check failed
 772             var checks = pr.checks(editHash);
 773             assertEquals(1, checks.size());
 774             var check = checks.get(&quot;jcheck&quot;);
 775             assertEquals(CheckStatus.FAILURE, check.status());
</pre>
<hr />
<pre>
 782 
 783             // The check should now be successful
 784             checks = pr.checks(editHash);
 785             assertEquals(1, checks.size());
 786             check = checks.get(&quot;jcheck&quot;);
 787             assertEquals(CheckStatus.SUCCESS, check.status());
 788         }
 789     }
 790 
 791     @Test
 792     void issueInSummary(TestInfo testInfo) throws IOException {
 793         try (var credentials = new HostCredentials(testInfo);
 794              var tempFolder = new TemporaryDirectory()) {
 795             var author = credentials.getHostedRepository();
 796             var reviewer = credentials.getHostedRepository();
 797             var issues = credentials.getIssueProject();
 798 
 799             var censusBuilder = credentials.getCensusBuilder()
 800                                            .addAuthor(author.forge().currentUser().id())
 801                                            .addReviewer(reviewer.forge().currentUser().id());
<span class="line-modified"> 802             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;, Map.of(), Map.of(),</span>
<span class="line-removed"> 803                                               Map.of(), Set.of(), Map.of(), issues);</span>
 804 
 805             // Populate the projects repository
 806             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), Path.of(&quot;appendable.txt&quot;),
 807                                                      Set.of(&quot;issues&quot;), null);
 808             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 809             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 810 
 811             var issue1 = issues.createIssue(&quot;My first issue&quot;, List.of(&quot;Hello&quot;), Map.of());
 812 
 813             // Make a change with a corresponding PR
 814             var editHash = CheckableRepository.appendAndCommit(localRepo);
 815             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 816             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, issue1.id() + &quot;: This is a pull request&quot;);
 817 
 818             // Check the status
 819             TestBotRunner.runPeriodicItems(checkBot);
 820 
 821             // The check should be successful
 822             var checks = pr.checks(editHash);
 823             assertEquals(1, checks.size());
</pre>
<hr />
<pre>
 914             pr.updateCheck(cancelled);
 915             checks = pr.checks(editHash);
 916             assertEquals(1, checks.size());
 917             retrieved = checks.get(&quot;jcheck&quot;);
 918             assertEquals(&quot;jcheck title&quot;, retrieved.title().get());
 919             assertEquals(&quot;jcheck summary&quot;, retrieved.summary().get());
 920             assertEquals(CheckStatus.CANCELLED, retrieved.status());
 921         }
 922     }
 923 
 924     @Test
 925     void rebaseBeforeCheck(TestInfo testInfo) throws IOException {
 926         try (var credentials = new HostCredentials(testInfo);
 927              var tempFolder = new TemporaryDirectory()) {
 928             var author = credentials.getHostedRepository();
 929             var reviewer = credentials.getHostedRepository();
 930 
 931             var censusBuilder = credentials.getCensusBuilder()
 932                                            .addAuthor(author.forge().currentUser().id())
 933                                            .addReviewer(reviewer.forge().currentUser().id());
<span class="line-modified"> 934             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);</span>
 935 
 936             // Populate the projects repository
 937             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 938             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 939             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 940 
 941             // Make a change with a corresponding PR
 942             var editHash = CheckableRepository.appendAndCommit(localRepo);
 943             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 944             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 945 
 946             // Enable a new check in the target branch
 947             localRepo.checkout(masterHash, true);
 948             CheckableRepository.init(tempFolder.path(), author.repositoryType(), Path.of(&quot;appendable.txt&quot;),
 949                                      Set.of(&quot;author&quot;, &quot;reviewers&quot;, &quot;whitespace&quot;, &quot;issues&quot;), null);
 950             var headHash = localRepo.resolve(&quot;HEAD&quot;).orElseThrow();
 951             localRepo.push(headHash, author.url(), &quot;master&quot;, true);
 952 
 953             // Check the status
 954             TestBotRunner.runPeriodicItems(checkBot);
</pre>
<hr />
<pre>
 965             TestBotRunner.runPeriodicItems(checkBot);
 966 
 967             // Verify that the check passed
 968             checks = pr.checks(editHash);
 969             assertEquals(1, checks.size());
 970             check = checks.get(&quot;jcheck&quot;);
 971             assertEquals(CheckStatus.SUCCESS, check.status());
 972         }
 973     }
 974 
 975     @Test
 976     void draft(TestInfo testInfo) throws IOException {
 977         try (var credentials = new HostCredentials(testInfo);
 978              var tempFolder = new TemporaryDirectory()) {
 979             var author = credentials.getHostedRepository();
 980             var reviewer = credentials.getHostedRepository();
 981 
 982             var censusBuilder = credentials.getCensusBuilder()
 983                                            .addAuthor(author.forge().currentUser().id())
 984                                            .addReviewer(reviewer.forge().currentUser().id());
<span class="line-modified"> 985             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);</span>
 986 
 987             // Populate the projects repository
 988             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 989             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 990             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 991 
 992             // Make a change with a corresponding PR
 993             var editHash = CheckableRepository.appendAndCommit(localRepo);
 994             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 995             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;,
 996                                                    &quot;This is a pull request&quot;, true);
 997 
 998             // Check the status
 999             TestBotRunner.runPeriodicItems(checkBot);
1000 
1001             // Verify that the check succeeded
1002             var checks = pr.checks(editHash);
1003             assertEquals(1, checks.size());
1004             var check = checks.get(&quot;jcheck&quot;);
1005             assertEquals(CheckStatus.SUCCESS, check.status());
1006 
1007             // The PR should still not be ready for review as it is a draft
1008             assertFalse(pr.labels().contains(&quot;rfr&quot;));
1009             assertFalse(pr.labels().contains(&quot;ready&quot;));
1010         }
1011     }
1012 
1013     @Test
1014     void excessiveFailures(TestInfo testInfo) throws IOException {
1015         try (var credentials = new HostCredentials(testInfo);
1016              var tempFolder = new TemporaryDirectory()) {
1017             var author = credentials.getHostedRepository();
1018             var reviewer = credentials.getHostedRepository();
1019 
1020             var censusBuilder = credentials.getCensusBuilder()
1021                                            .addAuthor(author.forge().currentUser().id())
1022                                            .addReviewer(reviewer.forge().currentUser().id());
<span class="line-modified">1023             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);</span>
1024 
1025             // Populate the projects repository
1026             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1027             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1028             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1029 
1030             // Make a change with a corresponding PR containing more errors than at least GitHub can handle in a check
1031             var badContent = &quot;\tline   \n&quot;.repeat(200);
1032             var editHash = CheckableRepository.appendAndCommit(localRepo, badContent);
1033             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
1034             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;,
1035                                                    &quot;This is a pull request&quot;, true);
1036 
1037             // Check the status
1038             TestBotRunner.runPeriodicItems(checkBot);
1039 
1040             // Verify that the check failed
1041             var checks = pr.checks(editHash);
1042             assertEquals(1, checks.size());
1043             var check = checks.get(&quot;jcheck&quot;);
1044             assertEquals(CheckStatus.FAILURE, check.status());
1045         }
1046     }
1047 
1048     @Test
1049     void retryOnException(TestInfo testInfo) throws IOException {
1050         try (var credentials = new HostCredentials(testInfo);
1051              var tempFolder = new TemporaryDirectory()) {
1052             var author = credentials.getHostedRepository();
1053             var reviewer = credentials.getHostedRepository();
1054 
1055             var censusBuilder = credentials.getCensusBuilder()
1056                                            .addAuthor(author.forge().currentUser().id())
1057                                            .addReviewer(reviewer.forge().currentUser().id());
<span class="line-modified">1058             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);</span>
1059 
1060             // Populate the projects repository
1061             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1062             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1063             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1064 
1065             // Break the jcheck configuration
1066             var confPath = tempFolder.path().resolve(&quot;.jcheck/conf&quot;);
1067             var oldConf = Files.readString(confPath, StandardCharsets.UTF_8);
1068             Files.writeString(confPath, &quot;Hello there!&quot;, StandardCharsets.UTF_8);
1069             localRepo.add(confPath);
1070             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A change&quot;);
1071             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1072             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;,
1073                                                    &quot;This is a pull request&quot;, true);
1074 
1075             // Check the status - should throw every time
1076             assertThrows(RuntimeException.class, () -&gt; TestBotRunner.runPeriodicItems(checkBot));
1077             assertThrows(RuntimeException.class, () -&gt; TestBotRunner.runPeriodicItems(checkBot));
1078             assertThrows(RuntimeException.class, () -&gt; TestBotRunner.runPeriodicItems(checkBot));
</pre>
<hr />
<pre>
1091             TestBotRunner.runPeriodicItems(checkBot);
1092 
1093             // Verify that the check now passes
1094             checks = pr.checks(editHash);
1095             assertEquals(1, checks.size());
1096             check = checks.get(&quot;jcheck&quot;);
1097             assertEquals(CheckStatus.SUCCESS, check.status());
1098         }
1099     }
1100 
1101     @Test
1102     void noCommit(TestInfo testInfo) throws IOException {
1103         try (var credentials = new HostCredentials(testInfo);
1104              var tempFolder = new TemporaryDirectory()) {
1105             var author = credentials.getHostedRepository();
1106             var reviewer = credentials.getHostedRepository();
1107 
1108             var censusBuilder = credentials.getCensusBuilder()
1109                                            .addAuthor(author.forge().currentUser().id())
1110                                            .addReviewer(reviewer.forge().currentUser().id());
<span class="line-modified">1111             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);</span>
1112 
1113             // Populate the projects repository
1114             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1115             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1116             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1117 
1118             // Make a change with a corresponding PR
1119             var editHash = CheckableRepository.appendAndCommit(localRepo);
1120             localRepo.push(editHash, author.url(), &quot;master&quot;);
1121             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1122             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1123 
1124             // Check the status
1125             TestBotRunner.runPeriodicItems(checkBot);
1126 
1127             // Verify that the check failed
1128             var checks = pr.checks(editHash);
1129             assertEquals(1, checks.size());
1130             var check = checks.get(&quot;jcheck&quot;);
1131             assertEquals(CheckStatus.FAILURE, check.status());
1132         }
1133     }



























































1134 }
</pre>
</td>
<td>
<hr />
<pre>
  30 import java.io.IOException;
  31 import java.nio.charset.StandardCharsets;
  32 import java.nio.file.*;
  33 import java.util.*;
  34 import java.util.regex.Pattern;
  35 
  36 import static org.junit.jupiter.api.Assertions.*;
  37 import static org.junit.jupiter.api.Assumptions.assumeTrue;
  38 
  39 class CheckTests {
  40     @Test
  41     void simpleCommit(TestInfo testInfo) throws IOException {
  42         try (var credentials = new HostCredentials(testInfo);
  43              var tempFolder = new TemporaryDirectory()) {
  44             var author = credentials.getHostedRepository();
  45             var reviewer = credentials.getHostedRepository();
  46 
  47             var censusBuilder = credentials.getCensusBuilder()
  48                                            .addAuthor(author.forge().currentUser().id())
  49                                            .addReviewer(reviewer.forge().currentUser().id());
<span class="line-modified">  50             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();</span>
  51 
  52             // Populate the projects repository
  53             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
  54             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
  55             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
  56 
  57             // Make a change with a corresponding PR
  58             var editHash = CheckableRepository.appendAndCommit(localRepo);
  59             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
  60             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
  61 
  62             // Check the status
  63             TestBotRunner.runPeriodicItems(checkBot);
  64 
  65             // Verify that the check succeeded
  66             var checks = pr.checks(editHash);
  67             assertEquals(1, checks.size());
  68             var check = checks.get(&quot;jcheck&quot;);
  69             assertEquals(CheckStatus.SUCCESS, check.status());
  70 
  71             // The PR should now be ready for review
  72             assertTrue(pr.labels().contains(&quot;rfr&quot;));
  73             assertFalse(pr.labels().contains(&quot;ready&quot;));
  74 
  75             // Approve it as another user
  76             var approvalPr = reviewer.pullRequest(pr.id());
  77             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
  78 
  79             // Check the status again
  80             TestBotRunner.runPeriodicItems(checkBot);
  81 
  82             // The check should now be successful
  83             checks = pr.checks(editHash);
  84             assertEquals(1, checks.size());
  85             check = checks.get(&quot;jcheck&quot;);
  86             assertEquals(CheckStatus.SUCCESS, check.status());
  87 
<span class="line-modified">  88             // The PR should now be ready</span>

  89             assertTrue(pr.labels().contains(&quot;ready&quot;));
  90         }
  91     }
  92 
  93     @Test
  94     void whitespaceIssue(TestInfo testInfo) throws IOException {
  95         try (var credentials = new HostCredentials(testInfo);
  96              var tempFolder = new TemporaryDirectory()) {
  97 
  98             var author = credentials.getHostedRepository();
  99             var reviewer = credentials.getHostedRepository();
 100 
 101             var censusBuilder = credentials.getCensusBuilder()
 102                                            .addAuthor(author.forge().currentUser().id())
 103                                            .addReviewer(reviewer.forge().currentUser().id());
<span class="line-modified"> 104             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();</span>
 105 
 106             // Populate the projects repository
 107             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 108             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 109             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 110 
 111             // Make a change with a corresponding PR
 112             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line with a trailing whitespace   &quot;);
 113             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 114             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 115 
 116             // Check the status
 117             TestBotRunner.runPeriodicItems(checkBot);
 118 
 119             // The PR should not be flagged as ready for review
 120             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 121 
 122             // Approve it as another user
 123             var approvalPr = reviewer.pullRequest(pr.id());
 124             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
</pre>
<hr />
<pre>
 135             // The PR should not still not be flagged as ready for review
 136             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 137 
 138             // Remove the trailing whitespace in a new commit
 139             editHash = CheckableRepository.replaceAndCommit(localRepo, &quot;A line without a trailing whitespace&quot;);
 140             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 141 
 142             // Make sure that the push registered
 143             var lastHeadHash = pr.headHash();
 144             var refreshCount = 0;
 145             do {
 146                 pr = author.pullRequest(pr.id());
 147                 if (refreshCount++ &gt; 100) {
 148                     fail(&quot;The PR did not update after the new push&quot;);
 149                 }
 150             } while (pr.headHash().equals(lastHeadHash));
 151 
 152             // Check the status again
 153             TestBotRunner.runPeriodicItems(checkBot);
 154 
<span class="line-modified"> 155             // The PR should now be ready</span>
<span class="line-modified"> 156             assertTrue(pr.labels().contains(&quot;ready&quot;));</span>
 157 
 158             // The check should now be successful
 159             checks = pr.checks(editHash);
 160             assertEquals(1, checks.size());
 161             check = checks.get(&quot;jcheck&quot;);
 162             assertEquals(CheckStatus.SUCCESS, check.status());
 163         }
 164     }
 165 
 166     @Test
 167     void multipleReviews(TestInfo testInfo) throws IOException {
 168         try (var credentials = new HostCredentials(testInfo);
 169              var tempFolder = new TemporaryDirectory()) {
 170 
 171             var author = credentials.getHostedRepository();
 172             var reviewer = credentials.getHostedRepository();
 173             var commenter = credentials.getHostedRepository();
 174 
 175             var censusBuilder = credentials.getCensusBuilder()
 176                                            .addAuthor(author.forge().currentUser().id())
 177                                            .addReviewer(reviewer.forge().currentUser().id())
 178                                            .addReviewer(commenter.forge().currentUser().id());
 179 
<span class="line-modified"> 180             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();</span>
 181 
 182             // Populate the projects repository
 183             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 184             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 185             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 186 
 187             // Make a change with a corresponding PR
 188             var editHash = CheckableRepository.appendAndCommit(localRepo);
 189             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 190             var authorPr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 191 
 192             // Let the status bot inspect the PR
 193             TestBotRunner.runPeriodicItems(checkBot);
 194             assertFalse(authorPr.body().contains(&quot;Approvers&quot;));
 195 
 196             // Approve it
 197             var reviewerPr = reviewer.pullRequest(authorPr.id());
 198             reviewerPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 199             TestBotRunner.runPeriodicItems(checkBot);
 200 
</pre>
<hr />
<pre>
 239 
 240             // Refresh the PR and check that it still only approved once (but two reviews) and is no longer stale
 241             authorPr = author.pullRequest(authorPr.id());
 242             assertTrue(authorPr.body().contains(&quot;Approvers&quot;));
 243             assertEquals(1, authorPr.body().split(&quot;Generated Reviewer&quot;, -1).length - 1);
 244             assertTrue(authorPr.reviews().size() &gt;= 2);
 245             assertFalse(authorPr.body().contains(&quot;Note&quot;));
 246         }
 247     }
 248 
 249     @Test
 250     void selfReview(TestInfo testInfo) throws IOException {
 251         try (var credentials = new HostCredentials(testInfo);
 252              var tempFolder = new TemporaryDirectory()) {
 253 
 254             var author = credentials.getHostedRepository();
 255 
 256             var censusBuilder = credentials.getCensusBuilder()
 257                                            .addReviewer(author.forge().currentUser().id());
 258 
<span class="line-modified"> 259             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();</span>
 260 
 261             // Populate the projects repository
 262             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 263             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 264             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 265 
 266             // Make a change with a corresponding PR
 267             var editHash = CheckableRepository.appendAndCommit(localRepo);
 268             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 269             var authorPr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 270 
 271             // Let the status bot inspect the PR
 272             TestBotRunner.runPeriodicItems(checkBot);
 273             assertFalse(authorPr.body().contains(&quot;Approvers&quot;));
 274 
 275             // Approve it
 276             authorPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 277             TestBotRunner.runPeriodicItems(checkBot);
 278 
 279             // Refresh the PR and check that it has been approved
 280             authorPr = author.pullRequest(authorPr.id());
 281             assertTrue(authorPr.body().contains(&quot;Approvers&quot;));
 282 
 283             // Verify that the check failed
 284             var checks = authorPr.checks(editHash);
 285             assertEquals(1, checks.size());
 286             var check = checks.get(&quot;jcheck&quot;);
 287             assertEquals(CheckStatus.FAILURE, check.status());
 288         }
 289     }
 290 
 291     @Test
 292     void multipleCommitters(TestInfo testInfo) throws IOException {
 293         try (var credentials = new HostCredentials(testInfo);
 294              var tempFolder = new TemporaryDirectory()) {
 295             var author = credentials.getHostedRepository();
 296             var reviewer = credentials.getHostedRepository();
 297 
 298             var censusBuilder = credentials.getCensusBuilder()
 299                                            .addReviewer(reviewer.forge().currentUser().id());
<span class="line-modified"> 300             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();</span>
 301 
 302             // Populate the projects repository
 303             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 304             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 305             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 306 
 307             // Make two changes with different authors
 308             CheckableRepository.appendAndCommit(localRepo, &quot;First edit&quot;, &quot;Edit by number 1&quot;,
 309                                                 &quot;number1&quot;, &quot;number1@none.none&quot;);
 310             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Second edit&quot;, &quot;Edit by number 2&quot;,
 311                                                                &quot;number2&quot;, &quot;number2@none.none&quot;);
 312             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 313             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 314 
 315             // Check the status
 316             TestBotRunner.runPeriodicItems(checkBot);
 317 
 318             // Verify that the check failed
 319             var checks = pr.checks(editHash);
 320             assertEquals(1, checks.size());
</pre>
<hr />
<pre>
 332             checks = pr.checks(editHash);
 333             assertEquals(1, checks.size());
 334             check = checks.get(&quot;jcheck&quot;);
 335             assertEquals(CheckStatus.FAILURE, check.status());
 336 
 337             // The PR should not be flagged as ready for review, as multiple committers is a problem
 338             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 339         }
 340     }
 341 
 342     @Test
 343     void updatedContentFailsCheck(TestInfo testInfo) throws IOException {
 344         try (var credentials = new HostCredentials(testInfo);
 345              var tempFolder = new TemporaryDirectory()) {
 346             var author = credentials.getHostedRepository();
 347             var reviewer = credentials.getHostedRepository();
 348 
 349             var censusBuilder = credentials.getCensusBuilder()
 350                                            .addAuthor(author.forge().currentUser().id())
 351                                            .addReviewer(reviewer.forge().currentUser().id());
<span class="line-modified"> 352             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();</span>
 353 
 354             // Populate the projects repository
 355             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 356             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 357             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 358 
 359             // Make a change with a corresponding PR
 360             var editHash = CheckableRepository.appendAndCommit(localRepo);
 361             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 362             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 363 
 364             // Check the status
 365             TestBotRunner.runPeriodicItems(checkBot);
 366 
 367             // Verify that the check passed
 368             var checks = pr.checks(editHash);
 369             assertEquals(1, checks.size());
 370             var check = checks.get(&quot;jcheck&quot;);
 371             assertEquals(CheckStatus.SUCCESS, check.status());
 372 
 373             // The PR should now be ready for review
 374             assertTrue(pr.labels().contains(&quot;rfr&quot;));
 375             assertFalse(pr.labels().contains(&quot;ready&quot;));
 376 
 377             // Approve it as another user
 378             var approvalPr = reviewer.pullRequest(pr.id());
 379             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 380 
 381             // Check the status again
 382             TestBotRunner.runPeriodicItems(checkBot);
 383 
 384             // The check should now be successful
 385             checks = pr.checks(editHash);
 386             assertEquals(1, checks.size());
 387             check = checks.get(&quot;jcheck&quot;);
 388             assertEquals(CheckStatus.SUCCESS, check.status());
 389 
<span class="line-modified"> 390             // The PR should now be ready</span>
<span class="line-modified"> 391             assertTrue(pr.labels().contains(&quot;rfr&quot;));</span>
 392             assertTrue(pr.labels().contains(&quot;ready&quot;));
 393 
 394             var addedHash = CheckableRepository.appendAndCommit(localRepo, &quot;trailing whitespace   &quot;);
 395             localRepo.push(addedHash, author.url(), &quot;edit&quot;);
 396 
 397             // Make sure that the push registered
 398             var lastHeadHash = pr.headHash();
 399             var refreshCount = 0;
 400             do {
 401                 pr = author.pullRequest(pr.id());
 402                 if (refreshCount++ &gt; 100) {
 403                     fail(&quot;The PR did not update after the new push&quot;);
 404                 }
 405             } while (pr.headHash().equals(lastHeadHash));
 406 
 407             // Check the status
 408             TestBotRunner.runPeriodicItems(checkBot);
 409 
 410             // The PR is now neither ready for review nor integration
 411             assertFalse(pr.labels().contains(&quot;rfr&quot;));
</pre>
<hr />
<pre>
 415             checks = pr.checks(addedHash);
 416             assertEquals(1, checks.size());
 417             check = checks.get(&quot;jcheck&quot;);
 418             assertEquals(CheckStatus.FAILURE, check.status());
 419         }
 420     }
 421 
 422     @Test
 423     void individualReviewComments(TestInfo testInfo) throws IOException {
 424         try (var credentials = new HostCredentials(testInfo);
 425              var tempFolder = new TemporaryDirectory()) {
 426             var author = credentials.getHostedRepository();
 427             var reviewer = credentials.getHostedRepository();
 428 
 429             // This test is only relevant on hosts not supporting proper review comment bodies
 430             assumeTrue(!author.forge().supportsReviewBody());
 431 
 432             var censusBuilder = credentials.getCensusBuilder()
 433                                            .addAuthor(author.forge().currentUser().id())
 434                                            .addReviewer(reviewer.forge().currentUser().id());
<span class="line-modified"> 435             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();</span>
 436 
 437             // Populate the projects repository
 438             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 439             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 440             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 441 
 442             // Make a change with a corresponding PR
 443             var editHash = CheckableRepository.appendAndCommit(localRepo);
 444             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 445             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 446 
 447             // Check the status
 448             TestBotRunner.runPeriodicItems(checkBot);
 449             var comments = pr.comments();
 450             var commentCount = comments.size();
 451 
 452             // Approve it as another user
 453             var approvalPr = reviewer.pullRequest(pr.id());
 454             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 455 
</pre>
<hr />
<pre>
 477             assertTrue(comment.body().contains(&quot;comment&quot;));
 478 
 479             // No changes should not generate additional comments
 480             TestBotRunner.runPeriodicItems(checkBot);
 481             comments = pr.comments();
 482             assertEquals(commentCount + 3, comments.size());
 483         }
 484     }
 485 
 486     @Test
 487     void mergeMessage(TestInfo testInfo) throws IOException {
 488         try (var credentials = new HostCredentials(testInfo);
 489              var tempFolder = new TemporaryDirectory();
 490              var pushedFolder = new TemporaryDirectory()) {
 491 
 492             var author = credentials.getHostedRepository();
 493             var integrator = credentials.getHostedRepository();
 494             var censusBuilder = credentials.getCensusBuilder()
 495                                            .addCommitter(author.forge().currentUser().id())
 496                                            .addReviewer(integrator.forge().currentUser().id());
<span class="line-modified"> 497             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();</span>
 498 
 499             // Populate the projects repository
 500             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 501             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 502             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
 503             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 504 
 505             // Make a change with a corresponding PR
 506             var editHash = CheckableRepository.appendAndCommit(localRepo);
 507             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 508             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 509 
 510             // Approve it as another user
 511             var approvalPr = integrator.pullRequest(pr.id());
 512             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 513 
 514             // Get all messages up to date
 515             TestBotRunner.runPeriodicItems(mergeBot);
 516 
 517             // Push something unrelated to master
</pre>
<hr />
<pre>
 528             // The bot should reply with an ok message
 529             var updated = pr.comments().stream()
 530                             .filter(comment -&gt; comment.body().contains(&quot;there has been 1 commit&quot;))
 531                             .filter(comment -&gt; comment.body().contains(&quot;please merge&quot;))
 532                             .count();
 533             assertEquals(1, updated);
 534         }
 535     }
 536 
 537     @Test
 538     void cannotRebase(TestInfo testInfo) throws IOException {
 539         try (var credentials = new HostCredentials(testInfo);
 540              var tempFolder = new TemporaryDirectory();
 541              var pushedFolder = new TemporaryDirectory()) {
 542 
 543             var author = credentials.getHostedRepository();
 544             var integrator = credentials.getHostedRepository();
 545             var censusBuilder = credentials.getCensusBuilder()
 546                                            .addCommitter(author.forge().currentUser().id())
 547                                            .addReviewer(integrator.forge().currentUser().id());
<span class="line-modified"> 548             var mergeBot = PullRequestBot.newBuilder().repo(integrator).censusRepo(censusBuilder.build()).build();</span>
 549 
 550             // Populate the projects repository
 551             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 552             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 553             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
 554             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 555 
 556             // Make a change with a corresponding PR
 557             var editHash = CheckableRepository.appendAndCommit(localRepo);
 558             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 559             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 560 
 561             // Approve it as another user
 562             var approvalPr = integrator.pullRequest(pr.id());
 563             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 564 
 565             // Get all messages up to date
 566             TestBotRunner.runPeriodicItems(mergeBot);
 567 
 568             // Push something conflicting to master
</pre>
<hr />
<pre>
 599             updated = pr.comments().stream()
 600                         .filter(comment -&gt; comment.body().contains(&quot;change now passes all automated&quot;))
 601                         .count();
 602             assertEquals(1, updated);
 603 
 604             // The PR should not be flagged as outdated
 605             assertFalse(pr.labels().contains(&quot;outdated&quot;));
 606         }
 607     }
 608 
 609     @Test
 610     void blockingLabel(TestInfo testInfo) throws IOException {
 611         try (var credentials = new HostCredentials(testInfo);
 612              var tempFolder = new TemporaryDirectory()) {
 613             var author = credentials.getHostedRepository();
 614             var reviewer = credentials.getHostedRepository();
 615 
 616             var censusBuilder = credentials.getCensusBuilder()
 617                                            .addAuthor(author.forge().currentUser().id())
 618                                            .addReviewer(reviewer.forge().currentUser().id());
<span class="line-modified"> 619             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).blockingLabels(Map.of(&quot;block&quot;, &quot;Test Blocker&quot;)).build();</span>

 620 
 621             // Populate the projects repository
 622             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 623             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 624             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 625 
 626             // Make a change with a corresponding PR
 627             var editHash = CheckableRepository.appendAndCommit(localRepo);
 628             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 629             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 630             pr.addLabel(&quot;block&quot;);
 631 
 632             // Check the status
 633             TestBotRunner.runPeriodicItems(checkBot);
 634 
 635             // Verify that the check failed
 636             var checks = pr.checks(editHash);
 637             assertEquals(1, checks.size());
 638             var check = checks.get(&quot;jcheck&quot;);
 639             assertEquals(CheckStatus.FAILURE, check.status());
</pre>
<hr />
<pre>
 647             // Check the status again
 648             pr.removeLabel(&quot;block&quot;);
 649             TestBotRunner.runPeriodicItems(checkBot);
 650 
 651             // The PR should now be ready for review
 652             assertTrue(pr.labels().contains(&quot;rfr&quot;));
 653             assertFalse(pr.labels().contains(&quot;ready&quot;));
 654         }
 655     }
 656 
 657     @Test
 658     void missingReadyLabel(TestInfo testInfo) throws IOException {
 659         try (var credentials = new HostCredentials(testInfo);
 660              var tempFolder = new TemporaryDirectory()) {
 661             var author = credentials.getHostedRepository();
 662             var reviewer = credentials.getHostedRepository();
 663 
 664             var censusBuilder = credentials.getCensusBuilder()
 665                                            .addAuthor(author.forge().currentUser().id())
 666                                            .addReviewer(reviewer.forge().currentUser().id());
<span class="line-modified"> 667             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).readyLabels(Set.of(&quot;good-to-go&quot;)).build();</span>

 668 
 669             // Populate the projects repository
 670             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 671             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 672             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 673 
 674             // Make a change with a corresponding PR
 675             var editHash = CheckableRepository.appendAndCommit(localRepo);
 676             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 677             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 678 
 679             // Check the status
 680             TestBotRunner.runPeriodicItems(checkBot);
 681 
 682             // Verify that no checks have been run
 683             var checks = pr.checks(editHash);
 684             assertEquals(0, checks.size());
 685 
 686             // The PR should not yet be ready for review
 687             assertFalse(pr.labels().contains(&quot;rfr&quot;));
 688 
 689             // Check the status again
 690             pr.addLabel(&quot;good-to-go&quot;);
 691             TestBotRunner.runPeriodicItems(checkBot);
 692 
 693             // The PR should now be ready for review
 694             assertTrue(pr.labels().contains(&quot;rfr&quot;));
 695         }
 696     }
 697 
 698     @Test
 699     void missingReadyComment(TestInfo testInfo) throws IOException {
 700         try (var credentials = new HostCredentials(testInfo);
 701              var tempFolder = new TemporaryDirectory()) {
 702             var author = credentials.getHostedRepository();
 703             var reviewer = credentials.getHostedRepository();
 704 
 705             var censusBuilder = credentials.getCensusBuilder()
 706                                            .addAuthor(author.forge().currentUser().id())
 707                                            .addReviewer(reviewer.forge().currentUser().id());
<span class="line-modified"> 708             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).readyComments(Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;proceed&quot;))).build();</span>

 709 
 710             // Populate the projects repository
 711             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 712             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 713             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 714 
 715             // Make a change with a corresponding PR
 716             var editHash = CheckableRepository.appendAndCommit(localRepo);
 717             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 718             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 719 
 720             // Check the status
 721             TestBotRunner.runPeriodicItems(checkBot);
 722 
 723             // Verify that no checks have been run
 724             var checks = pr.checks(editHash);
 725             assertEquals(0, checks.size());
 726 
 727             // The PR should not yet be ready for review
 728             assertFalse(pr.labels().contains(&quot;rfr&quot;));
</pre>
<hr />
<pre>
 730             // Check the status again
 731             var reviewerPr = reviewer.pullRequest(pr.id());
 732             reviewerPr.addComment(&quot;proceed&quot;);
 733             TestBotRunner.runPeriodicItems(checkBot);
 734 
 735             // The PR should now be ready for review
 736             assertTrue(pr.labels().contains(&quot;rfr&quot;));
 737         }
 738     }
 739 
 740     @Test
 741     void issueIssue(TestInfo testInfo) throws IOException {
 742         try (var credentials = new HostCredentials(testInfo);
 743              var tempFolder = new TemporaryDirectory()) {
 744             var author = credentials.getHostedRepository();
 745             var reviewer = credentials.getHostedRepository();
 746 
 747             var censusBuilder = credentials.getCensusBuilder()
 748                                            .addAuthor(author.forge().currentUser().id())
 749                                            .addReviewer(reviewer.forge().currentUser().id());
<span class="line-modified"> 750             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();</span>

 751 
 752             // Populate the projects repository
 753             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), Path.of(&quot;appendable.txt&quot;),
 754                                                      Set.of(&quot;issues&quot;), null);
 755             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 756             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 757 
 758             // Make a change with a corresponding PR
 759             var editHash = CheckableRepository.appendAndCommit(localRepo);
 760             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 761             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 762 
 763             // Check the status
 764             TestBotRunner.runPeriodicItems(checkBot);
 765 
 766             // Verify that the check failed
 767             var checks = pr.checks(editHash);
 768             assertEquals(1, checks.size());
 769             var check = checks.get(&quot;jcheck&quot;);
 770             assertEquals(CheckStatus.FAILURE, check.status());
</pre>
<hr />
<pre>
 777 
 778             // The check should now be successful
 779             checks = pr.checks(editHash);
 780             assertEquals(1, checks.size());
 781             check = checks.get(&quot;jcheck&quot;);
 782             assertEquals(CheckStatus.SUCCESS, check.status());
 783         }
 784     }
 785 
 786     @Test
 787     void issueInSummary(TestInfo testInfo) throws IOException {
 788         try (var credentials = new HostCredentials(testInfo);
 789              var tempFolder = new TemporaryDirectory()) {
 790             var author = credentials.getHostedRepository();
 791             var reviewer = credentials.getHostedRepository();
 792             var issues = credentials.getIssueProject();
 793 
 794             var censusBuilder = credentials.getCensusBuilder()
 795                                            .addAuthor(author.forge().currentUser().id())
 796                                            .addReviewer(reviewer.forge().currentUser().id());
<span class="line-modified"> 797             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).issueProject(issues).build();</span>

 798 
 799             // Populate the projects repository
 800             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), Path.of(&quot;appendable.txt&quot;),
 801                                                      Set.of(&quot;issues&quot;), null);
 802             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 803             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 804 
 805             var issue1 = issues.createIssue(&quot;My first issue&quot;, List.of(&quot;Hello&quot;), Map.of());
 806 
 807             // Make a change with a corresponding PR
 808             var editHash = CheckableRepository.appendAndCommit(localRepo);
 809             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
 810             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, issue1.id() + &quot;: This is a pull request&quot;);
 811 
 812             // Check the status
 813             TestBotRunner.runPeriodicItems(checkBot);
 814 
 815             // The check should be successful
 816             var checks = pr.checks(editHash);
 817             assertEquals(1, checks.size());
</pre>
<hr />
<pre>
 908             pr.updateCheck(cancelled);
 909             checks = pr.checks(editHash);
 910             assertEquals(1, checks.size());
 911             retrieved = checks.get(&quot;jcheck&quot;);
 912             assertEquals(&quot;jcheck title&quot;, retrieved.title().get());
 913             assertEquals(&quot;jcheck summary&quot;, retrieved.summary().get());
 914             assertEquals(CheckStatus.CANCELLED, retrieved.status());
 915         }
 916     }
 917 
 918     @Test
 919     void rebaseBeforeCheck(TestInfo testInfo) throws IOException {
 920         try (var credentials = new HostCredentials(testInfo);
 921              var tempFolder = new TemporaryDirectory()) {
 922             var author = credentials.getHostedRepository();
 923             var reviewer = credentials.getHostedRepository();
 924 
 925             var censusBuilder = credentials.getCensusBuilder()
 926                                            .addAuthor(author.forge().currentUser().id())
 927                                            .addReviewer(reviewer.forge().currentUser().id());
<span class="line-modified"> 928             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();</span>
 929 
 930             // Populate the projects repository
 931             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 932             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 933             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 934 
 935             // Make a change with a corresponding PR
 936             var editHash = CheckableRepository.appendAndCommit(localRepo);
 937             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 938             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 939 
 940             // Enable a new check in the target branch
 941             localRepo.checkout(masterHash, true);
 942             CheckableRepository.init(tempFolder.path(), author.repositoryType(), Path.of(&quot;appendable.txt&quot;),
 943                                      Set.of(&quot;author&quot;, &quot;reviewers&quot;, &quot;whitespace&quot;, &quot;issues&quot;), null);
 944             var headHash = localRepo.resolve(&quot;HEAD&quot;).orElseThrow();
 945             localRepo.push(headHash, author.url(), &quot;master&quot;, true);
 946 
 947             // Check the status
 948             TestBotRunner.runPeriodicItems(checkBot);
</pre>
<hr />
<pre>
 959             TestBotRunner.runPeriodicItems(checkBot);
 960 
 961             // Verify that the check passed
 962             checks = pr.checks(editHash);
 963             assertEquals(1, checks.size());
 964             check = checks.get(&quot;jcheck&quot;);
 965             assertEquals(CheckStatus.SUCCESS, check.status());
 966         }
 967     }
 968 
 969     @Test
 970     void draft(TestInfo testInfo) throws IOException {
 971         try (var credentials = new HostCredentials(testInfo);
 972              var tempFolder = new TemporaryDirectory()) {
 973             var author = credentials.getHostedRepository();
 974             var reviewer = credentials.getHostedRepository();
 975 
 976             var censusBuilder = credentials.getCensusBuilder()
 977                                            .addAuthor(author.forge().currentUser().id())
 978                                            .addReviewer(reviewer.forge().currentUser().id());
<span class="line-modified"> 979             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();</span>
 980 
 981             // Populate the projects repository
 982             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
 983             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 984             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
 985 
 986             // Make a change with a corresponding PR
 987             var editHash = CheckableRepository.appendAndCommit(localRepo);
 988             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
 989             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;,
 990                                                    &quot;This is a pull request&quot;, true);
 991 
 992             // Check the status
 993             TestBotRunner.runPeriodicItems(checkBot);
 994 
 995             // Verify that the check succeeded
 996             var checks = pr.checks(editHash);
 997             assertEquals(1, checks.size());
 998             var check = checks.get(&quot;jcheck&quot;);
 999             assertEquals(CheckStatus.SUCCESS, check.status());
1000 
1001             // The PR should still not be ready for review as it is a draft
1002             assertFalse(pr.labels().contains(&quot;rfr&quot;));
1003             assertFalse(pr.labels().contains(&quot;ready&quot;));
1004         }
1005     }
1006 
1007     @Test
1008     void excessiveFailures(TestInfo testInfo) throws IOException {
1009         try (var credentials = new HostCredentials(testInfo);
1010              var tempFolder = new TemporaryDirectory()) {
1011             var author = credentials.getHostedRepository();
1012             var reviewer = credentials.getHostedRepository();
1013 
1014             var censusBuilder = credentials.getCensusBuilder()
1015                                            .addAuthor(author.forge().currentUser().id())
1016                                            .addReviewer(reviewer.forge().currentUser().id());
<span class="line-modified">1017             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();</span>
1018 
1019             // Populate the projects repository
1020             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1021             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1022             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1023 
1024             // Make a change with a corresponding PR containing more errors than at least GitHub can handle in a check
1025             var badContent = &quot;\tline   \n&quot;.repeat(200);
1026             var editHash = CheckableRepository.appendAndCommit(localRepo, badContent);
1027             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
1028             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;,
1029                                                    &quot;This is a pull request&quot;, true);
1030 
1031             // Check the status
1032             TestBotRunner.runPeriodicItems(checkBot);
1033 
1034             // Verify that the check failed
1035             var checks = pr.checks(editHash);
1036             assertEquals(1, checks.size());
1037             var check = checks.get(&quot;jcheck&quot;);
1038             assertEquals(CheckStatus.FAILURE, check.status());
1039         }
1040     }
1041 
1042     @Test
1043     void retryOnException(TestInfo testInfo) throws IOException {
1044         try (var credentials = new HostCredentials(testInfo);
1045              var tempFolder = new TemporaryDirectory()) {
1046             var author = credentials.getHostedRepository();
1047             var reviewer = credentials.getHostedRepository();
1048 
1049             var censusBuilder = credentials.getCensusBuilder()
1050                                            .addAuthor(author.forge().currentUser().id())
1051                                            .addReviewer(reviewer.forge().currentUser().id());
<span class="line-modified">1052             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();</span>
1053 
1054             // Populate the projects repository
1055             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1056             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1057             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1058 
1059             // Break the jcheck configuration
1060             var confPath = tempFolder.path().resolve(&quot;.jcheck/conf&quot;);
1061             var oldConf = Files.readString(confPath, StandardCharsets.UTF_8);
1062             Files.writeString(confPath, &quot;Hello there!&quot;, StandardCharsets.UTF_8);
1063             localRepo.add(confPath);
1064             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A change&quot;);
1065             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1066             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;,
1067                                                    &quot;This is a pull request&quot;, true);
1068 
1069             // Check the status - should throw every time
1070             assertThrows(RuntimeException.class, () -&gt; TestBotRunner.runPeriodicItems(checkBot));
1071             assertThrows(RuntimeException.class, () -&gt; TestBotRunner.runPeriodicItems(checkBot));
1072             assertThrows(RuntimeException.class, () -&gt; TestBotRunner.runPeriodicItems(checkBot));
</pre>
<hr />
<pre>
1085             TestBotRunner.runPeriodicItems(checkBot);
1086 
1087             // Verify that the check now passes
1088             checks = pr.checks(editHash);
1089             assertEquals(1, checks.size());
1090             check = checks.get(&quot;jcheck&quot;);
1091             assertEquals(CheckStatus.SUCCESS, check.status());
1092         }
1093     }
1094 
1095     @Test
1096     void noCommit(TestInfo testInfo) throws IOException {
1097         try (var credentials = new HostCredentials(testInfo);
1098              var tempFolder = new TemporaryDirectory()) {
1099             var author = credentials.getHostedRepository();
1100             var reviewer = credentials.getHostedRepository();
1101 
1102             var censusBuilder = credentials.getCensusBuilder()
1103                                            .addAuthor(author.forge().currentUser().id())
1104                                            .addReviewer(reviewer.forge().currentUser().id());
<span class="line-modified">1105             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).build();</span>
1106 
1107             // Populate the projects repository
1108             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());
1109             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1110             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1111 
1112             // Make a change with a corresponding PR
1113             var editHash = CheckableRepository.appendAndCommit(localRepo);
1114             localRepo.push(editHash, author.url(), &quot;master&quot;);
1115             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);
1116             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1117 
1118             // Check the status
1119             TestBotRunner.runPeriodicItems(checkBot);
1120 
1121             // Verify that the check failed
1122             var checks = pr.checks(editHash);
1123             assertEquals(1, checks.size());
1124             var check = checks.get(&quot;jcheck&quot;);
1125             assertEquals(CheckStatus.FAILURE, check.status());
1126         }
1127     }
<span class="line-added">1128 </span>
<span class="line-added">1129     @Test</span>
<span class="line-added">1130     void ignoreStale(TestInfo testInfo) throws IOException {</span>
<span class="line-added">1131         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added">1132              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-added">1133 </span>
<span class="line-added">1134             var author = credentials.getHostedRepository();</span>
<span class="line-added">1135             var reviewer = credentials.getHostedRepository();</span>
<span class="line-added">1136 </span>
<span class="line-added">1137             var censusBuilder = credentials.getCensusBuilder()</span>
<span class="line-added">1138                                            .addAuthor(author.forge().currentUser().id())</span>
<span class="line-added">1139                                            .addReviewer(reviewer.forge().currentUser().id());</span>
<span class="line-added">1140             var checkBot = PullRequestBot.newBuilder().repo(author).censusRepo(censusBuilder.build()).ignoreStaleReviews(true).build();</span>
<span class="line-added">1141 </span>
<span class="line-added">1142             // Populate the projects repository</span>
<span class="line-added">1143             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());</span>
<span class="line-added">1144             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="line-added">1145             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
<span class="line-added">1146 </span>
<span class="line-added">1147             // Make a change with a corresponding PR</span>
<span class="line-added">1148             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line with&quot;);</span>
<span class="line-added">1149             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);</span>
<span class="line-added">1150             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);</span>
<span class="line-added">1151 </span>
<span class="line-added">1152             // Check the status</span>
<span class="line-added">1153             TestBotRunner.runPeriodicItems(checkBot);</span>
<span class="line-added">1154 </span>
<span class="line-added">1155             // Approve it as another user</span>
<span class="line-added">1156             var approvalPr = reviewer.pullRequest(pr.id());</span>
<span class="line-added">1157             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);</span>
<span class="line-added">1158 </span>
<span class="line-added">1159             // Check the status</span>
<span class="line-added">1160             TestBotRunner.runPeriodicItems(checkBot);</span>
<span class="line-added">1161 </span>
<span class="line-added">1162             // The PR should be flagged as ready</span>
<span class="line-added">1163             assertTrue(pr.labels().contains(&quot;ready&quot;));</span>
<span class="line-added">1164 </span>
<span class="line-added">1165             // Add another commit</span>
<span class="line-added">1166             editHash = CheckableRepository.replaceAndCommit(localRepo, &quot;Another line&quot;);</span>
<span class="line-added">1167             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);</span>
<span class="line-added">1168 </span>
<span class="line-added">1169             // Make sure that the push registered</span>
<span class="line-added">1170             var lastHeadHash = pr.headHash();</span>
<span class="line-added">1171             var refreshCount = 0;</span>
<span class="line-added">1172             do {</span>
<span class="line-added">1173                 pr = author.pullRequest(pr.id());</span>
<span class="line-added">1174                 if (refreshCount++ &gt; 100) {</span>
<span class="line-added">1175                     fail(&quot;The PR did not update after the new push&quot;);</span>
<span class="line-added">1176                 }</span>
<span class="line-added">1177             } while (pr.headHash().equals(lastHeadHash));</span>
<span class="line-added">1178 </span>
<span class="line-added">1179             // Check the status again</span>
<span class="line-added">1180             TestBotRunner.runPeriodicItems(checkBot);</span>
<span class="line-added">1181 </span>
<span class="line-added">1182             // The PR should no longer be ready, as the review is stale</span>
<span class="line-added">1183             assertFalse(pr.labels().contains(&quot;ready&quot;));</span>
<span class="line-added">1184             assertTrue(pr.labels().contains(&quot;rfr&quot;));</span>
<span class="line-added">1185         }</span>
<span class="line-added">1186     }</span>
1187 }
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/pr/SummaryCommand.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="CommandTests.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>