<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/pr/src/test/java/org/openjdk/skara/bots/pr/CheckTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/pr/CheckRun.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/pr/src/test/java/org/openjdk/skara/bots/pr/CheckTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.pr;
  24 
  25 import org.openjdk.skara.forge.*;
  26 import org.openjdk.skara.test.*;
  27 
  28 import org.junit.jupiter.api.*;
  29 
  30 import java.io.IOException;

  31 import java.nio.file.*;
  32 import java.util.*;
  33 import java.util.regex.Pattern;
  34 
  35 import static org.junit.jupiter.api.Assertions.*;
  36 import static org.junit.jupiter.api.Assumptions.assumeTrue;
  37 
  38 class CheckTests {
  39     @Test
  40     void simpleCommit(TestInfo testInfo) throws IOException {
  41         try (var credentials = new HostCredentials(testInfo);
  42              var tempFolder = new TemporaryDirectory()) {
  43             var author = credentials.getHostedRepository();
  44             var reviewer = credentials.getHostedRepository();
  45 
  46             var censusBuilder = credentials.getCensusBuilder()
  47                                            .addAuthor(author.forge().currentUser().id())
  48                                            .addReviewer(reviewer.forge().currentUser().id());
  49             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
  50 
</pre>
<hr />
<pre>
1026             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1027             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1028 
1029             // Make a change with a corresponding PR containing more errors than at least GitHub can handle in a check
1030             var badContent = &quot;\tline   \n&quot;.repeat(200);
1031             var editHash = CheckableRepository.appendAndCommit(localRepo, badContent);
1032             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
1033             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;,
1034                                                    &quot;This is a pull request&quot;, true);
1035 
1036             // Check the status
1037             TestBotRunner.runPeriodicItems(checkBot);
1038 
1039             // Verify that the check failed
1040             var checks = pr.checks(editHash);
1041             assertEquals(1, checks.size());
1042             var check = checks.get(&quot;jcheck&quot;);
1043             assertEquals(CheckStatus.FAILURE, check.status());
1044         }
1045     }





















































1046 }
</pre>
</td>
<td>
<hr />
<pre>
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.pr;
  24 
  25 import org.openjdk.skara.forge.*;
  26 import org.openjdk.skara.test.*;
  27 
  28 import org.junit.jupiter.api.*;
  29 
  30 import java.io.IOException;
<span class="line-added">  31 import java.nio.charset.StandardCharsets;</span>
  32 import java.nio.file.*;
  33 import java.util.*;
  34 import java.util.regex.Pattern;
  35 
  36 import static org.junit.jupiter.api.Assertions.*;
  37 import static org.junit.jupiter.api.Assumptions.assumeTrue;
  38 
  39 class CheckTests {
  40     @Test
  41     void simpleCommit(TestInfo testInfo) throws IOException {
  42         try (var credentials = new HostCredentials(testInfo);
  43              var tempFolder = new TemporaryDirectory()) {
  44             var author = credentials.getHostedRepository();
  45             var reviewer = credentials.getHostedRepository();
  46 
  47             var censusBuilder = credentials.getCensusBuilder()
  48                                            .addAuthor(author.forge().currentUser().id())
  49                                            .addReviewer(reviewer.forge().currentUser().id());
  50             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
  51 
</pre>
<hr />
<pre>
1027             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1028             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);
1029 
1030             // Make a change with a corresponding PR containing more errors than at least GitHub can handle in a check
1031             var badContent = &quot;\tline   \n&quot;.repeat(200);
1032             var editHash = CheckableRepository.appendAndCommit(localRepo, badContent);
1033             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);
1034             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;,
1035                                                    &quot;This is a pull request&quot;, true);
1036 
1037             // Check the status
1038             TestBotRunner.runPeriodicItems(checkBot);
1039 
1040             // Verify that the check failed
1041             var checks = pr.checks(editHash);
1042             assertEquals(1, checks.size());
1043             var check = checks.get(&quot;jcheck&quot;);
1044             assertEquals(CheckStatus.FAILURE, check.status());
1045         }
1046     }
<span class="line-added">1047 </span>
<span class="line-added">1048     @Test</span>
<span class="line-added">1049     void retryOnException(TestInfo testInfo) throws IOException {</span>
<span class="line-added">1050         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added">1051              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-added">1052             var author = credentials.getHostedRepository();</span>
<span class="line-added">1053             var reviewer = credentials.getHostedRepository();</span>
<span class="line-added">1054 </span>
<span class="line-added">1055             var censusBuilder = credentials.getCensusBuilder()</span>
<span class="line-added">1056                                            .addAuthor(author.forge().currentUser().id())</span>
<span class="line-added">1057                                            .addReviewer(reviewer.forge().currentUser().id());</span>
<span class="line-added">1058             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);</span>
<span class="line-added">1059 </span>
<span class="line-added">1060             // Populate the projects repository</span>
<span class="line-added">1061             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());</span>
<span class="line-added">1062             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="line-added">1063             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
<span class="line-added">1064 </span>
<span class="line-added">1065             // Break the jcheck configuration</span>
<span class="line-added">1066             var confPath = tempFolder.path().resolve(&quot;.jcheck/conf&quot;);</span>
<span class="line-added">1067             var oldConf = Files.readString(confPath, StandardCharsets.UTF_8);</span>
<span class="line-added">1068             Files.writeString(confPath, &quot;Hello there!&quot;, StandardCharsets.UTF_8);</span>
<span class="line-added">1069             localRepo.add(confPath);</span>
<span class="line-added">1070             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A change&quot;);</span>
<span class="line-added">1071             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);</span>
<span class="line-added">1072             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;,</span>
<span class="line-added">1073                                                    &quot;This is a pull request&quot;, true);</span>
<span class="line-added">1074 </span>
<span class="line-added">1075             // Check the status - should throw every time</span>
<span class="line-added">1076             assertThrows(RuntimeException.class, () -&gt; TestBotRunner.runPeriodicItems(checkBot));</span>
<span class="line-added">1077             assertThrows(RuntimeException.class, () -&gt; TestBotRunner.runPeriodicItems(checkBot));</span>
<span class="line-added">1078             assertThrows(RuntimeException.class, () -&gt; TestBotRunner.runPeriodicItems(checkBot));</span>
<span class="line-added">1079 </span>
<span class="line-added">1080             // Verify that the check failed</span>
<span class="line-added">1081             var checks = pr.checks(editHash);</span>
<span class="line-added">1082             assertEquals(1, checks.size());</span>
<span class="line-added">1083             var check = checks.get(&quot;jcheck&quot;);</span>
<span class="line-added">1084             assertEquals(CheckStatus.FAILURE, check.status());</span>
<span class="line-added">1085 </span>
<span class="line-added">1086             Files.writeString(confPath, oldConf, StandardCharsets.UTF_8);</span>
<span class="line-added">1087             localRepo.add(confPath);</span>
<span class="line-added">1088             editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another change&quot;);</span>
<span class="line-added">1089             localRepo.push(editHash, author.url(), &quot;edit&quot;);</span>
<span class="line-added">1090 </span>
<span class="line-added">1091             TestBotRunner.runPeriodicItems(checkBot);</span>
<span class="line-added">1092 </span>
<span class="line-added">1093             // Verify that the check now passes</span>
<span class="line-added">1094             checks = pr.checks(editHash);</span>
<span class="line-added">1095             assertEquals(1, checks.size());</span>
<span class="line-added">1096             check = checks.get(&quot;jcheck&quot;);</span>
<span class="line-added">1097             assertEquals(CheckStatus.SUCCESS, check.status());</span>
<span class="line-added">1098         }</span>
<span class="line-added">1099     }</span>
1100 }
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/pr/CheckRun.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>