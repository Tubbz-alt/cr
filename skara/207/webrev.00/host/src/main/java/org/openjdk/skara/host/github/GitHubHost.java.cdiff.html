<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff host/src/main/java/org/openjdk/skara/host/github/GitHubHost.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="GitHubApplication.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="GitHubPullRequest.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>host/src/main/java/org/openjdk/skara/host/github/GitHubHost.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 21,26 ***</span>
   * questions.
   */
  package org.openjdk.skara.host.github;
  
  import org.openjdk.skara.host.*;
<span class="line-modified">! import org.openjdk.skara.host.network.*;</span>
  import org.openjdk.skara.json.*;
  
  import java.net.*;
  import java.nio.charset.StandardCharsets;
  import java.util.Arrays;
  import java.util.regex.Pattern;
  
<span class="line-modified">! public class GitHubHost implements Host {</span>
      private final URI uri;
      private final Pattern webUriPattern;
      private final String webUriReplacement;
      private final GitHubApplication application;
      private final PersonalAccessToken pat;
      private final RestRequest request;
<span class="line-modified">!     private HostUserDetails currentUser;</span>
  
      public GitHubHost(URI uri, GitHubApplication application, Pattern webUriPattern, String webUriReplacement) {
          this.uri = uri;
          this.webUriPattern = webUriPattern;
          this.webUriReplacement = webUriReplacement;
<span class="line-new-header">--- 21,26 ---</span>
   * questions.
   */
  package org.openjdk.skara.host.github;
  
  import org.openjdk.skara.host.*;
<span class="line-modified">! import org.openjdk.skara.network.*;</span>
  import org.openjdk.skara.json.*;
  
  import java.net.*;
  import java.nio.charset.StandardCharsets;
  import java.util.Arrays;
  import java.util.regex.Pattern;
  
<span class="line-modified">! public class GitHubHost implements RepositoryHost {</span>
      private final URI uri;
      private final Pattern webUriPattern;
      private final String webUriReplacement;
      private final GitHubApplication application;
      private final PersonalAccessToken pat;
      private final RestRequest request;
<span class="line-modified">!     private HostUser currentUser;</span>
  
      public GitHubHost(URI uri, GitHubApplication application, Pattern webUriPattern, String webUriReplacement) {
          this.uri = uri;
          this.webUriPattern = webUriPattern;
          this.webUriReplacement = webUriReplacement;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 117,22 ***</span>
              return pat.token();
          }
      }
  
      private String getFullName(String userName) {
<span class="line-modified">!         var details = getUserDetails(userName);</span>
          return details.fullName();
      }
  
      // Most GitHub API&#39;s return user information in this format
<span class="line-modified">!     HostUserDetails parseUserField(JSONValue json) {</span>
          return parseUserObject(json.get(&quot;user&quot;));
      }
  
<span class="line-modified">!     HostUserDetails parseUserObject(JSONValue json) {</span>
<span class="line-modified">!         return new HostUserDetails(json.get(&quot;id&quot;).asInt(), json.get(&quot;login&quot;).asString(),</span>
<span class="line-modified">!                                    () -&gt; getFullName(json.get(&quot;login&quot;).asString()));</span>
      }
  
      @Override
      public boolean isValid() {
          var endpoints = request.get(&quot;&quot;)
<span class="line-new-header">--- 117,22 ---</span>
              return pat.token();
          }
      }
  
      private String getFullName(String userName) {
<span class="line-modified">!         var details = user(userName);</span>
          return details.fullName();
      }
  
      // Most GitHub API&#39;s return user information in this format
<span class="line-modified">!     HostUser parseUserField(JSONValue json) {</span>
          return parseUserObject(json.get(&quot;user&quot;));
      }
  
<span class="line-modified">!     HostUser parseUserObject(JSONValue json) {</span>
<span class="line-modified">!         return new HostUser(json.get(&quot;id&quot;).asInt(), json.get(&quot;login&quot;).asString(),</span>
<span class="line-modified">!                             () -&gt; getFullName(json.get(&quot;login&quot;).asString()));</span>
      }
  
      @Override
      public boolean isValid() {
          var endpoints = request.get(&quot;&quot;)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 153,43 ***</span>
                              .execute();
          return result.asObject();
      }
  
      @Override
<span class="line-modified">!     public HostedRepository getRepository(String name) {</span>
          return new GitHubRepository(this, name);
      }
  
      @Override
<span class="line-modified">!     public IssueProject getIssueProject(String name) {</span>
<span class="line-removed">-         throw new RuntimeException(&quot;not implemented yet&quot;);</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">-     @Override</span>
<span class="line-removed">-     public HostUserDetails getUserDetails(String username) {</span>
          var details = request.get(&quot;users/&quot; + URLEncoder.encode(username, StandardCharsets.UTF_8)).execute().asObject();
  
          // Always present
          var login = details.get(&quot;login&quot;).asString();
          var id = details.get(&quot;id&quot;).asInt();
  
          var name = details.get(&quot;name&quot;).asString();
          if (name == null) {
              name = login;
          }
<span class="line-modified">!         return new HostUserDetails(id, login, name);</span>
      }
  
      @Override
<span class="line-modified">!     public HostUserDetails getCurrentUserDetails() {</span>
          if (currentUser == null) {
              if (application != null) {
                  var appDetails = application.getAppDetails();
                  var appName = appDetails.get(&quot;name&quot;).asString() + &quot;[bot]&quot;;
<span class="line-modified">!                 currentUser = getUserDetails(appName);</span>
              } else if (pat != null) {
<span class="line-modified">!                 currentUser = getUserDetails(pat.userName());</span>
              } else {
                  throw new IllegalStateException(&quot;No credentials present&quot;);
              }
          }
          return currentUser;
<span class="line-new-header">--- 153,38 ---</span>
                              .execute();
          return result.asObject();
      }
  
      @Override
<span class="line-modified">!     public HostedRepository repository(String name) {</span>
          return new GitHubRepository(this, name);
      }
  
      @Override
<span class="line-modified">!     public HostUser user(String username) {</span>
          var details = request.get(&quot;users/&quot; + URLEncoder.encode(username, StandardCharsets.UTF_8)).execute().asObject();
  
          // Always present
          var login = details.get(&quot;login&quot;).asString();
          var id = details.get(&quot;id&quot;).asInt();
  
          var name = details.get(&quot;name&quot;).asString();
          if (name == null) {
              name = login;
          }
<span class="line-modified">!         return new HostUser(id, login, name);</span>
      }
  
      @Override
<span class="line-modified">!     public HostUser currentUser() {</span>
          if (currentUser == null) {
              if (application != null) {
                  var appDetails = application.getAppDetails();
                  var appName = appDetails.get(&quot;name&quot;).asString() + &quot;[bot]&quot;;
<span class="line-modified">!                 currentUser = user(appName);</span>
              } else if (pat != null) {
<span class="line-modified">!                 currentUser = user(pat.userName());</span>
              } else {
                  throw new IllegalStateException(&quot;No credentials present&quot;);
              }
          }
          return currentUser;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 199,11 ***</span>
      public boolean supportsReviewBody() {
          return true;
      }
  
      @Override
<span class="line-modified">!     public boolean isMemberOf(String groupId, HostUserDetails user) {</span>
          long gid = 0L;
          try {
              gid = Long.parseLong(groupId);
          } catch (NumberFormatException e) {
              throw new IllegalArgumentException(&quot;Group id is not a number: &quot; + groupId);
<span class="line-new-header">--- 194,11 ---</span>
      public boolean supportsReviewBody() {
          return true;
      }
  
      @Override
<span class="line-modified">!     public boolean isMemberOf(String groupId, HostUser user) {</span>
          long gid = 0L;
          try {
              gid = Long.parseLong(groupId);
          } catch (NumberFormatException e) {
              throw new IllegalArgumentException(&quot;Group id is not a number: &quot; + groupId);
</pre>
<center><a href="GitHubApplication.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="GitHubPullRequest.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>