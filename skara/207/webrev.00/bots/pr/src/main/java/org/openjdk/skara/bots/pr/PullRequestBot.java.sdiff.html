<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/pr/src/main/java/org/openjdk/skara/bots/pr/PullRequestBot.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ProjectPermissions.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="PullRequestInstance.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/pr/src/main/java/org/openjdk/skara/bots/pr/PullRequestBot.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 57         this.externalCommands = externalCommands;
 58         this.blockingLabels = blockingLabels;
 59         this.readyLabels = readyLabels;
 60         this.issueProject = issueProject;
 61         this.readyComments = readyComments;
 62         this.updateCache = new PullRequestUpdateCache();
 63     }
 64 
 65     PullRequestBot(HostedRepository repo, HostedRepository censusRepo, String censusRef,
 66                    Map&lt;String, List&lt;Pattern&gt;&gt; labelPatterns, Map&lt;String, String&gt; externalCommands,
 67                    Map&lt;String, String&gt; blockingLabels, Set&lt;String&gt; readyLabels,
 68                    Map&lt;String, Pattern&gt; readyComments) {
 69         this(repo, censusRepo, censusRef, labelPatterns, externalCommands, blockingLabels, readyLabels, readyComments, null);
 70     }
 71 
 72     PullRequestBot(HostedRepository repo, HostedRepository censusRepo, String censusRef) {
 73         this(repo, censusRepo, censusRef, Map.of(), Map.of(), Map.of(), Set.of(), Map.of(), null);
 74     }
 75 
 76     private boolean isReady(PullRequest pr) {
<span class="line-modified"> 77         var labels = new HashSet&lt;&gt;(pr.getLabels());</span>
 78         for (var readyLabel : readyLabels) {
 79             if (!labels.contains(readyLabel)) {
 80                 log.fine(&quot;PR is not yet ready - missing label &#39;&quot; + readyLabel + &quot;&#39;&quot;);
 81                 return false;
 82             }
 83         }
 84 
<span class="line-modified"> 85         var comments = pr.getComments();</span>
 86         for (var readyComment : readyComments.entrySet()) {
 87             var commentFound = false;
 88             for (var comment : comments) {
 89                 if (comment.author().userName().equals(readyComment.getKey())) {
 90                     var matcher = readyComment.getValue().matcher(comment.body());
 91                     if (matcher.find()) {
 92                         commentFound = true;
 93                         break;
 94                     }
 95                 }
 96             }
 97             if (!commentFound) {
 98                 log.fine(&quot;PR is not yet ready - missing ready comment from &#39;&quot; + readyComment.getKey() +
 99                                  &quot;containing &#39;&quot; + readyComment.getValue().pattern() + &quot;&#39;&quot;);
100                 return false;
101             }
102         }
103         return true;
104     }
105 
106     private List&lt;WorkItem&gt; getWorkItems(List&lt;PullRequest&gt; pullRequests) {
107         var ret = new LinkedList&lt;WorkItem&gt;();
108 
109         for (var pr : pullRequests) {
110             if (updateCache.needsUpdate(pr)) {
111                 if (!isReady(pr)) {
112                     continue;
113                 }
114 
115                 ret.add(new CheckWorkItem(pr, censusRepo, censusRef, blockingLabels, e -&gt; updateCache.invalidate(pr), issueProject));
116                 ret.add(new CommandWorkItem(pr, censusRepo, censusRef, externalCommands, e -&gt; updateCache.invalidate(pr)));
117                 ret.add(new LabelerWorkItem(pr, labelPatterns, currentLabels, e -&gt; updateCache.invalidate(pr)));
118             }
119         }
120 
121         return ret;
122     }
123 
124     @Override
125     public List&lt;WorkItem&gt; getPeriodicItems() {
<span class="line-modified">126         return getWorkItems(remoteRepo.getPullRequests());</span>
127     }
128 
129     @Override
130     public List&lt;WorkItem&gt; processWebHook(JSONValue body) {
131         var webHook = remoteRepo.parseWebHook(body);
132         if (webHook.isEmpty()) {
133             return new ArrayList&lt;&gt;();
134         }
135 
136         return getWorkItems(webHook.get().updatedPullRequests());
137     }
138 }
</pre>
</td>
<td>
<hr />
<pre>
 57         this.externalCommands = externalCommands;
 58         this.blockingLabels = blockingLabels;
 59         this.readyLabels = readyLabels;
 60         this.issueProject = issueProject;
 61         this.readyComments = readyComments;
 62         this.updateCache = new PullRequestUpdateCache();
 63     }
 64 
 65     PullRequestBot(HostedRepository repo, HostedRepository censusRepo, String censusRef,
 66                    Map&lt;String, List&lt;Pattern&gt;&gt; labelPatterns, Map&lt;String, String&gt; externalCommands,
 67                    Map&lt;String, String&gt; blockingLabels, Set&lt;String&gt; readyLabels,
 68                    Map&lt;String, Pattern&gt; readyComments) {
 69         this(repo, censusRepo, censusRef, labelPatterns, externalCommands, blockingLabels, readyLabels, readyComments, null);
 70     }
 71 
 72     PullRequestBot(HostedRepository repo, HostedRepository censusRepo, String censusRef) {
 73         this(repo, censusRepo, censusRef, Map.of(), Map.of(), Map.of(), Set.of(), Map.of(), null);
 74     }
 75 
 76     private boolean isReady(PullRequest pr) {
<span class="line-modified"> 77         var labels = new HashSet&lt;&gt;(pr.labels());</span>
 78         for (var readyLabel : readyLabels) {
 79             if (!labels.contains(readyLabel)) {
 80                 log.fine(&quot;PR is not yet ready - missing label &#39;&quot; + readyLabel + &quot;&#39;&quot;);
 81                 return false;
 82             }
 83         }
 84 
<span class="line-modified"> 85         var comments = pr.comments();</span>
 86         for (var readyComment : readyComments.entrySet()) {
 87             var commentFound = false;
 88             for (var comment : comments) {
 89                 if (comment.author().userName().equals(readyComment.getKey())) {
 90                     var matcher = readyComment.getValue().matcher(comment.body());
 91                     if (matcher.find()) {
 92                         commentFound = true;
 93                         break;
 94                     }
 95                 }
 96             }
 97             if (!commentFound) {
 98                 log.fine(&quot;PR is not yet ready - missing ready comment from &#39;&quot; + readyComment.getKey() +
 99                                  &quot;containing &#39;&quot; + readyComment.getValue().pattern() + &quot;&#39;&quot;);
100                 return false;
101             }
102         }
103         return true;
104     }
105 
106     private List&lt;WorkItem&gt; getWorkItems(List&lt;PullRequest&gt; pullRequests) {
107         var ret = new LinkedList&lt;WorkItem&gt;();
108 
109         for (var pr : pullRequests) {
110             if (updateCache.needsUpdate(pr)) {
111                 if (!isReady(pr)) {
112                     continue;
113                 }
114 
115                 ret.add(new CheckWorkItem(pr, censusRepo, censusRef, blockingLabels, e -&gt; updateCache.invalidate(pr), issueProject));
116                 ret.add(new CommandWorkItem(pr, censusRepo, censusRef, externalCommands, e -&gt; updateCache.invalidate(pr)));
117                 ret.add(new LabelerWorkItem(pr, labelPatterns, currentLabels, e -&gt; updateCache.invalidate(pr)));
118             }
119         }
120 
121         return ret;
122     }
123 
124     @Override
125     public List&lt;WorkItem&gt; getPeriodicItems() {
<span class="line-modified">126         return getWorkItems(remoteRepo.pullRequests());</span>
127     }
128 
129     @Override
130     public List&lt;WorkItem&gt; processWebHook(JSONValue body) {
131         var webHook = remoteRepo.parseWebHook(body);
132         if (webHook.isEmpty()) {
133             return new ArrayList&lt;&gt;();
134         }
135 
136         return getWorkItems(webHook.get().updatedPullRequests());
137     }
138 }
</pre>
</td>
</tr>
</table>
<center><a href="ProjectPermissions.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="PullRequestInstance.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>