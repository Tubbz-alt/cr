<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/pr/src/test/java/org/openjdk/skara/bots/pr/CheckTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/pr/Veto.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="CommandTests.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/pr/src/test/java/org/openjdk/skara/bots/pr/CheckTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  27 
  28 import org.junit.jupiter.api.*;
  29 
  30 import java.io.IOException;
  31 import java.nio.file.*;
  32 import java.util.*;
  33 import java.util.regex.Pattern;
  34 
  35 import static org.junit.jupiter.api.Assertions.*;
  36 import static org.junit.jupiter.api.Assumptions.assumeTrue;
  37 
  38 class CheckTests {
  39     @Test
  40     void simpleCommit(TestInfo testInfo) throws IOException {
  41         try (var credentials = new HostCredentials(testInfo);
  42              var tempFolder = new TemporaryDirectory()) {
  43             var author = credentials.getHostedRepository();
  44             var reviewer = credentials.getHostedRepository();
  45 
  46             var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified">  47                                            .addAuthor(author.host().getCurrentUserDetails().id())</span>
<span class="line-modified">  48                                            .addReviewer(reviewer.host().getCurrentUserDetails().id());</span>
  49             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
  50 
  51             // Populate the projects repository
<span class="line-modified">  52             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());</span>
  53             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified">  54             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);</span>
  55 
  56             // Make a change with a corresponding PR
  57             var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified">  58             localRepo.push(editHash, author.getUrl(), &quot;refs/heads/edit&quot;, true);</span>
  59             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
  60 
  61             // Check the status
  62             TestBotRunner.runPeriodicItems(checkBot);
  63 
  64             // Verify that the check succeeded
<span class="line-modified">  65             var checks = pr.getChecks(editHash);</span>
  66             assertEquals(1, checks.size());
  67             var check = checks.get(&quot;jcheck&quot;);
  68             assertEquals(CheckStatus.SUCCESS, check.status());
  69 
  70             // The PR should now be ready for review
<span class="line-modified">  71             assertTrue(pr.getLabels().contains(&quot;rfr&quot;));</span>
<span class="line-modified">  72             assertFalse(pr.getLabels().contains(&quot;ready&quot;));</span>
  73 
  74             // Approve it as another user
<span class="line-modified">  75             var approvalPr = reviewer.getPullRequest(pr.getId());</span>
  76             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
  77 
  78             // Check the status again
  79             TestBotRunner.runPeriodicItems(checkBot);
  80 
  81             // The check should now be successful
<span class="line-modified">  82             checks = pr.getChecks(editHash);</span>
  83             assertEquals(1, checks.size());
  84             check = checks.get(&quot;jcheck&quot;);
  85             assertEquals(CheckStatus.SUCCESS, check.status());
  86 
  87             // The PR should not be flagged as ready for review, at it is already reviewed
<span class="line-modified">  88             assertFalse(pr.getLabels().contains(&quot;rfr&quot;));</span>
<span class="line-modified">  89             assertTrue(pr.getLabels().contains(&quot;ready&quot;));</span>
  90         }
  91     }
  92 
  93     @Test
  94     void whitespaceIssue(TestInfo testInfo) throws IOException {
  95         try (var credentials = new HostCredentials(testInfo);
  96              var tempFolder = new TemporaryDirectory()) {
  97 
  98             var author = credentials.getHostedRepository();
  99             var reviewer = credentials.getHostedRepository();
 100 
 101             var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified"> 102                                            .addAuthor(author.host().getCurrentUserDetails().id())</span>
<span class="line-modified"> 103                                            .addReviewer(reviewer.host().getCurrentUserDetails().id());</span>
 104             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
 105 
 106             // Populate the projects repository
<span class="line-modified"> 107             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());</span>
 108             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified"> 109             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);</span>
 110 
 111             // Make a change with a corresponding PR
 112             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line with a trailing whitespace   &quot;);
<span class="line-modified"> 113             localRepo.push(editHash, author.getUrl(), &quot;refs/heads/edit&quot;, true);</span>
 114             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 115 
 116             // Check the status
 117             TestBotRunner.runPeriodicItems(checkBot);
 118 
 119             // The PR should not be flagged as ready for review
<span class="line-modified"> 120             assertFalse(pr.getLabels().contains(&quot;rfr&quot;));</span>
 121 
 122             // Approve it as another user
<span class="line-modified"> 123             var approvalPr = reviewer.getPullRequest(pr.getId());</span>
 124             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 125 
 126             // Check the status
 127             TestBotRunner.runPeriodicItems(checkBot);
 128 
 129             // Verify that the check failed
<span class="line-modified"> 130             var checks = pr.getChecks(editHash);</span>
 131             assertEquals(1, checks.size());
 132             var check = checks.get(&quot;jcheck&quot;);
 133             assertEquals(CheckStatus.FAILURE, check.status());
 134 
 135             // The PR should not still not be flagged as ready for review
<span class="line-modified"> 136             assertFalse(pr.getLabels().contains(&quot;rfr&quot;));</span>
 137 
 138             // Remove the trailing whitespace in a new commit
 139             editHash = CheckableRepository.replaceAndCommit(localRepo, &quot;A line without a trailing whitespace&quot;);
<span class="line-modified"> 140             localRepo.push(editHash, author.getUrl(), &quot;refs/heads/edit&quot;, true);</span>
 141 
 142             // Make sure that the push registered
<span class="line-modified"> 143             var lastHeadHash = pr.getHeadHash();</span>
 144             var refreshCount = 0;
 145             do {
<span class="line-modified"> 146                 pr = author.getPullRequest(pr.getId());</span>
 147                 if (refreshCount++ &gt; 100) {
 148                     fail(&quot;The PR did not update after the new push&quot;);
 149                 }
<span class="line-modified"> 150             } while (pr.getHeadHash().equals(lastHeadHash));</span>
 151 
 152             // Check the status again
 153             TestBotRunner.runPeriodicItems(checkBot);
 154 
 155             // The PR should not be flagged as ready for review, at it is already reviewed
<span class="line-modified"> 156             assertFalse(pr.getLabels().contains(&quot;rfr&quot;));</span>
 157 
 158             // The check should now be successful
<span class="line-modified"> 159             checks = pr.getChecks(editHash);</span>
 160             assertEquals(1, checks.size());
 161             check = checks.get(&quot;jcheck&quot;);
 162             assertEquals(CheckStatus.SUCCESS, check.status());
 163         }
 164     }
 165 
 166     @Test
 167     void multipleReviews(TestInfo testInfo) throws IOException {
 168         try (var credentials = new HostCredentials(testInfo);
 169              var tempFolder = new TemporaryDirectory()) {
 170 
 171             var author = credentials.getHostedRepository();
 172             var reviewer = credentials.getHostedRepository();
 173             var commenter = credentials.getHostedRepository();
 174 
 175             var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified"> 176                                            .addAuthor(author.host().getCurrentUserDetails().id())</span>
<span class="line-modified"> 177                                            .addReviewer(reviewer.host().getCurrentUserDetails().id())</span>
<span class="line-modified"> 178                                            .addReviewer(commenter.host().getCurrentUserDetails().id());</span>
 179 
 180             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
 181 
 182             // Populate the projects repository
<span class="line-modified"> 183             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());</span>
 184             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified"> 185             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);</span>
 186 
 187             // Make a change with a corresponding PR
 188             var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified"> 189             localRepo.push(editHash, author.getUrl(), &quot;refs/heads/edit&quot;, true);</span>
 190             var authorPr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 191 
 192             // Let the status bot inspect the PR
 193             TestBotRunner.runPeriodicItems(checkBot);
<span class="line-modified"> 194             assertFalse(authorPr.getBody().contains(&quot;Approvers&quot;));</span>
 195 
 196             // Approve it
<span class="line-modified"> 197             var reviewerPr = reviewer.getPullRequest(authorPr.getId());</span>
 198             reviewerPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 199             TestBotRunner.runPeriodicItems(checkBot);
 200 
 201             // Refresh the PR and check that it has been approved
<span class="line-modified"> 202             authorPr = author.getPullRequest(authorPr.getId());</span>
<span class="line-modified"> 203             assertTrue(authorPr.getBody().contains(&quot;Approvers&quot;));</span>
 204 
 205             // Update the file after approval
 206             editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Now I&#39;ve gone and changed it&quot;);
<span class="line-modified"> 207             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);</span>
 208 
 209             // Make sure that the push registered
<span class="line-modified"> 210             var lastHeadHash = authorPr.getHeadHash();</span>
 211             var refreshCount = 0;
 212             do {
<span class="line-modified"> 213                 authorPr = author.getPullRequest(authorPr.getId());</span>
 214                 if (refreshCount++ &gt; 100) {
 215                     fail(&quot;The PR did not update after the new push&quot;);
 216                 }
<span class="line-modified"> 217             } while (authorPr.getHeadHash().equals(lastHeadHash));</span>
 218 
 219             // Check that the review is flagged as stale
 220             TestBotRunner.runPeriodicItems(checkBot);
<span class="line-modified"> 221             authorPr = author.getPullRequest(authorPr.getId());</span>
<span class="line-modified"> 222             assertTrue(authorPr.getBody().contains(&quot;Note&quot;));</span>
 223 
 224             // Now we can approve it again
 225             reviewerPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 226             TestBotRunner.runPeriodicItems(checkBot);
 227 
 228             // Refresh the PR and check that it has been approved (once) and is no longer stale
<span class="line-modified"> 229             authorPr = author.getPullRequest(authorPr.getId());</span>
<span class="line-modified"> 230             assertTrue(authorPr.getBody().contains(&quot;Approvers&quot;));</span>
<span class="line-modified"> 231             assertEquals(1, authorPr.getBody().split(&quot;Generated Reviewer&quot;, -1).length - 1);</span>
<span class="line-modified"> 232             assertTrue(authorPr.getReviews().size() &gt;= 1);</span>
<span class="line-modified"> 233             assertFalse(authorPr.getBody().contains(&quot;Note&quot;));</span>
 234 
 235             // Add a review with disapproval
<span class="line-modified"> 236             var commenterPr = commenter.getPullRequest(authorPr.getId());</span>
 237             commenterPr.addReview(Review.Verdict.DISAPPROVED, &quot;Disapproved&quot;);
 238             TestBotRunner.runPeriodicItems(checkBot);
 239 
 240             // Refresh the PR and check that it still only approved once (but two reviews) and is no longer stale
<span class="line-modified"> 241             authorPr = author.getPullRequest(authorPr.getId());</span>
<span class="line-modified"> 242             assertTrue(authorPr.getBody().contains(&quot;Approvers&quot;));</span>
<span class="line-modified"> 243             assertEquals(1, authorPr.getBody().split(&quot;Generated Reviewer&quot;, -1).length - 1);</span>
<span class="line-modified"> 244             assertTrue(authorPr.getReviews().size() &gt;= 2);</span>
<span class="line-modified"> 245             assertFalse(authorPr.getBody().contains(&quot;Note&quot;));</span>
 246         }
 247     }
 248 
 249     @Test
 250     void selfReview(TestInfo testInfo) throws IOException {
 251         try (var credentials = new HostCredentials(testInfo);
 252              var tempFolder = new TemporaryDirectory()) {
 253 
 254             var author = credentials.getHostedRepository();
 255 
 256             var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified"> 257                                            .addReviewer(author.host().getCurrentUserDetails().id());</span>
 258 
 259             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
 260 
 261             // Populate the projects repository
<span class="line-modified"> 262             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());</span>
 263             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified"> 264             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);</span>
 265 
 266             // Make a change with a corresponding PR
 267             var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified"> 268             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);</span>
 269             var authorPr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 270 
 271             // Let the status bot inspect the PR
 272             TestBotRunner.runPeriodicItems(checkBot);
<span class="line-modified"> 273             assertFalse(authorPr.getBody().contains(&quot;Approvers&quot;));</span>
 274 
 275             // Approve it
 276             authorPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 277             TestBotRunner.runPeriodicItems(checkBot);
 278 
 279             // Refresh the PR and check that it has been approved
<span class="line-modified"> 280             authorPr = author.getPullRequest(authorPr.getId());</span>
<span class="line-modified"> 281             assertTrue(authorPr.getBody().contains(&quot;Approvers&quot;));</span>
 282 
 283             // Verify that the check failed
<span class="line-modified"> 284             var checks = authorPr.getChecks(editHash);</span>
 285             assertEquals(1, checks.size());
 286             var check = checks.get(&quot;jcheck&quot;);
 287             assertEquals(CheckStatus.FAILURE, check.status());
 288         }
 289     }
 290 
 291     @Test
 292     void multipleCommitters(TestInfo testInfo) throws IOException {
 293         try (var credentials = new HostCredentials(testInfo);
 294              var tempFolder = new TemporaryDirectory()) {
 295             var author = credentials.getHostedRepository();
 296             var reviewer = credentials.getHostedRepository();
 297 
 298             var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified"> 299                                            .addReviewer(reviewer.host().getCurrentUserDetails().id());</span>
 300             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
 301 
 302             // Populate the projects repository
<span class="line-modified"> 303             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());</span>
 304             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified"> 305             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);</span>
 306 
 307             // Make two changes with different authors
 308             CheckableRepository.appendAndCommit(localRepo, &quot;First edit&quot;, &quot;Edit by number 1&quot;,
 309                                                 &quot;number1&quot;, &quot;number1@none.none&quot;);
 310             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Second edit&quot;, &quot;Edit by number 2&quot;,
 311                                                                &quot;number2&quot;, &quot;number2@none.none&quot;);
<span class="line-modified"> 312             localRepo.push(editHash, author.getUrl(), &quot;refs/heads/edit&quot;, true);</span>
 313             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 314 
 315             // Check the status
 316             TestBotRunner.runPeriodicItems(checkBot);
 317 
 318             // Verify that the check failed
<span class="line-modified"> 319             var checks = pr.getChecks(editHash);</span>
 320             assertEquals(1, checks.size());
 321             var check = checks.get(&quot;jcheck&quot;);
 322             assertEquals(CheckStatus.FAILURE, check.status());
 323 
 324             // Approve it as another user
<span class="line-modified"> 325             var approvalPr = reviewer.getPullRequest(pr.getId());</span>
 326             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 327 
 328             // Check the status again
 329             TestBotRunner.runPeriodicItems(checkBot);
 330 
 331             // The check should still be failing
<span class="line-modified"> 332             checks = pr.getChecks(editHash);</span>
 333             assertEquals(1, checks.size());
 334             check = checks.get(&quot;jcheck&quot;);
 335             assertEquals(CheckStatus.FAILURE, check.status());
 336 
 337             // The PR should not be flagged as ready for review, as multiple committers is a problem
<span class="line-modified"> 338             assertFalse(pr.getLabels().contains(&quot;rfr&quot;));</span>
 339         }
 340     }
 341 
 342     @Test
 343     void updatedContentFailsCheck(TestInfo testInfo) throws IOException {
 344         try (var credentials = new HostCredentials(testInfo);
 345              var tempFolder = new TemporaryDirectory()) {
 346             var author = credentials.getHostedRepository();
 347             var reviewer = credentials.getHostedRepository();
 348 
 349             var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified"> 350                                            .addAuthor(author.host().getCurrentUserDetails().id())</span>
<span class="line-modified"> 351                                            .addReviewer(reviewer.host().getCurrentUserDetails().id());</span>
 352             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
 353 
 354             // Populate the projects repository
<span class="line-modified"> 355             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());</span>
 356             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified"> 357             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);</span>
 358 
 359             // Make a change with a corresponding PR
 360             var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified"> 361             localRepo.push(editHash, author.getUrl(), &quot;refs/heads/edit&quot;, true);</span>
 362             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 363 
 364             // Check the status
 365             TestBotRunner.runPeriodicItems(checkBot);
 366 
 367             // Verify that the check passed
<span class="line-modified"> 368             var checks = pr.getChecks(editHash);</span>
 369             assertEquals(1, checks.size());
 370             var check = checks.get(&quot;jcheck&quot;);
 371             assertEquals(CheckStatus.SUCCESS, check.status());
 372 
 373             // The PR should now be ready for review
<span class="line-modified"> 374             assertTrue(pr.getLabels().contains(&quot;rfr&quot;));</span>
<span class="line-modified"> 375             assertFalse(pr.getLabels().contains(&quot;ready&quot;));</span>
 376 
 377             // Approve it as another user
<span class="line-modified"> 378             var approvalPr = reviewer.getPullRequest(pr.getId());</span>
 379             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 380 
 381             // Check the status again
 382             TestBotRunner.runPeriodicItems(checkBot);
 383 
 384             // The check should now be successful
<span class="line-modified"> 385             checks = pr.getChecks(editHash);</span>
 386             assertEquals(1, checks.size());
 387             check = checks.get(&quot;jcheck&quot;);
 388             assertEquals(CheckStatus.SUCCESS, check.status());
 389 
 390             // The PR should not be flagged as ready for review, at it is already reviewed
<span class="line-modified"> 391             assertFalse(pr.getLabels().contains(&quot;rfr&quot;));</span>
<span class="line-modified"> 392             assertTrue(pr.getLabels().contains(&quot;ready&quot;));</span>
 393 
 394             var addedHash = CheckableRepository.appendAndCommit(localRepo, &quot;trailing whitespace   &quot;);
<span class="line-modified"> 395             localRepo.push(addedHash, author.getUrl(), &quot;edit&quot;);</span>
 396 
 397             // Make sure that the push registered
<span class="line-modified"> 398             var lastHeadHash = pr.getHeadHash();</span>
 399             var refreshCount = 0;
 400             do {
<span class="line-modified"> 401                 pr = author.getPullRequest(pr.getId());</span>
 402                 if (refreshCount++ &gt; 100) {
 403                     fail(&quot;The PR did not update after the new push&quot;);
 404                 }
<span class="line-modified"> 405             } while (pr.getHeadHash().equals(lastHeadHash));</span>
 406 
 407             // Check the status
 408             TestBotRunner.runPeriodicItems(checkBot);
 409 
 410             // The PR is now neither ready for review nor integration
<span class="line-modified"> 411             assertFalse(pr.getLabels().contains(&quot;rfr&quot;));</span>
<span class="line-modified"> 412             assertFalse(pr.getLabels().contains(&quot;ready&quot;));</span>
 413 
 414             // The check should now be failing
<span class="line-modified"> 415             checks = pr.getChecks(addedHash);</span>
 416             assertEquals(1, checks.size());
 417             check = checks.get(&quot;jcheck&quot;);
 418             assertEquals(CheckStatus.FAILURE, check.status());
 419         }
 420     }
 421 
 422     @Test
 423     void individualReviewComments(TestInfo testInfo) throws IOException {
 424         try (var credentials = new HostCredentials(testInfo);
 425              var tempFolder = new TemporaryDirectory()) {
 426             var author = credentials.getHostedRepository();
 427             var reviewer = credentials.getHostedRepository();
 428 
 429             // This test is only relevant on hosts not supporting proper review comment bodies
 430             assumeTrue(!author.host().supportsReviewBody());
 431 
 432             var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified"> 433                                            .addAuthor(author.host().getCurrentUserDetails().id())</span>
<span class="line-modified"> 434                                            .addReviewer(reviewer.host().getCurrentUserDetails().id());</span>
 435             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
 436 
 437             // Populate the projects repository
<span class="line-modified"> 438             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());</span>
 439             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified"> 440             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);</span>
 441 
 442             // Make a change with a corresponding PR
 443             var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified"> 444             localRepo.push(editHash, author.getUrl(), &quot;refs/heads/edit&quot;, true);</span>
 445             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 446 
 447             // Check the status
 448             TestBotRunner.runPeriodicItems(checkBot);
<span class="line-modified"> 449             var comments = pr.getComments();</span>
 450             var commentCount = comments.size();
 451 
 452             // Approve it as another user
<span class="line-modified"> 453             var approvalPr = reviewer.getPullRequest(pr.getId());</span>
 454             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 455 
 456             // Check the status again
 457             TestBotRunner.runPeriodicItems(checkBot);
 458 
 459             // There should now be two additional comments
<span class="line-modified"> 460             comments = pr.getComments();</span>
 461             assertEquals(commentCount + 2, comments.size());
 462             var comment = comments.get(commentCount);
<span class="line-modified"> 463             assertTrue(comment.body().contains(reviewer.host().getCurrentUserDetails().userName()));</span>
 464             assertTrue(comment.body().contains(&quot;approved&quot;));
 465 
 466             // Drop the review
 467             approvalPr.addReview(Review.Verdict.NONE, &quot;Unreviewed&quot;);
 468 
 469             // Check the status again
 470             TestBotRunner.runPeriodicItems(checkBot);
 471 
 472             // There should now be yet another comment
<span class="line-modified"> 473             comments = pr.getComments();</span>
 474             assertEquals(commentCount + 3, comments.size());
 475             comment = comments.get(commentCount + 2);
<span class="line-modified"> 476             assertTrue(comment.body().contains(reviewer.host().getCurrentUserDetails().userName()));</span>
 477             assertTrue(comment.body().contains(&quot;comment&quot;));
 478 
 479             // No changes should not generate additional comments
 480             TestBotRunner.runPeriodicItems(checkBot);
<span class="line-modified"> 481             comments = pr.getComments();</span>
 482             assertEquals(commentCount + 3, comments.size());
 483         }
 484     }
 485 
 486     @Test
 487     void mergeMessage(TestInfo testInfo) throws IOException {
 488         try (var credentials = new HostCredentials(testInfo);
 489              var tempFolder = new TemporaryDirectory();
 490              var pushedFolder = new TemporaryDirectory()) {
 491 
 492             var author = credentials.getHostedRepository();
 493             var integrator = credentials.getHostedRepository();
 494             var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified"> 495                                            .addCommitter(author.host().getCurrentUserDetails().id())</span>
<span class="line-modified"> 496                                            .addReviewer(integrator.host().getCurrentUserDetails().id());</span>
 497             var mergeBot = new PullRequestBot(integrator, censusBuilder.build(), &quot;master&quot;);
 498 
 499             // Populate the projects repository
<span class="line-modified"> 500             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());</span>
 501             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 502             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
<span class="line-modified"> 503             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);</span>
 504 
 505             // Make a change with a corresponding PR
 506             var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified"> 507             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);</span>
 508             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 509 
 510             // Approve it as another user
<span class="line-modified"> 511             var approvalPr = integrator.getPullRequest(pr.getId());</span>
 512             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 513 
 514             // Get all messages up to date
 515             TestBotRunner.runPeriodicItems(mergeBot);
 516 
 517             // Push something unrelated to master
 518             localRepo.checkout(masterHash, true);
 519             var unrelated = localRepo.root().resolve(&quot;unrelated.txt&quot;);
 520             Files.writeString(unrelated, &quot;Hello&quot;);
 521             localRepo.add(unrelated);
 522             var unrelatedHash = localRepo.commit(&quot;Unrelated&quot;, &quot;X&quot;, &quot;x@y.z&quot;);
<span class="line-modified"> 523             localRepo.push(unrelatedHash, author.getUrl(), &quot;master&quot;);</span>
 524 
 525             // Let the bot see the changes
 526             TestBotRunner.runPeriodicItems(mergeBot);
 527 
 528             // The bot should reply with an ok message
<span class="line-modified"> 529             var updated = pr.getComments().stream()</span>
 530                             .filter(comment -&gt; comment.body().contains(&quot;there has been 1 commit&quot;))
 531                             .filter(comment -&gt; comment.body().contains(&quot;please merge&quot;))
 532                             .count();
 533             assertEquals(1, updated);
 534         }
 535     }
 536 
 537     @Test
 538     void cannotRebase(TestInfo testInfo) throws IOException {
 539         try (var credentials = new HostCredentials(testInfo);
 540              var tempFolder = new TemporaryDirectory();
 541              var pushedFolder = new TemporaryDirectory()) {
 542 
 543             var author = credentials.getHostedRepository();
 544             var integrator = credentials.getHostedRepository();
 545             var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified"> 546                                            .addCommitter(author.host().getCurrentUserDetails().id())</span>
<span class="line-modified"> 547                                            .addReviewer(integrator.host().getCurrentUserDetails().id());</span>
 548             var mergeBot = new PullRequestBot(integrator, censusBuilder.build(), &quot;master&quot;);
 549 
 550             // Populate the projects repository
<span class="line-modified"> 551             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());</span>
 552             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 553             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
<span class="line-modified"> 554             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);</span>
 555 
 556             // Make a change with a corresponding PR
 557             var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified"> 558             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);</span>
 559             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 560 
 561             // Approve it as another user
<span class="line-modified"> 562             var approvalPr = integrator.getPullRequest(pr.getId());</span>
 563             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 564 
 565             // Get all messages up to date
 566             TestBotRunner.runPeriodicItems(mergeBot);
 567 
 568             // Push something conflicting to master
 569             localRepo.checkout(masterHash, true);
 570             var conflictingHash = CheckableRepository.appendAndCommit(localRepo, &quot;This looks like a conflict&quot;);
<span class="line-modified"> 571             localRepo.push(conflictingHash, author.getUrl(), &quot;master&quot;);</span>
 572 
 573             // Let the bot see the changes
 574             TestBotRunner.runPeriodicItems(mergeBot);
 575 
 576             // The bot should reply with that there is a conflict
<span class="line-modified"> 577             var updated = pr.getComments().stream()</span>
 578                             .filter(comment -&gt; comment.body().contains(&quot;there has been 1 commit&quot;))
 579                             .filter(comment -&gt; comment.body().contains(&quot;cannot be rebased automatically&quot;))
 580                             .count();
 581             assertEquals(1, updated);
 582 
 583             // The PR should be flagged as outdated
<span class="line-modified"> 584             assertTrue(pr.getLabels().contains(&quot;outdated&quot;));</span>
 585 
 586             // But it should still pass jcheck
<span class="line-modified"> 587             var checks = pr.getChecks(editHash);</span>
 588             assertEquals(1, checks.size());
 589             var check = checks.get(&quot;jcheck&quot;);
 590             assertEquals(CheckStatus.SUCCESS, check.status());
 591 
 592             // Restore the master branch
<span class="line-modified"> 593             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);</span>
 594 
 595             // Let the bot see the changes
 596             TestBotRunner.runPeriodicItems(mergeBot);
 597 
 598             // The bot should no longer detect a conflict
<span class="line-modified"> 599             updated = pr.getComments().stream()</span>
<span class="line-modified"> 600                             .filter(comment -&gt; comment.body().contains(&quot;change can now be integrated&quot;))</span>
<span class="line-modified"> 601                             .count();</span>
 602             assertEquals(1, updated);
 603 
 604             // The PR should not be flagged as outdated
<span class="line-modified"> 605             assertFalse(pr.getLabels().contains(&quot;outdated&quot;));</span>
 606         }
 607     }
 608 
 609     @Test
 610     void blockingLabel(TestInfo testInfo) throws IOException {
 611         try (var credentials = new HostCredentials(testInfo);
 612              var tempFolder = new TemporaryDirectory()) {
 613             var author = credentials.getHostedRepository();
 614             var reviewer = credentials.getHostedRepository();
 615 
 616             var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified"> 617                                            .addAuthor(author.host().getCurrentUserDetails().id())</span>
<span class="line-modified"> 618                                            .addReviewer(reviewer.host().getCurrentUserDetails().id());</span>
 619             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;, Map.of(), Map.of(),
 620                                               Map.of(&quot;block&quot;, &quot;Test Blocker&quot;), Set.of(), Map.of());
 621 
 622             // Populate the projects repository
<span class="line-modified"> 623             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());</span>
 624             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified"> 625             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);</span>
 626 
 627             // Make a change with a corresponding PR
 628             var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified"> 629             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);</span>
 630             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 631             pr.addLabel(&quot;block&quot;);
 632 
 633             // Check the status
 634             TestBotRunner.runPeriodicItems(checkBot);
 635 
 636             // Verify that the check failed
<span class="line-modified"> 637             var checks = pr.getChecks(editHash);</span>
 638             assertEquals(1, checks.size());
 639             var check = checks.get(&quot;jcheck&quot;);
 640             assertEquals(CheckStatus.FAILURE, check.status());
 641             assertTrue(check.summary().orElseThrow().contains(&quot;Test Blocker&quot;));
 642 
 643             // The PR should not yet be ready for review
<span class="line-modified"> 644             assertTrue(pr.getLabels().contains(&quot;block&quot;));</span>
<span class="line-modified"> 645             assertFalse(pr.getLabels().contains(&quot;rfr&quot;));</span>
<span class="line-modified"> 646             assertFalse(pr.getLabels().contains(&quot;ready&quot;));</span>
 647 
 648             // Check the status again
 649             pr.removeLabel(&quot;block&quot;);
 650             TestBotRunner.runPeriodicItems(checkBot);
 651 
 652             // The PR should now be ready for review
<span class="line-modified"> 653             assertTrue(pr.getLabels().contains(&quot;rfr&quot;));</span>
<span class="line-modified"> 654             assertFalse(pr.getLabels().contains(&quot;ready&quot;));</span>
 655         }
 656     }
 657 
 658     @Test
 659     void missingReadyLabel(TestInfo testInfo) throws IOException {
 660         try (var credentials = new HostCredentials(testInfo);
 661              var tempFolder = new TemporaryDirectory()) {
 662             var author = credentials.getHostedRepository();
 663             var reviewer = credentials.getHostedRepository();
 664 
 665             var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified"> 666                                            .addAuthor(author.host().getCurrentUserDetails().id())</span>
<span class="line-modified"> 667                                            .addReviewer(reviewer.host().getCurrentUserDetails().id());</span>
 668             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;, Map.of(), Map.of(),
 669                                               Map.of(), Set.of(&quot;good-to-go&quot;), Map.of());
 670 
 671             // Populate the projects repository
<span class="line-modified"> 672             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());</span>
 673             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified"> 674             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);</span>
 675 
 676             // Make a change with a corresponding PR
 677             var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified"> 678             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);</span>
 679             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 680 
 681             // Check the status
 682             TestBotRunner.runPeriodicItems(checkBot);
 683 
 684             // Verify that no checks have been run
<span class="line-modified"> 685             var checks = pr.getChecks(editHash);</span>
 686             assertEquals(0, checks.size());
 687 
 688             // The PR should not yet be ready for review
<span class="line-modified"> 689             assertFalse(pr.getLabels().contains(&quot;rfr&quot;));</span>
 690 
 691             // Check the status again
 692             pr.addLabel(&quot;good-to-go&quot;);
 693             TestBotRunner.runPeriodicItems(checkBot);
 694 
 695             // The PR should now be ready for review
<span class="line-modified"> 696             assertTrue(pr.getLabels().contains(&quot;rfr&quot;));</span>
 697         }
 698     }
 699 
 700     @Test
 701     void missingReadyComment(TestInfo testInfo) throws IOException {
 702         try (var credentials = new HostCredentials(testInfo);
 703              var tempFolder = new TemporaryDirectory()) {
 704             var author = credentials.getHostedRepository();
 705             var reviewer = credentials.getHostedRepository();
 706 
 707             var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified"> 708                                            .addAuthor(author.host().getCurrentUserDetails().id())</span>
<span class="line-modified"> 709                                            .addReviewer(reviewer.host().getCurrentUserDetails().id());</span>
 710             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;, Map.of(), Map.of(),
<span class="line-modified"> 711                                               Map.of(), Set.of(), Map.of(reviewer.host().getCurrentUserDetails().userName(), Pattern.compile(&quot;proceed&quot;)));</span>
 712 
 713             // Populate the projects repository
<span class="line-modified"> 714             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());</span>
 715             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified"> 716             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);</span>
 717 
 718             // Make a change with a corresponding PR
 719             var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified"> 720             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);</span>
 721             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 722 
 723             // Check the status
 724             TestBotRunner.runPeriodicItems(checkBot);
 725 
 726             // Verify that no checks have been run
<span class="line-modified"> 727             var checks = pr.getChecks(editHash);</span>
 728             assertEquals(0, checks.size());
 729 
 730             // The PR should not yet be ready for review
<span class="line-modified"> 731             assertFalse(pr.getLabels().contains(&quot;rfr&quot;));</span>
 732 
 733             // Check the status again
<span class="line-modified"> 734             var reviewerPr = reviewer.getPullRequest(pr.getId());</span>
 735             reviewerPr.addComment(&quot;proceed&quot;);
 736             TestBotRunner.runPeriodicItems(checkBot);
 737 
 738             // The PR should now be ready for review
<span class="line-modified"> 739             assertTrue(pr.getLabels().contains(&quot;rfr&quot;));</span>
 740         }
 741     }
 742 
 743     @Test
 744     void issueIssue(TestInfo testInfo) throws IOException {
 745         try (var credentials = new HostCredentials(testInfo);
 746              var tempFolder = new TemporaryDirectory()) {
 747             var author = credentials.getHostedRepository();
 748             var reviewer = credentials.getHostedRepository();
 749 
 750             var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified"> 751                                            .addAuthor(author.host().getCurrentUserDetails().id())</span>
<span class="line-modified"> 752                                            .addReviewer(reviewer.host().getCurrentUserDetails().id());</span>
 753             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;, Map.of(), Map.of(),
 754                                               Map.of(), Set.of(), Map.of());
 755 
 756             // Populate the projects repository
<span class="line-modified"> 757             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), Path.of(&quot;appendable.txt&quot;),</span>
 758                                                      Set.of(&quot;issues&quot;));
 759             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified"> 760             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);</span>
 761 
 762             // Make a change with a corresponding PR
 763             var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified"> 764             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);</span>
 765             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 766 
 767             // Check the status
 768             TestBotRunner.runPeriodicItems(checkBot);
 769 
 770             // Verify that the check failed
<span class="line-modified"> 771             var checks = pr.getChecks(editHash);</span>
 772             assertEquals(1, checks.size());
 773             var check = checks.get(&quot;jcheck&quot;);
 774             assertEquals(CheckStatus.FAILURE, check.status());
 775 
 776             // Add an issue to the title
 777             pr.setTitle(&quot;1234: This is a pull request&quot;);
 778 
 779             // Check the status again
 780             TestBotRunner.runPeriodicItems(checkBot);
 781 
 782             // The check should now be successful
<span class="line-modified"> 783             checks = pr.getChecks(editHash);</span>
 784             assertEquals(1, checks.size());
 785             check = checks.get(&quot;jcheck&quot;);
 786             assertEquals(CheckStatus.SUCCESS, check.status());
 787         }
 788     }
 789 
 790     @Test
 791     void issueInSummary(TestInfo testInfo) throws IOException {
 792         try (var credentials = new HostCredentials(testInfo);
 793              var tempFolder = new TemporaryDirectory()) {
 794             var author = credentials.getHostedRepository();
 795             var reviewer = credentials.getHostedRepository();
 796             var issues = credentials.getIssueProject();
 797 
 798             var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified"> 799                                            .addAuthor(author.host().getCurrentUserDetails().id())</span>
<span class="line-modified"> 800                                            .addReviewer(reviewer.host().getCurrentUserDetails().id());</span>
 801             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;, Map.of(), Map.of(),
 802                                               Map.of(), Set.of(), Map.of(), issues);
 803 
 804             // Populate the projects repository
<span class="line-modified"> 805             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), Path.of(&quot;appendable.txt&quot;),</span>
 806                                                      Set.of(&quot;issues&quot;));
 807             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified"> 808             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);</span>
 809 
 810             var issue1 = issues.createIssue(&quot;My first issue&quot;, List.of(&quot;Hello&quot;));
 811 
 812             // Make a change with a corresponding PR
 813             var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified"> 814             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);</span>
<span class="line-modified"> 815             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, issue1.getId() + &quot;: This is a pull request&quot;);</span>
 816 
 817             // Check the status
 818             TestBotRunner.runPeriodicItems(checkBot);
 819 
 820             // The check should be successful
<span class="line-modified"> 821             var checks = pr.getChecks(editHash);</span>
 822             assertEquals(1, checks.size());
 823             var check = checks.get(&quot;jcheck&quot;);
 824             assertEquals(CheckStatus.SUCCESS, check.status());
 825 
 826             // And the body should contain the issue title
<span class="line-modified"> 827             assertTrue(pr.getBody().contains(&quot;My first issue&quot;));</span>
 828 
 829             // Change the issue
 830             var issue2 = issues.createIssue(&quot;My second issue&quot;, List.of(&quot;Body&quot;));
<span class="line-modified"> 831             pr.setTitle(issue2.getId() + &quot;: This is a pull request&quot;);</span>
 832 
 833             // Check the status again
 834             TestBotRunner.runPeriodicItems(checkBot);
 835 
 836             // The body should contain the updated issue title
<span class="line-modified"> 837             assertFalse(pr.getBody().contains(&quot;My first issue&quot;));</span>
<span class="line-modified"> 838             assertTrue(pr.getBody().contains(&quot;My second issue&quot;));</span>
 839 
 840             // Use an invalid issue key
<span class="line-modified"> 841             var issueKey = issue1.getId().replace(&quot;TEST&quot;, &quot;BADPROJECT&quot;);</span>
 842             pr.setTitle(issueKey + &quot;: This is a pull request&quot;);
 843 
 844             // Check the status again
 845             TestBotRunner.runPeriodicItems(checkBot);
<span class="line-modified"> 846             assertFalse(pr.getBody().contains(&quot;My first issue&quot;));</span>
<span class="line-modified"> 847             assertFalse(pr.getBody().contains(&quot;My second issue&quot;));</span>
<span class="line-modified"> 848             assertTrue(pr.getBody().contains(&quot;Failed to retrieve&quot;));</span>
 849 
 850             // Now drop the issue key
<span class="line-modified"> 851             issueKey = issue1.getId().replace(&quot;TEST-&quot;, &quot;&quot;);</span>
 852             pr.setTitle(issueKey + &quot;: This is a pull request&quot;);
 853 
 854             // The body should now contain the updated issue title
 855             TestBotRunner.runPeriodicItems(checkBot);
<span class="line-modified"> 856             assertTrue(pr.getBody().contains(&quot;My first issue&quot;));</span>
<span class="line-modified"> 857             assertFalse(pr.getBody().contains(&quot;My second issue&quot;));</span>
 858 
 859             // Now enter an invalid issue id
 860             pr.setTitle(&quot;2384848: This is a pull request&quot;);
 861 
 862             // Check the status again
 863             TestBotRunner.runPeriodicItems(checkBot);
<span class="line-modified"> 864             assertFalse(pr.getBody().contains(&quot;My first issue&quot;));</span>
<span class="line-modified"> 865             assertFalse(pr.getBody().contains(&quot;My second issue&quot;));</span>
<span class="line-modified"> 866             assertTrue(pr.getBody().contains(&quot;Failed to retrieve&quot;));</span>
 867 
 868             // The check should still be successful though
<span class="line-modified"> 869             checks = pr.getChecks(editHash);</span>
 870             assertEquals(1, checks.size());
 871             check = checks.get(&quot;jcheck&quot;);
 872             assertEquals(CheckStatus.SUCCESS, check.status());
 873         }
 874     }
 875 
 876     @Test
 877     void cancelCheck(TestInfo testInfo) throws IOException {
 878         try (var credentials = new HostCredentials(testInfo);
 879              var tempFolder = new TemporaryDirectory()) {
 880             var author = credentials.getHostedRepository();
 881 
 882             // Populate the projects repository
<span class="line-modified"> 883             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());</span>
 884             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified"> 885             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);</span>
 886 
 887             // Make a change with a corresponding PR
 888             var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified"> 889             localRepo.push(editHash, author.getUrl(), &quot;refs/heads/edit&quot;, true);</span>
 890             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 891 
 892             // Verify no checks exists
<span class="line-modified"> 893             var checks = pr.getChecks(editHash);</span>
 894             assertEquals(0, checks.size());
 895 
 896             // Create a check that is running
 897             var original = CheckBuilder.create(&quot;jcheck&quot;, editHash)
 898                                        .title(&quot;jcheck title&quot;)
 899                                        .summary(&quot;jcheck summary&quot;)
 900                                        .build();
 901             pr.createCheck(original);
 902 
 903             // Verify check is created
<span class="line-modified"> 904             checks = pr.getChecks(editHash);</span>
 905             assertEquals(1, checks.size());
 906             var retrieved = checks.get(&quot;jcheck&quot;);
 907             assertEquals(&quot;jcheck title&quot;, retrieved.title().get());
 908             assertEquals(&quot;jcheck summary&quot;, retrieved.summary().get());
 909             assertEquals(CheckStatus.IN_PROGRESS, retrieved.status());
 910 
 911             // Cancel the check
 912             var cancelled = CheckBuilder.from(retrieved).cancel().build();
 913             pr.updateCheck(cancelled);
<span class="line-modified"> 914             checks = pr.getChecks(editHash);</span>
 915             assertEquals(1, checks.size());
 916             retrieved = checks.get(&quot;jcheck&quot;);
 917             assertEquals(&quot;jcheck title&quot;, retrieved.title().get());
 918             assertEquals(&quot;jcheck summary&quot;, retrieved.summary().get());
 919             assertEquals(CheckStatus.CANCELLED, retrieved.status());
 920         }
 921     }
 922 
 923     @Test
 924     void rebaseBeforeCheck(TestInfo testInfo) throws IOException {
 925         try (var credentials = new HostCredentials(testInfo);
 926              var tempFolder = new TemporaryDirectory()) {
 927             var author = credentials.getHostedRepository();
 928             var reviewer = credentials.getHostedRepository();
 929 
 930             var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified"> 931                                            .addAuthor(author.host().getCurrentUserDetails().id())</span>
<span class="line-modified"> 932                                            .addReviewer(reviewer.host().getCurrentUserDetails().id());</span>
 933             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
 934 
 935             // Populate the projects repository
<span class="line-modified"> 936             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());</span>
 937             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified"> 938             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);</span>
 939 
 940             // Make a change with a corresponding PR
 941             var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified"> 942             localRepo.push(editHash, author.getUrl(), &quot;refs/heads/edit&quot;, true);</span>
 943             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 944 
 945             // Enable a new check in the target branch
 946             localRepo.checkout(masterHash, true);
<span class="line-modified"> 947             CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), Path.of(&quot;appendable.txt&quot;),</span>
 948                                      Set.of(&quot;author&quot;, &quot;reviewers&quot;, &quot;whitespace&quot;, &quot;issues&quot;));
 949             var headHash = localRepo.resolve(&quot;HEAD&quot;).orElseThrow();
<span class="line-modified"> 950             localRepo.push(headHash, author.getUrl(), &quot;master&quot;, true);</span>
 951 
 952             // Check the status
 953             TestBotRunner.runPeriodicItems(checkBot);
 954 
 955             // Verify that the check failed
<span class="line-modified"> 956             var checks = pr.getChecks(editHash);</span>
 957             assertEquals(1, checks.size());
 958             var check = checks.get(&quot;jcheck&quot;);
 959             assertTrue(check.summary().orElseThrow().contains(&quot;commit message does not reference any issue&quot;));
 960             assertEquals(CheckStatus.FAILURE, check.status());
 961 
 962             // Adjust the title to conform and check the status again
 963             pr.setTitle(&quot;12345: This is a pull request&quot;);
 964             TestBotRunner.runPeriodicItems(checkBot);
 965 
 966             // Verify that the check passed
<span class="line-modified"> 967             checks = pr.getChecks(editHash);</span>
 968             assertEquals(1, checks.size());
 969             check = checks.get(&quot;jcheck&quot;);
 970             assertEquals(CheckStatus.SUCCESS, check.status());
 971         }
 972     }
 973 
 974     @Test
 975     void draft(TestInfo testInfo) throws IOException {
 976         try (var credentials = new HostCredentials(testInfo);
 977              var tempFolder = new TemporaryDirectory()) {
 978             var author = credentials.getHostedRepository();
 979             var reviewer = credentials.getHostedRepository();
 980 
 981             var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified"> 982                                            .addAuthor(author.host().getCurrentUserDetails().id())</span>
<span class="line-modified"> 983                                            .addReviewer(reviewer.host().getCurrentUserDetails().id());</span>
 984             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
 985 
 986             // Populate the projects repository
<span class="line-modified"> 987             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());</span>
 988             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified"> 989             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);</span>
 990 
 991             // Make a change with a corresponding PR
 992             var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified"> 993             localRepo.push(editHash, author.getUrl(), &quot;refs/heads/edit&quot;, true);</span>
 994             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;,
 995                                                    &quot;This is a pull request&quot;, true);
 996 
 997             // Check the status
 998             TestBotRunner.runPeriodicItems(checkBot);
 999 
1000             // Verify that the check succeeded
<span class="line-modified">1001             var checks = pr.getChecks(editHash);</span>
1002             assertEquals(1, checks.size());
1003             var check = checks.get(&quot;jcheck&quot;);
1004             assertEquals(CheckStatus.SUCCESS, check.status());
1005 
1006             // The PR should still not be ready for review as it is a draft
<span class="line-modified">1007             assertFalse(pr.getLabels().contains(&quot;rfr&quot;));</span>
<span class="line-modified">1008             assertFalse(pr.getLabels().contains(&quot;ready&quot;));</span>
1009         }
1010     }
1011 }
</pre>
</td>
<td>
<hr />
<pre>
  27 
  28 import org.junit.jupiter.api.*;
  29 
  30 import java.io.IOException;
  31 import java.nio.file.*;
  32 import java.util.*;
  33 import java.util.regex.Pattern;
  34 
  35 import static org.junit.jupiter.api.Assertions.*;
  36 import static org.junit.jupiter.api.Assumptions.assumeTrue;
  37 
  38 class CheckTests {
  39     @Test
  40     void simpleCommit(TestInfo testInfo) throws IOException {
  41         try (var credentials = new HostCredentials(testInfo);
  42              var tempFolder = new TemporaryDirectory()) {
  43             var author = credentials.getHostedRepository();
  44             var reviewer = credentials.getHostedRepository();
  45 
  46             var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified">  47                                            .addAuthor(author.host().currentUser().id())</span>
<span class="line-modified">  48                                            .addReviewer(reviewer.host().currentUser().id());</span>
  49             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
  50 
  51             // Populate the projects repository
<span class="line-modified">  52             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());</span>
  53             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified">  54             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
  55 
  56             // Make a change with a corresponding PR
  57             var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified">  58             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);</span>
  59             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
  60 
  61             // Check the status
  62             TestBotRunner.runPeriodicItems(checkBot);
  63 
  64             // Verify that the check succeeded
<span class="line-modified">  65             var checks = pr.checks(editHash);</span>
  66             assertEquals(1, checks.size());
  67             var check = checks.get(&quot;jcheck&quot;);
  68             assertEquals(CheckStatus.SUCCESS, check.status());
  69 
  70             // The PR should now be ready for review
<span class="line-modified">  71             assertTrue(pr.labels().contains(&quot;rfr&quot;));</span>
<span class="line-modified">  72             assertFalse(pr.labels().contains(&quot;ready&quot;));</span>
  73 
  74             // Approve it as another user
<span class="line-modified">  75             var approvalPr = reviewer.pullRequest(pr.id());</span>
  76             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
  77 
  78             // Check the status again
  79             TestBotRunner.runPeriodicItems(checkBot);
  80 
  81             // The check should now be successful
<span class="line-modified">  82             checks = pr.checks(editHash);</span>
  83             assertEquals(1, checks.size());
  84             check = checks.get(&quot;jcheck&quot;);
  85             assertEquals(CheckStatus.SUCCESS, check.status());
  86 
  87             // The PR should not be flagged as ready for review, at it is already reviewed
<span class="line-modified">  88             assertFalse(pr.labels().contains(&quot;rfr&quot;));</span>
<span class="line-modified">  89             assertTrue(pr.labels().contains(&quot;ready&quot;));</span>
  90         }
  91     }
  92 
  93     @Test
  94     void whitespaceIssue(TestInfo testInfo) throws IOException {
  95         try (var credentials = new HostCredentials(testInfo);
  96              var tempFolder = new TemporaryDirectory()) {
  97 
  98             var author = credentials.getHostedRepository();
  99             var reviewer = credentials.getHostedRepository();
 100 
 101             var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified"> 102                                            .addAuthor(author.host().currentUser().id())</span>
<span class="line-modified"> 103                                            .addReviewer(reviewer.host().currentUser().id());</span>
 104             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
 105 
 106             // Populate the projects repository
<span class="line-modified"> 107             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());</span>
 108             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified"> 109             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
 110 
 111             // Make a change with a corresponding PR
 112             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line with a trailing whitespace   &quot;);
<span class="line-modified"> 113             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);</span>
 114             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 115 
 116             // Check the status
 117             TestBotRunner.runPeriodicItems(checkBot);
 118 
 119             // The PR should not be flagged as ready for review
<span class="line-modified"> 120             assertFalse(pr.labels().contains(&quot;rfr&quot;));</span>
 121 
 122             // Approve it as another user
<span class="line-modified"> 123             var approvalPr = reviewer.pullRequest(pr.id());</span>
 124             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 125 
 126             // Check the status
 127             TestBotRunner.runPeriodicItems(checkBot);
 128 
 129             // Verify that the check failed
<span class="line-modified"> 130             var checks = pr.checks(editHash);</span>
 131             assertEquals(1, checks.size());
 132             var check = checks.get(&quot;jcheck&quot;);
 133             assertEquals(CheckStatus.FAILURE, check.status());
 134 
 135             // The PR should not still not be flagged as ready for review
<span class="line-modified"> 136             assertFalse(pr.labels().contains(&quot;rfr&quot;));</span>
 137 
 138             // Remove the trailing whitespace in a new commit
 139             editHash = CheckableRepository.replaceAndCommit(localRepo, &quot;A line without a trailing whitespace&quot;);
<span class="line-modified"> 140             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);</span>
 141 
 142             // Make sure that the push registered
<span class="line-modified"> 143             var lastHeadHash = pr.headHash();</span>
 144             var refreshCount = 0;
 145             do {
<span class="line-modified"> 146                 pr = author.pullRequest(pr.id());</span>
 147                 if (refreshCount++ &gt; 100) {
 148                     fail(&quot;The PR did not update after the new push&quot;);
 149                 }
<span class="line-modified"> 150             } while (pr.headHash().equals(lastHeadHash));</span>
 151 
 152             // Check the status again
 153             TestBotRunner.runPeriodicItems(checkBot);
 154 
 155             // The PR should not be flagged as ready for review, at it is already reviewed
<span class="line-modified"> 156             assertFalse(pr.labels().contains(&quot;rfr&quot;));</span>
 157 
 158             // The check should now be successful
<span class="line-modified"> 159             checks = pr.checks(editHash);</span>
 160             assertEquals(1, checks.size());
 161             check = checks.get(&quot;jcheck&quot;);
 162             assertEquals(CheckStatus.SUCCESS, check.status());
 163         }
 164     }
 165 
 166     @Test
 167     void multipleReviews(TestInfo testInfo) throws IOException {
 168         try (var credentials = new HostCredentials(testInfo);
 169              var tempFolder = new TemporaryDirectory()) {
 170 
 171             var author = credentials.getHostedRepository();
 172             var reviewer = credentials.getHostedRepository();
 173             var commenter = credentials.getHostedRepository();
 174 
 175             var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified"> 176                                            .addAuthor(author.host().currentUser().id())</span>
<span class="line-modified"> 177                                            .addReviewer(reviewer.host().currentUser().id())</span>
<span class="line-modified"> 178                                            .addReviewer(commenter.host().currentUser().id());</span>
 179 
 180             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
 181 
 182             // Populate the projects repository
<span class="line-modified"> 183             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());</span>
 184             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified"> 185             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
 186 
 187             // Make a change with a corresponding PR
 188             var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified"> 189             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);</span>
 190             var authorPr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 191 
 192             // Let the status bot inspect the PR
 193             TestBotRunner.runPeriodicItems(checkBot);
<span class="line-modified"> 194             assertFalse(authorPr.body().contains(&quot;Approvers&quot;));</span>
 195 
 196             // Approve it
<span class="line-modified"> 197             var reviewerPr = reviewer.pullRequest(authorPr.id());</span>
 198             reviewerPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 199             TestBotRunner.runPeriodicItems(checkBot);
 200 
 201             // Refresh the PR and check that it has been approved
<span class="line-modified"> 202             authorPr = author.pullRequest(authorPr.id());</span>
<span class="line-modified"> 203             assertTrue(authorPr.body().contains(&quot;Approvers&quot;));</span>
 204 
 205             // Update the file after approval
 206             editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Now I&#39;ve gone and changed it&quot;);
<span class="line-modified"> 207             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);</span>
 208 
 209             // Make sure that the push registered
<span class="line-modified"> 210             var lastHeadHash = authorPr.headHash();</span>
 211             var refreshCount = 0;
 212             do {
<span class="line-modified"> 213                 authorPr = author.pullRequest(authorPr.id());</span>
 214                 if (refreshCount++ &gt; 100) {
 215                     fail(&quot;The PR did not update after the new push&quot;);
 216                 }
<span class="line-modified"> 217             } while (authorPr.headHash().equals(lastHeadHash));</span>
 218 
 219             // Check that the review is flagged as stale
 220             TestBotRunner.runPeriodicItems(checkBot);
<span class="line-modified"> 221             authorPr = author.pullRequest(authorPr.id());</span>
<span class="line-modified"> 222             assertTrue(authorPr.body().contains(&quot;Note&quot;));</span>
 223 
 224             // Now we can approve it again
 225             reviewerPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 226             TestBotRunner.runPeriodicItems(checkBot);
 227 
 228             // Refresh the PR and check that it has been approved (once) and is no longer stale
<span class="line-modified"> 229             authorPr = author.pullRequest(authorPr.id());</span>
<span class="line-modified"> 230             assertTrue(authorPr.body().contains(&quot;Approvers&quot;));</span>
<span class="line-modified"> 231             assertEquals(1, authorPr.body().split(&quot;Generated Reviewer&quot;, -1).length - 1);</span>
<span class="line-modified"> 232             assertTrue(authorPr.reviews().size() &gt;= 1);</span>
<span class="line-modified"> 233             assertFalse(authorPr.body().contains(&quot;Note&quot;));</span>
 234 
 235             // Add a review with disapproval
<span class="line-modified"> 236             var commenterPr = commenter.pullRequest(authorPr.id());</span>
 237             commenterPr.addReview(Review.Verdict.DISAPPROVED, &quot;Disapproved&quot;);
 238             TestBotRunner.runPeriodicItems(checkBot);
 239 
 240             // Refresh the PR and check that it still only approved once (but two reviews) and is no longer stale
<span class="line-modified"> 241             authorPr = author.pullRequest(authorPr.id());</span>
<span class="line-modified"> 242             assertTrue(authorPr.body().contains(&quot;Approvers&quot;));</span>
<span class="line-modified"> 243             assertEquals(1, authorPr.body().split(&quot;Generated Reviewer&quot;, -1).length - 1);</span>
<span class="line-modified"> 244             assertTrue(authorPr.reviews().size() &gt;= 2);</span>
<span class="line-modified"> 245             assertFalse(authorPr.body().contains(&quot;Note&quot;));</span>
 246         }
 247     }
 248 
 249     @Test
 250     void selfReview(TestInfo testInfo) throws IOException {
 251         try (var credentials = new HostCredentials(testInfo);
 252              var tempFolder = new TemporaryDirectory()) {
 253 
 254             var author = credentials.getHostedRepository();
 255 
 256             var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified"> 257                                            .addReviewer(author.host().currentUser().id());</span>
 258 
 259             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
 260 
 261             // Populate the projects repository
<span class="line-modified"> 262             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());</span>
 263             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified"> 264             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
 265 
 266             // Make a change with a corresponding PR
 267             var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified"> 268             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);</span>
 269             var authorPr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 270 
 271             // Let the status bot inspect the PR
 272             TestBotRunner.runPeriodicItems(checkBot);
<span class="line-modified"> 273             assertFalse(authorPr.body().contains(&quot;Approvers&quot;));</span>
 274 
 275             // Approve it
 276             authorPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 277             TestBotRunner.runPeriodicItems(checkBot);
 278 
 279             // Refresh the PR and check that it has been approved
<span class="line-modified"> 280             authorPr = author.pullRequest(authorPr.id());</span>
<span class="line-modified"> 281             assertTrue(authorPr.body().contains(&quot;Approvers&quot;));</span>
 282 
 283             // Verify that the check failed
<span class="line-modified"> 284             var checks = authorPr.checks(editHash);</span>
 285             assertEquals(1, checks.size());
 286             var check = checks.get(&quot;jcheck&quot;);
 287             assertEquals(CheckStatus.FAILURE, check.status());
 288         }
 289     }
 290 
 291     @Test
 292     void multipleCommitters(TestInfo testInfo) throws IOException {
 293         try (var credentials = new HostCredentials(testInfo);
 294              var tempFolder = new TemporaryDirectory()) {
 295             var author = credentials.getHostedRepository();
 296             var reviewer = credentials.getHostedRepository();
 297 
 298             var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified"> 299                                            .addReviewer(reviewer.host().currentUser().id());</span>
 300             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
 301 
 302             // Populate the projects repository
<span class="line-modified"> 303             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());</span>
 304             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified"> 305             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
 306 
 307             // Make two changes with different authors
 308             CheckableRepository.appendAndCommit(localRepo, &quot;First edit&quot;, &quot;Edit by number 1&quot;,
 309                                                 &quot;number1&quot;, &quot;number1@none.none&quot;);
 310             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Second edit&quot;, &quot;Edit by number 2&quot;,
 311                                                                &quot;number2&quot;, &quot;number2@none.none&quot;);
<span class="line-modified"> 312             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);</span>
 313             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 314 
 315             // Check the status
 316             TestBotRunner.runPeriodicItems(checkBot);
 317 
 318             // Verify that the check failed
<span class="line-modified"> 319             var checks = pr.checks(editHash);</span>
 320             assertEquals(1, checks.size());
 321             var check = checks.get(&quot;jcheck&quot;);
 322             assertEquals(CheckStatus.FAILURE, check.status());
 323 
 324             // Approve it as another user
<span class="line-modified"> 325             var approvalPr = reviewer.pullRequest(pr.id());</span>
 326             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 327 
 328             // Check the status again
 329             TestBotRunner.runPeriodicItems(checkBot);
 330 
 331             // The check should still be failing
<span class="line-modified"> 332             checks = pr.checks(editHash);</span>
 333             assertEquals(1, checks.size());
 334             check = checks.get(&quot;jcheck&quot;);
 335             assertEquals(CheckStatus.FAILURE, check.status());
 336 
 337             // The PR should not be flagged as ready for review, as multiple committers is a problem
<span class="line-modified"> 338             assertFalse(pr.labels().contains(&quot;rfr&quot;));</span>
 339         }
 340     }
 341 
 342     @Test
 343     void updatedContentFailsCheck(TestInfo testInfo) throws IOException {
 344         try (var credentials = new HostCredentials(testInfo);
 345              var tempFolder = new TemporaryDirectory()) {
 346             var author = credentials.getHostedRepository();
 347             var reviewer = credentials.getHostedRepository();
 348 
 349             var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified"> 350                                            .addAuthor(author.host().currentUser().id())</span>
<span class="line-modified"> 351                                            .addReviewer(reviewer.host().currentUser().id());</span>
 352             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
 353 
 354             // Populate the projects repository
<span class="line-modified"> 355             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());</span>
 356             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified"> 357             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
 358 
 359             // Make a change with a corresponding PR
 360             var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified"> 361             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);</span>
 362             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 363 
 364             // Check the status
 365             TestBotRunner.runPeriodicItems(checkBot);
 366 
 367             // Verify that the check passed
<span class="line-modified"> 368             var checks = pr.checks(editHash);</span>
 369             assertEquals(1, checks.size());
 370             var check = checks.get(&quot;jcheck&quot;);
 371             assertEquals(CheckStatus.SUCCESS, check.status());
 372 
 373             // The PR should now be ready for review
<span class="line-modified"> 374             assertTrue(pr.labels().contains(&quot;rfr&quot;));</span>
<span class="line-modified"> 375             assertFalse(pr.labels().contains(&quot;ready&quot;));</span>
 376 
 377             // Approve it as another user
<span class="line-modified"> 378             var approvalPr = reviewer.pullRequest(pr.id());</span>
 379             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 380 
 381             // Check the status again
 382             TestBotRunner.runPeriodicItems(checkBot);
 383 
 384             // The check should now be successful
<span class="line-modified"> 385             checks = pr.checks(editHash);</span>
 386             assertEquals(1, checks.size());
 387             check = checks.get(&quot;jcheck&quot;);
 388             assertEquals(CheckStatus.SUCCESS, check.status());
 389 
 390             // The PR should not be flagged as ready for review, at it is already reviewed
<span class="line-modified"> 391             assertFalse(pr.labels().contains(&quot;rfr&quot;));</span>
<span class="line-modified"> 392             assertTrue(pr.labels().contains(&quot;ready&quot;));</span>
 393 
 394             var addedHash = CheckableRepository.appendAndCommit(localRepo, &quot;trailing whitespace   &quot;);
<span class="line-modified"> 395             localRepo.push(addedHash, author.url(), &quot;edit&quot;);</span>
 396 
 397             // Make sure that the push registered
<span class="line-modified"> 398             var lastHeadHash = pr.headHash();</span>
 399             var refreshCount = 0;
 400             do {
<span class="line-modified"> 401                 pr = author.pullRequest(pr.id());</span>
 402                 if (refreshCount++ &gt; 100) {
 403                     fail(&quot;The PR did not update after the new push&quot;);
 404                 }
<span class="line-modified"> 405             } while (pr.headHash().equals(lastHeadHash));</span>
 406 
 407             // Check the status
 408             TestBotRunner.runPeriodicItems(checkBot);
 409 
 410             // The PR is now neither ready for review nor integration
<span class="line-modified"> 411             assertFalse(pr.labels().contains(&quot;rfr&quot;));</span>
<span class="line-modified"> 412             assertFalse(pr.labels().contains(&quot;ready&quot;));</span>
 413 
 414             // The check should now be failing
<span class="line-modified"> 415             checks = pr.checks(addedHash);</span>
 416             assertEquals(1, checks.size());
 417             check = checks.get(&quot;jcheck&quot;);
 418             assertEquals(CheckStatus.FAILURE, check.status());
 419         }
 420     }
 421 
 422     @Test
 423     void individualReviewComments(TestInfo testInfo) throws IOException {
 424         try (var credentials = new HostCredentials(testInfo);
 425              var tempFolder = new TemporaryDirectory()) {
 426             var author = credentials.getHostedRepository();
 427             var reviewer = credentials.getHostedRepository();
 428 
 429             // This test is only relevant on hosts not supporting proper review comment bodies
 430             assumeTrue(!author.host().supportsReviewBody());
 431 
 432             var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified"> 433                                            .addAuthor(author.host().currentUser().id())</span>
<span class="line-modified"> 434                                            .addReviewer(reviewer.host().currentUser().id());</span>
 435             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
 436 
 437             // Populate the projects repository
<span class="line-modified"> 438             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());</span>
 439             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified"> 440             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
 441 
 442             // Make a change with a corresponding PR
 443             var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified"> 444             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);</span>
 445             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 446 
 447             // Check the status
 448             TestBotRunner.runPeriodicItems(checkBot);
<span class="line-modified"> 449             var comments = pr.comments();</span>
 450             var commentCount = comments.size();
 451 
 452             // Approve it as another user
<span class="line-modified"> 453             var approvalPr = reviewer.pullRequest(pr.id());</span>
 454             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 455 
 456             // Check the status again
 457             TestBotRunner.runPeriodicItems(checkBot);
 458 
 459             // There should now be two additional comments
<span class="line-modified"> 460             comments = pr.comments();</span>
 461             assertEquals(commentCount + 2, comments.size());
 462             var comment = comments.get(commentCount);
<span class="line-modified"> 463             assertTrue(comment.body().contains(reviewer.host().currentUser().userName()));</span>
 464             assertTrue(comment.body().contains(&quot;approved&quot;));
 465 
 466             // Drop the review
 467             approvalPr.addReview(Review.Verdict.NONE, &quot;Unreviewed&quot;);
 468 
 469             // Check the status again
 470             TestBotRunner.runPeriodicItems(checkBot);
 471 
 472             // There should now be yet another comment
<span class="line-modified"> 473             comments = pr.comments();</span>
 474             assertEquals(commentCount + 3, comments.size());
 475             comment = comments.get(commentCount + 2);
<span class="line-modified"> 476             assertTrue(comment.body().contains(reviewer.host().currentUser().userName()));</span>
 477             assertTrue(comment.body().contains(&quot;comment&quot;));
 478 
 479             // No changes should not generate additional comments
 480             TestBotRunner.runPeriodicItems(checkBot);
<span class="line-modified"> 481             comments = pr.comments();</span>
 482             assertEquals(commentCount + 3, comments.size());
 483         }
 484     }
 485 
 486     @Test
 487     void mergeMessage(TestInfo testInfo) throws IOException {
 488         try (var credentials = new HostCredentials(testInfo);
 489              var tempFolder = new TemporaryDirectory();
 490              var pushedFolder = new TemporaryDirectory()) {
 491 
 492             var author = credentials.getHostedRepository();
 493             var integrator = credentials.getHostedRepository();
 494             var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified"> 495                                            .addCommitter(author.host().currentUser().id())</span>
<span class="line-modified"> 496                                            .addReviewer(integrator.host().currentUser().id());</span>
 497             var mergeBot = new PullRequestBot(integrator, censusBuilder.build(), &quot;master&quot;);
 498 
 499             // Populate the projects repository
<span class="line-modified"> 500             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());</span>
 501             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 502             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
<span class="line-modified"> 503             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
 504 
 505             // Make a change with a corresponding PR
 506             var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified"> 507             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);</span>
 508             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 509 
 510             // Approve it as another user
<span class="line-modified"> 511             var approvalPr = integrator.pullRequest(pr.id());</span>
 512             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 513 
 514             // Get all messages up to date
 515             TestBotRunner.runPeriodicItems(mergeBot);
 516 
 517             // Push something unrelated to master
 518             localRepo.checkout(masterHash, true);
 519             var unrelated = localRepo.root().resolve(&quot;unrelated.txt&quot;);
 520             Files.writeString(unrelated, &quot;Hello&quot;);
 521             localRepo.add(unrelated);
 522             var unrelatedHash = localRepo.commit(&quot;Unrelated&quot;, &quot;X&quot;, &quot;x@y.z&quot;);
<span class="line-modified"> 523             localRepo.push(unrelatedHash, author.url(), &quot;master&quot;);</span>
 524 
 525             // Let the bot see the changes
 526             TestBotRunner.runPeriodicItems(mergeBot);
 527 
 528             // The bot should reply with an ok message
<span class="line-modified"> 529             var updated = pr.comments().stream()</span>
 530                             .filter(comment -&gt; comment.body().contains(&quot;there has been 1 commit&quot;))
 531                             .filter(comment -&gt; comment.body().contains(&quot;please merge&quot;))
 532                             .count();
 533             assertEquals(1, updated);
 534         }
 535     }
 536 
 537     @Test
 538     void cannotRebase(TestInfo testInfo) throws IOException {
 539         try (var credentials = new HostCredentials(testInfo);
 540              var tempFolder = new TemporaryDirectory();
 541              var pushedFolder = new TemporaryDirectory()) {
 542 
 543             var author = credentials.getHostedRepository();
 544             var integrator = credentials.getHostedRepository();
 545             var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified"> 546                                            .addCommitter(author.host().currentUser().id())</span>
<span class="line-modified"> 547                                            .addReviewer(integrator.host().currentUser().id());</span>
 548             var mergeBot = new PullRequestBot(integrator, censusBuilder.build(), &quot;master&quot;);
 549 
 550             // Populate the projects repository
<span class="line-modified"> 551             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());</span>
 552             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 553             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
<span class="line-modified"> 554             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
 555 
 556             // Make a change with a corresponding PR
 557             var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified"> 558             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);</span>
 559             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 560 
 561             // Approve it as another user
<span class="line-modified"> 562             var approvalPr = integrator.pullRequest(pr.id());</span>
 563             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
 564 
 565             // Get all messages up to date
 566             TestBotRunner.runPeriodicItems(mergeBot);
 567 
 568             // Push something conflicting to master
 569             localRepo.checkout(masterHash, true);
 570             var conflictingHash = CheckableRepository.appendAndCommit(localRepo, &quot;This looks like a conflict&quot;);
<span class="line-modified"> 571             localRepo.push(conflictingHash, author.url(), &quot;master&quot;);</span>
 572 
 573             // Let the bot see the changes
 574             TestBotRunner.runPeriodicItems(mergeBot);
 575 
 576             // The bot should reply with that there is a conflict
<span class="line-modified"> 577             var updated = pr.comments().stream()</span>
 578                             .filter(comment -&gt; comment.body().contains(&quot;there has been 1 commit&quot;))
 579                             .filter(comment -&gt; comment.body().contains(&quot;cannot be rebased automatically&quot;))
 580                             .count();
 581             assertEquals(1, updated);
 582 
 583             // The PR should be flagged as outdated
<span class="line-modified"> 584             assertTrue(pr.labels().contains(&quot;outdated&quot;));</span>
 585 
 586             // But it should still pass jcheck
<span class="line-modified"> 587             var checks = pr.checks(editHash);</span>
 588             assertEquals(1, checks.size());
 589             var check = checks.get(&quot;jcheck&quot;);
 590             assertEquals(CheckStatus.SUCCESS, check.status());
 591 
 592             // Restore the master branch
<span class="line-modified"> 593             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
 594 
 595             // Let the bot see the changes
 596             TestBotRunner.runPeriodicItems(mergeBot);
 597 
 598             // The bot should no longer detect a conflict
<span class="line-modified"> 599             updated = pr.comments().stream()</span>
<span class="line-modified"> 600                         .filter(comment -&gt; comment.body().contains(&quot;change can now be integrated&quot;))</span>
<span class="line-modified"> 601                         .count();</span>
 602             assertEquals(1, updated);
 603 
 604             // The PR should not be flagged as outdated
<span class="line-modified"> 605             assertFalse(pr.labels().contains(&quot;outdated&quot;));</span>
 606         }
 607     }
 608 
 609     @Test
 610     void blockingLabel(TestInfo testInfo) throws IOException {
 611         try (var credentials = new HostCredentials(testInfo);
 612              var tempFolder = new TemporaryDirectory()) {
 613             var author = credentials.getHostedRepository();
 614             var reviewer = credentials.getHostedRepository();
 615 
 616             var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified"> 617                                            .addAuthor(author.host().currentUser().id())</span>
<span class="line-modified"> 618                                            .addReviewer(reviewer.host().currentUser().id());</span>
 619             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;, Map.of(), Map.of(),
 620                                               Map.of(&quot;block&quot;, &quot;Test Blocker&quot;), Set.of(), Map.of());
 621 
 622             // Populate the projects repository
<span class="line-modified"> 623             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());</span>
 624             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified"> 625             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
 626 
 627             // Make a change with a corresponding PR
 628             var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified"> 629             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);</span>
 630             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 631             pr.addLabel(&quot;block&quot;);
 632 
 633             // Check the status
 634             TestBotRunner.runPeriodicItems(checkBot);
 635 
 636             // Verify that the check failed
<span class="line-modified"> 637             var checks = pr.checks(editHash);</span>
 638             assertEquals(1, checks.size());
 639             var check = checks.get(&quot;jcheck&quot;);
 640             assertEquals(CheckStatus.FAILURE, check.status());
 641             assertTrue(check.summary().orElseThrow().contains(&quot;Test Blocker&quot;));
 642 
 643             // The PR should not yet be ready for review
<span class="line-modified"> 644             assertTrue(pr.labels().contains(&quot;block&quot;));</span>
<span class="line-modified"> 645             assertFalse(pr.labels().contains(&quot;rfr&quot;));</span>
<span class="line-modified"> 646             assertFalse(pr.labels().contains(&quot;ready&quot;));</span>
 647 
 648             // Check the status again
 649             pr.removeLabel(&quot;block&quot;);
 650             TestBotRunner.runPeriodicItems(checkBot);
 651 
 652             // The PR should now be ready for review
<span class="line-modified"> 653             assertTrue(pr.labels().contains(&quot;rfr&quot;));</span>
<span class="line-modified"> 654             assertFalse(pr.labels().contains(&quot;ready&quot;));</span>
 655         }
 656     }
 657 
 658     @Test
 659     void missingReadyLabel(TestInfo testInfo) throws IOException {
 660         try (var credentials = new HostCredentials(testInfo);
 661              var tempFolder = new TemporaryDirectory()) {
 662             var author = credentials.getHostedRepository();
 663             var reviewer = credentials.getHostedRepository();
 664 
 665             var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified"> 666                                            .addAuthor(author.host().currentUser().id())</span>
<span class="line-modified"> 667                                            .addReviewer(reviewer.host().currentUser().id());</span>
 668             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;, Map.of(), Map.of(),
 669                                               Map.of(), Set.of(&quot;good-to-go&quot;), Map.of());
 670 
 671             // Populate the projects repository
<span class="line-modified"> 672             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());</span>
 673             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified"> 674             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
 675 
 676             // Make a change with a corresponding PR
 677             var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified"> 678             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);</span>
 679             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 680 
 681             // Check the status
 682             TestBotRunner.runPeriodicItems(checkBot);
 683 
 684             // Verify that no checks have been run
<span class="line-modified"> 685             var checks = pr.checks(editHash);</span>
 686             assertEquals(0, checks.size());
 687 
 688             // The PR should not yet be ready for review
<span class="line-modified"> 689             assertFalse(pr.labels().contains(&quot;rfr&quot;));</span>
 690 
 691             // Check the status again
 692             pr.addLabel(&quot;good-to-go&quot;);
 693             TestBotRunner.runPeriodicItems(checkBot);
 694 
 695             // The PR should now be ready for review
<span class="line-modified"> 696             assertTrue(pr.labels().contains(&quot;rfr&quot;));</span>
 697         }
 698     }
 699 
 700     @Test
 701     void missingReadyComment(TestInfo testInfo) throws IOException {
 702         try (var credentials = new HostCredentials(testInfo);
 703              var tempFolder = new TemporaryDirectory()) {
 704             var author = credentials.getHostedRepository();
 705             var reviewer = credentials.getHostedRepository();
 706 
 707             var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified"> 708                                            .addAuthor(author.host().currentUser().id())</span>
<span class="line-modified"> 709                                            .addReviewer(reviewer.host().currentUser().id());</span>
 710             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;, Map.of(), Map.of(),
<span class="line-modified"> 711                                               Map.of(), Set.of(), Map.of(reviewer.host().currentUser().userName(), Pattern.compile(&quot;proceed&quot;)));</span>
 712 
 713             // Populate the projects repository
<span class="line-modified"> 714             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());</span>
 715             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified"> 716             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
 717 
 718             // Make a change with a corresponding PR
 719             var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified"> 720             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);</span>
 721             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 722 
 723             // Check the status
 724             TestBotRunner.runPeriodicItems(checkBot);
 725 
 726             // Verify that no checks have been run
<span class="line-modified"> 727             var checks = pr.checks(editHash);</span>
 728             assertEquals(0, checks.size());
 729 
 730             // The PR should not yet be ready for review
<span class="line-modified"> 731             assertFalse(pr.labels().contains(&quot;rfr&quot;));</span>
 732 
 733             // Check the status again
<span class="line-modified"> 734             var reviewerPr = reviewer.pullRequest(pr.id());</span>
 735             reviewerPr.addComment(&quot;proceed&quot;);
 736             TestBotRunner.runPeriodicItems(checkBot);
 737 
 738             // The PR should now be ready for review
<span class="line-modified"> 739             assertTrue(pr.labels().contains(&quot;rfr&quot;));</span>
 740         }
 741     }
 742 
 743     @Test
 744     void issueIssue(TestInfo testInfo) throws IOException {
 745         try (var credentials = new HostCredentials(testInfo);
 746              var tempFolder = new TemporaryDirectory()) {
 747             var author = credentials.getHostedRepository();
 748             var reviewer = credentials.getHostedRepository();
 749 
 750             var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified"> 751                                            .addAuthor(author.host().currentUser().id())</span>
<span class="line-modified"> 752                                            .addReviewer(reviewer.host().currentUser().id());</span>
 753             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;, Map.of(), Map.of(),
 754                                               Map.of(), Set.of(), Map.of());
 755 
 756             // Populate the projects repository
<span class="line-modified"> 757             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), Path.of(&quot;appendable.txt&quot;),</span>
 758                                                      Set.of(&quot;issues&quot;));
 759             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified"> 760             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
 761 
 762             // Make a change with a corresponding PR
 763             var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified"> 764             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);</span>
 765             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 766 
 767             // Check the status
 768             TestBotRunner.runPeriodicItems(checkBot);
 769 
 770             // Verify that the check failed
<span class="line-modified"> 771             var checks = pr.checks(editHash);</span>
 772             assertEquals(1, checks.size());
 773             var check = checks.get(&quot;jcheck&quot;);
 774             assertEquals(CheckStatus.FAILURE, check.status());
 775 
 776             // Add an issue to the title
 777             pr.setTitle(&quot;1234: This is a pull request&quot;);
 778 
 779             // Check the status again
 780             TestBotRunner.runPeriodicItems(checkBot);
 781 
 782             // The check should now be successful
<span class="line-modified"> 783             checks = pr.checks(editHash);</span>
 784             assertEquals(1, checks.size());
 785             check = checks.get(&quot;jcheck&quot;);
 786             assertEquals(CheckStatus.SUCCESS, check.status());
 787         }
 788     }
 789 
 790     @Test
 791     void issueInSummary(TestInfo testInfo) throws IOException {
 792         try (var credentials = new HostCredentials(testInfo);
 793              var tempFolder = new TemporaryDirectory()) {
 794             var author = credentials.getHostedRepository();
 795             var reviewer = credentials.getHostedRepository();
 796             var issues = credentials.getIssueProject();
 797 
 798             var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified"> 799                                            .addAuthor(author.host().currentUser().id())</span>
<span class="line-modified"> 800                                            .addReviewer(reviewer.host().currentUser().id());</span>
 801             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;, Map.of(), Map.of(),
 802                                               Map.of(), Set.of(), Map.of(), issues);
 803 
 804             // Populate the projects repository
<span class="line-modified"> 805             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), Path.of(&quot;appendable.txt&quot;),</span>
 806                                                      Set.of(&quot;issues&quot;));
 807             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified"> 808             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
 809 
 810             var issue1 = issues.createIssue(&quot;My first issue&quot;, List.of(&quot;Hello&quot;));
 811 
 812             // Make a change with a corresponding PR
 813             var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified"> 814             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);</span>
<span class="line-modified"> 815             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, issue1.id() + &quot;: This is a pull request&quot;);</span>
 816 
 817             // Check the status
 818             TestBotRunner.runPeriodicItems(checkBot);
 819 
 820             // The check should be successful
<span class="line-modified"> 821             var checks = pr.checks(editHash);</span>
 822             assertEquals(1, checks.size());
 823             var check = checks.get(&quot;jcheck&quot;);
 824             assertEquals(CheckStatus.SUCCESS, check.status());
 825 
 826             // And the body should contain the issue title
<span class="line-modified"> 827             assertTrue(pr.body().contains(&quot;My first issue&quot;));</span>
 828 
 829             // Change the issue
 830             var issue2 = issues.createIssue(&quot;My second issue&quot;, List.of(&quot;Body&quot;));
<span class="line-modified"> 831             pr.setTitle(issue2.id() + &quot;: This is a pull request&quot;);</span>
 832 
 833             // Check the status again
 834             TestBotRunner.runPeriodicItems(checkBot);
 835 
 836             // The body should contain the updated issue title
<span class="line-modified"> 837             assertFalse(pr.body().contains(&quot;My first issue&quot;));</span>
<span class="line-modified"> 838             assertTrue(pr.body().contains(&quot;My second issue&quot;));</span>
 839 
 840             // Use an invalid issue key
<span class="line-modified"> 841             var issueKey = issue1.id().replace(&quot;TEST&quot;, &quot;BADPROJECT&quot;);</span>
 842             pr.setTitle(issueKey + &quot;: This is a pull request&quot;);
 843 
 844             // Check the status again
 845             TestBotRunner.runPeriodicItems(checkBot);
<span class="line-modified"> 846             assertFalse(pr.body().contains(&quot;My first issue&quot;));</span>
<span class="line-modified"> 847             assertFalse(pr.body().contains(&quot;My second issue&quot;));</span>
<span class="line-modified"> 848             assertTrue(pr.body().contains(&quot;Failed to retrieve&quot;));</span>
 849 
 850             // Now drop the issue key
<span class="line-modified"> 851             issueKey = issue1.id().replace(&quot;TEST-&quot;, &quot;&quot;);</span>
 852             pr.setTitle(issueKey + &quot;: This is a pull request&quot;);
 853 
 854             // The body should now contain the updated issue title
 855             TestBotRunner.runPeriodicItems(checkBot);
<span class="line-modified"> 856             assertTrue(pr.body().contains(&quot;My first issue&quot;));</span>
<span class="line-modified"> 857             assertFalse(pr.body().contains(&quot;My second issue&quot;));</span>
 858 
 859             // Now enter an invalid issue id
 860             pr.setTitle(&quot;2384848: This is a pull request&quot;);
 861 
 862             // Check the status again
 863             TestBotRunner.runPeriodicItems(checkBot);
<span class="line-modified"> 864             assertFalse(pr.body().contains(&quot;My first issue&quot;));</span>
<span class="line-modified"> 865             assertFalse(pr.body().contains(&quot;My second issue&quot;));</span>
<span class="line-modified"> 866             assertTrue(pr.body().contains(&quot;Failed to retrieve&quot;));</span>
 867 
 868             // The check should still be successful though
<span class="line-modified"> 869             checks = pr.checks(editHash);</span>
 870             assertEquals(1, checks.size());
 871             check = checks.get(&quot;jcheck&quot;);
 872             assertEquals(CheckStatus.SUCCESS, check.status());
 873         }
 874     }
 875 
 876     @Test
 877     void cancelCheck(TestInfo testInfo) throws IOException {
 878         try (var credentials = new HostCredentials(testInfo);
 879              var tempFolder = new TemporaryDirectory()) {
 880             var author = credentials.getHostedRepository();
 881 
 882             // Populate the projects repository
<span class="line-modified"> 883             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());</span>
 884             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified"> 885             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
 886 
 887             // Make a change with a corresponding PR
 888             var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified"> 889             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);</span>
 890             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 891 
 892             // Verify no checks exists
<span class="line-modified"> 893             var checks = pr.checks(editHash);</span>
 894             assertEquals(0, checks.size());
 895 
 896             // Create a check that is running
 897             var original = CheckBuilder.create(&quot;jcheck&quot;, editHash)
 898                                        .title(&quot;jcheck title&quot;)
 899                                        .summary(&quot;jcheck summary&quot;)
 900                                        .build();
 901             pr.createCheck(original);
 902 
 903             // Verify check is created
<span class="line-modified"> 904             checks = pr.checks(editHash);</span>
 905             assertEquals(1, checks.size());
 906             var retrieved = checks.get(&quot;jcheck&quot;);
 907             assertEquals(&quot;jcheck title&quot;, retrieved.title().get());
 908             assertEquals(&quot;jcheck summary&quot;, retrieved.summary().get());
 909             assertEquals(CheckStatus.IN_PROGRESS, retrieved.status());
 910 
 911             // Cancel the check
 912             var cancelled = CheckBuilder.from(retrieved).cancel().build();
 913             pr.updateCheck(cancelled);
<span class="line-modified"> 914             checks = pr.checks(editHash);</span>
 915             assertEquals(1, checks.size());
 916             retrieved = checks.get(&quot;jcheck&quot;);
 917             assertEquals(&quot;jcheck title&quot;, retrieved.title().get());
 918             assertEquals(&quot;jcheck summary&quot;, retrieved.summary().get());
 919             assertEquals(CheckStatus.CANCELLED, retrieved.status());
 920         }
 921     }
 922 
 923     @Test
 924     void rebaseBeforeCheck(TestInfo testInfo) throws IOException {
 925         try (var credentials = new HostCredentials(testInfo);
 926              var tempFolder = new TemporaryDirectory()) {
 927             var author = credentials.getHostedRepository();
 928             var reviewer = credentials.getHostedRepository();
 929 
 930             var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified"> 931                                            .addAuthor(author.host().currentUser().id())</span>
<span class="line-modified"> 932                                            .addReviewer(reviewer.host().currentUser().id());</span>
 933             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
 934 
 935             // Populate the projects repository
<span class="line-modified"> 936             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());</span>
 937             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified"> 938             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
 939 
 940             // Make a change with a corresponding PR
 941             var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified"> 942             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);</span>
 943             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 944 
 945             // Enable a new check in the target branch
 946             localRepo.checkout(masterHash, true);
<span class="line-modified"> 947             CheckableRepository.init(tempFolder.path(), author.repositoryType(), Path.of(&quot;appendable.txt&quot;),</span>
 948                                      Set.of(&quot;author&quot;, &quot;reviewers&quot;, &quot;whitespace&quot;, &quot;issues&quot;));
 949             var headHash = localRepo.resolve(&quot;HEAD&quot;).orElseThrow();
<span class="line-modified"> 950             localRepo.push(headHash, author.url(), &quot;master&quot;, true);</span>
 951 
 952             // Check the status
 953             TestBotRunner.runPeriodicItems(checkBot);
 954 
 955             // Verify that the check failed
<span class="line-modified"> 956             var checks = pr.checks(editHash);</span>
 957             assertEquals(1, checks.size());
 958             var check = checks.get(&quot;jcheck&quot;);
 959             assertTrue(check.summary().orElseThrow().contains(&quot;commit message does not reference any issue&quot;));
 960             assertEquals(CheckStatus.FAILURE, check.status());
 961 
 962             // Adjust the title to conform and check the status again
 963             pr.setTitle(&quot;12345: This is a pull request&quot;);
 964             TestBotRunner.runPeriodicItems(checkBot);
 965 
 966             // Verify that the check passed
<span class="line-modified"> 967             checks = pr.checks(editHash);</span>
 968             assertEquals(1, checks.size());
 969             check = checks.get(&quot;jcheck&quot;);
 970             assertEquals(CheckStatus.SUCCESS, check.status());
 971         }
 972     }
 973 
 974     @Test
 975     void draft(TestInfo testInfo) throws IOException {
 976         try (var credentials = new HostCredentials(testInfo);
 977              var tempFolder = new TemporaryDirectory()) {
 978             var author = credentials.getHostedRepository();
 979             var reviewer = credentials.getHostedRepository();
 980 
 981             var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified"> 982                                            .addAuthor(author.host().currentUser().id())</span>
<span class="line-modified"> 983                                            .addReviewer(reviewer.host().currentUser().id());</span>
 984             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
 985 
 986             // Populate the projects repository
<span class="line-modified"> 987             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());</span>
 988             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified"> 989             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
 990 
 991             // Make a change with a corresponding PR
 992             var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified"> 993             localRepo.push(editHash, author.url(), &quot;refs/heads/edit&quot;, true);</span>
 994             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;,
 995                                                    &quot;This is a pull request&quot;, true);
 996 
 997             // Check the status
 998             TestBotRunner.runPeriodicItems(checkBot);
 999 
1000             // Verify that the check succeeded
<span class="line-modified">1001             var checks = pr.checks(editHash);</span>
1002             assertEquals(1, checks.size());
1003             var check = checks.get(&quot;jcheck&quot;);
1004             assertEquals(CheckStatus.SUCCESS, check.status());
1005 
1006             // The PR should still not be ready for review as it is a draft
<span class="line-modified">1007             assertFalse(pr.labels().contains(&quot;rfr&quot;));</span>
<span class="line-modified">1008             assertFalse(pr.labels().contains(&quot;ready&quot;));</span>
1009         }
1010     }
1011 }
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/pr/Veto.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="CommandTests.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>