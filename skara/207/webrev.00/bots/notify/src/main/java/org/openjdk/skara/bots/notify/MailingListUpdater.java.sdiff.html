<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/notify/src/main/java/org/openjdk/skara/bots/notify/MailingListUpdater.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="JsonUpdater.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/java/org/openjdk/skara/bots/notify/UpdateHistoryTests.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/notify/src/main/java/org/openjdk/skara/bots/notify/MailingListUpdater.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 68             return &quot;+ &quot; + patch.target().path().orElseThrow();
 69         } else if (patch.status().isDeleted()) {
 70             return &quot;- &quot; + patch.source().path().orElseThrow();
 71         } else if (patch.status().isModified()) {
 72             return &quot;! &quot; + patch.target().path().orElseThrow();
 73         } else {
 74             return &quot;= &quot; + patch.target().path().orElseThrow();
 75         }
 76     }
 77 
 78     private String commitToText(HostedRepository repository, Commit commit) {
 79         var writer = new StringWriter();
 80         var printer = new PrintWriter(writer);
 81 
 82         printer.println(&quot;Changeset: &quot; + commit.hash().abbreviate());
 83         printer.println(&quot;Author:    &quot; + commit.author().name() + &quot; &lt;&quot; + commit.author().email() + &quot;&gt;&quot;);
 84         if (!commit.author().equals(commit.committer())) {
 85             printer.println(&quot;Committer: &quot; + commit.committer().name() + &quot; &lt;&quot; + commit.committer().email() + &quot;&gt;&quot;);
 86         }
 87         printer.println(&quot;Date:      &quot; + commit.date().format(DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss +0000&quot;)));
<span class="line-modified"> 88         printer.println(&quot;URL:       &quot; + repository.getWebUrl(commit.hash()));</span>
 89         printer.println();
 90         printer.println(String.join(&quot;\n&quot;, commit.message()));
 91         printer.println();
 92 
 93         for (var diff : commit.parentDiffs()) {
 94             for (var patch : diff.patches()) {
 95                 printer.println(patchToText(patch));
 96             }
 97         }
 98 
 99         return writer.toString();
100     }
101 
102     private EmailAddress commitsToAuthor(List&lt;Commit&gt; commits) {
103         var commit = commits.get(commits.size() - 1);
104         return EmailAddress.from(commit.committer().name(), commit.committer().email());
105     }
106 
107     private String commitsToSubject(HostedRepository repository, List&lt;Commit&gt; commits, Branch branch) {
108         var subject = new StringBuilder();
<span class="line-modified">109         subject.append(repository.getRepositoryType().shortName());</span>
110         subject.append(&quot;: &quot;);
<span class="line-modified">111         subject.append(repository.getName());</span>
112         subject.append(&quot;: &quot;);
113         if (includeBranch) {
114             subject.append(branch.name());
115             subject.append(&quot;: &quot;);
116         }
117         if (commits.size() &gt; 1) {
118             subject.append(commits.size());
119             subject.append(&quot; new changesets&quot;);
120         } else {
121             subject.append(commits.get(0).message().get(0));
122         }
123         return subject.toString();
124     }
125 
126     private String tagToSubject(HostedRepository repository, Hash hash, OpenJDKTag tag) {
<span class="line-modified">127         return repository.getRepositoryType().shortName() +</span>
128                 &quot;: &quot; +
<span class="line-modified">129                 repository.getName() +</span>
130                 &quot;: Added tag &quot; +
131                 tag.tag() +
132                 &quot; for changeset &quot; +
133                 hash.abbreviate();
134     }
135 
136     private List&lt;Commit&gt; filterAndSendPrCommits(HostedRepository repository, List&lt;Commit&gt; commits) {
137         var ret = new ArrayList&lt;Commit&gt;();
138 
139         var rfrs = list.conversations(Duration.ofDays(365)).stream()
140                        .map(Conversation::first)
141                        .filter(email -&gt; email.subject().startsWith(&quot;RFR: &quot;))
142                        .collect(Collectors.toList());
143 
144         for (var commit : commits) {
145             var candidates = repository.findPullRequestsWithComment(null, &quot;Pushed as commit &quot; + commit.hash() + &quot;.&quot;);
146             if (candidates.size() != 1) {
147                 log.warning(&quot;Commit &quot; + commit.hash() + &quot; matches &quot; + candidates.size() + &quot; pull requests - expected 1&quot;);
148                 ret.add(commit);
149                 continue;
150             }
151 
152             var candidate = candidates.get(0);
<span class="line-modified">153             var prLink = candidate.getWebUrl();</span>
154             var prLinkPattern = Pattern.compile(&quot;^(?:PR: )?&quot; + Pattern.quote(prLink.toString()), Pattern.MULTILINE);
155 
156             var rfrCandidates = rfrs.stream()
157                                     .filter(email -&gt; prLinkPattern.matcher(email.body()).find())
158                                     .collect(Collectors.toList());
159             if (rfrCandidates.size() != 1) {
160                 log.warning(&quot;Pull request &quot; + prLink + &quot; found in &quot; + rfrCandidates.size() + &quot; RFR threads - expected 1&quot;);
161                 ret.add(commit);
162                 continue;
163             }
164             var rfr = rfrCandidates.get(0);
165             var finalAuthor = author != null ? author : commitsToAuthor(commits);
166             var body = commitToText(repository, commit);
167             var email = Email.reply(rfr, &quot;Re: [Integrated] &quot; + rfr.subject(), body)
168                              .sender(sender)
169                              .author(finalAuthor)
170                              .recipient(recipient)
171                              .headers(headers)
172                              .build();
173             list.post(email);
</pre>
<hr />
<pre>
231                 printer.print(&quot;: &quot; + commit.message().get(0));
232             }
233             printer.println();
234         }
235 
236         var tagCommit = commits.get(commits.size() - 1);
237         var subject = tagToSubject(repository, tagCommit.hash(), tag);
238         var finalAuthor = author != null ? author : commitsToAuthor(commits);
239         var email = Email.create(subject, writer.toString())
240                          .sender(sender)
241                          .author(finalAuthor)
242                          .recipient(recipient)
243                          .headers(headers)
244                          .build();
245 
246         list.post(email);
247     }
248 
249     private String newBranchSubject(HostedRepository repository, List&lt;Commit&gt; commits, Branch parent, Branch branch) {
250         var subject = new StringBuilder();
<span class="line-modified">251         subject.append(repository.getRepositoryType().shortName());</span>
252         subject.append(&quot;: &quot;);
<span class="line-modified">253         subject.append(repository.getName());</span>
254         subject.append(&quot;: created branch &quot;);
255         subject.append(branch);
256         subject.append(&quot; based on the branch &quot;);
257         subject.append(parent);
258         subject.append(&quot; containing &quot;);
259         subject.append(commits.size());
260         subject.append(&quot; unique commit&quot;);
261         if (commits.size() != 1) {
262             subject.append(&quot;s&quot;);
263         }
264 
265         return subject.toString();
266     }
267 
268     @Override
269     public void handleNewBranch(HostedRepository repository, List&lt;Commit&gt; commits, Branch parent, Branch branch) {
270         var writer = new StringWriter();
271         var printer = new PrintWriter(writer);
272 
273         if (commits.size() &gt; 0) {
</pre>
</td>
<td>
<hr />
<pre>
 68             return &quot;+ &quot; + patch.target().path().orElseThrow();
 69         } else if (patch.status().isDeleted()) {
 70             return &quot;- &quot; + patch.source().path().orElseThrow();
 71         } else if (patch.status().isModified()) {
 72             return &quot;! &quot; + patch.target().path().orElseThrow();
 73         } else {
 74             return &quot;= &quot; + patch.target().path().orElseThrow();
 75         }
 76     }
 77 
 78     private String commitToText(HostedRepository repository, Commit commit) {
 79         var writer = new StringWriter();
 80         var printer = new PrintWriter(writer);
 81 
 82         printer.println(&quot;Changeset: &quot; + commit.hash().abbreviate());
 83         printer.println(&quot;Author:    &quot; + commit.author().name() + &quot; &lt;&quot; + commit.author().email() + &quot;&gt;&quot;);
 84         if (!commit.author().equals(commit.committer())) {
 85             printer.println(&quot;Committer: &quot; + commit.committer().name() + &quot; &lt;&quot; + commit.committer().email() + &quot;&gt;&quot;);
 86         }
 87         printer.println(&quot;Date:      &quot; + commit.date().format(DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss +0000&quot;)));
<span class="line-modified"> 88         printer.println(&quot;URL:       &quot; + repository.webUrl(commit.hash()));</span>
 89         printer.println();
 90         printer.println(String.join(&quot;\n&quot;, commit.message()));
 91         printer.println();
 92 
 93         for (var diff : commit.parentDiffs()) {
 94             for (var patch : diff.patches()) {
 95                 printer.println(patchToText(patch));
 96             }
 97         }
 98 
 99         return writer.toString();
100     }
101 
102     private EmailAddress commitsToAuthor(List&lt;Commit&gt; commits) {
103         var commit = commits.get(commits.size() - 1);
104         return EmailAddress.from(commit.committer().name(), commit.committer().email());
105     }
106 
107     private String commitsToSubject(HostedRepository repository, List&lt;Commit&gt; commits, Branch branch) {
108         var subject = new StringBuilder();
<span class="line-modified">109         subject.append(repository.repositoryType().shortName());</span>
110         subject.append(&quot;: &quot;);
<span class="line-modified">111         subject.append(repository.name());</span>
112         subject.append(&quot;: &quot;);
113         if (includeBranch) {
114             subject.append(branch.name());
115             subject.append(&quot;: &quot;);
116         }
117         if (commits.size() &gt; 1) {
118             subject.append(commits.size());
119             subject.append(&quot; new changesets&quot;);
120         } else {
121             subject.append(commits.get(0).message().get(0));
122         }
123         return subject.toString();
124     }
125 
126     private String tagToSubject(HostedRepository repository, Hash hash, OpenJDKTag tag) {
<span class="line-modified">127         return repository.repositoryType().shortName() +</span>
128                 &quot;: &quot; +
<span class="line-modified">129                 repository.name() +</span>
130                 &quot;: Added tag &quot; +
131                 tag.tag() +
132                 &quot; for changeset &quot; +
133                 hash.abbreviate();
134     }
135 
136     private List&lt;Commit&gt; filterAndSendPrCommits(HostedRepository repository, List&lt;Commit&gt; commits) {
137         var ret = new ArrayList&lt;Commit&gt;();
138 
139         var rfrs = list.conversations(Duration.ofDays(365)).stream()
140                        .map(Conversation::first)
141                        .filter(email -&gt; email.subject().startsWith(&quot;RFR: &quot;))
142                        .collect(Collectors.toList());
143 
144         for (var commit : commits) {
145             var candidates = repository.findPullRequestsWithComment(null, &quot;Pushed as commit &quot; + commit.hash() + &quot;.&quot;);
146             if (candidates.size() != 1) {
147                 log.warning(&quot;Commit &quot; + commit.hash() + &quot; matches &quot; + candidates.size() + &quot; pull requests - expected 1&quot;);
148                 ret.add(commit);
149                 continue;
150             }
151 
152             var candidate = candidates.get(0);
<span class="line-modified">153             var prLink = candidate.webUrl();</span>
154             var prLinkPattern = Pattern.compile(&quot;^(?:PR: )?&quot; + Pattern.quote(prLink.toString()), Pattern.MULTILINE);
155 
156             var rfrCandidates = rfrs.stream()
157                                     .filter(email -&gt; prLinkPattern.matcher(email.body()).find())
158                                     .collect(Collectors.toList());
159             if (rfrCandidates.size() != 1) {
160                 log.warning(&quot;Pull request &quot; + prLink + &quot; found in &quot; + rfrCandidates.size() + &quot; RFR threads - expected 1&quot;);
161                 ret.add(commit);
162                 continue;
163             }
164             var rfr = rfrCandidates.get(0);
165             var finalAuthor = author != null ? author : commitsToAuthor(commits);
166             var body = commitToText(repository, commit);
167             var email = Email.reply(rfr, &quot;Re: [Integrated] &quot; + rfr.subject(), body)
168                              .sender(sender)
169                              .author(finalAuthor)
170                              .recipient(recipient)
171                              .headers(headers)
172                              .build();
173             list.post(email);
</pre>
<hr />
<pre>
231                 printer.print(&quot;: &quot; + commit.message().get(0));
232             }
233             printer.println();
234         }
235 
236         var tagCommit = commits.get(commits.size() - 1);
237         var subject = tagToSubject(repository, tagCommit.hash(), tag);
238         var finalAuthor = author != null ? author : commitsToAuthor(commits);
239         var email = Email.create(subject, writer.toString())
240                          .sender(sender)
241                          .author(finalAuthor)
242                          .recipient(recipient)
243                          .headers(headers)
244                          .build();
245 
246         list.post(email);
247     }
248 
249     private String newBranchSubject(HostedRepository repository, List&lt;Commit&gt; commits, Branch parent, Branch branch) {
250         var subject = new StringBuilder();
<span class="line-modified">251         subject.append(repository.repositoryType().shortName());</span>
252         subject.append(&quot;: &quot;);
<span class="line-modified">253         subject.append(repository.name());</span>
254         subject.append(&quot;: created branch &quot;);
255         subject.append(branch);
256         subject.append(&quot; based on the branch &quot;);
257         subject.append(parent);
258         subject.append(&quot; containing &quot;);
259         subject.append(commits.size());
260         subject.append(&quot; unique commit&quot;);
261         if (commits.size() != 1) {
262             subject.append(&quot;s&quot;);
263         }
264 
265         return subject.toString();
266     }
267 
268     @Override
269     public void handleNewBranch(HostedRepository repository, List&lt;Commit&gt; commits, Branch parent, Branch branch) {
270         var writer = new StringWriter();
271         var printer = new PrintWriter(writer);
272 
273         if (commits.size() &gt; 0) {
</pre>
</td>
</tr>
</table>
<center><a href="JsonUpdater.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/java/org/openjdk/skara/bots/notify/UpdateHistoryTests.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>