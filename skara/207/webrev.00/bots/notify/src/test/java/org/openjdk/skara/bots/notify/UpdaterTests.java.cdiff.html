<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="UpdateHistoryTests.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../pr/src/main/java/org/openjdk/skara/bots/pr/AllowCommand.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 64,13 ***</span>
      void testJsonUpdaterBranch(TestInfo testInfo) throws IOException {
          try (var credentials = new HostCredentials(testInfo);
               var tempFolder = new TemporaryDirectory()) {
              var repo = credentials.getHostedRepository();
              var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(localRepoFolder, repo.getRepositoryType());</span>
              credentials.commitLock(localRepo);
<span class="line-modified">!             localRepo.pushAll(repo.getUrl());</span>
  
              var tagStorage = createTagStorage(repo);
              var branchStorage = createBranchStorage(repo);
              var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
              Files.createDirectory(jsonFolder);
<span class="line-new-header">--- 64,13 ---</span>
      void testJsonUpdaterBranch(TestInfo testInfo) throws IOException {
          try (var credentials = new HostCredentials(testInfo);
               var tempFolder = new TemporaryDirectory()) {
              var repo = credentials.getHostedRepository();
              var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());</span>
              credentials.commitLock(localRepo);
<span class="line-modified">!             localRepo.pushAll(repo.url());</span>
  
              var tagStorage = createTagStorage(repo);
              var branchStorage = createBranchStorage(repo);
              var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
              Files.createDirectory(jsonFolder);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 81,18 ***</span>
  
              TestBotRunner.runPeriodicItems(notifyBot);
              assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));
  
              var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;One more line&quot;, &quot;12345678: Fixes&quot;);
<span class="line-modified">!             localRepo.push(editHash, repo.getUrl(), &quot;master&quot;);</span>
              TestBotRunner.runPeriodicItems(notifyBot);
              var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);
              assertEquals(1, jsonFiles.size());
              var jsonData = Files.readString(jsonFiles.get(0), StandardCharsets.UTF_8);
              var json = JSON.parse(jsonData);
              assertEquals(1, json.asArray().size());
<span class="line-modified">!             assertEquals(repo.getWebUrl(editHash).toString(), json.asArray().get(0).get(&quot;url&quot;).asString());</span>
              assertEquals(List.of(&quot;12345678&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
                                                    .map(JSONValue::asString)
                                                    .collect(Collectors.toList()));
          }
      }
<span class="line-new-header">--- 81,18 ---</span>
  
              TestBotRunner.runPeriodicItems(notifyBot);
              assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));
  
              var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;One more line&quot;, &quot;12345678: Fixes&quot;);
<span class="line-modified">!             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
              TestBotRunner.runPeriodicItems(notifyBot);
              var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);
              assertEquals(1, jsonFiles.size());
              var jsonData = Files.readString(jsonFiles.get(0), StandardCharsets.UTF_8);
              var json = JSON.parse(jsonData);
              assertEquals(1, json.asArray().size());
<span class="line-modified">!             assertEquals(repo.webUrl(editHash).toString(), json.asArray().get(0).get(&quot;url&quot;).asString());</span>
              assertEquals(List.of(&quot;12345678&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
                                                    .map(JSONValue::asString)
                                                    .collect(Collectors.toList()));
          }
      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 101,15 ***</span>
      void testJsonUpdaterTag(TestInfo testInfo) throws IOException {
          try (var credentials = new HostCredentials(testInfo);
               var tempFolder = new TemporaryDirectory()) {
              var repo = credentials.getHostedRepository();
              var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(localRepoFolder, repo.getRepositoryType());</span>
              credentials.commitLock(localRepo);
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
              localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
<span class="line-modified">!             localRepo.pushAll(repo.getUrl());</span>
  
              var tagStorage = createTagStorage(repo);
              var branchStorage = createBranchStorage(repo);
              var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
              Files.createDirectory(jsonFolder);
<span class="line-new-header">--- 101,15 ---</span>
      void testJsonUpdaterTag(TestInfo testInfo) throws IOException {
          try (var credentials = new HostCredentials(testInfo);
               var tempFolder = new TemporaryDirectory()) {
              var repo = credentials.getHostedRepository();
              var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());</span>
              credentials.commitLock(localRepo);
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
              localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
<span class="line-modified">!             localRepo.pushAll(repo.url());</span>
  
              var tagStorage = createTagStorage(repo);
              var branchStorage = createBranchStorage(repo);
              var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
              Files.createDirectory(jsonFolder);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 120,15 ***</span>
  
              TestBotRunner.runPeriodicItems(notifyBot);
              assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));
  
              var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
<span class="line-modified">!             localRepo.fetch(repo.getUrl(), &quot;history:history&quot;);</span>
              localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
              var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;34567890: Even more fixes&quot;);
              localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
<span class="line-modified">!             localRepo.pushAll(repo.getUrl());</span>
  
              TestBotRunner.runPeriodicItems(notifyBot);
              var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);
              assertEquals(3, jsonFiles.size());
  
<span class="line-new-header">--- 120,15 ---</span>
  
              TestBotRunner.runPeriodicItems(notifyBot);
              assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));
  
              var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
<span class="line-modified">!             localRepo.fetch(repo.url(), &quot;history:history&quot;);</span>
              localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
              var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;34567890: Even more fixes&quot;);
              localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
<span class="line-modified">!             localRepo.pushAll(repo.url());</span>
  
              TestBotRunner.runPeriodicItems(notifyBot);
              var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);
              assertEquals(3, jsonFiles.size());
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 139,16 ***</span>
                  if (json.asArray().get(0).contains(&quot;date&quot;)) {
                      assertEquals(2, json.asArray().size());
                      assertEquals(List.of(&quot;23456789&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
                                                            .map(JSONValue::asString)
                                                            .collect(Collectors.toList()));
<span class="line-modified">!                     assertEquals(repo.getWebUrl(editHash).toString(), json.asArray().get(0).get(&quot;url&quot;).asString());</span>
                      assertEquals(&quot;team&quot;, json.asArray().get(0).get(&quot;build&quot;).asString());
                      assertEquals(List.of(&quot;34567890&quot;), json.asArray().get(1).get(&quot;issue&quot;).asArray().stream()
                                                            .map(JSONValue::asString)
                                                            .collect(Collectors.toList()));
<span class="line-modified">!                     assertEquals(repo.getWebUrl(editHash2).toString(), json.asArray().get(1).get(&quot;url&quot;).asString());</span>
                      assertEquals(&quot;team&quot;, json.asArray().get(1).get(&quot;build&quot;).asString());
                  } else {
                      assertEquals(1, json.asArray().size());
                      if (json.asArray().get(0).get(&quot;build&quot;).asString().equals(&quot;b02&quot;)) {
                          assertEquals(List.of(&quot;23456789&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
<span class="line-new-header">--- 139,16 ---</span>
                  if (json.asArray().get(0).contains(&quot;date&quot;)) {
                      assertEquals(2, json.asArray().size());
                      assertEquals(List.of(&quot;23456789&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
                                                            .map(JSONValue::asString)
                                                            .collect(Collectors.toList()));
<span class="line-modified">!                     assertEquals(repo.webUrl(editHash).toString(), json.asArray().get(0).get(&quot;url&quot;).asString());</span>
                      assertEquals(&quot;team&quot;, json.asArray().get(0).get(&quot;build&quot;).asString());
                      assertEquals(List.of(&quot;34567890&quot;), json.asArray().get(1).get(&quot;issue&quot;).asArray().stream()
                                                            .map(JSONValue::asString)
                                                            .collect(Collectors.toList()));
<span class="line-modified">!                     assertEquals(repo.webUrl(editHash2).toString(), json.asArray().get(1).get(&quot;url&quot;).asString());</span>
                      assertEquals(&quot;team&quot;, json.asArray().get(1).get(&quot;build&quot;).asString());
                  } else {
                      assertEquals(1, json.asArray().size());
                      if (json.asArray().get(0).get(&quot;build&quot;).asString().equals(&quot;b02&quot;)) {
                          assertEquals(List.of(&quot;23456789&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
</pre>
<hr />
<pre>
<span class="line-old-header">*** 170,14 ***</span>
          try (var listServer = new TestMailmanServer();
               var credentials = new HostCredentials(testInfo);
               var tempFolder = new TemporaryDirectory()) {
              var repo = credentials.getHostedRepository();
              var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(repoFolder, repo.getRepositoryType());</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
              credentials.commitLock(localRepo);
<span class="line-modified">!             localRepo.pushAll(repo.getUrl());</span>
  
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
              var mailmanList = mailmanServer.getList(listAddress.address());
              var tagStorage = createTagStorage(repo);
<span class="line-new-header">--- 170,14 ---</span>
          try (var listServer = new TestMailmanServer();
               var credentials = new HostCredentials(testInfo);
               var tempFolder = new TemporaryDirectory()) {
              var repo = credentials.getHostedRepository();
              var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
              credentials.commitLock(localRepo);
<span class="line-modified">!             localRepo.pushAll(repo.url());</span>
  
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
              var mailmanList = mailmanServer.getList(listAddress.address());
              var tagStorage = createTagStorage(repo);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 192,11 ***</span>
              // No mail should be sent on the first run as there is no history
              TestBotRunner.runPeriodicItems(notifyBot);
              assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
  
              var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
<span class="line-modified">!             localRepo.push(editHash, repo.getUrl(), &quot;master&quot;);</span>
              TestBotRunner.runPeriodicItems(notifyBot);
              listServer.processIncoming();
  
              var conversations = mailmanList.conversations(Duration.ofDays(1));
              var email = conversations.get(0).first();
<span class="line-new-header">--- 192,11 ---</span>
              // No mail should be sent on the first run as there is no history
              TestBotRunner.runPeriodicItems(notifyBot);
              assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
  
              var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
<span class="line-modified">!             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
              TestBotRunner.runPeriodicItems(notifyBot);
              listServer.processIncoming();
  
              var conversations = mailmanList.conversations(Duration.ofDays(1));
              var email = conversations.get(0).first();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 221,14 ***</span>
          try (var listServer = new TestMailmanServer();
               var credentials = new HostCredentials(testInfo);
               var tempFolder = new TemporaryDirectory()) {
              var repo = credentials.getHostedRepository();
              var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(repoFolder, repo.getRepositoryType());</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
              credentials.commitLock(localRepo);
<span class="line-modified">!             localRepo.pushAll(repo.getUrl());</span>
  
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
              var mailmanList = mailmanServer.getList(listAddress.address());
              var tagStorage = createTagStorage(repo);
<span class="line-new-header">--- 221,14 ---</span>
          try (var listServer = new TestMailmanServer();
               var credentials = new HostCredentials(testInfo);
               var tempFolder = new TemporaryDirectory()) {
              var repo = credentials.getHostedRepository();
              var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
              credentials.commitLock(localRepo);
<span class="line-modified">!             localRepo.pushAll(repo.url());</span>
  
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
              var mailmanList = mailmanServer.getList(listAddress.address());
              var tagStorage = createTagStorage(repo);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 244,14 ***</span>
              TestBotRunner.runPeriodicItems(notifyBot);
              assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
  
              var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
                                                                  &quot;first_author&quot;, &quot;first@author.example.com&quot;);
<span class="line-modified">!             localRepo.push(editHash1, repo.getUrl(), &quot;master&quot;);</span>
              var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;,
                                                                  &quot;another_author&quot;, &quot;another@author.example.com&quot;);
<span class="line-modified">!             localRepo.push(editHash2, repo.getUrl(), &quot;master&quot;);</span>
  
              TestBotRunner.runPeriodicItems(notifyBot);
              listServer.processIncoming();
  
              var conversations = mailmanList.conversations(Duration.ofDays(1));
<span class="line-new-header">--- 244,14 ---</span>
              TestBotRunner.runPeriodicItems(notifyBot);
              assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
  
              var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
                                                                  &quot;first_author&quot;, &quot;first@author.example.com&quot;);
<span class="line-modified">!             localRepo.push(editHash1, repo.url(), &quot;master&quot;);</span>
              var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;,
                                                                  &quot;another_author&quot;, &quot;another@author.example.com&quot;);
<span class="line-modified">!             localRepo.push(editHash2, repo.url(), &quot;master&quot;);</span>
  
              TestBotRunner.runPeriodicItems(notifyBot);
              listServer.processIncoming();
  
              var conversations = mailmanList.conversations(Duration.ofDays(1));
</pre>
<hr />
<pre>
<span class="line-old-header">*** 274,14 ***</span>
          try (var listServer = new TestMailmanServer();
               var credentials = new HostCredentials(testInfo);
               var tempFolder = new TemporaryDirectory()) {
              var repo = credentials.getHostedRepository();
              var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(repoFolder, repo.getRepositoryType());</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
              credentials.commitLock(localRepo);
<span class="line-modified">!             localRepo.pushAll(repo.getUrl());</span>
  
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
              var mailmanList = mailmanServer.getList(listAddress.address());
              var tagStorage = createTagStorage(repo);
<span class="line-new-header">--- 274,14 ---</span>
          try (var listServer = new TestMailmanServer();
               var credentials = new HostCredentials(testInfo);
               var tempFolder = new TemporaryDirectory()) {
              var repo = credentials.getHostedRepository();
              var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
              credentials.commitLock(localRepo);
<span class="line-modified">!             localRepo.pushAll(repo.url());</span>
  
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
              var mailmanList = mailmanServer.getList(listAddress.address());
              var tagStorage = createTagStorage(repo);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 298,11 ***</span>
              assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
  
              var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
                                                                 &quot;author&quot;, &quot;author@test.test&quot;,
                                                                 &quot;committer&quot;, &quot;committer@test.test&quot;);
<span class="line-modified">!             localRepo.push(editHash, repo.getUrl(), &quot;master&quot;);</span>
              TestBotRunner.runPeriodicItems(notifyBot);
              listServer.processIncoming();
  
              var conversations = mailmanList.conversations(Duration.ofDays(1));
              var email = conversations.get(0).first();
<span class="line-new-header">--- 298,11 ---</span>
              assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
  
              var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
                                                                 &quot;author&quot;, &quot;author@test.test&quot;,
                                                                 &quot;committer&quot;, &quot;committer@test.test&quot;);
<span class="line-modified">!             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
              TestBotRunner.runPeriodicItems(notifyBot);
              listServer.processIncoming();
  
              var conversations = mailmanList.conversations(Duration.ofDays(1));
              var email = conversations.get(0).first();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 322,15 ***</span>
          try (var listServer = new TestMailmanServer();
               var credentials = new HostCredentials(testInfo);
               var tempFolder = new TemporaryDirectory()) {
              var repo = credentials.getHostedRepository();
              var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(repoFolder, repo.getRepositoryType());</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
              credentials.commitLock(localRepo);
              var branch = localRepo.branch(masterHash, &quot;another&quot;);
<span class="line-modified">!             localRepo.pushAll(repo.getUrl());</span>
  
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
              var mailmanList = mailmanServer.getList(listAddress.address());
              var tagStorage = createTagStorage(repo);
<span class="line-new-header">--- 322,15 ---</span>
          try (var listServer = new TestMailmanServer();
               var credentials = new HostCredentials(testInfo);
               var tempFolder = new TemporaryDirectory()) {
              var repo = credentials.getHostedRepository();
              var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
              credentials.commitLock(localRepo);
              var branch = localRepo.branch(masterHash, &quot;another&quot;);
<span class="line-modified">!             localRepo.pushAll(repo.url());</span>
  
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
              var mailmanList = mailmanServer.getList(listAddress.address());
              var tagStorage = createTagStorage(repo);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 346,13 ***</span>
              // No mail should be sent on the first run as there is no history
              TestBotRunner.runPeriodicItems(notifyBot);
              assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
  
              var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
<span class="line-modified">!             localRepo.push(editHash1, repo.getUrl(), &quot;master&quot;);</span>
              var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;);
<span class="line-modified">!             localRepo.push(editHash2, repo.getUrl(), &quot;master&quot;);</span>
  
              TestBotRunner.runPeriodicItems(notifyBot);
              listServer.processIncoming();
  
              var conversations = mailmanList.conversations(Duration.ofDays(1));
<span class="line-new-header">--- 346,13 ---</span>
              // No mail should be sent on the first run as there is no history
              TestBotRunner.runPeriodicItems(notifyBot);
              assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
  
              var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
<span class="line-modified">!             localRepo.push(editHash1, repo.url(), &quot;master&quot;);</span>
              var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;);
<span class="line-modified">!             localRepo.push(editHash2, repo.url(), &quot;master&quot;);</span>
  
              TestBotRunner.runPeriodicItems(notifyBot);
              listServer.processIncoming();
  
              var conversations = mailmanList.conversations(Duration.ofDays(1));
</pre>
<hr />
<pre>
<span class="line-old-header">*** 369,11 ***</span>
              assertFalse(email.body().contains(masterHash.abbreviate()));
              assertFalse(email.body().contains(&quot;456789AB: Yet more fixes&quot;));
  
              localRepo.checkout(branch, true);
              var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another branch&quot;, &quot;456789AB: Yet more fixes&quot;);
<span class="line-modified">!             localRepo.push(editHash3, repo.getUrl(), &quot;another&quot;);</span>
  
              TestBotRunner.runPeriodicItems(notifyBot);
              listServer.processIncoming();
  
              conversations = mailmanList.conversations(Duration.ofDays(1));
<span class="line-new-header">--- 369,11 ---</span>
              assertFalse(email.body().contains(masterHash.abbreviate()));
              assertFalse(email.body().contains(&quot;456789AB: Yet more fixes&quot;));
  
              localRepo.checkout(branch, true);
              var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another branch&quot;, &quot;456789AB: Yet more fixes&quot;);
<span class="line-modified">!             localRepo.push(editHash3, repo.url(), &quot;another&quot;);</span>
  
              TestBotRunner.runPeriodicItems(notifyBot);
              listServer.processIncoming();
  
              conversations = mailmanList.conversations(Duration.ofDays(1));
</pre>
<hr />
<pre>
<span class="line-old-header">*** 395,14 ***</span>
          try (var listServer = new TestMailmanServer();
               var credentials = new HostCredentials(testInfo);
               var tempFolder = new TemporaryDirectory()) {
              var repo = credentials.getHostedRepository();
              var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(repoFolder, repo.getRepositoryType());</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
              credentials.commitLock(localRepo);
<span class="line-modified">!             localRepo.pushAll(repo.getUrl());</span>
  
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
              var mailmanList = mailmanServer.getList(listAddress.address());
              var tagStorage = createTagStorage(repo);
<span class="line-new-header">--- 395,14 ---</span>
          try (var listServer = new TestMailmanServer();
               var credentials = new HostCredentials(testInfo);
               var tempFolder = new TemporaryDirectory()) {
              var repo = credentials.getHostedRepository();
              var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
              credentials.commitLock(localRepo);
<span class="line-modified">!             localRepo.pushAll(repo.url());</span>
  
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
              var mailmanList = mailmanServer.getList(listAddress.address());
              var tagStorage = createTagStorage(repo);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 418,32 ***</span>
              // No mail should be sent on the first run as there is no history
              TestBotRunner.runPeriodicItems(notifyBot);
              assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
  
              var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
<span class="line-modified">!             localRepo.push(editHash, repo.getUrl(), &quot;edit&quot;);</span>
              var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
  
              // Create a potentially conflicting one
              var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
<span class="line-modified">!             localRepo.push(otherHash, repo.getUrl(), &quot;other&quot;);</span>
              var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);
  
              // PR hasn&#39;t been integrated yet, so there should be no mail
              TestBotRunner.runPeriodicItems(notifyBot);
              assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
  
              // Simulate an RFR email
<span class="line-modified">!             var rfr = Email.create(sender, &quot;RFR: My PR&quot;, &quot;PR: &quot; + pr.getWebUrl().toString())</span>
                      .recipient(listAddress)
                      .build();
              mailmanList.post(rfr);
              listServer.processIncoming();
  
              // And an integration
              pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
<span class="line-modified">!             localRepo.push(editHash, repo.getUrl(), &quot;master&quot;);</span>
              TestBotRunner.runPeriodicItems(notifyBot);
              listServer.processIncoming();
  
              var conversations = mailmanList.conversations(Duration.ofDays(1));
              assertEquals(1, conversations.size());
<span class="line-new-header">--- 418,32 ---</span>
              // No mail should be sent on the first run as there is no history
              TestBotRunner.runPeriodicItems(notifyBot);
              assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
  
              var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
<span class="line-modified">!             localRepo.push(editHash, repo.url(), &quot;edit&quot;);</span>
              var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
  
              // Create a potentially conflicting one
              var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
<span class="line-modified">!             localRepo.push(otherHash, repo.url(), &quot;other&quot;);</span>
              var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);
  
              // PR hasn&#39;t been integrated yet, so there should be no mail
              TestBotRunner.runPeriodicItems(notifyBot);
              assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
  
              // Simulate an RFR email
<span class="line-modified">!             var rfr = Email.create(sender, &quot;RFR: My PR&quot;, &quot;PR: &quot; + pr.webUrl().toString())</span>
                      .recipient(listAddress)
                      .build();
              mailmanList.post(rfr);
              listServer.processIncoming();
  
              // And an integration
              pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
<span class="line-modified">!             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
              TestBotRunner.runPeriodicItems(notifyBot);
              listServer.processIncoming();
  
              var conversations = mailmanList.conversations(Duration.ofDays(1));
              assertEquals(1, conversations.size());
</pre>
<hr />
<pre>
<span class="line-old-header">*** 460,11 ***</span>
              assertFalse(email.body().contains(masterHash.abbreviate()));
              assertTrue(email.hasHeader(&quot;extra1&quot;));
              assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
  
              // Now push the other one without a matching PR - PR_ONLY will not generate a mail
<span class="line-modified">!             localRepo.push(otherHash, repo.getUrl(), &quot;master&quot;);</span>
              TestBotRunner.runPeriodicItems(notifyBot);
              assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofSeconds(1)));
          }
      }
  
<span class="line-new-header">--- 460,11 ---</span>
              assertFalse(email.body().contains(masterHash.abbreviate()));
              assertTrue(email.hasHeader(&quot;extra1&quot;));
              assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
  
              // Now push the other one without a matching PR - PR_ONLY will not generate a mail
<span class="line-modified">!             localRepo.push(otherHash, repo.url(), &quot;master&quot;);</span>
              TestBotRunner.runPeriodicItems(notifyBot);
              assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofSeconds(1)));
          }
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 473,14 ***</span>
          try (var listServer = new TestMailmanServer();
               var credentials = new HostCredentials(testInfo);
               var tempFolder = new TemporaryDirectory()) {
              var repo = credentials.getHostedRepository();
              var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(repoFolder, repo.getRepositoryType());</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
              credentials.commitLock(localRepo);
<span class="line-modified">!             localRepo.pushAll(repo.getUrl());</span>
  
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
              var mailmanList = mailmanServer.getList(listAddress.address());
              var tagStorage = createTagStorage(repo);
<span class="line-new-header">--- 473,14 ---</span>
          try (var listServer = new TestMailmanServer();
               var credentials = new HostCredentials(testInfo);
               var tempFolder = new TemporaryDirectory()) {
              var repo = credentials.getHostedRepository();
              var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
              credentials.commitLock(localRepo);
<span class="line-modified">!             localRepo.pushAll(repo.url());</span>
  
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
              var mailmanList = mailmanServer.getList(listAddress.address());
              var tagStorage = createTagStorage(repo);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 495,36 ***</span>
              // No mail should be sent on the first run as there is no history
              TestBotRunner.runPeriodicItems(notifyBot);
              assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
  
              var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
<span class="line-modified">!             localRepo.push(editHash, repo.getUrl(), &quot;edit&quot;);</span>
              var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
  
              // Create a potentially conflicting one
              var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
<span class="line-modified">!             localRepo.push(otherHash, repo.getUrl(), &quot;other&quot;);</span>
              var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);
  
              // PR hasn&#39;t been integrated yet, so there should be no mail
              TestBotRunner.runPeriodicItems(notifyBot);
              assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
  
              // Simulate an RFR email
<span class="line-modified">!             var rfr = Email.create(&quot;RFR: My PR&quot;, &quot;PR:\n&quot; + pr.getWebUrl().toString())</span>
                             .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))
                             .recipient(listAddress)
                             .build();
              mailmanList.post(rfr);
              listServer.processIncoming();
  
              // And an integration
              pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
<span class="line-modified">!             localRepo.push(editHash, repo.getUrl(), &quot;master&quot;);</span>
  
              // Push the other one without a matching PR
<span class="line-modified">!             localRepo.push(otherHash, repo.getUrl(), &quot;master&quot;);</span>
  
              TestBotRunner.runPeriodicItems(notifyBot);
              listServer.processIncoming();
              listServer.processIncoming();
  
<span class="line-new-header">--- 495,36 ---</span>
              // No mail should be sent on the first run as there is no history
              TestBotRunner.runPeriodicItems(notifyBot);
              assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
  
              var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
<span class="line-modified">!             localRepo.push(editHash, repo.url(), &quot;edit&quot;);</span>
              var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
  
              // Create a potentially conflicting one
              var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
<span class="line-modified">!             localRepo.push(otherHash, repo.url(), &quot;other&quot;);</span>
              var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);
  
              // PR hasn&#39;t been integrated yet, so there should be no mail
              TestBotRunner.runPeriodicItems(notifyBot);
              assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
  
              // Simulate an RFR email
<span class="line-modified">!             var rfr = Email.create(&quot;RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())</span>
                             .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))
                             .recipient(listAddress)
                             .build();
              mailmanList.post(rfr);
              listServer.processIncoming();
  
              // And an integration
              pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
<span class="line-modified">!             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
  
              // Push the other one without a matching PR
<span class="line-modified">!             localRepo.push(otherHash, repo.url(), &quot;master&quot;);</span>
  
              TestBotRunner.runPeriodicItems(notifyBot);
              listServer.processIncoming();
              listServer.processIncoming();
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 559,15 ***</span>
          try (var credentials = new HostCredentials(testInfo);
               var tempFolder = new TemporaryDirectory();
               var listServer = new TestMailmanServer()) {
              var repo = credentials.getHostedRepository();
              var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(localRepoFolder, repo.getRepositoryType());</span>
              credentials.commitLock(localRepo);
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
              localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
<span class="line-modified">!             localRepo.pushAll(repo.getUrl());</span>
  
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
              var mailmanList = mailmanServer.getList(listAddress.address());
              var tagStorage = createTagStorage(repo);
<span class="line-new-header">--- 559,15 ---</span>
          try (var credentials = new HostCredentials(testInfo);
               var tempFolder = new TemporaryDirectory();
               var listServer = new TestMailmanServer()) {
              var repo = credentials.getHostedRepository();
              var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());</span>
              credentials.commitLock(localRepo);
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
              localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
<span class="line-modified">!             localRepo.pushAll(repo.url());</span>
  
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
              var mailmanList = mailmanServer.getList(listAddress.address());
              var tagStorage = createTagStorage(repo);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 585,20 ***</span>
              // No mail should be sent on the first run as there is no history
              TestBotRunner.runPeriodicItems(notifyBot);
              assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
  
              var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
<span class="line-modified">!             localRepo.fetch(repo.getUrl(), &quot;history:history&quot;);</span>
              localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
              CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);
              CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);
              var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);
              localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
              CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);
              var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);
              localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
<span class="line-modified">!             localRepo.pushAll(repo.getUrl());</span>
  
              TestBotRunner.runPeriodicItems(notifyBot);
              listServer.processIncoming();
              listServer.processIncoming();
              listServer.processIncoming();
<span class="line-new-header">--- 585,20 ---</span>
              // No mail should be sent on the first run as there is no history
              TestBotRunner.runPeriodicItems(notifyBot);
              assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
  
              var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
<span class="line-modified">!             localRepo.fetch(repo.url(), &quot;history:history&quot;);</span>
              localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
              CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);
              CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);
              var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);
              localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
              CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);
              var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);
              localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
<span class="line-modified">!             localRepo.pushAll(repo.url());</span>
  
              TestBotRunner.runPeriodicItems(notifyBot);
              listServer.processIncoming();
              listServer.processIncoming();
              listServer.processIncoming();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 652,14 ***</span>
          try (var listServer = new TestMailmanServer();
               var credentials = new HostCredentials(testInfo);
               var tempFolder = new TemporaryDirectory()) {
              var repo = credentials.getHostedRepository();
              var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(repoFolder, repo.getRepositoryType());</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
              credentials.commitLock(localRepo);
<span class="line-modified">!             localRepo.pushAll(repo.getUrl());</span>
  
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
              var mailmanList = mailmanServer.getList(listAddress.address());
              var tagStorage = createTagStorage(repo);
<span class="line-new-header">--- 652,14 ---</span>
          try (var listServer = new TestMailmanServer();
               var credentials = new HostCredentials(testInfo);
               var tempFolder = new TemporaryDirectory()) {
              var repo = credentials.getHostedRepository();
              var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
              credentials.commitLock(localRepo);
<span class="line-modified">!             localRepo.pushAll(repo.url());</span>
  
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
              var mailmanList = mailmanServer.getList(listAddress.address());
              var tagStorage = createTagStorage(repo);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 675,11 ***</span>
              TestBotRunner.runPeriodicItems(notifyBot);
              assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
  
              CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;12345678: Some fixes&quot;);
              var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
<span class="line-modified">!             localRepo.push(editHash, repo.getUrl(), &quot;newbranch1&quot;);</span>
              TestBotRunner.runPeriodicItems(notifyBot);
              listServer.processIncoming();
  
              var conversations = mailmanList.conversations(Duration.ofDays(1));
              var email = conversations.get(0).first();
<span class="line-new-header">--- 675,11 ---</span>
              TestBotRunner.runPeriodicItems(notifyBot);
              assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
  
              CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;12345678: Some fixes&quot;);
              var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
<span class="line-modified">!             localRepo.push(editHash, repo.url(), &quot;newbranch1&quot;);</span>
              TestBotRunner.runPeriodicItems(notifyBot);
              listServer.processIncoming();
  
              var conversations = mailmanList.conversations(Duration.ofDays(1));
              var email = conversations.get(0).first();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 694,11 ***</span>
              assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
  
              TestBotRunner.runPeriodicItems(notifyBot);
              assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
  
<span class="line-modified">!             localRepo.push(editHash, repo.getUrl(), &quot;newbranch2&quot;);</span>
              TestBotRunner.runPeriodicItems(notifyBot);
              listServer.processIncoming();
  
              var newConversation = mailmanList.conversations(Duration.ofDays(1)).stream()
                                               .filter(c -&gt; !c.equals(conversations.get(0)))
<span class="line-new-header">--- 694,11 ---</span>
              assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
  
              TestBotRunner.runPeriodicItems(notifyBot);
              assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
  
<span class="line-modified">!             localRepo.push(editHash, repo.url(), &quot;newbranch2&quot;);</span>
              TestBotRunner.runPeriodicItems(notifyBot);
              listServer.processIncoming();
  
              var newConversation = mailmanList.conversations(Duration.ofDays(1)).stream()
                                               .filter(c -&gt; !c.equals(conversations.get(0)))
</pre>
<center><a href="UpdateHistoryTests.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../pr/src/main/java/org/openjdk/skara/bots/pr/AllowCommand.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>