<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="MailingListArchiveReaderBotTests.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="WebrevStorageTests.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 22,11 ***</span>
   */
  package org.openjdk.skara.bots.mlbridge;
  
  import org.openjdk.skara.email.EmailAddress;
  import org.openjdk.skara.host.*;
<span class="line-modified">! import org.openjdk.skara.host.network.URIBuilder;</span>
  import org.openjdk.skara.mailinglist.MailingListServerFactory;
  import org.openjdk.skara.test.*;
  import org.openjdk.skara.vcs.Repository;
  
  import org.junit.jupiter.api.*;
<span class="line-new-header">--- 22,11 ---</span>
   */
  package org.openjdk.skara.bots.mlbridge;
  
  import org.openjdk.skara.email.EmailAddress;
  import org.openjdk.skara.host.*;
<span class="line-modified">! import org.openjdk.skara.network.URIBuilder;</span>
  import org.openjdk.skara.mailinglist.MailingListServerFactory;
  import org.openjdk.skara.test.*;
  import org.openjdk.skara.vcs.Repository;
  
  import org.junit.jupiter.api.*;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 91,12 ***</span>
      private long countSubstrings(String string, String substring) {
          return Pattern.compile(substring).matcher(string).results().count();
      }
  
      private String noreplyAddress(HostedRepository repository) {
<span class="line-modified">!         return &quot;test+&quot; + repository.host().getCurrentUserDetails().id() + &quot;+&quot; +</span>
<span class="line-modified">!                 repository.host().getCurrentUserDetails().userName() +</span>
                  &quot;@openjdk.java.net&quot;;
      }
  
      @Test
      void simpleArchive(TestInfo testInfo) throws IOException {
<span class="line-new-header">--- 91,12 ---</span>
      private long countSubstrings(String string, String substring) {
          return Pattern.compile(substring).matcher(string).results().count();
      }
  
      private String noreplyAddress(HostedRepository repository) {
<span class="line-modified">!         return &quot;test+&quot; + repository.host().currentUser().id() + &quot;+&quot; +</span>
<span class="line-modified">!                 repository.host().currentUser().userName() +</span>
                  &quot;@openjdk.java.net&quot;;
      }
  
      @Test
      void simpleArchive(TestInfo testInfo) throws IOException {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 108,74 ***</span>
              var author = credentials.getHostedRepository();
              var archive = credentials.getHostedRepository();
              var ignored = credentials.getHostedRepository();
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified">!                                            .addAuthor(author.host().getCurrentUserDetails().id());</span>
              var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
              var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,
<span class="line-modified">!                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),</span>
                                                   Set.of(),
                                                   listServer.getArchive(), listServer.getSMTP(),
                                                   archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
                                                   URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified">!                                                  Set.of(&quot;rfr&quot;), Map.of(ignored.host().getCurrentUserDetails().userName(),</span>
                                                                         Pattern.compile(&quot;ready&quot;)),
                                                   URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
                                                   Map.of(&quot;Extra1&quot;, &quot;val1&quot;, &quot;Extra2&quot;, &quot;val2&quot;),
                                                   Duration.ZERO);
  
              // Populate the projects repository
<span class="line-modified">!             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified">!             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);</span>
<span class="line-modified">!             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);</span>
  
              // Make a change with a corresponding PR
              var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
                                                                 &quot;Change msg\n\nWith several lines&quot;);
<span class="line-modified">!             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);</span>
              var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
              pr.setBody(&quot;This should not be ready&quot;);
  
              // Run an archive pass
              TestBotRunner.runPeriodicItems(mlBot);
  
              // A PR that isn&#39;t ready for review should not be archived
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);</span>
              assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
  
              // Flag it as ready for review
              pr.setBody(&quot;This should now be ready&quot;);
              pr.addLabel(&quot;rfr&quot;);
  
              // Run another archive pass
              TestBotRunner.runPeriodicItems(mlBot);
  
              // But it should still not be archived
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);</span>
              assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
  
              // Now post a general comment - not a ready marker
<span class="line-modified">!             var ignoredPr = ignored.getPullRequest(pr.getId());</span>
              ignoredPr.addComment(&quot;hello there&quot;);
  
              // Run another archive pass
              TestBotRunner.runPeriodicItems(mlBot);
  
              // It should still not be archived
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);</span>
              assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
  
              // Now post a ready comment
              ignoredPr.addComment(&quot;ready&quot;);
  
              // Run another archive pass
              TestBotRunner.runPeriodicItems(mlBot);
  
              // The archive should now contain an entry
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);</span>
              assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;Changes:&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
<span class="line-new-header">--- 108,74 ---</span>
              var author = credentials.getHostedRepository();
              var archive = credentials.getHostedRepository();
              var ignored = credentials.getHostedRepository();
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified">!                                            .addAuthor(author.host().currentUser().id());</span>
              var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
              var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,
<span class="line-modified">!                                                  Set.of(ignored.host().currentUser().userName()),</span>
                                                   Set.of(),
                                                   listServer.getArchive(), listServer.getSMTP(),
                                                   archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
                                                   URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-modified">!                                                  Set.of(&quot;rfr&quot;), Map.of(ignored.host().currentUser().userName(),</span>
                                                                         Pattern.compile(&quot;ready&quot;)),
                                                   URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
                                                   Map.of(&quot;Extra1&quot;, &quot;val1&quot;, &quot;Extra2&quot;, &quot;val2&quot;),
                                                   Duration.ZERO);
  
              // Populate the projects repository
<span class="line-modified">!             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified">!             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
<span class="line-modified">!             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);</span>
  
              // Make a change with a corresponding PR
              var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
                                                                 &quot;Change msg\n\nWith several lines&quot;);
<span class="line-modified">!             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);</span>
              var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;1234: This is a pull request&quot;);
              pr.setBody(&quot;This should not be ready&quot;);
  
              // Run an archive pass
              TestBotRunner.runPeriodicItems(mlBot);
  
              // A PR that isn&#39;t ready for review should not be archived
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
              assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
  
              // Flag it as ready for review
              pr.setBody(&quot;This should now be ready&quot;);
              pr.addLabel(&quot;rfr&quot;);
  
              // Run another archive pass
              TestBotRunner.runPeriodicItems(mlBot);
  
              // But it should still not be archived
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
              assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
  
              // Now post a general comment - not a ready marker
<span class="line-modified">!             var ignoredPr = ignored.pullRequest(pr.id());</span>
              ignoredPr.addComment(&quot;hello there&quot;);
  
              // Run another archive pass
              TestBotRunner.runPeriodicItems(mlBot);
  
              // It should still not be archived
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
              assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
  
              // Now post a ready comment
              ignoredPr.addComment(&quot;ready&quot;);
  
              // Run another archive pass
              TestBotRunner.runPeriodicItems(mlBot);
  
              // The archive should now contain an entry
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
              assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;Changes:&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
</pre>
<hr />
<pre>
<span class="line-old-header">*** 193,22 ***</span>
              var mailmanList = mailmanServer.getList(listAddress.address());
              var conversations = mailmanList.conversations(Duration.ofDays(1));
              assertEquals(1, conversations.size());
              var mail = conversations.get(0).first();
              assertEquals(&quot;RFR: 1234: This is a pull request&quot;, mail.subject());
<span class="line-modified">!             assertEquals(pr.getAuthor().fullName(), mail.author().fullName().orElseThrow());</span>
              assertEquals(noreplyAddress(archive), mail.author().address());
              assertEquals(from, mail.sender());
              assertEquals(&quot;val1&quot;, mail.headerValue(&quot;Extra1&quot;));
              assertEquals(&quot;val2&quot;, mail.headerValue(&quot;Extra2&quot;));
  
              // And there should be a webrev
<span class="line-modified">!             Repository.materialize(webrevFolder.path(), archive.getUrl(), &quot;webrev&quot;);</span>
              assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
<span class="line-modified">!             var comments = pr.getComments();</span>
              var webrevComments = comments.stream()
<span class="line-modified">!                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))</span>
                                           .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
                                           .filter(comment -&gt; comment.body().contains(editHash.hex()))
                                           .collect(Collectors.toList());
              assertEquals(1, webrevComments.size());
  
<span class="line-new-header">--- 193,22 ---</span>
              var mailmanList = mailmanServer.getList(listAddress.address());
              var conversations = mailmanList.conversations(Duration.ofDays(1));
              assertEquals(1, conversations.size());
              var mail = conversations.get(0).first();
              assertEquals(&quot;RFR: 1234: This is a pull request&quot;, mail.subject());
<span class="line-modified">!             assertEquals(pr.author().fullName(), mail.author().fullName().orElseThrow());</span>
              assertEquals(noreplyAddress(archive), mail.author().address());
              assertEquals(from, mail.sender());
              assertEquals(&quot;val1&quot;, mail.headerValue(&quot;Extra1&quot;));
              assertEquals(&quot;val2&quot;, mail.headerValue(&quot;Extra2&quot;));
  
              // And there should be a webrev
<span class="line-modified">!             Repository.materialize(webrevFolder.path(), archive.url(), &quot;webrev&quot;);</span>
              assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
<span class="line-modified">!             var comments = pr.comments();</span>
              var webrevComments = comments.stream()
<span class="line-modified">!                                          .filter(comment -&gt; comment.author().equals(author.host().currentUser()))</span>
                                           .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
                                           .filter(comment -&gt; comment.body().contains(editHash.hex()))
                                           .collect(Collectors.toList());
              assertEquals(1, webrevComments.size());
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 220,11 ***</span>
  
              // Run another archive pass
              TestBotRunner.runPeriodicItems(mlBot);
  
              // The archive should now contain the comment, but not the ignored one
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);</span>
              assertTrue(archiveContains(archiveFolder.path(), &quot;This is a comment&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This should now be ready&quot;));
              assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
  
              listServer.processIncoming();
<span class="line-new-header">--- 220,11 ---</span>
  
              // Run another archive pass
              TestBotRunner.runPeriodicItems(mlBot);
  
              // The archive should now contain the comment, but not the ignored one
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
              assertTrue(archiveContains(archiveFolder.path(), &quot;This is a comment&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This should now be ready&quot;));
              assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
  
              listServer.processIncoming();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 238,11 ***</span>
  
              // Run another archive pass
              TestBotRunner.runPeriodicItems(mlBot);
  
              // The archive should contain the additional comment
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);</span>
              assertTrue(archiveContains(archiveFolder.path(), &quot;This is another comment&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This should now be ready&quot;));
  
              listServer.processIncoming();
              conversations = mailmanList.conversations(Duration.ofDays(1));
<span class="line-new-header">--- 238,11 ---</span>
  
              // Run another archive pass
              TestBotRunner.runPeriodicItems(mlBot);
  
              // The archive should contain the additional comment
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
              assertTrue(archiveContains(archiveFolder.path(), &quot;This is another comment&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This should now be ready&quot;));
  
              listServer.processIncoming();
              conversations = mailmanList.conversations(Duration.ofDays(1));
</pre>
<hr />
<pre>
<span class="line-old-header">*** 265,51 ***</span>
              var author = credentials.getHostedRepository();
              var archive = credentials.getHostedRepository();
              var ignored = credentials.getHostedRepository();
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified">!                                            .addAuthor(author.host().getCurrentUserDetails().id());</span>
              var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
              var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,
<span class="line-modified">!                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),</span>
                                                   Set.of(),
                                                   listServer.getArchive(), listServer.getSMTP(),
                                                   archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
                                                   URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
                                                   Set.of(), Map.of(),
                                                   URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
                                                   Map.of(), Duration.ZERO);
  
              // Populate the projects repository
              var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified">!             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);</span>
<span class="line-modified">!             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);</span>
  
              // Make a change with a corresponding PR
              var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified">!             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);</span>
              var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
              pr.setBody(&quot;This is now ready&quot;);
              TestBotRunner.runPeriodicItems(mlBot);
              listServer.processIncoming();
  
              // And make a file specific comment
              var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
              var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
  
              // Add one from an ignored user as well
<span class="line-modified">!             var ignoredPr = ignored.getPullRequest(pr.getId());</span>
              ignoredPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Don&#39;t mind me&quot;);
  
              // Process comments
              TestBotRunner.runPeriodicItems(mlBot);
              listServer.processIncoming();
  
              // The archive should now contain an entry
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);</span>
              assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This is now ready&quot;));
              assertTrue(archiveContains(archiveFolder.path(), reviewFile.toString()));
<span class="line-new-header">--- 265,51 ---</span>
              var author = credentials.getHostedRepository();
              var archive = credentials.getHostedRepository();
              var ignored = credentials.getHostedRepository();
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified">!                                            .addAuthor(author.host().currentUser().id());</span>
              var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
              var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,
<span class="line-modified">!                                                  Set.of(ignored.host().currentUser().userName()),</span>
                                                   Set.of(),
                                                   listServer.getArchive(), listServer.getSMTP(),
                                                   archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
                                                   URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
                                                   Set.of(), Map.of(),
                                                   URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
                                                   Map.of(), Duration.ZERO);
  
              // Populate the projects repository
              var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified">!             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
<span class="line-modified">!             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);</span>
  
              // Make a change with a corresponding PR
              var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified">!             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);</span>
              var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
              pr.setBody(&quot;This is now ready&quot;);
              TestBotRunner.runPeriodicItems(mlBot);
              listServer.processIncoming();
  
              // And make a file specific comment
              var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
              var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
  
              // Add one from an ignored user as well
<span class="line-modified">!             var ignoredPr = ignored.pullRequest(pr.id());</span>
              ignoredPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Don&#39;t mind me&quot;);
  
              // Process comments
              TestBotRunner.runPeriodicItems(mlBot);
              listServer.processIncoming();
  
              // The archive should now contain an entry
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
              assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This is now ready&quot;));
              assertTrue(archiveContains(archiveFolder.path(), reviewFile.toString()));
</pre>
<hr />
<pre>
<span class="line-old-header">*** 327,11 ***</span>
              pr.addReviewCommentReply(comment, &quot;This is a review reply&quot;);
              TestBotRunner.runPeriodicItems(mlBot);
              listServer.processIncoming();
  
              // The archive should contain the additional comment (but no quoted footers)
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);</span>
              assertTrue(archiveContains(archiveFolder.path(), &quot;This is a review reply&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This is now ready&quot;));
              assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; PR:&quot;));
  
              // As well as the mailing list
<span class="line-new-header">--- 327,11 ---</span>
              pr.addReviewCommentReply(comment, &quot;This is a review reply&quot;);
              TestBotRunner.runPeriodicItems(mlBot);
              listServer.processIncoming();
  
              // The archive should contain the additional comment (but no quoted footers)
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
              assertTrue(archiveContains(archiveFolder.path(), &quot;This is a review reply&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This is now ready&quot;));
              assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; PR:&quot;));
  
              // As well as the mailing list
</pre>
<hr />
<pre>
<span class="line-old-header">*** 353,11 ***</span>
               var listServer = new TestMailmanServer()) {
              var author = credentials.getHostedRepository();
              var archive = credentials.getHostedRepository();
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified">!                                            .addAuthor(author.host().getCurrentUserDetails().id());</span>
              var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
              var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
                                                   listAddress, Set.of(), Set.of(),
                                                   listServer.getArchive(),
                                                   listServer.getSMTP(),
<span class="line-new-header">--- 353,11 ---</span>
               var listServer = new TestMailmanServer()) {
              var author = credentials.getHostedRepository();
              var archive = credentials.getHostedRepository();
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified">!                                            .addAuthor(author.host().currentUser().id());</span>
              var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
              var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
                                                   listAddress, Set.of(), Set.of(),
                                                   listServer.getArchive(),
                                                   listServer.getSMTP(),
</pre>
<hr />
<pre>
<span class="line-old-header">*** 367,18 ***</span>
                                                   URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
                                                   Map.of(), Duration.ZERO);
  
              // Populate the projects repository
              var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified">!             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);</span>
<span class="line-modified">!             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);</span>
  
              // Make a change with a corresponding PR
              var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified">!             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);</span>
              var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
              pr.setBody(&quot;This is now ready&quot;);
              pr.addComment(&quot;Avoid combining&quot;);
  
              TestBotRunner.runPeriodicItems(mlBot);
<span class="line-new-header">--- 367,18 ---</span>
                                                   URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
                                                   Map.of(), Duration.ZERO);
  
              // Populate the projects repository
              var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified">!             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
<span class="line-modified">!             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);</span>
  
              // Make a change with a corresponding PR
              var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified">!             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);</span>
              var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
              pr.setBody(&quot;This is now ready&quot;);
              pr.addComment(&quot;Avoid combining&quot;);
  
              TestBotRunner.runPeriodicItems(mlBot);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 392,11 ***</span>
              pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Final review comment&quot;);
              TestBotRunner.runPeriodicItems(mlBot);
              listServer.processIncoming();
  
              // The archive should contain a combined entry
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);</span>
              assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
  
              // As well as the mailing list
              var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
              var mailmanList = mailmanServer.getList(listAddress.address());
<span class="line-new-header">--- 392,11 ---</span>
              pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Final review comment&quot;);
              TestBotRunner.runPeriodicItems(mlBot);
              listServer.processIncoming();
  
              // The archive should contain a combined entry
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
              assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
  
              // As well as the mailing list
              var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
              var mailmanList = mailmanServer.getList(listAddress.address());
</pre>
<hr />
<pre>
<span class="line-old-header">*** 421,11 ***</span>
              pr.addReviewCommentReply(first, &quot;I agree&quot;);
              TestBotRunner.runPeriodicItems(mlBot);
              listServer.processIncoming();
  
              // The archive should contain a new entry
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);</span>
              assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
  
              // The combined review comments should only appear unquoted once
              assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^Another review comment&quot;));
          }
<span class="line-new-header">--- 421,11 ---</span>
              pr.addReviewCommentReply(first, &quot;I agree&quot;);
              TestBotRunner.runPeriodicItems(mlBot);
              listServer.processIncoming();
  
              // The archive should contain a new entry
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
              assertEquals(3, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
  
              // The combined review comments should only appear unquoted once
              assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^Another review comment&quot;));
          }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 440,12 ***</span>
              var author = credentials.getHostedRepository();
              var reviewer = credentials.getHostedRepository();
              var archive = credentials.getHostedRepository();
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified">!                                            .addReviewer(reviewer.host().getCurrentUserDetails().id())</span>
<span class="line-modified">!                                            .addAuthor(author.host().getCurrentUserDetails().id());</span>
              var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
              var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
                                                   listAddress, Set.of(), Set.of(),
                                                   listServer.getArchive(),
                                                   listServer.getSMTP(),
<span class="line-new-header">--- 440,12 ---</span>
              var author = credentials.getHostedRepository();
              var reviewer = credentials.getHostedRepository();
              var archive = credentials.getHostedRepository();
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified">!                                            .addReviewer(reviewer.host().currentUser().id())</span>
<span class="line-modified">!                                            .addAuthor(author.host().currentUser().id());</span>
              var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
              var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
                                                   listAddress, Set.of(), Set.of(),
                                                   listServer.getArchive(),
                                                   listServer.getSMTP(),
</pre>
<hr />
<pre>
<span class="line-old-header">*** 455,25 ***</span>
                                                   URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
                                                   Map.of(), Duration.ZERO);
  
              // Populate the projects repository
              var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified">!             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);</span>
<span class="line-modified">!             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);</span>
  
              // Make a change with a corresponding PR
              var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified">!             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);</span>
              var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
              pr.setBody(&quot;This is now ready&quot;);
              TestBotRunner.runPeriodicItems(mlBot);
              listServer.processIncoming();
  
              // Make a file specific comment
<span class="line-modified">!             var reviewPr = reviewer.getPullRequest(pr.getId());</span>
              var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
              pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
              reviewPr.addReviewCommentReply(comment1, &quot;Great&quot;);
              TestBotRunner.runPeriodicItems(mlBot);
              listServer.processIncoming();
<span class="line-new-header">--- 455,25 ---</span>
                                                   URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
                                                   Map.of(), Duration.ZERO);
  
              // Populate the projects repository
              var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified">!             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
<span class="line-modified">!             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);</span>
  
              // Make a change with a corresponding PR
              var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified">!             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);</span>
              var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
              pr.setBody(&quot;This is now ready&quot;);
              TestBotRunner.runPeriodicItems(mlBot);
              listServer.processIncoming();
  
              // Make a file specific comment
<span class="line-modified">!             var reviewPr = reviewer.pullRequest(pr.id());</span>
              var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
              pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
              reviewPr.addReviewCommentReply(comment1, &quot;Great&quot;);
              TestBotRunner.runPeriodicItems(mlBot);
              listServer.processIncoming();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 497,11 ***</span>
              listServer.processIncoming();
              listServer.processIncoming();
              listServer.processIncoming();
  
              // Sanity check the archive
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);</span>
              assertEquals(9, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
  
              // File specific comments should appear before the approval
              var archiveText = archiveContents(archiveFolder.path()).orElseThrow();
              assertTrue(archiveText.indexOf(&quot;Looks fine&quot;) &gt; archiveText.indexOf(&quot;You are welcome&quot;));
<span class="line-new-header">--- 497,11 ---</span>
              listServer.processIncoming();
              listServer.processIncoming();
              listServer.processIncoming();
  
              // Sanity check the archive
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
              assertEquals(9, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
  
              // File specific comments should appear before the approval
              var archiveText = archiveContents(archiveFolder.path()).orElseThrow();
              assertTrue(archiveText.indexOf(&quot;Looks fine&quot;) &gt; archiveText.indexOf(&quot;You are welcome&quot;));
</pre>
<hr />
<pre>
<span class="line-old-header">*** 523,11 ***</span>
              assertTrue(thread1.body().contains(&quot;Review comment\n\n&quot;), thread1.body());
              assertFalse(thread1.body().contains(&quot;Another review comment&quot;), thread1.body());
              var thread1reply1 = conversations.get(0).replies(thread1).get(0);
              assertTrue(thread1reply1.body().contains(&quot;I agree&quot;));
              assertEquals(noreplyAddress(archive), thread1reply1.author().address());
<span class="line-modified">!             assertEquals(archive.host().getCurrentUserDetails().fullName(), thread1reply1.author().fullName().orElseThrow());</span>
              var thread1reply2 = conversations.get(0).replies(thread1reply1).get(0);
              assertTrue(thread1reply2.body().contains(&quot;Great&quot;));
              assertEquals(&quot;integrationreviewer1@openjdk.java.net&quot;, thread1reply2.author().address());
              assertEquals(&quot;Generated Reviewer 1&quot;, thread1reply2.author().fullName().orElseThrow());
  
<span class="line-new-header">--- 523,11 ---</span>
              assertTrue(thread1.body().contains(&quot;Review comment\n\n&quot;), thread1.body());
              assertFalse(thread1.body().contains(&quot;Another review comment&quot;), thread1.body());
              var thread1reply1 = conversations.get(0).replies(thread1).get(0);
              assertTrue(thread1reply1.body().contains(&quot;I agree&quot;));
              assertEquals(noreplyAddress(archive), thread1reply1.author().address());
<span class="line-modified">!             assertEquals(archive.host().currentUser().fullName(), thread1reply1.author().fullName().orElseThrow());</span>
              var thread1reply2 = conversations.get(0).replies(thread1reply1).get(0);
              assertTrue(thread1reply2.body().contains(&quot;Great&quot;));
              assertEquals(&quot;integrationreviewer1@openjdk.java.net&quot;, thread1reply2.author().address());
              assertEquals(&quot;Generated Reviewer 1&quot;, thread1reply2.author().fullName().orElseThrow());
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 558,11 ***</span>
               var listServer = new TestMailmanServer()) {
              var author = credentials.getHostedRepository();
              var archive = credentials.getHostedRepository();
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified">!                                            .addAuthor(author.host().getCurrentUserDetails().id());</span>
              var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
              var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
                                                   listAddress, Set.of(), Set.of(),
                                                   listServer.getArchive(),
                                                   listServer.getSMTP(),
<span class="line-new-header">--- 558,11 ---</span>
               var listServer = new TestMailmanServer()) {
              var author = credentials.getHostedRepository();
              var archive = credentials.getHostedRepository();
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified">!                                            .addAuthor(author.host().currentUser().id());</span>
              var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
              var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
                                                   listAddress, Set.of(), Set.of(),
                                                   listServer.getArchive(),
                                                   listServer.getSMTP(),
</pre>
<hr />
<pre>
<span class="line-old-header">*** 572,18 ***</span>
                                                   URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
                                                   Map.of(), Duration.ZERO);
  
              // Populate the projects repository
              var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified">!             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);</span>
<span class="line-modified">!             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);</span>
  
              // Make a change with a corresponding PR
              var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
<span class="line-modified">!             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);</span>
              var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
              pr.setBody(&quot;This is now ready&quot;);
              TestBotRunner.runPeriodicItems(mlBot);
              listServer.processIncoming();
  
<span class="line-new-header">--- 572,18 ---</span>
                                                   URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
                                                   Map.of(), Duration.ZERO);
  
              // Populate the projects repository
              var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified">!             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
<span class="line-modified">!             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);</span>
  
              // Make a change with a corresponding PR
              var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
<span class="line-modified">!             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);</span>
              var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
              pr.setBody(&quot;This is now ready&quot;);
              TestBotRunner.runPeriodicItems(mlBot);
              listServer.processIncoming();
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 592,11 ***</span>
  
              TestBotRunner.runPeriodicItems(mlBot);
              listServer.processIncoming();
  
              // The archive should only contain context around line 2
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);</span>
              assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
              assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
          }
      }
<span class="line-new-header">--- 592,11 ---</span>
  
              TestBotRunner.runPeriodicItems(mlBot);
              listServer.processIncoming();
  
              // The archive should only contain context around line 2
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
              assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
              assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
          }
      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 609,11 ***</span>
               var listServer = new TestMailmanServer()) {
              var author = credentials.getHostedRepository();
              var archive = credentials.getHostedRepository();
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified">!                                            .addAuthor(author.host().getCurrentUserDetails().id());</span>
              var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
              var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
                                                   listAddress, Set.of(), Set.of(),
                                                   listServer.getArchive(),
                                                   listServer.getSMTP(),
<span class="line-new-header">--- 609,11 ---</span>
               var listServer = new TestMailmanServer()) {
              var author = credentials.getHostedRepository();
              var archive = credentials.getHostedRepository();
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified">!                                            .addAuthor(author.host().currentUser().id());</span>
              var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
              var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
                                                   listAddress, Set.of(), Set.of(),
                                                   listServer.getArchive(),
                                                   listServer.getSMTP(),
</pre>
<hr />
<pre>
<span class="line-old-header">*** 623,30 ***</span>
                                                   URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
                                                   Map.of(), Duration.ZERO);
  
              // Populate the projects repository
              var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified">!             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);</span>
<span class="line-modified">!             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);</span>
              var initialHash = CheckableRepository.appendAndCommit(localRepo,
                                                                    &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
                                                                            &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
                                                                            &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
                                                                            &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
                                                                            &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
                                                                            &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
<span class="line-modified">!             localRepo.push(initialHash, author.getUrl(), &quot;master&quot;);</span>
  
              // Make a change with a corresponding PR
              var current = Files.readString(localRepo.root().resolve(reviewFile), StandardCharsets.UTF_8);
              var updated = current.replaceAll(&quot;Line 2&quot;, &quot;Line 2 edit\nLine 2.5&quot;);
              updated = updated.replaceAll(&quot;Line 13&quot;, &quot;Line 12.5\nLine 13 edit&quot;);
              Files.writeString(localRepo.root().resolve(reviewFile), updated, StandardCharsets.UTF_8);
              var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified">!             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);</span>
              var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
              pr.setBody(&quot;This is now ready&quot;);
              TestBotRunner.runPeriodicItems(mlBot);
              listServer.processIncoming();
  
<span class="line-new-header">--- 623,30 ---</span>
                                                   URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
                                                   Map.of(), Duration.ZERO);
  
              // Populate the projects repository
              var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified">!             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
<span class="line-modified">!             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);</span>
              var initialHash = CheckableRepository.appendAndCommit(localRepo,
                                                                    &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
                                                                            &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
                                                                            &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
                                                                            &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
                                                                            &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
                                                                            &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
<span class="line-modified">!             localRepo.push(initialHash, author.url(), &quot;master&quot;);</span>
  
              // Make a change with a corresponding PR
              var current = Files.readString(localRepo.root().resolve(reviewFile), StandardCharsets.UTF_8);
              var updated = current.replaceAll(&quot;Line 2&quot;, &quot;Line 2 edit\nLine 2.5&quot;);
              updated = updated.replaceAll(&quot;Line 13&quot;, &quot;Line 12.5\nLine 13 edit&quot;);
              Files.writeString(localRepo.root().resolve(reviewFile), updated, StandardCharsets.UTF_8);
              var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified">!             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);</span>
              var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
              pr.setBody(&quot;This is now ready&quot;);
              TestBotRunner.runPeriodicItems(mlBot);
              listServer.processIncoming();
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 656,11 ***</span>
  
              TestBotRunner.runPeriodicItems(mlBot);
              listServer.processIncoming();
  
              // The archive should only contain context around line 2 and 20
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);</span>
              assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 7&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 6: Line 1$&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 7: Line 2 edit$&quot;));
              assertFalse(archiveContains(archiveFolder.path(), &quot;Line 3&quot;));
  
<span class="line-new-header">--- 656,11 ---</span>
  
              TestBotRunner.runPeriodicItems(mlBot);
              listServer.processIncoming();
  
              // The archive should only contain context around line 2 and 20
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
              assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 7&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 6: Line 1$&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 7: Line 2 edit$&quot;));
              assertFalse(archiveContains(archiveFolder.path(), &quot;Line 3&quot;));
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 679,11 ***</span>
               var listServer = new TestMailmanServer()) {
              var author = credentials.getHostedRepository();
              var archive = credentials.getHostedRepository();
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified">!                                            .addAuthor(author.host().getCurrentUserDetails().id());</span>
              var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
              var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
                                                   listAddress, Set.of(), Set.of(),
                                                   listServer.getArchive(), listServer.getSMTP(),
                                                   archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-new-header">--- 679,11 ---</span>
               var listServer = new TestMailmanServer()) {
              var author = credentials.getHostedRepository();
              var archive = credentials.getHostedRepository();
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified">!                                            .addAuthor(author.host().currentUser().id());</span>
              var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
              var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
                                                   listAddress, Set.of(), Set.of(),
                                                   listServer.getArchive(), listServer.getSMTP(),
                                                   archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
</pre>
<hr />
<pre>
<span class="line-old-header">*** 692,18 ***</span>
                                                   URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
                                                   Map.of(), Duration.ZERO);
  
              // Populate the projects repository
              var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified">!             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);</span>
<span class="line-modified">!             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);</span>
  
              // Make a change with a corresponding PR
              var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified">!             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);</span>
              var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
              pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
                                 &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
  
              // Make a bunch of comments
<span class="line-new-header">--- 692,18 ---</span>
                                                   URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
                                                   Map.of(), Duration.ZERO);
  
              // Populate the projects repository
              var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified">!             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
<span class="line-modified">!             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);</span>
  
              // Make a change with a corresponding PR
              var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified">!             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);</span>
              var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
              pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
                                 &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
  
              // Make a bunch of comments
</pre>
<hr />
<pre>
<span class="line-old-header">*** 714,11 ***</span>
  
              // Run an archive pass
              TestBotRunner.runPeriodicItems(mlBot);
  
              // The archive should not contain the comment
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);</span>
              assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
              assertFalse(archiveContains(archiveFolder.path(), &quot;this is a comment&quot;));
              assertFalse(archiveContains(archiveFolder.path(), &quot;Status stuff&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;And this is not&quot;));
              assertFalse(archiveContains(archiveFolder.path(), &quot;&lt;!--&quot;));
<span class="line-new-header">--- 714,11 ---</span>
  
              // Run an archive pass
              TestBotRunner.runPeriodicItems(mlBot);
  
              // The archive should not contain the comment
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
              assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
              assertFalse(archiveContains(archiveFolder.path(), &quot;this is a comment&quot;));
              assertFalse(archiveContains(archiveFolder.path(), &quot;Status stuff&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;And this is not&quot;));
              assertFalse(archiveContains(archiveFolder.path(), &quot;&lt;!--&quot;));
</pre>
<hr />
<pre>
<span class="line-old-header">*** 738,11 ***</span>
              var author = credentials.getHostedRepository();
              var archive = credentials.getHostedRepository();
              var commenter = credentials.getHostedRepository();
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified">!                                            .addAuthor(author.host().getCurrentUserDetails().id());</span>
              var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
              var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
                                                   listAddress, Set.of(), Set.of(),
                                                   listServer.getArchive(), listServer.getSMTP(),
                                                   archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-new-header">--- 738,11 ---</span>
              var author = credentials.getHostedRepository();
              var archive = credentials.getHostedRepository();
              var commenter = credentials.getHostedRepository();
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified">!                                            .addAuthor(author.host().currentUser().id());</span>
              var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
              var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
                                                   listAddress, Set.of(), Set.of(),
                                                   listServer.getArchive(), listServer.getSMTP(),
                                                   archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
</pre>
<hr />
<pre>
<span class="line-old-header">*** 751,57 ***</span>
                                                   URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
                                                   Map.of(), Duration.ZERO);
  
              // Populate the projects repository
              var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified">!             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);</span>
<span class="line-modified">!             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);</span>
  
              // Make a change with a corresponding PR
              var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified">!             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);</span>
              var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
              pr.setBody(&quot;This is now ready&quot;);
  
              // Run an archive pass
              TestBotRunner.runPeriodicItems(mlBot);
              listServer.processIncoming();
  
              var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
<span class="line-modified">!             localRepo.push(nextHash, author.getUrl(), &quot;edit&quot;);</span>
  
              // Make sure that the push registered
<span class="line-modified">!             var lastHeadHash = pr.getHeadHash();</span>
              var refreshCount = 0;
              do {
<span class="line-modified">!                 pr = author.getPullRequest(pr.getId());</span>
                  if (refreshCount++ &gt; 100) {
                      fail(&quot;The PR did not update after the new push&quot;);
                  }
<span class="line-modified">!             } while (pr.getHeadHash().equals(lastHeadHash));</span>
  
              // Run another archive pass
              TestBotRunner.runPeriodicItems(mlBot);
              TestBotRunner.runPeriodicItems(mlBot);
              TestBotRunner.runPeriodicItems(mlBot);
              listServer.processIncoming();
  
              // The archive should reference the updated push
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);</span>
              assertTrue(archiveContains(archiveFolder.path(), &quot;additional changes&quot;));
<span class="line-modified">!             assertTrue(archiveContains(archiveFolder.path(), &quot;full.*/&quot; + pr.getId() + &quot;/webrev.01&quot;));</span>
<span class="line-modified">!             assertTrue(archiveContains(archiveFolder.path(), &quot;inc.*/&quot; + pr.getId() + &quot;/webrev.00-01&quot;));</span>
              assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;Fixing&quot;));
  
              // The webrev comment should be updated
<span class="line-modified">!             var comments = pr.getComments();</span>
              var webrevComments = comments.stream()
<span class="line-modified">!                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))</span>
                                           .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
                                           .filter(comment -&gt; comment.body().contains(nextHash.hex()))
                                           .filter(comment -&gt; comment.body().contains(editHash.hex()))
                                           .collect(Collectors.toList());
              assertEquals(1, webrevComments.size());
<span class="line-new-header">--- 751,57 ---</span>
                                                   URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
                                                   Map.of(), Duration.ZERO);
  
              // Populate the projects repository
              var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified">!             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
<span class="line-modified">!             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);</span>
  
              // Make a change with a corresponding PR
              var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified">!             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);</span>
              var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
              pr.setBody(&quot;This is now ready&quot;);
  
              // Run an archive pass
              TestBotRunner.runPeriodicItems(mlBot);
              listServer.processIncoming();
  
              var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
<span class="line-modified">!             localRepo.push(nextHash, author.url(), &quot;edit&quot;);</span>
  
              // Make sure that the push registered
<span class="line-modified">!             var lastHeadHash = pr.headHash();</span>
              var refreshCount = 0;
              do {
<span class="line-modified">!                 pr = author.pullRequest(pr.id());</span>
                  if (refreshCount++ &gt; 100) {
                      fail(&quot;The PR did not update after the new push&quot;);
                  }
<span class="line-modified">!             } while (pr.headHash().equals(lastHeadHash));</span>
  
              // Run another archive pass
              TestBotRunner.runPeriodicItems(mlBot);
              TestBotRunner.runPeriodicItems(mlBot);
              TestBotRunner.runPeriodicItems(mlBot);
              listServer.processIncoming();
  
              // The archive should reference the updated push
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
              assertTrue(archiveContains(archiveFolder.path(), &quot;additional changes&quot;));
<span class="line-modified">!             assertTrue(archiveContains(archiveFolder.path(), &quot;full.*/&quot; + pr.id() + &quot;/webrev.01&quot;));</span>
<span class="line-modified">!             assertTrue(archiveContains(archiveFolder.path(), &quot;inc.*/&quot; + pr.id() + &quot;/webrev.00-01&quot;));</span>
              assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;Fixing&quot;));
  
              // The webrev comment should be updated
<span class="line-modified">!             var comments = pr.comments();</span>
              var webrevComments = comments.stream()
<span class="line-modified">!                                          .filter(comment -&gt; comment.author().equals(author.host().currentUser()))</span>
                                           .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
                                           .filter(comment -&gt; comment.body().contains(nextHash.hex()))
                                           .filter(comment -&gt; comment.body().contains(editHash.hex()))
                                           .collect(Collectors.toList());
              assertEquals(1, webrevComments.size());
</pre>
<hr />
<pre>
<span class="line-old-header">*** 815,29 ***</span>
                  assertEquals(noreplyAddress(archive), newMail.author().address());
                  assertEquals(from, newMail.sender());
              }
  
              // Add a comment
<span class="line-modified">!             var commenterPr = commenter.getPullRequest(pr.getId());</span>
              commenterPr.addReviewComment(masterHash, nextHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
              TestBotRunner.runPeriodicItems(mlBot);
              listServer.processIncoming();
  
              // Ensure that additional updates are only reported once
              for (int i = 0; i &lt; 3; ++i) {
                  var anotherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fixing&quot;);
<span class="line-modified">!                 localRepo.push(anotherHash, author.getUrl(), &quot;edit&quot;);</span>
  
                  // Make sure that the push registered
<span class="line-modified">!                 lastHeadHash = pr.getHeadHash();</span>
                  refreshCount = 0;
                  do {
<span class="line-modified">!                     pr = author.getPullRequest(pr.getId());</span>
                      if (refreshCount++ &gt; 100) {
                          fail(&quot;The PR did not update after the new push&quot;);
                      }
<span class="line-modified">!                 } while (pr.getHeadHash().equals(lastHeadHash));</span>
  
                  TestBotRunner.runPeriodicItems(mlBot);
                  TestBotRunner.runPeriodicItems(mlBot);
                  listServer.processIncoming();
              }
<span class="line-new-header">--- 815,29 ---</span>
                  assertEquals(noreplyAddress(archive), newMail.author().address());
                  assertEquals(from, newMail.sender());
              }
  
              // Add a comment
<span class="line-modified">!             var commenterPr = commenter.pullRequest(pr.id());</span>
              commenterPr.addReviewComment(masterHash, nextHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
              TestBotRunner.runPeriodicItems(mlBot);
              listServer.processIncoming();
  
              // Ensure that additional updates are only reported once
              for (int i = 0; i &lt; 3; ++i) {
                  var anotherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fixing&quot;);
<span class="line-modified">!                 localRepo.push(anotherHash, author.url(), &quot;edit&quot;);</span>
  
                  // Make sure that the push registered
<span class="line-modified">!                 lastHeadHash = pr.headHash();</span>
                  refreshCount = 0;
                  do {
<span class="line-modified">!                     pr = author.pullRequest(pr.id());</span>
                      if (refreshCount++ &gt; 100) {
                          fail(&quot;The PR did not update after the new push&quot;);
                      }
<span class="line-modified">!                 } while (pr.headHash().equals(lastHeadHash));</span>
  
                  TestBotRunner.runPeriodicItems(mlBot);
                  TestBotRunner.runPeriodicItems(mlBot);
                  listServer.processIncoming();
              }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 859,11 ***</span>
               var listServer = new TestMailmanServer()) {
              var author = credentials.getHostedRepository();
              var archive = credentials.getHostedRepository();
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified">!                                            .addAuthor(author.host().getCurrentUserDetails().id());</span>
              var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
              var mlBot = new MailingListBridgeBot(sender, author, archive, censusBuilder.build(), &quot;master&quot;,
                                                   listAddress, Set.of(), Set.of(),
                                                   listServer.getArchive(), listServer.getSMTP(),
                                                   archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
<span class="line-new-header">--- 859,11 ---</span>
               var listServer = new TestMailmanServer()) {
              var author = credentials.getHostedRepository();
              var archive = credentials.getHostedRepository();
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified">!                                            .addAuthor(author.host().currentUser().id());</span>
              var sender = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
              var mlBot = new MailingListBridgeBot(sender, author, archive, censusBuilder.build(), &quot;master&quot;,
                                                   listAddress, Set.of(), Set.of(),
                                                   listServer.getArchive(), listServer.getSMTP(),
                                                   archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
</pre>
<hr />
<pre>
<span class="line-old-header">*** 872,57 ***</span>
                                                   URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
                                                   Map.of(), Duration.ZERO);
  
              // Populate the projects repository
              var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.getRepositoryType(), reviewFile);</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified">!             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);</span>
<span class="line-modified">!             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);</span>
  
              // Make a change with a corresponding PR
              var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
<span class="line-modified">!             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);</span>
              var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
              pr.setBody(&quot;This is now ready&quot;);
  
              // Run an archive pass
              TestBotRunner.runPeriodicItems(mlBot);
              listServer.processIncoming();
  
<span class="line-modified">!             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.getUrl(), &quot;master&quot;);</span>
              var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
<span class="line-modified">!             newLocalRepo.push(newEditHash, author.getUrl(), &quot;edit&quot;, true);</span>
  
              // Make sure that the push registered
<span class="line-modified">!             var lastHeadHash = pr.getHeadHash();</span>
              var refreshCount = 0;
              do {
<span class="line-modified">!                 pr = author.getPullRequest(pr.getId());</span>
                  if (refreshCount++ &gt; 100) {
                      fail(&quot;The PR did not update after the new push&quot;);
                  }
<span class="line-modified">!             } while (pr.getHeadHash().equals(lastHeadHash));</span>
  
              // Run another archive pass
              TestBotRunner.runPeriodicItems(mlBot);
              listServer.processIncoming();
  
              // The archive should reference the rebased push
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);</span>
              assertTrue(archiveContains(archiveFolder.path(), &quot;complete new set of changes&quot;));
<span class="line-modified">!             assertTrue(archiveContains(archiveFolder.path(), pr.getId() + &quot;/webrev.01&quot;));</span>
              assertFalse(archiveContains(archiveFolder.path(), &quot;Incremental&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;Replaced msg&quot;));
  
              // The webrev comment should be updated
<span class="line-modified">!             var comments = pr.getComments();</span>
              var webrevComments = comments.stream()
<span class="line-modified">!                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))</span>
                                           .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
                                           .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
                                           .collect(Collectors.toList());
              assertEquals(1, webrevComments.size());
  
<span class="line-new-header">--- 872,57 ---</span>
                                                   URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
                                                   Map.of(), Duration.ZERO);
  
              // Populate the projects repository
              var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.repositoryType(), reviewFile);</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified">!             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
<span class="line-modified">!             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);</span>
  
              // Make a change with a corresponding PR
              var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
<span class="line-modified">!             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);</span>
              var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
              pr.setBody(&quot;This is now ready&quot;);
  
              // Run an archive pass
              TestBotRunner.runPeriodicItems(mlBot);
              listServer.processIncoming();
  
<span class="line-modified">!             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.url(), &quot;master&quot;);</span>
              var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
<span class="line-modified">!             newLocalRepo.push(newEditHash, author.url(), &quot;edit&quot;, true);</span>
  
              // Make sure that the push registered
<span class="line-modified">!             var lastHeadHash = pr.headHash();</span>
              var refreshCount = 0;
              do {
<span class="line-modified">!                 pr = author.pullRequest(pr.id());</span>
                  if (refreshCount++ &gt; 100) {
                      fail(&quot;The PR did not update after the new push&quot;);
                  }
<span class="line-modified">!             } while (pr.headHash().equals(lastHeadHash));</span>
  
              // Run another archive pass
              TestBotRunner.runPeriodicItems(mlBot);
              listServer.processIncoming();
  
              // The archive should reference the rebased push
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
              assertTrue(archiveContains(archiveFolder.path(), &quot;complete new set of changes&quot;));
<span class="line-modified">!             assertTrue(archiveContains(archiveFolder.path(), pr.id() + &quot;/webrev.01&quot;));</span>
              assertFalse(archiveContains(archiveFolder.path(), &quot;Incremental&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;Patch&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
              assertTrue(archiveContains(archiveFolder.path(), &quot;Replaced msg&quot;));
  
              // The webrev comment should be updated
<span class="line-modified">!             var comments = pr.comments();</span>
              var webrevComments = comments.stream()
<span class="line-modified">!                                          .filter(comment -&gt; comment.author().equals(author.host().currentUser()))</span>
                                           .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
                                           .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
                                           .collect(Collectors.toList());
              assertEquals(1, webrevComments.size());
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 950,65 ***</span>
              var author = credentials.getHostedRepository();
              var archive = credentials.getHostedRepository();
              var ignored = credentials.getHostedRepository();
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified">!                                            .addAuthor(author.host().getCurrentUserDetails().id());</span>
              var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
              var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
                                                   listAddress,
<span class="line-modified">!                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),</span>
                                                   Set.of(),
                                                   listServer.getArchive(), listServer.getSMTP(),
                                                   archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
                                                   URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
                                                   Set.of(), Map.of(),
                                                   URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
                                                   Map.of(), Duration.ZERO);
  
              // Populate the projects repository
<span class="line-modified">!             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified">!             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);</span>
<span class="line-modified">!             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);</span>
  
              // Make a change with a corresponding PR
              var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
                                                                 &quot;Change msg\n\nWith several lines&quot;);
<span class="line-modified">!             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);</span>
              var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
  
              // Flag it as ready for review
              pr.setBody(&quot;This should now be ready&quot;);
  
              // Run an archive pass
              TestBotRunner.runPeriodicItems(mlBot);
  
              // The archive should now contain an entry
<span class="line-modified">!             var archiveRepo = Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);</span>
              assertTrue(archiveContains(archiveFolder.path(), editHash.abbreviate()));
  
              // And there should be a webrev comment
<span class="line-modified">!             var comments = pr.getComments();</span>
              var webrevComments = comments.stream()
<span class="line-modified">!                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))</span>
                                           .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
                                           .filter(comment -&gt; comment.body().contains(editHash.hex()))
                                           .collect(Collectors.toList());
              assertEquals(1, webrevComments.size());
              assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
  
              // Pretend the archive didn&#39;t work out
<span class="line-modified">!             archiveRepo.push(masterHash, archive.getUrl(), &quot;master&quot;, true);</span>
  
              // Run another archive pass
              TestBotRunner.runPeriodicItems(mlBot);
  
              // The webrev comment should not contain duplicate entries
<span class="line-modified">!             comments = pr.getComments();</span>
              webrevComments = comments.stream()
<span class="line-modified">!                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))</span>
                                           .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
                                           .filter(comment -&gt; comment.body().contains(editHash.hex()))
                                           .collect(Collectors.toList());
              assertEquals(1, webrevComments.size());
              assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
<span class="line-new-header">--- 950,65 ---</span>
              var author = credentials.getHostedRepository();
              var archive = credentials.getHostedRepository();
              var ignored = credentials.getHostedRepository();
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified">!                                            .addAuthor(author.host().currentUser().id());</span>
              var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
              var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
                                                   listAddress,
<span class="line-modified">!                                                  Set.of(ignored.host().currentUser().userName()),</span>
                                                   Set.of(),
                                                   listServer.getArchive(), listServer.getSMTP(),
                                                   archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
                                                   URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
                                                   Set.of(), Map.of(),
                                                   URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
                                                   Map.of(), Duration.ZERO);
  
              // Populate the projects repository
<span class="line-modified">!             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified">!             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
<span class="line-modified">!             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);</span>
  
              // Make a change with a corresponding PR
              var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
                                                                 &quot;Change msg\n\nWith several lines&quot;);
<span class="line-modified">!             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);</span>
              var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
  
              // Flag it as ready for review
              pr.setBody(&quot;This should now be ready&quot;);
  
              // Run an archive pass
              TestBotRunner.runPeriodicItems(mlBot);
  
              // The archive should now contain an entry
<span class="line-modified">!             var archiveRepo = Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
              assertTrue(archiveContains(archiveFolder.path(), editHash.abbreviate()));
  
              // And there should be a webrev comment
<span class="line-modified">!             var comments = pr.comments();</span>
              var webrevComments = comments.stream()
<span class="line-modified">!                                          .filter(comment -&gt; comment.author().equals(author.host().currentUser()))</span>
                                           .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
                                           .filter(comment -&gt; comment.body().contains(editHash.hex()))
                                           .collect(Collectors.toList());
              assertEquals(1, webrevComments.size());
              assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
  
              // Pretend the archive didn&#39;t work out
<span class="line-modified">!             archiveRepo.push(masterHash, archive.url(), &quot;master&quot;, true);</span>
  
              // Run another archive pass
              TestBotRunner.runPeriodicItems(mlBot);
  
              // The webrev comment should not contain duplicate entries
<span class="line-modified">!             comments = pr.comments();</span>
              webrevComments = comments.stream()
<span class="line-modified">!                                          .filter(comment -&gt; comment.author().equals(author.host().currentUser()))</span>
                                           .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
                                           .filter(comment -&gt; comment.body().contains(editHash.hex()))
                                           .collect(Collectors.toList());
              assertEquals(1, webrevComments.size());
              assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1025,12 ***</span>
              var archive = credentials.getHostedRepository();
              var reviewer = credentials.getHostedRepository();
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
              var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified">!                                            .addReviewer(reviewer.host().getCurrentUserDetails().id())</span>
<span class="line-modified">!                                            .addAuthor(author.host().getCurrentUserDetails().id());</span>
              var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
                                                   listAddress, Set.of(), Set.of(),
                                                   listServer.getArchive(), listServer.getSMTP(),
                                                   archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
                                                   URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
<span class="line-new-header">--- 1025,12 ---</span>
              var archive = credentials.getHostedRepository();
              var reviewer = credentials.getHostedRepository();
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
              var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified">!                                            .addReviewer(reviewer.host().currentUser().id())</span>
<span class="line-modified">!                                            .addAuthor(author.host().currentUser().id());</span>
              var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
                                                   listAddress, Set.of(), Set.of(),
                                                   listServer.getArchive(), listServer.getSMTP(),
                                                   archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
                                                   URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1038,33 ***</span>
                                                   URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
                                                   Map.of(), Duration.ZERO);
  
              // Populate the projects repository
              var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified">!             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);</span>
<span class="line-modified">!             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);</span>
  
              // Make a change with a corresponding PR
              var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified">!             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);</span>
              var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
              pr.setBody(&quot;This is now ready&quot;);
  
              // Run an archive pass
              TestBotRunner.runPeriodicItems(mlBot);
  
              // First unapprove it
<span class="line-modified">!             var reviewedPr = reviewer.getPullRequest(pr.getId());</span>
              reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
              TestBotRunner.runPeriodicItems(mlBot);
              TestBotRunner.runPeriodicItems(mlBot);
              TestBotRunner.runPeriodicItems(mlBot);
  
              // The archive should contain a note
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);</span>
              assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Disapproved by &quot;));
              assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot; by integrationreviewer1&quot;));
              if (author.host().supportsReviewBody()) {
                  assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
              }
<span class="line-new-header">--- 1038,33 ---</span>
                                                   URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
                                                   Map.of(), Duration.ZERO);
  
              // Populate the projects repository
              var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified">!             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
<span class="line-modified">!             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);</span>
  
              // Make a change with a corresponding PR
              var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified">!             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);</span>
              var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
              pr.setBody(&quot;This is now ready&quot;);
  
              // Run an archive pass
              TestBotRunner.runPeriodicItems(mlBot);
  
              // First unapprove it
<span class="line-modified">!             var reviewedPr = reviewer.pullRequest(pr.id());</span>
              reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
              TestBotRunner.runPeriodicItems(mlBot);
              TestBotRunner.runPeriodicItems(mlBot);
              TestBotRunner.runPeriodicItems(mlBot);
  
              // The archive should contain a note
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
              assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Disapproved by &quot;));
              assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot; by integrationreviewer1&quot;));
              if (author.host().supportsReviewBody()) {
                  assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
              }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1074,11 ***</span>
              TestBotRunner.runPeriodicItems(mlBot);
              TestBotRunner.runPeriodicItems(mlBot);
              TestBotRunner.runPeriodicItems(mlBot);
  
              // The archive should contain another note
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);</span>
              assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Approved by &quot;));
              if (author.host().supportsReviewBody()) {
                  assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 2&quot;));
              }
              assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Re: \\[Approved\\] RFR:&quot;));
<span class="line-new-header">--- 1074,11 ---</span>
              TestBotRunner.runPeriodicItems(mlBot);
              TestBotRunner.runPeriodicItems(mlBot);
              TestBotRunner.runPeriodicItems(mlBot);
  
              // The archive should contain another note
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
              assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Approved by &quot;));
              if (author.host().supportsReviewBody()) {
                  assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 2&quot;));
              }
              assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Re: \\[Approved\\] RFR:&quot;));
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1088,11 ***</span>
              TestBotRunner.runPeriodicItems(mlBot);
              TestBotRunner.runPeriodicItems(mlBot);
              TestBotRunner.runPeriodicItems(mlBot);
  
              // The archive should contain another note
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);</span>
              assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Disapproved by &quot;));
              if (author.host().supportsReviewBody()) {
                  assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
              }
          }
<span class="line-new-header">--- 1088,11 ---</span>
              TestBotRunner.runPeriodicItems(mlBot);
              TestBotRunner.runPeriodicItems(mlBot);
              TestBotRunner.runPeriodicItems(mlBot);
  
              // The archive should contain another note
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
              assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Disapproved by &quot;));
              if (author.host().supportsReviewBody()) {
                  assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
              }
          }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1107,50 ***</span>
              var author = credentials.getHostedRepository();
              var ignored = credentials.getHostedRepository();
              var archive = credentials.getHostedRepository();
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified">!                                            .addAuthor(author.host().getCurrentUserDetails().id());</span>
              var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
              var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
                                                   listAddress,
<span class="line-modified">!                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),</span>
                                                   Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)),
                                                   listServer.getArchive(), listServer.getSMTP(),
                                                   archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
                                                   URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
                                                   Set.of(), Map.of(),
                                                   URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
                                                   Map.of(), Duration.ZERO);
  
              // Populate the projects repository
              var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified">!             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);</span>
<span class="line-modified">!             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);</span>
  
              // Make a change with a corresponding PR
              var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified">!             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);</span>
              var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
              pr.setBody(&quot;This is now ready&quot;);
  
              // Make a bunch of comments
              pr.addComment(&quot;Plain comment&quot;);
              pr.addComment(&quot;ignore this comment&quot;);
              pr.addComment(&quot;I think it is time to\nignore this comment!&quot;);
              pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review ignore this comment&quot;);
  
<span class="line-modified">!             var ignoredPR = ignored.getPullRequest(pr.getId());</span>
              ignoredPR.addComment(&quot;Don&#39;t mind me&quot;);
  
              TestBotRunner.runPeriodicItems(mlBot);
              TestBotRunner.runPeriodicItems(mlBot);
  
              // The archive should not contain the ignored comments
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);</span>
              assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
              assertFalse(archiveContains(archiveFolder.path(), &quot;ignore this comment&quot;));
              assertFalse(archiveContains(archiveFolder.path(), &quot;it is time to&quot;));
              assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
              assertFalse(archiveContains(archiveFolder.path(), &quot;Review ignore&quot;));
<span class="line-new-header">--- 1107,50 ---</span>
              var author = credentials.getHostedRepository();
              var ignored = credentials.getHostedRepository();
              var archive = credentials.getHostedRepository();
              var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
              var censusBuilder = credentials.getCensusBuilder()
<span class="line-modified">!                                            .addAuthor(author.host().currentUser().id());</span>
              var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
              var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
                                                   listAddress,
<span class="line-modified">!                                                  Set.of(ignored.host().currentUser().userName()),</span>
                                                   Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)),
                                                   listServer.getArchive(), listServer.getSMTP(),
                                                   archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
                                                   URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
                                                   Set.of(), Map.of(),
                                                   URIBuilder.base(&quot;http://issues.test/browse/&quot;).build(),
                                                   Map.of(), Duration.ZERO);
  
              // Populate the projects repository
              var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
<span class="line-modified">!             var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType(), reviewFile);</span>
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
<span class="line-modified">!             localRepo.push(masterHash, author.url(), &quot;master&quot;, true);</span>
<span class="line-modified">!             localRepo.push(masterHash, archive.url(), &quot;webrev&quot;, true);</span>
  
              // Make a change with a corresponding PR
              var editHash = CheckableRepository.appendAndCommit(localRepo);
<span class="line-modified">!             localRepo.push(editHash, author.url(), &quot;edit&quot;, true);</span>
              var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
              pr.setBody(&quot;This is now ready&quot;);
  
              // Make a bunch of comments
              pr.addComment(&quot;Plain comment&quot;);
              pr.addComment(&quot;ignore this comment&quot;);
              pr.addComment(&quot;I think it is time to\nignore this comment!&quot;);
              pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review ignore this comment&quot;);
  
<span class="line-modified">!             var ignoredPR = ignored.pullRequest(pr.id());</span>
              ignoredPR.addComment(&quot;Don&#39;t mind me&quot;);
  
              TestBotRunner.runPeriodicItems(mlBot);
              TestBotRunner.runPeriodicItems(mlBot);
  
              // The archive should not contain the ignored comments
<span class="line-modified">!             Repository.materialize(archiveFolder.path(), archive.url(), &quot;master&quot;);</span>
              assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
              assertFalse(archiveContains(archiveFolder.path(), &quot;ignore this comment&quot;));
              assertFalse(archiveContains(archiveFolder.path(), &quot;it is time to&quot;));
              assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
              assertFalse(archiveContains(archiveFolder.path(), &quot;Review ignore&quot;));
</pre>
<center><a href="MailingListArchiveReaderBotTests.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="WebrevStorageTests.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>