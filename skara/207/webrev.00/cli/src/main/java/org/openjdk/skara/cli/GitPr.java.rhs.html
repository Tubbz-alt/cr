<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames cli/src/main/java/org/openjdk/skara/cli/GitPr.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.cli;
 24 
 25 import org.openjdk.skara.args.*;
 26 import org.openjdk.skara.host.*;
 27 import org.openjdk.skara.vcs.*;
 28 import org.openjdk.skara.vcs.openjdk.*;
 29 import org.openjdk.skara.proxy.HttpProxy;
<a name="1" id="anc1"></a>
 30 
 31 import java.io.IOException;
 32 import java.net.URI;
 33 import java.nio.file.*;
 34 import java.util.*;
 35 import java.util.concurrent.TimeUnit;
 36 import java.util.function.Supplier;
 37 import java.util.logging.Level;
 38 import java.util.stream.Collectors;
 39 import java.nio.charset.StandardCharsets;
 40 
 41 public class GitPr {
 42     private static void exit(String fmt, Object...args) {
 43         System.err.println(String.format(fmt, args));
 44         System.exit(1);
 45     }
 46 
 47     private static &lt;T&gt; Supplier&lt;T&gt; die(String fmt, Object... args) {
 48         return () -&gt; {
 49             exit(fmt, args);
 50             return null;
 51         };
 52     }
 53 
 54     private static void await(Process p) throws IOException {
 55         try {
 56             var res = p.waitFor();
 57             if (res != 0) {
 58                 throw new IOException(&quot;Unexpected exit code &quot; + res);
 59             }
 60         } catch (InterruptedException e) {
 61             throw new IOException(e);
 62         }
 63     }
 64 
 65     private static boolean spawnEditor(ReadOnlyRepository repo, Path file) throws IOException {
 66         String editor = null;
 67         var lines = repo.config(&quot;core.editor&quot;);
 68         if (lines.size() == 1) {
 69             editor = lines.get(0);
 70         }
 71         if (editor == null) {
 72             editor = System.getenv(&quot;GIT_EDITOR&quot;);
 73         }
 74         if (editor == null) {
 75             editor = System.getenv(&quot;EDITOR&quot;);
 76         }
 77         if (editor == null) {
 78             editor = System.getenv(&quot;VISUAL&quot;);
 79         }
 80         if (editor == null) {
 81             editor = &quot;vi&quot;;
 82         }
 83 
 84         var pb = new ProcessBuilder(editor, file.toString());
 85         pb.inheritIO();
 86         var p = pb.start();
 87         try {
 88             return p.waitFor() == 0;
 89         } catch (InterruptedException e) {
 90             throw new IOException(e);
 91         }
 92     }
 93 
 94     private static String projectName(URI uri) {
 95         var name = uri.getPath().toString().substring(1);
 96         if (name.endsWith(&quot;.git&quot;)) {
 97             name = name.substring(0, name.length() - &quot;.git&quot;.length());
 98         }
 99         return name;
100     }
101 
102     private static HostedRepository getHostedRepositoryFor(URI uri, GitCredentials credentials) throws IOException {
<a name="2" id="anc2"></a><span class="line-modified">103         var host = RepositoryHost.from(uri, new PersonalAccessToken(credentials.username(), credentials.password()));</span>
104         if (System.getenv(&quot;GIT_TOKEN&quot;) == null) {
105             GitCredentials.approve(credentials);
106         }
<a name="3" id="anc3"></a><span class="line-modified">107         var remoteRepo = host.repository(projectName(uri));</span>
<span class="line-modified">108         var parentRepo = remoteRepo.parent();</span>
109         var targetRepo = parentRepo.isPresent() ? parentRepo.get() : remoteRepo;
110         return targetRepo;
111     }
112 
113     private static PullRequest getPullRequest(URI uri, GitCredentials credentials, Argument prId) throws IOException {
114         if (!prId.isPresent()) {
115             exit(&quot;error: missing pull request identifier&quot;);
116         }
117 
<a name="4" id="anc4"></a><span class="line-modified">118         var pr = getHostedRepositoryFor(uri, credentials).pullRequest(prId.asString());</span>
119         if (pr == null) {
120             exit(&quot;error: could not fetch PR information&quot;);
121         }
122 
123         return pr;
124     }
125 
126     private static void show(String ref, Hash hash) throws IOException {
127         show(ref, hash, null);
128     }
129     private static void show(String ref, Hash hash, Path dir) throws IOException {
130         var pb = new ProcessBuilder(&quot;git&quot;, &quot;diff&quot;, &quot;--binary&quot;,
131                                                    &quot;--patch&quot;,
132                                                    &quot;--find-renames=50%&quot;,
133                                                    &quot;--find-copies=50%&quot;,
134                                                    &quot;--find-copies-harder&quot;,
135                                                    &quot;--abbrev&quot;,
136                                                    ref + &quot;...&quot; + hash.hex());
137         if (dir != null) {
138             pb.directory(dir.toFile());
139         }
140         pb.inheritIO();
141         await(pb.start());
142     }
143 
144     private static void gimport() throws IOException {
145         var pb = new ProcessBuilder(&quot;hg&quot;, &quot;gimport&quot;);
146         pb.inheritIO();
147         await(pb.start());
148     }
149 
150     private static void hgImport(Path patch) throws IOException {
151         var pb = new ProcessBuilder(&quot;hg&quot;, &quot;import&quot;, &quot;--no-commit&quot;, patch.toAbsolutePath().toString());
152         pb.inheritIO();
153         await(pb.start());
154     }
155 
156     private static List&lt;String&gt; hgTags() throws IOException, InterruptedException {
157         var pb = new ProcessBuilder(&quot;hg&quot;, &quot;tags&quot;, &quot;--quiet&quot;);
158         pb.redirectOutput(ProcessBuilder.Redirect.PIPE);
159         pb.redirectError(ProcessBuilder.Redirect.INHERIT);
160         var p = pb.start();
161         var bytes = p.getInputStream().readAllBytes();
162         var exited = p.waitFor(1, TimeUnit.MINUTES);
163         var exitValue = p.exitValue();
164         if (!exited || exitValue != 0) {
165             throw new IOException(&quot;&#39;hg tags&#39; exited with value: &quot; + exitValue);
166         }
167 
168         return Arrays.asList(new String(bytes, StandardCharsets.UTF_8).split(&quot;\n&quot;));
169     }
170 
171     private static String hgResolve(String ref) throws IOException, InterruptedException {
172         var pb = new ProcessBuilder(&quot;hg&quot;, &quot;log&quot;, &quot;-r&quot;, ref, &quot;--template&quot;, &quot;{node}&quot;);
173         pb.redirectOutput(ProcessBuilder.Redirect.PIPE);
174         pb.redirectError(ProcessBuilder.Redirect.INHERIT);
175         var p = pb.start();
176         var bytes = p.getInputStream().readAllBytes();
177         var exited = p.waitFor(1, TimeUnit.MINUTES);
178         var exitValue = p.exitValue();
179         if (!exited || exitValue != 0) {
180             throw new IOException(&quot;&#39;hg log&#39; exited with value: &quot; + exitValue);
181         }
182 
183         return new String(bytes, StandardCharsets.UTF_8);
184     }
185 
186     private static Path diff(String ref, Hash hash) throws IOException {
187         return diff(ref, hash, null);
188     }
189 
190     private static Path diff(String ref, Hash hash, Path dir) throws IOException {
191         var patch = Files.createTempFile(hash.hex(), &quot;.patch&quot;);
192         var pb = new ProcessBuilder(&quot;git&quot;, &quot;diff&quot;, &quot;--binary&quot;,
193                                                    &quot;--patch&quot;,
194                                                    &quot;--find-renames=50%&quot;,
195                                                    &quot;--find-copies=50%&quot;,
196                                                    &quot;--find-copies-harder&quot;,
197                                                    &quot;--abbrev&quot;,
198                                                    ref + &quot;...&quot; + hash.hex());
199         if (dir != null) {
200             pb.directory(dir.toFile());
201         }
202         pb.redirectOutput(patch.toFile());
203         pb.redirectError(ProcessBuilder.Redirect.INHERIT);
204         await(pb.start());
205         return patch;
206     }
207 
208     private static void apply(Path patch) throws IOException {
209         var pb = new ProcessBuilder(&quot;git&quot;, &quot;apply&quot;, &quot;--no-commit&quot;, patch.toString());
210         pb.inheritIO();
211         await(pb.start());
212     }
213 
214     private static int longest(List&lt;String&gt; strings) {
215         return strings.stream().mapToInt(String::length).max().orElse(0);
216     }
217 
218     public static void main(String[] args) throws IOException, InterruptedException {
219         var flags = List.of(
220             Option.shortcut(&quot;u&quot;)
221                   .fullname(&quot;username&quot;)
222                   .describe(&quot;NAME&quot;)
223                   .helptext(&quot;Username on host&quot;)
224                   .optional(),
225             Option.shortcut(&quot;r&quot;)
226                   .fullname(&quot;remote&quot;)
227                   .describe(&quot;NAME&quot;)
228                   .helptext(&quot;Name of remote, defaults to &#39;origin&#39;&quot;)
229                   .optional(),
230             Option.shortcut(&quot;b&quot;)
231                   .fullname(&quot;branch&quot;)
232                   .describe(&quot;NAME&quot;)
233                   .helptext(&quot;Name of target branch, defaults to &#39;master&#39;&quot;)
234                   .optional(),
235             Option.shortcut(&quot;&quot;)
236                   .fullname(&quot;authors&quot;)
237                   .describe(&quot;LIST&quot;)
238                   .helptext(&quot;Comma separated list of authors&quot;)
239                   .optional(),
240             Option.shortcut(&quot;&quot;)
241                   .fullname(&quot;assignees&quot;)
242                   .describe(&quot;LIST&quot;)
243                   .helptext(&quot;Comma separated list of assignees&quot;)
244                   .optional(),
245             Option.shortcut(&quot;&quot;)
246                   .fullname(&quot;labels&quot;)
247                   .describe(&quot;LIST&quot;)
248                   .helptext(&quot;Comma separated list of labels&quot;)
249                   .optional(),
250             Option.shortcut(&quot;&quot;)
251                   .fullname(&quot;columns&quot;)
252                   .describe(&quot;id,title,author,assignees,labels&quot;)
253                   .helptext(&quot;Comma separated list of columns to show&quot;)
254                   .optional(),
255             Switch.shortcut(&quot;&quot;)
256                   .fullname(&quot;no-decoration&quot;)
257                   .helptext(&quot;Hide any decorations when listing PRs&quot;)
258                   .optional(),
259             Switch.shortcut(&quot;&quot;)
260                   .fullname(&quot;mercurial&quot;)
261                   .helptext(&quot;Force use of Mercurial (hg)&quot;)
262                   .optional(),
263             Switch.shortcut(&quot;&quot;)
264                   .fullname(&quot;verbose&quot;)
265                   .helptext(&quot;Turn on verbose output&quot;)
266                   .optional(),
267             Switch.shortcut(&quot;&quot;)
268                   .fullname(&quot;debug&quot;)
269                   .helptext(&quot;Turn on debugging output&quot;)
270                   .optional(),
271             Switch.shortcut(&quot;&quot;)
272                   .fullname(&quot;version&quot;)
273                   .helptext(&quot;Print the version of this tool&quot;)
274                   .optional());
275 
276         var inputs = List.of(
277             Input.position(0)
278                  .describe(&quot;list|fetch|show|checkout|apply|integrate|approve|create|close|update&quot;)
279                  .singular()
280                  .required(),
281             Input.position(1)
282                  .describe(&quot;ID&quot;)
283                  .singular()
284                  .optional()
285         );
286 
287         var parser = new ArgumentParser(&quot;git-pr&quot;, flags, inputs);
288         var arguments = parser.parse(args);
289 
290         if (arguments.contains(&quot;version&quot;)) {
291             System.out.println(&quot;git-pr version: &quot; + Version.fromManifest().orElse(&quot;unknown&quot;));
292             System.exit(0);
293         }
294 
295         if (arguments.contains(&quot;verbose&quot;) || arguments.contains(&quot;debug&quot;)) {
296             var level = arguments.contains(&quot;debug&quot;) ? Level.FINER : Level.FINE;
297             Logging.setup(level);
298         }
299 
300         HttpProxy.setup();
301 
302         var isMercurial = arguments.contains(&quot;mercurial&quot;);
303         var cwd = Path.of(&quot;&quot;).toAbsolutePath();
304         var repo = Repository.get(cwd).orElseThrow(() -&gt; new IOException(&quot;no git repository found at &quot; + cwd.toString()));
305         var remote = arguments.get(&quot;remote&quot;).orString(isMercurial ? &quot;default&quot; : &quot;origin&quot;);
306         var remotePullPath = repo.pullPath(remote);
307         var username = arguments.contains(&quot;username&quot;) ? arguments.get(&quot;username&quot;).asString() : null;
308         var token = isMercurial ? System.getenv(&quot;HG_TOKEN&quot;) :  System.getenv(&quot;GIT_TOKEN&quot;);
309         var uri = Remote.toWebURI(remotePullPath);
310         var credentials = GitCredentials.fill(uri.getHost(), uri.getPath(), username, token, uri.getScheme());
<a name="5" id="anc5"></a><span class="line-modified">311         var host = RepositoryHost.from(uri, new PersonalAccessToken(credentials.username(), credentials.password()));</span>
312 
313         var action = arguments.at(0).asString();
314         if (action.equals(&quot;create&quot;)) {
315             if (isMercurial) {
316                 var currentBookmark = repo.currentBookmark();
317                 if (!currentBookmark.isPresent()) {
318                     System.err.println(&quot;error: no bookmark is active, you must be on an active bookmark&quot;);
319                     System.err.println(&quot;&quot;);
320                     System.err.println(&quot;To create a bookmark and activate it, run:&quot;);
321                     System.err.println(&quot;&quot;);
322                     System.err.println(&quot;    hg bookmark NAME-FOR-YOUR-BOOKMARK&quot;);
323                     System.err.println(&quot;&quot;);
324                     System.exit(1);
325                 }
326 
327                 var bookmark = currentBookmark.get();
328                 if (bookmark.equals(new Bookmark(&quot;master&quot;))) {
329                     System.err.println(&quot;error: you should not create pull requests from the &#39;master&#39; bookmark&quot;);
330                     System.err.println(&quot;To create a bookmark and activate it, run:&quot;);
331                     System.err.println(&quot;&quot;);
332                     System.err.println(&quot;    hg bookmark NAME-FOR-YOUR-BOOKMARK&quot;);
333                     System.err.println(&quot;&quot;);
334                     System.exit(1);
335                 }
336 
337                 var tags = hgTags();
338                 var upstreams = tags.stream()
339                                     .filter(t -&gt; t.endsWith(bookmark.name()))
340                                     .collect(Collectors.toList());
341                 if (upstreams.isEmpty()) {
342                     System.err.println(&quot;error: there is no remote branch for the local bookmark &#39;&quot; + bookmark.name() + &quot;&#39;&quot;);
343                     System.err.println(&quot;&quot;);
344                     System.err.println(&quot;To create a remote branch and push the commits for your local branch, run:&quot;);
345                     System.err.println(&quot;&quot;);
346                     System.err.println(&quot;    hg push --bookmark &quot; + bookmark.name());
347                     System.err.println(&quot;&quot;);
348                     System.exit(1);
349                 }
350 
351                 var tagsAndHashes = new HashMap&lt;String, String&gt;();
352                 for (var tag : tags) {
353                     tagsAndHashes.put(tag, hgResolve(tag));
354                 }
355                 var bookmarkHash = hgResolve(bookmark.name());
356                 if (!tagsAndHashes.containsValue(bookmarkHash)) {
357                     System.err.println(&quot;error: there are local commits on bookmark &#39;&quot; + bookmark.name() + &quot;&#39; not present in a remote repository&quot;);
358                     System.err.println(&quot;&quot;);
359 
360                     if (upstreams.size() == 1) {
361                         System.err.println(&quot;To push the local commits to the remote repository, run:&quot;);
362                         System.err.println(&quot;&quot;);
363                         System.err.println(&quot;    hg push --bookmark &quot; + bookmark.name() + &quot; &quot; + upstreams.get(0));
364                         System.err.println(&quot;&quot;);
365                     } else {
366                         System.err.println(&quot;The following paths contains the &quot; + bookmark.name() + &quot; bookmark:&quot;);
367                         System.err.println(&quot;&quot;);
368                         for (var upstream : upstreams) {
369                             System.err.println(&quot;- &quot; + upstream.replace(&quot;/&quot; + bookmark.name(), &quot;&quot;));
370                         }
371                         System.err.println(&quot;&quot;);
372                         System.err.println(&quot;To push the local commits to a remote repository, run:&quot;);
373                         System.err.println(&quot;&quot;);
374                         System.err.println(&quot;    hg push --bookmark &quot; + bookmark.name() + &quot; &lt;PATH&gt;&quot;);
375                         System.err.println(&quot;&quot;);
376                     }
377                     System.exit(1);
378                 }
379 
380                 var targetBranch = arguments.get(&quot;branch&quot;).orString(&quot;master&quot;);
381                 var targetHash = hgResolve(targetBranch);
382                 var commits = repo.commits(targetHash + &quot;..&quot; + bookmarkHash + &quot;-&quot; + targetHash).asList();
383                 if (commits.isEmpty()) {
384                     System.err.println(&quot;error: no difference between bookmarks &quot; + targetBranch + &quot; and &quot; + bookmark.name());
385                     System.err.println(&quot;       Cannot create an empty pull request, have you committed?&quot;);
386                     System.exit(1);
387                 }
388 
389                 var diff = repo.diff(repo.head());
390                 if (!diff.patches().isEmpty()) {
391                     System.err.println(&quot;error: there are uncommitted changes in your working tree:&quot;);
392                     System.err.println(&quot;&quot;);
393                     for (var patch : diff.patches()) {
394                         var path = patch.target().path().isPresent() ?
395                             patch.target().path().get() : patch.source().path().get();
396                         System.err.println(&quot;    &quot; + patch.status().toString() + &quot; &quot; + path.toString());
397                     }
398                     System.err.println(&quot;&quot;);
399                     System.err.println(&quot;If these changes are meant to be part of the pull request, run:&quot;);
400                     System.err.println(&quot;&quot;);
401                     System.err.println(&quot;    hg commit --amend&quot;);
402                     System.err.println(&quot;    hg git-cleanup&quot;);
403                     System.err.println(&quot;    hg push --bookmark &quot; + bookmark.name() + &quot; &lt;PATH&gt;&quot;);
404                     System.err.println(&quot;    hg gimport&quot;);
405                     System.err.println(&quot;&quot;);
406                     System.err.println(&quot;If these changes are *not* meant to be part of the pull request, run:&quot;);
407                     System.err.println(&quot;&quot;);
408                     System.err.println(&quot;    hg shelve&quot;);
409                     System.err.println(&quot;&quot;);
410                     System.err.println(&quot;(You can later restore the changes by running: hg unshelve)&quot;);
411                     System.exit(1);
412                 }
413 
<a name="6" id="anc6"></a><span class="line-modified">414                 var remoteRepo = host.repository(projectName(uri));</span>
415                 if (token == null) {
416                     GitCredentials.approve(credentials);
417                 }
<a name="7" id="anc7"></a><span class="line-modified">418                 var parentRepo = remoteRepo.parent().orElseThrow(() -&gt;</span>
419                         new IOException(&quot;error: remote repository &quot; + remotePullPath + &quot; is not a fork of any repository&quot;));
420 
421                 var file = Files.createTempFile(&quot;PULL_REQUEST_&quot;, &quot;.txt&quot;);
422                 if (commits.size() == 1) {
423                     var commit = commits.get(0);
424                     var message = CommitMessageParsers.v1.parse(commit.message());
425                     Files.writeString(file, message.title() + &quot;\n&quot;);
426                     if (!message.summaries().isEmpty()) {
427                         Files.write(file, message.summaries(), StandardOpenOption.APPEND);
428                     }
429                     if (!message.additional().isEmpty()) {
430                         Files.write(file, message.additional(), StandardOpenOption.APPEND);
431                     }
432                 } else {
433                     Files.write(file, List.of(&quot;&quot;));
434                 }
435                 Files.write(file, List.of(
436                     &quot;# Please enter the pull request message for your changes. Lines starting&quot;,
437                     &quot;# with &#39;#&#39; will be ignored, and an empty message aborts the pull request.&quot;,
438                     &quot;# The first line will be considered the subject, use a blank line to separate&quot;,
439                     &quot;# the subject from the body.&quot;,
440                     &quot;#&quot;,
441                     &quot;# Commits to be included from branch &#39;&quot; + bookmark.name() + &quot;&#39;&quot;
442                     ),
443                     StandardOpenOption.APPEND
444                 );
445                 for (var commit : commits) {
446                     var desc = commit.hash().abbreviate() + &quot;: &quot; + commit.message().get(0);
447                     Files.writeString(file, &quot;# - &quot; + desc + &quot;\n&quot;, StandardOpenOption.APPEND);
448                 }
449                 Files.writeString(file, &quot;#\n&quot;, StandardOpenOption.APPEND);
450                 Files.writeString(file, &quot;# Target repository: &quot; + remotePullPath + &quot;\n&quot;, StandardOpenOption.APPEND);
451                 Files.writeString(file, &quot;# Target branch: &quot; + targetBranch + &quot;\n&quot;, StandardOpenOption.APPEND);
452                 var success = spawnEditor(repo, file);
453                 if (!success) {
454                     System.err.println(&quot;error: editor exited with non-zero status code, aborting&quot;);
455                     System.exit(1);
456                 }
457                 var lines = Files.readAllLines(file)
458                                  .stream()
459                                  .filter(l -&gt; !l.startsWith(&quot;#&quot;))
460                                  .collect(Collectors.toList());
461                 var isEmpty = lines.stream().allMatch(String::isEmpty);
462                 if (isEmpty) {
463                     System.err.println(&quot;error: no message present, aborting&quot;);
464                     System.exit(1);
465                 }
466 
467                 var title = lines.get(0);
468                 List&lt;String&gt; body = null;
469                 if (lines.size() &gt; 1) {
470                     body = lines.subList(1, lines.size())
471                                 .stream()
472                                 .dropWhile(String::isEmpty)
473                                 .collect(Collectors.toList());
474                 } else {
475                     body = Collections.emptyList();
476                 }
477 
478                 var pr = remoteRepo.createPullRequest(parentRepo, targetBranch, bookmark.name(), title, body);
479                 if (arguments.contains(&quot;assignees&quot;)) {
480                     var usernames = Arrays.asList(arguments.get(&quot;assignees&quot;).asString().split(&quot;,&quot;));
481                     var assignees = usernames.stream()
<a name="8" id="anc8"></a><span class="line-modified">482                                              .map(host::user)</span>
483                                              .collect(Collectors.toList());
484                     pr.setAssignees(assignees);
485                 }
<a name="9" id="anc9"></a><span class="line-modified">486                 System.out.println(pr.webUrl().toString());</span>
487                 Files.deleteIfExists(file);
488 
489                 System.exit(0);
490             }
491             var currentBranch = repo.currentBranch();
492             if (currentBranch.equals(repo.defaultBranch())) {
493                 System.err.println(&quot;error: you should not create pull requests from the &#39;master&#39; branch&quot;);
494                 System.err.println(&quot;&quot;);
495                 System.err.println(&quot;To create a local branch for your changes and restore the &#39;master&#39; branch, run:&quot;);
496                 System.err.println(&quot;&quot;);
497                 System.err.println(&quot;    git checkout -b NAME-FOR-YOUR-LOCAL-BRANCH&quot;);
498                 System.err.println(&quot;    git branch --force master origin/master&quot;);
499                 System.err.println(&quot;&quot;);
500                 System.exit(1);
501             }
502 
503             var upstream = repo.upstreamFor(currentBranch);
504             if (upstream.isEmpty()) {
505                 System.err.println(&quot;error: there is no remote branch for the local branch &#39;&quot; + currentBranch.name() + &quot;&#39;&quot;);
506                 System.err.println(&quot;&quot;);
507                 System.err.println(&quot;A remote branch must be present at &quot; + remotePullPath + &quot; to create a pull request&quot;);
508                 System.err.println(&quot;To create a remote branch and push the commits for your local branch, run:&quot;);
509                 System.err.println(&quot;&quot;);
510                 System.err.println(&quot;    git push --set-upstream &quot; + remote + &quot; &quot; + currentBranch.name());
511                 System.err.println(&quot;&quot;);
512                 System.err.println(&quot;If you created the remote branch from another client, you must update this repository.&quot;);
513                 System.err.println(&quot;To update remote information for this repository, run:&quot;);
514                 System.err.println(&quot;&quot;);
515                 System.err.println(&quot;    git fetch &quot; + remote);
516                 System.err.println(&quot;    git branch --set-upstream &quot; + currentBranch + &quot; &quot; + remote + &quot;/&quot; + currentBranch);
517                 System.err.println(&quot;&quot;);
518                 System.exit(1);
519             }
520 
521             var upstreamRefName = upstream.get().substring(remote.length() + 1);
522             repo.fetch(uri, upstreamRefName);
523             var branchCommits = repo.commits(upstream.get() + &quot;..&quot; + currentBranch.name()).asList();
524             if (!branchCommits.isEmpty()) {
525                 System.err.println(&quot;error: there are local commits on branch &#39;&quot; + currentBranch.name() + &quot;&#39; not present in the remote repository &quot; + remotePullPath);
526                 System.err.println(&quot;&quot;);
527                 System.err.println(&quot;All commits must be present in the remote repository to be part of the pull request&quot;);
528                 System.err.println(&quot;The following commits are not present in the remote repository:&quot;);
529                 System.err.println(&quot;&quot;);
530                 for (var commit : branchCommits) {
531                     System.err.println(&quot;- &quot; + commit.hash().abbreviate() + &quot;: &quot; + commit.message().get(0));
532                 }
533                 System.err.println(&quot;&quot;);
534                 System.err.println(&quot;To push the above local commits to the remote repository, run:&quot;);
535                 System.err.println(&quot;&quot;);
536                 System.err.println(&quot;    git push &quot; + remote + &quot; &quot; + currentBranch.name());
537                 System.err.println(&quot;&quot;);
538                 System.exit(1);
539             }
540 
541             var targetBranch = arguments.get(&quot;branch&quot;).orString(&quot;master&quot;);
542             var commits = repo.commits(targetBranch + &quot;..&quot; + currentBranch.name()).asList();
543             if (commits.isEmpty()) {
544                 System.err.println(&quot;error: no difference between branches &quot; + targetBranch + &quot; and &quot; + currentBranch.name());
545                 System.err.println(&quot;       Cannot create an empty pull request, have you committed?&quot;);
546                 System.exit(1);
547             }
548 
549             var diff = repo.diff(repo.head());
550             if (!diff.patches().isEmpty()) {
551                 System.err.println(&quot;error: there are uncommitted changes in your working tree:&quot;);
552                 System.err.println(&quot;&quot;);
553                 for (var patch : diff.patches()) {
554                     var path = patch.target().path().isPresent() ?
555                         patch.target().path().get() : patch.source().path().get();
556                     System.err.println(&quot;    &quot; + patch.status().toString() + &quot; &quot; + path.toString());
557                 }
558                 System.err.println(&quot;&quot;);
559                 System.err.println(&quot;If these changes are meant to be part of the pull request, run:&quot;);
560                 System.err.println(&quot;&quot;);
561                 System.err.println(&quot;    git commit -am &#39;Forgot to add some changes&#39;&quot;);
562                 System.err.println(&quot;&quot;);
563                 System.err.println(&quot;If these changes are *not* meant to be part of the pull request, run:&quot;);
564                 System.err.println(&quot;&quot;);
565                 System.err.println(&quot;    git stash&quot;);
566                 System.err.println(&quot;&quot;);
567                 System.err.println(&quot;(You can later restore the changes by running: git stash pop)&quot;);
568                 System.exit(1);
569             }
570 
<a name="10" id="anc10"></a><span class="line-modified">571             var remoteRepo = host.repository(projectName(uri));</span>
572             if (token == null) {
573                 GitCredentials.approve(credentials);
574             }
<a name="11" id="anc11"></a><span class="line-modified">575             var parentRepo = remoteRepo.parent().orElseThrow(() -&gt;</span>
576                     new IOException(&quot;error: remote repository &quot; + remotePullPath + &quot; is not a fork of any repository&quot;));
577 
578             var file = Files.createTempFile(&quot;PULL_REQUEST_&quot;, &quot;.txt&quot;);
579             if (commits.size() == 1) {
580                 var commit = commits.get(0);
581                 var message = CommitMessageParsers.v1.parse(commit.message());
582                 Files.writeString(file, message.title() + &quot;\n&quot;);
583                 if (!message.summaries().isEmpty()) {
584                     Files.write(file, message.summaries(), StandardOpenOption.APPEND);
585                 }
586                 if (!message.additional().isEmpty()) {
587                     Files.write(file, message.additional(), StandardOpenOption.APPEND);
588                 }
589             } else {
590                 Files.write(file, List.of(&quot;&quot;));
591             }
592             Files.write(file, List.of(
593                 &quot;# Please enter the pull request message for your changes. Lines starting&quot;,
594                 &quot;# with &#39;#&#39; will be ignored, and an empty message aborts the pull request.&quot;,
595                 &quot;# The first line will be considered the subject, use a blank line to separate&quot;,
596                 &quot;# the subject from the body.&quot;,
597                 &quot;#&quot;,
598                 &quot;# Commits to be included from branch &#39;&quot; + currentBranch.name() + &quot;&#39;&quot;
599                 ),
600                 StandardOpenOption.APPEND
601             );
602             for (var commit : commits) {
603                 var desc = commit.hash().abbreviate() + &quot;: &quot; + commit.message().get(0);
604                 Files.writeString(file, &quot;# - &quot; + desc + &quot;\n&quot;, StandardOpenOption.APPEND);
605             }
606             Files.writeString(file, &quot;#\n&quot;, StandardOpenOption.APPEND);
607             Files.writeString(file, &quot;# Target repository: &quot; + remotePullPath + &quot;\n&quot;, StandardOpenOption.APPEND);
608             Files.writeString(file, &quot;# Target branch: &quot; + targetBranch + &quot;\n&quot;, StandardOpenOption.APPEND);
609             var success = spawnEditor(repo, file);
610             if (!success) {
611                 System.err.println(&quot;error: editor exited with non-zero status code, aborting&quot;);
612                 System.exit(1);
613             }
614             var lines = Files.readAllLines(file)
615                              .stream()
616                              .filter(l -&gt; !l.startsWith(&quot;#&quot;))
617                              .collect(Collectors.toList());
618             var isEmpty = lines.stream().allMatch(String::isEmpty);
619             if (isEmpty) {
620                 System.err.println(&quot;error: no message present, aborting&quot;);
621                 System.exit(1);
622             }
623 
624             var title = lines.get(0);
625             List&lt;String&gt; body = null;
626             if (lines.size() &gt; 1) {
627                 body = lines.subList(1, lines.size())
628                             .stream()
629                             .dropWhile(String::isEmpty)
630                             .collect(Collectors.toList());
631             } else {
632                 body = Collections.emptyList();
633             }
634 
635             var pr = remoteRepo.createPullRequest(parentRepo, targetBranch, currentBranch.name(), title, body);
636             if (arguments.contains(&quot;assignees&quot;)) {
637                 var usernames = Arrays.asList(arguments.get(&quot;assignees&quot;).asString().split(&quot;,&quot;));
638                 var assignees = usernames.stream()
<a name="12" id="anc12"></a><span class="line-modified">639                                          .map(host::user)</span>
640                                          .collect(Collectors.toList());
641                 pr.setAssignees(assignees);
642             }
<a name="13" id="anc13"></a><span class="line-modified">643             System.out.println(pr.webUrl().toString());</span>
644             Files.deleteIfExists(file);
645         } else if (action.equals(&quot;integrate&quot;) || action.equals(&quot;approve&quot;)) {
646             var pr = getPullRequest(uri, credentials, arguments.at(1));
647 
648             if (action.equals(&quot;integrate&quot;)) {
649                 pr.addComment(&quot;/integrate&quot;);
650             } else if (action.equals(&quot;approve&quot;)) {
651                 pr.addReview(Review.Verdict.APPROVED, &quot;Looks good!&quot;);
652             } else {
653                 throw new IllegalStateException(&quot;unexpected action: &quot; + action);
654             }
655         } else if (action.equals(&quot;list&quot;)) {
656             var remoteRepo = getHostedRepositoryFor(uri, credentials);
<a name="14" id="anc14"></a><span class="line-modified">657             var prs = remoteRepo.pullRequests();</span>
658 
659             var ids = new ArrayList&lt;String&gt;();
660             var titles = new ArrayList&lt;String&gt;();
661             var authors = new ArrayList&lt;String&gt;();
662             var assignees = new ArrayList&lt;String&gt;();
663             var labels = new ArrayList&lt;String&gt;();
664 
665             var filterAuthors = arguments.contains(&quot;authors&quot;) ?
666                 new HashSet&lt;&gt;(Arrays.asList(arguments.get(&quot;authors&quot;).asString().split(&quot;,&quot;))) :
667                 Set.of();
668             var filterAssignees = arguments.contains(&quot;assignees&quot;) ?
669                 Arrays.asList(arguments.get(&quot;assignees&quot;).asString().split(&quot;,&quot;)) :
670                 Set.of();
671             var filterLabels = arguments.contains(&quot;labels&quot;) ?
672                 Arrays.asList(arguments.get(&quot;labels&quot;).asString().split(&quot;,&quot;)) :
673                 Set.of();
674 
675             var defaultColumns = List.of(&quot;id&quot;, &quot;title&quot;, &quot;authors&quot;, &quot;assignees&quot;, &quot;labels&quot;);
676             var columnValues = Map.of(defaultColumns.get(0), ids,
677                                       defaultColumns.get(1), titles,
678                                       defaultColumns.get(2), authors,
679                                       defaultColumns.get(3), assignees,
680                                       defaultColumns.get(4), labels);
681             var columns = arguments.contains(&quot;columns&quot;) ?
682                 Arrays.asList(arguments.get(&quot;columns&quot;).asString().split(&quot;,&quot;)) :
683                 defaultColumns;
684             if (columns != defaultColumns) {
685                 for (var column : columns) {
686                     if (!defaultColumns.contains(column)) {
687                         System.err.println(&quot;error: unknown column: &quot; + column);
688                         System.err.println(&quot;       available columns are: &quot; + String.join(&quot;,&quot;, defaultColumns));
689                         System.exit(1);
690                     }
691                 }
692             }
693 
<a name="15" id="anc15"></a><span class="line-modified">694             for (var pr : remoteRepo.pullRequests()) {</span>
<span class="line-modified">695                 var prAuthor = pr.author().userName();</span>
696                 if (!filterAuthors.isEmpty() &amp;&amp; !filterAuthors.contains(prAuthor)) {
697                     continue;
698                 }
699 
<a name="16" id="anc16"></a><span class="line-modified">700                 var prAssignees = pr.assignees().stream()</span>
<span class="line-modified">701                                     .map(HostUser::userName)</span>
<span class="line-modified">702                                     .collect(Collectors.toSet());</span>
703                 if (!filterAssignees.isEmpty() &amp;&amp; !filterAssignees.stream().anyMatch(prAssignees::contains)) {
704                     continue;
705                 }
706 
<a name="17" id="anc17"></a><span class="line-modified">707                 var prLabels = new HashSet&lt;&gt;(pr.labels());</span>
708                 if (!filterLabels.isEmpty() &amp;&amp; !filterLabels.stream().anyMatch(prLabels::contains)) {
709                     continue;
710                 }
711 
<a name="18" id="anc18"></a><span class="line-modified">712                 ids.add(pr.id());</span>
<span class="line-modified">713                 titles.add(pr.title());</span>
714                 authors.add(prAuthor);
715                 assignees.add(String.join(&quot;,&quot;, prAssignees));
716                 labels.add(String.join(&quot;,&quot;, prLabels));
717             }
718 
719 
720             String fmt = &quot;&quot;;
721             for (var column : columns.subList(0, columns.size() - 1)) {
722                 var values = columnValues.get(column);
723                 var n = Math.max(column.length(), longest(values));
724                 fmt += &quot;%-&quot; + n + &quot;s\t&quot;;
725             }
726             fmt += &quot;%s\n&quot;;
727 
728             if (!ids.isEmpty() &amp;&amp; !arguments.contains(&quot;no-decoration&quot;)) {
729                 var upperCase = columns.stream()
730                                        .map(String::toUpperCase)
731                                        .collect(Collectors.toList());
732                 System.out.format(fmt, (Object[]) upperCase.toArray(new String[0]));
733             }
734             for (var i = 0; i &lt; ids.size(); i++) {
735                 final int n = i;
736                 var row = columns.stream()
737                                  .map(columnValues::get)
738                                  .map(values -&gt; values.get(n))
739                                  .collect(Collectors.toList());
740                 System.out.format(fmt, (Object[]) row.toArray(new String[0]));
741             }
742         } else if (action.equals(&quot;fetch&quot;) || action.equals(&quot;checkout&quot;) || action.equals(&quot;show&quot;) || action.equals(&quot;apply&quot;)) {
743             var prId = arguments.at(1);
744             if (!prId.isPresent()) {
745                 exit(&quot;error: missing pull request identifier&quot;);
746             }
747 
748             var remoteRepo = getHostedRepositoryFor(uri, credentials);
<a name="19" id="anc19"></a><span class="line-modified">749             var pr = remoteRepo.pullRequest(prId.asString());</span>
<span class="line-modified">750             var repoUrl = remoteRepo.webUrl();</span>
<span class="line-modified">751             var prHeadRef = pr.sourceRef();</span>
752             var isHgGit = isMercurial &amp;&amp; Repository.exists(repo.root().resolve(&quot;.hg&quot;).resolve(&quot;git&quot;));
753             if (isHgGit) {
754                 var hgGitRepo = Repository.get(repo.root().resolve(&quot;.hg&quot;).resolve(&quot;git&quot;)).get();
755                 var hgGitFetchHead = hgGitRepo.fetch(repoUrl, prHeadRef);
756 
757                 if (action.equals(&quot;show&quot;) || action.equals(&quot;apply&quot;)) {
<a name="20" id="anc20"></a><span class="line-modified">758                     var target = hgGitRepo.fetch(repoUrl, pr.targetRef());</span>
759                     var hgGitMergeBase = hgGitRepo.mergeBase(target, hgGitFetchHead);
760 
761                     if (action.equals(&quot;show&quot;)) {
762                         show(hgGitMergeBase.hex(), hgGitFetchHead, hgGitRepo.root());
763                     } else {
764                         var patch = diff(hgGitMergeBase.hex(), hgGitFetchHead, hgGitRepo.root());
765                         hgImport(patch);
766                         Files.delete(patch);
767                     }
768                 } else if (action.equals(&quot;fetch&quot;) || action.equals(&quot;checkout&quot;)) {
769                     var hgGitRef = prHeadRef.endsWith(&quot;/head&quot;) ? prHeadRef.replace(&quot;/head&quot;, &quot;&quot;) : prHeadRef;
770                     var hgGitBranches = hgGitRepo.branches();
771                     if (hgGitBranches.contains(new Branch(hgGitRef))) {
772                         hgGitRepo.delete(new Branch(hgGitRef));
773                     }
774                     hgGitRepo.branch(hgGitFetchHead, hgGitRef);
775                     gimport();
776                     var hgFetchHead = repo.resolve(hgGitRef).get();
777 
778                     if (action.equals(&quot;fetch&quot;) &amp;&amp; arguments.contains(&quot;branch&quot;)) {
779                         repo.branch(hgFetchHead, arguments.get(&quot;branch&quot;).asString());
780                     } else if (action.equals(&quot;checkout&quot;)) {
781                         repo.checkout(hgFetchHead);
782                         if (arguments.contains(&quot;branch&quot;)) {
783                             repo.branch(hgFetchHead, arguments.get(&quot;branch&quot;).asString());
784                         }
785                     }
786                 } else {
787                     exit(&quot;Unexpected action: &quot; + action);
788                 }
789 
790                 return;
791             }
792 
<a name="21" id="anc21"></a><span class="line-modified">793             var fetchHead = repo.fetch(repoUrl, pr.sourceRef());</span>
794             if (action.equals(&quot;fetch&quot;)) {
795                 if (arguments.contains(&quot;branch&quot;)) {
796                     var branchName = arguments.get(&quot;branch&quot;).asString();
797                     repo.branch(fetchHead, branchName);
798                 } else {
799                     System.out.println(fetchHead.hex());
800                 }
801             } else if (action.equals(&quot;checkout&quot;)) {
802                 if (arguments.contains(&quot;branch&quot;)) {
803                     var branchName = arguments.get(&quot;branch&quot;).asString();
804                     var branch = repo.branch(fetchHead, branchName);
805                     repo.checkout(branch, false);
806                 } else {
807                     repo.checkout(fetchHead, false);
808                 }
809             } else if (action.equals(&quot;show&quot;)) {
<a name="22" id="anc22"></a><span class="line-modified">810                 show(pr.targetRef(), fetchHead);</span>
811             } else if (action.equals(&quot;apply&quot;)) {
<a name="23" id="anc23"></a><span class="line-modified">812                 var patch = diff(pr.targetRef(), fetchHead);</span>
813                 apply(patch);
814                 Files.deleteIfExists(patch);
815             }
816         } else if (action.equals(&quot;close&quot;)) {
817             var prId = arguments.at(1);
818             if (!prId.isPresent()) {
819                 exit(&quot;error: missing pull request identifier&quot;);
820             }
821 
822             var remoteRepo = getHostedRepositoryFor(uri, credentials);
<a name="24" id="anc24"></a><span class="line-modified">823             var pr = remoteRepo.pullRequest(prId.asString());</span>
824             pr.setState(PullRequest.State.CLOSED);
825         } else if (action.equals(&quot;update&quot;)) {
826             var prId = arguments.at(1);
827             if (!prId.isPresent()) {
828                 exit(&quot;error: missing pull request identifier&quot;);
829             }
830 
831             var remoteRepo = getHostedRepositoryFor(uri, credentials);
<a name="25" id="anc25"></a><span class="line-modified">832             var pr = remoteRepo.pullRequest(prId.asString());</span>
833             if (arguments.contains(&quot;assignees&quot;)) {
834                 var usernames = Arrays.asList(arguments.get(&quot;assignees&quot;).asString().split(&quot;,&quot;));
835                 var assignees = usernames.stream()
<a name="26" id="anc26"></a><span class="line-modified">836                     .map(host::user)</span>
837                     .collect(Collectors.toList());
838                 pr.setAssignees(assignees);
839             }
840         } else {
841             exit(&quot;error: unexpected action: &quot; + action);
842         }
843     }
844 }
<a name="27" id="anc27"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="27" type="hidden" />
</body>
</html>