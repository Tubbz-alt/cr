<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff cli/src/main/java/org/openjdk/skara/cli/GitPr.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="GitFork.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../host/build.gradle.cdiff.html" target="_top">next &gt;</a></center>    <h2>cli/src/main/java/org/openjdk/skara/cli/GitPr.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 25,11 ***</span>
  import org.openjdk.skara.args.*;
  import org.openjdk.skara.host.*;
  import org.openjdk.skara.vcs.*;
  import org.openjdk.skara.vcs.openjdk.*;
  import org.openjdk.skara.proxy.HttpProxy;
<span class="line-removed">- import org.openjdk.skara.ssh.SSHConfig;</span>
  
  import java.io.IOException;
  import java.net.URI;
  import java.nio.file.*;
  import java.util.*;
<span class="line-new-header">--- 25,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 99,26 ***</span>
          }
          return name;
      }
  
      private static HostedRepository getHostedRepositoryFor(URI uri, GitCredentials credentials) throws IOException {
<span class="line-modified">!         var host = Host.from(uri, new PersonalAccessToken(credentials.username(), credentials.password()));</span>
          if (System.getenv(&quot;GIT_TOKEN&quot;) == null) {
              GitCredentials.approve(credentials);
          }
<span class="line-modified">!         var remoteRepo = host.getRepository(projectName(uri));</span>
<span class="line-modified">!         var parentRepo = remoteRepo.getParent();</span>
          var targetRepo = parentRepo.isPresent() ? parentRepo.get() : remoteRepo;
          return targetRepo;
      }
  
      private static PullRequest getPullRequest(URI uri, GitCredentials credentials, Argument prId) throws IOException {
          if (!prId.isPresent()) {
              exit(&quot;error: missing pull request identifier&quot;);
          }
  
<span class="line-modified">!         var pr = getHostedRepositoryFor(uri, credentials).getPullRequest(prId.asString());</span>
          if (pr == null) {
              exit(&quot;error: could not fetch PR information&quot;);
          }
  
          return pr;
<span class="line-new-header">--- 98,26 ---</span>
          }
          return name;
      }
  
      private static HostedRepository getHostedRepositoryFor(URI uri, GitCredentials credentials) throws IOException {
<span class="line-modified">!         var host = RepositoryHost.from(uri, new PersonalAccessToken(credentials.username(), credentials.password()));</span>
          if (System.getenv(&quot;GIT_TOKEN&quot;) == null) {
              GitCredentials.approve(credentials);
          }
<span class="line-modified">!         var remoteRepo = host.repository(projectName(uri));</span>
<span class="line-modified">!         var parentRepo = remoteRepo.parent();</span>
          var targetRepo = parentRepo.isPresent() ? parentRepo.get() : remoteRepo;
          return targetRepo;
      }
  
      private static PullRequest getPullRequest(URI uri, GitCredentials credentials, Argument prId) throws IOException {
          if (!prId.isPresent()) {
              exit(&quot;error: missing pull request identifier&quot;);
          }
  
<span class="line-modified">!         var pr = getHostedRepositoryFor(uri, credentials).pullRequest(prId.asString());</span>
          if (pr == null) {
              exit(&quot;error: could not fetch PR information&quot;);
          }
  
          return pr;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 307,11 ***</span>
          var remotePullPath = repo.pullPath(remote);
          var username = arguments.contains(&quot;username&quot;) ? arguments.get(&quot;username&quot;).asString() : null;
          var token = isMercurial ? System.getenv(&quot;HG_TOKEN&quot;) :  System.getenv(&quot;GIT_TOKEN&quot;);
          var uri = Remote.toWebURI(remotePullPath);
          var credentials = GitCredentials.fill(uri.getHost(), uri.getPath(), username, token, uri.getScheme());
<span class="line-modified">!         var host = Host.from(uri, new PersonalAccessToken(credentials.username(), credentials.password()));</span>
  
          var action = arguments.at(0).asString();
          if (action.equals(&quot;create&quot;)) {
              if (isMercurial) {
                  var currentBookmark = repo.currentBookmark();
<span class="line-new-header">--- 306,11 ---</span>
          var remotePullPath = repo.pullPath(remote);
          var username = arguments.contains(&quot;username&quot;) ? arguments.get(&quot;username&quot;).asString() : null;
          var token = isMercurial ? System.getenv(&quot;HG_TOKEN&quot;) :  System.getenv(&quot;GIT_TOKEN&quot;);
          var uri = Remote.toWebURI(remotePullPath);
          var credentials = GitCredentials.fill(uri.getHost(), uri.getPath(), username, token, uri.getScheme());
<span class="line-modified">!         var host = RepositoryHost.from(uri, new PersonalAccessToken(credentials.username(), credentials.password()));</span>
  
          var action = arguments.at(0).asString();
          if (action.equals(&quot;create&quot;)) {
              if (isMercurial) {
                  var currentBookmark = repo.currentBookmark();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 410,15 ***</span>
                      System.err.println(&quot;&quot;);
                      System.err.println(&quot;(You can later restore the changes by running: hg unshelve)&quot;);
                      System.exit(1);
                  }
  
<span class="line-modified">!                 var remoteRepo = host.getRepository(projectName(uri));</span>
                  if (token == null) {
                      GitCredentials.approve(credentials);
                  }
<span class="line-modified">!                 var parentRepo = remoteRepo.getParent().orElseThrow(() -&gt;</span>
                          new IOException(&quot;error: remote repository &quot; + remotePullPath + &quot; is not a fork of any repository&quot;));
  
                  var file = Files.createTempFile(&quot;PULL_REQUEST_&quot;, &quot;.txt&quot;);
                  if (commits.size() == 1) {
                      var commit = commits.get(0);
<span class="line-new-header">--- 409,15 ---</span>
                      System.err.println(&quot;&quot;);
                      System.err.println(&quot;(You can later restore the changes by running: hg unshelve)&quot;);
                      System.exit(1);
                  }
  
<span class="line-modified">!                 var remoteRepo = host.repository(projectName(uri));</span>
                  if (token == null) {
                      GitCredentials.approve(credentials);
                  }
<span class="line-modified">!                 var parentRepo = remoteRepo.parent().orElseThrow(() -&gt;</span>
                          new IOException(&quot;error: remote repository &quot; + remotePullPath + &quot; is not a fork of any repository&quot;));
  
                  var file = Files.createTempFile(&quot;PULL_REQUEST_&quot;, &quot;.txt&quot;);
                  if (commits.size() == 1) {
                      var commit = commits.get(0);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 478,15 ***</span>
  
                  var pr = remoteRepo.createPullRequest(parentRepo, targetBranch, bookmark.name(), title, body);
                  if (arguments.contains(&quot;assignees&quot;)) {
                      var usernames = Arrays.asList(arguments.get(&quot;assignees&quot;).asString().split(&quot;,&quot;));
                      var assignees = usernames.stream()
<span class="line-modified">!                                              .map(host::getUserDetails)</span>
                                               .collect(Collectors.toList());
                      pr.setAssignees(assignees);
                  }
<span class="line-modified">!                 System.out.println(pr.getWebUrl().toString());</span>
                  Files.deleteIfExists(file);
  
                  System.exit(0);
              }
              var currentBranch = repo.currentBranch();
<span class="line-new-header">--- 477,15 ---</span>
  
                  var pr = remoteRepo.createPullRequest(parentRepo, targetBranch, bookmark.name(), title, body);
                  if (arguments.contains(&quot;assignees&quot;)) {
                      var usernames = Arrays.asList(arguments.get(&quot;assignees&quot;).asString().split(&quot;,&quot;));
                      var assignees = usernames.stream()
<span class="line-modified">!                                              .map(host::user)</span>
                                               .collect(Collectors.toList());
                      pr.setAssignees(assignees);
                  }
<span class="line-modified">!                 System.out.println(pr.webUrl().toString());</span>
                  Files.deleteIfExists(file);
  
                  System.exit(0);
              }
              var currentBranch = repo.currentBranch();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 567,15 ***</span>
                  System.err.println(&quot;&quot;);
                  System.err.println(&quot;(You can later restore the changes by running: git stash pop)&quot;);
                  System.exit(1);
              }
  
<span class="line-modified">!             var remoteRepo = host.getRepository(projectName(uri));</span>
              if (token == null) {
                  GitCredentials.approve(credentials);
              }
<span class="line-modified">!             var parentRepo = remoteRepo.getParent().orElseThrow(() -&gt;</span>
                      new IOException(&quot;error: remote repository &quot; + remotePullPath + &quot; is not a fork of any repository&quot;));
  
              var file = Files.createTempFile(&quot;PULL_REQUEST_&quot;, &quot;.txt&quot;);
              if (commits.size() == 1) {
                  var commit = commits.get(0);
<span class="line-new-header">--- 566,15 ---</span>
                  System.err.println(&quot;&quot;);
                  System.err.println(&quot;(You can later restore the changes by running: git stash pop)&quot;);
                  System.exit(1);
              }
  
<span class="line-modified">!             var remoteRepo = host.repository(projectName(uri));</span>
              if (token == null) {
                  GitCredentials.approve(credentials);
              }
<span class="line-modified">!             var parentRepo = remoteRepo.parent().orElseThrow(() -&gt;</span>
                      new IOException(&quot;error: remote repository &quot; + remotePullPath + &quot; is not a fork of any repository&quot;));
  
              var file = Files.createTempFile(&quot;PULL_REQUEST_&quot;, &quot;.txt&quot;);
              if (commits.size() == 1) {
                  var commit = commits.get(0);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 635,15 ***</span>
  
              var pr = remoteRepo.createPullRequest(parentRepo, targetBranch, currentBranch.name(), title, body);
              if (arguments.contains(&quot;assignees&quot;)) {
                  var usernames = Arrays.asList(arguments.get(&quot;assignees&quot;).asString().split(&quot;,&quot;));
                  var assignees = usernames.stream()
<span class="line-modified">!                                          .map(host::getUserDetails)</span>
                                           .collect(Collectors.toList());
                  pr.setAssignees(assignees);
              }
<span class="line-modified">!             System.out.println(pr.getWebUrl().toString());</span>
              Files.deleteIfExists(file);
          } else if (action.equals(&quot;integrate&quot;) || action.equals(&quot;approve&quot;)) {
              var pr = getPullRequest(uri, credentials, arguments.at(1));
  
              if (action.equals(&quot;integrate&quot;)) {
<span class="line-new-header">--- 634,15 ---</span>
  
              var pr = remoteRepo.createPullRequest(parentRepo, targetBranch, currentBranch.name(), title, body);
              if (arguments.contains(&quot;assignees&quot;)) {
                  var usernames = Arrays.asList(arguments.get(&quot;assignees&quot;).asString().split(&quot;,&quot;));
                  var assignees = usernames.stream()
<span class="line-modified">!                                          .map(host::user)</span>
                                           .collect(Collectors.toList());
                  pr.setAssignees(assignees);
              }
<span class="line-modified">!             System.out.println(pr.webUrl().toString());</span>
              Files.deleteIfExists(file);
          } else if (action.equals(&quot;integrate&quot;) || action.equals(&quot;approve&quot;)) {
              var pr = getPullRequest(uri, credentials, arguments.at(1));
  
              if (action.equals(&quot;integrate&quot;)) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 653,11 ***</span>
              } else {
                  throw new IllegalStateException(&quot;unexpected action: &quot; + action);
              }
          } else if (action.equals(&quot;list&quot;)) {
              var remoteRepo = getHostedRepositoryFor(uri, credentials);
<span class="line-modified">!             var prs = remoteRepo.getPullRequests();</span>
  
              var ids = new ArrayList&lt;String&gt;();
              var titles = new ArrayList&lt;String&gt;();
              var authors = new ArrayList&lt;String&gt;();
              var assignees = new ArrayList&lt;String&gt;();
<span class="line-new-header">--- 652,11 ---</span>
              } else {
                  throw new IllegalStateException(&quot;unexpected action: &quot; + action);
              }
          } else if (action.equals(&quot;list&quot;)) {
              var remoteRepo = getHostedRepositoryFor(uri, credentials);
<span class="line-modified">!             var prs = remoteRepo.pullRequests();</span>
  
              var ids = new ArrayList&lt;String&gt;();
              var titles = new ArrayList&lt;String&gt;();
              var authors = new ArrayList&lt;String&gt;();
              var assignees = new ArrayList&lt;String&gt;();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 690,30 ***</span>
                          System.exit(1);
                      }
                  }
              }
  
<span class="line-modified">!             for (var pr : remoteRepo.getPullRequests()) {</span>
<span class="line-modified">!                 var prAuthor = pr.getAuthor().userName();</span>
                  if (!filterAuthors.isEmpty() &amp;&amp; !filterAuthors.contains(prAuthor)) {
                      continue;
                  }
  
<span class="line-modified">!                 var prAssignees = pr.getAssignees().stream()</span>
<span class="line-modified">!                                    .map(HostUserDetails::userName)</span>
<span class="line-modified">!                                    .collect(Collectors.toSet());</span>
                  if (!filterAssignees.isEmpty() &amp;&amp; !filterAssignees.stream().anyMatch(prAssignees::contains)) {
                      continue;
                  }
  
<span class="line-modified">!                 var prLabels = new HashSet&lt;&gt;(pr.getLabels());</span>
                  if (!filterLabels.isEmpty() &amp;&amp; !filterLabels.stream().anyMatch(prLabels::contains)) {
                      continue;
                  }
  
<span class="line-modified">!                 ids.add(pr.getId());</span>
<span class="line-modified">!                 titles.add(pr.getTitle());</span>
                  authors.add(prAuthor);
                  assignees.add(String.join(&quot;,&quot;, prAssignees));
                  labels.add(String.join(&quot;,&quot;, prLabels));
              }
  
<span class="line-new-header">--- 689,30 ---</span>
                          System.exit(1);
                      }
                  }
              }
  
<span class="line-modified">!             for (var pr : remoteRepo.pullRequests()) {</span>
<span class="line-modified">!                 var prAuthor = pr.author().userName();</span>
                  if (!filterAuthors.isEmpty() &amp;&amp; !filterAuthors.contains(prAuthor)) {
                      continue;
                  }
  
<span class="line-modified">!                 var prAssignees = pr.assignees().stream()</span>
<span class="line-modified">!                                     .map(HostUser::userName)</span>
<span class="line-modified">!                                     .collect(Collectors.toSet());</span>
                  if (!filterAssignees.isEmpty() &amp;&amp; !filterAssignees.stream().anyMatch(prAssignees::contains)) {
                      continue;
                  }
  
<span class="line-modified">!                 var prLabels = new HashSet&lt;&gt;(pr.labels());</span>
                  if (!filterLabels.isEmpty() &amp;&amp; !filterLabels.stream().anyMatch(prLabels::contains)) {
                      continue;
                  }
  
<span class="line-modified">!                 ids.add(pr.id());</span>
<span class="line-modified">!                 titles.add(pr.title());</span>
                  authors.add(prAuthor);
                  assignees.add(String.join(&quot;,&quot;, prAssignees));
                  labels.add(String.join(&quot;,&quot;, prLabels));
              }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 745,20 ***</span>
              if (!prId.isPresent()) {
                  exit(&quot;error: missing pull request identifier&quot;);
              }
  
              var remoteRepo = getHostedRepositoryFor(uri, credentials);
<span class="line-modified">!             var pr = remoteRepo.getPullRequest(prId.asString());</span>
<span class="line-modified">!             var repoUrl = remoteRepo.getWebUrl();</span>
<span class="line-modified">!             var prHeadRef = pr.getSourceRef();</span>
              var isHgGit = isMercurial &amp;&amp; Repository.exists(repo.root().resolve(&quot;.hg&quot;).resolve(&quot;git&quot;));
              if (isHgGit) {
                  var hgGitRepo = Repository.get(repo.root().resolve(&quot;.hg&quot;).resolve(&quot;git&quot;)).get();
                  var hgGitFetchHead = hgGitRepo.fetch(repoUrl, prHeadRef);
  
                  if (action.equals(&quot;show&quot;) || action.equals(&quot;apply&quot;)) {
<span class="line-modified">!                     var target = hgGitRepo.fetch(repoUrl, pr.getTargetRef());</span>
                      var hgGitMergeBase = hgGitRepo.mergeBase(target, hgGitFetchHead);
  
                      if (action.equals(&quot;show&quot;)) {
                          show(hgGitMergeBase.hex(), hgGitFetchHead, hgGitRepo.root());
                      } else {
<span class="line-new-header">--- 744,20 ---</span>
              if (!prId.isPresent()) {
                  exit(&quot;error: missing pull request identifier&quot;);
              }
  
              var remoteRepo = getHostedRepositoryFor(uri, credentials);
<span class="line-modified">!             var pr = remoteRepo.pullRequest(prId.asString());</span>
<span class="line-modified">!             var repoUrl = remoteRepo.webUrl();</span>
<span class="line-modified">!             var prHeadRef = pr.sourceRef();</span>
              var isHgGit = isMercurial &amp;&amp; Repository.exists(repo.root().resolve(&quot;.hg&quot;).resolve(&quot;git&quot;));
              if (isHgGit) {
                  var hgGitRepo = Repository.get(repo.root().resolve(&quot;.hg&quot;).resolve(&quot;git&quot;)).get();
                  var hgGitFetchHead = hgGitRepo.fetch(repoUrl, prHeadRef);
  
                  if (action.equals(&quot;show&quot;) || action.equals(&quot;apply&quot;)) {
<span class="line-modified">!                     var target = hgGitRepo.fetch(repoUrl, pr.targetRef());</span>
                      var hgGitMergeBase = hgGitRepo.mergeBase(target, hgGitFetchHead);
  
                      if (action.equals(&quot;show&quot;)) {
                          show(hgGitMergeBase.hex(), hgGitFetchHead, hgGitRepo.root());
                      } else {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 789,11 ***</span>
                  }
  
                  return;
              }
  
<span class="line-modified">!             var fetchHead = repo.fetch(repoUrl, pr.getSourceRef());</span>
              if (action.equals(&quot;fetch&quot;)) {
                  if (arguments.contains(&quot;branch&quot;)) {
                      var branchName = arguments.get(&quot;branch&quot;).asString();
                      repo.branch(fetchHead, branchName);
                  } else {
<span class="line-new-header">--- 788,11 ---</span>
                  }
  
                  return;
              }
  
<span class="line-modified">!             var fetchHead = repo.fetch(repoUrl, pr.sourceRef());</span>
              if (action.equals(&quot;fetch&quot;)) {
                  if (arguments.contains(&quot;branch&quot;)) {
                      var branchName = arguments.get(&quot;branch&quot;).asString();
                      repo.branch(fetchHead, branchName);
                  } else {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 806,37 ***</span>
                      repo.checkout(branch, false);
                  } else {
                      repo.checkout(fetchHead, false);
                  }
              } else if (action.equals(&quot;show&quot;)) {
<span class="line-modified">!                 show(pr.getTargetRef(), fetchHead);</span>
              } else if (action.equals(&quot;apply&quot;)) {
<span class="line-modified">!                 var patch = diff(pr.getTargetRef(), fetchHead);</span>
                  apply(patch);
                  Files.deleteIfExists(patch);
              }
          } else if (action.equals(&quot;close&quot;)) {
              var prId = arguments.at(1);
              if (!prId.isPresent()) {
                  exit(&quot;error: missing pull request identifier&quot;);
              }
  
              var remoteRepo = getHostedRepositoryFor(uri, credentials);
<span class="line-modified">!             var pr = remoteRepo.getPullRequest(prId.asString());</span>
              pr.setState(PullRequest.State.CLOSED);
          } else if (action.equals(&quot;update&quot;)) {
              var prId = arguments.at(1);
              if (!prId.isPresent()) {
                  exit(&quot;error: missing pull request identifier&quot;);
              }
  
              var remoteRepo = getHostedRepositoryFor(uri, credentials);
<span class="line-modified">!             var pr = remoteRepo.getPullRequest(prId.asString());</span>
              if (arguments.contains(&quot;assignees&quot;)) {
                  var usernames = Arrays.asList(arguments.get(&quot;assignees&quot;).asString().split(&quot;,&quot;));
                  var assignees = usernames.stream()
<span class="line-modified">!                     .map(host::getUserDetails)</span>
                      .collect(Collectors.toList());
                  pr.setAssignees(assignees);
              }
          } else {
              exit(&quot;error: unexpected action: &quot; + action);
<span class="line-new-header">--- 805,37 ---</span>
                      repo.checkout(branch, false);
                  } else {
                      repo.checkout(fetchHead, false);
                  }
              } else if (action.equals(&quot;show&quot;)) {
<span class="line-modified">!                 show(pr.targetRef(), fetchHead);</span>
              } else if (action.equals(&quot;apply&quot;)) {
<span class="line-modified">!                 var patch = diff(pr.targetRef(), fetchHead);</span>
                  apply(patch);
                  Files.deleteIfExists(patch);
              }
          } else if (action.equals(&quot;close&quot;)) {
              var prId = arguments.at(1);
              if (!prId.isPresent()) {
                  exit(&quot;error: missing pull request identifier&quot;);
              }
  
              var remoteRepo = getHostedRepositoryFor(uri, credentials);
<span class="line-modified">!             var pr = remoteRepo.pullRequest(prId.asString());</span>
              pr.setState(PullRequest.State.CLOSED);
          } else if (action.equals(&quot;update&quot;)) {
              var prId = arguments.at(1);
              if (!prId.isPresent()) {
                  exit(&quot;error: missing pull request identifier&quot;);
              }
  
              var remoteRepo = getHostedRepositoryFor(uri, credentials);
<span class="line-modified">!             var pr = remoteRepo.pullRequest(prId.asString());</span>
              if (arguments.contains(&quot;assignees&quot;)) {
                  var usernames = Arrays.asList(arguments.get(&quot;assignees&quot;).asString().split(&quot;,&quot;));
                  var assignees = usernames.stream()
<span class="line-modified">!                     .map(host::user)</span>
                      .collect(Collectors.toList());
                  pr.setAssignees(assignees);
              }
          } else {
              exit(&quot;error: unexpected action: &quot; + action);
</pre>
<center><a href="GitFork.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../host/build.gradle.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>