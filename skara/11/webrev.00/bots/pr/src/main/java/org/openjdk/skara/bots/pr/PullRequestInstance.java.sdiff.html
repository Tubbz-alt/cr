<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/pr/src/main/java/org/openjdk/skara/bots/pr/PullRequestInstance.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="CheckWorkItem.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="ReviewTracker.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/pr/src/main/java/org/openjdk/skara/bots/pr/PullRequestInstance.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 33 import java.util.stream.Collectors;
 34 
 35 class PullRequestInstance {
 36     private final PullRequest pr;
 37     private final Repository localRepo;
 38     private final Hash targetHash;
 39     private final Hash headHash;
 40     private final Hash baseHash;
 41 
 42     PullRequestInstance(Path localRepoPath, PullRequest pr) throws IOException  {
 43         this.pr = pr;
 44         var repository = pr.repository();
 45 
 46         // Materialize the PR&#39;s target ref
 47         localRepo = Repository.materialize(localRepoPath, repository.getUrl(), pr.getTargetRef());
 48         targetHash = localRepo.fetch(repository.getUrl(), pr.getTargetRef());
 49         headHash = localRepo.fetch(repository.getUrl(), pr.getHeadHash().hex());
 50         baseHash = localRepo.mergeBase(targetHash, headHash);
 51     }
 52 
<span class="line-modified"> 53     private String commitMessage(Namespace namespace, boolean isMerge) throws IOException {</span>
<span class="line-modified"> 54         var reviewers = pr.getReviews().stream()</span>
<span class="line-modified"> 55                           .filter(review -&gt; review.verdict == Review.Verdict.APPROVED)</span>
<span class="line-modified"> 56                           .map(review -&gt; review.reviewer.id())</span>














 57                           .map(namespace::get)
 58                           .filter(Objects::nonNull)
 59                           .map(Contributor::username)
 60                           .collect(Collectors.toList());
 61 
 62         var additionalContributors = Contributors.contributors(pr.repository().host().getCurrentUserDetails(),
 63                                                                pr.getComments()).stream()
 64                                                  .map(email -&gt; Author.fromString(email.toString()))
 65                                                  .collect(Collectors.toList());
 66 
 67         var commitMessage = CommitMessage.title(isMerge ? &quot;Merge&quot; : pr.getTitle())
 68                                          .contributors(additionalContributors)
 69                                          .reviewers(reviewers);
 70         return String.join(&quot;\n&quot;, commitMessage.format(CommitMessageFormatters.v1));
 71     }
 72 
<span class="line-modified"> 73     private Hash commitSquashed(Namespace namespace, String censusDomain, String sponsorId) throws IOException {</span>
 74         localRepo.checkout(baseHash, true);
 75         localRepo.squash(headHash);
 76 
 77         Author committer;
 78         Author author;
 79         var contributor = namespace.get(pr.getAuthor().id());
 80 
 81         if (contributor == null) {
 82             // Use the information contained in the head commit - jcheck has verified that it contains sane values
 83             var headCommit = localRepo.commits(headHash.hex() + &quot;^..&quot; + headHash.hex()).asList().get(0);
 84             author = headCommit.author();
 85         } else {
 86             author = new Author(contributor.fullName().orElseThrow(), contributor.username() + &quot;@&quot; + censusDomain);
 87         }
 88 
 89         if (sponsorId != null) {
 90             var sponsorContributor = namespace.get(sponsorId);
 91             committer = new Author(sponsorContributor.fullName().orElseThrow(), sponsorContributor.username() + &quot;@&quot; + censusDomain);
 92         } else {
 93             committer = author;
</pre>
<hr />
<pre>
 76 
 77         Author committer;
 78         Author author;
 79         var contributor = namespace.get(pr.getAuthor().id());
 80 
 81         if (contributor == null) {
 82             // Use the information contained in the head commit - jcheck has verified that it contains sane values
 83             var headCommit = localRepo.commits(headHash.hex() + &quot;^..&quot; + headHash.hex()).asList().get(0);
 84             author = headCommit.author();
 85         } else {
 86             author = new Author(contributor.fullName().orElseThrow(), contributor.username() + &quot;@&quot; + censusDomain);
 87         }
 88 
 89         if (sponsorId != null) {
 90             var sponsorContributor = namespace.get(sponsorId);
 91             committer = new Author(sponsorContributor.fullName().orElseThrow(), sponsorContributor.username() + &quot;@&quot; + censusDomain);
 92         } else {
 93             committer = author;
 94         }
 95 
<span class="line-modified"> 96         var commitMessage = commitMessage(namespace, false);</span>
 97         return localRepo.commit(commitMessage, author.name(), author.email(), committer.name(), committer.email());
 98     }
 99 
<span class="line-modified">100     private Hash commitMerge(Namespace namespace, String censusDomain) throws IOException {</span>
101         localRepo.checkout(headHash, true);
102 
103         var contributor = namespace.get(pr.getAuthor().id());
104         if (contributor == null) {
105             throw new RuntimeException(&quot;Merges can only be performed by Committers&quot;);
106         }
107 
108         var author = new Author(contributor.fullName().orElseThrow(), contributor.username() + &quot;@&quot; + censusDomain);
109 
<span class="line-modified">110         var commitMessage = commitMessage(namespace, true);</span>
111         return localRepo.amend(commitMessage, author.name(), author.email(), author.name(), author.email());
112     }
113 
114     Hash commit(Namespace namespace, String censusDomain, String sponsorId) throws IOException {

115         if (!pr.getTitle().startsWith(&quot;Merge&quot;)) {
<span class="line-modified">116             return commitSquashed(namespace, censusDomain, sponsorId);</span>
117         } else {
<span class="line-modified">118             return commitMerge(namespace, censusDomain);</span>
119         }
120     }
121 
122     List&lt;Commit&gt; divergingCommits() {
123         try {
124             return localRepo.commits(baseHash + &quot;..&quot; + targetHash).asList();
125         } catch (IOException e) {
126             throw new RuntimeException(e);
127         }
128     }
129 
130     boolean rebasePossible(Hash commitHash) {
131         try {
132             var commit = localRepo.lookup(commitHash);
133             if (commit.isEmpty()) {
134                 return false;
135             }
136             localRepo.rebase(targetHash, commit.get().committer().name(), commit.get().committer().email());
137             var hash = localRepo.head();
138             return !hash.hex().equals(targetHash.hex());
</pre>
</td>
<td>
<hr />
<pre>
 33 import java.util.stream.Collectors;
 34 
 35 class PullRequestInstance {
 36     private final PullRequest pr;
 37     private final Repository localRepo;
 38     private final Hash targetHash;
 39     private final Hash headHash;
 40     private final Hash baseHash;
 41 
 42     PullRequestInstance(Path localRepoPath, PullRequest pr) throws IOException  {
 43         this.pr = pr;
 44         var repository = pr.repository();
 45 
 46         // Materialize the PR&#39;s target ref
 47         localRepo = Repository.materialize(localRepoPath, repository.getUrl(), pr.getTargetRef());
 48         targetHash = localRepo.fetch(repository.getUrl(), pr.getTargetRef());
 49         headHash = localRepo.fetch(repository.getUrl(), pr.getHeadHash().hex());
 50         baseHash = localRepo.mergeBase(targetHash, headHash);
 51     }
 52 
<span class="line-modified"> 53     /**</span>
<span class="line-modified"> 54      * The Review list is in chronological order, the latest one from a particular reviewer is the</span>
<span class="line-modified"> 55      * one that is &quot;active&quot;.</span>
<span class="line-modified"> 56      * @param allReviews</span>
<span class="line-added"> 57      * @return</span>
<span class="line-added"> 58      */</span>
<span class="line-added"> 59     static List&lt;Review&gt; filterActiveReviews(List&lt;Review&gt; allReviews) {</span>
<span class="line-added"> 60         var reviewPerUser = new LinkedHashMap&lt;HostUserDetails, Review&gt;();</span>
<span class="line-added"> 61         for (var review : allReviews) {</span>
<span class="line-added"> 62             reviewPerUser.put(review.reviewer(), review);</span>
<span class="line-added"> 63         }</span>
<span class="line-added"> 64         return new ArrayList&lt;&gt;(reviewPerUser.values());</span>
<span class="line-added"> 65     }</span>
<span class="line-added"> 66 </span>
<span class="line-added"> 67     private String commitMessage(List&lt;Review&gt; activeReviews, Namespace namespace, boolean isMerge) throws IOException {</span>
<span class="line-added"> 68         var reviewers = activeReviews.stream()</span>
<span class="line-added"> 69                           .filter(review -&gt; review.verdict() == Review.Verdict.APPROVED)</span>
<span class="line-added"> 70                           .map(review -&gt; review.reviewer().id())</span>
 71                           .map(namespace::get)
 72                           .filter(Objects::nonNull)
 73                           .map(Contributor::username)
 74                           .collect(Collectors.toList());
 75 
 76         var additionalContributors = Contributors.contributors(pr.repository().host().getCurrentUserDetails(),
 77                                                                pr.getComments()).stream()
 78                                                  .map(email -&gt; Author.fromString(email.toString()))
 79                                                  .collect(Collectors.toList());
 80 
 81         var commitMessage = CommitMessage.title(isMerge ? &quot;Merge&quot; : pr.getTitle())
 82                                          .contributors(additionalContributors)
 83                                          .reviewers(reviewers);
 84         return String.join(&quot;\n&quot;, commitMessage.format(CommitMessageFormatters.v1));
 85     }
 86 
<span class="line-modified"> 87     private Hash commitSquashed(List&lt;Review&gt; activeReviews, Namespace namespace, String censusDomain, String sponsorId) throws IOException {</span>
 88         localRepo.checkout(baseHash, true);
 89         localRepo.squash(headHash);
 90 
 91         Author committer;
 92         Author author;
 93         var contributor = namespace.get(pr.getAuthor().id());
 94 
 95         if (contributor == null) {
 96             // Use the information contained in the head commit - jcheck has verified that it contains sane values
 97             var headCommit = localRepo.commits(headHash.hex() + &quot;^..&quot; + headHash.hex()).asList().get(0);
 98             author = headCommit.author();
 99         } else {
100             author = new Author(contributor.fullName().orElseThrow(), contributor.username() + &quot;@&quot; + censusDomain);
101         }
102 
103         if (sponsorId != null) {
104             var sponsorContributor = namespace.get(sponsorId);
105             committer = new Author(sponsorContributor.fullName().orElseThrow(), sponsorContributor.username() + &quot;@&quot; + censusDomain);
106         } else {
107             committer = author;
</pre>
<hr />
<pre>
 90 
 91         Author committer;
 92         Author author;
 93         var contributor = namespace.get(pr.getAuthor().id());
 94 
 95         if (contributor == null) {
 96             // Use the information contained in the head commit - jcheck has verified that it contains sane values
 97             var headCommit = localRepo.commits(headHash.hex() + &quot;^..&quot; + headHash.hex()).asList().get(0);
 98             author = headCommit.author();
 99         } else {
100             author = new Author(contributor.fullName().orElseThrow(), contributor.username() + &quot;@&quot; + censusDomain);
101         }
102 
103         if (sponsorId != null) {
104             var sponsorContributor = namespace.get(sponsorId);
105             committer = new Author(sponsorContributor.fullName().orElseThrow(), sponsorContributor.username() + &quot;@&quot; + censusDomain);
106         } else {
107             committer = author;
108         }
109 
<span class="line-modified">110         var commitMessage = commitMessage(activeReviews, namespace, false);</span>
111         return localRepo.commit(commitMessage, author.name(), author.email(), committer.name(), committer.email());
112     }
113 
<span class="line-modified">114     private Hash commitMerge(List&lt;Review&gt; activeReviews, Namespace namespace, String censusDomain) throws IOException {</span>
115         localRepo.checkout(headHash, true);
116 
117         var contributor = namespace.get(pr.getAuthor().id());
118         if (contributor == null) {
119             throw new RuntimeException(&quot;Merges can only be performed by Committers&quot;);
120         }
121 
122         var author = new Author(contributor.fullName().orElseThrow(), contributor.username() + &quot;@&quot; + censusDomain);
123 
<span class="line-modified">124         var commitMessage = commitMessage(activeReviews, namespace, true);</span>
125         return localRepo.amend(commitMessage, author.name(), author.email(), author.name(), author.email());
126     }
127 
128     Hash commit(Namespace namespace, String censusDomain, String sponsorId) throws IOException {
<span class="line-added">129         var activeReviews = filterActiveReviews(pr.getReviews());</span>
130         if (!pr.getTitle().startsWith(&quot;Merge&quot;)) {
<span class="line-modified">131             return commitSquashed(activeReviews, namespace, censusDomain, sponsorId);</span>
132         } else {
<span class="line-modified">133             return commitMerge(activeReviews, namespace, censusDomain);</span>
134         }
135     }
136 
137     List&lt;Commit&gt; divergingCommits() {
138         try {
139             return localRepo.commits(baseHash + &quot;..&quot; + targetHash).asList();
140         } catch (IOException e) {
141             throw new RuntimeException(e);
142         }
143     }
144 
145     boolean rebasePossible(Hash commitHash) {
146         try {
147             var commit = localRepo.lookup(commitHash);
148             if (commit.isEmpty()) {
149                 return false;
150             }
151             localRepo.rebase(targetHash, commit.get().committer().name(), commit.get().committer().email());
152             var hash = localRepo.head();
153             return !hash.hex().equals(targetHash.hex());
</pre>
</td>
</tr>
</table>
<center><a href="CheckWorkItem.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="ReviewTracker.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>