<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/ArchiveWorkItem.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/ArchiveWorkItem.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
162                 &quot;Commits:\n&quot; +
163                 commitMessages + &quot;\n\n&quot; +
164                 &quot;Pull request:\n&quot; +
165                 pr.getWebUrl() + &quot;\n\n&quot; +
166                 &quot;Webrev:\n&quot; +
167                 webrev.toString() + &quot;\n\n&quot; +
168                 &quot;Patch:\n&quot; +
169                 prInstance.diffUrl() + &quot;\n\n&quot; +
170                 &quot;Fetch command:\n&quot; +
171                 prInstance.fetchCommand();
172     }
173 
174     private String composeReply(ZonedDateTime date, EmailAddress author, String parentBody, String body) {
175         return &quot;On &quot; + date.format(DateTimeFormatter.RFC_1123_DATE_TIME) + &quot;, &quot; + author.toString() + &quot; wrote:\n&quot; +
176                 &quot;\n&quot; +
177                 quoteBody(parentBody) +
178                 &quot;\n\n&quot; +
179                 filterComments(body);
180     }
181 

































182     private String composeRebaseComment(Hash lastBase, PullRequestInstance prInstance, URI fullWebrev) {
183         var commitMessages = prInstance.formatCommitMessages(prInstance.baseHash(), prInstance.headHash(), this::formatCommit);
184         return &quot;The pull request has been updated with a complete new set of changes (possibly due to a rebase).\n\n&quot; +
185                 infoSeparator + &quot;\n\n&quot; +
186                 &quot;Commits:\n&quot; +
187                 commitMessages + &quot;\n\n&quot; +
188                 &quot;Pull request:\n&quot; +
189                 pr.getWebUrl() + &quot;\n\n&quot; +
190                 &quot;Webrev:\n&quot; +
191                 fullWebrev.toString() + &quot;\n\n&quot; +
192                 &quot;Updated full patch:\n&quot; +
193                 prInstance.diffUrl() + &quot;\n\n&quot; +
194                 &quot;Fetch command:\n&quot; +
195                 prInstance.fetchCommand();
196     }
197 
198     private String composeIncrementalComment(Hash lastHead, PullRequestInstance prInstance, URI fullWebrev, URI incrementalWebrev) {
199         var newCommitMessages = prInstance.formatCommitMessages(lastHead, prInstance.headHash(), this::formatCommit);
200         return &quot;The pull request has been updated with additional changes.\n\n&quot; +
201                 infoSeparator + &quot;\n\n&quot; +
</pre>
<hr />
<pre>
200         return &quot;The pull request has been updated with additional changes.\n\n&quot; +
201                 infoSeparator + &quot;\n\n&quot; +
202                 &quot;Added commits:\n&quot; +
203                 newCommitMessages + &quot;\n\n&quot; +
204                 &quot;Pull request:\n&quot; +
205                 pr.getWebUrl() + &quot;\n\n&quot; +
206                 &quot;Webrevs:\n&quot; +
207                 &quot; - full: &quot; + fullWebrev.toString() + &quot;\n&quot; +
208                 &quot; - inc: &quot; + incrementalWebrev.toString() + &quot;\n\n&quot; +
209                 &quot;Updated full patch:\n&quot; +
210                 prInstance.diffUrl() + &quot;\n\n&quot; +
211                 &quot;Fetch command:\n&quot; +
212                 prInstance.fetchCommand();
213     }
214 
215     private String composeReadyForIntegrationComment() {
216         return &quot;This PR now fulfills all the requirements for integration, and is only awaiting the final &quot; +
217                 &quot;integration command from the author.&quot;;
218     }
219 
<span class="line-removed">220     private String verdictToString(Review.Verdict verdict) {</span>
<span class="line-removed">221         switch (verdict) {</span>
<span class="line-removed">222             case APPROVED:</span>
<span class="line-removed">223                 return &quot;changes are approved&quot;;</span>
<span class="line-removed">224             case DISAPPROVED:</span>
<span class="line-removed">225                 return &quot;more changes needed&quot;;</span>
<span class="line-removed">226             case NONE:</span>
<span class="line-removed">227                 return &quot;comment added&quot;;</span>
<span class="line-removed">228             default:</span>
<span class="line-removed">229                 throw new RuntimeException(&quot;Unknown verdict: &quot; + verdict);</span>
<span class="line-removed">230         }</span>
<span class="line-removed">231     }</span>
<span class="line-removed">232 </span>
<span class="line-removed">233     private String composeNewReviewVerdict(Review review) {</span>
<span class="line-removed">234         var ret = new StringBuilder();</span>
<span class="line-removed">235         var author = getAuthorAddress(review.reviewer);</span>
<span class="line-removed">236         ret.append(&quot;This PR has now been reviewed by &quot;);</span>
<span class="line-removed">237         ret.append(author.fullName().orElse(author.localPart()));</span>
<span class="line-removed">238         ret.append(&quot; - &quot;);</span>
<span class="line-removed">239         ret.append(verdictToString(review.verdict));</span>
<span class="line-removed">240         ret.append(&quot;.&quot;);</span>
<span class="line-removed">241         return ret.toString();</span>
<span class="line-removed">242     }</span>
<span class="line-removed">243 </span>
<span class="line-removed">244     private String composeUpdatedReviewVerdict(Review review) {</span>
<span class="line-removed">245         var ret = new StringBuilder();</span>
<span class="line-removed">246         var author = getAuthorAddress(review.reviewer);</span>
<span class="line-removed">247         ret.append(&quot;The PR reviewed by &quot;);</span>
<span class="line-removed">248         ret.append(author.fullName().orElse(author.localPart()));</span>
<span class="line-removed">249         ret.append(&quot; has now been updated - &quot;);</span>
<span class="line-removed">250         ret.append(verdictToString(review.verdict));</span>
<span class="line-removed">251         ret.append(&quot;.&quot;);</span>
<span class="line-removed">252         return ret.toString();</span>
<span class="line-removed">253     }</span>
<span class="line-removed">254 </span>
255     private Repository materializeArchive(Path scratchPath) {
256         try {
257             return Repository.materialize(scratchPath, bot.archiveRepo().getUrl(), pr.getTargetRef());
258         } catch (IOException e) {
259             throw new UncheckedIOException(e);
260         }
261     }
262 
263     private final static Pattern commandPattern = Pattern.compile(&quot;^/.*$&quot;);
264 
265     private boolean ignoreComment(HostUserDetails author, String body) {
266         if (pr.repository().host().getCurrentUserDetails().equals(author)) {
267             return true;
268         }
269         if (bot.ignoredUsers().contains(author.userName())) {
270             return true;
271         }
272         var commandMatcher = commandPattern.matcher(body);
273         if (commandMatcher.matches()) {
274             return true;
</pre>
<hr />
<pre>
297     private EmailAddress getMessageId() {
298         return getUniqueMessageId(&quot;fc&quot;);
299     }
300 
301     private EmailAddress getMessageId(Comment comment) {
302         return getUniqueMessageId(&quot;pc&quot; + comment.id());
303     }
304 
305     private EmailAddress getMessageId(ReviewComment comment) {
306         return getUniqueMessageId(&quot;rc&quot; + comment.id());
307     }
308 
309     private EmailAddress getMessageId(Hash hash) {
310         return getUniqueMessageId(&quot;ha&quot; + hash.hex());
311     }
312 
313     private EmailAddress getMessageId(String raw) {
314         return getUniqueMessageId(&quot;rw&quot; + raw);
315     }
316 
<span class="line-modified">317     private EmailAddress getMessageId(HostUserDetails reviewer, String verdict, int reviewCount) {</span>
<span class="line-modified">318         return getUniqueMessageId(&quot;vd&quot; + reviewer.id() + &quot;;&quot; + verdict + &quot;;&quot; + reviewCount);</span>
319     }
320 
321     private EmailAddress getAuthorAddress(HostUserDetails originalAuthor) {
322         return EmailAddress.from(originalAuthor.fullName() + &quot; via &quot; + pr.repository().getUrl().getHost(),
323                                  bot.emailAddress().address());
324     }
325 
326     private Email newConversation(PullRequestInstance prInstance, URI webrev) {
327         var body = composeConversation(pr.getBody(), prInstance, webrev);
328         var email = Email.create(getAuthorAddress(pr.getAuthor()), &quot;RFR: &quot; + pr.getTitle(), body)
329                          .sender(bot.emailAddress())
330                          .id(getMessageId())
331                          .header(&quot;PR-Head-Hash&quot;, prInstance.headHash().hex())
332                          .header(&quot;PR-Base-Hash&quot;, prInstance.baseHash().hex())
333                          .build();
334         return email;
335     }
336 
337 
338     private Email comment(Email parent, Comment comment) {
</pre>
<hr />
<pre>
335     }
336 
337 
338     private Email comment(Email parent, Comment comment) {
339         var reply = composeReply(parent.date(), parent.author(), parent.body(), comment.body());
340         var references = parent.id().toString();
341         if (parent.hasHeader(&quot;References&quot;)) {
342             references = parent.headerValue(&quot;References&quot;) + &quot; &quot; + references;
343         }
344 
345         var email = Email.create(getAuthorAddress(comment.author()), &quot;Re: RFR: &quot; + pr.getTitle(), reply)
346                          .sender(bot.emailAddress())
347                          .recipient(parent.author())
348                          .id(getMessageId(comment))
349                          .header(&quot;In-Reply-To&quot;, parent.id().toString())
350                          .header(&quot;References&quot;, references)
351                          .build();
352         return email;
353     }
354 













355     private Email reviewComment(Email parent, ReviewComment comment) {
356         var body = new StringBuilder();
357 
358         // Add some context to the first post
359         if (comment.parent().isEmpty()) {
360             var contents = pr.repository().getFileContents(comment.path(), comment.hash().hex()).lines().collect(Collectors.toList());
361 
362             body.append(comment.path()).append(&quot; line &quot;).append(comment.line()).append(&quot;:\n\n&quot;);
363             for (int i = Math.max(0, comment.line() - 2); i &lt; Math.min(contents.size(), comment.line() + 1); ++i) {
364                 body.append(&quot;&gt; &quot;).append(i + 1).append(&quot;: &quot;).append(contents.get(i)).append(&quot;\n&quot;);
365             }
366             body.append(&quot;\n&quot;);
367         }
368         body.append(comment.body());
369 
370         var reply = composeReply(parent.date(), parent.author(), parent.body(), body.toString());
371         var references = parent.id().toString();
372         if (parent.hasHeader(&quot;References&quot;)) {
373             references = parent.headerValue(&quot;References&quot;) + &quot; &quot; + references;
374         }
</pre>
<hr />
<pre>
407                          .header(&quot;References&quot;, parent.id().toString())
408                          .header(&quot;PR-Head-Hash&quot;, prInstance.headHash().hex())
409                          .header(&quot;PR-Base-Hash&quot;, prInstance.baseHash().hex())
410                          .build();
411         return email;
412     }
413 
414     private Email readyForIntegrationComment(Email parent, Set&lt;String&gt; currentLabels, int numLabelComments) {
415         var body = composeReadyForIntegrationComment();
416         var email = Email.create(getAuthorAddress(pr.getAuthor()), &quot;Re: RFR: &quot; + pr.getTitle(), body)
417                          .sender(bot.emailAddress())
418                          .recipient(parent.author())
419                          .id(getMessageId(&quot;labelcomment&quot; + numLabelComments))
420                          .header(&quot;In-Reply-To&quot;, parent.id().toString())
421                          .header(&quot;References&quot;, parent.id().toString())
422                          .header(&quot;PR-Labels&quot;, String.join(&quot;;&quot;, currentLabels))
423                          .build();
424         return email;
425     }
426 
<span class="line-removed">427     private Email reviewVerdictComment(Email parent, HostUserDetails reviewer, String verdict, int reviewCount, String body) {</span>
<span class="line-removed">428         var email = Email.create(getAuthorAddress(reviewer), &quot;Re: RFR: &quot; + pr.getTitle(), body)</span>
<span class="line-removed">429                          .sender(bot.emailAddress())</span>
<span class="line-removed">430                          .recipient(parent.author())</span>
<span class="line-removed">431                          .id(getMessageId(reviewer, verdict, reviewCount))</span>
<span class="line-removed">432                          .header(&quot;In-Reply-To&quot;, parent.id().toString())</span>
<span class="line-removed">433                          .header(&quot;References&quot;, parent.id().toString())</span>
<span class="line-removed">434                          .header(&quot;PR-Review-Verdict&quot;, reviewer.id() + &quot;;&quot; + verdict)</span>
<span class="line-removed">435                          .build();</span>
<span class="line-removed">436         return email;</span>
<span class="line-removed">437 </span>
<span class="line-removed">438     }</span>
<span class="line-removed">439 </span>
<span class="line-removed">440     private List&lt;Email&gt; getReviewVerdictMails(Email parent, List&lt;Email&gt; archiveMails) {</span>
<span class="line-removed">441         // Determine the latest reported reviews</span>
<span class="line-removed">442         var ret = new ArrayList&lt;Email&gt;();</span>
<span class="line-removed">443         var reportedReviews = archiveMails.stream()</span>
<span class="line-removed">444                                           .filter(email -&gt; email.hasHeader(&quot;PR-Review-Verdict&quot;))</span>
<span class="line-removed">445                                           .map(email -&gt; email.headerValue(&quot;PR-Review-Verdict&quot;))</span>
<span class="line-removed">446                                           .collect(Collectors.toMap(</span>
<span class="line-removed">447                                                   value -&gt; value.substring(0, value.indexOf(&quot;;&quot;)),</span>
<span class="line-removed">448                                                   value -&gt; value.substring(value.indexOf(&quot;;&quot;) + 1),</span>
<span class="line-removed">449                                                   (a, b) -&gt; b)</span>
<span class="line-removed">450                                           );</span>
<span class="line-removed">451         var reviews = pr.getReviews();</span>
<span class="line-removed">452         var newReviews = reviews.stream()</span>
<span class="line-removed">453                                 .filter(review -&gt; !reportedReviews.containsKey(review.reviewer.id()))</span>
<span class="line-removed">454                                 .collect(Collectors.toList());</span>
<span class="line-removed">455         var updatedReviews = reviews.stream()</span>
<span class="line-removed">456                                     .filter(review -&gt; reportedReviews.containsKey(review.reviewer.id()))</span>
<span class="line-removed">457                                     .filter(review -&gt; !reportedReviews.get(review.reviewer.id()).equals(review.verdict.toString()))</span>
<span class="line-removed">458                                     .collect(Collectors.toList());</span>
<span class="line-removed">459 </span>
<span class="line-removed">460         for (var newReview : newReviews) {</span>
<span class="line-removed">461             var body = composeNewReviewVerdict(newReview);</span>
<span class="line-removed">462             ret.add(reviewVerdictComment(parent, newReview.reviewer, newReview.verdict.toString(), reportedReviews.size(), body));</span>
<span class="line-removed">463         }</span>
<span class="line-removed">464         for (var updatedReview : updatedReviews) {</span>
<span class="line-removed">465             var body = composeUpdatedReviewVerdict(updatedReview);</span>
<span class="line-removed">466             ret.add(reviewVerdictComment(parent, updatedReview.reviewer, updatedReview.verdict.toString(), reportedReviews.size(), body));</span>
<span class="line-removed">467         }</span>
<span class="line-removed">468         return ret;</span>
<span class="line-removed">469     }</span>
<span class="line-removed">470 </span>
471     private List&lt;Email&gt; parseArchive(MailingList archive) {
472         var conversations = archive.conversations(Duration.ofDays(365));
473 
474         if (conversations.size() == 0) {
475             return new ArrayList&lt;&gt;();
476         } else if (conversations.size() == 1) {
477             var conversation = conversations.get(0);
478             return conversation.allMessages();
479         } else {
480             throw new RuntimeException(&quot;Something is wrong with the mbox&quot;);
481         }
482     }
483 
484     private Map&lt;Email, Email&gt; findParents(Map&lt;EmailAddress, Email&gt; emailIds) {
485         var parents = new HashMap&lt;Email, Email&gt;();
486         for (var entry : emailIds.entrySet()) {
487             if (entry.getValue().hasHeader(&quot;In-Reply-To&quot;)) {
488                 var replyId = EmailAddress.parse(entry.getValue().headerValue(&quot;In-Reply-To&quot;));
489             }
490         }
</pre>
<hr />
<pre>
655             var id = getStableMessageId(getMessageId(comment));
656             if (stableIdToMail.containsKey(id)) {
657                 previous = stableIdToMail.get(id);
658                 continue;
659             }
660             if (ignoreComment(comment.author(), comment.body())) {
661                 continue;
662             }
663 
664             // Try to determine a parent post from @mentions
665             var parentComment = getParentPost(comment, comments);
666             var parent = parentComment.map(c -&gt; stableIdToMail.get(getStableMessageId(getMessageId(c)))).orElse(previous);
667 
668             var commentMail = comment(parent, comment);
669             archive.post(commentMail);
670             newMails.add(commentMail);
671             stableIdToMail.put(getStableMessageId(commentMail.id()), commentMail);
672             previous = commentMail;
673         }
674 
<span class="line-modified">675         // File specific comments</span>
676         final var first = archiveMails.size() &gt; 0 ? archiveMails.get(0) : newMails.get(0);


















677         var reviewComments = pr.getReviewComments();
678         for (var reviewComment : reviewComments) {
679             var id = getStableMessageId(getMessageId(reviewComment));
680             if (stableIdToMail.containsKey(id)) {
681                 continue;
682             }
683             if (ignoreComment(reviewComment.author(), reviewComment.body())) {
684                 continue;
685             }
686 
687             var parent = reviewComment.parent().map(c -&gt; stableIdToMail.get(getStableMessageId(getMessageId(c)))).orElse(first);
688             var commentMail = reviewComment(parent, reviewComment);
689             archive.post(commentMail);
690             newMails.add(commentMail);
691             stableIdToMail.put(getStableMessageId(commentMail.id()), commentMail);
692         }
693 
<span class="line-removed">694         // Review verdicts</span>
<span class="line-removed">695         var reviewVerdictMails = getReviewVerdictMails(first, archiveMails);</span>
<span class="line-removed">696         for (var reviewVerdictMail : reviewVerdictMails) {</span>
<span class="line-removed">697             archive.post(reviewVerdictMail);</span>
<span class="line-removed">698             newMails.add(reviewVerdictMail);</span>
<span class="line-removed">699             stableIdToMail.put(getStableMessageId(reviewVerdictMail.id()), reviewVerdictMail);</span>
<span class="line-removed">700         }</span>
<span class="line-removed">701 </span>
702         if (newMails.isEmpty()) {
703             return;
704         }
705 
706         // Push all new mails to the archive repository
707         pushMbox(archiveRepo, &quot;Adding comments for PR &quot; + bot.codeRepo().getName() + &quot;/&quot; + pr.getId());
708 
709         // Combine and post all new mails to the list
710         var listMails = combineMails(newMails);
711         for (var mail : listMails) {
712             list.post(mail);
713         }
714     }
715 }
</pre>
</td>
<td>
<hr />
<pre>
162                 &quot;Commits:\n&quot; +
163                 commitMessages + &quot;\n\n&quot; +
164                 &quot;Pull request:\n&quot; +
165                 pr.getWebUrl() + &quot;\n\n&quot; +
166                 &quot;Webrev:\n&quot; +
167                 webrev.toString() + &quot;\n\n&quot; +
168                 &quot;Patch:\n&quot; +
169                 prInstance.diffUrl() + &quot;\n\n&quot; +
170                 &quot;Fetch command:\n&quot; +
171                 prInstance.fetchCommand();
172     }
173 
174     private String composeReply(ZonedDateTime date, EmailAddress author, String parentBody, String body) {
175         return &quot;On &quot; + date.format(DateTimeFormatter.RFC_1123_DATE_TIME) + &quot;, &quot; + author.toString() + &quot; wrote:\n&quot; +
176                 &quot;\n&quot; +
177                 quoteBody(parentBody) +
178                 &quot;\n\n&quot; +
179                 filterComments(body);
180     }
181 
<span class="line-added">182     private String verdictToString(Review.Verdict verdict) {</span>
<span class="line-added">183         switch (verdict) {</span>
<span class="line-added">184             case APPROVED:</span>
<span class="line-added">185                 return &quot;changes are approved&quot;;</span>
<span class="line-added">186             case DISAPPROVED:</span>
<span class="line-added">187                 return &quot;more changes are needed&quot;;</span>
<span class="line-added">188             case NONE:</span>
<span class="line-added">189                 return &quot;a comment has been added&quot;;</span>
<span class="line-added">190             default:</span>
<span class="line-added">191                 throw new RuntimeException(&quot;Unknown verdict: &quot; + verdict);</span>
<span class="line-added">192         }</span>
<span class="line-added">193     }</span>
<span class="line-added">194 </span>
<span class="line-added">195     private String composeReview(ZonedDateTime date, EmailAddress parentAuthor, String parentBody, Review review) {</span>
<span class="line-added">196         var body = new StringBuilder();</span>
<span class="line-added">197         var author = getAuthorAddress(review.reviewer());</span>
<span class="line-added">198         body.append(&quot;This PR has been reviewed by &quot;);</span>
<span class="line-added">199         body.append(author.fullName().orElse(author.localPart()));</span>
<span class="line-added">200         body.append(&quot; - &quot;);</span>
<span class="line-added">201         body.append(verdictToString(review.verdict()));</span>
<span class="line-added">202         body.append(&quot;.&quot;);</span>
<span class="line-added">203         if (review.body().isPresent()) {</span>
<span class="line-added">204             body.append(&quot; Review comment:\n\n&quot;);</span>
<span class="line-added">205             body.append(review.body().get());</span>
<span class="line-added">206         }</span>
<span class="line-added">207 </span>
<span class="line-added">208         return &quot;On &quot; + date.format(DateTimeFormatter.RFC_1123_DATE_TIME) + &quot;, &quot; + parentAuthor.toString() + &quot; wrote:\n&quot; +</span>
<span class="line-added">209                 &quot;\n&quot; +</span>
<span class="line-added">210                 quoteBody(parentBody) +</span>
<span class="line-added">211                 &quot;\n\n&quot; +</span>
<span class="line-added">212                 filterComments(body.toString());</span>
<span class="line-added">213     }</span>
<span class="line-added">214 </span>
215     private String composeRebaseComment(Hash lastBase, PullRequestInstance prInstance, URI fullWebrev) {
216         var commitMessages = prInstance.formatCommitMessages(prInstance.baseHash(), prInstance.headHash(), this::formatCommit);
217         return &quot;The pull request has been updated with a complete new set of changes (possibly due to a rebase).\n\n&quot; +
218                 infoSeparator + &quot;\n\n&quot; +
219                 &quot;Commits:\n&quot; +
220                 commitMessages + &quot;\n\n&quot; +
221                 &quot;Pull request:\n&quot; +
222                 pr.getWebUrl() + &quot;\n\n&quot; +
223                 &quot;Webrev:\n&quot; +
224                 fullWebrev.toString() + &quot;\n\n&quot; +
225                 &quot;Updated full patch:\n&quot; +
226                 prInstance.diffUrl() + &quot;\n\n&quot; +
227                 &quot;Fetch command:\n&quot; +
228                 prInstance.fetchCommand();
229     }
230 
231     private String composeIncrementalComment(Hash lastHead, PullRequestInstance prInstance, URI fullWebrev, URI incrementalWebrev) {
232         var newCommitMessages = prInstance.formatCommitMessages(lastHead, prInstance.headHash(), this::formatCommit);
233         return &quot;The pull request has been updated with additional changes.\n\n&quot; +
234                 infoSeparator + &quot;\n\n&quot; +
</pre>
<hr />
<pre>
233         return &quot;The pull request has been updated with additional changes.\n\n&quot; +
234                 infoSeparator + &quot;\n\n&quot; +
235                 &quot;Added commits:\n&quot; +
236                 newCommitMessages + &quot;\n\n&quot; +
237                 &quot;Pull request:\n&quot; +
238                 pr.getWebUrl() + &quot;\n\n&quot; +
239                 &quot;Webrevs:\n&quot; +
240                 &quot; - full: &quot; + fullWebrev.toString() + &quot;\n&quot; +
241                 &quot; - inc: &quot; + incrementalWebrev.toString() + &quot;\n\n&quot; +
242                 &quot;Updated full patch:\n&quot; +
243                 prInstance.diffUrl() + &quot;\n\n&quot; +
244                 &quot;Fetch command:\n&quot; +
245                 prInstance.fetchCommand();
246     }
247 
248     private String composeReadyForIntegrationComment() {
249         return &quot;This PR now fulfills all the requirements for integration, and is only awaiting the final &quot; +
250                 &quot;integration command from the author.&quot;;
251     }
252 



































253     private Repository materializeArchive(Path scratchPath) {
254         try {
255             return Repository.materialize(scratchPath, bot.archiveRepo().getUrl(), pr.getTargetRef());
256         } catch (IOException e) {
257             throw new UncheckedIOException(e);
258         }
259     }
260 
261     private final static Pattern commandPattern = Pattern.compile(&quot;^/.*$&quot;);
262 
263     private boolean ignoreComment(HostUserDetails author, String body) {
264         if (pr.repository().host().getCurrentUserDetails().equals(author)) {
265             return true;
266         }
267         if (bot.ignoredUsers().contains(author.userName())) {
268             return true;
269         }
270         var commandMatcher = commandPattern.matcher(body);
271         if (commandMatcher.matches()) {
272             return true;
</pre>
<hr />
<pre>
295     private EmailAddress getMessageId() {
296         return getUniqueMessageId(&quot;fc&quot;);
297     }
298 
299     private EmailAddress getMessageId(Comment comment) {
300         return getUniqueMessageId(&quot;pc&quot; + comment.id());
301     }
302 
303     private EmailAddress getMessageId(ReviewComment comment) {
304         return getUniqueMessageId(&quot;rc&quot; + comment.id());
305     }
306 
307     private EmailAddress getMessageId(Hash hash) {
308         return getUniqueMessageId(&quot;ha&quot; + hash.hex());
309     }
310 
311     private EmailAddress getMessageId(String raw) {
312         return getUniqueMessageId(&quot;rw&quot; + raw);
313     }
314 
<span class="line-modified">315     private EmailAddress getMessageId(Review review) {</span>
<span class="line-modified">316         return getUniqueMessageId(&quot;rv&quot; + review.id());</span>
317     }
318 
319     private EmailAddress getAuthorAddress(HostUserDetails originalAuthor) {
320         return EmailAddress.from(originalAuthor.fullName() + &quot; via &quot; + pr.repository().getUrl().getHost(),
321                                  bot.emailAddress().address());
322     }
323 
324     private Email newConversation(PullRequestInstance prInstance, URI webrev) {
325         var body = composeConversation(pr.getBody(), prInstance, webrev);
326         var email = Email.create(getAuthorAddress(pr.getAuthor()), &quot;RFR: &quot; + pr.getTitle(), body)
327                          .sender(bot.emailAddress())
328                          .id(getMessageId())
329                          .header(&quot;PR-Head-Hash&quot;, prInstance.headHash().hex())
330                          .header(&quot;PR-Base-Hash&quot;, prInstance.baseHash().hex())
331                          .build();
332         return email;
333     }
334 
335 
336     private Email comment(Email parent, Comment comment) {
</pre>
<hr />
<pre>
333     }
334 
335 
336     private Email comment(Email parent, Comment comment) {
337         var reply = composeReply(parent.date(), parent.author(), parent.body(), comment.body());
338         var references = parent.id().toString();
339         if (parent.hasHeader(&quot;References&quot;)) {
340             references = parent.headerValue(&quot;References&quot;) + &quot; &quot; + references;
341         }
342 
343         var email = Email.create(getAuthorAddress(comment.author()), &quot;Re: RFR: &quot; + pr.getTitle(), reply)
344                          .sender(bot.emailAddress())
345                          .recipient(parent.author())
346                          .id(getMessageId(comment))
347                          .header(&quot;In-Reply-To&quot;, parent.id().toString())
348                          .header(&quot;References&quot;, references)
349                          .build();
350         return email;
351     }
352 
<span class="line-added">353     private Email review(Email parent, Review review) {</span>
<span class="line-added">354         var body = composeReview(parent.date(), parent.author(), parent.body(), review);</span>
<span class="line-added">355         var email = Email.create(getAuthorAddress(review.reviewer()), &quot;Re: RFR: &quot; + pr.getTitle(), body)</span>
<span class="line-added">356                          .sender(bot.emailAddress())</span>
<span class="line-added">357                          .recipient(parent.author())</span>
<span class="line-added">358                          .id(getMessageId(review))</span>
<span class="line-added">359                          .header(&quot;In-Reply-To&quot;, parent.id().toString())</span>
<span class="line-added">360                          .header(&quot;References&quot;, parent.id().toString())</span>
<span class="line-added">361                          .build();</span>
<span class="line-added">362         return email;</span>
<span class="line-added">363 </span>
<span class="line-added">364     }</span>
<span class="line-added">365 </span>
366     private Email reviewComment(Email parent, ReviewComment comment) {
367         var body = new StringBuilder();
368 
369         // Add some context to the first post
370         if (comment.parent().isEmpty()) {
371             var contents = pr.repository().getFileContents(comment.path(), comment.hash().hex()).lines().collect(Collectors.toList());
372 
373             body.append(comment.path()).append(&quot; line &quot;).append(comment.line()).append(&quot;:\n\n&quot;);
374             for (int i = Math.max(0, comment.line() - 2); i &lt; Math.min(contents.size(), comment.line() + 1); ++i) {
375                 body.append(&quot;&gt; &quot;).append(i + 1).append(&quot;: &quot;).append(contents.get(i)).append(&quot;\n&quot;);
376             }
377             body.append(&quot;\n&quot;);
378         }
379         body.append(comment.body());
380 
381         var reply = composeReply(parent.date(), parent.author(), parent.body(), body.toString());
382         var references = parent.id().toString();
383         if (parent.hasHeader(&quot;References&quot;)) {
384             references = parent.headerValue(&quot;References&quot;) + &quot; &quot; + references;
385         }
</pre>
<hr />
<pre>
418                          .header(&quot;References&quot;, parent.id().toString())
419                          .header(&quot;PR-Head-Hash&quot;, prInstance.headHash().hex())
420                          .header(&quot;PR-Base-Hash&quot;, prInstance.baseHash().hex())
421                          .build();
422         return email;
423     }
424 
425     private Email readyForIntegrationComment(Email parent, Set&lt;String&gt; currentLabels, int numLabelComments) {
426         var body = composeReadyForIntegrationComment();
427         var email = Email.create(getAuthorAddress(pr.getAuthor()), &quot;Re: RFR: &quot; + pr.getTitle(), body)
428                          .sender(bot.emailAddress())
429                          .recipient(parent.author())
430                          .id(getMessageId(&quot;labelcomment&quot; + numLabelComments))
431                          .header(&quot;In-Reply-To&quot;, parent.id().toString())
432                          .header(&quot;References&quot;, parent.id().toString())
433                          .header(&quot;PR-Labels&quot;, String.join(&quot;;&quot;, currentLabels))
434                          .build();
435         return email;
436     }
437 












































438     private List&lt;Email&gt; parseArchive(MailingList archive) {
439         var conversations = archive.conversations(Duration.ofDays(365));
440 
441         if (conversations.size() == 0) {
442             return new ArrayList&lt;&gt;();
443         } else if (conversations.size() == 1) {
444             var conversation = conversations.get(0);
445             return conversation.allMessages();
446         } else {
447             throw new RuntimeException(&quot;Something is wrong with the mbox&quot;);
448         }
449     }
450 
451     private Map&lt;Email, Email&gt; findParents(Map&lt;EmailAddress, Email&gt; emailIds) {
452         var parents = new HashMap&lt;Email, Email&gt;();
453         for (var entry : emailIds.entrySet()) {
454             if (entry.getValue().hasHeader(&quot;In-Reply-To&quot;)) {
455                 var replyId = EmailAddress.parse(entry.getValue().headerValue(&quot;In-Reply-To&quot;));
456             }
457         }
</pre>
<hr />
<pre>
622             var id = getStableMessageId(getMessageId(comment));
623             if (stableIdToMail.containsKey(id)) {
624                 previous = stableIdToMail.get(id);
625                 continue;
626             }
627             if (ignoreComment(comment.author(), comment.body())) {
628                 continue;
629             }
630 
631             // Try to determine a parent post from @mentions
632             var parentComment = getParentPost(comment, comments);
633             var parent = parentComment.map(c -&gt; stableIdToMail.get(getStableMessageId(getMessageId(c)))).orElse(previous);
634 
635             var commentMail = comment(parent, comment);
636             archive.post(commentMail);
637             newMails.add(commentMail);
638             stableIdToMail.put(getStableMessageId(commentMail.id()), commentMail);
639             previous = commentMail;
640         }
641 
<span class="line-modified">642         // Review comments</span>
643         final var first = archiveMails.size() &gt; 0 ? archiveMails.get(0) : newMails.get(0);
<span class="line-added">644         var reviews = pr.getReviews();</span>
<span class="line-added">645         for (var review : reviews) {</span>
<span class="line-added">646             var id = getStableMessageId(getMessageId(review));</span>
<span class="line-added">647             if (stableIdToMail.containsKey(id)) {</span>
<span class="line-added">648                 continue;</span>
<span class="line-added">649             }</span>
<span class="line-added">650             if (ignoreComment(review.reviewer(), review.body().orElse(&quot;&quot;))) {</span>
<span class="line-added">651                 continue;</span>
<span class="line-added">652             }</span>
<span class="line-added">653 </span>
<span class="line-added">654             var commentMail = review(first, review);</span>
<span class="line-added">655             archive.post(commentMail);</span>
<span class="line-added">656             newMails.add(commentMail);</span>
<span class="line-added">657             stableIdToMail.put(getStableMessageId(commentMail.id()), commentMail);</span>
<span class="line-added">658         }</span>
<span class="line-added">659 </span>
<span class="line-added">660 </span>
<span class="line-added">661         // File specific comments</span>
662         var reviewComments = pr.getReviewComments();
663         for (var reviewComment : reviewComments) {
664             var id = getStableMessageId(getMessageId(reviewComment));
665             if (stableIdToMail.containsKey(id)) {
666                 continue;
667             }
668             if (ignoreComment(reviewComment.author(), reviewComment.body())) {
669                 continue;
670             }
671 
672             var parent = reviewComment.parent().map(c -&gt; stableIdToMail.get(getStableMessageId(getMessageId(c)))).orElse(first);
673             var commentMail = reviewComment(parent, reviewComment);
674             archive.post(commentMail);
675             newMails.add(commentMail);
676             stableIdToMail.put(getStableMessageId(commentMail.id()), commentMail);
677         }
678 








679         if (newMails.isEmpty()) {
680             return;
681         }
682 
683         // Push all new mails to the archive repository
684         pushMbox(archiveRepo, &quot;Adding comments for PR &quot; + bot.codeRepo().getName() + &quot;/&quot; + pr.getId());
685 
686         // Combine and post all new mails to the list
687         var listMails = combineMails(newMails);
688         for (var mail : listMails) {
689             list.post(mail);
690         }
691     }
692 }
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>