<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/pr/src/test/java/org/openjdk/skara/bots/pr/MergeTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="IntegrateTests.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="SponsorTests.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/pr/src/test/java/org/openjdk/skara/bots/pr/MergeTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 62                                                                 &quot;First other\n\nReviewed-by: integrationreviewer2&quot;);
 63             localRepo.push(otherHash1, author.getUrl(), &quot;other&quot;, true);
 64             var otherHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Second change in other&quot;,
 65                                                                 &quot;Second other\n\nReviewed-by: integrationreviewer2&quot;);
 66             localRepo.push(otherHash2, author.getUrl(), &quot;other&quot;);
 67 
 68             // Go back to the original master
 69             localRepo.checkout(masterHash, true);
 70 
 71             // Make a change with a corresponding PR
 72             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
 73             localRepo.add(unrelated);
 74             localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);
 75             localRepo.merge(otherHash2);
 76             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
 77             localRepo.push(mergeHash, author.getUrl(), &quot;edit&quot;, true);
 78             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + credentials.getHostedRepository().getName() + &quot;:other&quot;);
 79 
 80             // Approve it as another user
 81             var approvalPr = integrator.getPullRequest(pr.getId());
<span class="line-modified"> 82             approvalPr.addReview(Review.Verdict.APPROVED);</span>
 83 
 84             // Let the bot check the status
 85             TestBotRunner.runPeriodicItems(mergeBot);
 86 
 87             // Push it
 88             pr.addComment(&quot;/integrate&quot;);
 89             TestBotRunner.runPeriodicItems(mergeBot);
 90 
 91             // The bot should reply with an ok message
 92             var pushed = pr.getComments().stream()
 93                            .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
 94                            .count();
 95             assertEquals(1, pushed);
 96 
 97             // The change should now be present on the master branch
 98             var pushedRepoFolder = tempFolder.path().resolve(&quot;pushedrepo&quot;);
 99             var pushedRepo = Repository.materialize(pushedRepoFolder, author.getUrl(), &quot;master&quot;);
100             assertTrue(CheckableRepository.hasBeenEdited(pushedRepo));
101 
102             // The commits from the &quot;other&quot; branch should be preserved and not squashed (but not the merge commit)
</pre>
<hr />
<pre>
141                                                                  &quot;First other\n\nReviewed-by: integrationreviewer2&quot;);
142             localRepo.push(otherHash1, author.getUrl(), &quot;other&quot;, true);
143             var otherHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Second change in other&quot;,
144                                                                  &quot;Second other\n\nReviewed-by: integrationreviewer2&quot;);
145             localRepo.push(otherHash2, author.getUrl(), &quot;other&quot;);
146 
147             // Go back to the original master
148             localRepo.checkout(masterHash, true);
149 
150             // Make a change with a corresponding PR
151             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
152             localRepo.add(unrelated);
153             var updatedMaster = localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);
154             localRepo.merge(otherHash2);
155             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
156             localRepo.push(mergeHash, author.getUrl(), &quot;edit&quot;, true);
157             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + credentials.getHostedRepository().getName() + &quot;:other&quot;);
158 
159             // Approve it as another user
160             var approvalPr = integrator.getPullRequest(pr.getId());
<span class="line-modified">161             approvalPr.addReview(Review.Verdict.APPROVED);</span>
162 
163             // Let the bot check the status
164             TestBotRunner.runPeriodicItems(mergeBot);
165 
166             // Push something new to master
167             localRepo.checkout(updatedMaster, true);
168             var newMaster = Files.writeString(localRepo.root().resolve(&quot;newmaster.txt&quot;), &quot;New on master&quot;, StandardCharsets.UTF_8);
169             localRepo.add(newMaster);
170             var newMasterHash = localRepo.commit(&quot;New commit on master&quot;, &quot;some&quot;, &quot;some@one&quot;);
171             localRepo.push(newMasterHash, author.getUrl(), &quot;master&quot;);
172 
173             // Let the bot notice
174             TestBotRunner.runPeriodicItems(mergeBot);
175 
176             // Push it
177             pr.addComment(&quot;/integrate&quot;);
178             TestBotRunner.runPeriodicItems(mergeBot);
179 
180             // The bot should reply with an ok message
181             var pushed = pr.getComments().stream()
</pre>
<hr />
<pre>
227 
228             // Make a change in another branch that will not pass jcheck
229             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Change in other&quot;,
230                                                                 &quot;Unreviewed change in other&quot;);
231             localRepo.push(otherHash, author.getUrl(), &quot;other&quot;, true);
232 
233             // Go back to the original master
234             localRepo.checkout(masterHash, true);
235 
236             // Make a change with a corresponding PR
237             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
238             localRepo.add(unrelated);
239             localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);
240             localRepo.merge(otherHash);
241             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
242             localRepo.push(mergeHash, author.getUrl(), &quot;edit&quot;, true);
243             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + credentials.getHostedRepository().getName() + &quot;:other&quot;);
244 
245             // Approve it as another user
246             var approvalPr = integrator.getPullRequest(pr.getId());
<span class="line-modified">247             approvalPr.addReview(Review.Verdict.APPROVED);</span>
248 
249             // Let the bot check the status
250             TestBotRunner.runPeriodicItems(mergeBot);
251 
252             // Push it
253             pr.addComment(&quot;/integrate&quot;);
254             TestBotRunner.runPeriodicItems(mergeBot);
255 
256             // The bot should reply with a failure message
257             var error = pr.getComments().stream()
258                           .filter(comment -&gt; comment.body().contains(&quot;did not complete successfully&quot;))
259                           .count();
260             assertEquals(1, error, () -&gt; pr.getComments().stream().map(Comment::body).collect(Collectors.joining(&quot;\n\n&quot;)));
261         }
262     }
263 
264     @Test
265     void invalidSourceRepo(TestInfo testInfo) throws IOException {
266         try (var credentials = new HostCredentials(testInfo);
267              var tempFolder = new TemporaryDirectory()) {
</pre>
<hr />
<pre>
282 
283             // Make a change in another branch
284             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Change in other&quot;,
285                                                                 &quot;Other\n\nReviewed-by: integrationreviewer2&quot;);
286             localRepo.push(otherHash, author.getUrl(), &quot;other&quot;, true);
287 
288             // Go back to the original master
289             localRepo.checkout(masterHash, true);
290 
291             // Make a change with a corresponding PR
292             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
293             localRepo.add(unrelated);
294             localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);
295             localRepo.merge(otherHash);
296             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
297             localRepo.push(mergeHash, author.getUrl(), &quot;edit&quot;, true);
298             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + credentials.getHostedRepository().getName() + &quot;xyz&quot; + &quot;:other&quot;);
299 
300             // Approve it as another user
301             var approvalPr = integrator.getPullRequest(pr.getId());
<span class="line-modified">302             approvalPr.addReview(Review.Verdict.APPROVED);</span>
303 
304             // Let the bot check the status
305             TestBotRunner.runPeriodicItems(mergeBot);
306 
307             // Push it
308             pr.addComment(&quot;/integrate&quot;);
309             TestBotRunner.runPeriodicItems(mergeBot);
310 
311             // The bot should reply with a failure message
312             var error = pr.getComments().stream()
313                           .filter(comment -&gt; comment.body().contains(&quot;did not complete successfully&quot;))
314                           .count();
315             assertEquals(1, error, () -&gt; pr.getComments().stream().map(Comment::body).collect(Collectors.joining(&quot;\n\n&quot;)));
316 
317             var check = pr.getChecks(mergeHash).get(&quot;jcheck&quot;);
318             assertEquals(&quot;- Could not fetch branch `other` from project `&quot; + credentials.getHostedRepository().getName() + &quot;xyz` - check that they are correct.&quot;, check.summary().orElseThrow());
319         }
320     }
321 
322     @Test
</pre>
<hr />
<pre>
340 
341             // Make a change in another branch
342             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Change in other&quot;,
343                                                                 &quot;Other\n\nReviewed-by: integrationreviewer2&quot;);
344             localRepo.push(otherHash, author.getUrl(), &quot;other&quot;, true);
345 
346             // Go back to the original master
347             localRepo.checkout(masterHash, true);
348 
349             // Make a change with a corresponding PR
350             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
351             localRepo.add(unrelated);
352             localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);
353             localRepo.merge(otherHash);
354             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
355             localRepo.push(mergeHash, author.getUrl(), &quot;edit&quot;, true);
356             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + credentials.getHostedRepository().getName() + &quot;:otherxyz&quot;);
357 
358             // Approve it as another user
359             var approvalPr = integrator.getPullRequest(pr.getId());
<span class="line-modified">360             approvalPr.addReview(Review.Verdict.APPROVED);</span>
361 
362             // Let the bot check the status
363             TestBotRunner.runPeriodicItems(mergeBot);
364 
365             // Push it
366             pr.addComment(&quot;/integrate&quot;);
367             TestBotRunner.runPeriodicItems(mergeBot);
368 
369             // The bot should reply with a failure message
370             var error = pr.getComments().stream()
371                           .filter(comment -&gt; comment.body().contains(&quot;did not complete successfully&quot;))
372                           .count();
373             assertEquals(1, error, () -&gt; pr.getComments().stream().map(Comment::body).collect(Collectors.joining(&quot;\n\n&quot;)));
374 
375             var check = pr.getChecks(mergeHash).get(&quot;jcheck&quot;);
376             assertEquals(&quot;- Could not fetch branch `otherxyz` from project `&quot; + credentials.getHostedRepository().getName() + &quot;` - check that they are correct.&quot;, check.summary().orElseThrow());
377         }
378     }
379 
380     @Test
</pre>
<hr />
<pre>
403 
404             // Go back to the original master
405             localRepo.checkout(masterHash, true);
406 
407             // Make yet another change in another branch
408             var other2Hash = CheckableRepository.appendAndCommit(localRepo, &quot;Change in other2&quot;,
409                                                                 &quot;Unrelated\n\nReviewed-by: integrationreviewer2&quot;);
410             localRepo.push(other2Hash, author.getUrl(), &quot;other2&quot;, true);
411 
412             // Make a change with a corresponding PR
413             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
414             localRepo.add(unrelated);
415             localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);
416             localRepo.merge(other1Hash, &quot;ours&quot;);
417             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
418             localRepo.push(mergeHash, author.getUrl(), &quot;edit&quot;, true);
419             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + credentials.getHostedRepository().getName() + &quot;:other2&quot;);
420 
421             // Approve it as another user
422             var approvalPr = integrator.getPullRequest(pr.getId());
<span class="line-modified">423             approvalPr.addReview(Review.Verdict.APPROVED);</span>
424 
425             // Let the bot check the status
426             TestBotRunner.runPeriodicItems(mergeBot);
427 
428             // Push it
429             pr.addComment(&quot;/integrate&quot;);
430             TestBotRunner.runPeriodicItems(mergeBot);
431 
432             // The bot should reply with a failure message
433             var error = pr.getComments().stream()
434                           .filter(comment -&gt; comment.body().contains(&quot;did not complete successfully&quot;))
435                           .count();
436             assertEquals(1, error, () -&gt; pr.getComments().stream().map(Comment::body).collect(Collectors.joining(&quot;\n\n&quot;)));
437 
438             var check = pr.getChecks(mergeHash).get(&quot;jcheck&quot;);
439             assertEquals(&quot;- The merge contains commits that are not ancestors of the source&quot;, check.summary().orElseThrow());
440         }
441     }
442 
443     @Test
</pre>
<hr />
<pre>
461 
462             // Make a change in another branch
463             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Change in other&quot;,
464                                                                 &quot;Other\n\nReviewed-by: integrationreviewer2&quot;);
465             localRepo.push(otherHash, author.getUrl(), &quot;other&quot;, true);
466 
467             // Go back to the original master
468             localRepo.checkout(masterHash, true);
469 
470             // Make a change with a corresponding PR
471             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
472             localRepo.add(unrelated);
473             localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);
474             localRepo.merge(otherHash);
475             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
476             localRepo.push(mergeHash, author.getUrl(), &quot;edit&quot;, true);
477             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + credentials.getHostedRepository().getName() + &quot;:other&quot;);
478 
479             // Approve it as another user
480             var approvalPr = integrator.getPullRequest(pr.getId());
<span class="line-modified">481             approvalPr.addReview(Review.Verdict.APPROVED);</span>
482 
483             // Let the bot check the status
484             TestBotRunner.runPeriodicItems(mergeBot);
485 
486             // Push it
487             pr.addComment(&quot;/integrate&quot;);
488             TestBotRunner.runPeriodicItems(mergeBot);
489 
490             // The bot should reply with a failure message
491             var error = pr.getComments().stream()
492                           .filter(comment -&gt; comment.body().contains(&quot;Merges require Committer status&quot;))
493                           .count();
494             assertEquals(1, error, () -&gt; pr.getComments().stream().map(Comment::body).collect(Collectors.joining(&quot;\n\n&quot;)));
495         }
496     }
497 
498     @Test
499     void unrelatedHistory(TestInfo testInfo) throws IOException {
500         try (var credentials = new HostCredentials(testInfo);
501              var tempFolder = new TemporaryDirectory()) {
</pre>
<hr />
<pre>
533             // Make a change with a corresponding PR
534             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
535             localRepo.add(unrelated);
536             localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);
537             var mergeCmd = Process.command(&quot;git&quot;, &quot;merge&quot;, &quot;--no-commit&quot;, &quot;--allow-unrelated-histories&quot;, &quot;-s&quot;, &quot;ours&quot;, otherHash.hex())
538                                   .workdir(localRepo.root())
539                                   .environ(&quot;GIT_AUTHOR_NAME&quot;, &quot;some&quot;)
540                                   .environ(&quot;GIT_AUTHOR_EMAIL&quot;, &quot;some@one&quot;)
541                                   .environ(&quot;GIT_COMMITTER_NAME&quot;, &quot;another&quot;)
542                                   .environ(&quot;GIT_COMMITTER_EMAIL&quot;, &quot;another@one&quot;)
543                                   .execute();
544             mergeCmd.check();
545 
546             //localRepo.merge(otherHash);
547             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
548             localRepo.push(mergeHash, author.getUrl(), &quot;edit&quot;, true);
549             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + credentials.getHostedRepository().getName() + &quot;:other&quot;);
550 
551             // Approve it as another user
552             var approvalPr = integrator.getPullRequest(pr.getId());
<span class="line-modified">553             approvalPr.addReview(Review.Verdict.APPROVED);</span>
554 
555             // Let the bot check the status
556             TestBotRunner.runPeriodicItems(mergeBot);
557 
558             // Push it
559             pr.addComment(&quot;/integrate&quot;);
560             TestBotRunner.runPeriodicItems(mergeBot);
561 
562             // The bot should reply with an ok message as we currently allow this
563             var pushed = pr.getComments().stream()
564                            .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
565                            .count();
566             assertEquals(1, pushed);
567         }
568     }
569 }
</pre>
</td>
<td>
<hr />
<pre>
 62                                                                 &quot;First other\n\nReviewed-by: integrationreviewer2&quot;);
 63             localRepo.push(otherHash1, author.getUrl(), &quot;other&quot;, true);
 64             var otherHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Second change in other&quot;,
 65                                                                 &quot;Second other\n\nReviewed-by: integrationreviewer2&quot;);
 66             localRepo.push(otherHash2, author.getUrl(), &quot;other&quot;);
 67 
 68             // Go back to the original master
 69             localRepo.checkout(masterHash, true);
 70 
 71             // Make a change with a corresponding PR
 72             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
 73             localRepo.add(unrelated);
 74             localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);
 75             localRepo.merge(otherHash2);
 76             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
 77             localRepo.push(mergeHash, author.getUrl(), &quot;edit&quot;, true);
 78             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + credentials.getHostedRepository().getName() + &quot;:other&quot;);
 79 
 80             // Approve it as another user
 81             var approvalPr = integrator.getPullRequest(pr.getId());
<span class="line-modified"> 82             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);</span>
 83 
 84             // Let the bot check the status
 85             TestBotRunner.runPeriodicItems(mergeBot);
 86 
 87             // Push it
 88             pr.addComment(&quot;/integrate&quot;);
 89             TestBotRunner.runPeriodicItems(mergeBot);
 90 
 91             // The bot should reply with an ok message
 92             var pushed = pr.getComments().stream()
 93                            .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
 94                            .count();
 95             assertEquals(1, pushed);
 96 
 97             // The change should now be present on the master branch
 98             var pushedRepoFolder = tempFolder.path().resolve(&quot;pushedrepo&quot;);
 99             var pushedRepo = Repository.materialize(pushedRepoFolder, author.getUrl(), &quot;master&quot;);
100             assertTrue(CheckableRepository.hasBeenEdited(pushedRepo));
101 
102             // The commits from the &quot;other&quot; branch should be preserved and not squashed (but not the merge commit)
</pre>
<hr />
<pre>
141                                                                  &quot;First other\n\nReviewed-by: integrationreviewer2&quot;);
142             localRepo.push(otherHash1, author.getUrl(), &quot;other&quot;, true);
143             var otherHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Second change in other&quot;,
144                                                                  &quot;Second other\n\nReviewed-by: integrationreviewer2&quot;);
145             localRepo.push(otherHash2, author.getUrl(), &quot;other&quot;);
146 
147             // Go back to the original master
148             localRepo.checkout(masterHash, true);
149 
150             // Make a change with a corresponding PR
151             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
152             localRepo.add(unrelated);
153             var updatedMaster = localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);
154             localRepo.merge(otherHash2);
155             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
156             localRepo.push(mergeHash, author.getUrl(), &quot;edit&quot;, true);
157             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + credentials.getHostedRepository().getName() + &quot;:other&quot;);
158 
159             // Approve it as another user
160             var approvalPr = integrator.getPullRequest(pr.getId());
<span class="line-modified">161             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);</span>
162 
163             // Let the bot check the status
164             TestBotRunner.runPeriodicItems(mergeBot);
165 
166             // Push something new to master
167             localRepo.checkout(updatedMaster, true);
168             var newMaster = Files.writeString(localRepo.root().resolve(&quot;newmaster.txt&quot;), &quot;New on master&quot;, StandardCharsets.UTF_8);
169             localRepo.add(newMaster);
170             var newMasterHash = localRepo.commit(&quot;New commit on master&quot;, &quot;some&quot;, &quot;some@one&quot;);
171             localRepo.push(newMasterHash, author.getUrl(), &quot;master&quot;);
172 
173             // Let the bot notice
174             TestBotRunner.runPeriodicItems(mergeBot);
175 
176             // Push it
177             pr.addComment(&quot;/integrate&quot;);
178             TestBotRunner.runPeriodicItems(mergeBot);
179 
180             // The bot should reply with an ok message
181             var pushed = pr.getComments().stream()
</pre>
<hr />
<pre>
227 
228             // Make a change in another branch that will not pass jcheck
229             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Change in other&quot;,
230                                                                 &quot;Unreviewed change in other&quot;);
231             localRepo.push(otherHash, author.getUrl(), &quot;other&quot;, true);
232 
233             // Go back to the original master
234             localRepo.checkout(masterHash, true);
235 
236             // Make a change with a corresponding PR
237             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
238             localRepo.add(unrelated);
239             localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);
240             localRepo.merge(otherHash);
241             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
242             localRepo.push(mergeHash, author.getUrl(), &quot;edit&quot;, true);
243             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + credentials.getHostedRepository().getName() + &quot;:other&quot;);
244 
245             // Approve it as another user
246             var approvalPr = integrator.getPullRequest(pr.getId());
<span class="line-modified">247             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);</span>
248 
249             // Let the bot check the status
250             TestBotRunner.runPeriodicItems(mergeBot);
251 
252             // Push it
253             pr.addComment(&quot;/integrate&quot;);
254             TestBotRunner.runPeriodicItems(mergeBot);
255 
256             // The bot should reply with a failure message
257             var error = pr.getComments().stream()
258                           .filter(comment -&gt; comment.body().contains(&quot;did not complete successfully&quot;))
259                           .count();
260             assertEquals(1, error, () -&gt; pr.getComments().stream().map(Comment::body).collect(Collectors.joining(&quot;\n\n&quot;)));
261         }
262     }
263 
264     @Test
265     void invalidSourceRepo(TestInfo testInfo) throws IOException {
266         try (var credentials = new HostCredentials(testInfo);
267              var tempFolder = new TemporaryDirectory()) {
</pre>
<hr />
<pre>
282 
283             // Make a change in another branch
284             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Change in other&quot;,
285                                                                 &quot;Other\n\nReviewed-by: integrationreviewer2&quot;);
286             localRepo.push(otherHash, author.getUrl(), &quot;other&quot;, true);
287 
288             // Go back to the original master
289             localRepo.checkout(masterHash, true);
290 
291             // Make a change with a corresponding PR
292             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
293             localRepo.add(unrelated);
294             localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);
295             localRepo.merge(otherHash);
296             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
297             localRepo.push(mergeHash, author.getUrl(), &quot;edit&quot;, true);
298             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + credentials.getHostedRepository().getName() + &quot;xyz&quot; + &quot;:other&quot;);
299 
300             // Approve it as another user
301             var approvalPr = integrator.getPullRequest(pr.getId());
<span class="line-modified">302             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);</span>
303 
304             // Let the bot check the status
305             TestBotRunner.runPeriodicItems(mergeBot);
306 
307             // Push it
308             pr.addComment(&quot;/integrate&quot;);
309             TestBotRunner.runPeriodicItems(mergeBot);
310 
311             // The bot should reply with a failure message
312             var error = pr.getComments().stream()
313                           .filter(comment -&gt; comment.body().contains(&quot;did not complete successfully&quot;))
314                           .count();
315             assertEquals(1, error, () -&gt; pr.getComments().stream().map(Comment::body).collect(Collectors.joining(&quot;\n\n&quot;)));
316 
317             var check = pr.getChecks(mergeHash).get(&quot;jcheck&quot;);
318             assertEquals(&quot;- Could not fetch branch `other` from project `&quot; + credentials.getHostedRepository().getName() + &quot;xyz` - check that they are correct.&quot;, check.summary().orElseThrow());
319         }
320     }
321 
322     @Test
</pre>
<hr />
<pre>
340 
341             // Make a change in another branch
342             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Change in other&quot;,
343                                                                 &quot;Other\n\nReviewed-by: integrationreviewer2&quot;);
344             localRepo.push(otherHash, author.getUrl(), &quot;other&quot;, true);
345 
346             // Go back to the original master
347             localRepo.checkout(masterHash, true);
348 
349             // Make a change with a corresponding PR
350             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
351             localRepo.add(unrelated);
352             localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);
353             localRepo.merge(otherHash);
354             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
355             localRepo.push(mergeHash, author.getUrl(), &quot;edit&quot;, true);
356             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + credentials.getHostedRepository().getName() + &quot;:otherxyz&quot;);
357 
358             // Approve it as another user
359             var approvalPr = integrator.getPullRequest(pr.getId());
<span class="line-modified">360             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);</span>
361 
362             // Let the bot check the status
363             TestBotRunner.runPeriodicItems(mergeBot);
364 
365             // Push it
366             pr.addComment(&quot;/integrate&quot;);
367             TestBotRunner.runPeriodicItems(mergeBot);
368 
369             // The bot should reply with a failure message
370             var error = pr.getComments().stream()
371                           .filter(comment -&gt; comment.body().contains(&quot;did not complete successfully&quot;))
372                           .count();
373             assertEquals(1, error, () -&gt; pr.getComments().stream().map(Comment::body).collect(Collectors.joining(&quot;\n\n&quot;)));
374 
375             var check = pr.getChecks(mergeHash).get(&quot;jcheck&quot;);
376             assertEquals(&quot;- Could not fetch branch `otherxyz` from project `&quot; + credentials.getHostedRepository().getName() + &quot;` - check that they are correct.&quot;, check.summary().orElseThrow());
377         }
378     }
379 
380     @Test
</pre>
<hr />
<pre>
403 
404             // Go back to the original master
405             localRepo.checkout(masterHash, true);
406 
407             // Make yet another change in another branch
408             var other2Hash = CheckableRepository.appendAndCommit(localRepo, &quot;Change in other2&quot;,
409                                                                 &quot;Unrelated\n\nReviewed-by: integrationreviewer2&quot;);
410             localRepo.push(other2Hash, author.getUrl(), &quot;other2&quot;, true);
411 
412             // Make a change with a corresponding PR
413             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
414             localRepo.add(unrelated);
415             localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);
416             localRepo.merge(other1Hash, &quot;ours&quot;);
417             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
418             localRepo.push(mergeHash, author.getUrl(), &quot;edit&quot;, true);
419             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + credentials.getHostedRepository().getName() + &quot;:other2&quot;);
420 
421             // Approve it as another user
422             var approvalPr = integrator.getPullRequest(pr.getId());
<span class="line-modified">423             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);</span>
424 
425             // Let the bot check the status
426             TestBotRunner.runPeriodicItems(mergeBot);
427 
428             // Push it
429             pr.addComment(&quot;/integrate&quot;);
430             TestBotRunner.runPeriodicItems(mergeBot);
431 
432             // The bot should reply with a failure message
433             var error = pr.getComments().stream()
434                           .filter(comment -&gt; comment.body().contains(&quot;did not complete successfully&quot;))
435                           .count();
436             assertEquals(1, error, () -&gt; pr.getComments().stream().map(Comment::body).collect(Collectors.joining(&quot;\n\n&quot;)));
437 
438             var check = pr.getChecks(mergeHash).get(&quot;jcheck&quot;);
439             assertEquals(&quot;- The merge contains commits that are not ancestors of the source&quot;, check.summary().orElseThrow());
440         }
441     }
442 
443     @Test
</pre>
<hr />
<pre>
461 
462             // Make a change in another branch
463             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Change in other&quot;,
464                                                                 &quot;Other\n\nReviewed-by: integrationreviewer2&quot;);
465             localRepo.push(otherHash, author.getUrl(), &quot;other&quot;, true);
466 
467             // Go back to the original master
468             localRepo.checkout(masterHash, true);
469 
470             // Make a change with a corresponding PR
471             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
472             localRepo.add(unrelated);
473             localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);
474             localRepo.merge(otherHash);
475             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
476             localRepo.push(mergeHash, author.getUrl(), &quot;edit&quot;, true);
477             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + credentials.getHostedRepository().getName() + &quot;:other&quot;);
478 
479             // Approve it as another user
480             var approvalPr = integrator.getPullRequest(pr.getId());
<span class="line-modified">481             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);</span>
482 
483             // Let the bot check the status
484             TestBotRunner.runPeriodicItems(mergeBot);
485 
486             // Push it
487             pr.addComment(&quot;/integrate&quot;);
488             TestBotRunner.runPeriodicItems(mergeBot);
489 
490             // The bot should reply with a failure message
491             var error = pr.getComments().stream()
492                           .filter(comment -&gt; comment.body().contains(&quot;Merges require Committer status&quot;))
493                           .count();
494             assertEquals(1, error, () -&gt; pr.getComments().stream().map(Comment::body).collect(Collectors.joining(&quot;\n\n&quot;)));
495         }
496     }
497 
498     @Test
499     void unrelatedHistory(TestInfo testInfo) throws IOException {
500         try (var credentials = new HostCredentials(testInfo);
501              var tempFolder = new TemporaryDirectory()) {
</pre>
<hr />
<pre>
533             // Make a change with a corresponding PR
534             var unrelated = Files.writeString(localRepo.root().resolve(&quot;unrelated.txt&quot;), &quot;Unrelated&quot;, StandardCharsets.UTF_8);
535             localRepo.add(unrelated);
536             localRepo.commit(&quot;Unrelated&quot;, &quot;some&quot;, &quot;some@one&quot;);
537             var mergeCmd = Process.command(&quot;git&quot;, &quot;merge&quot;, &quot;--no-commit&quot;, &quot;--allow-unrelated-histories&quot;, &quot;-s&quot;, &quot;ours&quot;, otherHash.hex())
538                                   .workdir(localRepo.root())
539                                   .environ(&quot;GIT_AUTHOR_NAME&quot;, &quot;some&quot;)
540                                   .environ(&quot;GIT_AUTHOR_EMAIL&quot;, &quot;some@one&quot;)
541                                   .environ(&quot;GIT_COMMITTER_NAME&quot;, &quot;another&quot;)
542                                   .environ(&quot;GIT_COMMITTER_EMAIL&quot;, &quot;another@one&quot;)
543                                   .execute();
544             mergeCmd.check();
545 
546             //localRepo.merge(otherHash);
547             var mergeHash = localRepo.commit(&quot;Merge commit&quot;, &quot;some&quot;, &quot;some@one&quot;);
548             localRepo.push(mergeHash, author.getUrl(), &quot;edit&quot;, true);
549             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;Merge &quot; + credentials.getHostedRepository().getName() + &quot;:other&quot;);
550 
551             // Approve it as another user
552             var approvalPr = integrator.getPullRequest(pr.getId());
<span class="line-modified">553             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);</span>
554 
555             // Let the bot check the status
556             TestBotRunner.runPeriodicItems(mergeBot);
557 
558             // Push it
559             pr.addComment(&quot;/integrate&quot;);
560             TestBotRunner.runPeriodicItems(mergeBot);
561 
562             // The bot should reply with an ok message as we currently allow this
563             var pushed = pr.getComments().stream()
564                            .filter(comment -&gt; comment.body().contains(&quot;Pushed as commit&quot;))
565                            .count();
566             assertEquals(1, pushed);
567         }
568     }
569 }
</pre>
</td>
</tr>
</table>
<center><a href="IntegrateTests.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="SponsorTests.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>