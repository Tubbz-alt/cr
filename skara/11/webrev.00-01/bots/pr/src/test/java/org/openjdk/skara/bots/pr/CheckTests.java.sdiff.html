<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/pr/src/test/java/org/openjdk/skara/bots/pr/CheckTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/pr/ReviewTracker.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../../host/src/main/java/org/openjdk/skara/host/gitlab/GitLabMergeRequest.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/pr/src/test/java/org/openjdk/skara/bots/pr/CheckTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
210             do {
211                 authorPr = author.getPullRequest(authorPr.getId());
212                 if (refreshCount++ &gt; 100) {
213                     fail(&quot;The PR did not update after the new push&quot;);
214                 }
215             } while (authorPr.getHeadHash().equals(lastHeadHash));
216 
217             // Check that the review is flagged as stale
218             TestBotRunner.runPeriodicItems(checkBot);
219             authorPr = author.getPullRequest(authorPr.getId());
220             assertTrue(authorPr.getBody().contains(&quot;Note&quot;));
221 
222             // Now we can approve it again
223             reviewerPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
224             TestBotRunner.runPeriodicItems(checkBot);
225 
226             // Refresh the PR and check that it has been approved (once) and is no longer stale
227             authorPr = author.getPullRequest(authorPr.getId());
228             assertTrue(authorPr.getBody().contains(&quot;Approvers&quot;));
229             assertEquals(1, authorPr.getBody().split(&quot;Generated Reviewer&quot;, -1).length - 1);
<span class="line-modified">230             assertEquals(2, authorPr.getReviews().size());</span>
231             assertFalse(authorPr.getBody().contains(&quot;Note&quot;));
232 
233             // Add a review with disapproval
234             var commenterPr = commenter.getPullRequest(authorPr.getId());
235             commenterPr.addReview(Review.Verdict.DISAPPROVED, &quot;Disapproved&quot;);
236             TestBotRunner.runPeriodicItems(checkBot);
237 
238             // Refresh the PR and check that it still only approved once (but two reviews) and is no longer stale
239             authorPr = author.getPullRequest(authorPr.getId());
240             assertTrue(authorPr.getBody().contains(&quot;Approvers&quot;));
241             assertEquals(1, authorPr.getBody().split(&quot;Generated Reviewer&quot;, -1).length - 1);
<span class="line-modified">242             assertEquals(3, authorPr.getReviews().size());</span>
243             assertFalse(authorPr.getBody().contains(&quot;Note&quot;));
244         }
245     }
246 
247     @Test
248     void multipleCommitters(TestInfo testInfo) throws IOException {
249         try (var credentials = new HostCredentials(testInfo);
250              var tempFolder = new TemporaryDirectory()) {
251             var author = credentials.getHostedRepository();
252             var reviewer = credentials.getHostedRepository();
253 
254             var censusBuilder = credentials.getCensusBuilder()
255                                            .addReviewer(reviewer.host().getCurrentUserDetails().id());
256             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
257 
258             // Populate the projects repository
259             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
260             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
261             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
262 
</pre>
<hr />
<pre>
376             var author = credentials.getHostedRepository();
377             var reviewer = credentials.getHostedRepository();
378 
379             var censusBuilder = credentials.getCensusBuilder()
380                                            .addAuthor(author.host().getCurrentUserDetails().id())
381                                            .addReviewer(reviewer.host().getCurrentUserDetails().id());
382             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
383 
384             // Populate the projects repository
385             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
386             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
387             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
388 
389             // Make a change with a corresponding PR
390             var editHash = CheckableRepository.appendAndCommit(localRepo);
391             localRepo.push(editHash, author.getUrl(), &quot;refs/heads/edit&quot;, true);
392             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
393 
394             // Check the status
395             TestBotRunner.runPeriodicItems(checkBot);


396 
397             // Approve it as another user
398             var approvalPr = reviewer.getPullRequest(pr.getId());
399             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
400 
401             // Check the status again
402             TestBotRunner.runPeriodicItems(checkBot);
403 
<span class="line-modified">404             // There should now be a comment</span>
<span class="line-modified">405             var comments = pr.getComments();</span>
<span class="line-modified">406             assertEquals(2, comments.size());</span>
<span class="line-modified">407             var comment = comments.get(0);</span>
408             assertTrue(comment.body().contains(reviewer.host().getCurrentUserDetails().userName()));
409             assertTrue(comment.body().contains(&quot;approved&quot;));
410 
411             // Drop the review
412             approvalPr.addReview(Review.Verdict.NONE, &quot;Unreviewed&quot;);
413 
414             // Check the status again
415             TestBotRunner.runPeriodicItems(checkBot);
416 
417             // There should now be yet another comment
418             comments = pr.getComments();
<span class="line-modified">419             assertEquals(3, comments.size());</span>
<span class="line-modified">420             comment = comments.get(2);</span>
421             assertTrue(comment.body().contains(reviewer.host().getCurrentUserDetails().userName()));
422             assertTrue(comment.body().contains(&quot;comment&quot;));
423 
424             // No changes should not generate additional comments
425             TestBotRunner.runPeriodicItems(checkBot);
426             comments = pr.getComments();
<span class="line-modified">427             assertEquals(3, comments.size());</span>
428         }
429     }
430 
431     @Test
432     void mergeMessage(TestInfo testInfo) throws IOException {
433         try (var credentials = new HostCredentials(testInfo);
434              var tempFolder = new TemporaryDirectory();
435              var pushedFolder = new TemporaryDirectory()) {
436 
437             var author = credentials.getHostedRepository();
438             var integrator = credentials.getHostedRepository();
439             var censusBuilder = credentials.getCensusBuilder()
440                                            .addCommitter(author.host().getCurrentUserDetails().id())
441                                            .addReviewer(integrator.host().getCurrentUserDetails().id());
442             var mergeBot = new PullRequestBot(integrator, censusBuilder.build(), &quot;master&quot;);
443 
444             // Populate the projects repository
445             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
446             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
447             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
</pre>
</td>
<td>
<hr />
<pre>
210             do {
211                 authorPr = author.getPullRequest(authorPr.getId());
212                 if (refreshCount++ &gt; 100) {
213                     fail(&quot;The PR did not update after the new push&quot;);
214                 }
215             } while (authorPr.getHeadHash().equals(lastHeadHash));
216 
217             // Check that the review is flagged as stale
218             TestBotRunner.runPeriodicItems(checkBot);
219             authorPr = author.getPullRequest(authorPr.getId());
220             assertTrue(authorPr.getBody().contains(&quot;Note&quot;));
221 
222             // Now we can approve it again
223             reviewerPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
224             TestBotRunner.runPeriodicItems(checkBot);
225 
226             // Refresh the PR and check that it has been approved (once) and is no longer stale
227             authorPr = author.getPullRequest(authorPr.getId());
228             assertTrue(authorPr.getBody().contains(&quot;Approvers&quot;));
229             assertEquals(1, authorPr.getBody().split(&quot;Generated Reviewer&quot;, -1).length - 1);
<span class="line-modified">230             assertTrue(authorPr.getReviews().size() &gt;= 1);</span>
231             assertFalse(authorPr.getBody().contains(&quot;Note&quot;));
232 
233             // Add a review with disapproval
234             var commenterPr = commenter.getPullRequest(authorPr.getId());
235             commenterPr.addReview(Review.Verdict.DISAPPROVED, &quot;Disapproved&quot;);
236             TestBotRunner.runPeriodicItems(checkBot);
237 
238             // Refresh the PR and check that it still only approved once (but two reviews) and is no longer stale
239             authorPr = author.getPullRequest(authorPr.getId());
240             assertTrue(authorPr.getBody().contains(&quot;Approvers&quot;));
241             assertEquals(1, authorPr.getBody().split(&quot;Generated Reviewer&quot;, -1).length - 1);
<span class="line-modified">242             assertTrue(authorPr.getReviews().size() &gt;= 2);</span>
243             assertFalse(authorPr.getBody().contains(&quot;Note&quot;));
244         }
245     }
246 
247     @Test
248     void multipleCommitters(TestInfo testInfo) throws IOException {
249         try (var credentials = new HostCredentials(testInfo);
250              var tempFolder = new TemporaryDirectory()) {
251             var author = credentials.getHostedRepository();
252             var reviewer = credentials.getHostedRepository();
253 
254             var censusBuilder = credentials.getCensusBuilder()
255                                            .addReviewer(reviewer.host().getCurrentUserDetails().id());
256             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
257 
258             // Populate the projects repository
259             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
260             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
261             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
262 
</pre>
<hr />
<pre>
376             var author = credentials.getHostedRepository();
377             var reviewer = credentials.getHostedRepository();
378 
379             var censusBuilder = credentials.getCensusBuilder()
380                                            .addAuthor(author.host().getCurrentUserDetails().id())
381                                            .addReviewer(reviewer.host().getCurrentUserDetails().id());
382             var checkBot = new PullRequestBot(author, censusBuilder.build(), &quot;master&quot;);
383 
384             // Populate the projects repository
385             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
386             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
387             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
388 
389             // Make a change with a corresponding PR
390             var editHash = CheckableRepository.appendAndCommit(localRepo);
391             localRepo.push(editHash, author.getUrl(), &quot;refs/heads/edit&quot;, true);
392             var pr = credentials.createPullRequest(author, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
393 
394             // Check the status
395             TestBotRunner.runPeriodicItems(checkBot);
<span class="line-added">396             var comments = pr.getComments();</span>
<span class="line-added">397             var commentCount = comments.size();</span>
398 
399             // Approve it as another user
400             var approvalPr = reviewer.getPullRequest(pr.getId());
401             approvalPr.addReview(Review.Verdict.APPROVED, &quot;Approved&quot;);
402 
403             // Check the status again
404             TestBotRunner.runPeriodicItems(checkBot);
405 
<span class="line-modified">406             // There should now be two additional comments</span>
<span class="line-modified">407             comments = pr.getComments();</span>
<span class="line-modified">408             assertEquals(commentCount + 2, comments.size());</span>
<span class="line-modified">409             var comment = comments.get(commentCount);</span>
410             assertTrue(comment.body().contains(reviewer.host().getCurrentUserDetails().userName()));
411             assertTrue(comment.body().contains(&quot;approved&quot;));
412 
413             // Drop the review
414             approvalPr.addReview(Review.Verdict.NONE, &quot;Unreviewed&quot;);
415 
416             // Check the status again
417             TestBotRunner.runPeriodicItems(checkBot);
418 
419             // There should now be yet another comment
420             comments = pr.getComments();
<span class="line-modified">421             assertEquals(commentCount + 3, comments.size());</span>
<span class="line-modified">422             comment = comments.get(commentCount + 2);</span>
423             assertTrue(comment.body().contains(reviewer.host().getCurrentUserDetails().userName()));
424             assertTrue(comment.body().contains(&quot;comment&quot;));
425 
426             // No changes should not generate additional comments
427             TestBotRunner.runPeriodicItems(checkBot);
428             comments = pr.getComments();
<span class="line-modified">429             assertEquals(commentCount + 3, comments.size());</span>
430         }
431     }
432 
433     @Test
434     void mergeMessage(TestInfo testInfo) throws IOException {
435         try (var credentials = new HostCredentials(testInfo);
436              var tempFolder = new TemporaryDirectory();
437              var pushedFolder = new TemporaryDirectory()) {
438 
439             var author = credentials.getHostedRepository();
440             var integrator = credentials.getHostedRepository();
441             var censusBuilder = credentials.getCensusBuilder()
442                                            .addCommitter(author.host().getCurrentUserDetails().id())
443                                            .addReviewer(integrator.host().getCurrentUserDetails().id());
444             var mergeBot = new PullRequestBot(integrator, censusBuilder.build(), &quot;master&quot;);
445 
446             // Populate the projects repository
447             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
448             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
449             assertFalse(CheckableRepository.hasBeenEdited(localRepo));
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/pr/ReviewTracker.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../../host/src/main/java/org/openjdk/skara/host/gitlab/GitLabMergeRequest.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>