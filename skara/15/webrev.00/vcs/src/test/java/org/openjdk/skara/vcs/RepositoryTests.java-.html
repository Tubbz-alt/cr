<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old vcs/src/test/java/org/openjdk/skara/vcs/RepositoryTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.vcs;
  24 
  25 import org.openjdk.skara.test.TemporaryDirectory;
  26 
  27 import org.junit.jupiter.params.ParameterizedTest;
  28 import org.junit.jupiter.params.provider.EnumSource;
  29 
  30 import java.io.IOException;
  31 import java.net.URI;
  32 import java.nio.file.*;
  33 import java.util.*;
  34 import java.util.stream.Collectors;
  35 
  36 import static java.nio.file.StandardOpenOption.*;
  37 import static org.junit.jupiter.api.Assertions.*;
  38 
  39 public class RepositoryTests {
  40 
  41     @ParameterizedTest
  42     @EnumSource(VCS.class)
  43     void testExistsOnMissingDirectory(VCS vcs) throws IOException {
  44         var d = Paths.get(&quot;/&quot;, &quot;this&quot;, &quot;path&quot;, &quot;does&quot;, &quot;not&quot;, &quot;exist&quot;);
  45         var r = Repository.get(d);
  46         assertTrue(r.isEmpty());
  47     }
  48 
  49     @ParameterizedTest
  50     @EnumSource(VCS.class)
  51     void testExistsOnEmptyDirectory(VCS vcs) throws IOException {
  52         try (var dir = new TemporaryDirectory()) {
  53             var r = Repository.get(dir.path());
  54             assertTrue(r.isEmpty());
  55         }
  56     }
  57 
  58     @ParameterizedTest
  59     @EnumSource(VCS.class)
  60     void testExistsOnInitializedRepository(VCS vcs) throws IOException {
  61         try (var dir = new TemporaryDirectory()) {
  62             var r = Repository.init(dir.path(), vcs);
  63             assertTrue(r.exists());
  64         }
  65     }
  66 
  67     @ParameterizedTest
  68     @EnumSource(VCS.class)
  69     void testExistsOnSubdir() throws IOException {
  70         try (var dir = new TemporaryDirectory()) {
  71             var r = Repository.init(dir.path(), VCS.GIT);
  72             assertTrue(r.exists());
  73 
  74             var subdir = Paths.get(dir.toString(), &quot;test&quot;);
  75             Files.createDirectories(subdir);
  76             var r2 = Repository.get(subdir);
  77             assertTrue(r2.get().exists());
  78         }
  79     }
  80 
  81     @ParameterizedTest
  82     @EnumSource(VCS.class)
  83     void testRootOnTopLevel() throws IOException {
  84         try (var dir = new TemporaryDirectory()) {
  85             var r = Repository.init(dir.path(), VCS.GIT);
  86             assertEquals(dir.toString(), r.root().toString());
  87         }
  88     }
  89 
  90     @ParameterizedTest
  91     @EnumSource(VCS.class)
  92     void testRootOnSubdirectory(VCS vcs) throws IOException {
  93         try (var dir = new TemporaryDirectory()) {
  94             var r = Repository.init(dir.path(), vcs);
  95             assertEquals(dir.toString(), r.root().toString());
  96 
  97             var subdir = Paths.get(dir.toString(), &quot;sub&quot;);
  98             Files.createDirectories(subdir);
  99 
 100             var r2 = Repository.get(subdir);
 101             assertEquals(dir.toString(), r2.get().root().toString());
 102         }
 103     }
 104 
 105     @ParameterizedTest
 106     @EnumSource(VCS.class)
 107     void testResolveOnEmptyRepository(VCS vcs) throws IOException {
 108         try (var dir = new TemporaryDirectory()) {
 109             var r = Repository.init(dir.path(), vcs);
 110             assertTrue(r.resolve(&quot;HEAD&quot;).isEmpty());
 111         }
 112     }
 113 
 114     @ParameterizedTest
 115     @EnumSource(VCS.class)
 116     void testResolveWithHEAD(VCS vcs) throws IOException {
 117         try (var dir = new TemporaryDirectory()) {
 118             var r = Repository.init(dir.path(), vcs);
 119 
 120             var readme = dir.path().resolve(&quot;README&quot;);
 121             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 122 
 123             r.add(readme);
 124             var head = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 125             assertEquals(head, r.head());
 126         }
 127     }
 128 
 129     @ParameterizedTest
 130     @EnumSource(VCS.class)
 131     void testConfig(VCS vcs) throws IOException {
 132         try (var dir = new TemporaryDirectory()) {
 133             var r = Repository.init(dir.path(), vcs);
 134 
 135             if (vcs == VCS.GIT) {
 136                 var config = dir.path().resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 137                 Files.write(config, List.of(&quot;[user]&quot;, &quot;name = duke&quot;), WRITE, APPEND);
 138                 assertEquals(List.of(&quot;duke&quot;), r.config(&quot;user.name&quot;));
 139             } else if (vcs == VCS.HG) {
 140                 var config = dir.path().resolve(&quot;.hg&quot;).resolve(&quot;hgrc&quot;);
 141                 Files.write(config, List.of(&quot;[ui]&quot;, &quot;username = duke&quot;), WRITE, CREATE);
 142                 assertEquals(List.of(&quot;duke&quot;), r.config(&quot;ui.username&quot;));
 143             }
 144 
 145             assertEquals(&quot;duke&quot;, r.username().get());
 146         }
 147     }
 148 
 149     @ParameterizedTest
 150     @EnumSource(VCS.class)
 151     void testCurrentBranchOnEmptyRepository(VCS vcs) throws IOException {
 152         try (var dir = new TemporaryDirectory()) {
 153             var r = Repository.init(dir.path(), vcs);
 154             assertEquals(r.defaultBranch(), r.currentBranch());
 155         }
 156     }
 157 
 158     @ParameterizedTest
 159     @EnumSource(VCS.class)
 160     void testCheckout(VCS vcs) throws IOException {
 161         try (var dir = new TemporaryDirectory()) {
 162             var r = Repository.init(dir.path(), vcs);
 163 
 164             var readme = dir.path().resolve(&quot;README&quot;);
 165             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 166             r.add(readme);
 167 
 168             var head1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 169             assertEquals(head1, r.head());
 170 
 171             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 172             r.add(readme);
 173 
 174             var head2 = r.commit(&quot;Add one more line&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 175             assertEquals(head2, r.head());
 176 
 177             r.checkout(head1, false);
 178             assertEquals(head1, r.head());
 179 
 180             r.checkout(head2, false);
 181             assertEquals(head2, r.head());
 182         }
 183     }
 184 
 185     @ParameterizedTest
 186     @EnumSource(VCS.class)
 187     void testLines(VCS vcs) throws IOException {
 188         try (var dir = new TemporaryDirectory()) {
 189             var r = Repository.init(dir.path(), vcs);
 190 
 191             var readme = dir.path().resolve(&quot;README&quot;);
 192             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 193             r.add(readme);
 194 
 195             var head1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 196             assertEquals(List.of(&quot;Hello, readme!&quot;),
 197                          r.lines(readme, head1).orElseThrow());
 198 
 199             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 200             r.add(readme);
 201 
 202             var head2 = r.commit(&quot;Add one more line&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 203             assertEquals(List.of(&quot;Hello, readme!&quot;, &quot;Another line&quot;),
 204                          r.lines(readme, head2).orElseThrow());
 205         }
 206     }
 207 
 208     @ParameterizedTest
 209     @EnumSource(VCS.class)
 210     void testLinesInSubdir(VCS vcs) throws IOException {
 211         try (var dir = new TemporaryDirectory()) {
 212             Repository.init(dir.path(), vcs);
 213 
 214             var subdir = dir.path().resolve(&quot;sub&quot;);
 215             Files.createDirectories(subdir);
 216             var r = Repository.get(subdir).get();
 217 
 218             var readme = subdir.getParent().resolve(&quot;README&quot;);
 219             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 220             r.add(readme);
 221 
 222             var head = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 223             assertEquals(List.of(&quot;Hello, readme!&quot;),
 224                          r.lines(readme, head).orElseThrow());
 225 
 226             var example = subdir.resolve(&quot;EXAMPLE&quot;);
 227             Files.write(example, List.of(&quot;An example&quot;));
 228             r.add(example);
 229 
 230             var head2 = r.commit(&quot;Add EXAMPLE&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 231             assertEquals(List.of(&quot;An example&quot;),
 232                          r.lines(example, head2).orElseThrow());
 233         }
 234     }
 235 
 236     @ParameterizedTest
 237     @EnumSource(VCS.class)
 238     void testCommitListingOnEmptyRepo(VCS vcs) throws IOException {
 239         try (var dir = new TemporaryDirectory()) {
 240             var r = Repository.init(dir.path(), vcs);
 241             assertTrue(r.commits().asList().isEmpty());
 242         }
 243     }
 244 
 245     @ParameterizedTest
 246     @EnumSource(VCS.class)
 247     void testCommitListingWithSingleCommit(VCS vcs) throws IOException {
 248         try (var dir = new TemporaryDirectory()) {
 249             var r = Repository.init(dir.path(), vcs);
 250 
 251             var readme = dir.path().resolve(&quot;README&quot;);
 252             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 253 
 254             r.add(readme);
 255 
 256             var committerName = vcs == VCS.GIT ? &quot;bot&quot; : &quot;duke&quot;;
 257             var committerEmail = vcs == VCS.GIT ? &quot;bot@openjdk.java.net&quot; : &quot;duke@openjdk.java.net&quot;;
 258             var hash = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;, committerName, committerEmail);
 259 
 260             var commits = r.commits().asList();
 261             assertEquals(1, commits.size());
 262 
 263             var commit = commits.get(0);
 264             assertEquals(&quot;duke&quot;, commit.author().name());
 265             assertEquals(&quot;duke@openjdk.java.net&quot;, commit.author().email());
 266             assertEquals(committerName, commit.committer().name());
 267             assertEquals(committerEmail, commit.committer().email());
 268 
 269             assertEquals(List.of(&quot;Add README&quot;), commit.message());
 270 
 271             assertEquals(1, commit.numParents());
 272             assertEquals(1, commit.parents().size());
 273 
 274             var nullHash = &quot;0&quot;.repeat(40);
 275             var parent = commit.parents().get(0);
 276             assertEquals(nullHash, parent.hex());
 277 
 278             assertTrue(commit.isInitialCommit());
 279             assertFalse(commit.isMerge());
 280             assertEquals(hash, commit.hash());
 281 
 282             var diffs = commit.parentDiffs();
 283             assertEquals(1, diffs.size());
 284 
 285             var diff = diffs.get(0);
 286             assertEquals(nullHash, diff.from().hex());
 287             assertEquals(hash, diff.to());
 288 
 289             assertEquals(0, diff.removed());
 290             assertEquals(0, diff.modified());
 291             assertEquals(1, diff.added());
 292 
 293             var patches = diff.patches();
 294             assertEquals(1, patches.size());
 295 
 296             var patch = patches.get(0).asTextualPatch();
 297             assertTrue(patch.status().isAdded());
 298 
 299             assertTrue(patch.source().path().isEmpty());
 300             assertTrue(patch.source().type().isEmpty());
 301 
 302             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 303             assertTrue(patch.target().type().get().isRegularNonExecutable());
 304 
 305             var hunks = patch.hunks();
 306             assertEquals(1, hunks.size());
 307 
 308             var hunk = hunks.get(0);
 309             assertEquals(new Range(0, 0), hunk.source().range());
 310             assertEquals(new Range(1, 1), hunk.target().range());
 311 
 312             assertEquals(List.of(), hunk.source().lines());
 313             assertEquals(List.of(&quot;Hello, readme!&quot;), hunk.target().lines());
 314         }
 315     }
 316 
 317     @ParameterizedTest
 318     @EnumSource(VCS.class)
 319     void testCommitListingWithMultipleCommits(VCS vcs) throws IOException {
 320         try (var dir = new TemporaryDirectory()) {
 321             var r = Repository.init(dir.path(), vcs);
 322 
 323             var readme = dir.path().resolve(&quot;README&quot;);
 324             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 325 
 326             r.add(readme);
 327             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 328 
 329             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 330             r.add(readme);
 331             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 332 
 333             var commits = r.commits().asList();
 334             assertEquals(2, commits.size());
 335 
 336             var commit = commits.get(0);
 337             assertEquals(&quot;duke&quot;, commit.author().name());
 338             assertEquals(&quot;duke@openjdk.java.net&quot;, commit.author().email());
 339 
 340             assertEquals(List.of(&quot;Modify README&quot;), commit.message());
 341 
 342             assertEquals(1, commit.numParents());
 343             assertEquals(1, commit.parents().size());
 344 
 345             var parent = commit.parents().get(0);
 346             assertEquals(hash1, parent);
 347 
 348             assertFalse(commit.isInitialCommit());
 349             assertFalse(commit.isMerge());
 350             assertEquals(hash2, commit.hash());
 351 
 352             var diffs = commit.parentDiffs();
 353             assertEquals(1, diffs.size());
 354 
 355             var diff = diffs.get(0);
 356             assertEquals(hash1, diff.from());
 357             assertEquals(hash2, diff.to());
 358 
 359             assertEquals(0, diff.removed());
 360             assertEquals(0, diff.modified());
 361             assertEquals(1, diff.added());
 362 
 363             var patches = diff.patches();
 364             assertEquals(1, patches.size());
 365 
 366             var patch = patches.get(0).asTextualPatch();
 367             assertTrue(patch.status().isModified());
 368             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 369             assertTrue(patch.source().type().get().isRegularNonExecutable());
 370             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 371             assertTrue(patch.target().type().get().isRegularNonExecutable());
 372 
 373             var hunks = patch.hunks();
 374             assertEquals(1, hunks.size());
 375 
 376             var hunk = hunks.get(0);
 377             assertEquals(new Range(1, 0), hunk.source().range());
 378             assertEquals(new Range(2, 1), hunk.target().range());
 379 
 380             assertEquals(List.of(), hunk.source().lines());
 381             assertEquals(List.of(&quot;Another line&quot;), hunk.target().lines());
 382         }
 383     }
 384 
 385     @ParameterizedTest
 386     @EnumSource(VCS.class)
 387     void testSquashDeletes(VCS vcs) throws IOException {
 388         try (var dir = new TemporaryDirectory()) {
 389             var r = Repository.init(dir.path(), vcs);
 390 
 391             var file1 = dir.path().resolve(&quot;file1.txt&quot;);
 392             Files.write(file1, List.of(&quot;Hello, file 1!&quot;));
 393             var file2 = dir.path().resolve(&quot;file2.txt&quot;);
 394             Files.write(file2, List.of(&quot;Hello, file 2!&quot;));
 395             var file3 = dir.path().resolve(&quot;file3.txt&quot;);
 396             Files.write(file3, List.of(&quot;Hello, file 3!&quot;));
 397 
 398             r.add(file1, file2, file3);
 399             var hash1 = r.commit(&quot;Add files&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 400 
 401             Files.delete(file2);
 402             r.remove(file2);
 403             var hash2 = r.commit(&quot;Remove file 2&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 404 
 405             Files.delete(file3);
 406             r.remove(file3);
 407             var hash3 = r.commit(&quot;Remove file 3&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 408 
 409             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 410             assertEquals(3, r.commits(refspec).asList().size());
 411 
 412             r.checkout(hash1, false);
 413             r.squash(hash3);
 414             r.commit(&quot;Squashed remove of file 2 and 3&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 415 
 416             refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 417             var commits = r.commits(refspec).asList();
 418             assertEquals(2, commits.size());
 419 
 420             assertEquals(hash1, commits.get(1).hash());
 421 
 422             var head = commits.get(0);
 423             assertNotEquals(hash2, head);
 424             assertNotEquals(hash3, head);
 425 
 426             assertEquals(hash1, head.parents().get(0));
 427             assertFalse(head.isInitialCommit());
 428             assertFalse(head.isMerge());
 429 
 430             var diffs = head.parentDiffs();
 431             assertEquals(1, diffs.size());
 432 
 433             var diff = diffs.get(0);
 434             assertEquals(hash1, diff.from());
 435             assertEquals(head.hash(), diff.to());
 436 
 437             assertEquals(2, diff.removed());
 438             assertEquals(0, diff.modified());
 439             assertEquals(0, diff.added());
 440         }
 441     }
 442 
 443     @ParameterizedTest
 444     @EnumSource(VCS.class)
 445     void testSquash(VCS vcs) throws IOException {
 446         try (var dir = new TemporaryDirectory()) {
 447             var r = Repository.init(dir.path(), vcs);
 448 
 449             var readme = dir.path().resolve(&quot;README&quot;);
 450             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 451 
 452             r.add(readme);
 453             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 454 
 455             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 456             r.add(readme);
 457             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 458 
 459             Files.write(readme, List.of(&quot;A final line&quot;), WRITE, APPEND);
 460             r.add(readme);
 461             var hash3 = r.commit(&quot;Modify README again&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 462 
 463             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 464             assertEquals(3, r.commits(refspec).asList().size());
 465 
 466             r.checkout(hash1, false);
 467             r.squash(hash3);
 468             r.commit(&quot;Squashed commits 2 and 3&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 469 
 470             refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 471             var commits = r.commits(refspec).asList();
 472             assertEquals(2, commits.size());
 473 
 474             assertEquals(hash1, commits.get(1).hash());
 475 
 476             var head = commits.get(0);
 477             assertNotEquals(hash2, head);
 478             assertNotEquals(hash3, head);
 479 
 480             assertEquals(hash1, head.parents().get(0));
 481             assertFalse(head.isInitialCommit());
 482             assertFalse(head.isMerge());
 483 
 484             var diffs = head.parentDiffs();
 485             assertEquals(1, diffs.size());
 486 
 487             var diff = diffs.get(0);
 488             assertEquals(hash1, diff.from());
 489             assertEquals(head.hash(), diff.to());
 490 
 491             assertEquals(0, diff.removed());
 492             assertEquals(0, diff.modified());
 493             assertEquals(2, diff.added());
 494 
 495             var patches = diff.patches();
 496             assertEquals(1, patches.size());
 497 
 498             var patch = patches.get(0).asTextualPatch();
 499             assertTrue(patch.status().isModified());
 500             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 501             assertTrue(patch.source().type().get().isRegularNonExecutable());
 502             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 503             assertTrue(patch.target().type().get().isRegularNonExecutable());
 504 
 505             var hunks = patch.hunks();
 506             assertEquals(1, hunks.size());
 507 
 508             var hunk = hunks.get(0);
 509             assertEquals(new Range(1, 0), hunk.source().range());
 510             assertEquals(new Range(2, 2), hunk.target().range());
 511 
 512             assertEquals(List.of(), hunk.source().lines());
 513             assertEquals(List.of(&quot;Another line&quot;, &quot;A final line&quot;), hunk.target().lines());
 514         }
 515     }
 516 
 517     @ParameterizedTest
 518     @EnumSource(VCS.class)
 519     void testMergeBase(VCS vcs) throws IOException {
 520         try (var dir = new TemporaryDirectory()) {
 521             var r = Repository.init(dir.path(), vcs);
 522 
 523             var readme = dir.path().resolve(&quot;README&quot;);
 524             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 525 
 526             r.add(readme);
 527             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 528 
 529             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 530             r.add(readme);
 531             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 532 
 533             r.checkout(hash1, false);
 534             Files.write(readme, List.of(&quot;A conflicting line&quot;), WRITE, APPEND);
 535             r.add(readme);
 536             var hash3 = r.commit(&quot;Branching README modification&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 537 
 538             assertEquals(hash1, r.mergeBase(hash2, hash3));
 539         }
 540     }
 541 
 542     @ParameterizedTest
 543     @EnumSource(VCS.class)
 544     void testRebase(VCS vcs) throws IOException {
 545         try (var dir = new TemporaryDirectory()) {
 546             var r = Repository.init(dir.path(), vcs);
 547 
 548             var readme = dir.path().resolve(&quot;README&quot;);
 549             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 550 
 551             r.add(readme);
 552             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 553 
 554             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 555             r.add(readme);
 556             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 557 
 558             r.checkout(hash1, false);
 559 
 560             var contributing = dir.path().resolve(&quot;CONTRIBUTING&quot;);
 561             Files.write(contributing, List.of(&quot;Keep the patches coming&quot;));
 562             r.add(contributing);
 563             var hash3 = r.commit(&quot;Add independent change&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 564 
 565             var committerName = vcs == VCS.GIT ? &quot;bot&quot; : &quot;duke&quot;;
 566             var committerEmail = vcs == VCS.GIT ? &quot;bot@openjdk.java.net&quot; : &quot;duke@openjdk.java.net&quot;;
 567             r.rebase(hash2, committerName, committerEmail);
 568 
 569             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 570             var commits = r.commits(refspec).asList();
 571             assertEquals(3, commits.size());
 572             assertEquals(hash2, commits.get(1).hash());
 573             assertEquals(hash1, commits.get(2).hash());
 574 
 575             assertEquals(&quot;duke&quot;, commits.get(0).author().name());
 576             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(0).author().email());
 577             assertEquals(committerName, commits.get(0).committer().name());
 578             assertEquals(committerEmail, commits.get(0).committer().email());
 579 
 580             assertEquals(&quot;duke&quot;, commits.get(1).author().name());
 581             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(1).author().email());
 582             assertEquals(&quot;duke&quot;, commits.get(1).committer().name());
 583             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(1).committer().email());
 584 
 585             assertEquals(&quot;duke&quot;, commits.get(2).author().name());
 586             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(2).author().email());
 587             assertEquals(&quot;duke&quot;, commits.get(2).committer().name());
 588             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(2).committer().email());
 589 
 590             var head = commits.get(0);
 591             assertEquals(hash2, head.parents().get(0));
 592             assertEquals(List.of(&quot;Add independent change&quot;), head.message());
 593 
 594             var diffs = head.parentDiffs();
 595             assertEquals(1, diffs.size());
 596             var diff = diffs.get(0);
 597 
 598             assertEquals(0, diff.removed());
 599             assertEquals(0, diff.modified());
 600             assertEquals(1, diff.added());
 601 
 602             var patches = diff.patches();
 603             assertEquals(1, patches.size());
 604             var patch = patches.get(0).asTextualPatch();
 605             assertEquals(Path.of(&quot;CONTRIBUTING&quot;), patch.target().path().get());
 606 
 607             var hunks = patch.hunks();
 608             assertEquals(1, hunks.size());
 609             var hunk = hunks.get(0);
 610             assertEquals(List.of(&quot;Keep the patches coming&quot;), hunk.target().lines());
 611         }
 612     }
 613 
 614     @ParameterizedTest
 615     @EnumSource(VCS.class)
 616     void testInitializedRepositoryIsEmpty(VCS vcs) throws IOException {
 617         try (var dir = new TemporaryDirectory()) {
 618             var r = Repository.init(dir.path(), vcs);
 619             assertTrue(r.isEmpty());
 620         }
 621     }
 622 
 623     @ParameterizedTest
 624     @EnumSource(VCS.class)
 625     void testRepositoryWithCommitIsNonEmpty(VCS vcs) throws IOException {
 626         try (var dir = new TemporaryDirectory()) {
 627             var r = Repository.init(dir.path(), vcs);
 628 
 629             var readme = dir.path().resolve(&quot;README&quot;);
 630             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 631 
 632             r.add(readme);
 633             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 634 
 635             assertFalse(r.isEmpty());
 636         }
 637     }
 638 
 639     @ParameterizedTest
 640     @EnumSource(VCS.class)
 641     void testEmptyRepositoryIsHealthy(VCS vcs) throws IOException {
 642         try (var dir = new TemporaryDirectory()) {
 643             var r = Repository.init(dir.path(), vcs);
 644             assertTrue(r.isHealthy());
 645         }
 646     }
 647 
 648     @ParameterizedTest
 649     @EnumSource(VCS.class)
 650     void testNonEmptyRepositoryIsHealthy(VCS vcs) throws IOException {
 651         try (var dir = new TemporaryDirectory()) {
 652             var r = Repository.init(dir.path(), vcs);
 653 
 654             var readme = dir.path().resolve(&quot;README&quot;);
 655             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 656 
 657             r.add(readme);
 658             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 659 
 660             assertTrue(r.isHealthy());
 661         }
 662     }
 663 
 664     @ParameterizedTest
 665     @EnumSource(VCS.class)
 666     void testBranchesOnEmptyRepository(VCS vcs) throws IOException {
 667         try (var dir = new TemporaryDirectory()) {
 668             var r = Repository.init(dir.path(), vcs);
 669             var expected = vcs == VCS.GIT ? List.of() : List.of(new Branch(&quot;default&quot;));
 670             assertEquals(List.of(), r.branches());
 671         }
 672     }
 673 
 674     @ParameterizedTest
 675     @EnumSource(VCS.class)
 676     void testBranchesOnNonEmptyRepository(VCS vcs) throws IOException {
 677         try (var dir = new TemporaryDirectory()) {
 678             var r = Repository.init(dir.path(), vcs);
 679 
 680             var readme = dir.path().resolve(&quot;README&quot;);
 681             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 682 
 683             r.add(readme);
 684             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 685 
 686             assertEquals(List.of(r.defaultBranch()), r.branches());
 687         }
 688     }
 689 
 690     @ParameterizedTest
 691     @EnumSource(VCS.class)
 692     void testTagsOnEmptyRepository(VCS vcs) throws IOException {
 693         try (var dir = new TemporaryDirectory()) {
 694             var r = Repository.init(dir.path(), vcs);
 695             var expected = vcs == VCS.GIT ? List.of() : List.of(new Tag(&quot;tip&quot;));
 696             assertEquals(expected, r.tags());
 697         }
 698     }
 699 
 700     @ParameterizedTest
 701     @EnumSource(VCS.class)
 702     void testTagsOnNonEmptyRepository(VCS vcs) throws IOException {
 703         try (var dir = new TemporaryDirectory()) {
 704             var r = Repository.init(dir.path(), vcs);
 705 
 706             var readme = dir.path().resolve(&quot;README&quot;);
 707             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 708 
 709             r.add(readme);
 710             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 711 
 712             var expected = vcs == VCS.GIT ? List.of() : List.of(new Tag(&quot;tip&quot;));
 713             assertEquals(expected, r.tags());
 714         }
 715     }
 716 
 717     @ParameterizedTest
 718     @EnumSource(VCS.class)
 719     void testFetchAndPush(VCS vcs) throws IOException {
 720         try (var dir = new TemporaryDirectory()) {
 721             var upstream = Repository.init(dir.path(), vcs);
 722 
 723             if (vcs == VCS.GIT) {
 724                 Files.write(upstream.root().resolve(&quot;.git&quot;).resolve(&quot;config&quot;),
 725                             List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch=ignore&quot;),
 726                             WRITE, APPEND);
 727             }
 728 
 729             var readme = dir.path().resolve(&quot;README&quot;);
 730             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 731 
 732             upstream.add(readme);
 733             upstream.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 734 
 735             try (var dir2 = new TemporaryDirectory()) {
 736                 var downstream = Repository.init(dir2.path(), vcs);
 737 
 738                 var upstreamURI = URI.create(&quot;file://&quot; + dir.toString());
 739 
 740                 var fetchHead = downstream.fetch(upstreamURI, downstream.defaultBranch().name());
 741                 downstream.checkout(fetchHead, false);
 742 
 743                 var downstreamReadme = dir2.path().resolve(&quot;README&quot;);
 744                 Files.write(downstreamReadme, List.of(&quot;Downstream change&quot;), WRITE, APPEND);
 745 
 746                 downstream.add(downstreamReadme);
 747                 var head = downstream.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 748 
 749                 downstream.push(head, upstreamURI, downstream.defaultBranch().name());
 750             }
 751 
 752             upstream.checkout(upstream.resolve(upstream.defaultBranch().name()).get(), false);
 753 
 754             var commits = upstream.commits().asList();
 755             assertEquals(2, commits.size());
 756         }
 757     }
 758 
 759     @ParameterizedTest
 760     @EnumSource(VCS.class)
 761     void testClean(VCS vcs) throws IOException {
 762         try (var dir = new TemporaryDirectory()) {
 763             var r = Repository.init(dir.path(), vcs);
 764             r.clean();
 765 
 766             var readme = dir.path().resolve(&quot;README&quot;);
 767             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 768 
 769             r.add(readme);
 770             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 771 
 772             r.clean();
 773 
 774             assertEquals(hash1, r.head());
 775 
 776             Files.write(readme, List.of(&quot;A random change&quot;), WRITE, APPEND);
 777 
 778             r.clean();
 779 
 780             assertEquals(List.of(&quot;Hello, readme!&quot;), Files.readAllLines(readme));
 781 
 782             var untracked = dir.path().resolve(&quot;UNTRACKED&quot;);
 783             Files.write(untracked, List.of(&quot;Random text&quot;));
 784 
 785             r.clean();
 786 
 787             assertFalse(Files.exists(untracked));
 788 
 789             // Mercurial cannot currently deal with this situation
 790             if (vcs != VCS.HG) {
 791                 var subRepo = Repository.init(dir.path().resolve(&quot;submodule&quot;), vcs);
 792                 var subRepoFile = subRepo.root().resolve(&quot;file.txt&quot;);
 793                 Files.write(subRepoFile, List.of(&quot;Looks like a file in a submodule&quot;));
 794 
 795                 r.clean();
 796 
 797                 assertFalse(Files.exists(subRepoFile));
 798             }
 799         }
 800     }
 801 
 802     @ParameterizedTest
 803     @EnumSource(VCS.class)
 804     void testCleanIgnored(VCS vcs) throws IOException {
 805         try (var dir = new TemporaryDirectory()) {
 806             var r = Repository.init(dir.path(), vcs);
 807             r.clean();
 808 
 809             var readme = dir.path().resolve(&quot;README&quot;);
 810             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 811             Files.write(dir.path().resolve(&quot;.gitignore&quot;), List.of(&quot;*.txt&quot;));
 812             Files.write(dir.path().resolve(&quot;.hgignore&quot;), List.of(&quot;.*txt&quot;));
 813 
 814             r.add(readme);
 815             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 816 
 817             var ignored = dir.path().resolve(&quot;ignored.txt&quot;);
 818             Files.write(ignored, List.of(&quot;Random text&quot;));
 819 
 820             r.clean();
 821 
 822             assertFalse(Files.exists(ignored));
 823         }
 824     }
 825 
 826     @ParameterizedTest
 827     @EnumSource(VCS.class)
 828     void testDiffBetweenCommits(VCS vcs) throws IOException {
 829         try (var dir = new TemporaryDirectory()) {
 830             var r = Repository.init(dir.path(), vcs);
 831 
 832             var readme = dir.path().resolve(&quot;README&quot;);
 833             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 834 
 835             r.add(readme);
 836             var first = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 837 
 838             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
 839             r.add(readme);
 840             var second = r.commit(&quot;Add one more line&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 841 
 842             var diff = r.diff(first, second);
 843             assertEquals(first, diff.from());
 844             assertEquals(second, diff.to());
 845 
 846             var patches = diff.patches();
 847             assertEquals(1, patches.size());
 848 
 849             var patch = patches.get(0).asTextualPatch();
 850             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 851             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 852             assertTrue(patch.source().type().get().isRegularNonExecutable());
 853             assertTrue(patch.target().type().get().isRegularNonExecutable());
 854             assertTrue(patch.status().isModified());
 855 
 856             var hunks = patch.hunks();
 857             assertEquals(1, hunks.size());
 858 
 859             var hunk = hunks.get(0);
 860             assertEquals(1, hunk.source().range().start());
 861             assertEquals(0, hunk.source().range().count());
 862             assertEquals(0, hunk.source().lines().size());
 863 
 864             assertEquals(2, hunk.target().range().start());
 865             assertEquals(1, hunk.target().range().count());
 866             assertEquals(List.of(&quot;One more line&quot;), hunk.target().lines());
 867 
 868             assertEquals(1, hunk.added());
 869             assertEquals(0, hunk.removed());
 870             assertEquals(0, hunk.modified());
 871         }
 872     }
 873 
 874     @ParameterizedTest
 875     @EnumSource(VCS.class)
 876     void testDiffBetweenCommitsWithMultiplePatches(VCS vcs) throws IOException {
 877         try (var dir = new TemporaryDirectory()) {
 878             var r = Repository.init(dir.path(), vcs);
 879 
 880             var readme = dir.path().resolve(&quot;README&quot;);
 881             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 882 
 883             var building = dir.path().resolve(&quot;BUILDING&quot;);
 884             Files.write(building, List.of(&quot;make&quot;));
 885 
 886             r.add(readme);
 887             r.add(building);
 888             var first = r.commit(&quot;Add README and BUILDING&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 889 
 890             Files.write(readme, List.of(&quot;Hello, Skara!&quot;), WRITE, TRUNCATE_EXISTING);
 891             Files.write(building, List.of(&quot;make images&quot;), WRITE, TRUNCATE_EXISTING);
 892             r.add(readme);
 893             r.add(building);
 894             var second = r.commit(&quot;Modify README and BUILDING&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 895 
 896             var diff = r.diff(first, second);
 897             assertEquals(first, diff.from());
 898             assertEquals(second, diff.to());
 899 
 900             var patches = diff.patches();
 901             assertEquals(2, patches.size());
 902 
 903             var patch1 = patches.get(0).asTextualPatch();
 904             assertEquals(Path.of(&quot;BUILDING&quot;), patch1.source().path().get());
 905             assertEquals(Path.of(&quot;BUILDING&quot;), patch1.target().path().get());
 906             assertTrue(patch1.source().type().get().isRegularNonExecutable());
 907             assertTrue(patch1.target().type().get().isRegularNonExecutable());
 908             assertTrue(patch1.status().isModified());
 909 
 910             var hunks1 = patch1.hunks();
 911             assertEquals(1, hunks1.size());
 912 
 913             var hunk1 = hunks1.get(0);
 914             assertEquals(1, hunk1.source().range().start());
 915             assertEquals(1, hunk1.source().range().count());
 916             assertEquals(List.of(&quot;make&quot;), hunk1.source().lines());
 917 
 918             assertEquals(1, hunk1.target().range().start());
 919             assertEquals(1, hunk1.target().range().count());
 920             assertEquals(List.of(&quot;make images&quot;), hunk1.target().lines());
 921 
 922             var patch2 = patches.get(1).asTextualPatch();
 923             assertEquals(Path.of(&quot;README&quot;), patch2.source().path().get());
 924             assertEquals(Path.of(&quot;README&quot;), patch2.target().path().get());
 925             assertTrue(patch2.source().type().get().isRegularNonExecutable());
 926             assertTrue(patch2.target().type().get().isRegularNonExecutable());
 927             assertTrue(patch2.status().isModified());
 928 
 929             var hunks2 = patch2.hunks();
 930             assertEquals(1, hunks2.size());
 931 
 932             var hunk2 = hunks2.get(0);
 933             assertEquals(1, hunk2.source().range().start());
 934             assertEquals(1, hunk2.source().range().count());
 935             assertEquals(List.of(&quot;Hello, readme!&quot;), hunk2.source().lines());
 936 
 937             assertEquals(1, hunk2.target().range().start());
 938             assertEquals(1, hunk2.target().range().count());
 939             assertEquals(List.of(&quot;Hello, Skara!&quot;), hunk2.target().lines());
 940         }
 941     }
 942 
 943     @ParameterizedTest
 944     @EnumSource(VCS.class)
 945     void testDiffBetweenCommitsWithMultipleHunks(VCS vcs) throws IOException {
 946         try (var dir = new TemporaryDirectory()) {
 947             var r = Repository.init(dir.path(), vcs);
 948 
 949             var abc = dir.path().resolve(&quot;abc.txt&quot;);
 950             Files.write(abc, List.of(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;));
 951 
 952             r.add(abc);
 953             var first = r.commit(&quot;Added ABC&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 954 
 955             Files.write(abc, List.of(&quot;1&quot;, &quot;2&quot;, &quot;B&quot;, &quot;3&quot;), WRITE, TRUNCATE_EXISTING);
 956             r.add(abc);
 957             var second = r.commit(&quot;Modify A and C&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 958 
 959             var diff = r.diff(first, second);
 960             assertEquals(first, diff.from());
 961             assertEquals(second, diff.to());
 962 
 963             var patches = diff.patches();
 964             assertEquals(1, patches.size());
 965 
 966             var patch = patches.get(0).asTextualPatch();
 967             assertEquals(Path.of(&quot;abc.txt&quot;), patch.source().path().get());
 968             assertEquals(Path.of(&quot;abc.txt&quot;), patch.target().path().get());
 969             assertTrue(patch.source().type().get().isRegularNonExecutable());
 970             assertTrue(patch.target().type().get().isRegularNonExecutable());
 971             assertTrue(patch.status().isModified());
 972 
 973             var hunks = patch.hunks();
 974             assertEquals(2, hunks.size());
 975 
 976             var hunk1 = hunks.get(0);
 977             assertEquals(1, hunk1.source().range().start());
 978             assertEquals(1, hunk1.source().range().count());
 979             assertEquals(List.of(&quot;A&quot;), hunk1.source().lines());
 980 
 981             assertEquals(1, hunk1.target().range().start());
 982             assertEquals(2, hunk1.target().range().count());
 983             assertEquals(List.of(&quot;1&quot;, &quot;2&quot;), hunk1.target().lines());
 984 
 985             assertEquals(1, hunk1.added());
 986             assertEquals(0, hunk1.removed());
 987             assertEquals(1, hunk1.modified());
 988 
 989             var hunk2 = hunks.get(1);
 990             assertEquals(3, hunk2.source().range().start());
 991             assertEquals(1, hunk2.source().range().count());
 992             assertEquals(List.of(&quot;C&quot;), hunk2.source().lines());
 993 
 994             assertEquals(4, hunk2.target().range().start());
 995             assertEquals(1, hunk2.target().range().count());
 996             assertEquals(List.of(&quot;3&quot;), hunk2.target().lines());
 997 
 998             assertEquals(0, hunk2.added());
 999             assertEquals(0, hunk2.removed());
1000             assertEquals(1, hunk2.modified());
1001         }
1002     }
1003 
1004     @ParameterizedTest
1005     @EnumSource(VCS.class)
1006     void testDiffWithRemoval(VCS vcs) throws IOException {
1007         try (var dir = new TemporaryDirectory()) {
1008             var r = Repository.init(dir.path(), vcs);
1009 
1010             var readme = dir.path().resolve(&quot;README&quot;);
1011             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1012 
1013             r.add(readme);
1014             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1015 
1016             Files.delete(readme);
1017             r.remove(readme);
1018             var second = r.commit(&quot;Removed README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1019 
1020             var diff = r.diff(first, second);
1021             assertEquals(first, diff.from());
1022             assertEquals(second, diff.to());
1023 
1024             var patches = diff.patches();
1025             assertEquals(1, patches.size());
1026 
1027             var patch = patches.get(0).asTextualPatch();
1028             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
1029             assertTrue(patch.target().path().isEmpty());
1030             assertTrue(patch.source().type().get().isRegularNonExecutable());
1031             assertTrue(patch.target().type().isEmpty());
1032             assertTrue(patch.status().isDeleted());
1033 
1034             var hunks = patch.hunks();
1035             assertEquals(1, hunks.size());
1036 
1037             var hunk = hunks.get(0);
1038             assertEquals(1, hunk.source().range().start());
1039             assertEquals(1, hunk.source().range().count());
1040             assertEquals(List.of(&quot;Hello, world!&quot;), hunk.source().lines());
1041 
1042             assertEquals(0, hunk.target().range().start());
1043             assertEquals(0, hunk.target().range().count());
1044             assertEquals(List.of(), hunk.target().lines());
1045 
1046             assertEquals(0, hunk.added());
1047             assertEquals(1, hunk.removed());
1048             assertEquals(0, hunk.modified());
1049         }
1050     }
1051 
1052     @ParameterizedTest
1053     @EnumSource(VCS.class)
1054     void testDiffWithAddition(VCS vcs) throws IOException {
1055         try (var dir = new TemporaryDirectory()) {
1056             var r = Repository.init(dir.path(), vcs);
1057 
1058             var readme = dir.path().resolve(&quot;README&quot;);
1059             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1060 
1061             r.add(readme);
1062             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1063 
1064             var building = dir.path().resolve(&quot;BUILDING&quot;);
1065             Files.write(building, List.of(&quot;make&quot;));
1066             r.add(building);
1067             var second = r.commit(&quot;Added BUILDING&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1068 
1069             var diff = r.diff(first, second);
1070             assertEquals(first, diff.from());
1071             assertEquals(second, diff.to());
1072 
1073             var patches = diff.patches();
1074             assertEquals(1, patches.size());
1075 
1076             var patch = patches.get(0).asTextualPatch();
1077             assertTrue(patch.source().path().isEmpty());
1078             assertEquals(Path.of(&quot;BUILDING&quot;), patch.target().path().get());
1079             assertTrue(patch.source().type().isEmpty());
1080             assertTrue(patch.target().type().get().isRegularNonExecutable());
1081             assertTrue(patch.status().isAdded());
1082 
1083             var hunks = patch.hunks();
1084             assertEquals(1, hunks.size());
1085 
1086             var hunk = hunks.get(0);
1087             assertEquals(0, hunk.source().range().start());
1088             assertEquals(0, hunk.source().range().count());
1089             assertEquals(List.of(), hunk.source().lines());
1090 
1091             assertEquals(1, hunk.target().range().start());
1092             assertEquals(1, hunk.target().range().count());
1093             assertEquals(List.of(&quot;make&quot;), hunk.target().lines());
1094 
1095             assertEquals(1, hunk.added());
1096             assertEquals(0, hunk.removed());
1097             assertEquals(0, hunk.modified());
1098         }
1099     }
1100 
1101     @ParameterizedTest
1102     @EnumSource(VCS.class)
1103     void testDiffWithWorkingDir(VCS vcs) throws IOException {
1104         try (var dir = new TemporaryDirectory()) {
1105             var r = Repository.init(dir.path(), vcs);
1106 
1107             var readme = dir.path().resolve(&quot;README&quot;);
1108             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1109 
1110             r.add(readme);
1111             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1112 
1113             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1114             var diff = r.diff(first);
1115 
1116             assertEquals(first, diff.from());
1117             assertNull(diff.to());
1118 
1119             var patches = diff.patches();
1120             assertEquals(1, patches.size());
1121 
1122             var patch = patches.get(0).asTextualPatch();
1123             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
1124             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
1125             assertTrue(patch.source().type().get().isRegularNonExecutable());
1126             assertTrue(patch.target().type().get().isRegularNonExecutable());
1127             assertTrue(patch.status().isModified());
1128 
1129             var hunks = patch.hunks();
1130             assertEquals(1, hunks.size());
1131 
1132             var hunk = hunks.get(0);
1133             assertEquals(1, hunk.source().range().start());
1134             assertEquals(0, hunk.source().range().count());
1135             assertEquals(List.of(), hunk.source().lines());
1136 
1137             assertEquals(2, hunk.target().range().start());
1138             assertEquals(1, hunk.target().range().count());
1139             assertEquals(List.of(&quot;One more line&quot;), hunk.target().lines());
1140 
1141             assertEquals(1, hunk.added());
1142             assertEquals(0, hunk.removed());
1143             assertEquals(0, hunk.modified());
1144         }
1145     }
1146 
1147     @ParameterizedTest
1148     @EnumSource(VCS.class)
1149     void testCommitMetadata(VCS vcs) throws IOException {
1150         try (var dir = new TemporaryDirectory()) {
1151             var r = Repository.init(dir.path(), vcs);
1152 
1153             var readme = dir.path().resolve(&quot;README&quot;);
1154             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1155             r.add(readme);
1156             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1157 
1158             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1159             r.add(readme);
1160             var second = r.commit(&quot;Modified README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1161 
1162             var metadata = r.commitMetadata();
1163             assertEquals(2, metadata.size());
1164 
1165             assertEquals(first, metadata.get(0).hash());
1166             assertEquals(List.of(&quot;Added README&quot;), metadata.get(0).message());
1167 
1168             assertEquals(second, metadata.get(1).hash());
1169             assertEquals(List.of(&quot;Modified README&quot;), metadata.get(1).message());
1170         }
1171     }
1172 
1173     @ParameterizedTest
1174     @EnumSource(VCS.class)
1175     void testTrivialMerge(VCS vcs) throws IOException {
1176         try (var dir = new TemporaryDirectory()) {
1177             var r = Repository.init(dir.path(), vcs);
1178 
1179             var readme = dir.path().resolve(&quot;README&quot;);
1180             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1181             r.add(readme);
1182             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1183 
1184             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1185             r.add(readme);
1186             var second = r.commit(&quot;Modified README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1187 
1188             r.checkout(first, false);
1189 
1190             var contributing = dir.path().resolve(&quot;CONTRIBUTING&quot;);
1191             Files.write(contributing, List.of(&quot;Send those patches!&quot;));
1192             r.add(contributing);
1193             var third = r.commit(&quot;Added contributing&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1194 
1195             r.merge(second);
1196             r.commit(&quot;Merge&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1197 
1198             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
1199             var commits = r.commits(refspec).asList();
1200 
1201             assertEquals(4, commits.size());
1202 
1203             var merge = commits.get(0);
1204             assertEquals(List.of(&quot;Merge&quot;), merge.message());
1205 
1206             var parents = new HashSet&lt;&gt;(merge.parents());
1207             assertEquals(2, parents.size());
1208             assertTrue(parents.contains(second));
1209             assertTrue(parents.contains(third));
1210 
1211             var diffs = merge.parentDiffs();
1212             assertEquals(2, diffs.size());
1213 
1214             var diff1 = diffs.get(0);
1215             assertEquals(merge.hash(), diff1.to());
1216             assertEquals(0, diff1.patches().size());
1217             assertTrue(parents.contains(diff1.from()));
1218 
1219             var diff2 = diffs.get(1);
1220             assertEquals(merge.hash(), diff2.to());
1221             assertEquals(0, diff2.patches().size());
1222             assertTrue(parents.contains(diff2.from()));
1223         }
1224     }
1225 
1226     @ParameterizedTest
1227     @EnumSource(VCS.class)
1228     void testMergeWithEdit(VCS vcs) throws IOException {
1229         try (var dir = new TemporaryDirectory()) {
1230             var r = Repository.init(dir.path(), vcs);
1231 
1232             var readme = dir.path().resolve(&quot;README&quot;);
1233             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1234             r.add(readme);
1235             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1236 
1237             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1238             r.add(readme);
1239             var second = r.commit(&quot;Modified README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1240 
1241             r.checkout(first, false);
1242 
1243             var contributing = dir.path().resolve(&quot;CONTRIBUTING&quot;);
1244             Files.write(contributing, List.of(&quot;Send those patches!&quot;));
1245             r.add(contributing);
1246             var third = r.commit(&quot;Added contributing&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1247 
1248             r.merge(second);
1249 
1250             Files.write(readme, List.of(&quot;One last line&quot;), WRITE, APPEND);
1251             r.add(readme);
1252             r.commit(&quot;Merge&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1253 
1254             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
1255             var commits = r.commits(refspec).asList();
1256 
1257             assertEquals(4, commits.size());
1258 
1259             var merge = commits.get(0);
1260             assertEquals(List.of(&quot;Merge&quot;), merge.message());
1261 
1262             var parents = new HashSet&lt;&gt;(merge.parents());
1263             assertEquals(2, parents.size());
1264             assertTrue(parents.contains(second));
1265             assertTrue(parents.contains(third));
1266 
1267             var diffs = merge.parentDiffs();
1268             assertEquals(2, diffs.size());
1269 
1270             var secondDiff = diffs.stream().filter(d -&gt; d.from().equals(second)).findFirst().get();
1271             assertEquals(merge.hash(), secondDiff.to());
1272             assertEquals(1, secondDiff.patches().size());
1273             var secondPatch = secondDiff.patches().get(0).asTextualPatch();
1274 
1275             assertEquals(Path.of(&quot;README&quot;), secondPatch.source().path().get());
1276             assertEquals(Path.of(&quot;README&quot;), secondPatch.target().path().get());
1277             assertTrue(secondPatch.status().isModified());
1278             assertEquals(1, secondPatch.hunks().size());
1279 
1280             var secondHunk = secondPatch.hunks().get(0);
1281             assertEquals(List.of(), secondHunk.source().lines());
1282             assertEquals(List.of(&quot;One last line&quot;), secondHunk.target().lines());
1283 
1284             assertEquals(2, secondHunk.source().range().start());
1285             assertEquals(0, secondHunk.source().range().count());
1286             assertEquals(3, secondHunk.target().range().start());
1287             assertEquals(1, secondHunk.target().range().count());
1288 
1289             var thirdDiff = diffs.stream().filter(d -&gt; d.from().equals(third)).findFirst().get();
1290             assertEquals(merge.hash(), thirdDiff.to());
1291             assertEquals(1, thirdDiff.patches().size());
1292             var thirdPatch = thirdDiff.patches().get(0).asTextualPatch();
1293 
1294             assertEquals(Path.of(&quot;README&quot;), thirdPatch.source().path().get());
1295             assertEquals(Path.of(&quot;README&quot;), thirdPatch.target().path().get());
1296             assertTrue(thirdPatch.status().isModified());
1297             assertEquals(1, thirdPatch.hunks().size());
1298 
1299             var thirdHunk = thirdPatch.hunks().get(0);
1300             assertEquals(List.of(), thirdHunk.source().lines());
1301             assertEquals(List.of(&quot;One more line&quot;, &quot;One last line&quot;), thirdHunk.target().lines());
1302 
1303             assertEquals(1, thirdHunk.source().range().start());
1304             assertEquals(0, thirdHunk.source().range().count());
1305             assertEquals(2, thirdHunk.target().range().start());
1306             assertEquals(2, thirdHunk.target().range().count());
1307         }
1308     }
1309 
1310     @ParameterizedTest
1311     @EnumSource(VCS.class)
1312     void testDefaultBranch(VCS vcs) throws IOException {
1313         try (var dir = new TemporaryDirectory()) {
1314             var r = Repository.init(dir.path(), vcs);
1315             var expected = vcs == VCS.GIT ? &quot;master&quot; : &quot;default&quot;;
1316             assertEquals(expected, r.defaultBranch().name());
1317         }
1318     }
1319 
1320     @ParameterizedTest
1321     @EnumSource(VCS.class)
1322     void testPaths(VCS vcs) throws IOException {
1323         try (var dir = new TemporaryDirectory()) {
1324             var r = Repository.init(dir.path(), vcs);
1325             var remote = vcs == VCS.GIT ? &quot;origin&quot; : &quot;default&quot;;
1326             r.setPaths(remote, &quot;http://pull&quot;, &quot;http://push&quot;);
1327             assertEquals(&quot;http://pull&quot;, r.pullPath(remote));
1328             assertEquals(&quot;http://push&quot;, r.pushPath(remote));
1329         }
1330     }
1331 
1332     @ParameterizedTest
1333     @EnumSource(VCS.class)
1334     void testIsValidRevisionRange(VCS vcs) throws IOException {
1335         try (var dir = new TemporaryDirectory()) {
1336             var r = Repository.init(dir.path(), vcs);
1337             assertFalse(r.isValidRevisionRange(&quot;foo&quot;));
1338 
1339             var readme = dir.path().resolve(&quot;README&quot;);
1340             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1341             r.add(readme);
1342             r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1343 
1344             assertTrue(r.isValidRevisionRange(r.defaultBranch().toString()));
1345         }
1346     }
1347 
1348     @ParameterizedTest
1349     @EnumSource(VCS.class)
1350     void testDefaultTag(VCS vcs) throws IOException {
1351         try (var dir = new TemporaryDirectory()) {
1352             var r = Repository.init(dir.path(), vcs);
1353             var expected = vcs == VCS.GIT ? Optional.empty() : Optional.of(new Tag(&quot;tip&quot;));
1354             assertEquals(expected, r.defaultTag());
1355         }
1356     }
1357 
1358     @ParameterizedTest
1359     @EnumSource(VCS.class)
1360     void testTag(VCS vcs) throws IOException {
1361         try (var dir = new TemporaryDirectory()) {
1362             var r = Repository.init(dir.path(), vcs);
1363 
1364             var readme = dir.path().resolve(&quot;README&quot;);
1365             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1366             r.add(readme);
1367             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1368 
1369             r.tag(first, &quot;test&quot;, &quot;Tagging test&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1370             var defaultTag = r.defaultTag().orElse(null);
1371             var nonDefaultTags = r.tags().stream()
1372                                   .filter(tag -&gt; !tag.equals(defaultTag))
1373                                   .map(Tag::toString)
1374                                   .collect(Collectors.toList());
1375             assertEquals(List.of(&quot;test&quot;), nonDefaultTags);
1376         }
1377     }
1378 
1379     @ParameterizedTest
1380     @EnumSource(VCS.class)
1381     void testIsClean(VCS vcs) throws IOException {
1382         try (var dir = new TemporaryDirectory()) {
1383             var r = Repository.init(dir.path(), vcs);
1384             assertTrue(r.isClean());
1385 
1386             var readme = dir.path().resolve(&quot;README&quot;);
1387             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1388             assertFalse(r.isClean());
1389 
1390             r.add(readme);
1391             assertFalse(r.isClean());
1392 
1393             r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1394             assertTrue(r.isClean());
1395 
1396             Files.delete(readme);
1397             assertFalse(r.isClean());
1398 
1399             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1400             assertTrue(r.isClean());
1401         }
1402     }
1403 }
    </pre>
  </body>
</html>