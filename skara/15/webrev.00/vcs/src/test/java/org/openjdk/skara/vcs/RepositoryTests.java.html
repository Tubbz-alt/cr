<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New vcs/src/test/java/org/openjdk/skara/vcs/RepositoryTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.vcs;
  24 
  25 import org.openjdk.skara.test.TemporaryDirectory;
  26 
  27 import org.junit.jupiter.params.ParameterizedTest;
  28 import org.junit.jupiter.params.provider.EnumSource;
  29 
  30 import java.io.IOException;
  31 import java.net.URI;
  32 import java.nio.file.*;
  33 import java.nio.file.attribute.*;
  34 import java.util.*;
  35 import java.util.stream.Collectors;
  36 
  37 import static java.nio.file.StandardOpenOption.*;
  38 import static org.junit.jupiter.api.Assertions.*;
  39 
  40 public class RepositoryTests {
  41 
  42     @ParameterizedTest
  43     @EnumSource(VCS.class)
  44     void testExistsOnMissingDirectory(VCS vcs) throws IOException {
  45         var d = Paths.get(&quot;/&quot;, &quot;this&quot;, &quot;path&quot;, &quot;does&quot;, &quot;not&quot;, &quot;exist&quot;);
  46         var r = Repository.get(d);
  47         assertTrue(r.isEmpty());
  48     }
  49 
  50     @ParameterizedTest
  51     @EnumSource(VCS.class)
  52     void testExistsOnEmptyDirectory(VCS vcs) throws IOException {
  53         try (var dir = new TemporaryDirectory()) {
  54             var r = Repository.get(dir.path());
  55             assertTrue(r.isEmpty());
  56         }
  57     }
  58 
  59     @ParameterizedTest
  60     @EnumSource(VCS.class)
  61     void testExistsOnInitializedRepository(VCS vcs) throws IOException {
  62         try (var dir = new TemporaryDirectory()) {
  63             var r = Repository.init(dir.path(), vcs);
  64             assertTrue(r.exists());
  65         }
  66     }
  67 
  68     @ParameterizedTest
  69     @EnumSource(VCS.class)
  70     void testExistsOnSubdir() throws IOException {
  71         try (var dir = new TemporaryDirectory()) {
  72             var r = Repository.init(dir.path(), VCS.GIT);
  73             assertTrue(r.exists());
  74 
  75             var subdir = Paths.get(dir.toString(), &quot;test&quot;);
  76             Files.createDirectories(subdir);
  77             var r2 = Repository.get(subdir);
  78             assertTrue(r2.get().exists());
  79         }
  80     }
  81 
  82     @ParameterizedTest
  83     @EnumSource(VCS.class)
  84     void testRootOnTopLevel() throws IOException {
  85         try (var dir = new TemporaryDirectory()) {
  86             var r = Repository.init(dir.path(), VCS.GIT);
  87             assertEquals(dir.toString(), r.root().toString());
  88         }
  89     }
  90 
  91     @ParameterizedTest
  92     @EnumSource(VCS.class)
  93     void testRootOnSubdirectory(VCS vcs) throws IOException {
  94         try (var dir = new TemporaryDirectory()) {
  95             var r = Repository.init(dir.path(), vcs);
  96             assertEquals(dir.toString(), r.root().toString());
  97 
  98             var subdir = Paths.get(dir.toString(), &quot;sub&quot;);
  99             Files.createDirectories(subdir);
 100 
 101             var r2 = Repository.get(subdir);
 102             assertEquals(dir.toString(), r2.get().root().toString());
 103         }
 104     }
 105 
 106     @ParameterizedTest
 107     @EnumSource(VCS.class)
 108     void testResolveOnEmptyRepository(VCS vcs) throws IOException {
 109         try (var dir = new TemporaryDirectory()) {
 110             var r = Repository.init(dir.path(), vcs);
 111             assertTrue(r.resolve(&quot;HEAD&quot;).isEmpty());
 112         }
 113     }
 114 
 115     @ParameterizedTest
 116     @EnumSource(VCS.class)
 117     void testResolveWithHEAD(VCS vcs) throws IOException {
 118         try (var dir = new TemporaryDirectory()) {
 119             var r = Repository.init(dir.path(), vcs);
 120 
 121             var readme = dir.path().resolve(&quot;README&quot;);
 122             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 123 
 124             r.add(readme);
 125             var head = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 126             assertEquals(head, r.head());
 127         }
 128     }
 129 
 130     @ParameterizedTest
 131     @EnumSource(VCS.class)
 132     void testConfig(VCS vcs) throws IOException {
 133         try (var dir = new TemporaryDirectory()) {
 134             var r = Repository.init(dir.path(), vcs);
 135 
 136             if (vcs == VCS.GIT) {
 137                 var config = dir.path().resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 138                 Files.write(config, List.of(&quot;[user]&quot;, &quot;name = duke&quot;), WRITE, APPEND);
 139                 assertEquals(List.of(&quot;duke&quot;), r.config(&quot;user.name&quot;));
 140             } else if (vcs == VCS.HG) {
 141                 var config = dir.path().resolve(&quot;.hg&quot;).resolve(&quot;hgrc&quot;);
 142                 Files.write(config, List.of(&quot;[ui]&quot;, &quot;username = duke&quot;), WRITE, CREATE);
 143                 assertEquals(List.of(&quot;duke&quot;), r.config(&quot;ui.username&quot;));
 144             }
 145 
 146             assertEquals(&quot;duke&quot;, r.username().get());
 147         }
 148     }
 149 
 150     @ParameterizedTest
 151     @EnumSource(VCS.class)
 152     void testCurrentBranchOnEmptyRepository(VCS vcs) throws IOException {
 153         try (var dir = new TemporaryDirectory()) {
 154             var r = Repository.init(dir.path(), vcs);
 155             assertEquals(r.defaultBranch(), r.currentBranch());
 156         }
 157     }
 158 
 159     @ParameterizedTest
 160     @EnumSource(VCS.class)
 161     void testCheckout(VCS vcs) throws IOException {
 162         try (var dir = new TemporaryDirectory()) {
 163             var r = Repository.init(dir.path(), vcs);
 164 
 165             var readme = dir.path().resolve(&quot;README&quot;);
 166             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 167             r.add(readme);
 168 
 169             var head1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 170             assertEquals(head1, r.head());
 171 
 172             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 173             r.add(readme);
 174 
 175             var head2 = r.commit(&quot;Add one more line&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 176             assertEquals(head2, r.head());
 177 
 178             r.checkout(head1, false);
 179             assertEquals(head1, r.head());
 180 
 181             r.checkout(head2, false);
 182             assertEquals(head2, r.head());
 183         }
 184     }
 185 
 186     @ParameterizedTest
 187     @EnumSource(VCS.class)
 188     void testLines(VCS vcs) throws IOException {
 189         try (var dir = new TemporaryDirectory()) {
 190             var r = Repository.init(dir.path(), vcs);
 191 
 192             var readme = dir.path().resolve(&quot;README&quot;);
 193             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 194             r.add(readme);
 195 
 196             var head1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 197             assertEquals(List.of(&quot;Hello, readme!&quot;),
 198                          r.lines(readme, head1).orElseThrow());
 199 
 200             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 201             r.add(readme);
 202 
 203             var head2 = r.commit(&quot;Add one more line&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 204             assertEquals(List.of(&quot;Hello, readme!&quot;, &quot;Another line&quot;),
 205                          r.lines(readme, head2).orElseThrow());
 206         }
 207     }
 208 
 209     @ParameterizedTest
 210     @EnumSource(VCS.class)
 211     void testLinesInSubdir(VCS vcs) throws IOException {
 212         try (var dir = new TemporaryDirectory()) {
 213             Repository.init(dir.path(), vcs);
 214 
 215             var subdir = dir.path().resolve(&quot;sub&quot;);
 216             Files.createDirectories(subdir);
 217             var r = Repository.get(subdir).get();
 218 
 219             var readme = subdir.getParent().resolve(&quot;README&quot;);
 220             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 221             r.add(readme);
 222 
 223             var head = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 224             assertEquals(List.of(&quot;Hello, readme!&quot;),
 225                          r.lines(readme, head).orElseThrow());
 226 
 227             var example = subdir.resolve(&quot;EXAMPLE&quot;);
 228             Files.write(example, List.of(&quot;An example&quot;));
 229             r.add(example);
 230 
 231             var head2 = r.commit(&quot;Add EXAMPLE&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 232             assertEquals(List.of(&quot;An example&quot;),
 233                          r.lines(example, head2).orElseThrow());
 234         }
 235     }
 236 
 237     @ParameterizedTest
 238     @EnumSource(VCS.class)
 239     void testCommitListingOnEmptyRepo(VCS vcs) throws IOException {
 240         try (var dir = new TemporaryDirectory()) {
 241             var r = Repository.init(dir.path(), vcs);
 242             assertTrue(r.commits().asList().isEmpty());
 243         }
 244     }
 245 
 246     @ParameterizedTest
 247     @EnumSource(VCS.class)
 248     void testCommitListingWithSingleCommit(VCS vcs) throws IOException {
 249         try (var dir = new TemporaryDirectory()) {
 250             var r = Repository.init(dir.path(), vcs);
 251 
 252             var readme = dir.path().resolve(&quot;README&quot;);
 253             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 254 
 255             r.add(readme);
 256 
 257             var committerName = vcs == VCS.GIT ? &quot;bot&quot; : &quot;duke&quot;;
 258             var committerEmail = vcs == VCS.GIT ? &quot;bot@openjdk.java.net&quot; : &quot;duke@openjdk.java.net&quot;;
 259             var hash = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;, committerName, committerEmail);
 260 
 261             var commits = r.commits().asList();
 262             assertEquals(1, commits.size());
 263 
 264             var commit = commits.get(0);
 265             assertEquals(&quot;duke&quot;, commit.author().name());
 266             assertEquals(&quot;duke@openjdk.java.net&quot;, commit.author().email());
 267             assertEquals(committerName, commit.committer().name());
 268             assertEquals(committerEmail, commit.committer().email());
 269 
 270             assertEquals(List.of(&quot;Add README&quot;), commit.message());
 271 
 272             assertEquals(1, commit.numParents());
 273             assertEquals(1, commit.parents().size());
 274 
 275             var nullHash = &quot;0&quot;.repeat(40);
 276             var parent = commit.parents().get(0);
 277             assertEquals(nullHash, parent.hex());
 278 
 279             assertTrue(commit.isInitialCommit());
 280             assertFalse(commit.isMerge());
 281             assertEquals(hash, commit.hash());
 282 
 283             var diffs = commit.parentDiffs();
 284             assertEquals(1, diffs.size());
 285 
 286             var diff = diffs.get(0);
 287             assertEquals(nullHash, diff.from().hex());
 288             assertEquals(hash, diff.to());
 289 
 290             assertEquals(0, diff.removed());
 291             assertEquals(0, diff.modified());
 292             assertEquals(1, diff.added());
 293 
 294             var patches = diff.patches();
 295             assertEquals(1, patches.size());
 296 
 297             var patch = patches.get(0).asTextualPatch();
 298             assertTrue(patch.status().isAdded());
 299 
 300             assertTrue(patch.source().path().isEmpty());
 301             assertTrue(patch.source().type().isEmpty());
 302 
 303             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 304             assertTrue(patch.target().type().get().isRegularNonExecutable());
 305 
 306             var hunks = patch.hunks();
 307             assertEquals(1, hunks.size());
 308 
 309             var hunk = hunks.get(0);
 310             assertEquals(new Range(0, 0), hunk.source().range());
 311             assertEquals(new Range(1, 1), hunk.target().range());
 312 
 313             assertEquals(List.of(), hunk.source().lines());
 314             assertEquals(List.of(&quot;Hello, readme!&quot;), hunk.target().lines());
 315         }
 316     }
 317 
 318     @ParameterizedTest
 319     @EnumSource(VCS.class)
 320     void testCommitListingWithMultipleCommits(VCS vcs) throws IOException {
 321         try (var dir = new TemporaryDirectory()) {
 322             var r = Repository.init(dir.path(), vcs);
 323 
 324             var readme = dir.path().resolve(&quot;README&quot;);
 325             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 326 
 327             r.add(readme);
 328             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 329 
 330             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 331             r.add(readme);
 332             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 333 
 334             var commits = r.commits().asList();
 335             assertEquals(2, commits.size());
 336 
 337             var commit = commits.get(0);
 338             assertEquals(&quot;duke&quot;, commit.author().name());
 339             assertEquals(&quot;duke@openjdk.java.net&quot;, commit.author().email());
 340 
 341             assertEquals(List.of(&quot;Modify README&quot;), commit.message());
 342 
 343             assertEquals(1, commit.numParents());
 344             assertEquals(1, commit.parents().size());
 345 
 346             var parent = commit.parents().get(0);
 347             assertEquals(hash1, parent);
 348 
 349             assertFalse(commit.isInitialCommit());
 350             assertFalse(commit.isMerge());
 351             assertEquals(hash2, commit.hash());
 352 
 353             var diffs = commit.parentDiffs();
 354             assertEquals(1, diffs.size());
 355 
 356             var diff = diffs.get(0);
 357             assertEquals(hash1, diff.from());
 358             assertEquals(hash2, diff.to());
 359 
 360             assertEquals(0, diff.removed());
 361             assertEquals(0, diff.modified());
 362             assertEquals(1, diff.added());
 363 
 364             var patches = diff.patches();
 365             assertEquals(1, patches.size());
 366 
 367             var patch = patches.get(0).asTextualPatch();
 368             assertTrue(patch.status().isModified());
 369             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 370             assertTrue(patch.source().type().get().isRegularNonExecutable());
 371             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 372             assertTrue(patch.target().type().get().isRegularNonExecutable());
 373 
 374             var hunks = patch.hunks();
 375             assertEquals(1, hunks.size());
 376 
 377             var hunk = hunks.get(0);
 378             assertEquals(new Range(1, 0), hunk.source().range());
 379             assertEquals(new Range(2, 1), hunk.target().range());
 380 
 381             assertEquals(List.of(), hunk.source().lines());
 382             assertEquals(List.of(&quot;Another line&quot;), hunk.target().lines());
 383         }
 384     }
 385 
 386     @ParameterizedTest
 387     @EnumSource(VCS.class)
 388     void testSquashDeletes(VCS vcs) throws IOException {
 389         try (var dir = new TemporaryDirectory()) {
 390             var r = Repository.init(dir.path(), vcs);
 391 
 392             var file1 = dir.path().resolve(&quot;file1.txt&quot;);
 393             Files.write(file1, List.of(&quot;Hello, file 1!&quot;));
 394             var file2 = dir.path().resolve(&quot;file2.txt&quot;);
 395             Files.write(file2, List.of(&quot;Hello, file 2!&quot;));
 396             var file3 = dir.path().resolve(&quot;file3.txt&quot;);
 397             Files.write(file3, List.of(&quot;Hello, file 3!&quot;));
 398 
 399             r.add(file1, file2, file3);
 400             var hash1 = r.commit(&quot;Add files&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 401 
 402             Files.delete(file2);
 403             r.remove(file2);
 404             var hash2 = r.commit(&quot;Remove file 2&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 405 
 406             Files.delete(file3);
 407             r.remove(file3);
 408             var hash3 = r.commit(&quot;Remove file 3&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 409 
 410             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 411             assertEquals(3, r.commits(refspec).asList().size());
 412 
 413             r.checkout(hash1, false);
 414             r.squash(hash3);
 415             r.commit(&quot;Squashed remove of file 2 and 3&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 416 
 417             refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 418             var commits = r.commits(refspec).asList();
 419             assertEquals(2, commits.size());
 420 
 421             assertEquals(hash1, commits.get(1).hash());
 422 
 423             var head = commits.get(0);
 424             assertNotEquals(hash2, head);
 425             assertNotEquals(hash3, head);
 426 
 427             assertEquals(hash1, head.parents().get(0));
 428             assertFalse(head.isInitialCommit());
 429             assertFalse(head.isMerge());
 430 
 431             var diffs = head.parentDiffs();
 432             assertEquals(1, diffs.size());
 433 
 434             var diff = diffs.get(0);
 435             assertEquals(hash1, diff.from());
 436             assertEquals(head.hash(), diff.to());
 437 
 438             assertEquals(2, diff.removed());
 439             assertEquals(0, diff.modified());
 440             assertEquals(0, diff.added());
 441         }
 442     }
 443 
 444     @ParameterizedTest
 445     @EnumSource(VCS.class)
 446     void testSquash(VCS vcs) throws IOException {
 447         try (var dir = new TemporaryDirectory()) {
 448             var r = Repository.init(dir.path(), vcs);
 449 
 450             var readme = dir.path().resolve(&quot;README&quot;);
 451             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 452 
 453             r.add(readme);
 454             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 455 
 456             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 457             r.add(readme);
 458             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 459 
 460             Files.write(readme, List.of(&quot;A final line&quot;), WRITE, APPEND);
 461             r.add(readme);
 462             var hash3 = r.commit(&quot;Modify README again&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 463 
 464             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 465             assertEquals(3, r.commits(refspec).asList().size());
 466 
 467             r.checkout(hash1, false);
 468             r.squash(hash3);
 469             r.commit(&quot;Squashed commits 2 and 3&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 470 
 471             refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 472             var commits = r.commits(refspec).asList();
 473             assertEquals(2, commits.size());
 474 
 475             assertEquals(hash1, commits.get(1).hash());
 476 
 477             var head = commits.get(0);
 478             assertNotEquals(hash2, head);
 479             assertNotEquals(hash3, head);
 480 
 481             assertEquals(hash1, head.parents().get(0));
 482             assertFalse(head.isInitialCommit());
 483             assertFalse(head.isMerge());
 484 
 485             var diffs = head.parentDiffs();
 486             assertEquals(1, diffs.size());
 487 
 488             var diff = diffs.get(0);
 489             assertEquals(hash1, diff.from());
 490             assertEquals(head.hash(), diff.to());
 491 
 492             assertEquals(0, diff.removed());
 493             assertEquals(0, diff.modified());
 494             assertEquals(2, diff.added());
 495 
 496             var patches = diff.patches();
 497             assertEquals(1, patches.size());
 498 
 499             var patch = patches.get(0).asTextualPatch();
 500             assertTrue(patch.status().isModified());
 501             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 502             assertTrue(patch.source().type().get().isRegularNonExecutable());
 503             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 504             assertTrue(patch.target().type().get().isRegularNonExecutable());
 505 
 506             var hunks = patch.hunks();
 507             assertEquals(1, hunks.size());
 508 
 509             var hunk = hunks.get(0);
 510             assertEquals(new Range(1, 0), hunk.source().range());
 511             assertEquals(new Range(2, 2), hunk.target().range());
 512 
 513             assertEquals(List.of(), hunk.source().lines());
 514             assertEquals(List.of(&quot;Another line&quot;, &quot;A final line&quot;), hunk.target().lines());
 515         }
 516     }
 517 
 518     @ParameterizedTest
 519     @EnumSource(VCS.class)
 520     void testMergeBase(VCS vcs) throws IOException {
 521         try (var dir = new TemporaryDirectory()) {
 522             var r = Repository.init(dir.path(), vcs);
 523 
 524             var readme = dir.path().resolve(&quot;README&quot;);
 525             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 526 
 527             r.add(readme);
 528             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 529 
 530             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 531             r.add(readme);
 532             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 533 
 534             r.checkout(hash1, false);
 535             Files.write(readme, List.of(&quot;A conflicting line&quot;), WRITE, APPEND);
 536             r.add(readme);
 537             var hash3 = r.commit(&quot;Branching README modification&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 538 
 539             assertEquals(hash1, r.mergeBase(hash2, hash3));
 540         }
 541     }
 542 
 543     @ParameterizedTest
 544     @EnumSource(VCS.class)
 545     void testRebase(VCS vcs) throws IOException {
 546         try (var dir = new TemporaryDirectory()) {
 547             var r = Repository.init(dir.path(), vcs);
 548 
 549             var readme = dir.path().resolve(&quot;README&quot;);
 550             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 551 
 552             r.add(readme);
 553             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 554 
 555             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 556             r.add(readme);
 557             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 558 
 559             r.checkout(hash1, false);
 560 
 561             var contributing = dir.path().resolve(&quot;CONTRIBUTING&quot;);
 562             Files.write(contributing, List.of(&quot;Keep the patches coming&quot;));
 563             r.add(contributing);
 564             var hash3 = r.commit(&quot;Add independent change&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 565 
 566             var committerName = vcs == VCS.GIT ? &quot;bot&quot; : &quot;duke&quot;;
 567             var committerEmail = vcs == VCS.GIT ? &quot;bot@openjdk.java.net&quot; : &quot;duke@openjdk.java.net&quot;;
 568             r.rebase(hash2, committerName, committerEmail);
 569 
 570             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 571             var commits = r.commits(refspec).asList();
 572             assertEquals(3, commits.size());
 573             assertEquals(hash2, commits.get(1).hash());
 574             assertEquals(hash1, commits.get(2).hash());
 575 
 576             assertEquals(&quot;duke&quot;, commits.get(0).author().name());
 577             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(0).author().email());
 578             assertEquals(committerName, commits.get(0).committer().name());
 579             assertEquals(committerEmail, commits.get(0).committer().email());
 580 
 581             assertEquals(&quot;duke&quot;, commits.get(1).author().name());
 582             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(1).author().email());
 583             assertEquals(&quot;duke&quot;, commits.get(1).committer().name());
 584             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(1).committer().email());
 585 
 586             assertEquals(&quot;duke&quot;, commits.get(2).author().name());
 587             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(2).author().email());
 588             assertEquals(&quot;duke&quot;, commits.get(2).committer().name());
 589             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(2).committer().email());
 590 
 591             var head = commits.get(0);
 592             assertEquals(hash2, head.parents().get(0));
 593             assertEquals(List.of(&quot;Add independent change&quot;), head.message());
 594 
 595             var diffs = head.parentDiffs();
 596             assertEquals(1, diffs.size());
 597             var diff = diffs.get(0);
 598 
 599             assertEquals(0, diff.removed());
 600             assertEquals(0, diff.modified());
 601             assertEquals(1, diff.added());
 602 
 603             var patches = diff.patches();
 604             assertEquals(1, patches.size());
 605             var patch = patches.get(0).asTextualPatch();
 606             assertEquals(Path.of(&quot;CONTRIBUTING&quot;), patch.target().path().get());
 607 
 608             var hunks = patch.hunks();
 609             assertEquals(1, hunks.size());
 610             var hunk = hunks.get(0);
 611             assertEquals(List.of(&quot;Keep the patches coming&quot;), hunk.target().lines());
 612         }
 613     }
 614 
 615     @ParameterizedTest
 616     @EnumSource(VCS.class)
 617     void testInitializedRepositoryIsEmpty(VCS vcs) throws IOException {
 618         try (var dir = new TemporaryDirectory()) {
 619             var r = Repository.init(dir.path(), vcs);
 620             assertTrue(r.isEmpty());
 621         }
 622     }
 623 
 624     @ParameterizedTest
 625     @EnumSource(VCS.class)
 626     void testRepositoryWithCommitIsNonEmpty(VCS vcs) throws IOException {
 627         try (var dir = new TemporaryDirectory()) {
 628             var r = Repository.init(dir.path(), vcs);
 629 
 630             var readme = dir.path().resolve(&quot;README&quot;);
 631             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 632 
 633             r.add(readme);
 634             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 635 
 636             assertFalse(r.isEmpty());
 637         }
 638     }
 639 
 640     @ParameterizedTest
 641     @EnumSource(VCS.class)
 642     void testEmptyRepositoryIsHealthy(VCS vcs) throws IOException {
 643         try (var dir = new TemporaryDirectory()) {
 644             var r = Repository.init(dir.path(), vcs);
 645             assertTrue(r.isHealthy());
 646         }
 647     }
 648 
 649     @ParameterizedTest
 650     @EnumSource(VCS.class)
 651     void testNonEmptyRepositoryIsHealthy(VCS vcs) throws IOException {
 652         try (var dir = new TemporaryDirectory()) {
 653             var r = Repository.init(dir.path(), vcs);
 654 
 655             var readme = dir.path().resolve(&quot;README&quot;);
 656             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 657 
 658             r.add(readme);
 659             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 660 
 661             assertTrue(r.isHealthy());
 662         }
 663     }
 664 
 665     @ParameterizedTest
 666     @EnumSource(VCS.class)
 667     void testBranchesOnEmptyRepository(VCS vcs) throws IOException {
 668         try (var dir = new TemporaryDirectory()) {
 669             var r = Repository.init(dir.path(), vcs);
 670             var expected = vcs == VCS.GIT ? List.of() : List.of(new Branch(&quot;default&quot;));
 671             assertEquals(List.of(), r.branches());
 672         }
 673     }
 674 
 675     @ParameterizedTest
 676     @EnumSource(VCS.class)
 677     void testBranchesOnNonEmptyRepository(VCS vcs) throws IOException {
 678         try (var dir = new TemporaryDirectory()) {
 679             var r = Repository.init(dir.path(), vcs);
 680 
 681             var readme = dir.path().resolve(&quot;README&quot;);
 682             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 683 
 684             r.add(readme);
 685             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 686 
 687             assertEquals(List.of(r.defaultBranch()), r.branches());
 688         }
 689     }
 690 
 691     @ParameterizedTest
 692     @EnumSource(VCS.class)
 693     void testTagsOnEmptyRepository(VCS vcs) throws IOException {
 694         try (var dir = new TemporaryDirectory()) {
 695             var r = Repository.init(dir.path(), vcs);
 696             var expected = vcs == VCS.GIT ? List.of() : List.of(new Tag(&quot;tip&quot;));
 697             assertEquals(expected, r.tags());
 698         }
 699     }
 700 
 701     @ParameterizedTest
 702     @EnumSource(VCS.class)
 703     void testTagsOnNonEmptyRepository(VCS vcs) throws IOException {
 704         try (var dir = new TemporaryDirectory()) {
 705             var r = Repository.init(dir.path(), vcs);
 706 
 707             var readme = dir.path().resolve(&quot;README&quot;);
 708             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 709 
 710             r.add(readme);
 711             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 712 
 713             var expected = vcs == VCS.GIT ? List.of() : List.of(new Tag(&quot;tip&quot;));
 714             assertEquals(expected, r.tags());
 715         }
 716     }
 717 
 718     @ParameterizedTest
 719     @EnumSource(VCS.class)
 720     void testFetchAndPush(VCS vcs) throws IOException {
 721         try (var dir = new TemporaryDirectory()) {
 722             var upstream = Repository.init(dir.path(), vcs);
 723 
 724             if (vcs == VCS.GIT) {
 725                 Files.write(upstream.root().resolve(&quot;.git&quot;).resolve(&quot;config&quot;),
 726                             List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch=ignore&quot;),
 727                             WRITE, APPEND);
 728             }
 729 
 730             var readme = dir.path().resolve(&quot;README&quot;);
 731             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 732 
 733             upstream.add(readme);
 734             upstream.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 735 
 736             try (var dir2 = new TemporaryDirectory()) {
 737                 var downstream = Repository.init(dir2.path(), vcs);
 738 
 739                 var upstreamURI = URI.create(&quot;file://&quot; + dir.toString());
 740 
 741                 var fetchHead = downstream.fetch(upstreamURI, downstream.defaultBranch().name());
 742                 downstream.checkout(fetchHead, false);
 743 
 744                 var downstreamReadme = dir2.path().resolve(&quot;README&quot;);
 745                 Files.write(downstreamReadme, List.of(&quot;Downstream change&quot;), WRITE, APPEND);
 746 
 747                 downstream.add(downstreamReadme);
 748                 var head = downstream.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 749 
 750                 downstream.push(head, upstreamURI, downstream.defaultBranch().name());
 751             }
 752 
 753             upstream.checkout(upstream.resolve(upstream.defaultBranch().name()).get(), false);
 754 
 755             var commits = upstream.commits().asList();
 756             assertEquals(2, commits.size());
 757         }
 758     }
 759 
 760     @ParameterizedTest
 761     @EnumSource(VCS.class)
 762     void testClean(VCS vcs) throws IOException {
 763         try (var dir = new TemporaryDirectory()) {
 764             var r = Repository.init(dir.path(), vcs);
 765             r.clean();
 766 
 767             var readme = dir.path().resolve(&quot;README&quot;);
 768             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 769 
 770             r.add(readme);
 771             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 772 
 773             r.clean();
 774 
 775             assertEquals(hash1, r.head());
 776 
 777             Files.write(readme, List.of(&quot;A random change&quot;), WRITE, APPEND);
 778 
 779             r.clean();
 780 
 781             assertEquals(List.of(&quot;Hello, readme!&quot;), Files.readAllLines(readme));
 782 
 783             var untracked = dir.path().resolve(&quot;UNTRACKED&quot;);
 784             Files.write(untracked, List.of(&quot;Random text&quot;));
 785 
 786             r.clean();
 787 
 788             assertFalse(Files.exists(untracked));
 789 
 790             // Mercurial cannot currently deal with this situation
 791             if (vcs != VCS.HG) {
 792                 var subRepo = Repository.init(dir.path().resolve(&quot;submodule&quot;), vcs);
 793                 var subRepoFile = subRepo.root().resolve(&quot;file.txt&quot;);
 794                 Files.write(subRepoFile, List.of(&quot;Looks like a file in a submodule&quot;));
 795 
 796                 r.clean();
 797 
 798                 assertFalse(Files.exists(subRepoFile));
 799             }
 800         }
 801     }
 802 
 803     @ParameterizedTest
 804     @EnumSource(VCS.class)
 805     void testCleanIgnored(VCS vcs) throws IOException {
 806         try (var dir = new TemporaryDirectory()) {
 807             var r = Repository.init(dir.path(), vcs);
 808             r.clean();
 809 
 810             var readme = dir.path().resolve(&quot;README&quot;);
 811             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 812             Files.write(dir.path().resolve(&quot;.gitignore&quot;), List.of(&quot;*.txt&quot;));
 813             Files.write(dir.path().resolve(&quot;.hgignore&quot;), List.of(&quot;.*txt&quot;));
 814 
 815             r.add(readme);
 816             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 817 
 818             var ignored = dir.path().resolve(&quot;ignored.txt&quot;);
 819             Files.write(ignored, List.of(&quot;Random text&quot;));
 820 
 821             r.clean();
 822 
 823             assertFalse(Files.exists(ignored));
 824         }
 825     }
 826 
 827     @ParameterizedTest
 828     @EnumSource(VCS.class)
 829     void testDiffBetweenCommits(VCS vcs) throws IOException {
 830         try (var dir = new TemporaryDirectory()) {
 831             var r = Repository.init(dir.path(), vcs);
 832 
 833             var readme = dir.path().resolve(&quot;README&quot;);
 834             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 835 
 836             r.add(readme);
 837             var first = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 838 
 839             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
 840             r.add(readme);
 841             var second = r.commit(&quot;Add one more line&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 842 
 843             var diff = r.diff(first, second);
 844             assertEquals(first, diff.from());
 845             assertEquals(second, diff.to());
 846 
 847             var patches = diff.patches();
 848             assertEquals(1, patches.size());
 849 
 850             var patch = patches.get(0).asTextualPatch();
 851             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 852             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 853             assertTrue(patch.source().type().get().isRegularNonExecutable());
 854             assertTrue(patch.target().type().get().isRegularNonExecutable());
 855             assertTrue(patch.status().isModified());
 856 
 857             var hunks = patch.hunks();
 858             assertEquals(1, hunks.size());
 859 
 860             var hunk = hunks.get(0);
 861             assertEquals(1, hunk.source().range().start());
 862             assertEquals(0, hunk.source().range().count());
 863             assertEquals(0, hunk.source().lines().size());
 864 
 865             assertEquals(2, hunk.target().range().start());
 866             assertEquals(1, hunk.target().range().count());
 867             assertEquals(List.of(&quot;One more line&quot;), hunk.target().lines());
 868 
 869             assertEquals(1, hunk.added());
 870             assertEquals(0, hunk.removed());
 871             assertEquals(0, hunk.modified());
 872         }
 873     }
 874 
 875     @ParameterizedTest
 876     @EnumSource(VCS.class)
 877     void testDiffBetweenCommitsWithMultiplePatches(VCS vcs) throws IOException {
 878         try (var dir = new TemporaryDirectory()) {
 879             var r = Repository.init(dir.path(), vcs);
 880 
 881             var readme = dir.path().resolve(&quot;README&quot;);
 882             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 883 
 884             var building = dir.path().resolve(&quot;BUILDING&quot;);
 885             Files.write(building, List.of(&quot;make&quot;));
 886 
 887             r.add(readme);
 888             r.add(building);
 889             var first = r.commit(&quot;Add README and BUILDING&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 890 
 891             Files.write(readme, List.of(&quot;Hello, Skara!&quot;), WRITE, TRUNCATE_EXISTING);
 892             Files.write(building, List.of(&quot;make images&quot;), WRITE, TRUNCATE_EXISTING);
 893             r.add(readme);
 894             r.add(building);
 895             var second = r.commit(&quot;Modify README and BUILDING&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 896 
 897             var diff = r.diff(first, second);
 898             assertEquals(first, diff.from());
 899             assertEquals(second, diff.to());
 900 
 901             var patches = diff.patches();
 902             assertEquals(2, patches.size());
 903 
 904             var patch1 = patches.get(0).asTextualPatch();
 905             assertEquals(Path.of(&quot;BUILDING&quot;), patch1.source().path().get());
 906             assertEquals(Path.of(&quot;BUILDING&quot;), patch1.target().path().get());
 907             assertTrue(patch1.source().type().get().isRegularNonExecutable());
 908             assertTrue(patch1.target().type().get().isRegularNonExecutable());
 909             assertTrue(patch1.status().isModified());
 910 
 911             var hunks1 = patch1.hunks();
 912             assertEquals(1, hunks1.size());
 913 
 914             var hunk1 = hunks1.get(0);
 915             assertEquals(1, hunk1.source().range().start());
 916             assertEquals(1, hunk1.source().range().count());
 917             assertEquals(List.of(&quot;make&quot;), hunk1.source().lines());
 918 
 919             assertEquals(1, hunk1.target().range().start());
 920             assertEquals(1, hunk1.target().range().count());
 921             assertEquals(List.of(&quot;make images&quot;), hunk1.target().lines());
 922 
 923             var patch2 = patches.get(1).asTextualPatch();
 924             assertEquals(Path.of(&quot;README&quot;), patch2.source().path().get());
 925             assertEquals(Path.of(&quot;README&quot;), patch2.target().path().get());
 926             assertTrue(patch2.source().type().get().isRegularNonExecutable());
 927             assertTrue(patch2.target().type().get().isRegularNonExecutable());
 928             assertTrue(patch2.status().isModified());
 929 
 930             var hunks2 = patch2.hunks();
 931             assertEquals(1, hunks2.size());
 932 
 933             var hunk2 = hunks2.get(0);
 934             assertEquals(1, hunk2.source().range().start());
 935             assertEquals(1, hunk2.source().range().count());
 936             assertEquals(List.of(&quot;Hello, readme!&quot;), hunk2.source().lines());
 937 
 938             assertEquals(1, hunk2.target().range().start());
 939             assertEquals(1, hunk2.target().range().count());
 940             assertEquals(List.of(&quot;Hello, Skara!&quot;), hunk2.target().lines());
 941         }
 942     }
 943 
 944     @ParameterizedTest
 945     @EnumSource(VCS.class)
 946     void testDiffBetweenCommitsWithMultipleHunks(VCS vcs) throws IOException {
 947         try (var dir = new TemporaryDirectory()) {
 948             var r = Repository.init(dir.path(), vcs);
 949 
 950             var abc = dir.path().resolve(&quot;abc.txt&quot;);
 951             Files.write(abc, List.of(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;));
 952 
 953             r.add(abc);
 954             var first = r.commit(&quot;Added ABC&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 955 
 956             Files.write(abc, List.of(&quot;1&quot;, &quot;2&quot;, &quot;B&quot;, &quot;3&quot;), WRITE, TRUNCATE_EXISTING);
 957             r.add(abc);
 958             var second = r.commit(&quot;Modify A and C&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 959 
 960             var diff = r.diff(first, second);
 961             assertEquals(first, diff.from());
 962             assertEquals(second, diff.to());
 963 
 964             var patches = diff.patches();
 965             assertEquals(1, patches.size());
 966 
 967             var patch = patches.get(0).asTextualPatch();
 968             assertEquals(Path.of(&quot;abc.txt&quot;), patch.source().path().get());
 969             assertEquals(Path.of(&quot;abc.txt&quot;), patch.target().path().get());
 970             assertTrue(patch.source().type().get().isRegularNonExecutable());
 971             assertTrue(patch.target().type().get().isRegularNonExecutable());
 972             assertTrue(patch.status().isModified());
 973 
 974             var hunks = patch.hunks();
 975             assertEquals(2, hunks.size());
 976 
 977             var hunk1 = hunks.get(0);
 978             assertEquals(1, hunk1.source().range().start());
 979             assertEquals(1, hunk1.source().range().count());
 980             assertEquals(List.of(&quot;A&quot;), hunk1.source().lines());
 981 
 982             assertEquals(1, hunk1.target().range().start());
 983             assertEquals(2, hunk1.target().range().count());
 984             assertEquals(List.of(&quot;1&quot;, &quot;2&quot;), hunk1.target().lines());
 985 
 986             assertEquals(1, hunk1.added());
 987             assertEquals(0, hunk1.removed());
 988             assertEquals(1, hunk1.modified());
 989 
 990             var hunk2 = hunks.get(1);
 991             assertEquals(3, hunk2.source().range().start());
 992             assertEquals(1, hunk2.source().range().count());
 993             assertEquals(List.of(&quot;C&quot;), hunk2.source().lines());
 994 
 995             assertEquals(4, hunk2.target().range().start());
 996             assertEquals(1, hunk2.target().range().count());
 997             assertEquals(List.of(&quot;3&quot;), hunk2.target().lines());
 998 
 999             assertEquals(0, hunk2.added());
1000             assertEquals(0, hunk2.removed());
1001             assertEquals(1, hunk2.modified());
1002         }
1003     }
1004 
1005     @ParameterizedTest
1006     @EnumSource(VCS.class)
1007     void testDiffWithRemoval(VCS vcs) throws IOException {
1008         try (var dir = new TemporaryDirectory()) {
1009             var r = Repository.init(dir.path(), vcs);
1010 
1011             var readme = dir.path().resolve(&quot;README&quot;);
1012             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1013 
1014             r.add(readme);
1015             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1016 
1017             Files.delete(readme);
1018             r.remove(readme);
1019             var second = r.commit(&quot;Removed README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1020 
1021             var diff = r.diff(first, second);
1022             assertEquals(first, diff.from());
1023             assertEquals(second, diff.to());
1024 
1025             var patches = diff.patches();
1026             assertEquals(1, patches.size());
1027 
1028             var patch = patches.get(0).asTextualPatch();
1029             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
1030             assertTrue(patch.target().path().isEmpty());
1031             assertTrue(patch.source().type().get().isRegularNonExecutable());
1032             assertTrue(patch.target().type().isEmpty());
1033             assertTrue(patch.status().isDeleted());
1034 
1035             var hunks = patch.hunks();
1036             assertEquals(1, hunks.size());
1037 
1038             var hunk = hunks.get(0);
1039             assertEquals(1, hunk.source().range().start());
1040             assertEquals(1, hunk.source().range().count());
1041             assertEquals(List.of(&quot;Hello, world!&quot;), hunk.source().lines());
1042 
1043             assertEquals(0, hunk.target().range().start());
1044             assertEquals(0, hunk.target().range().count());
1045             assertEquals(List.of(), hunk.target().lines());
1046 
1047             assertEquals(0, hunk.added());
1048             assertEquals(1, hunk.removed());
1049             assertEquals(0, hunk.modified());
1050         }
1051     }
1052 
1053     @ParameterizedTest
1054     @EnumSource(VCS.class)
1055     void testDiffWithAddition(VCS vcs) throws IOException {
1056         try (var dir = new TemporaryDirectory()) {
1057             var r = Repository.init(dir.path(), vcs);
1058 
1059             var readme = dir.path().resolve(&quot;README&quot;);
1060             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1061 
1062             r.add(readme);
1063             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1064 
1065             var building = dir.path().resolve(&quot;BUILDING&quot;);
1066             Files.write(building, List.of(&quot;make&quot;));
1067             r.add(building);
1068             var second = r.commit(&quot;Added BUILDING&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1069 
1070             var diff = r.diff(first, second);
1071             assertEquals(first, diff.from());
1072             assertEquals(second, diff.to());
1073 
1074             var patches = diff.patches();
1075             assertEquals(1, patches.size());
1076 
1077             var patch = patches.get(0).asTextualPatch();
1078             assertTrue(patch.source().path().isEmpty());
1079             assertEquals(Path.of(&quot;BUILDING&quot;), patch.target().path().get());
1080             assertTrue(patch.source().type().isEmpty());
1081             assertTrue(patch.target().type().get().isRegularNonExecutable());
1082             assertTrue(patch.status().isAdded());
1083 
1084             var hunks = patch.hunks();
1085             assertEquals(1, hunks.size());
1086 
1087             var hunk = hunks.get(0);
1088             assertEquals(0, hunk.source().range().start());
1089             assertEquals(0, hunk.source().range().count());
1090             assertEquals(List.of(), hunk.source().lines());
1091 
1092             assertEquals(1, hunk.target().range().start());
1093             assertEquals(1, hunk.target().range().count());
1094             assertEquals(List.of(&quot;make&quot;), hunk.target().lines());
1095 
1096             assertEquals(1, hunk.added());
1097             assertEquals(0, hunk.removed());
1098             assertEquals(0, hunk.modified());
1099         }
1100     }
1101 
1102     @ParameterizedTest
1103     @EnumSource(VCS.class)
1104     void testDiffWithWorkingDir(VCS vcs) throws IOException {
1105         try (var dir = new TemporaryDirectory()) {
1106             var r = Repository.init(dir.path(), vcs);
1107 
1108             var readme = dir.path().resolve(&quot;README&quot;);
1109             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1110 
1111             r.add(readme);
1112             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1113 
1114             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1115             var diff = r.diff(first);
1116 
1117             assertEquals(first, diff.from());
1118             assertNull(diff.to());
1119 
1120             var patches = diff.patches();
1121             assertEquals(1, patches.size());
1122 
1123             var patch = patches.get(0).asTextualPatch();
1124             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
1125             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
1126             assertTrue(patch.source().type().get().isRegularNonExecutable());
1127             assertTrue(patch.target().type().get().isRegularNonExecutable());
1128             assertTrue(patch.status().isModified());
1129 
1130             var hunks = patch.hunks();
1131             assertEquals(1, hunks.size());
1132 
1133             var hunk = hunks.get(0);
1134             assertEquals(1, hunk.source().range().start());
1135             assertEquals(0, hunk.source().range().count());
1136             assertEquals(List.of(), hunk.source().lines());
1137 
1138             assertEquals(2, hunk.target().range().start());
1139             assertEquals(1, hunk.target().range().count());
1140             assertEquals(List.of(&quot;One more line&quot;), hunk.target().lines());
1141 
1142             assertEquals(1, hunk.added());
1143             assertEquals(0, hunk.removed());
1144             assertEquals(0, hunk.modified());
1145         }
1146     }
1147 
1148     @ParameterizedTest
1149     @EnumSource(VCS.class)
1150     void testCommitMetadata(VCS vcs) throws IOException {
1151         try (var dir = new TemporaryDirectory()) {
1152             var r = Repository.init(dir.path(), vcs);
1153 
1154             var readme = dir.path().resolve(&quot;README&quot;);
1155             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1156             r.add(readme);
1157             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1158 
1159             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1160             r.add(readme);
1161             var second = r.commit(&quot;Modified README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1162 
1163             var metadata = r.commitMetadata();
1164             assertEquals(2, metadata.size());
1165 
1166             assertEquals(first, metadata.get(0).hash());
1167             assertEquals(List.of(&quot;Added README&quot;), metadata.get(0).message());
1168 
1169             assertEquals(second, metadata.get(1).hash());
1170             assertEquals(List.of(&quot;Modified README&quot;), metadata.get(1).message());
1171         }
1172     }
1173 
1174     @ParameterizedTest
1175     @EnumSource(VCS.class)
1176     void testTrivialMerge(VCS vcs) throws IOException {
1177         try (var dir = new TemporaryDirectory()) {
1178             var r = Repository.init(dir.path(), vcs);
1179 
1180             var readme = dir.path().resolve(&quot;README&quot;);
1181             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1182             r.add(readme);
1183             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1184 
1185             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1186             r.add(readme);
1187             var second = r.commit(&quot;Modified README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1188 
1189             r.checkout(first, false);
1190 
1191             var contributing = dir.path().resolve(&quot;CONTRIBUTING&quot;);
1192             Files.write(contributing, List.of(&quot;Send those patches!&quot;));
1193             r.add(contributing);
1194             var third = r.commit(&quot;Added contributing&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1195 
1196             r.merge(second);
1197             r.commit(&quot;Merge&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1198 
1199             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
1200             var commits = r.commits(refspec).asList();
1201 
1202             assertEquals(4, commits.size());
1203 
1204             var merge = commits.get(0);
1205             assertEquals(List.of(&quot;Merge&quot;), merge.message());
1206 
1207             var parents = new HashSet&lt;&gt;(merge.parents());
1208             assertEquals(2, parents.size());
1209             assertTrue(parents.contains(second));
1210             assertTrue(parents.contains(third));
1211 
1212             var diffs = merge.parentDiffs();
1213             assertEquals(2, diffs.size());
1214 
1215             var diff1 = diffs.get(0);
1216             assertEquals(merge.hash(), diff1.to());
1217             assertEquals(0, diff1.patches().size());
1218             assertTrue(parents.contains(diff1.from()));
1219 
1220             var diff2 = diffs.get(1);
1221             assertEquals(merge.hash(), diff2.to());
1222             assertEquals(0, diff2.patches().size());
1223             assertTrue(parents.contains(diff2.from()));
1224         }
1225     }
1226 
1227     @ParameterizedTest
1228     @EnumSource(VCS.class)
1229     void testMergeWithEdit(VCS vcs) throws IOException {
1230         try (var dir = new TemporaryDirectory()) {
1231             var r = Repository.init(dir.path(), vcs);
1232 
1233             var readme = dir.path().resolve(&quot;README&quot;);
1234             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1235             r.add(readme);
1236             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1237 
1238             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1239             r.add(readme);
1240             var second = r.commit(&quot;Modified README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1241 
1242             r.checkout(first, false);
1243 
1244             var contributing = dir.path().resolve(&quot;CONTRIBUTING&quot;);
1245             Files.write(contributing, List.of(&quot;Send those patches!&quot;));
1246             r.add(contributing);
1247             var third = r.commit(&quot;Added contributing&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1248 
1249             r.merge(second);
1250 
1251             Files.write(readme, List.of(&quot;One last line&quot;), WRITE, APPEND);
1252             r.add(readme);
1253             r.commit(&quot;Merge&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1254 
1255             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
1256             var commits = r.commits(refspec).asList();
1257 
1258             assertEquals(4, commits.size());
1259 
1260             var merge = commits.get(0);
1261             assertEquals(List.of(&quot;Merge&quot;), merge.message());
1262 
1263             var parents = new HashSet&lt;&gt;(merge.parents());
1264             assertEquals(2, parents.size());
1265             assertTrue(parents.contains(second));
1266             assertTrue(parents.contains(third));
1267 
1268             var diffs = merge.parentDiffs();
1269             assertEquals(2, diffs.size());
1270 
1271             var secondDiff = diffs.stream().filter(d -&gt; d.from().equals(second)).findFirst().get();
1272             assertEquals(merge.hash(), secondDiff.to());
1273             assertEquals(1, secondDiff.patches().size());
1274             var secondPatch = secondDiff.patches().get(0).asTextualPatch();
1275 
1276             assertEquals(Path.of(&quot;README&quot;), secondPatch.source().path().get());
1277             assertEquals(Path.of(&quot;README&quot;), secondPatch.target().path().get());
1278             assertTrue(secondPatch.status().isModified());
1279             assertEquals(1, secondPatch.hunks().size());
1280 
1281             var secondHunk = secondPatch.hunks().get(0);
1282             assertEquals(List.of(), secondHunk.source().lines());
1283             assertEquals(List.of(&quot;One last line&quot;), secondHunk.target().lines());
1284 
1285             assertEquals(2, secondHunk.source().range().start());
1286             assertEquals(0, secondHunk.source().range().count());
1287             assertEquals(3, secondHunk.target().range().start());
1288             assertEquals(1, secondHunk.target().range().count());
1289 
1290             var thirdDiff = diffs.stream().filter(d -&gt; d.from().equals(third)).findFirst().get();
1291             assertEquals(merge.hash(), thirdDiff.to());
1292             assertEquals(1, thirdDiff.patches().size());
1293             var thirdPatch = thirdDiff.patches().get(0).asTextualPatch();
1294 
1295             assertEquals(Path.of(&quot;README&quot;), thirdPatch.source().path().get());
1296             assertEquals(Path.of(&quot;README&quot;), thirdPatch.target().path().get());
1297             assertTrue(thirdPatch.status().isModified());
1298             assertEquals(1, thirdPatch.hunks().size());
1299 
1300             var thirdHunk = thirdPatch.hunks().get(0);
1301             assertEquals(List.of(), thirdHunk.source().lines());
1302             assertEquals(List.of(&quot;One more line&quot;, &quot;One last line&quot;), thirdHunk.target().lines());
1303 
1304             assertEquals(1, thirdHunk.source().range().start());
1305             assertEquals(0, thirdHunk.source().range().count());
1306             assertEquals(2, thirdHunk.target().range().start());
1307             assertEquals(2, thirdHunk.target().range().count());
1308         }
1309     }
1310 
1311     @ParameterizedTest
1312     @EnumSource(VCS.class)
1313     void testDefaultBranch(VCS vcs) throws IOException {
1314         try (var dir = new TemporaryDirectory()) {
1315             var r = Repository.init(dir.path(), vcs);
1316             var expected = vcs == VCS.GIT ? &quot;master&quot; : &quot;default&quot;;
1317             assertEquals(expected, r.defaultBranch().name());
1318         }
1319     }
1320 
1321     @ParameterizedTest
1322     @EnumSource(VCS.class)
1323     void testPaths(VCS vcs) throws IOException {
1324         try (var dir = new TemporaryDirectory()) {
1325             var r = Repository.init(dir.path(), vcs);
1326             var remote = vcs == VCS.GIT ? &quot;origin&quot; : &quot;default&quot;;
1327             r.setPaths(remote, &quot;http://pull&quot;, &quot;http://push&quot;);
1328             assertEquals(&quot;http://pull&quot;, r.pullPath(remote));
1329             assertEquals(&quot;http://push&quot;, r.pushPath(remote));
1330         }
1331     }
1332 
1333     @ParameterizedTest
1334     @EnumSource(VCS.class)
1335     void testIsValidRevisionRange(VCS vcs) throws IOException {
1336         try (var dir = new TemporaryDirectory()) {
1337             var r = Repository.init(dir.path(), vcs);
1338             assertFalse(r.isValidRevisionRange(&quot;foo&quot;));
1339 
1340             var readme = dir.path().resolve(&quot;README&quot;);
1341             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1342             r.add(readme);
1343             r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1344 
1345             assertTrue(r.isValidRevisionRange(r.defaultBranch().toString()));
1346         }
1347     }
1348 
1349     @ParameterizedTest
1350     @EnumSource(VCS.class)
1351     void testDefaultTag(VCS vcs) throws IOException {
1352         try (var dir = new TemporaryDirectory()) {
1353             var r = Repository.init(dir.path(), vcs);
1354             var expected = vcs == VCS.GIT ? Optional.empty() : Optional.of(new Tag(&quot;tip&quot;));
1355             assertEquals(expected, r.defaultTag());
1356         }
1357     }
1358 
1359     @ParameterizedTest
1360     @EnumSource(VCS.class)
1361     void testTag(VCS vcs) throws IOException {
1362         try (var dir = new TemporaryDirectory()) {
1363             var r = Repository.init(dir.path(), vcs);
1364 
1365             var readme = dir.path().resolve(&quot;README&quot;);
1366             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1367             r.add(readme);
1368             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1369 
1370             r.tag(first, &quot;test&quot;, &quot;Tagging test&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1371             var defaultTag = r.defaultTag().orElse(null);
1372             var nonDefaultTags = r.tags().stream()
1373                                   .filter(tag -&gt; !tag.equals(defaultTag))
1374                                   .map(Tag::toString)
1375                                   .collect(Collectors.toList());
1376             assertEquals(List.of(&quot;test&quot;), nonDefaultTags);
1377         }
1378     }
1379 
1380     @ParameterizedTest
1381     @EnumSource(VCS.class)
1382     void testIsClean(VCS vcs) throws IOException {
1383         try (var dir = new TemporaryDirectory()) {
1384             var r = Repository.init(dir.path(), vcs);
1385             assertTrue(r.isClean());
1386 
1387             var readme = dir.path().resolve(&quot;README&quot;);
1388             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1389             assertFalse(r.isClean());
1390 
1391             r.add(readme);
1392             assertFalse(r.isClean());
1393 
1394             r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1395             assertTrue(r.isClean());
1396 
1397             Files.delete(readme);
1398             assertFalse(r.isClean());
1399 
1400             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1401             assertTrue(r.isClean());
1402         }
1403     }
1404 
1405     @ParameterizedTest
1406     @EnumSource(VCS.class)
1407     void testShowOnExecutableFiles(VCS vcs) throws IOException {
1408         try (var dir = new TemporaryDirectory()) {
1409             var r = Repository.init(dir.path(), vcs);
1410             assertTrue(r.isClean());
1411 
1412             var readOnlyExecutableFile = dir.path().resolve(&quot;hello.sh&quot;);
1413             Files.write(readOnlyExecutableFile, List.of(&quot;echo &#39;hello&#39;&quot;));
1414             if (readOnlyExecutableFile.getFileSystem().supportedFileAttributeViews().contains(&quot;posix&quot;)) {
1415                 var permissions = PosixFilePermissions.fromString(&quot;r-xr-xr-x&quot;);
1416                 Files.setPosixFilePermissions(readOnlyExecutableFile, permissions);
1417             }
1418             r.add(readOnlyExecutableFile);
1419             var hash = r.commit(&quot;Added read only executable file&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1420             assertEquals(Optional.of(List.of(&quot;echo &#39;hello&#39;&quot;)), r.lines(readOnlyExecutableFile, hash));
1421 
1422             var readWriteExecutableFile = dir.path().resolve(&quot;goodbye.sh&quot;);
1423             Files.write(readWriteExecutableFile, List.of(&quot;echo &#39;goodbye&#39;&quot;));
1424             if (readOnlyExecutableFile.getFileSystem().supportedFileAttributeViews().contains(&quot;posix&quot;)) {
1425                 var permissions = PosixFilePermissions.fromString(&quot;rwxrwxrwx&quot;);
1426                 Files.setPosixFilePermissions(readWriteExecutableFile, permissions);
1427             }
1428             r.add(readWriteExecutableFile);
1429             var hash2 = r.commit(&quot;Added read-write executable file&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1430             assertEquals(Optional.of(List.of(&quot;echo &#39;goodbye&#39;&quot;)), r.lines(readWriteExecutableFile, hash2));
1431         }
1432     }
1433 }
    </pre>
  </body>
</html>