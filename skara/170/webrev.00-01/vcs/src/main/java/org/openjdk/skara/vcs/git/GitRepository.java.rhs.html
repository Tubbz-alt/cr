<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames vcs/src/main/java/org/openjdk/skara/vcs/git/GitRepository.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.vcs.git;
  24 
  25 import org.openjdk.skara.process.*;
  26 import org.openjdk.skara.process.Process;
  27 import org.openjdk.skara.vcs.*;
  28 import org.openjdk.skara.vcs.tools.*;
  29 
  30 import java.io.*;
  31 import java.net.URI;
  32 import java.nio.file.*;
  33 import java.nio.charset.StandardCharsets;
  34 import java.time.*;
  35 import java.time.format.DateTimeFormatter;
  36 import java.util.*;
  37 import java.util.logging.Logger;
  38 import java.util.stream.Collectors;
  39 
  40 public class GitRepository implements Repository {
  41     private final Path dir;
  42     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.vcs.git&quot;);
  43     private Path cachedRoot = null;
  44 
  45     private java.lang.Process start(String... cmd) throws IOException {
  46         return start(Arrays.asList(cmd));
  47     }
  48 
  49     private java.lang.Process start(List&lt;String&gt; cmd) throws IOException {
  50         log.fine(&quot;Executing &quot; + String.join(&quot; &quot;, cmd));
  51         var pb = new ProcessBuilder(cmd);
  52         pb.directory(dir.toFile());
  53         pb.redirectError(ProcessBuilder.Redirect.DISCARD);
  54         return pb.start();
  55     }
  56 
  57     private static void stop(java.lang.Process p) throws IOException {
  58         if (p != null &amp;&amp; p.isAlive()) {
  59             var stream = p.getInputStream();
  60             var read = 0;
  61             var buf = new byte[128];
  62             while (read != -1) {
  63                 read = stream.read(buf);
  64             }
  65             try {
  66                 p.waitFor();
  67             } catch (InterruptedException e) {
  68                 throw new IOException(e);
  69             }
  70         }
  71     }
  72 
  73     private Execution capture(List&lt;String&gt; cmd) {
  74         return capture(cmd.toArray(new String[0]));
  75     }
  76 
  77     private Execution capture(String... cmd) {
  78         return capture(dir, cmd);
  79     }
  80 
  81     private static Execution capture(Path cwd, String... cmd) {
  82         return Process.capture(cmd)
  83                       .workdir(cwd)
  84                       .execute();
  85     }
  86 
  87     private static Execution capture(Path cwd, List&lt;String&gt; cmd) {
  88         return capture(cwd, cmd.toArray(new String[0]));
  89     }
  90 
  91     private static Execution.Result await(Execution e) throws IOException {
  92         var result = e.await();
  93         if (result.status() != 0) {
  94             throw new IOException(&quot;Unexpected exit code\n&quot; + result);
  95         }
  96         return result;
  97     }
  98 
  99     private static void await(java.lang.Process p) throws IOException {
 100         try {
 101             var res = p.waitFor();
 102             if (res != 0) {
 103                 throw new IOException(&quot;Unexpected exit code: &quot; + res);
 104             }
 105         } catch (InterruptedException e) {
 106             throw new IOException(e);
 107         }
 108     }
 109 
 110     public GitRepository(Path dir) {
 111         System.err.println(&quot;DEBUG: GitRepository: dir = &quot; + dir);
 112         this.dir = dir.toAbsolutePath();
 113     }
 114 
 115     public List&lt;Branch&gt; branches() throws IOException {
 116         try (var p = capture(&quot;git&quot;, &quot;for-each-ref&quot;, &quot;--format=%(refname:short)&quot;, &quot;refs/heads&quot;)) {
 117             return await(p).stdout()
 118                            .stream()
 119                            .map(Branch::new)
 120                            .collect(Collectors.toList());
 121         }
 122     }
 123 
 124     public List&lt;Tag&gt; tags() throws IOException {
 125         try (var p = capture(&quot;git&quot;, &quot;for-each-ref&quot;, &quot;--format=%(refname:short)&quot;, &quot;refs/tags&quot;)) {
 126             return await(p).stdout()
 127                            .stream()
 128                            .map(Tag::new)
 129                            .collect(Collectors.toList());
 130         }
 131     }
 132 
 133     @Override
 134     public Commits commits() throws IOException {
 135         return new GitCommits(dir, &quot;--all&quot;, false, -1);
 136     }
 137 
 138     @Override
 139     public Commits commits(int n) throws IOException {
 140         return new GitCommits(dir, &quot;--all&quot;, false, n);
 141     }
 142 
 143     @Override
 144     public Commits commits(boolean reverse) throws IOException {
 145         return new GitCommits(dir, &quot;--all&quot;, reverse, -1);
 146     }
 147 
 148     @Override
 149     public Commits commits(int n, boolean reverse) throws IOException {
 150         return new GitCommits(dir, &quot;--all&quot;, reverse, n);
 151     }
 152 
 153     @Override
 154     public Commits commits(String range) throws IOException {
 155         return new GitCommits(dir, range, false, -1);
 156     }
 157 
 158     @Override
 159     public Commits commits(String range, int n) throws IOException {
 160         return new GitCommits(dir, range, false, n);
 161     }
 162 
 163     @Override
 164     public Commits commits(String range, boolean reverse) throws IOException {
 165         return new GitCommits(dir, range, reverse, -1);
 166     }
 167 
 168     @Override
 169     public Commits commits(String range, int n, boolean reverse) throws IOException {
 170         return new GitCommits(dir, range, reverse, n);
 171     }
 172 
 173     @Override
 174     public Optional&lt;Commit&gt; lookup(Hash h) throws IOException {
 175         var commits = commits(h.hex(), 1).asList();
 176         if (commits.size() != 1) {
 177             return Optional.empty();
 178         }
 179         return Optional.of(commits.get(0));
 180     }
 181 
 182     @Override
 183     public Optional&lt;Commit&gt; lookup(Branch b) throws IOException {
 184         var hash = resolve(b.name()).orElseThrow(() -&gt; new IOException(&quot;Branch &quot; + b.name() + &quot; not found&quot;));
 185         return lookup(hash);
 186     }
 187 
 188     @Override
 189     public Optional&lt;Commit&gt; lookup(Tag t) throws IOException {
 190         var hash = resolve(t.name()).orElseThrow(() -&gt; new IOException(&quot;Tag &quot; + t.name() + &quot; not found&quot;));
 191         return lookup(hash);
 192     }
 193 
 194     public List&lt;CommitMetadata&gt; commitMetadata() throws IOException {
 195         var revisions = &quot;--all&quot;;
 196         var p = start(&quot;git&quot;, &quot;rev-list&quot;, &quot;--format=&quot; + GitCommitMetadata.FORMAT, &quot;--no-abbrev&quot;, &quot;--reverse&quot;, &quot;--no-color&quot;, revisions);
 197         var reader = new UnixStreamReader(p.getInputStream());
 198         var result = new ArrayList&lt;CommitMetadata&gt;();
 199 
 200         var line = reader.readLine();
 201         while (line != null) {
 202             if (!line.startsWith(&quot;commit&quot;)) {
 203                 throw new IOException(&quot;Unexpected line: &quot; + line);
 204             }
 205 
 206             result.add(GitCommitMetadata.read(reader));
 207             line = reader.readLine();
 208         }
 209 
 210         await(p);
 211         return result;
 212     }
 213 
 214     private List&lt;Hash&gt; refs() throws IOException {
 215         try (var p = capture(&quot;git&quot;, &quot;show-ref&quot;, &quot;--hash&quot;, &quot;--abbrev&quot;)) {
 216             var res = p.await();
 217             if (res.status() == -1) {
 218                 if (res.stdout().size() != 0) {
 219                     throw new IOException(&quot;Unexpected output\n&quot; + res);
 220                 }
 221                 return new ArrayList&lt;&gt;();
 222             } else {
 223                 return res.stdout().stream()
 224                           .map(Hash::new)
 225                           .collect(Collectors.toList());
 226             }
 227         }
 228     }
 229 
 230     @Override
 231     public boolean isEmpty() throws IOException {
 232         int numLooseObjects = -1;
 233         int numPackedObjects = -1;
 234 
 235         try (var p = capture(&quot;git&quot;, &quot;count-objects&quot;, &quot;-v&quot;)) {
 236             var res = await(p);
 237             var stdout = res.stdout();
 238 
 239             for (var line : stdout) {
 240                 if (line.startsWith(&quot;count: &quot;)) {
 241                     try {
 242                         numLooseObjects = Integer.parseUnsignedInt(line.split(&quot; &quot;)[1]);
 243                     } catch (NumberFormatException e) {
 244                         throw new IOException(&quot;Unexpected &#39;count&#39; value\n&quot; + res, e);
 245                     }
 246 
 247                 } else if (line.startsWith(&quot;in-pack: &quot;)) {
 248                     try {
 249                         numPackedObjects = Integer.parseUnsignedInt(line.split(&quot; &quot;)[1]);
 250                     } catch (NumberFormatException e) {
 251                         throw new IOException(&quot;Unexpected &#39;in-pack&#39; value\n&quot; + res, e);
 252                     }
 253                 }
 254             }
 255         }
 256 
 257         return numLooseObjects == 0 &amp;&amp; numPackedObjects == 0 &amp;&amp; refs().size() == 0;
 258     }
 259 
 260     @Override
 261     public boolean isHealthy() throws IOException {
 262         var refs = refs();
 263         if (refs.size() == 0) {
 264             return true;
 265         }
 266 
 267         var name = &quot;health-check&quot;;
 268         try (var p = capture(&quot;git&quot;, &quot;branch&quot;, name, refs.get(0).hex())) {
 269             if (p.await().status() != 0) {
 270                 return false;
 271             }
 272         }
 273         try (var p = capture(&quot;git&quot;, &quot;branch&quot;, &quot;-D&quot;, name)) {
 274             if (p.await().status() != 0) {
 275                 return false;
 276             }
 277         }
 278 
 279         return true;
 280     }
 281 
 282     @Override
 283     public void clean() throws IOException {
 284         cachedRoot = null;
 285 
 286         try (var p = capture(&quot;git&quot;, &quot;clean&quot;, &quot;-x&quot;, &quot;-d&quot;, &quot;--force&quot;, &quot;--force&quot;)) {
 287             await(p);
 288         }
 289 
 290         try (var p = capture(&quot;git&quot;, &quot;reset&quot;, &quot;--hard&quot;)) {
 291             await(p);
 292         }
 293 
 294         try (var p = capture(&quot;git&quot;, &quot;rebase&quot;, &quot;--quit&quot;)) {
 295             p.await(); // Don&#39;t care about the result.
 296         }
 297     }
 298 
 299     @Override
 300     public void reset(Hash target, boolean hard) throws IOException {
 301         var cmd = new ArrayList&lt;&gt;(List.of(&quot;git&quot;, &quot;reset&quot;));
 302         if (hard) {
 303            cmd.add(&quot;--hard&quot;);
 304         }
 305         cmd.add(target.hex());
 306 
 307         try (var p = capture(cmd)) {
 308             await(p);
 309         }
 310     }
 311 
 312 
 313     @Override
 314     public void revert(Hash h) throws IOException {
 315         try (var p = capture(&quot;git&quot;, &quot;checkout&quot;, h.hex(), &quot;--&quot;, &quot;.&quot;)) {
 316             await(p);
 317         }
 318     }
 319 
 320     @Override
 321     public Repository reinitialize() throws IOException {
 322         cachedRoot = null;
 323 
 324         Files.walk(dir)
 325              .map(Path::toFile)
 326              .sorted(Comparator.reverseOrder())
 327              .forEach(File::delete);
 328 
 329         return init();
 330     }
 331 
 332     @Override
 333     public Hash fetch(URI uri, String refspec) throws IOException {
 334         try (var p = capture(&quot;git&quot;, &quot;fetch&quot;, &quot;--tags&quot;, uri.toString(), refspec)) {
 335             await(p);
 336             return resolve(&quot;FETCH_HEAD&quot;).get();
 337         }
 338     }
 339 
 340     @Override
 341     public void fetchAll() throws IOException {
 342         try (var p = capture(&quot;git&quot;, &quot;fetch&quot;, &quot;--tags&quot;, &quot;--prune&quot;, &quot;--prune-tags&quot;, &quot;--all&quot;)) {
 343             await(p);
 344         }
 345     }
 346 
 347     private void checkout(String ref, boolean force) throws IOException {
 348         var cmd = new ArrayList&lt;String&gt;();
 349         cmd.addAll(List.of(&quot;git&quot;, &quot;-c&quot;, &quot;advice.detachedHead=false&quot;, &quot;checkout&quot;));
 350         if (force) {
 351             cmd.add(&quot;--force&quot;);
 352         }
 353         cmd.add(ref);
 354         try (var p = capture(cmd)) {
 355             await(p);
 356         }
 357     }
 358 
 359     @Override
 360     public void checkout(Hash h, boolean force) throws IOException {
 361         checkout(h.hex(), force);
 362     }
 363 
 364     @Override
 365     public void checkout(Branch b, boolean force) throws IOException {
 366         checkout(b.name(), force);
 367     }
 368 
 369     @Override
 370     public Repository init() throws IOException {
 371         cachedRoot = null;
 372 
 373         if (!Files.exists(dir)) {
 374             Files.createDirectories(dir);
 375         }
 376 
 377         try (var p = capture(&quot;git&quot;, &quot;init&quot;)) {
 378             await(p);
 379             return this;
 380         }
 381     }
 382 
 383     @Override
 384     public void pushAll(URI uri) throws IOException {
 385         try (var p = capture(&quot;git&quot;, &quot;push&quot;, &quot;--mirror&quot;, uri.toString())) {
 386             await(p);
 387         }
 388     }
 389 
 390     @Override
 391     public void push(Hash hash, URI uri, String ref, boolean force) throws IOException {
 392         String refspec = force ? &quot;+&quot; : &quot;&quot;;
 393         if (!ref.startsWith(&quot;refs/&quot;)) {
 394             ref = &quot;refs/heads/&quot; + ref;
 395         }
 396         refspec += hash.hex() + &quot;:&quot; + ref;
 397 
 398         try (var p = capture(&quot;git&quot;, &quot;push&quot;, uri.toString(), refspec)) {
 399             await(p);
 400         }
 401     }
 402 
 403     @Override
 404     public void push(Branch branch, String remote, boolean setUpstream) throws IOException {
 405         var cmd = new ArrayList&lt;String&gt;();
 406         cmd.addAll(List.of(&quot;git&quot;, &quot;push&quot;, remote, branch.name()));
 407         if (setUpstream) {
 408             cmd.add(&quot;--set-upstream&quot;);
 409         }
 410 
 411         try (var p = capture(cmd)) {
 412             await(p);
 413         }
 414     }
 415 
 416     @Override
 417     public boolean isClean() throws IOException {
 418         try (var p = capture(&quot;git&quot;, &quot;status&quot;, &quot;--porcelain&quot;)) {
 419             var output = await(p);
 420             return output.stdout().size() == 0;
 421         }
 422     }
 423 
 424     @Override
 425     public boolean exists() throws IOException {
 426         if (!Files.exists(dir)) {
 427             return false;
 428         }
 429 
 430         try (var p = capture(&quot;git&quot;, &quot;rev-parse&quot;, &quot;--git-dir&quot;)) {
 431             return p.await().status() == 0;
 432         }
 433     }
 434 
 435     @Override
 436     public Path root() throws IOException {
 437         if (cachedRoot != null) {
 438             return cachedRoot;
 439         }
 440 
 441         try (var p = capture(&quot;git&quot;, &quot;rev-parse&quot;, &quot;--show-toplevel&quot;)) {
 442             var res = await(p);
 443             if (res.stdout().size() != 1) {
 444                 // Perhaps this is a bare repository
 445                 try (var p2 = capture(&quot;git&quot;, &quot;rev-parse&quot;, &quot;--git-dir&quot;)) {
 446                     var res2 = await(p2);
 447                     if (res2.stdout().size() != 1) {
 448                         throw new IOException(&quot;Unexpected output\n&quot; + res2);
 449                     }
 450                     // CYGWIN: FIXME: map cygwin path to Windows path
 451                     cachedRoot = dir.resolve(Path.of(res2.stdout().get(0)));
 452                     return cachedRoot;
 453                 }
 454             }
 455 
 456             // CYGWIN: map cygwin path to Windows path (OK to use `/`)
 457             // FIXME: only do this if using Cygwin git, and use cygpath
 458             var cygPrefix = &quot;/cygdrive/c&quot;;
 459             var dirString = res.stdout().get(0);
 460             System.err.println(&quot;DEBUG: root dir = &quot; + dirString);
 461             if (dirString.startsWith(cygPrefix + &quot;/&quot;)) {
 462                 dirString = &quot;C:&quot; + dirString.substring(cygPrefix.length());
 463                 System.err.println(&quot;DEBUG: converted root dir = &quot; + dirString);
 464             }
 465             cachedRoot = Path.of(dirString);
 466             System.err.println(&quot;DEBUG: root path = &quot; + cachedRoot);
 467             return cachedRoot;
 468         }
 469     }
 470 
 471     @Override
 472     public void squash(Hash h) throws IOException {
 473         try (var p = capture(&quot;git&quot;, &quot;merge&quot;, &quot;--squash&quot;, h.hex())) {
 474             await(p);
 475         }
 476     }
 477 
 478     @FunctionalInterface
 479     private static interface Operation {
 480         void execute(List&lt;Path&gt; args) throws IOException;
 481     }
 482 
 483     private void batch(Operation op, List&lt;Path&gt; args) throws IOException {
 484         var batchSize = 64;
 485         var start = 0;
 486         while (start &lt; args.size()) {
 487             var end = start + batchSize;
 488             if (end &gt; args.size()) {
 489                 end = args.size();
 490             }
 491             op.execute(args.subList(start, end));
 492             start = end;
 493         }
 494     }
 495 
 496     private void addAll(List&lt;Path&gt; paths) throws IOException {
 497         var cmd = new ArrayList&lt;&gt;(List.of(&quot;git&quot;, &quot;add&quot;));
 498         for (var path : paths) {
 499             cmd.add(path.toString());
 500         }
 501         try (var p = capture(cmd)) {
 502             await(p);
 503         }
 504     }
 505 
 506     @Override
 507     public void add(List&lt;Path&gt; paths) throws IOException {
 508         batch(this::addAll, paths);
 509     }
 510 
 511     private void removeAll(List&lt;Path&gt; paths) throws IOException {
 512         var cmd = new ArrayList&lt;&gt;(List.of(&quot;git&quot;, &quot;rm&quot;));
 513         for (var path : paths) {
 514             cmd.add(path.toString());
 515         }
 516         try (var p = capture(cmd)) {
 517             await(p);
 518         }
 519     }
 520 
 521     @Override
 522     public void remove(List&lt;Path&gt; paths) throws IOException {
 523         batch(this::removeAll, paths);
 524     }
 525 
 526     @Override
 527     public void delete(Branch b) throws IOException {
 528         try (var p = capture(&quot;git&quot;, &quot;branch&quot;, &quot;-D&quot;, b.name())) {
 529             await(p);
 530         }
 531     }
 532 
 533     @Override
 534     public void addremove() throws IOException {
 535         try (var p = capture(&quot;git&quot;, &quot;add&quot;, &quot;--all&quot;)) {
 536             await(p);
 537         }
 538     }
 539 
 540     @Override
 541     public Hash commit(String message, String authorName, String authorEmail)  throws IOException {
 542         return commit(message, authorName, authorEmail, null);
 543     }
 544 
 545     @Override
 546     public Hash commit(String message, String authorName, String authorEmail, ZonedDateTime authorDate)  throws IOException {
 547         return commit(message, authorName, authorEmail, authorDate, authorName, authorEmail, authorDate);
 548     }
 549 
 550     @Override
 551     public Hash commit(String message,
 552                        String authorName,
 553                        String authorEmail,
 554                        String committerName,
 555                        String committerEmail) throws IOException {
 556         return commit(message, authorName, authorEmail, null, committerName, committerEmail, null);
 557     }
 558 
 559     @Override
 560     public Hash commit(String message,
 561                        String authorName,
 562                        String authorEmail,
 563                        ZonedDateTime authorDate,
 564                        String committerName,
 565                        String committerEmail,
 566                        ZonedDateTime committerDate) throws IOException {
 567         var cmd = Process.capture(&quot;git&quot;, &quot;commit&quot;, &quot;--message=&quot; + message)
 568                          .workdir(dir)
 569                          .environ(&quot;GIT_AUTHOR_NAME&quot;, authorName)
 570                          .environ(&quot;GIT_AUTHOR_EMAIL&quot;, authorEmail)
 571                          .environ(&quot;GIT_COMMITTER_NAME&quot;, committerName)
 572                          .environ(&quot;GIT_COMMITTER_EMAIL&quot;, committerEmail);
 573         if (authorDate != null) {
 574             cmd = cmd.environ(&quot;GIT_AUTHOR_DATE&quot;,
 575                               authorDate.format(DateTimeFormatter.ISO_OFFSET_DATE_TIME));
 576         }
 577         if (committerDate != null) {
 578             cmd = cmd.environ(&quot;GIT_COMMITTER_DATE&quot;,
 579                               committerDate.format(DateTimeFormatter.ISO_OFFSET_DATE_TIME));
 580         }
 581         try (var p = cmd.execute()) {
 582             await(p);
 583             return head();
 584         }
 585     }
 586 
 587     @Override
 588     public Hash amend(String message, String authorName, String authorEmail) throws IOException {
 589         return amend(message, authorName, authorEmail, null, null);
 590     }
 591 
 592     @Override
 593     public Hash amend(String message, String authorName, String authorEmail, String committerName, String committerEmail) throws IOException {
 594         if (committerName == null) {
 595             committerName = authorName;
 596             committerEmail = authorEmail;
 597         }
 598         var cmd = Process.capture(&quot;git&quot;, &quot;commit&quot;, &quot;--amend&quot;, &quot;--reset-author&quot;, &quot;--message=&quot; + message)
 599                          .workdir(dir)
 600                          .environ(&quot;GIT_AUTHOR_NAME&quot;, authorName)
 601                          .environ(&quot;GIT_AUTHOR_EMAIL&quot;, authorEmail)
 602                          .environ(&quot;GIT_COMMITTER_NAME&quot;, committerName)
 603                          .environ(&quot;GIT_COMMITTER_EMAIL&quot;, committerEmail);
 604         try (var p = cmd.execute()) {
 605             await(p);
 606             return head();
 607         }
 608     }
 609 
 610     @Override
 611     public Tag tag(Hash hash, String name, String message, String authorName, String authorEmail) throws IOException {
 612         var cmd = Process.capture(&quot;git&quot;, &quot;tag&quot;, &quot;--annotate&quot;, &quot;--message=&quot; + message, name, hash.hex())
 613                          .workdir(dir)
 614                          .environ(&quot;GIT_AUTHOR_NAME&quot;, authorName)
 615                          .environ(&quot;GIT_AUTHOR_EMAIL&quot;, authorEmail)
 616                          .environ(&quot;GIT_COMMITTER_NAME&quot;, authorName)
 617                          .environ(&quot;GIT_COMMITTER_EMAIL&quot;, authorEmail);
 618         try (var p = cmd.execute()) {
 619             await(p);
 620         }
 621 
 622         return new Tag(name);
 623     }
 624 
 625     @Override
 626     public Branch branch(Hash hash, String name) throws IOException {
 627         try (var p = capture(&quot;git&quot;, &quot;branch&quot;, name, hash.hex())) {
 628             await(p);
 629         }
 630 
 631         return new Branch(name);
 632     }
 633 
 634     @Override
 635     public Hash mergeBase(Hash first, Hash second) throws IOException {
 636         try (var p = capture(&quot;git&quot;, &quot;merge-base&quot;, first.hex(), second.hex())) {
 637             var res = await(p);
 638             if (res.stdout().size() != 1) {
 639                  throw new IOException(&quot;Unexpected output\n&quot; + res);
 640             }
 641             return new Hash(res.stdout().get(0));
 642         }
 643     }
 644 
 645     @Override
 646     public boolean isAncestor(Hash ancestor, Hash descendant) throws IOException {
 647         try (var p = capture(&quot;git&quot;, &quot;merge-base&quot;, &quot;--is-ancestor&quot;, ancestor.hex(), descendant.hex())) {
 648             var res = p.await();
 649             return res.status() == 0;
 650         }
 651     }
 652 
 653     @Override
 654     public void rebase(Hash hash, String committerName, String committerEmail) throws IOException {
 655         try (var p = Process.capture(&quot;git&quot;, &quot;rebase&quot;, &quot;--onto&quot;, hash.hex(), &quot;--root&quot;, &quot;--rebase-merges&quot;)
 656                             .environ(&quot;GIT_COMMITTER_NAME&quot;, committerName)
 657                             .environ(&quot;GIT_COMMITTER_EMAIL&quot;, committerEmail)
 658                             .workdir(dir)
 659                             .execute()) {
 660             await(p);
 661         }
 662     }
 663 
 664     @Override
 665     public Optional&lt;Hash&gt; resolve(String ref) throws IOException {
 666         // CYGWIN: need to escape the { and }
 667         // FIXME: only do this if using Cygwin git
 668         try (var p = capture(&quot;git&quot;, &quot;rev-parse&quot;, ref + &quot;^\\{commit\\}&quot;)) {
 669             var res = p.await();
 670             if (res.status() == 0 &amp;&amp; res.stdout().size() == 1) {
 671                 return Optional.of(new Hash(res.stdout().get(0)));
 672             }
 673             return Optional.empty();
 674         }
 675     }
 676 
 677     @Override
 678     public Branch currentBranch() throws IOException {
 679         try (var p = capture(&quot;git&quot;, &quot;symbolic-ref&quot;, &quot;--short&quot;, &quot;HEAD&quot;)) {
 680             var res = await(p);
 681             if (res.stdout().size() != 1) {
 682                 throw new IOException(&quot;Unexpected output\n&quot; + res);
 683             }
 684             return new Branch(res.stdout().get(0));
 685         }
 686     }
 687 
 688     @Override
 689     public Optional&lt;Bookmark&gt; currentBookmark() throws IOException {
 690         throw new RuntimeException(&quot;git does not have bookmarks&quot;);
 691     }
 692 
 693     @Override
 694     public Branch defaultBranch() throws IOException {
 695         try (var p = capture(&quot;git&quot;, &quot;symbolic-ref&quot;, &quot;--short&quot;, &quot;refs/remotes/origin/HEAD&quot;)) {
 696             var res = p.await();
 697             if (res.status() == 0 &amp;&amp; res.stdout().size() == 1) {
 698                 var ref = res.stdout().get(0).substring(&quot;origin/&quot;.length());
 699                 return new Branch(ref);
 700             } else {
 701                 return new Branch(&quot;master&quot;);
 702             }
 703         }
 704     }
 705 
 706     @Override
 707     public Optional&lt;Tag&gt; defaultTag() throws IOException {
 708         return Optional.empty();
 709     }
 710 
 711     @Override
 712     public Optional&lt;String&gt; username() throws IOException {
 713         var lines = config(&quot;user.name&quot;);
 714         return lines.size() == 1 ? Optional.of(lines.get(0)) : Optional.empty();
 715     }
 716 
 717     private String treeEntry(Path path, Hash hash) throws IOException {
<a name="1" id="anc1"></a><span class="line-added"> 718         // CYGWIN: map `\` to `/`</span>
<span class="line-added"> 719         // FIXME: only do this if using Cygwin git</span>
 720         try (var p = Process.capture(&quot;git&quot;, &quot;ls-tree&quot;, hash.hex(), path.toString().replace(&quot;\\&quot;, &quot;/&quot;))
 721                             .workdir(root())
 722                             .execute()) {
 723             var res = await(p);
 724             if (res.stdout().size() == 0) {
 725                 return null;
 726             }
 727             if (res.stdout().size() &gt; 1) {
 728                 throw new IOException(&quot;Unexpected output\n&quot; + res);
 729             }
 730             return res.stdout().get(0);
 731         }
 732     }
 733 
 734     private List&lt;FileEntry&gt; allFiles(Hash hash, List&lt;Path&gt; paths) throws IOException {
 735         var cmd = new ArrayList&lt;String&gt;();
 736         cmd.addAll(List.of(&quot;git&quot;, &quot;ls-tree&quot;, &quot;-r&quot;));
 737         cmd.add(hash.hex());
 738         // CYGWIN: map `\` to `/`
 739         // FIXME: only do this if using Cygwin git
 740         cmd.addAll(paths.stream().map(Path::toString).map(s -&gt; s.replace(&quot;\\&quot;, &quot;/&quot;)).collect(Collectors.toList()));
 741         try (var p = Process.capture(cmd.toArray(new String[0]))
 742                             .workdir(root())
 743                             .execute()) {
 744             var res = await(p);
 745             var entries = new ArrayList&lt;FileEntry&gt;();
 746             for (var line : res.stdout()) {
 747                 var parts = line.split(&quot;\t&quot;);
 748                 var metadata = parts[0].split(&quot; &quot;);
 749                 var filename = parts[1];
 750 
 751                 var entry = new FileEntry(hash,
 752                                           FileType.fromOctal(metadata[0]),
 753                                           new Hash(metadata[2]),
 754                                           Path.of(filename));
 755                 entries.add(entry);
 756             }
 757             return entries;
 758         }
 759     }
 760 
 761     @Override
 762     public List&lt;FileEntry&gt; files(Hash hash, List&lt;Path&gt; paths) throws IOException {
 763         if (paths.isEmpty()) {
 764             return allFiles(hash, paths);
 765         }
 766 
 767         var entries = new ArrayList&lt;FileEntry&gt;();
 768         var batchSize = 64;
 769         var start = 0;
 770         while (start &lt; paths.size()) {
 771             var end = start + batchSize;
 772             if (end &gt; paths.size()) {
 773                 end = paths.size();
 774             }
 775             entries.addAll(allFiles(hash, paths.subList(start, end)));
 776             start = end;
 777         }
 778         return entries;
 779     }
 780 
 781     private Path unpackFile(String blob) throws IOException {
 782         try (var p = capture(&quot;git&quot;, &quot;unpack-file&quot;, blob)) {
 783             var res = await(p);
 784             if (res.stdout().size() != 1) {
 785                 throw new IOException(&quot;Unexpected output\n&quot; + res);
 786             }
 787 
 788             return Path.of(root().toString(), res.stdout().get(0));
 789         }
 790     }
 791 
 792     @Override
 793     public Optional&lt;byte[]&gt; show(Path path, Hash hash) throws IOException {
 794         var entries = files(hash, path);
 795         if (entries.size() == 0) {
 796             return Optional.empty();
 797         } else if (entries.size() &gt; 1) {
 798             throw new IOException(&quot;Multiple files match path &quot; + path.toString() + &quot; in commit &quot; + hash.hex());
 799         }
 800 
 801         var entry = entries.get(0);
 802         var type = entry.type();
 803         if (type.isVCSLink()) {
 804             var content = &quot;Subproject commit &quot; + entry.hash().hex() + &quot; &quot; + entry.path().toString();
 805             return Optional.of(content.getBytes(StandardCharsets.UTF_8));
 806         } else if (type.isRegular()) {
 807             var tmp = unpackFile(entry.hash().hex());
 808             var content = Files.readAllBytes(tmp);
 809             Files.delete(tmp);
 810             return Optional.of(content);
 811         }
 812 
 813         return Optional.empty();
 814     }
 815 
 816     @Override
 817     public void dump(FileEntry entry, Path to) throws IOException {
 818         var type = entry.type();
 819         if (type.isRegular()) {
 820             var path = unpackFile(entry.hash().hex());
 821             Files.createDirectories(to.getParent());
 822             Files.move(path, to, StandardCopyOption.REPLACE_EXISTING);
 823         }
 824     }
 825 
 826     @Override
 827     public List&lt;StatusEntry&gt; status(Hash from, Hash to) throws IOException {
 828         try (var p = capture(&quot;git&quot;, &quot;diff&quot;, &quot;--raw&quot;, &quot;--find-renames=99%&quot;, &quot;--find-copies=99%&quot;, &quot;--find-copies-harder&quot;, &quot;--no-abbrev&quot;, &quot;--no-color&quot;, from.hex(), to.hex())) {
 829             var res = await(p);
 830             var entries = new ArrayList&lt;StatusEntry&gt;();
 831             for (var line : res.stdout()) {
 832                 entries.add(StatusEntry.fromRawLine(line));
 833             }
 834             return entries;
 835         }
 836     }
 837 
 838     @Override
 839     public Diff diff(Hash from) throws IOException {
 840         return diff(from, null);
 841     }
 842 
 843     @Override
 844     public Diff diff(Hash from, Hash to) throws IOException {
 845         var cmd = new ArrayList&lt;&gt;(List.of(&quot;git&quot;, &quot;diff&quot;, &quot;--patch&quot;,
 846                                                          &quot;--find-renames=99%&quot;,
 847                                                          &quot;--find-copies=99%&quot;,
 848                                                          &quot;--find-copies-harder&quot;,
 849                                                          &quot;--binary&quot;,
 850                                                          &quot;--raw&quot;,
 851                                                          &quot;--no-abbrev&quot;,
 852                                                          &quot;--unified=0&quot;,
 853                                                          &quot;--no-color&quot;,
 854                                                          from.hex()));
 855         if (to != null) {
 856             cmd.add(to.hex());
 857         }
 858 
 859         var p = start(cmd);
 860         try {
 861             var patches = UnifiedDiffParser.parseGitRaw(p.getInputStream());
 862             await(p);
 863             return new Diff(from, to, patches);
 864         } catch (Throwable t) {
 865             stop(p);
 866             throw t;
 867         }
 868     }
 869 
 870     @Override
 871     public List&lt;String&gt; config(String key) throws IOException {
 872         try (var p = capture(&quot;git&quot;, &quot;config&quot;, key)) {
 873             var res = p.await();
 874             return res.status() == 0 ? res.stdout() : List.of();
 875         }
 876     }
 877 
 878     @Override
 879     public Hash head() throws IOException {
 880         return resolve(&quot;HEAD&quot;).orElseThrow(() -&gt; new IllegalStateException(&quot;HEAD ref is not present&quot;));
 881     }
 882 
 883     public static Optional&lt;Repository&gt; get(Path p) throws IOException {
 884         if (!Files.exists(p)) {
 885             return Optional.empty();
 886         }
 887 
 888         var r = new GitRepository(p);
 889         return r.exists() ? Optional.of(new GitRepository(r.root())) : Optional.empty();
 890     }
 891 
 892     @Override
 893     public Repository copyTo(Path destination) throws IOException {
 894         try (var p = capture(&quot;git&quot;, &quot;clone&quot;, root().toString(), destination.toString())) {
 895             await(p);
 896         }
 897 
 898         return new GitRepository(destination);
 899     }
 900 
 901     @Override
 902     public void merge(Hash h) throws IOException {
 903         merge(h, null);
 904     }
 905 
 906     @Override
 907     public void merge(Hash h, String strategy) throws IOException {
 908         var cmd = new ArrayList&lt;String&gt;();
 909         cmd.addAll(List.of(&quot;git&quot;, &quot;-c&quot;, &quot;user.name=unused&quot;, &quot;-c&quot;, &quot;user.email=unused&quot;,
 910                            &quot;merge&quot;, &quot;--no-commit&quot;));
 911         if (strategy != null) {
 912             cmd.add(&quot;-s&quot;);
 913             cmd.add(strategy);
 914         }
 915         cmd.add(h.hex());
 916         try (var p = capture(cmd)) {
 917             await(p);
 918         }
 919     }
 920 
 921     @Override
 922     public void abortMerge() throws IOException {
 923         try (var p = capture(&quot;git&quot;, &quot;merge&quot;, &quot;--abort&quot;)) {
 924             await(p);
 925         }
 926     }
 927 
 928     @Override
 929     public void addRemote(String name, String pullPath) throws IOException {
 930         try (var p = capture(&quot;git&quot;, &quot;remote&quot;, &quot;add&quot;, name, pullPath)) {
 931             await(p);
 932         }
 933     }
 934 
 935     @Override
 936     public void setPaths(String remote, String pullPath, String pushPath) throws IOException {
 937         pullPath = pullPath == null ? &quot;&quot; : pullPath;
 938         try (var p = capture(&quot;git&quot;, &quot;config&quot;, &quot;remote.&quot; + remote + &quot;.url&quot;, pullPath)) {
 939             await(p);
 940         }
 941 
 942         pushPath = pushPath == null ? &quot;&quot; : pushPath;
 943         try (var p = capture(&quot;git&quot;, &quot;config&quot;, &quot;remote.&quot; + remote + &quot;.pushurl&quot;, pushPath)) {
 944             await(p);
 945         }
 946     }
 947 
 948     @Override
 949     public String pullPath(String remote) throws IOException {
 950         var lines = config(&quot;remote.&quot; + remote + &quot;.url&quot;);
 951         if (lines.size() != 1) {
 952             throw new IOException(&quot;No pull path found for remote &quot; + remote);
 953         }
 954         return lines.get(0);
 955     }
 956 
 957     @Override
 958     public String pushPath(String remote) throws IOException {
 959         var lines = config(&quot;remote.&quot; + remote + &quot;.pushurl&quot;);
 960         if (lines.size() != 1) {
 961             return pullPath(remote);
 962         }
 963         return lines.get(0);
 964     }
 965 
 966     @Override
 967     public boolean isValidRevisionRange(String expression) throws IOException {
 968         try (var p = capture(&quot;git&quot;, &quot;rev-parse&quot;, expression)) {
 969             return p.await().status() == 0;
 970         }
 971     }
 972 
 973     private void applyPatch(Patch patch) throws IOException {
 974         if (patch.isEmpty()) {
 975             return;
 976         }
 977 
 978         if (patch.isTextual()) {
 979         } else {
 980             throw new IllegalArgumentException(&quot;Cannot handle binary patches yet&quot;);
 981         }
 982     }
 983 
 984     @Override
 985     public void apply(Diff diff, boolean force) throws IOException {
 986         // ignore force, no such concept in git
 987         var patchFile = Files.createTempFile(&quot;apply&quot;, &quot;.patch&quot;);
 988         diff.toFile(patchFile);
 989         apply(patchFile, force);
 990         Files.delete(patchFile);
 991     }
 992 
 993     @Override
 994     public void apply(Path patchFile, boolean force)  throws IOException {
 995         var cmd = new ArrayList&lt;String&gt;();
 996         cmd.addAll(List.of(&quot;git&quot;, &quot;apply&quot;, &quot;--index&quot;, &quot;--unidiff-zero&quot;));
 997         cmd.add(patchFile.toAbsolutePath().toString());
 998         try (var p = capture(cmd)) {
 999             await(p);
1000             Files.delete(patchFile);
1001         }
1002     }
1003 
1004     @Override
1005     public void copy(Path from, Path to) throws IOException {
1006         Files.copy(from, to);
1007         add(to);
1008     }
1009 
1010     @Override
1011     public void move(Path from, Path to) throws IOException {
1012         try (var p = capture(&quot;git&quot;, &quot;mv&quot;, from.toString(), to.toString())) {
1013             await(p);
1014         }
1015     }
1016 
1017     @Override
1018     public Optional&lt;String&gt; upstreamFor(Branch b) throws IOException {
1019         try (var p = capture(&quot;git&quot;, &quot;for-each-ref&quot;, &quot;--format=%(upstream:short)&quot;, &quot;refs/heads/&quot; + b.name())) {
1020             var lines = await(p).stdout();
1021             return lines.size() == 1 &amp;&amp; !lines.get(0).isEmpty()? Optional.of(lines.get(0)) : Optional.empty();
1022         }
1023     }
1024 
1025     public static Repository clone(URI from, Path to, boolean isBare) throws IOException {
1026         var cmd = new ArrayList&lt;String&gt;();
1027         cmd.addAll(List.of(&quot;git&quot;, &quot;clone&quot;));
1028         if (isBare) {
1029             cmd.add(&quot;--bare&quot;);
1030         }
1031         cmd.addAll(List.of(from.toString(), to.toString()));
1032         try (var p = capture(Path.of(&quot;&quot;).toAbsolutePath(), cmd)) {
1033             await(p);
1034         }
1035         return new GitRepository(to);
1036     }
1037 
1038     public static Repository mirror(URI from, Path to) throws IOException {
1039         var cwd = Path.of(&quot;&quot;).toAbsolutePath();
1040         try (var p = capture(cwd, &quot;git&quot;, &quot;clone&quot;, &quot;--mirror&quot;, from.toString(), to.toString())) {
1041             await(p);
1042         }
1043         return new GitRepository(to);
1044     }
1045 
1046     @Override
1047     public void pull() throws IOException {
1048         pull(null, null);
1049     }
1050 
1051     @Override
1052     public void pull(String remote) throws IOException {
1053         pull(remote, null);
1054     }
1055 
1056 
1057     @Override
1058     public void pull(String remote, String refspec) throws IOException {
1059         var cmd = new ArrayList&lt;String&gt;();
1060         cmd.add(&quot;git&quot;);
1061         cmd.add(&quot;pull&quot;);
1062         if (remote != null) {
1063             cmd.add(remote);
1064         }
1065         if (refspec != null) {
1066             cmd.add(refspec);
1067         }
1068         try (var p = capture(cmd)) {
1069             await(p);
1070         }
1071     }
1072 
1073     @Override
1074     public boolean contains(Branch b, Hash h) throws IOException {
1075         try (var p = capture(&quot;git&quot;, &quot;for-each-ref&quot;, &quot;--contains&quot;, h.hex(), &quot;--format&quot;, &quot;%(refname:short)&quot;)) {
1076             var res = await(p);
1077             for (var line : res.stdout()) {
1078                 if (line.equals(b.name())) {
1079                     return true;
1080                 }
1081             }
1082         }
1083 
1084         return false;
1085     }
1086 
1087     @Override
1088     public List&lt;Reference&gt; remoteBranches(String remote) throws IOException {
1089         var refs = new ArrayList&lt;Reference&gt;();
1090         try (var p = capture(&quot;git&quot;, &quot;ls-remote&quot;, &quot;--heads&quot;, &quot;--refs&quot;, remote)) {
1091             for (var line : await(p).stdout()) {
1092                 var parts = line.split(&quot;\t&quot;);
1093                 var name = parts[1].replace(&quot;refs/heads/&quot;, &quot;&quot;);
1094                 refs.add(new Reference(name, new Hash(parts[0])));
1095             }
1096         }
1097         return refs;
1098     }
1099 
1100     @Override
1101     public List&lt;String&gt; remotes() throws IOException {
1102         var remotes = new ArrayList&lt;String&gt;();
1103         try (var p = capture(&quot;git&quot;, &quot;remote&quot;)) {
1104             for (var line : await(p).stdout()) {
1105                 remotes.add(line);
1106             }
1107         }
1108         return remotes;
1109     }
1110 }
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>