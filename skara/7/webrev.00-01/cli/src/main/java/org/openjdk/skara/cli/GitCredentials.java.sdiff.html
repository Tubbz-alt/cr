<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff cli/src/main/java/org/openjdk/skara/cli/GitCredentials.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> <a href="GitFork.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>cli/src/main/java/org/openjdk/skara/cli/GitCredentials.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.cli;
 24 
 25 import java.io.IOException;
 26 import java.nio.charset.StandardCharsets;
 27 import java.util.concurrent.TimeUnit;
 28 
 29 class GitCredentials {
 30     private final String host;

 31     private final String username;
 32     private final String password;
 33     private final String protocol;
 34 
<span class="line-modified"> 35     GitCredentials(String host, String username, String password, String protocol) {</span>
 36         this.host = host;

 37         this.username = username;
 38         this.password = password;
 39         this.protocol = protocol;
 40     }
 41 
 42     String host() {
 43         return host;
 44     }
 45 




 46     String username() {
 47         return username;
 48     }
 49 
 50     String password() {
 51         return password;
 52     }
 53 
 54     String protocol() {
 55         return protocol;
 56     }
 57 
<span class="line-modified"> 58     static GitCredentials fill(String host, String username, String password, String protocol) throws IOException {</span>
 59         try {
 60             var pb = new ProcessBuilder(&quot;git&quot;, &quot;credential&quot;, &quot;fill&quot;);
 61             pb.redirectInput(ProcessBuilder.Redirect.PIPE);
 62             pb.redirectOutput(ProcessBuilder.Redirect.PIPE);
 63             pb.redirectError(ProcessBuilder.Redirect.INHERIT);
 64             var p = pb.start();
 65 
 66             var gitStdin = p.getOutputStream();
 67             String input = &quot;host=&quot; + host + &quot;\n&quot;;



 68             if (username != null) {
 69                 input += &quot;username=&quot; + username + &quot;\n&quot;;
 70             }
 71             if (password != null) {
 72                 input += &quot;password=&quot; + password + &quot;\n&quot;;
 73             }
 74             if (protocol != null) {
 75                 input += &quot;protocol=&quot; + protocol + &quot;\n&quot;;
 76             }
 77             gitStdin.write((input + &quot;\n&quot;).getBytes(StandardCharsets.UTF_8));
 78             gitStdin.flush();
 79 
 80             var bytes = p.getInputStream().readAllBytes();
 81             var exited = p.waitFor(10, TimeUnit.MINUTES);
 82             var exitValue = p.exitValue();
 83             if (!exited || exitValue != 0) {
 84                 throw new IOException(&quot;&#39;git credential&#39; exited with value: &quot; + exitValue);
 85             }
 86 
 87             protocol = null;
</pre>
<hr />
<pre>
 70             }
 71             if (password != null) {
 72                 input += &quot;password=&quot; + password + &quot;\n&quot;;
 73             }
 74             if (protocol != null) {
 75                 input += &quot;protocol=&quot; + protocol + &quot;\n&quot;;
 76             }
 77             gitStdin.write((input + &quot;\n&quot;).getBytes(StandardCharsets.UTF_8));
 78             gitStdin.flush();
 79 
 80             var bytes = p.getInputStream().readAllBytes();
 81             var exited = p.waitFor(10, TimeUnit.MINUTES);
 82             var exitValue = p.exitValue();
 83             if (!exited || exitValue != 0) {
 84                 throw new IOException(&quot;&#39;git credential&#39; exited with value: &quot; + exitValue);
 85             }
 86 
 87             protocol = null;
 88             username = null;
 89             password = null;

 90             host = null;
 91             for (var line : new String(bytes, StandardCharsets.UTF_8).split(&quot;\n&quot;)) {
 92                 if (line.startsWith(&quot;host=&quot;)) {
 93                     host = line.split(&quot;=&quot;)[1];
 94                 } else if (line.startsWith(&quot;username=&quot;)) {
 95                     username = line.split(&quot;=&quot;)[1];
 96                 } else if (line.startsWith(&quot;password=&quot;)) {
 97                     password = line.split(&quot;=&quot;)[1];
 98                 } else if (line.startsWith(&quot;protocol=&quot;)) {
 99                     protocol = line.split(&quot;=&quot;)[1];
100                 } else if (line.startsWith(&quot;path=&quot;)) {
<span class="line-modified">101                     // ignore for now</span>

102                 } else {
103                     throw new IOException(&quot;&#39;git credential&#39; returned unexpected line: &quot; + line);
104                 }
105             }
106 
<span class="line-modified">107             return new GitCredentials(host, username, password, protocol);</span>
108         } catch (InterruptedException e) {
109             throw new IOException(e);
110         }
111     }
112 
113     static void approve(GitCredentials credentials) throws IOException {
114         try {
115             var pb = new ProcessBuilder(&quot;git&quot;, &quot;credential&quot;, &quot;approve&quot;);
116             pb.redirectInput(ProcessBuilder.Redirect.PIPE);
117             pb.redirectOutput(ProcessBuilder.Redirect.INHERIT);
118             pb.redirectError(ProcessBuilder.Redirect.INHERIT);
119             var p = pb.start();
120 
121             var gitStdin = p.getOutputStream();
122             String input = &quot;host=&quot; + credentials.host() + &quot;\n&quot; +

123                            &quot;username=&quot; + credentials.username() + &quot;\n&quot; +
124                            &quot;password=&quot; + credentials.password() + &quot;\n&quot; +
125                            &quot;protocol=&quot; + credentials.protocol() + &quot;\n&quot;;
126             gitStdin.write((input + &quot;\n&quot;).getBytes(StandardCharsets.UTF_8));
127             gitStdin.flush();
128             var res = p.waitFor();
129             if (res != 0) {
130                 throw new IOException(&quot;&#39;git credential approve&#39; exited with value: &quot; + res);
131             }
132         } catch (InterruptedException e) {
133             throw new IOException(e);
134         }
135     }
136 
137     static void reject(GitCredentials credentials) throws IOException {
138         try {
139             var pb = new ProcessBuilder(&quot;git&quot;, &quot;credential&quot;, &quot;reject&quot;);
140             pb.redirectInput(ProcessBuilder.Redirect.PIPE);
141             pb.redirectOutput(ProcessBuilder.Redirect.INHERIT);
142             pb.redirectError(ProcessBuilder.Redirect.INHERIT);
</pre>
<hr />
<pre>
127             gitStdin.flush();
128             var res = p.waitFor();
129             if (res != 0) {
130                 throw new IOException(&quot;&#39;git credential approve&#39; exited with value: &quot; + res);
131             }
132         } catch (InterruptedException e) {
133             throw new IOException(e);
134         }
135     }
136 
137     static void reject(GitCredentials credentials) throws IOException {
138         try {
139             var pb = new ProcessBuilder(&quot;git&quot;, &quot;credential&quot;, &quot;reject&quot;);
140             pb.redirectInput(ProcessBuilder.Redirect.PIPE);
141             pb.redirectOutput(ProcessBuilder.Redirect.INHERIT);
142             pb.redirectError(ProcessBuilder.Redirect.INHERIT);
143             var p = pb.start();
144 
145             var gitStdin = p.getOutputStream();
146             String input = &quot;host=&quot; + credentials.host() + &quot;\n&quot; +

147                            &quot;username=&quot; + credentials.username() + &quot;\n&quot; +
148                            &quot;password=&quot; + credentials.password() + &quot;\n&quot; +
149                            &quot;protocol=&quot; + credentials.protocol() + &quot;\n&quot;;
150             gitStdin.write((input + &quot;\n&quot;).getBytes(StandardCharsets.UTF_8));
151             gitStdin.flush();
152             var res = p.waitFor();
153             if (res != 0) {
154                 throw new IOException(&quot;&#39;git credential reject&#39; exited with value: &quot; + res);
155             }
156         } catch (InterruptedException e) {
157             throw new IOException(e);
158         }
159     }
160 }
</pre>
</td>
<td>
<hr />
<pre>
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.cli;
 24 
 25 import java.io.IOException;
 26 import java.nio.charset.StandardCharsets;
 27 import java.util.concurrent.TimeUnit;
 28 
 29 class GitCredentials {
 30     private final String host;
<span class="line-added"> 31     private final String path;</span>
 32     private final String username;
 33     private final String password;
 34     private final String protocol;
 35 
<span class="line-modified"> 36     GitCredentials(String host, String path, String username, String password, String protocol) {</span>
 37         this.host = host;
<span class="line-added"> 38         this.path = path;</span>
 39         this.username = username;
 40         this.password = password;
 41         this.protocol = protocol;
 42     }
 43 
 44     String host() {
 45         return host;
 46     }
 47 
<span class="line-added"> 48     String path() {</span>
<span class="line-added"> 49         return path;</span>
<span class="line-added"> 50     }</span>
<span class="line-added"> 51 </span>
 52     String username() {
 53         return username;
 54     }
 55 
 56     String password() {
 57         return password;
 58     }
 59 
 60     String protocol() {
 61         return protocol;
 62     }
 63 
<span class="line-modified"> 64     static GitCredentials fill(String host, String path, String username, String password, String protocol) throws IOException {</span>
 65         try {
 66             var pb = new ProcessBuilder(&quot;git&quot;, &quot;credential&quot;, &quot;fill&quot;);
 67             pb.redirectInput(ProcessBuilder.Redirect.PIPE);
 68             pb.redirectOutput(ProcessBuilder.Redirect.PIPE);
 69             pb.redirectError(ProcessBuilder.Redirect.INHERIT);
 70             var p = pb.start();
 71 
 72             var gitStdin = p.getOutputStream();
 73             String input = &quot;host=&quot; + host + &quot;\n&quot;;
<span class="line-added"> 74             if (path != null) {</span>
<span class="line-added"> 75                 input += &quot;path=&quot; + path + &quot;\n&quot;;</span>
<span class="line-added"> 76             }</span>
 77             if (username != null) {
 78                 input += &quot;username=&quot; + username + &quot;\n&quot;;
 79             }
 80             if (password != null) {
 81                 input += &quot;password=&quot; + password + &quot;\n&quot;;
 82             }
 83             if (protocol != null) {
 84                 input += &quot;protocol=&quot; + protocol + &quot;\n&quot;;
 85             }
 86             gitStdin.write((input + &quot;\n&quot;).getBytes(StandardCharsets.UTF_8));
 87             gitStdin.flush();
 88 
 89             var bytes = p.getInputStream().readAllBytes();
 90             var exited = p.waitFor(10, TimeUnit.MINUTES);
 91             var exitValue = p.exitValue();
 92             if (!exited || exitValue != 0) {
 93                 throw new IOException(&quot;&#39;git credential&#39; exited with value: &quot; + exitValue);
 94             }
 95 
 96             protocol = null;
</pre>
<hr />
<pre>
 79             }
 80             if (password != null) {
 81                 input += &quot;password=&quot; + password + &quot;\n&quot;;
 82             }
 83             if (protocol != null) {
 84                 input += &quot;protocol=&quot; + protocol + &quot;\n&quot;;
 85             }
 86             gitStdin.write((input + &quot;\n&quot;).getBytes(StandardCharsets.UTF_8));
 87             gitStdin.flush();
 88 
 89             var bytes = p.getInputStream().readAllBytes();
 90             var exited = p.waitFor(10, TimeUnit.MINUTES);
 91             var exitValue = p.exitValue();
 92             if (!exited || exitValue != 0) {
 93                 throw new IOException(&quot;&#39;git credential&#39; exited with value: &quot; + exitValue);
 94             }
 95 
 96             protocol = null;
 97             username = null;
 98             password = null;
<span class="line-added"> 99             path = null;</span>
100             host = null;
101             for (var line : new String(bytes, StandardCharsets.UTF_8).split(&quot;\n&quot;)) {
102                 if (line.startsWith(&quot;host=&quot;)) {
103                     host = line.split(&quot;=&quot;)[1];
104                 } else if (line.startsWith(&quot;username=&quot;)) {
105                     username = line.split(&quot;=&quot;)[1];
106                 } else if (line.startsWith(&quot;password=&quot;)) {
107                     password = line.split(&quot;=&quot;)[1];
108                 } else if (line.startsWith(&quot;protocol=&quot;)) {
109                     protocol = line.split(&quot;=&quot;)[1];
110                 } else if (line.startsWith(&quot;path=&quot;)) {
<span class="line-modified">111                     String[] parts = line.split(&quot;=&quot;);</span>
<span class="line-added">112                     path = parts.length &gt; 1 ? parts[1] : null; // value can be empty</span>
113                 } else {
114                     throw new IOException(&quot;&#39;git credential&#39; returned unexpected line: &quot; + line);
115                 }
116             }
117 
<span class="line-modified">118             return new GitCredentials(host, path, username, password, protocol);</span>
119         } catch (InterruptedException e) {
120             throw new IOException(e);
121         }
122     }
123 
124     static void approve(GitCredentials credentials) throws IOException {
125         try {
126             var pb = new ProcessBuilder(&quot;git&quot;, &quot;credential&quot;, &quot;approve&quot;);
127             pb.redirectInput(ProcessBuilder.Redirect.PIPE);
128             pb.redirectOutput(ProcessBuilder.Redirect.INHERIT);
129             pb.redirectError(ProcessBuilder.Redirect.INHERIT);
130             var p = pb.start();
131 
132             var gitStdin = p.getOutputStream();
133             String input = &quot;host=&quot; + credentials.host() + &quot;\n&quot; +
<span class="line-added">134                            &quot;path=&quot; + credentials.path() + &quot;\n&quot; +</span>
135                            &quot;username=&quot; + credentials.username() + &quot;\n&quot; +
136                            &quot;password=&quot; + credentials.password() + &quot;\n&quot; +
137                            &quot;protocol=&quot; + credentials.protocol() + &quot;\n&quot;;
138             gitStdin.write((input + &quot;\n&quot;).getBytes(StandardCharsets.UTF_8));
139             gitStdin.flush();
140             var res = p.waitFor();
141             if (res != 0) {
142                 throw new IOException(&quot;&#39;git credential approve&#39; exited with value: &quot; + res);
143             }
144         } catch (InterruptedException e) {
145             throw new IOException(e);
146         }
147     }
148 
149     static void reject(GitCredentials credentials) throws IOException {
150         try {
151             var pb = new ProcessBuilder(&quot;git&quot;, &quot;credential&quot;, &quot;reject&quot;);
152             pb.redirectInput(ProcessBuilder.Redirect.PIPE);
153             pb.redirectOutput(ProcessBuilder.Redirect.INHERIT);
154             pb.redirectError(ProcessBuilder.Redirect.INHERIT);
</pre>
<hr />
<pre>
139             gitStdin.flush();
140             var res = p.waitFor();
141             if (res != 0) {
142                 throw new IOException(&quot;&#39;git credential approve&#39; exited with value: &quot; + res);
143             }
144         } catch (InterruptedException e) {
145             throw new IOException(e);
146         }
147     }
148 
149     static void reject(GitCredentials credentials) throws IOException {
150         try {
151             var pb = new ProcessBuilder(&quot;git&quot;, &quot;credential&quot;, &quot;reject&quot;);
152             pb.redirectInput(ProcessBuilder.Redirect.PIPE);
153             pb.redirectOutput(ProcessBuilder.Redirect.INHERIT);
154             pb.redirectError(ProcessBuilder.Redirect.INHERIT);
155             var p = pb.start();
156 
157             var gitStdin = p.getOutputStream();
158             String input = &quot;host=&quot; + credentials.host() + &quot;\n&quot; +
<span class="line-added">159                            &quot;path=&quot; + credentials.path() + &quot;\n&quot; +</span>
160                            &quot;username=&quot; + credentials.username() + &quot;\n&quot; +
161                            &quot;password=&quot; + credentials.password() + &quot;\n&quot; +
162                            &quot;protocol=&quot; + credentials.protocol() + &quot;\n&quot;;
163             gitStdin.write((input + &quot;\n&quot;).getBytes(StandardCharsets.UTF_8));
164             gitStdin.flush();
165             var res = p.waitFor();
166             if (res != 0) {
167                 throw new IOException(&quot;&#39;git credential reject&#39; exited with value: &quot; + res);
168             }
169         } catch (InterruptedException e) {
170             throw new IOException(e);
171         }
172     }
173 }
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../index.html" target="_top">index</a> <a href="GitFork.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>