<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/notify/MailingListUpdater.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../../email/src/main/java/org/openjdk/skara/email/Email.java.udiff.html" target="_top">next &gt;</a></center>    <h2>bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -20,24 +20,25 @@</span>
   * or visit www.oracle.com if you need additional information or have any
   * questions.
   */
  package org.openjdk.skara.bots.notify;
  
<span class="udiff-line-modified-removed">- import org.openjdk.skara.email.EmailAddress;</span>
<span class="udiff-line-modified-added">+ import org.openjdk.skara.email.*;</span>
  import org.openjdk.skara.host.HostedRepository;
  import org.openjdk.skara.json.*;
<span class="udiff-line-added">+ import org.openjdk.skara.mailinglist.MailingListServerFactory;</span>
  import org.openjdk.skara.storage.StorageBuilder;
  import org.openjdk.skara.test.*;
  import org.openjdk.skara.vcs.Tag;
  
  import org.junit.jupiter.api.*;
  
  import java.io.IOException;
  import java.nio.charset.StandardCharsets;
  import java.nio.file.*;
  import java.time.Duration;
<span class="udiff-line-modified-removed">- import java.util.List;</span>
<span class="udiff-line-modified-added">+ import java.util.*;</span>
  import java.util.stream.Collectors;
  
  import static org.junit.jupiter.api.Assertions.*;
  
  class UpdaterTests {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -146,39 +147,44 @@</span>
          }
      }
  
      @Test
      void testMailingList(TestInfo testInfo) throws IOException {
<span class="udiff-line-modified-removed">-         try (var smtpServer = new SMTPServer();</span>
<span class="udiff-line-modified-added">+         try (var listServer = new TestMailmanServer();</span>
               var credentials = new HostCredentials(testInfo);
               var tempFolder = new TemporaryDirectory()) {
              var repo = credentials.getHostedRepository();
              var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
              var localRepo = CheckableRepository.init(repoFolder, repo.getRepositoryType());
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
              credentials.commitLock(localRepo);
              localRepo.pushAll(repo.getUrl());
  
<span class="udiff-line-added">+             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="udiff-line-added">+             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());</span>
<span class="udiff-line-added">+             var mailmanList = mailmanServer.getList(listAddress.address());</span>
              var tagStorage = createTagStorage(repo);
              var branchStorage = createBranchStorage(repo);
              var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
  
              var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
<span class="udiff-line-modified-removed">-             var recipient = EmailAddress.from(&quot;list&quot;, &quot;list@list.list&quot;);</span>
<span class="udiff-line-removed">-             var updater = new MailingListUpdater(smtpServer.address(), recipient, sender, false);</span>
<span class="udiff-line-modified-added">+             var updater = new MailingListUpdater(mailmanList, listAddress, sender, false, MailingListUpdater.Mode.ALL);</span>
              var notifyBot = new JNotifyBot(repo, storageFolder, List.of(&quot;master&quot;), tagStorage, branchStorage, List.of(updater));
  
              // No mail should be sent on the first run as there is no history
              TestBotRunner.runPeriodicItems(notifyBot);
<span class="udiff-line-modified-removed">-             assertThrows(RuntimeException.class, () -&gt; smtpServer.receive(Duration.ofMillis(1)));</span>
<span class="udiff-line-modified-added">+             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
  
              var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
              localRepo.push(editHash, repo.getUrl(), &quot;master&quot;);
              TestBotRunner.runPeriodicItems(notifyBot);
<span class="udiff-line-modified-removed">-             var email = smtpServer.receive(Duration.ofSeconds(10));</span>
<span class="udiff-line-modified-added">+             listServer.processIncoming();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="udiff-line-added">+             var email = conversations.get(0).first();</span>
              assertEquals(email.sender(), sender);
<span class="udiff-line-modified-removed">-             assertEquals(email.recipients(), List.of(recipient));</span>
<span class="udiff-line-modified-added">+             assertEquals(email.recipients(), List.of(listAddress));</span>
              assertTrue(email.subject().contains(&quot;: 23456789: More fixes&quot;));
              assertFalse(email.subject().contains(&quot;master&quot;));
              assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
              assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
              assertFalse(email.body().contains(&quot;Committer&quot;));
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -186,42 +192,47 @@</span>
          }
      }
  
      @Test
      void testMailingListMultiple(TestInfo testInfo) throws IOException {
<span class="udiff-line-modified-removed">-         try (var smtpServer = new SMTPServer();</span>
<span class="udiff-line-modified-added">+         try (var listServer = new TestMailmanServer();</span>
               var credentials = new HostCredentials(testInfo);
               var tempFolder = new TemporaryDirectory()) {
              var repo = credentials.getHostedRepository();
              var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
              var localRepo = CheckableRepository.init(repoFolder, repo.getRepositoryType());
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
              credentials.commitLock(localRepo);
              localRepo.pushAll(repo.getUrl());
  
<span class="udiff-line-added">+             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="udiff-line-added">+             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());</span>
<span class="udiff-line-added">+             var mailmanList = mailmanServer.getList(listAddress.address());</span>
              var tagStorage = createTagStorage(repo);
              var branchStorage = createBranchStorage(repo);
              var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
  
              var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
<span class="udiff-line-modified-removed">-             var recipient = EmailAddress.from(&quot;list&quot;, &quot;list@list.list&quot;);</span>
<span class="udiff-line-removed">-             var updater = new MailingListUpdater(smtpServer.address(), recipient, sender, false);</span>
<span class="udiff-line-modified-added">+             var updater = new MailingListUpdater(mailmanList, listAddress, sender, false, MailingListUpdater.Mode.ALL);</span>
              var notifyBot = new JNotifyBot(repo, storageFolder, List.of(&quot;master&quot;), tagStorage, branchStorage, List.of(updater));
  
              // No mail should be sent on the first run as there is no history
              TestBotRunner.runPeriodicItems(notifyBot);
<span class="udiff-line-modified-removed">-             assertThrows(RuntimeException.class, () -&gt; smtpServer.receive(Duration.ofMillis(1)));</span>
<span class="udiff-line-modified-added">+             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
  
              var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
              localRepo.push(editHash1, repo.getUrl(), &quot;master&quot;);
              var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;);
              localRepo.push(editHash2, repo.getUrl(), &quot;master&quot;);
  
              TestBotRunner.runPeriodicItems(notifyBot);
<span class="udiff-line-modified-removed">-             var email = smtpServer.receive(Duration.ofSeconds(10));</span>
<span class="udiff-line-modified-added">+             listServer.processIncoming();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="udiff-line-added">+             var email = conversations.get(0).first();</span>
              assertEquals(email.sender(), sender);
<span class="udiff-line-modified-removed">-             assertEquals(email.recipients(), List.of(recipient));</span>
<span class="udiff-line-modified-added">+             assertEquals(email.recipients(), List.of(listAddress));</span>
              assertTrue(email.subject().contains(&quot;: 2 new changesets&quot;));
              assertFalse(email.subject().contains(&quot;master&quot;));
              assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash1.abbreviate()));
              assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
              assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -230,84 +241,94 @@</span>
          }
      }
  
      @Test
      void testMailingListSponsored(TestInfo testInfo) throws IOException {
<span class="udiff-line-modified-removed">-         try (var smtpServer = new SMTPServer();</span>
<span class="udiff-line-modified-added">+         try (var listServer = new TestMailmanServer();</span>
               var credentials = new HostCredentials(testInfo);
               var tempFolder = new TemporaryDirectory()) {
              var repo = credentials.getHostedRepository();
              var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
              var localRepo = CheckableRepository.init(repoFolder, repo.getRepositoryType());
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
              credentials.commitLock(localRepo);
              localRepo.pushAll(repo.getUrl());
  
<span class="udiff-line-added">+             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="udiff-line-added">+             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());</span>
<span class="udiff-line-added">+             var mailmanList = mailmanServer.getList(listAddress.address());</span>
              var tagStorage = createTagStorage(repo);
              var branchStorage = createBranchStorage(repo);
              var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
  
              var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
<span class="udiff-line-modified-removed">-             var recipient = EmailAddress.from(&quot;list&quot;, &quot;list@list.list&quot;);</span>
<span class="udiff-line-removed">-             var updater = new MailingListUpdater(smtpServer.address(), recipient, sender, false);</span>
<span class="udiff-line-modified-added">+             var updater = new MailingListUpdater(mailmanList, listAddress, sender, false, MailingListUpdater.Mode.ALL);</span>
              var notifyBot = new JNotifyBot(repo, storageFolder, List.of(&quot;master&quot;), tagStorage, branchStorage, List.of(updater));
  
              // No mail should be sent on the first run as there is no history
              TestBotRunner.runPeriodicItems(notifyBot);
<span class="udiff-line-modified-removed">-             assertThrows(RuntimeException.class, () -&gt; smtpServer.receive(Duration.ofMillis(1)));</span>
<span class="udiff-line-modified-added">+             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
  
              var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
                                                                 &quot;author&quot;, &quot;author@test.test&quot;,
                                                                 &quot;committer&quot;, &quot;committer@test.test&quot;);
              localRepo.push(editHash, repo.getUrl(), &quot;master&quot;);
              TestBotRunner.runPeriodicItems(notifyBot);
<span class="udiff-line-modified-removed">-             var email = smtpServer.receive(Duration.ofSeconds(10));</span>
<span class="udiff-line-modified-added">+             listServer.processIncoming();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="udiff-line-added">+             var email = conversations.get(0).first();</span>
              assertEquals(email.sender(), sender);
<span class="udiff-line-modified-removed">-             assertEquals(email.recipients(), List.of(recipient));</span>
<span class="udiff-line-modified-added">+             assertEquals(email.recipients(), List.of(listAddress));</span>
              assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
              assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
              assertTrue(email.body().contains(&quot;Author:    author &lt;author@test.test&gt;&quot;));
              assertTrue(email.body().contains(&quot;Committer: committer &lt;committer@test.test&gt;&quot;));
              assertFalse(email.body().contains(masterHash.abbreviate()));
          }
      }
  
      @Test
      void testMailingListMultipleBranches(TestInfo testInfo) throws IOException {
<span class="udiff-line-modified-removed">-         try (var smtpServer = new SMTPServer();</span>
<span class="udiff-line-modified-added">+         try (var listServer = new TestMailmanServer();</span>
               var credentials = new HostCredentials(testInfo);
               var tempFolder = new TemporaryDirectory()) {
              var repo = credentials.getHostedRepository();
              var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
              var localRepo = CheckableRepository.init(repoFolder, repo.getRepositoryType());
              var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
              credentials.commitLock(localRepo);
              var branch = localRepo.branch(masterHash, &quot;another&quot;);
              localRepo.pushAll(repo.getUrl());
  
<span class="udiff-line-added">+             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="udiff-line-added">+             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());</span>
<span class="udiff-line-added">+             var mailmanList = mailmanServer.getList(listAddress.address());</span>
              var tagStorage = createTagStorage(repo);
              var branchStorage = createBranchStorage(repo);
              var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
  
              var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
<span class="udiff-line-modified-removed">-             var recipient = EmailAddress.from(&quot;list&quot;, &quot;list@list.list&quot;);</span>
<span class="udiff-line-removed">-             var updater = new MailingListUpdater(smtpServer.address(), recipient, sender, true);</span>
<span class="udiff-line-modified-added">+             var updater = new MailingListUpdater(mailmanList, listAddress, sender, true, MailingListUpdater.Mode.ALL);</span>
              var notifyBot = new JNotifyBot(repo, storageFolder, List.of(&quot;master&quot;, &quot;another&quot;), tagStorage, branchStorage, List.of(updater));
  
              // No mail should be sent on the first run as there is no history
              TestBotRunner.runPeriodicItems(notifyBot);
<span class="udiff-line-modified-removed">-             assertThrows(RuntimeException.class, () -&gt; smtpServer.receive(Duration.ofMillis(1)));</span>
<span class="udiff-line-modified-added">+             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
  
              var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
              localRepo.push(editHash1, repo.getUrl(), &quot;master&quot;);
              var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;);
              localRepo.push(editHash2, repo.getUrl(), &quot;master&quot;);
  
              TestBotRunner.runPeriodicItems(notifyBot);
<span class="udiff-line-modified-removed">-             var email = smtpServer.receive(Duration.ofSeconds(10));</span>
<span class="udiff-line-modified-added">+             listServer.processIncoming();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="udiff-line-added">+             var email = conversations.get(0).first();</span>
              assertEquals(email.sender(), sender);
<span class="udiff-line-modified-removed">-             assertEquals(email.recipients(), List.of(recipient));</span>
<span class="udiff-line-modified-added">+             assertEquals(email.recipients(), List.of(listAddress));</span>
              assertFalse(email.subject().contains(&quot;another&quot;));
              assertTrue(email.subject().contains(&quot;: master: 2 new changesets&quot;));
              assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash1.abbreviate()));
              assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
              assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -318,17 +339,175 @@</span>
              localRepo.checkout(branch, true);
              var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another branch&quot;, &quot;456789AB: Yet more fixes&quot;);
              localRepo.push(editHash3, repo.getUrl(), &quot;another&quot;);
  
              TestBotRunner.runPeriodicItems(notifyBot);
<span class="udiff-line-modified-removed">-             email = smtpServer.receive(Duration.ofSeconds(10));</span>
<span class="udiff-line-modified-added">+             listServer.processIncoming();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="udiff-line-added">+             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));</span>
<span class="udiff-line-added">+             email = conversations.get(0).first();</span>
              assertEquals(email.sender(), sender);
<span class="udiff-line-modified-removed">-             assertEquals(email.recipients(), List.of(recipient));</span>
<span class="udiff-line-modified-added">+             assertEquals(email.recipients(), List.of(listAddress));</span>
              assertTrue(email.subject().contains(&quot;: another: 456789AB: Yet more fixes&quot;));
              assertFalse(email.subject().contains(&quot;master&quot;));
              assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash3.abbreviate()));
              assertTrue(email.body().contains(&quot;456789AB: Yet more fixes&quot;));
              assertFalse(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Test</span>
<span class="udiff-line-added">+     void testMailingListPROnly(TestInfo testInfo) throws IOException {</span>
<span class="udiff-line-added">+         try (var listServer = new TestMailmanServer();</span>
<span class="udiff-line-added">+              var credentials = new HostCredentials(testInfo);</span>
<span class="udiff-line-added">+              var tempFolder = new TemporaryDirectory()) {</span>
<span class="udiff-line-added">+             var repo = credentials.getHostedRepository();</span>
<span class="udiff-line-added">+             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="udiff-line-added">+             var localRepo = CheckableRepository.init(repoFolder, repo.getRepositoryType());</span>
<span class="udiff-line-added">+             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="udiff-line-added">+             credentials.commitLock(localRepo);</span>
<span class="udiff-line-added">+             localRepo.pushAll(repo.getUrl());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="udiff-line-added">+             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());</span>
<span class="udiff-line-added">+             var mailmanList = mailmanServer.getList(listAddress.address());</span>
<span class="udiff-line-added">+             var tagStorage = createTagStorage(repo);</span>
<span class="udiff-line-added">+             var branchStorage = createBranchStorage(repo);</span>
<span class="udiff-line-added">+             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);</span>
<span class="udiff-line-added">+             var updater = new MailingListUpdater(mailmanList, listAddress, sender, false, MailingListUpdater.Mode.PR_ONLY);</span>
<span class="udiff-line-added">+             var notifyBot = new JNotifyBot(repo, storageFolder, List.of(&quot;master&quot;), tagStorage, branchStorage, List.of(updater));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // No mail should be sent on the first run as there is no history</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-added">+             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);</span>
<span class="udiff-line-added">+             localRepo.push(editHash, repo.getUrl(), &quot;edit&quot;);</span>
<span class="udiff-line-added">+             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Create a potentially conflicting one</span>
<span class="udiff-line-added">+             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);</span>
<span class="udiff-line-added">+             localRepo.push(otherHash, repo.getUrl(), &quot;other&quot;);</span>
<span class="udiff-line-added">+             var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // PR hasn&#39;t been integrated yet, so there should be no mail</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-added">+             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Simulate an RFR email</span>
<span class="udiff-line-added">+             var rfr = Email.create(sender, &quot;RFR: My PR&quot;, &quot;PR:\n&quot; + pr.getWebUrl().toString())</span>
<span class="udiff-line-added">+                     .recipient(listAddress)</span>
<span class="udiff-line-added">+                     .build();</span>
<span class="udiff-line-added">+             mailmanList.post(rfr);</span>
<span class="udiff-line-added">+             listServer.processIncoming();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // And an integration</span>
<span class="udiff-line-added">+             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);</span>
<span class="udiff-line-added">+             localRepo.push(editHash, repo.getUrl(), &quot;master&quot;);</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-added">+             listServer.processIncoming();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="udiff-line-added">+             assertEquals(1, conversations.size());</span>
<span class="udiff-line-added">+             var first = conversations.get(0).first();</span>
<span class="udiff-line-added">+             var email = conversations.get(0).replies(first).get(0);</span>
<span class="udiff-line-added">+             assertEquals(email.sender(), sender);</span>
<span class="udiff-line-added">+             assertEquals(email.recipients(), List.of(listAddress));</span>
<span class="udiff-line-added">+             assertEquals(&quot;Re: [Integrated] RFR: My PR&quot;, email.subject());</span>
<span class="udiff-line-added">+             assertFalse(email.subject().contains(&quot;master&quot;));</span>
<span class="udiff-line-added">+             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));</span>
<span class="udiff-line-added">+             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));</span>
<span class="udiff-line-added">+             assertFalse(email.body().contains(&quot;Committer&quot;));</span>
<span class="udiff-line-added">+             assertFalse(email.body().contains(masterHash.abbreviate()));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Now push the other one without a matching PR - PR_ONLY should make us throw an exception</span>
<span class="udiff-line-added">+             localRepo.push(otherHash, repo.getUrl(), &quot;master&quot;);</span>
<span class="udiff-line-added">+             assertThrows(RuntimeException.class, () -&gt; TestBotRunner.runPeriodicItems(notifyBot));</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     @Test</span>
<span class="udiff-line-added">+     void testMailingListPR(TestInfo testInfo) throws IOException {</span>
<span class="udiff-line-added">+         try (var listServer = new TestMailmanServer();</span>
<span class="udiff-line-added">+              var credentials = new HostCredentials(testInfo);</span>
<span class="udiff-line-added">+              var tempFolder = new TemporaryDirectory()) {</span>
<span class="udiff-line-added">+             var repo = credentials.getHostedRepository();</span>
<span class="udiff-line-added">+             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="udiff-line-added">+             var localRepo = CheckableRepository.init(repoFolder, repo.getRepositoryType());</span>
<span class="udiff-line-added">+             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();</span>
<span class="udiff-line-added">+             credentials.commitLock(localRepo);</span>
<span class="udiff-line-added">+             localRepo.pushAll(repo.getUrl());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));</span>
<span class="udiff-line-added">+             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());</span>
<span class="udiff-line-added">+             var mailmanList = mailmanServer.getList(listAddress.address());</span>
<span class="udiff-line-added">+             var tagStorage = createTagStorage(repo);</span>
<span class="udiff-line-added">+             var branchStorage = createBranchStorage(repo);</span>
<span class="udiff-line-added">+             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);</span>
<span class="udiff-line-added">+             var updater = new MailingListUpdater(mailmanList, listAddress, sender, false, MailingListUpdater.Mode.PR);</span>
<span class="udiff-line-added">+             var notifyBot = new JNotifyBot(repo, storageFolder, List.of(&quot;master&quot;), tagStorage, branchStorage, List.of(updater));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // No mail should be sent on the first run as there is no history</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-added">+             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);</span>
<span class="udiff-line-added">+             localRepo.push(editHash, repo.getUrl(), &quot;edit&quot;);</span>
<span class="udiff-line-added">+             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Create a potentially conflicting one</span>
<span class="udiff-line-added">+             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);</span>
<span class="udiff-line-added">+             localRepo.push(otherHash, repo.getUrl(), &quot;other&quot;);</span>
<span class="udiff-line-added">+             var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // PR hasn&#39;t been integrated yet, so there should be no mail</span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-added">+             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Simulate an RFR email</span>
<span class="udiff-line-added">+             var rfr = Email.create(sender, &quot;RFR: My PR&quot;, &quot;PR:\n&quot; + pr.getWebUrl().toString())</span>
<span class="udiff-line-added">+                            .recipient(listAddress)</span>
<span class="udiff-line-added">+                            .build();</span>
<span class="udiff-line-added">+             mailmanList.post(rfr);</span>
<span class="udiff-line-added">+             listServer.processIncoming();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // And an integration</span>
<span class="udiff-line-added">+             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);</span>
<span class="udiff-line-added">+             localRepo.push(editHash, repo.getUrl(), &quot;master&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             // Push the other one without a matching PR</span>
<span class="udiff-line-added">+             localRepo.push(otherHash, repo.getUrl(), &quot;master&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="udiff-line-added">+             listServer.processIncoming();</span>
<span class="udiff-line-added">+             listServer.processIncoming();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var conversations = mailmanList.conversations(Duration.ofDays(1));</span>
<span class="udiff-line-added">+             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));</span>
<span class="udiff-line-added">+             assertEquals(2, conversations.size());</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var prConversation = conversations.get(0);</span>
<span class="udiff-line-added">+             var pushConverstaion = conversations.get(1);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var prEmail = prConversation.replies(prConversation.first()).get(0);</span>
<span class="udiff-line-added">+             assertEquals(prEmail.sender(), sender);</span>
<span class="udiff-line-added">+             assertEquals(prEmail.recipients(), List.of(listAddress));</span>
<span class="udiff-line-added">+             assertEquals(&quot;Re: [Integrated] RFR: My PR&quot;, prEmail.subject());</span>
<span class="udiff-line-added">+             assertFalse(prEmail.subject().contains(&quot;master&quot;));</span>
<span class="udiff-line-added">+             assertTrue(prEmail.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));</span>
<span class="udiff-line-added">+             assertTrue(prEmail.body().contains(&quot;23456789: More fixes&quot;));</span>
<span class="udiff-line-added">+             assertFalse(prEmail.body().contains(&quot;Committer&quot;));</span>
<span class="udiff-line-added">+             assertFalse(prEmail.body().contains(masterHash.abbreviate()));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             var pushEmail = pushConverstaion.first();</span>
<span class="udiff-line-added">+             assertEquals(pushEmail.sender(), sender);</span>
<span class="udiff-line-added">+             assertEquals(pushEmail.recipients(), List.of(listAddress));</span>
<span class="udiff-line-added">+             assertTrue(pushEmail.subject().contains(&quot;23456789: More fixes&quot;));</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
  }
</pre>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/notify/MailingListUpdater.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../../email/src/main/java/org/openjdk/skara/email/Email.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>