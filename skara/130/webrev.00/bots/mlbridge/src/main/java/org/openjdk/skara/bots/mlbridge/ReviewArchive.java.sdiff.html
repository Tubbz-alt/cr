<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/ReviewArchive.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../notify/build.gradle.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/ReviewArchive.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
188                          .header(&quot;PR-Base-Hash&quot;, prInstance.baseHash().hex())
189                          .build();
190         generated.add(email);
191         generatedIds.put(getStableMessageId(id), email);
192     }
193 
194     private String latestHeadSubject() {
195         try {
196             var latestCommit = prInstance.localRepo().lookup(prInstance.headHash()).orElseThrow(RuntimeException::new);
197             var firstLine = latestCommit.message().size() &gt; 0 ? latestCommit.message().get(0) : prInstance.pr().getTitle();
198             return String.format(&quot;Re: %02d: %s&quot;, revisionCount(), firstLine);
199         } catch (IOException e) {
200             throw new UncheckedIOException(e);
201         }
202     }
203 
204     void addFull(URI webrev) {
205         var body = ArchiveMessages.composeRebaseComment(prInstance, webrev);
206         var id = getMessageId(prInstance.headHash());
207         var parent = topEmail();
<span class="line-modified">208         var email = Email.create(latestHeadSubject(), body)</span>
209                          .sender(sender)
210                          .author(getAuthorAddress(prInstance.pr().getAuthor()))
211                          .recipient(parent.author())
212                          .id(id)
<span class="line-removed">213                          .header(&quot;In-Reply-To&quot;, parent.id().toString())</span>
<span class="line-removed">214                          .header(&quot;References&quot;, parent.id().toString())</span>
215                          .header(&quot;PR-Head-Hash&quot;, prInstance.headHash().hex())
216                          .header(&quot;PR-Base-Hash&quot;, prInstance.baseHash().hex())
217                          .header(&quot;PR-Sequence&quot;, Integer.toString(existing.size() + generated.size()))
218                          .build();
219         generated.add(email);
220         generatedIds.put(getStableMessageId(id), email);
221     }
222 
223     void addIncremental(URI fullWebrev, URI incrementalWebrev) {
224         var body = ArchiveMessages.composeIncrementalComment(latestHead(), prInstance, fullWebrev, incrementalWebrev);
225         var id = getMessageId(prInstance.headHash());
226         var parent = topEmail();
<span class="line-modified">227         var email = Email.create(latestHeadSubject(), body)</span>
228                          .sender(sender)
229                          .author(getAuthorAddress(prInstance.pr().getAuthor()))
230                          .recipient(parent.author())
231                          .id(id)
<span class="line-removed">232                          .header(&quot;In-Reply-To&quot;, parent.id().toString())</span>
<span class="line-removed">233                          .header(&quot;References&quot;, parent.id().toString())</span>
234                          .header(&quot;PR-Head-Hash&quot;, prInstance.headHash().hex())
235                          .header(&quot;PR-Base-Hash&quot;, prInstance.baseHash().hex())
236                          .header(&quot;PR-Sequence&quot;, Integer.toString(existing.size() + generated.size()))
237                          .build();
238         generated.add(email);
239         generatedIds.put(getStableMessageId(id), email);
240     }
241 
242     private Optional&lt;Email&gt; findCollapsable(Email parent, HostUserDetails author) {
243         var parentId = getStableMessageId(parent.id());
244 
245         // Is it a self-reply?
246         if (parent.author().equals(getAuthorAddress(author)) &amp;&amp; generatedIds.containsKey(parentId)) {
247             return Optional.of(parent);
248         }
249 
250         // Have we already replied to the same parent?
251         for (var candidate : generated) {
252             if (!candidate.hasHeader(&quot;In-Reply-To&quot;)) {
253                 continue;
254             }
255             var inReplyTo = EmailAddress.parse(candidate.headerValue(&quot;In-Reply-To&quot;));
256             var candidateParentId = getStableMessageId(inReplyTo);
257             if (candidateParentId.equals(parentId) &amp;&amp; candidate.author().equals(getAuthorAddress(author))) {
258                 return Optional.of(candidate);
259             }
260         }
261 
262         return Optional.empty();
263     }
264 
265     private void addReplyCommon(Email parent, HostUserDetails author, String subject, String body, EmailAddress id) {
<span class="line-removed">266         var references = parent.id().toString();</span>
<span class="line-removed">267         if (parent.hasHeader(&quot;References&quot;)) {</span>
<span class="line-removed">268             references = parent.headerValue(&quot;References&quot;) + &quot; &quot; + references;</span>
<span class="line-removed">269         }</span>
270         if (!subject.startsWith(&quot;Re: &quot;)) {
271             subject = &quot;Re: &quot; + subject;
272         }
273 
274         // Collapse self-replies and replies-to-same that have been created in this run
275         var collapsable = findCollapsable(parent, author);
276         if (collapsable.isPresent()) {
277             // Drop the parent
278             var parentEmail = collapsable.get();
279             generated.remove(parentEmail);
280             generatedIds.remove(getStableMessageId(parentEmail.id()));
281 
282             var collapsed = parentEmail.hasHeader(&quot;PR-Collapsed-IDs&quot;) ? parentEmail.headerValue(&quot;PR-Collapsed-IDs&quot;) : &quot;&quot;;
283             collapsed += getStableMessageId(parentEmail.id());
284 
285             var reply = ArchiveMessages.composeCombinedReply(parentEmail, body, prInstance);
286             var email = Email.from(parentEmail)
287                              .body(reply)
288                              .subject(subject)
289                              .id(id)
290                              .header(&quot;PR-Collapsed-IDs&quot;, collapsed)
291                              .header(&quot;PR-Sequence&quot;, Integer.toString(existing.size() + generated.size()))
292                              .build();
293             generated.add(email);
294             generatedIds.put(getStableMessageId(id), email);
295         } else {
296             var reply = ArchiveMessages.composeReply(parent, body, prInstance);
<span class="line-modified">297             var email = Email.create(subject, reply)</span>
298                              .sender(sender)
299                              .author(getAuthorAddress(author))
300                              .recipient(parent.author())
301                              .id(id)
<span class="line-removed">302                              .header(&quot;In-Reply-To&quot;, parent.id().toString())</span>
<span class="line-removed">303                              .header(&quot;References&quot;, references)</span>
304                              .header(&quot;PR-Sequence&quot;, Integer.toString(existing.size() + generated.size()))
305                              .build();
306             generated.add(email);
307             generatedIds.put(getStableMessageId(id), email);
308         }
309     }
310 
311     void addComment(Comment comment) {
312         var id = getMessageId(comment);
313         if (existingIds.containsKey(getStableMessageId(id))) {
314             return;
315         }
316 
317         var parent = latestGeneralComment();
318         addReplyCommon(parent, comment.author(), &quot;Re: RFR: &quot; + prInstance.pr().getTitle(), comment.body(), id);
319     }
320 
321     private String projectRole(Contributor contributor) {
322         var version = censusInstance.configuration().census().version();
323         if (censusInstance.project().isLead(contributor.username(), version)) {
</pre>
</td>
<td>
<hr />
<pre>
188                          .header(&quot;PR-Base-Hash&quot;, prInstance.baseHash().hex())
189                          .build();
190         generated.add(email);
191         generatedIds.put(getStableMessageId(id), email);
192     }
193 
194     private String latestHeadSubject() {
195         try {
196             var latestCommit = prInstance.localRepo().lookup(prInstance.headHash()).orElseThrow(RuntimeException::new);
197             var firstLine = latestCommit.message().size() &gt; 0 ? latestCommit.message().get(0) : prInstance.pr().getTitle();
198             return String.format(&quot;Re: %02d: %s&quot;, revisionCount(), firstLine);
199         } catch (IOException e) {
200             throw new UncheckedIOException(e);
201         }
202     }
203 
204     void addFull(URI webrev) {
205         var body = ArchiveMessages.composeRebaseComment(prInstance, webrev);
206         var id = getMessageId(prInstance.headHash());
207         var parent = topEmail();
<span class="line-modified">208         var email = Email.reply(parent, latestHeadSubject(), body)</span>
209                          .sender(sender)
210                          .author(getAuthorAddress(prInstance.pr().getAuthor()))
211                          .recipient(parent.author())
212                          .id(id)


213                          .header(&quot;PR-Head-Hash&quot;, prInstance.headHash().hex())
214                          .header(&quot;PR-Base-Hash&quot;, prInstance.baseHash().hex())
215                          .header(&quot;PR-Sequence&quot;, Integer.toString(existing.size() + generated.size()))
216                          .build();
217         generated.add(email);
218         generatedIds.put(getStableMessageId(id), email);
219     }
220 
221     void addIncremental(URI fullWebrev, URI incrementalWebrev) {
222         var body = ArchiveMessages.composeIncrementalComment(latestHead(), prInstance, fullWebrev, incrementalWebrev);
223         var id = getMessageId(prInstance.headHash());
224         var parent = topEmail();
<span class="line-modified">225         var email = Email.reply(parent, latestHeadSubject(), body)</span>
226                          .sender(sender)
227                          .author(getAuthorAddress(prInstance.pr().getAuthor()))
228                          .recipient(parent.author())
229                          .id(id)


230                          .header(&quot;PR-Head-Hash&quot;, prInstance.headHash().hex())
231                          .header(&quot;PR-Base-Hash&quot;, prInstance.baseHash().hex())
232                          .header(&quot;PR-Sequence&quot;, Integer.toString(existing.size() + generated.size()))
233                          .build();
234         generated.add(email);
235         generatedIds.put(getStableMessageId(id), email);
236     }
237 
238     private Optional&lt;Email&gt; findCollapsable(Email parent, HostUserDetails author) {
239         var parentId = getStableMessageId(parent.id());
240 
241         // Is it a self-reply?
242         if (parent.author().equals(getAuthorAddress(author)) &amp;&amp; generatedIds.containsKey(parentId)) {
243             return Optional.of(parent);
244         }
245 
246         // Have we already replied to the same parent?
247         for (var candidate : generated) {
248             if (!candidate.hasHeader(&quot;In-Reply-To&quot;)) {
249                 continue;
250             }
251             var inReplyTo = EmailAddress.parse(candidate.headerValue(&quot;In-Reply-To&quot;));
252             var candidateParentId = getStableMessageId(inReplyTo);
253             if (candidateParentId.equals(parentId) &amp;&amp; candidate.author().equals(getAuthorAddress(author))) {
254                 return Optional.of(candidate);
255             }
256         }
257 
258         return Optional.empty();
259     }
260 
261     private void addReplyCommon(Email parent, HostUserDetails author, String subject, String body, EmailAddress id) {




262         if (!subject.startsWith(&quot;Re: &quot;)) {
263             subject = &quot;Re: &quot; + subject;
264         }
265 
266         // Collapse self-replies and replies-to-same that have been created in this run
267         var collapsable = findCollapsable(parent, author);
268         if (collapsable.isPresent()) {
269             // Drop the parent
270             var parentEmail = collapsable.get();
271             generated.remove(parentEmail);
272             generatedIds.remove(getStableMessageId(parentEmail.id()));
273 
274             var collapsed = parentEmail.hasHeader(&quot;PR-Collapsed-IDs&quot;) ? parentEmail.headerValue(&quot;PR-Collapsed-IDs&quot;) : &quot;&quot;;
275             collapsed += getStableMessageId(parentEmail.id());
276 
277             var reply = ArchiveMessages.composeCombinedReply(parentEmail, body, prInstance);
278             var email = Email.from(parentEmail)
279                              .body(reply)
280                              .subject(subject)
281                              .id(id)
282                              .header(&quot;PR-Collapsed-IDs&quot;, collapsed)
283                              .header(&quot;PR-Sequence&quot;, Integer.toString(existing.size() + generated.size()))
284                              .build();
285             generated.add(email);
286             generatedIds.put(getStableMessageId(id), email);
287         } else {
288             var reply = ArchiveMessages.composeReply(parent, body, prInstance);
<span class="line-modified">289             var email = Email.reply(parent, subject, reply)</span>
290                              .sender(sender)
291                              .author(getAuthorAddress(author))
292                              .recipient(parent.author())
293                              .id(id)


294                              .header(&quot;PR-Sequence&quot;, Integer.toString(existing.size() + generated.size()))
295                              .build();
296             generated.add(email);
297             generatedIds.put(getStableMessageId(id), email);
298         }
299     }
300 
301     void addComment(Comment comment) {
302         var id = getMessageId(comment);
303         if (existingIds.containsKey(getStableMessageId(id))) {
304             return;
305         }
306 
307         var parent = latestGeneralComment();
308         addReplyCommon(parent, comment.author(), &quot;Re: RFR: &quot; + prInstance.pr().getTitle(), comment.body(), id);
309     }
310 
311     private String projectRole(Contributor contributor) {
312         var version = censusInstance.configuration().census().version();
313         if (censusInstance.project().isLead(contributor.username(), version)) {
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../notify/build.gradle.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>