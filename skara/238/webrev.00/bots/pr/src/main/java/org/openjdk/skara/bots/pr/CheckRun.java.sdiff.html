<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/pr/src/main/java/org/openjdk/skara/bots/pr/CheckRun.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/pr/src/main/java/org/openjdk/skara/bots/pr/CheckRun.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
154                 } else {
155                     ret.add(&quot;Could not determine the source for this merge. A Merge PR title must be specified on the format: &quot; +
156                             &quot;Merge `project`:`branch` to allow verification of the merge contents.&quot;);
157                 }
158             }
159         }
160 
161         for (var blocker : blockingLabels.entrySet()) {
162             if (labels.contains(blocker.getKey())) {
163                 ret.add(blocker.getValue());
164             }
165         }
166 
167         return ret;
168     }
169 
170     private void updateCheckBuilder(CheckBuilder checkBuilder, PullRequestCheckIssueVisitor visitor, List&lt;String&gt; additionalErrors) {
171         if (visitor.isReadyForReview() &amp;&amp; additionalErrors.isEmpty()) {
172             checkBuilder.complete(true);
173         } else {

174             var summary = Stream.concat(visitor.getMessages().stream(), additionalErrors.stream())
175                                 .sorted()
176                                 .map(m -&gt; &quot;- &quot; + m)
177                                 .collect(Collectors.joining(&quot;\n&quot;));
178             checkBuilder.summary(summary);
179             for (var annotation : visitor.getAnnotations()) {
180                 checkBuilder.annotation(annotation);
181             }
182             checkBuilder.complete(false);
183         }
184     }
185 
186     private void updateReadyForReview(PullRequestCheckIssueVisitor visitor, List&lt;String&gt; additionalErrors) {
187         // If there are no issues at all, the PR is already reviewed
188         if (visitor.getMessages().isEmpty() &amp;&amp; additionalErrors.isEmpty()) {
189             pr.removeLabel(&quot;rfr&quot;);
190             return;
191         }
192 
193         // Additional errors are not allowed
</pre>
<hr />
<pre>
431         message.append(mergeReadyMarker);
432         return message.toString();
433     }
434 
435     private void updateMergeReadyComment(boolean isReady, String commitMessage, List&lt;Comment&gt; comments, List&lt;Review&gt; reviews, boolean rebasePossible) {
436         var existing = findComment(comments, mergeReadyMarker);
437         if (isReady) {
438             var message = getMergeReadyComment(commitMessage, reviews, rebasePossible);
439             if (existing.isEmpty()) {
440                 pr.addComment(message);
441             } else {
442                 pr.updateComment(existing.get().id(), message);
443             }
444         } else {
445             existing.ifPresent(comment -&gt; pr.updateComment(comment.id(), getMergeNoLongerReadyComment()));
446         }
447     }
448 
449     private void checkStatus() {
450         var checkBuilder = CheckBuilder.create(&quot;jcheck&quot;, pr.headHash());
<span class="line-removed">451         checkBuilder.title(&quot;Required&quot;);</span>
452         var censusDomain = censusInstance.configuration().census().domain();
453         Exception checkException = null;
454 
455         try {
456             // Post check in-progress
457             log.info(&quot;Starting to run jcheck on PR head&quot;);
458             pr.createCheck(checkBuilder.build());
459             var localHash = prInstance.commit(censusInstance.namespace(), censusDomain, null);
460 
461             // Try to rebase
462             boolean rebasePossible = true;
463             var ignored = new PrintWriter(new StringWriter());
464             var rebasedHash = prInstance.rebase(localHash, ignored);
465             if (rebasedHash.isEmpty()) {
466                 rebasePossible = false;
467             } else {
468                 localHash = rebasedHash.get();
469             }
470 
471             // Determine current status
</pre>
</td>
<td>
<hr />
<pre>
154                 } else {
155                     ret.add(&quot;Could not determine the source for this merge. A Merge PR title must be specified on the format: &quot; +
156                             &quot;Merge `project`:`branch` to allow verification of the merge contents.&quot;);
157                 }
158             }
159         }
160 
161         for (var blocker : blockingLabels.entrySet()) {
162             if (labels.contains(blocker.getKey())) {
163                 ret.add(blocker.getValue());
164             }
165         }
166 
167         return ret;
168     }
169 
170     private void updateCheckBuilder(CheckBuilder checkBuilder, PullRequestCheckIssueVisitor visitor, List&lt;String&gt; additionalErrors) {
171         if (visitor.isReadyForReview() &amp;&amp; additionalErrors.isEmpty()) {
172             checkBuilder.complete(true);
173         } else {
<span class="line-added">174             checkBuilder.title(&quot;Required&quot;);</span>
175             var summary = Stream.concat(visitor.getMessages().stream(), additionalErrors.stream())
176                                 .sorted()
177                                 .map(m -&gt; &quot;- &quot; + m)
178                                 .collect(Collectors.joining(&quot;\n&quot;));
179             checkBuilder.summary(summary);
180             for (var annotation : visitor.getAnnotations()) {
181                 checkBuilder.annotation(annotation);
182             }
183             checkBuilder.complete(false);
184         }
185     }
186 
187     private void updateReadyForReview(PullRequestCheckIssueVisitor visitor, List&lt;String&gt; additionalErrors) {
188         // If there are no issues at all, the PR is already reviewed
189         if (visitor.getMessages().isEmpty() &amp;&amp; additionalErrors.isEmpty()) {
190             pr.removeLabel(&quot;rfr&quot;);
191             return;
192         }
193 
194         // Additional errors are not allowed
</pre>
<hr />
<pre>
432         message.append(mergeReadyMarker);
433         return message.toString();
434     }
435 
436     private void updateMergeReadyComment(boolean isReady, String commitMessage, List&lt;Comment&gt; comments, List&lt;Review&gt; reviews, boolean rebasePossible) {
437         var existing = findComment(comments, mergeReadyMarker);
438         if (isReady) {
439             var message = getMergeReadyComment(commitMessage, reviews, rebasePossible);
440             if (existing.isEmpty()) {
441                 pr.addComment(message);
442             } else {
443                 pr.updateComment(existing.get().id(), message);
444             }
445         } else {
446             existing.ifPresent(comment -&gt; pr.updateComment(comment.id(), getMergeNoLongerReadyComment()));
447         }
448     }
449 
450     private void checkStatus() {
451         var checkBuilder = CheckBuilder.create(&quot;jcheck&quot;, pr.headHash());

452         var censusDomain = censusInstance.configuration().census().domain();
453         Exception checkException = null;
454 
455         try {
456             // Post check in-progress
457             log.info(&quot;Starting to run jcheck on PR head&quot;);
458             pr.createCheck(checkBuilder.build());
459             var localHash = prInstance.commit(censusInstance.namespace(), censusDomain, null);
460 
461             // Try to rebase
462             boolean rebasePossible = true;
463             var ignored = new PrintWriter(new StringWriter());
464             var rebasedHash = prInstance.rebase(localHash, ignored);
465             if (rebasedHash.isEmpty()) {
466                 rebasePossible = false;
467             } else {
468                 localHash = rebasedHash.get();
469             }
470 
471             // Determine current status
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>