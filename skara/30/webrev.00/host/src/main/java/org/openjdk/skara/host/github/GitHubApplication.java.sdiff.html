<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff host/src/main/java/org/openjdk/skara/host/github/GitHubApplication.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../json/src/main/java/org/openjdk/skara/json/JSONParser.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>host/src/main/java/org/openjdk/skara/host/github/GitHubApplication.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 80             cached = generator.generate();
 81             generatedAt = Instant.now();
 82             return cached;
 83         } catch (GeneratorError generatorError) {
 84             // FIXME? The operation could be retried here
 85             throw new GitHubApplicationError(&quot;Failed to generate authentication token (&quot; + generatorError.getMessage() + &quot;)&quot;);
 86         }
 87     }
 88 }
 89 
 90 public class GitHubApplication {
 91     private final String issue;
 92     private final String id;
 93 
 94     private final URI apiBase;
 95     private final PrivateKey key;
 96     private final Token jwt;
 97     private final Token installationToken;
 98 
 99     private final Logger log;
<span class="line-removed">100     private final JSONParser jsonParser;</span>
101 
102     static class GitHubConfigurationError extends RuntimeException {
103         public GitHubConfigurationError(String message) {
104             super(message);
105         }
106     }
107 
108     public GitHubApplication(String keyFile, String issue, String id) {
109 
110         log = Logger.getLogger(&quot;org.openjdk.host.github&quot;);
<span class="line-removed">111         jsonParser = new JSONParser();</span>
112 
113         apiBase = URIBuilder.base(&quot;https://api.github.com/&quot;).build();
114         this.issue = issue;
115         this.id = id;
116 
117         key = loadPkcs8PemFromFile(keyFile);
118         jwt = new Token(this::generateJsonWebToken, Duration.ofMinutes(5));
119         installationToken = new Token(this::generateInstallationToken, Duration.ofMinutes(30));
120     }
121 
122     private PrivateKey loadPkcs8PemFromFile(String keyFile) {
123         try {
124             var pem = new String(Files.readAllBytes(Paths.get(keyFile)));
125             var pemPattern = Pattern.compile(&quot;^-*BEGIN PRIVATE KEY-*$(.*)^-*END PRIVATE KEY-*&quot;,
126                     Pattern.DOTALL | Pattern.MULTILINE);
127             var keyString = pemPattern.matcher(pem).replaceFirst(&quot;$1&quot;);
128             //keyString = keyString.replace(&quot;\n&quot;, &quot;&quot;);
129             var rawKey = Base64.getMimeDecoder().decode(keyString);
130             var factory = KeyFactory.getInstance(&quot;RSA&quot;);
131             return factory.generatePrivate(new PKCS8EncodedKeySpec(rawKey));
</pre>
<hr />
<pre>
177     }
178 
179     private String generateInstallationToken() throws Token.GeneratorError {
180         var tokens = URIBuilder.base(apiBase).setPath(&quot;/installations/&quot; + id + &quot;/access_tokens&quot;).build();
181         var client = HttpClient.newBuilder()
182                                .connectTimeout(Duration.ofSeconds(10))
183                                .build();
184 
185         try {
186             var response = client.send(
187                     HttpRequest.newBuilder()
188                                .uri(tokens)
189                                .timeout(Duration.ofSeconds(30))
190                                .header(&quot;Authorization&quot;, &quot;Bearer &quot; + jwt)
191                                .header(&quot;Accept&quot;, &quot;application/vnd.github.machine-man-preview+json&quot;)
192                                .POST(HttpRequest.BodyPublishers.noBody())
193                                .build(),
194                     HttpResponse.BodyHandlers.ofString()
195             );
196 
<span class="line-modified">197             var data = jsonParser.parse(response.body());</span>
198             if (!data.contains(&quot;token&quot;)) {
199                 throw new Token.GeneratorError(&quot;Unknown data returned: &quot; + data);
200             }
201             return data.get(&quot;token&quot;).asString();
202         } catch (IOException e) {
203             throw new UncheckedIOException(e);
204         } catch (InterruptedException e) {
205             throw new Token.GeneratorError(e.toString());
206         }
207     }
208 
209     public String getInstallationToken() {
210         return installationToken.toString();
211     }
212 
213     JSONObject getAppDetails() {
214         var details = URIBuilder.base(apiBase).setPath(&quot;/app&quot;).build();
215         var client = HttpClient.newBuilder()
216                                .connectTimeout(Duration.ofSeconds(10))
217                                .build();
</pre>
<hr />
<pre>
211     }
212 
213     JSONObject getAppDetails() {
214         var details = URIBuilder.base(apiBase).setPath(&quot;/app&quot;).build();
215         var client = HttpClient.newBuilder()
216                                .connectTimeout(Duration.ofSeconds(10))
217                                .build();
218 
219         try {
220             var response = client.send(
221                     HttpRequest.newBuilder()
222                                .uri(details)
223                                .timeout(Duration.ofSeconds(30))
224                                .header(&quot;Authorization&quot;, &quot;Bearer &quot; + jwt)
225                                .header(&quot;Accept&quot;, &quot;application/vnd.github.machine-man-preview+json&quot;)
226                                .GET()
227                                .build(),
228                     HttpResponse.BodyHandlers.ofString()
229             );
230 
<span class="line-modified">231             var data = jsonParser.parse(response.body());</span>
232             return data.asObject();
233         } catch (IOException e) {
234             throw new UncheckedIOException(e);
235         } catch (InterruptedException e) {
236             throw new RuntimeException(e);
237         }
238     }
239 }
</pre>
</td>
<td>
<hr />
<pre>
 80             cached = generator.generate();
 81             generatedAt = Instant.now();
 82             return cached;
 83         } catch (GeneratorError generatorError) {
 84             // FIXME? The operation could be retried here
 85             throw new GitHubApplicationError(&quot;Failed to generate authentication token (&quot; + generatorError.getMessage() + &quot;)&quot;);
 86         }
 87     }
 88 }
 89 
 90 public class GitHubApplication {
 91     private final String issue;
 92     private final String id;
 93 
 94     private final URI apiBase;
 95     private final PrivateKey key;
 96     private final Token jwt;
 97     private final Token installationToken;
 98 
 99     private final Logger log;

100 
101     static class GitHubConfigurationError extends RuntimeException {
102         public GitHubConfigurationError(String message) {
103             super(message);
104         }
105     }
106 
107     public GitHubApplication(String keyFile, String issue, String id) {
108 
109         log = Logger.getLogger(&quot;org.openjdk.host.github&quot;);

110 
111         apiBase = URIBuilder.base(&quot;https://api.github.com/&quot;).build();
112         this.issue = issue;
113         this.id = id;
114 
115         key = loadPkcs8PemFromFile(keyFile);
116         jwt = new Token(this::generateJsonWebToken, Duration.ofMinutes(5));
117         installationToken = new Token(this::generateInstallationToken, Duration.ofMinutes(30));
118     }
119 
120     private PrivateKey loadPkcs8PemFromFile(String keyFile) {
121         try {
122             var pem = new String(Files.readAllBytes(Paths.get(keyFile)));
123             var pemPattern = Pattern.compile(&quot;^-*BEGIN PRIVATE KEY-*$(.*)^-*END PRIVATE KEY-*&quot;,
124                     Pattern.DOTALL | Pattern.MULTILINE);
125             var keyString = pemPattern.matcher(pem).replaceFirst(&quot;$1&quot;);
126             //keyString = keyString.replace(&quot;\n&quot;, &quot;&quot;);
127             var rawKey = Base64.getMimeDecoder().decode(keyString);
128             var factory = KeyFactory.getInstance(&quot;RSA&quot;);
129             return factory.generatePrivate(new PKCS8EncodedKeySpec(rawKey));
</pre>
<hr />
<pre>
175     }
176 
177     private String generateInstallationToken() throws Token.GeneratorError {
178         var tokens = URIBuilder.base(apiBase).setPath(&quot;/installations/&quot; + id + &quot;/access_tokens&quot;).build();
179         var client = HttpClient.newBuilder()
180                                .connectTimeout(Duration.ofSeconds(10))
181                                .build();
182 
183         try {
184             var response = client.send(
185                     HttpRequest.newBuilder()
186                                .uri(tokens)
187                                .timeout(Duration.ofSeconds(30))
188                                .header(&quot;Authorization&quot;, &quot;Bearer &quot; + jwt)
189                                .header(&quot;Accept&quot;, &quot;application/vnd.github.machine-man-preview+json&quot;)
190                                .POST(HttpRequest.BodyPublishers.noBody())
191                                .build(),
192                     HttpResponse.BodyHandlers.ofString()
193             );
194 
<span class="line-modified">195             var data = JSON.parse(response.body());</span>
196             if (!data.contains(&quot;token&quot;)) {
197                 throw new Token.GeneratorError(&quot;Unknown data returned: &quot; + data);
198             }
199             return data.get(&quot;token&quot;).asString();
200         } catch (IOException e) {
201             throw new UncheckedIOException(e);
202         } catch (InterruptedException e) {
203             throw new Token.GeneratorError(e.toString());
204         }
205     }
206 
207     public String getInstallationToken() {
208         return installationToken.toString();
209     }
210 
211     JSONObject getAppDetails() {
212         var details = URIBuilder.base(apiBase).setPath(&quot;/app&quot;).build();
213         var client = HttpClient.newBuilder()
214                                .connectTimeout(Duration.ofSeconds(10))
215                                .build();
</pre>
<hr />
<pre>
209     }
210 
211     JSONObject getAppDetails() {
212         var details = URIBuilder.base(apiBase).setPath(&quot;/app&quot;).build();
213         var client = HttpClient.newBuilder()
214                                .connectTimeout(Duration.ofSeconds(10))
215                                .build();
216 
217         try {
218             var response = client.send(
219                     HttpRequest.newBuilder()
220                                .uri(details)
221                                .timeout(Duration.ofSeconds(30))
222                                .header(&quot;Authorization&quot;, &quot;Bearer &quot; + jwt)
223                                .header(&quot;Accept&quot;, &quot;application/vnd.github.machine-man-preview+json&quot;)
224                                .GET()
225                                .build(),
226                     HttpResponse.BodyHandlers.ofString()
227             );
228 
<span class="line-modified">229             var data = JSON.parse(response.body());</span>
230             return data.asObject();
231         } catch (IOException e) {
232             throw new UncheckedIOException(e);
233         } catch (InterruptedException e) {
234             throw new RuntimeException(e);
235         }
236     }
237 }
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../../../json/src/main/java/org/openjdk/skara/json/JSONParser.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>