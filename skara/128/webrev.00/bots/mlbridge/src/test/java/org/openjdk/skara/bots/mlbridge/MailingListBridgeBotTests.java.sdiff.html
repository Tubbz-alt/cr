<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/mlbridge/ReviewArchive.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 342             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 343                                                  listAddress, Set.of(), Set.of(),
 344                                                  listServer.getArchive(),
 345                                                  listServer.getSMTP(),
 346                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 347                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 348                                                  Set.of(), Map.of());
 349 
 350             // Populate the projects repository
 351             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 352             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 353             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 354             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 355             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 356 
 357             // Make a change with a corresponding PR
 358             var editHash = CheckableRepository.appendAndCommit(localRepo);
 359             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 360             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 361             pr.setBody(&quot;This is now ready&quot;);


 362             TestBotRunner.runPeriodicItems(mlBot);
 363             listServer.processIncoming();

 364 
 365             // Make two file specific comments
 366             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 367             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 368             TestBotRunner.runPeriodicItems(mlBot);
 369             listServer.processIncoming();
 370 
 371             // The archive should contain a combined entry
 372             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
<span class="line-modified"> 373             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));</span>
 374 
 375             // As well as the mailing list
 376             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 377             var mailmanList = mailmanServer.getList(listAddress.address());
 378             var conversations = mailmanList.conversations(Duration.ofDays(1));
 379             assertEquals(1, conversations.size());
 380             var mail = conversations.get(0).first();
 381             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
<span class="line-modified"> 382             assertEquals(2, conversations.get(0).allMessages().size());</span>




 383 
<span class="line-modified"> 384             var reply = conversations.get(0).replies(mail).get(0);</span>
<span class="line-modified"> 385             assertEquals(2, reply.body().split(&quot;^On.*wrote:&quot;).length);</span>
<span class="line-modified"> 386             assertEquals(2, reply.body().split(&quot;&gt; This is now ready&quot;).length, reply.body());</span>
<span class="line-modified"> 387             assertEquals(&quot;Re: RFR: This is a pull request&quot;, reply.subject());</span>
<span class="line-modified"> 388             assertTrue(reply.body().contains(&quot;Review comment\n\n&quot;), reply.body());</span>
<span class="line-modified"> 389             assertTrue(reply.body().contains(&quot;Another review comment&quot;), reply.body());</span>
 390         }
 391     }
 392 
 393     @Test
 394     void commentThreading(TestInfo testInfo) throws IOException {
 395         try (var credentials = new HostCredentials(testInfo);
 396              var tempFolder = new TemporaryDirectory();
 397              var archiveFolder = new TemporaryDirectory();
 398              var listServer = new TestMailmanServer()) {
 399             var author = credentials.getHostedRepository();
 400             var reviewer = credentials.getHostedRepository();
 401             var archive = credentials.getHostedRepository();
 402             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 403             var censusBuilder = credentials.getCensusBuilder()
 404                                            .addReviewer(reviewer.host().getCurrentUserDetails().id())
 405                                            .addAuthor(author.host().getCurrentUserDetails().id());
 406             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 407             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 408                                                  listAddress, Set.of(), Set.of(),
 409                                                  listServer.getArchive(),
</pre>
<hr />
<pre>
 429 
 430             // Make a file specific comment
 431             var reviewPr = reviewer.getPullRequest(pr.getId());
 432             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 433             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 434             reviewPr.addReviewCommentReply(comment1, &quot;Great&quot;);
 435             TestBotRunner.runPeriodicItems(mlBot);
 436             listServer.processIncoming();
 437             listServer.processIncoming();
 438             listServer.processIncoming();
 439 
 440             // And a second one by ourselves
 441             var comment2 = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 442             reviewPr.addReviewCommentReply(comment2, &quot;Sounds good&quot;);
 443             pr.addReviewCommentReply(comment2, &quot;Thanks&quot;);
 444             TestBotRunner.runPeriodicItems(mlBot);
 445             listServer.processIncoming();
 446             listServer.processIncoming();
 447             listServer.processIncoming();
 448 







 449             // Sanity check the archive
 450             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
<span class="line-modified"> 451             assertEquals(6, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));</span>
 452 
 453             // Check the mailing list
 454             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 455             var mailmanList = mailmanServer.getList(listAddress.address());
 456             var conversations = mailmanList.conversations(Duration.ofDays(1));
 457             assertEquals(1, conversations.size());
 458             var mail = conversations.get(0).first();
 459             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
<span class="line-modified"> 460             assertEquals(7, conversations.get(0).allMessages().size());</span>
 461 
<span class="line-modified"> 462             // There should be two separate threads</span>
 463             var thread1 = conversations.get(0).replies(mail).get(0);
 464             assertEquals(2, thread1.body().split(&quot;^On.*wrote:&quot;).length);
 465             assertEquals(2, thread1.body().split(&quot;&gt; This is now ready&quot;).length, thread1.body());
 466             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread1.subject());
 467             assertTrue(thread1.body().contains(&quot;Review comment\n\n&quot;), thread1.body());
 468             assertFalse(thread1.body().contains(&quot;Another review comment&quot;), thread1.body());
 469             var thread1reply1 = conversations.get(0).replies(thread1).get(0);
 470             assertTrue(thread1reply1.body().contains(&quot;I agree&quot;));
 471             assertEquals(noreplyAddress(archive), thread1reply1.author().address());
 472             assertEquals(archive.host().getCurrentUserDetails().fullName(), thread1reply1.author().fullName().orElseThrow());
 473             var thread1reply2 = conversations.get(0).replies(thread1reply1).get(0);
 474             assertTrue(thread1reply2.body().contains(&quot;Great&quot;));
 475             assertEquals(&quot;integrationreviewer1@openjdk.java.net&quot;, thread1reply2.author().address());
 476             assertEquals(&quot;Generated Reviewer 1&quot;, thread1reply2.author().fullName().orElseThrow());
 477 
 478             var thread2 = conversations.get(0).replies(mail).get(1);
 479             assertEquals(2, thread2.body().split(&quot;^On.*wrote:&quot;).length);
 480             assertEquals(2, thread2.body().split(&quot;&gt; This is now ready&quot;).length, thread2.body());
 481             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread2.subject());
 482             assertFalse(thread2.body().contains(&quot;Review comment\n\n&quot;), thread2.body());





 488         }
 489     }
 490 
 491     @Test
 492     void reviewContext(TestInfo testInfo) throws IOException {
 493         try (var credentials = new HostCredentials(testInfo);
 494              var tempFolder = new TemporaryDirectory();
 495              var archiveFolder = new TemporaryDirectory();
 496              var listServer = new TestMailmanServer()) {
 497             var author = credentials.getHostedRepository();
 498             var archive = credentials.getHostedRepository();
 499             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 500             var censusBuilder = credentials.getCensusBuilder()
 501                                            .addAuthor(author.host().getCurrentUserDetails().id());
 502             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 503             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 504                                                  listAddress, Set.of(), Set.of(),
 505                                                  listServer.getArchive(),
 506                                                  listServer.getSMTP(),
 507                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
</pre>
<hr />
<pre>
 987             // The archive should contain a note
 988             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 989             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Review status set to Disapproved&quot;));
 990             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot; by integrationreviewer1&quot;));
 991             if (author.host().supportsReviewBody()) {
 992                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
 993             }
 994 
 995             // Then approve it
 996             reviewedPr.addReview(Review.Verdict.APPROVED, &quot;Reason 2&quot;);
 997             TestBotRunner.runPeriodicItems(mlBot);
 998             TestBotRunner.runPeriodicItems(mlBot);
 999             TestBotRunner.runPeriodicItems(mlBot);
1000 
1001             // The archive should contain another note
1002             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1003             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Review status set to Approved&quot;));
1004             if (author.host().supportsReviewBody()) {
1005                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 2&quot;));
1006             }
<span class="line-modified">1007             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;This PR has been marked as Reviewed by integrationreviewer1.&quot;));</span>
1008 
1009             // Yet another change
1010             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 3&quot;);
1011             TestBotRunner.runPeriodicItems(mlBot);
1012             TestBotRunner.runPeriodicItems(mlBot);
1013             TestBotRunner.runPeriodicItems(mlBot);
1014 
1015             // The archive should contain another note
1016             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1017             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Review status set to Disapproved&quot;));
1018             if (author.host().supportsReviewBody()) {
1019                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
1020             }
1021         }
1022     }
1023 
1024     @Test
1025     void ignoreComments(TestInfo testInfo) throws IOException {
1026         try (var credentials = new HostCredentials(testInfo);
1027              var tempFolder = new TemporaryDirectory();
</pre>
</td>
<td>
<hr />
<pre>
 342             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 343                                                  listAddress, Set.of(), Set.of(),
 344                                                  listServer.getArchive(),
 345                                                  listServer.getSMTP(),
 346                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 347                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 348                                                  Set.of(), Map.of());
 349 
 350             // Populate the projects repository
 351             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 352             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 353             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 354             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 355             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 356 
 357             // Make a change with a corresponding PR
 358             var editHash = CheckableRepository.appendAndCommit(localRepo);
 359             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 360             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 361             pr.setBody(&quot;This is now ready&quot;);
<span class="line-added"> 362             pr.addComment(&quot;Avoid combining&quot;);</span>
<span class="line-added"> 363 </span>
 364             TestBotRunner.runPeriodicItems(mlBot);
 365             listServer.processIncoming();
<span class="line-added"> 366             listServer.processIncoming();</span>
 367 
 368             // Make two file specific comments
 369             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 370             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 371             TestBotRunner.runPeriodicItems(mlBot);
 372             listServer.processIncoming();
 373 
 374             // The archive should contain a combined entry
 375             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
<span class="line-modified"> 376             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));</span>
 377 
 378             // As well as the mailing list
 379             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 380             var mailmanList = mailmanServer.getList(listAddress.address());
 381             var conversations = mailmanList.conversations(Duration.ofDays(1));
 382             assertEquals(1, conversations.size());
 383             var mail = conversations.get(0).first();
 384             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
<span class="line-modified"> 385             assertEquals(3, conversations.get(0).allMessages().size());</span>
<span class="line-added"> 386 </span>
<span class="line-added"> 387             var commentReply = conversations.get(0).replies(mail).get(0);</span>
<span class="line-added"> 388             assertEquals(2, commentReply.body().split(&quot;^On.*wrote:&quot;).length);</span>
<span class="line-added"> 389             assertTrue(commentReply.body().contains(&quot;Avoid combining\n\n&quot;), commentReply.body());</span>
 390 
<span class="line-modified"> 391             var reviewReply = conversations.get(0).replies(mail).get(1);</span>
<span class="line-modified"> 392             assertEquals(2, reviewReply.body().split(&quot;^On.*wrote:&quot;).length);</span>
<span class="line-modified"> 393             assertEquals(2, reviewReply.body().split(&quot;&gt; This is now ready&quot;).length, reviewReply.body());</span>
<span class="line-modified"> 394             assertEquals(&quot;Re: RFR: This is a pull request&quot;, reviewReply.subject());</span>
<span class="line-modified"> 395             assertTrue(reviewReply.body().contains(&quot;Review comment\n\n&quot;), reviewReply.body());</span>
<span class="line-modified"> 396             assertTrue(reviewReply.body().contains(&quot;Another review comment&quot;), reviewReply.body());</span>
 397         }
 398     }
 399 
 400     @Test
 401     void commentThreading(TestInfo testInfo) throws IOException {
 402         try (var credentials = new HostCredentials(testInfo);
 403              var tempFolder = new TemporaryDirectory();
 404              var archiveFolder = new TemporaryDirectory();
 405              var listServer = new TestMailmanServer()) {
 406             var author = credentials.getHostedRepository();
 407             var reviewer = credentials.getHostedRepository();
 408             var archive = credentials.getHostedRepository();
 409             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 410             var censusBuilder = credentials.getCensusBuilder()
 411                                            .addReviewer(reviewer.host().getCurrentUserDetails().id())
 412                                            .addAuthor(author.host().getCurrentUserDetails().id());
 413             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 414             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 415                                                  listAddress, Set.of(), Set.of(),
 416                                                  listServer.getArchive(),
</pre>
<hr />
<pre>
 436 
 437             // Make a file specific comment
 438             var reviewPr = reviewer.getPullRequest(pr.getId());
 439             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 440             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 441             reviewPr.addReviewCommentReply(comment1, &quot;Great&quot;);
 442             TestBotRunner.runPeriodicItems(mlBot);
 443             listServer.processIncoming();
 444             listServer.processIncoming();
 445             listServer.processIncoming();
 446 
 447             // And a second one by ourselves
 448             var comment2 = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 449             reviewPr.addReviewCommentReply(comment2, &quot;Sounds good&quot;);
 450             pr.addReviewCommentReply(comment2, &quot;Thanks&quot;);
 451             TestBotRunner.runPeriodicItems(mlBot);
 452             listServer.processIncoming();
 453             listServer.processIncoming();
 454             listServer.processIncoming();
 455 
<span class="line-added"> 456             // Finally some approvals</span>
<span class="line-added"> 457             pr.addReview(Review.Verdict.APPROVED, &quot;Nice&quot;);</span>
<span class="line-added"> 458             reviewPr.addReview(Review.Verdict.APPROVED, &quot;Looks fine&quot;);</span>
<span class="line-added"> 459             TestBotRunner.runPeriodicItems(mlBot);</span>
<span class="line-added"> 460             listServer.processIncoming();</span>
<span class="line-added"> 461             listServer.processIncoming();</span>
<span class="line-added"> 462 </span>
 463             // Sanity check the archive
 464             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
<span class="line-modified"> 465             assertEquals(8, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));</span>
 466 
 467             // Check the mailing list
 468             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 469             var mailmanList = mailmanServer.getList(listAddress.address());
 470             var conversations = mailmanList.conversations(Duration.ofDays(1));
 471             assertEquals(1, conversations.size());
 472             var mail = conversations.get(0).first();
 473             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
<span class="line-modified"> 474             assertEquals(9, conversations.get(0).allMessages().size());</span>
 475 
<span class="line-modified"> 476             // There should be four separate threads</span>
 477             var thread1 = conversations.get(0).replies(mail).get(0);
 478             assertEquals(2, thread1.body().split(&quot;^On.*wrote:&quot;).length);
 479             assertEquals(2, thread1.body().split(&quot;&gt; This is now ready&quot;).length, thread1.body());
 480             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread1.subject());
 481             assertTrue(thread1.body().contains(&quot;Review comment\n\n&quot;), thread1.body());
 482             assertFalse(thread1.body().contains(&quot;Another review comment&quot;), thread1.body());
 483             var thread1reply1 = conversations.get(0).replies(thread1).get(0);
 484             assertTrue(thread1reply1.body().contains(&quot;I agree&quot;));
 485             assertEquals(noreplyAddress(archive), thread1reply1.author().address());
 486             assertEquals(archive.host().getCurrentUserDetails().fullName(), thread1reply1.author().fullName().orElseThrow());
 487             var thread1reply2 = conversations.get(0).replies(thread1reply1).get(0);
 488             assertTrue(thread1reply2.body().contains(&quot;Great&quot;));
 489             assertEquals(&quot;integrationreviewer1@openjdk.java.net&quot;, thread1reply2.author().address());
 490             assertEquals(&quot;Generated Reviewer 1&quot;, thread1reply2.author().fullName().orElseThrow());
 491 
 492             var thread2 = conversations.get(0).replies(mail).get(1);
 493             assertEquals(2, thread2.body().split(&quot;^On.*wrote:&quot;).length);
 494             assertEquals(2, thread2.body().split(&quot;&gt; This is now ready&quot;).length, thread2.body());
 495             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread2.subject());
 496             assertFalse(thread2.body().contains(&quot;Review comment\n\n&quot;), thread2.body());
<span class="line-added"> 502 </span>
<span class="line-added"> 503             var thread3 = conversations.get(0).replies(mail).get(2);</span>
<span class="line-added"> 504             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread3.subject());</span>
<span class="line-added"> 505             var thread4 = conversations.get(0).replies(mail).get(3);</span>
<span class="line-added"> 506             assertEquals(&quot;Re: Approved and Reviewed by integrationreviewer1&quot;, thread4.subject());</span>
 507         }
 508     }
 509 
 510     @Test
 511     void reviewContext(TestInfo testInfo) throws IOException {
 512         try (var credentials = new HostCredentials(testInfo);
 513              var tempFolder = new TemporaryDirectory();
 514              var archiveFolder = new TemporaryDirectory();
 515              var listServer = new TestMailmanServer()) {
 516             var author = credentials.getHostedRepository();
 517             var archive = credentials.getHostedRepository();
 518             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 519             var censusBuilder = credentials.getCensusBuilder()
 520                                            .addAuthor(author.host().getCurrentUserDetails().id());
 521             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 522             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 523                                                  listAddress, Set.of(), Set.of(),
 524                                                  listServer.getArchive(),
 525                                                  listServer.getSMTP(),
 526                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
</pre>
<hr />
<pre>
1006             // The archive should contain a note
1007             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1008             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Review status set to Disapproved&quot;));
1009             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot; by integrationreviewer1&quot;));
1010             if (author.host().supportsReviewBody()) {
1011                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
1012             }
1013 
1014             // Then approve it
1015             reviewedPr.addReview(Review.Verdict.APPROVED, &quot;Reason 2&quot;);
1016             TestBotRunner.runPeriodicItems(mlBot);
1017             TestBotRunner.runPeriodicItems(mlBot);
1018             TestBotRunner.runPeriodicItems(mlBot);
1019 
1020             // The archive should contain another note
1021             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1022             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Review status set to Approved&quot;));
1023             if (author.host().supportsReviewBody()) {
1024                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 2&quot;));
1025             }
<span class="line-modified">1026             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Re: Approved and Reviewed by integrationreviewer1&quot;));</span>
1027 
1028             // Yet another change
1029             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 3&quot;);
1030             TestBotRunner.runPeriodicItems(mlBot);
1031             TestBotRunner.runPeriodicItems(mlBot);
1032             TestBotRunner.runPeriodicItems(mlBot);
1033 
1034             // The archive should contain another note
1035             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1036             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Review status set to Disapproved&quot;));
1037             if (author.host().supportsReviewBody()) {
1038                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
1039             }
1040         }
1041     }
1042 
1043     @Test
1044     void ignoreComments(TestInfo testInfo) throws IOException {
1045         try (var credentials = new HostCredentials(testInfo);
1046              var tempFolder = new TemporaryDirectory();
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/mlbridge/ReviewArchive.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>