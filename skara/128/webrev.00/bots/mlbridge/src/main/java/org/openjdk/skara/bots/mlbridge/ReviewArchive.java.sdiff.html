<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/ReviewArchive.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ArchiveMessages.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>bots/mlbridge/src/main/java/org/openjdk/skara/bots/mlbridge/ReviewArchive.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 47             throw new RuntimeException(&quot;Cannot find SHA-256&quot;);
 48         }
 49     }
 50 
 51     private EmailAddress getMessageId() {
 52         return getUniqueMessageId(&quot;fc&quot;);
 53     }
 54 
 55     private EmailAddress getMessageId(Comment comment) {
 56         return getUniqueMessageId(&quot;pc&quot; + comment.id());
 57     }
 58 
 59     private EmailAddress getMessageId(ReviewComment comment) {
 60         return getUniqueMessageId(&quot;rc&quot; + comment.id());
 61     }
 62 
 63     private EmailAddress getMessageId(Hash hash) {
 64         return getUniqueMessageId(&quot;ha&quot; + hash.hex());
 65     }
 66 
<span class="line-modified"> 67     private EmailAddress getMessageId(String raw) {</span>
<span class="line-modified"> 68         return getUniqueMessageId(&quot;rw&quot; + raw);</span>
<span class="line-removed"> 69     }</span>
<span class="line-removed"> 70 </span>
<span class="line-removed"> 71     private EmailAddress getMessageId(Review review, boolean verdict) {</span>
<span class="line-removed"> 72         if (verdict) {</span>
<span class="line-removed"> 73             return getUniqueMessageId(&quot;rvvd&quot; + review.id());</span>
<span class="line-removed"> 74         } else {</span>
<span class="line-removed"> 75             return getUniqueMessageId(&quot;rv&quot; + review.id());</span>
<span class="line-removed"> 76         }</span>
 77     }
 78 
 79     private String getStableMessageId(EmailAddress uniqueMessageId) {
 80         return uniqueMessageId.localPart().split(&quot;\\.&quot;)[0];
 81     }
 82 
 83     private Set&lt;String&gt; getStableMessageIds(Email email) {
 84         var ret = new HashSet&lt;String&gt;();
 85         ret.add(getStableMessageId(email.id()));
 86         if (email.hasHeader(&quot;PR-Collapsed-IDs&quot;)) {
 87             var additional = email.headerValue(&quot;PR-Collapsed-IDs&quot;).split(&quot; &quot;);
 88             ret.addAll(Arrays.asList(additional));
 89         }
 90         return ret;
 91     }
 92 
 93     private Email topEmail() {
 94         if (!existing.isEmpty()) {
 95             return existing.get(0);
 96         }
</pre>
<hr />
<pre>
222 
223     void addIncremental(URI fullWebrev, URI incrementalWebrev) {
224         var body = ArchiveMessages.composeIncrementalComment(latestHead(), prInstance, fullWebrev, incrementalWebrev);
225         var id = getMessageId(prInstance.headHash());
226         var parent = topEmail();
227         var email = Email.create(latestHeadSubject(), body)
228                          .sender(sender)
229                          .author(getAuthorAddress(prInstance.pr().getAuthor()))
230                          .recipient(parent.author())
231                          .id(id)
232                          .header(&quot;In-Reply-To&quot;, parent.id().toString())
233                          .header(&quot;References&quot;, parent.id().toString())
234                          .header(&quot;PR-Head-Hash&quot;, prInstance.headHash().hex())
235                          .header(&quot;PR-Base-Hash&quot;, prInstance.baseHash().hex())
236                          .header(&quot;PR-Sequence&quot;, Integer.toString(existing.size() + generated.size()))
237                          .build();
238         generated.add(email);
239         generatedIds.put(getStableMessageId(id), email);
240     }
241 
<span class="line-modified">242     private Optional&lt;Email&gt; findCollapsable(Email parent, HostUserDetails author) {</span>
243         var parentId = getStableMessageId(parent.id());
244 
245         // Is it a self-reply?
246         if (parent.author().equals(getAuthorAddress(author)) &amp;&amp; generatedIds.containsKey(parentId)) {
<span class="line-modified">247             return Optional.of(parent);</span>






248         }
249 
250         // Have we already replied to the same parent?
251         for (var candidate : generated) {
252             if (!candidate.hasHeader(&quot;In-Reply-To&quot;)) {
253                 continue;
254             }
255             var inReplyTo = EmailAddress.parse(candidate.headerValue(&quot;In-Reply-To&quot;));
256             var candidateParentId = getStableMessageId(inReplyTo);
257             if (candidateParentId.equals(parentId) &amp;&amp; candidate.author().equals(getAuthorAddress(author))) {
<span class="line-modified">258                 return Optional.of(candidate);</span>



259             }
260         }
261 
262         return Optional.empty();
263     }
264 
265     private void addReplyCommon(Email parent, HostUserDetails author, String subject, String body, EmailAddress id) {
266         var references = parent.id().toString();
267         if (parent.hasHeader(&quot;References&quot;)) {
268             references = parent.headerValue(&quot;References&quot;) + &quot; &quot; + references;
269         }
270         if (!subject.startsWith(&quot;Re: &quot;)) {
271             subject = &quot;Re: &quot; + subject;
272         }
273 
274         // Collapse self-replies and replies-to-same that have been created in this run
<span class="line-modified">275         var collapsable = findCollapsable(parent, author);</span>
276         if (collapsable.isPresent()) {
277             // Drop the parent
278             var parentEmail = collapsable.get();
279             generated.remove(parentEmail);
280             generatedIds.remove(getStableMessageId(parentEmail.id()));
281 
282             var collapsed = parentEmail.hasHeader(&quot;PR-Collapsed-IDs&quot;) ? parentEmail.headerValue(&quot;PR-Collapsed-IDs&quot;) : &quot;&quot;;
283             collapsed += getStableMessageId(parentEmail.id());
284 
285             var reply = ArchiveMessages.composeCombinedReply(parentEmail, body, prInstance);
286             var email = Email.from(parentEmail)
287                              .body(reply)
288                              .subject(subject)
289                              .id(id)
290                              .header(&quot;PR-Collapsed-IDs&quot;, collapsed)
291                              .header(&quot;PR-Sequence&quot;, Integer.toString(existing.size() + generated.size()))
292                              .build();
293             generated.add(email);
294             generatedIds.put(getStableMessageId(id), email);
295         } else {
</pre>
<hr />
<pre>
316 
317         var parent = latestGeneralComment();
318         addReplyCommon(parent, comment.author(), &quot;Re: RFR: &quot; + prInstance.pr().getTitle(), comment.body(), id);
319     }
320 
321     private String projectRole(Contributor contributor) {
322         var version = censusInstance.configuration().census().version();
323         if (censusInstance.project().isLead(contributor.username(), version)) {
324             return &quot;Lead&quot;;
325         } else if (censusInstance.project().isReviewer(contributor.username(), version)) {
326             return &quot;Reviewer&quot;;
327         } else if (censusInstance.project().isCommitter(contributor.username(), version)) {
328             return &quot;Committer&quot;;
329         } else if (censusInstance.project().isAuthor(contributor.username(), version)) {
330             return &quot;Author&quot;;
331         }
332         return &quot;none&quot;;
333     }
334 
335     void addReview(Review review) {





336         var contributor = censusInstance.namespace().get(review.reviewer().id());

337 
<span class="line-modified">338         // Post the review body as a regular comment</span>
<span class="line-modified">339         if (review.body().isPresent()) {</span>
<span class="line-modified">340             var id = getMessageId(review, false);</span>
<span class="line-removed">341             if (!existingIds.containsKey(getStableMessageId(id))) {</span>
<span class="line-removed">342                 var parent = topCommentForHash(review.hash());</span>
<span class="line-removed">343                 var userName = contributor != null ? contributor.username() : review.reviewer().userName() + &quot;@&quot; + censusInstance.namespace().name();</span>
<span class="line-removed">344                 var userRole = contributor != null ? projectRole(contributor) : &quot;none&quot;;</span>
<span class="line-removed">345                 var replyBody = ArchiveMessages.reviewCommentBody(review.body().get(), review.verdict(), userName, userRole);</span>
<span class="line-removed">346                 addReplyCommon(parent, review.reviewer(), parent.subject(), replyBody, id);</span>
<span class="line-removed">347             }</span>
<span class="line-removed">348         }</span>
349 
<span class="line-modified">350         if (contributor != null) {</span>
<span class="line-modified">351             var isReviewer = censusInstance.project().isReviewer(contributor.username(), censusInstance.configuration().census().version());</span>
<span class="line-modified">352             if (review.verdict() == Review.Verdict.APPROVED &amp;&amp; isReviewer) {</span>
<span class="line-modified">353                 var id = getMessageId(review, true);</span>
<span class="line-removed">354                 if (!existingIds.containsKey(getStableMessageId(id))) {</span>
<span class="line-removed">355                     var parent = topEmail();</span>
<span class="line-removed">356                     var replyBody = ArchiveMessages.reviewApprovalBodyReviewer(contributor.username());</span>
<span class="line-removed">357                     addReplyCommon(parent, review.reviewer(), &quot;Approved and Reviewed by &quot; + contributor.username(), replyBody, id);</span>
<span class="line-removed">358                 }</span>
<span class="line-removed">359             }</span>
360         }






361     }
362 
363     void addReviewComment(ReviewComment reviewComment) {
364         var id = getMessageId(reviewComment);
365         if (existingIds.containsKey(getStableMessageId(id))) {
366             return;
367         }
368 
369         var parent = parentForReviewComment(reviewComment);
370         var body = new StringBuilder();
371 
372         // Add some context to the first post
373         if (reviewComment.parent().isEmpty()) {
374             var contents = prInstance.pr().repository().getFileContents(reviewComment.path(), reviewComment.hash().hex()).lines().collect(Collectors.toList());
375 
376             body.append(reviewComment.path()).append(&quot; line &quot;).append(reviewComment.line()).append(&quot;:\n\n&quot;);
377             for (int i = Math.max(0, reviewComment.line() - 2); i &lt; Math.min(contents.size(), reviewComment.line() + 1); ++i) {
378                 body.append(&quot;&gt; &quot;).append(i + 1).append(&quot;: &quot;).append(contents.get(i)).append(&quot;\n&quot;);
379             }
380             body.append(&quot;\n&quot;);
</pre>
</td>
<td>
<hr />
<pre>
 47             throw new RuntimeException(&quot;Cannot find SHA-256&quot;);
 48         }
 49     }
 50 
 51     private EmailAddress getMessageId() {
 52         return getUniqueMessageId(&quot;fc&quot;);
 53     }
 54 
 55     private EmailAddress getMessageId(Comment comment) {
 56         return getUniqueMessageId(&quot;pc&quot; + comment.id());
 57     }
 58 
 59     private EmailAddress getMessageId(ReviewComment comment) {
 60         return getUniqueMessageId(&quot;rc&quot; + comment.id());
 61     }
 62 
 63     private EmailAddress getMessageId(Hash hash) {
 64         return getUniqueMessageId(&quot;ha&quot; + hash.hex());
 65     }
 66 
<span class="line-modified"> 67     private EmailAddress getMessageId(Review review) {</span>
<span class="line-modified"> 68         return getUniqueMessageId(&quot;rv&quot; + review.id());</span>








 69     }
 70 
 71     private String getStableMessageId(EmailAddress uniqueMessageId) {
 72         return uniqueMessageId.localPart().split(&quot;\\.&quot;)[0];
 73     }
 74 
 75     private Set&lt;String&gt; getStableMessageIds(Email email) {
 76         var ret = new HashSet&lt;String&gt;();
 77         ret.add(getStableMessageId(email.id()));
 78         if (email.hasHeader(&quot;PR-Collapsed-IDs&quot;)) {
 79             var additional = email.headerValue(&quot;PR-Collapsed-IDs&quot;).split(&quot; &quot;);
 80             ret.addAll(Arrays.asList(additional));
 81         }
 82         return ret;
 83     }
 84 
 85     private Email topEmail() {
 86         if (!existing.isEmpty()) {
 87             return existing.get(0);
 88         }
</pre>
<hr />
<pre>
214 
215     void addIncremental(URI fullWebrev, URI incrementalWebrev) {
216         var body = ArchiveMessages.composeIncrementalComment(latestHead(), prInstance, fullWebrev, incrementalWebrev);
217         var id = getMessageId(prInstance.headHash());
218         var parent = topEmail();
219         var email = Email.create(latestHeadSubject(), body)
220                          .sender(sender)
221                          .author(getAuthorAddress(prInstance.pr().getAuthor()))
222                          .recipient(parent.author())
223                          .id(id)
224                          .header(&quot;In-Reply-To&quot;, parent.id().toString())
225                          .header(&quot;References&quot;, parent.id().toString())
226                          .header(&quot;PR-Head-Hash&quot;, prInstance.headHash().hex())
227                          .header(&quot;PR-Base-Hash&quot;, prInstance.baseHash().hex())
228                          .header(&quot;PR-Sequence&quot;, Integer.toString(existing.size() + generated.size()))
229                          .build();
230         generated.add(email);
231         generatedIds.put(getStableMessageId(id), email);
232     }
233 
<span class="line-modified">234     private Optional&lt;Email&gt; findCollapsable(Email parent, HostUserDetails author, String subject) {</span>
235         var parentId = getStableMessageId(parent.id());
236 
237         // Is it a self-reply?
238         if (parent.author().equals(getAuthorAddress(author)) &amp;&amp; generatedIds.containsKey(parentId)) {
<span class="line-modified">239             // But avoid extending top-level parents</span>
<span class="line-added">240             if (!parent.hasHeader(&quot;PR-Head-Hash&quot;)) {</span>
<span class="line-added">241                 // And only collapse identical subjects</span>
<span class="line-added">242                 if (parent.subject().equals(subject)) {</span>
<span class="line-added">243                     return Optional.of(parent);</span>
<span class="line-added">244                 }</span>
<span class="line-added">245             }</span>
246         }
247 
248         // Have we already replied to the same parent?
249         for (var candidate : generated) {
250             if (!candidate.hasHeader(&quot;In-Reply-To&quot;)) {
251                 continue;
252             }
253             var inReplyTo = EmailAddress.parse(candidate.headerValue(&quot;In-Reply-To&quot;));
254             var candidateParentId = getStableMessageId(inReplyTo);
255             if (candidateParentId.equals(parentId) &amp;&amp; candidate.author().equals(getAuthorAddress(author))) {
<span class="line-modified">256                 // Only collapse identical subjects</span>
<span class="line-added">257                 if (candidate.subject().equals(subject)) {</span>
<span class="line-added">258                     return Optional.of(candidate);</span>
<span class="line-added">259                 }</span>
260             }
261         }
262 
263         return Optional.empty();
264     }
265 
266     private void addReplyCommon(Email parent, HostUserDetails author, String subject, String body, EmailAddress id) {
267         var references = parent.id().toString();
268         if (parent.hasHeader(&quot;References&quot;)) {
269             references = parent.headerValue(&quot;References&quot;) + &quot; &quot; + references;
270         }
271         if (!subject.startsWith(&quot;Re: &quot;)) {
272             subject = &quot;Re: &quot; + subject;
273         }
274 
275         // Collapse self-replies and replies-to-same that have been created in this run
<span class="line-modified">276         var collapsable = findCollapsable(parent, author, subject);</span>
277         if (collapsable.isPresent()) {
278             // Drop the parent
279             var parentEmail = collapsable.get();
280             generated.remove(parentEmail);
281             generatedIds.remove(getStableMessageId(parentEmail.id()));
282 
283             var collapsed = parentEmail.hasHeader(&quot;PR-Collapsed-IDs&quot;) ? parentEmail.headerValue(&quot;PR-Collapsed-IDs&quot;) : &quot;&quot;;
284             collapsed += getStableMessageId(parentEmail.id());
285 
286             var reply = ArchiveMessages.composeCombinedReply(parentEmail, body, prInstance);
287             var email = Email.from(parentEmail)
288                              .body(reply)
289                              .subject(subject)
290                              .id(id)
291                              .header(&quot;PR-Collapsed-IDs&quot;, collapsed)
292                              .header(&quot;PR-Sequence&quot;, Integer.toString(existing.size() + generated.size()))
293                              .build();
294             generated.add(email);
295             generatedIds.put(getStableMessageId(id), email);
296         } else {
</pre>
<hr />
<pre>
317 
318         var parent = latestGeneralComment();
319         addReplyCommon(parent, comment.author(), &quot;Re: RFR: &quot; + prInstance.pr().getTitle(), comment.body(), id);
320     }
321 
322     private String projectRole(Contributor contributor) {
323         var version = censusInstance.configuration().census().version();
324         if (censusInstance.project().isLead(contributor.username(), version)) {
325             return &quot;Lead&quot;;
326         } else if (censusInstance.project().isReviewer(contributor.username(), version)) {
327             return &quot;Reviewer&quot;;
328         } else if (censusInstance.project().isCommitter(contributor.username(), version)) {
329             return &quot;Committer&quot;;
330         } else if (censusInstance.project().isAuthor(contributor.username(), version)) {
331             return &quot;Author&quot;;
332         }
333         return &quot;none&quot;;
334     }
335 
336     void addReview(Review review) {
<span class="line-added">337         var id = getMessageId(review);</span>
<span class="line-added">338         if (existingIds.containsKey(getStableMessageId(id))) {</span>
<span class="line-added">339             return;</span>
<span class="line-added">340         }</span>
<span class="line-added">341 </span>
342         var contributor = censusInstance.namespace().get(review.reviewer().id());
<span class="line-added">343         var isReviewer = contributor != null &amp;&amp; censusInstance.project().isReviewer(contributor.username(), censusInstance.configuration().census().version());</span>
344 
<span class="line-modified">345         // Default parent and subject</span>
<span class="line-modified">346         var parent = topCommentForHash(review.hash());</span>
<span class="line-modified">347         var subject = parent.subject();</span>








348 
<span class="line-modified">349         // Approvals by Reviewers get special treatment - post these as top-level comments</span>
<span class="line-modified">350         if (review.verdict() == Review.Verdict.APPROVED &amp;&amp; isReviewer) {</span>
<span class="line-modified">351             parent = topEmail();</span>
<span class="line-modified">352             subject = &quot;Approved and Reviewed by &quot; + contributor.username();</span>






353         }
<span class="line-added">354 </span>
<span class="line-added">355         var userName = contributor != null ? contributor.username() : review.reviewer().userName() + &quot;@&quot; + censusInstance.namespace().name();</span>
<span class="line-added">356         var userRole = contributor != null ? projectRole(contributor) : &quot;none&quot;;</span>
<span class="line-added">357         var replyBody = ArchiveMessages.reviewCommentBody(review.body().orElse(&quot;&quot;), review.verdict(), userName, userRole);</span>
<span class="line-added">358 </span>
<span class="line-added">359         addReplyCommon(parent, review.reviewer(), subject, replyBody, id);</span>
360     }
361 
362     void addReviewComment(ReviewComment reviewComment) {
363         var id = getMessageId(reviewComment);
364         if (existingIds.containsKey(getStableMessageId(id))) {
365             return;
366         }
367 
368         var parent = parentForReviewComment(reviewComment);
369         var body = new StringBuilder();
370 
371         // Add some context to the first post
372         if (reviewComment.parent().isEmpty()) {
373             var contents = prInstance.pr().repository().getFileContents(reviewComment.path(), reviewComment.hash().hex()).lines().collect(Collectors.toList());
374 
375             body.append(reviewComment.path()).append(&quot; line &quot;).append(reviewComment.line()).append(&quot;:\n\n&quot;);
376             for (int i = Math.max(0, reviewComment.line() - 2); i &lt; Math.min(contents.size(), reviewComment.line() + 1); ++i) {
377                 body.append(&quot;&gt; &quot;).append(i + 1).append(&quot;: &quot;).append(contents.get(i)).append(&quot;\n&quot;);
378             }
379             body.append(&quot;\n&quot;);
</pre>
</td>
</tr>
</table>
<center><a href="ArchiveMessages.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>