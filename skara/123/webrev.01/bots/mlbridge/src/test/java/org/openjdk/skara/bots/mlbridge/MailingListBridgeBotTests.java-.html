<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old bots/mlbridge/src/test/java/org/openjdk/skara/bots/mlbridge/MailingListBridgeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.mlbridge;
  24 
  25 import org.openjdk.skara.email.EmailAddress;
  26 import org.openjdk.skara.host.Review;
  27 import org.openjdk.skara.host.network.URIBuilder;
  28 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  29 import org.openjdk.skara.test.*;
  30 import org.openjdk.skara.vcs.Repository;
  31 
  32 import org.junit.jupiter.api.*;
  33 
  34 import java.io.IOException;
  35 import java.nio.charset.StandardCharsets;
  36 import java.nio.file.*;
  37 import java.time.Duration;
  38 import java.util.*;
  39 import java.util.regex.Pattern;
  40 import java.util.stream.Collectors;
  41 
  42 import static org.junit.jupiter.api.Assertions.*;
  43 
  44 class MailingListBridgeBotTests {
  45     private boolean archiveContains(Path archive, String text) {
  46         return archiveContainsCount(archive, text) &gt; 0;
  47     }
  48 
  49     private int archiveContainsCount(Path archive, String text) {
  50         try {
  51             var mbox = Files.find(archive, 50, (path, attrs) -&gt; path.toString().endsWith(&quot;.mbox&quot;)).findAny();
  52             if (mbox.isEmpty()) {
  53                 return 0;
  54             }
  55             var lines = Files.readString(mbox.get(), StandardCharsets.UTF_8);
  56             var pattern = Pattern.compile(text);
  57             int count = 0;
  58             for (var line : lines.split(&quot;\\R&quot;)) {
  59                 var matcher = pattern.matcher(line);
  60                 if (matcher.find()) {
  61                     count++;
  62                 }
  63             }
  64             return count;
  65         } catch (IOException e) {
  66             return 0;
  67         }
  68     }
  69 
  70     private boolean webrevContains(Path webrev, String text) {
  71         try {
  72             var index = Files.find(webrev, 5, (path, attrs) -&gt; path.toString().endsWith(&quot;index.html&quot;)).findAny();
  73             if (index.isEmpty()) {
  74                 return false;
  75             }
  76             var lines = Files.readString(index.get(), StandardCharsets.UTF_8);
  77             return lines.contains(text);
  78         } catch (IOException e) {
  79             return false;
  80         }
  81     }
  82 
  83     private long countSubstrings(String string, String substring) {
  84         return Pattern.compile(substring).matcher(string).results().count();
  85     }
  86 
  87     @Test
  88     void simpleArchive(TestInfo testInfo) throws IOException {
  89         try (var credentials = new HostCredentials(testInfo);
  90              var tempFolder = new TemporaryDirectory();
  91              var archiveFolder = new TemporaryDirectory();
  92              var webrevFolder = new TemporaryDirectory();
  93              var listServer = new TestMailmanServer()) {
  94             var author = credentials.getHostedRepository();
  95             var archive = credentials.getHostedRepository();
  96             var ignored = credentials.getHostedRepository();
  97             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
  98             var censusBuilder = credentials.getCensusBuilder()
  99                                            .addAuthor(author.host().getCurrentUserDetails().id());
 100             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 101             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,
 102                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 103                                                  Set.of(),
 104                                                  listServer.getArchive(), listServer.getSMTP(),
 105                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 106                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 107                                                  Set.of(&quot;rfr&quot;), Map.of(ignored.host().getCurrentUserDetails().userName(),
 108                                                                        Pattern.compile(&quot;ready&quot;)));
 109 
 110             // Populate the projects repository
 111             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
 112             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 113             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 114             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 115 
 116             // Make a change with a corresponding PR
 117             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 118                                                                &quot;Change msg\n\nWith several lines&quot;);
 119             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 120             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 121             pr.setBody(&quot;This should not be ready&quot;);
 122 
 123             // Run an archive pass
 124             TestBotRunner.runPeriodicItems(mlBot);
 125 
 126             // A PR that isn&#39;t ready for review should not be archived
 127             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 128             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 129 
 130             // Flag it as ready for review
 131             pr.setBody(&quot;This should now be ready&quot;);
 132             pr.addLabel(&quot;rfr&quot;);
 133 
 134             // Run another archive pass
 135             TestBotRunner.runPeriodicItems(mlBot);
 136 
 137             // But it should still not be archived
 138             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 139             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 140 
 141             // Now post a general comment - not a ready marker
 142             var ignoredPr = ignored.getPullRequest(pr.getId());
 143             ignoredPr.addComment(&quot;hello there&quot;);
 144 
 145             // Run another archive pass
 146             TestBotRunner.runPeriodicItems(mlBot);
 147 
 148             // It should still not be archived
 149             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 150             assertFalse(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 151 
 152             // Now post a ready comment
 153             ignoredPr.addComment(&quot;ready&quot;);
 154 
 155             // Run another archive pass
 156             TestBotRunner.runPeriodicItems(mlBot);
 157 
 158             // The archive should now contain an entry
 159             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 160             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 161             assertTrue(archiveContains(archiveFolder.path(), &quot;This should now be ready&quot;));
 162             assertTrue(archiveContains(archiveFolder.path(), &quot;Patch:&quot;));
 163             assertTrue(archiveContains(archiveFolder.path(), &quot;Pull request:&quot;));
 164             assertTrue(archiveContains(archiveFolder.path(), &quot;Webrev:&quot;));
 165             assertTrue(archiveContains(archiveFolder.path(), &quot;http://www.test.test/&quot;));
 166             assertTrue(archiveContains(archiveFolder.path(), &quot;webrev.00&quot;));
 167             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch command:&quot;));
 168             assertTrue(archiveContains(archiveFolder.path(), &quot;^ - &quot; + editHash.abbreviate() + &quot;:\tChange msg&quot;));
 169             assertTrue(archiveContains(archiveFolder.path(), &quot;^\t\t\tWith several lines&quot;));
 170 
 171             // The mailing list as well
 172             listServer.processIncoming();
 173             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 174             var mailmanList = mailmanServer.getList(listAddress.address());
 175             var conversations = mailmanList.conversations(Duration.ofDays(1));
 176             assertEquals(1, conversations.size());
 177             var mail = conversations.get(0).first();
 178             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 179             assertEquals(pr.getAuthor().fullName() + &quot; via &quot; + pr.repository().getUrl().getHost(), mail.author().fullName().orElseThrow());
 180             assertEquals(from.address(), mail.author().address());
 181             assertEquals(from, mail.sender());
 182 
 183             // And there should be a webrev
 184             Repository.materialize(webrevFolder.path(), archive.getUrl(), &quot;webrev&quot;);
 185             assertTrue(webrevContains(webrevFolder.path(), &quot;1 lines changed&quot;));
 186             var comments = pr.getComments();
 187             var webrevComments = comments.stream()
 188                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 189                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 190                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 191                                          .collect(Collectors.toList());
 192             assertEquals(1, webrevComments.size());
 193 
 194             // Add a comment
 195             pr.addComment(&quot;This is a comment&quot;);
 196 
 197             // Add a comment from an ignored user as well
 198             ignoredPr.addComment(&quot;Don&#39;t mind me&quot;);
 199 
 200             // Run another archive pass
 201             TestBotRunner.runPeriodicItems(mlBot);
 202 
 203             // The archive should now contain the comment, but not the ignored one
 204             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 205             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a comment&quot;));
 206             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This should now be ready&quot;));
 207             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 208 
 209             listServer.processIncoming();
 210             conversations = mailmanList.conversations(Duration.ofDays(1));
 211             assertEquals(1, conversations.size());
 212             assertEquals(2, conversations.get(0).allMessages().size());
 213 
 214             // Remove the rfr flag and post another comment
 215             pr.addLabel(&quot;rfr&quot;);
 216             pr.addComment(&quot;This is another comment&quot;);
 217 
 218             // Run another archive pass
 219             TestBotRunner.runPeriodicItems(mlBot);
 220 
 221             // The archive should contain the additional comment
 222             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 223             assertTrue(archiveContains(archiveFolder.path(), &quot;This is another comment&quot;));
 224             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This should now be ready&quot;));
 225 
 226             listServer.processIncoming();
 227             conversations = mailmanList.conversations(Duration.ofDays(1));
 228             assertEquals(1, conversations.size());
 229             assertEquals(3, conversations.get(0).allMessages().size());
 230             for (var newMail : conversations.get(0).allMessages()) {
 231                 assertEquals(from.address(), newMail.author().address());
 232                 assertEquals(from, newMail.sender());
 233             }
 234         }
 235     }
 236 
 237     @Test
 238     void reviewComment(TestInfo testInfo) throws IOException {
 239         try (var credentials = new HostCredentials(testInfo);
 240              var tempFolder = new TemporaryDirectory();
 241              var archiveFolder = new TemporaryDirectory();
 242              var listServer = new TestMailmanServer()) {
 243             var author = credentials.getHostedRepository();
 244             var archive = credentials.getHostedRepository();
 245             var ignored = credentials.getHostedRepository();
 246             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 247             var censusBuilder = credentials.getCensusBuilder()
 248                                            .addAuthor(author.host().getCurrentUserDetails().id());
 249             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 250             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;, listAddress,
 251                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 252                                                  Set.of(),
 253                                                  listServer.getArchive(), listServer.getSMTP(),
 254                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 255                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 256                                                  Set.of(), Map.of());
 257 
 258             // Populate the projects repository
 259             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 260             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 261             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 262             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 263             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 264 
 265             // Make a change with a corresponding PR
 266             var editHash = CheckableRepository.appendAndCommit(localRepo);
 267             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 268             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 269             pr.setBody(&quot;This is now ready&quot;);
 270             TestBotRunner.runPeriodicItems(mlBot);
 271             listServer.processIncoming();
 272 
 273             // And make a file specific comment
 274             var currentMaster = localRepo.resolve(&quot;master&quot;).orElseThrow();
 275             var comment = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 276 
 277             // Add one from an ignored user as well
 278             var ignoredPr = ignored.getPullRequest(pr.getId());
 279             ignoredPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Don&#39;t mind me&quot;);
 280 
 281             // Process comments
 282             TestBotRunner.runPeriodicItems(mlBot);
 283             listServer.processIncoming();
 284 
 285             // The archive should now contain an entry
 286             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 287             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a pull request&quot;));
 288             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 289             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 290             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt; This is now ready&quot;));
 291             assertTrue(archiveContains(archiveFolder.path(), reviewFile.toString()));
 292             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
 293 
 294             // The mailing list as well
 295             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 296             var mailmanList = mailmanServer.getList(listAddress.address());
 297             var conversations = mailmanList.conversations(Duration.ofDays(1));
 298             assertEquals(1, conversations.size());
 299             var mail = conversations.get(0).first();
 300             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 301 
 302             // Comment on the comment
 303             pr.addReviewCommentReply(comment, &quot;This is a review reply&quot;);
 304             TestBotRunner.runPeriodicItems(mlBot);
 305             listServer.processIncoming();
 306 
 307             // The archive should contain the additional comment
 308             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 309             assertTrue(archiveContains(archiveFolder.path(), &quot;This is a review reply&quot;));
 310             assertTrue(archiveContains(archiveFolder.path(), &quot;&gt;&gt; This is now ready&quot;));
 311 
 312             // As well as the mailing list
 313             conversations = mailmanList.conversations(Duration.ofDays(1));
 314             assertEquals(1, conversations.size());
 315             assertEquals(3, conversations.get(0).allMessages().size());
 316             for (var newMail : conversations.get(0).allMessages()) {
 317                 assertEquals(from.address(), newMail.author().address());
 318                 assertEquals(from, newMail.sender());
 319             }
 320         }
 321     }
 322 
 323     @Test
 324     void combineComments(TestInfo testInfo) throws IOException {
 325         try (var credentials = new HostCredentials(testInfo);
 326              var tempFolder = new TemporaryDirectory();
 327              var archiveFolder = new TemporaryDirectory();
 328              var listServer = new TestMailmanServer()) {
 329             var author = credentials.getHostedRepository();
 330             var archive = credentials.getHostedRepository();
 331             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 332             var censusBuilder = credentials.getCensusBuilder()
 333                                            .addAuthor(author.host().getCurrentUserDetails().id());
 334             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 335             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 336                                                  listAddress, Set.of(), Set.of(),
 337                                                  listServer.getArchive(),
 338                                                  listServer.getSMTP(),
 339                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 340                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 341                                                  Set.of(), Map.of());
 342 
 343             // Populate the projects repository
 344             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 345             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 346             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 347             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 348             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 349 
 350             // Make a change with a corresponding PR
 351             var editHash = CheckableRepository.appendAndCommit(localRepo);
 352             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 353             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 354             pr.setBody(&quot;This is now ready&quot;);
 355             TestBotRunner.runPeriodicItems(mlBot);
 356             listServer.processIncoming();
 357 
 358             // Make two file specific comments
 359             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 360             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 361             TestBotRunner.runPeriodicItems(mlBot);
 362             listServer.processIncoming();
 363 
 364             // The archive should contain a combined entry
 365             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 366             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 367 
 368             // As well as the mailing list
 369             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 370             var mailmanList = mailmanServer.getList(listAddress.address());
 371             var conversations = mailmanList.conversations(Duration.ofDays(1));
 372             assertEquals(1, conversations.size());
 373             var mail = conversations.get(0).first();
 374             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 375             assertEquals(2, conversations.get(0).allMessages().size());
 376 
 377             var reply = conversations.get(0).replies(mail).get(0);
 378             assertEquals(2, reply.body().split(&quot;^On.*wrote:&quot;).length);
 379             assertEquals(2, reply.body().split(&quot;&gt; This is now ready&quot;).length, reply.body());
 380             assertEquals(&quot;Re: RFR: This is a pull request&quot;, reply.subject());
 381             assertTrue(reply.body().contains(&quot;Review comment\n\n&quot;), reply.body());
 382             assertTrue(reply.body().contains(&quot;Another review comment&quot;), reply.body());
 383         }
 384     }
 385 
 386     @Test
 387     void commentThreading(TestInfo testInfo) throws IOException {
 388         try (var credentials = new HostCredentials(testInfo);
 389              var tempFolder = new TemporaryDirectory();
 390              var archiveFolder = new TemporaryDirectory();
 391              var listServer = new TestMailmanServer()) {
 392             var author = credentials.getHostedRepository();
 393             var reviewer = credentials.getHostedRepository();
 394             var archive = credentials.getHostedRepository();
 395             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 396             var censusBuilder = credentials.getCensusBuilder()
 397                                            .addReviewer(reviewer.host().getCurrentUserDetails().id())
 398                                            .addAuthor(author.host().getCurrentUserDetails().id());
 399             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 400             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 401                                                  listAddress, Set.of(), Set.of(),
 402                                                  listServer.getArchive(),
 403                                                  listServer.getSMTP(),
 404                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 405                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 406                                                  Set.of(), Map.of());
 407 
 408             // Populate the projects repository
 409             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 410             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 411             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 412             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 413             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 414 
 415             // Make a change with a corresponding PR
 416             var editHash = CheckableRepository.appendAndCommit(localRepo);
 417             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 418             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 419             pr.setBody(&quot;This is now ready&quot;);
 420             TestBotRunner.runPeriodicItems(mlBot);
 421             listServer.processIncoming();
 422 
 423             // Make a file specific comment
 424             var reviewPr = reviewer.getPullRequest(pr.getId());
 425             var comment1 = reviewPr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 426             pr.addReviewCommentReply(comment1, &quot;I agree&quot;);
 427             reviewPr.addReviewCommentReply(comment1, &quot;Great&quot;);
 428             TestBotRunner.runPeriodicItems(mlBot);
 429             listServer.processIncoming();
 430             listServer.processIncoming();
 431             listServer.processIncoming();
 432 
 433             // And a second one by ourselves
 434             var comment2 = pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Another review comment&quot;);
 435             reviewPr.addReviewCommentReply(comment2, &quot;Sounds good&quot;);
 436             pr.addReviewCommentReply(comment2, &quot;Thanks&quot;);
 437             TestBotRunner.runPeriodicItems(mlBot);
 438             listServer.processIncoming();
 439             listServer.processIncoming();
 440             listServer.processIncoming();
 441 
 442             // Sanity check the archive
 443             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 444             assertEquals(6, archiveContainsCount(archiveFolder.path(), &quot;^On.*wrote:&quot;));
 445 
 446             // Check the mailing list
 447             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 448             var mailmanList = mailmanServer.getList(listAddress.address());
 449             var conversations = mailmanList.conversations(Duration.ofDays(1));
 450             assertEquals(1, conversations.size());
 451             var mail = conversations.get(0).first();
 452             assertEquals(&quot;RFR: This is a pull request&quot;, mail.subject());
 453             assertEquals(7, conversations.get(0).allMessages().size());
 454 
 455             // There should be two separate threads
 456             var thread1 = conversations.get(0).replies(mail).get(0);
 457             assertEquals(2, thread1.body().split(&quot;^On.*wrote:&quot;).length);
 458             assertEquals(2, thread1.body().split(&quot;&gt; This is now ready&quot;).length, thread1.body());
 459             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread1.subject());
 460             assertTrue(thread1.body().contains(&quot;Review comment\n\n&quot;), thread1.body());
 461             assertFalse(thread1.body().contains(&quot;Another review comment&quot;), thread1.body());
 462             var thread1reply1 = conversations.get(0).replies(thread1).get(0);
 463             assertTrue(thread1reply1.body().contains(&quot;I agree&quot;));
 464             var thread1reply2 = conversations.get(0).replies(thread1reply1).get(0);
 465             assertTrue(thread1reply2.body().contains(&quot;Great&quot;));
 466 
 467             var thread2 = conversations.get(0).replies(mail).get(1);
 468             assertEquals(2, thread2.body().split(&quot;^On.*wrote:&quot;).length);
 469             assertEquals(2, thread2.body().split(&quot;&gt; This is now ready&quot;).length, thread2.body());
 470             assertEquals(&quot;Re: RFR: This is a pull request&quot;, thread2.subject());
 471             assertFalse(thread2.body().contains(&quot;Review comment\n\n&quot;), thread2.body());
 472             assertTrue(thread2.body().contains(&quot;Another review comment&quot;), thread2.body());
 473             var thread2reply1 = conversations.get(0).replies(thread2).get(0);
 474             assertTrue(thread2reply1.body().contains(&quot;Sounds good&quot;));
 475             var thread2reply2 = conversations.get(0).replies(thread2reply1).get(0);
 476             assertTrue(thread2reply2.body().contains(&quot;Thanks&quot;));
 477         }
 478     }
 479 
 480     @Test
 481     void reviewContext(TestInfo testInfo) throws IOException {
 482         try (var credentials = new HostCredentials(testInfo);
 483              var tempFolder = new TemporaryDirectory();
 484              var archiveFolder = new TemporaryDirectory();
 485              var listServer = new TestMailmanServer()) {
 486             var author = credentials.getHostedRepository();
 487             var archive = credentials.getHostedRepository();
 488             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 489             var censusBuilder = credentials.getCensusBuilder()
 490                                            .addAuthor(author.host().getCurrentUserDetails().id());
 491             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 492             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 493                                                  listAddress, Set.of(), Set.of(),
 494                                                  listServer.getArchive(),
 495                                                  listServer.getSMTP(),
 496                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 497                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 498                                                  Set.of(), Map.of());
 499 
 500             // Populate the projects repository
 501             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 502             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 503             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 504             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 505             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 506 
 507             // Make a change with a corresponding PR
 508             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Line 1\nLine 2\nLine 3\nLine 4&quot;);
 509             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 510             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 511             pr.setBody(&quot;This is now ready&quot;);
 512             TestBotRunner.runPeriodicItems(mlBot);
 513             listServer.processIncoming();
 514 
 515             // Make a file specific comment
 516             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment&quot;);
 517 
 518             TestBotRunner.runPeriodicItems(mlBot);
 519             listServer.processIncoming();
 520 
 521             // The archive should only contain context around line 2
 522             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 523             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 2: Line 1$&quot;));
 524             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 3: Line 2$&quot;));
 525             assertFalse(archiveContains(archiveFolder.path(), &quot;^&gt; 4: Line 3$&quot;));
 526         }
 527     }
 528 
 529     @Test
 530     void multipleReviewContexts(TestInfo testInfo) throws IOException {
 531         try (var credentials = new HostCredentials(testInfo);
 532              var tempFolder = new TemporaryDirectory();
 533              var archiveFolder = new TemporaryDirectory();
 534              var listServer = new TestMailmanServer()) {
 535             var author = credentials.getHostedRepository();
 536             var archive = credentials.getHostedRepository();
 537             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 538             var censusBuilder = credentials.getCensusBuilder()
 539                                            .addAuthor(author.host().getCurrentUserDetails().id());
 540             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 541             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 542                                                  listAddress, Set.of(), Set.of(),
 543                                                  listServer.getArchive(),
 544                                                  listServer.getSMTP(),
 545                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 546                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 547                                                  Set.of(), Map.of());
 548 
 549             // Populate the projects repository
 550             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 551             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 552             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 553             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 554             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 555             var initialHash = CheckableRepository.appendAndCommit(localRepo,
 556                                                                   &quot;Line 0.1\nLine 0.2\nLine 0.3\nLine 0.4\n&quot; +
 557                                                                           &quot;Line 1\nLine 2\nLine 3\nLine 4\n&quot; +
 558                                                                           &quot;Line 5\nLine 6\nLine 7\nLine 8\n&quot; +
 559                                                                           &quot;Line 8.1\nLine 8.2\nLine 8.3\nLine 8.4\n&quot; +
 560                                                                           &quot;Line 9\nLine 10\nLine 11\nLine 12\n&quot; +
 561                                                                           &quot;Line 13\nLine 14\nLine 15\nLine 16\n&quot;);
 562             localRepo.push(initialHash, author.getUrl(), &quot;master&quot;);
 563 
 564             // Make a change with a corresponding PR
 565             var current = Files.readString(localRepo.root().resolve(reviewFile), StandardCharsets.UTF_8);
 566             var updated = current.replaceAll(&quot;Line 2&quot;, &quot;Line 2 edit\nLine 2.5&quot;);
 567             updated = updated.replaceAll(&quot;Line 13&quot;, &quot;Line 12.5\nLine 13 edit&quot;);
 568             Files.writeString(localRepo.root().resolve(reviewFile), updated, StandardCharsets.UTF_8);
 569             var editHash = CheckableRepository.appendAndCommit(localRepo);
 570             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 571             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 572             pr.setBody(&quot;This is now ready&quot;);
 573             TestBotRunner.runPeriodicItems(mlBot);
 574             listServer.processIncoming();
 575 
 576             // Make file specific comments
 577             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 7, &quot;Review comment&quot;);
 578             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 24, &quot;Another review comment&quot;);
 579 
 580             TestBotRunner.runPeriodicItems(mlBot);
 581             listServer.processIncoming();
 582 
 583             // The archive should only contain context around line 2 and 20
 584             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 585             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 7&quot;));
 586             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 6: Line 1$&quot;));
 587             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 7: Line 2 edit$&quot;));
 588             assertFalse(archiveContains(archiveFolder.path(), &quot;Line 3&quot;));
 589 
 590             assertTrue(archiveContains(archiveFolder.path(), &quot;reviewfile.txt line 24&quot;));
 591             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 23: Line 12.5$&quot;));
 592             assertTrue(archiveContains(archiveFolder.path(), &quot;^&gt; 24: Line 13 edit$&quot;));
 593             assertFalse(archiveContains(archiveFolder.path(), &quot;^Line 15&quot;));
 594         }
 595     }
 596 
 597     @Test
 598     void filterComments(TestInfo testInfo) throws IOException {
 599         try (var credentials = new HostCredentials(testInfo);
 600              var tempFolder = new TemporaryDirectory();
 601              var archiveFolder = new TemporaryDirectory();
 602              var listServer = new TestMailmanServer()) {
 603             var author = credentials.getHostedRepository();
 604             var archive = credentials.getHostedRepository();
 605             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 606             var censusBuilder = credentials.getCensusBuilder()
 607                                            .addAuthor(author.host().getCurrentUserDetails().id());
 608             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 609             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 610                                                  listAddress, Set.of(), Set.of(),
 611                                                  listServer.getArchive(), listServer.getSMTP(),
 612                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 613                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 614                                                  Set.of(), Map.of());
 615 
 616             // Populate the projects repository
 617             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 618             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 619             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 620             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 621             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 622 
 623             // Make a change with a corresponding PR
 624             var editHash = CheckableRepository.appendAndCommit(localRepo);
 625             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 626             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 627             pr.setBody(&quot;This is now ready\n&lt;!-- this is a comment --&gt;\nAnd this is not\n&quot; +
 628                                &quot;&lt;!-- Anything below this marker will be hidden --&gt;\nStatus stuff&quot;);
 629 
 630             // Make a bunch of comments
 631             pr.addComment(&quot;Plain comment\n&lt;!-- this is a comment --&gt;&quot;);
 632             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review comment &lt;!-- this is a comment --&gt;\n&quot;);
 633             pr.addComment(&quot;/integrate stuff&quot;);
 634             TestBotRunner.runPeriodicItems(mlBot);
 635 
 636             // Run an archive pass
 637             TestBotRunner.runPeriodicItems(mlBot);
 638 
 639             // The archive should not contain the comment
 640             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 641             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
 642             assertFalse(archiveContains(archiveFolder.path(), &quot;this is a comment&quot;));
 643             assertFalse(archiveContains(archiveFolder.path(), &quot;Status stuff&quot;));
 644             assertTrue(archiveContains(archiveFolder.path(), &quot;And this is not&quot;));
 645             assertFalse(archiveContains(archiveFolder.path(), &quot;&lt;!--&quot;));
 646             assertFalse(archiveContains(archiveFolder.path(), &quot;--&gt;&quot;));
 647             assertTrue(archiveContains(archiveFolder.path(), &quot;Plain comment&quot;));
 648             assertTrue(archiveContains(archiveFolder.path(), &quot;Review comment&quot;));
 649             assertFalse(archiveContains(archiveFolder.path(), &quot;/integrate&quot;));
 650         }
 651     }
 652 
 653     @Test
 654     void incrementalChanges(TestInfo testInfo) throws IOException {
 655         try (var credentials = new HostCredentials(testInfo);
 656              var tempFolder = new TemporaryDirectory();
 657              var archiveFolder = new TemporaryDirectory();
 658              var listServer = new TestMailmanServer()) {
 659             var author = credentials.getHostedRepository();
 660             var archive = credentials.getHostedRepository();
 661             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 662             var censusBuilder = credentials.getCensusBuilder()
 663                                            .addAuthor(author.host().getCurrentUserDetails().id());
 664             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 665             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 666                                                  listAddress, Set.of(), Set.of(),
 667                                                  listServer.getArchive(), listServer.getSMTP(),
 668                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 669                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 670                                                  Set.of(), Map.of());
 671 
 672             // Populate the projects repository
 673             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 674             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 675             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 676             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 677             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 678 
 679             // Make a change with a corresponding PR
 680             var editHash = CheckableRepository.appendAndCommit(localRepo);
 681             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 682             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 683             pr.setBody(&quot;This is now ready&quot;);
 684 
 685             // Run an archive pass
 686             TestBotRunner.runPeriodicItems(mlBot);
 687             listServer.processIncoming();
 688 
 689             var nextHash = CheckableRepository.appendAndCommit(localRepo, &quot;Yet one more line&quot;, &quot;Fixing&quot;);
 690             localRepo.push(nextHash, author.getUrl(), &quot;edit&quot;);
 691 
 692             // Make sure that the push registered
 693             var lastHeadHash = pr.getHeadHash();
 694             var refreshCount = 0;
 695             do {
 696                 pr = author.getPullRequest(pr.getId());
 697                 if (refreshCount++ &gt; 100) {
 698                     fail(&quot;The PR did not update after the new push&quot;);
 699                 }
 700             } while (pr.getHeadHash().equals(lastHeadHash));
 701 
 702             // Run another archive pass
 703             TestBotRunner.runPeriodicItems(mlBot);
 704             TestBotRunner.runPeriodicItems(mlBot);
 705             TestBotRunner.runPeriodicItems(mlBot);
 706             listServer.processIncoming();
 707 
 708             // The archive should reference the updated push
 709             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 710             assertTrue(archiveContains(archiveFolder.path(), &quot;additional changes&quot;));
 711             assertTrue(archiveContains(archiveFolder.path(), &quot;full.*/&quot; + pr.getId() + &quot;/webrev.01&quot;));
 712             assertTrue(archiveContains(archiveFolder.path(), &quot;inc.*/&quot; + pr.getId() + &quot;/webrev.00-01&quot;));
 713             assertTrue(archiveContains(archiveFolder.path(), &quot;Updated full patch&quot;));
 714             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
 715             assertTrue(archiveContains(archiveFolder.path(), &quot;Fixing&quot;));
 716 
 717             // The webrev comment should be updated
 718             var comments = pr.getComments();
 719             var webrevComments = comments.stream()
 720                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 721                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 722                                          .filter(comment -&gt; comment.body().contains(nextHash.hex()))
 723                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 724                                          .collect(Collectors.toList());
 725             assertEquals(1, webrevComments.size());
 726 
 727             // Check that sender address is set properly
 728             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 729             var mailmanList = mailmanServer.getList(listAddress.address());
 730             var conversations = mailmanList.conversations(Duration.ofDays(1));
 731             assertEquals(1, conversations.size());
 732             for (var newMail : conversations.get(0).allMessages()) {
 733                 assertEquals(from.address(), newMail.author().address());
 734                 assertEquals(from, newMail.sender());
 735             }
 736 
 737             // Ensure that additional updates are only reported once
 738             for (int i = 0; i &lt; 3; ++i) {
 739                 var anotherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fixing&quot;);
 740                 localRepo.push(anotherHash, author.getUrl(), &quot;edit&quot;);
 741 
 742                 // Make sure that the push registered
 743                 lastHeadHash = pr.getHeadHash();
 744                 refreshCount = 0;
 745                 do {
 746                     pr = author.getPullRequest(pr.getId());
 747                     if (refreshCount++ &gt; 100) {
 748                         fail(&quot;The PR did not update after the new push&quot;);
 749                     }
 750                 } while (pr.getHeadHash().equals(lastHeadHash));
 751 
 752                 TestBotRunner.runPeriodicItems(mlBot);
 753                 TestBotRunner.runPeriodicItems(mlBot);
 754                 listServer.processIncoming();
 755             }
 756             var updatedConversations = mailmanList.conversations(Duration.ofDays(1));
 757             assertEquals(1, updatedConversations.size());
 758             var conversation = updatedConversations.get(0);
 759             assertEquals(5, conversation.allMessages().size());
 760         }
 761     }
 762 
 763     @Test
 764     void rebased(TestInfo testInfo) throws IOException {
 765         try (var credentials = new HostCredentials(testInfo);
 766              var tempFolder = new TemporaryDirectory();
 767              var archiveFolder = new TemporaryDirectory();
 768              var listServer = new TestMailmanServer()) {
 769             var author = credentials.getHostedRepository();
 770             var archive = credentials.getHostedRepository();
 771             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 772             var censusBuilder = credentials.getCensusBuilder()
 773                                            .addAuthor(author.host().getCurrentUserDetails().id());
 774             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 775             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 776                                                  listAddress, Set.of(), Set.of(),
 777                                                  listServer.getArchive(), listServer.getSMTP(),
 778                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 779                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 780                                                  Set.of(), Map.of());
 781 
 782             // Populate the projects repository
 783             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 784             var localRepo = CheckableRepository.init(tempFolder.path().resolve(&quot;first&quot;), author.getRepositoryType(), reviewFile);
 785             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 786             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 787             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 788 
 789             // Make a change with a corresponding PR
 790             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A line&quot;, &quot;Original msg&quot;);
 791             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 792             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 793             pr.setBody(&quot;This is now ready&quot;);
 794 
 795             // Run an archive pass
 796             TestBotRunner.runPeriodicItems(mlBot);
 797             listServer.processIncoming();
 798 
 799             var newLocalRepo = Repository.materialize(tempFolder.path().resolve(&quot;second&quot;), author.getUrl(), &quot;master&quot;);
 800             var newEditHash = CheckableRepository.appendAndCommit(newLocalRepo, &quot;Another line&quot;, &quot;Replaced msg&quot;);
 801             newLocalRepo.push(newEditHash, author.getUrl(), &quot;edit&quot;, true);
 802 
 803             // Make sure that the push registered
 804             var lastHeadHash = pr.getHeadHash();
 805             var refreshCount = 0;
 806             do {
 807                 pr = author.getPullRequest(pr.getId());
 808                 if (refreshCount++ &gt; 100) {
 809                     fail(&quot;The PR did not update after the new push&quot;);
 810                 }
 811             } while (pr.getHeadHash().equals(lastHeadHash));
 812 
 813             // Run another archive pass
 814             TestBotRunner.runPeriodicItems(mlBot);
 815             listServer.processIncoming();
 816 
 817             // The archive should reference the rebased push
 818             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 819             assertTrue(archiveContains(archiveFolder.path(), &quot;complete new set of changes&quot;));
 820             assertTrue(archiveContains(archiveFolder.path(), pr.getId() + &quot;/webrev.01&quot;));
 821             assertFalse(archiveContains(archiveFolder.path(), &quot;Incremental&quot;));
 822             assertTrue(archiveContains(archiveFolder.path(), &quot;Updated full patch&quot;));
 823             assertTrue(archiveContains(archiveFolder.path(), &quot;Fetch&quot;));
 824             assertTrue(archiveContains(archiveFolder.path(), &quot;Original msg&quot;));
 825             assertTrue(archiveContains(archiveFolder.path(), &quot;Replaced msg&quot;));
 826 
 827             // The webrev comment should be updated
 828             var comments = pr.getComments();
 829             var webrevComments = comments.stream()
 830                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 831                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 832                                          .filter(comment -&gt; comment.body().contains(newEditHash.hex()))
 833                                          .collect(Collectors.toList());
 834             assertEquals(1, webrevComments.size());
 835 
 836             // Check that sender address is set properly
 837             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP());
 838             var mailmanList = mailmanServer.getList(listAddress.address());
 839             var conversations = mailmanList.conversations(Duration.ofDays(1));
 840             assertEquals(1, conversations.size());
 841             for (var newMail : conversations.get(0).allMessages()) {
 842                 assertEquals(from.address(), newMail.author().address());
 843                 assertEquals(from, newMail.sender());
 844             }
 845         }
 846     }
 847 
 848     @Test
 849     void skipAddingExistingWebrev(TestInfo testInfo) throws IOException {
 850         try (var credentials = new HostCredentials(testInfo);
 851              var tempFolder = new TemporaryDirectory();
 852              var archiveFolder = new TemporaryDirectory();
 853              var webrevFolder = new TemporaryDirectory();
 854              var listServer = new TestMailmanServer()) {
 855             var author = credentials.getHostedRepository();
 856             var archive = credentials.getHostedRepository();
 857             var ignored = credentials.getHostedRepository();
 858             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 859             var censusBuilder = credentials.getCensusBuilder()
 860                                            .addAuthor(author.host().getCurrentUserDetails().id());
 861             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 862             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 863                                                  listAddress,
 864                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
 865                                                  Set.of(),
 866                                                  listServer.getArchive(), listServer.getSMTP(),
 867                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 868                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 869                                                  Set.of(), Map.of());
 870 
 871             // Populate the projects repository
 872             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType());
 873             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 874             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 875             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 876 
 877             // Make a change with a corresponding PR
 878             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;A simple change&quot;,
 879                                                                &quot;Change msg\n\nWith several lines&quot;);
 880             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 881             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 882 
 883             // Flag it as ready for review
 884             pr.setBody(&quot;This should now be ready&quot;);
 885 
 886             // Run an archive pass
 887             TestBotRunner.runPeriodicItems(mlBot);
 888 
 889             // The archive should now contain an entry
 890             var archiveRepo = Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 891             assertTrue(archiveContains(archiveFolder.path(), editHash.abbreviate()));
 892 
 893             // And there should be a webrev comment
 894             var comments = pr.getComments();
 895             var webrevComments = comments.stream()
 896                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 897                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 898                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 899                                          .collect(Collectors.toList());
 900             assertEquals(1, webrevComments.size());
 901             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
 902 
 903             // Pretend the archive didn&#39;t work out
 904             archiveRepo.push(masterHash, archive.getUrl(), &quot;master&quot;, true);
 905 
 906             // Run another archive pass
 907             TestBotRunner.runPeriodicItems(mlBot);
 908 
 909             // The webrev comment should not contain duplicate entries
 910             comments = pr.getComments();
 911             webrevComments = comments.stream()
 912                                          .filter(comment -&gt; comment.author().equals(author.host().getCurrentUserDetails()))
 913                                          .filter(comment -&gt; comment.body().contains(&quot;webrev&quot;))
 914                                          .filter(comment -&gt; comment.body().contains(editHash.hex()))
 915                                          .collect(Collectors.toList());
 916             assertEquals(1, webrevComments.size());
 917             assertEquals(1, countSubstrings(webrevComments.get(0).body(), &quot;webrev.00&quot;));
 918         }
 919     }
 920 
 921     @Test
 922     void notifyReviewVerdicts(TestInfo testInfo) throws IOException {
 923         try (var credentials = new HostCredentials(testInfo);
 924              var tempFolder = new TemporaryDirectory();
 925              var archiveFolder = new TemporaryDirectory();
 926              var listServer = new TestMailmanServer()) {
 927             var author = credentials.getHostedRepository();
 928             var archive = credentials.getHostedRepository();
 929             var reviewer = credentials.getHostedRepository();
 930             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 931             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
 932             var censusBuilder = credentials.getCensusBuilder()
 933                                            .addReviewer(reviewer.host().getCurrentUserDetails().id())
 934                                            .addAuthor(author.host().getCurrentUserDetails().id());
 935             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
 936                                                  listAddress, Set.of(), Set.of(),
 937                                                  listServer.getArchive(), listServer.getSMTP(),
 938                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
 939                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
 940                                                  Set.of(), Map.of());
 941 
 942             // Populate the projects repository
 943             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
 944             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
 945             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 946             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
 947             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
 948 
 949             // Make a change with a corresponding PR
 950             var editHash = CheckableRepository.appendAndCommit(localRepo);
 951             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
 952             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
 953             pr.setBody(&quot;This is now ready&quot;);
 954 
 955             // Run an archive pass
 956             TestBotRunner.runPeriodicItems(mlBot);
 957 
 958             // First unapprove it
 959             var reviewedPr = reviewer.getPullRequest(pr.getId());
 960             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 1&quot;);
 961             TestBotRunner.runPeriodicItems(mlBot);
 962             TestBotRunner.runPeriodicItems(mlBot);
 963             TestBotRunner.runPeriodicItems(mlBot);
 964 
 965             // The archive should contain a note
 966             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 967             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Review status set to Disapproved&quot;));
 968             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot; by integrationreviewer1&quot;));
 969             if (author.host().supportsReviewBody()) {
 970                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 1&quot;));
 971             }
 972 
 973             // Then approve it
 974             reviewedPr.addReview(Review.Verdict.APPROVED, &quot;Reason 2&quot;);
 975             TestBotRunner.runPeriodicItems(mlBot);
 976             TestBotRunner.runPeriodicItems(mlBot);
 977             TestBotRunner.runPeriodicItems(mlBot);
 978 
 979             // The archive should contain another note
 980             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 981             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Review status set to Approved&quot;));
 982             if (author.host().supportsReviewBody()) {
 983                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 2&quot;));
 984             }
 985             assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;This PR has been marked as Reviewed by integrationreviewer1.&quot;));
 986 
 987             // Yet another change
 988             reviewedPr.addReview(Review.Verdict.DISAPPROVED, &quot;Reason 3&quot;);
 989             TestBotRunner.runPeriodicItems(mlBot);
 990             TestBotRunner.runPeriodicItems(mlBot);
 991             TestBotRunner.runPeriodicItems(mlBot);
 992 
 993             // The archive should contain another note
 994             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
 995             assertEquals(2, archiveContainsCount(archiveFolder.path(), &quot;Review status set to Disapproved&quot;));
 996             if (author.host().supportsReviewBody()) {
 997                 assertEquals(1, archiveContainsCount(archiveFolder.path(), &quot;Reason 3&quot;));
 998             }
 999         }
1000     }
1001 
1002     @Test
1003     void ignoreComments(TestInfo testInfo) throws IOException {
1004         try (var credentials = new HostCredentials(testInfo);
1005              var tempFolder = new TemporaryDirectory();
1006              var archiveFolder = new TemporaryDirectory();
1007              var listServer = new TestMailmanServer()) {
1008             var author = credentials.getHostedRepository();
1009             var ignored = credentials.getHostedRepository();
1010             var archive = credentials.getHostedRepository();
1011             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1012             var censusBuilder = credentials.getCensusBuilder()
1013                                            .addAuthor(author.host().getCurrentUserDetails().id());
1014             var from = EmailAddress.from(&quot;test&quot;, &quot;test@test.mail&quot;);
1015             var mlBot = new MailingListBridgeBot(from, author, archive, censusBuilder.build(), &quot;master&quot;,
1016                                                  listAddress,
1017                                                  Set.of(ignored.host().getCurrentUserDetails().userName()),
1018                                                  Set.of(Pattern.compile(&quot;ignore this comment&quot;, Pattern.MULTILINE | Pattern.DOTALL)),
1019                                                  listServer.getArchive(), listServer.getSMTP(),
1020                                                  archive, &quot;webrev&quot;, Path.of(&quot;test&quot;),
1021                                                  URIBuilder.base(&quot;http://www.test.test/&quot;).build(),
1022                                                  Set.of(), Map.of());
1023 
1024             // Populate the projects repository
1025             var reviewFile = Path.of(&quot;reviewfile.txt&quot;);
1026             var localRepo = CheckableRepository.init(tempFolder.path(), author.getRepositoryType(), reviewFile);
1027             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1028             localRepo.push(masterHash, author.getUrl(), &quot;master&quot;, true);
1029             localRepo.push(masterHash, archive.getUrl(), &quot;webrev&quot;, true);
1030 
1031             // Make a change with a corresponding PR
1032             var editHash = CheckableRepository.appendAndCommit(localRepo);
1033             localRepo.push(editHash, author.getUrl(), &quot;edit&quot;, true);
1034             var pr = credentials.createPullRequest(archive, &quot;master&quot;, &quot;edit&quot;, &quot;This is a pull request&quot;);
1035             pr.setBody(&quot;This is now ready&quot;);
1036 
1037             // Make a bunch of comments
1038             pr.addComment(&quot;Plain comment&quot;);
1039             pr.addComment(&quot;ignore this comment&quot;);
1040             pr.addComment(&quot;I think it is time to\nignore this comment!&quot;);
1041             pr.addReviewComment(masterHash, editHash, reviewFile.toString(), 2, &quot;Review ignore this comment&quot;);
1042 
1043             var ignoredPR = ignored.getPullRequest(pr.getId());
1044             ignoredPR.addComment(&quot;Don&#39;t mind me&quot;);
1045 
1046             TestBotRunner.runPeriodicItems(mlBot);
1047             TestBotRunner.runPeriodicItems(mlBot);
1048 
1049             // The archive should not contain the ignored comments
1050             Repository.materialize(archiveFolder.path(), archive.getUrl(), &quot;master&quot;);
1051             assertTrue(archiveContains(archiveFolder.path(), &quot;This is now ready&quot;));
1052             assertFalse(archiveContains(archiveFolder.path(), &quot;ignore this comment&quot;));
1053             assertFalse(archiveContains(archiveFolder.path(), &quot;it is time to&quot;));
1054             assertFalse(archiveContains(archiveFolder.path(), &quot;Don&#39;t mind me&quot;));
1055             assertFalse(archiveContains(archiveFolder.path(), &quot;Review ignore&quot;));
1056         }
1057     }
1058 }
    </pre>
  </body>
</html>