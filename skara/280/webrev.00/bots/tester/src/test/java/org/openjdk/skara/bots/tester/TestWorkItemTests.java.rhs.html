<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames bots/tester/src/test/java/org/openjdk/skara/bots/tester/TestWorkItemTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.
  8  *
  9  * This code is distributed in the hope that it will be useful, but WITHOUT
 10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 12  * version 2 for more details (a copy is included in the LICENSE file that
 13  * accompanied this code).
 14  *
 15  * You should have received a copy of the GNU General Public License version
 16  * 2 along with this work; if not, write to the Free Software Foundation,
 17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 18  *
 19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 20  * or visit www.oracle.com if you need additional information or have any
 21  * questions.
 22  */
 23 package org.openjdk.skara.bots.tester;
 24 
 25 import org.openjdk.skara.forge.CheckStatus;
 26 import org.openjdk.skara.host.*;
 27 import org.openjdk.skara.issuetracker.Comment;
 28 import org.openjdk.skara.vcs.*;
 29 import org.openjdk.skara.test.*;
 30 import org.openjdk.skara.ci.Job;
 31 
 32 import java.io.*;
 33 import java.net.URI;
 34 import java.nio.file.*;
 35 import java.util.*;
 36 import java.time.ZonedDateTime;
 37 
 38 import org.junit.jupiter.api.Test;
 39 import static org.junit.jupiter.api.Assertions.*;
 40 
 41 class TestWorkItemTests {
 42     @Test
 43     void noTestCommentsShouldDoNothing() throws IOException {
 44         try (var tmp = new TemporaryDirectory()) {
 45             var ci = new InMemoryContinuousIntegration();
 46             var approvers = &quot;0&quot;;
 47             var available = List.of(&quot;tier1&quot;, &quot;tier2&quot;, &quot;tier3&quot;);
 48             var defaultJobs = List.of(&quot;tier1&quot;);
 49             var name = &quot;test&quot;;
 50             var storage = tmp.path().resolve(&quot;storage&quot;);
 51             var scratch = tmp.path().resolve(&quot;storage&quot;);
 52 
 53             var bot = new HostUser(1, &quot;bot&quot;, &quot;openjdk [bot]&quot;);
 54             var host = new InMemoryHost();
 55             host.currentUserDetails = bot;
 56 
 57             var repo = new InMemoryHostedRepository();
 58             repo.host = host;
 59 
 60             var pr = new InMemoryPullRequest();
 61             pr.repository = repo;
 62 
 63             var duke = new HostUser(0, &quot;duke&quot;, &quot;Duke&quot;);
 64             pr.author = duke;
 65             pr.comments = List.of();
 66 
 67             var item = new TestWorkItem(ci, approvers, available, defaultJobs, name, storage, pr);
 68             item.run(scratch);
 69 
 70             var comments = pr.comments();
 71             assertEquals(0, comments.size());
 72         }
 73     }
 74 
 75     @Test
 76     void topLevelTestApproveShouldDoNothing() throws IOException {
 77         try (var tmp = new TemporaryDirectory()) {
 78             var ci = new InMemoryContinuousIntegration();
 79             var approvers = &quot;0&quot;;
 80             var available = List.of(&quot;tier1&quot;, &quot;tier2&quot;, &quot;tier3&quot;);
 81             var defaultJobs = List.of(&quot;tier1&quot;);
 82             var name = &quot;test&quot;;
 83             var storage = tmp.path().resolve(&quot;storage&quot;);
 84             var scratch = tmp.path().resolve(&quot;storage&quot;);
 85 
 86             var bot = new HostUser(1, &quot;bot&quot;, &quot;openjdk [bot]&quot;);
 87             var host = new InMemoryHost();
 88             host.currentUserDetails = bot;
 89 
 90             var repo = new InMemoryHostedRepository();
 91             repo.host = host;
 92 
 93             var pr = new InMemoryPullRequest();
 94             pr.repository = repo;
 95 
 96             var duke = new HostUser(0, &quot;duke&quot;, &quot;Duke&quot;);
 97             var now = ZonedDateTime.now();
 98             pr.author = duke;
 99             var testApproveComment = new Comment(&quot;0&quot;, &quot;/test approve&quot;, duke, now, now);
100             pr.comments = List.of(testApproveComment);
101 
102             var item = new TestWorkItem(ci, approvers, available, defaultJobs, name, storage, pr);
103             item.run(scratch);
104 
105             var comments = pr.comments();
106             assertEquals(1, comments.size());
107             assertEquals(testApproveComment, comments.get(0));
108         }
109     }
110 
111     @Test
112     void topLevelTestCancelShouldDoNothing() throws IOException {
113         try (var tmp = new TemporaryDirectory()) {
114             var ci = new InMemoryContinuousIntegration();
115             var approvers = &quot;0&quot;;
116             var available = List.of(&quot;tier1&quot;, &quot;tier2&quot;, &quot;tier3&quot;);
117             var defaultJobs = List.of(&quot;tier1&quot;);
118             var name = &quot;test&quot;;
119             var storage = tmp.path().resolve(&quot;storage&quot;);
120             var scratch = tmp.path().resolve(&quot;storage&quot;);
121 
122             var bot = new HostUser(1, &quot;bot&quot;, &quot;openjdk [bot]&quot;);
123             var host = new InMemoryHost();
124             host.currentUserDetails = bot;
125 
126             var repo = new InMemoryHostedRepository();
127             repo.host = host;
128 
129             var pr = new InMemoryPullRequest();
130             pr.repository = repo;
131 
132             var duke = new HostUser(0, &quot;duke&quot;, &quot;Duke&quot;);
133             var now = ZonedDateTime.now();
134             pr.author = duke;
135             var testApproveComment = new Comment(&quot;0&quot;, &quot;/test cancel&quot;, duke, now, now);
136             pr.comments = List.of(testApproveComment);
137 
138             var item = new TestWorkItem(ci, approvers, available, defaultJobs, name, storage, pr);
139             item.run(scratch);
140 
141             var comments = pr.comments();
142             assertEquals(1, comments.size());
143             assertEquals(testApproveComment, comments.get(0));
144         }
145     }
146 
147     @Test
148     void testCommentWithMadeUpJobShouldBeError() throws IOException {
149         try (var tmp = new TemporaryDirectory()) {
150             var ci = new InMemoryContinuousIntegration();
151             var approvers = &quot;0&quot;;
152             var available = List.of(&quot;tier1&quot;, &quot;tier2&quot;, &quot;tier3&quot;);
153             var defaultJobs = List.of(&quot;tier1&quot;);
154             var name = &quot;test&quot;;
155             var storage = tmp.path().resolve(&quot;storage&quot;);
156             var scratch = tmp.path().resolve(&quot;storage&quot;);
157 
158             var bot = new HostUser(1, &quot;bot&quot;, &quot;openjdk [bot]&quot;);
159             var host = new InMemoryHost();
160             host.currentUserDetails = bot;
161             host.groups = Map.of(&quot;0&quot;, Set.of());
162 
163             var repo = new InMemoryHostedRepository();
164             repo.host = host;
165 
166             var pr = new InMemoryPullRequest();
167             pr.repository = repo;
168 
169             var duke = new HostUser(0, &quot;duke&quot;, &quot;Duke&quot;);
170             pr.author = duke;
171 
172             var now = ZonedDateTime.now();
173             var comment = new Comment(&quot;0&quot;, &quot;/test foobar&quot;, duke, now, now);
174             pr.comments = new ArrayList&lt;&gt;(List.of(comment));
175 
176             var item = new TestWorkItem(ci, approvers, available, defaultJobs, name, storage, pr);
177             item.run(scratch);
178 
179             var comments = pr.comments();
180             assertEquals(2, comments.size());
181             assertEquals(comment, comments.get(0));
182 
183             var secondComment = comments.get(1);
184             assertEquals(bot, secondComment.author());
185 
186             var lines = secondComment.body().split(&quot;\n&quot;);
187             assertEquals(2, lines.length);
188             assertEquals(&quot;&lt;!-- TEST ERROR --&gt;&quot;, lines[0]);
189             assertEquals(&quot;@duke the test group foobar does not exist&quot;, lines[1]);
190         }
191     }
192 
193     @Test
194     void testCommentFromUnapprovedUserShouldBePending() throws IOException {
195         try (var tmp = new TemporaryDirectory()) {
196             var ci = new InMemoryContinuousIntegration();
197             var approvers = &quot;0&quot;;
198             var available = List.of(&quot;tier1&quot;, &quot;tier2&quot;, &quot;tier3&quot;);
199             var defaultJobs = List.of(&quot;tier1&quot;);
200             var name = &quot;test&quot;;
201             var storage = tmp.path().resolve(&quot;storage&quot;);
202             var scratch = tmp.path().resolve(&quot;storage&quot;);
203 
204             var bot = new HostUser(1, &quot;bot&quot;, &quot;openjdk [bot]&quot;);
205             var host = new InMemoryHost();
206             host.currentUserDetails = bot;
207             host.groups = Map.of(&quot;0&quot;, Set.of());
208 
209             var repo = new InMemoryHostedRepository();
210             repo.host = host;
211 
212             var pr = new InMemoryPullRequest();
213             pr.repository = repo;
214 
215             var duke = new HostUser(0, &quot;duke&quot;, &quot;Duke&quot;);
216             pr.author = duke;
217             pr.headHash = new Hash(&quot;01234567890123456789012345789012345789&quot;);
218 
219             var now = ZonedDateTime.now();
220             var comment = new Comment(&quot;0&quot;, &quot;/test foobar&quot;, duke, now, now);
221             pr.comments = new ArrayList&lt;&gt;(List.of(comment));
222 
223             var item = new TestWorkItem(ci, approvers, available, defaultJobs, name, storage, pr);
224 
225             // Non-existing test group should result in error
226             item.run(scratch);
227 
228             var comments = pr.comments();
229             assertEquals(2, comments.size());
230             assertEquals(comment, comments.get(0));
231 
232             var secondComment = comments.get(1);
233             assertEquals(bot, secondComment.author());
234 
235             var lines = secondComment.body().split(&quot;\n&quot;);
236             assertEquals(2, lines.length);
237             assertEquals(&quot;&lt;!-- TEST ERROR --&gt;&quot;, lines[0]);
238             assertEquals(&quot;@duke the test group foobar does not exist&quot;, lines[1]);
239 
240             // Trying to test again should be fine
241             var thirdComment = new Comment(&quot;2&quot;, &quot;/test tier1&quot;, duke, now, now);
242             pr.comments.add(thirdComment);
243             item.run(scratch);
244 
245             comments = pr.comments();
246             assertEquals(4, comments.size());
247             assertEquals(comment, comments.get(0));
248             assertEquals(secondComment, comments.get(1));
249             assertEquals(thirdComment, comments.get(2));
250 
251             var fourthComment = comments.get(3);
252             assertEquals(bot, fourthComment.author());
253 
254             lines = fourthComment.body().split(&quot;\n&quot;);
255             assertEquals(&quot;&lt;!-- TEST PENDING --&gt;&quot;, lines[0]);
256             assertEquals(&quot;&lt;!-- 01234567890123456789012345789012345789 --&gt;&quot;, lines[1]);
257             assertEquals(&quot;&lt;!-- tier1 --&gt;&quot;, lines[2]);
258             assertEquals(&quot;@duke you need to get approval to run the tests in tier1 for commits up until 01234567&quot;,
259                          lines[3]);
260 
261             // Nothing should change if we run it yet again
262             item.run(scratch);
263 
264             comments = pr.comments();
265             assertEquals(4, comments.size());
266             assertEquals(comment, comments.get(0));
267             assertEquals(secondComment, comments.get(1));
268             assertEquals(thirdComment, comments.get(2));
269             assertEquals(fourthComment, comments.get(3));
270         }
271     }
272 
273     @Test
274     void cancelAtestCommentShouldBeCancel() throws IOException {
275         try (var tmp = new TemporaryDirectory()) {
276             var ci = new InMemoryContinuousIntegration();
277             var approvers = &quot;0&quot;;
278             var available = List.of(&quot;tier1&quot;, &quot;tier2&quot;, &quot;tier3&quot;);
279             var defaultJobs = List.of(&quot;tier1&quot;);
280             var name = &quot;test&quot;;
281             var storage = tmp.path().resolve(&quot;storage&quot;);
282             var scratch = tmp.path().resolve(&quot;storage&quot;);
283 
284             var bot = new HostUser(1, &quot;bot&quot;, &quot;openjdk [bot]&quot;);
285             var host = new InMemoryHost();
286             host.currentUserDetails = bot;
287             host.groups = Map.of(&quot;0&quot;, Set.of());
288 
289             var repo = new InMemoryHostedRepository();
290             repo.host = host;
291 
292             var pr = new InMemoryPullRequest();
293             pr.repository = repo;
294 
295             var duke = new HostUser(0, &quot;duke&quot;, &quot;Duke&quot;);
296             pr.author = duke;
297             pr.headHash = new Hash(&quot;01234567890123456789012345789012345789&quot;);
298 
299             var now = ZonedDateTime.now();
300             var testComment = new Comment(&quot;0&quot;, &quot;/test tier1&quot;, duke, now, now);
301             var cancelComment = new Comment(&quot;1&quot;, &quot;/test cancel&quot;, duke, now, now);
302             pr.comments = new ArrayList&lt;&gt;(List.of(testComment, cancelComment));
303 
304             var item = new TestWorkItem(ci, approvers, available, defaultJobs, name, storage, pr);
305 
306             item.run(scratch);
307 
308             var comments = pr.comments();
309             assertEquals(2, comments.size());
310             assertEquals(testComment, comments.get(0));
311             assertEquals(cancelComment, comments.get(1));
312         }
313     }
314 
315     @Test
316     void cancellingAPendingTestCommentShouldWork() throws IOException {
317         try (var tmp = new TemporaryDirectory()) {
318             var ci = new InMemoryContinuousIntegration();
319             var approvers = &quot;0&quot;;
320             var available = List.of(&quot;tier1&quot;, &quot;tier2&quot;, &quot;tier3&quot;);
321             var defaultJobs = List.of(&quot;tier1&quot;);
322             var name = &quot;test&quot;;
323             var storage = tmp.path().resolve(&quot;storage&quot;);
324             var scratch = tmp.path().resolve(&quot;storage&quot;);
325 
326             var bot = new HostUser(1, &quot;bot&quot;, &quot;openjdk [bot]&quot;);
327             var host = new InMemoryHost();
328             host.currentUserDetails = bot;
329             host.groups = Map.of(approvers, Set.of());
330 
331             var repo = new InMemoryHostedRepository();
332             repo.host = host;
333 
334             var pr = new InMemoryPullRequest();
335             pr.repository = repo;
336 
337             var duke = new HostUser(0, &quot;duke&quot;, &quot;Duke&quot;);
338             pr.author = duke;
339             pr.headHash = new Hash(&quot;01234567890123456789012345789012345789&quot;);
340 
341             var now = ZonedDateTime.now();
342             var comment = new Comment(&quot;0&quot;, &quot;/test tier1&quot;, duke, now, now);
343             pr.comments = new ArrayList&lt;&gt;(List.of(comment));
344 
345             var item = new TestWorkItem(ci, approvers, available, defaultJobs, name, storage, pr);
346 
347             item.run(scratch);
348 
349             var comments = pr.comments();
350             assertEquals(2, comments.size());
351             assertEquals(comment, comments.get(0));
352             var secondComment = comments.get(1);
353             assertEquals(bot, secondComment.author());
354 
355             var lines = secondComment.body().split(&quot;\n&quot;);
356             assertEquals(&quot;&lt;!-- TEST PENDING --&gt;&quot;, lines[0]);
357             assertEquals(&quot;&lt;!-- 01234567890123456789012345789012345789 --&gt;&quot;, lines[1]);
358             assertEquals(&quot;&lt;!-- tier1 --&gt;&quot;, lines[2]);
359             assertEquals(&quot;@duke you need to get approval to run the tests in tier1 for commits up until 01234567&quot;,
360                          lines[3]);
361 
362             // Nothing should change if we run it yet again
363             item.run(scratch);
364 
365             comments = pr.comments();
366             assertEquals(2, comments.size());
367             assertEquals(comment, comments.get(0));
368             assertEquals(secondComment, comments.get(1));
369 
370             // Cancelling the test now should be fine
371             var cancelComment = new Comment(&quot;2&quot;, &quot;/test cancel&quot;, duke, now, now);
372             pr.comments.add(cancelComment);
373 
374             item.run(scratch);
375 
376             comments = pr.comments();
377             assertEquals(3, comments.size());
378             assertEquals(comment, comments.get(0));
379             assertEquals(secondComment, comments.get(1));
380             assertEquals(cancelComment, comments.get(2));
381 
382             // Approving the test should not start a job, it has already been cancelled
383             var member = new HostUser(3, &quot;foo&quot;, &quot;Foo Bar&quot;);
384             host.groups = Map.of(approvers, Set.of(member));
385             var approveComment = new Comment(&quot;3&quot;, &quot;/test approve&quot;, member, now, now);
386             pr.comments.add(approveComment);
387 
388             item.run(scratch);
389 
390             comments = pr.comments();
391             assertEquals(4, comments.size());
392             assertEquals(comment, comments.get(0));
393             assertEquals(secondComment, comments.get(1));
394             assertEquals(cancelComment, comments.get(2));
395             assertEquals(approveComment, comments.get(3));
396         }
397     }
398 
399     @Test
400     void cancellingApprovedPendingRequestShouldBeCancelled() throws IOException {
401         try (var tmp = new TemporaryDirectory()) {
402             var ci = new InMemoryContinuousIntegration();
403             var approvers = &quot;0&quot;;
404             var available = List.of(&quot;tier1&quot;, &quot;tier2&quot;, &quot;tier3&quot;);
405             var defaultJobs = List.of(&quot;tier1&quot;);
406             var name = &quot;test&quot;;
407             var storage = tmp.path().resolve(&quot;storage&quot;);
408             var scratch = tmp.path().resolve(&quot;storage&quot;);
409 
410             var bot = new HostUser(1, &quot;bot&quot;, &quot;openjdk [bot]&quot;);
411             var host = new InMemoryHost();
412             host.currentUserDetails = bot;
413             host.groups = Map.of(approvers, Set.of());
414 
415             var repo = new InMemoryHostedRepository();
416             repo.host = host;
417 
418             var pr = new InMemoryPullRequest();
419             pr.repository = repo;
420 
421             var duke = new HostUser(0, &quot;duke&quot;, &quot;Duke&quot;);
422             pr.author = duke;
423             pr.headHash = new Hash(&quot;01234567890123456789012345789012345789&quot;);
424 
425             var now = ZonedDateTime.now();
426             var comment = new Comment(&quot;0&quot;, &quot;/test tier1&quot;, duke, now, now);
427             pr.comments = new ArrayList&lt;&gt;(List.of(comment));
428 
429             var item = new TestWorkItem(ci, approvers, available, defaultJobs, name, storage, pr);
430 
431             item.run(scratch);
432 
433             var comments = pr.comments();
434             assertEquals(2, comments.size());
435             assertEquals(comment, comments.get(0));
436             var secondComment = comments.get(1);
437             assertEquals(bot, secondComment.author());
438 
439             var lines = secondComment.body().split(&quot;\n&quot;);
440             assertEquals(&quot;&lt;!-- TEST PENDING --&gt;&quot;, lines[0]);
441             assertEquals(&quot;&lt;!-- 01234567890123456789012345789012345789 --&gt;&quot;, lines[1]);
442             assertEquals(&quot;&lt;!-- tier1 --&gt;&quot;, lines[2]);
443             assertEquals(&quot;@duke you need to get approval to run the tests in tier1 for commits up until 01234567&quot;,
444                          lines[3]);
445 
446             // Nothing should change if we run it yet again
447             item.run(scratch);
448 
449             comments = pr.comments();
450             assertEquals(2, comments.size());
451             assertEquals(comment, comments.get(0));
452             assertEquals(secondComment, comments.get(1));
453 
454             // Approve the request
455             var member = new HostUser(2, &quot;foo&quot;, &quot;Foo Bar&quot;);
456             host.groups = Map.of(approvers, Set.of(member));
457             var approveComment = new Comment(&quot;2&quot;, &quot;/test approve&quot;, member, now, now);
458             pr.comments.add(approveComment);
459 
460             // Cancelling the request
461             var cancelComment = new Comment(&quot;2&quot;, &quot;/test cancel&quot;, duke, now, now);
462             pr.comments.add(cancelComment);
463 
464             item.run(scratch);
465 
466             comments = pr.comments();
467             assertEquals(4, comments.size());
468             assertEquals(comment, comments.get(0));
469             assertEquals(secondComment, comments.get(1));
470             assertEquals(approveComment, comments.get(2));
471             assertEquals(cancelComment, comments.get(3));
472         }
473     }
474 
475     @Test
476     void approvedPendingRequestShouldBeStarted() throws IOException {
477         try (var tmp = new TemporaryDirectory()) {
478             var localRepoDir = tmp.path().resolve(&quot;repository.git&quot;);
479             var localRepo = Repository.init(localRepoDir, VCS.GIT);
480             var readme = localRepoDir.resolve(&quot;README&quot;);
481             Files.writeString(readme, &quot;Hello\n&quot;);
482             localRepo.add(readme);
483             var head = localRepo.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
484 
485             var ci = new InMemoryContinuousIntegration();
486             var approvers = &quot;0&quot;;
487             var available = List.of(&quot;tier1&quot;, &quot;tier2&quot;, &quot;tier3&quot;);
488             var defaultJobs = List.of(&quot;tier1&quot;);
489             var name = &quot;test&quot;;
490             var storage = tmp.path().resolve(&quot;storage&quot;);
491             var scratch = tmp.path().resolve(&quot;storage&quot;);
492 
493             var bot = new HostUser(1, &quot;bot&quot;, &quot;openjdk [bot]&quot;);
494             var host = new InMemoryHost();
495             host.currentUserDetails = bot;
496             host.groups = Map.of(approvers, Set.of());
497 
498             var repo = new InMemoryHostedRepository();
499             repo.host = host;
500             repo.webUrl = URI.create(&quot;file://&quot; + localRepoDir.toAbsolutePath());
501             repo.url = URI.create(&quot;file://&quot; + localRepoDir.toAbsolutePath());
502             repo.id = 1337L;
503 
504             var pr = new InMemoryPullRequest();
505             pr.repository = repo;
506             pr.id = &quot;17&quot;;
<a name="1" id="anc1"></a>
507 
508             var duke = new HostUser(0, &quot;duke&quot;, &quot;Duke&quot;);
509             pr.author = duke;
510             pr.headHash = head;
511 
512             var now = ZonedDateTime.now();
513             var comment = new Comment(&quot;0&quot;, &quot;/test tier1&quot;, duke, now, now);
514             pr.comments = new ArrayList&lt;&gt;(List.of(comment));
515 
516             var item = new TestWorkItem(ci, approvers, available, defaultJobs, name, storage, pr);
517 
518             item.run(scratch);
519 
520             var comments = pr.comments();
521             assertEquals(2, comments.size());
522             assertEquals(comment, comments.get(0));
523             var secondComment = comments.get(1);
524             assertEquals(bot, secondComment.author());
525 
526             var lines = secondComment.body().split(&quot;\n&quot;);
527             assertEquals(&quot;&lt;!-- TEST PENDING --&gt;&quot;, lines[0]);
528             assertEquals(&quot;&lt;!-- &quot; + head.hex() + &quot; --&gt;&quot;, lines[1]);
529             assertEquals(&quot;&lt;!-- tier1 --&gt;&quot;, lines[2]);
530             assertEquals(&quot;@duke you need to get approval to run the tests in tier1 for commits up until &quot; + head.abbreviate(),
531                          lines[3]);
532 
533             // Nothing should change if we run it yet again
534             item.run(scratch);
535 
536             comments = pr.comments();
537             assertEquals(2, comments.size());
538             assertEquals(comment, comments.get(0));
539             assertEquals(secondComment, comments.get(1));
540 
541             // Approve the request
542             var member = new HostUser(2, &quot;foo&quot;, &quot;Foo Bar&quot;);
543             host.groups = Map.of(approvers, Set.of(member));
544             var approveComment = new Comment(&quot;2&quot;, &quot;/test approve&quot;, member, now, now);
545             pr.comments.add(approveComment);
546 
547             var expectedJobId = &quot;null-1337-17-0&quot;;
548             var expectedJob = new InMemoryJob();
549             expectedJob.status = new Job.Status(0, 1, 7);
550             ci.jobs.put(expectedJobId, expectedJob);
551 
552             item.run(scratch);
553 
554             comments = pr.comments();
555             assertEquals(4, comments.size());
556             assertEquals(comment, comments.get(0));
557             assertEquals(secondComment, comments.get(1));
558             assertEquals(approveComment, comments.get(2));
559 
560             var fourthComment = comments.get(3);
561             lines = fourthComment.body().split(&quot;\n&quot;);
562             assertEquals(&quot;&lt;!-- TEST STARTED --&gt;&quot;, lines[0]);
563             assertEquals(&quot;&lt;!-- &quot; + expectedJobId + &quot; --&gt;&quot;, lines[1]);
564             assertEquals(&quot;&lt;!-- &quot; + head.hex() + &quot; --&gt;&quot;, lines[2]);
565             assertEquals(&quot;A test job has been started with id: &quot; + expectedJobId, lines[3]);
566 
567             assertEquals(1, ci.submissions.size());
568             var submission = ci.submissions.get(0);
569             assertTrue(submission.source.startsWith(storage));
570             assertEquals(List.of(&quot;tier1&quot;), submission.jobs);
571             assertEquals(expectedJobId, submission.id);
572 
573             var checks = pr.checks(pr.headHash());
574             assertEquals(1, checks.keySet().size());
575             var check = checks.get(&quot;test&quot;);
576             assertEquals(&quot;Summary&quot;, check.title().get());
577             assertTrue(check.summary()
578                             .get()
579                             .contains(&quot;0 jobs completed, 1 job running, 7 jobs not yet started&quot;));
580         }
581     }
582 
583     @Test
584     void cancellingApprovedPendingRequestShouldBeCancel() throws IOException {
585         try (var tmp = new TemporaryDirectory()) {
586             var localRepoDir = tmp.path().resolve(&quot;repository.git&quot;);
587             var localRepo = Repository.init(localRepoDir, VCS.GIT);
588             var readme = localRepoDir.resolve(&quot;README&quot;);
589             Files.writeString(readme, &quot;Hello\n&quot;);
590             localRepo.add(readme);
591             var head = localRepo.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
592 
593             var ci = new InMemoryContinuousIntegration();
594             var approvers = &quot;0&quot;;
595             var available = List.of(&quot;tier1&quot;, &quot;tier2&quot;, &quot;tier3&quot;);
596             var defaultJobs = List.of(&quot;tier1&quot;);
597             var name = &quot;test&quot;;
598             var storage = tmp.path().resolve(&quot;storage&quot;);
599             var scratch = tmp.path().resolve(&quot;storage&quot;);
600 
601             var bot = new HostUser(1, &quot;bot&quot;, &quot;openjdk [bot]&quot;);
602             var host = new InMemoryHost();
603             host.currentUserDetails = bot;
604             host.groups = Map.of(approvers, Set.of());
605 
606             var repo = new InMemoryHostedRepository();
607             repo.host = host;
608             repo.webUrl = URI.create(&quot;file://&quot; + localRepoDir.toAbsolutePath());
609             repo.url = URI.create(&quot;file://&quot; + localRepoDir.toAbsolutePath());
610             repo.id = 1337L;
611 
612             var pr = new InMemoryPullRequest();
613             pr.repository = repo;
614             pr.id = &quot;17&quot;;
<a name="2" id="anc2"></a><span class="line-modified">615             pr.headHash = head;</span>
616 
617             var duke = new HostUser(0, &quot;duke&quot;, &quot;Duke&quot;);
618             pr.author = duke;
<a name="3" id="anc3"></a>
619 
620             var now = ZonedDateTime.now();
621             var comment = new Comment(&quot;0&quot;, &quot;/test tier1&quot;, duke, now, now);
622             pr.comments = new ArrayList&lt;&gt;(List.of(comment));
623 
624             var item = new TestWorkItem(ci, approvers, available, defaultJobs, name, storage, pr);
625 
626             item.run(scratch);
627 
628             var comments = pr.comments();
629             assertEquals(2, comments.size());
630             assertEquals(comment, comments.get(0));
631             var secondComment = comments.get(1);
632             assertEquals(bot, secondComment.author());
633 
634             var lines = secondComment.body().split(&quot;\n&quot;);
635             assertEquals(&quot;&lt;!-- TEST PENDING --&gt;&quot;, lines[0]);
636             assertEquals(&quot;&lt;!-- &quot; + head.hex() + &quot; --&gt;&quot;, lines[1]);
637             assertEquals(&quot;&lt;!-- tier1 --&gt;&quot;, lines[2]);
638             assertEquals(&quot;@duke you need to get approval to run the tests in tier1 for commits up until &quot; + head.abbreviate(),
639                          lines[3]);
640 
641             // Nothing should change if we run it yet again
642             item.run(scratch);
643 
644             comments = pr.comments();
645             assertEquals(2, comments.size());
646             assertEquals(comment, comments.get(0));
647             assertEquals(secondComment, comments.get(1));
648 
649             // Approve the request
650             var member = new HostUser(2, &quot;foo&quot;, &quot;Foo Bar&quot;);
651             host.groups = Map.of(approvers, Set.of(member));
652             var approveComment = new Comment(&quot;2&quot;, &quot;/test approve&quot;, member, now, now);
653             pr.comments.add(approveComment);
654 
655             var expectedJobId = &quot;null-1337-17-0&quot;;
656             var expectedJob = new InMemoryJob();
657             expectedJob.status = new Job.Status(0, 1, 7);
658             ci.jobs.put(expectedJobId, expectedJob);
659 
660             item.run(scratch);
661 
662             comments = pr.comments();
663             assertEquals(4, comments.size());
664             assertEquals(comment, comments.get(0));
665             assertEquals(secondComment, comments.get(1));
666             assertEquals(approveComment, comments.get(2));
667 
668             var fourthComment = comments.get(3);
669             lines = fourthComment.body().split(&quot;\n&quot;);
670             assertEquals(&quot;&lt;!-- TEST STARTED --&gt;&quot;, lines[0]);
671             assertEquals(&quot;&lt;!-- &quot; + expectedJobId + &quot; --&gt;&quot;, lines[1]);
672             assertEquals(&quot;&lt;!-- &quot; + head.hex() + &quot; --&gt;&quot;, lines[2]);
673             assertEquals(&quot;A test job has been started with id: &quot; + expectedJobId, lines[3]);
674 
675             assertEquals(1, ci.submissions.size());
676             var submission = ci.submissions.get(0);
677             assertTrue(submission.source.startsWith(storage));
678             assertEquals(List.of(&quot;tier1&quot;), submission.jobs);
679             assertEquals(expectedJobId, submission.id);
680 
681             var checks = pr.checks(pr.headHash());
682             assertEquals(1, checks.keySet().size());
683             var check = checks.get(&quot;test&quot;);
684             assertEquals(&quot;Summary&quot;, check.title().get());
685             assertEquals(CheckStatus.IN_PROGRESS, check.status());
686             assertTrue(check.summary()
687                             .get()
688                             .contains(&quot;## Status\n0 jobs completed, 1 job running, 7 jobs not yet started\n&quot;));
689 
690             var cancelComment = new Comment(&quot;4&quot;, &quot;/test cancel&quot;, duke, now, now);
691             pr.comments.add(cancelComment);
692 
693             item.run(scratch);
694 
695             checks = pr.checks(pr.headHash());
696             assertEquals(1, checks.keySet().size());
697             check = checks.get(&quot;test&quot;);
698             assertEquals(&quot;Summary&quot;, check.title().get());
699             assertEquals(CheckStatus.CANCELLED, check.status());
700             assertTrue(check.summary()
701                             .get()
702                             .contains(&quot;## Status\n0 jobs completed, 1 job running, 7 jobs not yet started\n&quot;));
703 
704             assertEquals(expectedJobId, ci.cancelled.get(0));
705         }
706     }
707 
708     @Test
709     void errorWhenCreatingTestJobShouldResultInError() throws IOException {
710         try (var tmp = new TemporaryDirectory()) {
711             var localRepoDir = tmp.path().resolve(&quot;repository.git&quot;);
712             var localRepo = Repository.init(localRepoDir, VCS.GIT);
713             var readme = localRepoDir.resolve(&quot;README&quot;);
714             Files.writeString(readme, &quot;Hello\n&quot;);
715             localRepo.add(readme);
716             var head = localRepo.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
717 
718             var ci = new InMemoryContinuousIntegration();
719             var approvers = &quot;0&quot;;
720             var available = List.of(&quot;tier1&quot;, &quot;tier2&quot;, &quot;tier3&quot;);
721             var defaultJobs = List.of(&quot;tier1&quot;);
722             var name = &quot;test&quot;;
723             var storage = tmp.path().resolve(&quot;storage&quot;);
724             var scratch = tmp.path().resolve(&quot;storage&quot;);
725 
726             var bot = new HostUser(1, &quot;bot&quot;, &quot;openjdk [bot]&quot;);
727             var host = new InMemoryHost();
728             host.currentUserDetails = bot;
729             host.groups = Map.of(approvers, Set.of());
730 
731             var repo = new InMemoryHostedRepository();
732             repo.host = host;
733             repo.webUrl = URI.create(&quot;file://&quot; + localRepoDir.toAbsolutePath());
734             repo.url = URI.create(&quot;file://&quot; + localRepoDir.toAbsolutePath());
735             repo.id = 1337L;
736 
737             var pr = new InMemoryPullRequest();
738             pr.repository = repo;
739             pr.id = &quot;17&quot;;
<a name="4" id="anc4"></a><span class="line-modified">740             pr.headHash = head;</span>
741 
742             var duke = new HostUser(0, &quot;duke&quot;, &quot;Duke&quot;);
743             pr.author = duke;
<a name="5" id="anc5"></a>
744 
745             var now = ZonedDateTime.now();
746             var comment = new Comment(&quot;0&quot;, &quot;/test tier1&quot;, duke, now, now);
747             pr.comments = new ArrayList&lt;&gt;(List.of(comment));
748 
749             var item = new TestWorkItem(ci, approvers, available, defaultJobs, name, storage, pr);
750 
751             item.run(scratch);
752 
753             var comments = pr.comments();
754             assertEquals(2, comments.size());
755             assertEquals(comment, comments.get(0));
756             var secondComment = comments.get(1);
757             assertEquals(bot, secondComment.author());
758 
759             var lines = secondComment.body().split(&quot;\n&quot;);
760             assertEquals(&quot;&lt;!-- TEST PENDING --&gt;&quot;, lines[0]);
761             assertEquals(&quot;&lt;!-- &quot; + head.hex() + &quot; --&gt;&quot;, lines[1]);
762             assertEquals(&quot;&lt;!-- tier1 --&gt;&quot;, lines[2]);
763             assertEquals(&quot;@duke you need to get approval to run the tests in tier1 for commits up until &quot; + head.abbreviate(),
764                          lines[3]);
765 
766             // Nothing should change if we run it yet again
767             item.run(scratch);
768 
769             comments = pr.comments();
770             assertEquals(2, comments.size());
771             assertEquals(comment, comments.get(0));
772             assertEquals(secondComment, comments.get(1));
773 
774             // Approve the request
775             var member = new HostUser(2, &quot;foo&quot;, &quot;Foo Bar&quot;);
776             host.groups = Map.of(approvers, Set.of(member));
777             var approveComment = new Comment(&quot;2&quot;, &quot;/test approve&quot;, member, now, now);
778             pr.comments.add(approveComment);
779 
780             ci.throwOnSubmit = true;
781             assertThrows(UncheckedIOException.class, () -&gt; item.run(scratch));
782 
783             comments = pr.comments();
784             assertEquals(4, comments.size());
785             assertEquals(comment, comments.get(0));
786             assertEquals(secondComment, comments.get(1));
787             assertEquals(approveComment, comments.get(2));
788 
789             var fifthComment = comments.get(3);
790             lines = fifthComment.body().split(&quot;\n&quot;);
791             assertEquals(&quot;&lt;!-- TEST ERROR --&gt;&quot;, lines[0]);
792             assertEquals(&quot;Could not create test job&quot;, lines[1]);
793         }
794     }
795 
796     @Test
797     void finishedJobShouldResultInFinishedComment() throws IOException {
798         try (var tmp = new TemporaryDirectory()) {
799             var localRepoDir = tmp.path().resolve(&quot;repository.git&quot;);
800             var localRepo = Repository.init(localRepoDir, VCS.GIT);
801             var readme = localRepoDir.resolve(&quot;README&quot;);
802             Files.writeString(readme, &quot;Hello\n&quot;);
803             localRepo.add(readme);
804             var head = localRepo.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
805 
806             var ci = new InMemoryContinuousIntegration();
807             var approvers = &quot;0&quot;;
808             var available = List.of(&quot;tier1&quot;, &quot;tier2&quot;, &quot;tier3&quot;);
809             var defaultJobs = List.of(&quot;tier1&quot;);
810             var name = &quot;test&quot;;
811             var storage = tmp.path().resolve(&quot;storage&quot;);
812             var scratch = tmp.path().resolve(&quot;storage&quot;);
813 
814             var bot = new HostUser(1, &quot;bot&quot;, &quot;openjdk [bot]&quot;);
815             var host = new InMemoryHost();
816             host.currentUserDetails = bot;
817             host.groups = Map.of(approvers, Set.of());
818 
819             var repo = new InMemoryHostedRepository();
820             repo.host = host;
821             repo.webUrl = URI.create(&quot;file://&quot; + localRepoDir.toAbsolutePath());
822             repo.url = URI.create(&quot;file://&quot; + localRepoDir.toAbsolutePath());
823             repo.id = 1337L;
824 
825             var pr = new InMemoryPullRequest();
826             pr.repository = repo;
827             pr.id = &quot;17&quot;;
<a name="6" id="anc6"></a><span class="line-modified">828             pr.headHash = head;</span>
829 
830             var duke = new HostUser(0, &quot;duke&quot;, &quot;Duke&quot;);
831             pr.author = duke;
<a name="7" id="anc7"></a>
832 
833             var now = ZonedDateTime.now();
834             var comment = new Comment(&quot;0&quot;, &quot;/test tier1&quot;, duke, now, now);
835             pr.comments = new ArrayList&lt;&gt;(List.of(comment));
836 
837             var item = new TestWorkItem(ci, approvers, available, defaultJobs, name, storage, pr);
838 
839             item.run(scratch);
840 
841             var comments = pr.comments();
842             assertEquals(2, comments.size());
843             assertEquals(comment, comments.get(0));
844             var secondComment = comments.get(1);
845             assertEquals(bot, secondComment.author());
846 
847             var lines = secondComment.body().split(&quot;\n&quot;);
848             assertEquals(&quot;&lt;!-- TEST PENDING --&gt;&quot;, lines[0]);
849             assertEquals(&quot;&lt;!-- &quot; + head.hex() + &quot; --&gt;&quot;, lines[1]);
850             assertEquals(&quot;&lt;!-- tier1 --&gt;&quot;, lines[2]);
851             assertEquals(&quot;@duke you need to get approval to run the tests in tier1 for commits up until &quot; + head.abbreviate(),
852                          lines[3]);
853 
854             // Nothing should change if we run it yet again
855             item.run(scratch);
856 
857             comments = pr.comments();
858             assertEquals(2, comments.size());
859             assertEquals(comment, comments.get(0));
860             assertEquals(secondComment, comments.get(1));
861 
862             // Approve the request
863             var member = new HostUser(2, &quot;foo&quot;, &quot;Foo Bar&quot;);
864             host.groups = Map.of(approvers, Set.of(member));
865             var approveComment = new Comment(&quot;2&quot;, &quot;/test approve&quot;, member, now, now);
866             pr.comments.add(approveComment);
867 
868             var expectedJobId = &quot;null-1337-17-0&quot;;
869             var expectedJob = new InMemoryJob();
870             expectedJob.status = new Job.Status(0, 1, 7);
871             ci.jobs.put(expectedJobId, expectedJob);
872 
873             item.run(scratch);
874 
875             comments = pr.comments();
876             assertEquals(4, comments.size());
877             assertEquals(comment, comments.get(0));
878             assertEquals(secondComment, comments.get(1));
879             assertEquals(approveComment, comments.get(2));
880 
881             var fourthComment = comments.get(3);
882             lines = fourthComment.body().split(&quot;\n&quot;);
883             assertEquals(&quot;&lt;!-- TEST STARTED --&gt;&quot;, lines[0]);
884             assertEquals(&quot;&lt;!-- &quot; + expectedJobId + &quot; --&gt;&quot;, lines[1]);
885             assertEquals(&quot;&lt;!-- &quot; + head.hex() + &quot; --&gt;&quot;, lines[2]);
886             assertEquals(&quot;A test job has been started with id: &quot; + expectedJobId, lines[3]);
887 
888             assertEquals(1, ci.submissions.size());
889             var submission = ci.submissions.get(0);
890             assertTrue(submission.source.startsWith(storage));
891             assertEquals(List.of(&quot;tier1&quot;), submission.jobs);
892             assertEquals(expectedJobId, submission.id);
893 
894             var checks = pr.checks(pr.headHash());
895             assertEquals(1, checks.keySet().size());
896             var check = checks.get(&quot;test&quot;);
897             assertEquals(&quot;Summary&quot;, check.title().get());
898             assertEquals(CheckStatus.IN_PROGRESS, check.status());
899             assertTrue(check.summary()
900                             .get()
901                             .contains(&quot;0 jobs completed, 1 job running, 7 jobs not yet started&quot;));
902 
903             var job = ci.jobs.get(expectedJobId);
904             assertNotNull(job);
905             job.id = &quot;id&quot;;
906             job.state = Job.State.COMPLETED;
907             job.status = new Job.Status(8, 0, 0);
908             job.result = new Job.Result(8, 0, 0);
909 
910             item.run(scratch);
911 
912             comments = pr.comments();
913             assertEquals(5, comments.size());
914             assertEquals(comment, comments.get(0));
915             assertEquals(secondComment, comments.get(1));
916             assertEquals(approveComment, comments.get(2));
917             assertEquals(fourthComment, comments.get(3));
918 
919             var finishedComment = comments.get(4);
920             lines = finishedComment.body().split(&quot;\n&quot;);
921             assertEquals(&quot;&lt;!-- TEST FINISHED --&gt;&quot;, lines[0]);
922             assertEquals(&quot;&lt;!-- &quot; + expectedJobId +&quot; --&gt;&quot;, lines[1]);
923             assertEquals(&quot;&lt;!-- &quot; + head.hex() +&quot; --&gt;&quot;, lines[2]);
924             assertEquals(&quot;@duke your test job with id &quot; + expectedJobId + &quot; for commits up until &quot; +
925                          head.abbreviate() + &quot; has finished.&quot;, lines[3]);
926 
927             checks = pr.checks(pr.headHash());
928             assertEquals(1, checks.keySet().size());
929             check = checks.get(&quot;test&quot;);
930             assertEquals(&quot;Summary&quot;, check.title().get());
931             assertEquals(CheckStatus.SUCCESS, check.status());
932 
933             var summaryLines = check.summary().get().split(&quot;\n&quot;);
934             assertEquals(&quot;## Id&quot;, summaryLines[0]);
935             assertEquals(&quot;`id`&quot;, summaryLines[1]);
936             assertEquals(&quot;&quot;, summaryLines[2]);
937             assertEquals(&quot;## Builds&quot;, summaryLines[3]);
938             assertEquals(&quot;&quot;, summaryLines[4]);
939             assertEquals(&quot;## Tests&quot;, summaryLines[5]);
940             assertEquals(&quot;&quot;, summaryLines[6]);
941             assertEquals(&quot;## Status&quot;, summaryLines[7]);
942             assertEquals(&quot;8 jobs completed, 0 jobs running, 0 jobs not yet started&quot;, summaryLines[8]);
943             assertEquals(&quot;&quot;, summaryLines[9]);
944             assertEquals(&quot;## Result&quot;, summaryLines[10]);
945             assertEquals(&quot;8 jobs passed, 0 jobs with failures, 0 jobs not run&quot;, summaryLines[11]);
946         }
947     }
948 }
<a name="8" id="anc8"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="8" type="hidden" />
</body>
</html>