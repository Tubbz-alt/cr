<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.incubator.foreign/share/classes/jdk/internal/foreign/abi/x64/windows/CallArranger.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../sysv/CallArranger.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>src/jdk.incubator.foreign/share/classes/jdk/internal/foreign/abi/x64/windows/CallArranger.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 57  * to translate a C FunctionDescriptor into a CallingSequence2, which can then be turned into a MethodHandle.
 58  *
 59  * This includes taking care of synthetic arguments like pointers to return buffers for &#39;in-memory&#39; returns.
 60  */
 61 public class CallArranger {
 62     private static final int STACK_SLOT_SIZE = 8;
 63 
 64     private static final ABIDescriptor CWindows = X86_64Architecture.abiFor(
 65         new VMStorage[] { rcx, rdx, r8, r9 },
 66         new VMStorage[] { xmm0, xmm1, xmm2, xmm3 },
 67         new VMStorage[] { rax },
 68         new VMStorage[] { xmm0 },
 69         0,
 70         new VMStorage[] { rax, r10, r11 },
 71         new VMStorage[] { xmm4, xmm5 },
 72         16,
 73         32
 74     );
 75 
 76     // record
<span class="line-modified"> 77     private static class Bindings {</span>
 78         public final CallingSequence callingSequence;
 79         public final boolean isInMemoryReturn;
 80 
 81         Bindings(CallingSequence callingSequence, boolean isInMemoryReturn) {
 82             this.callingSequence = callingSequence;
 83             this.isInMemoryReturn = isInMemoryReturn;
 84         }
 85     }
 86 
<span class="line-modified"> 87     private static Bindings getBindings(MethodType mt, FunctionDescriptor cDesc, boolean forUpcall) {</span>
 88         SharedUtils.checkFunctionTypes(mt, cDesc);
 89 
 90         class CallingSequenceBuilderHelper {
 91             final CallingSequenceBuilder csb = new CallingSequenceBuilder(forUpcall);
 92             final BindingCalculator argCalc =
 93                 forUpcall ? new BoxBindingCalculator(true) : new UnboxBindingCalculator(true);
 94             final BindingCalculator retCalc =
 95                 forUpcall ? new UnboxBindingCalculator(false) : new BoxBindingCalculator(false);
 96 
 97             void addArgumentBindings(Class&lt;?&gt; carrier, MemoryLayout layout) {
 98                 csb.addArgumentBindings(carrier, layout, argCalc.getBindings(carrier, layout));
 99             }
100 
101             void setReturnBindings(Class&lt;?&gt; carrier, MemoryLayout layout) {
102                 csb.setReturnBindings(carrier, layout, retCalc.getBindings(carrier, layout));
103             }
104         }
105         var csb = new CallingSequenceBuilderHelper();
106 
107         boolean returnInMemory = isInMemoryReturn(cDesc.returnLayout());
</pre>
</td>
<td>
<hr />
<pre>
 57  * to translate a C FunctionDescriptor into a CallingSequence2, which can then be turned into a MethodHandle.
 58  *
 59  * This includes taking care of synthetic arguments like pointers to return buffers for &#39;in-memory&#39; returns.
 60  */
 61 public class CallArranger {
 62     private static final int STACK_SLOT_SIZE = 8;
 63 
 64     private static final ABIDescriptor CWindows = X86_64Architecture.abiFor(
 65         new VMStorage[] { rcx, rdx, r8, r9 },
 66         new VMStorage[] { xmm0, xmm1, xmm2, xmm3 },
 67         new VMStorage[] { rax },
 68         new VMStorage[] { xmm0 },
 69         0,
 70         new VMStorage[] { rax, r10, r11 },
 71         new VMStorage[] { xmm4, xmm5 },
 72         16,
 73         32
 74     );
 75 
 76     // record
<span class="line-modified"> 77     public static class Bindings {</span>
 78         public final CallingSequence callingSequence;
 79         public final boolean isInMemoryReturn;
 80 
 81         Bindings(CallingSequence callingSequence, boolean isInMemoryReturn) {
 82             this.callingSequence = callingSequence;
 83             this.isInMemoryReturn = isInMemoryReturn;
 84         }
 85     }
 86 
<span class="line-modified"> 87     public static Bindings getBindings(MethodType mt, FunctionDescriptor cDesc, boolean forUpcall) {</span>
 88         SharedUtils.checkFunctionTypes(mt, cDesc);
 89 
 90         class CallingSequenceBuilderHelper {
 91             final CallingSequenceBuilder csb = new CallingSequenceBuilder(forUpcall);
 92             final BindingCalculator argCalc =
 93                 forUpcall ? new BoxBindingCalculator(true) : new UnboxBindingCalculator(true);
 94             final BindingCalculator retCalc =
 95                 forUpcall ? new UnboxBindingCalculator(false) : new BoxBindingCalculator(false);
 96 
 97             void addArgumentBindings(Class&lt;?&gt; carrier, MemoryLayout layout) {
 98                 csb.addArgumentBindings(carrier, layout, argCalc.getBindings(carrier, layout));
 99             }
100 
101             void setReturnBindings(Class&lt;?&gt; carrier, MemoryLayout layout) {
102                 csb.setReturnBindings(carrier, layout, retCalc.getBindings(carrier, layout));
103             }
104         }
105         var csb = new CallingSequenceBuilderHelper();
106 
107         boolean returnInMemory = isInMemoryReturn(cDesc.returnLayout());
</pre>
</td>
</tr>
</table>
<center><a href="../sysv/CallArranger.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>