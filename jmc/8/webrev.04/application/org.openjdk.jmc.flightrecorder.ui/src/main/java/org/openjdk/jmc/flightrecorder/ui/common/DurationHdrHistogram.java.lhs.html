<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames application/org.openjdk.jmc.flightrecorder.ui/src/main/java/org/openjdk/jmc/flightrecorder/ui/common/DurationHdrHistogram.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
  3  * Copyright (c) 2019, Red Hat Inc. All rights reserved.
  4  *
  5  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  6  *
  7  * The contents of this file are subject to the terms of either the Universal Permissive License
  8  * v 1.0 as shown at http://oss.oracle.com/licenses/upl
  9  *
 10  * or the following license:
 11  *
 12  * Redistribution and use in source and binary forms, with or without modification, are permitted
 13  * provided that the following conditions are met:
 14  *
 15  * 1. Redistributions of source code must retain the above copyright notice, this list of conditions
 16  * and the following disclaimer.
 17  *
 18  * 2. Redistributions in binary form must reproduce the above copyright notice, this list of
 19  * conditions and the following disclaimer in the documentation and/or other materials provided with
 20  * the distribution.
 21  *
 22  * 3. Neither the name of the copyright holder nor the names of its contributors may be used to
 23  * endorse or promote products derived from this software without specific prior written permission.
 24  *
 25  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR
 26  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
 27  * FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR
 28  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 29  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 30  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
 31  * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY
 32  * WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 33  */
 34 
 35 package org.openjdk.jmc.flightrecorder.ui.common;
 36 
 37 import org.HdrHistogram.ConcurrentHistogram;
 38 import org.HdrHistogram.Histogram;
 39 import org.openjdk.jmc.common.item.IItem;
 40 import org.openjdk.jmc.common.item.IItemConsumer;
 41 import org.openjdk.jmc.common.item.IMemberAccessor;
 42 import org.openjdk.jmc.common.unit.IQuantity;
 43 import org.openjdk.jmc.common.unit.UnitLookup;
 44 import org.openjdk.jmc.common.util.Pair;
 45 import org.openjdk.jmc.flightrecorder.JfrAttributes;
 46 
 47 /**
 48  * An HdrHistogram containing durations of Flight Recorder events.
 49  *
 50  * @see org.HdrHistogram
 51  * @see JfrAttributes#DURATION
 52  */
 53 public class DurationHdrHistogram {
 54 
 55 	// Precision of values stored in the HdrHistogram, in terms of significant digits
 56 	private static final int SIGNIFICANT_DIGITS = 3;
 57 
 58 	private final Histogram histogram;
 59 
 60 	public DurationHdrHistogram() {
 61 		// Use ConcurrentHistogram, as we may have multiple consumers recording in parallel
 62 		this.histogram = new ConcurrentHistogram(SIGNIFICANT_DIGITS);
 63 	}
 64 
 65 	/**
 66 	 * Consumer responsible for recording duration quantities in the HdrHistogram.
 67 	 */
 68 	static class DurationItemConsumer implements IItemConsumer&lt;DurationItemConsumer&gt; {
 69 
 70 		private final DurationHdrHistogram durationHist;
 71 		private final IMemberAccessor&lt;IQuantity, IItem&gt; accessor;
 72 
 73 		public DurationItemConsumer(DurationHdrHistogram durationHist, IMemberAccessor&lt;IQuantity, IItem&gt; accessor) {
 74 			this.durationHist = durationHist;
 75 			this.accessor = accessor;
 76 		}
 77 
 78 		@Override
 79 		public void consume(IItem item) {
 80 			IQuantity quantity = accessor.getMember(item);
 81 			durationHist.histogram.recordValue(quantity.clampedLongValueIn(UnitLookup.NANOSECOND));
 82 		}
 83 
 84 		@Override
 85 		public DurationItemConsumer merge(DurationItemConsumer other) {
 86 			// No-op, all consumers should be backed by the same histogram
 87 			return this;
 88 		}
 89 
 90 	}
 91 
 92 	/**
 93 	 * Computes the duration at a given percentile for values stored in the histogram.
<a name="1" id="anc1"></a><span class="line-modified"> 94 	 * @param percentile - the percentile, as a {@link UnitLookup#NUMBER}</span>


 95 	 * @return the computed duration, as a {@link UnitLookup#TIMESPAN}
 96 	 */
 97 	public IQuantity getDurationAtPercentile(IQuantity percentile) {
 98 		long rawValue = histogram.getValueAtPercentile(percentile.doubleValue());
 99 		IQuantity duration = UnitLookup.NANOSECOND.quantity(rawValue);
100 		return duration;
101 	}
102 
103 	/**
<a name="2" id="anc2"></a><span class="line-modified">104 	 * Computes the duration at a given percentile for values stored</span>
<span class="line-modified">105 	 * in the histogram, and number of values at or above that duration.</span>
<span class="line-modified">106 	 * @param percentile - the percentile, as a {@link UnitLookup#NUMBER}</span>
<span class="line-modified">107 	 * @return a pair with the computed duration as a {@link UnitLookup#TIMESPAN},</span>
<span class="line-modified">108 	 * 	       and item count as a {@link UnitLookup#NUMBER}, in that order</span>


109 	 */
110 	public Pair&lt;IQuantity, IQuantity&gt; getDurationAndCountAtPercentile(IQuantity percentile) {
111 		long rawValue = histogram.getValueAtPercentile(percentile.doubleValue());
112 		IQuantity duration = UnitLookup.NANOSECOND.quantity(rawValue);
113 		long rawCount = histogram.getCountBetweenValues(rawValue, histogram.getMaxValue());
114 		IQuantity count = UnitLookup.NUMBER_UNITY.quantity(rawCount);
115 		return new Pair&lt;&gt;(duration, count);
116 	}
117 
118 	/**
119 	 * @return whether this histogram is empty
120 	 */
121 	public boolean isEmpty() {
122 		return getTotalCount() == 0L;
123 	}
124 
125 	/**
126 	 * @return the total number of items present in the histogram
127 	 */
128 	public long getTotalCount() {
129 		return histogram.getTotalCount();
130 	}
131 
132 	/**
<a name="3" id="anc3"></a><span class="line-modified">133 	 * Gets the lowest value considered equivalent by this histogram,</span>
<span class="line-modified">134 	 * subject to its configured precision. This is effectively a lower</span>
<span class="line-modified">135 	 * bound for the &quot;bucket&quot; the specified value would fall under.</span>

136 	 * @see Histogram#lowestEquivalentValue(long)
<a name="4" id="anc4"></a><span class="line-modified">137 	 * @param duration - the specified duration quantity</span>

138 	 * @return the lowest duration equivalent to the supplied argument
139 	 */
140 	public IQuantity getLowestEquivalentDuration(IQuantity duration) {
141 		long rawValue = duration.clampedLongValueIn(UnitLookup.NANOSECOND);
142 		long lowestEquivalent = histogram.lowestEquivalentValue(rawValue);
143 		return UnitLookup.NANOSECOND.quantity(lowestEquivalent);
144 	}
145 
146 	/**
147 	 * Resets this histogram to its initial state, deleting all values from it.
148 	 */
149 	public void reset() {
150 		histogram.reset();
151 	}
<a name="5" id="anc5"></a><span class="line-removed">152 </span>
153 }
<a name="6" id="anc6"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="6" type="hidden" />
</body>
</html>