<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff application/org.openjdk.jmc.flightrecorder.ui/src/main/java/org/openjdk/jmc/flightrecorder/ui/common/ItemList.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="DataPageToolkit.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="../pages/EventBrowserPage.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>application/org.openjdk.jmc.flightrecorder.ui/src/main/java/org/openjdk/jmc/flightrecorder/ui/common/ItemList.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 48 import org.eclipse.osgi.util.NLS;
 49 import org.eclipse.swt.SWT;
 50 import org.eclipse.swt.widgets.Composite;
 51 import org.openjdk.jmc.common.collection.SimpleArray;
 52 import org.openjdk.jmc.common.item.IAttribute;
 53 import org.openjdk.jmc.common.item.IItem;
 54 import org.openjdk.jmc.common.item.IItemCollection;
 55 import org.openjdk.jmc.common.item.IMemberAccessor;
 56 import org.openjdk.jmc.common.item.ItemToolkit;
 57 import org.openjdk.jmc.common.unit.LinearKindOfQuantity;
 58 import org.openjdk.jmc.common.util.SortedHead;
 59 import org.openjdk.jmc.flightrecorder.ui.FlightRecorderUI;
 60 import org.openjdk.jmc.flightrecorder.ui.ItemCollectionToolkit;
 61 import org.openjdk.jmc.flightrecorder.ui.ItemIterableToolkit;
 62 import org.openjdk.jmc.flightrecorder.ui.messages.internal.Messages;
 63 import org.openjdk.jmc.ui.UIPlugin;
 64 import org.openjdk.jmc.ui.accessibility.FocusTracker;
 65 import org.openjdk.jmc.ui.column.ColumnBuilder;
 66 import org.openjdk.jmc.ui.column.ColumnManager;
 67 import org.openjdk.jmc.ui.column.ColumnManager.ColumnComparator;

 68 import org.openjdk.jmc.ui.column.IColumn;
 69 import org.openjdk.jmc.ui.column.TableSettings;
 70 
 71 public class ItemList {
 72 
 73 	public static class ItemListBuilder {
 74 
 75 		private final List&lt;IColumn&gt; columns = new ArrayList&lt;&gt;();
 76 
 77 		public void addColumn(IAttribute&lt;?&gt; a) {
 78 			IMemberAccessor&lt;?, IItem&gt; accessor = ItemToolkit.accessor(a);
 79 			// FIXME: Calculate column id, e.g. using getColumnId.
 80 			// Otherwise there will be problem if adding multiple attributes with the same id.
 81 			// Requires update of all column id references, e.g. in the pages xml.
 82 			addColumn(a.getIdentifier(), a.getName(), a.getDescription(),
 83 					a.getContentType() instanceof LinearKindOfQuantity, accessor);
 84 		}
 85 
 86 		public void addColumn(
 87 			String columnId, String name, String description, boolean right, IMemberAccessor&lt;?, IItem&gt; accessor) {
 88 			columns.add(new ColumnBuilder(name, columnId, accessor).description(description)
 89 					.style(right ? SWT.RIGHT : SWT.NONE).build());
 90 		}
 91 
 92 		public ItemList buildWithoutBorder(Composite container, TableSettings tableSettings) {
 93 			return new ItemList(container, columns, tableSettings, SWT.NONE);
 94 		}
 95 
 96 		public ItemList build(Composite container, TableSettings tableSettings) {
 97 			return new ItemList(container, columns, tableSettings, SWT.BORDER);
 98 		}
 99 	}
100 
101 	private final int maxSize = (int) FlightRecorderUI.getDefault().getItemListSize().longValue();
102 	private final IItem[] maxSizeArray = new IItem[maxSize + 1];
103 	private final ColumnManager columnManager;
104 	// FIXME: JMC-5127 - Don&#39;t initialize to 1000 elements
105 	private final SimpleArray&lt;IItem&gt; tail = new SimpleArray&lt;&gt;(new IItem[1000]);
106 
107 	private ExtraRowTableViewer tableViewer;

108 
109 	private ItemList(Composite container, List&lt;IColumn&gt; columns, TableSettings tableSettings, int style) {
110 		tableViewer = new ExtraRowTableViewer(container,
111 				SWT.MULTI | SWT.VIRTUAL | SWT.H_SCROLL | SWT.V_SCROLL | SWT.FULL_SELECTION | style);
112 		tableViewer.setContentProvider(ArrayContentProvider.getInstance());
113 		ColumnViewerToolTipSupport.enableFor(tableViewer);
114 		Consumer&lt;ColumnComparator&gt; onSortChange = comparator -&gt; {
115 			Object input = tableViewer.getInput();
116 			if (input instanceof IItem[] &amp;&amp; comparator != null) {
117 				IItem[] head = (IItem[]) input;
118 				if (tail.size() &gt; 0) {
119 					Iterator&lt;IItem&gt; oldTailIterator = tail.iterator();
120 					tail.clear();
121 					// addSorted will write to the array in tail, but not faster than it is read
122 					SortedHead.addSorted(oldTailIterator, head, tail, comparator);
123 				} else {
124 					Arrays.sort(head, comparator);
125 				}
126 				tableViewer.refresh();
127 				tableViewer.setSelection(StructuredSelection.EMPTY);
128 			}
129 		};
130 		if (UIPlugin.getDefault().getAccessibilityMode()) {
131 			FocusTracker.enableFocusTracking(tableViewer.getTable());
132 		}
133 
134 		columnManager = ColumnManager.build(tableViewer, columns, tableSettings, onSortChange);
135 	}
136 
137 	public ColumnManager getManager() {
138 		return columnManager;
139 	}
140 








141 	@SuppressWarnings(&quot;unchecked&quot;)
142 	public Supplier&lt;Stream&lt;? extends IItem&gt;&gt; getSelection() {
143 		List&lt;? extends IItem&gt; list = ((IStructuredSelection) columnManager.getViewer().getSelection()).toList();
144 		return () -&gt; list.stream();
145 	}
146 
147 	public void show(IItemCollection items) {
148 		show(ItemCollectionToolkit.stream(items).flatMap(ItemIterableToolkit::stream).iterator());
149 	}
150 
151 	public void show(Iterator&lt;? extends IItem&gt; it) {
152 		boolean showEllipsisMessage = false;
153 		int count = 0;
154 
155 		while (it.hasNext() &amp;&amp; count &lt; maxSizeArray.length - 1) {
156 			maxSizeArray[count++] = it.next();
157 		}
158 		IItem[] head;
159 		if (count &lt; maxSizeArray.length) {
160 			head = Arrays.copyOf(maxSizeArray, count);
</pre>
</td>
<td>
<hr />
<pre>
 48 import org.eclipse.osgi.util.NLS;
 49 import org.eclipse.swt.SWT;
 50 import org.eclipse.swt.widgets.Composite;
 51 import org.openjdk.jmc.common.collection.SimpleArray;
 52 import org.openjdk.jmc.common.item.IAttribute;
 53 import org.openjdk.jmc.common.item.IItem;
 54 import org.openjdk.jmc.common.item.IItemCollection;
 55 import org.openjdk.jmc.common.item.IMemberAccessor;
 56 import org.openjdk.jmc.common.item.ItemToolkit;
 57 import org.openjdk.jmc.common.unit.LinearKindOfQuantity;
 58 import org.openjdk.jmc.common.util.SortedHead;
 59 import org.openjdk.jmc.flightrecorder.ui.FlightRecorderUI;
 60 import org.openjdk.jmc.flightrecorder.ui.ItemCollectionToolkit;
 61 import org.openjdk.jmc.flightrecorder.ui.ItemIterableToolkit;
 62 import org.openjdk.jmc.flightrecorder.ui.messages.internal.Messages;
 63 import org.openjdk.jmc.ui.UIPlugin;
 64 import org.openjdk.jmc.ui.accessibility.FocusTracker;
 65 import org.openjdk.jmc.ui.column.ColumnBuilder;
 66 import org.openjdk.jmc.ui.column.ColumnManager;
 67 import org.openjdk.jmc.ui.column.ColumnManager.ColumnComparator;
<span class="line-added"> 68 import org.openjdk.jmc.ui.handlers.MCContextMenuManager;</span>
 69 import org.openjdk.jmc.ui.column.IColumn;
 70 import org.openjdk.jmc.ui.column.TableSettings;
 71 
 72 public class ItemList {
 73 
 74 	public static class ItemListBuilder {
 75 
 76 		private final List&lt;IColumn&gt; columns = new ArrayList&lt;&gt;();
 77 
 78 		public void addColumn(IAttribute&lt;?&gt; a) {
 79 			IMemberAccessor&lt;?, IItem&gt; accessor = ItemToolkit.accessor(a);
 80 			// FIXME: Calculate column id, e.g. using getColumnId.
 81 			// Otherwise there will be problem if adding multiple attributes with the same id.
 82 			// Requires update of all column id references, e.g. in the pages xml.
 83 			addColumn(a.getIdentifier(), a.getName(), a.getDescription(),
 84 					a.getContentType() instanceof LinearKindOfQuantity, accessor);
 85 		}
 86 
 87 		public void addColumn(
 88 			String columnId, String name, String description, boolean right, IMemberAccessor&lt;?, IItem&gt; accessor) {
 89 			columns.add(new ColumnBuilder(name, columnId, accessor).description(description)
 90 					.style(right ? SWT.RIGHT : SWT.NONE).build());
 91 		}
 92 
 93 		public ItemList buildWithoutBorder(Composite container, TableSettings tableSettings) {
 94 			return new ItemList(container, columns, tableSettings, SWT.NONE);
 95 		}
 96 
 97 		public ItemList build(Composite container, TableSettings tableSettings) {
 98 			return new ItemList(container, columns, tableSettings, SWT.BORDER);
 99 		}
100 	}
101 
102 	private final int maxSize = (int) FlightRecorderUI.getDefault().getItemListSize().longValue();
103 	private final IItem[] maxSizeArray = new IItem[maxSize + 1];
104 	private final ColumnManager columnManager;
105 	// FIXME: JMC-5127 - Don&#39;t initialize to 1000 elements
106 	private final SimpleArray&lt;IItem&gt; tail = new SimpleArray&lt;&gt;(new IItem[1000]);
107 
108 	private ExtraRowTableViewer tableViewer;
<span class="line-added">109 	private MCContextMenuManager menuManager;</span>
110 
111 	private ItemList(Composite container, List&lt;IColumn&gt; columns, TableSettings tableSettings, int style) {
112 		tableViewer = new ExtraRowTableViewer(container,
113 				SWT.MULTI | SWT.VIRTUAL | SWT.H_SCROLL | SWT.V_SCROLL | SWT.FULL_SELECTION | style);
114 		tableViewer.setContentProvider(ArrayContentProvider.getInstance());
115 		ColumnViewerToolTipSupport.enableFor(tableViewer);
116 		Consumer&lt;ColumnComparator&gt; onSortChange = comparator -&gt; {
117 			Object input = tableViewer.getInput();
118 			if (input instanceof IItem[] &amp;&amp; comparator != null) {
119 				IItem[] head = (IItem[]) input;
120 				if (tail.size() &gt; 0) {
121 					Iterator&lt;IItem&gt; oldTailIterator = tail.iterator();
122 					tail.clear();
123 					// addSorted will write to the array in tail, but not faster than it is read
124 					SortedHead.addSorted(oldTailIterator, head, tail, comparator);
125 				} else {
126 					Arrays.sort(head, comparator);
127 				}
128 				tableViewer.refresh();
129 				tableViewer.setSelection(StructuredSelection.EMPTY);
130 			}
131 		};
132 		if (UIPlugin.getDefault().getAccessibilityMode()) {
133 			FocusTracker.enableFocusTracking(tableViewer.getTable());
134 		}
135 
136 		columnManager = ColumnManager.build(tableViewer, columns, tableSettings, onSortChange);
137 	}
138 
139 	public ColumnManager getManager() {
140 		return columnManager;
141 	}
142 
<span class="line-added">143 	public void setMenuManager(MCContextMenuManager mm) {</span>
<span class="line-added">144 		menuManager = mm;</span>
<span class="line-added">145 	}</span>
<span class="line-added">146 </span>
<span class="line-added">147 	public MCContextMenuManager getMenuManager() {</span>
<span class="line-added">148 		return menuManager;</span>
<span class="line-added">149 	}</span>
<span class="line-added">150 </span>
151 	@SuppressWarnings(&quot;unchecked&quot;)
152 	public Supplier&lt;Stream&lt;? extends IItem&gt;&gt; getSelection() {
153 		List&lt;? extends IItem&gt; list = ((IStructuredSelection) columnManager.getViewer().getSelection()).toList();
154 		return () -&gt; list.stream();
155 	}
156 
157 	public void show(IItemCollection items) {
158 		show(ItemCollectionToolkit.stream(items).flatMap(ItemIterableToolkit::stream).iterator());
159 	}
160 
161 	public void show(Iterator&lt;? extends IItem&gt; it) {
162 		boolean showEllipsisMessage = false;
163 		int count = 0;
164 
165 		while (it.hasNext() &amp;&amp; count &lt; maxSizeArray.length - 1) {
166 			maxSizeArray[count++] = it.next();
167 		}
168 		IItem[] head;
169 		if (count &lt; maxSizeArray.length) {
170 			head = Arrays.copyOf(maxSizeArray, count);
</pre>
</td>
</tr>
</table>
<center><a href="DataPageToolkit.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="../pages/EventBrowserPage.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>