<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff application/org.openjdk.jmc.flightrecorder.ui/src/main/java/org/openjdk/jmc/flightrecorder/ui/pages/EventBrowserPage.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>application/org.openjdk.jmc.flightrecorder.ui/src/main/java/org/openjdk/jmc/flightrecorder/ui/pages/EventBrowserPage.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
159 		return ItemFilters.all();
160 	}
161 
162 	class EventBrowserUI implements IPageUI {
163 
164 		private static final String TREE_SASH = &quot;treeSash&quot;; //$NON-NLS-1$
165 		private static final String ITEM_LIST = &quot;itemList&quot;; //$NON-NLS-1$
166 		private static final String SHOW_TYPES_WITHOUT_EVENTS = &quot;showTypesWithoutEvents&quot;; //$NON-NLS-1$
167 		private static final String LIST_FILTER = &quot;listFilter&quot;; //$NON-NLS-1$
168 		private ItemList list;
169 		private final SashForm treeSash;
170 		private final IPageContainer container;
171 		private final List&lt;ColumnSettings&gt; listColumns = new ArrayList&lt;&gt;();
172 		private String listOrderBy;
173 		private Set&lt;IType&lt;?&gt;&gt; selectedTypes = Collections.emptySet();
174 		private final TypeFilterBuilder typeFilterTree;
175 		private IItemCollection selectionItems;
176 		private FlavorSelector flavorSelector;
177 		private FilterComponent listFilter;
178 		private Boolean showTypesWithoutEvents;


179 
180 		EventBrowserUI(Composite parent, FormToolkit toolkit, IState state, IPageContainer container) {
181 			this.container = container;
182 
183 			Form form = DataPageToolkit.createForm(parent, toolkit, getName(), getIcon());
184 
185 			treeSash = new SashForm(form.getBody(), SWT.HORIZONTAL);
186 			toolkit.adapt(treeSash);
187 			typeFilterTree = DataPageToolkit.buildEventTypeTree(treeSash, toolkit, this::onTypeChange, false);
188 			MCContextMenuManager mm = typeFilterTree.getMenuManager();
189 			IAction addPageAction = ActionToolkit.action(() -&gt; DataPageToolkit.addPage(selectedTypes),
190 					Messages.EventBrowserPage_NEW_PAGE_USING_TYPES_ACTION, NEW_PAGE_ICON);
191 			mm.appendToGroup(MCContextMenuManager.GROUP_NEW, addPageAction);
192 
193 			IAction typesWithoutEventsAction = ActionToolkit.checkAction(this::setTypesWithoutEvents,
194 					Messages.EventBrowserPage_DISPLAY_TYPES_WITHOUT_EVENTS, null);
195 			showTypesWithoutEvents = StateToolkit.readBoolean(state, SHOW_TYPES_WITHOUT_EVENTS, true);
196 			typesWithoutEventsAction.setChecked(showTypesWithoutEvents);
197 			mm.appendToGroup(MCContextMenuManager.GROUP_OPEN, typesWithoutEventsAction);
198 
</pre>
<hr />
<pre>
315 			ItemListBuilder itemListBuilder = new ItemListBuilder();
316 			commonAttributes.forEach(a -&gt; {
317 				String combinedId = ItemList.getColumnId(a);
318 				ContentType&lt;?&gt; contentType = a.getContentType();
319 				IMemberAccessor&lt;?, IItem&gt; accessor = ItemToolkit.accessor(a);
320 				// FIXME: This is duplicated in JfrPropertySheet, where we also create a tooltip for an attribute.
321 				itemListBuilder.addColumn(combinedId, a.getName(),
322 						NLS.bind(Messages.ATTRIBUTE_ID_LABEL, a.getIdentifier()) + System.getProperty(&quot;line.separator&quot;) //$NON-NLS-1$
323 								+ NLS.bind(Messages.ATTRIBUTE_DESCRIPTION_LABEL, a.getDescription()),
324 						contentType instanceof LinearKindOfQuantity, accessor);
325 				if (combinedId.equals(listOrderBy)) {
326 					// the list now has the most current order, to allow the list to clear it
327 					listOrderBy = null;
328 				}
329 				if (!existingColumnIds.contains(combinedId)) {
330 					newColumns.add(0, new ColumnSettings(combinedId, false, null, null));
331 				}
332 			});
333 			listColumns.addAll(0, newColumns);
334 

335 			Control oldListControl = list.getManager().getViewer().getControl();
336 			Composite parent = listFilter != null ? listFilter.getComponent().getParent() : oldListControl.getParent();
337 			for (Control c : parent.getChildren()) {
338 				c.dispose();
339 			}
340 			list = DataPageToolkit.createSimpleItemList(parent, itemListBuilder, container,
341 					DataPageToolkit.createTableSettingsByOrderByAndColumnsWithDefaultOrdering(orderBy, listColumns),
342 					Messages.EventBrowserPage_EVENT_BROWSER_SELECTION);
343 			listFilter = FilterComponent.createFilterComponent(list, flagsFilter, filteredItems,
344 					container.getSelectionStore()::getSelections, this::onFilterChange);
<span class="line-modified">345 			listFilter.loadState(getState().getChild(LIST_FILTER));</span>




346 			onFilterChange(flagsFilter);
347 
348 			MCContextMenuManager mm = list.getMenuManager();
349 			mm.add(listFilter.getShowFilterAction());
350 			mm.add(listFilter.getShowSearchAction());
351 
352 			parent.layout();
353 			list.show(filteredItems);
354 		}
355 
356 		private void mergeListSettings() {
357 			TableSettings settings = list.getManager().getSettings();
358 			Set&lt;String&gt; columns = settings.getColumns().stream().map(ColumnSettings::getId).collect(Collectors.toSet());
359 			List&lt;Integer&gt; replaceIndexs = new ArrayList&lt;&gt;(columns.size());
360 			for (int i = 0; i &lt; listColumns.size(); i++) {
361 				if (columns.contains(listColumns.get(i).getId())) {
362 					replaceIndexs.add(i);
363 				}
364 			}
365 			Iterator&lt;ColumnSettings&gt; replacements = settings.getColumns().iterator();
366 			Iterator&lt;Integer&gt; indexs = replaceIndexs.iterator();
367 			while (indexs.hasNext() &amp;&amp; replacements.hasNext()) {
368 				listColumns.set(indexs.next(), replacements.next());
369 			}
370 			if (settings.getOrderBy() != null) {
371 				listOrderBy = settings.getOrderBy();
372 			}
373 		}
374 














375 		@Override
376 		public void saveTo(IWritableState state) {
377 			PersistableSashForm.saveState(treeSash, state.createChild(TREE_SASH));
378 			mergeListSettings();
379 			new TableSettings(listOrderBy, listColumns).saveState(state.createChild(ITEM_LIST));
380 			StateToolkit.writeBoolean(state, SHOW_TYPES_WITHOUT_EVENTS, showTypesWithoutEvents);
381 			listFilter.saveState(state.createChild(LIST_FILTER));
382 			saveToLocal();
383 		}
384 
385 		private void saveToLocal() {
386 			treeSelection = typeFilterTree.getViewer().getSelection();
387 			treeExpansion = typeFilterTree.getViewer().getExpandedTreePaths();
388 			// FIXME: indexOf doesn&#39;t seem to work for some reason, probably an SWT bug
389 //			topIndex = typeFilterTree.getViewer().getTree().indexOf(typeFilterTree.getViewer().getTree().getTopItem());
390 			tableSelection = list.getManager().getSelectionState();
391 			flavorSelectorState = flavorSelector.getFlavorSelectorState();
392 		}
393 	}
394 }
</pre>
</td>
<td>
<hr />
<pre>
159 		return ItemFilters.all();
160 	}
161 
162 	class EventBrowserUI implements IPageUI {
163 
164 		private static final String TREE_SASH = &quot;treeSash&quot;; //$NON-NLS-1$
165 		private static final String ITEM_LIST = &quot;itemList&quot;; //$NON-NLS-1$
166 		private static final String SHOW_TYPES_WITHOUT_EVENTS = &quot;showTypesWithoutEvents&quot;; //$NON-NLS-1$
167 		private static final String LIST_FILTER = &quot;listFilter&quot;; //$NON-NLS-1$
168 		private ItemList list;
169 		private final SashForm treeSash;
170 		private final IPageContainer container;
171 		private final List&lt;ColumnSettings&gt; listColumns = new ArrayList&lt;&gt;();
172 		private String listOrderBy;
173 		private Set&lt;IType&lt;?&gt;&gt; selectedTypes = Collections.emptySet();
174 		private final TypeFilterBuilder typeFilterTree;
175 		private IItemCollection selectionItems;
176 		private FlavorSelector flavorSelector;
177 		private FilterComponent listFilter;
178 		private Boolean showTypesWithoutEvents;
<span class="line-added">179 		private Boolean showFilterAction;</span>
<span class="line-added">180 		private Boolean showSearchAction;</span>
181 
182 		EventBrowserUI(Composite parent, FormToolkit toolkit, IState state, IPageContainer container) {
183 			this.container = container;
184 
185 			Form form = DataPageToolkit.createForm(parent, toolkit, getName(), getIcon());
186 
187 			treeSash = new SashForm(form.getBody(), SWT.HORIZONTAL);
188 			toolkit.adapt(treeSash);
189 			typeFilterTree = DataPageToolkit.buildEventTypeTree(treeSash, toolkit, this::onTypeChange, false);
190 			MCContextMenuManager mm = typeFilterTree.getMenuManager();
191 			IAction addPageAction = ActionToolkit.action(() -&gt; DataPageToolkit.addPage(selectedTypes),
192 					Messages.EventBrowserPage_NEW_PAGE_USING_TYPES_ACTION, NEW_PAGE_ICON);
193 			mm.appendToGroup(MCContextMenuManager.GROUP_NEW, addPageAction);
194 
195 			IAction typesWithoutEventsAction = ActionToolkit.checkAction(this::setTypesWithoutEvents,
196 					Messages.EventBrowserPage_DISPLAY_TYPES_WITHOUT_EVENTS, null);
197 			showTypesWithoutEvents = StateToolkit.readBoolean(state, SHOW_TYPES_WITHOUT_EVENTS, true);
198 			typesWithoutEventsAction.setChecked(showTypesWithoutEvents);
199 			mm.appendToGroup(MCContextMenuManager.GROUP_OPEN, typesWithoutEventsAction);
200 
</pre>
<hr />
<pre>
317 			ItemListBuilder itemListBuilder = new ItemListBuilder();
318 			commonAttributes.forEach(a -&gt; {
319 				String combinedId = ItemList.getColumnId(a);
320 				ContentType&lt;?&gt; contentType = a.getContentType();
321 				IMemberAccessor&lt;?, IItem&gt; accessor = ItemToolkit.accessor(a);
322 				// FIXME: This is duplicated in JfrPropertySheet, where we also create a tooltip for an attribute.
323 				itemListBuilder.addColumn(combinedId, a.getName(),
324 						NLS.bind(Messages.ATTRIBUTE_ID_LABEL, a.getIdentifier()) + System.getProperty(&quot;line.separator&quot;) //$NON-NLS-1$
325 								+ NLS.bind(Messages.ATTRIBUTE_DESCRIPTION_LABEL, a.getDescription()),
326 						contentType instanceof LinearKindOfQuantity, accessor);
327 				if (combinedId.equals(listOrderBy)) {
328 					// the list now has the most current order, to allow the list to clear it
329 					listOrderBy = null;
330 				}
331 				if (!existingColumnIds.contains(combinedId)) {
332 					newColumns.add(0, new ColumnSettings(combinedId, false, null, null));
333 				}
334 			});
335 			listColumns.addAll(0, newColumns);
336 
<span class="line-added">337 			saveFilterActionStates();</span>
338 			Control oldListControl = list.getManager().getViewer().getControl();
339 			Composite parent = listFilter != null ? listFilter.getComponent().getParent() : oldListControl.getParent();
340 			for (Control c : parent.getChildren()) {
341 				c.dispose();
342 			}
343 			list = DataPageToolkit.createSimpleItemList(parent, itemListBuilder, container,
344 					DataPageToolkit.createTableSettingsByOrderByAndColumnsWithDefaultOrdering(orderBy, listColumns),
345 					Messages.EventBrowserPage_EVENT_BROWSER_SELECTION);
346 			listFilter = FilterComponent.createFilterComponent(list, flagsFilter, filteredItems,
347 					container.getSelectionStore()::getSelections, this::onFilterChange);
<span class="line-modified">348 			if (showFilterAction == null) {</span>
<span class="line-added">349 				listFilter.loadState(getState().getChild(LIST_FILTER));</span>
<span class="line-added">350 			} else {</span>
<span class="line-added">351 				loadFilterActionStates();</span>
<span class="line-added">352 			}</span>
353 			onFilterChange(flagsFilter);
354 
355 			MCContextMenuManager mm = list.getMenuManager();
356 			mm.add(listFilter.getShowFilterAction());
357 			mm.add(listFilter.getShowSearchAction());
358 
359 			parent.layout();
360 			list.show(filteredItems);
361 		}
362 
363 		private void mergeListSettings() {
364 			TableSettings settings = list.getManager().getSettings();
365 			Set&lt;String&gt; columns = settings.getColumns().stream().map(ColumnSettings::getId).collect(Collectors.toSet());
366 			List&lt;Integer&gt; replaceIndexs = new ArrayList&lt;&gt;(columns.size());
367 			for (int i = 0; i &lt; listColumns.size(); i++) {
368 				if (columns.contains(listColumns.get(i).getId())) {
369 					replaceIndexs.add(i);
370 				}
371 			}
372 			Iterator&lt;ColumnSettings&gt; replacements = settings.getColumns().iterator();
373 			Iterator&lt;Integer&gt; indexs = replaceIndexs.iterator();
374 			while (indexs.hasNext() &amp;&amp; replacements.hasNext()) {
375 				listColumns.set(indexs.next(), replacements.next());
376 			}
377 			if (settings.getOrderBy() != null) {
378 				listOrderBy = settings.getOrderBy();
379 			}
380 		}
381 
<span class="line-added">382 		private void saveFilterActionStates() {</span>
<span class="line-added">383 			if (listFilter != null) {</span>
<span class="line-added">384 				showFilterAction = listFilter.getShowFilterAction().isChecked();</span>
<span class="line-added">385 				showSearchAction = listFilter.getShowSearchAction().isChecked();</span>
<span class="line-added">386 			}</span>
<span class="line-added">387 		}</span>
<span class="line-added">388 </span>
<span class="line-added">389 		private void loadFilterActionStates() {</span>
<span class="line-added">390 			listFilter.getShowFilterAction().setChecked(showFilterAction);</span>
<span class="line-added">391 			listFilter.getShowSearchAction().setChecked(showSearchAction);</span>
<span class="line-added">392 			listFilter.getShowFilterAction().run();</span>
<span class="line-added">393 			listFilter.getShowSearchAction().run();</span>
<span class="line-added">394 		}</span>
<span class="line-added">395 </span>
396 		@Override
397 		public void saveTo(IWritableState state) {
398 			PersistableSashForm.saveState(treeSash, state.createChild(TREE_SASH));
399 			mergeListSettings();
400 			new TableSettings(listOrderBy, listColumns).saveState(state.createChild(ITEM_LIST));
401 			StateToolkit.writeBoolean(state, SHOW_TYPES_WITHOUT_EVENTS, showTypesWithoutEvents);
402 			listFilter.saveState(state.createChild(LIST_FILTER));
403 			saveToLocal();
404 		}
405 
406 		private void saveToLocal() {
407 			treeSelection = typeFilterTree.getViewer().getSelection();
408 			treeExpansion = typeFilterTree.getViewer().getExpandedTreePaths();
409 			// FIXME: indexOf doesn&#39;t seem to work for some reason, probably an SWT bug
410 //			topIndex = typeFilterTree.getViewer().getTree().indexOf(typeFilterTree.getViewer().getTree().getTopItem());
411 			tableSelection = list.getManager().getSelectionState();
412 			flavorSelectorState = flavorSelector.getFlavorSelectorState();
413 		}
414 	}
415 }
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>