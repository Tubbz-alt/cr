<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff core/org.openjdk.jmc.flightrecorder.rules.jdk/src/main/java/org/openjdk/jmc/flightrecorder/rules/jdk/memory/FullGcRule.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="AutoBoxingRule.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../../index.html" target="_top">index</a> <a href="GarbageCollectionsInfo.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>core/org.openjdk.jmc.flightrecorder.rules.jdk/src/main/java/org/openjdk/jmc/flightrecorder/rules/jdk/memory/FullGcRule.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 56 import org.openjdk.jmc.flightrecorder.jdk.JdkAttributes;
 57 import org.openjdk.jmc.flightrecorder.jdk.JdkFilters;
 58 import org.openjdk.jmc.flightrecorder.jdk.JdkTypeIDs;
 59 import org.openjdk.jmc.flightrecorder.rules.IRule;
 60 import org.openjdk.jmc.flightrecorder.rules.Result;
 61 import org.openjdk.jmc.flightrecorder.rules.jdk.messages.internal.Messages;
 62 import org.openjdk.jmc.flightrecorder.rules.util.JfrRuleTopics;
 63 import org.openjdk.jmc.flightrecorder.rules.util.RulesToolkit;
 64 import org.openjdk.jmc.flightrecorder.rules.util.RulesToolkit.EventAvailability;
 65 
 66 public class FullGcRule implements IRule {
 67 	private static final String FULL_GC_RESULT_ID = &quot;FullGc&quot;; //$NON-NLS-1$
 68 
 69 	@Override
 70 	public RunnableFuture&lt;Result&gt; evaluate(final IItemCollection items, final IPreferenceValueProvider valueProvider) {
 71 		return new FutureTask&lt;&gt;(new Callable&lt;Result&gt;() {
 72 			@Override
 73 			public Result call() throws Exception {
 74 				final CollectorType collectorType = CollectorType.getOldCollectorType(items);
 75 				if (!(CollectorType.CMS.equals(collectorType) || CollectorType.G1_OLD.equals(collectorType))) {
<span class="line-modified"> 76 					return RulesToolkit.getNotApplicableResult(</span>
<span class="line-modified"> 77 							FullGcRule.this,</span>
<span class="line-removed"> 78 							Messages.getString(Messages.FullGcRule_OTHER_COLLECTOR_IN_USE)</span>
<span class="line-removed"> 79 							);</span>
 80 				}
 81 
 82 				final String[] eventTypes;
 83 				if (CollectorType.CMS.equals(collectorType)) {
<span class="line-modified"> 84 					eventTypes = new String[] { JdkTypeIDs.GC_COLLECTOR_OLD_GARBAGE_COLLECTION };</span>
 85 				} else {
 86 					eventTypes = G1Aggregator.EVENT_TYPES;
 87 				}
 88 				if (!hasAvailableEvents(items, eventTypes)) {
<span class="line-modified"> 89 					return RulesToolkit.getEventAvailabilityResult(</span>
<span class="line-modified"> 90 							FullGcRule.this,</span>
<span class="line-removed"> 91 							items,</span>
<span class="line-removed"> 92 							RulesToolkit.getEventAvailability(items, eventTypes),</span>
<span class="line-removed"> 93 							eventTypes</span>
<span class="line-removed"> 94 							);</span>
 95 				}
 96 
 97 				final int fullGCs;
 98 				if (CollectorType.CMS.equals(collectorType)) {
<span class="line-modified"> 99 					final IQuantity c = items.getAggregate(Aggregators.count(null, null, JdkFilters.OLD_GARBAGE_COLLECTION));</span>

100 					fullGCs = c == null ? 0 : c.clampedIntFloorIn(NUMBER_UNITY);
101 				} else {
102 					fullGCs = items.getAggregate(new G1Aggregator()).fullGCs;
103 				}
104 
105 				if (fullGCs &gt; 0) {
<span class="line-modified">106 					return new Result(</span>
<span class="line-removed">107 							FullGcRule.this, 100,</span>
108 							Messages.getString(Messages.FullGcRule_FULL_GC_OCCURRED_TITLE),
<span class="line-modified">109 							Messages.getString(Messages.FullGcRule_FULL_GC_OCCURRED_DESC)</span>
<span class="line-removed">110 							);</span>
111 				} else {
<span class="line-modified">112 					return new Result(</span>
<span class="line-removed">113 							FullGcRule.this,</span>
<span class="line-removed">114 							0,</span>
<span class="line-removed">115 							Messages.getString(Messages.FullGcRule_NO_FULL_GC_OCCURRED)</span>
<span class="line-removed">116 							);</span>
117 				}
118 			}
119 		});
120 	}
121 
122 	private boolean hasAvailableEvents(final IItemCollection items, final String[] eventTypes) {
123 		return RulesToolkit.getEventAvailability(items, eventTypes) == EventAvailability.AVAILABLE;
124 	}
125 
126 	@Override
127 	public Collection&lt;TypedPreference&lt;?&gt;&gt; getConfigurationAttributes() {
128 		return Collections.emptyList();
129 	}
130 
131 	@Override
132 	public String getId() {
133 		return FULL_GC_RESULT_ID;
134 	}
135 
136 	@Override
137 	public String getName() {
138 		return Messages.getString(Messages.FullGcRule_RULE_NAME);
139 	}
140 
141 	@Override
142 	public String getTopic() {
143 		return JfrRuleTopics.GARBAGE_COLLECTION_TOPIC;
144 	}
145 
146 	private static class G1Aggregator extends MergingAggregator&lt;G1FullGCInfo, G1FullGCInfo&gt; {
<span class="line-modified">147 		static final String[] EVENT_TYPES = new String[] { JdkTypeIDs.GARBAGE_COLLECTION };</span>
148 
149 		G1Aggregator() {
150 			super(null, null, UnitLookup.UNKNOWN);
151 		}
152 
153 		@Override
154 		public final boolean acceptType(final IType&lt;IItem&gt; type) {
155 			return Arrays.asList(EVENT_TYPES).contains(type.getIdentifier());
156 		}
157 
158 		@Override
159 		public G1FullGCInfo newItemConsumer(final IType&lt;IItem&gt; type) {
160 			return new G1FullGCInfo(JdkAttributes.GC_NAME.getAccessor(type));
161 		}
162 
163 		@Override
164 		public G1FullGCInfo getValue(final G1FullGCInfo consumer) {
165 			return consumer == null ? new G1FullGCInfo(null) : consumer;
166 		}
167 	}
</pre>
</td>
<td>
<hr />
<pre>
 56 import org.openjdk.jmc.flightrecorder.jdk.JdkAttributes;
 57 import org.openjdk.jmc.flightrecorder.jdk.JdkFilters;
 58 import org.openjdk.jmc.flightrecorder.jdk.JdkTypeIDs;
 59 import org.openjdk.jmc.flightrecorder.rules.IRule;
 60 import org.openjdk.jmc.flightrecorder.rules.Result;
 61 import org.openjdk.jmc.flightrecorder.rules.jdk.messages.internal.Messages;
 62 import org.openjdk.jmc.flightrecorder.rules.util.JfrRuleTopics;
 63 import org.openjdk.jmc.flightrecorder.rules.util.RulesToolkit;
 64 import org.openjdk.jmc.flightrecorder.rules.util.RulesToolkit.EventAvailability;
 65 
 66 public class FullGcRule implements IRule {
 67 	private static final String FULL_GC_RESULT_ID = &quot;FullGc&quot;; //$NON-NLS-1$
 68 
 69 	@Override
 70 	public RunnableFuture&lt;Result&gt; evaluate(final IItemCollection items, final IPreferenceValueProvider valueProvider) {
 71 		return new FutureTask&lt;&gt;(new Callable&lt;Result&gt;() {
 72 			@Override
 73 			public Result call() throws Exception {
 74 				final CollectorType collectorType = CollectorType.getOldCollectorType(items);
 75 				if (!(CollectorType.CMS.equals(collectorType) || CollectorType.G1_OLD.equals(collectorType))) {
<span class="line-modified"> 76 					return RulesToolkit.getNotApplicableResult(FullGcRule.this,</span>
<span class="line-modified"> 77 							Messages.getString(Messages.FullGcRule_OTHER_COLLECTOR_IN_USE));</span>


 78 				}
 79 
 80 				final String[] eventTypes;
 81 				if (CollectorType.CMS.equals(collectorType)) {
<span class="line-modified"> 82 					eventTypes = new String[] {JdkTypeIDs.GC_COLLECTOR_OLD_GARBAGE_COLLECTION};</span>
 83 				} else {
 84 					eventTypes = G1Aggregator.EVENT_TYPES;
 85 				}
 86 				if (!hasAvailableEvents(items, eventTypes)) {
<span class="line-modified"> 87 					return RulesToolkit.getEventAvailabilityResult(FullGcRule.this, items,</span>
<span class="line-modified"> 88 							RulesToolkit.getEventAvailability(items, eventTypes), eventTypes);</span>




 89 				}
 90 
 91 				final int fullGCs;
 92 				if (CollectorType.CMS.equals(collectorType)) {
<span class="line-modified"> 93 					final IQuantity c = items</span>
<span class="line-added"> 94 							.getAggregate(Aggregators.count(null, null, JdkFilters.OLD_GARBAGE_COLLECTION));</span>
 95 					fullGCs = c == null ? 0 : c.clampedIntFloorIn(NUMBER_UNITY);
 96 				} else {
 97 					fullGCs = items.getAggregate(new G1Aggregator()).fullGCs;
 98 				}
 99 
100 				if (fullGCs &gt; 0) {
<span class="line-modified">101 					return new Result(FullGcRule.this, 100,</span>

102 							Messages.getString(Messages.FullGcRule_FULL_GC_OCCURRED_TITLE),
<span class="line-modified">103 							Messages.getString(Messages.FullGcRule_FULL_GC_OCCURRED_DESC));</span>

104 				} else {
<span class="line-modified">105 					return new Result(FullGcRule.this, 0, Messages.getString(Messages.FullGcRule_NO_FULL_GC_OCCURRED));</span>




106 				}
107 			}
108 		});
109 	}
110 
111 	private boolean hasAvailableEvents(final IItemCollection items, final String[] eventTypes) {
112 		return RulesToolkit.getEventAvailability(items, eventTypes) == EventAvailability.AVAILABLE;
113 	}
114 
115 	@Override
116 	public Collection&lt;TypedPreference&lt;?&gt;&gt; getConfigurationAttributes() {
117 		return Collections.emptyList();
118 	}
119 
120 	@Override
121 	public String getId() {
122 		return FULL_GC_RESULT_ID;
123 	}
124 
125 	@Override
126 	public String getName() {
127 		return Messages.getString(Messages.FullGcRule_RULE_NAME);
128 	}
129 
130 	@Override
131 	public String getTopic() {
132 		return JfrRuleTopics.GARBAGE_COLLECTION_TOPIC;
133 	}
134 
135 	private static class G1Aggregator extends MergingAggregator&lt;G1FullGCInfo, G1FullGCInfo&gt; {
<span class="line-modified">136 		static final String[] EVENT_TYPES = new String[] {JdkTypeIDs.GARBAGE_COLLECTION};</span>
137 
138 		G1Aggregator() {
139 			super(null, null, UnitLookup.UNKNOWN);
140 		}
141 
142 		@Override
143 		public final boolean acceptType(final IType&lt;IItem&gt; type) {
144 			return Arrays.asList(EVENT_TYPES).contains(type.getIdentifier());
145 		}
146 
147 		@Override
148 		public G1FullGCInfo newItemConsumer(final IType&lt;IItem&gt; type) {
149 			return new G1FullGCInfo(JdkAttributes.GC_NAME.getAccessor(type));
150 		}
151 
152 		@Override
153 		public G1FullGCInfo getValue(final G1FullGCInfo consumer) {
154 			return consumer == null ? new G1FullGCInfo(null) : consumer;
155 		}
156 	}
</pre>
</td>
</tr>
</table>
<center><a href="AutoBoxingRule.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../../index.html" target="_top">index</a> <a href="GarbageCollectionsInfo.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>