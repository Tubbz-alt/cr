<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff application/org.openjdk.jmc.rjmx/src/main/java/org/openjdk/jmc/rjmx/ConnectionToolkit.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../../org.openjdk.jmc.rjmx.services.jfr/src/main/java/org/openjdk/jmc/rjmx/services/jfr/internal/FlightRecorderServiceV2.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="JVMSupportToolkit.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>application/org.openjdk.jmc.rjmx/src/main/java/org/openjdk/jmc/rjmx/ConnectionToolkit.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2018, Oracle and/or its affiliates. All rights reserved.</span>
  3  * 
  4  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  5  *
  6  * The contents of this file are subject to the terms of either the Universal Permissive License
  7  * v 1.0 as shown at http://oss.oracle.com/licenses/upl
  8  *
  9  * or the following license:
 10  *
 11  * Redistribution and use in source and binary forms, with or without modification, are permitted
 12  * provided that the following conditions are met:
 13  * 
 14  * 1. Redistributions of source code must retain the above copyright notice, this list of conditions
 15  * and the following disclaimer.
 16  * 
 17  * 2. Redistributions in binary form must reproduce the above copyright notice, this list of
 18  * conditions and the following disclaimer in the documentation and/or other materials provided with
 19  * the distribution.
 20  * 
 21  * 3. Neither the name of the copyright holder nor the names of its contributors may be used to
 22  * endorse or promote products derived from this software without specific prior written permission.
</pre>
<hr />
<pre>
 39 import java.lang.management.RuntimeMXBean;
 40 import java.lang.management.ThreadMXBean;
 41 import java.lang.reflect.UndeclaredThrowableException;
 42 import java.net.MalformedURLException;
 43 import java.util.List;
 44 import java.util.Map;
 45 import java.util.StringTokenizer;
 46 import java.util.logging.Level;
 47 
 48 import javax.management.JMException;
 49 import javax.management.MBeanServerConnection;
 50 import javax.management.MalformedObjectNameException;
 51 import javax.management.ObjectName;
 52 import javax.management.openmbean.CompositeData;
 53 import javax.management.openmbean.TabularData;
 54 import javax.management.remote.JMXServiceURL;
 55 
 56 import org.openjdk.jmc.common.version.JavaVMVersionToolkit;
 57 import org.openjdk.jmc.common.version.JavaVersion;
 58 import org.openjdk.jmc.rjmx.internal.RJMXConnection;

 59 
 60 /**
 61  * Toolkit providing utility methods to retrieve MBean proxy objects, invoke JMX operations and
 62  * query a connection about its properties.
 63  */
 64 public final class ConnectionToolkit {
 65 
 66 	/**
 67 	 * Object name for the {@link ManagementFactory#RUNTIME_MXBEAN_NAME} constant.
 68 	 */
 69 	public static final ObjectName RUNTIME_BEAN_NAME = createObjectName(ManagementFactory.RUNTIME_MXBEAN_NAME);
 70 	/**
 71 	 * Object name for the {@link ManagementFactory#MEMORY_MXBEAN_NAME} constant.
 72 	 */
 73 	public static final ObjectName MEMORY_BEAN_NAME = createObjectName(ManagementFactory.MEMORY_MXBEAN_NAME);
 74 	/**
 75 	 * Object name for the {@link ManagementFactory#THREAD_MXBEAN_NAME} constant.
 76 	 */
 77 	public static final ObjectName THREAD_BEAN_NAME = createObjectName(ManagementFactory.THREAD_MXBEAN_NAME);
 78 	/**
</pre>
<hr />
<pre>
329 	/**
330 	 * Returns the default port number for the management agent.
331 	 *
332 	 * @return the default port for the management agent. May vary depending on which JVM version
333 	 *         the method is executed in.
334 	 */
335 	public static int getDefaultPort() {
336 		return RJMXConnection.VALUE_DEFAULT_REMOTE_PORT_JMX;
337 	}
338 
339 	/**
340 	 * Returns {@code true} if the connection handle is connected to a JRockit, {@code false}
341 	 * otherwise.
342 	 *
343 	 * @param connectionHandle
344 	 *            the connection handle to check.
345 	 * @return {@code true} if the connection handle is connected to a JRockit, {@code false}
346 	 *         otherwise.
347 	 */
348 	public static boolean isJRockit(IConnectionHandle connectionHandle) {
<span class="line-removed">349 </span>
350 		String vmName = getVMName(connectionHandle);
351 		return JavaVMVersionToolkit.isJRockitJVMName(vmName);
352 	}
353 
354 	/**
355 	 * Returns {@code true} if the connection handle is connected to a HotSpot, {@code false}
356 	 * otherwise. This method requires the connection handle to be connected.
357 	 *
358 	 * @param connectionHandle
359 	 *            the connection handle to check.
360 	 * @return {@code true} if the connection handle is connected to a HotSpot, {@code false}
361 	 *         otherwise.
362 	 */
363 	public static boolean isHotSpot(IConnectionHandle connectionHandle) {
364 		String vmName = getVMName(connectionHandle);
365 		return vmName != null &amp;&amp; JavaVMVersionToolkit.isHotspotJVMName(vmName);
366 	}
367 




























368 	/**
369 	 * This will return true if the java version is above or equal the supplied value. (For example
370 	 * 1.7.0_40).
371 	 *
372 	 * @param connectionHandle
373 	 *            the connectionHandle to check.
374 	 * @param minVersion
375 	 *            the java version needed.
376 	 * @return {@code true} if the version is above or equal the supplied value, {@code true} if no
377 	 *         version can be obtained from the connection, {@code false} otherwise.
378 	 */
379 	public static boolean isJavaVersionAboveOrEqual(IConnectionHandle connectionHandle, JavaVersion minVersion) {
380 		JavaVersion version = getJavaVersion(connectionHandle);
381 		return version != null ? version.isGreaterOrEqualThan(minVersion) : true;
382 	}
383 
384 	private static String getVMName(IConnectionHandle connectionHandle) {
385 		MBeanServerConnection connection = connectionHandle.getServiceOrDummy(MBeanServerConnection.class);
386 		try {
387 			// getAttribute may fail if the connection handle
</pre>
<hr />
<pre>
394 		return null;
395 	}
396 
397 	private static JavaVersion getJavaVersion(IConnectionHandle connectionHandle) {
398 		try {
399 			MBeanServerConnection server = connectionHandle.getServiceOrThrow(MBeanServerConnection.class);
400 			Map&lt;String, String&gt; serverProps = getRuntimeBean(server).getSystemProperties();
401 			String javaVersion = serverProps.get(&quot;java.version&quot;); //$NON-NLS-1$
402 			if (javaVersion != null) {
403 				return new JavaVersion(javaVersion);
404 			}
405 			RJMXPlugin.getDefault().getLogger().log(Level.WARNING,
406 					&quot;System Properties from &quot; + connectionHandle.getDescription() //$NON-NLS-1$
407 							+ &quot; contained no java.version property!&quot;); //$NON-NLS-1$
408 		} catch (Exception e) {
409 			RJMXPlugin.getDefault().getLogger().log(Level.WARNING,
410 					&quot;Could not check the java.version from System Properties!&quot;, e); //$NON-NLS-1$
411 		}
412 		return null;
413 	}
<span class="line-removed">414 </span>
415 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.</span>
  3  * 
  4  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  5  *
  6  * The contents of this file are subject to the terms of either the Universal Permissive License
  7  * v 1.0 as shown at http://oss.oracle.com/licenses/upl
  8  *
  9  * or the following license:
 10  *
 11  * Redistribution and use in source and binary forms, with or without modification, are permitted
 12  * provided that the following conditions are met:
 13  * 
 14  * 1. Redistributions of source code must retain the above copyright notice, this list of conditions
 15  * and the following disclaimer.
 16  * 
 17  * 2. Redistributions in binary form must reproduce the above copyright notice, this list of
 18  * conditions and the following disclaimer in the documentation and/or other materials provided with
 19  * the distribution.
 20  * 
 21  * 3. Neither the name of the copyright holder nor the names of its contributors may be used to
 22  * endorse or promote products derived from this software without specific prior written permission.
</pre>
<hr />
<pre>
 39 import java.lang.management.RuntimeMXBean;
 40 import java.lang.management.ThreadMXBean;
 41 import java.lang.reflect.UndeclaredThrowableException;
 42 import java.net.MalformedURLException;
 43 import java.util.List;
 44 import java.util.Map;
 45 import java.util.StringTokenizer;
 46 import java.util.logging.Level;
 47 
 48 import javax.management.JMException;
 49 import javax.management.MBeanServerConnection;
 50 import javax.management.MalformedObjectNameException;
 51 import javax.management.ObjectName;
 52 import javax.management.openmbean.CompositeData;
 53 import javax.management.openmbean.TabularData;
 54 import javax.management.remote.JMXServiceURL;
 55 
 56 import org.openjdk.jmc.common.version.JavaVMVersionToolkit;
 57 import org.openjdk.jmc.common.version.JavaVersion;
 58 import org.openjdk.jmc.rjmx.internal.RJMXConnection;
<span class="line-added"> 59 import org.openjdk.jmc.ui.common.jvm.JVMDescriptor;</span>
 60 
 61 /**
 62  * Toolkit providing utility methods to retrieve MBean proxy objects, invoke JMX operations and
 63  * query a connection about its properties.
 64  */
 65 public final class ConnectionToolkit {
 66 
 67 	/**
 68 	 * Object name for the {@link ManagementFactory#RUNTIME_MXBEAN_NAME} constant.
 69 	 */
 70 	public static final ObjectName RUNTIME_BEAN_NAME = createObjectName(ManagementFactory.RUNTIME_MXBEAN_NAME);
 71 	/**
 72 	 * Object name for the {@link ManagementFactory#MEMORY_MXBEAN_NAME} constant.
 73 	 */
 74 	public static final ObjectName MEMORY_BEAN_NAME = createObjectName(ManagementFactory.MEMORY_MXBEAN_NAME);
 75 	/**
 76 	 * Object name for the {@link ManagementFactory#THREAD_MXBEAN_NAME} constant.
 77 	 */
 78 	public static final ObjectName THREAD_BEAN_NAME = createObjectName(ManagementFactory.THREAD_MXBEAN_NAME);
 79 	/**
</pre>
<hr />
<pre>
330 	/**
331 	 * Returns the default port number for the management agent.
332 	 *
333 	 * @return the default port for the management agent. May vary depending on which JVM version
334 	 *         the method is executed in.
335 	 */
336 	public static int getDefaultPort() {
337 		return RJMXConnection.VALUE_DEFAULT_REMOTE_PORT_JMX;
338 	}
339 
340 	/**
341 	 * Returns {@code true} if the connection handle is connected to a JRockit, {@code false}
342 	 * otherwise.
343 	 *
344 	 * @param connectionHandle
345 	 *            the connection handle to check.
346 	 * @return {@code true} if the connection handle is connected to a JRockit, {@code false}
347 	 *         otherwise.
348 	 */
349 	public static boolean isJRockit(IConnectionHandle connectionHandle) {

350 		String vmName = getVMName(connectionHandle);
351 		return JavaVMVersionToolkit.isJRockitJVMName(vmName);
352 	}
353 
354 	/**
355 	 * Returns {@code true} if the connection handle is connected to a HotSpot, {@code false}
356 	 * otherwise. This method requires the connection handle to be connected.
357 	 *
358 	 * @param connectionHandle
359 	 *            the connection handle to check.
360 	 * @return {@code true} if the connection handle is connected to a HotSpot, {@code false}
361 	 *         otherwise.
362 	 */
363 	public static boolean isHotSpot(IConnectionHandle connectionHandle) {
364 		String vmName = getVMName(connectionHandle);
365 		return vmName != null &amp;&amp; JavaVMVersionToolkit.isHotspotJVMName(vmName);
366 	}
367 
<span class="line-added">368 	/**</span>
<span class="line-added">369 	 * Returns {@code true} if the connection handle is associated with an Oracle built JVM,</span>
<span class="line-added">370 	 * {@code false} otherwise. This method &lt;b&gt;does not&lt;/b&gt; require the connection handle to be</span>
<span class="line-added">371 	 * connected.</span>
<span class="line-added">372 	 */</span>
<span class="line-added">373 	public static boolean isOracle(IConnectionHandle handle) {</span>
<span class="line-added">374 		JVMDescriptor descriptor = handle.getServerDescriptor().getJvmInfo();</span>
<span class="line-added">375 		// This should normally not happen for discovered JVMs, but users can create custom connections</span>
<span class="line-added">376 		String vendor = null;</span>
<span class="line-added">377 		if (descriptor != null) {</span>
<span class="line-added">378 			vendor = descriptor.getJvmVendor();</span>
<span class="line-added">379 		} else {</span>
<span class="line-added">380 			// We try checking if connected</span>
<span class="line-added">381 			if (handle.isConnected()) {</span>
<span class="line-added">382 				MBeanServerConnection connection = handle.getServiceOrNull(MBeanServerConnection.class);</span>
<span class="line-added">383 				if (connection != null) {</span>
<span class="line-added">384 					try {</span>
<span class="line-added">385 						vendor = getRuntimeBean(connection).getVmVendor();</span>
<span class="line-added">386 					} catch (IOException e) {</span>
<span class="line-added">387 						// Worst case we classify JVM vendor wrong</span>
<span class="line-added">388 						RJMXPlugin.getDefault().getLogger().log(Level.WARNING, &quot;Could not check if Oracle JVM&quot;, e);</span>
<span class="line-added">389 					}</span>
<span class="line-added">390 				}</span>
<span class="line-added">391 			}</span>
<span class="line-added">392 		}</span>
<span class="line-added">393 		return vendor != null &amp;&amp; vendor.contains(&quot;Oracle&quot;);</span>
<span class="line-added">394 	}</span>
<span class="line-added">395 </span>
396 	/**
397 	 * This will return true if the java version is above or equal the supplied value. (For example
398 	 * 1.7.0_40).
399 	 *
400 	 * @param connectionHandle
401 	 *            the connectionHandle to check.
402 	 * @param minVersion
403 	 *            the java version needed.
404 	 * @return {@code true} if the version is above or equal the supplied value, {@code true} if no
405 	 *         version can be obtained from the connection, {@code false} otherwise.
406 	 */
407 	public static boolean isJavaVersionAboveOrEqual(IConnectionHandle connectionHandle, JavaVersion minVersion) {
408 		JavaVersion version = getJavaVersion(connectionHandle);
409 		return version != null ? version.isGreaterOrEqualThan(minVersion) : true;
410 	}
411 
412 	private static String getVMName(IConnectionHandle connectionHandle) {
413 		MBeanServerConnection connection = connectionHandle.getServiceOrDummy(MBeanServerConnection.class);
414 		try {
415 			// getAttribute may fail if the connection handle
</pre>
<hr />
<pre>
422 		return null;
423 	}
424 
425 	private static JavaVersion getJavaVersion(IConnectionHandle connectionHandle) {
426 		try {
427 			MBeanServerConnection server = connectionHandle.getServiceOrThrow(MBeanServerConnection.class);
428 			Map&lt;String, String&gt; serverProps = getRuntimeBean(server).getSystemProperties();
429 			String javaVersion = serverProps.get(&quot;java.version&quot;); //$NON-NLS-1$
430 			if (javaVersion != null) {
431 				return new JavaVersion(javaVersion);
432 			}
433 			RJMXPlugin.getDefault().getLogger().log(Level.WARNING,
434 					&quot;System Properties from &quot; + connectionHandle.getDescription() //$NON-NLS-1$
435 							+ &quot; contained no java.version property!&quot;); //$NON-NLS-1$
436 		} catch (Exception e) {
437 			RJMXPlugin.getDefault().getLogger().log(Level.WARNING,
438 					&quot;Could not check the java.version from System Properties!&quot;, e); //$NON-NLS-1$
439 		}
440 		return null;
441 	}

442 }
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../../org.openjdk.jmc.rjmx.services.jfr/src/main/java/org/openjdk/jmc/rjmx/services/jfr/internal/FlightRecorderServiceV2.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="JVMSupportToolkit.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>