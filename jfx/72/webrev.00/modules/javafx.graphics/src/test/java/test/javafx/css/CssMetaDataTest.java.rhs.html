<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.graphics/src/test/java/test/javafx/css/CssMetaDataTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
<a name="1" id="anc1"></a><span class="line-modified">   2  * Copyright (c) 2010, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 package test.javafx.css;
  27 
  28 import java.io.File;
  29 import java.lang.reflect.InvocationTargetException;
  30 import java.lang.reflect.Method;
  31 import java.lang.reflect.Modifier;
  32 import java.net.URL;
  33 import java.util.ArrayList;
  34 import java.util.Arrays;
  35 import java.util.Collections;
  36 import java.util.List;
  37 import java.util.Set;
  38 
  39 import com.sun.javafx.css.CascadingStyle;
  40 import com.sun.javafx.css.ParsedValueImpl;
  41 import com.sun.javafx.css.PseudoClassState;
  42 import com.sun.javafx.css.StyleManager;
  43 import test.com.sun.javafx.css.TestNode;
  44 import test.com.sun.javafx.css.TestNodeBase;
  45 import com.sun.javafx.sg.prism.NGNode;
  46 import javafx.beans.value.WritableValue;
  47 import javafx.scene.Group;
  48 import javafx.scene.Node;
  49 import javafx.scene.Scene;
  50 import javafx.scene.layout.Pane;
  51 import javafx.scene.paint.Color;
  52 import javafx.scene.shape.Rectangle;
  53 import javafx.scene.text.Font;
  54 import javafx.scene.text.Text;
  55 import javafx.stage.Stage;
  56 import javafx.css.converter.BooleanConverter;
  57 import com.sun.javafx.geom.BaseBounds;
  58 import com.sun.javafx.geom.transform.BaseTransform;
  59 import com.sun.javafx.scene.NodeHelper;
  60 import javafx.css.CompoundSelector;
  61 import javafx.css.CssMetaData;
  62 import javafx.css.CssParser;
  63 import javafx.css.CssParserShim;
  64 import javafx.css.Declaration;
  65 import javafx.css.DeclarationShim;
  66 import javafx.css.FontCssMetaData;
  67 import javafx.css.ParsedValue;
  68 import javafx.css.PseudoClass;
  69 import javafx.css.Rule;
  70 import javafx.css.RuleShim;
  71 import javafx.css.Selector;
  72 import javafx.css.SelectorShim;
  73 import javafx.css.SimpleSelector;
  74 import javafx.css.SimpleSelectorShim;
  75 import javafx.css.Style;
  76 import javafx.css.StyleConverter;
  77 import javafx.css.StyleOrigin;
  78 import javafx.css.Styleable;
  79 import javafx.css.StyleableProperty;
  80 import javafx.css.Stylesheet;
  81 import javafx.css.StylesheetShim;
  82 import org.junit.Test;
  83 import org.junit.Ignore;
  84 
  85 import static org.junit.Assert.*;
  86 
  87 enum TestEnum {
  88     LEFT,
  89     CENTER,
  90     RIGHT,
  91     JUSTIFY
  92 }
  93 
  94 public class CssMetaDataTest {
  95 
  96     public CssMetaDataTest() {
  97     }
  98 
  99     private static CssMetaData get(List&lt;CssMetaData&lt;? extends Styleable, ?&gt;&gt; list, String prop) {
 100         for (CssMetaData styleable : list) {
 101             if (prop.equals(styleable.getProperty())) return styleable;
 102         }
 103         return null;
 104     }
 105 
 106     /**
 107      * Test of getCssMetaData method of class Styleable.
 108      */
 109     @Test
 110     public void testGetCssMetaData_Styleable() {
 111         Styleable styleable = new TestNode();
 112         List&lt;CssMetaData&lt;? extends Styleable, ?&gt;&gt; expResult = TestNode.getClassCssMetaData();
 113         List result = styleable.getCssMetaData();
 114         assertEquals(expResult, result);
 115     }
 116 
 117     @Test
 118     public void testGetJavafxBeansProperty() {
 119         TestNode testNode = new TestNode();
 120         WritableValue prop = TestNodeBase.StyleableProperties.TEST.getStyleableProperty(testNode);
 121         assert(prop != null);
 122         CssMetaData result = ((StyleableProperty)prop).getCssMetaData();
 123         assert(result == TestNodeBase.StyleableProperties.TEST);
 124     }
 125 
 126     /**
 127      * Test of getProperty method, of class CssMetaData.
 128      */
 129     @Test
 130     public void testGetProperty() {
 131 
 132         String expResult = &quot;-fx-test&quot;;
 133         String result = TestNodeBase.StyleableProperties.TEST.getProperty();
 134         assertEquals(expResult, result);
 135     }
 136 
 137     /**
 138      * Test of getConverter method, of class CssMetaData.
 139      */
 140     @Test
 141     public void testGetConverter() {
 142 
 143         StyleConverter expResult = BooleanConverter.getInstance();
 144         StyleConverter result = TestNodeBase.StyleableProperties.TEST.getConverter();
 145         assertEquals(expResult, result);
 146     }
 147 
 148     /**
 149      * Test of getInitialValue method, of class CssMetaData.
 150      */
 151     @Test
 152     public void testGetInitialValue() {
 153 
 154         TestNode testNode = new TestNode();
 155         Double expResult = testNode.getXyzzy();
 156         Double result = (Double)TestNode.StyleableProperties.XYZZY.getInitialValue(testNode);
 157         assertEquals(expResult, result);
 158 
 159     }
 160 
 161     /**
 162      * Test of getSubProperties method, of class CssMetaData.
 163      */
 164     @Test
 165     public void testGetSubProperties() {
 166 
 167         CssMetaData&lt;TestNode,Font&gt; fontProp =
 168                 new FontCssMetaData&lt;TestNode&gt;(&quot;-fx-font&quot;, Font.getDefault()) {
 169 
 170                     @Override
 171                     public boolean isSettable(TestNode n) {
 172                         return true;
 173                     }
 174 
 175                     @Override
 176                     public StyleableProperty&lt;Font&gt; getStyleableProperty(TestNode n) {
 177                         return null;
 178                     }
 179                 };
 180 
 181         List&lt;CssMetaData&lt;? extends Styleable, ?&gt;&gt; list = fontProp.getSubProperties();
 182         assertNotNull(list);
 183 
 184     }
 185 
 186     /**
 187      * Test of isInherits method, of class CssMetaData.
 188      */
 189     @Test
 190     public void testIsInherits() {
 191 
 192         boolean expResult = false;
 193         boolean result = TestNode.StyleableProperties.XYZZY.isInherits();
 194         assertEquals(expResult, result);
 195 
 196     }
 197 
 198     /**
 199      * Test of toString method, of class CssMetaData.
 200      */
 201     @Test
 202     public void testToString() {
 203 
 204         CssMetaData&lt;TestNode,Font&gt; fontProp =
 205                 new FontCssMetaData&lt;TestNode&gt;(&quot;-fx-font&quot;, Font.getDefault()) {
 206 
 207                     @Override
 208                     public boolean isSettable(TestNode n) {
 209                         return true;
 210                     }
 211 
 212                     @Override
 213                     public StyleableProperty&lt;Font&gt; getStyleableProperty(TestNode n) {
 214                         return null;
 215                     }
 216                 };
 217 
 218         String string = fontProp.toString();
 219         assertNotNull(string);
 220 
 221     }
 222 
 223     /**
 224      * Test of equals method, of class CssMetaData.
 225      */
 226     @Test
 227     public void testEquals() {
 228         TestNode testNode = new TestNode();
 229         Node node = new Node() {
 230         };
 231 
 232         CssMetaData testNodeOpacity = get(TestNode.getClassCssMetaData(), &quot;-fx-opacity&quot;);
 233         CssMetaData nodeOpacity = get(Node.getClassCssMetaData(), &quot;-fx-opacity&quot;);
 234 
 235         assertTrue(testNodeOpacity.equals(nodeOpacity));
 236     }
 237 
 238     static int ord = 0;
 239     static CascadingStyle createCascadingStyle(Selector selector, Declaration declaration) {
 240 
 241         Set&lt;PseudoClass&gt; pseudoClasses = null;
 242         if (selector instanceof SimpleSelector) {
 243 
 244             pseudoClasses =
 245                     SimpleSelectorShim.getPseudoClassStates((SimpleSelector)selector);
 246         } else {
 247 
 248             pseudoClasses = new PseudoClassState();
 249             for (SimpleSelector sel : ((CompoundSelector)selector).getSelectors()) {
 250 
 251                 Set&lt;PseudoClass&gt; selectorPseudoClasses = SimpleSelectorShim.getPseudoClassStates(sel);
 252                 pseudoClasses.addAll(selectorPseudoClasses);
 253             }
 254         }
 255 
 256         return new CascadingStyle(
 257                 new Style(selector, declaration),
 258                 pseudoClasses,
 259                 0,
 260                 ord++
 261         );
 262     }
 263 
 264     @Ignore(&quot;JDK-8234142&quot;)
 265     @Test
 266     public void testGetMatchingStyles() {
 267 
 268 
 269         final Stylesheet stylesheet = StylesheetShim.getStylesheet();
 270         stylesheet.setOrigin(StyleOrigin.USER_AGENT);
 271         StyleManager.getInstance().getInstance().setDefaultUserAgentStylesheet(stylesheet);
 272 
 273         final List&lt;Rule&gt; rules = stylesheet.getRules();
 274 
 275         //
 276         // .root { -fx-base: red; -fx-color: -fx-base; }
 277         //
 278         List&lt;String&gt; rootStyleClass = new ArrayList&lt;String&gt;();
 279         rootStyleClass.add(&quot;root&quot;);
 280 
 281         Selector root = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rootStyleClass, null, null);
 282 
 283         ParsedValue fxBaseValue = new CssParserShim().parseExpr(&quot;-fx-base&quot;, &quot;red&quot;);
 284         Declaration fxBase = DeclarationShim.getDeclaration(&quot;-fx-base&quot;, fxBaseValue, false);
 285 
 286         ParsedValueImpl&lt;String,String&gt; fxColorValue = new ParsedValueImpl&lt;String,String&gt;(fxBase.getProperty(), null, true);
 287         Declaration fxColor = DeclarationShim.getDeclaration(&quot;-fx-color&quot;, fxColorValue, false);
 288 
 289         List&lt;Selector&gt; selectors = new ArrayList&lt;Selector&gt;();
 290         Collections.addAll(selectors, root);
 291 
 292         List&lt;Declaration&gt; declarations = new ArrayList&lt;Declaration&gt;();
 293         Collections.addAll(declarations, fxBase, fxColor);
 294 
 295         Rule baseRule = RuleShim.getRule(selectors, declarations);
 296         rules.add(baseRule);
 297 
 298         //
 299         // .rect { -fx-fill: -fx-color; }
 300         //
 301         List&lt;String&gt; rectStyleClass = new ArrayList&lt;String&gt;();
 302         rectStyleClass.add(&quot;rect&quot;);
 303 
 304         Selector rect = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rectStyleClass, null, null);
 305 
 306         ParsedValue fxFillValue = new CssParserShim().parseExpr(&quot;-fx-fill&quot;, &quot;-fx-color&quot;);
 307         Declaration fxFill = DeclarationShim.getDeclaration(&quot;-fx-fill&quot;, fxFillValue, false);
 308 
 309         selectors = new ArrayList&lt;Selector&gt;();
 310         Collections.addAll(selectors, rect);
 311 
 312         declarations = new ArrayList&lt;Declaration&gt;();
 313         Collections.addAll(declarations, fxFill);
 314 
 315         Rule rectRule = RuleShim.getRule(selectors, declarations);
 316         rules.add(rectRule);
 317 
 318         // .rect:hover { -fx-fill: yellow; }
 319         List&lt;String&gt; pseudoclasses = new ArrayList&lt;String&gt;();
 320         pseudoclasses.add(&quot;hover&quot;);
 321 
 322         Selector rectHover = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rectStyleClass, pseudoclasses, null);
 323 
 324         ParsedValueImpl&lt;Color,Color&gt; fxFillHoverValue = new ParsedValueImpl&lt;Color,Color&gt;(Color.YELLOW, null);
 325         Declaration fxFillHover = DeclarationShim.getDeclaration(&quot;-fx-fill&quot;, fxFillHoverValue, false);
 326 
 327         selectors = new ArrayList&lt;Selector&gt;();
 328         Collections.addAll(selectors, rectHover);
 329 
 330         declarations = new ArrayList&lt;Declaration&gt;();
 331         Collections.addAll(declarations, fxFillHover);
 332 
 333         Rule rectHoverRule = RuleShim.getRule(selectors, declarations);
 334         rules.add(rectHoverRule);
 335 
 336         List&lt;Style&gt; expecteds = new ArrayList&lt;Style&gt;();
 337         Collections.addAll(expecteds,
 338                            new Style(root, fxBase),
 339                            new Style(root, fxColor),
 340                            new Style(rect, fxFill),
 341                            new Style(rectHover, fxFillHover)
 342         );
 343 
 344         final Rectangle rectangle = new Rectangle();
 345         rectangle.getStyleClass().add(&quot;rect&quot;);
 346 
 347         final Group group = new Group();
 348         group.getChildren().add(rectangle);
 349 
 350         Scene scene = new Scene(group);
 351         Stage stage = new Stage();
 352         stage.setScene(scene);
 353         stage.show();
 354 
 355         final CssMetaData FILL = get(rectangle.getCssMetaData(), &quot;-fx-fill&quot;);
 356         final List&lt;Style&gt; actuals = NodeHelper.getMatchingStyles(FILL, rectangle);
 357 
 358         //        System.err.println(&quot;matchingStyles: &quot; + matchingStyles);
 359         //        System.err.println(&quot;expecteds: &quot; + expecteds);
 360         //        System.err.println(&quot;actuals: &quot; + actuals);
 361 
 362         assertEquals(expecteds.size(), actuals.size(), 0);
 363 
 364         for (Style style : expecteds) {
 365             if (!actuals.remove(style)) fail();
 366         }
 367         assertTrue(actuals.isEmpty());
 368     }
 369 
 370     @Ignore(&quot;JDK-8234142&quot;)
 371     @Test
 372     public void testGetMatchingStylesWithInlineStyleOnParent() {
 373 
 374 
 375         final Stylesheet stylesheet = StylesheetShim.getStylesheet();
 376         stylesheet.setOrigin(StyleOrigin.USER_AGENT);
 377         StyleManager.getInstance().getInstance().setDefaultUserAgentStylesheet(stylesheet);
 378 
 379         final List&lt;Rule&gt; rules = stylesheet.getRules();
 380 
 381         //
 382         // .root { -fx-base: red; -fx-color: -fx-base; }
 383         //
 384         List&lt;String&gt; rootStyleClass = new ArrayList&lt;String&gt;();
 385         rootStyleClass.add(&quot;root&quot;);
 386 
 387         Selector root = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rootStyleClass, null, null);
 388 
 389         ParsedValue fxBaseValue = new CssParserShim().parseExpr(&quot;-fx-base&quot;, &quot;red&quot;);
 390         Declaration fxBase = DeclarationShim.getDeclaration(&quot;-fx-base&quot;, fxBaseValue, false);
 391 
 392         ParsedValueImpl&lt;String,String&gt; fxColorValue = new ParsedValueImpl&lt;String,String&gt;(fxBase.getProperty(), null, true);
 393         Declaration fxColor = DeclarationShim.getDeclaration(&quot;-fx-color&quot;, fxColorValue, false);
 394 
 395         List&lt;Selector&gt; selectors = new ArrayList&lt;Selector&gt;();
 396         Collections.addAll(selectors, root);
 397 
 398         List&lt;Declaration&gt; declarations = new ArrayList&lt;Declaration&gt;();
 399         Collections.addAll(declarations, fxBase, fxColor);
 400 
 401         Rule baseRule = RuleShim.getRule(selectors, declarations);
 402         rules.add(baseRule);
 403 
 404         //
 405         // .rect { -fx-fill: -fx-color; }
 406         //
 407         List&lt;String&gt; rectStyleClass = new ArrayList&lt;String&gt;();
 408         rectStyleClass.add(&quot;rect&quot;);
 409 
 410         Selector rect = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rectStyleClass, null, null);
 411 
 412         ParsedValue fxFillValue = new CssParserShim().parseExpr(&quot;-fx-fill&quot;, &quot;-fx-color&quot;);
 413         Declaration fxFill = DeclarationShim.getDeclaration(&quot;-fx-fill&quot;, fxFillValue, false);
 414 
 415         selectors = new ArrayList&lt;Selector&gt;();
 416         Collections.addAll(selectors, rect);
 417 
 418         declarations = new ArrayList&lt;Declaration&gt;();
 419         Collections.addAll(declarations, fxFill);
 420 
 421         Rule rectRule = RuleShim.getRule(selectors, declarations);
 422         rules.add(rectRule);
 423 
 424         // .rect:hover { -fx-fill: yellow; }
 425         List&lt;String&gt; pseudoclasses = new ArrayList&lt;String&gt;();
 426         pseudoclasses.add(&quot;hover&quot;);
 427 
 428         Selector rectHover = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rectStyleClass, pseudoclasses, null);
 429 
 430         ParsedValueImpl&lt;Color,Color&gt; fxFillHoverValue = new ParsedValueImpl&lt;Color,Color&gt;(Color.YELLOW, null);
 431         Declaration fxFillHover = DeclarationShim.getDeclaration(&quot;-fx-fill&quot;, fxFillHoverValue, false);
 432 
 433         selectors = new ArrayList&lt;Selector&gt;();
 434         Collections.addAll(selectors, rectHover);
 435 
 436         declarations = new ArrayList&lt;Declaration&gt;();
 437         Collections.addAll(declarations, fxFillHover);
 438 
 439         Rule rectHoverRule = RuleShim.getRule(selectors, declarations);
 440         rules.add(rectHoverRule);
 441 
 442         // Declaration now checks origin, so we need to make this expected
 443         // value look like it came from an inline
 444         final Declaration decl = DeclarationShim.getDeclaration(&quot;-fx-base&quot;, new ParsedValueImpl&lt;Color,Color&gt;(Color.GREEN, null), false);
 445 
 446         Stylesheet ss = new StylesheetShim(null) {
 447             {
 448                 setOrigin(StyleOrigin.INLINE);
 449                 getRules().add(
 450                         RuleShim.getRule(Arrays.asList(SelectorShim.getUniversalSelector()), Arrays.asList(decl))
 451                 );
 452             }
 453         };
 454 
 455         List&lt;Style&gt; expecteds = new ArrayList&lt;Style&gt;();
 456         Collections.addAll(expecteds,
 457                            new Style(SelectorShim.getUniversalSelector(), decl),
 458                            new Style(root, fxBase),
 459                            new Style(root, fxColor),
 460                            new Style(rect, fxFill),
 461                            new Style(rectHover, fxFillHover)
 462         );
 463 
 464         final Rectangle rectangle = new Rectangle();
 465         rectangle.getStyleClass().add(&quot;rect&quot;);
 466 
 467         final Group group = new Group();
 468         group.setStyle(&quot;-fx-base: green;&quot;);
 469         group.getChildren().add(rectangle);
 470 
 471         Scene scene = new Scene(group);
 472         Stage stage = new Stage();
 473         stage.setScene(scene);
 474         stage.show();
 475 
 476         final CssMetaData FILL = get(rectangle.getCssMetaData(), &quot;-fx-fill&quot;);
 477         final List&lt;Style&gt; actuals = NodeHelper.getMatchingStyles(FILL, rectangle);
 478 
 479         //        System.err.println(&quot;matchingStyles: &quot; + matchingStyles);
 480         //        System.err.println(&quot;expecteds: &quot; + expecteds);
 481         //        System.err.println(&quot;actuals: &quot; + actuals);
 482 
 483         assertEquals(expecteds.size(), actuals.size(), 0);
 484 
 485         // inline style should be first
 486         assertEquals(expecteds.get(0), actuals.get(0));
 487 
 488         for (Style style : expecteds) {
 489             if (!actuals.remove(style)) fail();
 490         }
 491         assertTrue(actuals.isEmpty());
 492     }
 493 
 494     @Ignore(&quot;JDK-8234142&quot;)
 495     @Test
 496     public void testGetMatchingStylesWithInlineStyleOnLeaf() {
 497 
 498 
 499         final Stylesheet stylesheet = StylesheetShim.getStylesheet();
 500         stylesheet.setOrigin(StyleOrigin.USER_AGENT);
 501         StyleManager.getInstance().getInstance().setDefaultUserAgentStylesheet(stylesheet);
 502 
 503         final List&lt;Rule&gt; rules = stylesheet.getRules();
 504 
 505         //
 506         // .root { -fx-base: red; -fx-color: -fx-base; }
 507         //
 508         List&lt;String&gt; rootStyleClass = new ArrayList&lt;String&gt;();
 509         rootStyleClass.add(&quot;root&quot;);
 510 
 511         Selector root = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rootStyleClass, null, null);
 512 
 513         ParsedValue fxBaseValue = new CssParserShim().parseExpr(&quot;-fx-base&quot;, &quot;red&quot;);
 514         Declaration fxBase = DeclarationShim.getDeclaration(&quot;-fx-base&quot;, fxBaseValue, false);
 515 
 516         ParsedValueImpl&lt;String,String&gt; fxColorValue = new ParsedValueImpl&lt;String,String&gt;(fxBase.getProperty(), null, true);
 517         Declaration fxColor = DeclarationShim.getDeclaration(&quot;-fx-color&quot;, fxColorValue, false);
 518 
 519         List&lt;Selector&gt; selectors = new ArrayList&lt;Selector&gt;();
 520         Collections.addAll(selectors, root);
 521 
 522         List&lt;Declaration&gt; declarations = new ArrayList&lt;Declaration&gt;();
 523         Collections.addAll(declarations, fxBase, fxColor);
 524 
 525         Rule baseRule = RuleShim.getRule(selectors, declarations);
 526         rules.add(baseRule);
 527 
 528         //
 529         // .rect { -fx-fill: -fx-color; }
 530         //
 531         List&lt;String&gt; rectStyleClass = new ArrayList&lt;String&gt;();
 532         rectStyleClass.add(&quot;rect&quot;);
 533 
 534         Selector rect = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rectStyleClass, null, null);
 535 
 536         ParsedValue fxFillValue = new CssParserShim().parseExpr(&quot;-fx-fill&quot;, &quot;-fx-color&quot;);
 537         Declaration fxFill = DeclarationShim.getDeclaration(&quot;-fx-fill&quot;, fxFillValue, false);
 538 
 539         selectors = new ArrayList&lt;Selector&gt;();
 540         Collections.addAll(selectors, rect);
 541 
 542         declarations = new ArrayList&lt;Declaration&gt;();
 543         Collections.addAll(declarations, fxFill);
 544 
 545         Rule rectRule = RuleShim.getRule(selectors, declarations);
 546         rules.add(rectRule);
 547 
 548         // .rect:hover { -fx-fill: yellow; }
 549         List&lt;String&gt; pseudoclasses = new ArrayList&lt;String&gt;();
 550         pseudoclasses.add(&quot;hover&quot;);
 551 
 552         Selector rectHover = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rectStyleClass, pseudoclasses, null);
 553 
 554         ParsedValueImpl&lt;Color,Color&gt; fxFillHoverValue = new ParsedValueImpl&lt;Color,Color&gt;(Color.YELLOW, null);
 555         Declaration fxFillHover = DeclarationShim.getDeclaration(&quot;-fx-fill&quot;, fxFillHoverValue, false);
 556 
 557         selectors = new ArrayList&lt;Selector&gt;();
 558         Collections.addAll(selectors, rectHover);
 559 
 560         declarations = new ArrayList&lt;Declaration&gt;();
 561         Collections.addAll(declarations, fxFillHover);
 562 
 563         Rule rectHoverRule = RuleShim.getRule(selectors, declarations);
 564         rules.add(rectHoverRule);
 565 
 566         // Declaration now checks origin, so we need to make this expected
 567         // value look like it came from an inline
 568         final Declaration decl = DeclarationShim.getDeclaration(&quot;-fx-base&quot;, new ParsedValueImpl&lt;Color,Color&gt;(Color.GREEN, null), false);
 569 
 570         Stylesheet ss = new StylesheetShim(null) {
 571             {
 572                 setOrigin(StyleOrigin.INLINE);
 573                 getRules().add(
 574                         RuleShim.getRule(Arrays.asList(SelectorShim.getUniversalSelector()), Arrays.asList(decl))
 575                 );
 576             }
 577         };
 578 
 579         List&lt;Style&gt; expecteds = new ArrayList&lt;Style&gt;();
 580         Collections.addAll(expecteds,
 581                            new Style(SelectorShim.getUniversalSelector(), decl),
 582                            new Style(root, fxBase),
 583                            new Style(root, fxColor),
 584                            new Style(rect, fxFill),
 585                            new Style(rectHover, fxFillHover)
 586         );
 587 
 588         final Rectangle rectangle = new Rectangle();
 589         rectangle.getStyleClass().add(&quot;rect&quot;);
 590         rectangle.setStyle(&quot;-fx-base: green;&quot;);
 591 
 592         final Group group = new Group();
 593         group.getChildren().add(rectangle);
 594 
 595         Scene scene = new Scene(group);
 596         Stage stage = new Stage();
 597         stage.setScene(scene);
 598         stage.show();
 599 
 600         final CssMetaData FILL = get(rectangle.getCssMetaData(), &quot;-fx-fill&quot;);
 601         final List&lt;Style&gt; actuals = NodeHelper.getMatchingStyles(FILL, rectangle);
 602 
 603         //        System.err.println(&quot;matchingStyles: &quot; + matchingStyles);
 604         //        System.err.println(&quot;expecteds: &quot; + expecteds);
 605         //        System.err.println(&quot;actuals: &quot; + actuals);
 606 
 607         assertEquals(expecteds.size(), actuals.size(), 0);
 608 
 609         // inline style should be first
 610         assertEquals(expecteds.get(0), actuals.get(0));
 611 
 612         for (Style style : expecteds) {
 613             if (!actuals.remove(style)) fail();
 614         }
 615         assertTrue(actuals.isEmpty());
 616     }
 617 
 618     @Ignore(&quot;JDK-8234142&quot;)
 619     @Test
 620     public void testGetMatchingStylesWithInlineStyleOnRootAndLeaf() {
 621 
 622 
 623         final Stylesheet stylesheet = StylesheetShim.getStylesheet();
 624         stylesheet.setOrigin(StyleOrigin.USER_AGENT);
 625         StyleManager.getInstance().getInstance().setDefaultUserAgentStylesheet(stylesheet);
 626 
 627         final List&lt;Rule&gt; rules = stylesheet.getRules();
 628 
 629         //
 630         // .root { -fx-base: red; -fx-color: -fx-base; }
 631         //
 632         List&lt;String&gt; rootStyleClass = new ArrayList&lt;String&gt;();
 633         rootStyleClass.add(&quot;root&quot;);
 634 
 635         Selector root = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rootStyleClass, null, null);
 636 
 637         ParsedValue fxBaseValue = new CssParserShim().parseExpr(&quot;-fx-base&quot;, &quot;red&quot;);
 638         Declaration fxBase = DeclarationShim.getDeclaration(&quot;-fx-base&quot;, fxBaseValue, false);
 639 
 640         ParsedValueImpl&lt;String,String&gt; fxColorValue = new ParsedValueImpl&lt;String,String&gt;(fxBase.getProperty(), null, true);
 641         Declaration fxColor = DeclarationShim.getDeclaration(&quot;-fx-color&quot;, fxColorValue, false);
 642 
 643         List&lt;Selector&gt; selectors = new ArrayList&lt;Selector&gt;();
 644         Collections.addAll(selectors, root);
 645 
 646         List&lt;Declaration&gt; declarations = new ArrayList&lt;Declaration&gt;();
 647         Collections.addAll(declarations, fxBase, fxColor);
 648 
 649         Rule baseRule = RuleShim.getRule(selectors, declarations);
 650         rules.add(baseRule);
 651 
 652         //
 653         // .rect { -fx-fill: -fx-color; }
 654         //
 655         List&lt;String&gt; rectStyleClass = new ArrayList&lt;String&gt;();
 656         rectStyleClass.add(&quot;rect&quot;);
 657 
 658         Selector rect = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rectStyleClass, null, null);
 659 
 660         ParsedValue fxFillValue = new CssParserShim().parseExpr(&quot;-fx-fill&quot;, &quot;-fx-color&quot;);
 661         Declaration fxFill = DeclarationShim.getDeclaration(&quot;-fx-fill&quot;, fxFillValue, false);
 662 
 663         selectors = new ArrayList&lt;Selector&gt;();
 664         Collections.addAll(selectors, rect);
 665 
 666         declarations = new ArrayList&lt;Declaration&gt;();
 667         Collections.addAll(declarations, fxFill);
 668 
 669         Rule rectRule = RuleShim.getRule(selectors, declarations);
 670         rules.add(rectRule);
 671 
 672         // .rect:hover { -fx-fill: yellow; }
 673         List&lt;String&gt; pseudoclasses = new ArrayList&lt;String&gt;();
 674         pseudoclasses.add(&quot;hover&quot;);
 675 
 676         Selector rectHover = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rectStyleClass, pseudoclasses, null);
 677 
 678         ParsedValueImpl&lt;Color,Color&gt; fxFillHoverValue = new ParsedValueImpl&lt;Color,Color&gt;(Color.YELLOW, null);
 679         Declaration fxFillHover = DeclarationShim.getDeclaration(&quot;-fx-fill&quot;, fxFillHoverValue, false);
 680 
 681         selectors = new ArrayList&lt;Selector&gt;();
 682         Collections.addAll(selectors, rectHover);
 683 
 684         declarations = new ArrayList&lt;Declaration&gt;();
 685         Collections.addAll(declarations, fxFillHover);
 686 
 687         Rule rectHoverRule = RuleShim.getRule(selectors, declarations);
 688         rules.add(rectHoverRule);
 689 
 690         // Declaration now checks origin, so we need to make this expected
 691         // value look like it came from an inline
 692         final Declaration gdecl = DeclarationShim.getDeclaration(&quot;-fx-base&quot;, new ParsedValueImpl&lt;Color,Color&gt;(Color.GREEN, null), false);
 693         final Declaration ydecl = DeclarationShim.getDeclaration(&quot;-fx-color&quot;, new ParsedValueImpl&lt;Color,Color&gt;(Color.YELLOW, null), false);
 694 
 695         Stylesheet ss = new StylesheetShim(null) {
 696             {
 697                 setOrigin(StyleOrigin.INLINE);
 698                 Collections.addAll(getRules(),
 699                                    RuleShim.getRule(Arrays.asList(SelectorShim.getUniversalSelector()), Arrays.asList(gdecl)),
 700                                    RuleShim.getRule(Arrays.asList(SelectorShim.getUniversalSelector()), Arrays.asList(ydecl))
 701                 );
 702             }
 703         };
 704 
 705         List&lt;Style&gt; expecteds = new ArrayList&lt;Style&gt;();
 706         Collections.addAll(expecteds,
 707                            new Style(SelectorShim.getUniversalSelector(), ydecl),
 708                            new Style(SelectorShim.getUniversalSelector(), gdecl),
 709                            new Style(root, fxBase),
 710                            new Style(root, fxColor),
 711                            new Style(rect, fxFill),
 712                            new Style(rectHover, fxFillHover)
 713         );
 714 
 715         final Rectangle rectangle = new Rectangle();
 716         rectangle.getStyleClass().add(&quot;rect&quot;);
 717         rectangle.setStyle(&quot;-fx-base: green;&quot;);
 718 
 719         final Group group = new Group();
 720         group.setStyle(&quot;-fx-color: yellow;&quot;);
 721         group.getChildren().add(rectangle);
 722 
 723         Scene scene = new Scene(group);
 724         Stage stage = new Stage();
 725         stage.setScene(scene);
 726         stage.show();
 727 
 728         final CssMetaData FILL = get(rectangle.getCssMetaData(), &quot;-fx-fill&quot;);
 729         final List&lt;Style&gt; actuals = NodeHelper.getMatchingStyles(FILL, rectangle);
 730 
 731         //        System.err.println(&quot;matchingStyles: &quot; + matchingStyles);
 732         //        System.err.println(&quot;expecteds: &quot; + expecteds);
 733         //        System.err.println(&quot;actuals: &quot; + actuals);
 734 
 735         assertEquals(expecteds.size(), actuals.size(), 0);
 736 
 737         // inline style should be first
 738         assertEquals(expecteds.get(0), actuals.get(0));
 739 
 740         for (Style style : expecteds) {
 741             if (!actuals.remove(style)) fail(style.toString());
 742         }
 743         assertTrue(actuals.isEmpty());
 744     }
 745 
 746     @Ignore(&quot;JDK-8234142&quot;)
 747     @Test
 748     public void testGetMatchingStylesShouldNotReturnAncestorPropertyIfNotInherited() {
 749 
 750 
 751         final Stylesheet stylesheet = StylesheetShim.getStylesheet();
 752         stylesheet.setOrigin(StyleOrigin.USER_AGENT);
 753         StyleManager.getInstance().getInstance().setDefaultUserAgentStylesheet(stylesheet);
 754 
 755         final List&lt;Rule&gt; rules = stylesheet.getRules();
 756 
 757         //
 758         // .root { -fx-base: red; -fx-color: -fx-base; }
 759         //
 760         List&lt;String&gt; rootStyleClass = new ArrayList&lt;String&gt;();
 761         rootStyleClass.add(&quot;root&quot;);
 762 
 763         Selector root = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rootStyleClass, null, null);
 764 
 765         ParsedValue fxBaseValue = new CssParserShim().parseExpr(&quot;-fx-base&quot;, &quot;red&quot;);
 766         Declaration fxBase = DeclarationShim.getDeclaration(&quot;-fx-base&quot;, fxBaseValue, false);
 767 
 768         ParsedValueImpl&lt;String,String&gt; fxColorValue = new ParsedValueImpl&lt;String,String&gt;(fxBase.getProperty(), null, true);
 769         Declaration fxColor = DeclarationShim.getDeclaration(&quot;-fx-color&quot;, fxColorValue, false);
 770 
 771         ParsedValueImpl&lt;Color,Color&gt; fxFillShouldNotMatchValue = new ParsedValueImpl&lt;Color,Color&gt;(Color.RED, null);
 772         Declaration fxFillShouldNotMatch = DeclarationShim.getDeclaration(&quot;-fx-fill&quot;, fxFillShouldNotMatchValue, false);
 773 
 774         List&lt;Selector&gt; selectors = new ArrayList&lt;Selector&gt;();
 775         Collections.addAll(selectors, root);
 776 
 777         List&lt;Declaration&gt; declarations = new ArrayList&lt;Declaration&gt;();
 778         Collections.addAll(declarations, fxBase, fxColor, fxFillShouldNotMatch);
 779 
 780         Rule baseRule = RuleShim.getRule(selectors, declarations);
 781         rules.add(baseRule);
 782 
 783         //
 784         // .rect { -fx-fill: -fx-color; }
 785         //
 786         List&lt;String&gt; rectStyleClass = new ArrayList&lt;String&gt;();
 787         rectStyleClass.add(&quot;rect&quot;);
 788 
 789         Selector rect = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rectStyleClass, null, null);
 790 
 791         ParsedValue fxFillValue = new CssParserShim().parseExpr(&quot;-fx-fill&quot;, &quot;-fx-color&quot;);
 792         Declaration fxFill = DeclarationShim.getDeclaration(&quot;-fx-fill&quot;, fxFillValue, false);
 793 
 794         selectors = new ArrayList&lt;Selector&gt;();
 795         Collections.addAll(selectors, rect);
 796 
 797         declarations = new ArrayList&lt;Declaration&gt;();
 798         Collections.addAll(declarations, fxFill);
 799 
 800         Rule rectRule = RuleShim.getRule(selectors, declarations);
 801         rules.add(rectRule);
 802 
 803         // .rect:hover { -fx-fill: yellow; }
 804         List&lt;String&gt; pseudoclasses = new ArrayList&lt;String&gt;();
 805         pseudoclasses.add(&quot;hover&quot;);
 806 
 807         Selector rectHover = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rectStyleClass, pseudoclasses, null);
 808 
 809         ParsedValueImpl&lt;Color,Color&gt; fxFillHoverValue = new ParsedValueImpl&lt;Color,Color&gt;(Color.YELLOW, null);
 810         Declaration fxFillHover = DeclarationShim.getDeclaration(&quot;-fx-fill&quot;, fxFillHoverValue, false);
 811 
 812         selectors = new ArrayList&lt;Selector&gt;();
 813         Collections.addAll(selectors, rectHover);
 814 
 815         declarations = new ArrayList&lt;Declaration&gt;();
 816         Collections.addAll(declarations, fxFillHover);
 817 
 818         Rule rectHoverRule = RuleShim.getRule(selectors, declarations);
 819         rules.add(rectHoverRule);
 820 
 821         List&lt;Style&gt; expecteds = new ArrayList&lt;Style&gt;();
 822         Collections.addAll(expecteds,
 823                            new Style(root, fxBase),
 824                            new Style(root, fxColor),
 825                            new Style(rect, fxFill),
 826                            new Style(rectHover, fxFillHover)
 827         );
 828 
 829         final Rectangle rectangle = new Rectangle();
 830         rectangle.getStyleClass().add(&quot;rect&quot;);
 831 
 832         final Group group = new Group();
 833         group.getChildren().add(rectangle);
 834 
 835         Scene scene = new Scene(group);
 836         Stage stage = new Stage();
 837         stage.setScene(scene);
 838         stage.show();
 839 
 840         final CssMetaData FILL = get(rectangle.getCssMetaData(), &quot;-fx-fill&quot;);
 841         final List&lt;Style&gt; actuals = NodeHelper.getMatchingStyles(FILL, rectangle);
 842 
 843         //        System.err.println(&quot;matchingStyles: &quot; + matchingStyles);
 844         //        System.err.println(&quot;expecteds: &quot; + expecteds);
 845         //        System.err.println(&quot;actuals: &quot; + actuals);
 846 
 847         assertEquals(expecteds.size(), actuals.size(), 0);
 848 
 849         for (Style style : expecteds) {
 850             if (!actuals.remove(style)) fail();
 851         }
 852         assertTrue(actuals.isEmpty());
 853     }
 854 
 855     @Ignore(&quot;JDK-8234142&quot;)
 856     @Test
 857     public void testGetMatchingStylesShouldNotReturnInlineAncestorPropertyIfNotInherited() {
 858 
 859         final Stylesheet stylesheet = StylesheetShim.getStylesheet();
 860         stylesheet.setOrigin(StyleOrigin.USER_AGENT);
 861         StyleManager.getInstance().setDefaultUserAgentStylesheet(stylesheet);
 862 
 863         final List&lt;Rule&gt; rules = stylesheet.getRules();
 864 
 865         List&lt;String&gt; rootStyleClass = new ArrayList&lt;String&gt;();
 866         rootStyleClass.add(&quot;root&quot;);
 867 
 868         List&lt;String&gt; rectStyleClass = new ArrayList&lt;String&gt;();
 869         rectStyleClass.add(&quot;rect&quot;);
 870 
 871         //
 872         // .root { -fx-base: red; -fx-color: -fx-base; }
 873         //
 874         Selector root = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rootStyleClass, null, null);
 875 
 876         ParsedValue fxBaseValue = new CssParserShim().parseExpr(&quot;-fx-base&quot;, &quot;red&quot;);
 877         Declaration fxBase = DeclarationShim.getDeclaration(&quot;-fx-base&quot;, fxBaseValue, false);
 878 
 879         ParsedValueImpl&lt;String,String&gt; fxColorValue = new ParsedValueImpl&lt;String,String&gt;(fxBase.getProperty(), null, true);
 880         Declaration fxColor = DeclarationShim.getDeclaration(&quot;-fx-color&quot;, fxColorValue, false);
 881 
 882         ParsedValueImpl&lt;Color,Color&gt; fxFillShouldNotMatchValue = new ParsedValueImpl&lt;Color,Color&gt;(Color.RED, null);
 883         Declaration fxFillShouldNotMatch = DeclarationShim.getDeclaration(&quot;-fx-fill&quot;, fxFillShouldNotMatchValue, false);
 884 
 885         List&lt;Selector&gt; selectors = new ArrayList&lt;Selector&gt;();
 886         Collections.addAll(selectors, root);
 887 
 888         List&lt;Declaration&gt; declarations = new ArrayList&lt;Declaration&gt;();
 889         Collections.addAll(declarations, fxBase, fxColor, fxFillShouldNotMatch);
 890 
 891         Rule baseRule = RuleShim.getRule(selectors, declarations);
 892         rules.add(baseRule);
 893 
 894         //
 895         // .rect { -fx-fill: -fx-color; }
 896         //
 897         Selector rect = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rectStyleClass, null, null);
 898 
 899         ParsedValue fxFillValue = new CssParserShim().parseExpr(&quot;-fx-fill&quot;, &quot;-fx-color&quot;);
 900         Declaration fxFill = DeclarationShim.getDeclaration(&quot;-fx-fill&quot;, fxFillValue, false);
 901 
 902         selectors = new ArrayList&lt;Selector&gt;();
 903         Collections.addAll(selectors, rect);
 904 
 905         declarations = new ArrayList&lt;Declaration&gt;();
 906         Collections.addAll(declarations, fxFill);
 907 
 908         Rule rectRule = RuleShim.getRule(selectors, declarations);
 909         rules.add(rectRule);
 910 
 911         // .rect:hover { -fx-fill: yellow; }
 912         List&lt;String&gt; pseudoclasses = new ArrayList&lt;String&gt;();
 913         pseudoclasses.add(&quot;hover&quot;);
 914 
 915         Selector rectHover = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rectStyleClass, pseudoclasses, null);
 916 
 917         ParsedValueImpl&lt;Color,Color&gt; fxFillHoverValue = new ParsedValueImpl&lt;Color,Color&gt;(Color.YELLOW, null);
 918         Declaration fxFillHover = DeclarationShim.getDeclaration(&quot;-fx-fill&quot;, fxFillHoverValue, false);
 919 
 920         selectors = new ArrayList&lt;Selector&gt;();
 921         Collections.addAll(selectors, rectHover);
 922 
 923         declarations = new ArrayList&lt;Declaration&gt;();
 924         Collections.addAll(declarations, fxFillHover);
 925 
 926         Rule rectHoverRule = RuleShim.getRule(selectors, declarations);
 927         rules.add(rectHoverRule);
 928 
 929         List&lt;Style&gt; expecteds = new ArrayList&lt;Style&gt;();
 930         Collections.addAll(expecteds,
 931                            new Style(root, fxBase),
 932                            new Style(root, fxColor),
 933                            new Style(rect, fxFill),
 934                            new Style(rectHover, fxFillHover)
 935         );
 936 
 937         final Rectangle rectangle = new Rectangle();
 938         rectangle.getStyleClass().add(&quot;rect&quot;);
 939 
 940         final Group group = new Group();
 941         group.getChildren().add(rectangle);
 942 
 943         Scene scene = new Scene(group);
 944         Stage stage = new Stage();
 945         stage.setScene(scene);
 946         stage.show();
 947 
 948         final CssMetaData FILL = get(rectangle.getCssMetaData(), &quot;-fx-fill&quot;);
 949         final List&lt;Style&gt; actuals = NodeHelper.getMatchingStyles(FILL, rectangle);
 950 
 951         //        System.err.println(&quot;matchingStyles: &quot; + matchingStyles);
 952         //        System.err.println(&quot;expecteds: &quot; + expecteds);
 953         //        System.err.println(&quot;actuals: &quot; + actuals);
 954 
 955         for (Style style : expecteds) {
 956             actuals.remove(style);
 957         }
 958         assertTrue(actuals.toString(), actuals.isEmpty());
 959     }
 960 
 961     @Ignore(&quot;JDK-8234142&quot;)
 962     @Test
 963     public void testGetMatchingStylesReturnsInheritedProperty() {
 964 
 965 
 966         final Stylesheet stylesheet = StylesheetShim.getStylesheet();
 967         stylesheet.setOrigin(StyleOrigin.USER_AGENT);
 968         StyleManager.getInstance().setDefaultUserAgentStylesheet(stylesheet);
 969 
 970         final List&lt;Rule&gt; rules = stylesheet.getRules();
 971 
 972         //
 973         // .root { -fx-base: red; -fx-color: -fx-base; }
 974         //
 975         List&lt;String&gt; rootStyleClass = new ArrayList&lt;String&gt;();
 976         rootStyleClass.add(&quot;root&quot;);
 977 
 978         Selector root = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rootStyleClass, null, null);
 979 
 980         ParsedValue&lt;Color,Color&gt; fxFontShouldInheritValue = new CssParserShim().parseExpr(&quot;-fx-font&quot;, &quot;12px system&quot;);
 981         Declaration fxFontShouldInherit = DeclarationShim.getDeclaration(&quot;-fx-font&quot;, fxFontShouldInheritValue, false);
 982 
 983         List&lt;Selector&gt; selectors = new ArrayList&lt;Selector&gt;();
 984         Collections.addAll(selectors, root);
 985 
 986         List&lt;Declaration&gt; declarations = new ArrayList&lt;Declaration&gt;();
 987         Collections.addAll(declarations, fxFontShouldInherit);
 988 
 989         Rule baseRule = RuleShim.getRule(selectors, declarations);
 990         rules.add(baseRule);
 991 
 992         //
 993         // .text { -fx-fill: -fx-color; }
 994         //
 995         List&lt;String&gt; textStyleClass = new ArrayList&lt;String&gt;();
 996         textStyleClass.add(&quot;text&quot;);
 997 
 998         Selector textSelector = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, textStyleClass, null, null);
 999 
1000         ParsedValue fxFillValue = new CssParserShim().parseExpr(&quot;-fx-fill&quot;, &quot;red&quot;);
1001         Declaration fxFill = DeclarationShim.getDeclaration(&quot;-fx-fill&quot;, fxFillValue, false);
1002 
1003         selectors = new ArrayList&lt;Selector&gt;();
1004         Collections.addAll(selectors, textSelector);
1005 
1006         declarations = new ArrayList&lt;Declaration&gt;();
1007         Collections.addAll(declarations, fxFill);
1008 
1009         Rule rectRule = RuleShim.getRule(selectors, declarations);
1010         rules.add(rectRule);
1011 
1012         List&lt;Style&gt; expecteds = new ArrayList&lt;Style&gt;();
1013         Collections.addAll(expecteds,
1014                            new Style(root, fxFontShouldInherit)
1015         );
1016 
1017         final Text text = new Text(&quot;text&quot;);
1018         text.getStyleClass().add(&quot;text&quot;);
1019 
1020         final Group group = new Group();
1021         group.getChildren().add(text);
1022 
1023         Scene scene = new Scene(group);
1024         Stage stage = new Stage();
1025         stage.setScene(scene);
1026         stage.show();
1027 
1028         final CssMetaData FONT = get(text.getCssMetaData(), &quot;-fx-font&quot;);
1029         final List&lt;Style&gt; actuals = NodeHelper.getMatchingStyles(FONT, text);
1030 
1031         //        System.err.println(&quot;matchingStyles: &quot; + matchingStyles);
1032         //        System.err.println(&quot;expecteds: &quot; + expecteds);
1033         //        System.err.println(&quot;actuals: &quot; + actuals);
1034 
1035         assertEquals(expecteds.size(), actuals.size(), 0);
1036 
1037         for (Style style : expecteds) {
1038             if (!actuals.remove(style)) fail();
1039         }
1040         assertTrue(actuals.isEmpty());
1041     }
1042 
1043     @Ignore(&quot;JDK-8234142&quot;)
1044     @Test
1045     public void testGetMatchingStylesReturnsSubProperty() {
1046 
1047         final Stylesheet stylesheet = StylesheetShim.getStylesheet();
1048         stylesheet.setOrigin(StyleOrigin.USER_AGENT);
1049         StyleManager.getInstance().setDefaultUserAgentStylesheet(stylesheet);
1050 
1051         final List&lt;Rule&gt; rules = stylesheet.getRules();
1052 
1053         //
1054         // .root { -fx-base: red; -fx-color: -fx-base; }
1055         //
1056         List&lt;String&gt; rootStyleClass = new ArrayList&lt;String&gt;();
1057         rootStyleClass.add(&quot;root&quot;);
1058 
1059         Selector root = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rootStyleClass, null, null);
1060 
1061         ParsedValue&lt;Color,Color&gt; fxFontShouldInheritValue = new CssParserShim().parseExpr(&quot;-fx-font&quot;, &quot;12px system&quot;);
1062         Declaration fxFontShouldInherit = DeclarationShim.getDeclaration(&quot;-fx-font&quot;, fxFontShouldInheritValue, false);
1063 
1064         List&lt;Selector&gt; selectors = new ArrayList&lt;Selector&gt;();
1065         Collections.addAll(selectors, root);
1066 
1067         List&lt;Declaration&gt; declarations = new ArrayList&lt;Declaration&gt;();
1068         Collections.addAll(declarations, fxFontShouldInherit);
1069 
1070         Rule baseRule = RuleShim.getRule(selectors, declarations);
1071         rules.add(baseRule);
1072 
1073         //
1074         // .text { -fx-fill: -fx-color; }
1075         //
1076         List&lt;String&gt; rectStyleClass = new ArrayList&lt;String&gt;();
1077         rectStyleClass.add(&quot;text&quot;);
1078 
1079         Selector textSelector = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rectStyleClass, null, null);
1080 
1081         ParsedValue fxFillValue = new CssParserShim().parseExpr(&quot;-fx-fill&quot;, &quot;red&quot;);
1082         Declaration fxFill = DeclarationShim.getDeclaration(&quot;-fx-fill&quot;, fxFillValue, false);
1083 
1084         ParsedValue fxFontFamilyValue = new CssParserShim().parseExpr(&quot;-fx-font-family&quot;, &quot;arial&quot;);
1085         Declaration fxFontFamily = DeclarationShim.getDeclaration(&quot;-fx-font-family&quot;, fxFontFamilyValue, false);
1086 
1087         selectors = new ArrayList&lt;Selector&gt;();
1088         Collections.addAll(selectors, textSelector);
1089 
1090         declarations = new ArrayList&lt;Declaration&gt;();
1091         Collections.addAll(declarations, fxFill, fxFontFamily);
1092 
1093         Rule rectRule = RuleShim.getRule(selectors, declarations);
1094         rules.add(rectRule);
1095 
1096         List&lt;Style&gt; expecteds = new ArrayList&lt;Style&gt;();
1097         Collections.addAll(expecteds,
1098                            new Style(textSelector, fxFontFamily),
1099                            new Style(root, fxFontShouldInherit)
1100         );
1101 
1102         final Text text  = new Text();
1103         text.getStyleClass().add(&quot;text&quot;);
1104 
1105         final Group group = new Group();
1106         group.getChildren().add(text);
1107 
1108         Scene scene = new Scene(group);
1109         Stage stage = new Stage();
1110         stage.setScene(scene);
1111         stage.show();
1112 
1113         final CssMetaData FONT = get(text.getCssMetaData(), &quot;-fx-font&quot;);
1114         final List&lt;Style&gt; actuals = NodeHelper.getMatchingStyles(FONT, text);
1115 
1116         //        System.err.println(&quot;matchingStyles: &quot; + matchingStyles);
1117         //        System.err.println(&quot;expecteds: &quot; + expecteds);
1118         //        System.err.println(&quot;actuals: &quot; + actuals);
1119 
1120         assertEquals(expecteds.size(), actuals.size(), 0);
1121 
1122         for (Style style : expecteds) {
1123             if (!actuals.remove(style)) fail();
1124         }
1125         assertTrue(actuals.isEmpty());
1126     }
1127 
1128     @Test
1129     public void testRT18097() {
1130         try {
1131             File f = System.getProperties().containsKey(&quot;CSS_META_DATA_TEST_DIR&quot;) ?
1132                     new File(System.getProperties().get(&quot;CSS_META_DATA_TEST_DIR&quot;).toString()) :
1133                     null;
1134             if (f == null) {
1135                 ClassLoader cl = Thread.currentThread().getContextClassLoader();
1136                 URL base = cl.getResource(&quot;javafx/../javafx&quot;);
1137                 f = new File(base.toURI());
1138             }
1139             //System.err.println(f.getPath());
1140             assertTrue(&quot;&quot; + f.getCanonicalPath() + &quot; is not a directory&quot;, f.isDirectory());
1141             recursiveCheck(f, f.getPath().length() - 7);
1142         } catch (Exception ex) {
1143             ex.printStackTrace(System.err);
1144             fail(ex.getMessage());
1145         }
1146     }
1147 
1148     private static void checkClass(Class someClass) {
1149 
1150         if (javafx.scene.Node.class.isAssignableFrom(someClass) &amp;&amp;
1151                 Modifier.isAbstract(someClass.getModifiers()) == false) {
1152 
1153             String what = someClass.getName();
1154             try {
1155                 // should get NoSuchMethodException if ctor is not public
1156                 //                Constructor ctor = someClass.getConstructor((Class[])null);
1157                 Method m = someClass.getMethod(&quot;getClassCssMetaData&quot;, (Class[]) null);
1158                 //                Node node = (Node)ctor.newInstance((Object[])null);
1159                 Node node = (Node)someClass.newInstance();
1160                 List&lt;CssMetaData&lt;? extends Styleable, ?&gt;&gt; list = (List&lt;CssMetaData&lt;? extends Styleable, ?&gt;&gt;)m.invoke(null);
1161                 if(list == null || list.isEmpty()) return;
1162 
1163                 for (CssMetaData styleable : list) {
1164 
1165                     what = someClass.getName() + &quot; &quot; + styleable.getProperty();
1166                     WritableValue writable = styleable.getStyleableProperty(node);
1167                     assertNotNull(what, writable);
1168 
1169                     Object defaultValue = writable.getValue();
1170                     Object initialValue = styleable.getInitialValue((Node) someClass.newInstance());
1171 
1172                     if (defaultValue instanceof Number) {
1173                         // 5 and 5.0 are not the same according to equals,
1174                         // but they should be...
1175                         assert(initialValue instanceof Number);
1176                         double d1 = ((Number)defaultValue).doubleValue();
1177                         double d2 = ((Number)initialValue).doubleValue();
1178                         assertEquals(what, d1, d2, .001);
1179 
1180                     } else if (defaultValue != null &amp;&amp; defaultValue.getClass().isArray()) {
1181                         assertTrue(what, Arrays.equals((Object[])defaultValue, (Object[])initialValue));
1182                     } else {
1183                         assertEquals(what, defaultValue, initialValue);
1184                     }
1185 
1186                 }
1187 
1188             } catch (NoSuchMethodException ex) {
1189                 System.err.println(&quot;NoSuchMethodException: &quot; + what);
1190             } catch (IllegalAccessException ex) {
1191                 System.err.println(&quot;IllegalAccessException: &quot; + what);
1192             } catch (IllegalArgumentException ex) {
1193                 System.err.println(&quot;IllegalArgumentException: &quot; + what);
1194             } catch (InvocationTargetException ex) {
1195                 System.err.println(&quot;InvocationTargetException: &quot; + what);
1196             } catch (InstantiationException ex) {
1197                 System.err.println(&quot;InstantiationException: &quot; + what);
1198             }
1199         }
1200     }
1201 
1202     private static void checkDirectory(File directory, final int pathLength) {
1203         if (directory.isDirectory()) {
1204 
1205             for (File file : directory.listFiles()) {
1206                 if (file.isFile() &amp;&amp; file.getName().endsWith(&quot;.class&quot;)) {
1207                     final int len = file.getPath().length() - &quot;.class&quot;.length();
1208                     final String clName =
1209                             file.getPath().substring(pathLength+1, len).replace(File.separatorChar,&#39;.&#39;);
1210                     try {
1211                         final Class cl = Class.forName(clName);
1212                         if (cl != null) checkClass(cl);
1213                     } catch(ClassNotFoundException ex) {
1214                         System.err.println(ex.toString() + &quot; &quot; + clName);
1215                     }
1216                 }
1217             }
1218         }
1219     }
1220 
1221     private static void recursiveCheck(File directory, int pathLength) {
1222         if (directory.isDirectory()) {
1223             //            System.err.println(directory.getPath());
1224             checkDirectory(directory, pathLength);
1225 
1226             for (File subFile : directory.listFiles()) {
1227                 recursiveCheck(subFile, pathLength);
1228             }
1229         }
1230     }
1231 
1232     @Ignore(&quot;JDK-8234143&quot;) // Tested CssMetaData#set method, which is deprecated.
1233     @Test
1234     public void testRT_21185() {
1235 
1236         Color c1 = new Color(.1,.2,.3,1.0);
1237         Color c2 = new Color(.1,.2,.3,1.0);
1238 
1239         Rectangle rect = new Rectangle();
1240         rect.setFill(c1);
1241 
1242         StyleableProperty fill = (StyleableProperty)rect.fillProperty();
1243         StyleOrigin origin = ((StyleableProperty)rect.fillProperty()).getStyleOrigin();
1244 
1245         // set should not change the value if the values are equal and origin is same
1246         assertEquals(c1, c2);
1247         fill.applyStyle(origin, c2);
1248 
1249         assertSame(c1,rect.getFill()); // instance should not change.
1250 
1251         // set should change the value if the values are not equal.
1252         c2 = new Color(.3,.2,.1,1.0);
1253         fill.applyStyle(origin, c2);
1254         assertSame(c2,rect.getFill());
1255 
1256         // set should change the value if the origin is not the same
1257         fill.applyStyle(StyleOrigin.INLINE, c2);
1258         origin = ((StyleableProperty)rect.fillProperty()).getStyleOrigin();
1259         assertSame(StyleOrigin.INLINE, origin);
1260 
1261         // set should change the value if one is null and the other is not.
1262         rect.setFill(null);
1263         fill.applyStyle(origin, c2);
1264         assertSame(c2, rect.getFill());
1265 
1266         // set should change the value if one is null and the other is not
1267         fill.applyStyle(origin, null);
1268         assertNull(rect.getFill());
1269 
1270     }
1271 
1272     @Ignore(&quot;JDK-8234142&quot;)
1273     @Test
1274     public void testRT_24606() {
1275 
1276         final Stylesheet stylesheet = new CssParser().parse(
1277                 &quot;.root { -fx-base: red; }&quot; +
1278                         &quot;.group { -fx-color: -fx-base; }&quot; +
1279                         &quot;.text { -fx-fill: -fx-color; }&quot;
1280         );
1281         stylesheet.setOrigin(StyleOrigin.USER_AGENT);
1282         StyleManager.getInstance().setDefaultUserAgentStylesheet(stylesheet);
1283 
1284         final Text text = new Text(&quot;HelloWorld&quot;);
1285         text.getStyleClass().add(&quot;text&quot;);
1286         text.setFill(Color.BLUE);
1287 
1288         final Group group = new Group();
1289         group.getStyleClass().add(&quot;group&quot;);
1290         group.getChildren().add(text);
1291 
1292         final Group root = new Group();
1293         root.getChildren().add(group);
1294 
1295         Scene scene = new Scene(root);
1296         Stage stage = new Stage();
1297         stage.setScene(scene);
1298         stage.show();
1299 
1300         CssMetaData prop = ((StyleableProperty)text.fillProperty()).getCssMetaData();
1301         List list = NodeHelper.getMatchingStyles(prop, text);
1302 
1303         assertEquals(3, list.size(), 0);
1304 
1305     }
1306 
1307     @Test
1308     public void testStyleConverterReturnType() {
1309         final CssMetaData&lt;Pane, TestEnum&gt; TEST_ENUM =
1310                 new CssMetaData&lt;Pane, TestEnum&gt;(&quot;-test-enum&quot;, StyleConverter.getEnumConverter(TestEnum.class), TestEnum.LEFT, false) {
1311                     @Override
1312                     public boolean isSettable(Pane styleable) {
1313                         return false;
1314                     }
1315 
1316                     @Override
1317                     public StyleableProperty&lt;TestEnum&gt; getStyleableProperty(Pane styleable) {
1318                         return null;
1319                     }
1320                 };
1321     }
1322 
1323 }
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>