<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.graphics/src/main/native-iio/jpegloader.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center>&lt; prev <a href="../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>modules/javafx.graphics/src/main/native-iio/jpegloader.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  28 #include &lt;setjmp.h&gt;
  29 #include &lt;assert.h&gt;
  30 #include &lt;string.h&gt;
  31 
  32 #include &quot;jni.h&quot;
  33 
  34 #include &quot;com_sun_javafx_iio_jpeg_JPEGImageLoader.h&quot;
  35 
  36 /* headers from libjpeg */
  37 #include &lt;jpeglib.h&gt;
  38 #include &lt;jerror.h&gt;
  39 
  40 #if defined (_LP64) || defined(_WIN64)
  41 #define jlong_to_ptr(a) ((void*)(a))
  42 #define ptr_to_jlong(a) ((jlong)(a))
  43 #else
  44 #define jlong_to_ptr(a) ((void*)(int)(a))
  45 #define ptr_to_jlong(a) ((jlong)(int)(a))
  46 #endif
  47 
<span class="line-removed">  48 /* On non iOS platforms we use JNI_OnLoad() shared library entrypoint. */</span>
<span class="line-removed">  49 #define USING_BUILTIN_LIBRARY_ENTRYPOINT 0</span>
<span class="line-removed">  50 </span>
<span class="line-removed">  51 /* On iOS we use builtin libraries, thus JNI_OnLoad_javafx_iio() is the entrypoint */</span>
  52 #ifdef __APPLE__
  53 
  54 #include &lt;TargetConditionals.h&gt;
  55 
  56 /* RT-37125: use setjmp/longjmp versions that do not save/restore the signal mask */
  57 #define longjmp _longjmp
  58 #define setjmp _setjmp
  59 
<span class="line-removed">  60 #if TARGET_OS_IPHONE /* iOS */</span>
<span class="line-removed">  61 #undef  USING_BUILTIN_LIBRARY_ENTRYPOINT</span>
<span class="line-removed">  62 #define USING_BUILTIN_LIBRARY_ENTRYPOINT 1</span>
<span class="line-removed">  63 #endif</span>
  64 #endif
  65 
  66 static jboolean checkAndClearException(JNIEnv *env) {
  67     if (!(*env)-&gt;ExceptionCheck(env)) {
  68         return JNI_FALSE;
  69     }
  70     (*env)-&gt;ExceptionClear(env);
  71     return JNI_TRUE;
  72 }
  73 
  74 /***************** Begin verbatim copy from jni_util.c ***************/
  75 
  76 /**
  77  * Throw a Java exception by name. Similar to SignalError.
  78  */
  79 JNIEXPORT void JNICALL
  80 ThrowByName(JNIEnv *env, const char *name, const char *msg) {
  81     jclass cls = (*env)-&gt;FindClass(env, name);
  82     if (!(*env)-&gt;ExceptionCheck(env) &amp;&amp; cls != 0) {/* Otherwise an exception has already been thrown */
  83         (*env)-&gt;ThrowNew(env, cls, msg);
</pre>
<hr />
<pre>
  91     return env;
  92 }
  93 
  94 /***************** Begin verbatim copy from jni_util.c ***************/
  95 
  96 #undef MAX
  97 #define MAX(a,b)        ((a) &gt; (b) ? (a) : (b))
  98 
  99 /* Cached Java method IDs */
 100 static jmethodID InputStream_readID;
 101 static jmethodID InputStream_skipID;
 102 static jmethodID JPEGImageLoader_setInputAttributesID;
 103 static jmethodID JPEGImageLoader_setOutputAttributesID;
 104 static jmethodID JPEGImageLoader_updateImageProgressID;
 105 static jmethodID JPEGImageLoader_emitWarningID;
 106 
 107 /* Initialize the Java VM instance variable when the library is
 108    first loaded */
 109 static JavaVM *jvm;
 110 
<span class="line-modified"> 111 #if USING_BUILTIN_LIBRARY_ENTRYPOINT</span>
 112 
 113 JNIEXPORT jint JNICALL
 114 JNI_OnLoad_javafx_iio(JavaVM *vm, void *reserved) {
 115     jvm = vm;
 116 #ifdef JNI_VERSION_1_8
 117     //min. returned JNI_VERSION required by JDK8 for builtin libraries
 118     JNIEnv *env;
 119     if ((*vm)-&gt;GetEnv(vm, (void **)&amp;env, JNI_VERSION_1_8) != JNI_OK) {
 120             return JNI_VERSION_1_2;
 121     }
 122     return JNI_VERSION_1_8;
 123 #else
 124     return JNI_VERSION_1_2;
 125 #endif
 126 }
 127 
 128 #else
 129 
 130 JNIEXPORT jint JNICALL
 131 JNI_OnLoad(JavaVM *vm, void *reserved) {
 132     jvm = vm;
 133     return JNI_VERSION_1_2;
 134 }
 135 
<span class="line-modified"> 136 #endif</span>
 137 
 138 
 139 /*
 140  * The following sets of defines must match the warning messages in the
 141  * Java code.
 142  */
 143 
 144 /* Loader warnings */
 145 #define READ_NO_EOI          0
 146 
 147 /* Saver warnings */
 148 
 149 /* Return codes for various ops */
 150 #define OK     1
 151 #define NOT_OK 0
 152 
 153 /*
 154  * First we define two objects, one for the stream and buffer and one
 155  * for pixels.  Both contain references to Java objects and pointers to
 156  * pinned arrays.  These objects can be used for either input or
</pre>
</td>
<td>
<hr />
<pre>
  28 #include &lt;setjmp.h&gt;
  29 #include &lt;assert.h&gt;
  30 #include &lt;string.h&gt;
  31 
  32 #include &quot;jni.h&quot;
  33 
  34 #include &quot;com_sun_javafx_iio_jpeg_JPEGImageLoader.h&quot;
  35 
  36 /* headers from libjpeg */
  37 #include &lt;jpeglib.h&gt;
  38 #include &lt;jerror.h&gt;
  39 
  40 #if defined (_LP64) || defined(_WIN64)
  41 #define jlong_to_ptr(a) ((void*)(a))
  42 #define ptr_to_jlong(a) ((jlong)(a))
  43 #else
  44 #define jlong_to_ptr(a) ((void*)(int)(a))
  45 #define ptr_to_jlong(a) ((jlong)(int)(a))
  46 #endif
  47 




  48 #ifdef __APPLE__
  49 
  50 #include &lt;TargetConditionals.h&gt;
  51 
  52 /* RT-37125: use setjmp/longjmp versions that do not save/restore the signal mask */
  53 #define longjmp _longjmp
  54 #define setjmp _setjmp
  55 




  56 #endif
  57 
  58 static jboolean checkAndClearException(JNIEnv *env) {
  59     if (!(*env)-&gt;ExceptionCheck(env)) {
  60         return JNI_FALSE;
  61     }
  62     (*env)-&gt;ExceptionClear(env);
  63     return JNI_TRUE;
  64 }
  65 
  66 /***************** Begin verbatim copy from jni_util.c ***************/
  67 
  68 /**
  69  * Throw a Java exception by name. Similar to SignalError.
  70  */
  71 JNIEXPORT void JNICALL
  72 ThrowByName(JNIEnv *env, const char *name, const char *msg) {
  73     jclass cls = (*env)-&gt;FindClass(env, name);
  74     if (!(*env)-&gt;ExceptionCheck(env) &amp;&amp; cls != 0) {/* Otherwise an exception has already been thrown */
  75         (*env)-&gt;ThrowNew(env, cls, msg);
</pre>
<hr />
<pre>
  83     return env;
  84 }
  85 
  86 /***************** Begin verbatim copy from jni_util.c ***************/
  87 
  88 #undef MAX
  89 #define MAX(a,b)        ((a) &gt; (b) ? (a) : (b))
  90 
  91 /* Cached Java method IDs */
  92 static jmethodID InputStream_readID;
  93 static jmethodID InputStream_skipID;
  94 static jmethodID JPEGImageLoader_setInputAttributesID;
  95 static jmethodID JPEGImageLoader_setOutputAttributesID;
  96 static jmethodID JPEGImageLoader_updateImageProgressID;
  97 static jmethodID JPEGImageLoader_emitWarningID;
  98 
  99 /* Initialize the Java VM instance variable when the library is
 100    first loaded */
 101 static JavaVM *jvm;
 102 
<span class="line-modified"> 103 #ifdef STATIC_BUILD</span>
 104 
 105 JNIEXPORT jint JNICALL
 106 JNI_OnLoad_javafx_iio(JavaVM *vm, void *reserved) {
 107     jvm = vm;
 108 #ifdef JNI_VERSION_1_8
 109     //min. returned JNI_VERSION required by JDK8 for builtin libraries
 110     JNIEnv *env;
 111     if ((*vm)-&gt;GetEnv(vm, (void **)&amp;env, JNI_VERSION_1_8) != JNI_OK) {
 112             return JNI_VERSION_1_2;
 113     }
 114     return JNI_VERSION_1_8;
 115 #else
 116     return JNI_VERSION_1_2;
 117 #endif
 118 }
 119 
 120 #else
 121 
 122 JNIEXPORT jint JNICALL
 123 JNI_OnLoad(JavaVM *vm, void *reserved) {
 124     jvm = vm;
 125     return JNI_VERSION_1_2;
 126 }
 127 
<span class="line-modified"> 128 #endif // STATIC_BUILD</span>
 129 
 130 
 131 /*
 132  * The following sets of defines must match the warning messages in the
 133  * Java code.
 134  */
 135 
 136 /* Loader warnings */
 137 #define READ_NO_EOI          0
 138 
 139 /* Saver warnings */
 140 
 141 /* Return codes for various ops */
 142 #define OK     1
 143 #define NOT_OK 0
 144 
 145 /*
 146  * First we define two objects, one for the stream and buffer and one
 147  * for pixels.  Both contain references to Java objects and pointers to
 148  * pinned arrays.  These objects can be used for either input or
</pre>
</td>
</tr>
</table>
<center>&lt; prev <a href="../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>