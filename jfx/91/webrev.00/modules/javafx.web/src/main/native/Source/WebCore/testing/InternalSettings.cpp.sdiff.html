<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/testing/InternalSettings.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../svg/properties/SVGPropertyTraits.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="InternalSettings.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/testing/InternalSettings.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  19  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
  20  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
  21  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
  22  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
  23  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
  24  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  25  */
  26 
  27 #include &quot;config.h&quot;
  28 #include &quot;InternalSettings.h&quot;
  29 
  30 #include &quot;CaptionUserPreferences.h&quot;
  31 #include &quot;DeprecatedGlobalSettings.h&quot;
  32 #include &quot;Document.h&quot;
  33 #include &quot;FontCache.h&quot;
  34 #include &quot;Frame.h&quot;
  35 #include &quot;FrameView.h&quot;
  36 #include &quot;LocaleToScriptMapping.h&quot;
  37 #include &quot;Page.h&quot;
  38 #include &quot;PageGroup.h&quot;

  39 #include &quot;RenderTheme.h&quot;
  40 #include &quot;RuntimeEnabledFeatures.h&quot;
  41 #include &quot;Settings.h&quot;
  42 #include &quot;Supplementable.h&quot;
  43 #include &lt;wtf/Language.h&gt;
  44 
  45 #if ENABLE(INPUT_TYPE_COLOR)
  46 #include &quot;ColorChooser.h&quot;
  47 #endif
  48 
  49 #if USE(SOUP)
  50 #include &quot;SoupNetworkSession.h&quot;
  51 #endif
  52 




  53 namespace WebCore {
  54 
  55 InternalSettings::Backup::Backup(Settings&amp; settings)
  56     : m_originalEditingBehavior(settings.editingBehaviorType())
  57 #if ENABLE(TEXT_AUTOSIZING)
  58     , m_originalTextAutosizingEnabled(settings.textAutosizingEnabled())
  59     , m_originalTextAutosizingWindowSizeOverride(settings.textAutosizingWindowSizeOverride())

  60 #endif
  61     , m_originalMediaTypeOverride(settings.mediaTypeOverride())
  62     , m_originalCanvasUsesAcceleratedDrawing(settings.canvasUsesAcceleratedDrawing())
  63     , m_originalMockScrollbarsEnabled(DeprecatedGlobalSettings::mockScrollbarsEnabled())
  64     , m_imagesEnabled(settings.areImagesEnabled())
  65     , m_preferMIMETypeForImages(settings.preferMIMETypeForImages())
  66     , m_minimumDOMTimerInterval(settings.minimumDOMTimerInterval())
  67 #if ENABLE(VIDEO_TRACK)
  68     , m_shouldDisplaySubtitles(settings.shouldDisplaySubtitles())
  69     , m_shouldDisplayCaptions(settings.shouldDisplayCaptions())
  70     , m_shouldDisplayTextDescriptions(settings.shouldDisplayTextDescriptions())
  71 #endif
  72     , m_defaultVideoPosterURL(settings.defaultVideoPosterURL())
  73     , m_forcePendingWebGLPolicy(settings.isForcePendingWebGLPolicy())
  74     , m_originalTimeWithoutMouseMovementBeforeHidingControls(settings.timeWithoutMouseMovementBeforeHidingControls())
  75     , m_useLegacyBackgroundSizeShorthandBehavior(settings.useLegacyBackgroundSizeShorthandBehavior())
  76     , m_autoscrollForDragAndDropEnabled(settings.autoscrollForDragAndDropEnabled())
  77     , m_quickTimePluginReplacementEnabled(settings.quickTimePluginReplacementEnabled())
  78     , m_youTubeFlashPluginReplacementEnabled(settings.youTubeFlashPluginReplacementEnabled())
  79     , m_shouldConvertPositionStyleOnCopy(settings.shouldConvertPositionStyleOnCopy())
  80     , m_fontFallbackPrefersPictographs(settings.fontFallbackPrefersPictographs())
  81     , m_shouldIgnoreFontLoadCompletions(settings.shouldIgnoreFontLoadCompletions())
  82     , m_backgroundShouldExtendBeyondPage(settings.backgroundShouldExtendBeyondPage())
  83     , m_storageBlockingPolicy(settings.storageBlockingPolicy())
  84     , m_scrollingTreeIncludesFrames(settings.scrollingTreeIncludesFrames())
  85 #if ENABLE(TOUCH_EVENTS)
  86     , m_touchEventEmulationEnabled(settings.isTouchEventEmulationEnabled())
  87 #endif
  88 #if ENABLE(WIRELESS_PLAYBACK_TARGET)
  89     , m_allowsAirPlayForMediaPlayback(settings.allowsAirPlayForMediaPlayback())
  90 #endif
  91     , m_allowsInlineMediaPlayback(settings.allowsInlineMediaPlayback())
  92     , m_allowsInlineMediaPlaybackAfterFullscreen(settings.allowsInlineMediaPlaybackAfterFullscreen())
  93     , m_inlineMediaPlaybackRequiresPlaysInlineAttribute(settings.inlineMediaPlaybackRequiresPlaysInlineAttribute())
  94     , m_deferredCSSParserEnabled(settings.deferredCSSParserEnabled())
  95     , m_inputEventsEnabled(settings.inputEventsEnabled())
  96     , m_incompleteImageBorderEnabled(settings.incompleteImageBorderEnabled())
<span class="line-modified">  97 #if ENABLE(ACCESSIBILITY_EVENTS)</span>
<span class="line-modified">  98     , m_accessibilityEventsEnabled(settings.accessibilityEventsEnabled())</span>
<span class="line-modified">  99 #endif</span>

 100     , m_userInterfaceDirectionPolicy(settings.userInterfaceDirectionPolicy())
 101     , m_systemLayoutDirection(settings.systemLayoutDirection())
 102     , m_pdfImageCachingPolicy(settings.pdfImageCachingPolicy())
 103     , m_forcedColorsAreInvertedAccessibilityValue(settings.forcedColorsAreInvertedAccessibilityValue())
 104     , m_forcedDisplayIsMonochromeAccessibilityValue(settings.forcedDisplayIsMonochromeAccessibilityValue())
 105     , m_forcedPrefersReducedMotionAccessibilityValue(settings.forcedPrefersReducedMotionAccessibilityValue())
 106     , m_fontLoadTimingOverride(settings.fontLoadTimingOverride())
 107     , m_frameFlattening(settings.frameFlattening())
 108 #if ENABLE(INDEXED_DATABASE_IN_WORKERS)
 109     , m_indexedDBWorkersEnabled(RuntimeEnabledFeatures::sharedFeatures().indexedDBWorkersEnabled())
 110 #endif
 111 #if ENABLE(WEBGL2)
 112     , m_webGL2Enabled(RuntimeEnabledFeatures::sharedFeatures().webGL2Enabled())
<span class="line-removed"> 113 #endif</span>
<span class="line-removed"> 114 #if ENABLE(WEBMETAL)</span>
<span class="line-removed"> 115     , m_webMetalEnabled(RuntimeEnabledFeatures::sharedFeatures().webMetalEnabled())</span>
 116 #endif
 117     , m_webVREnabled(RuntimeEnabledFeatures::sharedFeatures().webVREnabled())
 118 #if ENABLE(MEDIA_STREAM)
 119     , m_setScreenCaptureEnabled(RuntimeEnabledFeatures::sharedFeatures().screenCaptureEnabled())
 120 #endif
 121     , m_shouldMockBoldSystemFontForAccessibility(RenderTheme::singleton().shouldMockBoldSystemFontForAccessibility())
 122 #if USE(AUDIO_SESSION)
 123     , m_shouldManageAudioSessionCategory(DeprecatedGlobalSettings::shouldManageAudioSessionCategory())
 124 #endif
 125     , m_customPasteboardDataEnabled(RuntimeEnabledFeatures::sharedFeatures().customPasteboardDataEnabled())
<span class="line-removed"> 126     , m_promptForStorageAccessAPIEnabled(RuntimeEnabledFeatures::sharedFeatures().storageAccessPromptsEnabled())</span>
 127 {
 128 }
 129 
 130 void InternalSettings::Backup::restoreTo(Settings&amp; settings)
 131 {
 132     settings.setEditingBehaviorType(m_originalEditingBehavior);
 133 
 134     for (const auto&amp; standardFont : m_standardFontFamilies)
 135         settings.setStandardFontFamily(standardFont.value, static_cast&lt;UScriptCode&gt;(standardFont.key));
 136     m_standardFontFamilies.clear();
 137 
 138     for (const auto&amp; fixedFont : m_fixedFontFamilies)
 139         settings.setFixedFontFamily(fixedFont.value, static_cast&lt;UScriptCode&gt;(fixedFont.key));
 140     m_fixedFontFamilies.clear();
 141 
 142     for (const auto&amp; serifFont : m_serifFontFamilies)
 143         settings.setSerifFontFamily(serifFont.value, static_cast&lt;UScriptCode&gt;(serifFont.key));
 144     m_serifFontFamilies.clear();
 145 
 146     for (const auto&amp; sansSerifFont : m_sansSerifFontFamilies)
 147         settings.setSansSerifFontFamily(sansSerifFont.value, static_cast&lt;UScriptCode&gt;(sansSerifFont.key));
 148     m_sansSerifFontFamilies.clear();
 149 
 150     for (const auto&amp; cursiveFont : m_cursiveFontFamilies)
 151         settings.setCursiveFontFamily(cursiveFont.value, static_cast&lt;UScriptCode&gt;(cursiveFont.key));
 152     m_cursiveFontFamilies.clear();
 153 
 154     for (const auto&amp; fantasyFont : m_fantasyFontFamilies)
 155         settings.setFantasyFontFamily(fantasyFont.value, static_cast&lt;UScriptCode&gt;(fantasyFont.key));
 156     m_fantasyFontFamilies.clear();
 157 
 158     for (const auto&amp; pictographFont : m_pictographFontFamilies)
 159         settings.setPictographFontFamily(pictographFont.value, static_cast&lt;UScriptCode&gt;(pictographFont.key));
 160     m_pictographFontFamilies.clear();
 161 
 162 #if ENABLE(TEXT_AUTOSIZING)
 163     settings.setTextAutosizingEnabled(m_originalTextAutosizingEnabled);
 164     settings.setTextAutosizingWindowSizeOverride(m_originalTextAutosizingWindowSizeOverride);

 165 #endif
 166     settings.setMediaTypeOverride(m_originalMediaTypeOverride);
 167     settings.setCanvasUsesAcceleratedDrawing(m_originalCanvasUsesAcceleratedDrawing);
 168     settings.setImagesEnabled(m_imagesEnabled);
 169     settings.setPreferMIMETypeForImages(m_preferMIMETypeForImages);
 170     settings.setMinimumDOMTimerInterval(m_minimumDOMTimerInterval);
 171 #if ENABLE(VIDEO_TRACK)
 172     settings.setShouldDisplaySubtitles(m_shouldDisplaySubtitles);
 173     settings.setShouldDisplayCaptions(m_shouldDisplayCaptions);
 174     settings.setShouldDisplayTextDescriptions(m_shouldDisplayTextDescriptions);
 175 #endif
 176     settings.setDefaultVideoPosterURL(m_defaultVideoPosterURL);
 177     settings.setForcePendingWebGLPolicy(m_forcePendingWebGLPolicy);
 178     settings.setTimeWithoutMouseMovementBeforeHidingControls(m_originalTimeWithoutMouseMovementBeforeHidingControls);
 179     settings.setUseLegacyBackgroundSizeShorthandBehavior(m_useLegacyBackgroundSizeShorthandBehavior);
 180     settings.setAutoscrollForDragAndDropEnabled(m_autoscrollForDragAndDropEnabled);
 181     settings.setShouldConvertPositionStyleOnCopy(m_shouldConvertPositionStyleOnCopy);
 182     settings.setFontFallbackPrefersPictographs(m_fontFallbackPrefersPictographs);
 183     settings.setShouldIgnoreFontLoadCompletions(m_shouldIgnoreFontLoadCompletions);
 184     settings.setBackgroundShouldExtendBeyondPage(m_backgroundShouldExtendBeyondPage);
</pre>
<hr />
<pre>
 189 #endif
 190     settings.setAllowsInlineMediaPlayback(m_allowsInlineMediaPlayback);
 191     settings.setAllowsInlineMediaPlaybackAfterFullscreen(m_allowsInlineMediaPlaybackAfterFullscreen);
 192     settings.setInlineMediaPlaybackRequiresPlaysInlineAttribute(m_inlineMediaPlaybackRequiresPlaysInlineAttribute);
 193     settings.setQuickTimePluginReplacementEnabled(m_quickTimePluginReplacementEnabled);
 194     settings.setYouTubeFlashPluginReplacementEnabled(m_youTubeFlashPluginReplacementEnabled);
 195     settings.setDeferredCSSParserEnabled(m_deferredCSSParserEnabled);
 196     settings.setInputEventsEnabled(m_inputEventsEnabled);
 197     settings.setUserInterfaceDirectionPolicy(m_userInterfaceDirectionPolicy);
 198     settings.setSystemLayoutDirection(m_systemLayoutDirection);
 199     settings.setPdfImageCachingPolicy(m_pdfImageCachingPolicy);
 200     settings.setForcedColorsAreInvertedAccessibilityValue(m_forcedColorsAreInvertedAccessibilityValue);
 201     settings.setForcedDisplayIsMonochromeAccessibilityValue(m_forcedDisplayIsMonochromeAccessibilityValue);
 202     settings.setForcedPrefersReducedMotionAccessibilityValue(m_forcedPrefersReducedMotionAccessibilityValue);
 203     settings.setFontLoadTimingOverride(m_fontLoadTimingOverride);
 204     DeprecatedGlobalSettings::setAllowsAnySSLCertificate(false);
 205     RenderTheme::singleton().setShouldMockBoldSystemFontForAccessibility(m_shouldMockBoldSystemFontForAccessibility);
 206     FontCache::singleton().setShouldMockBoldSystemFontForAccessibility(m_shouldMockBoldSystemFontForAccessibility);
 207     settings.setFrameFlattening(m_frameFlattening);
 208     settings.setIncompleteImageBorderEnabled(m_incompleteImageBorderEnabled);
<span class="line-modified"> 209 #if ENABLE(ACCESSIBILITY_EVENTS)</span>
<span class="line-modified"> 210     settings.setAccessibilityEventsEnabled(m_accessibilityEventsEnabled);</span>
<span class="line-modified"> 211 #endif</span>

 212 
 213 #if ENABLE(INDEXED_DATABASE_IN_WORKERS)
 214     RuntimeEnabledFeatures::sharedFeatures().setIndexedDBWorkersEnabled(m_indexedDBWorkersEnabled);
 215 #endif
 216 #if ENABLE(WEBGL2)
 217     RuntimeEnabledFeatures::sharedFeatures().setWebGL2Enabled(m_webGL2Enabled);
<span class="line-removed"> 218 #endif</span>
<span class="line-removed"> 219 #if ENABLE(WEBMETAL)</span>
<span class="line-removed"> 220     RuntimeEnabledFeatures::sharedFeatures().setWebMetalEnabled(m_webMetalEnabled);</span>
 221 #endif
 222     RuntimeEnabledFeatures::sharedFeatures().setWebVREnabled(m_webVREnabled);
 223 #if ENABLE(MEDIA_STREAM)
 224     RuntimeEnabledFeatures::sharedFeatures().setScreenCaptureEnabled(m_setScreenCaptureEnabled);
 225 #endif
 226     RuntimeEnabledFeatures::sharedFeatures().setCustomPasteboardDataEnabled(m_customPasteboardDataEnabled);
 227 
 228 #if USE(AUDIO_SESSION)
 229     DeprecatedGlobalSettings::setShouldManageAudioSessionCategory(m_shouldManageAudioSessionCategory);
 230 #endif
<span class="line-removed"> 231 </span>
<span class="line-removed"> 232     RuntimeEnabledFeatures::sharedFeatures().setStorageAccessPromptsEnabled(m_promptForStorageAccessAPIEnabled);</span>
 233 }
 234 
 235 class InternalSettingsWrapper : public Supplement&lt;Page&gt; {

 236 public:
 237     explicit InternalSettingsWrapper(Page* page)
 238         : m_internalSettings(InternalSettings::create(page)) { }
 239     virtual ~InternalSettingsWrapper() { m_internalSettings-&gt;hostDestroyed(); }
 240 #if !ASSERT_DISABLED
 241     bool isRefCountedWrapper() const override { return true; }
 242 #endif
 243     InternalSettings* internalSettings() const { return m_internalSettings.get(); }
 244 
 245 private:
 246     RefPtr&lt;InternalSettings&gt; m_internalSettings;
 247 };
 248 
 249 const char* InternalSettings::supplementName()
 250 {
 251     return &quot;InternalSettings&quot;;
 252 }
 253 
 254 InternalSettings* InternalSettings::from(Page* page)
 255 {
 256     if (!Supplement&lt;Page&gt;::from(page, supplementName()))
<span class="line-modified"> 257         Supplement&lt;Page&gt;::provideTo(page, supplementName(), std::make_unique&lt;InternalSettingsWrapper&gt;(page));</span>
 258     return static_cast&lt;InternalSettingsWrapper*&gt;(Supplement&lt;Page&gt;::from(page, supplementName()))-&gt;internalSettings();
 259 }
 260 
 261 void InternalSettings::hostDestroyed()
 262 {
 263     m_page = nullptr;
 264 }
 265 
 266 InternalSettings::InternalSettings(Page* page)
 267     : InternalSettingsGenerated(page)
 268     , m_page(page)
 269     , m_backup(page-&gt;settings())
 270 {
 271 #if ENABLE(WIRELESS_PLAYBACK_TARGET)
 272     setAllowsAirPlayForMediaPlayback(false);
 273 #endif
 274 #if ENABLE(MEDIA_STREAM)
 275     setMediaCaptureRequiresSecureConnection(false);
 276 #endif
 277 }
 278 
 279 Ref&lt;InternalSettings&gt; InternalSettings::create(Page* page)
 280 {
 281     return adoptRef(*new InternalSettings(page));
 282 }
 283 
 284 void InternalSettings::resetToConsistentState()
 285 {
 286     m_page-&gt;setPageScaleFactor(1, { 0, 0 });
 287     m_page-&gt;mainFrame().setPageAndTextZoomFactors(1, 1);
 288     m_page-&gt;setCanStartMedia(true);
<span class="line-modified"> 289     m_page-&gt;setUseDarkAppearance(false);</span>
 290 
 291     settings().setForcePendingWebGLPolicy(false);
 292 #if ENABLE(WIRELESS_PLAYBACK_TARGET)
 293     settings().setAllowsAirPlayForMediaPlayback(false);
 294 #endif
 295 #if ENABLE(MEDIA_STREAM)
 296     setMediaCaptureRequiresSecureConnection(false);
 297 #endif
 298 
 299     m_backup.restoreTo(settings());
 300     m_backup = Backup { settings() };
 301 
 302     InternalSettingsGenerated::resetToConsistentState();
 303 }
 304 
 305 Settings&amp; InternalSettings::settings() const
 306 {
 307     ASSERT(m_page);
 308     return m_page-&gt;settings();
 309 }
</pre>
<hr />
<pre>
 412     settings().setTextAutosizingEnabled(enabled);
 413 #else
 414     UNUSED_PARAM(enabled);
 415 #endif
 416     return { };
 417 }
 418 
 419 ExceptionOr&lt;void&gt; InternalSettings::setTextAutosizingWindowSizeOverride(int width, int height)
 420 {
 421     if (!m_page)
 422         return Exception { InvalidAccessError };
 423 #if ENABLE(TEXT_AUTOSIZING)
 424     settings().setTextAutosizingWindowSizeOverride(IntSize(width, height));
 425 #else
 426     UNUSED_PARAM(width);
 427     UNUSED_PARAM(height);
 428 #endif
 429     return { };
 430 }
 431 












 432 ExceptionOr&lt;void&gt; InternalSettings::setMediaTypeOverride(const String&amp; mediaType)
 433 {
 434     if (!m_page)
 435         return Exception { InvalidAccessError };
 436     settings().setMediaTypeOverride(mediaType);
 437     return { };
 438 }
 439 
 440 ExceptionOr&lt;void&gt; InternalSettings::setCanStartMedia(bool enabled)
 441 {
 442     if (!m_page)
 443         return Exception { InvalidAccessError };
 444     m_page-&gt;setCanStartMedia(enabled);
 445     return { };
 446 }
 447 
 448 ExceptionOr&lt;void&gt; InternalSettings::setAllowsAirPlayForMediaPlayback(bool allows)
 449 {
 450     if (!m_page)
 451         return Exception { InvalidAccessError };
</pre>
<hr />
<pre>
 510 ExceptionOr&lt;bool&gt; InternalSettings::shouldDisplayTrackKind(const String&amp; kind)
 511 {
 512     if (!m_page)
 513         return Exception { InvalidAccessError };
 514 #if ENABLE(VIDEO_TRACK)
 515     auto&amp; captionPreferences = m_page-&gt;group().captionPreferences();
 516     if (equalLettersIgnoringASCIICase(kind, &quot;subtitles&quot;))
 517         return captionPreferences.userPrefersSubtitles();
 518     if (equalLettersIgnoringASCIICase(kind, &quot;captions&quot;))
 519         return captionPreferences.userPrefersCaptions();
 520     if (equalLettersIgnoringASCIICase(kind, &quot;textdescriptions&quot;))
 521         return captionPreferences.userPrefersTextDescriptions();
 522 
 523     return Exception { SyntaxError };
 524 #else
 525     UNUSED_PARAM(kind);
 526     return false;
 527 #endif
 528 }
 529 
















 530 ExceptionOr&lt;void&gt; InternalSettings::setUseDarkAppearance(bool useDarkAppearance)
 531 {
 532     if (!m_page)
 533         return Exception { InvalidAccessError };
<span class="line-modified"> 534     m_page-&gt;setUseDarkAppearance(useDarkAppearance);</span>
 535     return { };
 536 }
 537 
 538 ExceptionOr&lt;void&gt; InternalSettings::setStorageBlockingPolicy(const String&amp; mode)
 539 {
 540     if (!m_page)
 541         return Exception { InvalidAccessError };
 542     if (mode == &quot;AllowAll&quot;)
 543         settings().setStorageBlockingPolicy(SecurityOrigin::AllowAllStorage);
 544     else if (mode == &quot;BlockThirdParty&quot;)
 545         settings().setStorageBlockingPolicy(SecurityOrigin::BlockThirdPartyStorage);
 546     else if (mode == &quot;BlockAll&quot;)
 547         settings().setStorageBlockingPolicy(SecurityOrigin::BlockAllStorage);
 548     else
 549         return Exception { SyntaxError };
 550     return { };
 551 }
 552 
 553 ExceptionOr&lt;void&gt; InternalSettings::setPreferMIMETypeForImages(bool preferMIMETypeForImages)
 554 {
</pre>
<hr />
<pre>
 732     return { };
 733 }
 734 
 735 ExceptionOr&lt;void&gt; InternalSettings::setInlineMediaPlaybackRequiresPlaysInlineAttribute(bool requires)
 736 {
 737     if (!m_page)
 738         return Exception { InvalidAccessError };
 739     settings().setInlineMediaPlaybackRequiresPlaysInlineAttribute(requires);
 740     return { };
 741 }
 742 
 743 ExceptionOr&lt;void&gt; InternalSettings::setShouldMockBoldSystemFontForAccessibility(bool requires)
 744 {
 745     if (!m_page)
 746         return Exception { InvalidAccessError };
 747     RenderTheme::singleton().setShouldMockBoldSystemFontForAccessibility(requires);
 748     FontCache::singleton().setShouldMockBoldSystemFontForAccessibility(requires);
 749     return { };
 750 }
 751 








 752 void InternalSettings::setIndexedDBWorkersEnabled(bool enabled)
 753 {
 754 #if ENABLE(INDEXED_DATABASE_IN_WORKERS)
 755     RuntimeEnabledFeatures::sharedFeatures().setIndexedDBWorkersEnabled(enabled);
 756 #else
 757     UNUSED_PARAM(enabled);
 758 #endif
 759 }
 760 
 761 void InternalSettings::setWebGL2Enabled(bool enabled)
 762 {
 763 #if ENABLE(WEBGL2)
 764     RuntimeEnabledFeatures::sharedFeatures().setWebGL2Enabled(enabled);
 765 #else
 766     UNUSED_PARAM(enabled);
 767 #endif
 768 }
 769 
<span class="line-modified"> 770 void InternalSettings::setWebMetalEnabled(bool enabled)</span>
 771 {
<span class="line-modified"> 772 #if ENABLE(WEBMETAL)</span>
<span class="line-modified"> 773     RuntimeEnabledFeatures::sharedFeatures().setWebMetalEnabled(enabled);</span>
 774 #else
 775     UNUSED_PARAM(enabled);
 776 #endif
 777 }
 778 
 779 void InternalSettings::setWebVREnabled(bool enabled)
 780 {
 781     RuntimeEnabledFeatures::sharedFeatures().setWebVREnabled(enabled);
 782 }
 783 
 784 void InternalSettings::setScreenCaptureEnabled(bool enabled)
 785 {
 786 #if ENABLE(MEDIA_STREAM)
 787     RuntimeEnabledFeatures::sharedFeatures().setScreenCaptureEnabled(enabled);
 788 #else
 789     UNUSED_PARAM(enabled);
 790 #endif
 791 }
 792 
<span class="line-removed"> 793 void InternalSettings::setStorageAccessPromptsEnabled(bool enabled)</span>
<span class="line-removed"> 794 {</span>
<span class="line-removed"> 795     RuntimeEnabledFeatures::sharedFeatures().setStorageAccessPromptsEnabled(enabled);</span>
<span class="line-removed"> 796 }</span>
<span class="line-removed"> 797 </span>
 798 ExceptionOr&lt;String&gt; InternalSettings::userInterfaceDirectionPolicy()
 799 {
 800     if (!m_page)
 801         return Exception { InvalidAccessError };
 802     switch (settings().userInterfaceDirectionPolicy()) {
 803     case UserInterfaceDirectionPolicy::Content:
 804         return &quot;Content&quot;_str;
 805     case UserInterfaceDirectionPolicy::System:
 806         return &quot;View&quot;_str;
 807     }
 808     ASSERT_NOT_REACHED();
 809     return Exception { InvalidAccessError };
 810 }
 811 
 812 ExceptionOr&lt;void&gt; InternalSettings::setUserInterfaceDirectionPolicy(const String&amp; policy)
 813 {
 814     if (!m_page)
 815         return Exception { InvalidAccessError };
 816     if (equalLettersIgnoringASCIICase(policy, &quot;content&quot;)) {
 817         settings().setUserInterfaceDirectionPolicy(UserInterfaceDirectionPolicy::Content);
</pre>
<hr />
<pre>
 884     return { };
 885 }
 886 
 887 ExceptionOr&lt;void&gt; InternalSettings::setShouldManageAudioSessionCategory(bool should)
 888 {
 889 #if USE(AUDIO_SESSION)
 890     DeprecatedGlobalSettings::setShouldManageAudioSessionCategory(should);
 891     return { };
 892 #else
 893     UNUSED_PARAM(should);
 894     return Exception { InvalidAccessError };
 895 #endif
 896 }
 897 
 898 ExceptionOr&lt;void&gt; InternalSettings::setCustomPasteboardDataEnabled(bool enabled)
 899 {
 900     RuntimeEnabledFeatures::sharedFeatures().setCustomPasteboardDataEnabled(enabled);
 901     return { };
 902 }
 903 
<span class="line-modified"> 904 ExceptionOr&lt;void&gt; InternalSettings::setAccessibilityEventsEnabled(bool enabled)</span>
 905 {
 906     if (!m_page)
 907         return Exception { InvalidAccessError };
<span class="line-modified"> 908 #if ENABLE(ACCESSIBILITY_EVENTS)</span>
<span class="line-removed"> 909     settings().setAccessibilityEventsEnabled(enabled);</span>
<span class="line-removed"> 910 #else</span>
<span class="line-removed"> 911     UNUSED_PARAM(enabled);</span>
<span class="line-removed"> 912 #endif</span>
 913     return { };
 914 }
 915 
<span class="line-modified"> 916 ExceptionOr&lt;void&gt; InternalSettings::setIncompleteImageBorderEnabled(bool enabled)</span>
 917 {
 918     if (!m_page)
 919         return Exception { InvalidAccessError };
<span class="line-modified"> 920     settings().setIncompleteImageBorderEnabled(enabled);</span>








 921     return { };
 922 }
 923 
 924 static InternalSettings::ForcedAccessibilityValue settingsToInternalSettingsValue(Settings::ForcedAccessibilityValue value)
 925 {
 926     switch (value) {
 927     case Settings::ForcedAccessibilityValue::System:
 928         return InternalSettings::ForcedAccessibilityValue::System;
 929     case Settings::ForcedAccessibilityValue::On:
 930         return InternalSettings::ForcedAccessibilityValue::On;
 931     case Settings::ForcedAccessibilityValue::Off:
 932         return InternalSettings::ForcedAccessibilityValue::Off;
 933     }
 934 
 935     ASSERT_NOT_REACHED();
 936     return InternalSettings::ForcedAccessibilityValue::Off;
 937 }
 938 
 939 static Settings::ForcedAccessibilityValue internalSettingsToSettingsValue(InternalSettings::ForcedAccessibilityValue value)
 940 {
</pre>
<hr />
<pre>
 969 void InternalSettings::setForcedDisplayIsMonochromeAccessibilityValue(InternalSettings::ForcedAccessibilityValue value)
 970 {
 971     settings().setForcedDisplayIsMonochromeAccessibilityValue(internalSettingsToSettingsValue(value));
 972 }
 973 
 974 InternalSettings::ForcedAccessibilityValue InternalSettings::forcedPrefersReducedMotionAccessibilityValue() const
 975 {
 976     return settingsToInternalSettingsValue(settings().forcedPrefersReducedMotionAccessibilityValue());
 977 }
 978 
 979 void InternalSettings::setForcedPrefersReducedMotionAccessibilityValue(InternalSettings::ForcedAccessibilityValue value)
 980 {
 981     settings().setForcedPrefersReducedMotionAccessibilityValue(internalSettingsToSettingsValue(value));
 982 }
 983 
 984 bool InternalSettings::webAnimationsCSSIntegrationEnabled()
 985 {
 986     return RuntimeEnabledFeatures::sharedFeatures().webAnimationsCSSIntegrationEnabled();
 987 }
 988 





 989 // If you add to this class, make sure that you update the Backup class for test reproducability!
 990 
 991 }
</pre>
</td>
<td>
<hr />
<pre>
  19  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
  20  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
  21  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
  22  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
  23  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
  24  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  25  */
  26 
  27 #include &quot;config.h&quot;
  28 #include &quot;InternalSettings.h&quot;
  29 
  30 #include &quot;CaptionUserPreferences.h&quot;
  31 #include &quot;DeprecatedGlobalSettings.h&quot;
  32 #include &quot;Document.h&quot;
  33 #include &quot;FontCache.h&quot;
  34 #include &quot;Frame.h&quot;
  35 #include &quot;FrameView.h&quot;
  36 #include &quot;LocaleToScriptMapping.h&quot;
  37 #include &quot;Page.h&quot;
  38 #include &quot;PageGroup.h&quot;
<span class="line-added">  39 #include &quot;PlatformMediaSessionManager.h&quot;</span>
  40 #include &quot;RenderTheme.h&quot;
  41 #include &quot;RuntimeEnabledFeatures.h&quot;
  42 #include &quot;Settings.h&quot;
  43 #include &quot;Supplementable.h&quot;
  44 #include &lt;wtf/Language.h&gt;
  45 
  46 #if ENABLE(INPUT_TYPE_COLOR)
  47 #include &quot;ColorChooser.h&quot;
  48 #endif
  49 
  50 #if USE(SOUP)
  51 #include &quot;SoupNetworkSession.h&quot;
  52 #endif
  53 
<span class="line-added">  54 #if PLATFORM(GTK)</span>
<span class="line-added">  55 #include &lt;gtk/gtk.h&gt;</span>
<span class="line-added">  56 #endif</span>
<span class="line-added">  57 </span>
  58 namespace WebCore {
  59 
  60 InternalSettings::Backup::Backup(Settings&amp; settings)
  61     : m_originalEditingBehavior(settings.editingBehaviorType())
  62 #if ENABLE(TEXT_AUTOSIZING)
  63     , m_originalTextAutosizingEnabled(settings.textAutosizingEnabled())
  64     , m_originalTextAutosizingWindowSizeOverride(settings.textAutosizingWindowSizeOverride())
<span class="line-added">  65     , m_originalTextAutosizingUsesIdempotentMode(settings.textAutosizingUsesIdempotentMode())</span>
  66 #endif
  67     , m_originalMediaTypeOverride(settings.mediaTypeOverride())
  68     , m_originalCanvasUsesAcceleratedDrawing(settings.canvasUsesAcceleratedDrawing())
  69     , m_originalMockScrollbarsEnabled(DeprecatedGlobalSettings::mockScrollbarsEnabled())
  70     , m_imagesEnabled(settings.areImagesEnabled())
  71     , m_preferMIMETypeForImages(settings.preferMIMETypeForImages())
  72     , m_minimumDOMTimerInterval(settings.minimumDOMTimerInterval())
  73 #if ENABLE(VIDEO_TRACK)
  74     , m_shouldDisplaySubtitles(settings.shouldDisplaySubtitles())
  75     , m_shouldDisplayCaptions(settings.shouldDisplayCaptions())
  76     , m_shouldDisplayTextDescriptions(settings.shouldDisplayTextDescriptions())
  77 #endif
  78     , m_defaultVideoPosterURL(settings.defaultVideoPosterURL())
  79     , m_forcePendingWebGLPolicy(settings.isForcePendingWebGLPolicy())
  80     , m_originalTimeWithoutMouseMovementBeforeHidingControls(settings.timeWithoutMouseMovementBeforeHidingControls())
  81     , m_useLegacyBackgroundSizeShorthandBehavior(settings.useLegacyBackgroundSizeShorthandBehavior())
  82     , m_autoscrollForDragAndDropEnabled(settings.autoscrollForDragAndDropEnabled())
  83     , m_quickTimePluginReplacementEnabled(settings.quickTimePluginReplacementEnabled())
  84     , m_youTubeFlashPluginReplacementEnabled(settings.youTubeFlashPluginReplacementEnabled())
  85     , m_shouldConvertPositionStyleOnCopy(settings.shouldConvertPositionStyleOnCopy())
  86     , m_fontFallbackPrefersPictographs(settings.fontFallbackPrefersPictographs())
  87     , m_shouldIgnoreFontLoadCompletions(settings.shouldIgnoreFontLoadCompletions())
  88     , m_backgroundShouldExtendBeyondPage(settings.backgroundShouldExtendBeyondPage())
  89     , m_storageBlockingPolicy(settings.storageBlockingPolicy())
  90     , m_scrollingTreeIncludesFrames(settings.scrollingTreeIncludesFrames())
  91 #if ENABLE(TOUCH_EVENTS)
  92     , m_touchEventEmulationEnabled(settings.isTouchEventEmulationEnabled())
  93 #endif
  94 #if ENABLE(WIRELESS_PLAYBACK_TARGET)
  95     , m_allowsAirPlayForMediaPlayback(settings.allowsAirPlayForMediaPlayback())
  96 #endif
  97     , m_allowsInlineMediaPlayback(settings.allowsInlineMediaPlayback())
  98     , m_allowsInlineMediaPlaybackAfterFullscreen(settings.allowsInlineMediaPlaybackAfterFullscreen())
  99     , m_inlineMediaPlaybackRequiresPlaysInlineAttribute(settings.inlineMediaPlaybackRequiresPlaysInlineAttribute())
 100     , m_deferredCSSParserEnabled(settings.deferredCSSParserEnabled())
 101     , m_inputEventsEnabled(settings.inputEventsEnabled())
 102     , m_incompleteImageBorderEnabled(settings.incompleteImageBorderEnabled())
<span class="line-modified"> 103     , m_shouldDispatchSyntheticMouseEventsWhenModifyingSelection(settings.shouldDispatchSyntheticMouseEventsWhenModifyingSelection())</span>
<span class="line-modified"> 104     , m_shouldDispatchSyntheticMouseOutAfterSyntheticClick(settings.shouldDispatchSyntheticMouseOutAfterSyntheticClick())</span>
<span class="line-modified"> 105     , m_shouldDeactivateAudioSession(PlatformMediaSessionManager::shouldDeactivateAudioSession())</span>
<span class="line-added"> 106     , m_animatedImageDebugCanvasDrawingEnabled(settings.animatedImageDebugCanvasDrawingEnabled())</span>
 107     , m_userInterfaceDirectionPolicy(settings.userInterfaceDirectionPolicy())
 108     , m_systemLayoutDirection(settings.systemLayoutDirection())
 109     , m_pdfImageCachingPolicy(settings.pdfImageCachingPolicy())
 110     , m_forcedColorsAreInvertedAccessibilityValue(settings.forcedColorsAreInvertedAccessibilityValue())
 111     , m_forcedDisplayIsMonochromeAccessibilityValue(settings.forcedDisplayIsMonochromeAccessibilityValue())
 112     , m_forcedPrefersReducedMotionAccessibilityValue(settings.forcedPrefersReducedMotionAccessibilityValue())
 113     , m_fontLoadTimingOverride(settings.fontLoadTimingOverride())
 114     , m_frameFlattening(settings.frameFlattening())
 115 #if ENABLE(INDEXED_DATABASE_IN_WORKERS)
 116     , m_indexedDBWorkersEnabled(RuntimeEnabledFeatures::sharedFeatures().indexedDBWorkersEnabled())
 117 #endif
 118 #if ENABLE(WEBGL2)
 119     , m_webGL2Enabled(RuntimeEnabledFeatures::sharedFeatures().webGL2Enabled())



 120 #endif
 121     , m_webVREnabled(RuntimeEnabledFeatures::sharedFeatures().webVREnabled())
 122 #if ENABLE(MEDIA_STREAM)
 123     , m_setScreenCaptureEnabled(RuntimeEnabledFeatures::sharedFeatures().screenCaptureEnabled())
 124 #endif
 125     , m_shouldMockBoldSystemFontForAccessibility(RenderTheme::singleton().shouldMockBoldSystemFontForAccessibility())
 126 #if USE(AUDIO_SESSION)
 127     , m_shouldManageAudioSessionCategory(DeprecatedGlobalSettings::shouldManageAudioSessionCategory())
 128 #endif
 129     , m_customPasteboardDataEnabled(RuntimeEnabledFeatures::sharedFeatures().customPasteboardDataEnabled())

 130 {
 131 }
 132 
 133 void InternalSettings::Backup::restoreTo(Settings&amp; settings)
 134 {
 135     settings.setEditingBehaviorType(m_originalEditingBehavior);
 136 
 137     for (const auto&amp; standardFont : m_standardFontFamilies)
 138         settings.setStandardFontFamily(standardFont.value, static_cast&lt;UScriptCode&gt;(standardFont.key));
 139     m_standardFontFamilies.clear();
 140 
 141     for (const auto&amp; fixedFont : m_fixedFontFamilies)
 142         settings.setFixedFontFamily(fixedFont.value, static_cast&lt;UScriptCode&gt;(fixedFont.key));
 143     m_fixedFontFamilies.clear();
 144 
 145     for (const auto&amp; serifFont : m_serifFontFamilies)
 146         settings.setSerifFontFamily(serifFont.value, static_cast&lt;UScriptCode&gt;(serifFont.key));
 147     m_serifFontFamilies.clear();
 148 
 149     for (const auto&amp; sansSerifFont : m_sansSerifFontFamilies)
 150         settings.setSansSerifFontFamily(sansSerifFont.value, static_cast&lt;UScriptCode&gt;(sansSerifFont.key));
 151     m_sansSerifFontFamilies.clear();
 152 
 153     for (const auto&amp; cursiveFont : m_cursiveFontFamilies)
 154         settings.setCursiveFontFamily(cursiveFont.value, static_cast&lt;UScriptCode&gt;(cursiveFont.key));
 155     m_cursiveFontFamilies.clear();
 156 
 157     for (const auto&amp; fantasyFont : m_fantasyFontFamilies)
 158         settings.setFantasyFontFamily(fantasyFont.value, static_cast&lt;UScriptCode&gt;(fantasyFont.key));
 159     m_fantasyFontFamilies.clear();
 160 
 161     for (const auto&amp; pictographFont : m_pictographFontFamilies)
 162         settings.setPictographFontFamily(pictographFont.value, static_cast&lt;UScriptCode&gt;(pictographFont.key));
 163     m_pictographFontFamilies.clear();
 164 
 165 #if ENABLE(TEXT_AUTOSIZING)
 166     settings.setTextAutosizingEnabled(m_originalTextAutosizingEnabled);
 167     settings.setTextAutosizingWindowSizeOverride(m_originalTextAutosizingWindowSizeOverride);
<span class="line-added"> 168     settings.setTextAutosizingUsesIdempotentMode(m_originalTextAutosizingUsesIdempotentMode);</span>
 169 #endif
 170     settings.setMediaTypeOverride(m_originalMediaTypeOverride);
 171     settings.setCanvasUsesAcceleratedDrawing(m_originalCanvasUsesAcceleratedDrawing);
 172     settings.setImagesEnabled(m_imagesEnabled);
 173     settings.setPreferMIMETypeForImages(m_preferMIMETypeForImages);
 174     settings.setMinimumDOMTimerInterval(m_minimumDOMTimerInterval);
 175 #if ENABLE(VIDEO_TRACK)
 176     settings.setShouldDisplaySubtitles(m_shouldDisplaySubtitles);
 177     settings.setShouldDisplayCaptions(m_shouldDisplayCaptions);
 178     settings.setShouldDisplayTextDescriptions(m_shouldDisplayTextDescriptions);
 179 #endif
 180     settings.setDefaultVideoPosterURL(m_defaultVideoPosterURL);
 181     settings.setForcePendingWebGLPolicy(m_forcePendingWebGLPolicy);
 182     settings.setTimeWithoutMouseMovementBeforeHidingControls(m_originalTimeWithoutMouseMovementBeforeHidingControls);
 183     settings.setUseLegacyBackgroundSizeShorthandBehavior(m_useLegacyBackgroundSizeShorthandBehavior);
 184     settings.setAutoscrollForDragAndDropEnabled(m_autoscrollForDragAndDropEnabled);
 185     settings.setShouldConvertPositionStyleOnCopy(m_shouldConvertPositionStyleOnCopy);
 186     settings.setFontFallbackPrefersPictographs(m_fontFallbackPrefersPictographs);
 187     settings.setShouldIgnoreFontLoadCompletions(m_shouldIgnoreFontLoadCompletions);
 188     settings.setBackgroundShouldExtendBeyondPage(m_backgroundShouldExtendBeyondPage);
</pre>
<hr />
<pre>
 193 #endif
 194     settings.setAllowsInlineMediaPlayback(m_allowsInlineMediaPlayback);
 195     settings.setAllowsInlineMediaPlaybackAfterFullscreen(m_allowsInlineMediaPlaybackAfterFullscreen);
 196     settings.setInlineMediaPlaybackRequiresPlaysInlineAttribute(m_inlineMediaPlaybackRequiresPlaysInlineAttribute);
 197     settings.setQuickTimePluginReplacementEnabled(m_quickTimePluginReplacementEnabled);
 198     settings.setYouTubeFlashPluginReplacementEnabled(m_youTubeFlashPluginReplacementEnabled);
 199     settings.setDeferredCSSParserEnabled(m_deferredCSSParserEnabled);
 200     settings.setInputEventsEnabled(m_inputEventsEnabled);
 201     settings.setUserInterfaceDirectionPolicy(m_userInterfaceDirectionPolicy);
 202     settings.setSystemLayoutDirection(m_systemLayoutDirection);
 203     settings.setPdfImageCachingPolicy(m_pdfImageCachingPolicy);
 204     settings.setForcedColorsAreInvertedAccessibilityValue(m_forcedColorsAreInvertedAccessibilityValue);
 205     settings.setForcedDisplayIsMonochromeAccessibilityValue(m_forcedDisplayIsMonochromeAccessibilityValue);
 206     settings.setForcedPrefersReducedMotionAccessibilityValue(m_forcedPrefersReducedMotionAccessibilityValue);
 207     settings.setFontLoadTimingOverride(m_fontLoadTimingOverride);
 208     DeprecatedGlobalSettings::setAllowsAnySSLCertificate(false);
 209     RenderTheme::singleton().setShouldMockBoldSystemFontForAccessibility(m_shouldMockBoldSystemFontForAccessibility);
 210     FontCache::singleton().setShouldMockBoldSystemFontForAccessibility(m_shouldMockBoldSystemFontForAccessibility);
 211     settings.setFrameFlattening(m_frameFlattening);
 212     settings.setIncompleteImageBorderEnabled(m_incompleteImageBorderEnabled);
<span class="line-modified"> 213     settings.setShouldDispatchSyntheticMouseEventsWhenModifyingSelection(m_shouldDispatchSyntheticMouseEventsWhenModifyingSelection);</span>
<span class="line-modified"> 214     settings.setShouldDispatchSyntheticMouseOutAfterSyntheticClick(m_shouldDispatchSyntheticMouseOutAfterSyntheticClick);</span>
<span class="line-modified"> 215     PlatformMediaSessionManager::setShouldDeactivateAudioSession(m_shouldDeactivateAudioSession);</span>
<span class="line-added"> 216     settings.setAnimatedImageDebugCanvasDrawingEnabled(m_animatedImageDebugCanvasDrawingEnabled);</span>
 217 
 218 #if ENABLE(INDEXED_DATABASE_IN_WORKERS)
 219     RuntimeEnabledFeatures::sharedFeatures().setIndexedDBWorkersEnabled(m_indexedDBWorkersEnabled);
 220 #endif
 221 #if ENABLE(WEBGL2)
 222     RuntimeEnabledFeatures::sharedFeatures().setWebGL2Enabled(m_webGL2Enabled);



 223 #endif
 224     RuntimeEnabledFeatures::sharedFeatures().setWebVREnabled(m_webVREnabled);
 225 #if ENABLE(MEDIA_STREAM)
 226     RuntimeEnabledFeatures::sharedFeatures().setScreenCaptureEnabled(m_setScreenCaptureEnabled);
 227 #endif
 228     RuntimeEnabledFeatures::sharedFeatures().setCustomPasteboardDataEnabled(m_customPasteboardDataEnabled);
 229 
 230 #if USE(AUDIO_SESSION)
 231     DeprecatedGlobalSettings::setShouldManageAudioSessionCategory(m_shouldManageAudioSessionCategory);
 232 #endif


 233 }
 234 
 235 class InternalSettingsWrapper : public Supplement&lt;Page&gt; {
<span class="line-added"> 236     WTF_MAKE_FAST_ALLOCATED;</span>
 237 public:
 238     explicit InternalSettingsWrapper(Page* page)
 239         : m_internalSettings(InternalSettings::create(page)) { }
 240     virtual ~InternalSettingsWrapper() { m_internalSettings-&gt;hostDestroyed(); }
 241 #if !ASSERT_DISABLED
 242     bool isRefCountedWrapper() const override { return true; }
 243 #endif
 244     InternalSettings* internalSettings() const { return m_internalSettings.get(); }
 245 
 246 private:
 247     RefPtr&lt;InternalSettings&gt; m_internalSettings;
 248 };
 249 
 250 const char* InternalSettings::supplementName()
 251 {
 252     return &quot;InternalSettings&quot;;
 253 }
 254 
 255 InternalSettings* InternalSettings::from(Page* page)
 256 {
 257     if (!Supplement&lt;Page&gt;::from(page, supplementName()))
<span class="line-modified"> 258         Supplement&lt;Page&gt;::provideTo(page, supplementName(), makeUnique&lt;InternalSettingsWrapper&gt;(page));</span>
 259     return static_cast&lt;InternalSettingsWrapper*&gt;(Supplement&lt;Page&gt;::from(page, supplementName()))-&gt;internalSettings();
 260 }
 261 
 262 void InternalSettings::hostDestroyed()
 263 {
 264     m_page = nullptr;
 265 }
 266 
 267 InternalSettings::InternalSettings(Page* page)
 268     : InternalSettingsGenerated(page)
 269     , m_page(page)
 270     , m_backup(page-&gt;settings())
 271 {
 272 #if ENABLE(WIRELESS_PLAYBACK_TARGET)
 273     setAllowsAirPlayForMediaPlayback(false);
 274 #endif
 275 #if ENABLE(MEDIA_STREAM)
 276     setMediaCaptureRequiresSecureConnection(false);
 277 #endif
 278 }
 279 
 280 Ref&lt;InternalSettings&gt; InternalSettings::create(Page* page)
 281 {
 282     return adoptRef(*new InternalSettings(page));
 283 }
 284 
 285 void InternalSettings::resetToConsistentState()
 286 {
 287     m_page-&gt;setPageScaleFactor(1, { 0, 0 });
 288     m_page-&gt;mainFrame().setPageAndTextZoomFactors(1, 1);
 289     m_page-&gt;setCanStartMedia(true);
<span class="line-modified"> 290     setUseDarkAppearanceInternal(false);</span>
 291 
 292     settings().setForcePendingWebGLPolicy(false);
 293 #if ENABLE(WIRELESS_PLAYBACK_TARGET)
 294     settings().setAllowsAirPlayForMediaPlayback(false);
 295 #endif
 296 #if ENABLE(MEDIA_STREAM)
 297     setMediaCaptureRequiresSecureConnection(false);
 298 #endif
 299 
 300     m_backup.restoreTo(settings());
 301     m_backup = Backup { settings() };
 302 
 303     InternalSettingsGenerated::resetToConsistentState();
 304 }
 305 
 306 Settings&amp; InternalSettings::settings() const
 307 {
 308     ASSERT(m_page);
 309     return m_page-&gt;settings();
 310 }
</pre>
<hr />
<pre>
 413     settings().setTextAutosizingEnabled(enabled);
 414 #else
 415     UNUSED_PARAM(enabled);
 416 #endif
 417     return { };
 418 }
 419 
 420 ExceptionOr&lt;void&gt; InternalSettings::setTextAutosizingWindowSizeOverride(int width, int height)
 421 {
 422     if (!m_page)
 423         return Exception { InvalidAccessError };
 424 #if ENABLE(TEXT_AUTOSIZING)
 425     settings().setTextAutosizingWindowSizeOverride(IntSize(width, height));
 426 #else
 427     UNUSED_PARAM(width);
 428     UNUSED_PARAM(height);
 429 #endif
 430     return { };
 431 }
 432 
<span class="line-added"> 433 ExceptionOr&lt;void&gt; InternalSettings::setTextAutosizingUsesIdempotentMode(bool enabled)</span>
<span class="line-added"> 434 {</span>
<span class="line-added"> 435     if (!m_page)</span>
<span class="line-added"> 436         return Exception { InvalidAccessError };</span>
<span class="line-added"> 437 #if ENABLE(TEXT_AUTOSIZING)</span>
<span class="line-added"> 438     settings().setTextAutosizingUsesIdempotentMode(enabled);</span>
<span class="line-added"> 439 #else</span>
<span class="line-added"> 440     UNUSED_PARAM(enabled);</span>
<span class="line-added"> 441 #endif</span>
<span class="line-added"> 442     return { };</span>
<span class="line-added"> 443 }</span>
<span class="line-added"> 444 </span>
 445 ExceptionOr&lt;void&gt; InternalSettings::setMediaTypeOverride(const String&amp; mediaType)
 446 {
 447     if (!m_page)
 448         return Exception { InvalidAccessError };
 449     settings().setMediaTypeOverride(mediaType);
 450     return { };
 451 }
 452 
 453 ExceptionOr&lt;void&gt; InternalSettings::setCanStartMedia(bool enabled)
 454 {
 455     if (!m_page)
 456         return Exception { InvalidAccessError };
 457     m_page-&gt;setCanStartMedia(enabled);
 458     return { };
 459 }
 460 
 461 ExceptionOr&lt;void&gt; InternalSettings::setAllowsAirPlayForMediaPlayback(bool allows)
 462 {
 463     if (!m_page)
 464         return Exception { InvalidAccessError };
</pre>
<hr />
<pre>
 523 ExceptionOr&lt;bool&gt; InternalSettings::shouldDisplayTrackKind(const String&amp; kind)
 524 {
 525     if (!m_page)
 526         return Exception { InvalidAccessError };
 527 #if ENABLE(VIDEO_TRACK)
 528     auto&amp; captionPreferences = m_page-&gt;group().captionPreferences();
 529     if (equalLettersIgnoringASCIICase(kind, &quot;subtitles&quot;))
 530         return captionPreferences.userPrefersSubtitles();
 531     if (equalLettersIgnoringASCIICase(kind, &quot;captions&quot;))
 532         return captionPreferences.userPrefersCaptions();
 533     if (equalLettersIgnoringASCIICase(kind, &quot;textdescriptions&quot;))
 534         return captionPreferences.userPrefersTextDescriptions();
 535 
 536     return Exception { SyntaxError };
 537 #else
 538     UNUSED_PARAM(kind);
 539     return false;
 540 #endif
 541 }
 542 
<span class="line-added"> 543 void InternalSettings::setUseDarkAppearanceInternal(bool useDarkAppearance)</span>
<span class="line-added"> 544 {</span>
<span class="line-added"> 545 #if PLATFORM(GTK)</span>
<span class="line-added"> 546     // GTK doesn&#39;t allow to change the theme from the web process, but tests need to do it, so</span>
<span class="line-added"> 547     // we do it here only for tests.</span>
<span class="line-added"> 548     if (auto* settings = gtk_settings_get_default()) {</span>
<span class="line-added"> 549         gboolean preferDarkTheme;</span>
<span class="line-added"> 550         g_object_get(settings, &quot;gtk-application-prefer-dark-theme&quot;, &amp;preferDarkTheme, nullptr);</span>
<span class="line-added"> 551         if (preferDarkTheme != useDarkAppearance)</span>
<span class="line-added"> 552             g_object_set(settings, &quot;gtk-application-prefer-dark-theme&quot;, useDarkAppearance, nullptr);</span>
<span class="line-added"> 553     }</span>
<span class="line-added"> 554 #endif</span>
<span class="line-added"> 555     ASSERT(m_page);</span>
<span class="line-added"> 556     m_page-&gt;effectiveAppearanceDidChange(useDarkAppearance, m_page-&gt;useElevatedUserInterfaceLevel());</span>
<span class="line-added"> 557 }</span>
<span class="line-added"> 558 </span>
 559 ExceptionOr&lt;void&gt; InternalSettings::setUseDarkAppearance(bool useDarkAppearance)
 560 {
 561     if (!m_page)
 562         return Exception { InvalidAccessError };
<span class="line-modified"> 563     setUseDarkAppearanceInternal(useDarkAppearance);</span>
 564     return { };
 565 }
 566 
 567 ExceptionOr&lt;void&gt; InternalSettings::setStorageBlockingPolicy(const String&amp; mode)
 568 {
 569     if (!m_page)
 570         return Exception { InvalidAccessError };
 571     if (mode == &quot;AllowAll&quot;)
 572         settings().setStorageBlockingPolicy(SecurityOrigin::AllowAllStorage);
 573     else if (mode == &quot;BlockThirdParty&quot;)
 574         settings().setStorageBlockingPolicy(SecurityOrigin::BlockThirdPartyStorage);
 575     else if (mode == &quot;BlockAll&quot;)
 576         settings().setStorageBlockingPolicy(SecurityOrigin::BlockAllStorage);
 577     else
 578         return Exception { SyntaxError };
 579     return { };
 580 }
 581 
 582 ExceptionOr&lt;void&gt; InternalSettings::setPreferMIMETypeForImages(bool preferMIMETypeForImages)
 583 {
</pre>
<hr />
<pre>
 761     return { };
 762 }
 763 
 764 ExceptionOr&lt;void&gt; InternalSettings::setInlineMediaPlaybackRequiresPlaysInlineAttribute(bool requires)
 765 {
 766     if (!m_page)
 767         return Exception { InvalidAccessError };
 768     settings().setInlineMediaPlaybackRequiresPlaysInlineAttribute(requires);
 769     return { };
 770 }
 771 
 772 ExceptionOr&lt;void&gt; InternalSettings::setShouldMockBoldSystemFontForAccessibility(bool requires)
 773 {
 774     if (!m_page)
 775         return Exception { InvalidAccessError };
 776     RenderTheme::singleton().setShouldMockBoldSystemFontForAccessibility(requires);
 777     FontCache::singleton().setShouldMockBoldSystemFontForAccessibility(requires);
 778     return { };
 779 }
 780 
<span class="line-added"> 781 ExceptionOr&lt;void&gt; InternalSettings::setAnimatedImageDebugCanvasDrawingEnabled(bool ignore)</span>
<span class="line-added"> 782 {</span>
<span class="line-added"> 783     if (!m_page)</span>
<span class="line-added"> 784         return Exception { InvalidAccessError };</span>
<span class="line-added"> 785     settings().setAnimatedImageDebugCanvasDrawingEnabled(ignore);</span>
<span class="line-added"> 786     return { };</span>
<span class="line-added"> 787 }</span>
<span class="line-added"> 788 </span>
 789 void InternalSettings::setIndexedDBWorkersEnabled(bool enabled)
 790 {
 791 #if ENABLE(INDEXED_DATABASE_IN_WORKERS)
 792     RuntimeEnabledFeatures::sharedFeatures().setIndexedDBWorkersEnabled(enabled);
 793 #else
 794     UNUSED_PARAM(enabled);
 795 #endif
 796 }
 797 
 798 void InternalSettings::setWebGL2Enabled(bool enabled)
 799 {
 800 #if ENABLE(WEBGL2)
 801     RuntimeEnabledFeatures::sharedFeatures().setWebGL2Enabled(enabled);
 802 #else
 803     UNUSED_PARAM(enabled);
 804 #endif
 805 }
 806 
<span class="line-modified"> 807 void InternalSettings::setWebGPUEnabled(bool enabled)</span>
 808 {
<span class="line-modified"> 809 #if ENABLE(WEBGPU)</span>
<span class="line-modified"> 810     RuntimeEnabledFeatures::sharedFeatures().setWebGPUEnabled(enabled);</span>
 811 #else
 812     UNUSED_PARAM(enabled);
 813 #endif
 814 }
 815 
 816 void InternalSettings::setWebVREnabled(bool enabled)
 817 {
 818     RuntimeEnabledFeatures::sharedFeatures().setWebVREnabled(enabled);
 819 }
 820 
 821 void InternalSettings::setScreenCaptureEnabled(bool enabled)
 822 {
 823 #if ENABLE(MEDIA_STREAM)
 824     RuntimeEnabledFeatures::sharedFeatures().setScreenCaptureEnabled(enabled);
 825 #else
 826     UNUSED_PARAM(enabled);
 827 #endif
 828 }
 829 





 830 ExceptionOr&lt;String&gt; InternalSettings::userInterfaceDirectionPolicy()
 831 {
 832     if (!m_page)
 833         return Exception { InvalidAccessError };
 834     switch (settings().userInterfaceDirectionPolicy()) {
 835     case UserInterfaceDirectionPolicy::Content:
 836         return &quot;Content&quot;_str;
 837     case UserInterfaceDirectionPolicy::System:
 838         return &quot;View&quot;_str;
 839     }
 840     ASSERT_NOT_REACHED();
 841     return Exception { InvalidAccessError };
 842 }
 843 
 844 ExceptionOr&lt;void&gt; InternalSettings::setUserInterfaceDirectionPolicy(const String&amp; policy)
 845 {
 846     if (!m_page)
 847         return Exception { InvalidAccessError };
 848     if (equalLettersIgnoringASCIICase(policy, &quot;content&quot;)) {
 849         settings().setUserInterfaceDirectionPolicy(UserInterfaceDirectionPolicy::Content);
</pre>
<hr />
<pre>
 916     return { };
 917 }
 918 
 919 ExceptionOr&lt;void&gt; InternalSettings::setShouldManageAudioSessionCategory(bool should)
 920 {
 921 #if USE(AUDIO_SESSION)
 922     DeprecatedGlobalSettings::setShouldManageAudioSessionCategory(should);
 923     return { };
 924 #else
 925     UNUSED_PARAM(should);
 926     return Exception { InvalidAccessError };
 927 #endif
 928 }
 929 
 930 ExceptionOr&lt;void&gt; InternalSettings::setCustomPasteboardDataEnabled(bool enabled)
 931 {
 932     RuntimeEnabledFeatures::sharedFeatures().setCustomPasteboardDataEnabled(enabled);
 933     return { };
 934 }
 935 
<span class="line-modified"> 936 ExceptionOr&lt;void&gt; InternalSettings::setIncompleteImageBorderEnabled(bool enabled)</span>
 937 {
 938     if (!m_page)
 939         return Exception { InvalidAccessError };
<span class="line-modified"> 940     settings().setIncompleteImageBorderEnabled(enabled);</span>




 941     return { };
 942 }
 943 
<span class="line-modified"> 944 ExceptionOr&lt;void&gt; InternalSettings::setShouldDispatchSyntheticMouseEventsWhenModifyingSelection(bool shouldDispatch)</span>
 945 {
 946     if (!m_page)
 947         return Exception { InvalidAccessError };
<span class="line-modified"> 948     settings().setShouldDispatchSyntheticMouseEventsWhenModifyingSelection(shouldDispatch);</span>
<span class="line-added"> 949     return { };</span>
<span class="line-added"> 950 }</span>
<span class="line-added"> 951 </span>
<span class="line-added"> 952 ExceptionOr&lt;void&gt; InternalSettings::setShouldDispatchSyntheticMouseOutAfterSyntheticClick(bool shouldDispatch)</span>
<span class="line-added"> 953 {</span>
<span class="line-added"> 954     if (!m_page)</span>
<span class="line-added"> 955         return Exception { InvalidAccessError };</span>
<span class="line-added"> 956     settings().setShouldDispatchSyntheticMouseOutAfterSyntheticClick(shouldDispatch);</span>
 957     return { };
 958 }
 959 
 960 static InternalSettings::ForcedAccessibilityValue settingsToInternalSettingsValue(Settings::ForcedAccessibilityValue value)
 961 {
 962     switch (value) {
 963     case Settings::ForcedAccessibilityValue::System:
 964         return InternalSettings::ForcedAccessibilityValue::System;
 965     case Settings::ForcedAccessibilityValue::On:
 966         return InternalSettings::ForcedAccessibilityValue::On;
 967     case Settings::ForcedAccessibilityValue::Off:
 968         return InternalSettings::ForcedAccessibilityValue::Off;
 969     }
 970 
 971     ASSERT_NOT_REACHED();
 972     return InternalSettings::ForcedAccessibilityValue::Off;
 973 }
 974 
 975 static Settings::ForcedAccessibilityValue internalSettingsToSettingsValue(InternalSettings::ForcedAccessibilityValue value)
 976 {
</pre>
<hr />
<pre>
1005 void InternalSettings::setForcedDisplayIsMonochromeAccessibilityValue(InternalSettings::ForcedAccessibilityValue value)
1006 {
1007     settings().setForcedDisplayIsMonochromeAccessibilityValue(internalSettingsToSettingsValue(value));
1008 }
1009 
1010 InternalSettings::ForcedAccessibilityValue InternalSettings::forcedPrefersReducedMotionAccessibilityValue() const
1011 {
1012     return settingsToInternalSettingsValue(settings().forcedPrefersReducedMotionAccessibilityValue());
1013 }
1014 
1015 void InternalSettings::setForcedPrefersReducedMotionAccessibilityValue(InternalSettings::ForcedAccessibilityValue value)
1016 {
1017     settings().setForcedPrefersReducedMotionAccessibilityValue(internalSettingsToSettingsValue(value));
1018 }
1019 
1020 bool InternalSettings::webAnimationsCSSIntegrationEnabled()
1021 {
1022     return RuntimeEnabledFeatures::sharedFeatures().webAnimationsCSSIntegrationEnabled();
1023 }
1024 
<span class="line-added">1025 void InternalSettings::setShouldDeactivateAudioSession(bool should)</span>
<span class="line-added">1026 {</span>
<span class="line-added">1027     PlatformMediaSessionManager::setShouldDeactivateAudioSession(should);</span>
<span class="line-added">1028 }</span>
<span class="line-added">1029 </span>
1030 // If you add to this class, make sure that you update the Backup class for test reproducability!
1031 
1032 }
</pre>
</td>
</tr>
</table>
<center><a href="../svg/properties/SVGPropertyTraits.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="InternalSettings.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>