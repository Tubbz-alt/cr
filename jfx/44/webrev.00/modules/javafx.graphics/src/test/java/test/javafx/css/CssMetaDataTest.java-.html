<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old modules/javafx.graphics/src/test/java/test/javafx/css/CssMetaDataTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2010, 2018, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 package test.javafx.css;
  27 
  28 import java.io.File;
  29 import java.lang.reflect.InvocationTargetException;
  30 import java.lang.reflect.Method;
  31 import java.lang.reflect.Modifier;
  32 import java.net.URL;
  33 import java.util.ArrayList;
  34 import java.util.Arrays;
  35 import java.util.Collections;
  36 import java.util.List;
  37 import java.util.Set;
  38 
  39 import com.sun.javafx.css.CascadingStyle;
  40 import com.sun.javafx.css.ParsedValueImpl;
  41 import com.sun.javafx.css.PseudoClassState;
  42 import com.sun.javafx.css.StyleManager;
  43 import test.com.sun.javafx.css.TestNode;
  44 import test.com.sun.javafx.css.TestNodeBase;
  45 import com.sun.javafx.sg.prism.NGNode;
  46 import javafx.beans.value.WritableValue;
  47 import javafx.scene.Group;
  48 import javafx.scene.Node;
  49 import javafx.scene.Scene;
  50 import javafx.scene.layout.Pane;
  51 import javafx.scene.paint.Color;
  52 import javafx.scene.shape.Rectangle;
  53 import javafx.scene.text.Font;
  54 import javafx.scene.text.Text;
  55 import javafx.stage.Stage;
  56 import javafx.css.converter.BooleanConverter;
  57 import com.sun.javafx.geom.BaseBounds;
  58 import com.sun.javafx.geom.transform.BaseTransform;
  59 import com.sun.javafx.scene.NodeHelper;
  60 import javafx.css.CompoundSelector;
  61 import javafx.css.CssMetaData;
  62 import javafx.css.CssParser;
  63 import javafx.css.CssParserShim;
  64 import javafx.css.Declaration;
  65 import javafx.css.DeclarationShim;
  66 import javafx.css.FontCssMetaData;
  67 import javafx.css.ParsedValue;
  68 import javafx.css.PseudoClass;
  69 import javafx.css.Rule;
  70 import javafx.css.RuleShim;
  71 import javafx.css.Selector;
  72 import javafx.css.SelectorShim;
  73 import javafx.css.SimpleSelector;
  74 import javafx.css.SimpleSelectorShim;
  75 import javafx.css.Style;
  76 import javafx.css.StyleConverter;
  77 import javafx.css.StyleOrigin;
  78 import javafx.css.Styleable;
  79 import javafx.css.StyleableProperty;
  80 import javafx.css.Stylesheet;
  81 import javafx.css.StylesheetShim;
  82 import org.junit.Test;
  83 
  84 import static org.junit.Assert.*;
  85 
  86 enum TestEnum {
  87     LEFT,
  88     CENTER,
  89     RIGHT,
  90     JUSTIFY
  91 }
  92 
  93 public class CssMetaDataTest {
  94 
  95     public CssMetaDataTest() {
  96     }
  97 
  98     private static CssMetaData get(List&lt;CssMetaData&lt;? extends Styleable, ?&gt;&gt; list, String prop) {
  99         for (CssMetaData styleable : list) {
 100             if (prop.equals(styleable.getProperty())) return styleable;
 101         }
 102         return null;
 103     }
 104 
 105     /**
 106      * Test of getCssMetaData method of class Styleable.
 107      */
 108     @Test
 109     public void testGetCssMetaData_Styleable() {
 110         Styleable styleable = new TestNode();
 111         List&lt;CssMetaData&lt;? extends Styleable, ?&gt;&gt; expResult = TestNode.getClassCssMetaData();
 112         List result = styleable.getCssMetaData();
 113         assertEquals(expResult, result);
 114     }
 115 
 116     @Test
 117     public void testGetJavafxBeansProperty() {
 118         TestNode testNode = new TestNode();
 119         WritableValue prop = TestNodeBase.StyleableProperties.TEST.getStyleableProperty(testNode);
 120         assert(prop != null);
 121         CssMetaData result = ((StyleableProperty)prop).getCssMetaData();
 122         assert(result == TestNodeBase.StyleableProperties.TEST);
 123     }
 124 
 125     /**
 126      * Test of getProperty method, of class CssMetaData.
 127      */
 128     @Test
 129     public void testGetProperty() {
 130 
 131         String expResult = &quot;-fx-test&quot;;
 132         String result = TestNodeBase.StyleableProperties.TEST.getProperty();
 133         assertEquals(expResult, result);
 134     }
 135 
 136     /**
 137      * Test of getConverter method, of class CssMetaData.
 138      */
 139     @Test
 140     public void testGetConverter() {
 141 
 142         StyleConverter expResult = BooleanConverter.getInstance();
 143         StyleConverter result = TestNodeBase.StyleableProperties.TEST.getConverter();
 144         assertEquals(expResult, result);
 145     }
 146 
 147     /**
 148      * Test of getInitialValue method, of class CssMetaData.
 149      */
 150     @Test
 151     public void testGetInitialValue() {
 152 
 153         TestNode testNode = new TestNode();
 154         Double expResult = testNode.getXyzzy();
 155         Double result = (Double)TestNode.StyleableProperties.XYZZY.getInitialValue(testNode);
 156         assertEquals(expResult, result);
 157 
 158     }
 159 
 160     /**
 161      * Test of getSubProperties method, of class CssMetaData.
 162      */
 163     @Test
 164     public void testGetSubProperties() {
 165 
 166         CssMetaData&lt;TestNode,Font&gt; fontProp =
 167                 new FontCssMetaData&lt;TestNode&gt;(&quot;-fx-font&quot;, Font.getDefault()) {
 168 
 169                     @Override
 170                     public boolean isSettable(TestNode n) {
 171                         return true;
 172                     }
 173 
 174                     @Override
 175                     public StyleableProperty&lt;Font&gt; getStyleableProperty(TestNode n) {
 176                         return null;
 177                     }
 178                 };
 179 
 180         List&lt;CssMetaData&lt;? extends Styleable, ?&gt;&gt; list = fontProp.getSubProperties();
 181         assertNotNull(list);
 182 
 183     }
 184 
 185     /**
 186      * Test of isInherits method, of class CssMetaData.
 187      */
 188     @Test
 189     public void testIsInherits() {
 190 
 191         boolean expResult = false;
 192         boolean result = TestNode.StyleableProperties.XYZZY.isInherits();
 193         assertEquals(expResult, result);
 194 
 195     }
 196 
 197     /**
 198      * Test of toString method, of class CssMetaData.
 199      */
 200     @Test
 201     public void testToString() {
 202 
 203         CssMetaData&lt;TestNode,Font&gt; fontProp =
 204                 new FontCssMetaData&lt;TestNode&gt;(&quot;-fx-font&quot;, Font.getDefault()) {
 205 
 206                     @Override
 207                     public boolean isSettable(TestNode n) {
 208                         return true;
 209                     }
 210 
 211                     @Override
 212                     public StyleableProperty&lt;Font&gt; getStyleableProperty(TestNode n) {
 213                         return null;
 214                     }
 215                 };
 216 
 217         String string = fontProp.toString();
 218         assertNotNull(string);
 219 
 220     }
 221 
 222     /**
 223      * Test of equals method, of class CssMetaData.
 224      */
 225     @Test
 226     public void testEquals() {
 227         TestNode testNode = new TestNode();
 228         Node node = new Node() {
 229         };
 230 
 231         CssMetaData testNodeOpacity = get(TestNode.getClassCssMetaData(), &quot;-fx-opacity&quot;);
 232         CssMetaData nodeOpacity = get(Node.getClassCssMetaData(), &quot;-fx-opacity&quot;);
 233 
 234         assertTrue(testNodeOpacity.equals(nodeOpacity));
 235     }
 236 
 237     static int ord = 0;
 238     static CascadingStyle createCascadingStyle(Selector selector, Declaration declaration) {
 239 
 240         Set&lt;PseudoClass&gt; pseudoClasses = null;
 241         if (selector instanceof SimpleSelector) {
 242 
 243             pseudoClasses =
 244                     SimpleSelectorShim.getPseudoClassStates((SimpleSelector)selector);
 245         } else {
 246 
 247             pseudoClasses = new PseudoClassState();
 248             for (SimpleSelector sel : ((CompoundSelector)selector).getSelectors()) {
 249 
 250                 Set&lt;PseudoClass&gt; selectorPseudoClasses = SimpleSelectorShim.getPseudoClassStates(sel);
 251                 pseudoClasses.addAll(selectorPseudoClasses);
 252             }
 253         }
 254 
 255         return new CascadingStyle(
 256                 new Style(selector, declaration),
 257                 pseudoClasses,
 258                 0,
 259                 ord++
 260         );
 261     }
 262 
 263     @Test @org.junit.Ignore
 264     public void testGetMatchingStyles() {
 265 
 266 
 267         final Stylesheet stylesheet = StylesheetShim.getStylesheet();
 268         stylesheet.setOrigin(StyleOrigin.USER_AGENT);
 269         StyleManager.getInstance().getInstance().setDefaultUserAgentStylesheet(stylesheet);
 270 
 271         final List&lt;Rule&gt; rules = stylesheet.getRules();
 272 
 273         //
 274         // .root { -fx-base: red; -fx-color: -fx-base; }
 275         //
 276         List&lt;String&gt; rootStyleClass = new ArrayList&lt;String&gt;();
 277         rootStyleClass.add(&quot;root&quot;);
 278 
 279         Selector root = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rootStyleClass, null, null);
 280 
 281         ParsedValue fxBaseValue = new CssParserShim().parseExpr(&quot;-fx-base&quot;, &quot;red&quot;);
 282         Declaration fxBase = DeclarationShim.getDeclaration(&quot;-fx-base&quot;, fxBaseValue, false);
 283 
 284         ParsedValueImpl&lt;String,String&gt; fxColorValue = new ParsedValueImpl&lt;String,String&gt;(fxBase.getProperty(), null, true);
 285         Declaration fxColor = DeclarationShim.getDeclaration(&quot;-fx-color&quot;, fxColorValue, false);
 286 
 287         List&lt;Selector&gt; selectors = new ArrayList&lt;Selector&gt;();
 288         Collections.addAll(selectors, root);
 289 
 290         List&lt;Declaration&gt; declarations = new ArrayList&lt;Declaration&gt;();
 291         Collections.addAll(declarations, fxBase, fxColor);
 292 
 293         Rule baseRule = RuleShim.getRule(selectors, declarations);
 294         rules.add(baseRule);
 295 
 296         //
 297         // .rect { -fx-fill: -fx-color; }
 298         //
 299         List&lt;String&gt; rectStyleClass = new ArrayList&lt;String&gt;();
 300         rectStyleClass.add(&quot;rect&quot;);
 301 
 302         Selector rect = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rectStyleClass, null, null);
 303 
 304         ParsedValue fxFillValue = new CssParserShim().parseExpr(&quot;-fx-fill&quot;, &quot;-fx-color&quot;);
 305         Declaration fxFill = DeclarationShim.getDeclaration(&quot;-fx-fill&quot;, fxFillValue, false);
 306 
 307         selectors = new ArrayList&lt;Selector&gt;();
 308         Collections.addAll(selectors, rect);
 309 
 310         declarations = new ArrayList&lt;Declaration&gt;();
 311         Collections.addAll(declarations, fxFill);
 312 
 313         Rule rectRule = RuleShim.getRule(selectors, declarations);
 314         rules.add(rectRule);
 315 
 316         // .rect:hover { -fx-fill: yellow; }
 317         List&lt;String&gt; pseudoclasses = new ArrayList&lt;String&gt;();
 318         pseudoclasses.add(&quot;hover&quot;);
 319 
 320         Selector rectHover = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rectStyleClass, pseudoclasses, null);
 321 
 322         ParsedValueImpl&lt;Color,Color&gt; fxFillHoverValue = new ParsedValueImpl&lt;Color,Color&gt;(Color.YELLOW, null);
 323         Declaration fxFillHover = DeclarationShim.getDeclaration(&quot;-fx-fill&quot;, fxFillHoverValue, false);
 324 
 325         selectors = new ArrayList&lt;Selector&gt;();
 326         Collections.addAll(selectors, rectHover);
 327 
 328         declarations = new ArrayList&lt;Declaration&gt;();
 329         Collections.addAll(declarations, fxFillHover);
 330 
 331         Rule rectHoverRule = RuleShim.getRule(selectors, declarations);
 332         rules.add(rectHoverRule);
 333 
 334         List&lt;Style&gt; expecteds = new ArrayList&lt;Style&gt;();
 335         Collections.addAll(expecteds,
 336                            new Style(root, fxBase),
 337                            new Style(root, fxColor),
 338                            new Style(rect, fxFill),
 339                            new Style(rectHover, fxFillHover)
 340         );
 341 
 342         final Rectangle rectangle = new Rectangle();
 343         rectangle.getStyleClass().add(&quot;rect&quot;);
 344 
 345         final Group group = new Group();
 346         group.getChildren().add(rectangle);
 347 
 348         Scene scene = new Scene(group);
 349         Stage stage = new Stage();
 350         stage.setScene(scene);
 351         stage.show();
 352 
 353         final CssMetaData FILL = get(rectangle.getCssMetaData(), &quot;-fx-fill&quot;);
 354         final List&lt;Style&gt; actuals = NodeHelper.getMatchingStyles(FILL, rectangle);
 355 
 356         //        System.err.println(&quot;matchingStyles: &quot; + matchingStyles);
 357         //        System.err.println(&quot;expecteds: &quot; + expecteds);
 358         //        System.err.println(&quot;actuals: &quot; + actuals);
 359 
 360         assertEquals(expecteds.size(), actuals.size(), 0);
 361 
 362         for (Style style : expecteds) {
 363             if (!actuals.remove(style)) fail();
 364         }
 365         assertTrue(actuals.isEmpty());
 366     }
 367 
 368     @Test @org.junit.Ignore
 369     public void testGetMatchingStylesWithInlineStyleOnParent() {
 370 
 371 
 372         final Stylesheet stylesheet = StylesheetShim.getStylesheet();
 373         stylesheet.setOrigin(StyleOrigin.USER_AGENT);
 374         StyleManager.getInstance().getInstance().setDefaultUserAgentStylesheet(stylesheet);
 375 
 376         final List&lt;Rule&gt; rules = stylesheet.getRules();
 377 
 378         //
 379         // .root { -fx-base: red; -fx-color: -fx-base; }
 380         //
 381         List&lt;String&gt; rootStyleClass = new ArrayList&lt;String&gt;();
 382         rootStyleClass.add(&quot;root&quot;);
 383 
 384         Selector root = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rootStyleClass, null, null);
 385 
 386         ParsedValue fxBaseValue = new CssParserShim().parseExpr(&quot;-fx-base&quot;, &quot;red&quot;);
 387         Declaration fxBase = DeclarationShim.getDeclaration(&quot;-fx-base&quot;, fxBaseValue, false);
 388 
 389         ParsedValueImpl&lt;String,String&gt; fxColorValue = new ParsedValueImpl&lt;String,String&gt;(fxBase.getProperty(), null, true);
 390         Declaration fxColor = DeclarationShim.getDeclaration(&quot;-fx-color&quot;, fxColorValue, false);
 391 
 392         List&lt;Selector&gt; selectors = new ArrayList&lt;Selector&gt;();
 393         Collections.addAll(selectors, root);
 394 
 395         List&lt;Declaration&gt; declarations = new ArrayList&lt;Declaration&gt;();
 396         Collections.addAll(declarations, fxBase, fxColor);
 397 
 398         Rule baseRule = RuleShim.getRule(selectors, declarations);
 399         rules.add(baseRule);
 400 
 401         //
 402         // .rect { -fx-fill: -fx-color; }
 403         //
 404         List&lt;String&gt; rectStyleClass = new ArrayList&lt;String&gt;();
 405         rectStyleClass.add(&quot;rect&quot;);
 406 
 407         Selector rect = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rectStyleClass, null, null);
 408 
 409         ParsedValue fxFillValue = new CssParserShim().parseExpr(&quot;-fx-fill&quot;, &quot;-fx-color&quot;);
 410         Declaration fxFill = DeclarationShim.getDeclaration(&quot;-fx-fill&quot;, fxFillValue, false);
 411 
 412         selectors = new ArrayList&lt;Selector&gt;();
 413         Collections.addAll(selectors, rect);
 414 
 415         declarations = new ArrayList&lt;Declaration&gt;();
 416         Collections.addAll(declarations, fxFill);
 417 
 418         Rule rectRule = RuleShim.getRule(selectors, declarations);
 419         rules.add(rectRule);
 420 
 421         // .rect:hover { -fx-fill: yellow; }
 422         List&lt;String&gt; pseudoclasses = new ArrayList&lt;String&gt;();
 423         pseudoclasses.add(&quot;hover&quot;);
 424 
 425         Selector rectHover = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rectStyleClass, pseudoclasses, null);
 426 
 427         ParsedValueImpl&lt;Color,Color&gt; fxFillHoverValue = new ParsedValueImpl&lt;Color,Color&gt;(Color.YELLOW, null);
 428         Declaration fxFillHover = DeclarationShim.getDeclaration(&quot;-fx-fill&quot;, fxFillHoverValue, false);
 429 
 430         selectors = new ArrayList&lt;Selector&gt;();
 431         Collections.addAll(selectors, rectHover);
 432 
 433         declarations = new ArrayList&lt;Declaration&gt;();
 434         Collections.addAll(declarations, fxFillHover);
 435 
 436         Rule rectHoverRule = RuleShim.getRule(selectors, declarations);
 437         rules.add(rectHoverRule);
 438 
 439         // Declaration now checks origin, so we need to make this expected
 440         // value look like it came from an inline
 441         final Declaration decl = DeclarationShim.getDeclaration(&quot;-fx-base&quot;, new ParsedValueImpl&lt;Color,Color&gt;(Color.GREEN, null), false);
 442 
 443         Stylesheet ss = new StylesheetShim(null) {
 444             {
 445                 setOrigin(StyleOrigin.INLINE);
 446                 getRules().add(
 447                         RuleShim.getRule(Arrays.asList(SelectorShim.getUniversalSelector()), Arrays.asList(decl))
 448                 );
 449             }
 450         };
 451 
 452         List&lt;Style&gt; expecteds = new ArrayList&lt;Style&gt;();
 453         Collections.addAll(expecteds,
 454                            new Style(SelectorShim.getUniversalSelector(), decl),
 455                            new Style(root, fxBase),
 456                            new Style(root, fxColor),
 457                            new Style(rect, fxFill),
 458                            new Style(rectHover, fxFillHover)
 459         );
 460 
 461         final Rectangle rectangle = new Rectangle();
 462         rectangle.getStyleClass().add(&quot;rect&quot;);
 463 
 464         final Group group = new Group();
 465         group.setStyle(&quot;-fx-base: green;&quot;);
 466         group.getChildren().add(rectangle);
 467 
 468         Scene scene = new Scene(group);
 469         Stage stage = new Stage();
 470         stage.setScene(scene);
 471         stage.show();
 472 
 473         final CssMetaData FILL = get(rectangle.getCssMetaData(), &quot;-fx-fill&quot;);
 474         final List&lt;Style&gt; actuals = NodeHelper.getMatchingStyles(FILL, rectangle);
 475 
 476         //        System.err.println(&quot;matchingStyles: &quot; + matchingStyles);
 477         //        System.err.println(&quot;expecteds: &quot; + expecteds);
 478         //        System.err.println(&quot;actuals: &quot; + actuals);
 479 
 480         assertEquals(expecteds.size(), actuals.size(), 0);
 481 
 482         // inline style should be first
 483         assertEquals(expecteds.get(0), actuals.get(0));
 484 
 485         for (Style style : expecteds) {
 486             if (!actuals.remove(style)) fail();
 487         }
 488         assertTrue(actuals.isEmpty());
 489     }
 490 
 491     @Test @org.junit.Ignore
 492     public void testGetMatchingStylesWithInlineStyleOnLeaf() {
 493 
 494 
 495         final Stylesheet stylesheet = StylesheetShim.getStylesheet();
 496         stylesheet.setOrigin(StyleOrigin.USER_AGENT);
 497         StyleManager.getInstance().getInstance().setDefaultUserAgentStylesheet(stylesheet);
 498 
 499         final List&lt;Rule&gt; rules = stylesheet.getRules();
 500 
 501         //
 502         // .root { -fx-base: red; -fx-color: -fx-base; }
 503         //
 504         List&lt;String&gt; rootStyleClass = new ArrayList&lt;String&gt;();
 505         rootStyleClass.add(&quot;root&quot;);
 506 
 507         Selector root = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rootStyleClass, null, null);
 508 
 509         ParsedValue fxBaseValue = new CssParserShim().parseExpr(&quot;-fx-base&quot;, &quot;red&quot;);
 510         Declaration fxBase = DeclarationShim.getDeclaration(&quot;-fx-base&quot;, fxBaseValue, false);
 511 
 512         ParsedValueImpl&lt;String,String&gt; fxColorValue = new ParsedValueImpl&lt;String,String&gt;(fxBase.getProperty(), null, true);
 513         Declaration fxColor = DeclarationShim.getDeclaration(&quot;-fx-color&quot;, fxColorValue, false);
 514 
 515         List&lt;Selector&gt; selectors = new ArrayList&lt;Selector&gt;();
 516         Collections.addAll(selectors, root);
 517 
 518         List&lt;Declaration&gt; declarations = new ArrayList&lt;Declaration&gt;();
 519         Collections.addAll(declarations, fxBase, fxColor);
 520 
 521         Rule baseRule = RuleShim.getRule(selectors, declarations);
 522         rules.add(baseRule);
 523 
 524         //
 525         // .rect { -fx-fill: -fx-color; }
 526         //
 527         List&lt;String&gt; rectStyleClass = new ArrayList&lt;String&gt;();
 528         rectStyleClass.add(&quot;rect&quot;);
 529 
 530         Selector rect = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rectStyleClass, null, null);
 531 
 532         ParsedValue fxFillValue = new CssParserShim().parseExpr(&quot;-fx-fill&quot;, &quot;-fx-color&quot;);
 533         Declaration fxFill = DeclarationShim.getDeclaration(&quot;-fx-fill&quot;, fxFillValue, false);
 534 
 535         selectors = new ArrayList&lt;Selector&gt;();
 536         Collections.addAll(selectors, rect);
 537 
 538         declarations = new ArrayList&lt;Declaration&gt;();
 539         Collections.addAll(declarations, fxFill);
 540 
 541         Rule rectRule = RuleShim.getRule(selectors, declarations);
 542         rules.add(rectRule);
 543 
 544         // .rect:hover { -fx-fill: yellow; }
 545         List&lt;String&gt; pseudoclasses = new ArrayList&lt;String&gt;();
 546         pseudoclasses.add(&quot;hover&quot;);
 547 
 548         Selector rectHover = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rectStyleClass, pseudoclasses, null);
 549 
 550         ParsedValueImpl&lt;Color,Color&gt; fxFillHoverValue = new ParsedValueImpl&lt;Color,Color&gt;(Color.YELLOW, null);
 551         Declaration fxFillHover = DeclarationShim.getDeclaration(&quot;-fx-fill&quot;, fxFillHoverValue, false);
 552 
 553         selectors = new ArrayList&lt;Selector&gt;();
 554         Collections.addAll(selectors, rectHover);
 555 
 556         declarations = new ArrayList&lt;Declaration&gt;();
 557         Collections.addAll(declarations, fxFillHover);
 558 
 559         Rule rectHoverRule = RuleShim.getRule(selectors, declarations);
 560         rules.add(rectHoverRule);
 561 
 562         // Declaration now checks origin, so we need to make this expected
 563         // value look like it came from an inline
 564         final Declaration decl = DeclarationShim.getDeclaration(&quot;-fx-base&quot;, new ParsedValueImpl&lt;Color,Color&gt;(Color.GREEN, null), false);
 565 
 566         Stylesheet ss = new StylesheetShim(null) {
 567             {
 568                 setOrigin(StyleOrigin.INLINE);
 569                 getRules().add(
 570                         RuleShim.getRule(Arrays.asList(SelectorShim.getUniversalSelector()), Arrays.asList(decl))
 571                 );
 572             }
 573         };
 574 
 575         List&lt;Style&gt; expecteds = new ArrayList&lt;Style&gt;();
 576         Collections.addAll(expecteds,
 577                            new Style(SelectorShim.getUniversalSelector(), decl),
 578                            new Style(root, fxBase),
 579                            new Style(root, fxColor),
 580                            new Style(rect, fxFill),
 581                            new Style(rectHover, fxFillHover)
 582         );
 583 
 584         final Rectangle rectangle = new Rectangle();
 585         rectangle.getStyleClass().add(&quot;rect&quot;);
 586         rectangle.setStyle(&quot;-fx-base: green;&quot;);
 587 
 588         final Group group = new Group();
 589         group.getChildren().add(rectangle);
 590 
 591         Scene scene = new Scene(group);
 592         Stage stage = new Stage();
 593         stage.setScene(scene);
 594         stage.show();
 595 
 596         final CssMetaData FILL = get(rectangle.getCssMetaData(), &quot;-fx-fill&quot;);
 597         final List&lt;Style&gt; actuals = NodeHelper.getMatchingStyles(FILL, rectangle);
 598 
 599         //        System.err.println(&quot;matchingStyles: &quot; + matchingStyles);
 600         //        System.err.println(&quot;expecteds: &quot; + expecteds);
 601         //        System.err.println(&quot;actuals: &quot; + actuals);
 602 
 603         assertEquals(expecteds.size(), actuals.size(), 0);
 604 
 605         // inline style should be first
 606         assertEquals(expecteds.get(0), actuals.get(0));
 607 
 608         for (Style style : expecteds) {
 609             if (!actuals.remove(style)) fail();
 610         }
 611         assertTrue(actuals.isEmpty());
 612     }
 613 
 614     @Test @org.junit.Ignore
 615     public void testGetMatchingStylesWithInlineStyleOnRootAndLeaf() {
 616 
 617 
 618         final Stylesheet stylesheet = StylesheetShim.getStylesheet();
 619         stylesheet.setOrigin(StyleOrigin.USER_AGENT);
 620         StyleManager.getInstance().getInstance().setDefaultUserAgentStylesheet(stylesheet);
 621 
 622         final List&lt;Rule&gt; rules = stylesheet.getRules();
 623 
 624         //
 625         // .root { -fx-base: red; -fx-color: -fx-base; }
 626         //
 627         List&lt;String&gt; rootStyleClass = new ArrayList&lt;String&gt;();
 628         rootStyleClass.add(&quot;root&quot;);
 629 
 630         Selector root = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rootStyleClass, null, null);
 631 
 632         ParsedValue fxBaseValue = new CssParserShim().parseExpr(&quot;-fx-base&quot;, &quot;red&quot;);
 633         Declaration fxBase = DeclarationShim.getDeclaration(&quot;-fx-base&quot;, fxBaseValue, false);
 634 
 635         ParsedValueImpl&lt;String,String&gt; fxColorValue = new ParsedValueImpl&lt;String,String&gt;(fxBase.getProperty(), null, true);
 636         Declaration fxColor = DeclarationShim.getDeclaration(&quot;-fx-color&quot;, fxColorValue, false);
 637 
 638         List&lt;Selector&gt; selectors = new ArrayList&lt;Selector&gt;();
 639         Collections.addAll(selectors, root);
 640 
 641         List&lt;Declaration&gt; declarations = new ArrayList&lt;Declaration&gt;();
 642         Collections.addAll(declarations, fxBase, fxColor);
 643 
 644         Rule baseRule = RuleShim.getRule(selectors, declarations);
 645         rules.add(baseRule);
 646 
 647         //
 648         // .rect { -fx-fill: -fx-color; }
 649         //
 650         List&lt;String&gt; rectStyleClass = new ArrayList&lt;String&gt;();
 651         rectStyleClass.add(&quot;rect&quot;);
 652 
 653         Selector rect = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rectStyleClass, null, null);
 654 
 655         ParsedValue fxFillValue = new CssParserShim().parseExpr(&quot;-fx-fill&quot;, &quot;-fx-color&quot;);
 656         Declaration fxFill = DeclarationShim.getDeclaration(&quot;-fx-fill&quot;, fxFillValue, false);
 657 
 658         selectors = new ArrayList&lt;Selector&gt;();
 659         Collections.addAll(selectors, rect);
 660 
 661         declarations = new ArrayList&lt;Declaration&gt;();
 662         Collections.addAll(declarations, fxFill);
 663 
 664         Rule rectRule = RuleShim.getRule(selectors, declarations);
 665         rules.add(rectRule);
 666 
 667         // .rect:hover { -fx-fill: yellow; }
 668         List&lt;String&gt; pseudoclasses = new ArrayList&lt;String&gt;();
 669         pseudoclasses.add(&quot;hover&quot;);
 670 
 671         Selector rectHover = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rectStyleClass, pseudoclasses, null);
 672 
 673         ParsedValueImpl&lt;Color,Color&gt; fxFillHoverValue = new ParsedValueImpl&lt;Color,Color&gt;(Color.YELLOW, null);
 674         Declaration fxFillHover = DeclarationShim.getDeclaration(&quot;-fx-fill&quot;, fxFillHoverValue, false);
 675 
 676         selectors = new ArrayList&lt;Selector&gt;();
 677         Collections.addAll(selectors, rectHover);
 678 
 679         declarations = new ArrayList&lt;Declaration&gt;();
 680         Collections.addAll(declarations, fxFillHover);
 681 
 682         Rule rectHoverRule = RuleShim.getRule(selectors, declarations);
 683         rules.add(rectHoverRule);
 684 
 685         // Declaration now checks origin, so we need to make this expected
 686         // value look like it came from an inline
 687         final Declaration gdecl = DeclarationShim.getDeclaration(&quot;-fx-base&quot;, new ParsedValueImpl&lt;Color,Color&gt;(Color.GREEN, null), false);
 688         final Declaration ydecl = DeclarationShim.getDeclaration(&quot;-fx-color&quot;, new ParsedValueImpl&lt;Color,Color&gt;(Color.YELLOW, null), false);
 689 
 690         Stylesheet ss = new StylesheetShim(null) {
 691             {
 692                 setOrigin(StyleOrigin.INLINE);
 693                 Collections.addAll(getRules(),
 694                                    RuleShim.getRule(Arrays.asList(SelectorShim.getUniversalSelector()), Arrays.asList(gdecl)),
 695                                    RuleShim.getRule(Arrays.asList(SelectorShim.getUniversalSelector()), Arrays.asList(ydecl))
 696                 );
 697             }
 698         };
 699 
 700         List&lt;Style&gt; expecteds = new ArrayList&lt;Style&gt;();
 701         Collections.addAll(expecteds,
 702                            new Style(SelectorShim.getUniversalSelector(), ydecl),
 703                            new Style(SelectorShim.getUniversalSelector(), gdecl),
 704                            new Style(root, fxBase),
 705                            new Style(root, fxColor),
 706                            new Style(rect, fxFill),
 707                            new Style(rectHover, fxFillHover)
 708         );
 709 
 710         final Rectangle rectangle = new Rectangle();
 711         rectangle.getStyleClass().add(&quot;rect&quot;);
 712         rectangle.setStyle(&quot;-fx-base: green;&quot;);
 713 
 714         final Group group = new Group();
 715         group.setStyle(&quot;-fx-color: yellow;&quot;);
 716         group.getChildren().add(rectangle);
 717 
 718         Scene scene = new Scene(group);
 719         Stage stage = new Stage();
 720         stage.setScene(scene);
 721         stage.show();
 722 
 723         final CssMetaData FILL = get(rectangle.getCssMetaData(), &quot;-fx-fill&quot;);
 724         final List&lt;Style&gt; actuals = NodeHelper.getMatchingStyles(FILL, rectangle);
 725 
 726         //        System.err.println(&quot;matchingStyles: &quot; + matchingStyles);
 727         //        System.err.println(&quot;expecteds: &quot; + expecteds);
 728         //        System.err.println(&quot;actuals: &quot; + actuals);
 729 
 730         assertEquals(expecteds.size(), actuals.size(), 0);
 731 
 732         // inline style should be first
 733         assertEquals(expecteds.get(0), actuals.get(0));
 734 
 735         for (Style style : expecteds) {
 736             if (!actuals.remove(style)) fail(style.toString());
 737         }
 738         assertTrue(actuals.isEmpty());
 739     }
 740 
 741     @Test @org.junit.Ignore
 742     public void testGetMatchingStylesShouldNotReturnAncestorPropertyIfNotInherited() {
 743 
 744 
 745         final Stylesheet stylesheet = StylesheetShim.getStylesheet();
 746         stylesheet.setOrigin(StyleOrigin.USER_AGENT);
 747         StyleManager.getInstance().getInstance().setDefaultUserAgentStylesheet(stylesheet);
 748 
 749         final List&lt;Rule&gt; rules = stylesheet.getRules();
 750 
 751         //
 752         // .root { -fx-base: red; -fx-color: -fx-base; }
 753         //
 754         List&lt;String&gt; rootStyleClass = new ArrayList&lt;String&gt;();
 755         rootStyleClass.add(&quot;root&quot;);
 756 
 757         Selector root = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rootStyleClass, null, null);
 758 
 759         ParsedValue fxBaseValue = new CssParserShim().parseExpr(&quot;-fx-base&quot;, &quot;red&quot;);
 760         Declaration fxBase = DeclarationShim.getDeclaration(&quot;-fx-base&quot;, fxBaseValue, false);
 761 
 762         ParsedValueImpl&lt;String,String&gt; fxColorValue = new ParsedValueImpl&lt;String,String&gt;(fxBase.getProperty(), null, true);
 763         Declaration fxColor = DeclarationShim.getDeclaration(&quot;-fx-color&quot;, fxColorValue, false);
 764 
 765         ParsedValueImpl&lt;Color,Color&gt; fxFillShouldNotMatchValue = new ParsedValueImpl&lt;Color,Color&gt;(Color.RED, null);
 766         Declaration fxFillShouldNotMatch = DeclarationShim.getDeclaration(&quot;-fx-fill&quot;, fxFillShouldNotMatchValue, false);
 767 
 768         List&lt;Selector&gt; selectors = new ArrayList&lt;Selector&gt;();
 769         Collections.addAll(selectors, root);
 770 
 771         List&lt;Declaration&gt; declarations = new ArrayList&lt;Declaration&gt;();
 772         Collections.addAll(declarations, fxBase, fxColor, fxFillShouldNotMatch);
 773 
 774         Rule baseRule = RuleShim.getRule(selectors, declarations);
 775         rules.add(baseRule);
 776 
 777         //
 778         // .rect { -fx-fill: -fx-color; }
 779         //
 780         List&lt;String&gt; rectStyleClass = new ArrayList&lt;String&gt;();
 781         rectStyleClass.add(&quot;rect&quot;);
 782 
 783         Selector rect = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rectStyleClass, null, null);
 784 
 785         ParsedValue fxFillValue = new CssParserShim().parseExpr(&quot;-fx-fill&quot;, &quot;-fx-color&quot;);
 786         Declaration fxFill = DeclarationShim.getDeclaration(&quot;-fx-fill&quot;, fxFillValue, false);
 787 
 788         selectors = new ArrayList&lt;Selector&gt;();
 789         Collections.addAll(selectors, rect);
 790 
 791         declarations = new ArrayList&lt;Declaration&gt;();
 792         Collections.addAll(declarations, fxFill);
 793 
 794         Rule rectRule = RuleShim.getRule(selectors, declarations);
 795         rules.add(rectRule);
 796 
 797         // .rect:hover { -fx-fill: yellow; }
 798         List&lt;String&gt; pseudoclasses = new ArrayList&lt;String&gt;();
 799         pseudoclasses.add(&quot;hover&quot;);
 800 
 801         Selector rectHover = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rectStyleClass, pseudoclasses, null);
 802 
 803         ParsedValueImpl&lt;Color,Color&gt; fxFillHoverValue = new ParsedValueImpl&lt;Color,Color&gt;(Color.YELLOW, null);
 804         Declaration fxFillHover = DeclarationShim.getDeclaration(&quot;-fx-fill&quot;, fxFillHoverValue, false);
 805 
 806         selectors = new ArrayList&lt;Selector&gt;();
 807         Collections.addAll(selectors, rectHover);
 808 
 809         declarations = new ArrayList&lt;Declaration&gt;();
 810         Collections.addAll(declarations, fxFillHover);
 811 
 812         Rule rectHoverRule = RuleShim.getRule(selectors, declarations);
 813         rules.add(rectHoverRule);
 814 
 815         List&lt;Style&gt; expecteds = new ArrayList&lt;Style&gt;();
 816         Collections.addAll(expecteds,
 817                            new Style(root, fxBase),
 818                            new Style(root, fxColor),
 819                            new Style(rect, fxFill),
 820                            new Style(rectHover, fxFillHover)
 821         );
 822 
 823         final Rectangle rectangle = new Rectangle();
 824         rectangle.getStyleClass().add(&quot;rect&quot;);
 825 
 826         final Group group = new Group();
 827         group.getChildren().add(rectangle);
 828 
 829         Scene scene = new Scene(group);
 830         Stage stage = new Stage();
 831         stage.setScene(scene);
 832         stage.show();
 833 
 834         final CssMetaData FILL = get(rectangle.getCssMetaData(), &quot;-fx-fill&quot;);
 835         final List&lt;Style&gt; actuals = NodeHelper.getMatchingStyles(FILL, rectangle);
 836 
 837         //        System.err.println(&quot;matchingStyles: &quot; + matchingStyles);
 838         //        System.err.println(&quot;expecteds: &quot; + expecteds);
 839         //        System.err.println(&quot;actuals: &quot; + actuals);
 840 
 841         assertEquals(expecteds.size(), actuals.size(), 0);
 842 
 843         for (Style style : expecteds) {
 844             if (!actuals.remove(style)) fail();
 845         }
 846         assertTrue(actuals.isEmpty());
 847     }
 848 
 849 
 850     @Test @org.junit.Ignore
 851     public void testGetMatchingStylesShouldNotReturnInlineAncestorPropertyIfNotInherited() {
 852 
 853         final Stylesheet stylesheet = StylesheetShim.getStylesheet();
 854         stylesheet.setOrigin(StyleOrigin.USER_AGENT);
 855         StyleManager.getInstance().setDefaultUserAgentStylesheet(stylesheet);
 856 
 857         final List&lt;Rule&gt; rules = stylesheet.getRules();
 858 
 859         List&lt;String&gt; rootStyleClass = new ArrayList&lt;String&gt;();
 860         rootStyleClass.add(&quot;root&quot;);
 861 
 862         List&lt;String&gt; rectStyleClass = new ArrayList&lt;String&gt;();
 863         rectStyleClass.add(&quot;rect&quot;);
 864 
 865         //
 866         // .root { -fx-base: red; -fx-color: -fx-base; }
 867         //
 868         Selector root = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rootStyleClass, null, null);
 869 
 870         ParsedValue fxBaseValue = new CssParserShim().parseExpr(&quot;-fx-base&quot;, &quot;red&quot;);
 871         Declaration fxBase = DeclarationShim.getDeclaration(&quot;-fx-base&quot;, fxBaseValue, false);
 872 
 873         ParsedValueImpl&lt;String,String&gt; fxColorValue = new ParsedValueImpl&lt;String,String&gt;(fxBase.getProperty(), null, true);
 874         Declaration fxColor = DeclarationShim.getDeclaration(&quot;-fx-color&quot;, fxColorValue, false);
 875 
 876         ParsedValueImpl&lt;Color,Color&gt; fxFillShouldNotMatchValue = new ParsedValueImpl&lt;Color,Color&gt;(Color.RED, null);
 877         Declaration fxFillShouldNotMatch = DeclarationShim.getDeclaration(&quot;-fx-fill&quot;, fxFillShouldNotMatchValue, false);
 878 
 879         List&lt;Selector&gt; selectors = new ArrayList&lt;Selector&gt;();
 880         Collections.addAll(selectors, root);
 881 
 882         List&lt;Declaration&gt; declarations = new ArrayList&lt;Declaration&gt;();
 883         Collections.addAll(declarations, fxBase, fxColor, fxFillShouldNotMatch);
 884 
 885         Rule baseRule = RuleShim.getRule(selectors, declarations);
 886         rules.add(baseRule);
 887 
 888         //
 889         // .rect { -fx-fill: -fx-color; }
 890         //
 891         Selector rect = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rectStyleClass, null, null);
 892 
 893         ParsedValue fxFillValue = new CssParserShim().parseExpr(&quot;-fx-fill&quot;, &quot;-fx-color&quot;);
 894         Declaration fxFill = DeclarationShim.getDeclaration(&quot;-fx-fill&quot;, fxFillValue, false);
 895 
 896         selectors = new ArrayList&lt;Selector&gt;();
 897         Collections.addAll(selectors, rect);
 898 
 899         declarations = new ArrayList&lt;Declaration&gt;();
 900         Collections.addAll(declarations, fxFill);
 901 
 902         Rule rectRule = RuleShim.getRule(selectors, declarations);
 903         rules.add(rectRule);
 904 
 905         // .rect:hover { -fx-fill: yellow; }
 906         List&lt;String&gt; pseudoclasses = new ArrayList&lt;String&gt;();
 907         pseudoclasses.add(&quot;hover&quot;);
 908 
 909         Selector rectHover = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rectStyleClass, pseudoclasses, null);
 910 
 911         ParsedValueImpl&lt;Color,Color&gt; fxFillHoverValue = new ParsedValueImpl&lt;Color,Color&gt;(Color.YELLOW, null);
 912         Declaration fxFillHover = DeclarationShim.getDeclaration(&quot;-fx-fill&quot;, fxFillHoverValue, false);
 913 
 914         selectors = new ArrayList&lt;Selector&gt;();
 915         Collections.addAll(selectors, rectHover);
 916 
 917         declarations = new ArrayList&lt;Declaration&gt;();
 918         Collections.addAll(declarations, fxFillHover);
 919 
 920         Rule rectHoverRule = RuleShim.getRule(selectors, declarations);
 921         rules.add(rectHoverRule);
 922 
 923         List&lt;Style&gt; expecteds = new ArrayList&lt;Style&gt;();
 924         Collections.addAll(expecteds,
 925                            new Style(root, fxBase),
 926                            new Style(root, fxColor),
 927                            new Style(rect, fxFill),
 928                            new Style(rectHover, fxFillHover)
 929         );
 930 
 931         final Rectangle rectangle = new Rectangle();
 932         rectangle.getStyleClass().add(&quot;rect&quot;);
 933 
 934         final Group group = new Group();
 935         group.getChildren().add(rectangle);
 936 
 937         Scene scene = new Scene(group);
 938         Stage stage = new Stage();
 939         stage.setScene(scene);
 940         stage.show();
 941 
 942         final CssMetaData FILL = get(rectangle.getCssMetaData(), &quot;-fx-fill&quot;);
 943         final List&lt;Style&gt; actuals = NodeHelper.getMatchingStyles(FILL, rectangle);
 944 
 945         //        System.err.println(&quot;matchingStyles: &quot; + matchingStyles);
 946         //        System.err.println(&quot;expecteds: &quot; + expecteds);
 947         //        System.err.println(&quot;actuals: &quot; + actuals);
 948 
 949         for (Style style : expecteds) {
 950             actuals.remove(style);
 951         }
 952         assertTrue(actuals.toString(), actuals.isEmpty());
 953     }
 954 
 955     @Test @org.junit.Ignore
 956     public void testGetMatchingStylesReturnsInheritedProperty() {
 957 
 958 
 959         final Stylesheet stylesheet = StylesheetShim.getStylesheet();
 960         stylesheet.setOrigin(StyleOrigin.USER_AGENT);
 961         StyleManager.getInstance().setDefaultUserAgentStylesheet(stylesheet);
 962 
 963         final List&lt;Rule&gt; rules = stylesheet.getRules();
 964 
 965         //
 966         // .root { -fx-base: red; -fx-color: -fx-base; }
 967         //
 968         List&lt;String&gt; rootStyleClass = new ArrayList&lt;String&gt;();
 969         rootStyleClass.add(&quot;root&quot;);
 970 
 971         Selector root = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rootStyleClass, null, null);
 972 
 973         ParsedValue&lt;Color,Color&gt; fxFontShouldInheritValue = new CssParserShim().parseExpr(&quot;-fx-font&quot;, &quot;12px system&quot;);
 974         Declaration fxFontShouldInherit = DeclarationShim.getDeclaration(&quot;-fx-font&quot;, fxFontShouldInheritValue, false);
 975 
 976         List&lt;Selector&gt; selectors = new ArrayList&lt;Selector&gt;();
 977         Collections.addAll(selectors, root);
 978 
 979         List&lt;Declaration&gt; declarations = new ArrayList&lt;Declaration&gt;();
 980         Collections.addAll(declarations, fxFontShouldInherit);
 981 
 982         Rule baseRule = RuleShim.getRule(selectors, declarations);
 983         rules.add(baseRule);
 984 
 985         //
 986         // .text { -fx-fill: -fx-color; }
 987         //
 988         List&lt;String&gt; textStyleClass = new ArrayList&lt;String&gt;();
 989         textStyleClass.add(&quot;text&quot;);
 990 
 991         Selector textSelector = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, textStyleClass, null, null);
 992 
 993         ParsedValue fxFillValue = new CssParserShim().parseExpr(&quot;-fx-fill&quot;, &quot;red&quot;);
 994         Declaration fxFill = DeclarationShim.getDeclaration(&quot;-fx-fill&quot;, fxFillValue, false);
 995 
 996         selectors = new ArrayList&lt;Selector&gt;();
 997         Collections.addAll(selectors, textSelector);
 998 
 999         declarations = new ArrayList&lt;Declaration&gt;();
1000         Collections.addAll(declarations, fxFill);
1001 
1002         Rule rectRule = RuleShim.getRule(selectors, declarations);
1003         rules.add(rectRule);
1004 
1005         List&lt;Style&gt; expecteds = new ArrayList&lt;Style&gt;();
1006         Collections.addAll(expecteds,
1007                            new Style(root, fxFontShouldInherit)
1008         );
1009 
1010         final Text text = new Text(&quot;text&quot;);
1011         text.getStyleClass().add(&quot;text&quot;);
1012 
1013         final Group group = new Group();
1014         group.getChildren().add(text);
1015 
1016         Scene scene = new Scene(group);
1017         Stage stage = new Stage();
1018         stage.setScene(scene);
1019         stage.show();
1020 
1021         final CssMetaData FONT = get(text.getCssMetaData(), &quot;-fx-font&quot;);
1022         final List&lt;Style&gt; actuals = NodeHelper.getMatchingStyles(FONT, text);
1023 
1024         //        System.err.println(&quot;matchingStyles: &quot; + matchingStyles);
1025         //        System.err.println(&quot;expecteds: &quot; + expecteds);
1026         //        System.err.println(&quot;actuals: &quot; + actuals);
1027 
1028         assertEquals(expecteds.size(), actuals.size(), 0);
1029 
1030         for (Style style : expecteds) {
1031             if (!actuals.remove(style)) fail();
1032         }
1033         assertTrue(actuals.isEmpty());
1034     }
1035 
1036     @Test @org.junit.Ignore
1037     public void testGetMatchingStylesReturnsSubProperty() {
1038 
1039         final Stylesheet stylesheet = StylesheetShim.getStylesheet();
1040         stylesheet.setOrigin(StyleOrigin.USER_AGENT);
1041         StyleManager.getInstance().setDefaultUserAgentStylesheet(stylesheet);
1042 
1043         final List&lt;Rule&gt; rules = stylesheet.getRules();
1044 
1045         //
1046         // .root { -fx-base: red; -fx-color: -fx-base; }
1047         //
1048         List&lt;String&gt; rootStyleClass = new ArrayList&lt;String&gt;();
1049         rootStyleClass.add(&quot;root&quot;);
1050 
1051         Selector root = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rootStyleClass, null, null);
1052 
1053         ParsedValue&lt;Color,Color&gt; fxFontShouldInheritValue = new CssParserShim().parseExpr(&quot;-fx-font&quot;, &quot;12px system&quot;);
1054         Declaration fxFontShouldInherit = DeclarationShim.getDeclaration(&quot;-fx-font&quot;, fxFontShouldInheritValue, false);
1055 
1056         List&lt;Selector&gt; selectors = new ArrayList&lt;Selector&gt;();
1057         Collections.addAll(selectors, root);
1058 
1059         List&lt;Declaration&gt; declarations = new ArrayList&lt;Declaration&gt;();
1060         Collections.addAll(declarations, fxFontShouldInherit);
1061 
1062         Rule baseRule = RuleShim.getRule(selectors, declarations);
1063         rules.add(baseRule);
1064 
1065         //
1066         // .text { -fx-fill: -fx-color; }
1067         //
1068         List&lt;String&gt; rectStyleClass = new ArrayList&lt;String&gt;();
1069         rectStyleClass.add(&quot;text&quot;);
1070 
1071         Selector textSelector = SimpleSelectorShim.getSimpleSelector(&quot;*&quot;, rectStyleClass, null, null);
1072 
1073         ParsedValue fxFillValue = new CssParserShim().parseExpr(&quot;-fx-fill&quot;, &quot;red&quot;);
1074         Declaration fxFill = DeclarationShim.getDeclaration(&quot;-fx-fill&quot;, fxFillValue, false);
1075 
1076         ParsedValue fxFontFamilyValue = new CssParserShim().parseExpr(&quot;-fx-font-family&quot;, &quot;arial&quot;);
1077         Declaration fxFontFamily = DeclarationShim.getDeclaration(&quot;-fx-font-family&quot;, fxFontFamilyValue, false);
1078 
1079         selectors = new ArrayList&lt;Selector&gt;();
1080         Collections.addAll(selectors, textSelector);
1081 
1082         declarations = new ArrayList&lt;Declaration&gt;();
1083         Collections.addAll(declarations, fxFill, fxFontFamily);
1084 
1085         Rule rectRule = RuleShim.getRule(selectors, declarations);
1086         rules.add(rectRule);
1087 
1088         List&lt;Style&gt; expecteds = new ArrayList&lt;Style&gt;();
1089         Collections.addAll(expecteds,
1090                            new Style(textSelector, fxFontFamily),
1091                            new Style(root, fxFontShouldInherit)
1092         );
1093 
1094         final Text text  = new Text();
1095         text.getStyleClass().add(&quot;text&quot;);
1096 
1097         final Group group = new Group();
1098         group.getChildren().add(text);
1099 
1100         Scene scene = new Scene(group);
1101         Stage stage = new Stage();
1102         stage.setScene(scene);
1103         stage.show();
1104 
1105         final CssMetaData FONT = get(text.getCssMetaData(), &quot;-fx-font&quot;);
1106         final List&lt;Style&gt; actuals = NodeHelper.getMatchingStyles(FONT, text);
1107 
1108         //        System.err.println(&quot;matchingStyles: &quot; + matchingStyles);
1109         //        System.err.println(&quot;expecteds: &quot; + expecteds);
1110         //        System.err.println(&quot;actuals: &quot; + actuals);
1111 
1112         assertEquals(expecteds.size(), actuals.size(), 0);
1113 
1114         for (Style style : expecteds) {
1115             if (!actuals.remove(style)) fail();
1116         }
1117         assertTrue(actuals.isEmpty());
1118     }
1119 
1120     @Test
1121     public void testRT18097() {
1122         try {
1123             File f = System.getProperties().containsKey(&quot;CSS_META_DATA_TEST_DIR&quot;) ?
1124                     new File(System.getProperties().get(&quot;CSS_META_DATA_TEST_DIR&quot;).toString()) :
1125                     null;
1126             if (f == null) {
1127                 ClassLoader cl = Thread.currentThread().getContextClassLoader();
1128                 URL base = cl.getResource(&quot;javafx/../javafx&quot;);
1129                 f = new File(base.toURI());
1130             }
1131             //System.err.println(f.getPath());
1132             assertTrue(&quot;&quot; + f.getCanonicalPath() + &quot; is not a directory&quot;, f.isDirectory());
1133             recursiveCheck(f, f.getPath().length() - 7);
1134         } catch (Exception ex) {
1135             ex.printStackTrace(System.err);
1136             fail(ex.getMessage());
1137         }
1138     }
1139 
1140     private static void checkClass(Class someClass) {
1141 
1142         if (javafx.scene.Node.class.isAssignableFrom(someClass) &amp;&amp;
1143                 Modifier.isAbstract(someClass.getModifiers()) == false) {
1144 
1145             String what = someClass.getName();
1146             try {
1147                 // should get NoSuchMethodException if ctor is not public
1148                 //                Constructor ctor = someClass.getConstructor((Class[])null);
1149                 Method m = someClass.getMethod(&quot;getClassCssMetaData&quot;, (Class[]) null);
1150                 //                Node node = (Node)ctor.newInstance((Object[])null);
1151                 Node node = (Node)someClass.newInstance();
1152                 List&lt;CssMetaData&lt;? extends Styleable, ?&gt;&gt; list = (List&lt;CssMetaData&lt;? extends Styleable, ?&gt;&gt;)m.invoke(null);
1153                 if(list == null || list.isEmpty()) return;
1154 
1155                 for (CssMetaData styleable : list) {
1156 
1157                     what = someClass.getName() + &quot; &quot; + styleable.getProperty();
1158                     WritableValue writable = styleable.getStyleableProperty(node);
1159                     assertNotNull(what, writable);
1160 
1161                     Object defaultValue = writable.getValue();
1162                     Object initialValue = styleable.getInitialValue((Node) someClass.newInstance());
1163 
1164                     if (defaultValue instanceof Number) {
1165                         // 5 and 5.0 are not the same according to equals,
1166                         // but they should be...
1167                         assert(initialValue instanceof Number);
1168                         double d1 = ((Number)defaultValue).doubleValue();
1169                         double d2 = ((Number)initialValue).doubleValue();
1170                         assertEquals(what, d1, d2, .001);
1171 
1172                     } else if (defaultValue != null &amp;&amp; defaultValue.getClass().isArray()) {
1173                         assertTrue(what, Arrays.equals((Object[])defaultValue, (Object[])initialValue));
1174                     } else {
1175                         assertEquals(what, defaultValue, initialValue);
1176                     }
1177 
1178                 }
1179 
1180             } catch (NoSuchMethodException ex) {
1181                 System.err.println(&quot;NoSuchMethodException: &quot; + what);
1182             } catch (IllegalAccessException ex) {
1183                 System.err.println(&quot;IllegalAccessException: &quot; + what);
1184             } catch (IllegalArgumentException ex) {
1185                 System.err.println(&quot;IllegalArgumentException: &quot; + what);
1186             } catch (InvocationTargetException ex) {
1187                 System.err.println(&quot;InvocationTargetException: &quot; + what);
1188             } catch (InstantiationException ex) {
1189                 System.err.println(&quot;InstantiationException: &quot; + what);
1190             }
1191         }
1192     }
1193 
1194     private static void checkDirectory(File directory, final int pathLength) {
1195         if (directory.isDirectory()) {
1196 
1197             for (File file : directory.listFiles()) {
1198                 if (file.isFile() &amp;&amp; file.getName().endsWith(&quot;.class&quot;)) {
1199                     final int len = file.getPath().length() - &quot;.class&quot;.length();
1200                     final String clName =
1201                             file.getPath().substring(pathLength+1, len).replace(File.separatorChar,&#39;.&#39;);
1202                     try {
1203                         final Class cl = Class.forName(clName);
1204                         if (cl != null) checkClass(cl);
1205                     } catch(ClassNotFoundException ex) {
1206                         System.err.println(ex.toString() + &quot; &quot; + clName);
1207                     }
1208                 }
1209             }
1210         }
1211     }
1212 
1213     private static void recursiveCheck(File directory, int pathLength) {
1214         if (directory.isDirectory()) {
1215             //            System.err.println(directory.getPath());
1216             checkDirectory(directory, pathLength);
1217 
1218             for (File subFile : directory.listFiles()) {
1219                 recursiveCheck(subFile, pathLength);
1220             }
1221         }
1222     }
1223 
1224     @Test @org.junit.Ignore(&quot;tested CssMetaData#set method, which is deprecated&quot;)
1225     public void testRT_21185() {
1226 
1227         Color c1 = new Color(.1,.2,.3,1.0);
1228         Color c2 = new Color(.1,.2,.3,1.0);
1229 
1230         Rectangle rect = new Rectangle();
1231         rect.setFill(c1);
1232 
1233         StyleableProperty fill = (StyleableProperty)rect.fillProperty();
1234         StyleOrigin origin = ((StyleableProperty)rect.fillProperty()).getStyleOrigin();
1235 
1236         // set should not change the value if the values are equal and origin is same
1237         assertEquals(c1, c2);
1238         fill.applyStyle(origin, c2);
1239 
1240         assertSame(c1,rect.getFill()); // instance should not change.
1241 
1242         // set should change the value if the values are not equal.
1243         c2 = new Color(.3,.2,.1,1.0);
1244         fill.applyStyle(origin, c2);
1245         assertSame(c2,rect.getFill());
1246 
1247         // set should change the value if the origin is not the same
1248         fill.applyStyle(StyleOrigin.INLINE, c2);
1249         origin = ((StyleableProperty)rect.fillProperty()).getStyleOrigin();
1250         assertSame(StyleOrigin.INLINE, origin);
1251 
1252         // set should change the value if one is null and the other is not.
1253         rect.setFill(null);
1254         fill.applyStyle(origin, c2);
1255         assertSame(c2, rect.getFill());
1256 
1257         // set should change the value if one is null and the other is not
1258         fill.applyStyle(origin, null);
1259         assertNull(rect.getFill());
1260 
1261     }
1262 
1263 
1264     @Test  @org.junit.Ignore
1265     public void testRT_24606() {
1266 
1267         final Stylesheet stylesheet = new CssParser().parse(
1268                 &quot;.root { -fx-base: red; }&quot; +
1269                         &quot;.group { -fx-color: -fx-base; }&quot; +
1270                         &quot;.text { -fx-fill: -fx-color; }&quot;
1271         );
1272         stylesheet.setOrigin(StyleOrigin.USER_AGENT);
1273         StyleManager.getInstance().setDefaultUserAgentStylesheet(stylesheet);
1274 
1275         final Text text = new Text(&quot;HelloWorld&quot;);
1276         text.getStyleClass().add(&quot;text&quot;);
1277         text.setFill(Color.BLUE);
1278 
1279         final Group group = new Group();
1280         group.getStyleClass().add(&quot;group&quot;);
1281         group.getChildren().add(text);
1282 
1283         final Group root = new Group();
1284         root.getChildren().add(group);
1285 
1286         Scene scene = new Scene(root);
1287         Stage stage = new Stage();
1288         stage.setScene(scene);
1289         stage.show();
1290 
1291         CssMetaData prop = ((StyleableProperty)text.fillProperty()).getCssMetaData();
1292         List list = NodeHelper.getMatchingStyles(prop, text);
1293 
1294         assertEquals(3, list.size(), 0);
1295 
1296     }
1297 
1298     @Test
1299     public void testStyleConverterReturnType() {
1300         final CssMetaData&lt;Pane, TestEnum&gt; TEST_ENUM =
1301                 new CssMetaData&lt;Pane, TestEnum&gt;(&quot;-test-enum&quot;, StyleConverter.getEnumConverter(TestEnum.class), TestEnum.LEFT, false) {
1302                     @Override
1303                     public boolean isSettable(Pane styleable) {
1304                         return false;
1305                     }
1306 
1307                     @Override
1308                     public StyleableProperty&lt;TestEnum&gt; getStyleableProperty(Pane styleable) {
1309                         return null;
1310                     }
1311                 };
1312     }
1313 
1314 }
    </pre>
  </body>
</html>