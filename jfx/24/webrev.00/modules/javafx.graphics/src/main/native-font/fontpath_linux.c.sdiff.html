<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.graphics/src/main/native-font/fontpath_linux.c</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="../java/com/sun/prism/impl/GlyphCache.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>modules/javafx.graphics/src/main/native-font/fontpath_linux.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
385             if (family != NULL) {
386                 free(family);
387             }
388             if (styleStr != NULL) {
389                 free(styleStr);
390             }
391             if (fullname != NULL) {
392                 free(fullname);
393             }
394             if (file != NULL) {
395                 free(file);
396             }
397             (*FcPatternDestroy)(pattern);
398             (*FcFontSetDestroy)(fontset);
399             (*env)-&gt;ReleaseStringUTFChars(env, fcNameStr, (const char*)fcName);
400             closeFontConfig(libfontconfig, JNI_FALSE);
401             return JNI_FALSE;
402         }
403         fontCount = 0;
404         minGlyphs = 20;

405         for (j=0; j&lt;nfonts; j++) {
406             FcPattern *fontPattern = fontset-&gt;fonts[j];
407             FcChar8 *fontformat;
<span class="line-modified">408             FcCharSet *unionCharset = NULL, *charset;</span>
409 
410             fontformat = NULL;
411             (*FcPatternGetString)(fontPattern, FC_FONTFORMAT, 0, &amp;fontformat);
412             /* We only want TrueType fonts for Java FX */
413             if (fontformat != NULL
414                 &amp;&amp; (strcmp((char*)fontformat, &quot;TrueType&quot;) != 0)) {
415                 continue;
416             }
417             result = (*FcPatternGetCharSet)(fontPattern,
418                                             FC_CHARSET, 0, &amp;charset);
419             if (result != FcResultMatch) {
420                 free(family);
421                 free(fullname);
422                 free(styleStr);
423                 free(file);
424                 (*FcPatternDestroy)(pattern);
425                 (*FcFontSetDestroy)(fontset);
426                 (*env)-&gt;ReleaseStringUTFChars(env,
427                                               fcNameStr, (const char*)fcName);
428                 closeFontConfig(libfontconfig, JNI_FALSE);
</pre>
<hr />
<pre>
439             }
440             if (unionCharset == NULL) {
441                 unionCharset = charset;
442             } else {
443                 if ((*FcCharSetSubtractCount)(charset, unionCharset)
444                     &gt; minGlyphs) {
445                     unionCharset = (* FcCharSetUnion)(unionCharset, charset);
446                 } else {
447                     continue;
448                 }
449             }
450 
451             fontCount++; // found a font we will use.
452             (*FcPatternGetString)(fontPattern, FC_FILE, 0, &amp;file[j]);
453             (*FcPatternGetString)(fontPattern, FC_FAMILY, 0, &amp;family[j]);
454             (*FcPatternGetString)(fontPattern, FC_STYLE, 0, &amp;styleStr[j]);
455             (*FcPatternGetString)(fontPattern, FC_FULLNAME, 0, &amp;fullname[j]);
456             if (!includeFallbacks) {
457                 break;
458             }







459         }
460 
461         /* Once we get here &#39;fontCount&#39; is the number of returned fonts
462          * we actually want to use, so we create &#39;fcFontArr&#39; of that length.
463          * The non-null entries of &quot;family[]&quot; etc are those fonts.
464          * Then loop again over all nfonts adding just those non-null ones
465          * to &#39;fcFontArr&#39;. If its null (we didn&#39;t want the font)
466          * then we don&#39;t enter the main body.
467          * So we should never get more than &#39;fontCount&#39; entries.
468          */
469         if (includeFallbacks) {
470             fcFontArr =
471                 (*env)-&gt;NewObjectArray(env, fontCount, fcFontClass, NULL);
472             (*env)-&gt;SetObjectField(env,
473                                    fcCompFontObj, fcAllFontsFID, fcFontArr);
474         } else {
475             fcFontArr = NULL;
476         }
477         fn=0;
478 
</pre>
</td>
<td>
<hr />
<pre>
385             if (family != NULL) {
386                 free(family);
387             }
388             if (styleStr != NULL) {
389                 free(styleStr);
390             }
391             if (fullname != NULL) {
392                 free(fullname);
393             }
394             if (file != NULL) {
395                 free(file);
396             }
397             (*FcPatternDestroy)(pattern);
398             (*FcFontSetDestroy)(fontset);
399             (*env)-&gt;ReleaseStringUTFChars(env, fcNameStr, (const char*)fcName);
400             closeFontConfig(libfontconfig, JNI_FALSE);
401             return JNI_FALSE;
402         }
403         fontCount = 0;
404         minGlyphs = 20;
<span class="line-added">405         FcCharSet *unionCharset = NULL;</span>
406         for (j=0; j&lt;nfonts; j++) {
407             FcPattern *fontPattern = fontset-&gt;fonts[j];
408             FcChar8 *fontformat;
<span class="line-modified">409             FcCharSet *charset;</span>
410 
411             fontformat = NULL;
412             (*FcPatternGetString)(fontPattern, FC_FONTFORMAT, 0, &amp;fontformat);
413             /* We only want TrueType fonts for Java FX */
414             if (fontformat != NULL
415                 &amp;&amp; (strcmp((char*)fontformat, &quot;TrueType&quot;) != 0)) {
416                 continue;
417             }
418             result = (*FcPatternGetCharSet)(fontPattern,
419                                             FC_CHARSET, 0, &amp;charset);
420             if (result != FcResultMatch) {
421                 free(family);
422                 free(fullname);
423                 free(styleStr);
424                 free(file);
425                 (*FcPatternDestroy)(pattern);
426                 (*FcFontSetDestroy)(fontset);
427                 (*env)-&gt;ReleaseStringUTFChars(env,
428                                               fcNameStr, (const char*)fcName);
429                 closeFontConfig(libfontconfig, JNI_FALSE);
</pre>
<hr />
<pre>
440             }
441             if (unionCharset == NULL) {
442                 unionCharset = charset;
443             } else {
444                 if ((*FcCharSetSubtractCount)(charset, unionCharset)
445                     &gt; minGlyphs) {
446                     unionCharset = (* FcCharSetUnion)(unionCharset, charset);
447                 } else {
448                     continue;
449                 }
450             }
451 
452             fontCount++; // found a font we will use.
453             (*FcPatternGetString)(fontPattern, FC_FILE, 0, &amp;file[j]);
454             (*FcPatternGetString)(fontPattern, FC_FAMILY, 0, &amp;family[j]);
455             (*FcPatternGetString)(fontPattern, FC_STYLE, 0, &amp;styleStr[j]);
456             (*FcPatternGetString)(fontPattern, FC_FULLNAME, 0, &amp;fullname[j]);
457             if (!includeFallbacks) {
458                 break;
459             }
<span class="line-added">460             if (fontCount == 254) {</span>
<span class="line-added">461                 /* Upstream Java code currently stores this in a byte;</span>
<span class="line-added">462                  * And we need one slot free for when this sequence is</span>
<span class="line-added">463                  * used as a fallback sequeunce.</span>
<span class="line-added">464                  */</span>
<span class="line-added">465                 break;</span>
<span class="line-added">466             }</span>
467         }
468 
469         /* Once we get here &#39;fontCount&#39; is the number of returned fonts
470          * we actually want to use, so we create &#39;fcFontArr&#39; of that length.
471          * The non-null entries of &quot;family[]&quot; etc are those fonts.
472          * Then loop again over all nfonts adding just those non-null ones
473          * to &#39;fcFontArr&#39;. If its null (we didn&#39;t want the font)
474          * then we don&#39;t enter the main body.
475          * So we should never get more than &#39;fontCount&#39; entries.
476          */
477         if (includeFallbacks) {
478             fcFontArr =
479                 (*env)-&gt;NewObjectArray(env, fontCount, fcFontClass, NULL);
480             (*env)-&gt;SetObjectField(env,
481                                    fcCompFontObj, fcAllFontsFID, fcFontArr);
482         } else {
483             fcFontArr = NULL;
484         }
485         fn=0;
486 
</pre>
</td>
</tr>
</table>
<center><a href="../java/com/sun/prism/impl/GlyphCache.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>