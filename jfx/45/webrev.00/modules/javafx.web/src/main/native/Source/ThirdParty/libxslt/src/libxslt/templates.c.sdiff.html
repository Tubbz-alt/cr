<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/ThirdParty/libxslt/src/libxslt/templates.c</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="security.c.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="transform.c.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/ThirdParty/libxslt/src/libxslt/templates.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
315         if (expr == NULL)
316         goto exit;
317         else if (*expr == &#39;{&#39;) {
318         ret = xmlStrcat(ret, expr);
319         xmlFree(expr);
320         } else {
321         xmlXPathCompExprPtr comp;
322         /*
323          * TODO: keep precompiled form around
324          */
325         if ((nsList == NULL) &amp;&amp; (inst != NULL)) {
326             int i = 0;
327 
328             nsList = xmlGetNsList(inst-&gt;doc, inst);
329             if (nsList != NULL) {
330             while (nsList[i] != NULL)
331                 i++;
332             nsNr = i;
333             }
334         }
<span class="line-modified">335         comp = xmlXPathCompile(expr);</span>
336                 val = xsltEvalXPathStringNs(ctxt, comp, nsNr, nsList);
337         xmlXPathFreeCompExpr(comp);
338         xmlFree(expr);
339         if (val != NULL) {
340             ret = xmlStrcat(ret, val);
341             xmlFree(val);
342         }
343         }
344         cur++;
345         str = cur;
346     } else if (*cur == &#39;}&#39;) {
347         cur++;
348         if (*cur == &#39;}&#39;) {  /* escaped &#39;}&#39; */
349         ret = xmlStrncat(ret, str, cur - str);
350         cur++;
351         str = cur;
352         continue;
353         } else {
354             xsltTransformError(ctxt, NULL, inst,
355              &quot;xsltAttrTemplateValueProcessNode: unmatched &#39;}&#39;\n&quot;);
</pre>
<hr />
<pre>
628  * @target:  the element where the attributes will be grafted
629  * @attrs:  the first attribute
630  *
631  * Processes all attributes of a Literal Result Element.
632  * Attribute references are applied via xsl:use-attribute-set
633  * attributes.
634  * Copies all non XSLT-attributes over to the @target element
635  * and evaluates Attribute Value Templates.
636  *
637  * Called by xsltApplySequenceConstructor() (transform.c).
638  *
639  * Returns a new list of attribute nodes, or NULL in case of error.
640  *         (Don&#39;t assign the result to @target-&gt;properties; if
641  *         the result is NULL, you&#39;ll get memory leaks, since the
642  *         attributes will be disattached.)
643  */
644 xmlAttrPtr
645 xsltAttrListTemplateProcess(xsltTransformContextPtr ctxt,
646                         xmlNodePtr target, xmlAttrPtr attrs)
647 {
<span class="line-modified">648     xmlAttrPtr attr, copy, last;</span>
649     xmlNodePtr oldInsert, text;
650     xmlNsPtr origNs = NULL, copyNs = NULL;
651     const xmlChar *value;
652     xmlChar *valueAVT;

653 
654     if ((ctxt == NULL) || (target == NULL) || (attrs == NULL) ||
655         (target-&gt;type != XML_ELEMENT_NODE))
656     return(NULL);
657 
658     oldInsert = ctxt-&gt;insert;
659     ctxt-&gt;insert = target;
660 
661     /*
<span class="line-modified">662     * Instantiate LRE-attributes.</span>
663     */
<span class="line-modified">664     if (target-&gt;properties) {</span>
<span class="line-modified">665     last = target-&gt;properties;</span>
<span class="line-modified">666     while (last-&gt;next != NULL)</span>
<span class="line-modified">667         last = last-&gt;next;</span>
<span class="line-modified">668     } else {</span>
<span class="line-modified">669     last = NULL;</span>















670     }




671     attr = attrs;
672     do {
673     /*
674     * Skip XSLT attributes.
675     */
676 #ifdef XSLT_REFACTORED
677     if (attr-&gt;psvi == xsltXSLTAttrMarker) {
678         goto next_attribute;
679     }
680 #else
681     if ((attr-&gt;ns != NULL) &amp;&amp;
682         xmlStrEqual(attr-&gt;ns-&gt;href, XSLT_NAMESPACE))
683     {
684         goto next_attribute;
685     }
686 #endif
687     /*
688     * Get the value.
689     */
690     if (attr-&gt;children != NULL) {
691         if ((attr-&gt;children-&gt;type != XML_TEXT_NODE) ||
692         (attr-&gt;children-&gt;next != NULL))
693         {
694         xsltTransformError(ctxt, NULL, attr-&gt;parent,
695             &quot;Internal error: The children of an attribute node of a &quot;
696             &quot;literal result element are not in the expected form.\n&quot;);
697         goto error;
698         }
699         value = attr-&gt;children-&gt;content;
700         if (value == NULL)
701         value = xmlDictLookup(ctxt-&gt;dict, BAD_CAST &quot;&quot;, 0);
702     } else
703         value = xmlDictLookup(ctxt-&gt;dict, BAD_CAST &quot;&quot;, 0);
704 
705     /*
<span class="line-modified">706     * Create a new attribute.</span>
<span class="line-removed">707     */</span>
<span class="line-removed">708     copy = xmlNewDocProp(target-&gt;doc, attr-&gt;name, NULL);</span>
<span class="line-removed">709     if (copy == NULL) {</span>
<span class="line-removed">710         if (attr-&gt;ns) {</span>
<span class="line-removed">711         xsltTransformError(ctxt, NULL, attr-&gt;parent,</span>
<span class="line-removed">712             &quot;Internal error: Failed to create attribute &#39;{%s}%s&#39;.\n&quot;,</span>
<span class="line-removed">713             attr-&gt;ns-&gt;href, attr-&gt;name);</span>
<span class="line-removed">714         } else {</span>
<span class="line-removed">715         xsltTransformError(ctxt, NULL, attr-&gt;parent,</span>
<span class="line-removed">716             &quot;Internal error: Failed to create attribute &#39;%s&#39;.\n&quot;,</span>
<span class="line-removed">717             attr-&gt;name);</span>
<span class="line-removed">718         }</span>
<span class="line-removed">719         goto error;</span>
<span class="line-removed">720     }</span>
<span class="line-removed">721     /*</span>
<span class="line-removed">722     * Attach it to the target element.</span>
<span class="line-removed">723     */</span>
<span class="line-removed">724     copy-&gt;parent = target;</span>
<span class="line-removed">725     if (last == NULL) {</span>
<span class="line-removed">726         target-&gt;properties = copy;</span>
<span class="line-removed">727         last = copy;</span>
<span class="line-removed">728     } else {</span>
<span class="line-removed">729         last-&gt;next = copy;</span>
<span class="line-removed">730         copy-&gt;prev = last;</span>
<span class="line-removed">731         last = copy;</span>
<span class="line-removed">732     }</span>
<span class="line-removed">733     /*</span>
<span class="line-removed">734     * Set the namespace. Avoid lookups of same namespaces.</span>
735     */
736     if (attr-&gt;ns != origNs) {
737         origNs = attr-&gt;ns;
738         if (attr-&gt;ns != NULL) {
739 #ifdef XSLT_REFACTORED
740         copyNs = xsltGetSpecialNamespace(ctxt, attr-&gt;parent,
741             attr-&gt;ns-&gt;href, attr-&gt;ns-&gt;prefix, target);
742 #else
743         copyNs = xsltGetNamespace(ctxt, attr-&gt;parent,
744             attr-&gt;ns, target);
745 #endif
746         if (copyNs == NULL)
747             goto error;
748         } else
749         copyNs = NULL;
750     }
<span class="line-modified">751     copy-&gt;ns = copyNs;</span>








































752 
753     /*
754     * Set the value.
755     */
756     text = xmlNewText(NULL);
757     if (text != NULL) {
758         copy-&gt;last = copy-&gt;children = text;
759         text-&gt;parent = (xmlNodePtr) copy;
760         text-&gt;doc = copy-&gt;doc;
761 
762         if (attr-&gt;psvi != NULL) {
763         /*
764         * Evaluate the Attribute Value Template.
765         */
766         valueAVT = xsltEvalAVT(ctxt, attr-&gt;psvi, attr-&gt;parent);
767         if (valueAVT == NULL) {
768             /*
769             * TODO: Damn, we need an easy mechanism to report
770             * qualified names!
771             */
</pre>
<hr />
<pre>
786             text-&gt;content = valueAVT;
787         }
788         } else if ((ctxt-&gt;internalized) &amp;&amp;
789         (target-&gt;doc != NULL) &amp;&amp;
790         (target-&gt;doc-&gt;dict == ctxt-&gt;dict) &amp;&amp;
791         xmlDictOwns(ctxt-&gt;dict, value))
792         {
793         text-&gt;content = (xmlChar *) value;
794         } else {
795         text-&gt;content = xmlStrdup(value);
796         }
797             if ((copy != NULL) &amp;&amp; (text != NULL) &amp;&amp;
798                 (xmlIsID(copy-&gt;doc, copy-&gt;parent, copy)))
799                 xmlAddID(NULL, copy-&gt;doc, text-&gt;content, copy);
800     }
801 
802 next_attribute:
803     attr = attr-&gt;next;
804     } while (attr != NULL);
805 
<span class="line-removed">806     /*</span>
<span class="line-removed">807     * Apply attribute-sets.</span>
<span class="line-removed">808     * The creation of such attributes will not overwrite any existing</span>
<span class="line-removed">809     * attribute.</span>
<span class="line-removed">810     */</span>
<span class="line-removed">811     attr = attrs;</span>
<span class="line-removed">812     do {</span>
<span class="line-removed">813 #ifdef XSLT_REFACTORED</span>
<span class="line-removed">814     if ((attr-&gt;psvi == xsltXSLTAttrMarker) &amp;&amp;</span>
<span class="line-removed">815         xmlStrEqual(attr-&gt;name, (const xmlChar *)&quot;use-attribute-sets&quot;))</span>
<span class="line-removed">816     {</span>
<span class="line-removed">817         xsltApplyAttributeSet(ctxt, ctxt-&gt;node, (xmlNodePtr) attr, NULL);</span>
<span class="line-removed">818     }</span>
<span class="line-removed">819 #else</span>
<span class="line-removed">820     if ((attr-&gt;ns != NULL) &amp;&amp;</span>
<span class="line-removed">821         xmlStrEqual(attr-&gt;name, (const xmlChar *)&quot;use-attribute-sets&quot;) &amp;&amp;</span>
<span class="line-removed">822         xmlStrEqual(attr-&gt;ns-&gt;href, XSLT_NAMESPACE))</span>
<span class="line-removed">823     {</span>
<span class="line-removed">824         xsltApplyAttributeSet(ctxt, ctxt-&gt;node, (xmlNodePtr) attr, NULL);</span>
<span class="line-removed">825     }</span>
<span class="line-removed">826 #endif</span>
<span class="line-removed">827     attr = attr-&gt;next;</span>
<span class="line-removed">828     } while (attr != NULL);</span>
<span class="line-removed">829 </span>
830     ctxt-&gt;insert = oldInsert;
831     return(target-&gt;properties);
832 
833 error:
834     ctxt-&gt;insert = oldInsert;
835     return(NULL);
836 }
837 
838 
839 /**
840  * xsltTemplateProcess:
841  * @ctxt:  the XSLT transformation context
842  * @node:  the attribute template node
843  *
844  * Obsolete. Don&#39;t use it.
845  *
846  * Returns NULL.
847  */
848 xmlNodePtr *
849 xsltTemplateProcess(xsltTransformContextPtr ctxt ATTRIBUTE_UNUSED, xmlNodePtr node) {
</pre>
</td>
<td>
<hr />
<pre>
315         if (expr == NULL)
316         goto exit;
317         else if (*expr == &#39;{&#39;) {
318         ret = xmlStrcat(ret, expr);
319         xmlFree(expr);
320         } else {
321         xmlXPathCompExprPtr comp;
322         /*
323          * TODO: keep precompiled form around
324          */
325         if ((nsList == NULL) &amp;&amp; (inst != NULL)) {
326             int i = 0;
327 
328             nsList = xmlGetNsList(inst-&gt;doc, inst);
329             if (nsList != NULL) {
330             while (nsList[i] != NULL)
331                 i++;
332             nsNr = i;
333             }
334         }
<span class="line-modified">335         comp = xmlXPathCtxtCompile(ctxt-&gt;xpathCtxt, expr);</span>
336                 val = xsltEvalXPathStringNs(ctxt, comp, nsNr, nsList);
337         xmlXPathFreeCompExpr(comp);
338         xmlFree(expr);
339         if (val != NULL) {
340             ret = xmlStrcat(ret, val);
341             xmlFree(val);
342         }
343         }
344         cur++;
345         str = cur;
346     } else if (*cur == &#39;}&#39;) {
347         cur++;
348         if (*cur == &#39;}&#39;) {  /* escaped &#39;}&#39; */
349         ret = xmlStrncat(ret, str, cur - str);
350         cur++;
351         str = cur;
352         continue;
353         } else {
354             xsltTransformError(ctxt, NULL, inst,
355              &quot;xsltAttrTemplateValueProcessNode: unmatched &#39;}&#39;\n&quot;);
</pre>
<hr />
<pre>
628  * @target:  the element where the attributes will be grafted
629  * @attrs:  the first attribute
630  *
631  * Processes all attributes of a Literal Result Element.
632  * Attribute references are applied via xsl:use-attribute-set
633  * attributes.
634  * Copies all non XSLT-attributes over to the @target element
635  * and evaluates Attribute Value Templates.
636  *
637  * Called by xsltApplySequenceConstructor() (transform.c).
638  *
639  * Returns a new list of attribute nodes, or NULL in case of error.
640  *         (Don&#39;t assign the result to @target-&gt;properties; if
641  *         the result is NULL, you&#39;ll get memory leaks, since the
642  *         attributes will be disattached.)
643  */
644 xmlAttrPtr
645 xsltAttrListTemplateProcess(xsltTransformContextPtr ctxt,
646                         xmlNodePtr target, xmlAttrPtr attrs)
647 {
<span class="line-modified">648     xmlAttrPtr attr, copy, last = NULL;</span>
649     xmlNodePtr oldInsert, text;
650     xmlNsPtr origNs = NULL, copyNs = NULL;
651     const xmlChar *value;
652     xmlChar *valueAVT;
<span class="line-added">653     int hasAttr = 0;</span>
654 
655     if ((ctxt == NULL) || (target == NULL) || (attrs == NULL) ||
656         (target-&gt;type != XML_ELEMENT_NODE))
657     return(NULL);
658 
659     oldInsert = ctxt-&gt;insert;
660     ctxt-&gt;insert = target;
661 
662     /*
<span class="line-modified">663     * Apply attribute-sets.</span>
664     */
<span class="line-modified">665     attr = attrs;</span>
<span class="line-modified">666     do {</span>
<span class="line-modified">667 #ifdef XSLT_REFACTORED</span>
<span class="line-modified">668     if ((attr-&gt;psvi == xsltXSLTAttrMarker) &amp;&amp;</span>
<span class="line-modified">669         xmlStrEqual(attr-&gt;name, (const xmlChar *)&quot;use-attribute-sets&quot;))</span>
<span class="line-modified">670     {</span>
<span class="line-added">671         xsltApplyAttributeSet(ctxt, ctxt-&gt;node, (xmlNodePtr) attr, NULL);</span>
<span class="line-added">672     }</span>
<span class="line-added">673 #else</span>
<span class="line-added">674     if ((attr-&gt;ns != NULL) &amp;&amp;</span>
<span class="line-added">675         xmlStrEqual(attr-&gt;name, (const xmlChar *)&quot;use-attribute-sets&quot;) &amp;&amp;</span>
<span class="line-added">676         xmlStrEqual(attr-&gt;ns-&gt;href, XSLT_NAMESPACE))</span>
<span class="line-added">677     {</span>
<span class="line-added">678         xsltApplyAttributeSet(ctxt, ctxt-&gt;node, (xmlNodePtr) attr, NULL);</span>
<span class="line-added">679     }</span>
<span class="line-added">680 #endif</span>
<span class="line-added">681     attr = attr-&gt;next;</span>
<span class="line-added">682     } while (attr != NULL);</span>
<span class="line-added">683 </span>
<span class="line-added">684     if (target-&gt;properties != NULL) {</span>
<span class="line-added">685         hasAttr = 1;</span>
686     }
<span class="line-added">687 </span>
<span class="line-added">688     /*</span>
<span class="line-added">689     * Instantiate LRE-attributes.</span>
<span class="line-added">690     */</span>
691     attr = attrs;
692     do {
693     /*
694     * Skip XSLT attributes.
695     */
696 #ifdef XSLT_REFACTORED
697     if (attr-&gt;psvi == xsltXSLTAttrMarker) {
698         goto next_attribute;
699     }
700 #else
701     if ((attr-&gt;ns != NULL) &amp;&amp;
702         xmlStrEqual(attr-&gt;ns-&gt;href, XSLT_NAMESPACE))
703     {
704         goto next_attribute;
705     }
706 #endif
707     /*
708     * Get the value.
709     */
710     if (attr-&gt;children != NULL) {
711         if ((attr-&gt;children-&gt;type != XML_TEXT_NODE) ||
712         (attr-&gt;children-&gt;next != NULL))
713         {
714         xsltTransformError(ctxt, NULL, attr-&gt;parent,
715             &quot;Internal error: The children of an attribute node of a &quot;
716             &quot;literal result element are not in the expected form.\n&quot;);
717         goto error;
718         }
719         value = attr-&gt;children-&gt;content;
720         if (value == NULL)
721         value = xmlDictLookup(ctxt-&gt;dict, BAD_CAST &quot;&quot;, 0);
722     } else
723         value = xmlDictLookup(ctxt-&gt;dict, BAD_CAST &quot;&quot;, 0);
724 
725     /*
<span class="line-modified">726     * Get the namespace. Avoid lookups of same namespaces.</span>




























727     */
728     if (attr-&gt;ns != origNs) {
729         origNs = attr-&gt;ns;
730         if (attr-&gt;ns != NULL) {
731 #ifdef XSLT_REFACTORED
732         copyNs = xsltGetSpecialNamespace(ctxt, attr-&gt;parent,
733             attr-&gt;ns-&gt;href, attr-&gt;ns-&gt;prefix, target);
734 #else
735         copyNs = xsltGetNamespace(ctxt, attr-&gt;parent,
736             attr-&gt;ns, target);
737 #endif
738         if (copyNs == NULL)
739             goto error;
740         } else
741         copyNs = NULL;
742     }
<span class="line-modified">743     /*</span>
<span class="line-added">744     * Create a new attribute.</span>
<span class="line-added">745     */</span>
<span class="line-added">746         if (hasAttr) {</span>
<span class="line-added">747         copy = xmlSetNsProp(target, copyNs, attr-&gt;name, NULL);</span>
<span class="line-added">748         } else {</span>
<span class="line-added">749             /*</span>
<span class="line-added">750             * Avoid checking for duplicate attributes if there aren&#39;t</span>
<span class="line-added">751             * any attribute sets.</span>
<span class="line-added">752             */</span>
<span class="line-added">753         copy = xmlNewDocProp(target-&gt;doc, attr-&gt;name, NULL);</span>
<span class="line-added">754 </span>
<span class="line-added">755         if (copy != NULL) {</span>
<span class="line-added">756                 copy-&gt;ns = copyNs;</span>
<span class="line-added">757 </span>
<span class="line-added">758                 /*</span>
<span class="line-added">759                 * Attach it to the target element.</span>
<span class="line-added">760                 */</span>
<span class="line-added">761                 copy-&gt;parent = target;</span>
<span class="line-added">762                 if (last == NULL) {</span>
<span class="line-added">763                     target-&gt;properties = copy;</span>
<span class="line-added">764                     last = copy;</span>
<span class="line-added">765                 } else {</span>
<span class="line-added">766                     last-&gt;next = copy;</span>
<span class="line-added">767                     copy-&gt;prev = last;</span>
<span class="line-added">768                     last = copy;</span>
<span class="line-added">769                 }</span>
<span class="line-added">770             }</span>
<span class="line-added">771         }</span>
<span class="line-added">772     if (copy == NULL) {</span>
<span class="line-added">773         if (attr-&gt;ns) {</span>
<span class="line-added">774         xsltTransformError(ctxt, NULL, attr-&gt;parent,</span>
<span class="line-added">775             &quot;Internal error: Failed to create attribute &#39;{%s}%s&#39;.\n&quot;,</span>
<span class="line-added">776             attr-&gt;ns-&gt;href, attr-&gt;name);</span>
<span class="line-added">777         } else {</span>
<span class="line-added">778         xsltTransformError(ctxt, NULL, attr-&gt;parent,</span>
<span class="line-added">779             &quot;Internal error: Failed to create attribute &#39;%s&#39;.\n&quot;,</span>
<span class="line-added">780             attr-&gt;name);</span>
<span class="line-added">781         }</span>
<span class="line-added">782         goto error;</span>
<span class="line-added">783     }</span>
784 
785     /*
786     * Set the value.
787     */
788     text = xmlNewText(NULL);
789     if (text != NULL) {
790         copy-&gt;last = copy-&gt;children = text;
791         text-&gt;parent = (xmlNodePtr) copy;
792         text-&gt;doc = copy-&gt;doc;
793 
794         if (attr-&gt;psvi != NULL) {
795         /*
796         * Evaluate the Attribute Value Template.
797         */
798         valueAVT = xsltEvalAVT(ctxt, attr-&gt;psvi, attr-&gt;parent);
799         if (valueAVT == NULL) {
800             /*
801             * TODO: Damn, we need an easy mechanism to report
802             * qualified names!
803             */
</pre>
<hr />
<pre>
818             text-&gt;content = valueAVT;
819         }
820         } else if ((ctxt-&gt;internalized) &amp;&amp;
821         (target-&gt;doc != NULL) &amp;&amp;
822         (target-&gt;doc-&gt;dict == ctxt-&gt;dict) &amp;&amp;
823         xmlDictOwns(ctxt-&gt;dict, value))
824         {
825         text-&gt;content = (xmlChar *) value;
826         } else {
827         text-&gt;content = xmlStrdup(value);
828         }
829             if ((copy != NULL) &amp;&amp; (text != NULL) &amp;&amp;
830                 (xmlIsID(copy-&gt;doc, copy-&gt;parent, copy)))
831                 xmlAddID(NULL, copy-&gt;doc, text-&gt;content, copy);
832     }
833 
834 next_attribute:
835     attr = attr-&gt;next;
836     } while (attr != NULL);
837 
























838     ctxt-&gt;insert = oldInsert;
839     return(target-&gt;properties);
840 
841 error:
842     ctxt-&gt;insert = oldInsert;
843     return(NULL);
844 }
845 
846 
847 /**
848  * xsltTemplateProcess:
849  * @ctxt:  the XSLT transformation context
850  * @node:  the attribute template node
851  *
852  * Obsolete. Don&#39;t use it.
853  *
854  * Returns NULL.
855  */
856 xmlNodePtr *
857 xsltTemplateProcess(xsltTransformContextPtr ctxt ATTRIBUTE_UNUSED, xmlNodePtr node) {
</pre>
</td>
</tr>
</table>
<center><a href="security.c.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="transform.c.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>