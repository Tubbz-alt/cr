<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.base/src/test/java/test/javafx/collections/FXCollectionsTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../com/sun/javafx/runtime/VersionInfoTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../javafx.web/src/main/java/javafx/scene/web/WebView.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.base/src/test/java/test/javafx/collections/FXCollectionsTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 655         }
 656         try {
 657             set.add(Integer.valueOf(10));
 658             fail(&quot;Expected ClassCastException&quot;);
 659         } catch (ClassCastException ex) {
 660         }
 661         set.add(&quot;foo3&quot;);
 662         assertTrue(set.containsAll(Arrays.asList(&quot;foo&quot;, &quot;foo2&quot;, &quot;foo3&quot;)));
 663         assertEquals(3, set.size());
 664 
 665         try {
 666             set.addAll(Arrays.asList(Boolean.TRUE, Boolean.FALSE));
 667             fail(&quot;Expected ClassCastException&quot;);
 668         } catch (ClassCastException ex) {
 669         }
 670         set.addAll(Arrays.asList(&quot;foo6&quot;, &quot;foo7&quot;));
 671         assertTrue(set.containsAll(Arrays.asList(&quot;foo&quot;, &quot;foo2&quot;, &quot;foo3&quot;, &quot;foo6&quot;, &quot;foo7&quot;)));
 672         assertEquals(5, set.size());
 673     }
 674 













































































































































































 675     @Test
 676     public void synchronizedMapIterationProtectionTest() {
 677         testIterationProtection(FXCollections.synchronizedObservableMap(FXCollections.observableHashMap()), this::putRandomValue, this::copyMap);
 678     }
 679 
 680     private void putRandomValue(Map&lt;Integer, Integer&gt; map, Random rnd) {
 681         map.put(rnd.nextInt(1000), rnd.nextInt());
 682     }
 683 
 684     private void copyMap(Map&lt;Integer, Integer&gt; map) {
 685         new HashMap&lt;&gt;(map);
 686     }
 687 
 688     @Test
 689     public void synchronizedSetIterationProtectionTest() {
 690         testIterationProtection(FXCollections.synchronizedObservableSet(FXCollections.observableSet()), this::addRandomValue, this::copySet);
 691     }
 692 
 693     private void addRandomValue(Set&lt;Integer&gt; set, Random rnd) {
 694         set.add(rnd.nextInt(1000));
</pre>
</td>
<td>
<hr />
<pre>
 655         }
 656         try {
 657             set.add(Integer.valueOf(10));
 658             fail(&quot;Expected ClassCastException&quot;);
 659         } catch (ClassCastException ex) {
 660         }
 661         set.add(&quot;foo3&quot;);
 662         assertTrue(set.containsAll(Arrays.asList(&quot;foo&quot;, &quot;foo2&quot;, &quot;foo3&quot;)));
 663         assertEquals(3, set.size());
 664 
 665         try {
 666             set.addAll(Arrays.asList(Boolean.TRUE, Boolean.FALSE));
 667             fail(&quot;Expected ClassCastException&quot;);
 668         } catch (ClassCastException ex) {
 669         }
 670         set.addAll(Arrays.asList(&quot;foo6&quot;, &quot;foo7&quot;));
 671         assertTrue(set.containsAll(Arrays.asList(&quot;foo&quot;, &quot;foo2&quot;, &quot;foo3&quot;, &quot;foo6&quot;, &quot;foo7&quot;)));
 672         assertEquals(5, set.size());
 673     }
 674 
<span class="line-added"> 675     @Test</span>
<span class="line-added"> 676     public void synchronizedMapIterationProtectionTest() {</span>
<span class="line-added"> 677         testIterationProtection(FXCollections.synchronizedObservableMap(FXCollections.observableHashMap()), this::putRandomValue, this::copyMap);</span>
<span class="line-added"> 678     }</span>
<span class="line-added"> 679 </span>
<span class="line-added"> 680     private void putRandomValue(Map&lt;Integer, Integer&gt; map, Random rnd) {</span>
<span class="line-added"> 681         map.put(rnd.nextInt(1000), rnd.nextInt());</span>
<span class="line-added"> 682     }</span>
<span class="line-added"> 683 </span>
<span class="line-added"> 684     private void copyMap(Map&lt;Integer, Integer&gt; map) {</span>
<span class="line-added"> 685         new HashMap&lt;&gt;(map);</span>
<span class="line-added"> 686     }</span>
<span class="line-added"> 687 </span>
<span class="line-added"> 688     @Test</span>
<span class="line-added"> 689     public void synchronizedSetIterationProtectionTest() {</span>
<span class="line-added"> 690         testIterationProtection(FXCollections.synchronizedObservableSet(FXCollections.observableSet()), this::addRandomValue, this::copySet);</span>
<span class="line-added"> 691     }</span>
<span class="line-added"> 692 </span>
<span class="line-added"> 693     private void addRandomValue(Set&lt;Integer&gt; set, Random rnd) {</span>
<span class="line-added"> 694         set.add(rnd.nextInt(1000));</span>
<span class="line-added"> 695     }</span>
<span class="line-added"> 696 </span>
<span class="line-added"> 697     private void copySet(Set&lt;Integer&gt; set) {</span>
<span class="line-added"> 698         new HashSet&lt;&gt;(set);</span>
<span class="line-added"> 699     }</span>
<span class="line-added"> 700 </span>
<span class="line-added"> 701     @Test</span>
<span class="line-added"> 702     public void synchronizedListIterationProtectionTest() {</span>
<span class="line-added"> 703         testIterationProtection(FXCollections.synchronizedObservableList(FXCollections.observableArrayList()), this::modifyList, this::iterateOverList);</span>
<span class="line-added"> 704     }</span>
<span class="line-added"> 705 </span>
<span class="line-added"> 706     private void modifyList(List&lt;Integer&gt; list, Random rnd) {</span>
<span class="line-added"> 707         if (rnd.nextInt(1000) &gt; list.size()) {</span>
<span class="line-added"> 708             list.add(rnd.nextInt(1000));</span>
<span class="line-added"> 709         } else {</span>
<span class="line-added"> 710             list.remove(rnd.nextInt(list.size()));</span>
<span class="line-added"> 711         }</span>
<span class="line-added"> 712     }</span>
<span class="line-added"> 713 </span>
<span class="line-added"> 714     private void iterateOverList(List&lt;Integer&gt; list) {</span>
<span class="line-added"> 715         Iterator&lt;Integer&gt; it = list.iterator();</span>
<span class="line-added"> 716         while (it.hasNext()) {</span>
<span class="line-added"> 717             it.next();</span>
<span class="line-added"> 718         }</span>
<span class="line-added"> 719     }</span>
<span class="line-added"> 720 </span>
<span class="line-added"> 721     public &lt;V&gt; void testIterationProtection(V collection, BiConsumer&lt;V, Random&gt; backgroundChanger, Consumer&lt;V&gt; protectedCode) {</span>
<span class="line-added"> 722         CollectionChangeThread&lt;V&gt; thread = new CollectionChangeThread&lt;&gt;(collection, backgroundChanger);</span>
<span class="line-added"> 723         thread.start();</span>
<span class="line-added"> 724         for (int i = 0; i &lt; 10000; i++) {</span>
<span class="line-added"> 725             try {</span>
<span class="line-added"> 726                 synchronized (collection) {</span>
<span class="line-added"> 727                     protectedCode.accept(collection);</span>
<span class="line-added"> 728                 }</span>
<span class="line-added"> 729             } catch (ConcurrentModificationException e) {</span>
<span class="line-added"> 730                 fail(&quot;ConcurrentModificationException should not be thrown&quot;);</span>
<span class="line-added"> 731             }</span>
<span class="line-added"> 732         }</span>
<span class="line-added"> 733         thread.terminate();</span>
<span class="line-added"> 734     }</span>
<span class="line-added"> 735 </span>
<span class="line-added"> 736     private static class CollectionChangeThread&lt;V&gt; extends Thread {</span>
<span class="line-added"> 737         private boolean shallRun = true;</span>
<span class="line-added"> 738         private V collection;</span>
<span class="line-added"> 739         private BiConsumer&lt;V, Random&gt; backgroundChanger;</span>
<span class="line-added"> 740         private Random rnd = new Random();</span>
<span class="line-added"> 741 </span>
<span class="line-added"> 742         public CollectionChangeThread(V collection, BiConsumer&lt;V, Random&gt; backgroundChanger) {</span>
<span class="line-added"> 743             super(&quot;FXCollectionsTest.CollectionChangeThread&quot;);</span>
<span class="line-added"> 744             this.collection = collection;</span>
<span class="line-added"> 745             this.backgroundChanger = backgroundChanger;</span>
<span class="line-added"> 746         }</span>
<span class="line-added"> 747 </span>
<span class="line-added"> 748         @Override</span>
<span class="line-added"> 749         public void run() {</span>
<span class="line-added"> 750             while (shallRun) {</span>
<span class="line-added"> 751                 backgroundChanger.accept(collection, rnd);</span>
<span class="line-added"> 752             }</span>
<span class="line-added"> 753         }</span>
<span class="line-added"> 754 </span>
<span class="line-added"> 755         public void terminate() {</span>
<span class="line-added"> 756             shallRun = false;</span>
<span class="line-added"> 757         }</span>
<span class="line-added"> 758     }</span>
<span class="line-added"> 759 </span>
<span class="line-added"> 760 </span>
<span class="line-added"> 761     @Test</span>
<span class="line-added"> 762     public void synchronizedMapIterationProtectionTest() {</span>
<span class="line-added"> 763         testIterationProtection(FXCollections.synchronizedObservableMap(FXCollections.observableHashMap()), this::putRandomValue, this::copyMap);</span>
<span class="line-added"> 764     }</span>
<span class="line-added"> 765 </span>
<span class="line-added"> 766     private void putRandomValue(Map&lt;Integer, Integer&gt; map, Random rnd) {</span>
<span class="line-added"> 767         map.put(rnd.nextInt(1000), rnd.nextInt());</span>
<span class="line-added"> 768     }</span>
<span class="line-added"> 769 </span>
<span class="line-added"> 770     private void copyMap(Map&lt;Integer, Integer&gt; map) {</span>
<span class="line-added"> 771         new HashMap&lt;&gt;(map);</span>
<span class="line-added"> 772     }</span>
<span class="line-added"> 773 </span>
<span class="line-added"> 774     @Test</span>
<span class="line-added"> 775     public void synchronizedSetIterationProtectionTest() {</span>
<span class="line-added"> 776         testIterationProtection(FXCollections.synchronizedObservableSet(FXCollections.observableSet()), this::addRandomValue, this::copySet);</span>
<span class="line-added"> 777     }</span>
<span class="line-added"> 778 </span>
<span class="line-added"> 779     private void addRandomValue(Set&lt;Integer&gt; set, Random rnd) {</span>
<span class="line-added"> 780         set.add(rnd.nextInt(1000));</span>
<span class="line-added"> 781     }</span>
<span class="line-added"> 782 </span>
<span class="line-added"> 783     private void copySet(Set&lt;Integer&gt; set) {</span>
<span class="line-added"> 784         new HashSet&lt;&gt;(set);</span>
<span class="line-added"> 785     }</span>
<span class="line-added"> 786 </span>
<span class="line-added"> 787     @Test</span>
<span class="line-added"> 788     public void synchronizedListIterationProtectionTest() {</span>
<span class="line-added"> 789         testIterationProtection(FXCollections.synchronizedObservableList(FXCollections.observableArrayList()), this::modifyList, this::iterateOverList);</span>
<span class="line-added"> 790     }</span>
<span class="line-added"> 791 </span>
<span class="line-added"> 792     private void modifyList(List&lt;Integer&gt; list, Random rnd) {</span>
<span class="line-added"> 793         if (rnd.nextInt(1000) &gt; list.size()) {</span>
<span class="line-added"> 794             list.add(rnd.nextInt(1000));</span>
<span class="line-added"> 795         } else {</span>
<span class="line-added"> 796             list.remove(rnd.nextInt(list.size()));</span>
<span class="line-added"> 797         }</span>
<span class="line-added"> 798     }</span>
<span class="line-added"> 799 </span>
<span class="line-added"> 800     private void iterateOverList(List&lt;Integer&gt; list) {</span>
<span class="line-added"> 801         Iterator&lt;Integer&gt; it = list.iterator();</span>
<span class="line-added"> 802         while (it.hasNext()) {</span>
<span class="line-added"> 803             it.next();</span>
<span class="line-added"> 804         }</span>
<span class="line-added"> 805     }</span>
<span class="line-added"> 806 </span>
<span class="line-added"> 807     public &lt;V&gt; void testIterationProtection(V collection, BiConsumer&lt;V, Random&gt; backgroundChanger, Consumer&lt;V&gt; protectedCode) {</span>
<span class="line-added"> 808         CollectionChangeThread&lt;V&gt; thread = new CollectionChangeThread&lt;&gt;(collection, backgroundChanger);</span>
<span class="line-added"> 809         thread.start();</span>
<span class="line-added"> 810         for (int i = 0; i &lt; 10000; i++) {</span>
<span class="line-added"> 811             try {</span>
<span class="line-added"> 812                 synchronized (collection) {</span>
<span class="line-added"> 813                     protectedCode.accept(collection);</span>
<span class="line-added"> 814                 }</span>
<span class="line-added"> 815             } catch (ConcurrentModificationException e) {</span>
<span class="line-added"> 816                 thread.terminate();</span>
<span class="line-added"> 817                 fail(&quot;ConcurrentModificationException should not be thrown&quot;);</span>
<span class="line-added"> 818             }</span>
<span class="line-added"> 819         }</span>
<span class="line-added"> 820         thread.terminate();</span>
<span class="line-added"> 821     }</span>
<span class="line-added"> 822 </span>
<span class="line-added"> 823     private static class CollectionChangeThread&lt;V&gt; extends Thread {</span>
<span class="line-added"> 824         private boolean shallRun = true;</span>
<span class="line-added"> 825         private V collection;</span>
<span class="line-added"> 826         private BiConsumer&lt;V, Random&gt; backgroundChanger;</span>
<span class="line-added"> 827         private Random rnd = new Random();</span>
<span class="line-added"> 828 </span>
<span class="line-added"> 829         public CollectionChangeThread(V collection, BiConsumer&lt;V, Random&gt; backgroundChanger) {</span>
<span class="line-added"> 830             super(&quot;FXCollectionsTest.CollectionChangeThread&quot;);</span>
<span class="line-added"> 831             this.collection = collection;</span>
<span class="line-added"> 832             this.backgroundChanger = backgroundChanger;</span>
<span class="line-added"> 833         }</span>
<span class="line-added"> 834 </span>
<span class="line-added"> 835         @Override</span>
<span class="line-added"> 836         public void run() {</span>
<span class="line-added"> 837             while (shallRun) {</span>
<span class="line-added"> 838                 backgroundChanger.accept(collection, rnd);</span>
<span class="line-added"> 839             }</span>
<span class="line-added"> 840         }</span>
<span class="line-added"> 841 </span>
<span class="line-added"> 842         public void terminate() {</span>
<span class="line-added"> 843             shallRun = false;</span>
<span class="line-added"> 844         }</span>
<span class="line-added"> 845     }</span>
<span class="line-added"> 846 </span>
<span class="line-added"> 847 </span>
 848     @Test
 849     public void synchronizedMapIterationProtectionTest() {
 850         testIterationProtection(FXCollections.synchronizedObservableMap(FXCollections.observableHashMap()), this::putRandomValue, this::copyMap);
 851     }
 852 
 853     private void putRandomValue(Map&lt;Integer, Integer&gt; map, Random rnd) {
 854         map.put(rnd.nextInt(1000), rnd.nextInt());
 855     }
 856 
 857     private void copyMap(Map&lt;Integer, Integer&gt; map) {
 858         new HashMap&lt;&gt;(map);
 859     }
 860 
 861     @Test
 862     public void synchronizedSetIterationProtectionTest() {
 863         testIterationProtection(FXCollections.synchronizedObservableSet(FXCollections.observableSet()), this::addRandomValue, this::copySet);
 864     }
 865 
 866     private void addRandomValue(Set&lt;Integer&gt; set, Random rnd) {
 867         set.add(rnd.nextInt(1000));
</pre>
</td>
</tr>
</table>
<center><a href="../../com/sun/javafx/runtime/VersionInfoTest.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../javafx.web/src/main/java/javafx/scene/web/WebView.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>