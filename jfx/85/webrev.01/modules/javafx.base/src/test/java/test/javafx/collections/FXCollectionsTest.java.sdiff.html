<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.base/src/test/java/test/javafx/collections/FXCollectionsTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../main/java/javafx/collections/FXCollections.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../javafx.web/src/main/java/javafx/scene/web/WebView.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.base/src/test/java/test/javafx/collections/FXCollectionsTest.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
655         }
656         try {
657             set.add(Integer.valueOf(10));
658             fail(&quot;Expected ClassCastException&quot;);
659         } catch (ClassCastException ex) {
660         }
661         set.add(&quot;foo3&quot;);
662         assertTrue(set.containsAll(Arrays.asList(&quot;foo&quot;, &quot;foo2&quot;, &quot;foo3&quot;)));
663         assertEquals(3, set.size());
664 
665         try {
666             set.addAll(Arrays.asList(Boolean.TRUE, Boolean.FALSE));
667             fail(&quot;Expected ClassCastException&quot;);
668         } catch (ClassCastException ex) {
669         }
670         set.addAll(Arrays.asList(&quot;foo6&quot;, &quot;foo7&quot;));
671         assertTrue(set.containsAll(Arrays.asList(&quot;foo&quot;, &quot;foo2&quot;, &quot;foo3&quot;, &quot;foo6&quot;, &quot;foo7&quot;)));
672         assertEquals(5, set.size());
673     }
674 






















































































675     @Test
676     public void synchronizedMapIterationProtectionTest() {
677         testIterationProtection(FXCollections.synchronizedObservableMap(FXCollections.observableHashMap()), this::putRandomValue, this::copyMap);
678     }
679 
680     private void putRandomValue(Map&lt;Integer, Integer&gt; map, Random rnd) {
681         map.put(rnd.nextInt(1000), rnd.nextInt());
682     }
683 
684     private void copyMap(Map&lt;Integer, Integer&gt; map) {
685         new HashMap&lt;&gt;(map);
686     }
687 
688     @Test
689     public void synchronizedSetIterationProtectionTest() {
690         testIterationProtection(FXCollections.synchronizedObservableSet(FXCollections.observableSet()), this::addRandomValue, this::copySet);
691     }
692 
693     private void addRandomValue(Set&lt;Integer&gt; set, Random rnd) {
694         set.add(rnd.nextInt(1000));
</pre>
</td>
<td>
<hr />
<pre>
655         }
656         try {
657             set.add(Integer.valueOf(10));
658             fail(&quot;Expected ClassCastException&quot;);
659         } catch (ClassCastException ex) {
660         }
661         set.add(&quot;foo3&quot;);
662         assertTrue(set.containsAll(Arrays.asList(&quot;foo&quot;, &quot;foo2&quot;, &quot;foo3&quot;)));
663         assertEquals(3, set.size());
664 
665         try {
666             set.addAll(Arrays.asList(Boolean.TRUE, Boolean.FALSE));
667             fail(&quot;Expected ClassCastException&quot;);
668         } catch (ClassCastException ex) {
669         }
670         set.addAll(Arrays.asList(&quot;foo6&quot;, &quot;foo7&quot;));
671         assertTrue(set.containsAll(Arrays.asList(&quot;foo&quot;, &quot;foo2&quot;, &quot;foo3&quot;, &quot;foo6&quot;, &quot;foo7&quot;)));
672         assertEquals(5, set.size());
673     }
674 
<span class="line-added">675     @Test</span>
<span class="line-added">676     public void synchronizedMapIterationProtectionTest() {</span>
<span class="line-added">677         testIterationProtection(FXCollections.synchronizedObservableMap(FXCollections.observableHashMap()), this::putRandomValue, this::copyMap);</span>
<span class="line-added">678     }</span>
<span class="line-added">679 </span>
<span class="line-added">680     private void putRandomValue(Map&lt;Integer, Integer&gt; map, Random rnd) {</span>
<span class="line-added">681         map.put(rnd.nextInt(1000), rnd.nextInt());</span>
<span class="line-added">682     }</span>
<span class="line-added">683 </span>
<span class="line-added">684     private void copyMap(Map&lt;Integer, Integer&gt; map) {</span>
<span class="line-added">685         new HashMap&lt;&gt;(map);</span>
<span class="line-added">686     }</span>
<span class="line-added">687 </span>
<span class="line-added">688     @Test</span>
<span class="line-added">689     public void synchronizedSetIterationProtectionTest() {</span>
<span class="line-added">690         testIterationProtection(FXCollections.synchronizedObservableSet(FXCollections.observableSet()), this::addRandomValue, this::copySet);</span>
<span class="line-added">691     }</span>
<span class="line-added">692 </span>
<span class="line-added">693     private void addRandomValue(Set&lt;Integer&gt; set, Random rnd) {</span>
<span class="line-added">694         set.add(rnd.nextInt(1000));</span>
<span class="line-added">695     }</span>
<span class="line-added">696 </span>
<span class="line-added">697     private void copySet(Set&lt;Integer&gt; set) {</span>
<span class="line-added">698         new HashSet&lt;&gt;(set);</span>
<span class="line-added">699     }</span>
<span class="line-added">700 </span>
<span class="line-added">701     @Test</span>
<span class="line-added">702     public void synchronizedListIterationProtectionTest() {</span>
<span class="line-added">703         testIterationProtection(FXCollections.synchronizedObservableList(FXCollections.observableArrayList()), this::modifyList, this::iterateOverList);</span>
<span class="line-added">704     }</span>
<span class="line-added">705 </span>
<span class="line-added">706     private void modifyList(List&lt;Integer&gt; list, Random rnd) {</span>
<span class="line-added">707         if (rnd.nextInt(1000) &gt; list.size()) {</span>
<span class="line-added">708             list.add(rnd.nextInt(1000));</span>
<span class="line-added">709         } else {</span>
<span class="line-added">710             list.remove(rnd.nextInt(list.size()));</span>
<span class="line-added">711         }</span>
<span class="line-added">712     }</span>
<span class="line-added">713 </span>
<span class="line-added">714     private void iterateOverList(List&lt;Integer&gt; list) {</span>
<span class="line-added">715         Iterator&lt;Integer&gt; it = list.iterator();</span>
<span class="line-added">716         while (it.hasNext()) {</span>
<span class="line-added">717             it.next();</span>
<span class="line-added">718         }</span>
<span class="line-added">719     }</span>
<span class="line-added">720 </span>
<span class="line-added">721     public &lt;V&gt; void testIterationProtection(V collection, BiConsumer&lt;V, Random&gt; backgroundChanger, Consumer&lt;V&gt; protectedCode) {</span>
<span class="line-added">722         CollectionChangeThread&lt;V&gt; thread = new CollectionChangeThread&lt;&gt;(collection, backgroundChanger);</span>
<span class="line-added">723         thread.start();</span>
<span class="line-added">724         for (int i = 0; i &lt; 10000; i++) {</span>
<span class="line-added">725             try {</span>
<span class="line-added">726                 synchronized (collection) {</span>
<span class="line-added">727                     protectedCode.accept(collection);</span>
<span class="line-added">728                 }</span>
<span class="line-added">729             } catch (ConcurrentModificationException e) {</span>
<span class="line-added">730                 fail(&quot;ConcurrentModificationException should not be thrown&quot;);</span>
<span class="line-added">731             }</span>
<span class="line-added">732         }</span>
<span class="line-added">733         thread.terminate();</span>
<span class="line-added">734     }</span>
<span class="line-added">735 </span>
<span class="line-added">736     private static class CollectionChangeThread&lt;V&gt; extends Thread {</span>
<span class="line-added">737         private boolean shallRun = true;</span>
<span class="line-added">738         private V collection;</span>
<span class="line-added">739         private BiConsumer&lt;V, Random&gt; backgroundChanger;</span>
<span class="line-added">740         private Random rnd = new Random();</span>
<span class="line-added">741 </span>
<span class="line-added">742         public CollectionChangeThread(V collection, BiConsumer&lt;V, Random&gt; backgroundChanger) {</span>
<span class="line-added">743             super(&quot;FXCollectionsTest.CollectionChangeThread&quot;);</span>
<span class="line-added">744             this.collection = collection;</span>
<span class="line-added">745             this.backgroundChanger = backgroundChanger;</span>
<span class="line-added">746         }</span>
<span class="line-added">747 </span>
<span class="line-added">748         @Override</span>
<span class="line-added">749         public void run() {</span>
<span class="line-added">750             while (shallRun) {</span>
<span class="line-added">751                 backgroundChanger.accept(collection, rnd);</span>
<span class="line-added">752             }</span>
<span class="line-added">753         }</span>
<span class="line-added">754 </span>
<span class="line-added">755         public void terminate() {</span>
<span class="line-added">756             shallRun = false;</span>
<span class="line-added">757         }</span>
<span class="line-added">758     }</span>
<span class="line-added">759 </span>
<span class="line-added">760 </span>
761     @Test
762     public void synchronizedMapIterationProtectionTest() {
763         testIterationProtection(FXCollections.synchronizedObservableMap(FXCollections.observableHashMap()), this::putRandomValue, this::copyMap);
764     }
765 
766     private void putRandomValue(Map&lt;Integer, Integer&gt; map, Random rnd) {
767         map.put(rnd.nextInt(1000), rnd.nextInt());
768     }
769 
770     private void copyMap(Map&lt;Integer, Integer&gt; map) {
771         new HashMap&lt;&gt;(map);
772     }
773 
774     @Test
775     public void synchronizedSetIterationProtectionTest() {
776         testIterationProtection(FXCollections.synchronizedObservableSet(FXCollections.observableSet()), this::addRandomValue, this::copySet);
777     }
778 
779     private void addRandomValue(Set&lt;Integer&gt; set, Random rnd) {
780         set.add(rnd.nextInt(1000));
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../main/java/javafx/collections/FXCollections.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../javafx.web/src/main/java/javafx/scene/web/WebView.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>