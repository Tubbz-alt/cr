<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.graphics/src/main/native-glass/gtk/glass_dnd.cpp</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="GlassWindow.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="glass_window.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.graphics/src/main/native-glass/gtk/glass_dnd.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -36,41 +36,39 @@</span>
  #include &lt;gtk/gtk.h&gt;
  #include &lt;gdk/gdkx.h&gt;
  #include &lt;gdk/gdkkeysyms.h&gt;
  
  /************************* COMMON *********************************************/
<span class="udiff-line-modified-removed">- static jint translate_gdk_action_to_glass(GdkDragAction action)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+ static jint translate_gdk_action_to_glass(GdkDragAction action) {</span>
      jint result = 0;
<span class="udiff-line-modified-removed">-     result |= (action &amp; GDK_ACTION_COPY)? com_sun_glass_ui_gtk_GtkDnDClipboard_ACTION_COPY : 0;</span>
<span class="udiff-line-modified-removed">-     result |= (action &amp; GDK_ACTION_MOVE)? com_sun_glass_ui_gtk_GtkDnDClipboard_ACTION_MOVE : 0;</span>
<span class="udiff-line-modified-removed">-     result |= (action &amp; GDK_ACTION_LINK)? com_sun_glass_ui_gtk_GtkDnDClipboard_ACTION_REFERENCE : 0;</span>
<span class="udiff-line-modified-added">+     result |= (action &amp; GDK_ACTION_COPY) ? com_sun_glass_ui_gtk_GtkDnDClipboard_ACTION_COPY : 0;</span>
<span class="udiff-line-modified-added">+     result |= (action &amp; GDK_ACTION_MOVE) ? com_sun_glass_ui_gtk_GtkDnDClipboard_ACTION_MOVE : 0;</span>
<span class="udiff-line-modified-added">+     result |= (action &amp; GDK_ACTION_LINK) ? com_sun_glass_ui_gtk_GtkDnDClipboard_ACTION_REFERENCE : 0;</span>
      return result;
  }
  
<span class="udiff-line-modified-removed">- static GdkDragAction translate_glass_action_to_gdk(jint action)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+ static GdkDragAction translate_glass_action_to_gdk(jint action) {</span>
      int result = 0;
      result |= (action &amp; com_sun_glass_ui_gtk_GtkDnDClipboard_ACTION_COPY) ? GDK_ACTION_COPY : 0;
      result |= (action &amp; com_sun_glass_ui_gtk_GtkDnDClipboard_ACTION_MOVE) ? GDK_ACTION_MOVE : 0;
      result |= (action &amp; com_sun_glass_ui_gtk_GtkDnDClipboard_ACTION_REFERENCE) ? GDK_ACTION_LINK : 0;
      return static_cast&lt;GdkDragAction&gt;(result);
  }
  
<span class="udiff-line-modified-removed">- static void clear_global_ref(gpointer data)</span>
<span class="udiff-line-modified-removed">- {</span>
<span class="udiff-line-removed">-     mainEnv-&gt;DeleteGlobalRef((jobject)data);</span>
<span class="udiff-line-modified-added">+ static void clear_global_ref(gpointer data) {</span>
<span class="udiff-line-modified-added">+     mainEnv-&gt;DeleteGlobalRef((jobject) data);</span>
  }
  
  static void dnd_set_performed_action(jint performed_action);
<span class="udiff-line-added">+ </span>
  static jint dnd_get_performed_action();
  
  enum {
<span class="udiff-line-modified-removed">-   TARGET_TEXT,</span>
<span class="udiff-line-modified-removed">-   TARGET_IMAGE,</span>
<span class="udiff-line-modified-removed">-   TARGET_URI,</span>
<span class="udiff-line-modified-removed">-   TARGET_RAW</span>
<span class="udiff-line-modified-added">+     TARGET_TEXT,</span>
<span class="udiff-line-modified-added">+     TARGET_IMAGE,</span>
<span class="udiff-line-modified-added">+     TARGET_URI,</span>
<span class="udiff-line-modified-added">+     TARGET_RAW</span>
  };
  
  /************************* TARGET *********************************************/
  
  static struct {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -93,18 +91,18 @@</span>
      }
  
      memset(&amp;target_ctx, 0, sizeof(target_ctx));
  }
  
<span class="udiff-line-modified-removed">- static gboolean dnd_drag_motion_callback(GtkWidget      *widget,</span>
<span class="udiff-line-modified-added">+ static gboolean dnd_drag_motion_callback(GtkWidget *widget,</span>
                                           GdkDragContext *context,
<span class="udiff-line-modified-removed">-                                          gint            x,</span>
<span class="udiff-line-modified-removed">-                                          gint            y,</span>
<span class="udiff-line-modified-removed">-                                          guint           time,</span>
<span class="udiff-line-modified-removed">-                                          gpointer        user_data) {</span>
<span class="udiff-line-modified-added">+                                          gint x,</span>
<span class="udiff-line-modified-added">+                                          gint y,</span>
<span class="udiff-line-modified-added">+                                          guint time,</span>
<span class="udiff-line-modified-added">+                                          gpointer user_data) {</span>
  
<span class="udiff-line-modified-removed">-     WindowContext* ctx = (WindowContext*)user_data;</span>
<span class="udiff-line-modified-added">+     WindowContext *ctx = (WindowContext *) user_data;</span>
  
      if (target_ctx.ctx == NULL || (target_ctx.ctx != context &amp;&amp; !target_ctx.just_entered)) {
          reset_target_ctx();
          is_dnd_owner = is_in_drag();
          target_ctx.ctx = context;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -116,13 +114,14 @@</span>
  
      jmethodID method = target_ctx.just_entered ? jViewNotifyDragEnter : jViewNotifyDragOver;
  
      GdkDragAction suggested = gdk_drag_context_get_suggested_action(context);
      GdkDragAction result = translate_glass_action_to_gdk(mainEnv-&gt;CallIntMethod(ctx-&gt;get_jview(), method,
<span class="udiff-line-modified-removed">-             (jint)x, (jint)y,</span>
<span class="udiff-line-modified-removed">-             (jint)x_abs, (jint)y_abs,</span>
<span class="udiff-line-modified-removed">-             translate_gdk_action_to_glass(suggested)));</span>
<span class="udiff-line-modified-added">+                                                                                 (jint) x, (jint) y,</span>
<span class="udiff-line-modified-added">+                                                                                 (jint) x_abs, (jint) y_abs,</span>
<span class="udiff-line-modified-added">+                                                                                 translate_gdk_action_to_glass(</span>
<span class="udiff-line-added">+                                                                                         suggested)));</span>
      CHECK_JNI_EXCEPTION_RET(mainEnv, FALSE)
  
      if (target_ctx.just_entered) {
          target_ctx.just_entered = FALSE;
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -130,16 +129,16 @@</span>
      gdk_drag_status(context, result, GDK_CURRENT_TIME);
  
      return (gboolean) result;
  }
  
<span class="udiff-line-modified-removed">- static gboolean dnd_drag_drop_callback(GtkWidget      *widget,</span>
<span class="udiff-line-modified-removed">-                                       GdkDragContext *context,</span>
<span class="udiff-line-modified-removed">-                                       gint            x,</span>
<span class="udiff-line-modified-removed">-                                       gint            y,</span>
<span class="udiff-line-modified-removed">-                                       guint           time,</span>
<span class="udiff-line-modified-removed">-                                       gpointer        user_data) {</span>
<span class="udiff-line-modified-added">+ static gboolean dnd_drag_drop_callback(GtkWidget *widget,</span>
<span class="udiff-line-modified-added">+                                        GdkDragContext *context,</span>
<span class="udiff-line-modified-added">+                                        gint x,</span>
<span class="udiff-line-modified-added">+                                        gint y,</span>
<span class="udiff-line-modified-added">+                                        guint time,</span>
<span class="udiff-line-modified-added">+                                        gpointer user_data) {</span>
      if (target_ctx.ctx == NULL || target_ctx.just_entered) {
          return FALSE; // Do not process drop events if no enter event and subsequent motion event were received
      }
  
      GdkAtom target = gtk_drag_dest_find_target(widget, context, NULL);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -152,20 +151,19 @@</span>
      gtk_drag_get_data(widget, context, target, GDK_CURRENT_TIME);
  
      return TRUE;
  }
  
<span class="udiff-line-modified-removed">- static void dnd_on_drag_data_received_callback(GtkWidget        *widget,</span>
<span class="udiff-line-modified-removed">-                                                GdkDragContext   *context,</span>
<span class="udiff-line-modified-removed">-                                                gint              x,</span>
<span class="udiff-line-modified-removed">-                                                gint              y,</span>
<span class="udiff-line-modified-added">+ static void dnd_on_drag_data_received_callback(GtkWidget *widget,</span>
<span class="udiff-line-modified-added">+                                                GdkDragContext *context,</span>
<span class="udiff-line-modified-added">+                                                gint x,</span>
<span class="udiff-line-modified-added">+                                                gint y,</span>
                                                 GtkSelectionData *data,
<span class="udiff-line-modified-removed">-                                                guint             info,</span>
<span class="udiff-line-modified-removed">-                                                guint             time,</span>
<span class="udiff-line-modified-removed">-                                                gpointer          user_data)</span>
<span class="udiff-line-modified-removed">- {</span>
<span class="udiff-line-removed">-     WindowContext* ctx = (WindowContext*)user_data;</span>
<span class="udiff-line-modified-added">+                                                guint info,</span>
<span class="udiff-line-modified-added">+                                                guint time,</span>
<span class="udiff-line-modified-added">+                                                gpointer user_data) {</span>
<span class="udiff-line-modified-added">+     WindowContext *ctx = (WindowContext *) user_data;</span>
  
      if (gtk_selection_data_get_length(data) == 0) {
          gtk_drag_finish(context, FALSE, FALSE, GDK_CURRENT_TIME);
          reset_target_ctx();
          return;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -176,30 +174,30 @@</span>
      GdkDragAction selected = gdk_drag_context_get_selected_action(context);
      target_ctx.data = data;
  
      // Delay the notify for when we have the data
      mainEnv-&gt;CallIntMethod(ctx-&gt;get_jview(), jViewNotifyDragDrop,
<span class="udiff-line-modified-removed">-                            (jint)x, (jint)y,</span>
<span class="udiff-line-modified-removed">-                            (jint)x_abs, (jint)y_abs,</span>
<span class="udiff-line-modified-added">+                            (jint) x, (jint) y,</span>
<span class="udiff-line-modified-added">+                            (jint) x_abs, (jint) y_abs,</span>
                             translate_gdk_action_to_glass(selected));
      LOG_EXCEPTION(mainEnv)
  
      gtk_drag_finish(context, selected, selected == GDK_ACTION_MOVE, GDK_CURRENT_TIME);
  }
  
<span class="udiff-line-modified-removed">- void dnd_drag_leave_callback(WindowContext* ctx) {</span>
<span class="udiff-line-modified-added">+ void dnd_drag_leave_callback(WindowContext *ctx) {</span>
      mainEnv-&gt;CallVoidMethod(ctx-&gt;get_jview(), jViewNotifyDragLeave, NULL);
      CHECK_JNI_EXCEPTION(mainEnv)
  
      reset_target_ctx();
  }
  
  void glass_dnd_attach_context(WindowContext *ctx) {
<span class="udiff-line-modified-removed">-     gtk_drag_dest_set(ctx-&gt;get_gtk_widget(), (GtkDestDefaults)0, NULL, 0,</span>
<span class="udiff-line-modified-added">+     gtk_drag_dest_set(ctx-&gt;get_gtk_widget(), (GtkDestDefaults) 0, NULL, 0,</span>
                        (GdkDragAction)(GDK_ACTION_COPY | GDK_ACTION_MOVE | GDK_ACTION_LINK));
  
<span class="udiff-line-modified-removed">-     GtkTargetList *target_list = gtk_target_list_new (NULL, 0);</span>
<span class="udiff-line-modified-added">+     GtkTargetList *target_list = gtk_target_list_new(NULL, 0);</span>
      gtk_target_list_add_image_targets(target_list, TARGET_IMAGE, TRUE);
      gtk_target_list_add_uri_targets(target_list, TARGET_URI);
      gtk_target_list_add_text_targets(target_list, TARGET_TEXT);
      gtk_target_list_add(target_list, gdk_atom_intern_static_string(&quot;&quot;), 0, TARGET_RAW);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -208,41 +206,39 @@</span>
      g_signal_connect(ctx-&gt;get_gtk_widget(), &quot;drag-motion&quot;, G_CALLBACK(dnd_drag_motion_callback), ctx);
      g_signal_connect(ctx-&gt;get_gtk_widget(), &quot;drag-drop&quot;, G_CALLBACK(dnd_drag_drop_callback), ctx);
      g_signal_connect(ctx-&gt;get_gtk_widget(), &quot;drag-data-received&quot;, G_CALLBACK(dnd_on_drag_data_received_callback), ctx);
  }
  
<span class="udiff-line-modified-removed">- static gboolean check_state_in_drag(JNIEnv *env)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+ static gboolean check_state_in_drag(JNIEnv *env) {</span>
      if (!target_ctx.ctx) {
          jclass jc = env-&gt;FindClass(&quot;java/lang/IllegalStateException&quot;);
          if (!env-&gt;ExceptionCheck()) {
              env-&gt;ThrowNew(jc,
<span class="udiff-line-modified-removed">-                     &quot;Cannot get supported actions. Drag pointer haven&#39;t entered the application window&quot;);</span>
<span class="udiff-line-modified-added">+                           &quot;Cannot get supported actions. Drag pointer haven&#39;t entered the application window&quot;);</span>
          }
          return TRUE;
      }
      return FALSE;
  }
  
<span class="udiff-line-modified-removed">- static GdkAtom* get_target_ctx_target_atoms(gint *size) {</span>
<span class="udiff-line-modified-removed">-     GList* targets = gdk_drag_context_list_targets(target_ctx.ctx);</span>
<span class="udiff-line-modified-removed">-     gint s = (gint)g_list_length(targets);</span>
<span class="udiff-line-modified-removed">-     GdkAtom* atoms = (GdkAtom*) g_try_malloc0(sizeof(GdkAtom)*s);</span>
<span class="udiff-line-modified-added">+ static GdkAtom *get_target_ctx_target_atoms(gint *size) {</span>
<span class="udiff-line-modified-added">+     GList *targets = gdk_drag_context_list_targets(target_ctx.ctx);</span>
<span class="udiff-line-modified-added">+     gint s = (gint) g_list_length(targets);</span>
<span class="udiff-line-modified-added">+     GdkAtom *atoms = (GdkAtom *) g_try_malloc0(sizeof(GdkAtom) * s);</span>
  
      int i = 0;
      for (; targets != NULL; targets = targets-&gt;next) {
<span class="udiff-line-modified-removed">-         atoms[i++] = (GdkAtom)targets-&gt;data;</span>
<span class="udiff-line-modified-added">+         atoms[i++] = (GdkAtom) targets-&gt;data;</span>
      }
  
      *size = s;
  
      g_list_free(targets);
      return atoms;
  }
  
<span class="udiff-line-modified-removed">- jobjectArray dnd_target_get_mimes(JNIEnv *env)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+ jobjectArray dnd_target_get_mimes(JNIEnv *env) {</span>
      if (check_state_in_drag(env)) {
          return NULL;
      }
  
      if (!target_ctx.mimes) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -257,11 +253,12 @@</span>
              jstring jStr = env-&gt;NewStringUTF(&quot;application/x-java-rawimage&quot;);
              EXCEPTION_OCCURED(env);
              env-&gt;CallBooleanMethod(set, jSetAdd, jStr, NULL);
              EXCEPTION_OCCURED(env);
              was_set = TRUE;
<span class="udiff-line-modified-removed">-         }  if (gtk_targets_include_uri(targets, size)) {</span>
<span class="udiff-line-modified-added">+         }</span>
<span class="udiff-line-added">+         if (gtk_targets_include_uri(targets, size)) {</span>
              // it&#39;s a possibility
              jstring jStr = env-&gt;NewStringUTF(&quot;application/x-java-file-list&quot;);
              EXCEPTION_OCCURED(env);
              env-&gt;CallBooleanMethod(set, jSetAdd, jStr, NULL);
              EXCEPTION_OCCURED(env);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -291,65 +288,61 @@</span>
              EXCEPTION_OCCURED(env);
              g_free(name);
          }
  
          target_ctx.mimes = env-&gt;NewObjectArray(env-&gt;CallIntMethod(set, jSetSize, NULL),
<span class="udiff-line-modified-removed">-                 jStringCls, NULL);</span>
<span class="udiff-line-modified-added">+                                                jStringCls, NULL);</span>
          EXCEPTION_OCCURED(env);
<span class="udiff-line-modified-removed">-         target_ctx.mimes = (jobjectArray)env-&gt;CallObjectMethod(set, jSetToArray, target_ctx.mimes, NULL);</span>
<span class="udiff-line-modified-removed">-         target_ctx.mimes = (jobjectArray)env-&gt;NewGlobalRef(target_ctx.mimes);</span>
<span class="udiff-line-modified-added">+         target_ctx.mimes = (jobjectArray) env-&gt;CallObjectMethod(set, jSetToArray, target_ctx.mimes, NULL);</span>
<span class="udiff-line-modified-added">+         target_ctx.mimes = (jobjectArray) env-&gt;NewGlobalRef(target_ctx.mimes);</span>
      }
  
      return target_ctx.mimes;
  }
  
<span class="udiff-line-modified-removed">- jint dnd_target_get_supported_actions(JNIEnv *env)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+ jint dnd_target_get_supported_actions(JNIEnv *env) {</span>
      if (check_state_in_drag(env)) {
          return 0;
      }
      return translate_gdk_action_to_glass(gdk_drag_context_get_actions(target_ctx.ctx));
  }
  
<span class="udiff-line-modified-removed">- static jobject dnd_target_get_string(JNIEnv *env)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+ static jobject dnd_target_get_string(JNIEnv *env) {</span>
      jobject result = NULL;
  
      GdkAtom atom = gtk_selection_data_get_data_type(target_ctx.data);
<span class="udiff-line-modified-removed">-     guchar* data = gtk_selection_data_get_text(target_ctx.data);</span>
<span class="udiff-line-modified-added">+     guchar *data = gtk_selection_data_get_text(target_ctx.data);</span>
  
      if (data) {
<span class="udiff-line-modified-removed">-         result = env-&gt;NewStringUTF((char *)data);</span>
<span class="udiff-line-modified-added">+         result = env-&gt;NewStringUTF((char *) data);</span>
          EXCEPTION_OCCURED(env);
  
          g_free(data);
      }
  
      return result;
  }
  
<span class="udiff-line-modified-removed">- static jobject dnd_target_get_list(JNIEnv *env, gboolean files)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+ static jobject dnd_target_get_list(JNIEnv *env, gboolean files) {</span>
      jobject result = NULL;
      GdkAtom atom = gtk_selection_data_get_selection(target_ctx.data);
<span class="udiff-line-modified-removed">-     gchar** data = gtk_selection_data_get_uris(target_ctx.data);</span>
<span class="udiff-line-modified-added">+     gchar **data = gtk_selection_data_get_uris(target_ctx.data);</span>
  
      if (data) {
          result = uris_to_java(env, data, files);
          // uris_to_java frees it
          //g_strfreev(data);
      }
  
      return result;
  }
  
<span class="udiff-line-modified-removed">- static jobject dnd_target_get_image(JNIEnv *env)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+ static jobject dnd_target_get_image(JNIEnv *env) {</span>
      jobject result = NULL;
  
      GdkAtom atom = gtk_selection_data_get_selection(target_ctx.data);
<span class="udiff-line-modified-removed">-     GdkPixbuf* buf = gtk_selection_data_get_pixbuf(target_ctx.data);</span>
<span class="udiff-line-modified-added">+     GdkPixbuf *buf = gtk_selection_data_get_pixbuf(target_ctx.data);</span>
  
      if (buf == NULL) {
          return NULL;
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -371,14 +364,14 @@</span>
      stride = gdk_pixbuf_get_rowstride(buf);
  
      cdata = gdk_pixbuf_get_pixels(buf);
  
      //Actually, we are converting RGBA to BGRA, but that&#39;s the same operation
<span class="udiff-line-modified-removed">-     cdata = (guchar*) convert_BGRA_to_RGBA((int*) cdata, stride, h);</span>
<span class="udiff-line-modified-added">+     cdata = (guchar *) convert_BGRA_to_RGBA((int *) cdata, stride, h);</span>
      data_array = env-&gt;NewByteArray(stride * h);
      EXCEPTION_OCCURED(env);
<span class="udiff-line-modified-removed">-     env-&gt;SetByteArrayRegion(data_array, 0, stride*h, (jbyte*) cdata);</span>
<span class="udiff-line-modified-added">+     env-&gt;SetByteArrayRegion(data_array, 0, stride * h, (jbyte *) cdata);</span>
      EXCEPTION_OCCURED(env);
  
      buffer = env-&gt;CallStaticObjectMethod(jByteBufferCls, jByteBufferWrap, data_array);
      EXCEPTION_OCCURED(env);
      result = env-&gt;NewObject(jGtkPixelsCls, jGtkPixelsInit, w, h, buffer);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -388,35 +381,33 @@</span>
      g_free(cdata);
  
      return result;
  }
  
<span class="udiff-line-modified-removed">- static jobject dnd_target_get_raw(JNIEnv *env, GdkAtom target, gboolean string_data)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+ static jobject dnd_target_get_raw(JNIEnv *env, GdkAtom target, gboolean string_data) {</span>
      jobject result = NULL;
      GdkAtom atom = gtk_selection_data_get_selection(target_ctx.data);
<span class="udiff-line-modified-removed">-     const guchar* data = gtk_selection_data_get_data(target_ctx.data);</span>
<span class="udiff-line-modified-added">+     const guchar *data = gtk_selection_data_get_data(target_ctx.data);</span>
  
      if (string_data) {
<span class="udiff-line-modified-removed">-          result = env-&gt;NewStringUTF((char *)data);</span>
<span class="udiff-line-modified-removed">-          EXCEPTION_OCCURED(env);</span>
<span class="udiff-line-modified-added">+         result = env-&gt;NewStringUTF((char *) data);</span>
<span class="udiff-line-modified-added">+         EXCEPTION_OCCURED(env);</span>
      } else {
          gint length = gtk_selection_data_get_length(target_ctx.data);
  
<span class="udiff-line-modified-removed">-         jbyteArray array = env-&gt;NewByteArray((jsize)length);</span>
<span class="udiff-line-modified-added">+         jbyteArray array = env-&gt;NewByteArray((jsize) length);</span>
          EXCEPTION_OCCURED(env);
<span class="udiff-line-modified-removed">-         env-&gt;SetByteArrayRegion(array, 0, length, (const jbyte*)data);</span>
<span class="udiff-line-modified-added">+         env-&gt;SetByteArrayRegion(array, 0, length, (const jbyte *) data);</span>
          EXCEPTION_OCCURED(env);
          result = env-&gt;CallStaticObjectMethod(jByteBufferCls, jByteBufferWrap, array);
          EXCEPTION_OCCURED(env);
      }
  
      return result;
  }
  
<span class="udiff-line-modified-removed">- jobject dnd_target_get_data(JNIEnv *env, jstring mime)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+ jobject dnd_target_get_data(JNIEnv *env, jstring mime) {</span>
      jobject ret = NULL;
  
      if (check_state_in_drag(env)) {
          return NULL;
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -429,11 +420,11 @@</span>
          ret = dnd_target_get_list(env, FALSE);
      } else if (g_str_has_prefix(cmime, &quot;text/&quot;)) {
          ret = dnd_target_get_raw(env, gdk_atom_intern(cmime, FALSE), TRUE);
      } else if (g_strcmp0(cmime, &quot;application/x-java-file-list&quot;) == 0) {
          ret = dnd_target_get_list(env, TRUE);
<span class="udiff-line-modified-removed">-     } else if (g_strcmp0(cmime, &quot;application/x-java-rawimage&quot;) == 0 ) {</span>
<span class="udiff-line-modified-added">+     } else if (g_strcmp0(cmime, &quot;application/x-java-rawimage&quot;) == 0) {</span>
          ret = dnd_target_get_image(env);
      } else {
          ret = dnd_target_get_raw(env, gdk_atom_intern(cmime, FALSE), FALSE);
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -445,90 +436,83 @@</span>
  
  /************************* SOURCE *********************************************/
  
  static jint dnd_performed_action;
  
<span class="udiff-line-modified-removed">- const char * const SOURCE_DND_DATA = &quot;fx-dnd-data&quot;;</span>
<span class="udiff-line-modified-added">+ const char *const SOURCE_DND_DATA = &quot;fx-dnd-data&quot;;</span>
  
<span class="udiff-line-modified-removed">- static void dnd_set_performed_action(jint performed_action)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+ static void dnd_set_performed_action(jint performed_action) {</span>
      dnd_performed_action = performed_action;
  }
  
<span class="udiff-line-modified-removed">- static jint dnd_get_performed_action()</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+ static jint dnd_get_performed_action() {</span>
      return dnd_performed_action;
  }
  
<span class="udiff-line-modified-removed">- static void pixbufDestroyNotifyFunc(guchar *pixels, gpointer)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+ static void pixbufDestroyNotifyFunc(guchar *pixels, gpointer) {</span>
      if (pixels != NULL) {
          g_free(pixels);
      }
  }
  
<span class="udiff-line-modified-removed">- static jobject dnd_source_get_data(GtkWidget *widget, const char *key)</span>
<span class="udiff-line-modified-removed">- {</span>
<span class="udiff-line-removed">-     jobject data = (jobject)g_object_get_data(G_OBJECT(widget), SOURCE_DND_DATA);</span>
<span class="udiff-line-modified-added">+ static jobject dnd_source_get_data(GtkWidget *widget, const char *key) {</span>
<span class="udiff-line-modified-added">+     jobject data = (jobject) g_object_get_data(G_OBJECT(widget), SOURCE_DND_DATA);</span>
      jstring string = mainEnv-&gt;NewStringUTF(key);
      EXCEPTION_OCCURED(mainEnv);
      jobject result = mainEnv-&gt;CallObjectMethod(data, jMapGet, string, NULL);
  
      return (EXCEPTION_OCCURED(mainEnv)) ? NULL : result;
  }
  
<span class="udiff-line-modified-removed">- static void add_gtk_target_from_jstring(JNIEnv *env, GtkTargetList **list, jstring string, guint flags)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+ static void add_gtk_target_from_jstring(JNIEnv *env, GtkTargetList **list, jstring string, guint flags) {</span>
      const char *gstring = env-&gt;GetStringUTFChars(string, NULL);
  
      if (g_strcmp0(gstring, &quot;text/plain&quot;) == 0) {
          gtk_target_list_add_text_targets(*list, TARGET_TEXT);
      } else if (g_strcmp0(gstring, &quot;application/x-java-rawimage&quot;) == 0) {
          gtk_target_list_add_image_targets(*list, TARGET_IMAGE, TRUE);
      } else if (g_strcmp0(gstring, &quot;application/x-java-file-list&quot;) == 0) {
          gtk_target_list_add_uri_targets(*list, TARGET_URI);
      } else if (g_strcmp0(gstring, &quot;application/x-java-drag-image&quot;) == 0
<span class="udiff-line-modified-removed">-         || g_strcmp0(gstring, &quot;application/x-java-drag-image-offset&quot;) == 0) {</span>
<span class="udiff-line-modified-added">+                || g_strcmp0(gstring, &quot;application/x-java-drag-image-offset&quot;) == 0) {</span>
          // do nothing - those are DragView information
      } else {
          GdkAtom atom = gdk_atom_intern(gstring, FALSE);
          gtk_target_list_add(*list, atom, flags, TARGET_RAW);
      }
  
      env-&gt;ReleaseStringUTFChars(string, gstring);
  }
  
<span class="udiff-line-modified-removed">- static GtkTargetList* data_to_gtk_target_list(JNIEnv *env, jobject data)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+ static GtkTargetList *data_to_gtk_target_list(JNIEnv *env, jobject data) {</span>
      guint flags = GTK_TARGET_OTHER_APP | GTK_TARGET_SAME_APP;
  
      jobject keys;
      jobject keysIterator;
      jstring next;
  
<span class="udiff-line-modified-removed">-     GtkTargetList *tlist = gtk_target_list_new (NULL, 0);</span>
<span class="udiff-line-modified-added">+     GtkTargetList *tlist = gtk_target_list_new(NULL, 0);</span>
  
      gint added_count = 0;
  
      keys = env-&gt;CallObjectMethod(data, jMapKeySet, NULL);
      JNI_EXCEPTION_TO_CPP(env)
      keysIterator = env-&gt;CallObjectMethod(keys, jIterableIterator, NULL);
      JNI_EXCEPTION_TO_CPP(env)
      while (env-&gt;CallBooleanMethod(keysIterator, jIteratorHasNext) == JNI_TRUE) {
<span class="udiff-line-modified-removed">-         next = (jstring)env-&gt;CallObjectMethod(keysIterator, jIteratorNext, NULL);</span>
<span class="udiff-line-modified-added">+         next = (jstring) env-&gt;CallObjectMethod(keysIterator, jIteratorNext, NULL);</span>
          JNI_EXCEPTION_TO_CPP(env)
          add_gtk_target_from_jstring(env, &amp;tlist, next, flags);
      }
  
      return tlist;
  }
  
<span class="udiff-line-modified-removed">- static gboolean dnd_source_set_string(GtkWidget *widget, GtkSelectionData *data, GdkAtom atom)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+ static gboolean dnd_source_set_string(GtkWidget *widget, GtkSelectionData *data, GdkAtom atom) {</span>
      gboolean is_data_set;
  
<span class="udiff-line-modified-removed">-     jstring string = (jstring)dnd_source_get_data(widget, &quot;text/plain&quot;);</span>
<span class="udiff-line-modified-added">+     jstring string = (jstring) dnd_source_get_data(widget, &quot;text/plain&quot;);</span>
      if (!string) {
          return FALSE;
      }
  
      const char *cstring = mainEnv-&gt;GetStringUTFChars(string, NULL);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -538,21 +522,20 @@</span>
      mainEnv-&gt;ReleaseStringUTFChars(string, cstring);
  
      return is_data_set;
  }
  
<span class="udiff-line-modified-removed">- static gboolean dnd_source_set_image(GtkWidget *widget, GtkSelectionData *data, GdkAtom atom)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+ static gboolean dnd_source_set_image(GtkWidget *widget, GtkSelectionData *data, GdkAtom atom) {</span>
      jobject pixels = dnd_source_get_data(widget, &quot;application/x-java-rawimage&quot;);
      if (!pixels) {
          g_warning(&quot;DND source failed to set image\n&quot;);
          return FALSE;
      }
  
      gchar *buffer;
      gsize size;
<span class="udiff-line-modified-removed">-     const char * type;</span>
<span class="udiff-line-modified-added">+     const char *type;</span>
      GdkPixbuf *pixbuf = NULL;
      gboolean is_data_set;
  
      mainEnv-&gt;CallVoidMethod(pixels, jPixelsAttachData, PTR_TO_JLONG(&amp;pixbuf));
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -563,13 +546,12 @@</span>
      g_object_unref(pixbuf);
  
      return is_data_set;
  }
  
<span class="udiff-line-modified-removed">- static gboolean dnd_source_set_uri(GtkWidget *widget, GtkSelectionData *data, GdkAtom atom)</span>
<span class="udiff-line-modified-removed">- {</span>
<span class="udiff-line-removed">-     const gchar* url = NULL;</span>
<span class="udiff-line-modified-added">+ static gboolean dnd_source_set_uri(GtkWidget *widget, GtkSelectionData *data, GdkAtom atom) {</span>
<span class="udiff-line-modified-added">+     const gchar *url = NULL;</span>
      jstring jurl = NULL;
  
      jobjectArray files_array = NULL;
      gsize files_cnt = 0;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -584,18 +566,18 @@</span>
      if (!url &amp;&amp; !files_cnt) {
          return FALSE;
      }
  
      gboolean is_data_set;
<span class="udiff-line-modified-removed">-     GString* res = g_string_new (NULL); //http://www.ietf.org/rfc/rfc2483.txt</span>
<span class="udiff-line-modified-added">+     GString *res = g_string_new(NULL); //http://www.ietf.org/rfc/rfc2483.txt</span>
  
      if (files_cnt &gt; 0) {
          for (gsize i = 0; i &lt; files_cnt; ++i) {
              jstring string = (jstring) mainEnv-&gt;GetObjectArrayElement(files_array, i);
              EXCEPTION_OCCURED(mainEnv);
<span class="udiff-line-modified-removed">-             const gchar* file = mainEnv-&gt;GetStringUTFChars(string, NULL);</span>
<span class="udiff-line-modified-removed">-             gchar* uri = g_filename_to_uri(file, NULL, NULL);</span>
<span class="udiff-line-modified-added">+             const gchar *file = mainEnv-&gt;GetStringUTFChars(string, NULL);</span>
<span class="udiff-line-modified-added">+             gchar *uri = g_filename_to_uri(file, NULL, NULL);</span>
  
              g_string_append(res, uri);
              g_string_append(res, URI_LIST_LINE_BREAK);
  
              g_free(uri);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -617,26 +599,25 @@</span>
      g_free(uri[0]);
  
      return is_data_set;
  }
  
<span class="udiff-line-modified-removed">- static gboolean dnd_source_set_raw(GtkWidget *widget, GtkSelectionData *sel_data, GdkAtom atom)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+ static gboolean dnd_source_set_raw(GtkWidget *widget, GtkSelectionData *sel_data, GdkAtom atom) {</span>
      gchar *target_name = gdk_atom_name(atom);
      jobject data = dnd_source_get_data(widget, target_name);
      gboolean is_data_set = FALSE;
      if (data) {
          if (mainEnv-&gt;IsInstanceOf(data, jStringCls)) {
<span class="udiff-line-modified-removed">-             const char *cstring = mainEnv-&gt;GetStringUTFChars((jstring)data, NULL);</span>
<span class="udiff-line-modified-added">+             const char *cstring = mainEnv-&gt;GetStringUTFChars((jstring) data, NULL);</span>
              if (cstring) {
                  is_data_set = gtk_selection_data_set_text(sel_data, (gchar *) cstring, strlen(cstring));
<span class="udiff-line-modified-removed">-                 mainEnv-&gt;ReleaseStringUTFChars((jstring)data, cstring);</span>
<span class="udiff-line-modified-added">+                 mainEnv-&gt;ReleaseStringUTFChars((jstring) data, cstring);</span>
              }
          } else if (mainEnv-&gt;IsInstanceOf(data, jByteBufferCls)) {
<span class="udiff-line-modified-removed">-             jbyteArray byteArray = (jbyteArray)mainEnv-&gt;CallObjectMethod(data, jByteBufferArray);</span>
<span class="udiff-line-modified-added">+             jbyteArray byteArray = (jbyteArray) mainEnv-&gt;CallObjectMethod(data, jByteBufferArray);</span>
              if (!EXCEPTION_OCCURED(mainEnv)) {
<span class="udiff-line-modified-removed">-                 jbyte* raw = mainEnv-&gt;GetByteArrayElements(byteArray, NULL);</span>
<span class="udiff-line-modified-added">+                 jbyte *raw = mainEnv-&gt;GetByteArrayElements(byteArray, NULL);</span>
                  if (raw) {
                      jsize nraw = mainEnv-&gt;GetArrayLength(byteArray);
                      gtk_selection_data_set(sel_data, atom, 8, (guchar *) raw, nraw);
                      mainEnv-&gt;ReleaseByteArrayElements(byteArray, raw, JNI_ABORT);
                      is_data_set = TRUE;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -662,24 +643,22 @@</span>
      return FALSE;
  }
  
  static void dnd_end_callback(GtkWidget *widget,
                               GdkDragContext *context,
<span class="udiff-line-modified-removed">-                              gpointer user_data)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+                              gpointer user_data) {</span>
      if (drag_widget) {
          GdkDragAction action = gdk_drag_context_get_selected_action(context);
          dnd_set_performed_action(translate_gdk_action_to_glass(action));
      }
      gdk_threads_add_idle((GSourceFunc) dnd_destroy_drag_widget_callback, NULL);
  }
  
  static gboolean dnd_drag_failed_callback(GtkWidget *widget,
<span class="udiff-line-modified-removed">-                                      GdkDragContext *context,</span>
<span class="udiff-line-modified-removed">-                                      GtkDragResult result,</span>
<span class="udiff-line-modified-removed">-                                      gpointer user_data)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+                                          GdkDragContext *context,</span>
<span class="udiff-line-modified-added">+                                          GtkDragResult result,</span>
<span class="udiff-line-modified-added">+                                          gpointer user_data) {</span>
      dnd_set_performed_action(com_sun_glass_ui_gtk_GtkDnDClipboard_ACTION_NONE);
      gdk_threads_add_idle((GSourceFunc) dnd_destroy_drag_widget_callback, NULL);
  
      return FALSE;
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -687,12 +666,11 @@</span>
  static void dnd_data_get_callback(GtkWidget *widget,
                                    GdkDragContext *context,
                                    GtkSelectionData *data,
                                    guint info,
                                    guint time,
<span class="udiff-line-modified-removed">-                                   gpointer user_data)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+                                   gpointer user_data) {</span>
      GdkAtom atom = gtk_selection_data_get_target(data);
  
      switch (info) {
          case TARGET_TEXT:
              dnd_source_set_string(widget, data, atom);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -708,21 +686,19 @@</span>
      }
  }
  
  static void dnd_drag_begin_callback(GtkWidget *widget,
                                      GdkDragContext *context,
<span class="udiff-line-modified-removed">-                                     gpointer user_data)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+                                     gpointer user_data) {</span>
      if (!is_grab_disabled()) {
          gtk_grab_add(drag_widget);
      }
  
      DragView::set_drag_view(widget, context);
  }
  
<span class="udiff-line-modified-removed">- static void dnd_source_push_data(JNIEnv *env, jobject data, jint supported)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+ static void dnd_source_push_data(JNIEnv *env, jobject data, jint supported) {</span>
      if (supported == 0) {
          return; // No supported actions, do nothing
      }
  
      data = env-&gt;NewGlobalRef(data);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -735,20 +711,20 @@</span>
      gtk_widget_show(drag_widget);
  
      g_object_set_data_full(G_OBJECT(drag_widget), SOURCE_DND_DATA, data, clear_global_ref);
  
      g_signal_connect(drag_widget, &quot;drag-begin&quot;,
<span class="udiff-line-modified-removed">-         G_CALLBACK(dnd_drag_begin_callback), NULL);</span>
<span class="udiff-line-modified-added">+                      G_CALLBACK(dnd_drag_begin_callback), NULL);</span>
  
      g_signal_connect(drag_widget, &quot;drag-failed&quot;,
<span class="udiff-line-modified-removed">-         G_CALLBACK(dnd_drag_failed_callback), NULL);</span>
<span class="udiff-line-modified-added">+                      G_CALLBACK(dnd_drag_failed_callback), NULL);</span>
  
      g_signal_connect(drag_widget, &quot;drag-data-get&quot;,
<span class="udiff-line-modified-removed">-         G_CALLBACK(dnd_data_get_callback), NULL);</span>
<span class="udiff-line-modified-added">+                      G_CALLBACK(dnd_data_get_callback), NULL);</span>
  
      g_signal_connect(drag_widget, &quot;drag-end&quot;,
<span class="udiff-line-modified-removed">-         G_CALLBACK(dnd_end_callback), NULL);</span>
<span class="udiff-line-modified-added">+                      G_CALLBACK(dnd_end_callback), NULL);</span>
  
      GtkTargetList *tlist = data_to_gtk_target_list(env, data);
  
      GdkDragContext *context;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -764,15 +740,14 @@</span>
  #endif
  
      gtk_target_list_unref(tlist);
  }
  
<span class="udiff-line-modified-removed">- jint execute_dnd(JNIEnv *env, jobject data, jint supported)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+ jint execute_dnd(JNIEnv *env, jobject data, jint supported) {</span>
      try {
          dnd_source_push_data(env, data, supported);
<span class="udiff-line-modified-removed">-     } catch (jni_exception&amp;) {</span>
<span class="udiff-line-modified-added">+     } catch (jni_exception &amp;) {</span>
          gdk_threads_add_idle((GSourceFunc) dnd_destroy_drag_widget_callback, NULL);
          return com_sun_glass_ui_gtk_GtkDnDClipboard_ACTION_NONE;
      }
  
      while (is_in_drag()) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -780,25 +755,24 @@</span>
      }
  
      return dnd_get_performed_action();
  }
  
<span class="udiff-line-modified-removed">-  /******************** DRAG VIEW ***************************/</span>
<span class="udiff-line-modified-removed">-  DragView::View* DragView::view = NULL;</span>
<span class="udiff-line-modified-added">+ /******************** DRAG VIEW ***************************/</span>
<span class="udiff-line-modified-added">+ DragView::View *DragView::view = NULL;</span>
  
<span class="udiff-line-modified-removed">-  gboolean DragView::get_drag_image_offset(GtkWidget *widget, int* x, int* y)</span>
<span class="udiff-line-removed">-  {</span>
<span class="udiff-line-modified-added">+ gboolean DragView::get_drag_image_offset(GtkWidget *widget, int *x, int *y) {</span>
      gboolean offset_set = FALSE;
      jobject bb = dnd_source_get_data(widget, &quot;application/x-java-drag-image-offset&quot;);
      if (bb) {
<span class="udiff-line-modified-removed">-         jbyteArray byteArray = (jbyteArray)mainEnv-&gt;CallObjectMethod(bb, jByteBufferArray);</span>
<span class="udiff-line-modified-added">+         jbyteArray byteArray = (jbyteArray) mainEnv-&gt;CallObjectMethod(bb, jByteBufferArray);</span>
          if (!EXCEPTION_OCCURED(mainEnv)) {
<span class="udiff-line-modified-removed">-             jbyte* raw = mainEnv-&gt;GetByteArrayElements(byteArray, NULL);</span>
<span class="udiff-line-modified-added">+             jbyte *raw = mainEnv-&gt;GetByteArrayElements(byteArray, NULL);</span>
              jsize nraw = mainEnv-&gt;GetArrayLength(byteArray);
  
              if ((size_t) nraw &gt;= sizeof(jint) * 2) {
<span class="udiff-line-modified-removed">-                 jint* r = (jint*) raw;</span>
<span class="udiff-line-modified-added">+                 jint *r = (jint *) raw;</span>
                  *x = BSWAP_32(r[0]);
                  *y = BSWAP_32(r[1]);
                  offset_set = TRUE;
              }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -806,35 +780,34 @@</span>
          }
      }
      return offset_set;
  }
  
<span class="udiff-line-modified-removed">- GdkPixbuf* DragView::get_drag_image(GtkWidget *widget, gboolean* is_raw_image, gint* width, gint* height)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+ GdkPixbuf *DragView::get_drag_image(GtkWidget *widget, gboolean *is_raw_image, gint *width, gint *height) {</span>
      GdkPixbuf *pixbuf = NULL;
      gboolean is_raw = FALSE;
  
      jobject drag_image = dnd_source_get_data(widget, &quot;application/x-java-drag-image&quot;);
  
      if (drag_image) {
          jbyteArray byteArray = (jbyteArray) mainEnv-&gt;CallObjectMethod(drag_image, jByteBufferArray);
          if (!EXCEPTION_OCCURED(mainEnv)) {
  
<span class="udiff-line-modified-removed">-             jbyte* raw = mainEnv-&gt;GetByteArrayElements(byteArray, NULL);</span>
<span class="udiff-line-modified-added">+             jbyte *raw = mainEnv-&gt;GetByteArrayElements(byteArray, NULL);</span>
              jsize nraw = mainEnv-&gt;GetArrayLength(byteArray);
  
              int w = 0, h = 0;
              int whsz = sizeof(jint) * 2; // Pixels are stored right after two ints
              // in this byteArray: width and height
              if (nraw &gt; whsz) {
<span class="udiff-line-modified-removed">-                 jint* int_raw = (jint*) raw;</span>
<span class="udiff-line-modified-added">+                 jint *int_raw = (jint *) raw;</span>
                  w = BSWAP_32(int_raw[0]);
                  h = BSWAP_32(int_raw[1]);
  
                  // We should have enough pixels for requested width and height
<span class="udiff-line-modified-removed">-                 if ((nraw - whsz) / 4 - w * h &gt;= 0 ) {</span>
<span class="udiff-line-modified-removed">-                     guchar* data = (guchar*) g_try_malloc0(nraw - whsz);</span>
<span class="udiff-line-modified-added">+                 if ((nraw - whsz) / 4 - w * h &gt;= 0) {</span>
<span class="udiff-line-modified-added">+                     guchar *data = (guchar *) g_try_malloc0(nraw - whsz);</span>
                      if (data) {
                          memcpy(data, (raw + whsz), nraw - whsz);
                          pixbuf = gdk_pixbuf_new_from_data(data, GDK_COLORSPACE_RGB, TRUE, 8,
                                                            w, h, w * 4, pixbufDestroyNotifyFunc, NULL);
                      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -859,12 +832,12 @@</span>
  
      int w = gdk_pixbuf_get_width(pixbuf);
      int h = gdk_pixbuf_get_height(pixbuf);
  
      if (w &gt; DRAG_IMAGE_MAX_WIDTH || h &gt; DRAG_IMAGE_MAX_HEIGH) {
<span class="udiff-line-modified-removed">-         double rw = DRAG_IMAGE_MAX_WIDTH / (double)w;</span>
<span class="udiff-line-modified-removed">-         double rh =  DRAG_IMAGE_MAX_HEIGH / (double)h;</span>
<span class="udiff-line-modified-added">+         double rw = DRAG_IMAGE_MAX_WIDTH / (double) w;</span>
<span class="udiff-line-modified-added">+         double rh = DRAG_IMAGE_MAX_HEIGH / (double) h;</span>
          double r = MIN(rw, rh);
  
          int new_w = w * r;
          int new_h = h * r;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -884,55 +857,51 @@</span>
      *height = h;
  
      return pixbuf;
  }
  
<span class="udiff-line-modified-removed">- void DragView::set_drag_view(GtkWidget *widget, GdkDragContext *context)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+ void DragView::set_drag_view(GtkWidget *widget, GdkDragContext *context) {</span>
      gboolean is_raw_image = FALSE;
      gint w = 0, h = 0;
<span class="udiff-line-modified-removed">-     GdkPixbuf* pixbuf = get_drag_image(widget, &amp;is_raw_image, &amp;w, &amp;h);</span>
<span class="udiff-line-modified-added">+     GdkPixbuf *pixbuf = get_drag_image(widget, &amp;is_raw_image, &amp;w, &amp;h);</span>
  
      if (GDK_IS_PIXBUF(pixbuf)) {
          gint offset_x = w / 2;
          gint offset_y = h / 2;
  
          gboolean is_offset_set = get_drag_image_offset(widget, &amp;offset_x, &amp;offset_y);
  
          DragView::view = new DragView::View(context, pixbuf, w, h, is_raw_image,
<span class="udiff-line-modified-removed">-             is_offset_set, offset_x, offset_y);</span>
<span class="udiff-line-modified-added">+                                             is_offset_set, offset_x, offset_y);</span>
      }
  }
  
<span class="udiff-line-modified-removed">- static void on_screen_changed(GtkWidget *widget, GdkScreen *previous_screen, gpointer view)</span>
<span class="udiff-line-modified-removed">- {</span>
<span class="udiff-line-modified-removed">-     (void)widget;</span>
<span class="udiff-line-removed">-     (void)previous_screen;</span>
<span class="udiff-line-modified-added">+ static void on_screen_changed(GtkWidget *widget, GdkScreen *previous_screen, gpointer view) {</span>
<span class="udiff-line-modified-added">+     (void) widget;</span>
<span class="udiff-line-modified-added">+     (void) previous_screen;</span>
  
<span class="udiff-line-modified-removed">-     ((DragView::View*) view)-&gt;screen_changed();</span>
<span class="udiff-line-modified-added">+     ((DragView::View *) view)-&gt;screen_changed();</span>
  }
  
<span class="udiff-line-modified-removed">- static gboolean on_expose(GtkWidget *widget, GdkEventExpose *event, gpointer view)</span>
<span class="udiff-line-modified-removed">- {</span>
<span class="udiff-line-modified-removed">-     (void)widget;</span>
<span class="udiff-line-removed">-     (void)event;</span>
<span class="udiff-line-modified-added">+ static gboolean on_expose(GtkWidget *widget, GdkEventExpose *event, gpointer view) {</span>
<span class="udiff-line-modified-added">+     (void) widget;</span>
<span class="udiff-line-modified-added">+     (void) event;</span>
  
<span class="udiff-line-modified-removed">-     ((DragView::View*) view)-&gt;expose();</span>
<span class="udiff-line-modified-added">+     ((DragView::View *) view)-&gt;expose();</span>
      return FALSE;
  }
  
<span class="udiff-line-modified-removed">- DragView::View::View(GdkDragContext* _context, GdkPixbuf* _pixbuf, gint _width, gint _height,</span>
<span class="udiff-line-modified-added">+ DragView::View::View(GdkDragContext *_context, GdkPixbuf *_pixbuf, gint _width, gint _height,</span>
                       gboolean _is_raw_image, gboolean _is_offset_set, gint _offset_x, gint _offset_y) :
<span class="udiff-line-modified-removed">-     context(_context),</span>
<span class="udiff-line-modified-removed">-     pixbuf(_pixbuf),</span>
<span class="udiff-line-modified-removed">-     width(_width),</span>
<span class="udiff-line-modified-removed">-     height(_height),</span>
<span class="udiff-line-modified-removed">-     is_raw_image(_is_raw_image),</span>
<span class="udiff-line-modified-removed">-     is_offset_set(_is_offset_set),</span>
<span class="udiff-line-modified-removed">-     offset_x(_offset_x),</span>
<span class="udiff-line-modified-removed">-     offset_y(_offset_y)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+         context(_context),</span>
<span class="udiff-line-modified-added">+         pixbuf(_pixbuf),</span>
<span class="udiff-line-modified-added">+         width(_width),</span>
<span class="udiff-line-modified-added">+         height(_height),</span>
<span class="udiff-line-modified-added">+         is_raw_image(_is_raw_image),</span>
<span class="udiff-line-modified-added">+         is_offset_set(_is_offset_set),</span>
<span class="udiff-line-modified-added">+         offset_x(_offset_x),</span>
<span class="udiff-line-modified-added">+         offset_y(_offset_y) {</span>
  #ifdef GLASS_GTK3
      gtk_drag_set_icon_pixbuf(context, pixbuf, offset_x, offset_y);
  #else
      widget = gtk_window_new(GTK_WINDOW_POPUP);
      gtk_window_set_type_hint(GTK_WINDOW(widget), GDK_WINDOW_TYPE_HINT_DND);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -951,12 +920,11 @@</span>
      gtk_widget_show_all(widget);
      gtk_drag_set_icon_widget(context, widget, offset_x, offset_y);
  #endif
  }
  
<span class="udiff-line-modified-removed">- void DragView::View::screen_changed()</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+ void DragView::View::screen_changed() {</span>
      GdkScreen *screen = gtk_widget_get_screen(widget);
  
      glass_configure_window_transparency(widget, true);
  
      if (!gdk_screen_is_composited(screen)) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -965,21 +933,20 @@</span>
              offset_y = 1;
          }
      }
  }
  
<span class="udiff-line-modified-removed">- void DragView::View::expose()</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+ void DragView::View::expose() {</span>
      cairo_t *context = gdk_cairo_create(gtk_widget_get_window(widget));
  
<span class="udiff-line-modified-removed">-     cairo_surface_t* cairo_surface;</span>
<span class="udiff-line-modified-added">+     cairo_surface_t *cairo_surface;</span>
  
<span class="udiff-line-modified-removed">-     guchar* pixels = is_raw_image</span>
<span class="udiff-line-modified-removed">-             ? (guchar*) convert_BGRA_to_RGBA((const int*) gdk_pixbuf_get_pixels(pixbuf),</span>
<span class="udiff-line-modified-removed">-                                                 gdk_pixbuf_get_rowstride(pixbuf),</span>
<span class="udiff-line-modified-removed">-                                                 height)</span>
<span class="udiff-line-modified-removed">-             : gdk_pixbuf_get_pixels(pixbuf);</span>
<span class="udiff-line-modified-added">+     guchar *pixels = is_raw_image</span>
<span class="udiff-line-modified-added">+                      ? (guchar *) convert_BGRA_to_RGBA((const int *) gdk_pixbuf_get_pixels(pixbuf),</span>
<span class="udiff-line-modified-added">+                                                        gdk_pixbuf_get_rowstride(pixbuf),</span>
<span class="udiff-line-modified-added">+                                                        height)</span>
<span class="udiff-line-modified-added">+                      : gdk_pixbuf_get_pixels(pixbuf);</span>
  
      cairo_surface = cairo_image_surface_create_for_data(
              pixels,
              CAIRO_FORMAT_ARGB32,
              width, height, width * 4);
</pre>
<center><a href="GlassWindow.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="glass_window.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>