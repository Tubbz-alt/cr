<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.graphics/src/main/native-glass/gtk/glass_dnd.cpp</title>
    <link rel="stylesheet" href="../../../../../../style.css" />
  </head>
<body>
<center><a href="GlassWindow.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="glass_window.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.graphics/src/main/native-glass/gtk/glass_dnd.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 36,41 ***</span>
  #include &lt;gtk/gtk.h&gt;
  #include &lt;gdk/gdkx.h&gt;
  #include &lt;gdk/gdkkeysyms.h&gt;
  
  /************************* COMMON *********************************************/
<span class="line-modified">! static jint translate_gdk_action_to_glass(GdkDragAction action)</span>
<span class="line-removed">- {</span>
      jint result = 0;
<span class="line-modified">!     result |= (action &amp; GDK_ACTION_COPY)? com_sun_glass_ui_gtk_GtkDnDClipboard_ACTION_COPY : 0;</span>
<span class="line-modified">!     result |= (action &amp; GDK_ACTION_MOVE)? com_sun_glass_ui_gtk_GtkDnDClipboard_ACTION_MOVE : 0;</span>
<span class="line-modified">!     result |= (action &amp; GDK_ACTION_LINK)? com_sun_glass_ui_gtk_GtkDnDClipboard_ACTION_REFERENCE : 0;</span>
      return result;
  }
  
<span class="line-modified">! static GdkDragAction translate_glass_action_to_gdk(jint action)</span>
<span class="line-removed">- {</span>
      int result = 0;
      result |= (action &amp; com_sun_glass_ui_gtk_GtkDnDClipboard_ACTION_COPY) ? GDK_ACTION_COPY : 0;
      result |= (action &amp; com_sun_glass_ui_gtk_GtkDnDClipboard_ACTION_MOVE) ? GDK_ACTION_MOVE : 0;
      result |= (action &amp; com_sun_glass_ui_gtk_GtkDnDClipboard_ACTION_REFERENCE) ? GDK_ACTION_LINK : 0;
      return static_cast&lt;GdkDragAction&gt;(result);
  }
  
<span class="line-modified">! static void clear_global_ref(gpointer data)</span>
<span class="line-modified">! {</span>
<span class="line-removed">-     mainEnv-&gt;DeleteGlobalRef((jobject)data);</span>
  }
  
  static void dnd_set_performed_action(jint performed_action);
  static jint dnd_get_performed_action();
  
  enum {
<span class="line-modified">!   TARGET_TEXT,</span>
<span class="line-modified">!   TARGET_IMAGE,</span>
<span class="line-modified">!   TARGET_URI,</span>
<span class="line-modified">!   TARGET_RAW</span>
  };
  
  /************************* TARGET *********************************************/
  
  static struct {
<span class="line-new-header">--- 36,39 ---</span>
  #include &lt;gtk/gtk.h&gt;
  #include &lt;gdk/gdkx.h&gt;
  #include &lt;gdk/gdkkeysyms.h&gt;
  
  /************************* COMMON *********************************************/
<span class="line-modified">! static jint translate_gdk_action_to_glass(GdkDragAction action) {</span>
      jint result = 0;
<span class="line-modified">!     result |= (action &amp; GDK_ACTION_COPY) ? com_sun_glass_ui_gtk_GtkDnDClipboard_ACTION_COPY : 0;</span>
<span class="line-modified">!     result |= (action &amp; GDK_ACTION_MOVE) ? com_sun_glass_ui_gtk_GtkDnDClipboard_ACTION_MOVE : 0;</span>
<span class="line-modified">!     result |= (action &amp; GDK_ACTION_LINK) ? com_sun_glass_ui_gtk_GtkDnDClipboard_ACTION_REFERENCE : 0;</span>
      return result;
  }
  
<span class="line-modified">! static GdkDragAction translate_glass_action_to_gdk(jint action) {</span>
      int result = 0;
      result |= (action &amp; com_sun_glass_ui_gtk_GtkDnDClipboard_ACTION_COPY) ? GDK_ACTION_COPY : 0;
      result |= (action &amp; com_sun_glass_ui_gtk_GtkDnDClipboard_ACTION_MOVE) ? GDK_ACTION_MOVE : 0;
      result |= (action &amp; com_sun_glass_ui_gtk_GtkDnDClipboard_ACTION_REFERENCE) ? GDK_ACTION_LINK : 0;
      return static_cast&lt;GdkDragAction&gt;(result);
  }
  
<span class="line-modified">! static void clear_global_ref(gpointer data) {</span>
<span class="line-modified">!     mainEnv-&gt;DeleteGlobalRef((jobject) data);</span>
  }
  
  static void dnd_set_performed_action(jint performed_action);
<span class="line-added">+ </span>
  static jint dnd_get_performed_action();
  
  enum {
<span class="line-modified">!     TARGET_TEXT,</span>
<span class="line-modified">!     TARGET_IMAGE,</span>
<span class="line-modified">!     TARGET_URI,</span>
<span class="line-modified">!     TARGET_RAW</span>
  };
  
  /************************* TARGET *********************************************/
  
  static struct {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 93,18 ***</span>
      }
  
      memset(&amp;target_ctx, 0, sizeof(target_ctx));
  }
  
<span class="line-modified">! static gboolean dnd_drag_motion_callback(GtkWidget      *widget,</span>
                                           GdkDragContext *context,
<span class="line-modified">!                                          gint            x,</span>
<span class="line-modified">!                                          gint            y,</span>
<span class="line-modified">!                                          guint           time,</span>
<span class="line-modified">!                                          gpointer        user_data) {</span>
  
<span class="line-modified">!     WindowContext* ctx = (WindowContext*)user_data;</span>
  
      if (target_ctx.ctx == NULL || (target_ctx.ctx != context &amp;&amp; !target_ctx.just_entered)) {
          reset_target_ctx();
          is_dnd_owner = is_in_drag();
          target_ctx.ctx = context;
<span class="line-new-header">--- 91,18 ---</span>
      }
  
      memset(&amp;target_ctx, 0, sizeof(target_ctx));
  }
  
<span class="line-modified">! static gboolean dnd_drag_motion_callback(GtkWidget *widget,</span>
                                           GdkDragContext *context,
<span class="line-modified">!                                          gint x,</span>
<span class="line-modified">!                                          gint y,</span>
<span class="line-modified">!                                          guint time,</span>
<span class="line-modified">!                                          gpointer user_data) {</span>
  
<span class="line-modified">!     WindowContext *ctx = (WindowContext *) user_data;</span>
  
      if (target_ctx.ctx == NULL || (target_ctx.ctx != context &amp;&amp; !target_ctx.just_entered)) {
          reset_target_ctx();
          is_dnd_owner = is_in_drag();
          target_ctx.ctx = context;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 116,13 ***</span>
  
      jmethodID method = target_ctx.just_entered ? jViewNotifyDragEnter : jViewNotifyDragOver;
  
      GdkDragAction suggested = gdk_drag_context_get_suggested_action(context);
      GdkDragAction result = translate_glass_action_to_gdk(mainEnv-&gt;CallIntMethod(ctx-&gt;get_jview(), method,
<span class="line-modified">!             (jint)x, (jint)y,</span>
<span class="line-modified">!             (jint)x_abs, (jint)y_abs,</span>
<span class="line-modified">!             translate_gdk_action_to_glass(suggested)));</span>
      CHECK_JNI_EXCEPTION_RET(mainEnv, FALSE)
  
      if (target_ctx.just_entered) {
          target_ctx.just_entered = FALSE;
      }
<span class="line-new-header">--- 114,14 ---</span>
  
      jmethodID method = target_ctx.just_entered ? jViewNotifyDragEnter : jViewNotifyDragOver;
  
      GdkDragAction suggested = gdk_drag_context_get_suggested_action(context);
      GdkDragAction result = translate_glass_action_to_gdk(mainEnv-&gt;CallIntMethod(ctx-&gt;get_jview(), method,
<span class="line-modified">!                                                                                 (jint) x, (jint) y,</span>
<span class="line-modified">!                                                                                 (jint) x_abs, (jint) y_abs,</span>
<span class="line-modified">!                                                                                 translate_gdk_action_to_glass(</span>
<span class="line-added">+                                                                                         suggested)));</span>
      CHECK_JNI_EXCEPTION_RET(mainEnv, FALSE)
  
      if (target_ctx.just_entered) {
          target_ctx.just_entered = FALSE;
      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 130,16 ***</span>
      gdk_drag_status(context, result, GDK_CURRENT_TIME);
  
      return (gboolean) result;
  }
  
<span class="line-modified">! static gboolean dnd_drag_drop_callback(GtkWidget      *widget,</span>
<span class="line-modified">!                                       GdkDragContext *context,</span>
<span class="line-modified">!                                       gint            x,</span>
<span class="line-modified">!                                       gint            y,</span>
<span class="line-modified">!                                       guint           time,</span>
<span class="line-modified">!                                       gpointer        user_data) {</span>
      if (target_ctx.ctx == NULL || target_ctx.just_entered) {
          return FALSE; // Do not process drop events if no enter event and subsequent motion event were received
      }
  
      GdkAtom target = gtk_drag_dest_find_target(widget, context, NULL);
<span class="line-new-header">--- 129,16 ---</span>
      gdk_drag_status(context, result, GDK_CURRENT_TIME);
  
      return (gboolean) result;
  }
  
<span class="line-modified">! static gboolean dnd_drag_drop_callback(GtkWidget *widget,</span>
<span class="line-modified">!                                        GdkDragContext *context,</span>
<span class="line-modified">!                                        gint x,</span>
<span class="line-modified">!                                        gint y,</span>
<span class="line-modified">!                                        guint time,</span>
<span class="line-modified">!                                        gpointer user_data) {</span>
      if (target_ctx.ctx == NULL || target_ctx.just_entered) {
          return FALSE; // Do not process drop events if no enter event and subsequent motion event were received
      }
  
      GdkAtom target = gtk_drag_dest_find_target(widget, context, NULL);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 152,20 ***</span>
      gtk_drag_get_data(widget, context, target, GDK_CURRENT_TIME);
  
      return TRUE;
  }
  
<span class="line-modified">! static void dnd_on_drag_data_received_callback(GtkWidget        *widget,</span>
<span class="line-modified">!                                                GdkDragContext   *context,</span>
<span class="line-modified">!                                                gint              x,</span>
<span class="line-modified">!                                                gint              y,</span>
                                                 GtkSelectionData *data,
<span class="line-modified">!                                                guint             info,</span>
<span class="line-modified">!                                                guint             time,</span>
<span class="line-modified">!                                                gpointer          user_data)</span>
<span class="line-modified">! {</span>
<span class="line-removed">-     WindowContext* ctx = (WindowContext*)user_data;</span>
  
      if (gtk_selection_data_get_length(data) == 0) {
          gtk_drag_finish(context, FALSE, FALSE, GDK_CURRENT_TIME);
          reset_target_ctx();
          return;
<span class="line-new-header">--- 151,19 ---</span>
      gtk_drag_get_data(widget, context, target, GDK_CURRENT_TIME);
  
      return TRUE;
  }
  
<span class="line-modified">! static void dnd_on_drag_data_received_callback(GtkWidget *widget,</span>
<span class="line-modified">!                                                GdkDragContext *context,</span>
<span class="line-modified">!                                                gint x,</span>
<span class="line-modified">!                                                gint y,</span>
                                                 GtkSelectionData *data,
<span class="line-modified">!                                                guint info,</span>
<span class="line-modified">!                                                guint time,</span>
<span class="line-modified">!                                                gpointer user_data) {</span>
<span class="line-modified">!     WindowContext *ctx = (WindowContext *) user_data;</span>
  
      if (gtk_selection_data_get_length(data) == 0) {
          gtk_drag_finish(context, FALSE, FALSE, GDK_CURRENT_TIME);
          reset_target_ctx();
          return;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 176,30 ***</span>
      GdkDragAction selected = gdk_drag_context_get_selected_action(context);
      target_ctx.data = data;
  
      // Delay the notify for when we have the data
      mainEnv-&gt;CallIntMethod(ctx-&gt;get_jview(), jViewNotifyDragDrop,
<span class="line-modified">!                            (jint)x, (jint)y,</span>
<span class="line-modified">!                            (jint)x_abs, (jint)y_abs,</span>
                             translate_gdk_action_to_glass(selected));
      LOG_EXCEPTION(mainEnv)
  
      gtk_drag_finish(context, selected, selected == GDK_ACTION_MOVE, GDK_CURRENT_TIME);
  }
  
<span class="line-modified">! void dnd_drag_leave_callback(WindowContext* ctx) {</span>
      mainEnv-&gt;CallVoidMethod(ctx-&gt;get_jview(), jViewNotifyDragLeave, NULL);
      CHECK_JNI_EXCEPTION(mainEnv)
  
      reset_target_ctx();
  }
  
  void glass_dnd_attach_context(WindowContext *ctx) {
<span class="line-modified">!     gtk_drag_dest_set(ctx-&gt;get_gtk_widget(), (GtkDestDefaults)0, NULL, 0,</span>
                        (GdkDragAction)(GDK_ACTION_COPY | GDK_ACTION_MOVE | GDK_ACTION_LINK));
  
<span class="line-modified">!     GtkTargetList *target_list = gtk_target_list_new (NULL, 0);</span>
      gtk_target_list_add_image_targets(target_list, TARGET_IMAGE, TRUE);
      gtk_target_list_add_uri_targets(target_list, TARGET_URI);
      gtk_target_list_add_text_targets(target_list, TARGET_TEXT);
      gtk_target_list_add(target_list, gdk_atom_intern_static_string(&quot;&quot;), 0, TARGET_RAW);
  
<span class="line-new-header">--- 174,30 ---</span>
      GdkDragAction selected = gdk_drag_context_get_selected_action(context);
      target_ctx.data = data;
  
      // Delay the notify for when we have the data
      mainEnv-&gt;CallIntMethod(ctx-&gt;get_jview(), jViewNotifyDragDrop,
<span class="line-modified">!                            (jint) x, (jint) y,</span>
<span class="line-modified">!                            (jint) x_abs, (jint) y_abs,</span>
                             translate_gdk_action_to_glass(selected));
      LOG_EXCEPTION(mainEnv)
  
      gtk_drag_finish(context, selected, selected == GDK_ACTION_MOVE, GDK_CURRENT_TIME);
  }
  
<span class="line-modified">! void dnd_drag_leave_callback(WindowContext *ctx) {</span>
      mainEnv-&gt;CallVoidMethod(ctx-&gt;get_jview(), jViewNotifyDragLeave, NULL);
      CHECK_JNI_EXCEPTION(mainEnv)
  
      reset_target_ctx();
  }
  
  void glass_dnd_attach_context(WindowContext *ctx) {
<span class="line-modified">!     gtk_drag_dest_set(ctx-&gt;get_gtk_widget(), (GtkDestDefaults) 0, NULL, 0,</span>
                        (GdkDragAction)(GDK_ACTION_COPY | GDK_ACTION_MOVE | GDK_ACTION_LINK));
  
<span class="line-modified">!     GtkTargetList *target_list = gtk_target_list_new(NULL, 0);</span>
      gtk_target_list_add_image_targets(target_list, TARGET_IMAGE, TRUE);
      gtk_target_list_add_uri_targets(target_list, TARGET_URI);
      gtk_target_list_add_text_targets(target_list, TARGET_TEXT);
      gtk_target_list_add(target_list, gdk_atom_intern_static_string(&quot;&quot;), 0, TARGET_RAW);
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 208,41 ***</span>
      g_signal_connect(ctx-&gt;get_gtk_widget(), &quot;drag-motion&quot;, G_CALLBACK(dnd_drag_motion_callback), ctx);
      g_signal_connect(ctx-&gt;get_gtk_widget(), &quot;drag-drop&quot;, G_CALLBACK(dnd_drag_drop_callback), ctx);
      g_signal_connect(ctx-&gt;get_gtk_widget(), &quot;drag-data-received&quot;, G_CALLBACK(dnd_on_drag_data_received_callback), ctx);
  }
  
<span class="line-modified">! static gboolean check_state_in_drag(JNIEnv *env)</span>
<span class="line-removed">- {</span>
      if (!target_ctx.ctx) {
          jclass jc = env-&gt;FindClass(&quot;java/lang/IllegalStateException&quot;);
          if (!env-&gt;ExceptionCheck()) {
              env-&gt;ThrowNew(jc,
<span class="line-modified">!                     &quot;Cannot get supported actions. Drag pointer haven&#39;t entered the application window&quot;);</span>
          }
          return TRUE;
      }
      return FALSE;
  }
  
<span class="line-modified">! static GdkAtom* get_target_ctx_target_atoms(gint *size) {</span>
<span class="line-modified">!     GList* targets = gdk_drag_context_list_targets(target_ctx.ctx);</span>
<span class="line-modified">!     gint s = (gint)g_list_length(targets);</span>
<span class="line-modified">!     GdkAtom* atoms = (GdkAtom*) g_try_malloc0(sizeof(GdkAtom)*s);</span>
  
      int i = 0;
      for (; targets != NULL; targets = targets-&gt;next) {
<span class="line-modified">!         atoms[i++] = (GdkAtom)targets-&gt;data;</span>
      }
  
      *size = s;
  
      g_list_free(targets);
      return atoms;
  }
  
<span class="line-modified">! jobjectArray dnd_target_get_mimes(JNIEnv *env)</span>
<span class="line-removed">- {</span>
      if (check_state_in_drag(env)) {
          return NULL;
      }
  
      if (!target_ctx.mimes) {
<span class="line-new-header">--- 206,39 ---</span>
      g_signal_connect(ctx-&gt;get_gtk_widget(), &quot;drag-motion&quot;, G_CALLBACK(dnd_drag_motion_callback), ctx);
      g_signal_connect(ctx-&gt;get_gtk_widget(), &quot;drag-drop&quot;, G_CALLBACK(dnd_drag_drop_callback), ctx);
      g_signal_connect(ctx-&gt;get_gtk_widget(), &quot;drag-data-received&quot;, G_CALLBACK(dnd_on_drag_data_received_callback), ctx);
  }
  
<span class="line-modified">! static gboolean check_state_in_drag(JNIEnv *env) {</span>
      if (!target_ctx.ctx) {
          jclass jc = env-&gt;FindClass(&quot;java/lang/IllegalStateException&quot;);
          if (!env-&gt;ExceptionCheck()) {
              env-&gt;ThrowNew(jc,
<span class="line-modified">!                           &quot;Cannot get supported actions. Drag pointer haven&#39;t entered the application window&quot;);</span>
          }
          return TRUE;
      }
      return FALSE;
  }
  
<span class="line-modified">! static GdkAtom *get_target_ctx_target_atoms(gint *size) {</span>
<span class="line-modified">!     GList *targets = gdk_drag_context_list_targets(target_ctx.ctx);</span>
<span class="line-modified">!     gint s = (gint) g_list_length(targets);</span>
<span class="line-modified">!     GdkAtom *atoms = (GdkAtom *) g_try_malloc0(sizeof(GdkAtom) * s);</span>
  
      int i = 0;
      for (; targets != NULL; targets = targets-&gt;next) {
<span class="line-modified">!         atoms[i++] = (GdkAtom) targets-&gt;data;</span>
      }
  
      *size = s;
  
      g_list_free(targets);
      return atoms;
  }
  
<span class="line-modified">! jobjectArray dnd_target_get_mimes(JNIEnv *env) {</span>
      if (check_state_in_drag(env)) {
          return NULL;
      }
  
      if (!target_ctx.mimes) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 257,11 ***</span>
              jstring jStr = env-&gt;NewStringUTF(&quot;application/x-java-rawimage&quot;);
              EXCEPTION_OCCURED(env);
              env-&gt;CallBooleanMethod(set, jSetAdd, jStr, NULL);
              EXCEPTION_OCCURED(env);
              was_set = TRUE;
<span class="line-modified">!         }  if (gtk_targets_include_uri(targets, size)) {</span>
              // it&#39;s a possibility
              jstring jStr = env-&gt;NewStringUTF(&quot;application/x-java-file-list&quot;);
              EXCEPTION_OCCURED(env);
              env-&gt;CallBooleanMethod(set, jSetAdd, jStr, NULL);
              EXCEPTION_OCCURED(env);
<span class="line-new-header">--- 253,12 ---</span>
              jstring jStr = env-&gt;NewStringUTF(&quot;application/x-java-rawimage&quot;);
              EXCEPTION_OCCURED(env);
              env-&gt;CallBooleanMethod(set, jSetAdd, jStr, NULL);
              EXCEPTION_OCCURED(env);
              was_set = TRUE;
<span class="line-modified">!         }</span>
<span class="line-added">+         if (gtk_targets_include_uri(targets, size)) {</span>
              // it&#39;s a possibility
              jstring jStr = env-&gt;NewStringUTF(&quot;application/x-java-file-list&quot;);
              EXCEPTION_OCCURED(env);
              env-&gt;CallBooleanMethod(set, jSetAdd, jStr, NULL);
              EXCEPTION_OCCURED(env);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 291,65 ***</span>
              EXCEPTION_OCCURED(env);
              g_free(name);
          }
  
          target_ctx.mimes = env-&gt;NewObjectArray(env-&gt;CallIntMethod(set, jSetSize, NULL),
<span class="line-modified">!                 jStringCls, NULL);</span>
          EXCEPTION_OCCURED(env);
<span class="line-modified">!         target_ctx.mimes = (jobjectArray)env-&gt;CallObjectMethod(set, jSetToArray, target_ctx.mimes, NULL);</span>
<span class="line-modified">!         target_ctx.mimes = (jobjectArray)env-&gt;NewGlobalRef(target_ctx.mimes);</span>
      }
  
      return target_ctx.mimes;
  }
  
<span class="line-modified">! jint dnd_target_get_supported_actions(JNIEnv *env)</span>
<span class="line-removed">- {</span>
      if (check_state_in_drag(env)) {
          return 0;
      }
      return translate_gdk_action_to_glass(gdk_drag_context_get_actions(target_ctx.ctx));
  }
  
<span class="line-modified">! static jobject dnd_target_get_string(JNIEnv *env)</span>
<span class="line-removed">- {</span>
      jobject result = NULL;
  
      GdkAtom atom = gtk_selection_data_get_data_type(target_ctx.data);
<span class="line-modified">!     guchar* data = gtk_selection_data_get_text(target_ctx.data);</span>
  
      if (data) {
<span class="line-modified">!         result = env-&gt;NewStringUTF((char *)data);</span>
          EXCEPTION_OCCURED(env);
  
          g_free(data);
      }
  
      return result;
  }
  
<span class="line-modified">! static jobject dnd_target_get_list(JNIEnv *env, gboolean files)</span>
<span class="line-removed">- {</span>
      jobject result = NULL;
      GdkAtom atom = gtk_selection_data_get_selection(target_ctx.data);
<span class="line-modified">!     gchar** data = gtk_selection_data_get_uris(target_ctx.data);</span>
  
      if (data) {
          result = uris_to_java(env, data, files);
          // uris_to_java frees it
          //g_strfreev(data);
      }
  
      return result;
  }
  
<span class="line-modified">! static jobject dnd_target_get_image(JNIEnv *env)</span>
<span class="line-removed">- {</span>
      jobject result = NULL;
  
      GdkAtom atom = gtk_selection_data_get_selection(target_ctx.data);
<span class="line-modified">!     GdkPixbuf* buf = gtk_selection_data_get_pixbuf(target_ctx.data);</span>
  
      if (buf == NULL) {
          return NULL;
      }
  
<span class="line-new-header">--- 288,61 ---</span>
              EXCEPTION_OCCURED(env);
              g_free(name);
          }
  
          target_ctx.mimes = env-&gt;NewObjectArray(env-&gt;CallIntMethod(set, jSetSize, NULL),
<span class="line-modified">!                                                jStringCls, NULL);</span>
          EXCEPTION_OCCURED(env);
<span class="line-modified">!         target_ctx.mimes = (jobjectArray) env-&gt;CallObjectMethod(set, jSetToArray, target_ctx.mimes, NULL);</span>
<span class="line-modified">!         target_ctx.mimes = (jobjectArray) env-&gt;NewGlobalRef(target_ctx.mimes);</span>
      }
  
      return target_ctx.mimes;
  }
  
<span class="line-modified">! jint dnd_target_get_supported_actions(JNIEnv *env) {</span>
      if (check_state_in_drag(env)) {
          return 0;
      }
      return translate_gdk_action_to_glass(gdk_drag_context_get_actions(target_ctx.ctx));
  }
  
<span class="line-modified">! static jobject dnd_target_get_string(JNIEnv *env) {</span>
      jobject result = NULL;
  
      GdkAtom atom = gtk_selection_data_get_data_type(target_ctx.data);
<span class="line-modified">!     guchar *data = gtk_selection_data_get_text(target_ctx.data);</span>
  
      if (data) {
<span class="line-modified">!         result = env-&gt;NewStringUTF((char *) data);</span>
          EXCEPTION_OCCURED(env);
  
          g_free(data);
      }
  
      return result;
  }
  
<span class="line-modified">! static jobject dnd_target_get_list(JNIEnv *env, gboolean files) {</span>
      jobject result = NULL;
      GdkAtom atom = gtk_selection_data_get_selection(target_ctx.data);
<span class="line-modified">!     gchar **data = gtk_selection_data_get_uris(target_ctx.data);</span>
  
      if (data) {
          result = uris_to_java(env, data, files);
          // uris_to_java frees it
          //g_strfreev(data);
      }
  
      return result;
  }
  
<span class="line-modified">! static jobject dnd_target_get_image(JNIEnv *env) {</span>
      jobject result = NULL;
  
      GdkAtom atom = gtk_selection_data_get_selection(target_ctx.data);
<span class="line-modified">!     GdkPixbuf *buf = gtk_selection_data_get_pixbuf(target_ctx.data);</span>
  
      if (buf == NULL) {
          return NULL;
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 371,14 ***</span>
      stride = gdk_pixbuf_get_rowstride(buf);
  
      cdata = gdk_pixbuf_get_pixels(buf);
  
      //Actually, we are converting RGBA to BGRA, but that&#39;s the same operation
<span class="line-modified">!     cdata = (guchar*) convert_BGRA_to_RGBA((int*) cdata, stride, h);</span>
      data_array = env-&gt;NewByteArray(stride * h);
      EXCEPTION_OCCURED(env);
<span class="line-modified">!     env-&gt;SetByteArrayRegion(data_array, 0, stride*h, (jbyte*) cdata);</span>
      EXCEPTION_OCCURED(env);
  
      buffer = env-&gt;CallStaticObjectMethod(jByteBufferCls, jByteBufferWrap, data_array);
      EXCEPTION_OCCURED(env);
      result = env-&gt;NewObject(jGtkPixelsCls, jGtkPixelsInit, w, h, buffer);
<span class="line-new-header">--- 364,14 ---</span>
      stride = gdk_pixbuf_get_rowstride(buf);
  
      cdata = gdk_pixbuf_get_pixels(buf);
  
      //Actually, we are converting RGBA to BGRA, but that&#39;s the same operation
<span class="line-modified">!     cdata = (guchar *) convert_BGRA_to_RGBA((int *) cdata, stride, h);</span>
      data_array = env-&gt;NewByteArray(stride * h);
      EXCEPTION_OCCURED(env);
<span class="line-modified">!     env-&gt;SetByteArrayRegion(data_array, 0, stride * h, (jbyte *) cdata);</span>
      EXCEPTION_OCCURED(env);
  
      buffer = env-&gt;CallStaticObjectMethod(jByteBufferCls, jByteBufferWrap, data_array);
      EXCEPTION_OCCURED(env);
      result = env-&gt;NewObject(jGtkPixelsCls, jGtkPixelsInit, w, h, buffer);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 388,35 ***</span>
      g_free(cdata);
  
      return result;
  }
  
<span class="line-modified">! static jobject dnd_target_get_raw(JNIEnv *env, GdkAtom target, gboolean string_data)</span>
<span class="line-removed">- {</span>
      jobject result = NULL;
      GdkAtom atom = gtk_selection_data_get_selection(target_ctx.data);
<span class="line-modified">!     const guchar* data = gtk_selection_data_get_data(target_ctx.data);</span>
  
      if (string_data) {
<span class="line-modified">!          result = env-&gt;NewStringUTF((char *)data);</span>
<span class="line-modified">!          EXCEPTION_OCCURED(env);</span>
      } else {
          gint length = gtk_selection_data_get_length(target_ctx.data);
  
<span class="line-modified">!         jbyteArray array = env-&gt;NewByteArray((jsize)length);</span>
          EXCEPTION_OCCURED(env);
<span class="line-modified">!         env-&gt;SetByteArrayRegion(array, 0, length, (const jbyte*)data);</span>
          EXCEPTION_OCCURED(env);
          result = env-&gt;CallStaticObjectMethod(jByteBufferCls, jByteBufferWrap, array);
          EXCEPTION_OCCURED(env);
      }
  
      return result;
  }
  
<span class="line-modified">! jobject dnd_target_get_data(JNIEnv *env, jstring mime)</span>
<span class="line-removed">- {</span>
      jobject ret = NULL;
  
      if (check_state_in_drag(env)) {
          return NULL;
      }
<span class="line-new-header">--- 381,33 ---</span>
      g_free(cdata);
  
      return result;
  }
  
<span class="line-modified">! static jobject dnd_target_get_raw(JNIEnv *env, GdkAtom target, gboolean string_data) {</span>
      jobject result = NULL;
      GdkAtom atom = gtk_selection_data_get_selection(target_ctx.data);
<span class="line-modified">!     const guchar *data = gtk_selection_data_get_data(target_ctx.data);</span>
  
      if (string_data) {
<span class="line-modified">!         result = env-&gt;NewStringUTF((char *) data);</span>
<span class="line-modified">!         EXCEPTION_OCCURED(env);</span>
      } else {
          gint length = gtk_selection_data_get_length(target_ctx.data);
  
<span class="line-modified">!         jbyteArray array = env-&gt;NewByteArray((jsize) length);</span>
          EXCEPTION_OCCURED(env);
<span class="line-modified">!         env-&gt;SetByteArrayRegion(array, 0, length, (const jbyte *) data);</span>
          EXCEPTION_OCCURED(env);
          result = env-&gt;CallStaticObjectMethod(jByteBufferCls, jByteBufferWrap, array);
          EXCEPTION_OCCURED(env);
      }
  
      return result;
  }
  
<span class="line-modified">! jobject dnd_target_get_data(JNIEnv *env, jstring mime) {</span>
      jobject ret = NULL;
  
      if (check_state_in_drag(env)) {
          return NULL;
      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 429,11 ***</span>
          ret = dnd_target_get_list(env, FALSE);
      } else if (g_str_has_prefix(cmime, &quot;text/&quot;)) {
          ret = dnd_target_get_raw(env, gdk_atom_intern(cmime, FALSE), TRUE);
      } else if (g_strcmp0(cmime, &quot;application/x-java-file-list&quot;) == 0) {
          ret = dnd_target_get_list(env, TRUE);
<span class="line-modified">!     } else if (g_strcmp0(cmime, &quot;application/x-java-rawimage&quot;) == 0 ) {</span>
          ret = dnd_target_get_image(env);
      } else {
          ret = dnd_target_get_raw(env, gdk_atom_intern(cmime, FALSE), FALSE);
      }
  
<span class="line-new-header">--- 420,11 ---</span>
          ret = dnd_target_get_list(env, FALSE);
      } else if (g_str_has_prefix(cmime, &quot;text/&quot;)) {
          ret = dnd_target_get_raw(env, gdk_atom_intern(cmime, FALSE), TRUE);
      } else if (g_strcmp0(cmime, &quot;application/x-java-file-list&quot;) == 0) {
          ret = dnd_target_get_list(env, TRUE);
<span class="line-modified">!     } else if (g_strcmp0(cmime, &quot;application/x-java-rawimage&quot;) == 0) {</span>
          ret = dnd_target_get_image(env);
      } else {
          ret = dnd_target_get_raw(env, gdk_atom_intern(cmime, FALSE), FALSE);
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 445,90 ***</span>
  
  /************************* SOURCE *********************************************/
  
  static jint dnd_performed_action;
  
<span class="line-modified">! const char * const SOURCE_DND_DATA = &quot;fx-dnd-data&quot;;</span>
  
<span class="line-modified">! static void dnd_set_performed_action(jint performed_action)</span>
<span class="line-removed">- {</span>
      dnd_performed_action = performed_action;
  }
  
<span class="line-modified">! static jint dnd_get_performed_action()</span>
<span class="line-removed">- {</span>
      return dnd_performed_action;
  }
  
<span class="line-modified">! static void pixbufDestroyNotifyFunc(guchar *pixels, gpointer)</span>
<span class="line-removed">- {</span>
      if (pixels != NULL) {
          g_free(pixels);
      }
  }
  
<span class="line-modified">! static jobject dnd_source_get_data(GtkWidget *widget, const char *key)</span>
<span class="line-modified">! {</span>
<span class="line-removed">-     jobject data = (jobject)g_object_get_data(G_OBJECT(widget), SOURCE_DND_DATA);</span>
      jstring string = mainEnv-&gt;NewStringUTF(key);
      EXCEPTION_OCCURED(mainEnv);
      jobject result = mainEnv-&gt;CallObjectMethod(data, jMapGet, string, NULL);
  
      return (EXCEPTION_OCCURED(mainEnv)) ? NULL : result;
  }
  
<span class="line-modified">! static void add_gtk_target_from_jstring(JNIEnv *env, GtkTargetList **list, jstring string, guint flags)</span>
<span class="line-removed">- {</span>
      const char *gstring = env-&gt;GetStringUTFChars(string, NULL);
  
      if (g_strcmp0(gstring, &quot;text/plain&quot;) == 0) {
          gtk_target_list_add_text_targets(*list, TARGET_TEXT);
      } else if (g_strcmp0(gstring, &quot;application/x-java-rawimage&quot;) == 0) {
          gtk_target_list_add_image_targets(*list, TARGET_IMAGE, TRUE);
      } else if (g_strcmp0(gstring, &quot;application/x-java-file-list&quot;) == 0) {
          gtk_target_list_add_uri_targets(*list, TARGET_URI);
      } else if (g_strcmp0(gstring, &quot;application/x-java-drag-image&quot;) == 0
<span class="line-modified">!         || g_strcmp0(gstring, &quot;application/x-java-drag-image-offset&quot;) == 0) {</span>
          // do nothing - those are DragView information
      } else {
          GdkAtom atom = gdk_atom_intern(gstring, FALSE);
          gtk_target_list_add(*list, atom, flags, TARGET_RAW);
      }
  
      env-&gt;ReleaseStringUTFChars(string, gstring);
  }
  
<span class="line-modified">! static GtkTargetList* data_to_gtk_target_list(JNIEnv *env, jobject data)</span>
<span class="line-removed">- {</span>
      guint flags = GTK_TARGET_OTHER_APP | GTK_TARGET_SAME_APP;
  
      jobject keys;
      jobject keysIterator;
      jstring next;
  
<span class="line-modified">!     GtkTargetList *tlist = gtk_target_list_new (NULL, 0);</span>
  
      gint added_count = 0;
  
      keys = env-&gt;CallObjectMethod(data, jMapKeySet, NULL);
      JNI_EXCEPTION_TO_CPP(env)
      keysIterator = env-&gt;CallObjectMethod(keys, jIterableIterator, NULL);
      JNI_EXCEPTION_TO_CPP(env)
      while (env-&gt;CallBooleanMethod(keysIterator, jIteratorHasNext) == JNI_TRUE) {
<span class="line-modified">!         next = (jstring)env-&gt;CallObjectMethod(keysIterator, jIteratorNext, NULL);</span>
          JNI_EXCEPTION_TO_CPP(env)
          add_gtk_target_from_jstring(env, &amp;tlist, next, flags);
      }
  
      return tlist;
  }
  
<span class="line-modified">! static gboolean dnd_source_set_string(GtkWidget *widget, GtkSelectionData *data, GdkAtom atom)</span>
<span class="line-removed">- {</span>
      gboolean is_data_set;
  
<span class="line-modified">!     jstring string = (jstring)dnd_source_get_data(widget, &quot;text/plain&quot;);</span>
      if (!string) {
          return FALSE;
      }
  
      const char *cstring = mainEnv-&gt;GetStringUTFChars(string, NULL);
<span class="line-new-header">--- 436,83 ---</span>
  
  /************************* SOURCE *********************************************/
  
  static jint dnd_performed_action;
  
<span class="line-modified">! const char *const SOURCE_DND_DATA = &quot;fx-dnd-data&quot;;</span>
  
<span class="line-modified">! static void dnd_set_performed_action(jint performed_action) {</span>
      dnd_performed_action = performed_action;
  }
  
<span class="line-modified">! static jint dnd_get_performed_action() {</span>
      return dnd_performed_action;
  }
  
<span class="line-modified">! static void pixbufDestroyNotifyFunc(guchar *pixels, gpointer) {</span>
      if (pixels != NULL) {
          g_free(pixels);
      }
  }
  
<span class="line-modified">! static jobject dnd_source_get_data(GtkWidget *widget, const char *key) {</span>
<span class="line-modified">!     jobject data = (jobject) g_object_get_data(G_OBJECT(widget), SOURCE_DND_DATA);</span>
      jstring string = mainEnv-&gt;NewStringUTF(key);
      EXCEPTION_OCCURED(mainEnv);
      jobject result = mainEnv-&gt;CallObjectMethod(data, jMapGet, string, NULL);
  
      return (EXCEPTION_OCCURED(mainEnv)) ? NULL : result;
  }
  
<span class="line-modified">! static void add_gtk_target_from_jstring(JNIEnv *env, GtkTargetList **list, jstring string, guint flags) {</span>
      const char *gstring = env-&gt;GetStringUTFChars(string, NULL);
  
      if (g_strcmp0(gstring, &quot;text/plain&quot;) == 0) {
          gtk_target_list_add_text_targets(*list, TARGET_TEXT);
      } else if (g_strcmp0(gstring, &quot;application/x-java-rawimage&quot;) == 0) {
          gtk_target_list_add_image_targets(*list, TARGET_IMAGE, TRUE);
      } else if (g_strcmp0(gstring, &quot;application/x-java-file-list&quot;) == 0) {
          gtk_target_list_add_uri_targets(*list, TARGET_URI);
      } else if (g_strcmp0(gstring, &quot;application/x-java-drag-image&quot;) == 0
<span class="line-modified">!                || g_strcmp0(gstring, &quot;application/x-java-drag-image-offset&quot;) == 0) {</span>
          // do nothing - those are DragView information
      } else {
          GdkAtom atom = gdk_atom_intern(gstring, FALSE);
          gtk_target_list_add(*list, atom, flags, TARGET_RAW);
      }
  
      env-&gt;ReleaseStringUTFChars(string, gstring);
  }
  
<span class="line-modified">! static GtkTargetList *data_to_gtk_target_list(JNIEnv *env, jobject data) {</span>
      guint flags = GTK_TARGET_OTHER_APP | GTK_TARGET_SAME_APP;
  
      jobject keys;
      jobject keysIterator;
      jstring next;
  
<span class="line-modified">!     GtkTargetList *tlist = gtk_target_list_new(NULL, 0);</span>
  
      gint added_count = 0;
  
      keys = env-&gt;CallObjectMethod(data, jMapKeySet, NULL);
      JNI_EXCEPTION_TO_CPP(env)
      keysIterator = env-&gt;CallObjectMethod(keys, jIterableIterator, NULL);
      JNI_EXCEPTION_TO_CPP(env)
      while (env-&gt;CallBooleanMethod(keysIterator, jIteratorHasNext) == JNI_TRUE) {
<span class="line-modified">!         next = (jstring) env-&gt;CallObjectMethod(keysIterator, jIteratorNext, NULL);</span>
          JNI_EXCEPTION_TO_CPP(env)
          add_gtk_target_from_jstring(env, &amp;tlist, next, flags);
      }
  
      return tlist;
  }
  
<span class="line-modified">! static gboolean dnd_source_set_string(GtkWidget *widget, GtkSelectionData *data, GdkAtom atom) {</span>
      gboolean is_data_set;
  
<span class="line-modified">!     jstring string = (jstring) dnd_source_get_data(widget, &quot;text/plain&quot;);</span>
      if (!string) {
          return FALSE;
      }
  
      const char *cstring = mainEnv-&gt;GetStringUTFChars(string, NULL);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 538,21 ***</span>
      mainEnv-&gt;ReleaseStringUTFChars(string, cstring);
  
      return is_data_set;
  }
  
<span class="line-modified">! static gboolean dnd_source_set_image(GtkWidget *widget, GtkSelectionData *data, GdkAtom atom)</span>
<span class="line-removed">- {</span>
      jobject pixels = dnd_source_get_data(widget, &quot;application/x-java-rawimage&quot;);
      if (!pixels) {
          g_warning(&quot;DND source failed to set image\n&quot;);
          return FALSE;
      }
  
      gchar *buffer;
      gsize size;
<span class="line-modified">!     const char * type;</span>
      GdkPixbuf *pixbuf = NULL;
      gboolean is_data_set;
  
      mainEnv-&gt;CallVoidMethod(pixels, jPixelsAttachData, PTR_TO_JLONG(&amp;pixbuf));
  
<span class="line-new-header">--- 522,20 ---</span>
      mainEnv-&gt;ReleaseStringUTFChars(string, cstring);
  
      return is_data_set;
  }
  
<span class="line-modified">! static gboolean dnd_source_set_image(GtkWidget *widget, GtkSelectionData *data, GdkAtom atom) {</span>
      jobject pixels = dnd_source_get_data(widget, &quot;application/x-java-rawimage&quot;);
      if (!pixels) {
          g_warning(&quot;DND source failed to set image\n&quot;);
          return FALSE;
      }
  
      gchar *buffer;
      gsize size;
<span class="line-modified">!     const char *type;</span>
      GdkPixbuf *pixbuf = NULL;
      gboolean is_data_set;
  
      mainEnv-&gt;CallVoidMethod(pixels, jPixelsAttachData, PTR_TO_JLONG(&amp;pixbuf));
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 563,13 ***</span>
      g_object_unref(pixbuf);
  
      return is_data_set;
  }
  
<span class="line-modified">! static gboolean dnd_source_set_uri(GtkWidget *widget, GtkSelectionData *data, GdkAtom atom)</span>
<span class="line-modified">! {</span>
<span class="line-removed">-     const gchar* url = NULL;</span>
      jstring jurl = NULL;
  
      jobjectArray files_array = NULL;
      gsize files_cnt = 0;
  
<span class="line-new-header">--- 546,12 ---</span>
      g_object_unref(pixbuf);
  
      return is_data_set;
  }
  
<span class="line-modified">! static gboolean dnd_source_set_uri(GtkWidget *widget, GtkSelectionData *data, GdkAtom atom) {</span>
<span class="line-modified">!     const gchar *url = NULL;</span>
      jstring jurl = NULL;
  
      jobjectArray files_array = NULL;
      gsize files_cnt = 0;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 584,18 ***</span>
      if (!url &amp;&amp; !files_cnt) {
          return FALSE;
      }
  
      gboolean is_data_set;
<span class="line-modified">!     GString* res = g_string_new (NULL); //http://www.ietf.org/rfc/rfc2483.txt</span>
  
      if (files_cnt &gt; 0) {
          for (gsize i = 0; i &lt; files_cnt; ++i) {
              jstring string = (jstring) mainEnv-&gt;GetObjectArrayElement(files_array, i);
              EXCEPTION_OCCURED(mainEnv);
<span class="line-modified">!             const gchar* file = mainEnv-&gt;GetStringUTFChars(string, NULL);</span>
<span class="line-modified">!             gchar* uri = g_filename_to_uri(file, NULL, NULL);</span>
  
              g_string_append(res, uri);
              g_string_append(res, URI_LIST_LINE_BREAK);
  
              g_free(uri);
<span class="line-new-header">--- 566,18 ---</span>
      if (!url &amp;&amp; !files_cnt) {
          return FALSE;
      }
  
      gboolean is_data_set;
<span class="line-modified">!     GString *res = g_string_new(NULL); //http://www.ietf.org/rfc/rfc2483.txt</span>
  
      if (files_cnt &gt; 0) {
          for (gsize i = 0; i &lt; files_cnt; ++i) {
              jstring string = (jstring) mainEnv-&gt;GetObjectArrayElement(files_array, i);
              EXCEPTION_OCCURED(mainEnv);
<span class="line-modified">!             const gchar *file = mainEnv-&gt;GetStringUTFChars(string, NULL);</span>
<span class="line-modified">!             gchar *uri = g_filename_to_uri(file, NULL, NULL);</span>
  
              g_string_append(res, uri);
              g_string_append(res, URI_LIST_LINE_BREAK);
  
              g_free(uri);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 617,26 ***</span>
      g_free(uri[0]);
  
      return is_data_set;
  }
  
<span class="line-modified">! static gboolean dnd_source_set_raw(GtkWidget *widget, GtkSelectionData *sel_data, GdkAtom atom)</span>
<span class="line-removed">- {</span>
      gchar *target_name = gdk_atom_name(atom);
      jobject data = dnd_source_get_data(widget, target_name);
      gboolean is_data_set = FALSE;
      if (data) {
          if (mainEnv-&gt;IsInstanceOf(data, jStringCls)) {
<span class="line-modified">!             const char *cstring = mainEnv-&gt;GetStringUTFChars((jstring)data, NULL);</span>
              if (cstring) {
                  is_data_set = gtk_selection_data_set_text(sel_data, (gchar *) cstring, strlen(cstring));
<span class="line-modified">!                 mainEnv-&gt;ReleaseStringUTFChars((jstring)data, cstring);</span>
              }
          } else if (mainEnv-&gt;IsInstanceOf(data, jByteBufferCls)) {
<span class="line-modified">!             jbyteArray byteArray = (jbyteArray)mainEnv-&gt;CallObjectMethod(data, jByteBufferArray);</span>
              if (!EXCEPTION_OCCURED(mainEnv)) {
<span class="line-modified">!                 jbyte* raw = mainEnv-&gt;GetByteArrayElements(byteArray, NULL);</span>
                  if (raw) {
                      jsize nraw = mainEnv-&gt;GetArrayLength(byteArray);
                      gtk_selection_data_set(sel_data, atom, 8, (guchar *) raw, nraw);
                      mainEnv-&gt;ReleaseByteArrayElements(byteArray, raw, JNI_ABORT);
                      is_data_set = TRUE;
<span class="line-new-header">--- 599,25 ---</span>
      g_free(uri[0]);
  
      return is_data_set;
  }
  
<span class="line-modified">! static gboolean dnd_source_set_raw(GtkWidget *widget, GtkSelectionData *sel_data, GdkAtom atom) {</span>
      gchar *target_name = gdk_atom_name(atom);
      jobject data = dnd_source_get_data(widget, target_name);
      gboolean is_data_set = FALSE;
      if (data) {
          if (mainEnv-&gt;IsInstanceOf(data, jStringCls)) {
<span class="line-modified">!             const char *cstring = mainEnv-&gt;GetStringUTFChars((jstring) data, NULL);</span>
              if (cstring) {
                  is_data_set = gtk_selection_data_set_text(sel_data, (gchar *) cstring, strlen(cstring));
<span class="line-modified">!                 mainEnv-&gt;ReleaseStringUTFChars((jstring) data, cstring);</span>
              }
          } else if (mainEnv-&gt;IsInstanceOf(data, jByteBufferCls)) {
<span class="line-modified">!             jbyteArray byteArray = (jbyteArray) mainEnv-&gt;CallObjectMethod(data, jByteBufferArray);</span>
              if (!EXCEPTION_OCCURED(mainEnv)) {
<span class="line-modified">!                 jbyte *raw = mainEnv-&gt;GetByteArrayElements(byteArray, NULL);</span>
                  if (raw) {
                      jsize nraw = mainEnv-&gt;GetArrayLength(byteArray);
                      gtk_selection_data_set(sel_data, atom, 8, (guchar *) raw, nraw);
                      mainEnv-&gt;ReleaseByteArrayElements(byteArray, raw, JNI_ABORT);
                      is_data_set = TRUE;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 662,24 ***</span>
      return FALSE;
  }
  
  static void dnd_end_callback(GtkWidget *widget,
                               GdkDragContext *context,
<span class="line-modified">!                              gpointer user_data)</span>
<span class="line-removed">- {</span>
      if (drag_widget) {
          GdkDragAction action = gdk_drag_context_get_selected_action(context);
          dnd_set_performed_action(translate_gdk_action_to_glass(action));
      }
      gdk_threads_add_idle((GSourceFunc) dnd_destroy_drag_widget_callback, NULL);
  }
  
  static gboolean dnd_drag_failed_callback(GtkWidget *widget,
<span class="line-modified">!                                      GdkDragContext *context,</span>
<span class="line-modified">!                                      GtkDragResult result,</span>
<span class="line-modified">!                                      gpointer user_data)</span>
<span class="line-removed">- {</span>
      dnd_set_performed_action(com_sun_glass_ui_gtk_GtkDnDClipboard_ACTION_NONE);
      gdk_threads_add_idle((GSourceFunc) dnd_destroy_drag_widget_callback, NULL);
  
      return FALSE;
  }
<span class="line-new-header">--- 643,22 ---</span>
      return FALSE;
  }
  
  static void dnd_end_callback(GtkWidget *widget,
                               GdkDragContext *context,
<span class="line-modified">!                              gpointer user_data) {</span>
      if (drag_widget) {
          GdkDragAction action = gdk_drag_context_get_selected_action(context);
          dnd_set_performed_action(translate_gdk_action_to_glass(action));
      }
      gdk_threads_add_idle((GSourceFunc) dnd_destroy_drag_widget_callback, NULL);
  }
  
  static gboolean dnd_drag_failed_callback(GtkWidget *widget,
<span class="line-modified">!                                          GdkDragContext *context,</span>
<span class="line-modified">!                                          GtkDragResult result,</span>
<span class="line-modified">!                                          gpointer user_data) {</span>
      dnd_set_performed_action(com_sun_glass_ui_gtk_GtkDnDClipboard_ACTION_NONE);
      gdk_threads_add_idle((GSourceFunc) dnd_destroy_drag_widget_callback, NULL);
  
      return FALSE;
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 687,12 ***</span>
  static void dnd_data_get_callback(GtkWidget *widget,
                                    GdkDragContext *context,
                                    GtkSelectionData *data,
                                    guint info,
                                    guint time,
<span class="line-modified">!                                   gpointer user_data)</span>
<span class="line-removed">- {</span>
      GdkAtom atom = gtk_selection_data_get_target(data);
  
      switch (info) {
          case TARGET_TEXT:
              dnd_source_set_string(widget, data, atom);
<span class="line-new-header">--- 666,11 ---</span>
  static void dnd_data_get_callback(GtkWidget *widget,
                                    GdkDragContext *context,
                                    GtkSelectionData *data,
                                    guint info,
                                    guint time,
<span class="line-modified">!                                   gpointer user_data) {</span>
      GdkAtom atom = gtk_selection_data_get_target(data);
  
      switch (info) {
          case TARGET_TEXT:
              dnd_source_set_string(widget, data, atom);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 708,21 ***</span>
      }
  }
  
  static void dnd_drag_begin_callback(GtkWidget *widget,
                                      GdkDragContext *context,
<span class="line-modified">!                                     gpointer user_data)</span>
<span class="line-removed">- {</span>
      if (!is_grab_disabled()) {
          gtk_grab_add(drag_widget);
      }
  
      DragView::set_drag_view(widget, context);
  }
  
<span class="line-modified">! static void dnd_source_push_data(JNIEnv *env, jobject data, jint supported)</span>
<span class="line-removed">- {</span>
      if (supported == 0) {
          return; // No supported actions, do nothing
      }
  
      data = env-&gt;NewGlobalRef(data);
<span class="line-new-header">--- 686,19 ---</span>
      }
  }
  
  static void dnd_drag_begin_callback(GtkWidget *widget,
                                      GdkDragContext *context,
<span class="line-modified">!                                     gpointer user_data) {</span>
      if (!is_grab_disabled()) {
          gtk_grab_add(drag_widget);
      }
  
      DragView::set_drag_view(widget, context);
  }
  
<span class="line-modified">! static void dnd_source_push_data(JNIEnv *env, jobject data, jint supported) {</span>
      if (supported == 0) {
          return; // No supported actions, do nothing
      }
  
      data = env-&gt;NewGlobalRef(data);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 735,20 ***</span>
      gtk_widget_show(drag_widget);
  
      g_object_set_data_full(G_OBJECT(drag_widget), SOURCE_DND_DATA, data, clear_global_ref);
  
      g_signal_connect(drag_widget, &quot;drag-begin&quot;,
<span class="line-modified">!         G_CALLBACK(dnd_drag_begin_callback), NULL);</span>
  
      g_signal_connect(drag_widget, &quot;drag-failed&quot;,
<span class="line-modified">!         G_CALLBACK(dnd_drag_failed_callback), NULL);</span>
  
      g_signal_connect(drag_widget, &quot;drag-data-get&quot;,
<span class="line-modified">!         G_CALLBACK(dnd_data_get_callback), NULL);</span>
  
      g_signal_connect(drag_widget, &quot;drag-end&quot;,
<span class="line-modified">!         G_CALLBACK(dnd_end_callback), NULL);</span>
  
      GtkTargetList *tlist = data_to_gtk_target_list(env, data);
  
      GdkDragContext *context;
  
<span class="line-new-header">--- 711,20 ---</span>
      gtk_widget_show(drag_widget);
  
      g_object_set_data_full(G_OBJECT(drag_widget), SOURCE_DND_DATA, data, clear_global_ref);
  
      g_signal_connect(drag_widget, &quot;drag-begin&quot;,
<span class="line-modified">!                      G_CALLBACK(dnd_drag_begin_callback), NULL);</span>
  
      g_signal_connect(drag_widget, &quot;drag-failed&quot;,
<span class="line-modified">!                      G_CALLBACK(dnd_drag_failed_callback), NULL);</span>
  
      g_signal_connect(drag_widget, &quot;drag-data-get&quot;,
<span class="line-modified">!                      G_CALLBACK(dnd_data_get_callback), NULL);</span>
  
      g_signal_connect(drag_widget, &quot;drag-end&quot;,
<span class="line-modified">!                      G_CALLBACK(dnd_end_callback), NULL);</span>
  
      GtkTargetList *tlist = data_to_gtk_target_list(env, data);
  
      GdkDragContext *context;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 764,15 ***</span>
  #endif
  
      gtk_target_list_unref(tlist);
  }
  
<span class="line-modified">! jint execute_dnd(JNIEnv *env, jobject data, jint supported)</span>
<span class="line-removed">- {</span>
      try {
          dnd_source_push_data(env, data, supported);
<span class="line-modified">!     } catch (jni_exception&amp;) {</span>
          gdk_threads_add_idle((GSourceFunc) dnd_destroy_drag_widget_callback, NULL);
          return com_sun_glass_ui_gtk_GtkDnDClipboard_ACTION_NONE;
      }
  
      while (is_in_drag()) {
<span class="line-new-header">--- 740,14 ---</span>
  #endif
  
      gtk_target_list_unref(tlist);
  }
  
<span class="line-modified">! jint execute_dnd(JNIEnv *env, jobject data, jint supported) {</span>
      try {
          dnd_source_push_data(env, data, supported);
<span class="line-modified">!     } catch (jni_exception &amp;) {</span>
          gdk_threads_add_idle((GSourceFunc) dnd_destroy_drag_widget_callback, NULL);
          return com_sun_glass_ui_gtk_GtkDnDClipboard_ACTION_NONE;
      }
  
      while (is_in_drag()) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 780,25 ***</span>
      }
  
      return dnd_get_performed_action();
  }
  
<span class="line-modified">!  /******************** DRAG VIEW ***************************/</span>
<span class="line-modified">!  DragView::View* DragView::view = NULL;</span>
  
<span class="line-modified">!  gboolean DragView::get_drag_image_offset(GtkWidget *widget, int* x, int* y)</span>
<span class="line-removed">-  {</span>
      gboolean offset_set = FALSE;
      jobject bb = dnd_source_get_data(widget, &quot;application/x-java-drag-image-offset&quot;);
      if (bb) {
<span class="line-modified">!         jbyteArray byteArray = (jbyteArray)mainEnv-&gt;CallObjectMethod(bb, jByteBufferArray);</span>
          if (!EXCEPTION_OCCURED(mainEnv)) {
<span class="line-modified">!             jbyte* raw = mainEnv-&gt;GetByteArrayElements(byteArray, NULL);</span>
              jsize nraw = mainEnv-&gt;GetArrayLength(byteArray);
  
              if ((size_t) nraw &gt;= sizeof(jint) * 2) {
<span class="line-modified">!                 jint* r = (jint*) raw;</span>
                  *x = BSWAP_32(r[0]);
                  *y = BSWAP_32(r[1]);
                  offset_set = TRUE;
              }
  
<span class="line-new-header">--- 755,24 ---</span>
      }
  
      return dnd_get_performed_action();
  }
  
<span class="line-modified">! /******************** DRAG VIEW ***************************/</span>
<span class="line-modified">! DragView::View *DragView::view = NULL;</span>
  
<span class="line-modified">! gboolean DragView::get_drag_image_offset(GtkWidget *widget, int *x, int *y) {</span>
      gboolean offset_set = FALSE;
      jobject bb = dnd_source_get_data(widget, &quot;application/x-java-drag-image-offset&quot;);
      if (bb) {
<span class="line-modified">!         jbyteArray byteArray = (jbyteArray) mainEnv-&gt;CallObjectMethod(bb, jByteBufferArray);</span>
          if (!EXCEPTION_OCCURED(mainEnv)) {
<span class="line-modified">!             jbyte *raw = mainEnv-&gt;GetByteArrayElements(byteArray, NULL);</span>
              jsize nraw = mainEnv-&gt;GetArrayLength(byteArray);
  
              if ((size_t) nraw &gt;= sizeof(jint) * 2) {
<span class="line-modified">!                 jint *r = (jint *) raw;</span>
                  *x = BSWAP_32(r[0]);
                  *y = BSWAP_32(r[1]);
                  offset_set = TRUE;
              }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 806,35 ***</span>
          }
      }
      return offset_set;
  }
  
<span class="line-modified">! GdkPixbuf* DragView::get_drag_image(GtkWidget *widget, gboolean* is_raw_image, gint* width, gint* height)</span>
<span class="line-removed">- {</span>
      GdkPixbuf *pixbuf = NULL;
      gboolean is_raw = FALSE;
  
      jobject drag_image = dnd_source_get_data(widget, &quot;application/x-java-drag-image&quot;);
  
      if (drag_image) {
          jbyteArray byteArray = (jbyteArray) mainEnv-&gt;CallObjectMethod(drag_image, jByteBufferArray);
          if (!EXCEPTION_OCCURED(mainEnv)) {
  
<span class="line-modified">!             jbyte* raw = mainEnv-&gt;GetByteArrayElements(byteArray, NULL);</span>
              jsize nraw = mainEnv-&gt;GetArrayLength(byteArray);
  
              int w = 0, h = 0;
              int whsz = sizeof(jint) * 2; // Pixels are stored right after two ints
              // in this byteArray: width and height
              if (nraw &gt; whsz) {
<span class="line-modified">!                 jint* int_raw = (jint*) raw;</span>
                  w = BSWAP_32(int_raw[0]);
                  h = BSWAP_32(int_raw[1]);
  
                  // We should have enough pixels for requested width and height
<span class="line-modified">!                 if ((nraw - whsz) / 4 - w * h &gt;= 0 ) {</span>
<span class="line-modified">!                     guchar* data = (guchar*) g_try_malloc0(nraw - whsz);</span>
                      if (data) {
                          memcpy(data, (raw + whsz), nraw - whsz);
                          pixbuf = gdk_pixbuf_new_from_data(data, GDK_COLORSPACE_RGB, TRUE, 8,
                                                            w, h, w * 4, pixbufDestroyNotifyFunc, NULL);
                      }
<span class="line-new-header">--- 780,34 ---</span>
          }
      }
      return offset_set;
  }
  
<span class="line-modified">! GdkPixbuf *DragView::get_drag_image(GtkWidget *widget, gboolean *is_raw_image, gint *width, gint *height) {</span>
      GdkPixbuf *pixbuf = NULL;
      gboolean is_raw = FALSE;
  
      jobject drag_image = dnd_source_get_data(widget, &quot;application/x-java-drag-image&quot;);
  
      if (drag_image) {
          jbyteArray byteArray = (jbyteArray) mainEnv-&gt;CallObjectMethod(drag_image, jByteBufferArray);
          if (!EXCEPTION_OCCURED(mainEnv)) {
  
<span class="line-modified">!             jbyte *raw = mainEnv-&gt;GetByteArrayElements(byteArray, NULL);</span>
              jsize nraw = mainEnv-&gt;GetArrayLength(byteArray);
  
              int w = 0, h = 0;
              int whsz = sizeof(jint) * 2; // Pixels are stored right after two ints
              // in this byteArray: width and height
              if (nraw &gt; whsz) {
<span class="line-modified">!                 jint *int_raw = (jint *) raw;</span>
                  w = BSWAP_32(int_raw[0]);
                  h = BSWAP_32(int_raw[1]);
  
                  // We should have enough pixels for requested width and height
<span class="line-modified">!                 if ((nraw - whsz) / 4 - w * h &gt;= 0) {</span>
<span class="line-modified">!                     guchar *data = (guchar *) g_try_malloc0(nraw - whsz);</span>
                      if (data) {
                          memcpy(data, (raw + whsz), nraw - whsz);
                          pixbuf = gdk_pixbuf_new_from_data(data, GDK_COLORSPACE_RGB, TRUE, 8,
                                                            w, h, w * 4, pixbufDestroyNotifyFunc, NULL);
                      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 859,12 ***</span>
  
      int w = gdk_pixbuf_get_width(pixbuf);
      int h = gdk_pixbuf_get_height(pixbuf);
  
      if (w &gt; DRAG_IMAGE_MAX_WIDTH || h &gt; DRAG_IMAGE_MAX_HEIGH) {
<span class="line-modified">!         double rw = DRAG_IMAGE_MAX_WIDTH / (double)w;</span>
<span class="line-modified">!         double rh =  DRAG_IMAGE_MAX_HEIGH / (double)h;</span>
          double r = MIN(rw, rh);
  
          int new_w = w * r;
          int new_h = h * r;
  
<span class="line-new-header">--- 832,12 ---</span>
  
      int w = gdk_pixbuf_get_width(pixbuf);
      int h = gdk_pixbuf_get_height(pixbuf);
  
      if (w &gt; DRAG_IMAGE_MAX_WIDTH || h &gt; DRAG_IMAGE_MAX_HEIGH) {
<span class="line-modified">!         double rw = DRAG_IMAGE_MAX_WIDTH / (double) w;</span>
<span class="line-modified">!         double rh = DRAG_IMAGE_MAX_HEIGH / (double) h;</span>
          double r = MIN(rw, rh);
  
          int new_w = w * r;
          int new_h = h * r;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 884,55 ***</span>
      *height = h;
  
      return pixbuf;
  }
  
<span class="line-modified">! void DragView::set_drag_view(GtkWidget *widget, GdkDragContext *context)</span>
<span class="line-removed">- {</span>
      gboolean is_raw_image = FALSE;
      gint w = 0, h = 0;
<span class="line-modified">!     GdkPixbuf* pixbuf = get_drag_image(widget, &amp;is_raw_image, &amp;w, &amp;h);</span>
  
      if (GDK_IS_PIXBUF(pixbuf)) {
          gint offset_x = w / 2;
          gint offset_y = h / 2;
  
          gboolean is_offset_set = get_drag_image_offset(widget, &amp;offset_x, &amp;offset_y);
  
          DragView::view = new DragView::View(context, pixbuf, w, h, is_raw_image,
<span class="line-modified">!             is_offset_set, offset_x, offset_y);</span>
      }
  }
  
<span class="line-modified">! static void on_screen_changed(GtkWidget *widget, GdkScreen *previous_screen, gpointer view)</span>
<span class="line-modified">! {</span>
<span class="line-modified">!     (void)widget;</span>
<span class="line-removed">-     (void)previous_screen;</span>
  
<span class="line-modified">!     ((DragView::View*) view)-&gt;screen_changed();</span>
  }
  
<span class="line-modified">! static gboolean on_expose(GtkWidget *widget, GdkEventExpose *event, gpointer view)</span>
<span class="line-modified">! {</span>
<span class="line-modified">!     (void)widget;</span>
<span class="line-removed">-     (void)event;</span>
  
<span class="line-modified">!     ((DragView::View*) view)-&gt;expose();</span>
      return FALSE;
  }
  
<span class="line-modified">! DragView::View::View(GdkDragContext* _context, GdkPixbuf* _pixbuf, gint _width, gint _height,</span>
                       gboolean _is_raw_image, gboolean _is_offset_set, gint _offset_x, gint _offset_y) :
<span class="line-modified">!     context(_context),</span>
<span class="line-modified">!     pixbuf(_pixbuf),</span>
<span class="line-modified">!     width(_width),</span>
<span class="line-modified">!     height(_height),</span>
<span class="line-modified">!     is_raw_image(_is_raw_image),</span>
<span class="line-modified">!     is_offset_set(_is_offset_set),</span>
<span class="line-modified">!     offset_x(_offset_x),</span>
<span class="line-modified">!     offset_y(_offset_y)</span>
<span class="line-removed">- {</span>
  #ifdef GLASS_GTK3
      gtk_drag_set_icon_pixbuf(context, pixbuf, offset_x, offset_y);
  #else
      widget = gtk_window_new(GTK_WINDOW_POPUP);
      gtk_window_set_type_hint(GTK_WINDOW(widget), GDK_WINDOW_TYPE_HINT_DND);
<span class="line-new-header">--- 857,51 ---</span>
      *height = h;
  
      return pixbuf;
  }
  
<span class="line-modified">! void DragView::set_drag_view(GtkWidget *widget, GdkDragContext *context) {</span>
      gboolean is_raw_image = FALSE;
      gint w = 0, h = 0;
<span class="line-modified">!     GdkPixbuf *pixbuf = get_drag_image(widget, &amp;is_raw_image, &amp;w, &amp;h);</span>
  
      if (GDK_IS_PIXBUF(pixbuf)) {
          gint offset_x = w / 2;
          gint offset_y = h / 2;
  
          gboolean is_offset_set = get_drag_image_offset(widget, &amp;offset_x, &amp;offset_y);
  
          DragView::view = new DragView::View(context, pixbuf, w, h, is_raw_image,
<span class="line-modified">!                                             is_offset_set, offset_x, offset_y);</span>
      }
  }
  
<span class="line-modified">! static void on_screen_changed(GtkWidget *widget, GdkScreen *previous_screen, gpointer view) {</span>
<span class="line-modified">!     (void) widget;</span>
<span class="line-modified">!     (void) previous_screen;</span>
  
<span class="line-modified">!     ((DragView::View *) view)-&gt;screen_changed();</span>
  }
  
<span class="line-modified">! static gboolean on_expose(GtkWidget *widget, GdkEventExpose *event, gpointer view) {</span>
<span class="line-modified">!     (void) widget;</span>
<span class="line-modified">!     (void) event;</span>
  
<span class="line-modified">!     ((DragView::View *) view)-&gt;expose();</span>
      return FALSE;
  }
  
<span class="line-modified">! DragView::View::View(GdkDragContext *_context, GdkPixbuf *_pixbuf, gint _width, gint _height,</span>
                       gboolean _is_raw_image, gboolean _is_offset_set, gint _offset_x, gint _offset_y) :
<span class="line-modified">!         context(_context),</span>
<span class="line-modified">!         pixbuf(_pixbuf),</span>
<span class="line-modified">!         width(_width),</span>
<span class="line-modified">!         height(_height),</span>
<span class="line-modified">!         is_raw_image(_is_raw_image),</span>
<span class="line-modified">!         is_offset_set(_is_offset_set),</span>
<span class="line-modified">!         offset_x(_offset_x),</span>
<span class="line-modified">!         offset_y(_offset_y) {</span>
  #ifdef GLASS_GTK3
      gtk_drag_set_icon_pixbuf(context, pixbuf, offset_x, offset_y);
  #else
      widget = gtk_window_new(GTK_WINDOW_POPUP);
      gtk_window_set_type_hint(GTK_WINDOW(widget), GDK_WINDOW_TYPE_HINT_DND);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 951,12 ***</span>
      gtk_widget_show_all(widget);
      gtk_drag_set_icon_widget(context, widget, offset_x, offset_y);
  #endif
  }
  
<span class="line-modified">! void DragView::View::screen_changed()</span>
<span class="line-removed">- {</span>
      GdkScreen *screen = gtk_widget_get_screen(widget);
  
      glass_configure_window_transparency(widget, true);
  
      if (!gdk_screen_is_composited(screen)) {
<span class="line-new-header">--- 920,11 ---</span>
      gtk_widget_show_all(widget);
      gtk_drag_set_icon_widget(context, widget, offset_x, offset_y);
  #endif
  }
  
<span class="line-modified">! void DragView::View::screen_changed() {</span>
      GdkScreen *screen = gtk_widget_get_screen(widget);
  
      glass_configure_window_transparency(widget, true);
  
      if (!gdk_screen_is_composited(screen)) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 965,21 ***</span>
              offset_y = 1;
          }
      }
  }
  
<span class="line-modified">! void DragView::View::expose()</span>
<span class="line-removed">- {</span>
      cairo_t *context = gdk_cairo_create(gtk_widget_get_window(widget));
  
<span class="line-modified">!     cairo_surface_t* cairo_surface;</span>
  
<span class="line-modified">!     guchar* pixels = is_raw_image</span>
<span class="line-modified">!             ? (guchar*) convert_BGRA_to_RGBA((const int*) gdk_pixbuf_get_pixels(pixbuf),</span>
<span class="line-modified">!                                                 gdk_pixbuf_get_rowstride(pixbuf),</span>
<span class="line-modified">!                                                 height)</span>
<span class="line-modified">!             : gdk_pixbuf_get_pixels(pixbuf);</span>
  
      cairo_surface = cairo_image_surface_create_for_data(
              pixels,
              CAIRO_FORMAT_ARGB32,
              width, height, width * 4);
<span class="line-new-header">--- 933,20 ---</span>
              offset_y = 1;
          }
      }
  }
  
<span class="line-modified">! void DragView::View::expose() {</span>
      cairo_t *context = gdk_cairo_create(gtk_widget_get_window(widget));
  
<span class="line-modified">!     cairo_surface_t *cairo_surface;</span>
  
<span class="line-modified">!     guchar *pixels = is_raw_image</span>
<span class="line-modified">!                      ? (guchar *) convert_BGRA_to_RGBA((const int *) gdk_pixbuf_get_pixels(pixbuf),</span>
<span class="line-modified">!                                                        gdk_pixbuf_get_rowstride(pixbuf),</span>
<span class="line-modified">!                                                        height)</span>
<span class="line-modified">!                      : gdk_pixbuf_get_pixels(pixbuf);</span>
  
      cairo_surface = cairo_image_surface_create_for_data(
              pixels,
              CAIRO_FORMAT_ARGB32,
              width, height, width * 4);
</pre>
<center><a href="GlassWindow.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../index.html" target="_top">index</a> <a href="glass_window.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>