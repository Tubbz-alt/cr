<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.media/src/main/native/gstreamer/3rd_party/glib/glib/gdate.c</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="gdatasetprivate.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="gdate.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.media/src/main/native/gstreamer/3rd_party/glib/glib/gdate.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 27,11 ***</span>
   */
  
  #include &quot;config.h&quot;
  #include &quot;glibconfig.h&quot;
  
<span class="line-modified">! #define DEBUG_MSG(x)    /* */</span>
  #ifdef G_ENABLE_DEBUG
  /* #define DEBUG_MSG(args)  g_message args ; */
  #endif
  
  #include &lt;time.h&gt;
<span class="line-new-header">--- 27,11 ---</span>
   */
  
  #include &quot;config.h&quot;
  #include &quot;glibconfig.h&quot;
  
<span class="line-modified">! #define DEBUG_MSG(x)  /* */</span>
  #ifdef G_ENABLE_DEBUG
  /* #define DEBUG_MSG(args)  g_message args ; */
  #endif
  
  #include &lt;time.h&gt;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 116,15 ***</span>
   *
   * Represents a precise time, with seconds and microseconds.
   * Similar to the struct timeval returned by the gettimeofday()
   * UNIX system call.
   *
<span class="line-modified">!  * GLib is attempting to unify around the use of 64bit integers to</span>
   * represent microsecond-precision time. As such, this type will be
   * removed from a future version of GLib. A consequence of using `glong` for
   * `tv_sec` is that on 32-bit systems `GTimeVal` is subject to the year 2038
   * problem.
   */
  
  /**
   * GDate:
   * @julian_days: the Julian representation of the date
<span class="line-new-header">--- 116,17 ---</span>
   *
   * Represents a precise time, with seconds and microseconds.
   * Similar to the struct timeval returned by the gettimeofday()
   * UNIX system call.
   *
<span class="line-modified">!  * GLib is attempting to unify around the use of 64-bit integers to</span>
   * represent microsecond-precision time. As such, this type will be
   * removed from a future version of GLib. A consequence of using `glong` for
   * `tv_sec` is that on 32-bit systems `GTimeVal` is subject to the year 2038
   * problem.
<span class="line-added">+  *</span>
<span class="line-added">+  * Deprecated: 2.62: Use #GDateTime or #guint64 instead.</span>
   */
  
  /**
   * GDate:
   * @julian_days: the Julian representation of the date
</pre>
<hr />
<pre>
<span class="line-old-header">*** 150,16 ***</span>
   */
  
  /**
   * GTime:
   *
<span class="line-modified">!  * Simply a replacement for time_t. It has been deprecated</span>
<span class="line-modified">!  * since it is not equivalent to time_t on 64-bit platforms</span>
<span class="line-modified">!  * with a 64-bit time_t. Unrelated to #GTimer.</span>
   *
   * Note that #GTime is defined to always be a 32-bit integer,
<span class="line-modified">!  * unlike time_t which may be 64-bit on some systems. Therefore,</span>
   * #GTime will overflow in the year 2038, and you cannot use the
   * address of a #GTime variable as argument to the UNIX time()
   * function.
   *
   * Instead, do the following:
<span class="line-new-header">--- 152,16 ---</span>
   */
  
  /**
   * GTime:
   *
<span class="line-modified">!  * Simply a replacement for `time_t`. It has been deprecated</span>
<span class="line-modified">!  * since it is not equivalent to `time_t` on 64-bit platforms</span>
<span class="line-modified">!  * with a 64-bit `time_t`. Unrelated to #GTimer.</span>
   *
   * Note that #GTime is defined to always be a 32-bit integer,
<span class="line-modified">!  * unlike `time_t` which may be 64-bit on some systems. Therefore,</span>
   * #GTime will overflow in the year 2038, and you cannot use the
   * address of a #GTime variable as argument to the UNIX time()
   * function.
   *
   * Instead, do the following:
</pre>
<hr />
<pre>
<span class="line-old-header">*** 168,10 ***</span>
<span class="line-new-header">--- 170,13 ---</span>
   * GTime gtime;
   *
   * time (&amp;ttime);
   * gtime = (GTime)ttime;
   * ]|
<span class="line-added">+  *</span>
<span class="line-added">+  * Deprecated: 2.62: This is not [Y2038-safe](https://en.wikipedia.org/wiki/Year_2038_problem).</span>
<span class="line-added">+  *    Use #GDateTime or #time_t instead.</span>
   */
  
  /**
   * GDateDMY:
   * @G_DATE_DAY: a day
</pre>
<hr />
<pre>
<span class="line-old-header">*** 492,20 ***</span>
   * Returns: %TRUE if the date is a valid one
   */
  gboolean
  g_date_valid_dmy (GDateDay   d,
                    GDateMonth m,
<span class="line-modified">!           GDateYear  y)</span>
  {
    /* No need to check the upper bound of @y, because #GDateYear is 16 bits wide,
     * just like #GDate.year. */
    return ( (m &gt; G_DATE_BAD_MONTH) &amp;&amp;
             (m &lt; 13)               &amp;&amp;
             (d &gt; G_DATE_BAD_DAY)   &amp;&amp;
             (y &gt; G_DATE_BAD_YEAR)  &amp;&amp;   /* must check before using g_date_is_leap_year */
             (d &lt;=  (g_date_is_leap_year (y) ?
<span class="line-modified">!            days_in_months[1][m] : days_in_months[0][m])) );</span>
  }
  
  
  /* &quot;Julian days&quot; just means an absolute number of days, where Day 1 ==
   *   Jan 1, Year 1
<span class="line-new-header">--- 497,20 ---</span>
   * Returns: %TRUE if the date is a valid one
   */
  gboolean
  g_date_valid_dmy (GDateDay   d,
                    GDateMonth m,
<span class="line-modified">!       GDateYear  y)</span>
  {
    /* No need to check the upper bound of @y, because #GDateYear is 16 bits wide,
     * just like #GDate.year. */
    return ( (m &gt; G_DATE_BAD_MONTH) &amp;&amp;
             (m &lt; 13)               &amp;&amp;
             (d &gt; G_DATE_BAD_DAY)   &amp;&amp;
             (y &gt; G_DATE_BAD_YEAR)  &amp;&amp;   /* must check before using g_date_is_leap_year */
             (d &lt;=  (g_date_is_leap_year (y) ?
<span class="line-modified">!        days_in_months[1][m] : days_in_months[0][m])) );</span>
  }
  
  
  /* &quot;Julian days&quot; just means an absolute number of days, where Day 1 ==
   *   Jan 1, Year 1
</pre>
<hr />
<pre>
<span class="line-old-header">*** 580,11 ***</span>
    y = 100 * B + D - 4800 + (M/10);
  
  #ifdef G_ENABLE_DEBUG
    if (!g_date_valid_dmy (day, m, y))
      g_warning (&quot;OOPS julian: %u  computed dmy: %u %u %u&quot;,
<span class="line-modified">!            d-&gt;julian_days, day, m, y);</span>
  #endif
  
    d-&gt;month = m;
    d-&gt;day   = day;
    d-&gt;year  = y;
<span class="line-new-header">--- 585,11 ---</span>
    y = 100 * B + D - 4800 + (M/10);
  
  #ifdef G_ENABLE_DEBUG
    if (!g_date_valid_dmy (day, m, y))
      g_warning (&quot;OOPS julian: %u  computed dmy: %u %u %u&quot;,
<span class="line-modified">!          d-&gt;julian_days, day, m, y);</span>
  #endif
  
    d-&gt;month = m;
    d-&gt;day   = day;
    d-&gt;year  = y;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 842,11 ***</span>
   *
   * Returns: the number of days between @date1 and @date2
   */
  gint
  g_date_days_between (const GDate *d1,
<span class="line-modified">!              const GDate *d2)</span>
  {
    g_return_val_if_fail (g_date_valid (d1), 0);
    g_return_val_if_fail (g_date_valid (d2), 0);
  
    return (gint)g_date_get_julian (d2) - (gint)g_date_get_julian (d1);
<span class="line-new-header">--- 847,11 ---</span>
   *
   * Returns: the number of days between @date1 and @date2
   */
  gint
  g_date_days_between (const GDate *d1,
<span class="line-modified">!          const GDate *d2)</span>
  {
    g_return_val_if_fail (g_date_valid (d1), 0);
    g_return_val_if_fail (g_date_valid (d2), 0);
  
    return (gint)g_date_get_julian (d2) - (gint)g_date_get_julian (d1);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1017,30 ***</span>
             * Note that most of the languages can&#39;t or don&#39;t use the the
             * genitive case here so they use nominative everywhere.
             * For example, English always uses &quot;January&quot;.
             */
            if (update_month_match (&amp;longest, normalized, long_month_names[i]))
<span class="line-modified">!                   pt-&gt;month = i;</span>
  
            /* Here month names will be in a nominative case.
             * Examples of how January may look in some languages:
             * Catalan: &quot;gener&quot;, Croatian: &quot;gener&quot;, Polish: &quot;gener&quot;,
             * Upper Sorbian: &quot;Januar&quot;.
             */
            if (update_month_match (&amp;longest, normalized, long_month_names_alternative[i]))
<span class="line-modified">!                   pt-&gt;month = i;</span>
  
            /* Differences between abbreviated nominative and abbreviated
             * genitive month names are visible in very few languages but
             * let&#39;s handle them.
             */
            if (update_month_match (&amp;longest, normalized, short_month_names[i]))
<span class="line-modified">!                   pt-&gt;month = i;</span>
  
            if (update_month_match (&amp;longest, normalized, short_month_names_alternative[i]))
<span class="line-modified">!                   pt-&gt;month = i;</span>
<span class="line-modified">!                 }</span>
  
        g_free (normalized);
      }
  }
  
<span class="line-new-header">--- 1022,30 ---</span>
             * Note that most of the languages can&#39;t or don&#39;t use the the
             * genitive case here so they use nominative everywhere.
             * For example, English always uses &quot;January&quot;.
             */
            if (update_month_match (&amp;longest, normalized, long_month_names[i]))
<span class="line-modified">!             pt-&gt;month = i;</span>
  
            /* Here month names will be in a nominative case.
             * Examples of how January may look in some languages:
             * Catalan: &quot;gener&quot;, Croatian: &quot;gener&quot;, Polish: &quot;gener&quot;,
             * Upper Sorbian: &quot;Januar&quot;.
             */
            if (update_month_match (&amp;longest, normalized, long_month_names_alternative[i]))
<span class="line-modified">!             pt-&gt;month = i;</span>
  
            /* Differences between abbreviated nominative and abbreviated
             * genitive month names are visible in very few languages but
             * let&#39;s handle them.
             */
            if (update_month_match (&amp;longest, normalized, short_month_names[i]))
<span class="line-modified">!             pt-&gt;month = i;</span>
  
            if (update_month_match (&amp;longest, normalized, short_month_names_alternative[i]))
<span class="line-modified">!             pt-&gt;month = i;</span>
<span class="line-modified">!         }</span>
  
        g_free (normalized);
      }
  }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1073,28 ***</span>
        short_month_names[0] = &quot;Error&quot;;
        long_month_names[0] = &quot;Error&quot;;
  
        while (i &lt; 13)
          {
<span class="line-modified">!       gchar *casefold;</span>
  
            g_date_set_dmy (&amp;d, 1, i, 1976);
  
            g_return_if_fail (g_date_valid (&amp;d));
  
            g_date_strftime (buf, 127, &quot;%b&quot;, &amp;d);
  
<span class="line-modified">!       casefold = g_utf8_casefold (buf, -1);</span>
            g_free (short_month_names[i]);
            short_month_names[i] = g_utf8_normalize (casefold, -1, G_NORMALIZE_ALL);
<span class="line-modified">!       g_free (casefold);</span>
  
            g_date_strftime (buf, 127, &quot;%B&quot;, &amp;d);
<span class="line-modified">!       casefold = g_utf8_casefold (buf, -1);</span>
            g_free (long_month_names[i]);
            long_month_names[i] = g_utf8_normalize (casefold, -1, G_NORMALIZE_ALL);
<span class="line-modified">!       g_free (casefold);</span>
  
            g_date_strftime (buf, 127, &quot;%Ob&quot;, &amp;d);
            casefold = g_utf8_casefold (buf, -1);
            g_free (short_month_names_alternative[i]);
            short_month_names_alternative[i] = g_utf8_normalize (casefold, -1, G_NORMALIZE_ALL);
<span class="line-new-header">--- 1078,28 ---</span>
        short_month_names[0] = &quot;Error&quot;;
        long_month_names[0] = &quot;Error&quot;;
  
        while (i &lt; 13)
          {
<span class="line-modified">!     gchar *casefold;</span>
  
            g_date_set_dmy (&amp;d, 1, i, 1976);
  
            g_return_if_fail (g_date_valid (&amp;d));
  
            g_date_strftime (buf, 127, &quot;%b&quot;, &amp;d);
  
<span class="line-modified">!     casefold = g_utf8_casefold (buf, -1);</span>
            g_free (short_month_names[i]);
            short_month_names[i] = g_utf8_normalize (casefold, -1, G_NORMALIZE_ALL);
<span class="line-modified">!     g_free (casefold);</span>
  
            g_date_strftime (buf, 127, &quot;%B&quot;, &amp;d);
<span class="line-modified">!     casefold = g_utf8_casefold (buf, -1);</span>
            g_free (long_month_names[i]);
            long_month_names[i] = g_utf8_normalize (casefold, -1, G_NORMALIZE_ALL);
<span class="line-modified">!     g_free (casefold);</span>
  
            g_date_strftime (buf, 127, &quot;%Ob&quot;, &amp;d);
            casefold = g_utf8_casefold (buf, -1);
            g_free (short_month_names_alternative[i]);
            short_month_names_alternative[i] = g_utf8_normalize (casefold, -1, G_NORMALIZE_ALL);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1165,11 ***</span>
            DEBUG_MSG ((&quot;  %s   %s&quot;, long_month_names_alternative[i], short_month_names_alternative[i]));
            ++i;
          }
        if (using_twodigit_years)
          {
<span class="line-modified">!       DEBUG_MSG ((&quot;**Using twodigit years with cutoff year: %u&quot;, twodigit_start_year));</span>
          }
        {
          gchar *strings[3];
          i = 0;
          while (i &lt; 3)
<span class="line-new-header">--- 1170,11 ---</span>
            DEBUG_MSG ((&quot;  %s   %s&quot;, long_month_names_alternative[i], short_month_names_alternative[i]));
            ++i;
          }
        if (using_twodigit_years)
          {
<span class="line-modified">!     DEBUG_MSG ((&quot;**Using twodigit years with cutoff year: %u&quot;, twodigit_start_year));</span>
          }
        {
          gchar *strings[3];
          i = 0;
          while (i &lt; 3)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1232,11 ***</span>
    G_LOCK (g_date_global);
  
    g_date_prepare_to_parse (str, &amp;pt);
  
    DEBUG_MSG ((&quot;Found %d ints, &#39;%d&#39; &#39;%d&#39; &#39;%d&#39; and written out month %d&quot;,
<span class="line-modified">!           pt.num_ints, pt.n[0], pt.n[1], pt.n[2], pt.month));</span>
  
  
    if (pt.num_ints == 4)
      {
        G_UNLOCK (g_date_global);
<span class="line-new-header">--- 1237,11 ---</span>
    G_LOCK (g_date_global);
  
    g_date_prepare_to_parse (str, &amp;pt);
  
    DEBUG_MSG ((&quot;Found %d ints, &#39;%d&#39; &#39;%d&#39; &#39;%d&#39; and written out month %d&quot;,
<span class="line-modified">!         pt.num_ints, pt.n[0], pt.n[1], pt.n[2], pt.month));</span>
  
  
    if (pt.num_ints == 4)
      {
        G_UNLOCK (g_date_global);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1253,52 ***</span>
        while (i &lt; pt.num_ints &amp;&amp; j &lt; 3)
          {
            switch (dmy_order[j])
              {
              case G_DATE_MONTH:
<span class="line-modified">!         {</span>
<span class="line-modified">!           if (pt.num_ints == 2 &amp;&amp; pt.month != G_DATE_BAD_MONTH)</span>
<span class="line-modified">!         {</span>
<span class="line-modified">!           m = pt.month;</span>
<span class="line-modified">!           ++j;      /* skip months, but don&#39;t skip this number */</span>
<span class="line-modified">!           continue;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!           else</span>
<span class="line-modified">!         m = pt.n[i];</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         break;</span>
              case G_DATE_DAY:
<span class="line-modified">!         {</span>
<span class="line-modified">!           if (pt.num_ints == 2 &amp;&amp; pt.month == G_DATE_BAD_MONTH)</span>
<span class="line-modified">!         {</span>
<span class="line-modified">!           day = 1;</span>
<span class="line-modified">!           ++j;      /* skip days, since we may have month/year */</span>
<span class="line-modified">!           continue;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!           day = pt.n[i];</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         break;</span>
              case G_DATE_YEAR:
<span class="line-modified">!         {</span>
<span class="line-modified">!           y  = pt.n[i];</span>
  
<span class="line-modified">!           if (locale_era_adjust != 0)</span>
<span class="line-modified">!             {</span>
<span class="line-modified">!           y += locale_era_adjust;</span>
<span class="line-modified">!             }</span>
<span class="line-modified">!           else if (using_twodigit_years &amp;&amp; y &lt; 100)</span>
<span class="line-modified">!         {</span>
<span class="line-modified">!           guint two     =  twodigit_start_year % 100;</span>
<span class="line-modified">!           guint century = (twodigit_start_year / 100) * 100;</span>
  
<span class="line-modified">!           if (y &lt; two)</span>
<span class="line-modified">!             century += 100;</span>
  
<span class="line-modified">!           y += century;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         break;</span>
              default:
                break;
              }
  
            ++i;
<span class="line-new-header">--- 1258,52 ---</span>
        while (i &lt; pt.num_ints &amp;&amp; j &lt; 3)
          {
            switch (dmy_order[j])
              {
              case G_DATE_MONTH:
<span class="line-modified">!       {</span>
<span class="line-modified">!         if (pt.num_ints == 2 &amp;&amp; pt.month != G_DATE_BAD_MONTH)</span>
<span class="line-modified">!     {</span>
<span class="line-modified">!       m = pt.month;</span>
<span class="line-modified">!       ++j;      /* skip months, but don&#39;t skip this number */</span>
<span class="line-modified">!       continue;</span>
<span class="line-modified">!     }</span>
<span class="line-modified">!         else</span>
<span class="line-modified">!     m = pt.n[i];</span>
<span class="line-modified">!       }</span>
<span class="line-modified">!       break;</span>
              case G_DATE_DAY:
<span class="line-modified">!       {</span>
<span class="line-modified">!         if (pt.num_ints == 2 &amp;&amp; pt.month == G_DATE_BAD_MONTH)</span>
<span class="line-modified">!     {</span>
<span class="line-modified">!       day = 1;</span>
<span class="line-modified">!       ++j;      /* skip days, since we may have month/year */</span>
<span class="line-modified">!       continue;</span>
<span class="line-modified">!     }</span>
<span class="line-modified">!         day = pt.n[i];</span>
<span class="line-modified">!       }</span>
<span class="line-modified">!       break;</span>
              case G_DATE_YEAR:
<span class="line-modified">!       {</span>
<span class="line-modified">!         y  = pt.n[i];</span>
  
<span class="line-modified">!         if (locale_era_adjust != 0)</span>
<span class="line-modified">!           {</span>
<span class="line-modified">!       y += locale_era_adjust;</span>
<span class="line-modified">!           }</span>
<span class="line-modified">!         else if (using_twodigit_years &amp;&amp; y &lt; 100)</span>
<span class="line-modified">!     {</span>
<span class="line-modified">!       guint two     =  twodigit_start_year % 100;</span>
<span class="line-modified">!       guint century = (twodigit_start_year / 100) * 100;</span>
  
<span class="line-modified">!       if (y &lt; two)</span>
<span class="line-modified">!         century += 100;</span>
  
<span class="line-modified">!       y += century;</span>
<span class="line-modified">!     }</span>
<span class="line-modified">!       }</span>
<span class="line-modified">!       break;</span>
              default:
                break;
              }
  
            ++i;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1315,14 ***</span>
  
            if (using_twodigit_years &amp;&amp; y &lt; 100)
              y = G_DATE_BAD_YEAR; /* avoids ambiguity */
          }
        else if (pt.num_ints == 2)
<span class="line-modified">!     {</span>
<span class="line-modified">!       if (m == G_DATE_BAD_MONTH &amp;&amp; pt.month != G_DATE_BAD_MONTH)</span>
<span class="line-modified">!         m = pt.month;</span>
<span class="line-modified">!     }</span>
      }
    else if (pt.num_ints == 1)
      {
        if (pt.month != G_DATE_BAD_MONTH)
          {
<span class="line-new-header">--- 1320,14 ---</span>
  
            if (using_twodigit_years &amp;&amp; y &lt; 100)
              y = G_DATE_BAD_YEAR; /* avoids ambiguity */
          }
        else if (pt.num_ints == 2)
<span class="line-modified">!   {</span>
<span class="line-modified">!     if (m == G_DATE_BAD_MONTH &amp;&amp; pt.month != G_DATE_BAD_MONTH)</span>
<span class="line-modified">!       m = pt.month;</span>
<span class="line-modified">!   }</span>
      }
    else if (pt.num_ints == 1)
      {
        if (pt.month != G_DATE_BAD_MONTH)
          {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1390,11 ***</span>
   *
   * Since: 2.10
   */
  void
  g_date_set_time_t (GDate *date,
<span class="line-modified">!            time_t timet)</span>
  {
    struct tm tm;
  
    g_return_if_fail (date != NULL);
  
<span class="line-new-header">--- 1395,11 ---</span>
   *
   * Since: 2.10
   */
  void
  g_date_set_time_t (GDate *date,
<span class="line-modified">!        time_t timet)</span>
  {
    struct tm tm;
  
    g_return_if_fail (date != NULL);
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1404,20 ***</span>
    {
      struct tm *ptm = localtime (&amp;timet);
  
      if (ptm == NULL)
        {
<span class="line-modified">!     /* Happens at least in Microsoft&#39;s C library if you pass a</span>
<span class="line-modified">!      * negative time_t. Use 2000-01-01 as default date.</span>
<span class="line-modified">!      */</span>
  #ifndef G_DISABLE_CHECKS
<span class="line-modified">!     g_return_if_fail_warning (G_LOG_DOMAIN, &quot;g_date_set_time&quot;, &quot;ptm != NULL&quot;);</span>
  #endif
  
<span class="line-modified">!     tm.tm_mon = 0;</span>
<span class="line-modified">!     tm.tm_mday = 1;</span>
<span class="line-modified">!     tm.tm_year = 100;</span>
        }
      else
        memcpy ((void *) &amp;tm, (void *) ptm, sizeof(struct tm));
    }
  #endif
<span class="line-new-header">--- 1409,20 ---</span>
    {
      struct tm *ptm = localtime (&amp;timet);
  
      if (ptm == NULL)
        {
<span class="line-modified">!   /* Happens at least in Microsoft&#39;s C library if you pass a</span>
<span class="line-modified">!    * negative time_t. Use 2000-01-01 as default date.</span>
<span class="line-modified">!    */</span>
  #ifndef G_DISABLE_CHECKS
<span class="line-modified">!   g_return_if_fail_warning (G_LOG_DOMAIN, &quot;g_date_set_time&quot;, &quot;ptm != NULL&quot;);</span>
  #endif
  
<span class="line-modified">!   tm.tm_mon = 0;</span>
<span class="line-modified">!   tm.tm_mday = 1;</span>
<span class="line-modified">!   tm.tm_year = 100;</span>
        }
      else
        memcpy ((void *) &amp;tm, (void *) ptm, sizeof(struct tm));
    }
  #endif
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1442,16 ***</span>
   * Sets the value of a date from a #GTime value.
   * The time to date conversion is done using the user&#39;s current timezone.
   *
   * Deprecated: 2.10: Use g_date_set_time_t() instead.
   */
  void
  g_date_set_time (GDate *date,
<span class="line-modified">!          GTime  time_)</span>
  {
    g_date_set_time_t (date, (time_t) time_);
  }
  
  /**
   * g_date_set_time_val:
   * @date: a #GDate
   * @timeval: #GTimeVal value to set
<span class="line-new-header">--- 1447,18 ---</span>
   * Sets the value of a date from a #GTime value.
   * The time to date conversion is done using the user&#39;s current timezone.
   *
   * Deprecated: 2.10: Use g_date_set_time_t() instead.
   */
<span class="line-added">+ G_GNUC_BEGIN_IGNORE_DEPRECATIONS</span>
  void
  g_date_set_time (GDate *date,
<span class="line-modified">!      GTime  time_)</span>
  {
    g_date_set_time_t (date, (time_t) time_);
  }
<span class="line-added">+ G_GNUC_END_IGNORE_DEPRECATIONS</span>
  
  /**
   * g_date_set_time_val:
   * @date: a #GDate
   * @timeval: #GTimeVal value to set
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1461,17 ***</span>
   * additional precision.
   *
   * The time to date conversion is done using the user&#39;s current timezone.
   *
   * Since: 2.10
   */
  void
  g_date_set_time_val (GDate    *date,
<span class="line-modified">!              GTimeVal *timeval)</span>
  {
    g_date_set_time_t (date, (time_t) timeval-&gt;tv_sec);
  }
  
  /**
   * g_date_set_month:
   * @date: a #GDate
   * @month: month to set
<span class="line-new-header">--- 1468,21 ---</span>
   * additional precision.
   *
   * The time to date conversion is done using the user&#39;s current timezone.
   *
   * Since: 2.10
<span class="line-added">+  * Deprecated: 2.62: #GTimeVal is not year-2038-safe. Use g_date_set_time_t()</span>
<span class="line-added">+  *    instead.</span>
   */
<span class="line-added">+ G_GNUC_BEGIN_IGNORE_DEPRECATIONS</span>
  void
  g_date_set_time_val (GDate    *date,
<span class="line-modified">!          GTimeVal *timeval)</span>
  {
    g_date_set_time_t (date, (time_t) timeval-&gt;tv_sec);
  }
<span class="line-added">+ G_GNUC_END_IGNORE_DEPRECATIONS</span>
  
  /**
   * g_date_set_month:
   * @date: a #GDate
   * @month: month to set
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1727,11 ***</span>
    nmonths += d-&gt;month - 1;
  
    years  = nmonths/12;
    months = nmonths%12;
  
<span class="line-modified">!   g_return_if_fail (years &lt;= G_MAXUINT16 - d-&gt;year);</span>
  
    d-&gt;month = months + 1;
    d-&gt;year  += years;
  
    idx = g_date_is_leap_year (d-&gt;year) ? 1 : 0;
<span class="line-new-header">--- 1738,11 ---</span>
    nmonths += d-&gt;month - 1;
  
    years  = nmonths/12;
    months = nmonths%12;
  
<span class="line-modified">!   g_return_if_fail (years &lt;= (guint) (G_MAXUINT16 - d-&gt;year));</span>
  
    d-&gt;month = months + 1;
    d-&gt;year  += years;
  
    idx = g_date_is_leap_year (d-&gt;year) ? 1 : 0;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1811,11 ***</span>
  
    if (!d-&gt;dmy)
      g_date_update_dmy (d);
  
    g_return_if_fail (d-&gt;dmy != 0);
<span class="line-modified">!   g_return_if_fail (nyears &lt;= G_MAXUINT16 - d-&gt;year);</span>
  
    d-&gt;year += nyears;
  
    if (d-&gt;month == 2 &amp;&amp; d-&gt;day == 29)
      {
<span class="line-new-header">--- 1822,11 ---</span>
  
    if (!d-&gt;dmy)
      g_date_update_dmy (d);
  
    g_return_if_fail (d-&gt;dmy != 0);
<span class="line-modified">!   g_return_if_fail (nyears &lt;= (guint) (G_MAXUINT16 - d-&gt;year));</span>
  
    d-&gt;year += nyears;
  
    if (d-&gt;month == 2 &amp;&amp; d-&gt;day == 29)
      {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2095,12 ***</span>
   * Either of @min_date and @max_date may be %NULL.
   * All non-%NULL dates must be valid.
   */
  void
  g_date_clamp (GDate       *date,
<span class="line-modified">!           const GDate *min_date,</span>
<span class="line-modified">!           const GDate *max_date)</span>
  {
    g_return_if_fail (g_date_valid (date));
  
    if (min_date != NULL)
      g_return_if_fail (g_date_valid (min_date));
<span class="line-new-header">--- 2106,12 ---</span>
   * Either of @min_date and @max_date may be %NULL.
   * All non-%NULL dates must be valid.
   */
  void
  g_date_clamp (GDate       *date,
<span class="line-modified">!         const GDate *min_date,</span>
<span class="line-modified">!         const GDate *max_date)</span>
  {
    g_return_if_fail (g_date_valid (date));
  
    if (min_date != NULL)
      g_return_if_fail (g_date_valid (min_date));
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2142,14 ***</span>
  }
  
  #ifdef G_OS_WIN32
  static void
  append_month_name (GArray     *result,
<span class="line-modified">!            LCID        lcid,</span>
<span class="line-modified">!            SYSTEMTIME *systemtime,</span>
<span class="line-modified">!            gboolean    abbreviated,</span>
<span class="line-modified">!            gboolean    alternative)</span>
  {
    int n;
    WORD base;
    LPCWSTR lpFormat;
  
<span class="line-new-header">--- 2153,14 ---</span>
  }
  
  #ifdef G_OS_WIN32
  static void
  append_month_name (GArray     *result,
<span class="line-modified">!        LCID        lcid,</span>
<span class="line-modified">!        SYSTEMTIME *systemtime,</span>
<span class="line-modified">!        gboolean    abbreviated,</span>
<span class="line-modified">!        gboolean    alternative)</span>
  {
    int n;
    WORD base;
    LPCWSTR lpFormat;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2157,11 ***</span>
      {
        base = abbreviated ? LOCALE_SABBREVMONTHNAME1 : LOCALE_SMONTHNAME1;
        n = GetLocaleInfoW (lcid, base + systemtime-&gt;wMonth - 1, NULL, 0);
        g_array_set_size (result, result-&gt;len + n);
        GetLocaleInfoW (lcid, base + systemtime-&gt;wMonth - 1,
<span class="line-modified">!               ((wchar_t *) result-&gt;data) + result-&gt;len - n, n);</span>
        g_array_set_size (result, result-&gt;len - 1);
      }
    else
      {
        /* According to MSDN, this is the correct method to obtain
<span class="line-new-header">--- 2168,11 ---</span>
      {
        base = abbreviated ? LOCALE_SABBREVMONTHNAME1 : LOCALE_SMONTHNAME1;
        n = GetLocaleInfoW (lcid, base + systemtime-&gt;wMonth - 1, NULL, 0);
        g_array_set_size (result, result-&gt;len + n);
        GetLocaleInfoW (lcid, base + systemtime-&gt;wMonth - 1,
<span class="line-modified">!           ((wchar_t *) result-&gt;data) + result-&gt;len - n, n);</span>
        g_array_set_size (result, result-&gt;len - 1);
      }
    else
      {
        /* According to MSDN, this is the correct method to obtain
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2170,28 ***</span>
         */
        lpFormat = abbreviated ? L&quot;ddMMM&quot; : L&quot;ddMMMM&quot;;
        n = GetDateFormatW (lcid, 0, systemtime, lpFormat, NULL, 0);
        g_array_set_size (result, result-&gt;len + n);
        GetDateFormatW (lcid, 0, systemtime, lpFormat,
<span class="line-modified">!               ((wchar_t *) result-&gt;data) + result-&gt;len - n, n);</span>
        /* We have obtained a day number as two digits and the month name.
         * Now let&#39;s get rid of those two digits: overwrite them with the
         * month name.
         */
        memmove (((wchar_t *) result-&gt;data) + result-&gt;len - n,
<span class="line-modified">!            ((wchar_t *) result-&gt;data) + result-&gt;len - n + 2,</span>
<span class="line-modified">!            (n - 2) * sizeof (wchar_t));</span>
        g_array_set_size (result, result-&gt;len - 3);
      }
  }
  
  static gsize
  win32_strftime_helper (const GDate     *d,
<span class="line-modified">!                        const gchar     *format,</span>
<span class="line-modified">!                        const struct tm *tm,</span>
<span class="line-modified">!                        gchar           *s,</span>
<span class="line-modified">!                gsize            slen)</span>
  {
    SYSTEMTIME systemtime;
    TIME_ZONE_INFORMATION tzinfo;
    LCID lcid;
    int n, k;
<span class="line-new-header">--- 2181,28 ---</span>
         */
        lpFormat = abbreviated ? L&quot;ddMMM&quot; : L&quot;ddMMMM&quot;;
        n = GetDateFormatW (lcid, 0, systemtime, lpFormat, NULL, 0);
        g_array_set_size (result, result-&gt;len + n);
        GetDateFormatW (lcid, 0, systemtime, lpFormat,
<span class="line-modified">!           ((wchar_t *) result-&gt;data) + result-&gt;len - n, n);</span>
        /* We have obtained a day number as two digits and the month name.
         * Now let&#39;s get rid of those two digits: overwrite them with the
         * month name.
         */
        memmove (((wchar_t *) result-&gt;data) + result-&gt;len - n,
<span class="line-modified">!          ((wchar_t *) result-&gt;data) + result-&gt;len - n + 2,</span>
<span class="line-modified">!          (n - 2) * sizeof (wchar_t));</span>
        g_array_set_size (result, result-&gt;len - 3);
      }
  }
  
  static gsize
  win32_strftime_helper (const GDate     *d,
<span class="line-modified">!            const gchar     *format,</span>
<span class="line-modified">!            const struct tm *tm,</span>
<span class="line-modified">!            gchar           *s,</span>
<span class="line-modified">!            gsize          slen)</span>
  {
    SYSTEMTIME systemtime;
    TIME_ZONE_INFORMATION tzinfo;
    LCID lcid;
    int n, k;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2218,317 ***</span>
    p = format;
    while (*p)
      {
        c = g_utf8_get_char (p);
        if (c == &#39;%&#39;)
<span class="line-modified">!     {</span>
<span class="line-modified">!       p = g_utf8_next_char (p);</span>
<span class="line-modified">!       if (!*p)</span>
<span class="line-modified">!         {</span>
<span class="line-modified">!           s[0] = &#39;\0&#39;;</span>
<span class="line-modified">!           g_array_free (result, TRUE);</span>
  
<span class="line-modified">!           return 0;</span>
<span class="line-modified">!         }</span>
  
<span class="line-modified">!       modifier = &#39;\0&#39;;</span>
<span class="line-modified">!       c = g_utf8_get_char (p);</span>
<span class="line-modified">!       if (c == &#39;E&#39; || c == &#39;O&#39;)</span>
<span class="line-modified">!         {</span>
<span class="line-modified">!           /* &quot;%OB&quot;, &quot;%Ob&quot;, and &quot;%Oh&quot; are supported, ignore other modified</span>
<span class="line-modified">!            * conversion specifiers for now.</span>
<span class="line-modified">!            */</span>
<span class="line-modified">!           modifier = c;</span>
<span class="line-modified">!           p = g_utf8_next_char (p);</span>
<span class="line-modified">!           if (!*p)</span>
<span class="line-modified">!         {</span>
<span class="line-modified">!           s[0] = &#39;\0&#39;;</span>
<span class="line-modified">!           g_array_free (result, TRUE);</span>
  
<span class="line-modified">!           return 0;</span>
<span class="line-modified">!         }</span>
  
<span class="line-modified">!           c = g_utf8_get_char (p);</span>
<span class="line-modified">!         }</span>
  
<span class="line-modified">!       switch (c)</span>
<span class="line-modified">!         {</span>
<span class="line-modified">!         case &#39;a&#39;:</span>
<span class="line-modified">!           if (systemtime.wDayOfWeek == 0)</span>
<span class="line-modified">!         k = 6;</span>
<span class="line-modified">!           else</span>
<span class="line-modified">!         k = systemtime.wDayOfWeek - 1;</span>
<span class="line-modified">!           n = GetLocaleInfoW (lcid, LOCALE_SABBREVDAYNAME1+k, NULL, 0);</span>
<span class="line-modified">!           g_array_set_size (result, result-&gt;len + n);</span>
<span class="line-modified">!           GetLocaleInfoW (lcid, LOCALE_SABBREVDAYNAME1+k, ((wchar_t *) result-&gt;data) + result-&gt;len - n, n);</span>
<span class="line-modified">!           g_array_set_size (result, result-&gt;len - 1);</span>
<span class="line-modified">!           break;</span>
<span class="line-modified">!         case &#39;A&#39;:</span>
<span class="line-modified">!           if (systemtime.wDayOfWeek == 0)</span>
<span class="line-modified">!         k = 6;</span>
<span class="line-modified">!           else</span>
<span class="line-modified">!         k = systemtime.wDayOfWeek - 1;</span>
<span class="line-modified">!           n = GetLocaleInfoW (lcid, LOCALE_SDAYNAME1+k, NULL, 0);</span>
<span class="line-modified">!           g_array_set_size (result, result-&gt;len + n);</span>
<span class="line-modified">!           GetLocaleInfoW (lcid, LOCALE_SDAYNAME1+k, ((wchar_t *) result-&gt;data) + result-&gt;len - n, n);</span>
<span class="line-modified">!           g_array_set_size (result, result-&gt;len - 1);</span>
<span class="line-modified">!           break;</span>
<span class="line-modified">!         case &#39;b&#39;:</span>
<span class="line-modified">!         case &#39;h&#39;:</span>
<span class="line-modified">!           append_month_name (result, lcid, &amp;systemtime, TRUE,</span>
<span class="line-modified">!                  modifier == &#39;O&#39;);</span>
<span class="line-modified">!           break;</span>
<span class="line-modified">!         case &#39;B&#39;:</span>
<span class="line-modified">!           append_month_name (result, lcid, &amp;systemtime, FALSE,</span>
<span class="line-modified">!                  modifier == &#39;O&#39;);</span>
<span class="line-modified">!           break;</span>
<span class="line-modified">!         case &#39;c&#39;:</span>
<span class="line-modified">!           n = GetDateFormatW (lcid, 0, &amp;systemtime, NULL, NULL, 0);</span>
<span class="line-modified">!           if (n &gt; 0)</span>
<span class="line-modified">!         {</span>
<span class="line-modified">!           g_array_set_size (result, result-&gt;len + n);</span>
<span class="line-modified">!           GetDateFormatW (lcid, 0, &amp;systemtime, NULL, ((wchar_t *) result-&gt;data) + result-&gt;len - n, n);</span>
<span class="line-modified">!           g_array_set_size (result, result-&gt;len - 1);</span>
<span class="line-modified">!         }</span>
<span class="line-removed">-           g_array_append_vals (result, L&quot; &quot;, 1);</span>
<span class="line-removed">-           n = GetTimeFormatW (lcid, 0, &amp;systemtime, NULL, NULL, 0);</span>
<span class="line-removed">-           if (n &gt; 0)</span>
<span class="line-removed">-         {</span>
<span class="line-removed">-           g_array_set_size (result, result-&gt;len + n);</span>
<span class="line-removed">-           GetTimeFormatW (lcid, 0, &amp;systemtime, NULL, ((wchar_t *) result-&gt;data) + result-&gt;len - n, n);</span>
<span class="line-removed">-           g_array_set_size (result, result-&gt;len - 1);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-           break;</span>
<span class="line-removed">-         case &#39;C&#39;:</span>
<span class="line-removed">-           g_array_append_vals (result, digits + systemtime.wYear/1000, 1);</span>
<span class="line-removed">-           g_array_append_vals (result, digits + (systemtime.wYear/1000)%10, 1);</span>
<span class="line-removed">-           break;</span>
<span class="line-removed">-         case &#39;d&#39;:</span>
<span class="line-removed">-           g_array_append_vals (result, digits + systemtime.wDay/10, 1);</span>
<span class="line-removed">-           g_array_append_vals (result, digits + systemtime.wDay%10, 1);</span>
<span class="line-removed">-           break;</span>
<span class="line-removed">-         case &#39;D&#39;:</span>
<span class="line-removed">-           g_array_append_vals (result, digits + systemtime.wMonth/10, 1);</span>
<span class="line-removed">-           g_array_append_vals (result, digits + systemtime.wMonth%10, 1);</span>
<span class="line-removed">-           g_array_append_vals (result, L&quot;/&quot;, 1);</span>
<span class="line-removed">-           g_array_append_vals (result, digits + systemtime.wDay/10, 1);</span>
<span class="line-removed">-           g_array_append_vals (result, digits + systemtime.wDay%10, 1);</span>
<span class="line-removed">-           g_array_append_vals (result, L&quot;/&quot;, 1);</span>
<span class="line-removed">-           g_array_append_vals (result, digits + (systemtime.wYear/10)%10, 1);</span>
<span class="line-removed">-           g_array_append_vals (result, digits + systemtime.wYear%10, 1);</span>
<span class="line-removed">-           break;</span>
<span class="line-removed">-         case &#39;e&#39;:</span>
<span class="line-removed">-           if (systemtime.wDay &gt;= 10)</span>
<span class="line-removed">-         g_array_append_vals (result, digits + systemtime.wDay/10, 1);</span>
<span class="line-removed">-           else</span>
          g_array_append_vals (result, L&quot; &quot;, 1);
<span class="line-modified">!           g_array_append_vals (result, digits + systemtime.wDay%10, 1);</span>
<span class="line-modified">!           break;</span>
<span class="line-modified">! </span>
<span class="line-modified">!           /* A GDate has no time fields, so for now we can</span>
<span class="line-modified">!            * hardcode all time conversions into zeros (or 12 for</span>
<span class="line-modified">!            * %I). The alternative code snippets in the #else</span>
<span class="line-modified">!            * branches are here ready to be taken into use when</span>
<span class="line-modified">!            * needed by a g_strftime() or g_date_and_time_format()</span>
<span class="line-modified">!            * or whatever.</span>
<span class="line-modified">!            */</span>
<span class="line-modified">!         case &#39;H&#39;:</span>
  #if 1
<span class="line-modified">!           g_array_append_vals (result, L&quot;00&quot;, 2);</span>
  #else
<span class="line-modified">!           g_array_append_vals (result, digits + systemtime.wHour/10, 1);</span>
<span class="line-modified">!           g_array_append_vals (result, digits + systemtime.wHour%10, 1);</span>
  #endif
<span class="line-modified">!           break;</span>
<span class="line-modified">!         case &#39;I&#39;:</span>
  #if 1
<span class="line-removed">-           g_array_append_vals (result, L&quot;12&quot;, 2);</span>
<span class="line-removed">- #else</span>
<span class="line-removed">-           if (systemtime.wHour == 0)</span>
          g_array_append_vals (result, L&quot;12&quot;, 2);
<span class="line-modified">!           else</span>
<span class="line-modified">!         {</span>
<span class="line-modified">!           g_array_append_vals (result, digits + (systemtime.wHour%12)/10, 1);</span>
<span class="line-modified">!           g_array_append_vals (result, digits + (systemtime.wHour%12)%10, 1);</span>
<span class="line-modified">!         }</span>
  #endif
<span class="line-modified">!           break;</span>
<span class="line-modified">!         case  &#39;j&#39;:</span>
<span class="line-modified">!           g_array_append_vals (result, digits + (tm-&gt;tm_yday+1)/100, 1);</span>
<span class="line-modified">!           g_array_append_vals (result, digits + ((tm-&gt;tm_yday+1)/10)%10, 1);</span>
<span class="line-modified">!           g_array_append_vals (result, digits + (tm-&gt;tm_yday+1)%10, 1);</span>
<span class="line-modified">!           break;</span>
<span class="line-modified">!         case &#39;m&#39;:</span>
<span class="line-modified">!           g_array_append_vals (result, digits + systemtime.wMonth/10, 1);</span>
<span class="line-modified">!           g_array_append_vals (result, digits + systemtime.wMonth%10, 1);</span>
<span class="line-modified">!           break;</span>
<span class="line-modified">!         case &#39;M&#39;:</span>
  #if 1
<span class="line-modified">!           g_array_append_vals (result, L&quot;00&quot;, 2);</span>
  #else
<span class="line-modified">!           g_array_append_vals (result, digits + systemtime.wMinute/10, 1);</span>
<span class="line-modified">!           g_array_append_vals (result, digits + systemtime.wMinute%10, 1);</span>
  #endif
<span class="line-modified">!           break;</span>
<span class="line-modified">!         case &#39;n&#39;:</span>
<span class="line-modified">!           g_array_append_vals (result, L&quot;\n&quot;, 1);</span>
<span class="line-modified">!           break;</span>
<span class="line-modified">!         case &#39;p&#39;:</span>
<span class="line-modified">!           n = GetTimeFormatW (lcid, 0, &amp;systemtime, L&quot;tt&quot;, NULL, 0);</span>
<span class="line-modified">!           if (n &gt; 0)</span>
<span class="line-modified">!         {</span>
<span class="line-modified">!           g_array_set_size (result, result-&gt;len + n);</span>
<span class="line-modified">!           GetTimeFormatW (lcid, 0, &amp;systemtime, L&quot;tt&quot;, ((wchar_t *) result-&gt;data) + result-&gt;len - n, n);</span>
<span class="line-modified">!           g_array_set_size (result, result-&gt;len - 1);</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!           break;</span>
<span class="line-modified">!         case &#39;r&#39;:</span>
<span class="line-modified">!           /* This is a rather odd format. Hard to say what to do.</span>
<span class="line-modified">!            * Let&#39;s always use the POSIX %I:%M:%S %p</span>
<span class="line-modified">!            */</span>
  #if 1
<span class="line-modified">!           g_array_append_vals (result, L&quot;12:00:00&quot;, 8);</span>
  #else
<span class="line-modified">!           if (systemtime.wHour == 0)</span>
<span class="line-modified">!         g_array_append_vals (result, L&quot;12&quot;, 2);</span>
<span class="line-modified">!           else</span>
<span class="line-modified">!         {</span>
<span class="line-modified">!           g_array_append_vals (result, digits + (systemtime.wHour%12)/10, 1);</span>
<span class="line-modified">!           g_array_append_vals (result, digits + (systemtime.wHour%12)%10, 1);</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!           g_array_append_vals (result, L&quot;:&quot;, 1);</span>
<span class="line-modified">!           g_array_append_vals (result, digits + systemtime.wMinute/10, 1);</span>
<span class="line-modified">!           g_array_append_vals (result, digits + systemtime.wMinute%10, 1);</span>
<span class="line-modified">!           g_array_append_vals (result, L&quot;:&quot;, 1);</span>
<span class="line-modified">!           g_array_append_vals (result, digits + systemtime.wSecond/10, 1);</span>
<span class="line-modified">!           g_array_append_vals (result, digits + systemtime.wSecond%10, 1);</span>
<span class="line-modified">!           g_array_append_vals (result, L&quot; &quot;, 1);</span>
  #endif
<span class="line-modified">!           n = GetTimeFormatW (lcid, 0, &amp;systemtime, L&quot;tt&quot;, NULL, 0);</span>
<span class="line-modified">!           if (n &gt; 0)</span>
<span class="line-modified">!         {</span>
<span class="line-modified">!           g_array_set_size (result, result-&gt;len + n);</span>
<span class="line-modified">!           GetTimeFormatW (lcid, 0, &amp;systemtime, L&quot;tt&quot;, ((wchar_t *) result-&gt;data) + result-&gt;len - n, n);</span>
<span class="line-modified">!           g_array_set_size (result, result-&gt;len - 1);</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!           break;</span>
<span class="line-modified">!         case &#39;R&#39;:</span>
  #if 1
<span class="line-modified">!           g_array_append_vals (result, L&quot;00:00&quot;, 5);</span>
  #else
<span class="line-modified">!           g_array_append_vals (result, digits + systemtime.wHour/10, 1);</span>
<span class="line-modified">!           g_array_append_vals (result, digits + systemtime.wHour%10, 1);</span>
<span class="line-modified">!           g_array_append_vals (result, L&quot;:&quot;, 1);</span>
<span class="line-modified">!           g_array_append_vals (result, digits + systemtime.wMinute/10, 1);</span>
<span class="line-modified">!           g_array_append_vals (result, digits + systemtime.wMinute%10, 1);</span>
  #endif
<span class="line-modified">!           break;</span>
<span class="line-modified">!         case &#39;S&#39;:</span>
  #if 1
<span class="line-modified">!           g_array_append_vals (result, L&quot;00&quot;, 2);</span>
  #else
<span class="line-modified">!           g_array_append_vals (result, digits + systemtime.wSecond/10, 1);</span>
<span class="line-modified">!           g_array_append_vals (result, digits + systemtime.wSecond%10, 1);</span>
  #endif
<span class="line-modified">!           break;</span>
<span class="line-modified">!         case &#39;t&#39;:</span>
<span class="line-modified">!           g_array_append_vals (result, L&quot;\t&quot;, 1);</span>
<span class="line-modified">!           break;</span>
<span class="line-modified">!         case &#39;T&#39;:</span>
  #if 1
<span class="line-modified">!           g_array_append_vals (result, L&quot;00:00:00&quot;, 8);</span>
  #else
<span class="line-modified">!           g_array_append_vals (result, digits + systemtime.wHour/10, 1);</span>
<span class="line-modified">!           g_array_append_vals (result, digits + systemtime.wHour%10, 1);</span>
<span class="line-modified">!           g_array_append_vals (result, L&quot;:&quot;, 1);</span>
<span class="line-modified">!           g_array_append_vals (result, digits + systemtime.wMinute/10, 1);</span>
<span class="line-modified">!           g_array_append_vals (result, digits + systemtime.wMinute%10, 1);</span>
<span class="line-modified">!           g_array_append_vals (result, L&quot;:&quot;, 1);</span>
<span class="line-modified">!           g_array_append_vals (result, digits + systemtime.wSecond/10, 1);</span>
<span class="line-modified">!           g_array_append_vals (result, digits + systemtime.wSecond%10, 1);</span>
  #endif
<span class="line-modified">!           break;</span>
<span class="line-modified">!         case &#39;u&#39;:</span>
<span class="line-modified">!           if (systemtime.wDayOfWeek == 0)</span>
<span class="line-modified">!         g_array_append_vals (result, L&quot;7&quot;, 1);</span>
<span class="line-modified">!           else</span>
          g_array_append_vals (result, digits + systemtime.wDayOfWeek, 1);
<span class="line-modified">!           break;</span>
<span class="line-modified">!         case &#39;U&#39;:</span>
<span class="line-modified">!           n = g_date_get_sunday_week_of_year (d);</span>
<span class="line-modified">!           g_array_append_vals (result, digits + n/10, 1);</span>
<span class="line-modified">!           g_array_append_vals (result, digits + n%10, 1);</span>
<span class="line-modified">!           break;</span>
<span class="line-modified">!         case &#39;V&#39;:</span>
<span class="line-modified">!           n = g_date_get_iso8601_week_of_year (d);</span>
<span class="line-modified">!           g_array_append_vals (result, digits + n/10, 1);</span>
<span class="line-modified">!           g_array_append_vals (result, digits + n%10, 1);</span>
<span class="line-modified">!           break;</span>
<span class="line-modified">!         case &#39;w&#39;:</span>
<span class="line-modified">!           g_array_append_vals (result, digits + systemtime.wDayOfWeek, 1);</span>
<span class="line-removed">-           break;</span>
<span class="line-removed">-         case &#39;W&#39;:</span>
<span class="line-removed">-           n = g_date_get_monday_week_of_year (d);</span>
<span class="line-removed">-           g_array_append_vals (result, digits + n/10, 1);</span>
<span class="line-removed">-           g_array_append_vals (result, digits + n%10, 1);</span>
<span class="line-removed">-           break;</span>
<span class="line-removed">-         case &#39;x&#39;:</span>
<span class="line-removed">-           n = GetDateFormatW (lcid, 0, &amp;systemtime, NULL, NULL, 0);</span>
<span class="line-removed">-           if (n &gt; 0)</span>
<span class="line-removed">-         {</span>
<span class="line-removed">-           g_array_set_size (result, result-&gt;len + n);</span>
<span class="line-removed">-           GetDateFormatW (lcid, 0, &amp;systemtime, NULL, ((wchar_t *) result-&gt;data) + result-&gt;len - n, n);</span>
<span class="line-removed">-           g_array_set_size (result, result-&gt;len - 1);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-           break;</span>
<span class="line-removed">-         case &#39;X&#39;:</span>
<span class="line-removed">-           n = GetTimeFormatW (lcid, 0, &amp;systemtime, NULL, NULL, 0);</span>
<span class="line-removed">-           if (n &gt; 0)</span>
<span class="line-removed">-         {</span>
<span class="line-removed">-           g_array_set_size (result, result-&gt;len + n);</span>
<span class="line-removed">-           GetTimeFormatW (lcid, 0, &amp;systemtime, NULL, ((wchar_t *) result-&gt;data) + result-&gt;len - n, n);</span>
<span class="line-removed">-           g_array_set_size (result, result-&gt;len - 1);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-           break;</span>
<span class="line-removed">-         case &#39;y&#39;:</span>
<span class="line-removed">-           g_array_append_vals (result, digits + (systemtime.wYear/10)%10, 1);</span>
<span class="line-removed">-           g_array_append_vals (result, digits + systemtime.wYear%10, 1);</span>
<span class="line-removed">-           break;</span>
<span class="line-removed">-         case &#39;Y&#39;:</span>
<span class="line-removed">-           g_array_append_vals (result, digits + systemtime.wYear/1000, 1);</span>
<span class="line-removed">-           g_array_append_vals (result, digits + (systemtime.wYear/100)%10, 1);</span>
<span class="line-removed">-           g_array_append_vals (result, digits + (systemtime.wYear/10)%10, 1);</span>
<span class="line-removed">-           g_array_append_vals (result, digits + systemtime.wYear%10, 1);</span>
<span class="line-removed">-           break;</span>
<span class="line-removed">-         case &#39;Z&#39;:</span>
<span class="line-removed">-           n = GetTimeZoneInformation (&amp;tzinfo);</span>
<span class="line-removed">-           if (n == TIME_ZONE_ID_UNKNOWN)</span>
<span class="line-removed">-         ;</span>
<span class="line-removed">-           else if (n == TIME_ZONE_ID_STANDARD)</span>
<span class="line-removed">-         g_array_append_vals (result, tzinfo.StandardName, wcslen (tzinfo.StandardName));</span>
<span class="line-removed">-           else if (n == TIME_ZONE_ID_DAYLIGHT)</span>
<span class="line-removed">-         g_array_append_vals (result, tzinfo.DaylightName, wcslen (tzinfo.DaylightName));</span>
<span class="line-removed">-           break;</span>
<span class="line-removed">-         case &#39;%&#39;:</span>
<span class="line-removed">-           g_array_append_vals (result, L&quot;%&quot;, 1);</span>
<span class="line-removed">-           break;</span>
<span class="line-removed">-         }</span>
      }
<span class="line-modified">!       else if (c &lt;= 0xFFFF)</span>
      {
<span class="line-modified">!       wchar_t wc = c;</span>
<span class="line-modified">!       g_array_append_vals (result, &amp;wc, 1);</span>
      }
        else
<span class="line-modified">!     {</span>
<span class="line-modified">!       glong nwc;</span>
<span class="line-modified">!       wchar_t *ws;</span>
  
<span class="line-modified">!       ws = g_ucs4_to_utf16 (&amp;c, 1, NULL, &amp;nwc, NULL);</span>
<span class="line-modified">!       g_array_append_vals (result, ws, nwc);</span>
<span class="line-modified">!       g_free (ws);</span>
<span class="line-modified">!     }</span>
        p = g_utf8_next_char (p);
      }
  
    convbuf = g_utf16_to_utf8 ((wchar_t *) result-&gt;data, result-&gt;len, NULL, &amp;convlen, NULL);
    g_array_free (result, TRUE);
<span class="line-new-header">--- 2229,317 ---</span>
    p = format;
    while (*p)
      {
        c = g_utf8_get_char (p);
        if (c == &#39;%&#39;)
<span class="line-modified">!   {</span>
<span class="line-modified">!     p = g_utf8_next_char (p);</span>
<span class="line-modified">!     if (!*p)</span>
<span class="line-modified">!       {</span>
<span class="line-modified">!         s[0] = &#39;\0&#39;;</span>
<span class="line-modified">!         g_array_free (result, TRUE);</span>
  
<span class="line-modified">!         return 0;</span>
<span class="line-modified">!       }</span>
  
<span class="line-modified">!     modifier = &#39;\0&#39;;</span>
<span class="line-modified">!     c = g_utf8_get_char (p);</span>
<span class="line-modified">!     if (c == &#39;E&#39; || c == &#39;O&#39;)</span>
<span class="line-modified">!       {</span>
<span class="line-modified">!         /* &quot;%OB&quot;, &quot;%Ob&quot;, and &quot;%Oh&quot; are supported, ignore other modified</span>
<span class="line-modified">!          * conversion specifiers for now.</span>
<span class="line-modified">!          */</span>
<span class="line-modified">!         modifier = c;</span>
<span class="line-modified">!         p = g_utf8_next_char (p);</span>
<span class="line-modified">!         if (!*p)</span>
<span class="line-modified">!     {</span>
<span class="line-modified">!       s[0] = &#39;\0&#39;;</span>
<span class="line-modified">!       g_array_free (result, TRUE);</span>
  
<span class="line-modified">!       return 0;</span>
<span class="line-modified">!     }</span>
  
<span class="line-modified">!         c = g_utf8_get_char (p);</span>
<span class="line-modified">!       }</span>
  
<span class="line-modified">!     switch (c)</span>
<span class="line-modified">!       {</span>
<span class="line-modified">!       case &#39;a&#39;:</span>
<span class="line-modified">!         if (systemtime.wDayOfWeek == 0)</span>
<span class="line-modified">!     k = 6;</span>
<span class="line-modified">!         else</span>
<span class="line-modified">!     k = systemtime.wDayOfWeek - 1;</span>
<span class="line-modified">!         n = GetLocaleInfoW (lcid, LOCALE_SABBREVDAYNAME1+k, NULL, 0);</span>
<span class="line-modified">!         g_array_set_size (result, result-&gt;len + n);</span>
<span class="line-modified">!         GetLocaleInfoW (lcid, LOCALE_SABBREVDAYNAME1+k, ((wchar_t *) result-&gt;data) + result-&gt;len - n, n);</span>
<span class="line-modified">!         g_array_set_size (result, result-&gt;len - 1);</span>
<span class="line-modified">!         break;</span>
<span class="line-modified">!       case &#39;A&#39;:</span>
<span class="line-modified">!         if (systemtime.wDayOfWeek == 0)</span>
<span class="line-modified">!     k = 6;</span>
<span class="line-modified">!         else</span>
<span class="line-modified">!     k = systemtime.wDayOfWeek - 1;</span>
<span class="line-modified">!         n = GetLocaleInfoW (lcid, LOCALE_SDAYNAME1+k, NULL, 0);</span>
<span class="line-modified">!         g_array_set_size (result, result-&gt;len + n);</span>
<span class="line-modified">!         GetLocaleInfoW (lcid, LOCALE_SDAYNAME1+k, ((wchar_t *) result-&gt;data) + result-&gt;len - n, n);</span>
<span class="line-modified">!         g_array_set_size (result, result-&gt;len - 1);</span>
<span class="line-modified">!         break;</span>
<span class="line-modified">!       case &#39;b&#39;:</span>
<span class="line-modified">!       case &#39;h&#39;:</span>
<span class="line-modified">!         append_month_name (result, lcid, &amp;systemtime, TRUE,</span>
<span class="line-modified">!          modifier == &#39;O&#39;);</span>
<span class="line-modified">!         break;</span>
<span class="line-modified">!       case &#39;B&#39;:</span>
<span class="line-modified">!         append_month_name (result, lcid, &amp;systemtime, FALSE,</span>
<span class="line-modified">!          modifier == &#39;O&#39;);</span>
<span class="line-modified">!         break;</span>
<span class="line-modified">!       case &#39;c&#39;:</span>
<span class="line-modified">!         n = GetDateFormatW (lcid, 0, &amp;systemtime, NULL, NULL, 0);</span>
<span class="line-modified">!         if (n &gt; 0)</span>
<span class="line-modified">!     {</span>
<span class="line-modified">!       g_array_set_size (result, result-&gt;len + n);</span>
<span class="line-modified">!       GetDateFormatW (lcid, 0, &amp;systemtime, NULL, ((wchar_t *) result-&gt;data) + result-&gt;len - n, n);</span>
<span class="line-modified">!       g_array_set_size (result, result-&gt;len - 1);</span>
<span class="line-modified">!     }</span>
          g_array_append_vals (result, L&quot; &quot;, 1);
<span class="line-modified">!         n = GetTimeFormatW (lcid, 0, &amp;systemtime, NULL, NULL, 0);</span>
<span class="line-modified">!         if (n &gt; 0)</span>
<span class="line-modified">!     {</span>
<span class="line-modified">!       g_array_set_size (result, result-&gt;len + n);</span>
<span class="line-modified">!       GetTimeFormatW (lcid, 0, &amp;systemtime, NULL, ((wchar_t *) result-&gt;data) + result-&gt;len - n, n);</span>
<span class="line-modified">!       g_array_set_size (result, result-&gt;len - 1);</span>
<span class="line-modified">!     }</span>
<span class="line-modified">!         break;</span>
<span class="line-modified">!       case &#39;C&#39;:</span>
<span class="line-modified">!         g_array_append_vals (result, digits + systemtime.wYear/1000, 1);</span>
<span class="line-modified">!         g_array_append_vals (result, digits + (systemtime.wYear/1000)%10, 1);</span>
<span class="line-added">+         break;</span>
<span class="line-added">+       case &#39;d&#39;:</span>
<span class="line-added">+         g_array_append_vals (result, digits + systemtime.wDay/10, 1);</span>
<span class="line-added">+         g_array_append_vals (result, digits + systemtime.wDay%10, 1);</span>
<span class="line-added">+         break;</span>
<span class="line-added">+       case &#39;D&#39;:</span>
<span class="line-added">+         g_array_append_vals (result, digits + systemtime.wMonth/10, 1);</span>
<span class="line-added">+         g_array_append_vals (result, digits + systemtime.wMonth%10, 1);</span>
<span class="line-added">+         g_array_append_vals (result, L&quot;/&quot;, 1);</span>
<span class="line-added">+         g_array_append_vals (result, digits + systemtime.wDay/10, 1);</span>
<span class="line-added">+         g_array_append_vals (result, digits + systemtime.wDay%10, 1);</span>
<span class="line-added">+         g_array_append_vals (result, L&quot;/&quot;, 1);</span>
<span class="line-added">+         g_array_append_vals (result, digits + (systemtime.wYear/10)%10, 1);</span>
<span class="line-added">+         g_array_append_vals (result, digits + systemtime.wYear%10, 1);</span>
<span class="line-added">+         break;</span>
<span class="line-added">+       case &#39;e&#39;:</span>
<span class="line-added">+         if (systemtime.wDay &gt;= 10)</span>
<span class="line-added">+     g_array_append_vals (result, digits + systemtime.wDay/10, 1);</span>
<span class="line-added">+         else</span>
<span class="line-added">+     g_array_append_vals (result, L&quot; &quot;, 1);</span>
<span class="line-added">+         g_array_append_vals (result, digits + systemtime.wDay%10, 1);</span>
<span class="line-added">+         break;</span>
<span class="line-added">+ </span>
<span class="line-added">+         /* A GDate has no time fields, so for now we can</span>
<span class="line-added">+          * hardcode all time conversions into zeros (or 12 for</span>
<span class="line-added">+          * %I). The alternative code snippets in the #else</span>
<span class="line-added">+          * branches are here ready to be taken into use when</span>
<span class="line-added">+          * needed by a g_strftime() or g_date_and_time_format()</span>
<span class="line-added">+          * or whatever.</span>
<span class="line-added">+          */</span>
<span class="line-added">+       case &#39;H&#39;:</span>
  #if 1
<span class="line-modified">!         g_array_append_vals (result, L&quot;00&quot;, 2);</span>
  #else
<span class="line-modified">!         g_array_append_vals (result, digits + systemtime.wHour/10, 1);</span>
<span class="line-modified">!         g_array_append_vals (result, digits + systemtime.wHour%10, 1);</span>
  #endif
<span class="line-modified">!         break;</span>
<span class="line-modified">!       case &#39;I&#39;:</span>
  #if 1
          g_array_append_vals (result, L&quot;12&quot;, 2);
<span class="line-modified">! #else</span>
<span class="line-modified">!         if (systemtime.wHour == 0)</span>
<span class="line-modified">!     g_array_append_vals (result, L&quot;12&quot;, 2);</span>
<span class="line-modified">!         else</span>
<span class="line-modified">!     {</span>
<span class="line-added">+       g_array_append_vals (result, digits + (systemtime.wHour%12)/10, 1);</span>
<span class="line-added">+       g_array_append_vals (result, digits + (systemtime.wHour%12)%10, 1);</span>
<span class="line-added">+     }</span>
  #endif
<span class="line-modified">!         break;</span>
<span class="line-modified">!       case  &#39;j&#39;:</span>
<span class="line-modified">!         g_array_append_vals (result, digits + (tm-&gt;tm_yday+1)/100, 1);</span>
<span class="line-modified">!         g_array_append_vals (result, digits + ((tm-&gt;tm_yday+1)/10)%10, 1);</span>
<span class="line-modified">!         g_array_append_vals (result, digits + (tm-&gt;tm_yday+1)%10, 1);</span>
<span class="line-modified">!         break;</span>
<span class="line-modified">!       case &#39;m&#39;:</span>
<span class="line-modified">!         g_array_append_vals (result, digits + systemtime.wMonth/10, 1);</span>
<span class="line-modified">!         g_array_append_vals (result, digits + systemtime.wMonth%10, 1);</span>
<span class="line-modified">!         break;</span>
<span class="line-modified">!       case &#39;M&#39;:</span>
  #if 1
<span class="line-modified">!         g_array_append_vals (result, L&quot;00&quot;, 2);</span>
  #else
<span class="line-modified">!         g_array_append_vals (result, digits + systemtime.wMinute/10, 1);</span>
<span class="line-modified">!         g_array_append_vals (result, digits + systemtime.wMinute%10, 1);</span>
  #endif
<span class="line-modified">!         break;</span>
<span class="line-modified">!       case &#39;n&#39;:</span>
<span class="line-modified">!         g_array_append_vals (result, L&quot;\n&quot;, 1);</span>
<span class="line-modified">!         break;</span>
<span class="line-modified">!       case &#39;p&#39;:</span>
<span class="line-modified">!         n = GetTimeFormatW (lcid, 0, &amp;systemtime, L&quot;tt&quot;, NULL, 0);</span>
<span class="line-modified">!         if (n &gt; 0)</span>
<span class="line-modified">!     {</span>
<span class="line-modified">!       g_array_set_size (result, result-&gt;len + n);</span>
<span class="line-modified">!       GetTimeFormatW (lcid, 0, &amp;systemtime, L&quot;tt&quot;, ((wchar_t *) result-&gt;data) + result-&gt;len - n, n);</span>
<span class="line-modified">!       g_array_set_size (result, result-&gt;len - 1);</span>
<span class="line-modified">!     }</span>
<span class="line-modified">!         break;</span>
<span class="line-modified">!       case &#39;r&#39;:</span>
<span class="line-modified">!         /* This is a rather odd format. Hard to say what to do.</span>
<span class="line-modified">!          * Let&#39;s always use the POSIX %I:%M:%S %p</span>
<span class="line-modified">!          */</span>
  #if 1
<span class="line-modified">!         g_array_append_vals (result, L&quot;12:00:00&quot;, 8);</span>
  #else
<span class="line-modified">!         if (systemtime.wHour == 0)</span>
<span class="line-modified">!     g_array_append_vals (result, L&quot;12&quot;, 2);</span>
<span class="line-modified">!         else</span>
<span class="line-modified">!     {</span>
<span class="line-modified">!       g_array_append_vals (result, digits + (systemtime.wHour%12)/10, 1);</span>
<span class="line-modified">!       g_array_append_vals (result, digits + (systemtime.wHour%12)%10, 1);</span>
<span class="line-modified">!     }</span>
<span class="line-modified">!         g_array_append_vals (result, L&quot;:&quot;, 1);</span>
<span class="line-modified">!         g_array_append_vals (result, digits + systemtime.wMinute/10, 1);</span>
<span class="line-modified">!         g_array_append_vals (result, digits + systemtime.wMinute%10, 1);</span>
<span class="line-modified">!         g_array_append_vals (result, L&quot;:&quot;, 1);</span>
<span class="line-modified">!         g_array_append_vals (result, digits + systemtime.wSecond/10, 1);</span>
<span class="line-modified">!         g_array_append_vals (result, digits + systemtime.wSecond%10, 1);</span>
<span class="line-modified">!         g_array_append_vals (result, L&quot; &quot;, 1);</span>
  #endif
<span class="line-modified">!         n = GetTimeFormatW (lcid, 0, &amp;systemtime, L&quot;tt&quot;, NULL, 0);</span>
<span class="line-modified">!         if (n &gt; 0)</span>
<span class="line-modified">!     {</span>
<span class="line-modified">!       g_array_set_size (result, result-&gt;len + n);</span>
<span class="line-modified">!       GetTimeFormatW (lcid, 0, &amp;systemtime, L&quot;tt&quot;, ((wchar_t *) result-&gt;data) + result-&gt;len - n, n);</span>
<span class="line-modified">!       g_array_set_size (result, result-&gt;len - 1);</span>
<span class="line-modified">!     }</span>
<span class="line-modified">!         break;</span>
<span class="line-modified">!       case &#39;R&#39;:</span>
  #if 1
<span class="line-modified">!         g_array_append_vals (result, L&quot;00:00&quot;, 5);</span>
  #else
<span class="line-modified">!         g_array_append_vals (result, digits + systemtime.wHour/10, 1);</span>
<span class="line-modified">!         g_array_append_vals (result, digits + systemtime.wHour%10, 1);</span>
<span class="line-modified">!         g_array_append_vals (result, L&quot;:&quot;, 1);</span>
<span class="line-modified">!         g_array_append_vals (result, digits + systemtime.wMinute/10, 1);</span>
<span class="line-modified">!         g_array_append_vals (result, digits + systemtime.wMinute%10, 1);</span>
  #endif
<span class="line-modified">!         break;</span>
<span class="line-modified">!       case &#39;S&#39;:</span>
  #if 1
<span class="line-modified">!         g_array_append_vals (result, L&quot;00&quot;, 2);</span>
  #else
<span class="line-modified">!         g_array_append_vals (result, digits + systemtime.wSecond/10, 1);</span>
<span class="line-modified">!         g_array_append_vals (result, digits + systemtime.wSecond%10, 1);</span>
  #endif
<span class="line-modified">!         break;</span>
<span class="line-modified">!       case &#39;t&#39;:</span>
<span class="line-modified">!         g_array_append_vals (result, L&quot;\t&quot;, 1);</span>
<span class="line-modified">!         break;</span>
<span class="line-modified">!       case &#39;T&#39;:</span>
  #if 1
<span class="line-modified">!         g_array_append_vals (result, L&quot;00:00:00&quot;, 8);</span>
  #else
<span class="line-modified">!         g_array_append_vals (result, digits + systemtime.wHour/10, 1);</span>
<span class="line-modified">!         g_array_append_vals (result, digits + systemtime.wHour%10, 1);</span>
<span class="line-modified">!         g_array_append_vals (result, L&quot;:&quot;, 1);</span>
<span class="line-modified">!         g_array_append_vals (result, digits + systemtime.wMinute/10, 1);</span>
<span class="line-modified">!         g_array_append_vals (result, digits + systemtime.wMinute%10, 1);</span>
<span class="line-modified">!         g_array_append_vals (result, L&quot;:&quot;, 1);</span>
<span class="line-modified">!         g_array_append_vals (result, digits + systemtime.wSecond/10, 1);</span>
<span class="line-modified">!         g_array_append_vals (result, digits + systemtime.wSecond%10, 1);</span>
  #endif
<span class="line-modified">!         break;</span>
<span class="line-modified">!       case &#39;u&#39;:</span>
<span class="line-modified">!         if (systemtime.wDayOfWeek == 0)</span>
<span class="line-modified">!     g_array_append_vals (result, L&quot;7&quot;, 1);</span>
<span class="line-modified">!         else</span>
<span class="line-added">+     g_array_append_vals (result, digits + systemtime.wDayOfWeek, 1);</span>
<span class="line-added">+         break;</span>
<span class="line-added">+       case &#39;U&#39;:</span>
<span class="line-added">+         n = g_date_get_sunday_week_of_year (d);</span>
<span class="line-added">+         g_array_append_vals (result, digits + n/10, 1);</span>
<span class="line-added">+         g_array_append_vals (result, digits + n%10, 1);</span>
<span class="line-added">+         break;</span>
<span class="line-added">+       case &#39;V&#39;:</span>
<span class="line-added">+         n = g_date_get_iso8601_week_of_year (d);</span>
<span class="line-added">+         g_array_append_vals (result, digits + n/10, 1);</span>
<span class="line-added">+         g_array_append_vals (result, digits + n%10, 1);</span>
<span class="line-added">+         break;</span>
<span class="line-added">+       case &#39;w&#39;:</span>
          g_array_append_vals (result, digits + systemtime.wDayOfWeek, 1);
<span class="line-modified">!         break;</span>
<span class="line-modified">!       case &#39;W&#39;:</span>
<span class="line-modified">!         n = g_date_get_monday_week_of_year (d);</span>
<span class="line-modified">!         g_array_append_vals (result, digits + n/10, 1);</span>
<span class="line-modified">!         g_array_append_vals (result, digits + n%10, 1);</span>
<span class="line-modified">!         break;</span>
<span class="line-modified">!       case &#39;x&#39;:</span>
<span class="line-modified">!         n = GetDateFormatW (lcid, 0, &amp;systemtime, NULL, NULL, 0);</span>
<span class="line-modified">!         if (n &gt; 0)</span>
<span class="line-modified">!     {</span>
<span class="line-modified">!       g_array_set_size (result, result-&gt;len + n);</span>
<span class="line-modified">!       GetDateFormatW (lcid, 0, &amp;systemtime, NULL, ((wchar_t *) result-&gt;data) + result-&gt;len - n, n);</span>
<span class="line-modified">!       g_array_set_size (result, result-&gt;len - 1);</span>
      }
<span class="line-modified">!         break;</span>
<span class="line-added">+       case &#39;X&#39;:</span>
<span class="line-added">+         n = GetTimeFormatW (lcid, 0, &amp;systemtime, NULL, NULL, 0);</span>
<span class="line-added">+         if (n &gt; 0)</span>
      {
<span class="line-modified">!       g_array_set_size (result, result-&gt;len + n);</span>
<span class="line-modified">!       GetTimeFormatW (lcid, 0, &amp;systemtime, NULL, ((wchar_t *) result-&gt;data) + result-&gt;len - n, n);</span>
<span class="line-added">+       g_array_set_size (result, result-&gt;len - 1);</span>
      }
<span class="line-added">+         break;</span>
<span class="line-added">+       case &#39;y&#39;:</span>
<span class="line-added">+         g_array_append_vals (result, digits + (systemtime.wYear/10)%10, 1);</span>
<span class="line-added">+         g_array_append_vals (result, digits + systemtime.wYear%10, 1);</span>
<span class="line-added">+         break;</span>
<span class="line-added">+       case &#39;Y&#39;:</span>
<span class="line-added">+         g_array_append_vals (result, digits + systemtime.wYear/1000, 1);</span>
<span class="line-added">+         g_array_append_vals (result, digits + (systemtime.wYear/100)%10, 1);</span>
<span class="line-added">+         g_array_append_vals (result, digits + (systemtime.wYear/10)%10, 1);</span>
<span class="line-added">+         g_array_append_vals (result, digits + systemtime.wYear%10, 1);</span>
<span class="line-added">+         break;</span>
<span class="line-added">+       case &#39;Z&#39;:</span>
<span class="line-added">+         n = GetTimeZoneInformation (&amp;tzinfo);</span>
<span class="line-added">+         if (n == TIME_ZONE_ID_UNKNOWN)</span>
<span class="line-added">+     ;</span>
<span class="line-added">+         else if (n == TIME_ZONE_ID_STANDARD)</span>
<span class="line-added">+     g_array_append_vals (result, tzinfo.StandardName, wcslen (tzinfo.StandardName));</span>
<span class="line-added">+         else if (n == TIME_ZONE_ID_DAYLIGHT)</span>
<span class="line-added">+     g_array_append_vals (result, tzinfo.DaylightName, wcslen (tzinfo.DaylightName));</span>
<span class="line-added">+         break;</span>
<span class="line-added">+       case &#39;%&#39;:</span>
<span class="line-added">+         g_array_append_vals (result, L&quot;%&quot;, 1);</span>
<span class="line-added">+         break;</span>
<span class="line-added">+       }</span>
<span class="line-added">+   }</span>
<span class="line-added">+       else if (c &lt;= 0xFFFF)</span>
<span class="line-added">+   {</span>
<span class="line-added">+     wchar_t wc = c;</span>
<span class="line-added">+     g_array_append_vals (result, &amp;wc, 1);</span>
<span class="line-added">+   }</span>
        else
<span class="line-modified">!   {</span>
<span class="line-modified">!     glong nwc;</span>
<span class="line-modified">!     wchar_t *ws;</span>
  
<span class="line-modified">!     ws = g_ucs4_to_utf16 (&amp;c, 1, NULL, &amp;nwc, NULL);</span>
<span class="line-modified">!     g_array_append_vals (result, ws, nwc);</span>
<span class="line-modified">!     g_free (ws);</span>
<span class="line-modified">!   }</span>
        p = g_utf8_next_char (p);
      }
  
    convbuf = g_utf16_to_utf8 ((wchar_t *) result-&gt;data, result-&gt;len, NULL, &amp;convlen, NULL);
    g_array_free (result, TRUE);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2582,12 ***</span>
<span class="line-new-header">--- 2593,19 ---</span>
   * make the \%F provided by the C99 strftime() work on Windows
   * where the C library only complies to C89.
   *
   * Returns: number of characters written to the buffer, or 0 the buffer was too small
   */
<span class="line-added">+ #ifdef GSTREAMER_LITE</span>
<span class="line-added">+ #ifndef G_OS_WIN32</span>
<span class="line-added">+ #pragma GCC diagnostic push</span>
<span class="line-added">+ #pragma GCC diagnostic ignored &quot;-Wformat-nonliteral&quot;</span>
<span class="line-added">+ #endif // G_OS_WIN32</span>
<span class="line-added">+ #else // GSTREAMER_LITE</span>
  #pragma GCC diagnostic push
  #pragma GCC diagnostic ignored &quot;-Wformat-nonliteral&quot;
<span class="line-added">+ #endif // GSTREAMER_LITE</span>
  
  gsize
  g_date_strftime (gchar       *s,
                   gsize        slen,
                   const gchar *format,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2700,6 ***</span>
<span class="line-new-header">--- 2718,12 ---</span>
  
    return retval;
  #endif
  }
  
<span class="line-added">+ #ifdef GSTREAMER_LITE</span>
<span class="line-added">+ #ifndef G_OS_WIN32</span>
  #pragma GCC diagnostic pop
<span class="line-added">+ #endif // G_OS_WIN32</span>
<span class="line-added">+ #else // GSTREAMER_LITE</span>
<span class="line-added">+ #pragma GCC diagnostic pop</span>
<span class="line-added">+ #endif // GSTREAMER_LITE</span>
</pre>
<center><a href="gdatasetprivate.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="gdate.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>