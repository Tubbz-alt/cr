<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.media/src/main/native/gstreamer/3rd_party/glib/glib/grand.c</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="gqueue.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="grand.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.media/src/main/native/gstreamer/3rd_party/glib/glib/grand.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -47,10 +47,11 @@</span>
  #include &quot;genviron.h&quot;
  #include &quot;gmain.h&quot;
  #include &quot;gmem.h&quot;
  #include &quot;gtestutils.h&quot;
  #include &quot;gthread.h&quot;
<span class="udiff-line-added">+ #include &quot;gtimer.h&quot;</span>
  
  #ifdef G_OS_UNIX
  #include &lt;unistd.h&gt;
  #endif
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -142,20 +143,20 @@</span>
  
    if (g_once_init_enter (&amp;initialized))
      {
        const gchar *version_string = g_getenv (&quot;G_RANDOM_VERSION&quot;);
        if (!version_string || version_string[0] == &#39;\000&#39; ||
<span class="udiff-line-modified-removed">-       strcmp (version_string, &quot;2.2&quot;) == 0)</span>
<span class="udiff-line-modified-removed">-     random_version = 22;</span>
<span class="udiff-line-modified-added">+     strcmp (version_string, &quot;2.2&quot;) == 0)</span>
<span class="udiff-line-modified-added">+   random_version = 22;</span>
        else if (strcmp (version_string, &quot;2.0&quot;) == 0)
<span class="udiff-line-modified-removed">-     random_version = 20;</span>
<span class="udiff-line-modified-added">+   random_version = 20;</span>
        else
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       g_warning (&quot;Unknown G_RANDOM_VERSION \&quot;%s\&quot;. Using version 2.2.&quot;,</span>
<span class="udiff-line-modified-removed">-              version_string);</span>
<span class="udiff-line-modified-removed">-       random_version = 22;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     g_warning (&quot;Unknown G_RANDOM_VERSION \&quot;%s\&quot;. Using version 2.2.&quot;,</span>
<span class="udiff-line-modified-added">+          version_string);</span>
<span class="udiff-line-modified-added">+     random_version = 22;</span>
<span class="udiff-line-modified-added">+   }</span>
        g_once_init_leave (&amp;initialized, TRUE);
      }
  
    return random_version;
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -218,48 +219,47 @@</span>
  g_rand_new (void)
  {
    guint32 seed[4];
  #ifdef G_OS_UNIX
    static gboolean dev_urandom_exists = TRUE;
<span class="udiff-line-removed">-   GTimeVal now;</span>
  
    if (dev_urandom_exists)
      {
        FILE* dev_urandom;
  
        do
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       dev_urandom = fopen(&quot;/dev/urandom&quot;, &quot;rb&quot;);</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     dev_urandom = fopen(&quot;/dev/urandom&quot;, &quot;rb&quot;);</span>
<span class="udiff-line-modified-added">+   }</span>
        while G_UNLIKELY (dev_urandom == NULL &amp;&amp; errno == EINTR);
  
        if (dev_urandom)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       int r;</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     int r;</span>
  
<span class="udiff-line-modified-removed">-       setvbuf (dev_urandom, NULL, _IONBF, 0);</span>
<span class="udiff-line-modified-removed">-       do</span>
<span class="udiff-line-modified-removed">-         {</span>
<span class="udiff-line-modified-removed">-           errno = 0;</span>
<span class="udiff-line-modified-removed">-           r = fread (seed, sizeof (seed), 1, dev_urandom);</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-       while G_UNLIKELY (errno == EINTR);</span>
<span class="udiff-line-modified-added">+     setvbuf (dev_urandom, NULL, _IONBF, 0);</span>
<span class="udiff-line-modified-added">+     do</span>
<span class="udiff-line-modified-added">+       {</span>
<span class="udiff-line-modified-added">+         errno = 0;</span>
<span class="udiff-line-modified-added">+         r = fread (seed, sizeof (seed), 1, dev_urandom);</span>
<span class="udiff-line-modified-added">+       }</span>
<span class="udiff-line-modified-added">+     while G_UNLIKELY (errno == EINTR);</span>
  
<span class="udiff-line-modified-removed">-       if (r != 1)</span>
<span class="udiff-line-modified-removed">-         dev_urandom_exists = FALSE;</span>
<span class="udiff-line-modified-added">+     if (r != 1)</span>
<span class="udiff-line-modified-added">+       dev_urandom_exists = FALSE;</span>
  
<span class="udiff-line-modified-removed">-       fclose (dev_urandom);</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+     fclose (dev_urandom);</span>
<span class="udiff-line-modified-added">+   }</span>
        else
<span class="udiff-line-modified-removed">-     dev_urandom_exists = FALSE;</span>
<span class="udiff-line-modified-added">+   dev_urandom_exists = FALSE;</span>
      }
  
    if (!dev_urandom_exists)
      {
<span class="udiff-line-modified-removed">-       g_get_current_time (&amp;now);</span>
<span class="udiff-line-modified-removed">-       seed[0] = now.tv_sec;</span>
<span class="udiff-line-modified-removed">-       seed[1] = now.tv_usec;</span>
<span class="udiff-line-modified-added">+       gint64 now_us = g_get_real_time ();</span>
<span class="udiff-line-modified-added">+       seed[0] = now_us / G_USEC_PER_SEC;</span>
<span class="udiff-line-modified-added">+       seed[1] = now_us % G_USEC_PER_SEC;</span>
        seed[2] = getpid ();
        seed[3] = getppid ();
      }
  #else /* G_OS_WIN32 */
    /* rand_s() is only available since Visual Studio 2005 and
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -345,26 +345,26 @@</span>
        /* the generator Line 25 of Table 1 in          */
        /* [KNUTH 1981, The Art of Computer Programming */
        /*    Vol. 2 (2nd Ed.), pp102]                  */
  
        if (seed == 0) /* This would make the PRNG produce only zeros */
<span class="udiff-line-modified-removed">-     seed = 0x6b842128; /* Just set it to another number */</span>
<span class="udiff-line-modified-added">+   seed = 0x6b842128; /* Just set it to another number */</span>
  
        rand-&gt;mt[0]= seed;
        for (rand-&gt;mti=1; rand-&gt;mti&lt;N; rand-&gt;mti++)
<span class="udiff-line-modified-removed">-     rand-&gt;mt[rand-&gt;mti] = (69069 * rand-&gt;mt[rand-&gt;mti-1]);</span>
<span class="udiff-line-modified-added">+   rand-&gt;mt[rand-&gt;mti] = (69069 * rand-&gt;mt[rand-&gt;mti-1]);</span>
  
        break;
      case 22:
        /* See Knuth TAOCP Vol2. 3rd Ed. P.106 for multiplier. */
        /* In the previous version (see above), MSBs of the    */
        /* seed affect only MSBs of the array mt[].            */
  
        rand-&gt;mt[0]= seed;
        for (rand-&gt;mti=1; rand-&gt;mti&lt;N; rand-&gt;mti++)
<span class="udiff-line-modified-removed">-     rand-&gt;mt[rand-&gt;mti] = 1812433253UL *</span>
<span class="udiff-line-modified-removed">-       (rand-&gt;mt[rand-&gt;mti-1] ^ (rand-&gt;mt[rand-&gt;mti-1] &gt;&gt; 30)) + rand-&gt;mti;</span>
<span class="udiff-line-modified-added">+   rand-&gt;mt[rand-&gt;mti] = 1812433253UL *</span>
<span class="udiff-line-modified-added">+     (rand-&gt;mt[rand-&gt;mti-1] ^ (rand-&gt;mt[rand-&gt;mti-1] &gt;&gt; 30)) + rand-&gt;mti;</span>
        break;
      default:
        g_assert_not_reached ();
      }
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -398,45 +398,45 @@</span>
    i=1; j=0;
    k = (N&gt;seed_length ? N : seed_length);
    for (; k; k--)
      {
        rand-&gt;mt[i] = (rand-&gt;mt[i] ^
<span class="udiff-line-modified-removed">-              ((rand-&gt;mt[i-1] ^ (rand-&gt;mt[i-1] &gt;&gt; 30)) * 1664525UL))</span>
<span class="udiff-line-modified-removed">-           + seed[j] + j; /* non linear */</span>
<span class="udiff-line-modified-added">+          ((rand-&gt;mt[i-1] ^ (rand-&gt;mt[i-1] &gt;&gt; 30)) * 1664525UL))</span>
<span class="udiff-line-modified-added">+         + seed[j] + j; /* non linear */</span>
        rand-&gt;mt[i] &amp;= 0xffffffffUL; /* for WORDSIZE &gt; 32 machines */
        i++; j++;
        if (i&gt;=N)
          {
<span class="udiff-line-modified-removed">-       rand-&gt;mt[0] = rand-&gt;mt[N-1];</span>
<span class="udiff-line-modified-removed">-       i=1;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+     rand-&gt;mt[0] = rand-&gt;mt[N-1];</span>
<span class="udiff-line-modified-added">+     i=1;</span>
<span class="udiff-line-modified-added">+   }</span>
        if (j&gt;=seed_length)
<span class="udiff-line-modified-removed">-     j=0;</span>
<span class="udiff-line-modified-added">+   j=0;</span>
      }
    for (k=N-1; k; k--)
      {
        rand-&gt;mt[i] = (rand-&gt;mt[i] ^
<span class="udiff-line-modified-removed">-              ((rand-&gt;mt[i-1] ^ (rand-&gt;mt[i-1] &gt;&gt; 30)) * 1566083941UL))</span>
<span class="udiff-line-modified-removed">-           - i; /* non linear */</span>
<span class="udiff-line-modified-added">+          ((rand-&gt;mt[i-1] ^ (rand-&gt;mt[i-1] &gt;&gt; 30)) * 1566083941UL))</span>
<span class="udiff-line-modified-added">+         - i; /* non linear */</span>
        rand-&gt;mt[i] &amp;= 0xffffffffUL; /* for WORDSIZE &gt; 32 machines */
        i++;
        if (i&gt;=N)
          {
<span class="udiff-line-modified-removed">-       rand-&gt;mt[0] = rand-&gt;mt[N-1];</span>
<span class="udiff-line-modified-removed">-       i=1;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+     rand-&gt;mt[0] = rand-&gt;mt[N-1];</span>
<span class="udiff-line-modified-added">+     i=1;</span>
<span class="udiff-line-modified-added">+   }</span>
      }
  
    rand-&gt;mt[0] = 0x80000000UL; /* MSB is 1; assuring non-zero initial array */
  }
  
  /**
   * g_rand_boolean:
   * @rand_: a #GRand
   *
   * Returns a random #gboolean from @rand_.
<span class="udiff-line-modified-removed">-  * This corresponds to a unbiased coin toss.</span>
<span class="udiff-line-modified-added">+  * This corresponds to an unbiased coin toss.</span>
   *
   * Returns: a random #gboolean
   */
  /**
   * g_rand_int:
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -509,63 +509,63 @@</span>
  
    switch (get_random_version ())
      {
      case 20:
        if (dist &lt;= 0x10000L) /* 2^16 */
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       /* This method, which only calls g_rand_int once is only good</span>
<span class="udiff-line-modified-removed">-        * for (end - begin) &lt;= 2^16, because we only have 32 bits set</span>
<span class="udiff-line-modified-removed">-        * from the one call to g_rand_int ().</span>
<span class="udiff-line-modified-removed">-        *</span>
<span class="udiff-line-modified-removed">-        * We are using (trans + trans * trans), because g_rand_int only</span>
<span class="udiff-line-modified-removed">-        * covers [0..2^32-1] and thus g_rand_int * trans only covers</span>
<span class="udiff-line-modified-removed">-        * [0..1-2^-32], but the biggest double &lt; 1 is 1-2^-52.</span>
<span class="udiff-line-modified-removed">-        */</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-       gdouble double_rand = g_rand_int (rand) *</span>
<span class="udiff-line-modified-removed">-         (G_RAND_DOUBLE_TRANSFORM +</span>
<span class="udiff-line-modified-removed">-          G_RAND_DOUBLE_TRANSFORM * G_RAND_DOUBLE_TRANSFORM);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-       random = (gint32) (double_rand * dist);</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     /* This method, which only calls g_rand_int once is only good</span>
<span class="udiff-line-modified-added">+      * for (end - begin) &lt;= 2^16, because we only have 32 bits set</span>
<span class="udiff-line-modified-added">+      * from the one call to g_rand_int ().</span>
<span class="udiff-line-modified-added">+      *</span>
<span class="udiff-line-modified-added">+      * We are using (trans + trans * trans), because g_rand_int only</span>
<span class="udiff-line-modified-added">+      * covers [0..2^32-1] and thus g_rand_int * trans only covers</span>
<span class="udiff-line-modified-added">+      * [0..1-2^-32], but the biggest double &lt; 1 is 1-2^-52.</span>
<span class="udiff-line-modified-added">+      */</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     gdouble double_rand = g_rand_int (rand) *</span>
<span class="udiff-line-modified-added">+       (G_RAND_DOUBLE_TRANSFORM +</span>
<span class="udiff-line-modified-added">+        G_RAND_DOUBLE_TRANSFORM * G_RAND_DOUBLE_TRANSFORM);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     random = (gint32) (double_rand * dist);</span>
<span class="udiff-line-modified-added">+   }</span>
        else
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       /* Now we use g_rand_double_range (), which will set 52 bits</span>
<span class="udiff-line-modified-removed">-        * for us, so that it is safe to round and still get a decent</span>
<span class="udiff-line-modified-removed">-        * distribution</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     /* Now we use g_rand_double_range (), which will set 52 bits</span>
<span class="udiff-line-modified-added">+      * for us, so that it is safe to round and still get a decent</span>
<span class="udiff-line-modified-added">+      * distribution</span>
             */
<span class="udiff-line-modified-removed">-       random = (gint32) g_rand_double_range (rand, 0, dist);</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+     random = (gint32) g_rand_double_range (rand, 0, dist);</span>
<span class="udiff-line-modified-added">+   }</span>
        break;
      case 22:
        if (dist == 0)
<span class="udiff-line-modified-removed">-     random = 0;</span>
<span class="udiff-line-modified-added">+   random = 0;</span>
        else
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       /* maxvalue is set to the predecessor of the greatest</span>
<span class="udiff-line-modified-removed">-        * multiple of dist less or equal 2^32.</span>
<span class="udiff-line-modified-removed">-        */</span>
<span class="udiff-line-modified-removed">-       guint32 maxvalue;</span>
<span class="udiff-line-modified-removed">-       if (dist &lt;= 0x80000000u) /* 2^31 */</span>
<span class="udiff-line-modified-removed">-         {</span>
<span class="udiff-line-modified-removed">-           /* maxvalue = 2^32 - 1 - (2^32 % dist) */</span>
<span class="udiff-line-modified-removed">-           guint32 leftover = (0x80000000u % dist) * 2;</span>
<span class="udiff-line-modified-removed">-           if (leftover &gt;= dist) leftover -= dist;</span>
<span class="udiff-line-modified-removed">-           maxvalue = 0xffffffffu - leftover;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-       else</span>
<span class="udiff-line-modified-removed">-         maxvalue = dist - 1;</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-       do</span>
<span class="udiff-line-modified-removed">-         random = g_rand_int (rand);</span>
<span class="udiff-line-modified-removed">-       while (random &gt; maxvalue);</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-       random %= dist;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     /* maxvalue is set to the predecessor of the greatest</span>
<span class="udiff-line-modified-added">+      * multiple of dist less or equal 2^32.</span>
<span class="udiff-line-modified-added">+      */</span>
<span class="udiff-line-modified-added">+     guint32 maxvalue;</span>
<span class="udiff-line-modified-added">+     if (dist &lt;= 0x80000000u) /* 2^31 */</span>
<span class="udiff-line-modified-added">+       {</span>
<span class="udiff-line-modified-added">+         /* maxvalue = 2^32 - 1 - (2^32 % dist) */</span>
<span class="udiff-line-modified-added">+         guint32 leftover = (0x80000000u % dist) * 2;</span>
<span class="udiff-line-modified-added">+         if (leftover &gt;= dist) leftover -= dist;</span>
<span class="udiff-line-modified-added">+         maxvalue = 0xffffffffu - leftover;</span>
<span class="udiff-line-modified-added">+       }</span>
<span class="udiff-line-modified-added">+     else</span>
<span class="udiff-line-modified-added">+       maxvalue = dist - 1;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     do</span>
<span class="udiff-line-modified-added">+       random = g_rand_int (rand);</span>
<span class="udiff-line-modified-added">+     while (random &gt; maxvalue);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     random %= dist;</span>
<span class="udiff-line-modified-added">+   }</span>
        break;
      default:
<span class="udiff-line-modified-removed">-       random = 0;       /* Quiet GCC */</span>
<span class="udiff-line-modified-added">+       random = 0;   /* Quiet GCC */</span>
        g_assert_not_reached ();
      }
  
    return begin + random;
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -632,11 +632,11 @@</span>
  
  /**
   * g_random_boolean:
   *
   * Returns a random #gboolean.
<span class="udiff-line-modified-removed">-  * This corresponds to a unbiased coin toss.</span>
<span class="udiff-line-modified-added">+  * This corresponds to an unbiased coin toss.</span>
   *
   * Returns: a random #gboolean
   */
  /**
   * g_random_int:
</pre>
<center><a href="gqueue.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="grand.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>