<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.media/src/main/native/gstreamer/gstreamer-lite/gst-plugins-base/gst-libs/gst/video/video-overlay-composition.c</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="video-orc.orc.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="video-overlay-composition.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.media/src/main/native/gstreamer/gstreamer-lite/gst-plugins-base/gst-libs/gst/video/video-overlay-composition.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -40,11 +40,11 @@</span>
   *   buffers, thus consolidating blending functionality for raw video in
   *   one place.
   *
   * Together, this allows existing overlay elements to easily handle raw
   * and non-raw video as input in without major changes (once the overlays
<span class="udiff-line-modified-removed">-  * have been put into a #GstOverlayComposition object anyway) - for raw</span>
<span class="udiff-line-modified-added">+  * have been put into a #GstVideoOverlayComposition object anyway) - for raw</span>
   * video the overlay can just use the blending function to blend the data
   * on top of the video, and for surface buffers it can just attach them to
   * the buffer and let the sink render the overlays.
   *
   */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -310,10 +310,12 @@</span>
    guint num;
  
    num = comp-&gt;num_rectangles;
  
    while (num &gt; 0) {
<span class="udiff-line-added">+     gst_mini_object_remove_parent (GST_MINI_OBJECT_CAST (comp-&gt;rectangles[num -</span>
<span class="udiff-line-added">+                 1]), GST_MINI_OBJECT_CAST (comp));</span>
      gst_video_overlay_rectangle_unref (comp-&gt;rectangles[num - 1]);
      --num;
    }
  
    g_free (comp-&gt;rectangles);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -352,10 +354,12 @@</span>
        (GstMiniObjectCopyFunction) gst_video_overlay_composition_copy,
        NULL, (GstMiniObjectFreeFunction) gst_video_overlay_composition_free);
  
    comp-&gt;rectangles = g_new0 (GstVideoOverlayRectangle *, RECTANGLE_ARRAY_STEP);
    comp-&gt;rectangles[0] = gst_video_overlay_rectangle_ref (rectangle);
<span class="udiff-line-added">+   gst_mini_object_add_parent (GST_MINI_OBJECT_CAST (rectangle),</span>
<span class="udiff-line-added">+       GST_MINI_OBJECT_CAST (comp));</span>
    comp-&gt;num_rectangles = 1;
  
    comp-&gt;seq_num = gst_video_overlay_get_seqnum ();
  
    /* since the rectangle was created earlier, its seqnum is smaller than ours */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -380,20 +384,22 @@</span>
  gst_video_overlay_composition_add_rectangle (GstVideoOverlayComposition * comp,
      GstVideoOverlayRectangle * rectangle)
  {
    g_return_if_fail (GST_IS_VIDEO_OVERLAY_COMPOSITION (comp));
    g_return_if_fail (GST_IS_VIDEO_OVERLAY_RECTANGLE (rectangle));
<span class="udiff-line-modified-removed">-   g_return_if_fail (GST_MINI_OBJECT_REFCOUNT_VALUE (comp) == 1);</span>
<span class="udiff-line-modified-added">+   g_return_if_fail (gst_mini_object_is_writable (GST_MINI_OBJECT_CAST (comp)));</span>
  
    if (comp-&gt;num_rectangles % RECTANGLE_ARRAY_STEP == 0) {
      comp-&gt;rectangles =
          g_renew (GstVideoOverlayRectangle *, comp-&gt;rectangles,
          comp-&gt;num_rectangles + RECTANGLE_ARRAY_STEP);
    }
  
    comp-&gt;rectangles[comp-&gt;num_rectangles] =
        gst_video_overlay_rectangle_ref (rectangle);
<span class="udiff-line-added">+   gst_mini_object_add_parent (GST_MINI_OBJECT_CAST (rectangle),</span>
<span class="udiff-line-added">+       GST_MINI_OBJECT_CAST (comp));</span>
    comp-&gt;num_rectangles += 1;
  
    comp-&gt;min_seq_num_used = MIN (comp-&gt;min_seq_num_used, rectangle-&gt;seq_num);
  
    GST_LOG (&quot;composition %p: added rectangle %p&quot;, comp, rectangle);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -579,15 +585,16 @@</span>
  {
    GstVideoOverlayComposition *writable_comp;
  
    g_return_val_if_fail (GST_IS_VIDEO_OVERLAY_COMPOSITION (comp), NULL);
  
<span class="udiff-line-modified-removed">-   if (GST_MINI_OBJECT_REFCOUNT_VALUE (comp) == 1) {</span>
<span class="udiff-line-modified-added">+   if (gst_mini_object_is_writable (GST_MINI_OBJECT_CAST (comp))) {</span>
      guint n;
  
      for (n = 0; n &lt; comp-&gt;num_rectangles; ++n) {
<span class="udiff-line-modified-removed">-       if (GST_MINI_OBJECT_REFCOUNT_VALUE (comp-&gt;rectangles[n]) != 1)</span>
<span class="udiff-line-modified-added">+       if (!gst_mini_object_is_writable (GST_MINI_OBJECT_CAST (comp-&gt;rectangles</span>
<span class="udiff-line-added">+                   [n])))</span>
          goto copy;
      }
      return comp;
    }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -626,10 +633,12 @@</span>
  static void
  gst_video_overlay_rectangle_free (GstMiniObject * mini_obj)
  {
    GstVideoOverlayRectangle *rect = (GstVideoOverlayRectangle *) mini_obj;
  
<span class="udiff-line-added">+   gst_mini_object_remove_parent (GST_MINI_OBJECT_CAST (rect-&gt;pixels),</span>
<span class="udiff-line-added">+       GST_MINI_OBJECT_CAST (rect));</span>
    gst_buffer_replace (&amp;rect-&gt;pixels, NULL);
  
    while (rect-&gt;scaled_rectangles != NULL) {
      GstVideoOverlayRectangle *scaled_rect = rect-&gt;scaled_rectangles-&gt;data;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -727,10 +736,12 @@</span>
        NULL, (GstMiniObjectFreeFunction) gst_video_overlay_rectangle_free);
  
    g_mutex_init (&amp;rect-&gt;lock);
  
    rect-&gt;pixels = gst_buffer_ref (pixels);
<span class="udiff-line-added">+   gst_mini_object_add_parent (GST_MINI_OBJECT_CAST (pixels),</span>
<span class="udiff-line-added">+       GST_MINI_OBJECT_CAST (rect));</span>
    rect-&gt;scaled_rectangles = NULL;
  
    gst_video_info_init (&amp;rect-&gt;info);
    if (!gst_video_info_set_format (&amp;rect-&gt;info, format, width, height)) {
      gst_mini_object_unref (GST_MINI_OBJECT_CAST (rect));
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -814,11 +825,12 @@</span>
  gst_video_overlay_rectangle_set_render_rectangle (GstVideoOverlayRectangle *
      rectangle, gint render_x, gint render_y, guint render_width,
      guint render_height)
  {
    g_return_if_fail (GST_IS_VIDEO_OVERLAY_RECTANGLE (rectangle));
<span class="udiff-line-modified-removed">-   g_return_if_fail (GST_MINI_OBJECT_REFCOUNT_VALUE (rectangle) == 1);</span>
<span class="udiff-line-modified-added">+   g_return_if_fail (gst_mini_object_is_writable (GST_MINI_OBJECT_CAST</span>
<span class="udiff-line-added">+           (rectangle)));</span>
  
    rectangle-&gt;x = render_x;
    rectangle-&gt;y = render_y;
    rectangle-&gt;render_width = render_width;
    rectangle-&gt;render_height = render_height;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -827,16 +839,21 @@</span>
  /* FIXME: orc-ify */
  static void
  gst_video_overlay_rectangle_premultiply_0 (GstVideoFrame * frame)
  {
    int i, j;
<span class="udiff-line-modified-removed">-   for (j = 0; j &lt; GST_VIDEO_FRAME_HEIGHT (frame); ++j) {</span>
<span class="udiff-line-modified-added">+   int width = GST_VIDEO_FRAME_WIDTH (frame);</span>
<span class="udiff-line-added">+   int height = GST_VIDEO_FRAME_HEIGHT (frame);</span>
<span class="udiff-line-added">+   int stride = GST_VIDEO_FRAME_PLANE_STRIDE (frame, 0);</span>
<span class="udiff-line-added">+   guint8 *data = GST_VIDEO_FRAME_PLANE_DATA (frame, 0);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   for (j = 0; j &lt; height; ++j) {</span>
      guint8 *line;
  
<span class="udiff-line-modified-removed">-     line = GST_VIDEO_FRAME_PLANE_DATA (frame, 0);</span>
<span class="udiff-line-modified-removed">-     line += GST_VIDEO_FRAME_PLANE_STRIDE (frame, 0) * j;</span>
<span class="udiff-line-modified-removed">-     for (i = 0; i &lt; GST_VIDEO_FRAME_WIDTH (frame); ++i) {</span>
<span class="udiff-line-modified-added">+     line = data;</span>
<span class="udiff-line-modified-added">+     line += stride * j;</span>
<span class="udiff-line-modified-added">+     for (i = 0; i &lt; width; ++i) {</span>
        int a = line[0];
        line[1] = line[1] * a / 255;
        line[2] = line[2] * a / 255;
        line[3] = line[3] * a / 255;
        line += 4;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -846,16 +863,21 @@</span>
  
  static void
  gst_video_overlay_rectangle_premultiply_3 (GstVideoFrame * frame)
  {
    int i, j;
<span class="udiff-line-modified-removed">-   for (j = 0; j &lt; GST_VIDEO_FRAME_HEIGHT (frame); ++j) {</span>
<span class="udiff-line-modified-added">+   int width = GST_VIDEO_FRAME_WIDTH (frame);</span>
<span class="udiff-line-added">+   int height = GST_VIDEO_FRAME_HEIGHT (frame);</span>
<span class="udiff-line-added">+   int stride = GST_VIDEO_FRAME_PLANE_STRIDE (frame, 0);</span>
<span class="udiff-line-added">+   guint8 *data = GST_VIDEO_FRAME_PLANE_DATA (frame, 0);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   for (j = 0; j &lt; height; ++j) {</span>
      guint8 *line;
  
<span class="udiff-line-modified-removed">-     line = GST_VIDEO_FRAME_PLANE_DATA (frame, 0);</span>
<span class="udiff-line-modified-removed">-     line += GST_VIDEO_FRAME_PLANE_STRIDE (frame, 0) * j;</span>
<span class="udiff-line-modified-removed">-     for (i = 0; i &lt; GST_VIDEO_FRAME_WIDTH (frame); ++i) {</span>
<span class="udiff-line-modified-added">+     line = data;</span>
<span class="udiff-line-modified-added">+     line += stride * j;</span>
<span class="udiff-line-modified-added">+     for (i = 0; i &lt; width; ++i) {</span>
        int a = line[3];
        line[0] = line[0] * a / 255;
        line[1] = line[1] * a / 255;
        line[2] = line[2] * a / 255;
        line += 4;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -885,16 +907,21 @@</span>
  /* FIXME: orc-ify */
  static void
  gst_video_overlay_rectangle_unpremultiply_0 (GstVideoFrame * frame)
  {
    int i, j;
<span class="udiff-line-modified-removed">-   for (j = 0; j &lt; GST_VIDEO_FRAME_HEIGHT (frame); ++j) {</span>
<span class="udiff-line-modified-added">+   int width = GST_VIDEO_FRAME_WIDTH (frame);</span>
<span class="udiff-line-added">+   int height = GST_VIDEO_FRAME_HEIGHT (frame);</span>
<span class="udiff-line-added">+   int stride = GST_VIDEO_FRAME_PLANE_STRIDE (frame, 0);</span>
<span class="udiff-line-added">+   guint8 *data = GST_VIDEO_FRAME_PLANE_DATA (frame, 0);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   for (j = 0; j &lt; height; ++j) {</span>
      guint8 *line;
  
<span class="udiff-line-modified-removed">-     line = GST_VIDEO_FRAME_PLANE_DATA (frame, 0);</span>
<span class="udiff-line-modified-removed">-     line += GST_VIDEO_FRAME_PLANE_STRIDE (frame, 0) * j;</span>
<span class="udiff-line-modified-removed">-     for (i = 0; i &lt; GST_VIDEO_FRAME_WIDTH (frame); ++i) {</span>
<span class="udiff-line-modified-added">+     line = data;</span>
<span class="udiff-line-modified-added">+     line += stride * j;</span>
<span class="udiff-line-modified-added">+     for (i = 0; i &lt; width; ++i) {</span>
        int a = line[0];
        if (a) {
          line[1] = MIN ((line[1] * 255 + a / 2) / a, 255);
          line[2] = MIN ((line[2] * 255 + a / 2) / a, 255);
          line[3] = MIN ((line[3] * 255 + a / 2) / a, 255);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -906,16 +933,21 @@</span>
  
  static void
  gst_video_overlay_rectangle_unpremultiply_3 (GstVideoFrame * frame)
  {
    int i, j;
<span class="udiff-line-modified-removed">-   for (j = 0; j &lt; GST_VIDEO_FRAME_HEIGHT (frame); ++j) {</span>
<span class="udiff-line-modified-added">+   int width = GST_VIDEO_FRAME_WIDTH (frame);</span>
<span class="udiff-line-added">+   int height = GST_VIDEO_FRAME_HEIGHT (frame);</span>
<span class="udiff-line-added">+   int stride = GST_VIDEO_FRAME_PLANE_STRIDE (frame, 0);</span>
<span class="udiff-line-added">+   guint8 *data = GST_VIDEO_FRAME_PLANE_DATA (frame, 0);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   for (j = 0; j &lt; height; ++j) {</span>
      guint8 *line;
  
<span class="udiff-line-modified-removed">-     line = GST_VIDEO_FRAME_PLANE_DATA (frame, 0);</span>
<span class="udiff-line-modified-removed">-     line += GST_VIDEO_FRAME_PLANE_STRIDE (frame, 0) * j;</span>
<span class="udiff-line-modified-removed">-     for (i = 0; i &lt; GST_VIDEO_FRAME_WIDTH (frame); ++i) {</span>
<span class="udiff-line-modified-added">+     line = data;</span>
<span class="udiff-line-modified-added">+     line += stride * j;</span>
<span class="udiff-line-modified-added">+     for (i = 0; i &lt; width; ++i) {</span>
        int a = line[3];
        if (a) {
          line[0] = MIN ((line[0] * 255 + a / 2) / a, 255);
          line[1] = MIN ((line[1] * 255 + a / 2) / a, 255);
          line[2] = MIN ((line[2] * 255 + a / 2) / a, 255);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -998,11 +1030,17 @@</span>
  
    if (rect-&gt;initial_alpha == NULL)
      gst_video_overlay_rectangle_extract_alpha (rect);
  
    src = rect-&gt;initial_alpha;
<span class="udiff-line-modified-removed">-   rect-&gt;pixels = gst_buffer_make_writable (rect-&gt;pixels);</span>
<span class="udiff-line-modified-added">+   if (!gst_buffer_is_writable (rect-&gt;pixels)) {</span>
<span class="udiff-line-added">+     gst_mini_object_remove_parent (GST_MINI_OBJECT_CAST (rect-&gt;pixels),</span>
<span class="udiff-line-added">+         GST_MINI_OBJECT_CAST (rect));</span>
<span class="udiff-line-added">+     rect-&gt;pixels = gst_buffer_copy (rect-&gt;pixels);</span>
<span class="udiff-line-added">+     gst_mini_object_add_parent (GST_MINI_OBJECT_CAST (rect-&gt;pixels),</span>
<span class="udiff-line-added">+         GST_MINI_OBJECT_CAST (rect));</span>
<span class="udiff-line-added">+   }</span>
  
    gst_video_frame_map (&amp;frame, &amp;rect-&gt;info, rect-&gt;pixels, GST_MAP_READ);
    dst = GST_VIDEO_FRAME_PLANE_DATA (&amp;frame, 0);
    w = GST_VIDEO_INFO_WIDTH (&amp;rect-&gt;info);
    h = GST_VIDEO_INFO_HEIGHT (&amp;rect-&gt;info);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1526,10 +1564,12 @@</span>
  void
  gst_video_overlay_rectangle_set_global_alpha (GstVideoOverlayRectangle *
      rectangle, gfloat global_alpha)
  {
    g_return_if_fail (GST_IS_VIDEO_OVERLAY_RECTANGLE (rectangle));
<span class="udiff-line-added">+   g_return_if_fail (gst_mini_object_is_writable (GST_MINI_OBJECT_CAST</span>
<span class="udiff-line-added">+           (rectangle)));</span>
    g_return_if_fail (global_alpha &gt;= 0 &amp;&amp; global_alpha &lt;= 1);
  
    if (rectangle-&gt;global_alpha != global_alpha) {
      rectangle-&gt;global_alpha = global_alpha;
      if (global_alpha != 1)
</pre>
<center><a href="video-orc.orc.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="video-overlay-composition.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>