<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.media/src/main/native/gstreamer/gstreamer-lite/gst-plugins-base/gst-libs/gst/tag/gsttagdemux.c</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="gstid3tag.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="gsttageditingprivate.c.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.media/src/main/native/gstreamer/gstreamer-lite/gst-plugins-base/gst-libs/gst/tag/gsttagdemux.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 165,10 ***</span>
<span class="line-new-header">--- 165,11 ---</span>
  static void gst_tag_demux_base_init (gpointer g_class);
  static void gst_tag_demux_class_init (gpointer g_class, gpointer d);
  static void gst_tag_demux_init (GstTagDemux * obj, GstTagDemuxClass * klass);
  
  static gpointer parent_class;   /* NULL */
<span class="line-added">+ static gint private_offset = 0;</span>
  
  /* Cannot use boilerplate macros here because we want the abstract flag */
  GType
  gst_tag_demux_get_type (void)
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 187,15 ***</span>
<span class="line-new-header">--- 188,24 ---</span>
        (GInstanceInitFunc) gst_tag_demux_init
      };
  
      object_type = g_type_register_static (GST_TYPE_ELEMENT,
          &quot;GstTagDemux&quot;, &amp;object_info, G_TYPE_FLAG_ABSTRACT);
<span class="line-added">+ </span>
<span class="line-added">+     private_offset =</span>
<span class="line-added">+         g_type_add_instance_private (object_type, sizeof (GstTagDemuxPrivate));</span>
    }
  
    return object_type;
  }
  
<span class="line-added">+ static inline GstTagDemuxPrivate *</span>
<span class="line-added">+ gst_tag_demux_get_instance_private (GstTagDemux * self)</span>
<span class="line-added">+ {</span>
<span class="line-added">+   return (G_STRUCT_MEMBER_P (self, private_offset));</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  static void
  gst_tag_demux_base_init (gpointer klass)
  {
    GstElementClass *element_class = GST_ELEMENT_CLASS (klass);
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 216,11 ***</span>
  
    gobject_class-&gt;dispose = gst_tag_demux_dispose;
  
    element_class-&gt;change_state = GST_DEBUG_FUNCPTR (gst_tag_demux_change_state);
  
<span class="line-modified">!   g_type_class_add_private (klass, sizeof (GstTagDemuxPrivate));</span>
  
    /* subclasses must set at least one of these */
    tagdemux_class-&gt;min_start_size = 0;
    tagdemux_class-&gt;min_end_size = 0;
  }
<span class="line-new-header">--- 226,12 ---</span>
  
    gobject_class-&gt;dispose = gst_tag_demux_dispose;
  
    element_class-&gt;change_state = GST_DEBUG_FUNCPTR (gst_tag_demux_change_state);
  
<span class="line-modified">!   if (private_offset != 0)</span>
<span class="line-added">+     g_type_class_adjust_private_offset (klass, &amp;private_offset);</span>
  
    /* subclasses must set at least one of these */
    tagdemux_class-&gt;min_start_size = 0;
    tagdemux_class-&gt;min_end_size = 0;
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 265,12 ***</span>
  gst_tag_demux_init (GstTagDemux * demux, GstTagDemuxClass * gclass)
  {
    GstElementClass *element_klass = GST_ELEMENT_CLASS (gclass);
    GstPadTemplate *tmpl;
  
<span class="line-modified">!   demux-&gt;priv = g_type_instance_get_private ((GTypeInstance *) demux,</span>
<span class="line-removed">-       GST_TYPE_TAG_DEMUX);</span>
  
    /* sink pad */
    tmpl = gst_element_class_get_pad_template (element_klass, &quot;sink&quot;);
    if (tmpl) {
      demux-&gt;priv-&gt;sinkpad = gst_pad_new_from_template (tmpl, &quot;sink&quot;);
<span class="line-new-header">--- 276,11 ---</span>
  gst_tag_demux_init (GstTagDemux * demux, GstTagDemuxClass * gclass)
  {
    GstElementClass *element_klass = GST_ELEMENT_CLASS (gclass);
    GstPadTemplate *tmpl;
  
<span class="line-modified">!   demux-&gt;priv = gst_tag_demux_get_instance_private (demux);</span>
  
    /* sink pad */
    tmpl = gst_element_class_get_pad_template (element_klass, &quot;sink&quot;);
    if (tmpl) {
      demux-&gt;priv-&gt;sinkpad = gst_pad_new_from_template (tmpl, &quot;sink&quot;);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 330,12 ***</span>
    if (old_caps == NULL || !gst_caps_is_equal (new_caps, old_caps)) {
      GstEvent *event;
  
      gst_caps_replace (&amp;tagdemux-&gt;priv-&gt;src_caps, new_caps);
  
<span class="line-modified">!       GST_DEBUG_OBJECT (tagdemux, &quot;Changing src pad caps to %&quot; GST_PTR_FORMAT,</span>
<span class="line-modified">!           tagdemux-&gt;priv-&gt;src_caps);</span>
  
      event =
          gst_pad_get_sticky_event (tagdemux-&gt;priv-&gt;sinkpad,
          GST_EVENT_STREAM_START, 0);
      if (!event) {
<span class="line-new-header">--- 340,12 ---</span>
    if (old_caps == NULL || !gst_caps_is_equal (new_caps, old_caps)) {
      GstEvent *event;
  
      gst_caps_replace (&amp;tagdemux-&gt;priv-&gt;src_caps, new_caps);
  
<span class="line-modified">!     GST_DEBUG_OBJECT (tagdemux, &quot;Changing src pad caps to %&quot; GST_PTR_FORMAT,</span>
<span class="line-modified">!         tagdemux-&gt;priv-&gt;src_caps);</span>
  
      event =
          gst_pad_get_sticky_event (tagdemux-&gt;priv-&gt;sinkpad,
          GST_EVENT_STREAM_START, 0);
      if (!event) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 661,11 ***</span>
  
        GST_DEBUG_OBJECT (demux, &quot;Found type %&quot; GST_PTR_FORMAT &quot; with a &quot;
            &quot;probability of %u&quot;, caps, probability);
  
        gst_tag_demux_set_src_caps (demux, caps);
<span class="line-modified">!         gst_caps_unref (caps);</span>
  
        /* Move onto streaming and fall-through to push out existing
         * data */
        demux-&gt;priv-&gt;state = GST_TAG_DEMUX_STREAMING;
        /* fall-through */
<span class="line-new-header">--- 671,11 ---</span>
  
        GST_DEBUG_OBJECT (demux, &quot;Found type %&quot; GST_PTR_FORMAT &quot; with a &quot;
            &quot;probability of %u&quot;, caps, probability);
  
        gst_tag_demux_set_src_caps (demux, caps);
<span class="line-modified">!       gst_caps_unref (caps);</span>
  
        /* Move onto streaming and fall-through to push out existing
         * data */
        demux-&gt;priv-&gt;state = GST_TAG_DEMUX_STREAMING;
        /* fall-through */
</pre>
<hr />
<pre>
<span class="line-old-header">*** 733,12 ***</span>
  
          /* push final buffer with eos indication to force typefinding */
          gst_tag_demux_chain_buffer (demux, gst_buffer_new (), TRUE);
  
          if (!gst_pad_has_current_caps (demux-&gt;priv-&gt;srcpad)) {
<span class="line-modified">!         GST_ELEMENT_ERROR (demux, STREAM, TYPE_NOT_FOUND, (NULL), (NULL));</span>
<span class="line-modified">!       }</span>
        }
        ret = gst_pad_event_default (pad, parent, event);
        break;
      case GST_EVENT_SEGMENT:
      {
<span class="line-new-header">--- 743,12 ---</span>
  
          /* push final buffer with eos indication to force typefinding */
          gst_tag_demux_chain_buffer (demux, gst_buffer_new (), TRUE);
  
          if (!gst_pad_has_current_caps (demux-&gt;priv-&gt;srcpad)) {
<span class="line-modified">!           GST_ELEMENT_ERROR (demux, STREAM, TYPE_NOT_FOUND, (NULL), (NULL));</span>
<span class="line-modified">!         }</span>
        }
        ret = gst_pad_event_default (pad, parent, event);
        break;
      case GST_EVENT_SEGMENT:
      {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 919,67 ***</span>
  
  static gboolean
  gst_tag_demux_seek_push (GstTagDemux * tagdemux, GstEvent * event)
  {
    gboolean res = FALSE;
<span class="line-modified">!       gdouble rate;</span>
<span class="line-modified">!       GstFormat format;</span>
    GstSeekType start_type, stop_type;
<span class="line-modified">!       GstSeekFlags flags;</span>
    gint64 start, stop;
  
<span class="line-modified">!       gst_event_parse_seek (event, &amp;rate, &amp;format, &amp;flags,</span>
        &amp;start_type, &amp;start, &amp;stop_type, &amp;stop);
  
<span class="line-modified">!       if (format == GST_FORMAT_BYTES &amp;&amp;</span>
<span class="line-modified">!           tagdemux-&gt;priv-&gt;state == GST_TAG_DEMUX_STREAMING &amp;&amp;</span>
<span class="line-modified">!           gst_pad_is_linked (tagdemux-&gt;priv-&gt;sinkpad)) {</span>
<span class="line-modified">!         GstEvent *upstream;</span>
  
      switch (start_type) {
<span class="line-modified">!           case GST_SEEK_TYPE_SET:</span>
          if (start == -1)
            start = 0;
          start += tagdemux-&gt;priv-&gt;strip_start;
<span class="line-modified">!             break;</span>
<span class="line-modified">!           case GST_SEEK_TYPE_END:</span>
<span class="line-modified">!             /* Adjust the seek to be relative to the start of any end tag</span>
<span class="line-modified">!              * (note: 10 bytes before end is represented by stop=-10) */</span>
          if (start &gt; 0)
            start = 0;
          start -= tagdemux-&gt;priv-&gt;strip_end;
<span class="line-modified">!             break;</span>
<span class="line-modified">!           case GST_SEEK_TYPE_NONE:</span>
<span class="line-modified">!           default:</span>
<span class="line-modified">!             break;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         switch (stop_type) {</span>
<span class="line-modified">!           case GST_SEEK_TYPE_SET:</span>
<span class="line-modified">!             if (stop != -1) {</span>
<span class="line-modified">!               /* -1 means the end of the file, pass it upstream intact */</span>
<span class="line-modified">!               stop += tagdemux-&gt;priv-&gt;strip_start;</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-             break;</span>
<span class="line-removed">-           case GST_SEEK_TYPE_END:</span>
<span class="line-removed">-             /* Adjust the seek to be relative to the start of any end tag</span>
<span class="line-removed">-              * (note: 10 bytes before end is represented by stop=-10) */</span>
<span class="line-removed">-             if (stop &gt; 0)</span>
<span class="line-removed">-               stop = 0;</span>
<span class="line-removed">-             stop -= tagdemux-&gt;priv-&gt;strip_end;</span>
<span class="line-removed">-             break;</span>
<span class="line-removed">-           case GST_SEEK_TYPE_NONE:</span>
<span class="line-removed">-           default:</span>
<span class="line-removed">-             break;</span>
          }
<span class="line-modified">!         upstream = gst_event_new_seek (rate, format, flags,</span>
          start_type, start, stop_type, stop);
<span class="line-modified">!         res = gst_pad_push_event (tagdemux-&gt;priv-&gt;sinkpad, upstream);</span>
    } else if (format == GST_FORMAT_TIME &amp;&amp;
        tagdemux-&gt;priv-&gt;state == GST_TAG_DEMUX_STREAMING &amp;&amp;
        gst_pad_is_linked (tagdemux-&gt;priv-&gt;sinkpad)) {
      res = gst_pad_push_event (tagdemux-&gt;priv-&gt;sinkpad, gst_event_ref (event));
<span class="line-modified">!       }</span>
  
    return res;
  }
  
  static gboolean
<span class="line-new-header">--- 929,67 ---</span>
  
  static gboolean
  gst_tag_demux_seek_push (GstTagDemux * tagdemux, GstEvent * event)
  {
    gboolean res = FALSE;
<span class="line-modified">!   gdouble rate;</span>
<span class="line-modified">!   GstFormat format;</span>
    GstSeekType start_type, stop_type;
<span class="line-modified">!   GstSeekFlags flags;</span>
    gint64 start, stop;
  
<span class="line-modified">!   gst_event_parse_seek (event, &amp;rate, &amp;format, &amp;flags,</span>
        &amp;start_type, &amp;start, &amp;stop_type, &amp;stop);
  
<span class="line-modified">!   if (format == GST_FORMAT_BYTES &amp;&amp;</span>
<span class="line-modified">!       tagdemux-&gt;priv-&gt;state == GST_TAG_DEMUX_STREAMING &amp;&amp;</span>
<span class="line-modified">!       gst_pad_is_linked (tagdemux-&gt;priv-&gt;sinkpad)) {</span>
<span class="line-modified">!     GstEvent *upstream;</span>
  
      switch (start_type) {
<span class="line-modified">!       case GST_SEEK_TYPE_SET:</span>
          if (start == -1)
            start = 0;
          start += tagdemux-&gt;priv-&gt;strip_start;
<span class="line-modified">!         break;</span>
<span class="line-modified">!       case GST_SEEK_TYPE_END:</span>
<span class="line-modified">!         /* Adjust the seek to be relative to the start of any end tag</span>
<span class="line-modified">!          * (note: 10 bytes before end is represented by stop=-10) */</span>
          if (start &gt; 0)
            start = 0;
          start -= tagdemux-&gt;priv-&gt;strip_end;
<span class="line-modified">!         break;</span>
<span class="line-modified">!       case GST_SEEK_TYPE_NONE:</span>
<span class="line-modified">!       default:</span>
<span class="line-modified">!         break;</span>
<span class="line-modified">!     }</span>
<span class="line-modified">!     switch (stop_type) {</span>
<span class="line-modified">!       case GST_SEEK_TYPE_SET:</span>
<span class="line-modified">!         if (stop != -1) {</span>
<span class="line-modified">!           /* -1 means the end of the file, pass it upstream intact */</span>
<span class="line-modified">!           stop += tagdemux-&gt;priv-&gt;strip_start;</span>
          }
<span class="line-modified">!         break;</span>
<span class="line-added">+       case GST_SEEK_TYPE_END:</span>
<span class="line-added">+         /* Adjust the seek to be relative to the start of any end tag</span>
<span class="line-added">+          * (note: 10 bytes before end is represented by stop=-10) */</span>
<span class="line-added">+         if (stop &gt; 0)</span>
<span class="line-added">+           stop = 0;</span>
<span class="line-added">+         stop -= tagdemux-&gt;priv-&gt;strip_end;</span>
<span class="line-added">+         break;</span>
<span class="line-added">+       case GST_SEEK_TYPE_NONE:</span>
<span class="line-added">+       default:</span>
<span class="line-added">+         break;</span>
<span class="line-added">+     }</span>
<span class="line-added">+     upstream = gst_event_new_seek (rate, format, flags,</span>
          start_type, start, stop_type, stop);
<span class="line-modified">!     res = gst_pad_push_event (tagdemux-&gt;priv-&gt;sinkpad, upstream);</span>
    } else if (format == GST_FORMAT_TIME &amp;&amp;
        tagdemux-&gt;priv-&gt;state == GST_TAG_DEMUX_STREAMING &amp;&amp;
        gst_pad_is_linked (tagdemux-&gt;priv-&gt;sinkpad)) {
      res = gst_pad_push_event (tagdemux-&gt;priv-&gt;sinkpad, gst_event_ref (event));
<span class="line-modified">!   }</span>
  
    return res;
  }
  
  static gboolean
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1383,11 ***</span>
     * the chain function if we end up in push mode */
    demux-&gt;priv-&gt;state = GST_TAG_DEMUX_STREAMING;
  
    /* 6 Set the srcpad caps now that we know them */
    gst_tag_demux_set_src_caps (demux, caps);
<span class="line-modified">!       gst_caps_unref (caps);</span>
  
  skip_typefinding:
  
    /* set it again, in case we skipped typefinding */
    demux-&gt;priv-&gt;state = GST_TAG_DEMUX_STREAMING;
<span class="line-new-header">--- 1393,11 ---</span>
     * the chain function if we end up in push mode */
    demux-&gt;priv-&gt;state = GST_TAG_DEMUX_STREAMING;
  
    /* 6 Set the srcpad caps now that we know them */
    gst_tag_demux_set_src_caps (demux, caps);
<span class="line-modified">!   gst_caps_unref (caps);</span>
  
  skip_typefinding:
  
    /* set it again, in case we skipped typefinding */
    demux-&gt;priv-&gt;state = GST_TAG_DEMUX_STREAMING;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1453,11 ***</span>
  
        if (demux-&gt;priv-&gt;need_newseg) {
          demux-&gt;priv-&gt;need_newseg = FALSE;
          /* FIXME: check segment, should be 0-N for downstream */
          gst_tag_demux_send_new_segment (demux);
<span class="line-modified">!   }</span>
  
        /* Send our own pending tag event */
        if (demux-&gt;priv-&gt;send_tag_event) {
          gst_tag_demux_send_tag_event (demux);
          demux-&gt;priv-&gt;send_tag_event = FALSE;
<span class="line-new-header">--- 1463,11 ---</span>
  
        if (demux-&gt;priv-&gt;need_newseg) {
          demux-&gt;priv-&gt;need_newseg = FALSE;
          /* FIXME: check segment, should be 0-N for downstream */
          gst_tag_demux_send_new_segment (demux);
<span class="line-modified">!       }</span>
  
        /* Send our own pending tag event */
        if (demux-&gt;priv-&gt;send_tag_event) {
          gst_tag_demux_send_tag_event (demux);
          demux-&gt;priv-&gt;send_tag_event = FALSE;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1476,11 ***</span>
        GST_BUFFER_OFFSET_END (outbuf) =
            demux-&gt;priv-&gt;offset - demux-&gt;priv-&gt;strip_start;
  
        ret = gst_pad_push (demux-&gt;priv-&gt;srcpad, outbuf);
        break;
<span class="line-modified">!   }</span>
      default:
        ret = GST_FLOW_ERROR;
        break;
    }
    if (ret != GST_FLOW_OK)
<span class="line-new-header">--- 1486,11 ---</span>
        GST_BUFFER_OFFSET_END (outbuf) =
            demux-&gt;priv-&gt;offset - demux-&gt;priv-&gt;strip_start;
  
        ret = gst_pad_push (demux-&gt;priv-&gt;srcpad, outbuf);
        break;
<span class="line-modified">!     }</span>
      default:
        ret = GST_FLOW_ERROR;
        break;
    }
    if (ret != GST_FLOW_OK)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1514,11 ***</span>
                  GST_FORMAT_BYTES, stop));
          gst_pad_push_event (demux-&gt;priv-&gt;srcpad,
              gst_event_new_segment_done (GST_FORMAT_BYTES, stop));
        } else {
          push_eos = TRUE;
<span class="line-modified">!   }</span>
      } else if (ret == GST_FLOW_NOT_LINKED || ret &lt; GST_FLOW_EOS) {
        /* for fatal errors we post an error message */
        GST_ELEMENT_FLOW_ERROR (demux, ret);
        push_eos = TRUE;
      }
<span class="line-new-header">--- 1524,11 ---</span>
                  GST_FORMAT_BYTES, stop));
          gst_pad_push_event (demux-&gt;priv-&gt;srcpad,
              gst_event_new_segment_done (GST_FORMAT_BYTES, stop));
        } else {
          push_eos = TRUE;
<span class="line-modified">!       }</span>
      } else if (ret == GST_FLOW_NOT_LINKED || ret &lt; GST_FLOW_EOS) {
        /* for fatal errors we post an error message */
        GST_ELEMENT_FLOW_ERROR (demux, ret);
        push_eos = TRUE;
      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1826,11 ***</span>
  #ifdef GSTREAMER_LITE
    if (event == NULL)
      return;
  #endif // GSTREAMER_LITE
  
<span class="line-removed">-     GST_EVENT_TIMESTAMP (event) = 0;</span>
      GST_DEBUG_OBJECT (demux, &quot;Sending tag event on src pad&quot;);
      gst_pad_push_event (demux-&gt;priv-&gt;srcpad, event);
    }
  }
  
<span class="line-new-header">--- 1836,10 ---</span>
</pre>
<center><a href="gstid3tag.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="gsttageditingprivate.c.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>