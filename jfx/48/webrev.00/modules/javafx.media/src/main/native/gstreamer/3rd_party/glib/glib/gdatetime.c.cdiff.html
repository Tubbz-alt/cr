<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.media/src/main/native/gstreamer/3rd_party/glib/glib/gdatetime.c</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="gdate.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="gdatetime.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.media/src/main/native/gstreamer/3rd_party/glib/glib/gdatetime.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,12 ***</span>
  /* gdatetime.c
   *
   * Copyright (C) 2009-2010 Christian Hergert &lt;chris@dronelabs.com&gt;
   * Copyright (C) 2010 Thiago Santos &lt;thiago.sousa.santos@collabora.co.uk&gt;
   * Copyright (C) 2010 Emmanuele Bassi &lt;ebassi@linux.intel.com&gt;
<span class="line-modified">!  * Copyright � 2010 Codethink Limited</span>
<span class="line-modified">!  * Copyright � 2018 Tomasz Mi?sko</span>
   *
   * This library is free software; you can redistribute it and/or modify
   * it under the terms of the GNU Lesser General Public License as
   * published by the Free Software Foundation; either version 2.1 of the
   * licence, or (at your option) any later version.
<span class="line-new-header">--- 1,12 ---</span>
  /* gdatetime.c
   *
   * Copyright (C) 2009-2010 Christian Hergert &lt;chris@dronelabs.com&gt;
   * Copyright (C) 2010 Thiago Santos &lt;thiago.sousa.santos@collabora.co.uk&gt;
   * Copyright (C) 2010 Emmanuele Bassi &lt;ebassi@linux.intel.com&gt;
<span class="line-modified">!  * Copyright (C) 2010 Codethink Limited</span>
<span class="line-modified">!  * Copyright (C) 2018 Tomasz Miasko</span>
   *
   * This library is free software; you can redistribute it and/or modify
   * it under the terms of the GNU Lesser General Public License as
   * published by the Free Software Foundation; either version 2.1 of the
   * licence, or (at your option) any later version.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 132,14 ***</span>
<span class="line-new-header">--- 132,20 ---</span>
  /* Time conversion {{{1 */
  
  #define UNIX_EPOCH_START     719163
  #define INSTANT_TO_UNIX(instant) \
    ((instant)/USEC_PER_SECOND - UNIX_EPOCH_START * SEC_PER_DAY)
<span class="line-added">+ #define INSTANT_TO_UNIX_USECS(instant) \</span>
<span class="line-added">+   ((instant) - UNIX_EPOCH_START * SEC_PER_DAY * USEC_PER_SECOND)</span>
  #define UNIX_TO_INSTANT(unix) \
    (((gint64) (unix) + UNIX_EPOCH_START * SEC_PER_DAY) * USEC_PER_SECOND)
<span class="line-added">+ #define UNIX_USECS_TO_INSTANT(unix_usecs) \</span>
<span class="line-added">+   ((gint64) (unix_usecs) + UNIX_EPOCH_START * SEC_PER_DAY * USEC_PER_SECOND)</span>
  #define UNIX_TO_INSTANT_IS_VALID(unix) \
    ((gint64) (unix) &lt;= INSTANT_TO_UNIX (G_MAXINT64))
<span class="line-added">+ #define UNIX_USECS_TO_INSTANT_IS_VALID(unix_usecs) \</span>
<span class="line-added">+   ((gint64) (unix_usecs) &lt;= INSTANT_TO_UNIX_USECS (G_MAXINT64))</span>
  
  #define DAYS_IN_4YEARS    1461    /* days in 4 years */
  #define DAYS_IN_100YEARS  36524   /* days in 100 years */
  #define DAYS_IN_400YEARS  146097  /* days in 400 years  */
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 739,11 ***</span>
  }
  
  /*&lt; internal &gt;
   * g_date_time_from_instant:
   * @tz: a #GTimeZone
<span class="line-modified">!  * @instant: a instant in time</span>
   *
   * Creates a #GDateTime from a time zone and an instant.
   *
   * This might fail if the time ends up being out of range.
   */
<span class="line-new-header">--- 745,11 ---</span>
  }
  
  /*&lt; internal &gt;
   * g_date_time_from_instant:
   * @tz: a #GTimeZone
<span class="line-modified">!  * @instant: an instant in time</span>
   *
   * Creates a #GDateTime from a time zone and an instant.
   *
   * This might fail if the time ends up being out of range.
   */
</pre>
<hr />
<pre>
<span class="line-old-header">*** 852,10 ***</span>
<span class="line-new-header">--- 858,11 ---</span>
    return new;
  }
  
  /* now/unix/timeval Constructors {{{1 */
  
<span class="line-added">+ G_GNUC_BEGIN_IGNORE_DEPRECATIONS</span>
  /*&lt; internal &gt;
   * g_date_time_new_from_timeval:
   * @tz: a #GTimeZone
   * @tv: a #GTimeVal
   *
</pre>
<hr />
<pre>
<span class="line-old-header">*** 885,17 ***</span>
      return NULL;
  
    return g_date_time_from_instant (tz, tv-&gt;tv_usec +
                                     UNIX_TO_INSTANT (tv-&gt;tv_sec));
  }
  
  /*&lt; internal &gt;
   * g_date_time_new_from_unix:
   * @tz: a #GTimeZone
<span class="line-modified">!  * @t: the Unix time</span>
   *
<span class="line-modified">!  * Creates a #GDateTime corresponding to the given Unix time @t in the</span>
   * given time zone @tz.
   *
   * Unix time is the number of seconds that have elapsed since 1970-01-01
   * 00:00:00 UTC, regardless of the time zone given.
   *
<span class="line-new-header">--- 892,18 ---</span>
      return NULL;
  
    return g_date_time_from_instant (tz, tv-&gt;tv_usec +
                                     UNIX_TO_INSTANT (tv-&gt;tv_sec));
  }
<span class="line-added">+ G_GNUC_END_IGNORE_DEPRECATIONS</span>
  
  /*&lt; internal &gt;
   * g_date_time_new_from_unix:
   * @tz: a #GTimeZone
<span class="line-modified">!  * @usecs: the Unix time, in microseconds since the epoch</span>
   *
<span class="line-modified">!  * Creates a #GDateTime corresponding to the given Unix time @t_us in the</span>
   * given time zone @tz.
   *
   * Unix time is the number of seconds that have elapsed since 1970-01-01
   * 00:00:00 UTC, regardless of the time zone given.
   *
</pre>
<hr />
<pre>
<span class="line-old-header">*** 909,16 ***</span>
   *
   * Since: 2.26
   **/
  static GDateTime *
  g_date_time_new_from_unix (GTimeZone *tz,
<span class="line-modified">!                            gint64     secs)</span>
  {
<span class="line-modified">!   if (!UNIX_TO_INSTANT_IS_VALID (secs))</span>
      return NULL;
  
<span class="line-modified">!   return g_date_time_from_instant (tz, UNIX_TO_INSTANT (secs));</span>
  }
  
  /**
   * g_date_time_new_now:
   * @tz: a #GTimeZone
<span class="line-new-header">--- 917,16 ---</span>
   *
   * Since: 2.26
   **/
  static GDateTime *
  g_date_time_new_from_unix (GTimeZone *tz,
<span class="line-modified">!                            gint64     usecs)</span>
  {
<span class="line-modified">!   if (!UNIX_USECS_TO_INSTANT_IS_VALID (usecs))</span>
      return NULL;
  
<span class="line-modified">!   return g_date_time_from_instant (tz, UNIX_USECS_TO_INSTANT (usecs));</span>
  }
  
  /**
   * g_date_time_new_now:
   * @tz: a #GTimeZone
</pre>
<hr />
<pre>
<span class="line-old-header">*** 939,15 ***</span>
   * Since: 2.26
   **/
  GDateTime *
  g_date_time_new_now (GTimeZone *tz)
  {
<span class="line-modified">!   GTimeVal tv;</span>
  
<span class="line-modified">!   g_get_current_time (&amp;tv);</span>
  
<span class="line-modified">!   return g_date_time_new_from_timeval (tz, &amp;tv);</span>
  }
  
  /**
   * g_date_time_new_now_local:
   *
<span class="line-new-header">--- 947,15 ---</span>
   * Since: 2.26
   **/
  GDateTime *
  g_date_time_new_now (GTimeZone *tz)
  {
<span class="line-modified">!   gint64 now_us;</span>
  
<span class="line-modified">!   now_us = g_get_real_time ();</span>
  
<span class="line-modified">!   return g_date_time_new_from_unix (tz, now_us);</span>
  }
  
  /**
   * g_date_time_new_now_local:
   *
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1023,12 ***</span>
  g_date_time_new_from_unix_local (gint64 t)
  {
    GDateTime *datetime;
    GTimeZone *local;
  
    local = g_time_zone_new_local ();
<span class="line-modified">!   datetime = g_date_time_new_from_unix (local, t);</span>
    g_time_zone_unref (local);
  
    return datetime;
  }
  
<span class="line-new-header">--- 1031,15 ---</span>
  g_date_time_new_from_unix_local (gint64 t)
  {
    GDateTime *datetime;
    GTimeZone *local;
  
<span class="line-added">+   if (t &gt; G_MAXINT64 / USEC_PER_SECOND)</span>
<span class="line-added">+     return NULL;</span>
<span class="line-added">+ </span>
    local = g_time_zone_new_local ();
<span class="line-modified">!   datetime = g_date_time_new_from_unix (local, t * USEC_PER_SECOND);</span>
    g_time_zone_unref (local);
  
    return datetime;
  }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1055,12 ***</span>
  g_date_time_new_from_unix_utc (gint64 t)
  {
    GDateTime *datetime;
    GTimeZone *utc;
  
    utc = g_time_zone_new_utc ();
<span class="line-modified">!   datetime = g_date_time_new_from_unix (utc, t);</span>
    g_time_zone_unref (utc);
  
    return datetime;
  }
  
<span class="line-new-header">--- 1066,15 ---</span>
  g_date_time_new_from_unix_utc (gint64 t)
  {
    GDateTime *datetime;
    GTimeZone *utc;
  
<span class="line-added">+   if (t &gt; G_MAXINT64 / USEC_PER_SECOND)</span>
<span class="line-added">+     return NULL;</span>
<span class="line-added">+ </span>
    utc = g_time_zone_new_utc ();
<span class="line-modified">!   datetime = g_date_time_new_from_unix (utc, t * USEC_PER_SECOND);</span>
    g_time_zone_unref (utc);
  
    return datetime;
  }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1082,11 ***</span>
<span class="line-new-header">--- 1096,14 ---</span>
   * when you are done with it.
   *
   * Returns: a new #GDateTime, or %NULL
   *
   * Since: 2.26
<span class="line-added">+  * Deprecated: 2.62: #GTimeVal is not year-2038-safe. Use</span>
<span class="line-added">+  *    g_date_time_new_from_unix_local() instead.</span>
   **/
<span class="line-added">+ G_GNUC_BEGIN_IGNORE_DEPRECATIONS</span>
  GDateTime *
  g_date_time_new_from_timeval_local (const GTimeVal *tv)
  {
    GDateTime *datetime;
    GTimeZone *local;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1095,10 ***</span>
<span class="line-new-header">--- 1112,11 ---</span>
    datetime = g_date_time_new_from_timeval (local, tv);
    g_time_zone_unref (local);
  
    return datetime;
  }
<span class="line-added">+ G_GNUC_END_IGNORE_DEPRECATIONS</span>
  
  /**
   * g_date_time_new_from_timeval_utc:
   * @tv: a #GTimeVal
   *
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1114,11 ***</span>
<span class="line-new-header">--- 1132,14 ---</span>
   * when you are done with it.
   *
   * Returns: a new #GDateTime, or %NULL
   *
   * Since: 2.26
<span class="line-added">+  * Deprecated: 2.62: #GTimeVal is not year-2038-safe. Use</span>
<span class="line-added">+  *    g_date_time_new_from_unix_utc() instead.</span>
   **/
<span class="line-added">+ G_GNUC_BEGIN_IGNORE_DEPRECATIONS</span>
  GDateTime *
  g_date_time_new_from_timeval_utc (const GTimeVal *tv)
  {
    GDateTime *datetime;
    GTimeZone *utc;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1127,16 ***</span>
    datetime = g_date_time_new_from_timeval (utc, tv);
    g_time_zone_unref (utc);
  
    return datetime;
  }
  
  /* Parse integers in the form d (week days), dd (hours etc), ddd (ordinal days) or dddd (years) */
  static gboolean
  get_iso8601_int (const gchar *text, gsize length, gint *value)
  {
<span class="line-modified">!   gint i, v = 0;</span>
  
    if (length &lt; 1 || length &gt; 4)
      return FALSE;
  
    for (i = 0; i &lt; length; i++)
<span class="line-new-header">--- 1148,18 ---</span>
    datetime = g_date_time_new_from_timeval (utc, tv);
    g_time_zone_unref (utc);
  
    return datetime;
  }
<span class="line-added">+ G_GNUC_END_IGNORE_DEPRECATIONS</span>
  
  /* Parse integers in the form d (week days), dd (hours etc), ddd (ordinal days) or dddd (years) */
  static gboolean
  get_iso8601_int (const gchar *text, gsize length, gint *value)
  {
<span class="line-modified">!   gsize i;</span>
<span class="line-added">+   guint v = 0;</span>
  
    if (length &lt; 1 || length &gt; 4)
      return FALSE;
  
    for (i = 0; i &lt; length; i++)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1153,11 ***</span>
  
  /* Parse seconds in the form ss or ss.sss (variable length decimal) */
  static gboolean
  get_iso8601_seconds (const gchar *text, gsize length, gdouble *value)
  {
<span class="line-modified">!   gint i;</span>
    gdouble divisor = 1, v = 0;
  
    if (length &lt; 2)
      return FALSE;
  
<span class="line-new-header">--- 1176,11 ---</span>
  
  /* Parse seconds in the form ss or ss.sss (variable length decimal) */
  static gboolean
  get_iso8601_seconds (const gchar *text, gsize length, gdouble *value)
  {
<span class="line-modified">!   gsize i;</span>
    gdouble divisor = 1, v = 0;
  
    if (length &lt; 2)
      return FALSE;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1195,15 ***</span>
  
    if (ordinal_day &lt; 1 || ordinal_day &gt; (GREGORIAN_LEAP (year) ? 366 : 365))
      return NULL;
  
    dt = g_date_time_new (tz, year, 1, 1, hour, minute, seconds);
<span class="line-modified">! #ifdef GSTREAMER_LITE</span>
<span class="line-removed">-   if (dt == NULL) {</span>
      return NULL;
<span class="line-removed">-   }</span>
<span class="line-removed">- #endif // GSTREAMER_LITE</span>
    dt-&gt;days += ordinal_day - 1;
  
    return dt;
  }
  
<span class="line-new-header">--- 1218,12 ---</span>
  
    if (ordinal_day &lt; 1 || ordinal_day &gt; (GREGORIAN_LEAP (year) ? 366 : 365))
      return NULL;
  
    dt = g_date_time_new (tz, year, 1, 1, hour, minute, seconds);
<span class="line-modified">!   if (dt == NULL)</span>
      return NULL;
    dt-&gt;days += ordinal_day - 1;
  
    return dt;
  }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1219,10 ***</span>
<span class="line-new-header">--- 1239,12 ---</span>
  
    if (week &lt; 1 || week &gt; max_week || week_day &lt; 1 || week_day &gt; 7)
      return NULL;
  
    dt = g_date_time_new (tz, year, 1, 4, 0, 0, 0);
<span class="line-added">+   if (dt == NULL)</span>
<span class="line-added">+     return NULL;</span>
    g_date_time_get_week_number (dt, NULL, &amp;jan4_week_day, NULL);
    g_date_time_unref (dt);
  
    ordinal_day = (week * 7) + week_day - (jan4_week_day + 3);
    if (ordinal_day &lt; 0)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1306,11 ***</span>
  }
  
  static GTimeZone *
  parse_iso8601_timezone (const gchar *text, gsize length, gssize *tz_offset)
  {
<span class="line-modified">!   gint i, tz_length, offset_sign = 1, offset_hours, offset_minutes;</span>
    GTimeZone *tz;
  
    /* UTC uses Z suffix  */
    if (length &gt; 0 &amp;&amp; text[length - 1] == &#39;Z&#39;)
      {
<span class="line-new-header">--- 1328,12 ---</span>
  }
  
  static GTimeZone *
  parse_iso8601_timezone (const gchar *text, gsize length, gssize *tz_offset)
  {
<span class="line-modified">!   gint i, tz_length, offset_hours, offset_minutes;</span>
<span class="line-added">+   gint offset_sign = 1;</span>
    GTimeZone *tz;
  
    /* UTC uses Z suffix  */
    if (length &gt; 0 &amp;&amp; text[length - 1] == &#39;Z&#39;)
      {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1355,12 ***</span>
  
    *tz_offset = i;
    tz = g_time_zone_new (text + i);
  
    /* Double-check that the GTimeZone matches our interpretation of the timezone.
<span class="line-modified">!    * Failure would indicate a bug either here of in the GTimeZone code. */</span>
<span class="line-modified">!   g_assert (g_time_zone_get_offset (tz, 0) == offset_sign * (offset_hours * 3600 + offset_minutes * 60));</span>
  
    return tz;
  }
  
  static gboolean
<span class="line-new-header">--- 1378,18 ---</span>
  
    *tz_offset = i;
    tz = g_time_zone_new (text + i);
  
    /* Double-check that the GTimeZone matches our interpretation of the timezone.
<span class="line-modified">!    * This can fail because our interpretation is less strict than (for example)</span>
<span class="line-modified">!    * parse_time() in gtimezone.c, which restricts the range of the parsed</span>
<span class="line-added">+    * integers. */</span>
<span class="line-added">+   if (g_time_zone_get_offset (tz, 0) != offset_sign * (offset_hours * 3600 + offset_minutes * 60))</span>
<span class="line-added">+     {</span>
<span class="line-added">+       g_time_zone_unref (tz);</span>
<span class="line-added">+       return NULL;</span>
<span class="line-added">+     }</span>
  
    return tz;
  }
  
  static gboolean
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2535,20 ***</span>
<span class="line-new-header">--- 2564,24 ---</span>
   * On systems where &#39;long&#39; is 64bit, this function never fails.
   *
   * Returns: %TRUE if successful, else %FALSE
   *
   * Since: 2.26
<span class="line-added">+  * Deprecated: 2.62: #GTimeVal is not year-2038-safe. Use</span>
<span class="line-added">+  *    g_date_time_to_unix() instead.</span>
   **/
<span class="line-added">+ G_GNUC_BEGIN_IGNORE_DEPRECATIONS</span>
  gboolean
  g_date_time_to_timeval (GDateTime *datetime,
                          GTimeVal  *tv)
  {
    tv-&gt;tv_sec = INSTANT_TO_UNIX (g_date_time_to_instant (datetime));
    tv-&gt;tv_usec = datetime-&gt;usec % USEC_PER_SECOND;
  
    return TRUE;
  }
<span class="line-added">+ G_GNUC_END_IGNORE_DEPRECATIONS</span>
  
  /* Timezone queries {{{1 */
  /**
   * g_date_time_get_utc_offset:
   * @datetime: a #GDateTime
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2781,11 ***</span>
  
    return TRUE;
  }
  
  #ifdef HAVE_LANGINFO_OUTDIGIT
<span class="line-modified">! /** Initializes the array with UTF-8 encoded alternate digits suibtable for use</span>
   * in current locale. Returns NULL when current locale does not use alternate
   * digits or there was an error converting them to UTF-8.
   */
  static const gchar * const *
  initialize_alt_digits (void)
<span class="line-new-header">--- 2814,11 ---</span>
  
    return TRUE;
  }
  
  #ifdef HAVE_LANGINFO_OUTDIGIT
<span class="line-modified">! /* Initializes the array with UTF-8 encoded alternate digits suitable for use</span>
   * in current locale. Returns NULL when current locale does not use alternate
   * digits or there was an error converting them to UTF-8.
   */
  static const gchar * const *
  initialize_alt_digits (void)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2811,11 ***</span>
  
        digit = g_locale_to_utf8 (locale_digit, -1, NULL, &amp;digit_len, NULL);
        if (digit == NULL)
          return NULL;
  
<span class="line-modified">!       g_assert (digit_len &lt; buffer + sizeof (buffer) - buffer_end);</span>
  
        alt_digits[i] = buffer_end;
        buffer_end = g_stpcpy (buffer_end, digit);
        /* skip trailing null byte */
        buffer_end += 1;
<span class="line-new-header">--- 2844,11 ---</span>
  
        digit = g_locale_to_utf8 (locale_digit, -1, NULL, &amp;digit_len, NULL);
        if (digit == NULL)
          return NULL;
  
<span class="line-modified">!       g_assert (digit_len &lt; (gsize) (buffer + sizeof (buffer) - buffer_end));</span>
  
        alt_digits[i] = buffer_end;
        buffer_end = g_stpcpy (buffer_end, digit);
        /* skip trailing null byte */
        buffer_end += 1;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2903,31 ***</span>
      }
    if (uppercase)
      ampm_dup = g_utf8_strup (ampm, -1);
    else
      ampm_dup = g_utf8_strdown (ampm, -1);
<span class="line-modified">!       g_free (tmp);</span>
  
    g_string_append (outstr, ampm_dup);
<span class="line-modified">!       g_free (ampm_dup);</span>
  
    return TRUE;
  }
  
  static gboolean g_date_time_format_utf8 (GDateTime   *datetime,
<span class="line-modified">!                        const gchar *format,</span>
<span class="line-modified">!                        GString     *outstr,</span>
<span class="line-modified">!                        gboolean     locale_is_utf8);</span>
  
  /* g_date_time_format() subroutine that takes a locale-encoded format
   * string and produces a UTF-8 encoded date/time string.
   */
  static gboolean
  g_date_time_format_locale (GDateTime   *datetime,
<span class="line-modified">!                const gchar *locale_format,</span>
<span class="line-modified">!                            GString     *outstr,</span>
<span class="line-modified">!                            gboolean     locale_is_utf8)</span>
  {
    gchar *utf8_format;
    gboolean success;
  
    if (locale_is_utf8)
<span class="line-new-header">--- 2936,31 ---</span>
      }
    if (uppercase)
      ampm_dup = g_utf8_strup (ampm, -1);
    else
      ampm_dup = g_utf8_strdown (ampm, -1);
<span class="line-modified">!   g_free (tmp);</span>
  
    g_string_append (outstr, ampm_dup);
<span class="line-modified">!   g_free (ampm_dup);</span>
  
    return TRUE;
  }
  
  static gboolean g_date_time_format_utf8 (GDateTime   *datetime,
<span class="line-modified">!            const gchar *format,</span>
<span class="line-modified">!            GString     *outstr,</span>
<span class="line-modified">!            gboolean     locale_is_utf8);</span>
  
  /* g_date_time_format() subroutine that takes a locale-encoded format
   * string and produces a UTF-8 encoded date/time string.
   */
  static gboolean
  g_date_time_format_locale (GDateTime   *datetime,
<span class="line-modified">!          const gchar *locale_format,</span>
<span class="line-modified">!          GString     *outstr,</span>
<span class="line-modified">!          gboolean     locale_is_utf8)</span>
  {
    gchar *utf8_format;
    gboolean success;
  
    if (locale_is_utf8)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2936,11 ***</span>
    utf8_format = g_locale_to_utf8 (locale_format, -1, NULL, NULL, NULL);
    if (utf8_format == NULL)
      return FALSE;
  
    success = g_date_time_format_utf8 (datetime, utf8_format, outstr,
<span class="line-modified">!                        locale_is_utf8);</span>
    g_free (utf8_format);
    return success;
  }
  
  static inline gboolean
<span class="line-new-header">--- 2969,11 ---</span>
    utf8_format = g_locale_to_utf8 (locale_format, -1, NULL, NULL, NULL);
    if (utf8_format == NULL)
      return FALSE;
  
    success = g_date_time_format_utf8 (datetime, utf8_format, outstr,
<span class="line-modified">!                                      locale_is_utf8);</span>
    g_free (utf8_format);
    return success;
  }
  
  static inline gboolean
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2970,13 ***</span>
  /* g_date_time_format() subroutine that takes a UTF-8 encoded format
   * string and produces a UTF-8 encoded date/time string.
   */
  static gboolean
  g_date_time_format_utf8 (GDateTime   *datetime,
<span class="line-modified">!              const gchar *utf8_format,</span>
<span class="line-modified">!              GString     *outstr,</span>
<span class="line-modified">!              gboolean     locale_is_utf8)</span>
  {
    guint     len;
    guint     colons;
    gunichar  c;
    gboolean  alt_digits = FALSE;
<span class="line-new-header">--- 3003,13 ---</span>
  /* g_date_time_format() subroutine that takes a UTF-8 encoded format
   * string and produces a UTF-8 encoded date/time string.
   */
  static gboolean
  g_date_time_format_utf8 (GDateTime   *datetime,
<span class="line-modified">!        const gchar *utf8_format,</span>
<span class="line-modified">!        GString     *outstr,</span>
<span class="line-modified">!        gboolean     locale_is_utf8)</span>
  {
    guint     len;
    guint     colons;
    gunichar  c;
    gboolean  alt_digits = FALSE;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2992,271 ***</span>
        if (len)
          g_string_append_len (outstr, utf8_format, len);
  
        utf8_format += len;
        if (!*utf8_format)
<span class="line-modified">!     break;</span>
  
        g_assert (*utf8_format == &#39;%&#39;);
        utf8_format++;
        if (!*utf8_format)
<span class="line-modified">!     break;</span>
  
        colons = 0;
        alt_digits = FALSE;
        pad_set = FALSE;
  
      next_mod:
        c = g_utf8_get_char (utf8_format);
        utf8_format = g_utf8_next_char (utf8_format);
        switch (c)
<span class="line-modified">!     {</span>
<span class="line-modified">!     case &#39;a&#39;:</span>
<span class="line-modified">!       name = WEEKDAY_ABBR (datetime);</span>
            if (g_strcmp0 (name, &quot;&quot;) == 0)
              return FALSE;
  
            name_is_utf8 = locale_is_utf8 || !WEEKDAY_ABBR_IS_LOCALE;
  
            if (!string_append (outstr, name, name_is_utf8))
              return FALSE;
  
<span class="line-modified">!       break;</span>
<span class="line-modified">!     case &#39;A&#39;:</span>
<span class="line-modified">!       name = WEEKDAY_FULL (datetime);</span>
            if (g_strcmp0 (name, &quot;&quot;) == 0)
              return FALSE;
  
            name_is_utf8 = locale_is_utf8 || !WEEKDAY_FULL_IS_LOCALE;
  
            if (!string_append (outstr, name, name_is_utf8))
              return FALSE;
  
<span class="line-modified">!       break;</span>
<span class="line-modified">!     case &#39;b&#39;:</span>
<span class="line-modified">!       name = alt_digits ? MONTH_ABBR_STANDALONE (datetime)</span>
<span class="line-modified">!                 : MONTH_ABBR_WITH_DAY (datetime);</span>
            if (g_strcmp0 (name, &quot;&quot;) == 0)
              return FALSE;
  
            name_is_utf8 = locale_is_utf8 ||
              ((alt_digits &amp;&amp; !MONTH_ABBR_STANDALONE_IS_LOCALE) ||
               (!alt_digits &amp;&amp; !MONTH_ABBR_WITH_DAY_IS_LOCALE));
  
            if (!string_append (outstr, name, name_is_utf8))
              return FALSE;
  
<span class="line-modified">!       break;</span>
<span class="line-modified">!     case &#39;B&#39;:</span>
<span class="line-modified">!       name = alt_digits ? MONTH_FULL_STANDALONE (datetime)</span>
<span class="line-modified">!                 : MONTH_FULL_WITH_DAY (datetime);</span>
            if (g_strcmp0 (name, &quot;&quot;) == 0)
              return FALSE;
  
            name_is_utf8 = locale_is_utf8 ||
              ((alt_digits &amp;&amp; !MONTH_FULL_STANDALONE_IS_LOCALE) ||
               (!alt_digits &amp;&amp; !MONTH_FULL_WITH_DAY_IS_LOCALE));
  
            if (!string_append (outstr, name, name_is_utf8))
                return FALSE;
  
<span class="line-modified">!       break;</span>
<span class="line-modified">!     case &#39;c&#39;:</span>
<span class="line-modified">!       {</span>
              if (g_strcmp0 (PREFERRED_DATE_TIME_FMT, &quot;&quot;) == 0)
                return FALSE;
              if (!g_date_time_format_locale (datetime, PREFERRED_DATE_TIME_FMT,
                                              outstr, locale_is_utf8))
                return FALSE;
<span class="line-modified">!       }</span>
<span class="line-modified">!       break;</span>
<span class="line-modified">!     case &#39;C&#39;:</span>
<span class="line-modified">!       format_number (outstr, alt_digits, pad_set ? pad : &quot;0&quot;, 2,</span>
<span class="line-modified">!              g_date_time_get_year (datetime) / 100);</span>
<span class="line-modified">!       break;</span>
<span class="line-modified">!     case &#39;d&#39;:</span>
<span class="line-modified">!       format_number (outstr, alt_digits, pad_set ? pad : &quot;0&quot;, 2,</span>
<span class="line-modified">!              g_date_time_get_day_of_month (datetime));</span>
<span class="line-modified">!       break;</span>
<span class="line-modified">!     case &#39;e&#39;:</span>
<span class="line-modified">!       format_number (outstr, alt_digits, pad_set ? pad : &quot; &quot;, 2,</span>
<span class="line-modified">!              g_date_time_get_day_of_month (datetime));</span>
<span class="line-modified">!       break;</span>
<span class="line-modified">!     case &#39;F&#39;:</span>
<span class="line-modified">!       g_string_append_printf (outstr, &quot;%d-%02d-%02d&quot;,</span>
<span class="line-modified">!                   g_date_time_get_year (datetime),</span>
<span class="line-modified">!                   g_date_time_get_month (datetime),</span>
<span class="line-modified">!                   g_date_time_get_day_of_month (datetime));</span>
<span class="line-modified">!       break;</span>
<span class="line-modified">!     case &#39;g&#39;:</span>
<span class="line-modified">!       format_number (outstr, alt_digits, pad_set ? pad : &quot;0&quot;, 2,</span>
<span class="line-modified">!              g_date_time_get_week_numbering_year (datetime) % 100);</span>
<span class="line-modified">!       break;</span>
<span class="line-modified">!     case &#39;G&#39;:</span>
<span class="line-modified">!       format_number (outstr, alt_digits, pad_set ? pad : 0, 0,</span>
<span class="line-modified">!              g_date_time_get_week_numbering_year (datetime));</span>
<span class="line-modified">!       break;</span>
<span class="line-modified">!     case &#39;h&#39;:</span>
<span class="line-modified">!       name = alt_digits ? MONTH_ABBR_STANDALONE (datetime)</span>
<span class="line-modified">!                 : MONTH_ABBR_WITH_DAY (datetime);</span>
            if (g_strcmp0 (name, &quot;&quot;) == 0)
              return FALSE;
  
            name_is_utf8 = locale_is_utf8 ||
              ((alt_digits &amp;&amp; !MONTH_ABBR_STANDALONE_IS_LOCALE) ||
               (!alt_digits &amp;&amp; !MONTH_ABBR_WITH_DAY_IS_LOCALE));
  
            if (!string_append (outstr, name, name_is_utf8))
              return FALSE;
  
<span class="line-modified">!       break;</span>
<span class="line-modified">!     case &#39;H&#39;:</span>
<span class="line-modified">!       format_number (outstr, alt_digits, pad_set ? pad : &quot;0&quot;, 2,</span>
<span class="line-modified">!              g_date_time_get_hour (datetime));</span>
<span class="line-modified">!       break;</span>
<span class="line-modified">!     case &#39;I&#39;:</span>
<span class="line-modified">!       format_number (outstr, alt_digits, pad_set ? pad : &quot;0&quot;, 2,</span>
<span class="line-modified">!              (g_date_time_get_hour (datetime) + 11) % 12 + 1);</span>
<span class="line-modified">!       break;</span>
<span class="line-modified">!     case &#39;j&#39;:</span>
<span class="line-modified">!       format_number (outstr, alt_digits, pad_set ? pad : &quot;0&quot;, 3,</span>
<span class="line-modified">!              g_date_time_get_day_of_year (datetime));</span>
<span class="line-modified">!       break;</span>
<span class="line-modified">!     case &#39;k&#39;:</span>
<span class="line-modified">!       format_number (outstr, alt_digits, pad_set ? pad : &quot; &quot;, 2,</span>
<span class="line-modified">!              g_date_time_get_hour (datetime));</span>
<span class="line-modified">!       break;</span>
<span class="line-modified">!     case &#39;l&#39;:</span>
<span class="line-modified">!       format_number (outstr, alt_digits, pad_set ? pad : &quot; &quot;, 2,</span>
<span class="line-modified">!              (g_date_time_get_hour (datetime) + 11) % 12 + 1);</span>
<span class="line-modified">!       break;</span>
<span class="line-modified">!     case &#39;n&#39;:</span>
<span class="line-modified">!       g_string_append_c (outstr, &#39;\n&#39;);</span>
<span class="line-modified">!       break;</span>
<span class="line-modified">!     case &#39;m&#39;:</span>
<span class="line-modified">!       format_number (outstr, alt_digits, pad_set ? pad : &quot;0&quot;, 2,</span>
<span class="line-modified">!              g_date_time_get_month (datetime));</span>
<span class="line-modified">!       break;</span>
<span class="line-modified">!     case &#39;M&#39;:</span>
<span class="line-modified">!       format_number (outstr, alt_digits, pad_set ? pad : &quot;0&quot;, 2,</span>
<span class="line-modified">!              g_date_time_get_minute (datetime));</span>
<span class="line-modified">!       break;</span>
<span class="line-modified">!     case &#39;O&#39;:</span>
<span class="line-modified">!       alt_digits = TRUE;</span>
<span class="line-modified">!       goto next_mod;</span>
<span class="line-modified">!     case &#39;p&#39;:</span>
            if (!format_ampm (datetime, outstr, locale_is_utf8, TRUE))
              return FALSE;
            break;
<span class="line-modified">!     case &#39;P&#39;:</span>
            if (!format_ampm (datetime, outstr, locale_is_utf8, FALSE))
              return FALSE;
<span class="line-modified">!       break;</span>
<span class="line-modified">!     case &#39;r&#39;:</span>
<span class="line-modified">!       {</span>
              if (g_strcmp0 (PREFERRED_12HR_TIME_FMT, &quot;&quot;) == 0)
                return FALSE;
<span class="line-modified">!         if (!g_date_time_format_locale (datetime, PREFERRED_12HR_TIME_FMT,</span>
<span class="line-modified">!                         outstr, locale_is_utf8))</span>
<span class="line-modified">!           return FALSE;</span>
<span class="line-modified">!       }</span>
<span class="line-modified">!       break;</span>
<span class="line-modified">!     case &#39;R&#39;:</span>
<span class="line-modified">!       g_string_append_printf (outstr, &quot;%02d:%02d&quot;,</span>
<span class="line-modified">!                   g_date_time_get_hour (datetime),</span>
<span class="line-modified">!                   g_date_time_get_minute (datetime));</span>
<span class="line-modified">!       break;</span>
<span class="line-modified">!     case &#39;s&#39;:</span>
<span class="line-modified">!       g_string_append_printf (outstr, &quot;%&quot; G_GINT64_FORMAT, g_date_time_to_unix (datetime));</span>
<span class="line-modified">!       break;</span>
<span class="line-modified">!     case &#39;S&#39;:</span>
<span class="line-modified">!       format_number (outstr, alt_digits, pad_set ? pad : &quot;0&quot;, 2,</span>
<span class="line-modified">!              g_date_time_get_second (datetime));</span>
<span class="line-modified">!       break;</span>
<span class="line-modified">!     case &#39;t&#39;:</span>
<span class="line-modified">!       g_string_append_c (outstr, &#39;\t&#39;);</span>
<span class="line-modified">!       break;</span>
<span class="line-modified">!     case &#39;T&#39;:</span>
<span class="line-modified">!       g_string_append_printf (outstr, &quot;%02d:%02d:%02d&quot;,</span>
<span class="line-modified">!                   g_date_time_get_hour (datetime),</span>
<span class="line-modified">!                   g_date_time_get_minute (datetime),</span>
<span class="line-modified">!                   g_date_time_get_second (datetime));</span>
<span class="line-modified">!       break;</span>
<span class="line-modified">!     case &#39;u&#39;:</span>
<span class="line-modified">!       format_number (outstr, alt_digits, 0, 0,</span>
<span class="line-modified">!              g_date_time_get_day_of_week (datetime));</span>
<span class="line-modified">!       break;</span>
<span class="line-modified">!     case &#39;V&#39;:</span>
<span class="line-modified">!       format_number (outstr, alt_digits, pad_set ? pad : &quot;0&quot;, 2,</span>
<span class="line-modified">!              g_date_time_get_week_of_year (datetime));</span>
<span class="line-modified">!       break;</span>
<span class="line-modified">!     case &#39;w&#39;:</span>
<span class="line-modified">!       format_number (outstr, alt_digits, 0, 0,</span>
<span class="line-modified">!              g_date_time_get_day_of_week (datetime) % 7);</span>
<span class="line-modified">!       break;</span>
<span class="line-modified">!     case &#39;x&#39;:</span>
<span class="line-modified">!       {</span>
              if (g_strcmp0 (PREFERRED_DATE_FMT, &quot;&quot;) == 0)
                return FALSE;
<span class="line-modified">!         if (!g_date_time_format_locale (datetime, PREFERRED_DATE_FMT,</span>
<span class="line-modified">!                         outstr, locale_is_utf8))</span>
<span class="line-modified">!           return FALSE;</span>
<span class="line-modified">!       }</span>
<span class="line-modified">!       break;</span>
<span class="line-modified">!     case &#39;X&#39;:</span>
<span class="line-modified">!       {</span>
              if (g_strcmp0 (PREFERRED_TIME_FMT, &quot;&quot;) == 0)
                return FALSE;
<span class="line-modified">!         if (!g_date_time_format_locale (datetime, PREFERRED_TIME_FMT,</span>
<span class="line-modified">!                         outstr, locale_is_utf8))</span>
<span class="line-removed">-           return FALSE;</span>
<span class="line-removed">-       }</span>
<span class="line-removed">-       break;</span>
<span class="line-removed">-     case &#39;y&#39;:</span>
<span class="line-removed">-       format_number (outstr, alt_digits, pad_set ? pad : &quot;0&quot;, 2,</span>
<span class="line-removed">-              g_date_time_get_year (datetime) % 100);</span>
<span class="line-removed">-       break;</span>
<span class="line-removed">-     case &#39;Y&#39;:</span>
<span class="line-removed">-       format_number (outstr, alt_digits, 0, 0,</span>
<span class="line-removed">-              g_date_time_get_year (datetime));</span>
<span class="line-removed">-       break;</span>
<span class="line-removed">-     case &#39;z&#39;:</span>
<span class="line-removed">-       {</span>
<span class="line-removed">-         gint64 offset;</span>
<span class="line-removed">-         offset = g_date_time_get_utc_offset (datetime) / USEC_PER_SECOND;</span>
<span class="line-removed">-         if (!format_z (outstr, (int) offset, colons))</span>
<span class="line-removed">-           return FALSE;</span>
<span class="line-removed">-       }</span>
<span class="line-removed">-       break;</span>
<span class="line-removed">-     case &#39;Z&#39;:</span>
<span class="line-removed">-       tz = g_date_time_get_timezone_abbreviation (datetime);</span>
<span class="line-removed">-           g_string_append (outstr, tz);</span>
<span class="line-removed">-       break;</span>
<span class="line-removed">-     case &#39;%&#39;:</span>
<span class="line-removed">-       g_string_append_c (outstr, &#39;%&#39;);</span>
<span class="line-removed">-       break;</span>
<span class="line-removed">-     case &#39;-&#39;:</span>
<span class="line-removed">-       pad_set = TRUE;</span>
<span class="line-removed">-       pad = &quot;&quot;;</span>
<span class="line-removed">-       goto next_mod;</span>
<span class="line-removed">-     case &#39;_&#39;:</span>
<span class="line-removed">-       pad_set = TRUE;</span>
<span class="line-removed">-       pad = &quot; &quot;;</span>
<span class="line-removed">-       goto next_mod;</span>
<span class="line-removed">-     case &#39;0&#39;:</span>
<span class="line-removed">-       pad_set = TRUE;</span>
<span class="line-removed">-       pad = &quot;0&quot;;</span>
<span class="line-removed">-       goto next_mod;</span>
<span class="line-removed">-     case &#39;:&#39;:</span>
<span class="line-removed">-       /* Colons are only allowed before &#39;z&#39; */</span>
<span class="line-removed">-       if (*utf8_format &amp;&amp; *utf8_format != &#39;z&#39; &amp;&amp; *utf8_format != &#39;:&#39;)</span>
          return FALSE;
<span class="line-removed">-       colons++;</span>
<span class="line-removed">-       goto next_mod;</span>
<span class="line-removed">-     default:</span>
<span class="line-removed">-       return FALSE;</span>
      }
      }
  
    return TRUE;
  }
  
<span class="line-new-header">--- 3025,271 ---</span>
        if (len)
          g_string_append_len (outstr, utf8_format, len);
  
        utf8_format += len;
        if (!*utf8_format)
<span class="line-modified">!   break;</span>
  
        g_assert (*utf8_format == &#39;%&#39;);
        utf8_format++;
        if (!*utf8_format)
<span class="line-modified">!   break;</span>
  
        colons = 0;
        alt_digits = FALSE;
        pad_set = FALSE;
  
      next_mod:
        c = g_utf8_get_char (utf8_format);
        utf8_format = g_utf8_next_char (utf8_format);
        switch (c)
<span class="line-modified">!   {</span>
<span class="line-modified">!   case &#39;a&#39;:</span>
<span class="line-modified">!     name = WEEKDAY_ABBR (datetime);</span>
            if (g_strcmp0 (name, &quot;&quot;) == 0)
              return FALSE;
  
            name_is_utf8 = locale_is_utf8 || !WEEKDAY_ABBR_IS_LOCALE;
  
            if (!string_append (outstr, name, name_is_utf8))
              return FALSE;
  
<span class="line-modified">!     break;</span>
<span class="line-modified">!   case &#39;A&#39;:</span>
<span class="line-modified">!     name = WEEKDAY_FULL (datetime);</span>
            if (g_strcmp0 (name, &quot;&quot;) == 0)
              return FALSE;
  
            name_is_utf8 = locale_is_utf8 || !WEEKDAY_FULL_IS_LOCALE;
  
            if (!string_append (outstr, name, name_is_utf8))
              return FALSE;
  
<span class="line-modified">!     break;</span>
<span class="line-modified">!   case &#39;b&#39;:</span>
<span class="line-modified">!     name = alt_digits ? MONTH_ABBR_STANDALONE (datetime)</span>
<span class="line-modified">!           : MONTH_ABBR_WITH_DAY (datetime);</span>
            if (g_strcmp0 (name, &quot;&quot;) == 0)
              return FALSE;
  
            name_is_utf8 = locale_is_utf8 ||
              ((alt_digits &amp;&amp; !MONTH_ABBR_STANDALONE_IS_LOCALE) ||
               (!alt_digits &amp;&amp; !MONTH_ABBR_WITH_DAY_IS_LOCALE));
  
            if (!string_append (outstr, name, name_is_utf8))
              return FALSE;
  
<span class="line-modified">!     break;</span>
<span class="line-modified">!   case &#39;B&#39;:</span>
<span class="line-modified">!     name = alt_digits ? MONTH_FULL_STANDALONE (datetime)</span>
<span class="line-modified">!           : MONTH_FULL_WITH_DAY (datetime);</span>
            if (g_strcmp0 (name, &quot;&quot;) == 0)
              return FALSE;
  
            name_is_utf8 = locale_is_utf8 ||
              ((alt_digits &amp;&amp; !MONTH_FULL_STANDALONE_IS_LOCALE) ||
               (!alt_digits &amp;&amp; !MONTH_FULL_WITH_DAY_IS_LOCALE));
  
            if (!string_append (outstr, name, name_is_utf8))
                return FALSE;
  
<span class="line-modified">!     break;</span>
<span class="line-modified">!   case &#39;c&#39;:</span>
<span class="line-modified">!     {</span>
              if (g_strcmp0 (PREFERRED_DATE_TIME_FMT, &quot;&quot;) == 0)
                return FALSE;
              if (!g_date_time_format_locale (datetime, PREFERRED_DATE_TIME_FMT,
                                              outstr, locale_is_utf8))
                return FALSE;
<span class="line-modified">!     }</span>
<span class="line-modified">!     break;</span>
<span class="line-modified">!   case &#39;C&#39;:</span>
<span class="line-modified">!     format_number (outstr, alt_digits, pad_set ? pad : &quot;0&quot;, 2,</span>
<span class="line-modified">!        g_date_time_get_year (datetime) / 100);</span>
<span class="line-modified">!     break;</span>
<span class="line-modified">!   case &#39;d&#39;:</span>
<span class="line-modified">!     format_number (outstr, alt_digits, pad_set ? pad : &quot;0&quot;, 2,</span>
<span class="line-modified">!        g_date_time_get_day_of_month (datetime));</span>
<span class="line-modified">!     break;</span>
<span class="line-modified">!   case &#39;e&#39;:</span>
<span class="line-modified">!     format_number (outstr, alt_digits, pad_set ? pad : &quot; &quot;, 2,</span>
<span class="line-modified">!        g_date_time_get_day_of_month (datetime));</span>
<span class="line-modified">!     break;</span>
<span class="line-modified">!   case &#39;F&#39;:</span>
<span class="line-modified">!     g_string_append_printf (outstr, &quot;%d-%02d-%02d&quot;,</span>
<span class="line-modified">!           g_date_time_get_year (datetime),</span>
<span class="line-modified">!           g_date_time_get_month (datetime),</span>
<span class="line-modified">!           g_date_time_get_day_of_month (datetime));</span>
<span class="line-modified">!     break;</span>
<span class="line-modified">!   case &#39;g&#39;:</span>
<span class="line-modified">!     format_number (outstr, alt_digits, pad_set ? pad : &quot;0&quot;, 2,</span>
<span class="line-modified">!        g_date_time_get_week_numbering_year (datetime) % 100);</span>
<span class="line-modified">!     break;</span>
<span class="line-modified">!   case &#39;G&#39;:</span>
<span class="line-modified">!     format_number (outstr, alt_digits, pad_set ? pad : 0, 0,</span>
<span class="line-modified">!        g_date_time_get_week_numbering_year (datetime));</span>
<span class="line-modified">!     break;</span>
<span class="line-modified">!   case &#39;h&#39;:</span>
<span class="line-modified">!     name = alt_digits ? MONTH_ABBR_STANDALONE (datetime)</span>
<span class="line-modified">!           : MONTH_ABBR_WITH_DAY (datetime);</span>
            if (g_strcmp0 (name, &quot;&quot;) == 0)
              return FALSE;
  
            name_is_utf8 = locale_is_utf8 ||
              ((alt_digits &amp;&amp; !MONTH_ABBR_STANDALONE_IS_LOCALE) ||
               (!alt_digits &amp;&amp; !MONTH_ABBR_WITH_DAY_IS_LOCALE));
  
            if (!string_append (outstr, name, name_is_utf8))
              return FALSE;
  
<span class="line-modified">!     break;</span>
<span class="line-modified">!   case &#39;H&#39;:</span>
<span class="line-modified">!     format_number (outstr, alt_digits, pad_set ? pad : &quot;0&quot;, 2,</span>
<span class="line-modified">!        g_date_time_get_hour (datetime));</span>
<span class="line-modified">!     break;</span>
<span class="line-modified">!   case &#39;I&#39;:</span>
<span class="line-modified">!     format_number (outstr, alt_digits, pad_set ? pad : &quot;0&quot;, 2,</span>
<span class="line-modified">!        (g_date_time_get_hour (datetime) + 11) % 12 + 1);</span>
<span class="line-modified">!     break;</span>
<span class="line-modified">!   case &#39;j&#39;:</span>
<span class="line-modified">!     format_number (outstr, alt_digits, pad_set ? pad : &quot;0&quot;, 3,</span>
<span class="line-modified">!        g_date_time_get_day_of_year (datetime));</span>
<span class="line-modified">!     break;</span>
<span class="line-modified">!   case &#39;k&#39;:</span>
<span class="line-modified">!     format_number (outstr, alt_digits, pad_set ? pad : &quot; &quot;, 2,</span>
<span class="line-modified">!        g_date_time_get_hour (datetime));</span>
<span class="line-modified">!     break;</span>
<span class="line-modified">!   case &#39;l&#39;:</span>
<span class="line-modified">!     format_number (outstr, alt_digits, pad_set ? pad : &quot; &quot;, 2,</span>
<span class="line-modified">!        (g_date_time_get_hour (datetime) + 11) % 12 + 1);</span>
<span class="line-modified">!     break;</span>
<span class="line-modified">!   case &#39;n&#39;:</span>
<span class="line-modified">!     g_string_append_c (outstr, &#39;\n&#39;);</span>
<span class="line-modified">!     break;</span>
<span class="line-modified">!   case &#39;m&#39;:</span>
<span class="line-modified">!     format_number (outstr, alt_digits, pad_set ? pad : &quot;0&quot;, 2,</span>
<span class="line-modified">!        g_date_time_get_month (datetime));</span>
<span class="line-modified">!     break;</span>
<span class="line-modified">!   case &#39;M&#39;:</span>
<span class="line-modified">!     format_number (outstr, alt_digits, pad_set ? pad : &quot;0&quot;, 2,</span>
<span class="line-modified">!        g_date_time_get_minute (datetime));</span>
<span class="line-modified">!     break;</span>
<span class="line-modified">!   case &#39;O&#39;:</span>
<span class="line-modified">!     alt_digits = TRUE;</span>
<span class="line-modified">!     goto next_mod;</span>
<span class="line-modified">!   case &#39;p&#39;:</span>
            if (!format_ampm (datetime, outstr, locale_is_utf8, TRUE))
              return FALSE;
            break;
<span class="line-modified">!   case &#39;P&#39;:</span>
            if (!format_ampm (datetime, outstr, locale_is_utf8, FALSE))
              return FALSE;
<span class="line-modified">!     break;</span>
<span class="line-modified">!   case &#39;r&#39;:</span>
<span class="line-modified">!     {</span>
              if (g_strcmp0 (PREFERRED_12HR_TIME_FMT, &quot;&quot;) == 0)
                return FALSE;
<span class="line-modified">!       if (!g_date_time_format_locale (datetime, PREFERRED_12HR_TIME_FMT,</span>
<span class="line-modified">!               outstr, locale_is_utf8))</span>
<span class="line-modified">!         return FALSE;</span>
<span class="line-modified">!     }</span>
<span class="line-modified">!     break;</span>
<span class="line-modified">!   case &#39;R&#39;:</span>
<span class="line-modified">!     g_string_append_printf (outstr, &quot;%02d:%02d&quot;,</span>
<span class="line-modified">!           g_date_time_get_hour (datetime),</span>
<span class="line-modified">!           g_date_time_get_minute (datetime));</span>
<span class="line-modified">!     break;</span>
<span class="line-modified">!   case &#39;s&#39;:</span>
<span class="line-modified">!     g_string_append_printf (outstr, &quot;%&quot; G_GINT64_FORMAT, g_date_time_to_unix (datetime));</span>
<span class="line-modified">!     break;</span>
<span class="line-modified">!   case &#39;S&#39;:</span>
<span class="line-modified">!     format_number (outstr, alt_digits, pad_set ? pad : &quot;0&quot;, 2,</span>
<span class="line-modified">!        g_date_time_get_second (datetime));</span>
<span class="line-modified">!     break;</span>
<span class="line-modified">!   case &#39;t&#39;:</span>
<span class="line-modified">!     g_string_append_c (outstr, &#39;\t&#39;);</span>
<span class="line-modified">!     break;</span>
<span class="line-modified">!   case &#39;T&#39;:</span>
<span class="line-modified">!     g_string_append_printf (outstr, &quot;%02d:%02d:%02d&quot;,</span>
<span class="line-modified">!           g_date_time_get_hour (datetime),</span>
<span class="line-modified">!           g_date_time_get_minute (datetime),</span>
<span class="line-modified">!           g_date_time_get_second (datetime));</span>
<span class="line-modified">!     break;</span>
<span class="line-modified">!   case &#39;u&#39;:</span>
<span class="line-modified">!     format_number (outstr, alt_digits, 0, 0,</span>
<span class="line-modified">!        g_date_time_get_day_of_week (datetime));</span>
<span class="line-modified">!     break;</span>
<span class="line-modified">!   case &#39;V&#39;:</span>
<span class="line-modified">!     format_number (outstr, alt_digits, pad_set ? pad : &quot;0&quot;, 2,</span>
<span class="line-modified">!        g_date_time_get_week_of_year (datetime));</span>
<span class="line-modified">!     break;</span>
<span class="line-modified">!   case &#39;w&#39;:</span>
<span class="line-modified">!     format_number (outstr, alt_digits, 0, 0,</span>
<span class="line-modified">!        g_date_time_get_day_of_week (datetime) % 7);</span>
<span class="line-modified">!     break;</span>
<span class="line-modified">!   case &#39;x&#39;:</span>
<span class="line-modified">!     {</span>
              if (g_strcmp0 (PREFERRED_DATE_FMT, &quot;&quot;) == 0)
                return FALSE;
<span class="line-modified">!       if (!g_date_time_format_locale (datetime, PREFERRED_DATE_FMT,</span>
<span class="line-modified">!               outstr, locale_is_utf8))</span>
<span class="line-modified">!         return FALSE;</span>
<span class="line-modified">!     }</span>
<span class="line-modified">!     break;</span>
<span class="line-modified">!   case &#39;X&#39;:</span>
<span class="line-modified">!     {</span>
              if (g_strcmp0 (PREFERRED_TIME_FMT, &quot;&quot;) == 0)
                return FALSE;
<span class="line-modified">!       if (!g_date_time_format_locale (datetime, PREFERRED_TIME_FMT,</span>
<span class="line-modified">!               outstr, locale_is_utf8))</span>
          return FALSE;
      }
<span class="line-added">+     break;</span>
<span class="line-added">+   case &#39;y&#39;:</span>
<span class="line-added">+     format_number (outstr, alt_digits, pad_set ? pad : &quot;0&quot;, 2,</span>
<span class="line-added">+        g_date_time_get_year (datetime) % 100);</span>
<span class="line-added">+     break;</span>
<span class="line-added">+   case &#39;Y&#39;:</span>
<span class="line-added">+     format_number (outstr, alt_digits, 0, 0,</span>
<span class="line-added">+        g_date_time_get_year (datetime));</span>
<span class="line-added">+     break;</span>
<span class="line-added">+   case &#39;z&#39;:</span>
<span class="line-added">+     {</span>
<span class="line-added">+       gint64 offset;</span>
<span class="line-added">+       offset = g_date_time_get_utc_offset (datetime) / USEC_PER_SECOND;</span>
<span class="line-added">+       if (!format_z (outstr, (int) offset, colons))</span>
<span class="line-added">+         return FALSE;</span>
<span class="line-added">+     }</span>
<span class="line-added">+     break;</span>
<span class="line-added">+   case &#39;Z&#39;:</span>
<span class="line-added">+     tz = g_date_time_get_timezone_abbreviation (datetime);</span>
<span class="line-added">+           g_string_append (outstr, tz);</span>
<span class="line-added">+     break;</span>
<span class="line-added">+   case &#39;%&#39;:</span>
<span class="line-added">+     g_string_append_c (outstr, &#39;%&#39;);</span>
<span class="line-added">+     break;</span>
<span class="line-added">+   case &#39;-&#39;:</span>
<span class="line-added">+     pad_set = TRUE;</span>
<span class="line-added">+     pad = &quot;&quot;;</span>
<span class="line-added">+     goto next_mod;</span>
<span class="line-added">+   case &#39;_&#39;:</span>
<span class="line-added">+     pad_set = TRUE;</span>
<span class="line-added">+     pad = &quot; &quot;;</span>
<span class="line-added">+     goto next_mod;</span>
<span class="line-added">+   case &#39;0&#39;:</span>
<span class="line-added">+     pad_set = TRUE;</span>
<span class="line-added">+     pad = &quot;0&quot;;</span>
<span class="line-added">+     goto next_mod;</span>
<span class="line-added">+   case &#39;:&#39;:</span>
<span class="line-added">+     /* Colons are only allowed before &#39;z&#39; */</span>
<span class="line-added">+     if (*utf8_format &amp;&amp; *utf8_format != &#39;z&#39; &amp;&amp; *utf8_format != &#39;:&#39;)</span>
<span class="line-added">+       return FALSE;</span>
<span class="line-added">+     colons++;</span>
<span class="line-added">+     goto next_mod;</span>
<span class="line-added">+   default:</span>
<span class="line-added">+     return FALSE;</span>
<span class="line-added">+   }</span>
      }
  
    return TRUE;
  }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3392,11 ***</span>
      {
        g_string_free (outstr, TRUE);
        return NULL;
      }
  
<span class="line-modified">!     return g_string_free (outstr, FALSE);</span>
  }
  
  
  /* Epilogue {{{1 */
  /* vim:set foldmethod=marker: */
<span class="line-new-header">--- 3425,54 ---</span>
      {
        g_string_free (outstr, TRUE);
        return NULL;
      }
  
<span class="line-modified">!   return g_string_free (outstr, FALSE);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ /**</span>
<span class="line-added">+  * g_date_time_format_iso8601:</span>
<span class="line-added">+  * @datetime: A #GDateTime</span>
<span class="line-added">+  *</span>
<span class="line-added">+  * Format @datetime in [ISO 8601 format](https://en.wikipedia.org/wiki/ISO_8601),</span>
<span class="line-added">+  * including the date, time and time zone, and return that as a UTF-8 encoded</span>
<span class="line-added">+  * string.</span>
<span class="line-added">+  *</span>
<span class="line-added">+  * Returns: a newly allocated string formatted in ISO 8601 format</span>
<span class="line-added">+  *     or %NULL in the case that there was an error. The string</span>
<span class="line-added">+  *     should be freed with g_free().</span>
<span class="line-added">+  * Since: 2.62</span>
<span class="line-added">+  */</span>
<span class="line-added">+ gchar *</span>
<span class="line-added">+ g_date_time_format_iso8601 (GDateTime *datetime)</span>
<span class="line-added">+ {</span>
<span class="line-added">+   GString *outstr = NULL;</span>
<span class="line-added">+   gchar *main_date = NULL;</span>
<span class="line-added">+   gint64 offset;</span>
<span class="line-added">+ </span>
<span class="line-added">+   /* Main date and time. */</span>
<span class="line-added">+   main_date = g_date_time_format (datetime, &quot;%Y-%m-%dT%H:%M:%S&quot;);</span>
<span class="line-added">+   outstr = g_string_new (main_date);</span>
<span class="line-added">+   g_free (main_date);</span>
<span class="line-added">+ </span>
<span class="line-added">+   /* Timezone. Format it as `%:::z` unless the offset is zero, in which case</span>
<span class="line-added">+    * we can simply use `Z`. */</span>
<span class="line-added">+   offset = g_date_time_get_utc_offset (datetime);</span>
<span class="line-added">+ </span>
<span class="line-added">+   if (offset == 0)</span>
<span class="line-added">+     {</span>
<span class="line-added">+       g_string_append_c (outstr, &#39;Z&#39;);</span>
<span class="line-added">+     }</span>
<span class="line-added">+   else</span>
<span class="line-added">+     {</span>
<span class="line-added">+       gchar *time_zone = g_date_time_format (datetime, &quot;%:::z&quot;);</span>
<span class="line-added">+       g_string_append (outstr, time_zone);</span>
<span class="line-added">+       g_free (time_zone);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+   return g_string_free (outstr, FALSE);</span>
  }
  
  
  /* Epilogue {{{1 */
  /* vim:set foldmethod=marker: */
</pre>
<center><a href="gdate.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="gdatetime.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>