<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.media/src/main/native/gstreamer/3rd_party/glib/glib/gtestutils.c</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="gstring.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="gtestutils.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.media/src/main/native/gstreamer/3rd_party/glib/glib/gtestutils.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -25,11 +25,10 @@</span>
  #ifdef G_OS_UNIX
  #include &lt;sys/wait.h&gt;
  #include &lt;sys/time.h&gt;
  #include &lt;fcntl.h&gt;
  #include &lt;unistd.h&gt;
<span class="udiff-line-removed">- #include &lt;glib/gstdio.h&gt;</span>
  #endif
  #include &lt;string.h&gt;
  #include &lt;stdlib.h&gt;
  #include &lt;stdio.h&gt;
  #ifdef HAVE_SYS_RESOURCE_H
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -42,26 +41,27 @@</span>
  #include &lt;errno.h&gt;
  #include &lt;signal.h&gt;
  #ifdef HAVE_SYS_SELECT_H
  #include &lt;sys/select.h&gt;
  #endif /* HAVE_SYS_SELECT_H */
<span class="udiff-line-added">+ #include &lt;glib/gstdio.h&gt;</span>
  
  #include &quot;gmain.h&quot;
  #include &quot;gpattern.h&quot;
  #include &quot;grand.h&quot;
  #include &quot;gstrfuncs.h&quot;
  #include &quot;gtimer.h&quot;
  #include &quot;gslice.h&quot;
  #include &quot;gspawn.h&quot;
  #include &quot;glib-private.h&quot;
<span class="udiff-line-added">+ #include &quot;gutilsprivate.h&quot;</span>
  
  
  /**
   * SECTION:testing
   * @title: Testing
   * @short_description: a test framework
<span class="udiff-line-removed">-  * @see_also: [gtester][gtester], [gtester-report][gtester-report]</span>
   *
   * GLib provides a framework for writing and maintaining unit tests
   * in parallel to the code they are testing. The API is designed according
   * to established concepts found in the other test frameworks (JUnit, NUnit,
   * RUnit), which in turn is based on smalltalk unit testing concepts.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -88,11 +88,12 @@</span>
   * &quot;assertions&quot;, which consists of running the test_assertions function.
   *
   * In addition to the traditional g_assert_true(), the test framework provides
   * an extended set of assertions for comparisons: g_assert_cmpfloat(),
   * g_assert_cmpfloat_with_epsilon(), g_assert_cmpint(), g_assert_cmpuint(),
<span class="udiff-line-modified-removed">-  * g_assert_cmphex(), g_assert_cmpstr(), and g_assert_cmpmem(). The</span>
<span class="udiff-line-modified-added">+  * g_assert_cmphex(), g_assert_cmpstr(), g_assert_cmpmem() and</span>
<span class="udiff-line-added">+  * g_assert_cmpvariant(). The</span>
   * advantage of these variants over plain g_assert_true() is that the assertion
   * messages can be more elaborate, and include the values of the compared
   * entities.
   *
   * Note that g_assert() should not be used in unit tests, since it is a no-op
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -147,11 +148,10 @@</span>
   * main (int argc, char *argv[])
   * {
   *   setlocale (LC_ALL, &quot;&quot;);
   *
   *   g_test_init (&amp;argc, &amp;argv, NULL);
<span class="udiff-line-removed">-  *   g_test_bug_base (&quot;http://bugzilla.gnome.org/show_bug.cgi?id=&quot;);</span>
   *
   *   // Define the tests.
   *   g_test_add (&quot;/my-object/test1&quot;, MyObjectFixture, &quot;some-user-data&quot;,
   *               my_object_fixture_set_up, test_my_object_test1,
   *               my_object_fixture_tear_down);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -191,13 +191,13 @@</span>
   *
   * If you are using Autotools, you&#39;re strongly encouraged to use the Automake
   * [TAP](https://testanything.org/) harness; GLib provides template files for
   * easily integrating with it:
   *
<span class="udiff-line-modified-removed">-  *   - [glib-tap.mk](https://git.gnome.org/browse/glib/tree/glib-tap.mk)</span>
<span class="udiff-line-modified-removed">-  *   - [tap-test](https://git.gnome.org/browse/glib/tree/tap-test)</span>
<span class="udiff-line-modified-removed">-  *   - [tap-driver.sh](https://git.gnome.org/browse/glib/tree/tap-driver.sh)</span>
<span class="udiff-line-modified-added">+  *   - [glib-tap.mk](https://gitlab.gnome.org/GNOME/glib/blob/glib-2-58/glib-tap.mk)</span>
<span class="udiff-line-modified-added">+  *   - [tap-test](https://gitlab.gnome.org/GNOME/glib/blob/glib-2-58/tap-test)</span>
<span class="udiff-line-modified-added">+  *   - [tap-driver.sh](https://gitlab.gnome.org/GNOME/glib/blob/glib-2-58/tap-driver.sh)</span>
   *
   * You can copy these files in your own project&#39;s root directory, and then
   * set up your `Makefile.am` file to reference them, for instance:
   *
   * |[&lt;!-- language=&quot;plain&quot; --&gt;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -230,12 +230,15 @@</span>
   * `glib-tap.mk` will be distributed implicitly due to being included in a
   * `Makefile.am`. All three files should be added to version control.
   *
   * If you don&#39;t have access to the Autotools TAP harness, you can use the
   * [gtester][gtester] and [gtester-report][gtester-report] tools, and use
<span class="udiff-line-modified-removed">-  * the [glib.mk](https://git.gnome.org/browse/glib/tree/glib.mk) Automake</span>
<span class="udiff-line-modified-removed">-  * template provided by GLib.</span>
<span class="udiff-line-modified-added">+  * the [glib.mk](https://gitlab.gnome.org/GNOME/glib/blob/glib-2-58/glib.mk)</span>
<span class="udiff-line-modified-added">+  * Automake template provided by GLib. Note, however, that since GLib 2.62,</span>
<span class="udiff-line-added">+  * [gtester][gtester] and [gtester-report][gtester-report] have been deprecated</span>
<span class="udiff-line-added">+  * in favour of using TAP. The `--tap` argument to tests is enabled by default</span>
<span class="udiff-line-added">+  * as of GLib 2.62.</span>
   */
  
  /**
   * g_test_initialized:
   *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -343,32 +346,10 @@</span>
   * g_test_queue_destroy() with a destroy callback of g_object_unref().
   *
   * Since: 2.16
   */
  
<span class="udiff-line-removed">- /**</span>
<span class="udiff-line-removed">-  * GTestTrapFlags:</span>
<span class="udiff-line-removed">-  * @G_TEST_TRAP_SILENCE_STDOUT: Redirect stdout of the test child to</span>
<span class="udiff-line-removed">-  *     `/dev/null` so it cannot be observed on the console during test</span>
<span class="udiff-line-removed">-  *     runs. The actual output is still captured though to allow later</span>
<span class="udiff-line-removed">-  *     tests with g_test_trap_assert_stdout().</span>
<span class="udiff-line-removed">-  * @G_TEST_TRAP_SILENCE_STDERR: Redirect stderr of the test child to</span>
<span class="udiff-line-removed">-  *     `/dev/null` so it cannot be observed on the console during test</span>
<span class="udiff-line-removed">-  *     runs. The actual output is still captured though to allow later</span>
<span class="udiff-line-removed">-  *     tests with g_test_trap_assert_stderr().</span>
<span class="udiff-line-removed">-  * @G_TEST_TRAP_INHERIT_STDIN: If this flag is given, stdin of the</span>
<span class="udiff-line-removed">-  *     child process is shared with stdin of its parent process.</span>
<span class="udiff-line-removed">-  *     It is redirected to `/dev/null` otherwise.</span>
<span class="udiff-line-removed">-  *</span>
<span class="udiff-line-removed">-  * Test traps are guards around forked tests.</span>
<span class="udiff-line-removed">-  * These flags determine what traps to set.</span>
<span class="udiff-line-removed">-  *</span>
<span class="udiff-line-removed">-  * Deprecated: #GTestTrapFlags is used only with g_test_trap_fork(),</span>
<span class="udiff-line-removed">-  * which is deprecated. g_test_trap_subprocess() uses</span>
<span class="udiff-line-removed">-  * #GTestSubprocessFlags.</span>
<span class="udiff-line-removed">-  */</span>
<span class="udiff-line-removed">- </span>
  /**
   * GTestSubprocessFlags:
   * @G_TEST_SUBPROCESS_INHERIT_STDIN: If this flag is given, the child
   *     process will inherit the parent&#39;s stdin. Otherwise, the child&#39;s
   *     stdin is redirected to `/dev/null`.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -573,11 +554,11 @@</span>
  
  /**
   * g_assert_cmpstr:
   * @s1: a string (may be %NULL)
   * @cmp: The comparison operator to use.
<span class="udiff-line-modified-removed">-  *     One of ==, !=, &lt;, &gt;, &lt;=, &gt;=.</span>
<span class="udiff-line-modified-added">+  *     One of `==`, `!=`, `&lt;`, `&gt;`, `&lt;=`, `&gt;=`.</span>
   * @s2: another string (may be %NULL)
   *
   * Debugging macro to compare two strings. If the comparison fails,
   * an error message is logged and the application is either terminated
   * or the testcase marked as failed.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -597,11 +578,11 @@</span>
  
  /**
   * g_assert_cmpint:
   * @n1: an integer
   * @cmp: The comparison operator to use.
<span class="udiff-line-modified-removed">-  *     One of ==, !=, &lt;, &gt;, &lt;=, &gt;=.</span>
<span class="udiff-line-modified-added">+  *     One of `==`, `!=`, `&lt;`, `&gt;`, `&lt;=`, `&gt;=`.</span>
   * @n2: another integer
   *
   * Debugging macro to compare two integers.
   *
   * The effect of `g_assert_cmpint (n1, op, n2)` is
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -614,11 +595,11 @@</span>
  
  /**
   * g_assert_cmpuint:
   * @n1: an unsigned integer
   * @cmp: The comparison operator to use.
<span class="udiff-line-modified-removed">-  *     One of ==, !=, &lt;, &gt;, &lt;=, &gt;=.</span>
<span class="udiff-line-modified-added">+  *     One of `==`, `!=`, `&lt;`, `&gt;`, `&lt;=`, `&gt;=`.</span>
   * @n2: another unsigned integer
   *
   * Debugging macro to compare two unsigned integers.
   *
   * The effect of `g_assert_cmpuint (n1, op, n2)` is
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -631,11 +612,11 @@</span>
  
  /**
   * g_assert_cmphex:
   * @n1: an unsigned integer
   * @cmp: The comparison operator to use.
<span class="udiff-line-modified-removed">-  *     One of ==, !=, &lt;, &gt;, &lt;=, &gt;=.</span>
<span class="udiff-line-modified-added">+  *     One of `==`, `!=`, `&lt;`, `&gt;`, `&lt;=`, `&gt;=`.</span>
   * @n2: another unsigned integer
   *
   * Debugging macro to compare to unsigned integers.
   *
   * This is a variant of g_assert_cmpuint() that displays the numbers
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -644,13 +625,13 @@</span>
   * Since: 2.16
   */
  
  /**
   * g_assert_cmpfloat:
<span class="udiff-line-modified-removed">-  * @n1: an floating point number</span>
<span class="udiff-line-modified-added">+  * @n1: a floating point number</span>
   * @cmp: The comparison operator to use.
<span class="udiff-line-modified-removed">-  *     One of ==, !=, &lt;, &gt;, &lt;=, &gt;=.</span>
<span class="udiff-line-modified-added">+  *     One of `==`, `!=`, `&lt;`, `&gt;`, `&lt;=`, `&gt;=`.</span>
   * @n2: another floating point number
   *
   * Debugging macro to compare two floating point numbers.
   *
   * The effect of `g_assert_cmpfloat (n1, op, n2)` is
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -661,11 +642,11 @@</span>
   * Since: 2.16
   */
  
  /**
   * g_assert_cmpfloat_with_epsilon:
<span class="udiff-line-modified-removed">-  * @n1: an floating point number</span>
<span class="udiff-line-modified-added">+  * @n1: a floating point number</span>
   * @n2: another floating point number
   * @epsilon: a numeric value that expresses the expected tolerance
   *   between @n1 and @n2
   *
   * Debugging macro to compare two floating point numbers within an epsilon.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -699,10 +680,27 @@</span>
   * ]|
   *
   * Since: 2.46
   */
  
<span class="udiff-line-added">+ /**</span>
<span class="udiff-line-added">+  * g_assert_cmpvariant:</span>
<span class="udiff-line-added">+  * @v1: pointer to a #GVariant</span>
<span class="udiff-line-added">+  * @v2: pointer to another #GVariant</span>
<span class="udiff-line-added">+  *</span>
<span class="udiff-line-added">+  * Debugging macro to compare two #GVariants. If the comparison fails,</span>
<span class="udiff-line-added">+  * an error message is logged and the application is either terminated</span>
<span class="udiff-line-added">+  * or the testcase marked as failed. The variants are compared using</span>
<span class="udiff-line-added">+  * g_variant_equal().</span>
<span class="udiff-line-added">+  *</span>
<span class="udiff-line-added">+  * The effect of `g_assert_cmpvariant (v1, v2)` is the same as</span>
<span class="udiff-line-added">+  * `g_assert_true (g_variant_equal (v1, v2))`. The advantage of this macro is</span>
<span class="udiff-line-added">+  * that it can produce a message that includes the actual values of @v1 and @v2.</span>
<span class="udiff-line-added">+  *</span>
<span class="udiff-line-added">+  * Since: 2.60</span>
<span class="udiff-line-added">+  */</span>
<span class="udiff-line-added">+ </span>
  /**
   * g_assert_no_error:
   * @err: a #GError, possibly %NULL
   *
   * Debugging macro to check that a #GError is not set.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -730,11 +728,11 @@</span>
   * macro is that it can produce a message that includes the incorrect
   * error message and code.
   *
   * This can only be used to test for a specific error. If you want to
   * test that @err is set, but don&#39;t care what it&#39;s set to, just use
<span class="udiff-line-modified-removed">-  * `g_assert (err != NULL)`</span>
<span class="udiff-line-modified-added">+  * `g_assert_nonnull (err)`.</span>
   *
   * Since: 2.20
   */
  
  /**
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -805,12 +803,16 @@</span>
  
  /* --- variables --- */
  static int         test_log_fd = -1;
  static gboolean    test_mode_fatal = TRUE;
  static gboolean    g_test_run_once = TRUE;
<span class="udiff-line-added">+ static gboolean    test_isolate_dirs = FALSE;</span>
<span class="udiff-line-added">+ static gchar      *test_isolate_dirs_tmpdir = NULL;</span>
<span class="udiff-line-added">+ static const gchar *test_tmpdir = NULL;</span>
  static gboolean    test_run_list = FALSE;
  static gchar      *test_run_seedstr = NULL;
<span class="udiff-line-added">+ G_LOCK_DEFINE_STATIC (test_run_rand);</span>
  static GRand      *test_run_rand = NULL;
  static gchar      *test_run_name = &quot;&quot;;
  static GSList    **test_filename_free_list;
  static guint       test_run_forks = 0;
  static guint       test_run_count = 0;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -829,11 +831,11 @@</span>
  static char       *test_trap_last_subprocess = NULL;
  static char       *test_trap_last_stdout = NULL;
  static char       *test_trap_last_stderr = NULL;
  static char       *test_uri_base = NULL;
  static gboolean    test_debug_log = FALSE;
<span class="udiff-line-modified-removed">- static gboolean    test_tap_log = FALSE;</span>
<span class="udiff-line-modified-added">+ static gboolean    test_tap_log = TRUE;  /* default to TAP as of GLib 2.62; see #1619; the non-TAP output mode is deprecated */</span>
  static gboolean    test_nonfatal_assertions = FALSE;
  static DestroyEntry *test_destroy_queue = NULL;
  static char       *test_argv0 = NULL;
  static char       *test_argv0_dirname;
  static const char *test_disted_files_dir;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -939,21 +941,28 @@</span>
          g_print (&quot;GTest: random seed: %s\n&quot;, string2);
        break;
      case G_TEST_LOG_START_SUITE:
        if (test_tap_log)
          {
<span class="udiff-line-added">+           /* We only print the TAP &quot;plan&quot; (1..n) ahead of time if we did</span>
<span class="udiff-line-added">+            * not use the -p option to select specific tests to be run. */</span>
            if (string1[0] != 0)
              g_print (&quot;# Start of %s tests\n&quot;, string1);
<span class="udiff-line-modified-removed">-           else</span>
<span class="udiff-line-modified-added">+           else if (test_paths == NULL)</span>
              g_print (&quot;1..%d\n&quot;, test_count);
          }
        break;
      case G_TEST_LOG_STOP_SUITE:
        if (test_tap_log)
          {
<span class="udiff-line-added">+           /* If we didn&#39;t print the TAP &quot;plan&quot; at the beginning because</span>
<span class="udiff-line-added">+            * we were using -p, we need to print how many tests we ran at</span>
<span class="udiff-line-added">+            * the end instead. */</span>
            if (string1[0] != 0)
              g_print (&quot;# End of %s tests\n&quot;, string1);
<span class="udiff-line-added">+           else if (test_paths != NULL)</span>
<span class="udiff-line-added">+             g_print (&quot;1..%d\n&quot;, test_run_count);</span>
          }
        break;
      case G_TEST_LOG_STOP_CASE:
        result = largs[0];
        fail = result == G_TEST_RUN_FAILURE;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -991,10 +1000,14 @@</span>
            g_abort ();
          }
        if (result == G_TEST_RUN_SKIPPED || result == G_TEST_RUN_INCOMPLETE)
          test_skipped_count++;
        break;
<span class="udiff-line-added">+     case G_TEST_LOG_SKIP_CASE:</span>
<span class="udiff-line-added">+       if (test_tap_log)</span>
<span class="udiff-line-added">+           g_print (&quot;ok %d %s # SKIP\n&quot;, test_run_count, string1);</span>
<span class="udiff-line-added">+       break;</span>
      case G_TEST_LOG_MIN_RESULT:
        if (test_tap_log)
          g_print (&quot;# min perf: %s\n&quot;, string1);
        else if (g_test_verbose ())
          g_print (&quot;(MINPERF:%s)\n&quot;, string1);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1094,10 +1107,13 @@</span>
              {
                argv[i++] = NULL;
                test_log_fd = g_ascii_strtoull (argv[i], NULL, 0);
              }
            argv[i] = NULL;
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+           /* Force non-TAP output when using gtester */</span>
<span class="udiff-line-added">+           test_tap_log = FALSE;</span>
          }
        else if (strcmp (&quot;--GTestSkipCount&quot;, argv[i]) == 0 || strncmp (&quot;--GTestSkipCount=&quot;, argv[i], 17) == 0)
          {
            gchar *equal = argv[i] + 16;
            if (*equal == &#39;=&#39;)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1121,10 +1137,14 @@</span>
              struct rlimit limit = { 0, 0 };
              (void) setrlimit (RLIMIT_CORE, &amp;limit);
            }
  #endif
            argv[i] = NULL;
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+           /* Force non-TAP output when spawning a subprocess, since people often</span>
<span class="udiff-line-added">+            * test the stdout/stderr of the subprocess strictly */</span>
<span class="udiff-line-added">+           test_tap_log = FALSE;</span>
          }
        else if (strcmp (&quot;-p&quot;, argv[i]) == 0 || strncmp (&quot;-p=&quot;, argv[i], 3) == 0)
          {
            gchar *equal = argv[i] + 2;
            if (*equal == &#39;=&#39;)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1228,10 +1248,15 @@</span>
                    &quot;  --verbose                      Run tests verbosely\n&quot;,
                    argv[0]);
            exit (0);
          }
      }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   /* We&#39;ve been prepending to test_paths, but its order matters, so</span>
<span class="udiff-line-added">+    * permute it */</span>
<span class="udiff-line-added">+   test_paths = g_slist_reverse (test_paths);</span>
<span class="udiff-line-added">+ </span>
    /* collapse argv */
    e = 1;
    for (i = 1; i &lt; argc; i++)
      if (argv[i])
        {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1240,19 +1265,143 @@</span>
            argv[i] = NULL;
        }
    *argc_p = e;
  }
  
<span class="udiff-line-added">+ /* A fairly naive `rm -rf` implementation to clean up after unit tests. */</span>
<span class="udiff-line-added">+ static void</span>
<span class="udiff-line-added">+ rm_rf (const gchar *path)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+   GDir *dir = NULL;</span>
<span class="udiff-line-added">+   const gchar *entry;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   dir = g_dir_open (path, 0, NULL);</span>
<span class="udiff-line-added">+   if (dir == NULL)</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       /* Assume it&#39;s a file. */</span>
<span class="udiff-line-added">+       g_remove (path);</span>
<span class="udiff-line-added">+       return;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   while ((entry = g_dir_read_name (dir)) != NULL)</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       gchar *sub_path = g_build_filename (path, entry, NULL);</span>
<span class="udiff-line-added">+       rm_rf (sub_path);</span>
<span class="udiff-line-added">+       g_free (sub_path);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   g_dir_close (dir);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   g_rmdir (path);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ /* Implement the %G_TEST_OPTION_ISOLATE_DIRS option, iff it&#39;s enabled. Create</span>
<span class="udiff-line-added">+  * a temporary directory for this unit test (disambiguated using @test_run_name)</span>
<span class="udiff-line-added">+  * and use g_set_user_dirs() to point various XDG directories into it, without</span>
<span class="udiff-line-added">+  * having to call setenv() in a process which potentially has threads running.</span>
<span class="udiff-line-added">+  *</span>
<span class="udiff-line-added">+  * Note that this is called for each unit test, and hence won&#39;t have taken</span>
<span class="udiff-line-added">+  * effect before g_test_run() is called in the unit test&#39;s main(). Hence</span>
<span class="udiff-line-added">+  * references to XDG variables in main() will not be using the temporary</span>
<span class="udiff-line-added">+  * directory. */</span>
<span class="udiff-line-added">+ static gboolean</span>
<span class="udiff-line-added">+ test_do_isolate_dirs (GError **error)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+   gchar *subdir = NULL;</span>
<span class="udiff-line-added">+   gchar *home_dir = NULL, *cache_dir = NULL, *config_dir = NULL;</span>
<span class="udiff-line-added">+   gchar *data_dir = NULL, *runtime_dir = NULL;</span>
<span class="udiff-line-added">+   gchar *config_dirs[3];</span>
<span class="udiff-line-added">+   gchar *data_dirs[3];</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   if (!test_isolate_dirs)</span>
<span class="udiff-line-added">+     return TRUE;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   /* The @test_run_name includes the test suites, so may be several directories</span>
<span class="udiff-line-added">+    * deep. Add a `.dirs` directory to contain all the paths we create, and</span>
<span class="udiff-line-added">+    * guarantee none of them clash with test paths below the current one - test</span>
<span class="udiff-line-added">+    * paths may not contain components starting with `.`. */</span>
<span class="udiff-line-added">+   subdir = g_build_filename (test_tmpdir, test_run_name, &quot;.dirs&quot;, NULL);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   /* We have to create the runtime directory (because it must be bound to</span>
<span class="udiff-line-added">+    * the session lifetime, which we consider to be the lifetime of the unit</span>
<span class="udiff-line-added">+    * test for testing purposes - see</span>
<span class="udiff-line-added">+    * https://standards.freedesktop.org/basedir-spec/basedir-spec-latest.html.</span>
<span class="udiff-line-added">+    * We don&#39;t need to create the other directories - the specification</span>
<span class="udiff-line-added">+    * requires that client code create them if they don&#39;t exist. Not creating</span>
<span class="udiff-line-added">+    * them automatically is a good test of clients&#39; adherence to the spec</span>
<span class="udiff-line-added">+    * and error handling of missing directories. */</span>
<span class="udiff-line-added">+   runtime_dir = g_build_filename (subdir, &quot;runtime&quot;, NULL);</span>
<span class="udiff-line-added">+   if (g_mkdir_with_parents (runtime_dir, 0700) != 0)</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       gint saved_errno = errno;</span>
<span class="udiff-line-added">+       g_set_error (error, G_FILE_ERROR, g_file_error_from_errno (saved_errno),</span>
<span class="udiff-line-added">+                    &quot;Failed to create XDG_RUNTIME_DIR &#39;%s&#39;: %s&quot;,</span>
<span class="udiff-line-added">+                   runtime_dir, g_strerror (saved_errno));</span>
<span class="udiff-line-added">+       g_free (runtime_dir);</span>
<span class="udiff-line-added">+       g_free (subdir);</span>
<span class="udiff-line-added">+       return FALSE;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   home_dir = g_build_filename (subdir, &quot;home&quot;, NULL);</span>
<span class="udiff-line-added">+   cache_dir = g_build_filename (subdir, &quot;cache&quot;, NULL);</span>
<span class="udiff-line-added">+   config_dir = g_build_filename (subdir, &quot;config&quot;, NULL);</span>
<span class="udiff-line-added">+   data_dir = g_build_filename (subdir, &quot;data&quot;, NULL);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   config_dirs[0] = g_build_filename (subdir, &quot;system-config1&quot;, NULL);</span>
<span class="udiff-line-added">+   config_dirs[1] = g_build_filename (subdir, &quot;system-config2&quot;, NULL);</span>
<span class="udiff-line-added">+   config_dirs[2] = NULL;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   data_dirs[0] = g_build_filename (subdir, &quot;system-data1&quot;, NULL);</span>
<span class="udiff-line-added">+   data_dirs[1] = g_build_filename (subdir, &quot;system-data2&quot;, NULL);</span>
<span class="udiff-line-added">+   data_dirs[2] = NULL;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   /* Remember to update the documentation for %G_TEST_OPTION_ISOLATE_DIRS if</span>
<span class="udiff-line-added">+    * this list changes. */</span>
<span class="udiff-line-added">+   g_set_user_dirs (&quot;HOME&quot;, home_dir,</span>
<span class="udiff-line-added">+                    &quot;XDG_CACHE_HOME&quot;, cache_dir,</span>
<span class="udiff-line-added">+                    &quot;XDG_CONFIG_DIRS&quot;, config_dirs,</span>
<span class="udiff-line-added">+                    &quot;XDG_CONFIG_HOME&quot;, config_dir,</span>
<span class="udiff-line-added">+                    &quot;XDG_DATA_DIRS&quot;, data_dirs,</span>
<span class="udiff-line-added">+                    &quot;XDG_DATA_HOME&quot;, data_dir,</span>
<span class="udiff-line-added">+                    &quot;XDG_RUNTIME_DIR&quot;, runtime_dir,</span>
<span class="udiff-line-added">+                    NULL);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   g_free (runtime_dir);</span>
<span class="udiff-line-added">+   g_free (data_dir);</span>
<span class="udiff-line-added">+   g_free (config_dir);</span>
<span class="udiff-line-added">+   g_free (cache_dir);</span>
<span class="udiff-line-added">+   g_free (home_dir);</span>
<span class="udiff-line-added">+   g_free (data_dirs[1]);</span>
<span class="udiff-line-added">+   g_free (data_dirs[0]);</span>
<span class="udiff-line-added">+   g_free (config_dirs[1]);</span>
<span class="udiff-line-added">+   g_free (config_dirs[0]);</span>
<span class="udiff-line-added">+   g_free (subdir);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   return TRUE;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ /* Clean up after test_do_isolate_dirs(). */</span>
<span class="udiff-line-added">+ static void</span>
<span class="udiff-line-added">+ test_rm_isolate_dirs (void)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+   gchar *subdir = NULL;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   if (!test_isolate_dirs)</span>
<span class="udiff-line-added">+     return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   subdir = g_build_filename (test_tmpdir, test_run_name, NULL);</span>
<span class="udiff-line-added">+   rm_rf (subdir);</span>
<span class="udiff-line-added">+   g_free (subdir);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  /**
   * g_test_init:
   * @argc: Address of the @argc parameter of the main() function.
   *        Changed if any arguments were handled.
   * @argv: Address of the @argv parameter of main().
   *        Any parameters understood by g_test_init() stripped before return.
<span class="udiff-line-modified-removed">-  * @...: %NULL-terminated list of special options. Currently the only</span>
<span class="udiff-line-removed">-  *       defined option is `&quot;no_g_set_prgname&quot;`, which</span>
<span class="udiff-line-removed">-  *       will cause g_test_init() to not call g_set_prgname().</span>
<span class="udiff-line-modified-added">+  * @...: %NULL-terminated list of special options, documented below.</span>
   *
   * Initialize the GLib testing framework, e.g. by seeding the
   * test random number generator, the name for g_get_prgname()
   * and parsing test related command line args.
   *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1282,10 +1431,18 @@</span>
   *
   *   `no-undefined`: Avoid tests for undefined behaviour
   *
   * - `--debug-log`: Debug test logging output.
   *
<span class="udiff-line-added">+  * Options which can be passed to @... are:</span>
<span class="udiff-line-added">+  *</span>
<span class="udiff-line-added">+  *  - `&quot;no_g_set_prgname&quot;`: Causes g_test_init() to not call g_set_prgname().</span>
<span class="udiff-line-added">+  *  - %G_TEST_OPTION_ISOLATE_DIRS: Creates a unique temporary directory for each</span>
<span class="udiff-line-added">+  *    unit test and uses g_set_user_dirs() to set XDG directories to point into</span>
<span class="udiff-line-added">+  *    that temporary directory for the duration of the unit test. See the</span>
<span class="udiff-line-added">+  *    documentation for %G_TEST_OPTION_ISOLATE_DIRS.</span>
<span class="udiff-line-added">+  *</span>
   * Since 2.58, if tests are compiled with `G_DISABLE_ASSERT` defined,
   * g_test_init() will print an error and exit. This is to prevent no-op tests
   * from being executed, as g_assert() is commonly (erroneously) used in unit
   * tests, and is a no-op when compiled with `G_DISABLE_ASSERT`. Ensure your
   * tests are compiled without `G_DISABLE_ASSERT` defined.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1314,10 +1471,12 @@</span>
    va_start (args, argv);
    while ((option = va_arg (args, char *)))
      {
        if (g_strcmp0 (option, &quot;no_g_set_prgname&quot;) == 0)
          no_g_set_prgname = TRUE;
<span class="udiff-line-added">+       else if (g_strcmp0 (option, G_TEST_OPTION_ISOLATE_DIRS) == 0)</span>
<span class="udiff-line-added">+         test_isolate_dirs = TRUE;</span>
      }
    va_end (args);
  
    /* setup random seed string */
    g_snprintf (seedstr, sizeof (seedstr), &quot;R02S%08x%08x%08x%08x&quot;, g_random_int(), g_random_int(), g_random_int(), g_random_int());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1327,20 +1486,79 @@</span>
    parse_args (argc, argv);
  
    if (!g_get_prgname() &amp;&amp; !no_g_set_prgname)
      g_set_prgname ((*argv)[0]);
  
<span class="udiff-line-modified-removed">-   /* sanity check */</span>
<span class="udiff-line-modified-removed">-   if (test_tap_log)</span>
<span class="udiff-line-modified-added">+   /* Set up the temporary directory for isolating the test. We have to do this</span>
<span class="udiff-line-modified-added">+    * early, as we want the return values from g_get_user_data_dir() (and</span>
<span class="udiff-line-added">+    * friends) to return subdirectories of the temporary directory throughout</span>
<span class="udiff-line-added">+    * the setup function, test, and teardown function, for each unit test.</span>
<span class="udiff-line-added">+    * See test_do_isolate_dirs().</span>
<span class="udiff-line-added">+    *</span>
<span class="udiff-line-added">+    * The directory is deleted at the bottom of g_test_run().</span>
<span class="udiff-line-added">+    *</span>
<span class="udiff-line-added">+    * Rather than setting the XDG_* environment variables we use a new</span>
<span class="udiff-line-added">+    * G_TEST_TMPDIR variable which gives the top-level temporary directory. This</span>
<span class="udiff-line-added">+    * allows test subprocesses to reuse the same temporary directory when</span>
<span class="udiff-line-added">+    * g_test_init() is called in them. */</span>
<span class="udiff-line-added">+   if (test_isolate_dirs)</span>
      {
<span class="udiff-line-modified-removed">-       if (test_paths || test_startup_skip_count)</span>
<span class="udiff-line-modified-added">+       if (g_getenv (&quot;G_TEST_TMPDIR&quot;) == NULL)</span>
          {
<span class="udiff-line-modified-removed">-           /* Not invoking every test (even if SKIPped) breaks the &quot;1..XX&quot; plan */</span>
<span class="udiff-line-modified-removed">-           g_printerr (&quot;%s: -p and --GTestSkipCount options are incompatible with --tap\n&quot;,</span>
<span class="udiff-line-modified-removed">-                       (*argv)[0]);</span>
<span class="udiff-line-modified-removed">-           exit (1);</span>
<span class="udiff-line-modified-added">+           gchar *test_prgname = NULL;</span>
<span class="udiff-line-modified-added">+           gchar *tmpl = NULL;</span>
<span class="udiff-line-modified-added">+           GError *local_error = NULL;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+           test_prgname = g_path_get_basename (g_get_prgname ());</span>
<span class="udiff-line-added">+           if (*test_prgname == &#39;\0&#39;)</span>
<span class="udiff-line-added">+             test_prgname = g_strdup (&quot;unknown&quot;);</span>
<span class="udiff-line-added">+           tmpl = g_strdup_printf (&quot;test_%s_XXXXXX&quot;, test_prgname);</span>
<span class="udiff-line-added">+           g_free (test_prgname);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+           test_isolate_dirs_tmpdir = g_dir_make_tmp (tmpl, &amp;local_error);</span>
<span class="udiff-line-added">+           if (local_error != NULL)</span>
<span class="udiff-line-added">+             {</span>
<span class="udiff-line-added">+               g_printerr (&quot;%s: Failed to create temporary directory: %s\n&quot;,</span>
<span class="udiff-line-added">+                           (*argv)[0], local_error-&gt;message);</span>
<span class="udiff-line-added">+               g_error_free (local_error);</span>
<span class="udiff-line-added">+               exit (1);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+           g_free (tmpl);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+           /* Propagate the temporary directory to subprocesses. */</span>
<span class="udiff-line-added">+           g_setenv (&quot;G_TEST_TMPDIR&quot;, test_isolate_dirs_tmpdir, TRUE);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+           /* And clear the traditional environment variables so subprocesses</span>
<span class="udiff-line-added">+            * spawned by the code under test can&#39;t trash anything. If a test</span>
<span class="udiff-line-added">+            * spawns a process, the test is responsible for propagating</span>
<span class="udiff-line-added">+            * appropriate environment variables.</span>
<span class="udiff-line-added">+            *</span>
<span class="udiff-line-added">+            * We assume that any in-process code will use g_get_user_data_dir()</span>
<span class="udiff-line-added">+            * and friends, rather than getenv() directly.</span>
<span class="udiff-line-added">+            *</span>
<span class="udiff-line-added">+            * We set them to &#39;/dev/null&#39; as that should fairly obviously not</span>
<span class="udiff-line-added">+            * accidentally work, and should be fairly greppable. */</span>
<span class="udiff-line-added">+             {</span>
<span class="udiff-line-added">+               const gchar *overridden_environment_variables[] =</span>
<span class="udiff-line-added">+                 {</span>
<span class="udiff-line-added">+                   &quot;HOME&quot;,</span>
<span class="udiff-line-added">+                   &quot;XDG_CACHE_HOME&quot;,</span>
<span class="udiff-line-added">+                   &quot;XDG_CONFIG_DIRS&quot;,</span>
<span class="udiff-line-added">+                   &quot;XDG_CONFIG_HOME&quot;,</span>
<span class="udiff-line-added">+                   &quot;XDG_DATA_DIRS&quot;,</span>
<span class="udiff-line-added">+                   &quot;XDG_DATA_HOME&quot;,</span>
<span class="udiff-line-added">+                   &quot;XDG_RUNTIME_DIR&quot;,</span>
<span class="udiff-line-added">+                 };</span>
<span class="udiff-line-added">+               gsize i;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+               for (i = 0; i &lt; G_N_ELEMENTS (overridden_environment_variables); i++)</span>
<span class="udiff-line-added">+                 g_setenv (overridden_environment_variables[i], &quot;/dev/null&quot;, TRUE);</span>
<span class="udiff-line-added">+             }</span>
          }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       /* Cache this for the remainder of this process&#39; lifetime. */</span>
<span class="udiff-line-added">+       test_tmpdir = g_getenv (&quot;G_TEST_TMPDIR&quot;);</span>
      }
  
    /* verify GRand reliability, needed for reliable seeds */
    if (1)
      {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1435,11 +1653,17 @@</span>
   * Since: 2.16
   */
  gint32
  g_test_rand_int (void)
  {
<span class="udiff-line-modified-removed">-   return g_rand_int (test_run_rand);</span>
<span class="udiff-line-modified-added">+   gint32 r;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   G_LOCK (test_run_rand);</span>
<span class="udiff-line-added">+   r = g_rand_int (test_run_rand);</span>
<span class="udiff-line-added">+   G_UNLOCK (test_run_rand);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   return r;</span>
  }
  
  /**
   * g_test_rand_int_range:
   * @begin: the minimum value returned by this function
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1454,11 +1678,17 @@</span>
   */
  gint32
  g_test_rand_int_range (gint32          begin,
                         gint32          end)
  {
<span class="udiff-line-modified-removed">-   return g_rand_int_range (test_run_rand, begin, end);</span>
<span class="udiff-line-modified-added">+   gint32 r;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   G_LOCK (test_run_rand);</span>
<span class="udiff-line-added">+   r = g_rand_int_range (test_run_rand, begin, end);</span>
<span class="udiff-line-added">+   G_UNLOCK (test_run_rand);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   return r;</span>
  }
  
  /**
   * g_test_rand_double:
   *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1470,11 +1700,17 @@</span>
   * Since: 2.16
   */
  double
  g_test_rand_double (void)
  {
<span class="udiff-line-modified-removed">-   return g_rand_double (test_run_rand);</span>
<span class="udiff-line-modified-added">+   double r;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   G_LOCK (test_run_rand);</span>
<span class="udiff-line-added">+   r = g_rand_double (test_run_rand);</span>
<span class="udiff-line-added">+   G_UNLOCK (test_run_rand);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   return r;</span>
  }
  
  /**
   * g_test_rand_double_range:
   * @range_start: the minimum value returned by this function
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1489,11 +1725,17 @@</span>
   */
  double
  g_test_rand_double_range (double          range_start,
                            double          range_end)
  {
<span class="udiff-line-modified-removed">-   return g_rand_double_range (test_run_rand, range_start, range_end);</span>
<span class="udiff-line-modified-added">+   double r;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   G_LOCK (test_run_rand);</span>
<span class="udiff-line-added">+   r = g_rand_double_range (test_run_rand, range_start, range_end);</span>
<span class="udiff-line-added">+   G_UNLOCK (test_run_rand);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   return r;</span>
  }
  
  /**
   * g_test_timer_start:
   *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1642,10 +1884,13 @@</span>
   * case only.
   * Bug URIs are constructed by appending a bug specific URI
   * portion to @uri_pattern, or by replacing the special string
   * &#39;\%s&#39; within @uri_pattern if that is present.
   *
<span class="udiff-line-added">+  * If g_test_bug_base() is not called, bug URIs are formed solely</span>
<span class="udiff-line-added">+  * from the value provided by g_test_bug().</span>
<span class="udiff-line-added">+  *</span>
   * Since: 2.16
   */
  void
  g_test_bug_base (const char *uri_pattern)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1658,33 +1903,73 @@</span>
   * @bug_uri_snippet: Bug specific bug tracker URI portion.
   *
   * This function adds a message to test reports that
   * associates a bug URI with a test case.
   * Bug URIs are constructed from a base URI set with g_test_bug_base()
<span class="udiff-line-modified-removed">-  * and @bug_uri_snippet.</span>
<span class="udiff-line-modified-added">+  * and @bug_uri_snippet. If g_test_bug_base() has not been called, it is</span>
<span class="udiff-line-added">+  * assumed to be the empty string, so a full URI can be provided to</span>
<span class="udiff-line-added">+  * g_test_bug() instead.</span>
   *
   * Since: 2.16
<span class="udiff-line-added">+  * See also: g_test_summary()</span>
   */
  void
  g_test_bug (const char *bug_uri_snippet)
  {
<span class="udiff-line-modified-removed">-   char *c;</span>
<span class="udiff-line-modified-added">+   const char *c = NULL;</span>
  
<span class="udiff-line-removed">-   g_return_if_fail (test_uri_base != NULL);</span>
    g_return_if_fail (bug_uri_snippet != NULL);
  
<span class="udiff-line-modified-removed">-   c = strstr (test_uri_base, &quot;%s&quot;);</span>
<span class="udiff-line-modified-added">+   if (test_uri_base != NULL)</span>
<span class="udiff-line-added">+     c = strstr (test_uri_base, &quot;%s&quot;);</span>
    if (c)
      {
        char *b = g_strndup (test_uri_base, c - test_uri_base);
        char *s = g_strconcat (b, bug_uri_snippet, c + 2, NULL);
        g_free (b);
        g_test_message (&quot;Bug Reference: %s&quot;, s);
        g_free (s);
      }
    else
<span class="udiff-line-modified-removed">-     g_test_message (&quot;Bug Reference: %s%s&quot;, test_uri_base, bug_uri_snippet);</span>
<span class="udiff-line-modified-added">+     g_test_message (&quot;Bug Reference: %s%s&quot;,</span>
<span class="udiff-line-added">+                     test_uri_base ? test_uri_base : &quot;&quot;, bug_uri_snippet);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ /**</span>
<span class="udiff-line-added">+  * g_test_summary:</span>
<span class="udiff-line-added">+  * @summary: One or two sentences summarising what the test checks, and how it</span>
<span class="udiff-line-added">+  *    checks it.</span>
<span class="udiff-line-added">+  *</span>
<span class="udiff-line-added">+  * Set the summary for a test, which describes what the test checks, and how it</span>
<span class="udiff-line-added">+  * goes about checking it. This may be included in test report output, and is</span>
<span class="udiff-line-added">+  * useful documentation for anyone reading the source code or modifying a test</span>
<span class="udiff-line-added">+  * in future. It must be a single line.</span>
<span class="udiff-line-added">+  *</span>
<span class="udiff-line-added">+  * This should be called at the top of a test function.</span>
<span class="udiff-line-added">+  *</span>
<span class="udiff-line-added">+  * For example:</span>
<span class="udiff-line-added">+  * |[&lt;!-- language=&quot;C&quot; --&gt;</span>
<span class="udiff-line-added">+  * static void</span>
<span class="udiff-line-added">+  * test_array_sort (void)</span>
<span class="udiff-line-added">+  * {</span>
<span class="udiff-line-added">+  *   g_test_summary (&quot;Test my_array_sort() sorts the array correctly and stably, &quot;</span>
<span class="udiff-line-added">+  *                   &quot;including testing zero length and one-element arrays.&quot;);</span>
<span class="udiff-line-added">+  *</span>
<span class="udiff-line-added">+  * }</span>
<span class="udiff-line-added">+  * ]|</span>
<span class="udiff-line-added">+  *</span>
<span class="udiff-line-added">+  * Since: 2.62</span>
<span class="udiff-line-added">+  * See also: g_test_bug()</span>
<span class="udiff-line-added">+  */</span>
<span class="udiff-line-added">+ void</span>
<span class="udiff-line-added">+ g_test_summary (const char *summary)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+   g_return_if_fail (summary != NULL);</span>
<span class="udiff-line-added">+   g_return_if_fail (strchr (summary, &#39;\n&#39;) == NULL);</span>
<span class="udiff-line-added">+   g_return_if_fail (strchr (summary, &#39;\r&#39;) == NULL);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   g_test_message (&quot;%s summary: %s&quot;, test_run_name, summary);</span>
  }
  
  /**
   * g_test_get_root:
   *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1753,10 +2038,18 @@</span>
  g_test_run (void)
  {
    if (g_test_run_suite (g_test_get_root()) != 0)
      return 1;
  
<span class="udiff-line-added">+   /* Clean up the temporary directory. */</span>
<span class="udiff-line-added">+   if (test_isolate_dirs_tmpdir != NULL)</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       rm_rf (test_isolate_dirs_tmpdir);</span>
<span class="udiff-line-added">+       g_free (test_isolate_dirs_tmpdir);</span>
<span class="udiff-line-added">+       test_isolate_dirs_tmpdir = NULL;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
    /* 77 is special to Automake&#39;s default driver, but not Automake&#39;s TAP driver
     * or Perl&#39;s prove(1) TAP driver. */
    if (test_tap_log)
      return 0;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1869,10 +2162,11 @@</span>
    GTestSuite *suite;
  
    g_return_if_fail (testpath != NULL);
    g_return_if_fail (g_path_is_absolute (testpath));
    g_return_if_fail (fixture_test_func != NULL);
<span class="udiff-line-added">+   g_return_if_fail (!test_isolate_dirs || strstr (testpath, &quot;/.&quot;) == NULL);</span>
  
    suite = g_test_get_root();
    segments = g_strsplit (testpath, &quot;/&quot;, -1);
    for (ui = 0; segments[ui] != NULL; ui++)
      {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2057,10 +2351,14 @@</span>
   *
   * If @testpath includes the component &quot;subprocess&quot; anywhere in it,
   * the test will be skipped by default, and only run if explicitly
   * required via the `-p` command-line option or g_test_trap_subprocess().
   *
<span class="udiff-line-added">+  * No component of @testpath may start with a dot (`.`) if the</span>
<span class="udiff-line-added">+  * %G_TEST_OPTION_ISOLATE_DIRS option is being used; and it is recommended to</span>
<span class="udiff-line-added">+  * do so even if it isn&#39;t.</span>
<span class="udiff-line-added">+  *</span>
   * Since: 2.16
   */
  void
  g_test_add_func (const char *testpath,
                   GTestFunc   test_func)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2095,10 +2393,14 @@</span>
   *
   * If @testpath includes the component &quot;subprocess&quot; anywhere in it,
   * the test will be skipped by default, and only run if explicitly
   * required via the `-p` command-line option or g_test_trap_subprocess().
   *
<span class="udiff-line-added">+  * No component of @testpath may start with a dot (`.`) if the</span>
<span class="udiff-line-added">+  * %G_TEST_OPTION_ISOLATE_DIRS option is being used; and it is recommended to</span>
<span class="udiff-line-added">+  * do so even if it isn&#39;t.</span>
<span class="udiff-line-added">+  *</span>
   * Since: 2.16
   */
  void
  g_test_add_data_func (const char     *testpath,
                        gconstpointer   test_data,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2308,29 +2610,42 @@</span>
        g_test_log_set_fatal_handler (NULL, NULL);
        if (test_paths_skipped &amp;&amp; g_slist_find_custom (test_paths_skipped, test_run_name, (GCompareFunc)g_strcmp0))
          g_test_skip (&quot;by request (-s option)&quot;);
        else
          {
<span class="udiff-line-modified-removed">-           g_timer_start (test_run_timer);</span>
<span class="udiff-line-modified-removed">-           fixture = tc-&gt;fixture_size ? g_malloc0 (tc-&gt;fixture_size) : tc-&gt;test_data;</span>
<span class="udiff-line-modified-removed">-           test_run_seed (test_run_seedstr);</span>
<span class="udiff-line-modified-removed">-           if (tc-&gt;fixture_setup)</span>
<span class="udiff-line-modified-removed">-             tc-&gt;fixture_setup (fixture, tc-&gt;test_data);</span>
<span class="udiff-line-modified-removed">-           tc-&gt;fixture_test (fixture, tc-&gt;test_data);</span>
<span class="udiff-line-modified-removed">-           test_trap_clear();</span>
<span class="udiff-line-modified-removed">-           while (test_destroy_queue)</span>
<span class="udiff-line-modified-added">+           GError *local_error = NULL;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+           if (!test_do_isolate_dirs (&amp;local_error))</span>
<span class="udiff-line-modified-added">+             {</span>
<span class="udiff-line-modified-added">+               g_test_log (G_TEST_LOG_ERROR, local_error-&gt;message, NULL, 0, NULL);</span>
<span class="udiff-line-modified-added">+               g_test_fail ();</span>
<span class="udiff-line-modified-added">+               g_error_free (local_error);</span>
<span class="udiff-line-modified-added">+             }</span>
<span class="udiff-line-added">+           else</span>
              {
<span class="udiff-line-modified-removed">-               DestroyEntry *dentry = test_destroy_queue;</span>
<span class="udiff-line-modified-removed">-               test_destroy_queue = dentry-&gt;next;</span>
<span class="udiff-line-modified-removed">-               dentry-&gt;destroy_func (dentry-&gt;destroy_data);</span>
<span class="udiff-line-modified-removed">-               g_slice_free (DestroyEntry, dentry);</span>
<span class="udiff-line-modified-added">+               g_timer_start (test_run_timer);</span>
<span class="udiff-line-modified-added">+               fixture = tc-&gt;fixture_size ? g_malloc0 (tc-&gt;fixture_size) : tc-&gt;test_data;</span>
<span class="udiff-line-modified-added">+               test_run_seed (test_run_seedstr);</span>
<span class="udiff-line-modified-added">+               if (tc-&gt;fixture_setup)</span>
<span class="udiff-line-added">+                 tc-&gt;fixture_setup (fixture, tc-&gt;test_data);</span>
<span class="udiff-line-added">+               tc-&gt;fixture_test (fixture, tc-&gt;test_data);</span>
<span class="udiff-line-added">+               test_trap_clear();</span>
<span class="udiff-line-added">+               while (test_destroy_queue)</span>
<span class="udiff-line-added">+                 {</span>
<span class="udiff-line-added">+                   DestroyEntry *dentry = test_destroy_queue;</span>
<span class="udiff-line-added">+                   test_destroy_queue = dentry-&gt;next;</span>
<span class="udiff-line-added">+                   dentry-&gt;destroy_func (dentry-&gt;destroy_data);</span>
<span class="udiff-line-added">+                   g_slice_free (DestroyEntry, dentry);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+               if (tc-&gt;fixture_teardown)</span>
<span class="udiff-line-added">+                 tc-&gt;fixture_teardown (fixture, tc-&gt;test_data);</span>
<span class="udiff-line-added">+               if (tc-&gt;fixture_size)</span>
<span class="udiff-line-added">+                 g_free (fixture);</span>
<span class="udiff-line-added">+               g_timer_stop (test_run_timer);</span>
              }
<span class="udiff-line-modified-removed">-           if (tc-&gt;fixture_teardown)</span>
<span class="udiff-line-modified-removed">-             tc-&gt;fixture_teardown (fixture, tc-&gt;test_data);</span>
<span class="udiff-line-removed">-           if (tc-&gt;fixture_size)</span>
<span class="udiff-line-removed">-             g_free (fixture);</span>
<span class="udiff-line-removed">-           g_timer_stop (test_run_timer);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+           test_rm_isolate_dirs ();</span>
          }
        success = test_run_success;
        test_run_success = G_TEST_RUN_FAILURE;
        largs[0] = success; /* OK */
        largs[1] = test_run_forks;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2596,15 +2911,18 @@</span>
      g_abort ();
  }
  
  /**
   * g_assertion_message_expr: (skip)
<span class="udiff-line-modified-removed">-  * @domain: (nullable):</span>
<span class="udiff-line-modified-removed">-  * @file:</span>
<span class="udiff-line-modified-removed">-  * @line:</span>
<span class="udiff-line-modified-removed">-  * @func:</span>
<span class="udiff-line-modified-removed">-  * @expr: (nullable):</span>
<span class="udiff-line-modified-added">+  * @domain: (nullable): log domain</span>
<span class="udiff-line-modified-added">+  * @file: file containing the assertion</span>
<span class="udiff-line-modified-added">+  * @line: line number of the assertion</span>
<span class="udiff-line-modified-added">+  * @func: function containing the assertion</span>
<span class="udiff-line-modified-added">+  * @expr: (nullable): expression which failed</span>
<span class="udiff-line-added">+  *</span>
<span class="udiff-line-added">+  * Internal function used to print messages from the public g_assert() and</span>
<span class="udiff-line-added">+  * g_assert_not_reached() macros.</span>
   */
  void
  g_assertion_message_expr (const char     *domain,
                            const char     *file,
                            int             line,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2675,17 +2993,17 @@</span>
    g_free (s);
  }
  
  void
  g_assertion_message_error (const char     *domain,
<span class="udiff-line-modified-removed">-                const char     *file,</span>
<span class="udiff-line-modified-removed">-                int             line,</span>
<span class="udiff-line-modified-removed">-                const char     *func,</span>
<span class="udiff-line-modified-removed">-                const char     *expr,</span>
<span class="udiff-line-modified-removed">-                const GError   *error,</span>
<span class="udiff-line-modified-removed">-                GQuark          error_domain,</span>
<span class="udiff-line-modified-removed">-                int             error_code)</span>
<span class="udiff-line-modified-added">+          const char     *file,</span>
<span class="udiff-line-modified-added">+          int             line,</span>
<span class="udiff-line-modified-added">+          const char     *func,</span>
<span class="udiff-line-modified-added">+          const char     *expr,</span>
<span class="udiff-line-modified-added">+          const GError   *error,</span>
<span class="udiff-line-modified-added">+          GQuark          error_domain,</span>
<span class="udiff-line-modified-added">+          int             error_code)</span>
  {
    GString *gstring;
  
    /* This is used by both g_assert_error() and g_assert_no_error(), so there
     * are three cases: expected an error but got the wrong error, expected
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2693,17 +3011,17 @@</span>
     */
  
    gstring = g_string_new (&quot;assertion failed &quot;);
    if (error_domain)
        g_string_append_printf (gstring, &quot;(%s == (%s, %d)): &quot;, expr,
<span class="udiff-line-modified-removed">-                   g_quark_to_string (error_domain), error_code);</span>
<span class="udiff-line-modified-added">+             g_quark_to_string (error_domain), error_code);</span>
    else
      g_string_append_printf (gstring, &quot;(%s == NULL): &quot;, expr);
  
    if (error)
        g_string_append_printf (gstring, &quot;%s (%s, %d)&quot;, error-&gt;message,
<span class="udiff-line-modified-removed">-                   g_quark_to_string (error-&gt;domain), error-&gt;code);</span>
<span class="udiff-line-modified-added">+             g_quark_to_string (error-&gt;domain), error-&gt;code);</span>
    else
      g_string_append_printf (gstring, &quot;%s is NULL&quot;, expr);
  
    g_assertion_message (domain, file, line, func, gstring-&gt;str);
    g_string_free (gstring, TRUE);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2964,10 +3282,11 @@</span>
   *
   * Deprecated: This function is implemented only on Unix platforms,
   * and is not always reliable due to problems inherent in
   * fork-without-exec. Use g_test_trap_subprocess() instead.
   */
<span class="udiff-line-added">+ G_GNUC_BEGIN_IGNORE_DEPRECATIONS</span>
  gboolean
  g_test_trap_fork (guint64        usec_timeout,
                    GTestTrapFlags test_trap_flags)
  {
  #ifdef G_OS_UNIX
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3006,10 +3325,22 @@</span>
          close (fd0);
        if (stdout_pipe[1] &gt;= 3)
          close (stdout_pipe[1]);
        if (stderr_pipe[1] &gt;= 3)
          close (stderr_pipe[1]);
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       /* We typically expect these child processes to crash, and some</span>
<span class="udiff-line-added">+        * tests spawn a *lot* of them.  Avoid spamming system crash</span>
<span class="udiff-line-added">+        * collection programs such as systemd-coredump and abrt.</span>
<span class="udiff-line-added">+        */</span>
<span class="udiff-line-added">+ #ifdef HAVE_SYS_RESOURCE_H</span>
<span class="udiff-line-added">+       {</span>
<span class="udiff-line-added">+         struct rlimit limit = { 0, 0 };</span>
<span class="udiff-line-added">+         (void) setrlimit (RLIMIT_CORE, &amp;limit);</span>
<span class="udiff-line-added">+       }</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
        return TRUE;
      }
    else                          /* parent */
      {
        test_run_forks++;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3026,10 +3357,11 @@</span>
    g_message (&quot;Not implemented: g_test_trap_fork&quot;);
  
    return FALSE;
  #endif
  }
<span class="udiff-line-added">+ G_GNUC_END_IGNORE_DEPRECATIONS</span>
  
  /**
   * g_test_trap_subprocess:
   * @test_path: (nullable): Test to run in a subprocess
   * @usec_timeout: Timeout for the subprocess test in micro seconds.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3144,10 +3476,12 @@</span>
        g_ptr_array_add (argv, log_fd_buf);
      }
    g_ptr_array_add (argv, NULL);
  
    flags = G_SPAWN_DO_NOT_REAP_CHILD;
<span class="udiff-line-added">+   if (test_log_fd != -1)</span>
<span class="udiff-line-added">+     flags |= G_SPAWN_LEAVE_DESCRIPTORS_OPEN;</span>
    if (test_flags &amp; G_TEST_TRAP_INHERIT_STDIN)
      flags |= G_SPAWN_CHILD_INHERITS_STDIN;
  
    if (!g_spawn_async_with_pipes (test_initial_cwd,
                                   (char **)argv-&gt;pdata,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3341,21 +3675,23 @@</span>
      {
        char *msg;
  
        logged_child_output = logged_child_output || log_child_output (process_id);
  
<span class="udiff-line-modified-removed">-       msg = g_strdup_printf (&quot;stdout of child process (%s) %s: %s&quot;, process_id, match_error, stdout_pattern);</span>
<span class="udiff-line-modified-added">+       msg = g_strdup_printf (&quot;stdout of child process (%s) %s: %s\nstdout was:\n%s&quot;,</span>
<span class="udiff-line-added">+                              process_id, match_error, stdout_pattern, test_trap_last_stdout);</span>
        g_assertion_message (domain, file, line, func, msg);
        g_free (msg);
      }
    if (stderr_pattern &amp;&amp; match_result == !g_pattern_match_simple (stderr_pattern, test_trap_last_stderr))
      {
        char *msg;
  
        logged_child_output = logged_child_output || log_child_output (process_id);
  
<span class="udiff-line-modified-removed">-       msg = g_strdup_printf (&quot;stderr of child process (%s) %s: %s&quot;, process_id, match_error, stderr_pattern);</span>
<span class="udiff-line-modified-added">+       msg = g_strdup_printf (&quot;stderr of child process (%s) %s: %s\nstderr was:\n%s&quot;,</span>
<span class="udiff-line-added">+                              process_id, match_error, stderr_pattern, test_trap_last_stderr);</span>
        g_assertion_message (domain, file, line, func, msg);
        g_free (msg);
      }
    g_free (process_id);
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3560,11 +3896,11 @@</span>
  g_test_build_filename_va (GTestFileType  file_type,
                            const gchar   *first_path,
                            va_list        ap)
  {
    const gchar *pathv[16];
<span class="udiff-line-modified-removed">-   gint num_path_segments;</span>
<span class="udiff-line-modified-added">+   gsize num_path_segments;</span>
  
    if (file_type == G_TEST_DIST)
      pathv[0] = test_disted_files_dir;
    else if (file_type == G_TEST_BUILT)
      pathv[0] = test_built_files_dir;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3733,27 +4069,5 @@</span>
      node-&gt;next = *test_filename_free_list;
    while (!g_atomic_pointer_compare_and_exchange (test_filename_free_list, node-&gt;next, node));
  
    return result;
  }
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- /* --- macros docs START --- */</span>
<span class="udiff-line-removed">- /**</span>
<span class="udiff-line-removed">-  * g_test_add:</span>
<span class="udiff-line-removed">-  * @testpath:  The test path for a new test case.</span>
<span class="udiff-line-removed">-  * @Fixture:   The type of a fixture data structure.</span>
<span class="udiff-line-removed">-  * @tdata:     Data argument for the test functions.</span>
<span class="udiff-line-removed">-  * @fsetup:    The function to set up the fixture data.</span>
<span class="udiff-line-removed">-  * @ftest:     The actual test function.</span>
<span class="udiff-line-removed">-  * @fteardown: The function to tear down the fixture data.</span>
<span class="udiff-line-removed">-  *</span>
<span class="udiff-line-removed">-  * Hook up a new test case at @testpath, similar to g_test_add_func().</span>
<span class="udiff-line-removed">-  * A fixture data structure with setup and teardown functions may be provided,</span>
<span class="udiff-line-removed">-  * similar to g_test_create_case().</span>
<span class="udiff-line-removed">-  *</span>
<span class="udiff-line-removed">-  * g_test_add() is implemented as a macro, so that the fsetup(), ftest() and</span>
<span class="udiff-line-removed">-  * fteardown() callbacks can expect a @Fixture pointer as their first argument</span>
<span class="udiff-line-removed">-  * in a type safe manner. They otherwise have type #GTestFixtureFunc.</span>
<span class="udiff-line-removed">-  *</span>
<span class="udiff-line-removed">-  * Since: 2.16</span>
<span class="udiff-line-removed">-  **/</span>
<span class="udiff-line-removed">- /* --- macros docs END --- */</span>
</pre>
<center><a href="gstring.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="gtestutils.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>