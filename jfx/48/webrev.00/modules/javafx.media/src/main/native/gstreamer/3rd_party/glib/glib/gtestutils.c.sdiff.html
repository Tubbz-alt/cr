<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.media/src/main/native/gstreamer/3rd_party/glib/glib/gtestutils.c</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="gstring.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="gtestutils.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.media/src/main/native/gstreamer/3rd_party/glib/glib/gtestutils.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  10  * This library is distributed in the hope that it will be useful,
  11  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  12  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
  13  * Lesser General Public License for more details.
  14  *
  15  * You should have received a copy of the GNU Lesser General Public
  16  * License along with this library; if not, see &lt;http://www.gnu.org/licenses/&gt;.
  17  */
  18 
  19 #include &quot;config.h&quot;
  20 
  21 #include &quot;gtestutils.h&quot;
  22 #include &quot;gfileutils.h&quot;
  23 
  24 #include &lt;sys/types.h&gt;
  25 #ifdef G_OS_UNIX
  26 #include &lt;sys/wait.h&gt;
  27 #include &lt;sys/time.h&gt;
  28 #include &lt;fcntl.h&gt;
  29 #include &lt;unistd.h&gt;
<span class="line-removed">  30 #include &lt;glib/gstdio.h&gt;</span>
  31 #endif
  32 #include &lt;string.h&gt;
  33 #include &lt;stdlib.h&gt;
  34 #include &lt;stdio.h&gt;
  35 #ifdef HAVE_SYS_RESOURCE_H
  36 #include &lt;sys/resource.h&gt;
  37 #endif
  38 #ifdef G_OS_WIN32
  39 #include &lt;io.h&gt;
  40 #include &lt;windows.h&gt;
  41 #endif
  42 #include &lt;errno.h&gt;
  43 #include &lt;signal.h&gt;
  44 #ifdef HAVE_SYS_SELECT_H
  45 #include &lt;sys/select.h&gt;
  46 #endif /* HAVE_SYS_SELECT_H */

  47 
  48 #include &quot;gmain.h&quot;
  49 #include &quot;gpattern.h&quot;
  50 #include &quot;grand.h&quot;
  51 #include &quot;gstrfuncs.h&quot;
  52 #include &quot;gtimer.h&quot;
  53 #include &quot;gslice.h&quot;
  54 #include &quot;gspawn.h&quot;
  55 #include &quot;glib-private.h&quot;

  56 
  57 
  58 /**
  59  * SECTION:testing
  60  * @title: Testing
  61  * @short_description: a test framework
<span class="line-removed">  62  * @see_also: [gtester][gtester], [gtester-report][gtester-report]</span>
  63  *
  64  * GLib provides a framework for writing and maintaining unit tests
  65  * in parallel to the code they are testing. The API is designed according
  66  * to established concepts found in the other test frameworks (JUnit, NUnit,
  67  * RUnit), which in turn is based on smalltalk unit testing concepts.
  68  *
  69  * - Test case: Tests (test methods) are grouped together with their
  70  *   fixture into test cases.
  71  *
  72  * - Fixture: A test fixture consists of fixture data and setup and
  73  *   teardown methods to establish the environment for the test
  74  *   functions. We use fresh fixtures, i.e. fixtures are newly set
  75  *   up and torn down around each test invocation to avoid dependencies
  76  *   between tests.
  77  *
  78  * - Test suite: Test cases can be grouped into test suites, to allow
  79  *   subsets of the available tests to be run. Test suites can be
  80  *   grouped into other test suites as well.
  81  *
  82  * The API is designed to handle creation and registration of test suites
  83  * and test cases implicitly. A simple call like
  84  * |[&lt;!-- language=&quot;C&quot; --&gt;
  85  *   g_test_add_func (&quot;/misc/assertions&quot;, test_assertions);
  86  * ]|
  87  * creates a test suite called &quot;misc&quot; with a single test case named
  88  * &quot;assertions&quot;, which consists of running the test_assertions function.
  89  *
  90  * In addition to the traditional g_assert_true(), the test framework provides
  91  * an extended set of assertions for comparisons: g_assert_cmpfloat(),
  92  * g_assert_cmpfloat_with_epsilon(), g_assert_cmpint(), g_assert_cmpuint(),
<span class="line-modified">  93  * g_assert_cmphex(), g_assert_cmpstr(), and g_assert_cmpmem(). The</span>

  94  * advantage of these variants over plain g_assert_true() is that the assertion
  95  * messages can be more elaborate, and include the values of the compared
  96  * entities.
  97  *
  98  * Note that g_assert() should not be used in unit tests, since it is a no-op
  99  * when compiling with `G_DISABLE_ASSERT`. Use g_assert() in production code,
 100  * and g_assert_true() in unit tests.
 101  *
 102  * A full example of creating a test suite with two tests using fixtures:
 103  * |[&lt;!-- language=&quot;C&quot; --&gt;
 104  * #include &lt;glib.h&gt;
 105  * #include &lt;locale.h&gt;
 106  *
 107  * typedef struct {
 108  *   MyObject *obj;
 109  *   OtherObject *helper;
 110  * } MyObjectFixture;
 111  *
 112  * static void
 113  * my_object_fixture_set_up (MyObjectFixture *fixture,
</pre>
<hr />
<pre>
 132  * test_my_object_test1 (MyObjectFixture *fixture,
 133  *                       gconstpointer user_data)
 134  * {
 135  *   g_assert_cmpstr (my_object_get_property (fixture-&gt;obj), ==, &quot;initial-value&quot;);
 136  * }
 137  *
 138  * static void
 139  * test_my_object_test2 (MyObjectFixture *fixture,
 140  *                       gconstpointer user_data)
 141  * {
 142  *   my_object_do_some_work_using_helper (fixture-&gt;obj, fixture-&gt;helper);
 143  *   g_assert_cmpstr (my_object_get_property (fixture-&gt;obj), ==, &quot;updated-value&quot;);
 144  * }
 145  *
 146  * int
 147  * main (int argc, char *argv[])
 148  * {
 149  *   setlocale (LC_ALL, &quot;&quot;);
 150  *
 151  *   g_test_init (&amp;argc, &amp;argv, NULL);
<span class="line-removed"> 152  *   g_test_bug_base (&quot;http://bugzilla.gnome.org/show_bug.cgi?id=&quot;);</span>
 153  *
 154  *   // Define the tests.
 155  *   g_test_add (&quot;/my-object/test1&quot;, MyObjectFixture, &quot;some-user-data&quot;,
 156  *               my_object_fixture_set_up, test_my_object_test1,
 157  *               my_object_fixture_tear_down);
 158  *   g_test_add (&quot;/my-object/test2&quot;, MyObjectFixture, &quot;some-user-data&quot;,
 159  *               my_object_fixture_set_up, test_my_object_test2,
 160  *               my_object_fixture_tear_down);
 161  *
 162  *   return g_test_run ();
 163  * }
 164  * ]|
 165  *
 166  * ### Integrating GTest in your project
 167  *
 168  * If you are using the [Meson](http://mesonbuild.com) build system, you will
 169  * typically use the provided `test()` primitive to call the test binaries,
 170  * e.g.:
 171  *
 172  * |[&lt;!-- language=&quot;plain&quot; --&gt;
</pre>
<hr />
<pre>
 176  *     env: [
 177  *       &#39;G_TEST_SRCDIR=@0@&#39;.format(meson.current_source_dir()),
 178  *       &#39;G_TEST_BUILDDIR=@0@&#39;.format(meson.current_build_dir()),
 179  *     ],
 180  *   )
 181  *
 182  *   test(
 183  *     &#39;bar&#39;,
 184  *     executable(&#39;bar&#39;, &#39;bar.c&#39;, dependencies: deps),
 185  *     env: [
 186  *       &#39;G_TEST_SRCDIR=@0@&#39;.format(meson.current_source_dir()),
 187  *       &#39;G_TEST_BUILDDIR=@0@&#39;.format(meson.current_build_dir()),
 188  *     ],
 189  *   )
 190  * ]|
 191  *
 192  * If you are using Autotools, you&#39;re strongly encouraged to use the Automake
 193  * [TAP](https://testanything.org/) harness; GLib provides template files for
 194  * easily integrating with it:
 195  *
<span class="line-modified"> 196  *   - [glib-tap.mk](https://git.gnome.org/browse/glib/tree/glib-tap.mk)</span>
<span class="line-modified"> 197  *   - [tap-test](https://git.gnome.org/browse/glib/tree/tap-test)</span>
<span class="line-modified"> 198  *   - [tap-driver.sh](https://git.gnome.org/browse/glib/tree/tap-driver.sh)</span>
 199  *
 200  * You can copy these files in your own project&#39;s root directory, and then
 201  * set up your `Makefile.am` file to reference them, for instance:
 202  *
 203  * |[&lt;!-- language=&quot;plain&quot; --&gt;
 204  * include $(top_srcdir)/glib-tap.mk
 205  *
 206  * # test binaries
 207  * test_programs = \
 208  *   foo \
 209  *   bar
 210  *
 211  * # data distributed in the tarball
 212  * dist_test_data = \
 213  *   foo.data.txt \
 214  *   bar.data.txt
 215  *
 216  * # data not distributed in the tarball
 217  * test_data = \
 218  *   blah.data.txt
 219  * ]|
 220  *
 221  * Make sure to distribute the TAP files, using something like the following
 222  * in your top-level `Makefile.am`:
 223  *
 224  * |[&lt;!-- language=&quot;plain&quot; --&gt;
 225  * EXTRA_DIST += \
 226  *   tap-driver.sh \
 227  *   tap-test
 228  * ]|
 229  *
 230  * `glib-tap.mk` will be distributed implicitly due to being included in a
 231  * `Makefile.am`. All three files should be added to version control.
 232  *
 233  * If you don&#39;t have access to the Autotools TAP harness, you can use the
 234  * [gtester][gtester] and [gtester-report][gtester-report] tools, and use
<span class="line-modified"> 235  * the [glib.mk](https://git.gnome.org/browse/glib/tree/glib.mk) Automake</span>
<span class="line-modified"> 236  * template provided by GLib.</span>



 237  */
 238 
 239 /**
 240  * g_test_initialized:
 241  *
 242  * Returns %TRUE if g_test_init() has been called.
 243  *
 244  * Returns: %TRUE if g_test_init() has been called.
 245  *
 246  * Since: 2.36
 247  */
 248 
 249 /**
 250  * g_test_quick:
 251  *
 252  * Returns %TRUE if tests are run in quick mode.
 253  * Exactly one of g_test_quick() and g_test_slow() is active in any run;
 254  * there is no &quot;medium speed&quot;.
 255  *
 256  * By default, tests are run in quick mode. In tests that use
</pre>
<hr />
<pre>
 328  *
 329  * Returns %TRUE if tests are run in quiet mode.
 330  * In tests that use g_test_init(), the option `-q` or `--quiet` enables
 331  * this, while `--verbose` disables it.
 332  * The default is neither g_test_verbose() nor g_test_quiet().
 333  *
 334  * Returns: %TRUE if in quiet mode
 335  */
 336 
 337 /**
 338  * g_test_queue_unref:
 339  * @gobject: the object to unref
 340  *
 341  * Enqueue an object to be released with g_object_unref() during
 342  * the next teardown phase. This is equivalent to calling
 343  * g_test_queue_destroy() with a destroy callback of g_object_unref().
 344  *
 345  * Since: 2.16
 346  */
 347 
<span class="line-removed"> 348 /**</span>
<span class="line-removed"> 349  * GTestTrapFlags:</span>
<span class="line-removed"> 350  * @G_TEST_TRAP_SILENCE_STDOUT: Redirect stdout of the test child to</span>
<span class="line-removed"> 351  *     `/dev/null` so it cannot be observed on the console during test</span>
<span class="line-removed"> 352  *     runs. The actual output is still captured though to allow later</span>
<span class="line-removed"> 353  *     tests with g_test_trap_assert_stdout().</span>
<span class="line-removed"> 354  * @G_TEST_TRAP_SILENCE_STDERR: Redirect stderr of the test child to</span>
<span class="line-removed"> 355  *     `/dev/null` so it cannot be observed on the console during test</span>
<span class="line-removed"> 356  *     runs. The actual output is still captured though to allow later</span>
<span class="line-removed"> 357  *     tests with g_test_trap_assert_stderr().</span>
<span class="line-removed"> 358  * @G_TEST_TRAP_INHERIT_STDIN: If this flag is given, stdin of the</span>
<span class="line-removed"> 359  *     child process is shared with stdin of its parent process.</span>
<span class="line-removed"> 360  *     It is redirected to `/dev/null` otherwise.</span>
<span class="line-removed"> 361  *</span>
<span class="line-removed"> 362  * Test traps are guards around forked tests.</span>
<span class="line-removed"> 363  * These flags determine what traps to set.</span>
<span class="line-removed"> 364  *</span>
<span class="line-removed"> 365  * Deprecated: #GTestTrapFlags is used only with g_test_trap_fork(),</span>
<span class="line-removed"> 366  * which is deprecated. g_test_trap_subprocess() uses</span>
<span class="line-removed"> 367  * #GTestSubprocessFlags.</span>
<span class="line-removed"> 368  */</span>
<span class="line-removed"> 369 </span>
 370 /**
 371  * GTestSubprocessFlags:
 372  * @G_TEST_SUBPROCESS_INHERIT_STDIN: If this flag is given, the child
 373  *     process will inherit the parent&#39;s stdin. Otherwise, the child&#39;s
 374  *     stdin is redirected to `/dev/null`.
 375  * @G_TEST_SUBPROCESS_INHERIT_STDOUT: If this flag is given, the child
 376  *     process will inherit the parent&#39;s stdout. Otherwise, the child&#39;s
 377  *     stdout will not be visible, but it will be captured to allow
 378  *     later tests with g_test_trap_assert_stdout().
 379  * @G_TEST_SUBPROCESS_INHERIT_STDERR: If this flag is given, the child
 380  *     process will inherit the parent&#39;s stderr. Otherwise, the child&#39;s
 381  *     stderr will not be visible, but it will be captured to allow
 382  *     later tests with g_test_trap_assert_stderr().
 383  *
 384  * Flags to pass to g_test_trap_subprocess() to control input and output.
 385  *
 386  * Note that in contrast with g_test_trap_fork(), the default is to
 387  * not show stdout and stderr.
 388  */
 389 
</pre>
<hr />
<pre>
 558  *
 559  * Debugging macro to check an expression is not %NULL.
 560  *
 561  * If the assertion fails (i.e. the expression is %NULL),
 562  * an error message is logged and the application is either
 563  * terminated or the testcase marked as failed.
 564  *
 565  * Note that unlike g_assert(), this macro is unaffected by whether
 566  * `G_DISABLE_ASSERT` is defined. Hence it should only be used in tests and,
 567  * conversely, g_assert() should not be used in tests.
 568  *
 569  * See g_test_set_nonfatal_assertions().
 570  *
 571  * Since: 2.40
 572  */
 573 
 574 /**
 575  * g_assert_cmpstr:
 576  * @s1: a string (may be %NULL)
 577  * @cmp: The comparison operator to use.
<span class="line-modified"> 578  *     One of ==, !=, &lt;, &gt;, &lt;=, &gt;=.</span>
 579  * @s2: another string (may be %NULL)
 580  *
 581  * Debugging macro to compare two strings. If the comparison fails,
 582  * an error message is logged and the application is either terminated
 583  * or the testcase marked as failed.
 584  * The strings are compared using g_strcmp0().
 585  *
 586  * The effect of `g_assert_cmpstr (s1, op, s2)` is
 587  * the same as `g_assert_true (g_strcmp0 (s1, s2) op 0)`.
 588  * The advantage of this macro is that it can produce a message that
 589  * includes the actual values of @s1 and @s2.
 590  *
 591  * |[&lt;!-- language=&quot;C&quot; --&gt;
 592  *   g_assert_cmpstr (mystring, ==, &quot;fubar&quot;);
 593  * ]|
 594  *
 595  * Since: 2.16
 596  */
 597 
 598 /**
 599  * g_assert_cmpint:
 600  * @n1: an integer
 601  * @cmp: The comparison operator to use.
<span class="line-modified"> 602  *     One of ==, !=, &lt;, &gt;, &lt;=, &gt;=.</span>
 603  * @n2: another integer
 604  *
 605  * Debugging macro to compare two integers.
 606  *
 607  * The effect of `g_assert_cmpint (n1, op, n2)` is
 608  * the same as `g_assert_true (n1 op n2)`. The advantage
 609  * of this macro is that it can produce a message that includes the
 610  * actual values of @n1 and @n2.
 611  *
 612  * Since: 2.16
 613  */
 614 
 615 /**
 616  * g_assert_cmpuint:
 617  * @n1: an unsigned integer
 618  * @cmp: The comparison operator to use.
<span class="line-modified"> 619  *     One of ==, !=, &lt;, &gt;, &lt;=, &gt;=.</span>
 620  * @n2: another unsigned integer
 621  *
 622  * Debugging macro to compare two unsigned integers.
 623  *
 624  * The effect of `g_assert_cmpuint (n1, op, n2)` is
 625  * the same as `g_assert_true (n1 op n2)`. The advantage
 626  * of this macro is that it can produce a message that includes the
 627  * actual values of @n1 and @n2.
 628  *
 629  * Since: 2.16
 630  */
 631 
 632 /**
 633  * g_assert_cmphex:
 634  * @n1: an unsigned integer
 635  * @cmp: The comparison operator to use.
<span class="line-modified"> 636  *     One of ==, !=, &lt;, &gt;, &lt;=, &gt;=.</span>
 637  * @n2: another unsigned integer
 638  *
 639  * Debugging macro to compare to unsigned integers.
 640  *
 641  * This is a variant of g_assert_cmpuint() that displays the numbers
 642  * in hexadecimal notation in the message.
 643  *
 644  * Since: 2.16
 645  */
 646 
 647 /**
 648  * g_assert_cmpfloat:
<span class="line-modified"> 649  * @n1: an floating point number</span>
 650  * @cmp: The comparison operator to use.
<span class="line-modified"> 651  *     One of ==, !=, &lt;, &gt;, &lt;=, &gt;=.</span>
 652  * @n2: another floating point number
 653  *
 654  * Debugging macro to compare two floating point numbers.
 655  *
 656  * The effect of `g_assert_cmpfloat (n1, op, n2)` is
 657  * the same as `g_assert_true (n1 op n2)`. The advantage
 658  * of this macro is that it can produce a message that includes the
 659  * actual values of @n1 and @n2.
 660  *
 661  * Since: 2.16
 662  */
 663 
 664 /**
 665  * g_assert_cmpfloat_with_epsilon:
<span class="line-modified"> 666  * @n1: an floating point number</span>
 667  * @n2: another floating point number
 668  * @epsilon: a numeric value that expresses the expected tolerance
 669  *   between @n1 and @n2
 670  *
 671  * Debugging macro to compare two floating point numbers within an epsilon.
 672  *
 673  * The effect of `g_assert_cmpfloat_with_epsilon (n1, n2, epsilon)` is
 674  * the same as `g_assert_true (abs (n1 - n2) &lt; epsilon)`. The advantage
 675  * of this macro is that it can produce a message that includes the
 676  * actual values of @n1 and @n2.
 677  *
 678  * Since: 2.58
 679  */
 680 
 681 /**
 682  * g_assert_cmpmem:
 683  * @m1: pointer to a buffer
 684  * @l1: length of @m1
 685  * @m2: pointer to another buffer
 686  * @l2: length of @m2
 687  *
 688  * Debugging macro to compare memory regions. If the comparison fails,
 689  * an error message is logged and the application is either terminated
 690  * or the testcase marked as failed.
 691  *
 692  * The effect of `g_assert_cmpmem (m1, l1, m2, l2)` is
 693  * the same as `g_assert_true (l1 == l2 &amp;&amp; memcmp (m1, m2, l1) == 0)`.
 694  * The advantage of this macro is that it can produce a message that
 695  * includes the actual values of @l1 and @l2.
 696  *
 697  * |[&lt;!-- language=&quot;C&quot; --&gt;
 698  *   g_assert_cmpmem (buf-&gt;data, buf-&gt;len, expected, sizeof (expected));
 699  * ]|
 700  *
 701  * Since: 2.46
 702  */
 703 

















 704 /**
 705  * g_assert_no_error:
 706  * @err: a #GError, possibly %NULL
 707  *
 708  * Debugging macro to check that a #GError is not set.
 709  *
 710  * The effect of `g_assert_no_error (err)` is
 711  * the same as `g_assert_true (err == NULL)`. The advantage
 712  * of this macro is that it can produce a message that includes
 713  * the error message and code.
 714  *
 715  * Since: 2.20
 716  */
 717 
 718 /**
 719  * g_assert_error:
 720  * @err: a #GError, possibly %NULL
 721  * @dom: the expected error domain (a #GQuark)
 722  * @c: the expected error code
 723  *
 724  * Debugging macro to check that a method has returned
 725  * the correct #GError.
 726  *
 727  * The effect of `g_assert_error (err, dom, c)` is
 728  * the same as `g_assert_true (err != NULL &amp;&amp; err-&gt;domain
 729  * == dom &amp;&amp; err-&gt;code == c)`. The advantage of this
 730  * macro is that it can produce a message that includes the incorrect
 731  * error message and code.
 732  *
 733  * This can only be used to test for a specific error. If you want to
 734  * test that @err is set, but don&#39;t care what it&#39;s set to, just use
<span class="line-modified"> 735  * `g_assert (err != NULL)`</span>
 736  *
 737  * Since: 2.20
 738  */
 739 
 740 /**
 741  * GTestCase:
 742  *
 743  * An opaque structure representing a test case.
 744  */
 745 
 746 /**
 747  * GTestSuite:
 748  *
 749  * An opaque structure representing a test suite.
 750  */
 751 
 752 
 753 /* Global variable for storing assertion messages; this is the counterpart to
 754  * glibc&#39;s (private) __abort_msg variable, and allows developers and crash
 755  * analysis systems like Apport and ABRT to fish out assertion messages from
</pre>
<hr />
<pre>
 790 static void     test_trap_clear                 (void);
 791 static guint8*  g_test_log_dump                 (GTestLogMsg *msg,
 792                                                  guint       *len);
 793 static void     gtest_default_log_handler       (const gchar    *log_domain,
 794                                                  GLogLevelFlags  log_level,
 795                                                  const gchar    *message,
 796                                                  gpointer        unused_data);
 797 
 798 
 799 static const char * const g_test_result_names[] = {
 800   &quot;OK&quot;,
 801   &quot;SKIP&quot;,
 802   &quot;FAIL&quot;,
 803   &quot;TODO&quot;
 804 };
 805 
 806 /* --- variables --- */
 807 static int         test_log_fd = -1;
 808 static gboolean    test_mode_fatal = TRUE;
 809 static gboolean    g_test_run_once = TRUE;



 810 static gboolean    test_run_list = FALSE;
 811 static gchar      *test_run_seedstr = NULL;

 812 static GRand      *test_run_rand = NULL;
 813 static gchar      *test_run_name = &quot;&quot;;
 814 static GSList    **test_filename_free_list;
 815 static guint       test_run_forks = 0;
 816 static guint       test_run_count = 0;
 817 static guint       test_count = 0;
 818 static guint       test_skipped_count = 0;
 819 static GTestResult test_run_success = G_TEST_RUN_FAILURE;
 820 static gchar      *test_run_msg = NULL;
 821 static guint       test_startup_skip_count = 0;
 822 static GTimer     *test_user_timer = NULL;
 823 static double      test_user_stamp = 0;
 824 static GSList     *test_paths = NULL;
 825 static GSList     *test_paths_skipped = NULL;
 826 static GTestSuite *test_suite_root = NULL;
 827 static int         test_trap_last_status = 0;  /* unmodified platform-specific status */
 828 static GPid        test_trap_last_pid = 0;
 829 static char       *test_trap_last_subprocess = NULL;
 830 static char       *test_trap_last_stdout = NULL;
 831 static char       *test_trap_last_stderr = NULL;
 832 static char       *test_uri_base = NULL;
 833 static gboolean    test_debug_log = FALSE;
<span class="line-modified"> 834 static gboolean    test_tap_log = FALSE;</span>
 835 static gboolean    test_nonfatal_assertions = FALSE;
 836 static DestroyEntry *test_destroy_queue = NULL;
 837 static char       *test_argv0 = NULL;
 838 static char       *test_argv0_dirname;
 839 static const char *test_disted_files_dir;
 840 static const char *test_built_files_dir;
 841 static char       *test_initial_cwd = NULL;
 842 static gboolean    test_in_forked_child = FALSE;
 843 static gboolean    test_in_subprocess = FALSE;
 844 static GTestConfig mutable_test_config_vars = {
 845   FALSE,        /* test_initialized */
 846   TRUE,         /* test_quick */
 847   FALSE,        /* test_perf */
 848   FALSE,        /* test_verbose */
 849   FALSE,        /* test_quiet */
 850   TRUE,         /* test_undefined */
 851 };
 852 const GTestConfig * const g_test_config_vars = &amp;mutable_test_config_vars;
 853 static gboolean  no_g_set_prgname = FALSE;
 854 
</pre>
<hr />
<pre>
 924             long double *largs)
 925 {
 926   GTestResult result;
 927   gboolean fail;
 928   GTestLogMsg msg;
 929   gchar *astrings[3] = { NULL, NULL, NULL };
 930   guint8 *dbuffer;
 931   guint32 dbufferlen;
 932 
 933   switch (lbit)
 934     {
 935     case G_TEST_LOG_START_BINARY:
 936       if (test_tap_log)
 937         g_print (&quot;# random seed: %s\n&quot;, string2);
 938       else if (g_test_verbose ())
 939         g_print (&quot;GTest: random seed: %s\n&quot;, string2);
 940       break;
 941     case G_TEST_LOG_START_SUITE:
 942       if (test_tap_log)
 943         {


 944           if (string1[0] != 0)
 945             g_print (&quot;# Start of %s tests\n&quot;, string1);
<span class="line-modified"> 946           else</span>
 947             g_print (&quot;1..%d\n&quot;, test_count);
 948         }
 949       break;
 950     case G_TEST_LOG_STOP_SUITE:
 951       if (test_tap_log)
 952         {



 953           if (string1[0] != 0)
 954             g_print (&quot;# End of %s tests\n&quot;, string1);


 955         }
 956       break;
 957     case G_TEST_LOG_STOP_CASE:
 958       result = largs[0];
 959       fail = result == G_TEST_RUN_FAILURE;
 960       if (test_tap_log)
 961         {
 962           const gchar *ok;
 963 
 964           /* The TAP representation for an expected failure starts with
 965            * &quot;not ok&quot;, even though it does not actually count as failing
 966            * due to the use of the TODO directive. &quot;ok # TODO&quot; would mean
 967            * a test that was expected to fail unexpectedly succeeded,
 968            * for which GTestResult does not currently have a
 969            * representation. */
 970           if (fail || result == G_TEST_RUN_INCOMPLETE)
 971             ok = &quot;not ok&quot;;
 972           else
 973             ok = &quot;ok&quot;;
 974 
</pre>
<hr />
<pre>
 976           if (result == G_TEST_RUN_INCOMPLETE)
 977             g_print (&quot; # TODO %s\n&quot;, string2 ? string2 : &quot;&quot;);
 978           else if (result == G_TEST_RUN_SKIPPED)
 979             g_print (&quot; # SKIP %s\n&quot;, string2 ? string2 : &quot;&quot;);
 980           else
 981             g_print (&quot;\n&quot;);
 982         }
 983       else if (g_test_verbose ())
 984         g_print (&quot;GTest: result: %s\n&quot;, g_test_result_names[result]);
 985       else if (!g_test_quiet ())
 986         g_print (&quot;%s\n&quot;, g_test_result_names[result]);
 987       if (fail &amp;&amp; test_mode_fatal)
 988         {
 989           if (test_tap_log)
 990             g_print (&quot;Bail out!\n&quot;);
 991           g_abort ();
 992         }
 993       if (result == G_TEST_RUN_SKIPPED || result == G_TEST_RUN_INCOMPLETE)
 994         test_skipped_count++;
 995       break;




 996     case G_TEST_LOG_MIN_RESULT:
 997       if (test_tap_log)
 998         g_print (&quot;# min perf: %s\n&quot;, string1);
 999       else if (g_test_verbose ())
1000         g_print (&quot;(MINPERF:%s)\n&quot;, string1);
1001       break;
1002     case G_TEST_LOG_MAX_RESULT:
1003       if (test_tap_log)
1004         g_print (&quot;# max perf: %s\n&quot;, string1);
1005       else if (g_test_verbose ())
1006         g_print (&quot;(MAXPERF:%s)\n&quot;, string1);
1007       break;
1008     case G_TEST_LOG_MESSAGE:
1009       if (test_tap_log)
1010         g_print (&quot;# %s\n&quot;, string1);
1011       else if (g_test_verbose ())
1012         g_print (&quot;(MSG: %s)\n&quot;, string1);
1013       break;
1014     case G_TEST_LOG_ERROR:
1015       if (test_tap_log)
</pre>
<hr />
<pre>
1079         {
1080           test_debug_log = TRUE;
1081           argv[i] = NULL;
1082         }
1083       else if (strcmp (argv[i], &quot;--tap&quot;) == 0)
1084         {
1085           test_tap_log = TRUE;
1086           argv[i] = NULL;
1087         }
1088       else if (strcmp (&quot;--GTestLogFD&quot;, argv[i]) == 0 || strncmp (&quot;--GTestLogFD=&quot;, argv[i], 13) == 0)
1089         {
1090           gchar *equal = argv[i] + 12;
1091           if (*equal == &#39;=&#39;)
1092             test_log_fd = g_ascii_strtoull (equal + 1, NULL, 0);
1093           else if (i + 1 &lt; argc)
1094             {
1095               argv[i++] = NULL;
1096               test_log_fd = g_ascii_strtoull (argv[i], NULL, 0);
1097             }
1098           argv[i] = NULL;



1099         }
1100       else if (strcmp (&quot;--GTestSkipCount&quot;, argv[i]) == 0 || strncmp (&quot;--GTestSkipCount=&quot;, argv[i], 17) == 0)
1101         {
1102           gchar *equal = argv[i] + 16;
1103           if (*equal == &#39;=&#39;)
1104             test_startup_skip_count = g_ascii_strtoull (equal + 1, NULL, 0);
1105           else if (i + 1 &lt; argc)
1106             {
1107               argv[i++] = NULL;
1108               test_startup_skip_count = g_ascii_strtoull (argv[i], NULL, 0);
1109             }
1110           argv[i] = NULL;
1111         }
1112       else if (strcmp (&quot;--GTestSubprocess&quot;, argv[i]) == 0)
1113         {
1114           test_in_subprocess = TRUE;
1115           /* We typically expect these child processes to crash, and some
1116            * tests spawn a *lot* of them.  Avoid spamming system crash
1117            * collection programs such as systemd-coredump and abrt.
1118            */
1119 #ifdef HAVE_SYS_RESOURCE_H
1120           {
1121             struct rlimit limit = { 0, 0 };
1122             (void) setrlimit (RLIMIT_CORE, &amp;limit);
1123           }
1124 #endif
1125           argv[i] = NULL;




1126         }
1127       else if (strcmp (&quot;-p&quot;, argv[i]) == 0 || strncmp (&quot;-p=&quot;, argv[i], 3) == 0)
1128         {
1129           gchar *equal = argv[i] + 2;
1130           if (*equal == &#39;=&#39;)
1131             test_paths = g_slist_prepend (test_paths, equal + 1);
1132           else if (i + 1 &lt; argc)
1133             {
1134               argv[i++] = NULL;
1135               test_paths = g_slist_prepend (test_paths, argv[i]);
1136             }
1137           argv[i] = NULL;
1138         }
1139       else if (strcmp (&quot;-s&quot;, argv[i]) == 0 || strncmp (&quot;-s=&quot;, argv[i], 3) == 0)
1140         {
1141           gchar *equal = argv[i] + 2;
1142           if (*equal == &#39;=&#39;)
1143             test_paths_skipped = g_slist_prepend (test_paths_skipped, equal + 1);
1144           else if (i + 1 &lt; argc)
1145             {
</pre>
<hr />
<pre>
1213         {
1214           printf (&quot;Usage:\n&quot;
1215                   &quot;  %s [OPTION...]\n\n&quot;
1216                   &quot;Help Options:\n&quot;
1217                   &quot;  -h, --help                     Show help options\n\n&quot;
1218                   &quot;Test Options:\n&quot;
1219                   &quot;  --g-fatal-warnings             Make all warnings fatal\n&quot;
1220                   &quot;  -l                             List test cases available in a test executable\n&quot;
1221                   &quot;  -m {perf|slow|thorough|quick}  Execute tests according to mode\n&quot;
1222                   &quot;  -m {undefined|no-undefined}    Execute tests according to mode\n&quot;
1223                   &quot;  -p TESTPATH                    Only start test cases matching TESTPATH\n&quot;
1224                   &quot;  -s TESTPATH                    Skip all tests matching TESTPATH\n&quot;
1225                   &quot;  --seed=SEEDSTRING              Start tests with random seed SEEDSTRING\n&quot;
1226                   &quot;  --debug-log                    debug test logging output\n&quot;
1227                   &quot;  -q, --quiet                    Run tests quietly\n&quot;
1228                   &quot;  --verbose                      Run tests verbosely\n&quot;,
1229                   argv[0]);
1230           exit (0);
1231         }
1232     }





1233   /* collapse argv */
1234   e = 1;
1235   for (i = 1; i &lt; argc; i++)
1236     if (argv[i])
1237       {
1238         argv[e++] = argv[i];
1239         if (i &gt;= e)
1240           argv[i] = NULL;
1241       }
1242   *argc_p = e;
1243 }
1244 






























































































































1245 /**
1246  * g_test_init:
1247  * @argc: Address of the @argc parameter of the main() function.
1248  *        Changed if any arguments were handled.
1249  * @argv: Address of the @argv parameter of main().
1250  *        Any parameters understood by g_test_init() stripped before return.
<span class="line-modified">1251  * @...: %NULL-terminated list of special options. Currently the only</span>
<span class="line-removed">1252  *       defined option is `&quot;no_g_set_prgname&quot;`, which</span>
<span class="line-removed">1253  *       will cause g_test_init() to not call g_set_prgname().</span>
1254  *
1255  * Initialize the GLib testing framework, e.g. by seeding the
1256  * test random number generator, the name for g_get_prgname()
1257  * and parsing test related command line args.
1258  *
1259  * So far, the following arguments are understood:
1260  *
1261  * - `-l`: List test cases available in a test executable.
1262  * - `--seed=SEED`: Provide a random seed to reproduce test
1263  *   runs using random numbers.
1264  * - `--verbose`: Run tests verbosely.
1265  * - `-q`, `--quiet`: Run tests quietly.
1266  * - `-p PATH`: Execute all tests matching the given path.
1267  * - `-s PATH`: Skip all tests matching the given path.
1268  *   This can also be used to force a test to run that would otherwise
1269  *   be skipped (ie, a test whose name contains &quot;/subprocess&quot;).
1270  * - `-m {perf|slow|thorough|quick|undefined|no-undefined}`: Execute tests according to these test modes:
1271  *
1272  *   `perf`: Performance tests, may take long and report results (off by default).
1273  *
1274  *   `slow`, `thorough`: Slow and thorough tests, may take quite long and maximize coverage
1275  *   (off by default).
1276  *
1277  *   `quick`: Quick tests, should run really quickly and give good coverage (the default).
1278  *
1279  *   `undefined`: Tests for undefined behaviour, may provoke programming errors
1280  *   under g_test_trap_subprocess() or g_test_expect_message() to check
1281  *   that appropriate assertions or warnings are given (the default).
1282  *
1283  *   `no-undefined`: Avoid tests for undefined behaviour
1284  *
1285  * - `--debug-log`: Debug test logging output.
1286  *








1287  * Since 2.58, if tests are compiled with `G_DISABLE_ASSERT` defined,
1288  * g_test_init() will print an error and exit. This is to prevent no-op tests
1289  * from being executed, as g_assert() is commonly (erroneously) used in unit
1290  * tests, and is a no-op when compiled with `G_DISABLE_ASSERT`. Ensure your
1291  * tests are compiled without `G_DISABLE_ASSERT` defined.
1292  *
1293  * Since: 2.16
1294  */
1295 void
1296 (g_test_init) (int    *argc,
1297                char ***argv,
1298                ...)
1299 {
1300   static char seedstr[4 + 4 * 8 + 1];
1301   va_list args;
1302   gpointer option;
1303   /* make warnings and criticals fatal for all test programs */
1304   GLogLevelFlags fatal_mask = (GLogLevelFlags) g_log_set_always_fatal ((GLogLevelFlags) G_LOG_FATAL_MASK);
1305 
1306   fatal_mask = (GLogLevelFlags) (fatal_mask | G_LOG_LEVEL_WARNING | G_LOG_LEVEL_CRITICAL);
1307   g_log_set_always_fatal (fatal_mask);
1308   /* check caller args */
1309   g_return_if_fail (argc != NULL);
1310   g_return_if_fail (argv != NULL);
1311   g_return_if_fail (g_test_config_vars-&gt;test_initialized == FALSE);
1312   mutable_test_config_vars.test_initialized = TRUE;
1313 
1314   va_start (args, argv);
1315   while ((option = va_arg (args, char *)))
1316     {
1317       if (g_strcmp0 (option, &quot;no_g_set_prgname&quot;) == 0)
1318         no_g_set_prgname = TRUE;


1319     }
1320   va_end (args);
1321 
1322   /* setup random seed string */
1323   g_snprintf (seedstr, sizeof (seedstr), &quot;R02S%08x%08x%08x%08x&quot;, g_random_int(), g_random_int(), g_random_int(), g_random_int());
1324   test_run_seedstr = seedstr;
1325 
1326   /* parse args, sets up mode, changes seed, etc. */
1327   parse_args (argc, argv);
1328 
1329   if (!g_get_prgname() &amp;&amp; !no_g_set_prgname)
1330     g_set_prgname ((*argv)[0]);
1331 
<span class="line-modified">1332   /* sanity check */</span>
<span class="line-modified">1333   if (test_tap_log)</span>











1334     {
<span class="line-modified">1335       if (test_paths || test_startup_skip_count)</span>
1336         {
<span class="line-modified">1337           /* Not invoking every test (even if SKIPped) breaks the &quot;1..XX&quot; plan */</span>
<span class="line-modified">1338           g_printerr (&quot;%s: -p and --GTestSkipCount options are incompatible with --tap\n&quot;,</span>
<span class="line-modified">1339                       (*argv)[0]);</span>
<span class="line-modified">1340           exit (1);</span>













































1341         }



1342     }
1343 
1344   /* verify GRand reliability, needed for reliable seeds */
1345   if (1)
1346     {
1347       GRand *rg = g_rand_new_with_seed (0xc8c49fb6);
1348       guint32 t1 = g_rand_int (rg), t2 = g_rand_int (rg), t3 = g_rand_int (rg), t4 = g_rand_int (rg);
1349       /* g_print (&quot;GRand-current: 0x%x 0x%x 0x%x 0x%x\n&quot;, t1, t2, t3, t4); */
1350       if (t1 != 0xfab39f9b || t2 != 0xb948fb0e || t3 != 0x3d31be26 || t4 != 0x43a19d66)
1351         g_warning (&quot;random numbers are not GRand-2.2 compatible, seeds may be broken (check $G_RANDOM_VERSION)&quot;);
1352       g_rand_free (rg);
1353     }
1354 
1355   /* check rand seed */
1356   test_run_seed (test_run_seedstr);
1357 
1358   /* report program start */
1359   g_log_set_default_handler (gtest_default_log_handler, NULL);
1360   g_test_log (G_TEST_LOG_START_BINARY, g_get_prgname(), test_run_seedstr, 0, NULL);
1361 
</pre>
<hr />
<pre>
1420 /**
1421  * g_test_rand_int:
1422  *
1423  * Get a reproducible random integer number.
1424  *
1425  * The random numbers generated by the g_test_rand_*() family of functions
1426  * change with every new test program start, unless the --seed option is
1427  * given when starting test programs.
1428  *
1429  * For individual test cases however, the random number generator is
1430  * reseeded, to avoid dependencies between tests and to make --seed
1431  * effective for all test cases.
1432  *
1433  * Returns: a random number from the seeded random number generator.
1434  *
1435  * Since: 2.16
1436  */
1437 gint32
1438 g_test_rand_int (void)
1439 {
<span class="line-modified">1440   return g_rand_int (test_run_rand);</span>






1441 }
1442 
1443 /**
1444  * g_test_rand_int_range:
1445  * @begin: the minimum value returned by this function
1446  * @end:   the smallest value not to be returned by this function
1447  *
1448  * Get a reproducible random integer number out of a specified range,
1449  * see g_test_rand_int() for details on test case random numbers.
1450  *
1451  * Returns: a number with @begin &lt;= number &lt; @end.
1452  *
1453  * Since: 2.16
1454  */
1455 gint32
1456 g_test_rand_int_range (gint32          begin,
1457                        gint32          end)
1458 {
<span class="line-modified">1459   return g_rand_int_range (test_run_rand, begin, end);</span>






1460 }
1461 
1462 /**
1463  * g_test_rand_double:
1464  *
1465  * Get a reproducible random floating point number,
1466  * see g_test_rand_int() for details on test case random numbers.
1467  *
1468  * Returns: a random number from the seeded random number generator.
1469  *
1470  * Since: 2.16
1471  */
1472 double
1473 g_test_rand_double (void)
1474 {
<span class="line-modified">1475   return g_rand_double (test_run_rand);</span>






1476 }
1477 
1478 /**
1479  * g_test_rand_double_range:
1480  * @range_start: the minimum value returned by this function
1481  * @range_end: the minimum value not returned by this function
1482  *
1483  * Get a reproducible random floating pointer number out of a specified range,
1484  * see g_test_rand_int() for details on test case random numbers.
1485  *
1486  * Returns: a number with @range_start &lt;= number &lt; @range_end.
1487  *
1488  * Since: 2.16
1489  */
1490 double
1491 g_test_rand_double_range (double          range_start,
1492                           double          range_end)
1493 {
<span class="line-modified">1494   return g_rand_double_range (test_run_rand, range_start, range_end);</span>






1495 }
1496 
1497 /**
1498  * g_test_timer_start:
1499  *
1500  * Start a timing test. Call g_test_timer_elapsed() when the task is supposed
1501  * to be done. Call this function again to restart the timer.
1502  *
1503  * Since: 2.16
1504  */
1505 void
1506 g_test_timer_start (void)
1507 {
1508   if (!test_user_timer)
1509     test_user_timer = g_timer_new();
1510   test_user_stamp = 0;
1511   g_timer_start (test_user_timer);
1512 }
1513 
1514 /**
</pre>
<hr />
<pre>
1627   g_test_log (G_TEST_LOG_MESSAGE, buffer, NULL, 0, NULL);
1628   g_free (buffer);
1629 }
1630 
1631 /**
1632  * g_test_bug_base:
1633  * @uri_pattern: the base pattern for bug URIs
1634  *
1635  * Specify the base URI for bug reports.
1636  *
1637  * The base URI is used to construct bug report messages for
1638  * g_test_message() when g_test_bug() is called.
1639  * Calling this function outside of a test case sets the
1640  * default base URI for all test cases. Calling it from within
1641  * a test case changes the base URI for the scope of the test
1642  * case only.
1643  * Bug URIs are constructed by appending a bug specific URI
1644  * portion to @uri_pattern, or by replacing the special string
1645  * &#39;\%s&#39; within @uri_pattern if that is present.
1646  *



1647  * Since: 2.16
1648  */
1649 void
1650 g_test_bug_base (const char *uri_pattern)
1651 {
1652   g_free (test_uri_base);
1653   test_uri_base = g_strdup (uri_pattern);
1654 }
1655 
1656 /**
1657  * g_test_bug:
1658  * @bug_uri_snippet: Bug specific bug tracker URI portion.
1659  *
1660  * This function adds a message to test reports that
1661  * associates a bug URI with a test case.
1662  * Bug URIs are constructed from a base URI set with g_test_bug_base()
<span class="line-modified">1663  * and @bug_uri_snippet.</span>


1664  *
1665  * Since: 2.16

1666  */
1667 void
1668 g_test_bug (const char *bug_uri_snippet)
1669 {
<span class="line-modified">1670   char *c;</span>
1671 
<span class="line-removed">1672   g_return_if_fail (test_uri_base != NULL);</span>
1673   g_return_if_fail (bug_uri_snippet != NULL);
1674 
<span class="line-modified">1675   c = strstr (test_uri_base, &quot;%s&quot;);</span>

1676   if (c)
1677     {
1678       char *b = g_strndup (test_uri_base, c - test_uri_base);
1679       char *s = g_strconcat (b, bug_uri_snippet, c + 2, NULL);
1680       g_free (b);
1681       g_test_message (&quot;Bug Reference: %s&quot;, s);
1682       g_free (s);
1683     }
1684   else
<span class="line-modified">1685     g_test_message (&quot;Bug Reference: %s%s&quot;, test_uri_base, bug_uri_snippet);</span>





































1686 }
1687 
1688 /**
1689  * g_test_get_root:
1690  *
1691  * Get the toplevel test suite for the test path API.
1692  *
1693  * Returns: the toplevel #GTestSuite
1694  *
1695  * Since: 2.16
1696  */
1697 GTestSuite*
1698 g_test_get_root (void)
1699 {
1700   if (!test_suite_root)
1701     {
1702       test_suite_root = g_test_create_suite (&quot;root&quot;);
1703       g_free (test_suite_root-&gt;name);
1704       test_suite_root-&gt;name = g_strdup (&quot;&quot;);
1705     }
</pre>
<hr />
<pre>
1738  * on the order that tests are run in. If you need to ensure that some
1739  * particular code runs before or after a given test case, use
1740  * g_test_add(), which lets you specify setup and teardown functions.
1741  *
1742  * If all tests are skipped or marked as incomplete (expected failures),
1743  * this function will return 0 if producing TAP output, or 77 (treated
1744  * as &quot;skip test&quot; by Automake) otherwise.
1745  *
1746  * Returns: 0 on success, 1 on failure (assuming it returns at all),
1747  *   0 or 77 if all tests were skipped with g_test_skip() and/or
1748  *   g_test_incomplete()
1749  *
1750  * Since: 2.16
1751  */
1752 int
1753 g_test_run (void)
1754 {
1755   if (g_test_run_suite (g_test_get_root()) != 0)
1756     return 1;
1757 








1758   /* 77 is special to Automake&#39;s default driver, but not Automake&#39;s TAP driver
1759    * or Perl&#39;s prove(1) TAP driver. */
1760   if (test_tap_log)
1761     return 0;
1762 
1763   if (test_run_count &gt; 0 &amp;&amp; test_run_count == test_skipped_count)
1764     return 77;
1765   else
1766     return 0;
1767 }
1768 
1769 /**
1770  * g_test_create_case:
1771  * @test_name:     the name for the test case
1772  * @data_size:     the size of the fixture data structure
1773  * @test_data:     test data argument for the test functions
1774  * @data_setup:    (scope async): the function to set up the fixture data
1775  * @data_test:     (scope async): the actual test function
1776  * @data_teardown: (scope async): the function to teardown the fixture data
1777  *
</pre>
<hr />
<pre>
1854  * test framework, of the size requested.  If the requested size was
1855  * zero then @fixture will be equal to @user_data.
1856  *
1857  * Since: 2.28
1858  */
1859 void
1860 g_test_add_vtable (const char       *testpath,
1861                    gsize             data_size,
1862                    gconstpointer     test_data,
1863                    GTestFixtureFunc  data_setup,
1864                    GTestFixtureFunc  fixture_test_func,
1865                    GTestFixtureFunc  data_teardown)
1866 {
1867   gchar **segments;
1868   guint ui;
1869   GTestSuite *suite;
1870 
1871   g_return_if_fail (testpath != NULL);
1872   g_return_if_fail (g_path_is_absolute (testpath));
1873   g_return_if_fail (fixture_test_func != NULL);

1874 
1875   suite = g_test_get_root();
1876   segments = g_strsplit (testpath, &quot;/&quot;, -1);
1877   for (ui = 0; segments[ui] != NULL; ui++)
1878     {
1879       const char *seg = segments[ui];
1880       gboolean islast = segments[ui + 1] == NULL;
1881       if (islast &amp;&amp; !seg[0])
1882         g_error (&quot;invalid test case path: %s&quot;, testpath);
1883       else if (!seg[0])
1884         continue;       /* initial or duplicate slash */
1885       else if (!islast)
1886         {
1887           GSList *l;
1888           GTestSuite *csuite;
1889           l = g_slist_find_custom (suite-&gt;suites, seg, find_suite);
1890           if (l)
1891             {
1892               csuite = l-&gt;data;
1893             }
</pre>
<hr />
<pre>
2042  *
2043  * The type used for test case functions.
2044  *
2045  * Since: 2.28
2046  */
2047 
2048 /**
2049  * g_test_add_func:
2050  * @testpath:  /-separated test case path name for the test.
2051  * @test_func: (scope async):  The test function to invoke for this test.
2052  *
2053  * Create a new test case, similar to g_test_create_case(). However
2054  * the test is assumed to use no fixture, and test suites are automatically
2055  * created on the fly and added to the root fixture, based on the
2056  * slash-separated portions of @testpath.
2057  *
2058  * If @testpath includes the component &quot;subprocess&quot; anywhere in it,
2059  * the test will be skipped by default, and only run if explicitly
2060  * required via the `-p` command-line option or g_test_trap_subprocess().
2061  *




2062  * Since: 2.16
2063  */
2064 void
2065 g_test_add_func (const char *testpath,
2066                  GTestFunc   test_func)
2067 {
2068   g_return_if_fail (testpath != NULL);
2069   g_return_if_fail (testpath[0] == &#39;/&#39;);
2070   g_return_if_fail (test_func != NULL);
2071   g_test_add_vtable (testpath, 0, NULL, NULL, (GTestFixtureFunc) test_func, NULL);
2072 }
2073 
2074 /**
2075  * GTestDataFunc:
2076  * @user_data: the data provided when registering the test
2077  *
2078  * The type used for test case functions that take an extra pointer
2079  * argument.
2080  *
2081  * Since: 2.28
2082  */
2083 
2084 /**
2085  * g_test_add_data_func:
2086  * @testpath:  /-separated test case path name for the test.
2087  * @test_data: Test data argument for the test function.
2088  * @test_func: (scope async): The test function to invoke for this test.
2089  *
2090  * Create a new test case, similar to g_test_create_case(). However
2091  * the test is assumed to use no fixture, and test suites are automatically
2092  * created on the fly and added to the root fixture, based on the
2093  * slash-separated portions of @testpath. The @test_data argument
2094  * will be passed as first argument to @test_func.
2095  *
2096  * If @testpath includes the component &quot;subprocess&quot; anywhere in it,
2097  * the test will be skipped by default, and only run if explicitly
2098  * required via the `-p` command-line option or g_test_trap_subprocess().
2099  *




2100  * Since: 2.16
2101  */
2102 void
2103 g_test_add_data_func (const char     *testpath,
2104                       gconstpointer   test_data,
2105                       GTestDataFunc   test_func)
2106 {
2107   g_return_if_fail (testpath != NULL);
2108   g_return_if_fail (testpath[0] == &#39;/&#39;);
2109   g_return_if_fail (test_func != NULL);
2110 
2111   g_test_add_vtable (testpath, 0, test_data, NULL, (GTestFixtureFunc) test_func, NULL);
2112 }
2113 
2114 /**
2115  * g_test_add_data_func_full:
2116  * @testpath: /-separated test case path name for the test.
2117  * @test_data: Test data argument for the test function.
2118  * @test_func: The test function to invoke for this test.
2119  * @data_free_func: #GDestroyNotify for @test_data.
</pre>
<hr />
<pre>
2293     g_test_log (G_TEST_LOG_SKIP_CASE, test_run_name, NULL, 0, NULL);
2294   else if (test_run_list)
2295     {
2296       g_print (&quot;%s\n&quot;, test_run_name);
2297       g_test_log (G_TEST_LOG_LIST_CASE, test_run_name, NULL, 0, NULL);
2298     }
2299   else
2300     {
2301       GTimer *test_run_timer = g_timer_new();
2302       long double largs[3];
2303       void *fixture;
2304       g_test_log (G_TEST_LOG_START_CASE, test_run_name, NULL, 0, NULL);
2305       test_run_forks = 0;
2306       test_run_success = G_TEST_RUN_SUCCESS;
2307       g_clear_pointer (&amp;test_run_msg, g_free);
2308       g_test_log_set_fatal_handler (NULL, NULL);
2309       if (test_paths_skipped &amp;&amp; g_slist_find_custom (test_paths_skipped, test_run_name, (GCompareFunc)g_strcmp0))
2310         g_test_skip (&quot;by request (-s option)&quot;);
2311       else
2312         {
<span class="line-modified">2313           g_timer_start (test_run_timer);</span>
<span class="line-modified">2314           fixture = tc-&gt;fixture_size ? g_malloc0 (tc-&gt;fixture_size) : tc-&gt;test_data;</span>
<span class="line-modified">2315           test_run_seed (test_run_seedstr);</span>
<span class="line-modified">2316           if (tc-&gt;fixture_setup)</span>
<span class="line-modified">2317             tc-&gt;fixture_setup (fixture, tc-&gt;test_data);</span>
<span class="line-modified">2318           tc-&gt;fixture_test (fixture, tc-&gt;test_data);</span>
<span class="line-modified">2319           test_trap_clear();</span>
<span class="line-modified">2320           while (test_destroy_queue)</span>

2321             {
<span class="line-modified">2322               DestroyEntry *dentry = test_destroy_queue;</span>
<span class="line-modified">2323               test_destroy_queue = dentry-&gt;next;</span>
<span class="line-modified">2324               dentry-&gt;destroy_func (dentry-&gt;destroy_data);</span>
<span class="line-modified">2325               g_slice_free (DestroyEntry, dentry);</span>















2326             }
<span class="line-modified">2327           if (tc-&gt;fixture_teardown)</span>
<span class="line-modified">2328             tc-&gt;fixture_teardown (fixture, tc-&gt;test_data);</span>
<span class="line-removed">2329           if (tc-&gt;fixture_size)</span>
<span class="line-removed">2330             g_free (fixture);</span>
<span class="line-removed">2331           g_timer_stop (test_run_timer);</span>
2332         }
2333       success = test_run_success;
2334       test_run_success = G_TEST_RUN_FAILURE;
2335       largs[0] = success; /* OK */
2336       largs[1] = test_run_forks;
2337       largs[2] = g_timer_elapsed (test_run_timer, NULL);
2338       g_test_log (G_TEST_LOG_STOP_CASE, test_run_name, test_run_msg, G_N_ELEMENTS (largs), largs);
2339       g_clear_pointer (&amp;test_run_msg, g_free);
2340       g_timer_destroy (test_run_timer);
2341     }
2342 
2343   g_slist_free_full (filename_free_list, g_free);
2344   test_filename_free_list = old_free_list;
2345   g_free (test_uri_base);
2346   test_uri_base = old_base;
2347 
2348   return (success == G_TEST_RUN_SUCCESS ||
2349           success == G_TEST_RUN_SKIPPED ||
2350           success == G_TEST_RUN_INCOMPLETE);
2351 }
</pre>
<hr />
<pre>
2581     free (__glib_assert_msg);
2582   __glib_assert_msg = (char*) malloc (strlen (s) + 1);
2583   strcpy (__glib_assert_msg, s);
2584 
2585   g_free (s);
2586 
2587   if (test_in_subprocess)
2588     {
2589       /* If this is a test case subprocess then it probably hit this
2590        * assertion on purpose, so just exit() rather than abort()ing,
2591        * to avoid triggering any system crash-reporting daemon.
2592        */
2593       _exit (1);
2594     }
2595   else
2596     g_abort ();
2597 }
2598 
2599 /**
2600  * g_assertion_message_expr: (skip)
<span class="line-modified">2601  * @domain: (nullable):</span>
<span class="line-modified">2602  * @file:</span>
<span class="line-modified">2603  * @line:</span>
<span class="line-modified">2604  * @func:</span>
<span class="line-modified">2605  * @expr: (nullable):</span>



2606  */
2607 void
2608 g_assertion_message_expr (const char     *domain,
2609                           const char     *file,
2610                           int             line,
2611                           const char     *func,
2612                           const char     *expr)
2613 {
2614   char *s;
2615   if (!expr)
2616     s = g_strdup (&quot;code should not be reached&quot;);
2617   else
2618     s = g_strconcat (&quot;assertion failed: (&quot;, expr, &quot;)&quot;, NULL);
2619   g_assertion_message (domain, file, line, func, s);
2620   g_free (s);
2621 
2622   /* Normally g_assertion_message() won&#39;t return, but we need this for
2623    * when test_nonfatal_assertions is set, since
2624    * g_assertion_message_expr() is used for always-fatal assertions.
2625    */
</pre>
<hr />
<pre>
2660                             const char     *func,
2661                             const char     *expr,
2662                             const char     *arg1,
2663                             const char     *cmp,
2664                             const char     *arg2)
2665 {
2666   char *a1, *a2, *s, *t1 = NULL, *t2 = NULL;
2667   a1 = arg1 ? g_strconcat (&quot;\&quot;&quot;, t1 = g_strescape (arg1, NULL), &quot;\&quot;&quot;, NULL) : g_strdup (&quot;NULL&quot;);
2668   a2 = arg2 ? g_strconcat (&quot;\&quot;&quot;, t2 = g_strescape (arg2, NULL), &quot;\&quot;&quot;, NULL) : g_strdup (&quot;NULL&quot;);
2669   g_free (t1);
2670   g_free (t2);
2671   s = g_strdup_printf (&quot;assertion failed (%s): (%s %s %s)&quot;, expr, a1, cmp, a2);
2672   g_free (a1);
2673   g_free (a2);
2674   g_assertion_message (domain, file, line, func, s);
2675   g_free (s);
2676 }
2677 
2678 void
2679 g_assertion_message_error (const char     *domain,
<span class="line-modified">2680                const char     *file,</span>
<span class="line-modified">2681                int             line,</span>
<span class="line-modified">2682                const char     *func,</span>
<span class="line-modified">2683                const char     *expr,</span>
<span class="line-modified">2684                const GError   *error,</span>
<span class="line-modified">2685                GQuark          error_domain,</span>
<span class="line-modified">2686                int             error_code)</span>
2687 {
2688   GString *gstring;
2689 
2690   /* This is used by both g_assert_error() and g_assert_no_error(), so there
2691    * are three cases: expected an error but got the wrong error, expected
2692    * an error but got no error, and expected no error but got an error.
2693    */
2694 
2695   gstring = g_string_new (&quot;assertion failed &quot;);
2696   if (error_domain)
2697       g_string_append_printf (gstring, &quot;(%s == (%s, %d)): &quot;, expr,
<span class="line-modified">2698                   g_quark_to_string (error_domain), error_code);</span>
2699   else
2700     g_string_append_printf (gstring, &quot;(%s == NULL): &quot;, expr);
2701 
2702   if (error)
2703       g_string_append_printf (gstring, &quot;%s (%s, %d)&quot;, error-&gt;message,
<span class="line-modified">2704                   g_quark_to_string (error-&gt;domain), error-&gt;code);</span>
2705   else
2706     g_string_append_printf (gstring, &quot;%s is NULL&quot;, expr);
2707 
2708   g_assertion_message (domain, file, line, func, gstring-&gt;str);
2709   g_string_free (gstring, TRUE);
2710 }
2711 
2712 /**
2713  * g_strcmp0:
2714  * @str1: (nullable): a C string or %NULL
2715  * @str2: (nullable): another C string or %NULL
2716  *
2717  * Compares @str1 and @str2 like strcmp(). Handles %NULL
2718  * gracefully by sorting it before non-%NULL strings.
2719  * Comparing two %NULL pointers returns 0.
2720  *
2721  * Returns: an integer less than, equal to, or greater than zero, if @str1 is &lt;, == or &gt; than @str2.
2722  *
2723  * Since: 2.16
2724  */
</pre>
<hr />
<pre>
2949  *     if (g_test_trap_fork (0, G_TEST_TRAP_SILENCE_STDOUT | G_TEST_TRAP_SILENCE_STDERR))
2950  *       {
2951  *         g_print (&quot;some stdout text: somagic17\n&quot;);
2952  *         g_printerr (&quot;some stderr text: semagic43\n&quot;);
2953  *         exit (0); // successful test run
2954  *       }
2955  *     g_test_trap_assert_passed ();
2956  *     g_test_trap_assert_stdout (&quot;*somagic17*&quot;);
2957  *     g_test_trap_assert_stderr (&quot;*semagic43*&quot;);
2958  *   }
2959  * ]|
2960  *
2961  * Returns: %TRUE for the forked child and %FALSE for the executing parent process.
2962  *
2963  * Since: 2.16
2964  *
2965  * Deprecated: This function is implemented only on Unix platforms,
2966  * and is not always reliable due to problems inherent in
2967  * fork-without-exec. Use g_test_trap_subprocess() instead.
2968  */

2969 gboolean
2970 g_test_trap_fork (guint64        usec_timeout,
2971                   GTestTrapFlags test_trap_flags)
2972 {
2973 #ifdef G_OS_UNIX
2974   int stdout_pipe[2] = { -1, -1 };
2975   int stderr_pipe[2] = { -1, -1 };
2976   int errsv;
2977 
2978   test_trap_clear();
2979   if (pipe (stdout_pipe) &lt; 0 || pipe (stderr_pipe) &lt; 0)
2980     {
2981       errsv = errno;
2982       g_error (&quot;failed to create pipes to fork test program: %s&quot;, g_strerror (errsv));
2983     }
2984   test_trap_last_pid = fork ();
2985   errsv = errno;
2986   if (test_trap_last_pid &lt; 0)
2987     g_error (&quot;failed to fork test program: %s&quot;, g_strerror (errsv));
2988   if (test_trap_last_pid == 0)  /* child */
</pre>
<hr />
<pre>
2991       test_in_forked_child = TRUE;
2992       close (stdout_pipe[0]);
2993       close (stderr_pipe[0]);
2994       if (!(test_trap_flags &amp; G_TEST_TRAP_INHERIT_STDIN))
2995         {
2996           fd0 = g_open (&quot;/dev/null&quot;, O_RDONLY, 0);
2997           if (fd0 &lt; 0)
2998             g_error (&quot;failed to open /dev/null for stdin redirection&quot;);
2999         }
3000       if (sane_dup2 (stdout_pipe[1], 1) &lt; 0 || sane_dup2 (stderr_pipe[1], 2) &lt; 0 || (fd0 &gt;= 0 &amp;&amp; sane_dup2 (fd0, 0) &lt; 0))
3001         {
3002           errsv = errno;
3003           g_error (&quot;failed to dup2() in forked test program: %s&quot;, g_strerror (errsv));
3004         }
3005       if (fd0 &gt;= 3)
3006         close (fd0);
3007       if (stdout_pipe[1] &gt;= 3)
3008         close (stdout_pipe[1]);
3009       if (stderr_pipe[1] &gt;= 3)
3010         close (stderr_pipe[1]);












3011       return TRUE;
3012     }
3013   else                          /* parent */
3014     {
3015       test_run_forks++;
3016       close (stdout_pipe[1]);
3017       close (stderr_pipe[1]);
3018 
3019       wait_for_child (test_trap_last_pid,
3020                       stdout_pipe[0], !(test_trap_flags &amp; G_TEST_TRAP_SILENCE_STDOUT),
3021                       stderr_pipe[0], !(test_trap_flags &amp; G_TEST_TRAP_SILENCE_STDERR),
3022                       usec_timeout);
3023       return FALSE;
3024     }
3025 #else
3026   g_message (&quot;Not implemented: g_test_trap_fork&quot;);
3027 
3028   return FALSE;
3029 #endif
3030 }

3031 
3032 /**
3033  * g_test_trap_subprocess:
3034  * @test_path: (nullable): Test to run in a subprocess
3035  * @usec_timeout: Timeout for the subprocess test in micro seconds.
3036  * @test_flags:   Flags to modify subprocess behaviour.
3037  *
3038  * Respawns the test program to run only @test_path in a subprocess.
3039  * This can be used for a test case that might not return, or that
3040  * might abort.
3041  *
3042  * If @test_path is %NULL then the same test is re-run in a subprocess.
3043  * You can use g_test_subprocess() to determine whether the test is in
3044  * a subprocess or not.
3045  *
3046  * @test_path can also be the name of the parent test, followed by
3047  * &quot;`/subprocess/`&quot; and then a name for the specific subtest (or just
3048  * ending with &quot;`/subprocess`&quot; if the test only has one child test);
3049  * tests with names of this form will automatically be skipped in the
3050  * parent process.
</pre>
<hr />
<pre>
3129   test_trap_clear ();
3130   test_trap_last_subprocess = g_strdup (test_path);
3131 
3132   argv = g_ptr_array_new ();
3133   g_ptr_array_add (argv, test_argv0);
3134   g_ptr_array_add (argv, &quot;-q&quot;);
3135   g_ptr_array_add (argv, &quot;-p&quot;);
3136   g_ptr_array_add (argv, (char *)test_path);
3137   g_ptr_array_add (argv, &quot;--GTestSubprocess&quot;);
3138   if (test_log_fd != -1)
3139     {
3140       char log_fd_buf[128];
3141 
3142       g_ptr_array_add (argv, &quot;--GTestLogFD&quot;);
3143       g_snprintf (log_fd_buf, sizeof (log_fd_buf), &quot;%d&quot;, test_log_fd);
3144       g_ptr_array_add (argv, log_fd_buf);
3145     }
3146   g_ptr_array_add (argv, NULL);
3147 
3148   flags = G_SPAWN_DO_NOT_REAP_CHILD;


3149   if (test_flags &amp; G_TEST_TRAP_INHERIT_STDIN)
3150     flags |= G_SPAWN_CHILD_INHERITS_STDIN;
3151 
3152   if (!g_spawn_async_with_pipes (test_initial_cwd,
3153                                  (char **)argv-&gt;pdata,
3154                                  NULL, flags,
3155                                  NULL, NULL,
3156                                  &amp;pid, NULL, &amp;stdout_fd, &amp;stderr_fd,
3157                                  &amp;error))
3158     {
3159       g_error (&quot;g_test_trap_subprocess() failed: %s&quot;,
3160                error-&gt;message);
3161     }
3162   g_ptr_array_free (argv, TRUE);
3163 
3164   wait_for_child (pid,
3165                   stdout_fd, !!(test_flags &amp; G_TEST_SUBPROCESS_INHERIT_STDOUT),
3166                   stderr_fd, !!(test_flags &amp; G_TEST_SUBPROCESS_INHERIT_STDERR),
3167                   usec_timeout);
3168 }
</pre>
<hr />
<pre>
3326       msg = g_strdup_printf (&quot;child process (%s) failed unexpectedly&quot;, process_id);
3327       g_assertion_message (domain, file, line, func, msg);
3328       g_free (msg);
3329     }
3330   if (must_fail &amp;&amp; g_test_trap_has_passed())
3331     {
3332       char *msg;
3333 
3334       logged_child_output = logged_child_output || log_child_output (process_id);
3335 
3336       msg = g_strdup_printf (&quot;child process (%s) did not fail as expected&quot;, process_id);
3337       g_assertion_message (domain, file, line, func, msg);
3338       g_free (msg);
3339     }
3340   if (stdout_pattern &amp;&amp; match_result == !g_pattern_match_simple (stdout_pattern, test_trap_last_stdout))
3341     {
3342       char *msg;
3343 
3344       logged_child_output = logged_child_output || log_child_output (process_id);
3345 
<span class="line-modified">3346       msg = g_strdup_printf (&quot;stdout of child process (%s) %s: %s&quot;, process_id, match_error, stdout_pattern);</span>

3347       g_assertion_message (domain, file, line, func, msg);
3348       g_free (msg);
3349     }
3350   if (stderr_pattern &amp;&amp; match_result == !g_pattern_match_simple (stderr_pattern, test_trap_last_stderr))
3351     {
3352       char *msg;
3353 
3354       logged_child_output = logged_child_output || log_child_output (process_id);
3355 
<span class="line-modified">3356       msg = g_strdup_printf (&quot;stderr of child process (%s) %s: %s&quot;, process_id, match_error, stderr_pattern);</span>

3357       g_assertion_message (domain, file, line, func, msg);
3358       g_free (msg);
3359     }
3360   g_free (process_id);
3361 }
3362 
3363 static void
3364 gstring_overwrite_int (GString *gstring,
3365                        guint    pos,
3366                        guint32  vuint)
3367 {
3368   vuint = g_htonl (vuint);
3369   g_string_overwrite_len (gstring, pos, (const gchar*) &amp;vuint, 4);
3370 }
3371 
3372 static void
3373 gstring_append_int (GString *gstring,
3374                     guint32  vuint)
3375 {
3376   vuint = g_htonl (vuint);
</pre>
<hr />
<pre>
3545 /**
3546  * g_test_log_msg_free:
3547  *
3548  * Internal function for gtester to free test log messages, no ABI guarantees provided.
3549  */
3550 void
3551 g_test_log_msg_free (GTestLogMsg *tmsg)
3552 {
3553   g_return_if_fail (tmsg != NULL);
3554   g_strfreev (tmsg-&gt;strings);
3555   g_free (tmsg-&gt;nums);
3556   g_free (tmsg);
3557 }
3558 
3559 static gchar *
3560 g_test_build_filename_va (GTestFileType  file_type,
3561                           const gchar   *first_path,
3562                           va_list        ap)
3563 {
3564   const gchar *pathv[16];
<span class="line-modified">3565   gint num_path_segments;</span>
3566 
3567   if (file_type == G_TEST_DIST)
3568     pathv[0] = test_disted_files_dir;
3569   else if (file_type == G_TEST_BUILT)
3570     pathv[0] = test_built_files_dir;
3571   else
3572     g_assert_not_reached ();
3573 
3574   pathv[1] = first_path;
3575 
3576   for (num_path_segments = 2; num_path_segments &lt; G_N_ELEMENTS (pathv); num_path_segments++)
3577     {
3578       pathv[num_path_segments] = va_arg (ap, const char *);
3579       if (pathv[num_path_segments] == NULL)
3580         break;
3581     }
3582 
3583   g_assert_cmpint (num_path_segments, &lt;, G_N_ELEMENTS (pathv));
3584 
3585   return g_build_filenamev ((gchar **) pathv);
</pre>
<hr />
<pre>
3718 {
3719   gchar *result;
3720   GSList *node;
3721   va_list ap;
3722 
3723   g_assert (g_test_initialized ());
3724   if (test_filename_free_list == NULL)
3725     g_error (&quot;g_test_get_filename() can only be used within testcase functions&quot;);
3726 
3727   va_start (ap, first_path);
3728   result = g_test_build_filename_va (file_type, first_path, ap);
3729   va_end (ap);
3730 
3731   node = g_slist_prepend (NULL, result);
3732   do
3733     node-&gt;next = *test_filename_free_list;
3734   while (!g_atomic_pointer_compare_and_exchange (test_filename_free_list, node-&gt;next, node));
3735 
3736   return result;
3737 }
<span class="line-removed">3738 </span>
<span class="line-removed">3739 /* --- macros docs START --- */</span>
<span class="line-removed">3740 /**</span>
<span class="line-removed">3741  * g_test_add:</span>
<span class="line-removed">3742  * @testpath:  The test path for a new test case.</span>
<span class="line-removed">3743  * @Fixture:   The type of a fixture data structure.</span>
<span class="line-removed">3744  * @tdata:     Data argument for the test functions.</span>
<span class="line-removed">3745  * @fsetup:    The function to set up the fixture data.</span>
<span class="line-removed">3746  * @ftest:     The actual test function.</span>
<span class="line-removed">3747  * @fteardown: The function to tear down the fixture data.</span>
<span class="line-removed">3748  *</span>
<span class="line-removed">3749  * Hook up a new test case at @testpath, similar to g_test_add_func().</span>
<span class="line-removed">3750  * A fixture data structure with setup and teardown functions may be provided,</span>
<span class="line-removed">3751  * similar to g_test_create_case().</span>
<span class="line-removed">3752  *</span>
<span class="line-removed">3753  * g_test_add() is implemented as a macro, so that the fsetup(), ftest() and</span>
<span class="line-removed">3754  * fteardown() callbacks can expect a @Fixture pointer as their first argument</span>
<span class="line-removed">3755  * in a type safe manner. They otherwise have type #GTestFixtureFunc.</span>
<span class="line-removed">3756  *</span>
<span class="line-removed">3757  * Since: 2.16</span>
<span class="line-removed">3758  **/</span>
<span class="line-removed">3759 /* --- macros docs END --- */</span>
</pre>
</td>
<td>
<hr />
<pre>
  10  * This library is distributed in the hope that it will be useful,
  11  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  12  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
  13  * Lesser General Public License for more details.
  14  *
  15  * You should have received a copy of the GNU Lesser General Public
  16  * License along with this library; if not, see &lt;http://www.gnu.org/licenses/&gt;.
  17  */
  18 
  19 #include &quot;config.h&quot;
  20 
  21 #include &quot;gtestutils.h&quot;
  22 #include &quot;gfileutils.h&quot;
  23 
  24 #include &lt;sys/types.h&gt;
  25 #ifdef G_OS_UNIX
  26 #include &lt;sys/wait.h&gt;
  27 #include &lt;sys/time.h&gt;
  28 #include &lt;fcntl.h&gt;
  29 #include &lt;unistd.h&gt;

  30 #endif
  31 #include &lt;string.h&gt;
  32 #include &lt;stdlib.h&gt;
  33 #include &lt;stdio.h&gt;
  34 #ifdef HAVE_SYS_RESOURCE_H
  35 #include &lt;sys/resource.h&gt;
  36 #endif
  37 #ifdef G_OS_WIN32
  38 #include &lt;io.h&gt;
  39 #include &lt;windows.h&gt;
  40 #endif
  41 #include &lt;errno.h&gt;
  42 #include &lt;signal.h&gt;
  43 #ifdef HAVE_SYS_SELECT_H
  44 #include &lt;sys/select.h&gt;
  45 #endif /* HAVE_SYS_SELECT_H */
<span class="line-added">  46 #include &lt;glib/gstdio.h&gt;</span>
  47 
  48 #include &quot;gmain.h&quot;
  49 #include &quot;gpattern.h&quot;
  50 #include &quot;grand.h&quot;
  51 #include &quot;gstrfuncs.h&quot;
  52 #include &quot;gtimer.h&quot;
  53 #include &quot;gslice.h&quot;
  54 #include &quot;gspawn.h&quot;
  55 #include &quot;glib-private.h&quot;
<span class="line-added">  56 #include &quot;gutilsprivate.h&quot;</span>
  57 
  58 
  59 /**
  60  * SECTION:testing
  61  * @title: Testing
  62  * @short_description: a test framework

  63  *
  64  * GLib provides a framework for writing and maintaining unit tests
  65  * in parallel to the code they are testing. The API is designed according
  66  * to established concepts found in the other test frameworks (JUnit, NUnit,
  67  * RUnit), which in turn is based on smalltalk unit testing concepts.
  68  *
  69  * - Test case: Tests (test methods) are grouped together with their
  70  *   fixture into test cases.
  71  *
  72  * - Fixture: A test fixture consists of fixture data and setup and
  73  *   teardown methods to establish the environment for the test
  74  *   functions. We use fresh fixtures, i.e. fixtures are newly set
  75  *   up and torn down around each test invocation to avoid dependencies
  76  *   between tests.
  77  *
  78  * - Test suite: Test cases can be grouped into test suites, to allow
  79  *   subsets of the available tests to be run. Test suites can be
  80  *   grouped into other test suites as well.
  81  *
  82  * The API is designed to handle creation and registration of test suites
  83  * and test cases implicitly. A simple call like
  84  * |[&lt;!-- language=&quot;C&quot; --&gt;
  85  *   g_test_add_func (&quot;/misc/assertions&quot;, test_assertions);
  86  * ]|
  87  * creates a test suite called &quot;misc&quot; with a single test case named
  88  * &quot;assertions&quot;, which consists of running the test_assertions function.
  89  *
  90  * In addition to the traditional g_assert_true(), the test framework provides
  91  * an extended set of assertions for comparisons: g_assert_cmpfloat(),
  92  * g_assert_cmpfloat_with_epsilon(), g_assert_cmpint(), g_assert_cmpuint(),
<span class="line-modified">  93  * g_assert_cmphex(), g_assert_cmpstr(), g_assert_cmpmem() and</span>
<span class="line-added">  94  * g_assert_cmpvariant(). The</span>
  95  * advantage of these variants over plain g_assert_true() is that the assertion
  96  * messages can be more elaborate, and include the values of the compared
  97  * entities.
  98  *
  99  * Note that g_assert() should not be used in unit tests, since it is a no-op
 100  * when compiling with `G_DISABLE_ASSERT`. Use g_assert() in production code,
 101  * and g_assert_true() in unit tests.
 102  *
 103  * A full example of creating a test suite with two tests using fixtures:
 104  * |[&lt;!-- language=&quot;C&quot; --&gt;
 105  * #include &lt;glib.h&gt;
 106  * #include &lt;locale.h&gt;
 107  *
 108  * typedef struct {
 109  *   MyObject *obj;
 110  *   OtherObject *helper;
 111  * } MyObjectFixture;
 112  *
 113  * static void
 114  * my_object_fixture_set_up (MyObjectFixture *fixture,
</pre>
<hr />
<pre>
 133  * test_my_object_test1 (MyObjectFixture *fixture,
 134  *                       gconstpointer user_data)
 135  * {
 136  *   g_assert_cmpstr (my_object_get_property (fixture-&gt;obj), ==, &quot;initial-value&quot;);
 137  * }
 138  *
 139  * static void
 140  * test_my_object_test2 (MyObjectFixture *fixture,
 141  *                       gconstpointer user_data)
 142  * {
 143  *   my_object_do_some_work_using_helper (fixture-&gt;obj, fixture-&gt;helper);
 144  *   g_assert_cmpstr (my_object_get_property (fixture-&gt;obj), ==, &quot;updated-value&quot;);
 145  * }
 146  *
 147  * int
 148  * main (int argc, char *argv[])
 149  * {
 150  *   setlocale (LC_ALL, &quot;&quot;);
 151  *
 152  *   g_test_init (&amp;argc, &amp;argv, NULL);

 153  *
 154  *   // Define the tests.
 155  *   g_test_add (&quot;/my-object/test1&quot;, MyObjectFixture, &quot;some-user-data&quot;,
 156  *               my_object_fixture_set_up, test_my_object_test1,
 157  *               my_object_fixture_tear_down);
 158  *   g_test_add (&quot;/my-object/test2&quot;, MyObjectFixture, &quot;some-user-data&quot;,
 159  *               my_object_fixture_set_up, test_my_object_test2,
 160  *               my_object_fixture_tear_down);
 161  *
 162  *   return g_test_run ();
 163  * }
 164  * ]|
 165  *
 166  * ### Integrating GTest in your project
 167  *
 168  * If you are using the [Meson](http://mesonbuild.com) build system, you will
 169  * typically use the provided `test()` primitive to call the test binaries,
 170  * e.g.:
 171  *
 172  * |[&lt;!-- language=&quot;plain&quot; --&gt;
</pre>
<hr />
<pre>
 176  *     env: [
 177  *       &#39;G_TEST_SRCDIR=@0@&#39;.format(meson.current_source_dir()),
 178  *       &#39;G_TEST_BUILDDIR=@0@&#39;.format(meson.current_build_dir()),
 179  *     ],
 180  *   )
 181  *
 182  *   test(
 183  *     &#39;bar&#39;,
 184  *     executable(&#39;bar&#39;, &#39;bar.c&#39;, dependencies: deps),
 185  *     env: [
 186  *       &#39;G_TEST_SRCDIR=@0@&#39;.format(meson.current_source_dir()),
 187  *       &#39;G_TEST_BUILDDIR=@0@&#39;.format(meson.current_build_dir()),
 188  *     ],
 189  *   )
 190  * ]|
 191  *
 192  * If you are using Autotools, you&#39;re strongly encouraged to use the Automake
 193  * [TAP](https://testanything.org/) harness; GLib provides template files for
 194  * easily integrating with it:
 195  *
<span class="line-modified"> 196  *   - [glib-tap.mk](https://gitlab.gnome.org/GNOME/glib/blob/glib-2-58/glib-tap.mk)</span>
<span class="line-modified"> 197  *   - [tap-test](https://gitlab.gnome.org/GNOME/glib/blob/glib-2-58/tap-test)</span>
<span class="line-modified"> 198  *   - [tap-driver.sh](https://gitlab.gnome.org/GNOME/glib/blob/glib-2-58/tap-driver.sh)</span>
 199  *
 200  * You can copy these files in your own project&#39;s root directory, and then
 201  * set up your `Makefile.am` file to reference them, for instance:
 202  *
 203  * |[&lt;!-- language=&quot;plain&quot; --&gt;
 204  * include $(top_srcdir)/glib-tap.mk
 205  *
 206  * # test binaries
 207  * test_programs = \
 208  *   foo \
 209  *   bar
 210  *
 211  * # data distributed in the tarball
 212  * dist_test_data = \
 213  *   foo.data.txt \
 214  *   bar.data.txt
 215  *
 216  * # data not distributed in the tarball
 217  * test_data = \
 218  *   blah.data.txt
 219  * ]|
 220  *
 221  * Make sure to distribute the TAP files, using something like the following
 222  * in your top-level `Makefile.am`:
 223  *
 224  * |[&lt;!-- language=&quot;plain&quot; --&gt;
 225  * EXTRA_DIST += \
 226  *   tap-driver.sh \
 227  *   tap-test
 228  * ]|
 229  *
 230  * `glib-tap.mk` will be distributed implicitly due to being included in a
 231  * `Makefile.am`. All three files should be added to version control.
 232  *
 233  * If you don&#39;t have access to the Autotools TAP harness, you can use the
 234  * [gtester][gtester] and [gtester-report][gtester-report] tools, and use
<span class="line-modified"> 235  * the [glib.mk](https://gitlab.gnome.org/GNOME/glib/blob/glib-2-58/glib.mk)</span>
<span class="line-modified"> 236  * Automake template provided by GLib. Note, however, that since GLib 2.62,</span>
<span class="line-added"> 237  * [gtester][gtester] and [gtester-report][gtester-report] have been deprecated</span>
<span class="line-added"> 238  * in favour of using TAP. The `--tap` argument to tests is enabled by default</span>
<span class="line-added"> 239  * as of GLib 2.62.</span>
 240  */
 241 
 242 /**
 243  * g_test_initialized:
 244  *
 245  * Returns %TRUE if g_test_init() has been called.
 246  *
 247  * Returns: %TRUE if g_test_init() has been called.
 248  *
 249  * Since: 2.36
 250  */
 251 
 252 /**
 253  * g_test_quick:
 254  *
 255  * Returns %TRUE if tests are run in quick mode.
 256  * Exactly one of g_test_quick() and g_test_slow() is active in any run;
 257  * there is no &quot;medium speed&quot;.
 258  *
 259  * By default, tests are run in quick mode. In tests that use
</pre>
<hr />
<pre>
 331  *
 332  * Returns %TRUE if tests are run in quiet mode.
 333  * In tests that use g_test_init(), the option `-q` or `--quiet` enables
 334  * this, while `--verbose` disables it.
 335  * The default is neither g_test_verbose() nor g_test_quiet().
 336  *
 337  * Returns: %TRUE if in quiet mode
 338  */
 339 
 340 /**
 341  * g_test_queue_unref:
 342  * @gobject: the object to unref
 343  *
 344  * Enqueue an object to be released with g_object_unref() during
 345  * the next teardown phase. This is equivalent to calling
 346  * g_test_queue_destroy() with a destroy callback of g_object_unref().
 347  *
 348  * Since: 2.16
 349  */
 350 






















 351 /**
 352  * GTestSubprocessFlags:
 353  * @G_TEST_SUBPROCESS_INHERIT_STDIN: If this flag is given, the child
 354  *     process will inherit the parent&#39;s stdin. Otherwise, the child&#39;s
 355  *     stdin is redirected to `/dev/null`.
 356  * @G_TEST_SUBPROCESS_INHERIT_STDOUT: If this flag is given, the child
 357  *     process will inherit the parent&#39;s stdout. Otherwise, the child&#39;s
 358  *     stdout will not be visible, but it will be captured to allow
 359  *     later tests with g_test_trap_assert_stdout().
 360  * @G_TEST_SUBPROCESS_INHERIT_STDERR: If this flag is given, the child
 361  *     process will inherit the parent&#39;s stderr. Otherwise, the child&#39;s
 362  *     stderr will not be visible, but it will be captured to allow
 363  *     later tests with g_test_trap_assert_stderr().
 364  *
 365  * Flags to pass to g_test_trap_subprocess() to control input and output.
 366  *
 367  * Note that in contrast with g_test_trap_fork(), the default is to
 368  * not show stdout and stderr.
 369  */
 370 
</pre>
<hr />
<pre>
 539  *
 540  * Debugging macro to check an expression is not %NULL.
 541  *
 542  * If the assertion fails (i.e. the expression is %NULL),
 543  * an error message is logged and the application is either
 544  * terminated or the testcase marked as failed.
 545  *
 546  * Note that unlike g_assert(), this macro is unaffected by whether
 547  * `G_DISABLE_ASSERT` is defined. Hence it should only be used in tests and,
 548  * conversely, g_assert() should not be used in tests.
 549  *
 550  * See g_test_set_nonfatal_assertions().
 551  *
 552  * Since: 2.40
 553  */
 554 
 555 /**
 556  * g_assert_cmpstr:
 557  * @s1: a string (may be %NULL)
 558  * @cmp: The comparison operator to use.
<span class="line-modified"> 559  *     One of `==`, `!=`, `&lt;`, `&gt;`, `&lt;=`, `&gt;=`.</span>
 560  * @s2: another string (may be %NULL)
 561  *
 562  * Debugging macro to compare two strings. If the comparison fails,
 563  * an error message is logged and the application is either terminated
 564  * or the testcase marked as failed.
 565  * The strings are compared using g_strcmp0().
 566  *
 567  * The effect of `g_assert_cmpstr (s1, op, s2)` is
 568  * the same as `g_assert_true (g_strcmp0 (s1, s2) op 0)`.
 569  * The advantage of this macro is that it can produce a message that
 570  * includes the actual values of @s1 and @s2.
 571  *
 572  * |[&lt;!-- language=&quot;C&quot; --&gt;
 573  *   g_assert_cmpstr (mystring, ==, &quot;fubar&quot;);
 574  * ]|
 575  *
 576  * Since: 2.16
 577  */
 578 
 579 /**
 580  * g_assert_cmpint:
 581  * @n1: an integer
 582  * @cmp: The comparison operator to use.
<span class="line-modified"> 583  *     One of `==`, `!=`, `&lt;`, `&gt;`, `&lt;=`, `&gt;=`.</span>
 584  * @n2: another integer
 585  *
 586  * Debugging macro to compare two integers.
 587  *
 588  * The effect of `g_assert_cmpint (n1, op, n2)` is
 589  * the same as `g_assert_true (n1 op n2)`. The advantage
 590  * of this macro is that it can produce a message that includes the
 591  * actual values of @n1 and @n2.
 592  *
 593  * Since: 2.16
 594  */
 595 
 596 /**
 597  * g_assert_cmpuint:
 598  * @n1: an unsigned integer
 599  * @cmp: The comparison operator to use.
<span class="line-modified"> 600  *     One of `==`, `!=`, `&lt;`, `&gt;`, `&lt;=`, `&gt;=`.</span>
 601  * @n2: another unsigned integer
 602  *
 603  * Debugging macro to compare two unsigned integers.
 604  *
 605  * The effect of `g_assert_cmpuint (n1, op, n2)` is
 606  * the same as `g_assert_true (n1 op n2)`. The advantage
 607  * of this macro is that it can produce a message that includes the
 608  * actual values of @n1 and @n2.
 609  *
 610  * Since: 2.16
 611  */
 612 
 613 /**
 614  * g_assert_cmphex:
 615  * @n1: an unsigned integer
 616  * @cmp: The comparison operator to use.
<span class="line-modified"> 617  *     One of `==`, `!=`, `&lt;`, `&gt;`, `&lt;=`, `&gt;=`.</span>
 618  * @n2: another unsigned integer
 619  *
 620  * Debugging macro to compare to unsigned integers.
 621  *
 622  * This is a variant of g_assert_cmpuint() that displays the numbers
 623  * in hexadecimal notation in the message.
 624  *
 625  * Since: 2.16
 626  */
 627 
 628 /**
 629  * g_assert_cmpfloat:
<span class="line-modified"> 630  * @n1: a floating point number</span>
 631  * @cmp: The comparison operator to use.
<span class="line-modified"> 632  *     One of `==`, `!=`, `&lt;`, `&gt;`, `&lt;=`, `&gt;=`.</span>
 633  * @n2: another floating point number
 634  *
 635  * Debugging macro to compare two floating point numbers.
 636  *
 637  * The effect of `g_assert_cmpfloat (n1, op, n2)` is
 638  * the same as `g_assert_true (n1 op n2)`. The advantage
 639  * of this macro is that it can produce a message that includes the
 640  * actual values of @n1 and @n2.
 641  *
 642  * Since: 2.16
 643  */
 644 
 645 /**
 646  * g_assert_cmpfloat_with_epsilon:
<span class="line-modified"> 647  * @n1: a floating point number</span>
 648  * @n2: another floating point number
 649  * @epsilon: a numeric value that expresses the expected tolerance
 650  *   between @n1 and @n2
 651  *
 652  * Debugging macro to compare two floating point numbers within an epsilon.
 653  *
 654  * The effect of `g_assert_cmpfloat_with_epsilon (n1, n2, epsilon)` is
 655  * the same as `g_assert_true (abs (n1 - n2) &lt; epsilon)`. The advantage
 656  * of this macro is that it can produce a message that includes the
 657  * actual values of @n1 and @n2.
 658  *
 659  * Since: 2.58
 660  */
 661 
 662 /**
 663  * g_assert_cmpmem:
 664  * @m1: pointer to a buffer
 665  * @l1: length of @m1
 666  * @m2: pointer to another buffer
 667  * @l2: length of @m2
 668  *
 669  * Debugging macro to compare memory regions. If the comparison fails,
 670  * an error message is logged and the application is either terminated
 671  * or the testcase marked as failed.
 672  *
 673  * The effect of `g_assert_cmpmem (m1, l1, m2, l2)` is
 674  * the same as `g_assert_true (l1 == l2 &amp;&amp; memcmp (m1, m2, l1) == 0)`.
 675  * The advantage of this macro is that it can produce a message that
 676  * includes the actual values of @l1 and @l2.
 677  *
 678  * |[&lt;!-- language=&quot;C&quot; --&gt;
 679  *   g_assert_cmpmem (buf-&gt;data, buf-&gt;len, expected, sizeof (expected));
 680  * ]|
 681  *
 682  * Since: 2.46
 683  */
 684 
<span class="line-added"> 685 /**</span>
<span class="line-added"> 686  * g_assert_cmpvariant:</span>
<span class="line-added"> 687  * @v1: pointer to a #GVariant</span>
<span class="line-added"> 688  * @v2: pointer to another #GVariant</span>
<span class="line-added"> 689  *</span>
<span class="line-added"> 690  * Debugging macro to compare two #GVariants. If the comparison fails,</span>
<span class="line-added"> 691  * an error message is logged and the application is either terminated</span>
<span class="line-added"> 692  * or the testcase marked as failed. The variants are compared using</span>
<span class="line-added"> 693  * g_variant_equal().</span>
<span class="line-added"> 694  *</span>
<span class="line-added"> 695  * The effect of `g_assert_cmpvariant (v1, v2)` is the same as</span>
<span class="line-added"> 696  * `g_assert_true (g_variant_equal (v1, v2))`. The advantage of this macro is</span>
<span class="line-added"> 697  * that it can produce a message that includes the actual values of @v1 and @v2.</span>
<span class="line-added"> 698  *</span>
<span class="line-added"> 699  * Since: 2.60</span>
<span class="line-added"> 700  */</span>
<span class="line-added"> 701 </span>
 702 /**
 703  * g_assert_no_error:
 704  * @err: a #GError, possibly %NULL
 705  *
 706  * Debugging macro to check that a #GError is not set.
 707  *
 708  * The effect of `g_assert_no_error (err)` is
 709  * the same as `g_assert_true (err == NULL)`. The advantage
 710  * of this macro is that it can produce a message that includes
 711  * the error message and code.
 712  *
 713  * Since: 2.20
 714  */
 715 
 716 /**
 717  * g_assert_error:
 718  * @err: a #GError, possibly %NULL
 719  * @dom: the expected error domain (a #GQuark)
 720  * @c: the expected error code
 721  *
 722  * Debugging macro to check that a method has returned
 723  * the correct #GError.
 724  *
 725  * The effect of `g_assert_error (err, dom, c)` is
 726  * the same as `g_assert_true (err != NULL &amp;&amp; err-&gt;domain
 727  * == dom &amp;&amp; err-&gt;code == c)`. The advantage of this
 728  * macro is that it can produce a message that includes the incorrect
 729  * error message and code.
 730  *
 731  * This can only be used to test for a specific error. If you want to
 732  * test that @err is set, but don&#39;t care what it&#39;s set to, just use
<span class="line-modified"> 733  * `g_assert_nonnull (err)`.</span>
 734  *
 735  * Since: 2.20
 736  */
 737 
 738 /**
 739  * GTestCase:
 740  *
 741  * An opaque structure representing a test case.
 742  */
 743 
 744 /**
 745  * GTestSuite:
 746  *
 747  * An opaque structure representing a test suite.
 748  */
 749 
 750 
 751 /* Global variable for storing assertion messages; this is the counterpart to
 752  * glibc&#39;s (private) __abort_msg variable, and allows developers and crash
 753  * analysis systems like Apport and ABRT to fish out assertion messages from
</pre>
<hr />
<pre>
 788 static void     test_trap_clear                 (void);
 789 static guint8*  g_test_log_dump                 (GTestLogMsg *msg,
 790                                                  guint       *len);
 791 static void     gtest_default_log_handler       (const gchar    *log_domain,
 792                                                  GLogLevelFlags  log_level,
 793                                                  const gchar    *message,
 794                                                  gpointer        unused_data);
 795 
 796 
 797 static const char * const g_test_result_names[] = {
 798   &quot;OK&quot;,
 799   &quot;SKIP&quot;,
 800   &quot;FAIL&quot;,
 801   &quot;TODO&quot;
 802 };
 803 
 804 /* --- variables --- */
 805 static int         test_log_fd = -1;
 806 static gboolean    test_mode_fatal = TRUE;
 807 static gboolean    g_test_run_once = TRUE;
<span class="line-added"> 808 static gboolean    test_isolate_dirs = FALSE;</span>
<span class="line-added"> 809 static gchar      *test_isolate_dirs_tmpdir = NULL;</span>
<span class="line-added"> 810 static const gchar *test_tmpdir = NULL;</span>
 811 static gboolean    test_run_list = FALSE;
 812 static gchar      *test_run_seedstr = NULL;
<span class="line-added"> 813 G_LOCK_DEFINE_STATIC (test_run_rand);</span>
 814 static GRand      *test_run_rand = NULL;
 815 static gchar      *test_run_name = &quot;&quot;;
 816 static GSList    **test_filename_free_list;
 817 static guint       test_run_forks = 0;
 818 static guint       test_run_count = 0;
 819 static guint       test_count = 0;
 820 static guint       test_skipped_count = 0;
 821 static GTestResult test_run_success = G_TEST_RUN_FAILURE;
 822 static gchar      *test_run_msg = NULL;
 823 static guint       test_startup_skip_count = 0;
 824 static GTimer     *test_user_timer = NULL;
 825 static double      test_user_stamp = 0;
 826 static GSList     *test_paths = NULL;
 827 static GSList     *test_paths_skipped = NULL;
 828 static GTestSuite *test_suite_root = NULL;
 829 static int         test_trap_last_status = 0;  /* unmodified platform-specific status */
 830 static GPid        test_trap_last_pid = 0;
 831 static char       *test_trap_last_subprocess = NULL;
 832 static char       *test_trap_last_stdout = NULL;
 833 static char       *test_trap_last_stderr = NULL;
 834 static char       *test_uri_base = NULL;
 835 static gboolean    test_debug_log = FALSE;
<span class="line-modified"> 836 static gboolean    test_tap_log = TRUE;  /* default to TAP as of GLib 2.62; see #1619; the non-TAP output mode is deprecated */</span>
 837 static gboolean    test_nonfatal_assertions = FALSE;
 838 static DestroyEntry *test_destroy_queue = NULL;
 839 static char       *test_argv0 = NULL;
 840 static char       *test_argv0_dirname;
 841 static const char *test_disted_files_dir;
 842 static const char *test_built_files_dir;
 843 static char       *test_initial_cwd = NULL;
 844 static gboolean    test_in_forked_child = FALSE;
 845 static gboolean    test_in_subprocess = FALSE;
 846 static GTestConfig mutable_test_config_vars = {
 847   FALSE,        /* test_initialized */
 848   TRUE,         /* test_quick */
 849   FALSE,        /* test_perf */
 850   FALSE,        /* test_verbose */
 851   FALSE,        /* test_quiet */
 852   TRUE,         /* test_undefined */
 853 };
 854 const GTestConfig * const g_test_config_vars = &amp;mutable_test_config_vars;
 855 static gboolean  no_g_set_prgname = FALSE;
 856 
</pre>
<hr />
<pre>
 926             long double *largs)
 927 {
 928   GTestResult result;
 929   gboolean fail;
 930   GTestLogMsg msg;
 931   gchar *astrings[3] = { NULL, NULL, NULL };
 932   guint8 *dbuffer;
 933   guint32 dbufferlen;
 934 
 935   switch (lbit)
 936     {
 937     case G_TEST_LOG_START_BINARY:
 938       if (test_tap_log)
 939         g_print (&quot;# random seed: %s\n&quot;, string2);
 940       else if (g_test_verbose ())
 941         g_print (&quot;GTest: random seed: %s\n&quot;, string2);
 942       break;
 943     case G_TEST_LOG_START_SUITE:
 944       if (test_tap_log)
 945         {
<span class="line-added"> 946           /* We only print the TAP &quot;plan&quot; (1..n) ahead of time if we did</span>
<span class="line-added"> 947            * not use the -p option to select specific tests to be run. */</span>
 948           if (string1[0] != 0)
 949             g_print (&quot;# Start of %s tests\n&quot;, string1);
<span class="line-modified"> 950           else if (test_paths == NULL)</span>
 951             g_print (&quot;1..%d\n&quot;, test_count);
 952         }
 953       break;
 954     case G_TEST_LOG_STOP_SUITE:
 955       if (test_tap_log)
 956         {
<span class="line-added"> 957           /* If we didn&#39;t print the TAP &quot;plan&quot; at the beginning because</span>
<span class="line-added"> 958            * we were using -p, we need to print how many tests we ran at</span>
<span class="line-added"> 959            * the end instead. */</span>
 960           if (string1[0] != 0)
 961             g_print (&quot;# End of %s tests\n&quot;, string1);
<span class="line-added"> 962           else if (test_paths != NULL)</span>
<span class="line-added"> 963             g_print (&quot;1..%d\n&quot;, test_run_count);</span>
 964         }
 965       break;
 966     case G_TEST_LOG_STOP_CASE:
 967       result = largs[0];
 968       fail = result == G_TEST_RUN_FAILURE;
 969       if (test_tap_log)
 970         {
 971           const gchar *ok;
 972 
 973           /* The TAP representation for an expected failure starts with
 974            * &quot;not ok&quot;, even though it does not actually count as failing
 975            * due to the use of the TODO directive. &quot;ok # TODO&quot; would mean
 976            * a test that was expected to fail unexpectedly succeeded,
 977            * for which GTestResult does not currently have a
 978            * representation. */
 979           if (fail || result == G_TEST_RUN_INCOMPLETE)
 980             ok = &quot;not ok&quot;;
 981           else
 982             ok = &quot;ok&quot;;
 983 
</pre>
<hr />
<pre>
 985           if (result == G_TEST_RUN_INCOMPLETE)
 986             g_print (&quot; # TODO %s\n&quot;, string2 ? string2 : &quot;&quot;);
 987           else if (result == G_TEST_RUN_SKIPPED)
 988             g_print (&quot; # SKIP %s\n&quot;, string2 ? string2 : &quot;&quot;);
 989           else
 990             g_print (&quot;\n&quot;);
 991         }
 992       else if (g_test_verbose ())
 993         g_print (&quot;GTest: result: %s\n&quot;, g_test_result_names[result]);
 994       else if (!g_test_quiet ())
 995         g_print (&quot;%s\n&quot;, g_test_result_names[result]);
 996       if (fail &amp;&amp; test_mode_fatal)
 997         {
 998           if (test_tap_log)
 999             g_print (&quot;Bail out!\n&quot;);
1000           g_abort ();
1001         }
1002       if (result == G_TEST_RUN_SKIPPED || result == G_TEST_RUN_INCOMPLETE)
1003         test_skipped_count++;
1004       break;
<span class="line-added">1005     case G_TEST_LOG_SKIP_CASE:</span>
<span class="line-added">1006       if (test_tap_log)</span>
<span class="line-added">1007           g_print (&quot;ok %d %s # SKIP\n&quot;, test_run_count, string1);</span>
<span class="line-added">1008       break;</span>
1009     case G_TEST_LOG_MIN_RESULT:
1010       if (test_tap_log)
1011         g_print (&quot;# min perf: %s\n&quot;, string1);
1012       else if (g_test_verbose ())
1013         g_print (&quot;(MINPERF:%s)\n&quot;, string1);
1014       break;
1015     case G_TEST_LOG_MAX_RESULT:
1016       if (test_tap_log)
1017         g_print (&quot;# max perf: %s\n&quot;, string1);
1018       else if (g_test_verbose ())
1019         g_print (&quot;(MAXPERF:%s)\n&quot;, string1);
1020       break;
1021     case G_TEST_LOG_MESSAGE:
1022       if (test_tap_log)
1023         g_print (&quot;# %s\n&quot;, string1);
1024       else if (g_test_verbose ())
1025         g_print (&quot;(MSG: %s)\n&quot;, string1);
1026       break;
1027     case G_TEST_LOG_ERROR:
1028       if (test_tap_log)
</pre>
<hr />
<pre>
1092         {
1093           test_debug_log = TRUE;
1094           argv[i] = NULL;
1095         }
1096       else if (strcmp (argv[i], &quot;--tap&quot;) == 0)
1097         {
1098           test_tap_log = TRUE;
1099           argv[i] = NULL;
1100         }
1101       else if (strcmp (&quot;--GTestLogFD&quot;, argv[i]) == 0 || strncmp (&quot;--GTestLogFD=&quot;, argv[i], 13) == 0)
1102         {
1103           gchar *equal = argv[i] + 12;
1104           if (*equal == &#39;=&#39;)
1105             test_log_fd = g_ascii_strtoull (equal + 1, NULL, 0);
1106           else if (i + 1 &lt; argc)
1107             {
1108               argv[i++] = NULL;
1109               test_log_fd = g_ascii_strtoull (argv[i], NULL, 0);
1110             }
1111           argv[i] = NULL;
<span class="line-added">1112 </span>
<span class="line-added">1113           /* Force non-TAP output when using gtester */</span>
<span class="line-added">1114           test_tap_log = FALSE;</span>
1115         }
1116       else if (strcmp (&quot;--GTestSkipCount&quot;, argv[i]) == 0 || strncmp (&quot;--GTestSkipCount=&quot;, argv[i], 17) == 0)
1117         {
1118           gchar *equal = argv[i] + 16;
1119           if (*equal == &#39;=&#39;)
1120             test_startup_skip_count = g_ascii_strtoull (equal + 1, NULL, 0);
1121           else if (i + 1 &lt; argc)
1122             {
1123               argv[i++] = NULL;
1124               test_startup_skip_count = g_ascii_strtoull (argv[i], NULL, 0);
1125             }
1126           argv[i] = NULL;
1127         }
1128       else if (strcmp (&quot;--GTestSubprocess&quot;, argv[i]) == 0)
1129         {
1130           test_in_subprocess = TRUE;
1131           /* We typically expect these child processes to crash, and some
1132            * tests spawn a *lot* of them.  Avoid spamming system crash
1133            * collection programs such as systemd-coredump and abrt.
1134            */
1135 #ifdef HAVE_SYS_RESOURCE_H
1136           {
1137             struct rlimit limit = { 0, 0 };
1138             (void) setrlimit (RLIMIT_CORE, &amp;limit);
1139           }
1140 #endif
1141           argv[i] = NULL;
<span class="line-added">1142 </span>
<span class="line-added">1143           /* Force non-TAP output when spawning a subprocess, since people often</span>
<span class="line-added">1144            * test the stdout/stderr of the subprocess strictly */</span>
<span class="line-added">1145           test_tap_log = FALSE;</span>
1146         }
1147       else if (strcmp (&quot;-p&quot;, argv[i]) == 0 || strncmp (&quot;-p=&quot;, argv[i], 3) == 0)
1148         {
1149           gchar *equal = argv[i] + 2;
1150           if (*equal == &#39;=&#39;)
1151             test_paths = g_slist_prepend (test_paths, equal + 1);
1152           else if (i + 1 &lt; argc)
1153             {
1154               argv[i++] = NULL;
1155               test_paths = g_slist_prepend (test_paths, argv[i]);
1156             }
1157           argv[i] = NULL;
1158         }
1159       else if (strcmp (&quot;-s&quot;, argv[i]) == 0 || strncmp (&quot;-s=&quot;, argv[i], 3) == 0)
1160         {
1161           gchar *equal = argv[i] + 2;
1162           if (*equal == &#39;=&#39;)
1163             test_paths_skipped = g_slist_prepend (test_paths_skipped, equal + 1);
1164           else if (i + 1 &lt; argc)
1165             {
</pre>
<hr />
<pre>
1233         {
1234           printf (&quot;Usage:\n&quot;
1235                   &quot;  %s [OPTION...]\n\n&quot;
1236                   &quot;Help Options:\n&quot;
1237                   &quot;  -h, --help                     Show help options\n\n&quot;
1238                   &quot;Test Options:\n&quot;
1239                   &quot;  --g-fatal-warnings             Make all warnings fatal\n&quot;
1240                   &quot;  -l                             List test cases available in a test executable\n&quot;
1241                   &quot;  -m {perf|slow|thorough|quick}  Execute tests according to mode\n&quot;
1242                   &quot;  -m {undefined|no-undefined}    Execute tests according to mode\n&quot;
1243                   &quot;  -p TESTPATH                    Only start test cases matching TESTPATH\n&quot;
1244                   &quot;  -s TESTPATH                    Skip all tests matching TESTPATH\n&quot;
1245                   &quot;  --seed=SEEDSTRING              Start tests with random seed SEEDSTRING\n&quot;
1246                   &quot;  --debug-log                    debug test logging output\n&quot;
1247                   &quot;  -q, --quiet                    Run tests quietly\n&quot;
1248                   &quot;  --verbose                      Run tests verbosely\n&quot;,
1249                   argv[0]);
1250           exit (0);
1251         }
1252     }
<span class="line-added">1253 </span>
<span class="line-added">1254   /* We&#39;ve been prepending to test_paths, but its order matters, so</span>
<span class="line-added">1255    * permute it */</span>
<span class="line-added">1256   test_paths = g_slist_reverse (test_paths);</span>
<span class="line-added">1257 </span>
1258   /* collapse argv */
1259   e = 1;
1260   for (i = 1; i &lt; argc; i++)
1261     if (argv[i])
1262       {
1263         argv[e++] = argv[i];
1264         if (i &gt;= e)
1265           argv[i] = NULL;
1266       }
1267   *argc_p = e;
1268 }
1269 
<span class="line-added">1270 /* A fairly naive `rm -rf` implementation to clean up after unit tests. */</span>
<span class="line-added">1271 static void</span>
<span class="line-added">1272 rm_rf (const gchar *path)</span>
<span class="line-added">1273 {</span>
<span class="line-added">1274   GDir *dir = NULL;</span>
<span class="line-added">1275   const gchar *entry;</span>
<span class="line-added">1276 </span>
<span class="line-added">1277   dir = g_dir_open (path, 0, NULL);</span>
<span class="line-added">1278   if (dir == NULL)</span>
<span class="line-added">1279     {</span>
<span class="line-added">1280       /* Assume it&#39;s a file. */</span>
<span class="line-added">1281       g_remove (path);</span>
<span class="line-added">1282       return;</span>
<span class="line-added">1283     }</span>
<span class="line-added">1284 </span>
<span class="line-added">1285   while ((entry = g_dir_read_name (dir)) != NULL)</span>
<span class="line-added">1286     {</span>
<span class="line-added">1287       gchar *sub_path = g_build_filename (path, entry, NULL);</span>
<span class="line-added">1288       rm_rf (sub_path);</span>
<span class="line-added">1289       g_free (sub_path);</span>
<span class="line-added">1290     }</span>
<span class="line-added">1291 </span>
<span class="line-added">1292   g_dir_close (dir);</span>
<span class="line-added">1293 </span>
<span class="line-added">1294   g_rmdir (path);</span>
<span class="line-added">1295 }</span>
<span class="line-added">1296 </span>
<span class="line-added">1297 /* Implement the %G_TEST_OPTION_ISOLATE_DIRS option, iff it&#39;s enabled. Create</span>
<span class="line-added">1298  * a temporary directory for this unit test (disambiguated using @test_run_name)</span>
<span class="line-added">1299  * and use g_set_user_dirs() to point various XDG directories into it, without</span>
<span class="line-added">1300  * having to call setenv() in a process which potentially has threads running.</span>
<span class="line-added">1301  *</span>
<span class="line-added">1302  * Note that this is called for each unit test, and hence won&#39;t have taken</span>
<span class="line-added">1303  * effect before g_test_run() is called in the unit test&#39;s main(). Hence</span>
<span class="line-added">1304  * references to XDG variables in main() will not be using the temporary</span>
<span class="line-added">1305  * directory. */</span>
<span class="line-added">1306 static gboolean</span>
<span class="line-added">1307 test_do_isolate_dirs (GError **error)</span>
<span class="line-added">1308 {</span>
<span class="line-added">1309   gchar *subdir = NULL;</span>
<span class="line-added">1310   gchar *home_dir = NULL, *cache_dir = NULL, *config_dir = NULL;</span>
<span class="line-added">1311   gchar *data_dir = NULL, *runtime_dir = NULL;</span>
<span class="line-added">1312   gchar *config_dirs[3];</span>
<span class="line-added">1313   gchar *data_dirs[3];</span>
<span class="line-added">1314 </span>
<span class="line-added">1315   if (!test_isolate_dirs)</span>
<span class="line-added">1316     return TRUE;</span>
<span class="line-added">1317 </span>
<span class="line-added">1318   /* The @test_run_name includes the test suites, so may be several directories</span>
<span class="line-added">1319    * deep. Add a `.dirs` directory to contain all the paths we create, and</span>
<span class="line-added">1320    * guarantee none of them clash with test paths below the current one - test</span>
<span class="line-added">1321    * paths may not contain components starting with `.`. */</span>
<span class="line-added">1322   subdir = g_build_filename (test_tmpdir, test_run_name, &quot;.dirs&quot;, NULL);</span>
<span class="line-added">1323 </span>
<span class="line-added">1324   /* We have to create the runtime directory (because it must be bound to</span>
<span class="line-added">1325    * the session lifetime, which we consider to be the lifetime of the unit</span>
<span class="line-added">1326    * test for testing purposes - see</span>
<span class="line-added">1327    * https://standards.freedesktop.org/basedir-spec/basedir-spec-latest.html.</span>
<span class="line-added">1328    * We don&#39;t need to create the other directories - the specification</span>
<span class="line-added">1329    * requires that client code create them if they don&#39;t exist. Not creating</span>
<span class="line-added">1330    * them automatically is a good test of clients&#39; adherence to the spec</span>
<span class="line-added">1331    * and error handling of missing directories. */</span>
<span class="line-added">1332   runtime_dir = g_build_filename (subdir, &quot;runtime&quot;, NULL);</span>
<span class="line-added">1333   if (g_mkdir_with_parents (runtime_dir, 0700) != 0)</span>
<span class="line-added">1334     {</span>
<span class="line-added">1335       gint saved_errno = errno;</span>
<span class="line-added">1336       g_set_error (error, G_FILE_ERROR, g_file_error_from_errno (saved_errno),</span>
<span class="line-added">1337                    &quot;Failed to create XDG_RUNTIME_DIR &#39;%s&#39;: %s&quot;,</span>
<span class="line-added">1338                   runtime_dir, g_strerror (saved_errno));</span>
<span class="line-added">1339       g_free (runtime_dir);</span>
<span class="line-added">1340       g_free (subdir);</span>
<span class="line-added">1341       return FALSE;</span>
<span class="line-added">1342     }</span>
<span class="line-added">1343 </span>
<span class="line-added">1344   home_dir = g_build_filename (subdir, &quot;home&quot;, NULL);</span>
<span class="line-added">1345   cache_dir = g_build_filename (subdir, &quot;cache&quot;, NULL);</span>
<span class="line-added">1346   config_dir = g_build_filename (subdir, &quot;config&quot;, NULL);</span>
<span class="line-added">1347   data_dir = g_build_filename (subdir, &quot;data&quot;, NULL);</span>
<span class="line-added">1348 </span>
<span class="line-added">1349   config_dirs[0] = g_build_filename (subdir, &quot;system-config1&quot;, NULL);</span>
<span class="line-added">1350   config_dirs[1] = g_build_filename (subdir, &quot;system-config2&quot;, NULL);</span>
<span class="line-added">1351   config_dirs[2] = NULL;</span>
<span class="line-added">1352 </span>
<span class="line-added">1353   data_dirs[0] = g_build_filename (subdir, &quot;system-data1&quot;, NULL);</span>
<span class="line-added">1354   data_dirs[1] = g_build_filename (subdir, &quot;system-data2&quot;, NULL);</span>
<span class="line-added">1355   data_dirs[2] = NULL;</span>
<span class="line-added">1356 </span>
<span class="line-added">1357   /* Remember to update the documentation for %G_TEST_OPTION_ISOLATE_DIRS if</span>
<span class="line-added">1358    * this list changes. */</span>
<span class="line-added">1359   g_set_user_dirs (&quot;HOME&quot;, home_dir,</span>
<span class="line-added">1360                    &quot;XDG_CACHE_HOME&quot;, cache_dir,</span>
<span class="line-added">1361                    &quot;XDG_CONFIG_DIRS&quot;, config_dirs,</span>
<span class="line-added">1362                    &quot;XDG_CONFIG_HOME&quot;, config_dir,</span>
<span class="line-added">1363                    &quot;XDG_DATA_DIRS&quot;, data_dirs,</span>
<span class="line-added">1364                    &quot;XDG_DATA_HOME&quot;, data_dir,</span>
<span class="line-added">1365                    &quot;XDG_RUNTIME_DIR&quot;, runtime_dir,</span>
<span class="line-added">1366                    NULL);</span>
<span class="line-added">1367 </span>
<span class="line-added">1368   g_free (runtime_dir);</span>
<span class="line-added">1369   g_free (data_dir);</span>
<span class="line-added">1370   g_free (config_dir);</span>
<span class="line-added">1371   g_free (cache_dir);</span>
<span class="line-added">1372   g_free (home_dir);</span>
<span class="line-added">1373   g_free (data_dirs[1]);</span>
<span class="line-added">1374   g_free (data_dirs[0]);</span>
<span class="line-added">1375   g_free (config_dirs[1]);</span>
<span class="line-added">1376   g_free (config_dirs[0]);</span>
<span class="line-added">1377   g_free (subdir);</span>
<span class="line-added">1378 </span>
<span class="line-added">1379   return TRUE;</span>
<span class="line-added">1380 }</span>
<span class="line-added">1381 </span>
<span class="line-added">1382 /* Clean up after test_do_isolate_dirs(). */</span>
<span class="line-added">1383 static void</span>
<span class="line-added">1384 test_rm_isolate_dirs (void)</span>
<span class="line-added">1385 {</span>
<span class="line-added">1386   gchar *subdir = NULL;</span>
<span class="line-added">1387 </span>
<span class="line-added">1388   if (!test_isolate_dirs)</span>
<span class="line-added">1389     return;</span>
<span class="line-added">1390 </span>
<span class="line-added">1391   subdir = g_build_filename (test_tmpdir, test_run_name, NULL);</span>
<span class="line-added">1392   rm_rf (subdir);</span>
<span class="line-added">1393   g_free (subdir);</span>
<span class="line-added">1394 }</span>
<span class="line-added">1395 </span>
1396 /**
1397  * g_test_init:
1398  * @argc: Address of the @argc parameter of the main() function.
1399  *        Changed if any arguments were handled.
1400  * @argv: Address of the @argv parameter of main().
1401  *        Any parameters understood by g_test_init() stripped before return.
<span class="line-modified">1402  * @...: %NULL-terminated list of special options, documented below.</span>


1403  *
1404  * Initialize the GLib testing framework, e.g. by seeding the
1405  * test random number generator, the name for g_get_prgname()
1406  * and parsing test related command line args.
1407  *
1408  * So far, the following arguments are understood:
1409  *
1410  * - `-l`: List test cases available in a test executable.
1411  * - `--seed=SEED`: Provide a random seed to reproduce test
1412  *   runs using random numbers.
1413  * - `--verbose`: Run tests verbosely.
1414  * - `-q`, `--quiet`: Run tests quietly.
1415  * - `-p PATH`: Execute all tests matching the given path.
1416  * - `-s PATH`: Skip all tests matching the given path.
1417  *   This can also be used to force a test to run that would otherwise
1418  *   be skipped (ie, a test whose name contains &quot;/subprocess&quot;).
1419  * - `-m {perf|slow|thorough|quick|undefined|no-undefined}`: Execute tests according to these test modes:
1420  *
1421  *   `perf`: Performance tests, may take long and report results (off by default).
1422  *
1423  *   `slow`, `thorough`: Slow and thorough tests, may take quite long and maximize coverage
1424  *   (off by default).
1425  *
1426  *   `quick`: Quick tests, should run really quickly and give good coverage (the default).
1427  *
1428  *   `undefined`: Tests for undefined behaviour, may provoke programming errors
1429  *   under g_test_trap_subprocess() or g_test_expect_message() to check
1430  *   that appropriate assertions or warnings are given (the default).
1431  *
1432  *   `no-undefined`: Avoid tests for undefined behaviour
1433  *
1434  * - `--debug-log`: Debug test logging output.
1435  *
<span class="line-added">1436  * Options which can be passed to @... are:</span>
<span class="line-added">1437  *</span>
<span class="line-added">1438  *  - `&quot;no_g_set_prgname&quot;`: Causes g_test_init() to not call g_set_prgname().</span>
<span class="line-added">1439  *  - %G_TEST_OPTION_ISOLATE_DIRS: Creates a unique temporary directory for each</span>
<span class="line-added">1440  *    unit test and uses g_set_user_dirs() to set XDG directories to point into</span>
<span class="line-added">1441  *    that temporary directory for the duration of the unit test. See the</span>
<span class="line-added">1442  *    documentation for %G_TEST_OPTION_ISOLATE_DIRS.</span>
<span class="line-added">1443  *</span>
1444  * Since 2.58, if tests are compiled with `G_DISABLE_ASSERT` defined,
1445  * g_test_init() will print an error and exit. This is to prevent no-op tests
1446  * from being executed, as g_assert() is commonly (erroneously) used in unit
1447  * tests, and is a no-op when compiled with `G_DISABLE_ASSERT`. Ensure your
1448  * tests are compiled without `G_DISABLE_ASSERT` defined.
1449  *
1450  * Since: 2.16
1451  */
1452 void
1453 (g_test_init) (int    *argc,
1454                char ***argv,
1455                ...)
1456 {
1457   static char seedstr[4 + 4 * 8 + 1];
1458   va_list args;
1459   gpointer option;
1460   /* make warnings and criticals fatal for all test programs */
1461   GLogLevelFlags fatal_mask = (GLogLevelFlags) g_log_set_always_fatal ((GLogLevelFlags) G_LOG_FATAL_MASK);
1462 
1463   fatal_mask = (GLogLevelFlags) (fatal_mask | G_LOG_LEVEL_WARNING | G_LOG_LEVEL_CRITICAL);
1464   g_log_set_always_fatal (fatal_mask);
1465   /* check caller args */
1466   g_return_if_fail (argc != NULL);
1467   g_return_if_fail (argv != NULL);
1468   g_return_if_fail (g_test_config_vars-&gt;test_initialized == FALSE);
1469   mutable_test_config_vars.test_initialized = TRUE;
1470 
1471   va_start (args, argv);
1472   while ((option = va_arg (args, char *)))
1473     {
1474       if (g_strcmp0 (option, &quot;no_g_set_prgname&quot;) == 0)
1475         no_g_set_prgname = TRUE;
<span class="line-added">1476       else if (g_strcmp0 (option, G_TEST_OPTION_ISOLATE_DIRS) == 0)</span>
<span class="line-added">1477         test_isolate_dirs = TRUE;</span>
1478     }
1479   va_end (args);
1480 
1481   /* setup random seed string */
1482   g_snprintf (seedstr, sizeof (seedstr), &quot;R02S%08x%08x%08x%08x&quot;, g_random_int(), g_random_int(), g_random_int(), g_random_int());
1483   test_run_seedstr = seedstr;
1484 
1485   /* parse args, sets up mode, changes seed, etc. */
1486   parse_args (argc, argv);
1487 
1488   if (!g_get_prgname() &amp;&amp; !no_g_set_prgname)
1489     g_set_prgname ((*argv)[0]);
1490 
<span class="line-modified">1491   /* Set up the temporary directory for isolating the test. We have to do this</span>
<span class="line-modified">1492    * early, as we want the return values from g_get_user_data_dir() (and</span>
<span class="line-added">1493    * friends) to return subdirectories of the temporary directory throughout</span>
<span class="line-added">1494    * the setup function, test, and teardown function, for each unit test.</span>
<span class="line-added">1495    * See test_do_isolate_dirs().</span>
<span class="line-added">1496    *</span>
<span class="line-added">1497    * The directory is deleted at the bottom of g_test_run().</span>
<span class="line-added">1498    *</span>
<span class="line-added">1499    * Rather than setting the XDG_* environment variables we use a new</span>
<span class="line-added">1500    * G_TEST_TMPDIR variable which gives the top-level temporary directory. This</span>
<span class="line-added">1501    * allows test subprocesses to reuse the same temporary directory when</span>
<span class="line-added">1502    * g_test_init() is called in them. */</span>
<span class="line-added">1503   if (test_isolate_dirs)</span>
1504     {
<span class="line-modified">1505       if (g_getenv (&quot;G_TEST_TMPDIR&quot;) == NULL)</span>
1506         {
<span class="line-modified">1507           gchar *test_prgname = NULL;</span>
<span class="line-modified">1508           gchar *tmpl = NULL;</span>
<span class="line-modified">1509           GError *local_error = NULL;</span>
<span class="line-modified">1510 </span>
<span class="line-added">1511           test_prgname = g_path_get_basename (g_get_prgname ());</span>
<span class="line-added">1512           if (*test_prgname == &#39;\0&#39;)</span>
<span class="line-added">1513             test_prgname = g_strdup (&quot;unknown&quot;);</span>
<span class="line-added">1514           tmpl = g_strdup_printf (&quot;test_%s_XXXXXX&quot;, test_prgname);</span>
<span class="line-added">1515           g_free (test_prgname);</span>
<span class="line-added">1516 </span>
<span class="line-added">1517           test_isolate_dirs_tmpdir = g_dir_make_tmp (tmpl, &amp;local_error);</span>
<span class="line-added">1518           if (local_error != NULL)</span>
<span class="line-added">1519             {</span>
<span class="line-added">1520               g_printerr (&quot;%s: Failed to create temporary directory: %s\n&quot;,</span>
<span class="line-added">1521                           (*argv)[0], local_error-&gt;message);</span>
<span class="line-added">1522               g_error_free (local_error);</span>
<span class="line-added">1523               exit (1);</span>
<span class="line-added">1524             }</span>
<span class="line-added">1525           g_free (tmpl);</span>
<span class="line-added">1526 </span>
<span class="line-added">1527           /* Propagate the temporary directory to subprocesses. */</span>
<span class="line-added">1528           g_setenv (&quot;G_TEST_TMPDIR&quot;, test_isolate_dirs_tmpdir, TRUE);</span>
<span class="line-added">1529 </span>
<span class="line-added">1530           /* And clear the traditional environment variables so subprocesses</span>
<span class="line-added">1531            * spawned by the code under test can&#39;t trash anything. If a test</span>
<span class="line-added">1532            * spawns a process, the test is responsible for propagating</span>
<span class="line-added">1533            * appropriate environment variables.</span>
<span class="line-added">1534            *</span>
<span class="line-added">1535            * We assume that any in-process code will use g_get_user_data_dir()</span>
<span class="line-added">1536            * and friends, rather than getenv() directly.</span>
<span class="line-added">1537            *</span>
<span class="line-added">1538            * We set them to &#39;/dev/null&#39; as that should fairly obviously not</span>
<span class="line-added">1539            * accidentally work, and should be fairly greppable. */</span>
<span class="line-added">1540             {</span>
<span class="line-added">1541               const gchar *overridden_environment_variables[] =</span>
<span class="line-added">1542                 {</span>
<span class="line-added">1543                   &quot;HOME&quot;,</span>
<span class="line-added">1544                   &quot;XDG_CACHE_HOME&quot;,</span>
<span class="line-added">1545                   &quot;XDG_CONFIG_DIRS&quot;,</span>
<span class="line-added">1546                   &quot;XDG_CONFIG_HOME&quot;,</span>
<span class="line-added">1547                   &quot;XDG_DATA_DIRS&quot;,</span>
<span class="line-added">1548                   &quot;XDG_DATA_HOME&quot;,</span>
<span class="line-added">1549                   &quot;XDG_RUNTIME_DIR&quot;,</span>
<span class="line-added">1550                 };</span>
<span class="line-added">1551               gsize i;</span>
<span class="line-added">1552 </span>
<span class="line-added">1553               for (i = 0; i &lt; G_N_ELEMENTS (overridden_environment_variables); i++)</span>
<span class="line-added">1554                 g_setenv (overridden_environment_variables[i], &quot;/dev/null&quot;, TRUE);</span>
<span class="line-added">1555             }</span>
1556         }
<span class="line-added">1557 </span>
<span class="line-added">1558       /* Cache this for the remainder of this process&#39; lifetime. */</span>
<span class="line-added">1559       test_tmpdir = g_getenv (&quot;G_TEST_TMPDIR&quot;);</span>
1560     }
1561 
1562   /* verify GRand reliability, needed for reliable seeds */
1563   if (1)
1564     {
1565       GRand *rg = g_rand_new_with_seed (0xc8c49fb6);
1566       guint32 t1 = g_rand_int (rg), t2 = g_rand_int (rg), t3 = g_rand_int (rg), t4 = g_rand_int (rg);
1567       /* g_print (&quot;GRand-current: 0x%x 0x%x 0x%x 0x%x\n&quot;, t1, t2, t3, t4); */
1568       if (t1 != 0xfab39f9b || t2 != 0xb948fb0e || t3 != 0x3d31be26 || t4 != 0x43a19d66)
1569         g_warning (&quot;random numbers are not GRand-2.2 compatible, seeds may be broken (check $G_RANDOM_VERSION)&quot;);
1570       g_rand_free (rg);
1571     }
1572 
1573   /* check rand seed */
1574   test_run_seed (test_run_seedstr);
1575 
1576   /* report program start */
1577   g_log_set_default_handler (gtest_default_log_handler, NULL);
1578   g_test_log (G_TEST_LOG_START_BINARY, g_get_prgname(), test_run_seedstr, 0, NULL);
1579 
</pre>
<hr />
<pre>
1638 /**
1639  * g_test_rand_int:
1640  *
1641  * Get a reproducible random integer number.
1642  *
1643  * The random numbers generated by the g_test_rand_*() family of functions
1644  * change with every new test program start, unless the --seed option is
1645  * given when starting test programs.
1646  *
1647  * For individual test cases however, the random number generator is
1648  * reseeded, to avoid dependencies between tests and to make --seed
1649  * effective for all test cases.
1650  *
1651  * Returns: a random number from the seeded random number generator.
1652  *
1653  * Since: 2.16
1654  */
1655 gint32
1656 g_test_rand_int (void)
1657 {
<span class="line-modified">1658   gint32 r;</span>
<span class="line-added">1659 </span>
<span class="line-added">1660   G_LOCK (test_run_rand);</span>
<span class="line-added">1661   r = g_rand_int (test_run_rand);</span>
<span class="line-added">1662   G_UNLOCK (test_run_rand);</span>
<span class="line-added">1663 </span>
<span class="line-added">1664   return r;</span>
1665 }
1666 
1667 /**
1668  * g_test_rand_int_range:
1669  * @begin: the minimum value returned by this function
1670  * @end:   the smallest value not to be returned by this function
1671  *
1672  * Get a reproducible random integer number out of a specified range,
1673  * see g_test_rand_int() for details on test case random numbers.
1674  *
1675  * Returns: a number with @begin &lt;= number &lt; @end.
1676  *
1677  * Since: 2.16
1678  */
1679 gint32
1680 g_test_rand_int_range (gint32          begin,
1681                        gint32          end)
1682 {
<span class="line-modified">1683   gint32 r;</span>
<span class="line-added">1684 </span>
<span class="line-added">1685   G_LOCK (test_run_rand);</span>
<span class="line-added">1686   r = g_rand_int_range (test_run_rand, begin, end);</span>
<span class="line-added">1687   G_UNLOCK (test_run_rand);</span>
<span class="line-added">1688 </span>
<span class="line-added">1689   return r;</span>
1690 }
1691 
1692 /**
1693  * g_test_rand_double:
1694  *
1695  * Get a reproducible random floating point number,
1696  * see g_test_rand_int() for details on test case random numbers.
1697  *
1698  * Returns: a random number from the seeded random number generator.
1699  *
1700  * Since: 2.16
1701  */
1702 double
1703 g_test_rand_double (void)
1704 {
<span class="line-modified">1705   double r;</span>
<span class="line-added">1706 </span>
<span class="line-added">1707   G_LOCK (test_run_rand);</span>
<span class="line-added">1708   r = g_rand_double (test_run_rand);</span>
<span class="line-added">1709   G_UNLOCK (test_run_rand);</span>
<span class="line-added">1710 </span>
<span class="line-added">1711   return r;</span>
1712 }
1713 
1714 /**
1715  * g_test_rand_double_range:
1716  * @range_start: the minimum value returned by this function
1717  * @range_end: the minimum value not returned by this function
1718  *
1719  * Get a reproducible random floating pointer number out of a specified range,
1720  * see g_test_rand_int() for details on test case random numbers.
1721  *
1722  * Returns: a number with @range_start &lt;= number &lt; @range_end.
1723  *
1724  * Since: 2.16
1725  */
1726 double
1727 g_test_rand_double_range (double          range_start,
1728                           double          range_end)
1729 {
<span class="line-modified">1730   double r;</span>
<span class="line-added">1731 </span>
<span class="line-added">1732   G_LOCK (test_run_rand);</span>
<span class="line-added">1733   r = g_rand_double_range (test_run_rand, range_start, range_end);</span>
<span class="line-added">1734   G_UNLOCK (test_run_rand);</span>
<span class="line-added">1735 </span>
<span class="line-added">1736   return r;</span>
1737 }
1738 
1739 /**
1740  * g_test_timer_start:
1741  *
1742  * Start a timing test. Call g_test_timer_elapsed() when the task is supposed
1743  * to be done. Call this function again to restart the timer.
1744  *
1745  * Since: 2.16
1746  */
1747 void
1748 g_test_timer_start (void)
1749 {
1750   if (!test_user_timer)
1751     test_user_timer = g_timer_new();
1752   test_user_stamp = 0;
1753   g_timer_start (test_user_timer);
1754 }
1755 
1756 /**
</pre>
<hr />
<pre>
1869   g_test_log (G_TEST_LOG_MESSAGE, buffer, NULL, 0, NULL);
1870   g_free (buffer);
1871 }
1872 
1873 /**
1874  * g_test_bug_base:
1875  * @uri_pattern: the base pattern for bug URIs
1876  *
1877  * Specify the base URI for bug reports.
1878  *
1879  * The base URI is used to construct bug report messages for
1880  * g_test_message() when g_test_bug() is called.
1881  * Calling this function outside of a test case sets the
1882  * default base URI for all test cases. Calling it from within
1883  * a test case changes the base URI for the scope of the test
1884  * case only.
1885  * Bug URIs are constructed by appending a bug specific URI
1886  * portion to @uri_pattern, or by replacing the special string
1887  * &#39;\%s&#39; within @uri_pattern if that is present.
1888  *
<span class="line-added">1889  * If g_test_bug_base() is not called, bug URIs are formed solely</span>
<span class="line-added">1890  * from the value provided by g_test_bug().</span>
<span class="line-added">1891  *</span>
1892  * Since: 2.16
1893  */
1894 void
1895 g_test_bug_base (const char *uri_pattern)
1896 {
1897   g_free (test_uri_base);
1898   test_uri_base = g_strdup (uri_pattern);
1899 }
1900 
1901 /**
1902  * g_test_bug:
1903  * @bug_uri_snippet: Bug specific bug tracker URI portion.
1904  *
1905  * This function adds a message to test reports that
1906  * associates a bug URI with a test case.
1907  * Bug URIs are constructed from a base URI set with g_test_bug_base()
<span class="line-modified">1908  * and @bug_uri_snippet. If g_test_bug_base() has not been called, it is</span>
<span class="line-added">1909  * assumed to be the empty string, so a full URI can be provided to</span>
<span class="line-added">1910  * g_test_bug() instead.</span>
1911  *
1912  * Since: 2.16
<span class="line-added">1913  * See also: g_test_summary()</span>
1914  */
1915 void
1916 g_test_bug (const char *bug_uri_snippet)
1917 {
<span class="line-modified">1918   const char *c = NULL;</span>
1919 

1920   g_return_if_fail (bug_uri_snippet != NULL);
1921 
<span class="line-modified">1922   if (test_uri_base != NULL)</span>
<span class="line-added">1923     c = strstr (test_uri_base, &quot;%s&quot;);</span>
1924   if (c)
1925     {
1926       char *b = g_strndup (test_uri_base, c - test_uri_base);
1927       char *s = g_strconcat (b, bug_uri_snippet, c + 2, NULL);
1928       g_free (b);
1929       g_test_message (&quot;Bug Reference: %s&quot;, s);
1930       g_free (s);
1931     }
1932   else
<span class="line-modified">1933     g_test_message (&quot;Bug Reference: %s%s&quot;,</span>
<span class="line-added">1934                     test_uri_base ? test_uri_base : &quot;&quot;, bug_uri_snippet);</span>
<span class="line-added">1935 }</span>
<span class="line-added">1936 </span>
<span class="line-added">1937 /**</span>
<span class="line-added">1938  * g_test_summary:</span>
<span class="line-added">1939  * @summary: One or two sentences summarising what the test checks, and how it</span>
<span class="line-added">1940  *    checks it.</span>
<span class="line-added">1941  *</span>
<span class="line-added">1942  * Set the summary for a test, which describes what the test checks, and how it</span>
<span class="line-added">1943  * goes about checking it. This may be included in test report output, and is</span>
<span class="line-added">1944  * useful documentation for anyone reading the source code or modifying a test</span>
<span class="line-added">1945  * in future. It must be a single line.</span>
<span class="line-added">1946  *</span>
<span class="line-added">1947  * This should be called at the top of a test function.</span>
<span class="line-added">1948  *</span>
<span class="line-added">1949  * For example:</span>
<span class="line-added">1950  * |[&lt;!-- language=&quot;C&quot; --&gt;</span>
<span class="line-added">1951  * static void</span>
<span class="line-added">1952  * test_array_sort (void)</span>
<span class="line-added">1953  * {</span>
<span class="line-added">1954  *   g_test_summary (&quot;Test my_array_sort() sorts the array correctly and stably, &quot;</span>
<span class="line-added">1955  *                   &quot;including testing zero length and one-element arrays.&quot;);</span>
<span class="line-added">1956  *</span>
<span class="line-added">1957  * }</span>
<span class="line-added">1958  * ]|</span>
<span class="line-added">1959  *</span>
<span class="line-added">1960  * Since: 2.62</span>
<span class="line-added">1961  * See also: g_test_bug()</span>
<span class="line-added">1962  */</span>
<span class="line-added">1963 void</span>
<span class="line-added">1964 g_test_summary (const char *summary)</span>
<span class="line-added">1965 {</span>
<span class="line-added">1966   g_return_if_fail (summary != NULL);</span>
<span class="line-added">1967   g_return_if_fail (strchr (summary, &#39;\n&#39;) == NULL);</span>
<span class="line-added">1968   g_return_if_fail (strchr (summary, &#39;\r&#39;) == NULL);</span>
<span class="line-added">1969 </span>
<span class="line-added">1970   g_test_message (&quot;%s summary: %s&quot;, test_run_name, summary);</span>
1971 }
1972 
1973 /**
1974  * g_test_get_root:
1975  *
1976  * Get the toplevel test suite for the test path API.
1977  *
1978  * Returns: the toplevel #GTestSuite
1979  *
1980  * Since: 2.16
1981  */
1982 GTestSuite*
1983 g_test_get_root (void)
1984 {
1985   if (!test_suite_root)
1986     {
1987       test_suite_root = g_test_create_suite (&quot;root&quot;);
1988       g_free (test_suite_root-&gt;name);
1989       test_suite_root-&gt;name = g_strdup (&quot;&quot;);
1990     }
</pre>
<hr />
<pre>
2023  * on the order that tests are run in. If you need to ensure that some
2024  * particular code runs before or after a given test case, use
2025  * g_test_add(), which lets you specify setup and teardown functions.
2026  *
2027  * If all tests are skipped or marked as incomplete (expected failures),
2028  * this function will return 0 if producing TAP output, or 77 (treated
2029  * as &quot;skip test&quot; by Automake) otherwise.
2030  *
2031  * Returns: 0 on success, 1 on failure (assuming it returns at all),
2032  *   0 or 77 if all tests were skipped with g_test_skip() and/or
2033  *   g_test_incomplete()
2034  *
2035  * Since: 2.16
2036  */
2037 int
2038 g_test_run (void)
2039 {
2040   if (g_test_run_suite (g_test_get_root()) != 0)
2041     return 1;
2042 
<span class="line-added">2043   /* Clean up the temporary directory. */</span>
<span class="line-added">2044   if (test_isolate_dirs_tmpdir != NULL)</span>
<span class="line-added">2045     {</span>
<span class="line-added">2046       rm_rf (test_isolate_dirs_tmpdir);</span>
<span class="line-added">2047       g_free (test_isolate_dirs_tmpdir);</span>
<span class="line-added">2048       test_isolate_dirs_tmpdir = NULL;</span>
<span class="line-added">2049     }</span>
<span class="line-added">2050 </span>
2051   /* 77 is special to Automake&#39;s default driver, but not Automake&#39;s TAP driver
2052    * or Perl&#39;s prove(1) TAP driver. */
2053   if (test_tap_log)
2054     return 0;
2055 
2056   if (test_run_count &gt; 0 &amp;&amp; test_run_count == test_skipped_count)
2057     return 77;
2058   else
2059     return 0;
2060 }
2061 
2062 /**
2063  * g_test_create_case:
2064  * @test_name:     the name for the test case
2065  * @data_size:     the size of the fixture data structure
2066  * @test_data:     test data argument for the test functions
2067  * @data_setup:    (scope async): the function to set up the fixture data
2068  * @data_test:     (scope async): the actual test function
2069  * @data_teardown: (scope async): the function to teardown the fixture data
2070  *
</pre>
<hr />
<pre>
2147  * test framework, of the size requested.  If the requested size was
2148  * zero then @fixture will be equal to @user_data.
2149  *
2150  * Since: 2.28
2151  */
2152 void
2153 g_test_add_vtable (const char       *testpath,
2154                    gsize             data_size,
2155                    gconstpointer     test_data,
2156                    GTestFixtureFunc  data_setup,
2157                    GTestFixtureFunc  fixture_test_func,
2158                    GTestFixtureFunc  data_teardown)
2159 {
2160   gchar **segments;
2161   guint ui;
2162   GTestSuite *suite;
2163 
2164   g_return_if_fail (testpath != NULL);
2165   g_return_if_fail (g_path_is_absolute (testpath));
2166   g_return_if_fail (fixture_test_func != NULL);
<span class="line-added">2167   g_return_if_fail (!test_isolate_dirs || strstr (testpath, &quot;/.&quot;) == NULL);</span>
2168 
2169   suite = g_test_get_root();
2170   segments = g_strsplit (testpath, &quot;/&quot;, -1);
2171   for (ui = 0; segments[ui] != NULL; ui++)
2172     {
2173       const char *seg = segments[ui];
2174       gboolean islast = segments[ui + 1] == NULL;
2175       if (islast &amp;&amp; !seg[0])
2176         g_error (&quot;invalid test case path: %s&quot;, testpath);
2177       else if (!seg[0])
2178         continue;       /* initial or duplicate slash */
2179       else if (!islast)
2180         {
2181           GSList *l;
2182           GTestSuite *csuite;
2183           l = g_slist_find_custom (suite-&gt;suites, seg, find_suite);
2184           if (l)
2185             {
2186               csuite = l-&gt;data;
2187             }
</pre>
<hr />
<pre>
2336  *
2337  * The type used for test case functions.
2338  *
2339  * Since: 2.28
2340  */
2341 
2342 /**
2343  * g_test_add_func:
2344  * @testpath:  /-separated test case path name for the test.
2345  * @test_func: (scope async):  The test function to invoke for this test.
2346  *
2347  * Create a new test case, similar to g_test_create_case(). However
2348  * the test is assumed to use no fixture, and test suites are automatically
2349  * created on the fly and added to the root fixture, based on the
2350  * slash-separated portions of @testpath.
2351  *
2352  * If @testpath includes the component &quot;subprocess&quot; anywhere in it,
2353  * the test will be skipped by default, and only run if explicitly
2354  * required via the `-p` command-line option or g_test_trap_subprocess().
2355  *
<span class="line-added">2356  * No component of @testpath may start with a dot (`.`) if the</span>
<span class="line-added">2357  * %G_TEST_OPTION_ISOLATE_DIRS option is being used; and it is recommended to</span>
<span class="line-added">2358  * do so even if it isn&#39;t.</span>
<span class="line-added">2359  *</span>
2360  * Since: 2.16
2361  */
2362 void
2363 g_test_add_func (const char *testpath,
2364                  GTestFunc   test_func)
2365 {
2366   g_return_if_fail (testpath != NULL);
2367   g_return_if_fail (testpath[0] == &#39;/&#39;);
2368   g_return_if_fail (test_func != NULL);
2369   g_test_add_vtable (testpath, 0, NULL, NULL, (GTestFixtureFunc) test_func, NULL);
2370 }
2371 
2372 /**
2373  * GTestDataFunc:
2374  * @user_data: the data provided when registering the test
2375  *
2376  * The type used for test case functions that take an extra pointer
2377  * argument.
2378  *
2379  * Since: 2.28
2380  */
2381 
2382 /**
2383  * g_test_add_data_func:
2384  * @testpath:  /-separated test case path name for the test.
2385  * @test_data: Test data argument for the test function.
2386  * @test_func: (scope async): The test function to invoke for this test.
2387  *
2388  * Create a new test case, similar to g_test_create_case(). However
2389  * the test is assumed to use no fixture, and test suites are automatically
2390  * created on the fly and added to the root fixture, based on the
2391  * slash-separated portions of @testpath. The @test_data argument
2392  * will be passed as first argument to @test_func.
2393  *
2394  * If @testpath includes the component &quot;subprocess&quot; anywhere in it,
2395  * the test will be skipped by default, and only run if explicitly
2396  * required via the `-p` command-line option or g_test_trap_subprocess().
2397  *
<span class="line-added">2398  * No component of @testpath may start with a dot (`.`) if the</span>
<span class="line-added">2399  * %G_TEST_OPTION_ISOLATE_DIRS option is being used; and it is recommended to</span>
<span class="line-added">2400  * do so even if it isn&#39;t.</span>
<span class="line-added">2401  *</span>
2402  * Since: 2.16
2403  */
2404 void
2405 g_test_add_data_func (const char     *testpath,
2406                       gconstpointer   test_data,
2407                       GTestDataFunc   test_func)
2408 {
2409   g_return_if_fail (testpath != NULL);
2410   g_return_if_fail (testpath[0] == &#39;/&#39;);
2411   g_return_if_fail (test_func != NULL);
2412 
2413   g_test_add_vtable (testpath, 0, test_data, NULL, (GTestFixtureFunc) test_func, NULL);
2414 }
2415 
2416 /**
2417  * g_test_add_data_func_full:
2418  * @testpath: /-separated test case path name for the test.
2419  * @test_data: Test data argument for the test function.
2420  * @test_func: The test function to invoke for this test.
2421  * @data_free_func: #GDestroyNotify for @test_data.
</pre>
<hr />
<pre>
2595     g_test_log (G_TEST_LOG_SKIP_CASE, test_run_name, NULL, 0, NULL);
2596   else if (test_run_list)
2597     {
2598       g_print (&quot;%s\n&quot;, test_run_name);
2599       g_test_log (G_TEST_LOG_LIST_CASE, test_run_name, NULL, 0, NULL);
2600     }
2601   else
2602     {
2603       GTimer *test_run_timer = g_timer_new();
2604       long double largs[3];
2605       void *fixture;
2606       g_test_log (G_TEST_LOG_START_CASE, test_run_name, NULL, 0, NULL);
2607       test_run_forks = 0;
2608       test_run_success = G_TEST_RUN_SUCCESS;
2609       g_clear_pointer (&amp;test_run_msg, g_free);
2610       g_test_log_set_fatal_handler (NULL, NULL);
2611       if (test_paths_skipped &amp;&amp; g_slist_find_custom (test_paths_skipped, test_run_name, (GCompareFunc)g_strcmp0))
2612         g_test_skip (&quot;by request (-s option)&quot;);
2613       else
2614         {
<span class="line-modified">2615           GError *local_error = NULL;</span>
<span class="line-modified">2616 </span>
<span class="line-modified">2617           if (!test_do_isolate_dirs (&amp;local_error))</span>
<span class="line-modified">2618             {</span>
<span class="line-modified">2619               g_test_log (G_TEST_LOG_ERROR, local_error-&gt;message, NULL, 0, NULL);</span>
<span class="line-modified">2620               g_test_fail ();</span>
<span class="line-modified">2621               g_error_free (local_error);</span>
<span class="line-modified">2622             }</span>
<span class="line-added">2623           else</span>
2624             {
<span class="line-modified">2625               g_timer_start (test_run_timer);</span>
<span class="line-modified">2626               fixture = tc-&gt;fixture_size ? g_malloc0 (tc-&gt;fixture_size) : tc-&gt;test_data;</span>
<span class="line-modified">2627               test_run_seed (test_run_seedstr);</span>
<span class="line-modified">2628               if (tc-&gt;fixture_setup)</span>
<span class="line-added">2629                 tc-&gt;fixture_setup (fixture, tc-&gt;test_data);</span>
<span class="line-added">2630               tc-&gt;fixture_test (fixture, tc-&gt;test_data);</span>
<span class="line-added">2631               test_trap_clear();</span>
<span class="line-added">2632               while (test_destroy_queue)</span>
<span class="line-added">2633                 {</span>
<span class="line-added">2634                   DestroyEntry *dentry = test_destroy_queue;</span>
<span class="line-added">2635                   test_destroy_queue = dentry-&gt;next;</span>
<span class="line-added">2636                   dentry-&gt;destroy_func (dentry-&gt;destroy_data);</span>
<span class="line-added">2637                   g_slice_free (DestroyEntry, dentry);</span>
<span class="line-added">2638                 }</span>
<span class="line-added">2639               if (tc-&gt;fixture_teardown)</span>
<span class="line-added">2640                 tc-&gt;fixture_teardown (fixture, tc-&gt;test_data);</span>
<span class="line-added">2641               if (tc-&gt;fixture_size)</span>
<span class="line-added">2642                 g_free (fixture);</span>
<span class="line-added">2643               g_timer_stop (test_run_timer);</span>
2644             }
<span class="line-modified">2645 </span>
<span class="line-modified">2646           test_rm_isolate_dirs ();</span>



2647         }
2648       success = test_run_success;
2649       test_run_success = G_TEST_RUN_FAILURE;
2650       largs[0] = success; /* OK */
2651       largs[1] = test_run_forks;
2652       largs[2] = g_timer_elapsed (test_run_timer, NULL);
2653       g_test_log (G_TEST_LOG_STOP_CASE, test_run_name, test_run_msg, G_N_ELEMENTS (largs), largs);
2654       g_clear_pointer (&amp;test_run_msg, g_free);
2655       g_timer_destroy (test_run_timer);
2656     }
2657 
2658   g_slist_free_full (filename_free_list, g_free);
2659   test_filename_free_list = old_free_list;
2660   g_free (test_uri_base);
2661   test_uri_base = old_base;
2662 
2663   return (success == G_TEST_RUN_SUCCESS ||
2664           success == G_TEST_RUN_SKIPPED ||
2665           success == G_TEST_RUN_INCOMPLETE);
2666 }
</pre>
<hr />
<pre>
2896     free (__glib_assert_msg);
2897   __glib_assert_msg = (char*) malloc (strlen (s) + 1);
2898   strcpy (__glib_assert_msg, s);
2899 
2900   g_free (s);
2901 
2902   if (test_in_subprocess)
2903     {
2904       /* If this is a test case subprocess then it probably hit this
2905        * assertion on purpose, so just exit() rather than abort()ing,
2906        * to avoid triggering any system crash-reporting daemon.
2907        */
2908       _exit (1);
2909     }
2910   else
2911     g_abort ();
2912 }
2913 
2914 /**
2915  * g_assertion_message_expr: (skip)
<span class="line-modified">2916  * @domain: (nullable): log domain</span>
<span class="line-modified">2917  * @file: file containing the assertion</span>
<span class="line-modified">2918  * @line: line number of the assertion</span>
<span class="line-modified">2919  * @func: function containing the assertion</span>
<span class="line-modified">2920  * @expr: (nullable): expression which failed</span>
<span class="line-added">2921  *</span>
<span class="line-added">2922  * Internal function used to print messages from the public g_assert() and</span>
<span class="line-added">2923  * g_assert_not_reached() macros.</span>
2924  */
2925 void
2926 g_assertion_message_expr (const char     *domain,
2927                           const char     *file,
2928                           int             line,
2929                           const char     *func,
2930                           const char     *expr)
2931 {
2932   char *s;
2933   if (!expr)
2934     s = g_strdup (&quot;code should not be reached&quot;);
2935   else
2936     s = g_strconcat (&quot;assertion failed: (&quot;, expr, &quot;)&quot;, NULL);
2937   g_assertion_message (domain, file, line, func, s);
2938   g_free (s);
2939 
2940   /* Normally g_assertion_message() won&#39;t return, but we need this for
2941    * when test_nonfatal_assertions is set, since
2942    * g_assertion_message_expr() is used for always-fatal assertions.
2943    */
</pre>
<hr />
<pre>
2978                             const char     *func,
2979                             const char     *expr,
2980                             const char     *arg1,
2981                             const char     *cmp,
2982                             const char     *arg2)
2983 {
2984   char *a1, *a2, *s, *t1 = NULL, *t2 = NULL;
2985   a1 = arg1 ? g_strconcat (&quot;\&quot;&quot;, t1 = g_strescape (arg1, NULL), &quot;\&quot;&quot;, NULL) : g_strdup (&quot;NULL&quot;);
2986   a2 = arg2 ? g_strconcat (&quot;\&quot;&quot;, t2 = g_strescape (arg2, NULL), &quot;\&quot;&quot;, NULL) : g_strdup (&quot;NULL&quot;);
2987   g_free (t1);
2988   g_free (t2);
2989   s = g_strdup_printf (&quot;assertion failed (%s): (%s %s %s)&quot;, expr, a1, cmp, a2);
2990   g_free (a1);
2991   g_free (a2);
2992   g_assertion_message (domain, file, line, func, s);
2993   g_free (s);
2994 }
2995 
2996 void
2997 g_assertion_message_error (const char     *domain,
<span class="line-modified">2998          const char     *file,</span>
<span class="line-modified">2999          int             line,</span>
<span class="line-modified">3000          const char     *func,</span>
<span class="line-modified">3001          const char     *expr,</span>
<span class="line-modified">3002          const GError   *error,</span>
<span class="line-modified">3003          GQuark          error_domain,</span>
<span class="line-modified">3004          int             error_code)</span>
3005 {
3006   GString *gstring;
3007 
3008   /* This is used by both g_assert_error() and g_assert_no_error(), so there
3009    * are three cases: expected an error but got the wrong error, expected
3010    * an error but got no error, and expected no error but got an error.
3011    */
3012 
3013   gstring = g_string_new (&quot;assertion failed &quot;);
3014   if (error_domain)
3015       g_string_append_printf (gstring, &quot;(%s == (%s, %d)): &quot;, expr,
<span class="line-modified">3016             g_quark_to_string (error_domain), error_code);</span>
3017   else
3018     g_string_append_printf (gstring, &quot;(%s == NULL): &quot;, expr);
3019 
3020   if (error)
3021       g_string_append_printf (gstring, &quot;%s (%s, %d)&quot;, error-&gt;message,
<span class="line-modified">3022             g_quark_to_string (error-&gt;domain), error-&gt;code);</span>
3023   else
3024     g_string_append_printf (gstring, &quot;%s is NULL&quot;, expr);
3025 
3026   g_assertion_message (domain, file, line, func, gstring-&gt;str);
3027   g_string_free (gstring, TRUE);
3028 }
3029 
3030 /**
3031  * g_strcmp0:
3032  * @str1: (nullable): a C string or %NULL
3033  * @str2: (nullable): another C string or %NULL
3034  *
3035  * Compares @str1 and @str2 like strcmp(). Handles %NULL
3036  * gracefully by sorting it before non-%NULL strings.
3037  * Comparing two %NULL pointers returns 0.
3038  *
3039  * Returns: an integer less than, equal to, or greater than zero, if @str1 is &lt;, == or &gt; than @str2.
3040  *
3041  * Since: 2.16
3042  */
</pre>
<hr />
<pre>
3267  *     if (g_test_trap_fork (0, G_TEST_TRAP_SILENCE_STDOUT | G_TEST_TRAP_SILENCE_STDERR))
3268  *       {
3269  *         g_print (&quot;some stdout text: somagic17\n&quot;);
3270  *         g_printerr (&quot;some stderr text: semagic43\n&quot;);
3271  *         exit (0); // successful test run
3272  *       }
3273  *     g_test_trap_assert_passed ();
3274  *     g_test_trap_assert_stdout (&quot;*somagic17*&quot;);
3275  *     g_test_trap_assert_stderr (&quot;*semagic43*&quot;);
3276  *   }
3277  * ]|
3278  *
3279  * Returns: %TRUE for the forked child and %FALSE for the executing parent process.
3280  *
3281  * Since: 2.16
3282  *
3283  * Deprecated: This function is implemented only on Unix platforms,
3284  * and is not always reliable due to problems inherent in
3285  * fork-without-exec. Use g_test_trap_subprocess() instead.
3286  */
<span class="line-added">3287 G_GNUC_BEGIN_IGNORE_DEPRECATIONS</span>
3288 gboolean
3289 g_test_trap_fork (guint64        usec_timeout,
3290                   GTestTrapFlags test_trap_flags)
3291 {
3292 #ifdef G_OS_UNIX
3293   int stdout_pipe[2] = { -1, -1 };
3294   int stderr_pipe[2] = { -1, -1 };
3295   int errsv;
3296 
3297   test_trap_clear();
3298   if (pipe (stdout_pipe) &lt; 0 || pipe (stderr_pipe) &lt; 0)
3299     {
3300       errsv = errno;
3301       g_error (&quot;failed to create pipes to fork test program: %s&quot;, g_strerror (errsv));
3302     }
3303   test_trap_last_pid = fork ();
3304   errsv = errno;
3305   if (test_trap_last_pid &lt; 0)
3306     g_error (&quot;failed to fork test program: %s&quot;, g_strerror (errsv));
3307   if (test_trap_last_pid == 0)  /* child */
</pre>
<hr />
<pre>
3310       test_in_forked_child = TRUE;
3311       close (stdout_pipe[0]);
3312       close (stderr_pipe[0]);
3313       if (!(test_trap_flags &amp; G_TEST_TRAP_INHERIT_STDIN))
3314         {
3315           fd0 = g_open (&quot;/dev/null&quot;, O_RDONLY, 0);
3316           if (fd0 &lt; 0)
3317             g_error (&quot;failed to open /dev/null for stdin redirection&quot;);
3318         }
3319       if (sane_dup2 (stdout_pipe[1], 1) &lt; 0 || sane_dup2 (stderr_pipe[1], 2) &lt; 0 || (fd0 &gt;= 0 &amp;&amp; sane_dup2 (fd0, 0) &lt; 0))
3320         {
3321           errsv = errno;
3322           g_error (&quot;failed to dup2() in forked test program: %s&quot;, g_strerror (errsv));
3323         }
3324       if (fd0 &gt;= 3)
3325         close (fd0);
3326       if (stdout_pipe[1] &gt;= 3)
3327         close (stdout_pipe[1]);
3328       if (stderr_pipe[1] &gt;= 3)
3329         close (stderr_pipe[1]);
<span class="line-added">3330 </span>
<span class="line-added">3331       /* We typically expect these child processes to crash, and some</span>
<span class="line-added">3332        * tests spawn a *lot* of them.  Avoid spamming system crash</span>
<span class="line-added">3333        * collection programs such as systemd-coredump and abrt.</span>
<span class="line-added">3334        */</span>
<span class="line-added">3335 #ifdef HAVE_SYS_RESOURCE_H</span>
<span class="line-added">3336       {</span>
<span class="line-added">3337         struct rlimit limit = { 0, 0 };</span>
<span class="line-added">3338         (void) setrlimit (RLIMIT_CORE, &amp;limit);</span>
<span class="line-added">3339       }</span>
<span class="line-added">3340 #endif</span>
<span class="line-added">3341 </span>
3342       return TRUE;
3343     }
3344   else                          /* parent */
3345     {
3346       test_run_forks++;
3347       close (stdout_pipe[1]);
3348       close (stderr_pipe[1]);
3349 
3350       wait_for_child (test_trap_last_pid,
3351                       stdout_pipe[0], !(test_trap_flags &amp; G_TEST_TRAP_SILENCE_STDOUT),
3352                       stderr_pipe[0], !(test_trap_flags &amp; G_TEST_TRAP_SILENCE_STDERR),
3353                       usec_timeout);
3354       return FALSE;
3355     }
3356 #else
3357   g_message (&quot;Not implemented: g_test_trap_fork&quot;);
3358 
3359   return FALSE;
3360 #endif
3361 }
<span class="line-added">3362 G_GNUC_END_IGNORE_DEPRECATIONS</span>
3363 
3364 /**
3365  * g_test_trap_subprocess:
3366  * @test_path: (nullable): Test to run in a subprocess
3367  * @usec_timeout: Timeout for the subprocess test in micro seconds.
3368  * @test_flags:   Flags to modify subprocess behaviour.
3369  *
3370  * Respawns the test program to run only @test_path in a subprocess.
3371  * This can be used for a test case that might not return, or that
3372  * might abort.
3373  *
3374  * If @test_path is %NULL then the same test is re-run in a subprocess.
3375  * You can use g_test_subprocess() to determine whether the test is in
3376  * a subprocess or not.
3377  *
3378  * @test_path can also be the name of the parent test, followed by
3379  * &quot;`/subprocess/`&quot; and then a name for the specific subtest (or just
3380  * ending with &quot;`/subprocess`&quot; if the test only has one child test);
3381  * tests with names of this form will automatically be skipped in the
3382  * parent process.
</pre>
<hr />
<pre>
3461   test_trap_clear ();
3462   test_trap_last_subprocess = g_strdup (test_path);
3463 
3464   argv = g_ptr_array_new ();
3465   g_ptr_array_add (argv, test_argv0);
3466   g_ptr_array_add (argv, &quot;-q&quot;);
3467   g_ptr_array_add (argv, &quot;-p&quot;);
3468   g_ptr_array_add (argv, (char *)test_path);
3469   g_ptr_array_add (argv, &quot;--GTestSubprocess&quot;);
3470   if (test_log_fd != -1)
3471     {
3472       char log_fd_buf[128];
3473 
3474       g_ptr_array_add (argv, &quot;--GTestLogFD&quot;);
3475       g_snprintf (log_fd_buf, sizeof (log_fd_buf), &quot;%d&quot;, test_log_fd);
3476       g_ptr_array_add (argv, log_fd_buf);
3477     }
3478   g_ptr_array_add (argv, NULL);
3479 
3480   flags = G_SPAWN_DO_NOT_REAP_CHILD;
<span class="line-added">3481   if (test_log_fd != -1)</span>
<span class="line-added">3482     flags |= G_SPAWN_LEAVE_DESCRIPTORS_OPEN;</span>
3483   if (test_flags &amp; G_TEST_TRAP_INHERIT_STDIN)
3484     flags |= G_SPAWN_CHILD_INHERITS_STDIN;
3485 
3486   if (!g_spawn_async_with_pipes (test_initial_cwd,
3487                                  (char **)argv-&gt;pdata,
3488                                  NULL, flags,
3489                                  NULL, NULL,
3490                                  &amp;pid, NULL, &amp;stdout_fd, &amp;stderr_fd,
3491                                  &amp;error))
3492     {
3493       g_error (&quot;g_test_trap_subprocess() failed: %s&quot;,
3494                error-&gt;message);
3495     }
3496   g_ptr_array_free (argv, TRUE);
3497 
3498   wait_for_child (pid,
3499                   stdout_fd, !!(test_flags &amp; G_TEST_SUBPROCESS_INHERIT_STDOUT),
3500                   stderr_fd, !!(test_flags &amp; G_TEST_SUBPROCESS_INHERIT_STDERR),
3501                   usec_timeout);
3502 }
</pre>
<hr />
<pre>
3660       msg = g_strdup_printf (&quot;child process (%s) failed unexpectedly&quot;, process_id);
3661       g_assertion_message (domain, file, line, func, msg);
3662       g_free (msg);
3663     }
3664   if (must_fail &amp;&amp; g_test_trap_has_passed())
3665     {
3666       char *msg;
3667 
3668       logged_child_output = logged_child_output || log_child_output (process_id);
3669 
3670       msg = g_strdup_printf (&quot;child process (%s) did not fail as expected&quot;, process_id);
3671       g_assertion_message (domain, file, line, func, msg);
3672       g_free (msg);
3673     }
3674   if (stdout_pattern &amp;&amp; match_result == !g_pattern_match_simple (stdout_pattern, test_trap_last_stdout))
3675     {
3676       char *msg;
3677 
3678       logged_child_output = logged_child_output || log_child_output (process_id);
3679 
<span class="line-modified">3680       msg = g_strdup_printf (&quot;stdout of child process (%s) %s: %s\nstdout was:\n%s&quot;,</span>
<span class="line-added">3681                              process_id, match_error, stdout_pattern, test_trap_last_stdout);</span>
3682       g_assertion_message (domain, file, line, func, msg);
3683       g_free (msg);
3684     }
3685   if (stderr_pattern &amp;&amp; match_result == !g_pattern_match_simple (stderr_pattern, test_trap_last_stderr))
3686     {
3687       char *msg;
3688 
3689       logged_child_output = logged_child_output || log_child_output (process_id);
3690 
<span class="line-modified">3691       msg = g_strdup_printf (&quot;stderr of child process (%s) %s: %s\nstderr was:\n%s&quot;,</span>
<span class="line-added">3692                              process_id, match_error, stderr_pattern, test_trap_last_stderr);</span>
3693       g_assertion_message (domain, file, line, func, msg);
3694       g_free (msg);
3695     }
3696   g_free (process_id);
3697 }
3698 
3699 static void
3700 gstring_overwrite_int (GString *gstring,
3701                        guint    pos,
3702                        guint32  vuint)
3703 {
3704   vuint = g_htonl (vuint);
3705   g_string_overwrite_len (gstring, pos, (const gchar*) &amp;vuint, 4);
3706 }
3707 
3708 static void
3709 gstring_append_int (GString *gstring,
3710                     guint32  vuint)
3711 {
3712   vuint = g_htonl (vuint);
</pre>
<hr />
<pre>
3881 /**
3882  * g_test_log_msg_free:
3883  *
3884  * Internal function for gtester to free test log messages, no ABI guarantees provided.
3885  */
3886 void
3887 g_test_log_msg_free (GTestLogMsg *tmsg)
3888 {
3889   g_return_if_fail (tmsg != NULL);
3890   g_strfreev (tmsg-&gt;strings);
3891   g_free (tmsg-&gt;nums);
3892   g_free (tmsg);
3893 }
3894 
3895 static gchar *
3896 g_test_build_filename_va (GTestFileType  file_type,
3897                           const gchar   *first_path,
3898                           va_list        ap)
3899 {
3900   const gchar *pathv[16];
<span class="line-modified">3901   gsize num_path_segments;</span>
3902 
3903   if (file_type == G_TEST_DIST)
3904     pathv[0] = test_disted_files_dir;
3905   else if (file_type == G_TEST_BUILT)
3906     pathv[0] = test_built_files_dir;
3907   else
3908     g_assert_not_reached ();
3909 
3910   pathv[1] = first_path;
3911 
3912   for (num_path_segments = 2; num_path_segments &lt; G_N_ELEMENTS (pathv); num_path_segments++)
3913     {
3914       pathv[num_path_segments] = va_arg (ap, const char *);
3915       if (pathv[num_path_segments] == NULL)
3916         break;
3917     }
3918 
3919   g_assert_cmpint (num_path_segments, &lt;, G_N_ELEMENTS (pathv));
3920 
3921   return g_build_filenamev ((gchar **) pathv);
</pre>
<hr />
<pre>
4054 {
4055   gchar *result;
4056   GSList *node;
4057   va_list ap;
4058 
4059   g_assert (g_test_initialized ());
4060   if (test_filename_free_list == NULL)
4061     g_error (&quot;g_test_get_filename() can only be used within testcase functions&quot;);
4062 
4063   va_start (ap, first_path);
4064   result = g_test_build_filename_va (file_type, first_path, ap);
4065   va_end (ap);
4066 
4067   node = g_slist_prepend (NULL, result);
4068   do
4069     node-&gt;next = *test_filename_free_list;
4070   while (!g_atomic_pointer_compare_and_exchange (test_filename_free_list, node-&gt;next, node));
4071 
4072   return result;
4073 }






















</pre>
</td>
</tr>
</table>
<center><a href="gstring.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="gtestutils.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>