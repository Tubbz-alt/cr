<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.media/src/main/native/gstreamer/3rd_party/glib/glib/gutils.c</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="gutf8.c.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="gutils.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.media/src/main/native/gstreamer/3rd_party/glib/glib/gutils.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -27,17 +27,18 @@</span>
   */
  
  #include &quot;config.h&quot;
  
  #include &quot;gutils.h&quot;
<span class="udiff-line-added">+ #include &quot;gutilsprivate.h&quot;</span>
  
  #include &lt;stdarg.h&gt;
  #include &lt;stdlib.h&gt;
  #include &lt;stdio.h&gt;
  #include &lt;locale.h&gt;
  #include &lt;string.h&gt;
<span class="udiff-line-modified-removed">- #include &lt;ctype.h&gt;      /* For tolower() */</span>
<span class="udiff-line-modified-added">+ #include &lt;ctype.h&gt;    /* For tolower() */</span>
  #include &lt;errno.h&gt;
  #include &lt;sys/types.h&gt;
  #include &lt;sys/stat.h&gt;
  #ifdef G_OS_UNIX
  #include &lt;pwd.h&gt;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -86,45 +87,19 @@</span>
  #  include &lt;windows.h&gt;
  #  ifndef GET_MODULE_HANDLE_EX_FLAG_FROM_ADDRESS
  #    define GET_MODULE_HANDLE_EX_FLAG_UNCHANGED_REFCOUNT 2
  #    define GET_MODULE_HANDLE_EX_FLAG_FROM_ADDRESS 4
  #  endif
<span class="udiff-line-modified-removed">- #  include &lt;lmcons.h&gt;       /* For UNLEN */</span>
<span class="udiff-line-modified-added">+ #  include &lt;lmcons.h&gt;   /* For UNLEN */</span>
  #endif /* G_PLATFORM_WIN32 */
  
  #ifdef G_OS_WIN32
  #  include &lt;direct.h&gt;
  #  include &lt;shlobj.h&gt;
<span class="udiff-line-removed">-    /* older SDK (e.g. msvc 5.0) does not have these*/</span>
<span class="udiff-line-removed">- #  ifndef CSIDL_MYMUSIC</span>
<span class="udiff-line-removed">- #    define CSIDL_MYMUSIC 13</span>
<span class="udiff-line-removed">- #  endif</span>
<span class="udiff-line-removed">- #  ifndef CSIDL_MYVIDEO</span>
<span class="udiff-line-removed">- #    define CSIDL_MYVIDEO 14</span>
<span class="udiff-line-removed">- #  endif</span>
<span class="udiff-line-removed">- #  ifndef CSIDL_INTERNET_CACHE</span>
<span class="udiff-line-removed">- #    define CSIDL_INTERNET_CACHE 32</span>
<span class="udiff-line-removed">- #  endif</span>
<span class="udiff-line-removed">- #  ifndef CSIDL_COMMON_APPDATA</span>
<span class="udiff-line-removed">- #    define CSIDL_COMMON_APPDATA 35</span>
<span class="udiff-line-removed">- #  endif</span>
<span class="udiff-line-removed">- #  ifndef CSIDL_MYPICTURES</span>
<span class="udiff-line-removed">- #    define CSIDL_MYPICTURES 0x27</span>
<span class="udiff-line-removed">- #  endif</span>
<span class="udiff-line-removed">- #  ifndef CSIDL_COMMON_DOCUMENTS</span>
<span class="udiff-line-removed">- #    define CSIDL_COMMON_DOCUMENTS 46</span>
<span class="udiff-line-removed">- #  endif</span>
<span class="udiff-line-removed">- #  ifndef CSIDL_PROFILE</span>
<span class="udiff-line-removed">- #    define CSIDL_PROFILE 40</span>
<span class="udiff-line-removed">- #  endif</span>
  #  include &lt;process.h&gt;
  #endif
  
<span class="udiff-line-removed">- #ifdef HAVE_CARBON</span>
<span class="udiff-line-removed">- #include &lt;CoreServices/CoreServices.h&gt;</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- </span>
  #ifdef HAVE_CODESET
  #include &lt;langinfo.h&gt;
  #endif
  
  #ifdef G_PLATFORM_WIN32
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -221,10 +196,11 @@</span>
   * calling g_atexit() (or atexit()) except in the main executable of a
   * program.
   *
   * Deprecated:2.32: It is best to avoid g_atexit().
   */
<span class="udiff-line-added">+ G_GNUC_BEGIN_IGNORE_DEPRECATIONS</span>
  void
  g_atexit (GVoidFunc func)
  {
    gint result;
    int errsv;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -235,20 +211,21 @@</span>
      {
        g_error (&quot;Could not register atexit() function: %s&quot;,
                 g_strerror (errsv));
      }
  }
<span class="udiff-line-added">+ G_GNUC_END_IGNORE_DEPRECATIONS</span>
  
  #endif // GSTREAMER_LITE
  
  /* Based on execvp() from GNU Libc.
   * Some of this code is cut-and-pasted into gspawn.c
   */
  
  static gchar*
  my_strchrnul (const gchar *str,
<span class="udiff-line-modified-removed">-           gchar        c)</span>
<span class="udiff-line-modified-added">+         gchar        c)</span>
  {
    gchar *p = (gchar*)str;
    while (*p &amp;&amp; (*p != c))
      ++p;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -268,37 +245,37 @@</span>
        strchr (last_dot, &#39;\\&#39;) != NULL ||
        strchr (last_dot, &#39;/&#39;) != NULL)
      {
        const gint program_length = strlen (program);
        gchar *pathext = g_build_path (&quot;;&quot;,
<span class="udiff-line-modified-removed">-                      &quot;.exe;.cmd;.bat;.com&quot;,</span>
<span class="udiff-line-modified-removed">-                      g_getenv (&quot;PATHEXT&quot;),</span>
<span class="udiff-line-modified-removed">-                      NULL);</span>
<span class="udiff-line-modified-added">+              &quot;.exe;.cmd;.bat;.com&quot;,</span>
<span class="udiff-line-modified-added">+              g_getenv (&quot;PATHEXT&quot;),</span>
<span class="udiff-line-modified-added">+              NULL);</span>
        gchar *p;
        gchar *decorated_program;
        gchar *retval;
  
        p = pathext;
        do
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       gchar *q = my_strchrnul (p, &#39;;&#39;);</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     gchar *q = my_strchrnul (p, &#39;;&#39;);</span>
  
<span class="udiff-line-modified-removed">-       decorated_program = g_malloc (program_length + (q-p) + 1);</span>
<span class="udiff-line-modified-removed">-       memcpy (decorated_program, program, program_length);</span>
<span class="udiff-line-modified-removed">-       memcpy (decorated_program+program_length, p, q-p);</span>
<span class="udiff-line-modified-removed">-       decorated_program [program_length + (q-p)] = &#39;\0&#39;;</span>
<span class="udiff-line-modified-added">+     decorated_program = g_malloc (program_length + (q-p) + 1);</span>
<span class="udiff-line-modified-added">+     memcpy (decorated_program, program, program_length);</span>
<span class="udiff-line-modified-added">+     memcpy (decorated_program+program_length, p, q-p);</span>
<span class="udiff-line-modified-added">+     decorated_program [program_length + (q-p)] = &#39;\0&#39;;</span>
  
<span class="udiff-line-modified-removed">-       retval = inner_find_program_in_path (decorated_program);</span>
<span class="udiff-line-modified-removed">-       g_free (decorated_program);</span>
<span class="udiff-line-modified-added">+     retval = inner_find_program_in_path (decorated_program);</span>
<span class="udiff-line-modified-added">+     g_free (decorated_program);</span>
  
<span class="udiff-line-modified-removed">-       if (retval != NULL)</span>
<span class="udiff-line-modified-removed">-         {</span>
<span class="udiff-line-modified-removed">-           g_free (pathext);</span>
<span class="udiff-line-modified-removed">-           return retval;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-       p = q;</span>
<span class="udiff-line-modified-removed">-     } while (*p++ != &#39;\0&#39;);</span>
<span class="udiff-line-modified-added">+     if (retval != NULL)</span>
<span class="udiff-line-modified-added">+       {</span>
<span class="udiff-line-modified-added">+         g_free (pathext);</span>
<span class="udiff-line-modified-added">+         return retval;</span>
<span class="udiff-line-modified-added">+       }</span>
<span class="udiff-line-modified-added">+     p = q;</span>
<span class="udiff-line-modified-added">+   } while (*p++ != &#39;\0&#39;);</span>
        g_free (pathext);
        return NULL;
      }
    else
      return inner_find_program_in_path (program);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -363,11 +340,11 @@</span>
        || strchr (program, &#39;/&#39;) != NULL
  #endif
        )
      {
        if (g_file_test (program, G_FILE_TEST_IS_EXECUTABLE) &amp;&amp;
<span class="udiff-line-modified-removed">-       !g_file_test (program, G_FILE_TEST_IS_DIR))</span>
<span class="udiff-line-modified-added">+     !g_file_test (program, G_FILE_TEST_IS_DIR))</span>
          return g_strdup (program);
        else
          return NULL;
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -470,17 +447,17 @@</span>
          startp = name + 1;
        else
          startp = memcpy (name - (p - path), path, p - path);
  
        if (g_file_test (startp, G_FILE_TEST_IS_EXECUTABLE) &amp;&amp;
<span class="udiff-line-modified-removed">-       !g_file_test (startp, G_FILE_TEST_IS_DIR))</span>
<span class="udiff-line-modified-added">+     !g_file_test (startp, G_FILE_TEST_IS_DIR))</span>
          {
            gchar *ret;
            ret = g_strdup (startp);
            g_free (freeme);
  #ifdef G_OS_WIN32
<span class="udiff-line-modified-removed">-       g_free ((gchar *) path_copy);</span>
<span class="udiff-line-modified-added">+     g_free ((gchar *) path_copy);</span>
  #endif
            return ret;
          }
      }
    while (*p++ != &#39;\0&#39;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -561,16 +538,17 @@</span>
    gchar *user_name;
    gchar *real_name;
    gchar *home_dir;
  } UserDatabaseEntry;
  
<span class="udiff-line-added">+ /* These must all be read/written with @g_utils_global held. */</span>
  static  gchar   *g_user_data_dir = NULL;
  static  gchar  **g_system_data_dirs = NULL;
  static  gchar   *g_user_cache_dir = NULL;
  static  gchar   *g_user_config_dir = NULL;
<span class="udiff-line-added">+ static  gchar   *g_user_runtime_dir = NULL;</span>
  static  gchar  **g_system_config_dirs = NULL;
<span class="udiff-line-removed">- </span>
  static  gchar  **g_user_special_dirs = NULL;
  
  /* fifteen minutes of fame for everybody */
  #define G_USER_DIRS_EXPIRE      15 * 60
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -588,11 +566,11 @@</span>
    hr = SHGetSpecialFolderLocation (NULL, csidl, &amp;pidl);
    if (hr == S_OK)
      {
        b = SHGetPathFromIDListW (pidl, path);
        if (b)
<span class="udiff-line-modified-removed">-     retval = g_utf16_to_utf8 (path, -1, NULL, NULL, NULL);</span>
<span class="udiff-line-modified-added">+   retval = g_utf16_to_utf8 (path, -1, NULL, NULL, NULL);</span>
        CoTaskMemFree (pidl);
      }
    return retval;
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -608,15 +586,15 @@</span>
         */
        char *windowsdir = g_utf16_to_utf8 (wwindowsdir, -1, NULL, NULL, NULL);
        char *p;
  
        if (windowsdir == NULL)
<span class="udiff-line-modified-removed">-     return g_strdup (&quot;C:\\&quot;);</span>
<span class="udiff-line-modified-added">+   return g_strdup (&quot;C:\\&quot;);</span>
  
        p = (char *) g_path_skip_root (windowsdir);
        if (G_IS_DIR_SEPARATOR (p[-1]) &amp;&amp; p[-2] != &#39;:&#39;)
<span class="udiff-line-modified-removed">-     p--;</span>
<span class="udiff-line-modified-added">+   p--;</span>
        *p = &#39;\0&#39;;
        return windowsdir;
      }
    else
      return g_strdup (&quot;C:\\&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -796,10 +774,83 @@</span>
    entry = g_get_user_database_entry ();
  
    return entry-&gt;real_name;
  }
  
<span class="udiff-line-added">+ /* Protected by @g_utils_global_lock. */</span>
<span class="udiff-line-added">+ static gchar *g_home_dir = NULL;  /* (owned) (nullable before initialised) */</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ static gchar *</span>
<span class="udiff-line-added">+ g_build_home_dir (void)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+   gchar *home_dir;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   /* We first check HOME and use it if it is set */</span>
<span class="udiff-line-added">+   home_dir = g_strdup (g_getenv (&quot;HOME&quot;));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #ifdef G_OS_WIN32</span>
<span class="udiff-line-added">+   /* Only believe HOME if it is an absolute path and exists.</span>
<span class="udiff-line-added">+    *</span>
<span class="udiff-line-added">+    * We only do this check on Windows for a couple of reasons.</span>
<span class="udiff-line-added">+    * Historically, we only did it there because we used to ignore $HOME</span>
<span class="udiff-line-added">+    * on UNIX.  There are concerns about enabling it now on UNIX because</span>
<span class="udiff-line-added">+    * of things like autofs.  In short, if the user has a bogus value in</span>
<span class="udiff-line-added">+    * $HOME then they get what they pay for...</span>
<span class="udiff-line-added">+    */</span>
<span class="udiff-line-added">+   if (home_dir != NULL)</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       if (!(g_path_is_absolute (home_dir) &amp;&amp;</span>
<span class="udiff-line-added">+             g_file_test (home_dir, G_FILE_TEST_IS_DIR)))</span>
<span class="udiff-line-added">+         g_clear_pointer (&amp;home_dir, g_free);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   /* In case HOME is Unix-style (it happens), convert it to</span>
<span class="udiff-line-added">+    * Windows style.</span>
<span class="udiff-line-added">+    */</span>
<span class="udiff-line-added">+   if (home_dir != NULL)</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       gchar *p;</span>
<span class="udiff-line-added">+       while ((p = strchr (home_dir, &#39;/&#39;)) != NULL)</span>
<span class="udiff-line-added">+         *p = &#39;\\&#39;;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   if (home_dir == NULL)</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       /* USERPROFILE is probably the closest equivalent to $HOME? */</span>
<span class="udiff-line-added">+       if (g_getenv (&quot;USERPROFILE&quot;) != NULL)</span>
<span class="udiff-line-added">+         home_dir = g_strdup (g_getenv (&quot;USERPROFILE&quot;));</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   if (home_dir == NULL)</span>
<span class="udiff-line-added">+     home_dir = get_special_folder (CSIDL_PROFILE);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   if (home_dir == NULL)</span>
<span class="udiff-line-added">+     home_dir = get_windows_directory_root ();</span>
<span class="udiff-line-added">+ #endif /* G_OS_WIN32 */</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   if (home_dir == NULL)</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       /* If we didn&#39;t get it from any of those methods, we will have</span>
<span class="udiff-line-added">+        * to read the user database entry.</span>
<span class="udiff-line-added">+        */</span>
<span class="udiff-line-added">+       UserDatabaseEntry *entry = g_get_user_database_entry ();</span>
<span class="udiff-line-added">+       home_dir = g_strdup (entry-&gt;home_dir);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   /* If we have been denied access to /etc/passwd (for example, by an</span>
<span class="udiff-line-added">+    * overly-zealous LSM), make up a junk value. The return value at this</span>
<span class="udiff-line-added">+    * point is explicitly documented as &#39;undefined&#39;. */</span>
<span class="udiff-line-added">+   if (home_dir == NULL)</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       g_warning (&quot;Could not find home directory: $HOME is not set, and &quot;</span>
<span class="udiff-line-added">+                  &quot;user database could not be read.&quot;);</span>
<span class="udiff-line-added">+       home_dir = g_strdup (&quot;/&quot;);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   return g_steal_pointer (&amp;home_dir);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  /**
   * g_get_home_dir:
   *
   * Gets the current user&#39;s home directory.
   *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -825,91 +876,19 @@</span>
   * Returns: (type filename): the current user&#39;s home directory
   */
  const gchar *
  g_get_home_dir (void)
  {
<span class="udiff-line-modified-removed">-   static gchar *home_dir;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   if (g_once_init_enter (&amp;home_dir))</span>
<span class="udiff-line-removed">-     {</span>
<span class="udiff-line-removed">-       gchar *tmp;</span>
<span class="udiff-line-modified-added">+   const gchar *home_dir;</span>
  
<span class="udiff-line-modified-removed">-       /* We first check HOME and use it if it is set */</span>
<span class="udiff-line-removed">-       tmp = g_strdup (g_getenv (&quot;HOME&quot;));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- #ifdef G_OS_WIN32</span>
<span class="udiff-line-removed">-       /* Only believe HOME if it is an absolute path and exists.</span>
<span class="udiff-line-removed">-        *</span>
<span class="udiff-line-removed">-        * We only do this check on Windows for a couple of reasons.</span>
<span class="udiff-line-removed">-        * Historically, we only did it there because we used to ignore $HOME</span>
<span class="udiff-line-removed">-        * on UNIX.  There are concerns about enabling it now on UNIX because</span>
<span class="udiff-line-removed">-        * of things like autofs.  In short, if the user has a bogus value in</span>
<span class="udiff-line-removed">-        * $HOME then they get what they pay for...</span>
<span class="udiff-line-removed">-        */</span>
<span class="udiff-line-removed">-       if (tmp)</span>
<span class="udiff-line-removed">-         {</span>
<span class="udiff-line-removed">-           if (!(g_path_is_absolute (tmp) &amp;&amp;</span>
<span class="udiff-line-removed">-                 g_file_test (tmp, G_FILE_TEST_IS_DIR)))</span>
<span class="udiff-line-removed">-             {</span>
<span class="udiff-line-removed">-               g_free (tmp);</span>
<span class="udiff-line-removed">-               tmp = NULL;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-       /* In case HOME is Unix-style (it happens), convert it to</span>
<span class="udiff-line-removed">-        * Windows style.</span>
<span class="udiff-line-removed">-        */</span>
<span class="udiff-line-removed">-       if (tmp)</span>
<span class="udiff-line-removed">-         {</span>
<span class="udiff-line-removed">-           gchar *p;</span>
<span class="udiff-line-removed">-           while ((p = strchr (tmp, &#39;/&#39;)) != NULL)</span>
<span class="udiff-line-removed">-             *p = &#39;\\&#39;;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-       if (!tmp)</span>
<span class="udiff-line-removed">-         {</span>
<span class="udiff-line-removed">-           /* USERPROFILE is probably the closest equivalent to $HOME? */</span>
<span class="udiff-line-removed">-           if (g_getenv (&quot;USERPROFILE&quot;) != NULL)</span>
<span class="udiff-line-removed">-             tmp = g_strdup (g_getenv (&quot;USERPROFILE&quot;));</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-       if (!tmp)</span>
<span class="udiff-line-removed">-         tmp = get_special_folder (CSIDL_PROFILE);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-       if (!tmp)</span>
<span class="udiff-line-removed">-         tmp = get_windows_directory_root ();</span>
<span class="udiff-line-removed">- #endif /* G_OS_WIN32 */</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-       if (!tmp)</span>
<span class="udiff-line-removed">-         {</span>
<span class="udiff-line-removed">-           /* If we didn&#39;t get it from any of those methods, we will have</span>
<span class="udiff-line-removed">-            * to read the user database entry.</span>
<span class="udiff-line-removed">-            */</span>
<span class="udiff-line-removed">-           UserDatabaseEntry *entry;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-           entry = g_get_user_database_entry ();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-           /* Strictly speaking, we should copy this, but we know that</span>
<span class="udiff-line-removed">-            * neither will ever be freed, so don&#39;t bother...</span>
<span class="udiff-line-removed">-            */</span>
<span class="udiff-line-removed">-           tmp = entry-&gt;home_dir;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+   G_LOCK (g_utils_global);</span>
  
<span class="udiff-line-modified-removed">-       /* If we have been denied access to /etc/passwd (for example, by an</span>
<span class="udiff-line-modified-removed">-        * overly-zealous LSM), make up a junk value. The return value at this</span>
<span class="udiff-line-modified-removed">-        * point is explicitly documented as �?undefined’. Memory management is as</span>
<span class="udiff-line-removed">-        * immediately above: strictly this should be copied, but we know not</span>
<span class="udiff-line-removed">-        * copying it is OK. */</span>
<span class="udiff-line-removed">-       if (tmp == NULL)</span>
<span class="udiff-line-removed">-         {</span>
<span class="udiff-line-removed">-           g_warning (&quot;Could not find home directory: $HOME is not set, and &quot;</span>
<span class="udiff-line-removed">-                      &quot;user database could not be read.&quot;);</span>
<span class="udiff-line-removed">-           tmp = &quot;/&quot;;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+   if (g_home_dir == NULL)</span>
<span class="udiff-line-modified-added">+     g_home_dir = g_build_home_dir ();</span>
<span class="udiff-line-modified-added">+   home_dir = g_home_dir;</span>
  
<span class="udiff-line-modified-removed">-       g_once_init_leave (&amp;home_dir, tmp);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+   G_UNLOCK (g_utils_global);</span>
  
    return home_dir;
  }
  
  /**
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1008,12 +987,41 @@</span>
      {
        gboolean failed;
        gchar *utmp;
  
  #ifndef G_OS_WIN32
<span class="udiff-line-modified-removed">-       gchar *tmp = g_malloc (sizeof (gchar) * 100);</span>
<span class="udiff-line-modified-removed">-       failed = (gethostname (tmp, sizeof (gchar) * 100) == -1);</span>
<span class="udiff-line-modified-added">+       glong max;</span>
<span class="udiff-line-modified-added">+       gsize size;</span>
<span class="udiff-line-added">+       /* The number 256 * 256 is taken from the value of _POSIX_HOST_NAME_MAX,</span>
<span class="udiff-line-added">+        * which is 255. Since we use _POSIX_HOST_NAME_MAX + 1 (= 256) in the</span>
<span class="udiff-line-added">+        * fallback case, we pick 256 * 256 as the size of the larger buffer here.</span>
<span class="udiff-line-added">+        * It should be large enough. It doesn&#39;t looks reasonable to name a host</span>
<span class="udiff-line-added">+        * with a string that is longer than 64 KiB.</span>
<span class="udiff-line-added">+        */</span>
<span class="udiff-line-added">+       const gsize size_large = (gsize) 256 * 256;</span>
<span class="udiff-line-added">+       gchar *tmp;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       max = sysconf (_SC_HOST_NAME_MAX);</span>
<span class="udiff-line-added">+       if (max &gt; 0 &amp;&amp; max &lt;= G_MAXSIZE - 1)</span>
<span class="udiff-line-added">+         size = (gsize) max + 1;</span>
<span class="udiff-line-added">+       else</span>
<span class="udiff-line-added">+ #ifdef HOST_NAME_MAX</span>
<span class="udiff-line-added">+         size = HOST_NAME_MAX + 1;</span>
<span class="udiff-line-added">+ #else</span>
<span class="udiff-line-added">+         size = _POSIX_HOST_NAME_MAX + 1;</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       tmp = g_malloc (size);</span>
<span class="udiff-line-added">+       failed = (gethostname (tmp, size) == -1);</span>
<span class="udiff-line-added">+       if (failed &amp;&amp; size &lt; size_large)</span>
<span class="udiff-line-added">+         {</span>
<span class="udiff-line-added">+           /* Try again with a larger buffer if &#39;size&#39; may be too small. */</span>
<span class="udiff-line-added">+           g_free (tmp);</span>
<span class="udiff-line-added">+           tmp = g_malloc (size_large);</span>
<span class="udiff-line-added">+           failed = (gethostname (tmp, size_large) == -1);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
        if (failed)
          g_clear_pointer (&amp;tmp, g_free);
        utmp = tmp;
  #else
        wchar_t tmp[MAX_COMPUTERNAME_LENGTH + 1];
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1044,42 +1052,20 @@</span>
   * g_application_run(). In case of GDK or GTK+ it is set in
   * gdk_init(), which is called by gtk_init() and the
   * #GtkApplication::startup handler. The program name is found by
   * taking the last component of @argv[0].
   *
<span class="udiff-line-modified-removed">-  * Returns: the name of the program. The returned string belongs</span>
<span class="udiff-line-modified-added">+  * Returns: (nullable): the name of the program, or %NULL if it has not been</span>
<span class="udiff-line-added">+  *     set yet. The returned string belongs</span>
   *     to GLib and must not be modified or freed.
   */
  const gchar*
  g_get_prgname (void)
  {
    gchar* retval;
  
    G_LOCK (g_prgname);
<span class="udiff-line-removed">- #ifdef G_OS_WIN32</span>
<span class="udiff-line-removed">-   if (g_prgname == NULL)</span>
<span class="udiff-line-removed">-     {</span>
<span class="udiff-line-removed">-       static gboolean beenhere = FALSE;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-       if (!beenhere)</span>
<span class="udiff-line-removed">-     {</span>
<span class="udiff-line-removed">-       gchar *utf8_buf = NULL;</span>
<span class="udiff-line-removed">-       wchar_t buf[MAX_PATH+1];</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-       beenhere = TRUE;</span>
<span class="udiff-line-removed">-       if (GetModuleFileNameW (GetModuleHandle (NULL),</span>
<span class="udiff-line-removed">-                   buf, G_N_ELEMENTS (buf)) &gt; 0)</span>
<span class="udiff-line-removed">-         utf8_buf = g_utf16_to_utf8 (buf, -1, NULL, NULL, NULL);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-       if (utf8_buf)</span>
<span class="udiff-line-removed">-         {</span>
<span class="udiff-line-removed">-           g_prgname = g_path_get_basename (utf8_buf);</span>
<span class="udiff-line-removed">-           g_free (utf8_buf);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- #endif</span>
    retval = g_prgname;
    G_UNLOCK (g_prgname);
  
    return retval;
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1173,10 +1159,139 @@</span>
  
    if (already_set)
      g_warning (&quot;g_set_application_name() called multiple times&quot;);
  }
  
<span class="udiff-line-added">+ /* Set @global_str to a copy of @new_value if it&#39;s currently unset or has a</span>
<span class="udiff-line-added">+  * different value. If its current value matches @new_value, do nothing. If</span>
<span class="udiff-line-added">+  * replaced, we have to leak the old value as client code could still have</span>
<span class="udiff-line-added">+  * pointers to it. */</span>
<span class="udiff-line-added">+ static void</span>
<span class="udiff-line-added">+ set_str_if_different (gchar       **global_str,</span>
<span class="udiff-line-added">+                       const gchar  *type,</span>
<span class="udiff-line-added">+                       const gchar  *new_value)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+   if (*global_str == NULL ||</span>
<span class="udiff-line-added">+       !g_str_equal (new_value, *global_str))</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       g_debug (&quot;g_set_user_dirs: Setting %s to %s&quot;, type, new_value);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       /* We have to leak the old value, as user code could be retaining pointers</span>
<span class="udiff-line-added">+        * to it. */</span>
<span class="udiff-line-added">+       *global_str = g_strdup (new_value);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ static void</span>
<span class="udiff-line-added">+ set_strv_if_different (gchar                ***global_strv,</span>
<span class="udiff-line-added">+                        const gchar            *type,</span>
<span class="udiff-line-added">+                        const gchar  * const   *new_value)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+   if (*global_strv == NULL ||</span>
<span class="udiff-line-added">+       !g_strv_equal (new_value, (const gchar * const *) *global_strv))</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       gchar *new_value_str = g_strjoinv (&quot;:&quot;, (gchar **) new_value);</span>
<span class="udiff-line-added">+       g_debug (&quot;g_set_user_dirs: Setting %s to %s&quot;, type, new_value_str);</span>
<span class="udiff-line-added">+       g_free (new_value_str);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       /* We have to leak the old value, as user code could be retaining pointers</span>
<span class="udiff-line-added">+        * to it. */</span>
<span class="udiff-line-added">+       *global_strv = g_strdupv ((gchar **) new_value);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ /*</span>
<span class="udiff-line-added">+  * g_set_user_dirs:</span>
<span class="udiff-line-added">+  * @first_dir_type: Type of the first directory to set</span>
<span class="udiff-line-added">+  * @...: Value to set the first directory to, followed by additional type/value</span>
<span class="udiff-line-added">+  *    pairs, followed by %NULL</span>
<span class="udiff-line-added">+  *</span>
<span class="udiff-line-added">+  * Set one or more &#39;user&#39; directories to custom values. This is intended to be</span>
<span class="udiff-line-added">+  * used by test code (particularly with the %G_TEST_OPTION_ISOLATE_DIRS option)</span>
<span class="udiff-line-added">+  * to override the values returned by the following functions, so that test</span>
<span class="udiff-line-added">+  * code can be run without touching an installed system and user data:</span>
<span class="udiff-line-added">+  *</span>
<span class="udiff-line-added">+  *  - g_get_home_dir() - use type `HOME`, pass a string</span>
<span class="udiff-line-added">+  *  - g_get_user_cache_dir() - use type `XDG_CACHE_HOME`, pass a string</span>
<span class="udiff-line-added">+  *  - g_get_system_config_dirs() - use type `XDG_CONFIG_DIRS`, pass a</span>
<span class="udiff-line-added">+  *    %NULL-terminated string array</span>
<span class="udiff-line-added">+  *  - g_get_user_config_dir() - use type `XDG_CONFIG_HOME`, pass a string</span>
<span class="udiff-line-added">+  *  - g_get_system_data_dirs() - use type `XDG_DATA_DIRS`, pass a</span>
<span class="udiff-line-added">+  *    %NULL-terminated string array</span>
<span class="udiff-line-added">+  *  - g_get_user_data_dir() - use type `XDG_DATA_HOME`, pass a string</span>
<span class="udiff-line-added">+  *  - g_get_user_runtime_dir() - use type `XDG_RUNTIME_DIR`, pass a string</span>
<span class="udiff-line-added">+  *</span>
<span class="udiff-line-added">+  * The list must be terminated with a %NULL type. All of the values must be</span>
<span class="udiff-line-added">+  * non-%NULL - passing %NULL as a value won&#39;t reset a directory. If a reference</span>
<span class="udiff-line-added">+  * to a directory from the calling environment needs to be kept, copy it before</span>
<span class="udiff-line-added">+  * the first call to g_set_user_dirs(). g_set_user_dirs() can be called multiple</span>
<span class="udiff-line-added">+  * times.</span>
<span class="udiff-line-added">+  *</span>
<span class="udiff-line-added">+  * Since: 2.60</span>
<span class="udiff-line-added">+  */</span>
<span class="udiff-line-added">+ /*&lt; private &gt; */</span>
<span class="udiff-line-added">+ void</span>
<span class="udiff-line-added">+ g_set_user_dirs (const gchar *first_dir_type,</span>
<span class="udiff-line-added">+                  ...)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+   va_list args;</span>
<span class="udiff-line-added">+   const gchar *dir_type;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   G_LOCK (g_utils_global);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   va_start (args, first_dir_type);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   for (dir_type = first_dir_type; dir_type != NULL; dir_type = va_arg (args, const gchar *))</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       gconstpointer dir_value = va_arg (args, gconstpointer);</span>
<span class="udiff-line-added">+       g_assert (dir_value != NULL);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       if (g_str_equal (dir_type, &quot;HOME&quot;))</span>
<span class="udiff-line-added">+         set_str_if_different (&amp;g_home_dir, dir_type, dir_value);</span>
<span class="udiff-line-added">+       else if (g_str_equal (dir_type, &quot;XDG_CACHE_HOME&quot;))</span>
<span class="udiff-line-added">+         set_str_if_different (&amp;g_user_cache_dir, dir_type, dir_value);</span>
<span class="udiff-line-added">+       else if (g_str_equal (dir_type, &quot;XDG_CONFIG_DIRS&quot;))</span>
<span class="udiff-line-added">+         set_strv_if_different (&amp;g_system_config_dirs, dir_type, dir_value);</span>
<span class="udiff-line-added">+       else if (g_str_equal (dir_type, &quot;XDG_CONFIG_HOME&quot;))</span>
<span class="udiff-line-added">+         set_str_if_different (&amp;g_user_config_dir, dir_type, dir_value);</span>
<span class="udiff-line-added">+       else if (g_str_equal (dir_type, &quot;XDG_DATA_DIRS&quot;))</span>
<span class="udiff-line-added">+         set_strv_if_different (&amp;g_system_data_dirs, dir_type, dir_value);</span>
<span class="udiff-line-added">+       else if (g_str_equal (dir_type, &quot;XDG_DATA_HOME&quot;))</span>
<span class="udiff-line-added">+         set_str_if_different (&amp;g_user_data_dir, dir_type, dir_value);</span>
<span class="udiff-line-added">+       else if (g_str_equal (dir_type, &quot;XDG_RUNTIME_DIR&quot;))</span>
<span class="udiff-line-added">+         set_str_if_different (&amp;g_user_runtime_dir, dir_type, dir_value);</span>
<span class="udiff-line-added">+       else</span>
<span class="udiff-line-added">+         g_assert_not_reached ();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   va_end (args);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   G_UNLOCK (g_utils_global);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ static gchar *</span>
<span class="udiff-line-added">+ g_build_user_data_dir (void)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+   gchar *data_dir = NULL;</span>
<span class="udiff-line-added">+   const gchar *data_dir_env = g_getenv (&quot;XDG_DATA_HOME&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   if (data_dir_env &amp;&amp; data_dir_env[0])</span>
<span class="udiff-line-added">+     data_dir = g_strdup (data_dir_env);</span>
<span class="udiff-line-added">+ #ifdef G_OS_WIN32</span>
<span class="udiff-line-added">+   else</span>
<span class="udiff-line-added">+     data_dir = get_special_folder (CSIDL_LOCAL_APPDATA);</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+   if (!data_dir || !data_dir[0])</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       gchar *home_dir = g_build_home_dir ();</span>
<span class="udiff-line-added">+       data_dir = g_build_filename (home_dir, &quot;.local&quot;, &quot;share&quot;, NULL);</span>
<span class="udiff-line-added">+       g_free (home_dir);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   return g_steal_pointer (&amp;data_dir);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  /**
   * g_get_user_data_dir:
   *
   * Returns a base directory in which to access application data such
   * as icons that is customized for a particular user.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1198,71 +1313,43 @@</span>
   * Since: 2.6
   **/
  const gchar *
  g_get_user_data_dir (void)
  {
<span class="udiff-line-modified-removed">-   gchar *data_dir = NULL;</span>
<span class="udiff-line-modified-added">+   const gchar *user_data_dir;</span>
  
    G_LOCK (g_utils_global);
  
<span class="udiff-line-modified-removed">-   if (!g_user_data_dir)</span>
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       const gchar *data_dir_env = g_getenv (&quot;XDG_DATA_HOME&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-       if (data_dir_env &amp;&amp; data_dir_env[0])</span>
<span class="udiff-line-removed">-         data_dir = g_strdup (data_dir_env);</span>
<span class="udiff-line-removed">- #ifdef G_OS_WIN32</span>
<span class="udiff-line-removed">-       else</span>
<span class="udiff-line-removed">-       data_dir = get_special_folder (CSIDL_LOCAL_APPDATA);</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">-       if (!data_dir || !data_dir[0])</span>
<span class="udiff-line-removed">-     {</span>
<span class="udiff-line-removed">-           const gchar *home_dir = g_get_home_dir ();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-           if (home_dir)</span>
<span class="udiff-line-removed">-             data_dir = g_build_filename (home_dir, &quot;.local&quot;, &quot;share&quot;, NULL);</span>
<span class="udiff-line-removed">-       else</span>
<span class="udiff-line-removed">-             data_dir = g_build_filename (g_get_tmp_dir (), g_get_user_name (), &quot;.local&quot;, &quot;share&quot;, NULL);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-       g_user_data_dir = data_dir;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-   else</span>
<span class="udiff-line-removed">-     data_dir = g_user_data_dir;</span>
<span class="udiff-line-modified-added">+   if (g_user_data_dir == NULL)</span>
<span class="udiff-line-modified-added">+     g_user_data_dir = g_build_user_data_dir ();</span>
<span class="udiff-line-modified-added">+   user_data_dir = g_user_data_dir;</span>
  
    G_UNLOCK (g_utils_global);
  
<span class="udiff-line-modified-removed">-   return data_dir;</span>
<span class="udiff-line-modified-added">+   return user_data_dir;</span>
  }
  
<span class="udiff-line-modified-removed">- static void</span>
<span class="udiff-line-modified-removed">- g_init_user_config_dir (void)</span>
<span class="udiff-line-modified-added">+ static gchar *</span>
<span class="udiff-line-modified-added">+ g_build_user_config_dir (void)</span>
  {
    gchar *config_dir = NULL;
<span class="udiff-line-added">+   const gchar *config_dir_env = g_getenv (&quot;XDG_CONFIG_HOME&quot;);</span>
  
<span class="udiff-line-modified-removed">-   if (!g_user_config_dir)</span>
<span class="udiff-line-removed">-     {</span>
<span class="udiff-line-removed">-       const gchar *config_dir_env = g_getenv (&quot;XDG_CONFIG_HOME&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-       if (config_dir_env &amp;&amp; config_dir_env[0])</span>
<span class="udiff-line-modified-added">+   if (config_dir_env &amp;&amp; config_dir_env[0])</span>
      config_dir = g_strdup (config_dir_env);
  #ifdef G_OS_WIN32
<span class="udiff-line-modified-removed">-       else</span>
<span class="udiff-line-modified-removed">-       config_dir = get_special_folder (CSIDL_LOCAL_APPDATA);</span>
<span class="udiff-line-modified-added">+   else</span>
<span class="udiff-line-modified-added">+     config_dir = get_special_folder (CSIDL_LOCAL_APPDATA);</span>
  #endif
<span class="udiff-line-modified-removed">-       if (!config_dir || !config_dir[0])</span>
<span class="udiff-line-modified-added">+   if (!config_dir || !config_dir[0])</span>
      {
<span class="udiff-line-modified-removed">-           const gchar *home_dir = g_get_home_dir ();</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-           if (home_dir)</span>
<span class="udiff-line-removed">-             config_dir = g_build_filename (home_dir, &quot;.config&quot;, NULL);</span>
<span class="udiff-line-removed">-       else</span>
<span class="udiff-line-removed">-             config_dir = g_build_filename (g_get_tmp_dir (), g_get_user_name (), &quot;.config&quot;, NULL);</span>
<span class="udiff-line-modified-added">+       gchar *home_dir = g_build_home_dir ();</span>
<span class="udiff-line-modified-added">+       config_dir = g_build_filename (home_dir, &quot;.config&quot;, NULL);</span>
<span class="udiff-line-modified-added">+       g_free (home_dir);</span>
      }
  
<span class="udiff-line-modified-removed">-       g_user_config_dir = config_dir;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+   return g_steal_pointer (&amp;config_dir);</span>
  }
  
  /**
   * g_get_user_config_dir:
   *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1286,17 +1373,43 @@</span>
   * Since: 2.6
   **/
  const gchar *
  g_get_user_config_dir (void)
  {
<span class="udiff-line-added">+   const gchar *user_config_dir;</span>
<span class="udiff-line-added">+ </span>
    G_LOCK (g_utils_global);
  
<span class="udiff-line-modified-removed">-   g_init_user_config_dir ();</span>
<span class="udiff-line-modified-added">+   if (g_user_config_dir == NULL)</span>
<span class="udiff-line-added">+     g_user_config_dir = g_build_user_config_dir ();</span>
<span class="udiff-line-added">+   user_config_dir = g_user_config_dir;</span>
  
    G_UNLOCK (g_utils_global);
  
<span class="udiff-line-modified-removed">-   return g_user_config_dir;</span>
<span class="udiff-line-modified-added">+   return user_config_dir;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ static gchar *</span>
<span class="udiff-line-added">+ g_build_user_cache_dir (void)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+   gchar *cache_dir = NULL;</span>
<span class="udiff-line-added">+   const gchar *cache_dir_env = g_getenv (&quot;XDG_CACHE_HOME&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   if (cache_dir_env &amp;&amp; cache_dir_env[0])</span>
<span class="udiff-line-added">+     cache_dir = g_strdup (cache_dir_env);</span>
<span class="udiff-line-added">+ #ifdef G_OS_WIN32</span>
<span class="udiff-line-added">+   else</span>
<span class="udiff-line-added">+     cache_dir = get_special_folder (CSIDL_INTERNET_CACHE);</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+   if (!cache_dir || !cache_dir[0])</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       gchar *home_dir = g_build_home_dir ();</span>
<span class="udiff-line-added">+       cache_dir = g_build_filename (home_dir, &quot;.cache&quot;, NULL);</span>
<span class="udiff-line-added">+       g_free (home_dir);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   return g_steal_pointer (&amp;cache_dir);</span>
  }
  
  /**
   * g_get_user_cache_dir:
   *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1319,41 +1432,49 @@</span>
   * Since: 2.6
   **/
  const gchar *
  g_get_user_cache_dir (void)
  {
<span class="udiff-line-modified-removed">-   gchar *cache_dir = NULL;</span>
<span class="udiff-line-modified-added">+   const gchar *user_cache_dir;</span>
  
    G_LOCK (g_utils_global);
  
<span class="udiff-line-modified-removed">-   if (!g_user_cache_dir)</span>
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       const gchar *cache_dir_env = g_getenv (&quot;XDG_CACHE_HOME&quot;);</span>
<span class="udiff-line-modified-added">+   if (g_user_cache_dir == NULL)</span>
<span class="udiff-line-modified-added">+     g_user_cache_dir = g_build_user_cache_dir ();</span>
<span class="udiff-line-modified-added">+   user_cache_dir = g_user_cache_dir;</span>
  
<span class="udiff-line-modified-removed">-       if (cache_dir_env &amp;&amp; cache_dir_env[0])</span>
<span class="udiff-line-removed">-         cache_dir = g_strdup (cache_dir_env);</span>
<span class="udiff-line-removed">- #ifdef G_OS_WIN32</span>
<span class="udiff-line-removed">-       else</span>
<span class="udiff-line-removed">-         cache_dir = get_special_folder (CSIDL_INTERNET_CACHE);</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">-       if (!cache_dir || !cache_dir[0])</span>
<span class="udiff-line-removed">-     {</span>
<span class="udiff-line-removed">-           const gchar *home_dir = g_get_home_dir ();</span>
<span class="udiff-line-modified-added">+   G_UNLOCK (g_utils_global);</span>
  
<span class="udiff-line-modified-removed">-           if (home_dir)</span>
<span class="udiff-line-modified-removed">-             cache_dir = g_build_filename (home_dir, &quot;.cache&quot;, NULL);</span>
<span class="udiff-line-modified-removed">-       else</span>
<span class="udiff-line-modified-removed">-             cache_dir = g_build_filename (g_get_tmp_dir (), g_get_user_name (), &quot;.cache&quot;, NULL);</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-removed">-       g_user_cache_dir = cache_dir;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   return user_cache_dir;</span>
<span class="udiff-line-modified-added">+ }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+ static gchar *</span>
<span class="udiff-line-modified-added">+ g_build_user_runtime_dir (void)</span>
<span class="udiff-line-modified-added">+ {</span>
<span class="udiff-line-modified-added">+   gchar *runtime_dir = NULL;</span>
<span class="udiff-line-added">+   const gchar *runtime_dir_env = g_getenv (&quot;XDG_RUNTIME_DIR&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   if (runtime_dir_env &amp;&amp; runtime_dir_env[0])</span>
<span class="udiff-line-added">+     runtime_dir = g_strdup (runtime_dir_env);</span>
    else
<span class="udiff-line-modified-removed">-     cache_dir = g_user_cache_dir;</span>
<span class="udiff-line-modified-added">+     {</span>
<span class="udiff-line-added">+       runtime_dir = g_build_user_cache_dir ();</span>
  
<span class="udiff-line-modified-removed">-   G_UNLOCK (g_utils_global);</span>
<span class="udiff-line-modified-added">+       /* The user should be able to rely on the directory existing</span>
<span class="udiff-line-added">+        * when the function returns.  Probably it already does, but</span>
<span class="udiff-line-added">+        * let&#39;s make sure.  Just do mkdir() directly since it will be</span>
<span class="udiff-line-added">+        * no more expensive than a stat() in the case that the</span>
<span class="udiff-line-added">+        * directory already exists and is a lot easier.</span>
<span class="udiff-line-added">+        *</span>
<span class="udiff-line-added">+        * $XDG_CACHE_HOME is probably ~/.cache/ so as long as $HOME</span>
<span class="udiff-line-added">+        * exists this will work.  If the user changed $XDG_CACHE_HOME</span>
<span class="udiff-line-added">+        * then they can make sure that it exists...</span>
<span class="udiff-line-added">+        */</span>
<span class="udiff-line-added">+       (void) g_mkdir (runtime_dir, 0700);</span>
<span class="udiff-line-added">+     }</span>
  
<span class="udiff-line-modified-removed">-   return cache_dir;</span>
<span class="udiff-line-modified-added">+   return g_steal_pointer (&amp;runtime_dir);</span>
  }
  
  /**
   * g_get_user_runtime_dir:
   *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1374,116 +1495,54 @@</span>
   * Since: 2.28
   **/
  const gchar *
  g_get_user_runtime_dir (void)
  {
<span class="udiff-line-modified-removed">-   static const gchar *runtime_dir;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   if (g_once_init_enter (&amp;runtime_dir))</span>
<span class="udiff-line-removed">-     {</span>
<span class="udiff-line-removed">-       const gchar *dir;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-       dir = g_strdup (getenv (&quot;XDG_RUNTIME_DIR&quot;));</span>
<span class="udiff-line-modified-added">+   const gchar *user_runtime_dir;</span>
  
<span class="udiff-line-modified-removed">-       if (dir == NULL)</span>
<span class="udiff-line-removed">-         {</span>
<span class="udiff-line-removed">-           /* No need to strdup this one since it is valid forever. */</span>
<span class="udiff-line-removed">-           dir = g_get_user_cache_dir ();</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-           /* The user should be able to rely on the directory existing</span>
<span class="udiff-line-removed">-            * when the function returns.  Probably it already does, but</span>
<span class="udiff-line-removed">-            * let&#39;s make sure.  Just do mkdir() directly since it will be</span>
<span class="udiff-line-removed">-            * no more expensive than a stat() in the case that the</span>
<span class="udiff-line-removed">-            * directory already exists and is a lot easier.</span>
<span class="udiff-line-removed">-            *</span>
<span class="udiff-line-removed">-            * $XDG_CACHE_HOME is probably ~/.cache/ so as long as $HOME</span>
<span class="udiff-line-removed">-            * exists this will work.  If the user changed $XDG_CACHE_HOME</span>
<span class="udiff-line-removed">-            * then they can make sure that it exists...</span>
<span class="udiff-line-removed">-    */</span>
<span class="udiff-line-removed">-           (void) g_mkdir (dir, 0700);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+   G_LOCK (g_utils_global);</span>
  
<span class="udiff-line-modified-removed">-       g_assert (dir != NULL);</span>
<span class="udiff-line-modified-added">+   if (g_user_runtime_dir == NULL)</span>
<span class="udiff-line-added">+     g_user_runtime_dir = g_build_user_runtime_dir ();</span>
<span class="udiff-line-added">+   user_runtime_dir = g_user_runtime_dir;</span>
  
<span class="udiff-line-modified-removed">-       g_once_init_leave (&amp;runtime_dir, dir);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-modified-added">+   G_UNLOCK (g_utils_global);</span>
  
<span class="udiff-line-modified-removed">-   return runtime_dir;</span>
<span class="udiff-line-modified-added">+   return user_runtime_dir;</span>
  }
  
<span class="udiff-line-modified-removed">- #ifdef HAVE_CARBON</span>
<span class="udiff-line-modified-added">+ #ifdef HAVE_COCOA</span>
  
<span class="udiff-line-modified-removed">- static gchar *</span>
<span class="udiff-line-modified-removed">- find_folder (OSType type)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-   gchar *filename = NULL;</span>
<span class="udiff-line-removed">-   FSRef  found;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   if (FSFindFolder (kUserDomain, type, kDontCreateFolder, &amp;found) == noErr)</span>
<span class="udiff-line-removed">-     {</span>
<span class="udiff-line-removed">-       CFURLRef url = CFURLCreateFromFSRef (kCFAllocatorSystemDefault, &amp;found);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-       if (url)</span>
<span class="udiff-line-removed">-     {</span>
<span class="udiff-line-removed">-       CFStringRef path = CFURLCopyFileSystemPath (url, kCFURLPOSIXPathStyle);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-       if (path)</span>
<span class="udiff-line-removed">-         {</span>
<span class="udiff-line-removed">-           filename = g_strdup (CFStringGetCStringPtr (path, kCFStringEncodingUTF8));</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-           if (! filename)</span>
<span class="udiff-line-removed">-         {</span>
<span class="udiff-line-removed">-           filename = g_new0 (gchar, CFStringGetLength (path) * 3 + 1);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-           CFStringGetCString (path, filename,</span>
<span class="udiff-line-removed">-                       CFStringGetLength (path) * 3 + 1,</span>
<span class="udiff-line-removed">-                       kCFStringEncodingUTF8);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-           CFRelease (path);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-       CFRelease (url);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   return filename;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-modified-added">+ /* Implemented in gutils-macos.m */</span>
<span class="udiff-line-modified-added">+ void load_user_special_dirs_macos (gchar **table);</span>
  
  static void
  load_user_special_dirs (void)
  {
<span class="udiff-line-modified-removed">-   g_user_special_dirs[G_USER_DIRECTORY_DESKTOP] = find_folder (kDesktopFolderType);</span>
<span class="udiff-line-removed">-   g_user_special_dirs[G_USER_DIRECTORY_DOCUMENTS] = find_folder (kDocumentsFolderType);</span>
<span class="udiff-line-removed">-   g_user_special_dirs[G_USER_DIRECTORY_DOWNLOAD] = find_folder (kDesktopFolderType); /* XXX correct ? */</span>
<span class="udiff-line-removed">-   g_user_special_dirs[G_USER_DIRECTORY_MUSIC] = find_folder (kMusicDocumentsFolderType);</span>
<span class="udiff-line-removed">-   g_user_special_dirs[G_USER_DIRECTORY_PICTURES] = find_folder (kPictureDocumentsFolderType);</span>
<span class="udiff-line-removed">-   g_user_special_dirs[G_USER_DIRECTORY_PUBLIC_SHARE] = NULL;</span>
<span class="udiff-line-removed">-   g_user_special_dirs[G_USER_DIRECTORY_TEMPLATES] = NULL;</span>
<span class="udiff-line-removed">-   g_user_special_dirs[G_USER_DIRECTORY_VIDEOS] = find_folder (kMovieDocumentsFolderType);</span>
<span class="udiff-line-modified-added">+   load_user_special_dirs_macos (g_user_special_dirs);</span>
  }
  
  #elif defined(G_OS_WIN32)
  
  static void
  load_user_special_dirs (void)
  {
    typedef HRESULT (WINAPI *t_SHGetKnownFolderPath) (const GUID *rfid,
<span class="udiff-line-modified-removed">-                             DWORD dwFlags,</span>
<span class="udiff-line-modified-removed">-                             HANDLE hToken,</span>
<span class="udiff-line-modified-removed">-                             PWSTR *ppszPath);</span>
<span class="udiff-line-modified-added">+                 DWORD dwFlags,</span>
<span class="udiff-line-modified-added">+                 HANDLE hToken,</span>
<span class="udiff-line-modified-added">+                 PWSTR *ppszPath);</span>
    t_SHGetKnownFolderPath p_SHGetKnownFolderPath;
  
    static const GUID FOLDERID_Downloads =
      { 0x374de290, 0x123f, 0x4565, { 0x91, 0x64, 0x39, 0xc4, 0x92, 0x5e, 0x46, 0x7b } };
    static const GUID FOLDERID_Public =
      { 0xDFDF76A2, 0xC82A, 0x4D63, { 0x90, 0x6A, 0x56, 0x44, 0xAC, 0x45, 0x73, 0x85 } };
  
    wchar_t *wcp;
  
    p_SHGetKnownFolderPath = (t_SHGetKnownFolderPath) GetProcAddress (GetModuleHandle (&quot;shell32.dll&quot;),
<span class="udiff-line-modified-removed">-                                     &quot;SHGetKnownFolderPath&quot;);</span>
<span class="udiff-line-modified-added">+                     &quot;SHGetKnownFolderPath&quot;);</span>
  
    g_user_special_dirs[G_USER_DIRECTORY_DESKTOP] = get_special_folder (CSIDL_DESKTOPDIRECTORY);
    g_user_special_dirs[G_USER_DIRECTORY_DOCUMENTS] = get_special_folder (CSIDL_PERSONAL);
  
    if (p_SHGetKnownFolderPath == NULL)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1559,19 +1618,21 @@</span>
   * SOFTWARE.
   */
  static void
  load_user_special_dirs (void)
  {
<span class="udiff-line-added">+   gchar *config_dir = NULL;</span>
    gchar *config_file;
    gchar *data;
    gchar **lines;
    gint n_lines, i;
  
<span class="udiff-line-modified-removed">-   g_init_user_config_dir ();</span>
<span class="udiff-line-modified-removed">-   config_file = g_build_filename (g_user_config_dir,</span>
<span class="udiff-line-modified-added">+   config_dir = g_build_user_config_dir ();</span>
<span class="udiff-line-modified-added">+   config_file = g_build_filename (config_dir,</span>
                                    &quot;user-dirs.dirs&quot;,
                                    NULL);
<span class="udiff-line-added">+   g_free (config_dir);</span>
  
    if (!g_file_get_contents (config_file, &amp;data, NULL, NULL))
      {
        g_free (config_file);
        return;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1590,15 +1651,15 @@</span>
        GUserDirectory directory;
  
        /* Remove newline at end */
        len = strlen (buffer);
        if (len &gt; 0 &amp;&amp; buffer[len - 1] == &#39;\n&#39;)
<span class="udiff-line-modified-removed">-     buffer[len - 1] = 0;</span>
<span class="udiff-line-modified-added">+   buffer[len - 1] = 0;</span>
  
        p = buffer;
        while (*p == &#39; &#39; || *p == &#39;\t&#39;)
<span class="udiff-line-modified-removed">-     p++;</span>
<span class="udiff-line-modified-added">+   p++;</span>
  
        if (strncmp (p, &quot;XDG_DESKTOP_DIR&quot;, strlen (&quot;XDG_DESKTOP_DIR&quot;)) == 0)
          {
            directory = G_USER_DIRECTORY_DESKTOP;
            p += strlen (&quot;XDG_DESKTOP_DIR&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1637,33 +1698,33 @@</span>
          {
            directory = G_USER_DIRECTORY_VIDEOS;
            p += strlen (&quot;XDG_VIDEOS_DIR&quot;);
          }
        else
<span class="udiff-line-modified-removed">-     continue;</span>
<span class="udiff-line-modified-added">+   continue;</span>
  
        while (*p == &#39; &#39; || *p == &#39;\t&#39;)
<span class="udiff-line-modified-removed">-     p++;</span>
<span class="udiff-line-modified-added">+   p++;</span>
  
        if (*p != &#39;=&#39;)
<span class="udiff-line-modified-removed">-     continue;</span>
<span class="udiff-line-modified-added">+   continue;</span>
        p++;
  
        while (*p == &#39; &#39; || *p == &#39;\t&#39;)
<span class="udiff-line-modified-removed">-     p++;</span>
<span class="udiff-line-modified-added">+   p++;</span>
  
        if (*p != &#39;&quot;&#39;)
<span class="udiff-line-modified-removed">-     continue;</span>
<span class="udiff-line-modified-added">+   continue;</span>
        p++;
  
        if (strncmp (p, &quot;$HOME&quot;, 5) == 0)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       p += 5;</span>
<span class="udiff-line-modified-removed">-       is_relative = TRUE;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     p += 5;</span>
<span class="udiff-line-modified-added">+     is_relative = TRUE;</span>
<span class="udiff-line-modified-added">+   }</span>
        else if (*p != &#39;/&#39;)
<span class="udiff-line-modified-removed">-     continue;</span>
<span class="udiff-line-modified-added">+   continue;</span>
  
        d = strrchr (p, &#39;&quot;&#39;);
        if (!d)
          continue;
        *d = 0;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1675,14 +1736,16 @@</span>
        if (d[len - 1] == &#39;/&#39;)
          d[len - 1] = 0;
  
        if (is_relative)
          {
<span class="udiff-line-modified-removed">-           g_user_special_dirs[directory] = g_build_filename (g_get_home_dir (), d, NULL);</span>
<span class="udiff-line-modified-added">+           gchar *home_dir = g_build_home_dir ();</span>
<span class="udiff-line-added">+           g_user_special_dirs[directory] = g_build_filename (home_dir, d, NULL);</span>
<span class="udiff-line-added">+           g_free (home_dir);</span>
          }
        else
<span class="udiff-line-modified-removed">-     g_user_special_dirs[directory] = g_strdup (d);</span>
<span class="udiff-line-modified-added">+   g_user_special_dirs[directory] = g_strdup (d);</span>
      }
  
    g_strfreev (lines);
    g_free (config_file);
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1695,11 +1758,11 @@</span>
   *
   * Resets the cache used for g_get_user_special_dir(), so
   * that the latest on-disk version is used. Call this only
   * if you just changed the data on disk yourself.
   *
<span class="udiff-line-modified-removed">-  * Due to threadsafety issues this may cause leaking of strings</span>
<span class="udiff-line-modified-added">+  * Due to thread safety issues this may cause leaking of strings</span>
   * that were previously returned from g_get_user_special_dir()
   * that can&#39;t be freed. We ensure to only leak the data for
   * the directories that actually changed value though.
   *
   * Since: 2.22
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1768,10 +1831,12 @@</span>
   * Since: 2.14
   */
  const gchar *
  g_get_user_special_dir (GUserDirectory directory)
  {
<span class="udiff-line-added">+   const gchar *user_special_dir;</span>
<span class="udiff-line-added">+ </span>
    g_return_val_if_fail (directory &gt;= G_USER_DIRECTORY_DESKTOP &amp;&amp;
                          directory &lt; G_USER_N_DIRECTORIES, NULL);
  
    G_LOCK (g_utils_global);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1781,16 +1846,21 @@</span>
  
        load_user_special_dirs ();
  
        /* Special-case desktop for historical compatibility */
        if (g_user_special_dirs[G_USER_DIRECTORY_DESKTOP] == NULL)
<span class="udiff-line-modified-removed">-         g_user_special_dirs[G_USER_DIRECTORY_DESKTOP] = g_build_filename (g_get_home_dir (), &quot;Desktop&quot;, NULL);</span>
<span class="udiff-line-modified-added">+         {</span>
<span class="udiff-line-added">+           gchar *home_dir = g_build_home_dir ();</span>
<span class="udiff-line-added">+           g_user_special_dirs[G_USER_DIRECTORY_DESKTOP] = g_build_filename (home_dir, &quot;Desktop&quot;, NULL);</span>
<span class="udiff-line-added">+           g_free (home_dir);</span>
<span class="udiff-line-added">+         }</span>
      }
<span class="udiff-line-added">+   user_special_dir = g_user_special_dirs[directory];</span>
  
    G_UNLOCK (g_utils_global);
  
<span class="udiff-line-modified-removed">-   return g_user_special_dirs[directory];</span>
<span class="udiff-line-modified-added">+   return user_special_dir;</span>
  }
  
  #ifdef G_OS_WIN32
  
  #undef g_get_system_data_dirs
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1809,19 +1879,19 @@</span>
      return NULL;
  
    if (!beenhere)
      {
        p_GetModuleHandleExA =
<span class="udiff-line-modified-removed">-     (t_GetModuleHandleExA) GetProcAddress (GetModuleHandle (&quot;kernel32.dll&quot;),</span>
<span class="udiff-line-modified-removed">-                            &quot;GetModuleHandleExA&quot;);</span>
<span class="udiff-line-modified-added">+   (t_GetModuleHandleExA) GetProcAddress (GetModuleHandle (&quot;kernel32.dll&quot;),</span>
<span class="udiff-line-modified-added">+                  &quot;GetModuleHandleExA&quot;);</span>
        beenhere = TRUE;
      }
  
    if (p_GetModuleHandleExA == NULL ||
        !(*p_GetModuleHandleExA) (GET_MODULE_HANDLE_EX_FLAG_UNCHANGED_REFCOUNT |
<span class="udiff-line-modified-removed">-                 GET_MODULE_HANDLE_EX_FLAG_FROM_ADDRESS,</span>
<span class="udiff-line-modified-removed">-                 address, &amp;hmodule))</span>
<span class="udiff-line-modified-added">+         GET_MODULE_HANDLE_EX_FLAG_FROM_ADDRESS,</span>
<span class="udiff-line-modified-added">+         address, &amp;hmodule))</span>
      {
        MEMORY_BASIC_INFORMATION mbi;
        VirtualQuery (address, &amp;mbi, sizeof (mbi));
        hmodule = (HMODULE) mbi.AllocationBase;
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1861,24 +1931,24 @@</span>
    if (address_of_function)
      {
        G_LOCK (g_utils_global);
        hmodule = get_module_for_address (address_of_function);
        if (hmodule != NULL)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       if (per_module_data_dirs == NULL)</span>
<span class="udiff-line-modified-removed">-         per_module_data_dirs = g_hash_table_new (NULL, NULL);</span>
<span class="udiff-line-modified-removed">-       else</span>
<span class="udiff-line-modified-removed">-         {</span>
<span class="udiff-line-modified-removed">-           retval = g_hash_table_lookup (per_module_data_dirs, hmodule);</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     if (per_module_data_dirs == NULL)</span>
<span class="udiff-line-modified-added">+       per_module_data_dirs = g_hash_table_new (NULL, NULL);</span>
<span class="udiff-line-modified-added">+     else</span>
<span class="udiff-line-modified-added">+       {</span>
<span class="udiff-line-modified-added">+         retval = g_hash_table_lookup (per_module_data_dirs, hmodule);</span>
  
<span class="udiff-line-modified-removed">-           if (retval != NULL)</span>
<span class="udiff-line-modified-removed">-         {</span>
<span class="udiff-line-modified-removed">-           G_UNLOCK (g_utils_global);</span>
<span class="udiff-line-modified-removed">-           return (const gchar * const *) retval;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+         if (retval != NULL)</span>
<span class="udiff-line-modified-added">+     {</span>
<span class="udiff-line-modified-added">+       G_UNLOCK (g_utils_global);</span>
<span class="udiff-line-modified-added">+       return (const gchar * const *) retval;</span>
      }
<span class="udiff-line-added">+       }</span>
<span class="udiff-line-added">+   }</span>
      }
  
    data_dirs = g_array_new (TRUE, TRUE, sizeof (char *));
  
    /* Documents and Settings\All Users\Application Data */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1920,11 +1990,11 @@</span>
    if (glib_dll != NULL)
      {
        gchar *glib_root = g_win32_get_package_installation_directory_of_module (glib_dll);
        p = g_build_filename (glib_root, &quot;share&quot;, NULL);
        if (p)
<span class="udiff-line-modified-removed">-     g_array_append_val (data_dirs, p);</span>
<span class="udiff-line-modified-added">+   g_array_append_val (data_dirs, p);</span>
        g_free (glib_root);
      }
  
    exe_root = g_win32_get_package_installation_directory_of_module (NULL);
    p = g_build_filename (exe_root, &quot;share&quot;, NULL);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1935,11 +2005,11 @@</span>
    retval = (gchar **) g_array_free (data_dirs, FALSE);
  
    if (address_of_function)
      {
        if (hmodule != NULL)
<span class="udiff-line-modified-removed">-     g_hash_table_insert (per_module_data_dirs, hmodule, retval);</span>
<span class="udiff-line-modified-added">+   g_hash_table_insert (per_module_data_dirs, hmodule, retval);</span>
        G_UNLOCK (g_utils_global);
      }
  
    return (const gchar * const *) retval;
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1948,11 +2018,11 @@</span>
  g_win32_get_system_data_dirs_for_module (void (*address_of_function)(void))
  {
    gboolean should_call_g_get_system_data_dirs;
  
    should_call_g_get_system_data_dirs = TRUE;
<span class="udiff-line-modified-removed">-   /* These checks are the same as the ones that g_get_system_data_dirs() does.</span>
<span class="udiff-line-modified-added">+   /* These checks are the same as the ones that g_build_system_data_dirs() does.</span>
     * Please keep them in sync.
     */
    G_LOCK (g_utils_global);
  
    if (!g_system_data_dirs)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1992,10 +2062,34 @@</span>
    return g_win32_get_system_data_dirs_for_module_real (address_of_function);
  }
  
  #endif
  
<span class="udiff-line-added">+ static gchar **</span>
<span class="udiff-line-added">+ g_build_system_data_dirs (void)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+   gchar **data_dir_vector = NULL;</span>
<span class="udiff-line-added">+   gchar *data_dirs = (gchar *) g_getenv (&quot;XDG_DATA_DIRS&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   /* These checks are the same as the ones that g_win32_get_system_data_dirs_for_module()</span>
<span class="udiff-line-added">+    * does. Please keep them in sync.</span>
<span class="udiff-line-added">+    */</span>
<span class="udiff-line-added">+ #ifndef G_OS_WIN32</span>
<span class="udiff-line-added">+   if (!data_dirs || !data_dirs[0])</span>
<span class="udiff-line-added">+     data_dirs = &quot;/usr/local/share/:/usr/share/&quot;;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   data_dir_vector = g_strsplit (data_dirs, G_SEARCHPATH_SEPARATOR_S, 0);</span>
<span class="udiff-line-added">+ #else</span>
<span class="udiff-line-added">+   if (!data_dirs || !data_dirs[0])</span>
<span class="udiff-line-added">+     data_dir_vector = g_strdupv ((gchar **) g_win32_get_system_data_dirs_for_module_real (NULL));</span>
<span class="udiff-line-added">+   else</span>
<span class="udiff-line-added">+     data_dir_vector = g_strsplit (data_dirs, G_SEARCHPATH_SEPARATOR_S, 0);</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   return g_steal_pointer (&amp;data_dir_vector);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  /**
   * g_get_system_data_dirs:
   *
   * Returns an ordered list of base directories in which to access
   * system-wide application data.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2036,41 +2130,53 @@</span>
   * Since: 2.6
   **/
  const gchar * const *
  g_get_system_data_dirs (void)
  {
<span class="udiff-line-modified-removed">-   gchar **data_dir_vector;</span>
<span class="udiff-line-modified-added">+   const gchar * const *system_data_dirs;</span>
  
<span class="udiff-line-removed">-   /* These checks are the same as the ones that g_win32_get_system_data_dirs_for_module()</span>
<span class="udiff-line-removed">-    * does. Please keep them in sync.</span>
<span class="udiff-line-removed">-    */</span>
    G_LOCK (g_utils_global);
  
<span class="udiff-line-modified-removed">-   if (!g_system_data_dirs)</span>
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       gchar *data_dirs = (gchar *) g_getenv (&quot;XDG_DATA_DIRS&quot;);</span>
<span class="udiff-line-modified-added">+   if (g_system_data_dirs == NULL)</span>
<span class="udiff-line-modified-added">+     g_system_data_dirs = g_build_system_data_dirs ();</span>
<span class="udiff-line-modified-added">+   system_data_dirs = (const gchar * const *) g_system_data_dirs;</span>
  
<span class="udiff-line-modified-removed">- #ifndef G_OS_WIN32</span>
<span class="udiff-line-removed">-       if (!data_dirs || !data_dirs[0])</span>
<span class="udiff-line-removed">-           data_dirs = &quot;/usr/local/share/:/usr/share/&quot;;</span>
<span class="udiff-line-modified-added">+   G_UNLOCK (g_utils_global);</span>
  
<span class="udiff-line-modified-removed">-       data_dir_vector = g_strsplit (data_dirs, G_SEARCHPATH_SEPARATOR_S, 0);</span>
<span class="udiff-line-modified-removed">- #else</span>
<span class="udiff-line-removed">-       if (!data_dirs || !data_dirs[0])</span>
<span class="udiff-line-removed">-         data_dir_vector = g_strdupv ((gchar **) g_win32_get_system_data_dirs_for_module_real (NULL));</span>
<span class="udiff-line-removed">-       else</span>
<span class="udiff-line-removed">-         data_dir_vector = g_strsplit (data_dirs, G_SEARCHPATH_SEPARATOR_S, 0);</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-modified-added">+   return system_data_dirs;</span>
<span class="udiff-line-modified-added">+ }</span>
  
<span class="udiff-line-modified-removed">-       g_system_data_dirs = data_dir_vector;</span>
<span class="udiff-line-modified-added">+ static gchar **</span>
<span class="udiff-line-added">+ g_build_system_config_dirs (void)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+   gchar **conf_dir_vector = NULL;</span>
<span class="udiff-line-added">+   const gchar *conf_dirs = g_getenv (&quot;XDG_CONFIG_DIRS&quot;);</span>
<span class="udiff-line-added">+ #ifdef G_OS_WIN32</span>
<span class="udiff-line-added">+   if (conf_dirs)</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       conf_dir_vector = g_strsplit (conf_dirs, G_SEARCHPATH_SEPARATOR_S, 0);</span>
      }
    else
<span class="udiff-line-modified-removed">-     data_dir_vector = g_system_data_dirs;</span>
<span class="udiff-line-modified-added">+     {</span>
<span class="udiff-line-added">+       gchar *special_conf_dirs = get_special_folder (CSIDL_COMMON_APPDATA);</span>
  
<span class="udiff-line-modified-removed">-   G_UNLOCK (g_utils_global);</span>
<span class="udiff-line-modified-added">+       if (special_conf_dirs)</span>
<span class="udiff-line-added">+         conf_dir_vector = g_strsplit (special_conf_dirs, G_SEARCHPATH_SEPARATOR_S, 0);</span>
<span class="udiff-line-added">+       else</span>
<span class="udiff-line-added">+         /* Return empty list */</span>
<span class="udiff-line-added">+         conf_dir_vector = g_strsplit (&quot;&quot;, G_SEARCHPATH_SEPARATOR_S, 0);</span>
  
<span class="udiff-line-modified-removed">-   return (const gchar * const *) data_dir_vector;</span>
<span class="udiff-line-modified-added">+       g_free (special_conf_dirs);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ #else</span>
<span class="udiff-line-added">+   if (!conf_dirs || !conf_dirs[0])</span>
<span class="udiff-line-added">+     conf_dirs = &quot;/etc/xdg&quot;;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   conf_dir_vector = g_strsplit (conf_dirs, G_SEARCHPATH_SEPARATOR_S, 0);</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   return g_steal_pointer (&amp;conf_dir_vector);</span>
  }
  
  /**
   * g_get_system_config_dirs:
   *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2099,48 +2205,21 @@</span>
   * Since: 2.6
   **/
  const gchar * const *
  g_get_system_config_dirs (void)
  {
<span class="udiff-line-modified-removed">-   gchar **conf_dir_vector;</span>
<span class="udiff-line-modified-added">+   const gchar * const *system_config_dirs;</span>
  
    G_LOCK (g_utils_global);
  
<span class="udiff-line-modified-removed">-   if (!g_system_config_dirs)</span>
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       const gchar *conf_dirs = g_getenv (&quot;XDG_CONFIG_DIRS&quot;);</span>
<span class="udiff-line-removed">- #ifdef G_OS_WIN32</span>
<span class="udiff-line-removed">-       if (conf_dirs)</span>
<span class="udiff-line-removed">-     {</span>
<span class="udiff-line-removed">-       conf_dir_vector = g_strsplit (conf_dirs, G_SEARCHPATH_SEPARATOR_S, 0);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-       else</span>
<span class="udiff-line-removed">-     {</span>
<span class="udiff-line-removed">-       gchar *special_conf_dirs = get_special_folder (CSIDL_COMMON_APPDATA);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-       if (special_conf_dirs)</span>
<span class="udiff-line-removed">-         conf_dir_vector = g_strsplit (special_conf_dirs, G_SEARCHPATH_SEPARATOR_S, 0);</span>
<span class="udiff-line-removed">-       else</span>
<span class="udiff-line-removed">-       /* Return empty list */</span>
<span class="udiff-line-removed">-       conf_dir_vector = g_strsplit (&quot;&quot;, G_SEARCHPATH_SEPARATOR_S, 0);</span>
<span class="udiff-line-modified-added">+   if (g_system_config_dirs == NULL)</span>
<span class="udiff-line-modified-added">+     g_system_config_dirs = g_build_system_config_dirs ();</span>
<span class="udiff-line-modified-added">+   system_config_dirs = (const gchar * const *) g_system_config_dirs;</span>
  
<span class="udiff-line-removed">-       g_free (special_conf_dirs);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- #else</span>
<span class="udiff-line-removed">-       if (!conf_dirs || !conf_dirs[0])</span>
<span class="udiff-line-removed">-           conf_dirs = &quot;/etc/xdg&quot;;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-       conf_dir_vector = g_strsplit (conf_dirs, G_SEARCHPATH_SEPARATOR_S, 0);</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-       g_system_config_dirs = conf_dir_vector;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-   else</span>
<span class="udiff-line-removed">-     conf_dir_vector = g_system_config_dirs;</span>
    G_UNLOCK (g_utils_global);
  
<span class="udiff-line-modified-removed">-   return (const gchar * const *) conf_dir_vector;</span>
<span class="udiff-line-modified-added">+   return system_config_dirs;</span>
  }
  
  /**
   * g_nullify_pointer:
   * @nullify_location: (not nullable): the memory address of the pointer.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2174,11 +2253,13 @@</span>
   * @size: a size in bytes
   *
   * Formats a size (for example the size of a file) into a human readable
   * string.  Sizes are rounded to the nearest size prefix (kB, MB, GB)
   * and are displayed rounded to the nearest tenth. E.g. the file size
<span class="udiff-line-modified-removed">-  * 3292528 bytes will be converted into the string &quot;3.2 MB&quot;.</span>
<span class="udiff-line-modified-added">+  * 3292528 bytes will be converted into the string &quot;3.2 MB&quot;. The returned string</span>
<span class="udiff-line-added">+  * is UTF-8, and may use a non-breaking space to separate the number and units,</span>
<span class="udiff-line-added">+  * to ensure they aren&#39;t separated when line wrapped.</span>
   *
   * The prefix units base is 1000 (i.e. 1 kB is 1000 bytes).
   *
   * This string should be freed with g_free() when not needed any longer.
   *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2241,11 +2322,11 @@</span>
                      GFormatSizeFlags flags)
  {
    struct Format
    {
      guint64 factor;
<span class="udiff-line-modified-removed">-     char string[9];</span>
<span class="udiff-line-modified-added">+     char string[10];</span>
    };
  
    typedef enum
    {
      FORMAT_BYTES,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2254,41 +2335,65 @@</span>
      FORMAT_BITS_IEC
    } FormatIndex;
  
    const struct Format formats[4][6] = {
      {
<span class="udiff-line-added">+       /* Translators: Keep the no-break space between %.1f and the unit symbol */</span>
        { KILOBYTE_FACTOR, N_(&quot;%.1f kB&quot;) },
<span class="udiff-line-added">+       /* Translators: Keep the no-break space between %.1f and the unit symbol */</span>
        { MEGABYTE_FACTOR, N_(&quot;%.1f MB&quot;) },
<span class="udiff-line-added">+       /* Translators: Keep the no-break space between %.1f and the unit symbol */</span>
        { GIGABYTE_FACTOR, N_(&quot;%.1f GB&quot;) },
<span class="udiff-line-added">+       /* Translators: Keep the no-break space between %.1f and the unit symbol */</span>
        { TERABYTE_FACTOR, N_(&quot;%.1f TB&quot;) },
<span class="udiff-line-added">+       /* Translators: Keep the no-break space between %.1f and the unit symbol */</span>
        { PETABYTE_FACTOR, N_(&quot;%.1f PB&quot;) },
<span class="udiff-line-added">+       /* Translators: Keep the no-break space between %.1f and the unit symbol */</span>
        { EXABYTE_FACTOR,  N_(&quot;%.1f EB&quot;) }
      },
<span class="udiff-line-modified-removed">-         {</span>
<span class="udiff-line-modified-added">+     {</span>
<span class="udiff-line-added">+       /* Translators: Keep the no-break space between %.1f and the unit symbol */</span>
        { KIBIBYTE_FACTOR, N_(&quot;%.1f KiB&quot;) },
<span class="udiff-line-added">+       /* Translators: Keep the no-break space between %.1f and the unit symbol */</span>
        { MEBIBYTE_FACTOR, N_(&quot;%.1f MiB&quot;) },
<span class="udiff-line-added">+       /* Translators: Keep the no-break space between %.1f and the unit symbol */</span>
        { GIBIBYTE_FACTOR, N_(&quot;%.1f GiB&quot;) },
<span class="udiff-line-added">+       /* Translators: Keep the no-break space between %.1f and the unit symbol */</span>
        { TEBIBYTE_FACTOR, N_(&quot;%.1f TiB&quot;) },
<span class="udiff-line-added">+       /* Translators: Keep the no-break space between %.1f and the unit symbol */</span>
        { PEBIBYTE_FACTOR, N_(&quot;%.1f PiB&quot;) },
<span class="udiff-line-added">+       /* Translators: Keep the no-break space between %.1f and the unit symbol */</span>
        { EXBIBYTE_FACTOR, N_(&quot;%.1f EiB&quot;) }
      },
      {
<span class="udiff-line-added">+       /* Translators: Keep the no-break space between %.1f and the unit symbol */</span>
        { KILOBYTE_FACTOR, N_(&quot;%.1f kb&quot;) },
<span class="udiff-line-added">+       /* Translators: Keep the no-break space between %.1f and the unit symbol */</span>
        { MEGABYTE_FACTOR, N_(&quot;%.1f Mb&quot;) },
<span class="udiff-line-added">+       /* Translators: Keep the no-break space between %.1f and the unit symbol */</span>
        { GIGABYTE_FACTOR, N_(&quot;%.1f Gb&quot;) },
<span class="udiff-line-added">+       /* Translators: Keep the no-break space between %.1f and the unit symbol */</span>
        { TERABYTE_FACTOR, N_(&quot;%.1f Tb&quot;) },
<span class="udiff-line-added">+       /* Translators: Keep the no-break space between %.1f and the unit symbol */</span>
        { PETABYTE_FACTOR, N_(&quot;%.1f Pb&quot;) },
<span class="udiff-line-added">+       /* Translators: Keep the no-break space between %.1f and the unit symbol */</span>
        { EXABYTE_FACTOR,  N_(&quot;%.1f Eb&quot;) }
      },
      {
<span class="udiff-line-added">+       /* Translators: Keep the no-break space between %.1f and the unit symbol */</span>
        { KIBIBYTE_FACTOR, N_(&quot;%.1f Kib&quot;) },
<span class="udiff-line-added">+       /* Translators: Keep the no-break space between %.1f and the unit symbol */</span>
        { MEBIBYTE_FACTOR, N_(&quot;%.1f Mib&quot;) },
<span class="udiff-line-added">+       /* Translators: Keep the no-break space between %.1f and the unit symbol */</span>
        { GIBIBYTE_FACTOR, N_(&quot;%.1f Gib&quot;) },
<span class="udiff-line-added">+       /* Translators: Keep the no-break space between %.1f and the unit symbol */</span>
        { TEBIBYTE_FACTOR, N_(&quot;%.1f Tib&quot;) },
<span class="udiff-line-added">+       /* Translators: Keep the no-break space between %.1f and the unit symbol */</span>
        { PEBIBYTE_FACTOR, N_(&quot;%.1f Pib&quot;) },
<span class="udiff-line-added">+       /* Translators: Keep the no-break space between %.1f and the unit symbol */</span>
        { EXBIBYTE_FACTOR, N_(&quot;%.1f Eib&quot;) }
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-added">+     }</span>
    };
  
    GString *string;
    FormatIndex index;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2318,13 +2423,13 @@</span>
        const char * format;
  
        if (index == FORMAT_BYTES || index == FORMAT_BYTES_IEC)
          {
            format = g_dngettext (GETTEXT_PACKAGE, &quot;%u byte&quot;, &quot;%u bytes&quot;, (guint) size);
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-removed">-   else</span>
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-added">+         }</span>
<span class="udiff-line-modified-added">+       else</span>
<span class="udiff-line-modified-added">+         {</span>
            format = g_dngettext (GETTEXT_PACKAGE, &quot;%u bit&quot;, &quot;%u bits&quot;, (guint) size);
          }
  
        g_string_printf (string, format, (guint) size);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2387,28 +2492,19 @@</span>
        const gchar *translated_format;
        gchar *formatted_number;
  
        if (index == FORMAT_BYTES || index == FORMAT_BYTES_IEC)
          {
<span class="udiff-line-modified-removed">-       /* Translators: the %s in &quot;%s bytes&quot; will always be replaced by a number. */</span>
<span class="udiff-line-modified-added">+           /* Translators: the %s in &quot;%s bytes&quot; will always be replaced by a number. */</span>
            translated_format = g_dngettext (GETTEXT_PACKAGE, &quot;%s byte&quot;, &quot;%s bytes&quot;, plural_form);
          }
        else
          {
            /* Translators: the %s in &quot;%s bits&quot; will always be replaced by a number. */
            translated_format = g_dngettext (GETTEXT_PACKAGE, &quot;%s bit&quot;, &quot;%s bits&quot;, plural_form);
          }
<span class="udiff-line-removed">-       /* XXX: Windows doesn&#39;t support the &quot;&#39;&quot; format modifier, so we</span>
<span class="udiff-line-removed">-        * must not use it there.  Instead, just display the number</span>
<span class="udiff-line-removed">-        * without separation.  Bug #655336 is open until a solution is</span>
<span class="udiff-line-removed">-        * found.</span>
<span class="udiff-line-removed">-        */</span>
<span class="udiff-line-removed">- #ifndef G_OS_WIN32</span>
        formatted_number = g_strdup_printf (&quot;%&#39;&quot;G_GUINT64_FORMAT, size);
<span class="udiff-line-removed">- #else</span>
<span class="udiff-line-removed">-       formatted_number = g_strdup_printf (&quot;%&quot;G_GUINT64_FORMAT, size);</span>
<span class="udiff-line-removed">- #endif</span>
  
        g_string_append (string, &quot; (&quot;);
        g_string_append_printf (string, translated_format, formatted_number);
        g_free (formatted_number);
        g_string_append (string, &quot;)&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2522,11 +2618,11 @@</span>
   * Returns %TRUE if the current process was executed as setuid
   */
  gboolean
  g_check_setuid (void)
  {
<span class="udiff-line-modified-removed">- #if defined(HAVE_SYS_AUXV_H)</span>
<span class="udiff-line-modified-added">+ #if defined(HAVE_SYS_AUXV_H) &amp;&amp; defined(HAVE_GETAUXVAL) &amp;&amp; defined(AT_SECURE)</span>
    unsigned long value;
    int errsv;
  
    errno = 0;
    value = getauxval (AT_SECURE);
</pre>
<center><a href="gutf8.c.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="gutils.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>