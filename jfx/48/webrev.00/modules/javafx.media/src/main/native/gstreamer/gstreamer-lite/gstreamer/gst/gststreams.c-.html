<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old modules/javafx.media/src/main/native/gstreamer/gstreamer-lite/gstreamer/gst/gststreams.c</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
  1 /* GStreamer
  2  *
  3  * Copyright (C) 2015 Centricular Ltd
  4  *  @author: Edward Hervey &lt;edward@centricular.com&gt;
  5  *  @author: Jan Schmidt &lt;jan@centricular.com&gt;
  6  *
  7  * gststreams.c: GstStream and GstStreamCollection object and methods
  8  *
  9  * This library is free software; you can redistribute it and/or
 10  * modify it under the terms of the GNU Library General Public
 11  * License as published by the Free Software Foundation; either
 12  * version 2 of the License, or (at your option) any later version.
 13  *
 14  * This library is distributed in the hope that it will be useful,
 15  * but WITHOUT ANY WARRANTY; without even the implied warranty of
 16  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 17  * Library General Public License for more details.
 18  *
 19  * You should have received a copy of the GNU Library General Public
 20  * License along with this library; if not, write to the
 21  * Free Software Foundation, Inc., 51 Franklin St, Fifth Floor,
 22  * Boston, MA 02110-1301, USA.
 23  *
 24  * MT safe.
 25  */
 26 
 27 /**
 28  * SECTION:gststreams
 29  * @title: GstStreams
 30  * @short_description: Base class for stream objects
 31  *
 32  * A #GstStream is a high-level object defining a stream of data which is, or
 33  * can be, present in a #GstPipeline.
 34  *
 35  * It is defined by a unique identifier, a &quot;Stream ID&quot;. A #GstStream does not
 36  * automatically imply the stream is present within a pipeline or element.
 37  *
 38  * Any element that can introduce new streams in a pipeline should create the
 39  * appropriate #GstStream object, and can convey that object via the
 40  * %GST_EVENT_STREAM_START event and/or the #GstStreamCollection.
 41  *
 42  * Elements that do not modify the nature of the stream can add extra information
 43  * on it (such as enrich the #GstCaps, or #GstTagList). This is typically done
 44  * by parsing elements.
 45  *
 46  * Since: 1.10
 47  */
 48 
 49 #include &quot;gst_private.h&quot;
 50 
 51 #include &quot;gstenumtypes.h&quot;
 52 #include &quot;gstevent.h&quot;
 53 #include &quot;gststreams.h&quot;
 54 
 55 GST_DEBUG_CATEGORY_STATIC (streams_debug);
 56 #define GST_CAT_DEFAULT streams_debug
 57 
 58 #define GST_STREAM_GET_PRIVATE(obj)  \
 59    (G_TYPE_INSTANCE_GET_PRIVATE ((obj), GST_TYPE_STREAM, GstStreamPrivate))
 60 
 61 struct _GstStreamPrivate
 62 {
 63   GstStreamFlags flags;
 64   GstStreamType type;
 65   GstTagList *tags;
 66   GstCaps *caps;
 67 };
 68 
 69 /* stream signals and properties */
 70 enum
 71 {
 72   LAST_SIGNAL
 73 };
 74 
 75 enum
 76 {
 77   PROP_0,
 78   PROP_STREAM_ID,
 79   PROP_STREAM_FLAGS,
 80   PROP_STREAM_TYPE,
 81   PROP_TAGS,
 82   PROP_CAPS,
 83   PROP_LAST
 84 };
 85 
 86 static GParamSpec *gst_stream_pspecs[PROP_LAST] = { 0 };
 87 
 88 #if 0
 89 static guint gst_stream_signals[LAST_SIGNAL] = { 0 };
 90 #endif
 91 
 92 static void gst_stream_finalize (GObject * object);
 93 
 94 static void gst_stream_set_property (GObject * object, guint prop_id,
 95     const GValue * value, GParamSpec * pspec);
 96 static void gst_stream_get_property (GObject * object, guint prop_id,
 97     GValue * value, GParamSpec * pspec);
 98 
 99 #define _do_init                \
100 { \
101   GST_DEBUG_CATEGORY_INIT (streams_debug, &quot;streams&quot;, GST_DEBUG_BOLD, \
102       &quot;debugging info for the stream and stream collection objects&quot;); \
103   \
104 }
105 
106 #define gst_stream_parent_class parent_class
107 G_DEFINE_TYPE_WITH_CODE (GstStream, gst_stream, GST_TYPE_OBJECT, _do_init);
108 
109 static void
110 gst_stream_class_init (GstStreamClass * klass)
111 {
112   GObjectClass *gobject_class;
113 
114   gobject_class = (GObjectClass *) klass;
115 
116   g_type_class_add_private (klass, sizeof (GstStreamPrivate));
117 
118   gobject_class-&gt;set_property = gst_stream_set_property;
119   gobject_class-&gt;get_property = gst_stream_get_property;
120 
121   /**
122    * GstStream:stream-id:
123    *
124    * The unique identifier of the #GstStream. Can only be set at construction
125    * time.
126    */
127   g_object_class_install_property (gobject_class, PROP_STREAM_ID,
128       g_param_spec_string (&quot;stream-id&quot;, &quot;Stream ID&quot;,
129           &quot;The stream ID of the stream&quot;,
130           NULL,
131           G_PARAM_READWRITE | G_PARAM_CONSTRUCT_ONLY | G_PARAM_STATIC_STRINGS));
132 
133   /**
134    * GstStream:flags:
135    *
136    * The #GstStreamFlags of the #GstStream. Can only be set at construction time.
137    **/
138   gst_stream_pspecs[PROP_STREAM_FLAGS] =
139       g_param_spec_flags (&quot;stream-flags&quot;, &quot;Stream Flags&quot;, &quot;The stream flags&quot;,
140       GST_TYPE_STREAM_FLAGS, GST_STREAM_FLAG_NONE,
141       G_PARAM_READWRITE | G_PARAM_CONSTRUCT | G_PARAM_STATIC_STRINGS);
142   g_object_class_install_property (gobject_class, PROP_STREAM_FLAGS,
143       gst_stream_pspecs[PROP_STREAM_FLAGS]);
144 
145   /**
146    * GstStream:stream-type:
147    *
148    * The #GstStreamType of the #GstStream. Can only be set at construction time.
149    **/
150 #ifndef GSTREAMER_LITE
151   gst_stream_pspecs[PROP_STREAM_TYPE] =
152       g_param_spec_flags (&quot;stream-type&quot;, &quot;Stream Type&quot;, &quot;The type of stream&quot;,
153       GST_TYPE_STREAM_TYPE, GST_STREAM_TYPE_UNKNOWN,
154       G_PARAM_READWRITE | G_PARAM_CONSTRUCT | G_PARAM_STATIC_STRINGS);
155   g_object_class_install_property (gobject_class, PROP_STREAM_TYPE,
156       gst_stream_pspecs[PROP_STREAM_TYPE]);
157 #endif // GSTREAMER_LITE
158 
159   /**
160    * GstStream:caps:
161    *
162    * The #GstCaps of the #GstStream.
163    **/
164   gst_stream_pspecs[PROP_CAPS] =
165       g_param_spec_boxed (&quot;caps&quot;, &quot;Caps&quot;, &quot;The caps of the stream&quot;,
166       GST_TYPE_CAPS, G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS);
167   g_object_class_install_property (gobject_class, PROP_CAPS,
168       gst_stream_pspecs[PROP_CAPS]);
169 
170   /**
171    * GstStream:tags:
172    *
173    * The #GstTagList of the #GstStream.
174    **/
175   gst_stream_pspecs[PROP_TAGS] =
176       g_param_spec_boxed (&quot;tags&quot;, &quot;Tags&quot;, &quot;The tags of the stream&quot;,
177       GST_TYPE_TAG_LIST, G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS);
178   g_object_class_install_property (gobject_class, PROP_TAGS,
179       gst_stream_pspecs[PROP_TAGS]);
180 
181   gobject_class-&gt;finalize = gst_stream_finalize;
182 }
183 
184 static void
185 gst_stream_init (GstStream * stream)
186 {
187   stream-&gt;priv = GST_STREAM_GET_PRIVATE (stream);
188   stream-&gt;priv-&gt;type = GST_STREAM_TYPE_UNKNOWN;
189 }
190 
191 static void
192 gst_stream_finalize (GObject * object)
193 {
194   GstStream *stream = GST_STREAM_CAST (object);
195 
196   gst_mini_object_replace ((GstMiniObject **) &amp; stream-&gt;priv-&gt;tags,
197       (GstMiniObject *) NULL);
198   gst_caps_replace (&amp;stream-&gt;priv-&gt;caps, NULL);
199   g_free ((gchar *) stream-&gt;stream_id);
200 
201   G_OBJECT_CLASS (parent_class)-&gt;finalize (object);
202 }
203 
204 /**
205  * gst_stream_new:
206  * @stream_id: (allow-none): the id for the new stream. If %NULL,
207  * a new one will be automatically generated
208  * @caps: (allow-none) (transfer none): the #GstCaps of the stream
209  * @type: the #GstStreamType of the stream
210  * @flags: the #GstStreamFlags of the stream
211  *
212  * Create a new #GstStream for the given @stream_id, @caps, @type
213  * and @flags
214  *
215  * Returns: (transfer full): The new #GstStream
216  *
217  * Since: 1.10
218  */
219 GstStream *
220 gst_stream_new (const gchar * stream_id, GstCaps * caps, GstStreamType type,
221     GstStreamFlags flags)
222 {
223   GstStream *stream;
224 
225   stream = g_object_new (GST_TYPE_STREAM, &quot;stream-id&quot;, stream_id, &quot;caps&quot;, caps,
226       &quot;stream-type&quot;, type, &quot;stream-flags&quot;, flags, NULL);
227 
228   /* Clear floating flag */
229   gst_object_ref_sink (stream);
230 
231   return stream;
232 }
233 
234 static void
235 gst_stream_set_stream_id (GstStream * stream, const gchar * stream_id)
236 {
237   GST_OBJECT_LOCK (stream);
238   g_assert (stream-&gt;stream_id == NULL);
239   if (stream_id)
240     stream-&gt;stream_id = g_strdup (stream_id);
241   else {
242     /* Create a randoom stream_id if NULL */
243     GST_FIXME_OBJECT (stream, &quot;Creating random stream-id, consider &quot;
244         &quot;implementing a deterministic way of creating a stream-id&quot;);
245     stream-&gt;stream_id =
246         g_strdup_printf (&quot;%08x%08x%08x%08x&quot;, g_random_int (), g_random_int (),
247         g_random_int (), g_random_int ());
248   }
249 
250   GST_OBJECT_UNLOCK (stream);
251 }
252 
253 /**
254  * gst_stream_get_stream_id:
255  * @stream: a #GstStream
256  *
257  * Returns the stream ID of @stream.
258  *
259  * Returns: (transfer none) (nullable): the stream ID of @stream. Only valid
260  * during the lifetime of @stream.
261  *
262  * Since: 1.10
263  */
264 const gchar *
265 gst_stream_get_stream_id (GstStream * stream)
266 {
267   return stream-&gt;stream_id;
268 }
269 
270 /**
271  * gst_stream_set_stream_flags:
272  * @stream: a #GstStream
273  * @flags: the flags to set on @stream
274  *
275  * Set the @flags for the @stream.
276  *
277  * Since: 1.10
278  */
279 void
280 gst_stream_set_stream_flags (GstStream * stream, GstStreamFlags flags)
281 {
282   GST_OBJECT_LOCK (stream);
283   stream-&gt;priv-&gt;flags = flags;
284   GST_OBJECT_UNLOCK (stream);
285 
286   g_object_notify_by_pspec (G_OBJECT (stream),
287       gst_stream_pspecs[PROP_STREAM_FLAGS]);
288 }
289 
290 /**
291  * gst_stream_get_stream_flags:
292  * @stream: a #GstStream
293  *
294  * Retrieve the current stream flags for @stream
295  *
296  * Returns: The #GstStreamFlags for @stream
297  *
298  * Since: 1.10
299  */
300 GstStreamFlags
301 gst_stream_get_stream_flags (GstStream * stream)
302 {
303   GstStreamFlags res;
304 
305   GST_OBJECT_LOCK (stream);
306   res = stream-&gt;priv-&gt;flags;
307   GST_OBJECT_UNLOCK (stream);
308 
309   return res;
310 }
311 
312 /**
313  * gst_stream_set_stream_type:
314  * @stream: a #GstStream
315  * @stream_type: the type to set on @stream
316  *
317  * Set the stream type of @stream
318  *
319  * Since: 1.10
320  */
321 void
322 gst_stream_set_stream_type (GstStream * stream, GstStreamType stream_type)
323 {
324   GST_OBJECT_LOCK (stream);
325   stream-&gt;priv-&gt;type = stream_type;
326   GST_OBJECT_UNLOCK (stream);
327 
328   g_object_notify_by_pspec (G_OBJECT (stream),
329       gst_stream_pspecs[PROP_STREAM_TYPE]);
330 }
331 
332 /**
333  * gst_stream_get_stream_type:
334  * @stream: a #GstStream
335  *
336  * Retrieve the stream type for @stream
337  *
338  * Returns: The #GstStreamType for @stream
339  *
340  * Since: 1.10
341  */
342 GstStreamType
343 gst_stream_get_stream_type (GstStream * stream)
344 {
345   GstStreamType res;
346 
347   GST_OBJECT_LOCK (stream);
348   res = stream-&gt;priv-&gt;type;
349   GST_OBJECT_UNLOCK (stream);
350 
351   return res;
352 }
353 
354 /**
355  * gst_stream_set_tags:
356  * @stream: a #GstStream
357  * @tags: (transfer none) (allow-none): a #GstTagList
358  *
359  * Set the tags for the #GstStream
360  *
361  * Since: 1.10
362  */
363 void
364 gst_stream_set_tags (GstStream * stream, GstTagList * tags)
365 {
366   gboolean notify = FALSE;
367 
368   GST_OBJECT_LOCK (stream);
369   if (stream-&gt;priv-&gt;tags == NULL || tags == NULL
370       || !gst_tag_list_is_equal (stream-&gt;priv-&gt;tags, tags)) {
371     gst_mini_object_replace ((GstMiniObject **) &amp; stream-&gt;priv-&gt;tags,
372         (GstMiniObject *) tags);
373     notify = TRUE;
374   }
375   GST_OBJECT_UNLOCK (stream);
376 
377   if (notify)
378     g_object_notify_by_pspec (G_OBJECT (stream), gst_stream_pspecs[PROP_TAGS]);
379 }
380 
381 /**
382  * gst_stream_get_tags:
383  * @stream: a #GstStream
384  *
385  * Retrieve the tags for @stream, if any
386  *
387  * Returns: (transfer full) (nullable): The #GstTagList for @stream
388  *
389  * Since: 1.10
390  */
391 GstTagList *
392 gst_stream_get_tags (GstStream * stream)
393 {
394   GstTagList *res = NULL;
395 
396   GST_OBJECT_LOCK (stream);
397   if (stream-&gt;priv-&gt;tags)
398     res = gst_tag_list_ref (stream-&gt;priv-&gt;tags);
399   GST_OBJECT_UNLOCK (stream);
400 
401   return res;
402 }
403 
404 /**
405  * gst_stream_set_caps:
406  * @stream: a #GstStream
407  * @caps: (transfer none) (allow-none): a #GstCaps
408  *
409  * Set the caps for the #GstStream
410  *
411  * Since: 1.10
412  */
413 void
414 gst_stream_set_caps (GstStream * stream, GstCaps * caps)
415 {
416   gboolean notify = FALSE;
417 
418   GST_OBJECT_LOCK (stream);
419   if (stream-&gt;priv-&gt;caps == NULL || (caps
420           &amp;&amp; !gst_caps_is_equal (stream-&gt;priv-&gt;caps, caps))) {
421     gst_caps_replace (&amp;stream-&gt;priv-&gt;caps, caps);
422     notify = TRUE;
423   }
424   GST_OBJECT_UNLOCK (stream);
425 
426   if (notify)
427     g_object_notify_by_pspec (G_OBJECT (stream), gst_stream_pspecs[PROP_CAPS]);
428 }
429 
430 
431 /**
432  * gst_stream_get_caps:
433  * @stream: a #GstStream
434  *
435  * Retrieve the caps for @stream, if any
436  *
437  * Returns: (transfer full) (nullable): The #GstCaps for @stream
438  *
439  * Since: 1.10
440  */
441 GstCaps *
442 gst_stream_get_caps (GstStream * stream)
443 {
444   GstCaps *res = NULL;
445 
446   GST_OBJECT_LOCK (stream);
447   if (stream-&gt;priv-&gt;caps)
448     res = gst_caps_ref (stream-&gt;priv-&gt;caps);
449   GST_OBJECT_UNLOCK (stream);
450 
451   return res;
452 }
453 
454 static void
455 gst_stream_set_property (GObject * object, guint prop_id,
456     const GValue * value, GParamSpec * pspec)
457 {
458   GstStream *stream;
459 
460   stream = GST_STREAM_CAST (object);
461 
462   switch (prop_id) {
463     case PROP_STREAM_ID:
464       gst_stream_set_stream_id (stream, g_value_get_string (value));
465       break;
466     case PROP_STREAM_FLAGS:
467       GST_OBJECT_LOCK (stream);
468       stream-&gt;priv-&gt;flags = g_value_get_flags (value);
469       GST_OBJECT_UNLOCK (stream);
470       break;
471     case PROP_STREAM_TYPE:
472       GST_OBJECT_LOCK (stream);
473       stream-&gt;priv-&gt;type = g_value_get_flags (value);
474       GST_OBJECT_UNLOCK (stream);
475       break;
476     case PROP_TAGS:
477       GST_OBJECT_LOCK (stream);
478       gst_mini_object_replace ((GstMiniObject **) &amp; stream-&gt;priv-&gt;tags,
479           (GstMiniObject *) g_value_get_boxed (value));
480       GST_OBJECT_UNLOCK (stream);
481       break;
482     case PROP_CAPS:
483       GST_OBJECT_LOCK (stream);
484       gst_mini_object_replace ((GstMiniObject **) &amp; stream-&gt;priv-&gt;caps,
485           (GstMiniObject *) g_value_get_boxed (value));
486       GST_OBJECT_UNLOCK (stream);
487       break;
488     default:
489       G_OBJECT_WARN_INVALID_PROPERTY_ID (object, prop_id, pspec);
490       break;
491   }
492 }
493 
494 static void
495 gst_stream_get_property (GObject * object, guint prop_id,
496     GValue * value, GParamSpec * pspec)
497 {
498   GstStream *stream;
499 
500   stream = GST_STREAM_CAST (object);
501 
502   switch (prop_id) {
503     case PROP_STREAM_ID:
504       g_value_set_string (value, gst_stream_get_stream_id (stream));
505       break;
506     case PROP_STREAM_FLAGS:
507       g_value_set_flags (value, gst_stream_get_stream_flags (stream));
508       break;
509     case PROP_STREAM_TYPE:
510       g_value_set_flags (value, gst_stream_get_stream_type (stream));
511       break;
512     case PROP_TAGS:
513       g_value_take_boxed (value, gst_stream_get_tags (stream));
514       break;
515     case PROP_CAPS:
516       g_value_take_boxed (value, gst_stream_get_caps (stream));
517       break;
518     default:
519       G_OBJECT_WARN_INVALID_PROPERTY_ID (object, prop_id, pspec);
520       break;
521   }
522 }
523 
524 /**
525  * gst_stream_type_get_name:
526  * @stype: a #GstStreamType
527  *
528  * Get a descriptive string for a given #GstStreamType
529  *
530  * Returns: (nullable): A string describing the stream type
531  *
532  * Since: 1.10
533  */
534 const gchar *
535 gst_stream_type_get_name (GstStreamType stype)
536 {
537   /* FIXME : Make this more flexible */
538   switch (stype) {
539     case GST_STREAM_TYPE_UNKNOWN:
540       return &quot;unknown&quot;;
541     case GST_STREAM_TYPE_AUDIO:
542       return &quot;audio&quot;;
543     case GST_STREAM_TYPE_VIDEO:
544       return &quot;video&quot;;
545     case GST_STREAM_TYPE_CONTAINER:
546       return &quot;container&quot;;
547     case GST_STREAM_TYPE_TEXT:
548       return &quot;text&quot;;
549     default:
550       return NULL;
551   }
552 
553   return NULL;
554 }
    </pre>
  </body>
</html>