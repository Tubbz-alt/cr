<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.media/src/main/native/gstreamer/3rd_party/glib/glib/grcbox.c</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="grand.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="grcboxprivate.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.media/src/main/native/gstreamer/3rd_party/glib/glib/grcbox.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -154,35 +154,59 @@</span>
   * {
   *   // my_data_struct_clear() is defined elsewhere
   *   g_rc_box_release_full (data, (GDestroyNotify) my_data_struct_clear);
   * }
   *
<span class="udiff-line-modified-removed">-  * G_DEFINE_AUTOPTR_CLEANUP_FUNC (MyDataStruct, my_data_struct_clear)</span>
<span class="udiff-line-modified-added">+  * G_DEFINE_AUTOPTR_CLEANUP_FUNC (MyDataStruct, my_data_struct_release)</span>
   * ]|
   *
<span class="udiff-line-modified-removed">-  * Since: 2.58.</span>
<span class="udiff-line-modified-added">+  * Since: 2.58</span>
   */
  
<span class="udiff-line-removed">- #define G_RC_BOX(p)             (GRcBox *) (((char *) (p)) - G_RC_BOX_SIZE)</span>
<span class="udiff-line-removed">- </span>
  /* We use the same alignment as GTypeInstance and GNU libc&#39;s malloc */
<span class="udiff-line-removed">- #define STRUCT_ALIGNMENT        (2 * sizeof (gsize))</span>
  #define ALIGN_STRUCT(offset)    ((offset + (STRUCT_ALIGNMENT - 1)) &amp; -STRUCT_ALIGNMENT)
  
<span class="udiff-line-added">+ #define G_RC_BOX(p)             (GRcBox *) (((char *) (p)) - G_RC_BOX_SIZE)</span>
<span class="udiff-line-added">+ </span>
  gpointer
  g_rc_box_alloc_full (gsize    block_size,
<span class="udiff-line-added">+                      gsize    alignment,</span>
                       gboolean atomic,
                       gboolean clear)
  {
<span class="udiff-line-modified-removed">-   /* sizeof GArcBox == sizeof GRcBox */</span>
<span class="udiff-line-modified-added">+   /* We don&#39;t do an (atomic ? G_ARC_BOX_SIZE : G_RC_BOX_SIZE) check, here</span>
<span class="udiff-line-added">+    * because we have a static assertion that sizeof(GArcBox) == sizeof(GRcBox)</span>
<span class="udiff-line-added">+    * inside grcboxprivate.h, and we don&#39;t want the compiler to unnecessarily</span>
<span class="udiff-line-added">+    * warn about both branches of the conditional yielding identical results</span>
<span class="udiff-line-added">+    */</span>
    gsize private_size = G_ARC_BOX_SIZE;
<span class="udiff-line-added">+   gsize private_offset = 0;</span>
    gsize real_size;
    char *allocated;
  
<span class="udiff-line-modified-removed">-   g_assert (block_size &lt; (G_MAXSIZE - G_ARC_BOX_SIZE));</span>
<span class="udiff-line-modified-added">+   g_assert (alignment != 0);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   /* We need to ensure that the private data is aligned */</span>
<span class="udiff-line-added">+   if (private_size % alignment != 0)</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       private_offset = private_size % alignment;</span>
<span class="udiff-line-added">+       private_size += (alignment - private_offset);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   g_assert (block_size &lt; (G_MAXSIZE - private_size));</span>
    real_size = private_size + block_size;
  
<span class="udiff-line-added">+   /* The real allocated size must be a multiple of @alignment, to</span>
<span class="udiff-line-added">+    * maintain the alignment of block_size</span>
<span class="udiff-line-added">+    */</span>
<span class="udiff-line-added">+   if (real_size % alignment != 0)</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       gsize offset = real_size % alignment;</span>
<span class="udiff-line-added">+       g_assert (real_size &lt; (G_MAXSIZE - (alignment - offset)));</span>
<span class="udiff-line-added">+       real_size += (alignment - offset);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
  #ifdef ENABLE_VALGRIND
    if (RUNNING_ON_VALGRIND)
      {
        /* When running under Valgrind we massage the memory allocation
         * to include a pointer at the tail end of the block; the pointer
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -212,21 +236,41 @@</span>
          allocated = g_malloc (real_size);
      }
  
    if (atomic)
      {
<span class="udiff-line-modified-removed">-       GArcBox *real_box = (GArcBox *) allocated;</span>
<span class="udiff-line-modified-added">+       /* We leave the alignment padding at the top of the allocation,</span>
<span class="udiff-line-added">+        * so we have an in memory layout of:</span>
<span class="udiff-line-added">+        *</span>
<span class="udiff-line-added">+        *  |[ offset ][ sizeof(GArcBox) ]||[ block_size ]|</span>
<span class="udiff-line-added">+        */</span>
<span class="udiff-line-added">+       GArcBox *real_box = (GArcBox *) (allocated + private_offset);</span>
<span class="udiff-line-added">+       /* Store the real size */</span>
        real_box-&gt;mem_size = block_size;
<span class="udiff-line-added">+       /* Store the alignment offset, to be used when freeing the</span>
<span class="udiff-line-added">+        * allocated block</span>
<span class="udiff-line-added">+        */</span>
<span class="udiff-line-added">+       real_box-&gt;private_offset = private_offset;</span>
  #ifndef G_DISABLE_ASSERT
        real_box-&gt;magic = G_BOX_MAGIC;
  #endif
        g_atomic_ref_count_init (&amp;real_box-&gt;ref_count);
      }
    else
      {
<span class="udiff-line-modified-removed">-       GRcBox *real_box = (GRcBox *) allocated;</span>
<span class="udiff-line-modified-added">+       /* We leave the alignment padding at the top of the allocation,</span>
<span class="udiff-line-added">+        * so we have an in memory layout of:</span>
<span class="udiff-line-added">+        *</span>
<span class="udiff-line-added">+        *  |[ offset ][ sizeof(GRcBox) ]||[ block_size ]|</span>
<span class="udiff-line-added">+        */</span>
<span class="udiff-line-added">+       GRcBox *real_box = (GRcBox *) (allocated + private_offset);</span>
<span class="udiff-line-added">+       /* Store the real size */</span>
        real_box-&gt;mem_size = block_size;
<span class="udiff-line-added">+       /* Store the alignment offset, to be used when freeing the</span>
<span class="udiff-line-added">+        * allocated block</span>
<span class="udiff-line-added">+        */</span>
<span class="udiff-line-added">+       real_box-&gt;private_offset = private_offset;</span>
  #ifndef G_DISABLE_ASSERT
        real_box-&gt;magic = G_BOX_MAGIC;
  #endif
        g_ref_count_init (&amp;real_box-&gt;ref_count);
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -244,20 +288,23 @@</span>
   * counting semantics to it.
   *
   * The data will be freed when its reference count drops to
   * zero.
   *
<span class="udiff-line-added">+  * The allocated data is guaranteed to be suitably aligned for any</span>
<span class="udiff-line-added">+  * built-in type.</span>
<span class="udiff-line-added">+  *</span>
   * Returns: (transfer full) (not nullable): a pointer to the allocated memory
   *
   * Since: 2.58
   */
  gpointer
  g_rc_box_alloc (gsize block_size)
  {
    g_return_val_if_fail (block_size &gt; 0, NULL);
  
<span class="udiff-line-modified-removed">-   return g_rc_box_alloc_full (block_size, FALSE, FALSE);</span>
<span class="udiff-line-modified-added">+   return g_rc_box_alloc_full (block_size, STRUCT_ALIGNMENT, FALSE, FALSE);</span>
  }
  
  /**
   * g_rc_box_alloc0:
   * @block_size: the size of the allocation, must be greater than 0
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -268,20 +315,23 @@</span>
   * The contents of the returned data is set to zero.
   *
   * The data will be freed when its reference count drops to
   * zero.
   *
<span class="udiff-line-added">+  * The allocated data is guaranteed to be suitably aligned for any</span>
<span class="udiff-line-added">+  * built-in type.</span>
<span class="udiff-line-added">+  *</span>
   * Returns: (transfer full) (not nullable): a pointer to the allocated memory
   *
   * Since: 2.58
   */
  gpointer
  g_rc_box_alloc0 (gsize block_size)
  {
    g_return_val_if_fail (block_size &gt; 0, NULL);
  
<span class="udiff-line-modified-removed">-   return g_rc_box_alloc_full (block_size, FALSE, TRUE);</span>
<span class="udiff-line-modified-added">+   return g_rc_box_alloc_full (block_size, STRUCT_ALIGNMENT, FALSE, TRUE);</span>
  }
  
  /**
   * g_rc_box_new:
   * @type: the type to allocate, typically a structure name
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -337,11 +387,11 @@</span>
    gpointer res;
  
    g_return_val_if_fail (block_size &gt; 0, NULL);
    g_return_val_if_fail (mem_block != NULL, NULL);
  
<span class="udiff-line-modified-removed">-   res = g_rc_box_alloc_full (block_size, FALSE, FALSE);</span>
<span class="udiff-line-modified-added">+   res = g_rc_box_alloc_full (block_size, STRUCT_ALIGNMENT, FALSE, FALSE);</span>
    memcpy (res, mem_block, block_size);
  
    return res;
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -414,17 +464,19 @@</span>
    g_return_if_fail (real_box-&gt;magic == G_BOX_MAGIC);
  #endif
  
    if (g_ref_count_dec (&amp;real_box-&gt;ref_count))
      {
<span class="udiff-line-added">+       char *real_mem = (char *) real_box - real_box-&gt;private_offset;</span>
<span class="udiff-line-added">+ </span>
        TRACE (GLIB_RCBOX_RELEASE (mem_block, 0));
  
        if (clear_func != NULL)
          clear_func (mem_block);
  
        TRACE (GLIB_RCBOX_FREE (mem_block));
<span class="udiff-line-modified-removed">-       g_free (real_box);</span>
<span class="udiff-line-modified-added">+       g_free (real_mem);</span>
      }
  }
  
  /**
   * g_rc_box_get_size:
</pre>
<center><a href="grand.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="grcboxprivate.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>