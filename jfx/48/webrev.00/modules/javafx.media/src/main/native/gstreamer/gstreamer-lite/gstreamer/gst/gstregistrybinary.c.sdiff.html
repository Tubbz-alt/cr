<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.media/src/main/native/gstreamer/gstreamer-lite/gstreamer/gst/gstregistrybinary.c</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="gstregistry.c.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="gstregistrychunks.c.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.media/src/main/native/gstreamer/gstreamer-lite/gstreamer/gst/gstregistrybinary.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
236     GST_ERROR (&quot;Failed to write to cache file&quot;);
237   }
238   cache-&gt;currentoffset += written;
239 
240   return written;
241 }
242 
243 static gboolean
244 gst_registry_binary_cache_finish (BinaryRegistryCache * cache, gboolean success)
245 {
246   /* only fsync if we&#39;re actually going to use and rename the file below */
247   if (success &amp;&amp; fsync (cache-&gt;cache_fd) &lt; 0)
248     goto fsync_failed;
249 
250   if (close (cache-&gt;cache_fd) &lt; 0)
251     goto close_failed;
252 
253   if (!success)
254     goto fail_after_close;
255 
<span class="line-modified">256     /* Only do the rename if we wrote the entire file successfully */</span>
<span class="line-modified">257     if (g_rename (cache-&gt;tmp_location, cache-&gt;location) &lt; 0) {</span>
<span class="line-modified">258       GST_ERROR (&quot;g_rename() failed: %s&quot;, g_strerror (errno));</span>
<span class="line-modified">259       goto rename_failed;</span>
<span class="line-modified">260     }</span>
261 
262   g_free (cache-&gt;tmp_location);
263   g_slice_free (BinaryRegistryCache, cache);
264   GST_INFO (&quot;Wrote binary registry cache&quot;);
265   return TRUE;
266 
267 /* ERRORS */
268 fail_after_close:
269   {
270     g_unlink (cache-&gt;tmp_location);
271     g_free (cache-&gt;tmp_location);
272     g_slice_free (BinaryRegistryCache, cache);
273     return FALSE;
274   }
275 fsync_failed:
276   {
277     GST_ERROR (&quot;fsync() failed: %s&quot;, g_strerror (errno));
278     goto fail_after_close;
279   }
280 close_failed:
</pre>
<hr />
<pre>
287     GST_ERROR (&quot;g_rename() failed: %s&quot;, g_strerror (errno));
288     goto fail_after_close;
289   }
290 }
291 #endif
292 
293 /*
294  * gst_registry_binary_write_chunk:
295  *
296  * Write from a memory location to the registry cache file
297  *
298  * Returns: %TRUE for success
299  */
300 inline static gboolean
301 gst_registry_binary_write_chunk (BinaryRegistryCache * cache,
302     GstRegistryChunk * chunk, unsigned long *file_position)
303 {
304   gchar padder[ALIGNMENT] = { 0, };
305   int padsize = 0;
306 
<span class="line-modified">307   /* Padding to insert the struct that requiere word alignment */</span>
308   if ((chunk-&gt;align) &amp;&amp; (alignment (*file_position) != 0)) {
309     padsize = ALIGNMENT - alignment (*file_position);
310     if (gst_registry_binary_cache_write (cache, *file_position,
311             padder, padsize) != padsize) {
312       GST_ERROR (&quot;Failed to write binary registry padder&quot;);
313       return FALSE;
314     }
315     *file_position += padsize;
316   }
317 
318   if (gst_registry_binary_cache_write (cache, *file_position,
319           chunk-&gt;data, chunk-&gt;size) != chunk-&gt;size) {
320     GST_ERROR (&quot;Failed to write binary registry element&quot;);
321     return FALSE;
322   }
323 
324   *file_position += chunk-&gt;size;
325 
326   return TRUE;
327 }
</pre>
</td>
<td>
<hr />
<pre>
236     GST_ERROR (&quot;Failed to write to cache file&quot;);
237   }
238   cache-&gt;currentoffset += written;
239 
240   return written;
241 }
242 
243 static gboolean
244 gst_registry_binary_cache_finish (BinaryRegistryCache * cache, gboolean success)
245 {
246   /* only fsync if we&#39;re actually going to use and rename the file below */
247   if (success &amp;&amp; fsync (cache-&gt;cache_fd) &lt; 0)
248     goto fsync_failed;
249 
250   if (close (cache-&gt;cache_fd) &lt; 0)
251     goto close_failed;
252 
253   if (!success)
254     goto fail_after_close;
255 
<span class="line-modified">256   /* Only do the rename if we wrote the entire file successfully */</span>
<span class="line-modified">257   if (g_rename (cache-&gt;tmp_location, cache-&gt;location) &lt; 0) {</span>
<span class="line-modified">258     GST_ERROR (&quot;g_rename() failed: %s&quot;, g_strerror (errno));</span>
<span class="line-modified">259     goto rename_failed;</span>
<span class="line-modified">260   }</span>
261 
262   g_free (cache-&gt;tmp_location);
263   g_slice_free (BinaryRegistryCache, cache);
264   GST_INFO (&quot;Wrote binary registry cache&quot;);
265   return TRUE;
266 
267 /* ERRORS */
268 fail_after_close:
269   {
270     g_unlink (cache-&gt;tmp_location);
271     g_free (cache-&gt;tmp_location);
272     g_slice_free (BinaryRegistryCache, cache);
273     return FALSE;
274   }
275 fsync_failed:
276   {
277     GST_ERROR (&quot;fsync() failed: %s&quot;, g_strerror (errno));
278     goto fail_after_close;
279   }
280 close_failed:
</pre>
<hr />
<pre>
287     GST_ERROR (&quot;g_rename() failed: %s&quot;, g_strerror (errno));
288     goto fail_after_close;
289   }
290 }
291 #endif
292 
293 /*
294  * gst_registry_binary_write_chunk:
295  *
296  * Write from a memory location to the registry cache file
297  *
298  * Returns: %TRUE for success
299  */
300 inline static gboolean
301 gst_registry_binary_write_chunk (BinaryRegistryCache * cache,
302     GstRegistryChunk * chunk, unsigned long *file_position)
303 {
304   gchar padder[ALIGNMENT] = { 0, };
305   int padsize = 0;
306 
<span class="line-modified">307   /* Padding to insert the struct that require word alignment */</span>
308   if ((chunk-&gt;align) &amp;&amp; (alignment (*file_position) != 0)) {
309     padsize = ALIGNMENT - alignment (*file_position);
310     if (gst_registry_binary_cache_write (cache, *file_position,
311             padder, padsize) != padsize) {
312       GST_ERROR (&quot;Failed to write binary registry padder&quot;);
313       return FALSE;
314     }
315     *file_position += padsize;
316   }
317 
318   if (gst_registry_binary_cache_write (cache, *file_position,
319           chunk-&gt;data, chunk-&gt;size) != chunk-&gt;size) {
320     GST_ERROR (&quot;Failed to write binary registry element&quot;);
321     return FALSE;
322   }
323 
324   *file_position += chunk-&gt;size;
325 
326   return TRUE;
327 }
</pre>
</td>
</tr>
</table>
<center><a href="gstregistry.c.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="gstregistrychunks.c.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>