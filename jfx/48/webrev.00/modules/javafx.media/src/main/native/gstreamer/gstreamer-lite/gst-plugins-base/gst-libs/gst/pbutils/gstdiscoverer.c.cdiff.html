<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.media/src/main/native/gstreamer/gstreamer-lite/gst-plugins-base/gst-libs/gst/pbutils/gstdiscoverer.c</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="gstdiscoverer-types.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="gstdiscoverer.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.media/src/main/native/gstreamer/gstreamer-lite/gst-plugins-base/gst-libs/gst/pbutils/gstdiscoverer.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 51,12 ***</span>
<span class="line-new-header">--- 51,16 ---</span>
  #include &lt;string.h&gt;
  
  #include &quot;pbutils.h&quot;
  #include &quot;pbutils-private.h&quot;
  
<span class="line-added">+ /* For g_stat () */</span>
<span class="line-added">+ #include &lt;glib/gstdio.h&gt;</span>
<span class="line-added">+ </span>
  GST_DEBUG_CATEGORY_STATIC (discoverer_debug);
  #define GST_CAT_DEFAULT discoverer_debug
<span class="line-added">+ #define CACHE_DIRNAME &quot;discoverer&quot;</span>
  
  static GQuark _CAPS_QUARK;
  static GQuark _TAGS_QUARK;
  static GQuark _ELEMENT_SRCPAD_QUARK;
  static GQuark _TOC_QUARK;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 122,12 ***</span>
  
    GType decodebin_type;
  
    /* Custom main context variables */
    GMainContext *ctx;
<span class="line-modified">!   guint sourceid;</span>
<span class="line-modified">!   guint timeoutid;</span>
  
    /* reusable queries */
    GstQuery *seeking_query;
  
    /* Handler ids for various callbacks */
<span class="line-new-header">--- 126,12 ---</span>
  
    GType decodebin_type;
  
    /* Custom main context variables */
    GMainContext *ctx;
<span class="line-modified">!   GSource *bus_source;</span>
<span class="line-modified">!   GSource *timeout_source;</span>
  
    /* reusable queries */
    GstQuery *seeking_query;
  
    /* Handler ids for various callbacks */
</pre>
<hr />
<pre>
<span class="line-old-header">*** 135,10 ***</span>
<span class="line-new-header">--- 139,12 ---</span>
    gulong pad_remove_id;
    gulong no_more_pads_id;
    gulong source_chg_id;
    gulong element_added_id;
    gulong bus_cb_id;
<span class="line-added">+ </span>
<span class="line-added">+   gboolean use_cache;</span>
  };
  
  #define DISCO_LOCK(dc) g_mutex_lock (&amp;dc-&gt;priv-&gt;lock);
  #define DISCO_UNLOCK(dc) g_mutex_unlock (&amp;dc-&gt;priv-&gt;lock);
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 156,11 ***</span>
    _STREAM_TOPOLOGY_QUARK = g_quark_from_static_string (&quot;stream-topology&quot;);
    _TOPOLOGY_PAD_QUARK = g_quark_from_static_string (&quot;pad&quot;);
  };
  
  G_DEFINE_TYPE_EXTENDED (GstDiscoverer, gst_discoverer, G_TYPE_OBJECT, 0,
<span class="line-modified">!     _do_init ());</span>
  
  enum
  {
    SIGNAL_FINISHED,
    SIGNAL_STARTING,
<span class="line-new-header">--- 162,11 ---</span>
    _STREAM_TOPOLOGY_QUARK = g_quark_from_static_string (&quot;stream-topology&quot;);
    _TOPOLOGY_PAD_QUARK = g_quark_from_static_string (&quot;pad&quot;);
  };
  
  G_DEFINE_TYPE_EXTENDED (GstDiscoverer, gst_discoverer, G_TYPE_OBJECT, 0,
<span class="line-modified">!     G_ADD_PRIVATE (GstDiscoverer) _do_init ());</span>
  
  enum
  {
    SIGNAL_FINISHED,
    SIGNAL_STARTING,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 168,15 ***</span>
    SIGNAL_SOURCE_SETUP,
    LAST_SIGNAL
  };
  
  #define DEFAULT_PROP_TIMEOUT 15 * GST_SECOND
  
  enum
  {
    PROP_0,
<span class="line-modified">!   PROP_TIMEOUT</span>
  };
  
  static guint gst_discoverer_signals[LAST_SIGNAL] = { 0 };
  
  static void gst_discoverer_set_timeout (GstDiscoverer * dc,
<span class="line-new-header">--- 174,17 ---</span>
    SIGNAL_SOURCE_SETUP,
    LAST_SIGNAL
  };
  
  #define DEFAULT_PROP_TIMEOUT 15 * GST_SECOND
<span class="line-added">+ #define DEFAULT_PROP_USE_CACHE FALSE</span>
  
  enum
  {
    PROP_0,
<span class="line-modified">!   PROP_TIMEOUT,</span>
<span class="line-added">+   PROP_USE_CACHE</span>
  };
  
  static guint gst_discoverer_signals[LAST_SIGNAL] = { 0 };
  
  static void gst_discoverer_set_timeout (GstDiscoverer * dc,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 198,10 ***</span>
<span class="line-new-header">--- 206,17 ---</span>
  static void gst_discoverer_finalize (GObject * dc);
  static void gst_discoverer_set_property (GObject * object, guint prop_id,
      const GValue * value, GParamSpec * pspec);
  static void gst_discoverer_get_property (GObject * object, guint prop_id,
      GValue * value, GParamSpec * pspec);
<span class="line-added">+ static gboolean _setup_locked (GstDiscoverer * dc);</span>
<span class="line-added">+ static void handle_current_async (GstDiscoverer * dc);</span>
<span class="line-added">+ static gboolean emit_discovererd_and_next (GstDiscoverer * dc);</span>
<span class="line-added">+ static GVariant *gst_discoverer_info_to_variant_recurse (GstDiscovererStreamInfo</span>
<span class="line-added">+     * sinfo, GstDiscovererSerializeFlags flags);</span>
<span class="line-added">+ static GstDiscovererStreamInfo *_parse_discovery (GVariant * variant,</span>
<span class="line-added">+     GstDiscovererInfo * info);</span>
  
  static void
  gst_discoverer_class_init (GstDiscovererClass * klass)
  {
    GObjectClass *gobject_class = (GObjectClass *) klass;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 210,11 ***</span>
    gobject_class-&gt;finalize = gst_discoverer_finalize;
  
    gobject_class-&gt;set_property = gst_discoverer_set_property;
    gobject_class-&gt;get_property = gst_discoverer_get_property;
  
<span class="line-removed">-   g_type_class_add_private (klass, sizeof (GstDiscovererPrivate));</span>
  
    /* properties */
    /**
     * GstDiscoverer:timeout:
     *
<span class="line-new-header">--- 225,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 227,10 ***</span>
<span class="line-new-header">--- 241,28 ---</span>
    g_object_class_install_property (gobject_class, PROP_TIMEOUT,
        g_param_spec_uint64 (&quot;timeout&quot;, &quot;timeout&quot;, &quot;Timeout&quot;,
            GST_SECOND, 3600 * GST_SECOND, DEFAULT_PROP_TIMEOUT,
            G_PARAM_READWRITE | G_PARAM_CONSTRUCT | G_PARAM_STATIC_STRINGS));
  
<span class="line-added">+   /**</span>
<span class="line-added">+    * GstDiscoverer::use-cache:</span>
<span class="line-added">+    *</span>
<span class="line-added">+    * Whether to use a serialized version of the discoverer info from our</span>
<span class="line-added">+    * own cache if accessible. This allows the discovery to be much faster</span>
<span class="line-added">+    * as when using this option, we do not need to create a #GstPipeline</span>
<span class="line-added">+    * and run it, but instead, just reload the #GstDiscovererInfo in its</span>
<span class="line-added">+    * serialized form.</span>
<span class="line-added">+    *</span>
<span class="line-added">+    * The cache files are saved in `$XDG_CACHE_DIR/gstreamer-1.0/discoverer/`.</span>
<span class="line-added">+    *</span>
<span class="line-added">+    * Since: 1.16</span>
<span class="line-added">+    */</span>
<span class="line-added">+   g_object_class_install_property (gobject_class, PROP_USE_CACHE,</span>
<span class="line-added">+       g_param_spec_boolean (&quot;use-cache&quot;, &quot;use cache&quot;, &quot;Use cache&quot;,</span>
<span class="line-added">+           DEFAULT_PROP_USE_CACHE,</span>
<span class="line-added">+           G_PARAM_READWRITE | G_PARAM_CONSTRUCT | G_PARAM_STATIC_STRINGS));</span>
<span class="line-added">+ </span>
    /* signals */
    /**
     * GstDiscoverer::finished:
     * @discoverer: the #GstDiscoverer
     *
</pre>
<hr />
<pre>
<span class="line-old-header">*** 310,14 ***</span>
  gst_discoverer_init (GstDiscoverer * dc)
  {
    GstElement *tmp;
    GstFormat format = GST_FORMAT_TIME;
  
<span class="line-modified">!   dc-&gt;priv = G_TYPE_INSTANCE_GET_PRIVATE (dc, GST_TYPE_DISCOVERER,</span>
<span class="line-removed">-       GstDiscovererPrivate);</span>
  
    dc-&gt;priv-&gt;timeout = DEFAULT_PROP_TIMEOUT;
    dc-&gt;priv-&gt;async = FALSE;
  
    g_mutex_init (&amp;dc-&gt;priv-&gt;lock);
  
    dc-&gt;priv-&gt;pending_subtitle_pads = 0;
<span class="line-new-header">--- 342,14 ---</span>
  gst_discoverer_init (GstDiscoverer * dc)
  {
    GstElement *tmp;
    GstFormat format = GST_FORMAT_TIME;
  
<span class="line-modified">!   dc-&gt;priv = gst_discoverer_get_instance_private (dc);</span>
  
    dc-&gt;priv-&gt;timeout = DEFAULT_PROP_TIMEOUT;
<span class="line-added">+   dc-&gt;priv-&gt;use_cache = DEFAULT_PROP_USE_CACHE;</span>
    dc-&gt;priv-&gt;async = FALSE;
  
    g_mutex_init (&amp;dc-&gt;priv-&gt;lock);
  
    dc-&gt;priv-&gt;pending_subtitle_pads = 0;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 451,10 ***</span>
<span class="line-new-header">--- 483,15 ---</span>
  
    switch (prop_id) {
      case PROP_TIMEOUT:
        gst_discoverer_set_timeout (dc, g_value_get_uint64 (value));
        break;
<span class="line-added">+     case PROP_USE_CACHE:</span>
<span class="line-added">+       DISCO_LOCK (dc);</span>
<span class="line-added">+       dc-&gt;priv-&gt;use_cache = g_value_get_boolean (value);</span>
<span class="line-added">+       DISCO_UNLOCK (dc);</span>
<span class="line-added">+       break;</span>
      default:
        G_OBJECT_WARN_INVALID_PROPERTY_ID (object, prop_id, pspec);
        break;
    }
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 469,10 ***</span>
<span class="line-new-header">--- 506,15 ---</span>
      case PROP_TIMEOUT:
        DISCO_LOCK (dc);
        g_value_set_uint64 (value, dc-&gt;priv-&gt;timeout);
        DISCO_UNLOCK (dc);
        break;
<span class="line-added">+     case PROP_USE_CACHE:</span>
<span class="line-added">+       DISCO_LOCK (dc);</span>
<span class="line-added">+       g_value_set_boolean (value, dc-&gt;priv-&gt;use_cache);</span>
<span class="line-added">+       DISCO_UNLOCK (dc);</span>
<span class="line-added">+       break;</span>
      default:
        G_OBJECT_WARN_INVALID_PROPERTY_ID (object, prop_id, pspec);
        break;
    }
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 545,21 ***</span>
    }
  
    return GST_PAD_PROBE_OK;
  }
  
<span class="line-modified">! static GstStaticCaps subtitle_caps = GST_STATIC_CAPS (&quot;text/x-raw; &quot;</span>
<span class="line-modified">!     &quot;subpicture/x-pgs; subpicture/x-dvb; subpicture/x-dvd; &quot;</span>
<span class="line-modified">!     &quot;application/x-subtitle-unknown; application/x-ssa; application/x-ass; &quot;</span>
<span class="line-removed">-     &quot;subtitle/x-kate; application/x-kate; subpicture/x-xsub&quot;);</span>
  
  static gboolean
  is_subtitle_caps (const GstCaps * caps)
  {
    GstCaps *subs_caps;
    gboolean ret;
  
    subs_caps = gst_static_caps_get (&amp;subtitle_caps);
    ret = gst_caps_can_intersect (caps, subs_caps);
    gst_caps_unref (subs_caps);
  
    return ret;
<span class="line-new-header">--- 587,34 ---</span>
    }
  
    return GST_PAD_PROBE_OK;
  }
  
<span class="line-modified">! static GstStaticCaps subtitle_caps =</span>
<span class="line-modified">!     GST_STATIC_CAPS</span>
<span class="line-modified">!     (&quot;application/x-ssa; application/x-ass; application/x-kate&quot;);</span>
  
  static gboolean
  is_subtitle_caps (const GstCaps * caps)
  {
    GstCaps *subs_caps;
<span class="line-added">+   GstStructure *s;</span>
<span class="line-added">+   const gchar *name;</span>
    gboolean ret;
  
<span class="line-added">+   s = gst_caps_get_structure (caps, 0);</span>
<span class="line-added">+   if (!s)</span>
<span class="line-added">+     return FALSE;</span>
<span class="line-added">+ </span>
<span class="line-added">+   name = gst_structure_get_name (s);</span>
<span class="line-added">+   if (g_str_has_prefix (name, &quot;text/&quot;) ||</span>
<span class="line-added">+       g_str_has_prefix (name, &quot;subpicture/&quot;) ||</span>
<span class="line-added">+       g_str_has_prefix (name, &quot;subtitle/&quot;) ||</span>
<span class="line-added">+       g_str_has_prefix (name, &quot;closedcaption/&quot;) ||</span>
<span class="line-added">+       g_str_has_prefix (name, &quot;application/x-subtitle&quot;))</span>
<span class="line-added">+     return TRUE;</span>
<span class="line-added">+ </span>
    subs_caps = gst_static_caps_get (&amp;subtitle_caps);
    ret = gst_caps_can_intersect (caps, subs_caps);
    gst_caps_unref (subs_caps);
  
    return ret;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1304,20 ***</span>
    }
  
    return res;
  }
  
  /* Called when pipeline is pre-rolled */
  static void
  discoverer_collect (GstDiscoverer * dc)
  {
    GST_DEBUG (&quot;Collecting information&quot;);
  
    /* Stop the timeout handler if present */
<span class="line-modified">!   if (dc-&gt;priv-&gt;timeoutid) {</span>
<span class="line-modified">!     g_source_remove (dc-&gt;priv-&gt;timeoutid);</span>
<span class="line-modified">!     dc-&gt;priv-&gt;timeoutid = 0;</span>
    }
  
    if (dc-&gt;priv-&gt;streams) {
      /* FIXME : Make this querying optional */
      if (TRUE) {
<span class="line-new-header">--- 1359,75 ---</span>
    }
  
    return res;
  }
  
<span class="line-added">+ /* Required DISCO_LOCK to be taken, and will release it */</span>
<span class="line-added">+ static void</span>
<span class="line-added">+ setup_next_uri_locked (GstDiscoverer * dc)</span>
<span class="line-added">+ {</span>
<span class="line-added">+   if (dc-&gt;priv-&gt;pending_uris != NULL) {</span>
<span class="line-added">+     gboolean ready = _setup_locked (dc);</span>
<span class="line-added">+     DISCO_UNLOCK (dc);</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (!ready) {</span>
<span class="line-added">+       /* Start timeout */</span>
<span class="line-added">+       handle_current_async (dc);</span>
<span class="line-added">+     } else {</span>
<span class="line-added">+       g_idle_add_full (G_PRIORITY_DEFAULT_IDLE,</span>
<span class="line-added">+           (GSourceFunc) emit_discovererd_and_next, gst_object_ref (dc),</span>
<span class="line-added">+           gst_object_unref);</span>
<span class="line-added">+     }</span>
<span class="line-added">+   } else {</span>
<span class="line-added">+     /* We&#39;re done ! */</span>
<span class="line-added">+     DISCO_UNLOCK (dc);</span>
<span class="line-added">+     g_signal_emit (dc, gst_discoverer_signals[SIGNAL_FINISHED], 0);</span>
<span class="line-added">+   }</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ </span>
<span class="line-added">+ static void</span>
<span class="line-added">+ emit_discovererd (GstDiscoverer * dc)</span>
<span class="line-added">+ {</span>
<span class="line-added">+   GST_DEBUG_OBJECT (dc, &quot;Emitting &#39;discoverered&#39; %s&quot;,</span>
<span class="line-added">+       dc-&gt;priv-&gt;current_info-&gt;uri);</span>
<span class="line-added">+   g_signal_emit (dc, gst_discoverer_signals[SIGNAL_DISCOVERED], 0,</span>
<span class="line-added">+       dc-&gt;priv-&gt;current_info, dc-&gt;priv-&gt;current_error);</span>
<span class="line-added">+   /* Clients get a copy of current_info since it is a boxed type */</span>
<span class="line-added">+   gst_discoverer_info_unref (dc-&gt;priv-&gt;current_info);</span>
<span class="line-added">+   dc-&gt;priv-&gt;current_info = NULL;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ static gboolean</span>
<span class="line-added">+ emit_discovererd_and_next (GstDiscoverer * dc)</span>
<span class="line-added">+ {</span>
<span class="line-added">+   emit_discovererd (dc);</span>
<span class="line-added">+ </span>
<span class="line-added">+   DISCO_LOCK (dc);</span>
<span class="line-added">+   setup_next_uri_locked (dc);</span>
<span class="line-added">+ </span>
<span class="line-added">+   return G_SOURCE_REMOVE;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  /* Called when pipeline is pre-rolled */
  static void
  discoverer_collect (GstDiscoverer * dc)
  {
    GST_DEBUG (&quot;Collecting information&quot;);
  
    /* Stop the timeout handler if present */
<span class="line-modified">!   if (dc-&gt;priv-&gt;timeout_source) {</span>
<span class="line-modified">!     g_source_destroy (dc-&gt;priv-&gt;timeout_source);</span>
<span class="line-modified">!     g_source_unref (dc-&gt;priv-&gt;timeout_source);</span>
<span class="line-added">+     dc-&gt;priv-&gt;timeout_source = NULL;</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
<span class="line-added">+   if (dc-&gt;priv-&gt;use_cache &amp;&amp; dc-&gt;priv-&gt;current_info</span>
<span class="line-added">+       &amp;&amp; dc-&gt;priv-&gt;current_info-&gt;from_cache) {</span>
<span class="line-added">+     GST_DEBUG_OBJECT (dc,</span>
<span class="line-added">+         &quot;Nothing to collect as the info was built from&quot; &quot; the cache&quot;);</span>
<span class="line-added">+     return;</span>
    }
  
    if (dc-&gt;priv-&gt;streams) {
      /* FIXME : Make this querying optional */
      if (TRUE) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1407,18 ***</span>
        if (g_str_has_prefix (gst_structure_get_name (st), &quot;image/&quot;))
          ((GstDiscovererVideoInfo *) stream_info)-&gt;is_image = TRUE;
      }
    }
  
<span class="line-modified">!   if (dc-&gt;priv-&gt;async) {</span>
<span class="line-modified">!     GST_DEBUG (&quot;Emitting &#39;discoverered&#39;&quot;);</span>
<span class="line-modified">!     g_signal_emit (dc, gst_discoverer_signals[SIGNAL_DISCOVERED], 0,</span>
<span class="line-modified">!         dc-&gt;priv-&gt;current_info, dc-&gt;priv-&gt;current_error);</span>
<span class="line-modified">!     /* Clients get a copy of current_info since it is a boxed type */</span>
<span class="line-modified">!     gst_discoverer_info_unref (dc-&gt;priv-&gt;current_info);</span>
<span class="line-modified">!     dc-&gt;priv-&gt;current_info = NULL;</span>
    }
  }
  
  static void
  get_async_cb (gpointer cb_data, GSource * source, GSourceFunc * func,
      gpointer * data)
<span class="line-new-header">--- 1517,21 ---</span>
        if (g_str_has_prefix (gst_structure_get_name (st), &quot;image/&quot;))
          ((GstDiscovererVideoInfo *) stream_info)-&gt;is_image = TRUE;
      }
    }
  
<span class="line-modified">!   if (dc-&gt;priv-&gt;use_cache &amp;&amp; dc-&gt;priv-&gt;current_info-&gt;cachefile &amp;&amp;</span>
<span class="line-modified">!       dc-&gt;priv-&gt;current_info-&gt;result == GST_DISCOVERER_OK) {</span>
<span class="line-modified">!     GVariant *variant = gst_discoverer_info_to_variant (dc-&gt;priv-&gt;current_info,</span>
<span class="line-modified">!         GST_DISCOVERER_SERIALIZE_ALL);</span>
<span class="line-modified">! </span>
<span class="line-modified">!     g_file_set_contents (dc-&gt;priv-&gt;current_info-&gt;cachefile,</span>
<span class="line-modified">!         g_variant_get_data (variant), g_variant_get_size (variant), NULL);</span>
    }
<span class="line-added">+ </span>
<span class="line-added">+   if (dc-&gt;priv-&gt;async)</span>
<span class="line-added">+     emit_discovererd (dc);</span>
  }
  
  static void
  get_async_cb (gpointer cb_data, GSource * source, GSourceFunc * func,
      gpointer * data)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1445,12 ***</span>
    };
  
    /* Attach a timeout to the main context */
    source = g_timeout_source_new (dc-&gt;priv-&gt;timeout / GST_MSECOND);
    g_source_set_callback_indirect (source, g_object_ref (dc), &amp;cb_funcs);
<span class="line-modified">!   dc-&gt;priv-&gt;timeoutid = g_source_attach (source, dc-&gt;priv-&gt;ctx);</span>
<span class="line-modified">!   g_source_unref (source);</span>
  }
  
  
  /* Returns TRUE if processing should stop */
  static gboolean
<span class="line-new-header">--- 1558,12 ---</span>
    };
  
    /* Attach a timeout to the main context */
    source = g_timeout_source_new (dc-&gt;priv-&gt;timeout / GST_MSECOND);
    g_source_set_callback_indirect (source, g_object_ref (dc), &amp;cb_funcs);
<span class="line-modified">!   g_source_attach (source, dc-&gt;priv-&gt;ctx);</span>
<span class="line-modified">!   dc-&gt;priv-&gt;timeout_source = source;</span>
  }
  
  
  /* Returns TRUE if processing should stop */
  static gboolean
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1659,23 ***</span>
  
    g_timer_stop (timer);
    g_timer_destroy (timer);
  }
  
<span class="line-modified">! static void</span>
  _setup_locked (GstDiscoverer * dc)
  {
    GstStateChangeReturn ret;
  
    GST_DEBUG (&quot;Setting up&quot;);
  
    /* Pop URI off the pending URI list */
    dc-&gt;priv-&gt;current_info =
        (GstDiscovererInfo *) g_object_new (GST_TYPE_DISCOVERER_INFO, NULL);
<span class="line-modified">!   dc-&gt;priv-&gt;current_info-&gt;uri = (gchar *) dc-&gt;priv-&gt;pending_uris-&gt;data;</span>
<span class="line-modified">!   dc-&gt;priv-&gt;pending_uris =</span>
<span class="line-removed">-       g_list_delete_link (dc-&gt;priv-&gt;pending_uris, dc-&gt;priv-&gt;pending_uris);</span>
  
    /* set uri on uridecodebin */
    g_object_set (dc-&gt;priv-&gt;uridecodebin, &quot;uri&quot;, dc-&gt;priv-&gt;current_info-&gt;uri,
        NULL);
  
<span class="line-new-header">--- 1772,120 ---</span>
  
    g_timer_stop (timer);
    g_timer_destroy (timer);
  }
  
<span class="line-modified">! static gchar *</span>
<span class="line-added">+ _serialized_info_get_path (GstDiscoverer * dc, gchar * uri)</span>
<span class="line-added">+ {</span>
<span class="line-added">+   GChecksum *cs = NULL;</span>
<span class="line-added">+   GStatBuf file_status;</span>
<span class="line-added">+   gchar *location = NULL, *res = NULL, *cache_dir = NULL, *tmp = NULL,</span>
<span class="line-added">+       *protocol = gst_uri_get_protocol (uri), hash_dirname[3] = &quot;00&quot;;</span>
<span class="line-added">+   const gchar *checksum;</span>
<span class="line-added">+ </span>
<span class="line-added">+   if (g_ascii_strcasecmp (protocol, &quot;file&quot;) != 0) {</span>
<span class="line-added">+     GST_DEBUG_OBJECT (dc, &quot;Can not work with serialized DiscovererInfo&quot;</span>
<span class="line-added">+         &quot; on non local files - protocol: %s&quot;, protocol);</span>
<span class="line-added">+ </span>
<span class="line-added">+     goto done;</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
<span class="line-added">+   location = gst_uri_get_location (uri);</span>
<span class="line-added">+   if (g_stat (location, &amp;file_status) &lt; 0) {</span>
<span class="line-added">+     GST_DEBUG_OBJECT (dc, &quot;Could not get stat for file: %s&quot;, location);</span>
<span class="line-added">+ </span>
<span class="line-added">+     goto done;</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
<span class="line-added">+   tmp = g_strdup_printf (&quot;%s-%&quot; G_GSIZE_FORMAT &quot;-%&quot; G_GINT64_FORMAT,</span>
<span class="line-added">+       location, (gsize) file_status.st_size, (gint64) file_status.st_mtime);</span>
<span class="line-added">+   cs = g_checksum_new (G_CHECKSUM_SHA1);</span>
<span class="line-added">+   g_checksum_update (cs, (const guchar *) tmp, strlen (tmp));</span>
<span class="line-added">+   checksum = g_checksum_get_string (cs);</span>
<span class="line-added">+ </span>
<span class="line-added">+   hash_dirname[0] = checksum[0];</span>
<span class="line-added">+   hash_dirname[1] = checksum[1];</span>
<span class="line-added">+   cache_dir =</span>
<span class="line-added">+       g_build_filename (g_get_user_cache_dir (), &quot;gstreamer-&quot; GST_API_VERSION,</span>
<span class="line-added">+       CACHE_DIRNAME, hash_dirname, NULL);</span>
<span class="line-added">+   g_mkdir_with_parents (cache_dir, 0777);</span>
<span class="line-added">+ </span>
<span class="line-added">+   res = g_build_filename (cache_dir, &amp;checksum[2], NULL);</span>
<span class="line-added">+ </span>
<span class="line-added">+ done:</span>
<span class="line-added">+   g_free (cache_dir);</span>
<span class="line-added">+   g_free (location);</span>
<span class="line-added">+   g_free (tmp);</span>
<span class="line-added">+   g_free (protocol);</span>
<span class="line-added">+ </span>
<span class="line-added">+   return res;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ static GstDiscovererInfo *</span>
<span class="line-added">+ _get_info_from_cachefile (GstDiscoverer * dc, gchar * cachefile)</span>
<span class="line-added">+ {</span>
<span class="line-added">+   gchar *data;</span>
<span class="line-added">+   gsize length;</span>
<span class="line-added">+ </span>
<span class="line-added">+   if (g_file_get_contents (cachefile, &amp;data, &amp;length, NULL)) {</span>
<span class="line-added">+     GstDiscovererInfo *info = NULL;</span>
<span class="line-added">+     GVariant *variant =</span>
<span class="line-added">+         g_variant_new_from_data (G_VARIANT_TYPE (&quot;v&quot;), data, length,</span>
<span class="line-added">+         TRUE, NULL, NULL);</span>
<span class="line-added">+ </span>
<span class="line-added">+     info = gst_discoverer_info_from_variant (variant);</span>
<span class="line-added">+     g_variant_unref (variant);</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (info) {</span>
<span class="line-added">+       info-&gt;cachefile = cachefile;</span>
<span class="line-added">+       info-&gt;from_cache = (gpointer) 0x01;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     GST_INFO_OBJECT (dc, &quot;Got info from cache: %p&quot;, info);</span>
<span class="line-added">+ </span>
<span class="line-added">+     return info;</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
<span class="line-added">+   return NULL;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ static gboolean</span>
  _setup_locked (GstDiscoverer * dc)
  {
    GstStateChangeReturn ret;
<span class="line-added">+   gchar *uri = (gchar *) dc-&gt;priv-&gt;pending_uris-&gt;data;</span>
<span class="line-added">+   gchar *cachefile = NULL;</span>
<span class="line-added">+ </span>
<span class="line-added">+   dc-&gt;priv-&gt;pending_uris =</span>
<span class="line-added">+       g_list_delete_link (dc-&gt;priv-&gt;pending_uris, dc-&gt;priv-&gt;pending_uris);</span>
<span class="line-added">+ </span>
<span class="line-added">+   if (dc-&gt;priv-&gt;use_cache) {</span>
<span class="line-added">+     cachefile = _serialized_info_get_path (dc, uri);</span>
<span class="line-added">+     if (cachefile)</span>
<span class="line-added">+       dc-&gt;priv-&gt;current_info = _get_info_from_cachefile (dc, cachefile);</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (dc-&gt;priv-&gt;current_info) {</span>
<span class="line-added">+       /* Make sure the URI is exactly what the user passed in */</span>
<span class="line-added">+       g_free (dc-&gt;priv-&gt;current_info-&gt;uri);</span>
<span class="line-added">+       dc-&gt;priv-&gt;current_info-&gt;uri = uri;</span>
<span class="line-added">+ </span>
<span class="line-added">+       dc-&gt;priv-&gt;current_info-&gt;cachefile = cachefile;</span>
<span class="line-added">+       dc-&gt;priv-&gt;processing = FALSE;</span>
<span class="line-added">+       dc-&gt;priv-&gt;target_state = GST_STATE_NULL;</span>
<span class="line-added">+ </span>
<span class="line-added">+       return TRUE;</span>
<span class="line-added">+     }</span>
<span class="line-added">+   }</span>
  
    GST_DEBUG (&quot;Setting up&quot;);
  
    /* Pop URI off the pending URI list */
    dc-&gt;priv-&gt;current_info =
        (GstDiscovererInfo *) g_object_new (GST_TYPE_DISCOVERER_INFO, NULL);
<span class="line-modified">!   dc-&gt;priv-&gt;current_info-&gt;cachefile = cachefile;</span>
<span class="line-modified">!   dc-&gt;priv-&gt;current_info-&gt;uri = uri;</span>
  
    /* set uri on uridecodebin */
    g_object_set (dc-&gt;priv-&gt;uridecodebin, &quot;uri&quot;, dc-&gt;priv-&gt;current_info-&gt;uri,
        NULL);
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1702,10 ***</span>
<span class="line-new-header">--- 1912,12 ---</span>
    DISCO_LOCK (dc);
  
  
    GST_DEBUG_OBJECT (dc, &quot;Pipeline going to PAUSED : %s&quot;,
        gst_element_state_change_return_get_name (ret));
<span class="line-added">+ </span>
<span class="line-added">+   return FALSE;</span>
  }
  
  static void
  discoverer_cleanup (GstDiscoverer * dc)
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1746,20 ***</span>
    dc-&gt;priv-&gt;cleanup = FALSE;
  
  
    /* Try popping the next uri */
    if (dc-&gt;priv-&gt;async) {
<span class="line-modified">!     if (dc-&gt;priv-&gt;pending_uris != NULL) {</span>
<span class="line-removed">-       _setup_locked (dc);</span>
<span class="line-removed">-       DISCO_UNLOCK (dc);</span>
<span class="line-removed">-       /* Start timeout */</span>
<span class="line-removed">-       handle_current_async (dc);</span>
<span class="line-removed">-     } else {</span>
<span class="line-removed">-       /* We&#39;re done ! */</span>
<span class="line-removed">-       DISCO_UNLOCK (dc);</span>
<span class="line-removed">-       g_signal_emit (dc, gst_discoverer_signals[SIGNAL_FINISHED], 0);</span>
<span class="line-removed">-     }</span>
    } else
      DISCO_UNLOCK (dc);
  
    GST_DEBUG (&quot;out&quot;);
  }
<span class="line-new-header">--- 1958,11 ---</span>
    dc-&gt;priv-&gt;cleanup = FALSE;
  
  
    /* Try popping the next uri */
    if (dc-&gt;priv-&gt;async) {
<span class="line-modified">!     setup_next_uri_locked (dc);</span>
    } else
      DISCO_UNLOCK (dc);
  
    GST_DEBUG (&quot;out&quot;);
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1782,11 ***</span>
  
  static gboolean
  async_timeout_cb (GstDiscoverer * dc)
  {
    if (!g_source_is_destroyed (g_main_current_source ())) {
<span class="line-removed">-     dc-&gt;priv-&gt;timeoutid = 0;</span>
      GST_DEBUG (&quot;Setting result to TIMEOUT&quot;);
      dc-&gt;priv-&gt;current_info-&gt;result = GST_DISCOVERER_TIMEOUT;
      dc-&gt;priv-&gt;processing = FALSE;
      discoverer_collect (dc);
      discoverer_cleanup (dc);
<span class="line-new-header">--- 1985,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1801,10 ***</span>
<span class="line-new-header">--- 2003,11 ---</span>
   * else a error flag.
   */
  static GstDiscovererResult
  start_discovering (GstDiscoverer * dc)
  {
<span class="line-added">+   gboolean ready;</span>
    GstDiscovererResult res = GST_DISCOVERER_OK;
  
    GST_DEBUG (&quot;Starting&quot;);
  
    DISCO_LOCK (dc);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1822,18 ***</span>
      goto beach;
    }
  
    g_signal_emit (dc, gst_discoverer_signals[SIGNAL_STARTING], 0);
  
<span class="line-modified">!   _setup_locked (dc);</span>
  
    DISCO_UNLOCK (dc);
  
<span class="line-modified">!   if (dc-&gt;priv-&gt;async)</span>
      handle_current_async (dc);
<span class="line-modified">!   else</span>
<span class="line-modified">!     handle_current_sync (dc);</span>
  
  beach:
    return res;
  }
  
<span class="line-new-header">--- 2025,28 ---</span>
      goto beach;
    }
  
    g_signal_emit (dc, gst_discoverer_signals[SIGNAL_STARTING], 0);
  
<span class="line-modified">!   ready = _setup_locked (dc);</span>
  
    DISCO_UNLOCK (dc);
  
<span class="line-modified">!   if (dc-&gt;priv-&gt;async) {</span>
<span class="line-added">+     if (ready) {</span>
<span class="line-added">+       g_idle_add_full (G_PRIORITY_DEFAULT_IDLE,</span>
<span class="line-added">+           (GSourceFunc) emit_discovererd_and_next, gst_object_ref (dc),</span>
<span class="line-added">+           gst_object_unref);</span>
<span class="line-added">+ </span>
<span class="line-added">+       goto beach;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      handle_current_async (dc);
<span class="line-modified">!   } else {</span>
<span class="line-modified">!     if (!ready)</span>
<span class="line-added">+       handle_current_sync (dc);</span>
<span class="line-added">+   }</span>
  
  beach:
    return res;
  }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1842,10 ***</span>
<span class="line-new-header">--- 2055,11 ---</span>
  static GVariant *
  _serialize_common_stream_info (GstDiscovererStreamInfo * sinfo,
      GstDiscovererSerializeFlags flags)
  {
    GVariant *common;
<span class="line-added">+   GVariant *nextv = NULL;</span>
    gchar *caps_str = NULL, *tags_str = NULL, *misc_str = NULL;
  
    if (sinfo-&gt;caps &amp;&amp; (flags &amp; GST_DISCOVERER_SERIALIZE_CAPS))
      caps_str = gst_caps_to_string (sinfo-&gt;caps);
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1853,13 ***</span>
      tags_str = gst_tag_list_to_string (sinfo-&gt;tags);
  
    if (sinfo-&gt;misc &amp;&amp; (flags &amp; GST_DISCOVERER_SERIALIZE_MISC))
      misc_str = gst_structure_to_string (sinfo-&gt;misc);
  
    common =
<span class="line-modified">!       g_variant_new (&quot;(msmsmsms)&quot;, sinfo-&gt;stream_id, caps_str, tags_str,</span>
<span class="line-modified">!       misc_str);</span>
  
    g_free (caps_str);
    g_free (tags_str);
    g_free (misc_str);
  
<span class="line-new-header">--- 2067,19 ---</span>
      tags_str = gst_tag_list_to_string (sinfo-&gt;tags);
  
    if (sinfo-&gt;misc &amp;&amp; (flags &amp; GST_DISCOVERER_SERIALIZE_MISC))
      misc_str = gst_structure_to_string (sinfo-&gt;misc);
  
<span class="line-added">+ </span>
<span class="line-added">+   if (sinfo-&gt;next)</span>
<span class="line-added">+     nextv = gst_discoverer_info_to_variant_recurse (sinfo-&gt;next, flags);</span>
<span class="line-added">+   else</span>
<span class="line-added">+     nextv = g_variant_new (&quot;()&quot;);</span>
<span class="line-added">+ </span>
    common =
<span class="line-modified">!       g_variant_new (&quot;(msmsmsmsv)&quot;, sinfo-&gt;stream_id, caps_str, tags_str,</span>
<span class="line-modified">!       misc_str, nextv);</span>
  
    g_free (caps_str);
    g_free (tags_str);
    g_free (misc_str);
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1960,10 ***</span>
<span class="line-new-header">--- 2180,20 ---</span>
      GVariant *subtitle_stream_info =
          _serialize_subtitle_stream_info (GST_DISCOVERER_SUBTITLE_INFO (sinfo));
      stream_variant =
          g_variant_new (&quot;(yvv)&quot;, &#39;s&#39;, common_stream_variant,
          subtitle_stream_info);
<span class="line-added">+   } else {</span>
<span class="line-added">+     GVariant *nextv = NULL;</span>
<span class="line-added">+     GstDiscovererStreamInfo *ninfo =</span>
<span class="line-added">+         gst_discoverer_stream_info_get_next (sinfo);</span>
<span class="line-added">+ </span>
<span class="line-added">+     nextv = gst_discoverer_info_to_variant_recurse (ninfo, flags);</span>
<span class="line-added">+ </span>
<span class="line-added">+     stream_variant =</span>
<span class="line-added">+         g_variant_new (&quot;(yvv)&quot;, &#39;n&#39;, common_stream_variant,</span>
<span class="line-added">+         g_variant_new (&quot;v&quot;, nextv));</span>
    }
  
    return stream_variant;
  }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2007,11 ***</span>
  
    GET_FROM_TUPLE (info_variant, boolean, 4, &amp;info-&gt;live);
  }
  
  static void
<span class="line-modified">! _parse_common_stream_info (GstDiscovererStreamInfo * sinfo, GVariant * common)</span>
  {
    const gchar *str;
  
    str = _maybe_get_string_from_tuple (common, 0);
    if (str)
<span class="line-new-header">--- 2237,12 ---</span>
  
    GET_FROM_TUPLE (info_variant, boolean, 4, &amp;info-&gt;live);
  }
  
  static void
<span class="line-modified">! _parse_common_stream_info (GstDiscovererStreamInfo * sinfo, GVariant * common,</span>
<span class="line-added">+     GstDiscovererInfo * info)</span>
  {
    const gchar *str;
  
    str = _maybe_get_string_from_tuple (common, 0);
    if (str)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2027,10 ***</span>
<span class="line-new-header">--- 2258,19 ---</span>
  
    str = _maybe_get_string_from_tuple (common, 3);
    if (str)
      sinfo-&gt;misc = gst_structure_new_from_string (str);
  
<span class="line-added">+   if (g_variant_n_children (common) &gt; 4) {</span>
<span class="line-added">+     GVariant *nextv;</span>
<span class="line-added">+ </span>
<span class="line-added">+     GET_FROM_TUPLE (common, variant, 4, &amp;nextv);</span>
<span class="line-added">+     if (g_variant_n_children (nextv) &gt; 0) {</span>
<span class="line-added">+       sinfo-&gt;next = _parse_discovery (nextv, info);</span>
<span class="line-added">+     }</span>
<span class="line-added">+   }</span>
<span class="line-added">+ </span>
    g_variant_unref (common);
  }
  
  static void
  _parse_audio_stream_info (GstDiscovererAudioInfo * ainfo, GVariant * specific)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2112,18 ***</span>
      case &#39;s&#39;:
        sinfo = g_object_new (GST_TYPE_DISCOVERER_SUBTITLE_INFO, NULL);
        _parse_subtitle_stream_info (GST_DISCOVERER_SUBTITLE_INFO (sinfo),
            g_variant_get_child_value (specific, 0));
        break;
      default:
        GST_WARNING (&quot;Unexpected discoverer info type %d&quot;, type);
        goto out;
    }
  
<span class="line-modified">!   _parse_common_stream_info (sinfo, g_variant_get_child_value (common, 0));</span>
  
<span class="line-modified">!   info-&gt;stream_list = g_list_append (info-&gt;stream_list, sinfo);</span>
  
    if (!info-&gt;stream_info) {
      info-&gt;stream_info = sinfo;
    }
  
<span class="line-new-header">--- 2352,23 ---</span>
      case &#39;s&#39;:
        sinfo = g_object_new (GST_TYPE_DISCOVERER_SUBTITLE_INFO, NULL);
        _parse_subtitle_stream_info (GST_DISCOVERER_SUBTITLE_INFO (sinfo),
            g_variant_get_child_value (specific, 0));
        break;
<span class="line-added">+     case &#39;n&#39;:</span>
<span class="line-added">+       sinfo = g_object_new (GST_TYPE_DISCOVERER_STREAM_INFO, NULL);</span>
<span class="line-added">+       break;</span>
      default:
        GST_WARNING (&quot;Unexpected discoverer info type %d&quot;, type);
        goto out;
    }
  
<span class="line-modified">!   _parse_common_stream_info (sinfo, g_variant_get_child_value (common, 0),</span>
<span class="line-added">+       info);</span>
  
<span class="line-modified">!   if (!GST_IS_DISCOVERER_CONTAINER_INFO (sinfo))</span>
<span class="line-added">+     info-&gt;stream_list = g_list_append (info-&gt;stream_list, sinfo);</span>
  
    if (!info-&gt;stream_info) {
      info-&gt;stream_info = sinfo;
    }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2186,12 ***</span>
      ctx = g_main_context_default ();
  
    source = gst_bus_create_watch (discoverer-&gt;priv-&gt;bus);
    g_source_set_callback (source, (GSourceFunc) gst_bus_async_signal_func,
        NULL, NULL);
<span class="line-modified">!   discoverer-&gt;priv-&gt;sourceid = g_source_attach (source, ctx);</span>
<span class="line-modified">!   g_source_unref (source);</span>
    discoverer-&gt;priv-&gt;ctx = g_main_context_ref (ctx);
  
    start_discovering (discoverer);
    GST_DEBUG_OBJECT (discoverer, &quot;Started&quot;);
  }
<span class="line-new-header">--- 2431,12 ---</span>
      ctx = g_main_context_default ();
  
    source = gst_bus_create_watch (discoverer-&gt;priv-&gt;bus);
    g_source_set_callback (source, (GSourceFunc) gst_bus_async_signal_func,
        NULL, NULL);
<span class="line-modified">!   g_source_attach (source, ctx);</span>
<span class="line-modified">!   discoverer-&gt;priv-&gt;bus_source = source;</span>
    discoverer-&gt;priv-&gt;ctx = g_main_context_ref (ctx);
  
    start_discovering (discoverer);
    GST_DEBUG_OBJECT (discoverer, &quot;Started&quot;);
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2229,18 ***</span>
    }
    discoverer-&gt;priv-&gt;running = FALSE;
    DISCO_UNLOCK (discoverer);
  
    /* Remove timeout handler */
<span class="line-modified">!   if (discoverer-&gt;priv-&gt;timeoutid) {</span>
<span class="line-modified">!     g_source_remove (discoverer-&gt;priv-&gt;timeoutid);</span>
<span class="line-modified">!     discoverer-&gt;priv-&gt;timeoutid = 0;</span>
    }
    /* Remove signal watch */
<span class="line-modified">!   if (discoverer-&gt;priv-&gt;sourceid) {</span>
<span class="line-modified">!     g_source_remove (discoverer-&gt;priv-&gt;sourceid);</span>
<span class="line-modified">!     discoverer-&gt;priv-&gt;sourceid = 0;</span>
    }
    /* Unref main context */
    if (discoverer-&gt;priv-&gt;ctx) {
      g_main_context_unref (discoverer-&gt;priv-&gt;ctx);
      discoverer-&gt;priv-&gt;ctx = NULL;
<span class="line-new-header">--- 2474,20 ---</span>
    }
    discoverer-&gt;priv-&gt;running = FALSE;
    DISCO_UNLOCK (discoverer);
  
    /* Remove timeout handler */
<span class="line-modified">!   if (discoverer-&gt;priv-&gt;timeout_source) {</span>
<span class="line-modified">!     g_source_destroy (discoverer-&gt;priv-&gt;timeout_source);</span>
<span class="line-modified">!     g_source_unref (discoverer-&gt;priv-&gt;timeout_source);</span>
<span class="line-added">+     discoverer-&gt;priv-&gt;timeout_source = NULL;</span>
    }
    /* Remove signal watch */
<span class="line-modified">!   if (discoverer-&gt;priv-&gt;bus_source) {</span>
<span class="line-modified">!     g_source_destroy (discoverer-&gt;priv-&gt;bus_source);</span>
<span class="line-modified">!     g_source_unref (discoverer-&gt;priv-&gt;bus_source);</span>
<span class="line-added">+     discoverer-&gt;priv-&gt;bus_source = NULL;</span>
    }
    /* Unref main context */
    if (discoverer-&gt;priv-&gt;ctx) {
      g_main_context_unref (discoverer-&gt;priv-&gt;ctx);
      discoverer-&gt;priv-&gt;ctx = NULL;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2402,22 ***</span>
  gst_discoverer_info_to_variant (GstDiscovererInfo * info,
      GstDiscovererSerializeFlags flags)
  {
    /* FIXME: implement TOC support */
    GVariant *stream_variant;
<span class="line-modified">!   GVariant *variant;</span>
    GstDiscovererStreamInfo *sinfo;
    GVariant *wrapper;
  
    g_return_val_if_fail (GST_IS_DISCOVERER_INFO (info), NULL);
    g_return_val_if_fail (gst_discoverer_info_get_result (info) ==
        GST_DISCOVERER_OK, NULL);
  
    sinfo = gst_discoverer_info_get_stream_info (info);
    stream_variant = gst_discoverer_info_to_variant_recurse (sinfo, flags);
<span class="line-modified">!   variant =</span>
<span class="line-modified">!       g_variant_new (&quot;(vv)&quot;, _serialize_info (info, flags), stream_variant);</span>
  
    /* Returning a wrapper implies some small overhead, but simplifies
     * deserializing from bytes */
    wrapper = g_variant_new_variant (variant);
  
<span class="line-new-header">--- 2649,23 ---</span>
  gst_discoverer_info_to_variant (GstDiscovererInfo * info,
      GstDiscovererSerializeFlags flags)
  {
    /* FIXME: implement TOC support */
    GVariant *stream_variant;
<span class="line-modified">!   GVariant *variant, *info_variant;</span>
    GstDiscovererStreamInfo *sinfo;
    GVariant *wrapper;
  
    g_return_val_if_fail (GST_IS_DISCOVERER_INFO (info), NULL);
    g_return_val_if_fail (gst_discoverer_info_get_result (info) ==
        GST_DISCOVERER_OK, NULL);
  
    sinfo = gst_discoverer_info_get_stream_info (info);
    stream_variant = gst_discoverer_info_to_variant_recurse (sinfo, flags);
<span class="line-modified">!   info_variant = _serialize_info (info, flags);</span>
<span class="line-modified">! </span>
<span class="line-added">+   variant = g_variant_new (&quot;(vv)&quot;, info_variant, stream_variant);</span>
  
    /* Returning a wrapper implies some small overhead, but simplifies
     * deserializing from bytes */
    wrapper = g_variant_new_variant (variant);
  
</pre>
<center><a href="gstdiscoverer-types.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="gstdiscoverer.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>