<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.media/src/main/native/gstreamer/3rd_party/glib/glib/gstrfuncs.c</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /* GLIB - Library of useful routines for C programming
   2  * Copyright (C) 1995-1997  Peter Mattis, Spencer Kimball and Josh MacDonald
   3  *
   4  * This library is free software; you can redistribute it and/or
   5  * modify it under the terms of the GNU Lesser General Public
   6  * License as published by the Free Software Foundation; either
   7  * version 2.1 of the License, or (at your option) any later version.
   8  *
   9  * This library is distributed in the hope that it will be useful,
  10  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  11  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
  12  * Lesser General Public License for more details.
  13  *
  14  * You should have received a copy of the GNU Lesser General Public
  15  * License along with this library; if not, see &lt;http://www.gnu.org/licenses/&gt;.
  16  */
  17 
  18 /*
  19  * Modified by the GLib Team and others 1997-2000.  See the AUTHORS
  20  * file for a list of people on the GLib Team.  See the ChangeLog
  21  * files for a list of changes.  These files are distributed with
  22  * GLib at ftp://ftp.gtk.org/pub/gtk/.
  23  */
  24 
  25 /*
  26  * MT safe
  27  */
  28 
  29 #include &quot;config.h&quot;
  30 
  31 #include &lt;stdarg.h&gt;
  32 #include &lt;stdio.h&gt;
  33 #include &lt;stdlib.h&gt;
  34 #include &lt;locale.h&gt;
  35 #include &lt;string.h&gt;
  36 #include &lt;locale.h&gt;
  37 #include &lt;errno.h&gt;
  38 #include &lt;ctype.h&gt;              /* For tolower() */
  39 
  40 #ifdef HAVE_XLOCALE_H
  41 /* Needed on BSD/OS X for e.g. strtod_l */
  42 #include &lt;xlocale.h&gt;
  43 #endif
  44 
  45 #ifdef G_OS_WIN32
  46 #include &lt;windows.h&gt;
  47 #endif
  48 
  49 /* do not include &lt;unistd.h&gt; here, it may interfere with g_strsignal() */
  50 
  51 #include &quot;gstrfuncs.h&quot;
  52 
  53 #include &quot;gprintf.h&quot;
  54 #include &quot;gprintfint.h&quot;
  55 #include &quot;glibintl.h&quot;
  56 
  57 
  58 /**
  59  * SECTION:string_utils
  60  * @title: String Utility Functions
  61  * @short_description: various string-related functions
  62  *
  63  * This section describes a number of utility functions for creating,
  64  * duplicating, and manipulating strings.
  65  *
  66  * Note that the functions g_printf(), g_fprintf(), g_sprintf(),
  67  * g_vprintf(), g_vfprintf(), g_vsprintf() and g_vasprintf()
  68  * are declared in the header `gprintf.h` which is not included in `glib.h`
  69  * (otherwise using `glib.h` would drag in `stdio.h`), so you&#39;ll have to
  70  * explicitly include `&lt;glib/gprintf.h&gt;` in order to use the GLib
  71  * printf() functions.
  72  *
  73  * ## String precision pitfalls # {#string-precision}
  74  *
  75  * While you may use the printf() functions to format UTF-8 strings,
  76  * notice that the precision of a \%Ns parameter is interpreted
  77  * as the number of bytes, not characters to print. On top of that,
  78  * the GNU libc implementation of the printf() functions has the
  79  * &quot;feature&quot; that it checks that the string given for the \%Ns
  80  * parameter consists of a whole number of characters in the current
  81  * encoding. So, unless you are sure you are always going to be in an
  82  * UTF-8 locale or your know your text is restricted to ASCII, avoid
  83  * using \%Ns. If your intention is to format strings for a
  84  * certain number of columns, then \%Ns is not a correct solution
  85  * anyway, since it fails to take wide characters (see g_unichar_iswide())
  86  * into account.
  87  *
  88  * Note also that there are various printf() parameters which are platform
  89  * dependent. GLib provides platform independent macros for these parameters
  90  * which should be used instead. A common example is %G_GUINT64_FORMAT, which
  91  * should be used instead of `%llu` or similar parameters for formatting
  92  * 64-bit integers. These macros are all named `G_*_FORMAT`; see
  93  * [Basic Types][glib-Basic-Types].
  94  */
  95 
  96 /**
  97  * g_ascii_isalnum:
  98  * @c: any character
  99  *
 100  * Determines whether a character is alphanumeric.
 101  *
 102  * Unlike the standard C library isalnum() function, this only
 103  * recognizes standard ASCII letters and ignores the locale,
 104  * returning %FALSE for all non-ASCII characters. Also, unlike
 105  * the standard library function, this takes a char, not an int,
 106  * so don&#39;t call it on %EOF, but no need to cast to #guchar before
 107  * passing a possibly non-ASCII character in.
 108  *
 109  * Returns: %TRUE if @c is an ASCII alphanumeric character
 110  */
 111 
 112 /**
 113  * g_ascii_isalpha:
 114  * @c: any character
 115  *
 116  * Determines whether a character is alphabetic (i.e. a letter).
 117  *
 118  * Unlike the standard C library isalpha() function, this only
 119  * recognizes standard ASCII letters and ignores the locale,
 120  * returning %FALSE for all non-ASCII characters. Also, unlike
 121  * the standard library function, this takes a char, not an int,
 122  * so don&#39;t call it on %EOF, but no need to cast to #guchar before
 123  * passing a possibly non-ASCII character in.
 124  *
 125  * Returns: %TRUE if @c is an ASCII alphabetic character
 126  */
 127 
 128 /**
 129  * g_ascii_iscntrl:
 130  * @c: any character
 131  *
 132  * Determines whether a character is a control character.
 133  *
 134  * Unlike the standard C library iscntrl() function, this only
 135  * recognizes standard ASCII control characters and ignores the
 136  * locale, returning %FALSE for all non-ASCII characters. Also,
 137  * unlike the standard library function, this takes a char, not
 138  * an int, so don&#39;t call it on %EOF, but no need to cast to #guchar
 139  * before passing a possibly non-ASCII character in.
 140  *
 141  * Returns: %TRUE if @c is an ASCII control character.
 142  */
 143 
 144 /**
 145  * g_ascii_isdigit:
 146  * @c: any character
 147  *
 148  * Determines whether a character is digit (0-9).
 149  *
 150  * Unlike the standard C library isdigit() function, this takes
 151  * a char, not an int, so don&#39;t call it  on %EOF, but no need to
 152  * cast to #guchar before passing a possibly non-ASCII character in.
 153  *
 154  * Returns: %TRUE if @c is an ASCII digit.
 155  */
 156 
 157 /**
 158  * g_ascii_isgraph:
 159  * @c: any character
 160  *
 161  * Determines whether a character is a printing character and not a space.
 162  *
 163  * Unlike the standard C library isgraph() function, this only
 164  * recognizes standard ASCII characters and ignores the locale,
 165  * returning %FALSE for all non-ASCII characters. Also, unlike
 166  * the standard library function, this takes a char, not an int,
 167  * so don&#39;t call it on %EOF, but no need to cast to #guchar before
 168  * passing a possibly non-ASCII character in.
 169  *
 170  * Returns: %TRUE if @c is an ASCII printing character other than space.
 171  */
 172 
 173 /**
 174  * g_ascii_islower:
 175  * @c: any character
 176  *
 177  * Determines whether a character is an ASCII lower case letter.
 178  *
 179  * Unlike the standard C library islower() function, this only
 180  * recognizes standard ASCII letters and ignores the locale,
 181  * returning %FALSE for all non-ASCII characters. Also, unlike
 182  * the standard library function, this takes a char, not an int,
 183  * so don&#39;t call it on %EOF, but no need to worry about casting
 184  * to #guchar before passing a possibly non-ASCII character in.
 185  *
 186  * Returns: %TRUE if @c is an ASCII lower case letter
 187  */
 188 
 189 /**
 190  * g_ascii_isprint:
 191  * @c: any character
 192  *
 193  * Determines whether a character is a printing character.
 194  *
 195  * Unlike the standard C library isprint() function, this only
 196  * recognizes standard ASCII characters and ignores the locale,
 197  * returning %FALSE for all non-ASCII characters. Also, unlike
 198  * the standard library function, this takes a char, not an int,
 199  * so don&#39;t call it on %EOF, but no need to cast to #guchar before
 200  * passing a possibly non-ASCII character in.
 201  *
 202  * Returns: %TRUE if @c is an ASCII printing character.
 203  */
 204 
 205 /**
 206  * g_ascii_ispunct:
 207  * @c: any character
 208  *
 209  * Determines whether a character is a punctuation character.
 210  *
 211  * Unlike the standard C library ispunct() function, this only
 212  * recognizes standard ASCII letters and ignores the locale,
 213  * returning %FALSE for all non-ASCII characters. Also, unlike
 214  * the standard library function, this takes a char, not an int,
 215  * so don&#39;t call it on %EOF, but no need to cast to #guchar before
 216  * passing a possibly non-ASCII character in.
 217  *
 218  * Returns: %TRUE if @c is an ASCII punctuation character.
 219  */
 220 
 221 /**
 222  * g_ascii_isspace:
 223  * @c: any character
 224  *
 225  * Determines whether a character is a white-space character.
 226  *
 227  * Unlike the standard C library isspace() function, this only
 228  * recognizes standard ASCII white-space and ignores the locale,
 229  * returning %FALSE for all non-ASCII characters. Also, unlike
 230  * the standard library function, this takes a char, not an int,
 231  * so don&#39;t call it on %EOF, but no need to cast to #guchar before
 232  * passing a possibly non-ASCII character in.
 233  *
 234  * Returns: %TRUE if @c is an ASCII white-space character
 235  */
 236 
 237 /**
 238  * g_ascii_isupper:
 239  * @c: any character
 240  *
 241  * Determines whether a character is an ASCII upper case letter.
 242  *
 243  * Unlike the standard C library isupper() function, this only
 244  * recognizes standard ASCII letters and ignores the locale,
 245  * returning %FALSE for all non-ASCII characters. Also, unlike
 246  * the standard library function, this takes a char, not an int,
 247  * so don&#39;t call it on %EOF, but no need to worry about casting
 248  * to #guchar before passing a possibly non-ASCII character in.
 249  *
 250  * Returns: %TRUE if @c is an ASCII upper case letter
 251  */
 252 
 253 /**
 254  * g_ascii_isxdigit:
 255  * @c: any character
 256  *
 257  * Determines whether a character is a hexadecimal-digit character.
 258  *
 259  * Unlike the standard C library isxdigit() function, this takes
 260  * a char, not an int, so don&#39;t call it on %EOF, but no need to
 261  * cast to #guchar before passing a possibly non-ASCII character in.
 262  *
 263  * Returns: %TRUE if @c is an ASCII hexadecimal-digit character.
 264  */
 265 
 266 /**
 267  * G_ASCII_DTOSTR_BUF_SIZE:
 268  *
 269  * A good size for a buffer to be passed into g_ascii_dtostr().
 270  * It is guaranteed to be enough for all output of that function
 271  * on systems with 64bit IEEE-compatible doubles.
 272  *
 273  * The typical usage would be something like:
 274  * |[&lt;!-- language=&quot;C&quot; --&gt;
 275  *   char buf[G_ASCII_DTOSTR_BUF_SIZE];
 276  *
 277  *   fprintf (out, &quot;value=%s\n&quot;, g_ascii_dtostr (buf, sizeof (buf), value));
 278  * ]|
 279  */
 280 
 281 /**
 282  * g_strstrip:
 283  * @string: a string to remove the leading and trailing whitespace from
 284  *
 285  * Removes leading and trailing whitespace from a string.
 286  * See g_strchomp() and g_strchug().
 287  *
 288  * Returns: @string
 289  */
 290 
 291 /**
 292  * G_STR_DELIMITERS:
 293  *
 294  * The standard delimiters, used in g_strdelimit().
 295  */
 296 
 297 static const guint16 ascii_table_data[256] = {
 298   0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004,
 299   0x004, 0x104, 0x104, 0x004, 0x104, 0x104, 0x004, 0x004,
 300   0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004,
 301   0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004, 0x004,
 302   0x140, 0x0d0, 0x0d0, 0x0d0, 0x0d0, 0x0d0, 0x0d0, 0x0d0,
 303   0x0d0, 0x0d0, 0x0d0, 0x0d0, 0x0d0, 0x0d0, 0x0d0, 0x0d0,
 304   0x459, 0x459, 0x459, 0x459, 0x459, 0x459, 0x459, 0x459,
 305   0x459, 0x459, 0x0d0, 0x0d0, 0x0d0, 0x0d0, 0x0d0, 0x0d0,
 306   0x0d0, 0x653, 0x653, 0x653, 0x653, 0x653, 0x653, 0x253,
 307   0x253, 0x253, 0x253, 0x253, 0x253, 0x253, 0x253, 0x253,
 308   0x253, 0x253, 0x253, 0x253, 0x253, 0x253, 0x253, 0x253,
 309   0x253, 0x253, 0x253, 0x0d0, 0x0d0, 0x0d0, 0x0d0, 0x0d0,
 310   0x0d0, 0x473, 0x473, 0x473, 0x473, 0x473, 0x473, 0x073,
 311   0x073, 0x073, 0x073, 0x073, 0x073, 0x073, 0x073, 0x073,
 312   0x073, 0x073, 0x073, 0x073, 0x073, 0x073, 0x073, 0x073,
 313   0x073, 0x073, 0x073, 0x0d0, 0x0d0, 0x0d0, 0x0d0, 0x004
 314   /* the upper 128 are all zeroes */
 315 };
 316 
 317 const guint16 * const g_ascii_table = ascii_table_data;
 318 
 319 #if defined (HAVE_NEWLOCALE) &amp;&amp; \
 320     defined (HAVE_USELOCALE) &amp;&amp; \
 321     defined (HAVE_STRTOD_L) &amp;&amp; \
 322     defined (HAVE_STRTOULL_L) &amp;&amp; \
 323     defined (HAVE_STRTOLL_L)
 324 #define USE_XLOCALE 1
 325 #endif
 326 
 327 #ifdef USE_XLOCALE
 328 static locale_t
 329 get_C_locale (void)
 330 {
 331   static gsize initialized = FALSE;
 332   static locale_t C_locale = NULL;
 333 
 334   if (g_once_init_enter (&amp;initialized))
 335     {
 336       C_locale = newlocale (LC_ALL_MASK, &quot;C&quot;, NULL);
 337       g_once_init_leave (&amp;initialized, TRUE);
 338     }
 339 
 340   return C_locale;
 341 }
 342 #endif
 343 
 344 /**
 345  * g_strdup:
 346  * @str: (nullable): the string to duplicate
 347  *
 348  * Duplicates a string. If @str is %NULL it returns %NULL.
 349  * The returned string should be freed with g_free()
 350  * when no longer needed.
 351  *
 352  * Returns: a newly-allocated copy of @str
 353  */
 354 gchar*
 355 g_strdup (const gchar *str)
 356 {
 357   gchar *new_str;
 358   gsize length;
 359 
 360   if (str)
 361     {
 362       length = strlen (str) + 1;
 363       new_str = g_new (char, length);
 364       memcpy (new_str, str, length);
 365     }
 366   else
 367     new_str = NULL;
 368 
 369   return new_str;
 370 }
 371 
 372 /**
 373  * g_memdup:
 374  * @mem: the memory to copy.
 375  * @byte_size: the number of bytes to copy.
 376  *
 377  * Allocates @byte_size bytes of memory, and copies @byte_size bytes into it
 378  * from @mem. If @mem is %NULL it returns %NULL.
 379  *
 380  * Returns: a pointer to the newly-allocated copy of the memory, or %NULL if @mem
 381  *  is %NULL.
 382  */
 383 gpointer
 384 g_memdup (gconstpointer mem,
 385           guint         byte_size)
 386 {
 387   gpointer new_mem;
 388 
 389   if (mem &amp;&amp; byte_size != 0)
 390     {
 391       new_mem = g_malloc (byte_size);
 392       memcpy (new_mem, mem, byte_size);
 393     }
 394   else
 395     new_mem = NULL;
 396 
 397   return new_mem;
 398 }
 399 
 400 /**
 401  * g_strndup:
 402  * @str: the string to duplicate
 403  * @n: the maximum number of bytes to copy from @str
 404  *
 405  * Duplicates the first @n bytes of a string, returning a newly-allocated
 406  * buffer @n + 1 bytes long which will always be nul-terminated. If @str
 407  * is less than @n bytes long the buffer is padded with nuls. If @str is
 408  * %NULL it returns %NULL. The returned value should be freed when no longer
 409  * needed.
 410  *
 411  * To copy a number of characters from a UTF-8 encoded string,
 412  * use g_utf8_strncpy() instead.
 413  *
 414  * Returns: a newly-allocated buffer containing the first @n bytes
 415  *     of @str, nul-terminated
 416  */
 417 gchar*
 418 g_strndup (const gchar *str,
 419            gsize        n)
 420 {
 421   gchar *new_str;
 422 
 423   if (str)
 424     {
 425       new_str = g_new (gchar, n + 1);
 426       strncpy (new_str, str, n);
 427       new_str[n] = &#39;\0&#39;;
 428     }
 429   else
 430     new_str = NULL;
 431 
 432   return new_str;
 433 }
 434 
 435 /**
 436  * g_strnfill:
 437  * @length: the length of the new string
 438  * @fill_char: the byte to fill the string with
 439  *
 440  * Creates a new string @length bytes long filled with @fill_char.
 441  * The returned string should be freed when no longer needed.
 442  *
 443  * Returns: a newly-allocated string filled the @fill_char
 444  */
 445 gchar*
 446 g_strnfill (gsize length,
 447             gchar fill_char)
 448 {
 449   gchar *str;
 450 
 451   str = g_new (gchar, length + 1);
 452   memset (str, (guchar)fill_char, length);
 453   str[length] = &#39;\0&#39;;
 454 
 455   return str;
 456 }
 457 
 458 /**
 459  * g_stpcpy:
 460  * @dest: destination buffer.
 461  * @src: source string.
 462  *
 463  * Copies a nul-terminated string into the dest buffer, include the
 464  * trailing nul, and return a pointer to the trailing nul byte.
 465  * This is useful for concatenating multiple strings together
 466  * without having to repeatedly scan for the end.
 467  *
 468  * Returns: a pointer to trailing nul byte.
 469  **/
 470 gchar *
 471 g_stpcpy (gchar       *dest,
 472           const gchar *src)
 473 {
 474 #ifdef HAVE_STPCPY
 475   g_return_val_if_fail (dest != NULL, NULL);
 476   g_return_val_if_fail (src != NULL, NULL);
 477   return stpcpy (dest, src);
 478 #else
 479   gchar *d = dest;
 480   const gchar *s = src;
 481 
 482   g_return_val_if_fail (dest != NULL, NULL);
 483   g_return_val_if_fail (src != NULL, NULL);
 484   do
 485     *d++ = *s;
 486   while (*s++ != &#39;\0&#39;);
 487 
 488   return d - 1;
 489 #endif
 490 }
 491 
 492 /**
 493  * g_strdup_vprintf:
 494  * @format: a standard printf() format string, but notice
 495  *     [string precision pitfalls][string-precision]
 496  * @args: the list of parameters to insert into the format string
 497  *
 498  * Similar to the standard C vsprintf() function but safer, since it
 499  * calculates the maximum space required and allocates memory to hold
 500  * the result. The returned string should be freed with g_free() when
 501  * no longer needed.
 502  *
 503  * See also g_vasprintf(), which offers the same functionality, but
 504  * additionally returns the length of the allocated string.
 505  *
 506  * Returns: a newly-allocated string holding the result
 507  */
 508 gchar*
 509 g_strdup_vprintf (const gchar *format,
 510                   va_list      args)
 511 {
 512   gchar *string = NULL;
 513 
 514   g_vasprintf (&amp;string, format, args);
 515 
 516   return string;
 517 }
 518 
 519 /**
 520  * g_strdup_printf:
 521  * @format: a standard printf() format string, but notice
 522  *     [string precision pitfalls][string-precision]
 523  * @...: the parameters to insert into the format string
 524  *
 525  * Similar to the standard C sprintf() function but safer, since it
 526  * calculates the maximum space required and allocates memory to hold
 527  * the result. The returned string should be freed with g_free() when no
 528  * longer needed.
 529  *
 530  * Returns: a newly-allocated string holding the result
 531  */
 532 gchar*
 533 g_strdup_printf (const gchar *format,
 534                  ...)
 535 {
 536   gchar *buffer;
 537   va_list args;
 538 
 539   va_start (args, format);
 540   buffer = g_strdup_vprintf (format, args);
 541   va_end (args);
 542 
 543   return buffer;
 544 }
 545 
 546 /**
 547  * g_strconcat:
 548  * @string1: the first string to add, which must not be %NULL
 549  * @...: a %NULL-terminated list of strings to append to the string
 550  *
 551  * Concatenates all of the given strings into one long string. The
 552  * returned string should be freed with g_free() when no longer needed.
 553  *
 554  * The variable argument list must end with %NULL. If you forget the %NULL,
 555  * g_strconcat() will start appending random memory junk to your string.
 556  *
 557  * Note that this function is usually not the right function to use to
 558  * assemble a translated message from pieces, since proper translation
 559  * often requires the pieces to be reordered.
 560  *
 561  * Returns: a newly-allocated string containing all the string arguments
 562  */
 563 gchar*
 564 g_strconcat (const gchar *string1, ...)
 565 {
 566   gsize   l;
 567   va_list args;
 568   gchar   *s;
 569   gchar   *concat;
 570   gchar   *ptr;
 571 
 572   if (!string1)
 573     return NULL;
 574 
 575   l = 1 + strlen (string1);
 576   va_start (args, string1);
 577   s = va_arg (args, gchar*);
 578   while (s)
 579     {
 580       l += strlen (s);
 581       s = va_arg (args, gchar*);
 582     }
 583   va_end (args);
 584 
 585   concat = g_new (gchar, l);
 586   ptr = concat;
 587 
 588   ptr = g_stpcpy (ptr, string1);
 589   va_start (args, string1);
 590   s = va_arg (args, gchar*);
 591   while (s)
 592     {
 593       ptr = g_stpcpy (ptr, s);
 594       s = va_arg (args, gchar*);
 595     }
 596   va_end (args);
 597 
 598   return concat;
 599 }
 600 
 601 /**
 602  * g_strtod:
 603  * @nptr:    the string to convert to a numeric value.
 604  * @endptr:  (out) (transfer none) (optional): if non-%NULL, it returns the
 605  *           character after the last character used in the conversion.
 606  *
 607  * Converts a string to a #gdouble value.
 608  * It calls the standard strtod() function to handle the conversion, but
 609  * if the string is not completely converted it attempts the conversion
 610  * again with g_ascii_strtod(), and returns the best match.
 611  *
 612  * This function should seldom be used. The normal situation when reading
 613  * numbers not for human consumption is to use g_ascii_strtod(). Only when
 614  * you know that you must expect both locale formatted and C formatted numbers
 615  * should you use this. Make sure that you don&#39;t pass strings such as comma
 616  * separated lists of values, since the commas may be interpreted as a decimal
 617  * point in some locales, causing unexpected results.
 618  *
 619  * Returns: the #gdouble value.
 620  **/
 621 gdouble
 622 g_strtod (const gchar *nptr,
 623           gchar      **endptr)
 624 {
 625   gchar *fail_pos_1;
 626   gchar *fail_pos_2;
 627   gdouble val_1;
 628   gdouble val_2 = 0;
 629 
 630   g_return_val_if_fail (nptr != NULL, 0);
 631 
 632   fail_pos_1 = NULL;
 633   fail_pos_2 = NULL;
 634 
 635   val_1 = strtod (nptr, &amp;fail_pos_1);
 636 
 637   if (fail_pos_1 &amp;&amp; fail_pos_1[0] != 0)
 638     val_2 = g_ascii_strtod (nptr, &amp;fail_pos_2);
 639 
 640   if (!fail_pos_1 || fail_pos_1[0] == 0 || fail_pos_1 &gt;= fail_pos_2)
 641     {
 642       if (endptr)
 643         *endptr = fail_pos_1;
 644       return val_1;
 645     }
 646   else
 647     {
 648       if (endptr)
 649         *endptr = fail_pos_2;
 650       return val_2;
 651     }
 652 }
 653 
 654 /**
 655  * g_ascii_strtod:
 656  * @nptr:    the string to convert to a numeric value.
 657  * @endptr:  (out) (transfer none) (optional): if non-%NULL, it returns the
 658  *           character after the last character used in the conversion.
 659  *
 660  * Converts a string to a #gdouble value.
 661  *
 662  * This function behaves like the standard strtod() function
 663  * does in the C locale. It does this without actually changing
 664  * the current locale, since that would not be thread-safe.
 665  * A limitation of the implementation is that this function
 666  * will still accept localized versions of infinities and NANs.
 667  *
 668  * This function is typically used when reading configuration
 669  * files or other non-user input that should be locale independent.
 670  * To handle input from the user you should normally use the
 671  * locale-sensitive system strtod() function.
 672  *
 673  * To convert from a #gdouble to a string in a locale-insensitive
 674  * way, use g_ascii_dtostr().
 675  *
 676  * If the correct value would cause overflow, plus or minus %HUGE_VAL
 677  * is returned (according to the sign of the value), and %ERANGE is
 678  * stored in %errno. If the correct value would cause underflow,
 679  * zero is returned and %ERANGE is stored in %errno.
 680  *
 681  * This function resets %errno before calling strtod() so that
 682  * you can reliably detect overflow and underflow.
 683  *
 684  * Returns: the #gdouble value.
 685  */
 686 gdouble
 687 g_ascii_strtod (const gchar *nptr,
 688                 gchar      **endptr)
 689 {
 690 #ifdef USE_XLOCALE
 691 
 692   g_return_val_if_fail (nptr != NULL, 0);
 693 
 694   errno = 0;
 695 
 696   return strtod_l (nptr, endptr, get_C_locale ());
 697 
 698 #else
 699 
 700   gchar *fail_pos;
 701   gdouble val;
 702 #ifndef __BIONIC__
 703   struct lconv *locale_data;
 704 #endif
 705   const char *decimal_point;
 706   gsize decimal_point_len;
 707   const char *p, *decimal_point_pos;
 708   const char *end = NULL; /* Silence gcc */
 709   int strtod_errno;
 710 
 711   g_return_val_if_fail (nptr != NULL, 0);
 712 
 713   fail_pos = NULL;
 714 
 715 #ifndef __BIONIC__
 716   locale_data = localeconv ();
 717   decimal_point = locale_data-&gt;decimal_point;
 718   decimal_point_len = strlen (decimal_point);
 719 #else
 720   decimal_point = &quot;.&quot;;
 721   decimal_point_len = 1;
 722 #endif
 723 
 724   g_assert (decimal_point_len != 0);
 725 
 726   decimal_point_pos = NULL;
 727   end = NULL;
 728 
 729   if (decimal_point[0] != &#39;.&#39; ||
 730       decimal_point[1] != 0)
 731     {
 732       p = nptr;
 733       /* Skip leading space */
 734       while (g_ascii_isspace (*p))
 735         p++;
 736 
 737       /* Skip leading optional sign */
 738       if (*p == &#39;+&#39; || *p == &#39;-&#39;)
 739         p++;
 740 
 741       if (p[0] == &#39;0&#39; &amp;&amp;
 742           (p[1] == &#39;x&#39; || p[1] == &#39;X&#39;))
 743         {
 744           p += 2;
 745           /* HEX - find the (optional) decimal point */
 746 
 747           while (g_ascii_isxdigit (*p))
 748             p++;
 749 
 750           if (*p == &#39;.&#39;)
 751             decimal_point_pos = p++;
 752 
 753           while (g_ascii_isxdigit (*p))
 754             p++;
 755 
 756           if (*p == &#39;p&#39; || *p == &#39;P&#39;)
 757             p++;
 758           if (*p == &#39;+&#39; || *p == &#39;-&#39;)
 759             p++;
 760           while (g_ascii_isdigit (*p))
 761             p++;
 762 
 763           end = p;
 764         }
 765       else if (g_ascii_isdigit (*p) || *p == &#39;.&#39;)
 766         {
 767           while (g_ascii_isdigit (*p))
 768             p++;
 769 
 770           if (*p == &#39;.&#39;)
 771             decimal_point_pos = p++;
 772 
 773           while (g_ascii_isdigit (*p))
 774             p++;
 775 
 776           if (*p == &#39;e&#39; || *p == &#39;E&#39;)
 777             p++;
 778           if (*p == &#39;+&#39; || *p == &#39;-&#39;)
 779             p++;
 780           while (g_ascii_isdigit (*p))
 781             p++;
 782 
 783           end = p;
 784         }
 785       /* For the other cases, we need not convert the decimal point */
 786     }
 787 
 788   if (decimal_point_pos)
 789     {
 790       char *copy, *c;
 791 
 792       /* We need to convert the &#39;.&#39; to the locale specific decimal point */
 793       copy = g_malloc (end - nptr + 1 + decimal_point_len);
 794 #ifdef GSTREAMER_LITE
 795       if (copy == NULL)
 796           return 0;
 797 #endif // GSTREAMER_LITE
 798 
 799       c = copy;
 800       memcpy (c, nptr, decimal_point_pos - nptr);
 801       c += decimal_point_pos - nptr;
 802       memcpy (c, decimal_point, decimal_point_len);
 803       c += decimal_point_len;
 804       memcpy (c, decimal_point_pos + 1, end - (decimal_point_pos + 1));
 805       c += end - (decimal_point_pos + 1);
 806       *c = 0;
 807 
 808       errno = 0;
 809       val = strtod (copy, &amp;fail_pos);
 810       strtod_errno = errno;
 811 
 812       if (fail_pos)
 813         {
 814           if (fail_pos - copy &gt; decimal_point_pos - nptr)
 815             fail_pos = (char *)nptr + (fail_pos - copy) - (decimal_point_len - 1);
 816           else
 817             fail_pos = (char *)nptr + (fail_pos - copy);
 818         }
 819 
 820       g_free (copy);
 821 
 822     }
 823   else if (end)
 824     {
 825       char *copy;
 826 
 827       copy = g_malloc (end - (char *)nptr + 1);
 828 #ifdef GSTREAMER_LITE
 829       if (copy == NULL)
 830         return 0;
 831 #endif
 832       memcpy (copy, nptr, end - nptr);
 833       *(copy + (end - (char *)nptr)) = 0;
 834 
 835       errno = 0;
 836       val = strtod (copy, &amp;fail_pos);
 837       strtod_errno = errno;
 838 
 839       if (fail_pos)
 840         {
 841           fail_pos = (char *)nptr + (fail_pos - copy);
 842         }
 843 
 844       g_free (copy);
 845     }
 846   else
 847     {
 848       errno = 0;
 849       val = strtod (nptr, &amp;fail_pos);
 850       strtod_errno = errno;
 851     }
 852 
 853   if (endptr)
 854     *endptr = fail_pos;
 855 
 856   errno = strtod_errno;
 857 
 858   return val;
 859 #endif
 860 }
 861 
 862 
 863 /**
 864  * g_ascii_dtostr:
 865  * @buffer: A buffer to place the resulting string in
 866  * @buf_len: The length of the buffer.
 867  * @d: The #gdouble to convert
 868  *
 869  * Converts a #gdouble to a string, using the &#39;.&#39; as
 870  * decimal point.
 871  *
 872  * This function generates enough precision that converting
 873  * the string back using g_ascii_strtod() gives the same machine-number
 874  * (on machines with IEEE compatible 64bit doubles). It is
 875  * guaranteed that the size of the resulting string will never
 876  * be larger than @G_ASCII_DTOSTR_BUF_SIZE bytes, including the terminating
 877  * nul character, which is always added.
 878  *
 879  * Returns: The pointer to the buffer with the converted string.
 880  **/
 881 gchar *
 882 g_ascii_dtostr (gchar       *buffer,
 883                 gint         buf_len,
 884                 gdouble      d)
 885 {
 886   return g_ascii_formatd (buffer, buf_len, &quot;%.17g&quot;, d);
 887 }
 888 
 889 #ifdef GSTREAMER_LITE
 890 #ifndef G_OS_WIN32
 891 #pragma GCC diagnostic push
 892 #pragma GCC diagnostic ignored &quot;-Wformat-nonliteral&quot;
 893 #endif // G_OS_WIN32
 894 #else // GSTREAMER_LITE
 895 #pragma GCC diagnostic push
 896 #pragma GCC diagnostic ignored &quot;-Wformat-nonliteral&quot;
 897 #endif // GSTREAMER_LITE
 898 
 899 /**
 900  * g_ascii_formatd:
 901  * @buffer: A buffer to place the resulting string in
 902  * @buf_len: The length of the buffer.
 903  * @format: The printf()-style format to use for the
 904  *          code to use for converting.
 905  * @d: The #gdouble to convert
 906  *
 907  * Converts a #gdouble to a string, using the &#39;.&#39; as
 908  * decimal point. To format the number you pass in
 909  * a printf()-style format string. Allowed conversion
 910  * specifiers are &#39;e&#39;, &#39;E&#39;, &#39;f&#39;, &#39;F&#39;, &#39;g&#39; and &#39;G&#39;.
 911  *
 912  * The returned buffer is guaranteed to be nul-terminated.
 913  *
 914  * If you just want to want to serialize the value into a
 915  * string, use g_ascii_dtostr().
 916  *
 917  * Returns: The pointer to the buffer with the converted string.
 918  */
 919 gchar *
 920 g_ascii_formatd (gchar       *buffer,
 921                  gint         buf_len,
 922                  const gchar *format,
 923                  gdouble      d)
 924 {
 925 #ifdef USE_XLOCALE
 926   locale_t old_locale;
 927 
 928   old_locale = uselocale (get_C_locale ());
 929    _g_snprintf (buffer, buf_len, format, d);
 930   uselocale (old_locale);
 931 
 932   return buffer;
 933 #else
 934 #ifndef __BIONIC__
 935   struct lconv *locale_data;
 936 #endif
 937   const char *decimal_point;
 938   gsize decimal_point_len;
 939   gchar *p;
 940   int rest_len;
 941   gchar format_char;
 942 
 943   g_return_val_if_fail (buffer != NULL, NULL);
 944   g_return_val_if_fail (format[0] == &#39;%&#39;, NULL);
 945   g_return_val_if_fail (strpbrk (format + 1, &quot;&#39;l%&quot;) == NULL, NULL);
 946 
 947   format_char = format[strlen (format) - 1];
 948 
 949   g_return_val_if_fail (format_char == &#39;e&#39; || format_char == &#39;E&#39; ||
 950                         format_char == &#39;f&#39; || format_char == &#39;F&#39; ||
 951                         format_char == &#39;g&#39; || format_char == &#39;G&#39;,
 952                         NULL);
 953 
 954   if (format[0] != &#39;%&#39;)
 955     return NULL;
 956 
 957   if (strpbrk (format + 1, &quot;&#39;l%&quot;))
 958     return NULL;
 959 
 960   if (!(format_char == &#39;e&#39; || format_char == &#39;E&#39; ||
 961         format_char == &#39;f&#39; || format_char == &#39;F&#39; ||
 962         format_char == &#39;g&#39; || format_char == &#39;G&#39;))
 963     return NULL;
 964 
 965   _g_snprintf (buffer, buf_len, format, d);
 966 
 967 #ifndef __BIONIC__
 968   locale_data = localeconv ();
 969   decimal_point = locale_data-&gt;decimal_point;
 970   decimal_point_len = strlen (decimal_point);
 971 #else
 972   decimal_point = &quot;.&quot;;
 973   decimal_point_len = 1;
 974 #endif
 975 
 976   g_assert (decimal_point_len != 0);
 977 
 978   if (decimal_point[0] != &#39;.&#39; ||
 979       decimal_point[1] != 0)
 980     {
 981       p = buffer;
 982 
 983       while (g_ascii_isspace (*p))
 984         p++;
 985 
 986       if (*p == &#39;+&#39; || *p == &#39;-&#39;)
 987         p++;
 988 
 989       while (isdigit ((guchar)*p))
 990         p++;
 991 
 992       if (strncmp (p, decimal_point, decimal_point_len) == 0)
 993         {
 994           *p = &#39;.&#39;;
 995           p++;
 996           if (decimal_point_len &gt; 1)
 997             {
 998               rest_len = strlen (p + (decimal_point_len - 1));
 999               memmove (p, p + (decimal_point_len - 1), rest_len);
1000               p[rest_len] = 0;
1001             }
1002         }
1003     }
1004 
1005   return buffer;
1006 #endif
1007 }
1008 
1009 #ifdef GSTREAMER_LITE
1010 #ifndef G_OS_WIN32
1011 #pragma GCC diagnostic pop
1012 #endif // G_OS_WIN32
1013 #else // GSTREAMER_LITE
1014 #pragma GCC diagnostic pop
1015 #endif // GSTREAMER_LITE
1016 
1017 #define ISSPACE(c)              ((c) == &#39; &#39; || (c) == &#39;\f&#39; || (c) == &#39;\n&#39; || \
1018                                  (c) == &#39;\r&#39; || (c) == &#39;\t&#39; || (c) == &#39;\v&#39;)
1019 #define ISUPPER(c)              ((c) &gt;= &#39;A&#39; &amp;&amp; (c) &lt;= &#39;Z&#39;)
1020 #define ISLOWER(c)              ((c) &gt;= &#39;a&#39; &amp;&amp; (c) &lt;= &#39;z&#39;)
1021 #define ISALPHA(c)              (ISUPPER (c) || ISLOWER (c))
1022 #define TOUPPER(c)              (ISLOWER (c) ? (c) - &#39;a&#39; + &#39;A&#39; : (c))
1023 #define TOLOWER(c)              (ISUPPER (c) ? (c) - &#39;A&#39; + &#39;a&#39; : (c))
1024 
1025 #ifndef USE_XLOCALE
1026 
1027 static guint64
1028 g_parse_long_long (const gchar  *nptr,
1029                    const gchar **endptr,
1030                    guint         base,
1031                    gboolean     *negative)
1032 {
1033   /* this code is based on on the strtol(3) code from GNU libc released under
1034    * the GNU Lesser General Public License.
1035    *
1036    * Copyright (C) 1991,92,94,95,96,97,98,99,2000,01,02
1037    *        Free Software Foundation, Inc.
1038    */
1039   gboolean overflow;
1040   guint64 cutoff;
1041   guint64 cutlim;
1042   guint64 ui64;
1043   const gchar *s, *save;
1044   guchar c;
1045 
1046   g_return_val_if_fail (nptr != NULL, 0);
1047 
1048   *negative = FALSE;
1049   if (base == 1 || base &gt; 36)
1050     {
1051       errno = EINVAL;
1052       if (endptr)
1053         *endptr = nptr;
1054       return 0;
1055     }
1056 
1057   save = s = nptr;
1058 
1059   /* Skip white space.  */
1060   while (ISSPACE (*s))
1061     ++s;
1062 
1063   if (G_UNLIKELY (!*s))
1064     goto noconv;
1065 
1066   /* Check for a sign.  */
1067   if (*s == &#39;-&#39;)
1068     {
1069       *negative = TRUE;
1070       ++s;
1071     }
1072   else if (*s == &#39;+&#39;)
1073     ++s;
1074 
1075   /* Recognize number prefix and if BASE is zero, figure it out ourselves.  */
1076   if (*s == &#39;0&#39;)
1077     {
1078       if ((base == 0 || base == 16) &amp;&amp; TOUPPER (s[1]) == &#39;X&#39;)
1079         {
1080           s += 2;
1081           base = 16;
1082         }
1083       else if (base == 0)
1084         base = 8;
1085     }
1086   else if (base == 0)
1087     base = 10;
1088 
1089   /* Save the pointer so we can check later if anything happened.  */
1090   save = s;
1091   cutoff = G_MAXUINT64 / base;
1092   cutlim = G_MAXUINT64 % base;
1093 
1094   overflow = FALSE;
1095   ui64 = 0;
1096   c = *s;
1097   for (; c; c = *++s)
1098     {
1099       if (c &gt;= &#39;0&#39; &amp;&amp; c &lt;= &#39;9&#39;)
1100         c -= &#39;0&#39;;
1101       else if (ISALPHA (c))
1102         c = TOUPPER (c) - &#39;A&#39; + 10;
1103       else
1104         break;
1105       if (c &gt;= base)
1106         break;
1107       /* Check for overflow.  */
1108       if (ui64 &gt; cutoff || (ui64 == cutoff &amp;&amp; c &gt; cutlim))
1109         overflow = TRUE;
1110       else
1111         {
1112           ui64 *= base;
1113           ui64 += c;
1114         }
1115     }
1116 
1117   /* Check if anything actually happened.  */
1118   if (s == save)
1119     goto noconv;
1120 
1121   /* Store in ENDPTR the address of one character
1122      past the last character we converted.  */
1123   if (endptr)
1124     *endptr = s;
1125 
1126   if (G_UNLIKELY (overflow))
1127     {
1128       errno = ERANGE;
1129       return G_MAXUINT64;
1130     }
1131 
1132   return ui64;
1133 
1134  noconv:
1135   /* We must handle a special case here: the base is 0 or 16 and the
1136      first two characters are &#39;0&#39; and &#39;x&#39;, but the rest are no
1137      hexadecimal digits.  This is no error case.  We return 0 and
1138      ENDPTR points to the `x`.  */
1139   if (endptr)
1140     {
1141       if (save - nptr &gt;= 2 &amp;&amp; TOUPPER (save[-1]) == &#39;X&#39;
1142           &amp;&amp; save[-2] == &#39;0&#39;)
1143         *endptr = &amp;save[-1];
1144       else
1145         /*  There was no number to convert.  */
1146         *endptr = nptr;
1147     }
1148   return 0;
1149 }
1150 #endif /* !USE_XLOCALE */
1151 
1152 /**
1153  * g_ascii_strtoull:
1154  * @nptr:    the string to convert to a numeric value.
1155  * @endptr:  (out) (transfer none) (optional): if non-%NULL, it returns the
1156  *           character after the last character used in the conversion.
1157  * @base:    to be used for the conversion, 2..36 or 0
1158  *
1159  * Converts a string to a #guint64 value.
1160  * This function behaves like the standard strtoull() function
1161  * does in the C locale. It does this without actually
1162  * changing the current locale, since that would not be
1163  * thread-safe.
1164  *
<a name="1" id="anc1"></a>




1165  * This function is typically used when reading configuration
1166  * files or other non-user input that should be locale independent.
1167  * To handle input from the user you should normally use the
1168  * locale-sensitive system strtoull() function.
1169  *
1170  * If the correct value would cause overflow, %G_MAXUINT64
1171  * is returned, and `ERANGE` is stored in `errno`.
1172  * If the base is outside the valid range, zero is returned, and
1173  * `EINVAL` is stored in `errno`.
1174  * If the string conversion fails, zero is returned, and @endptr returns
1175  * @nptr (if @endptr is non-%NULL).
1176  *
1177  * Returns: the #guint64 value or zero on error.
1178  *
1179  * Since: 2.2
1180  */
1181 guint64
1182 g_ascii_strtoull (const gchar *nptr,
1183                   gchar      **endptr,
1184                   guint        base)
1185 {
1186 #ifdef USE_XLOCALE
1187   return strtoull_l (nptr, endptr, base, get_C_locale ());
1188 #else
1189   gboolean negative;
1190   guint64 result;
1191 
1192   result = g_parse_long_long (nptr, (const gchar **) endptr, base, &amp;negative);
1193 
1194   /* Return the result of the appropriate sign.  */
1195   return negative ? -result : result;
1196 #endif
1197 }
1198 
1199 /**
1200  * g_ascii_strtoll:
1201  * @nptr:    the string to convert to a numeric value.
1202  * @endptr:  (out) (transfer none) (optional): if non-%NULL, it returns the
1203  *           character after the last character used in the conversion.
1204  * @base:    to be used for the conversion, 2..36 or 0
1205  *
1206  * Converts a string to a #gint64 value.
1207  * This function behaves like the standard strtoll() function
1208  * does in the C locale. It does this without actually
1209  * changing the current locale, since that would not be
1210  * thread-safe.
1211  *
1212  * This function is typically used when reading configuration
1213  * files or other non-user input that should be locale independent.
1214  * To handle input from the user you should normally use the
1215  * locale-sensitive system strtoll() function.
1216  *
1217  * If the correct value would cause overflow, %G_MAXINT64 or %G_MININT64
1218  * is returned, and `ERANGE` is stored in `errno`.
1219  * If the base is outside the valid range, zero is returned, and
1220  * `EINVAL` is stored in `errno`. If the
1221  * string conversion fails, zero is returned, and @endptr returns @nptr
1222  * (if @endptr is non-%NULL).
1223  *
1224  * Returns: the #gint64 value or zero on error.
1225  *
1226  * Since: 2.12
1227  */
1228 gint64
1229 g_ascii_strtoll (const gchar *nptr,
1230                  gchar      **endptr,
1231                  guint        base)
1232 {
1233 #ifdef USE_XLOCALE
1234   return strtoll_l (nptr, endptr, base, get_C_locale ());
1235 #else
1236   gboolean negative;
1237   guint64 result;
1238 
1239   result = g_parse_long_long (nptr, (const gchar **) endptr, base, &amp;negative);
1240 
1241   if (negative &amp;&amp; result &gt; (guint64) G_MININT64)
1242     {
1243       errno = ERANGE;
1244       return G_MININT64;
1245     }
1246   else if (!negative &amp;&amp; result &gt; (guint64) G_MAXINT64)
1247     {
1248       errno = ERANGE;
1249       return G_MAXINT64;
1250     }
1251   else if (negative)
1252     return - (gint64) result;
1253   else
1254     return (gint64) result;
1255 #endif
1256 }
1257 
1258 /**
1259  * g_strerror:
1260  * @errnum: the system error number. See the standard C %errno
1261  *     documentation
1262  *
1263  * Returns a string corresponding to the given error code, e.g. &quot;no
1264  * such process&quot;. Unlike strerror(), this always returns a string in
1265  * UTF-8 encoding, and the pointer is guaranteed to remain valid for
1266  * the lifetime of the process.
1267  *
1268  * Note that the string may be translated according to the current locale.
1269  *
1270  * The value of %errno will not be changed by this function. However, it may
1271  * be changed by intermediate function calls, so you should save its value
1272  * as soon as the call returns:
1273  * |[
1274  *   int saved_errno;
1275  *
1276  *   ret = read (blah);
1277  *   saved_errno = errno;
1278  *
1279  *   g_strerror (saved_errno);
1280  * ]|
1281  *
1282  * Returns: a UTF-8 string describing the error code. If the error code
1283  *     is unknown, it returns a string like &quot;unknown error (&lt;code&gt;)&quot;.
1284  */
1285 const gchar *
1286 g_strerror (gint errnum)
1287 {
1288   static GHashTable *errors;
1289   G_LOCK_DEFINE_STATIC (errors);
1290   const gchar *msg;
1291   gint saved_errno = errno;
1292 
1293   G_LOCK (errors);
1294   if (errors)
1295     msg = g_hash_table_lookup (errors, GINT_TO_POINTER (errnum));
1296   else
1297     {
1298       errors = g_hash_table_new (NULL, NULL);
1299       msg = NULL;
1300     }
1301 
1302   if (!msg)
1303     {
1304       gchar buf[1024];
1305       GError *error = NULL;
1306 
1307 #if defined(G_OS_WIN32)
1308       strerror_s (buf, sizeof (buf), errnum);
1309       msg = buf;
1310 #elif defined(HAVE_STRERROR_R)
1311       /* Match the condition in strerror_r(3) for glibc */
1312 #  if defined(STRERROR_R_CHAR_P)
1313       msg = strerror_r (errnum, buf, sizeof (buf));
1314 #  else
1315       (void) strerror_r (errnum, buf, sizeof (buf));
1316       msg = buf;
1317 #  endif /* HAVE_STRERROR_R */
1318 #else
1319       g_strlcpy (buf, strerror (errnum), sizeof (buf));
1320       msg = buf;
1321 #endif
<a name="2" id="anc2"></a><span class="line-modified">1322   if (!g_get_charset (NULL))</span>
1323         {
1324           msg = g_locale_to_utf8 (msg, -1, NULL, NULL, &amp;error);
1325           if (error)
1326             g_print (&quot;%s\n&quot;, error-&gt;message);
1327         }
1328       else if (msg == (const gchar *)buf)
1329         msg = g_strdup (buf);
1330 
1331       g_hash_table_insert (errors, GINT_TO_POINTER (errnum), (char *) msg);
1332     }
1333   G_UNLOCK (errors);
1334 
1335   errno = saved_errno;
1336   return msg;
1337 }
1338 
1339 /**
1340  * g_strsignal:
1341  * @signum: the signal number. See the `signal` documentation
1342  *
1343  * Returns a string describing the given signal, e.g. &quot;Segmentation fault&quot;.
1344  * You should use this function in preference to strsignal(), because it
1345  * returns a string in UTF-8 encoding, and since not all platforms support
1346  * the strsignal() function.
1347  *
1348  * Returns: a UTF-8 string describing the signal. If the signal is unknown,
1349  *     it returns &quot;unknown signal (&lt;signum&gt;)&quot;.
1350  */
1351 const gchar *
1352 g_strsignal (gint signum)
1353 {
1354   gchar *msg;
1355   gchar *tofree;
1356   const gchar *ret;
1357 
1358   msg = tofree = NULL;
1359 
1360 #ifdef HAVE_STRSIGNAL
1361   msg = strsignal (signum);
<a name="3" id="anc3"></a><span class="line-modified">1362   if (!g_get_charset (NULL))</span>
1363     msg = tofree = g_locale_to_utf8 (msg, -1, NULL, NULL, NULL);
1364 #endif
1365 
1366   if (!msg)
1367     msg = tofree = g_strdup_printf (&quot;unknown signal (%d)&quot;, signum);
1368   ret = g_intern_string (msg);
1369   g_free (tofree);
1370 
1371   return ret;
1372 }
1373 
1374 /* Functions g_strlcpy and g_strlcat were originally developed by
1375  * Todd C. Miller &lt;Todd.Miller@courtesan.com&gt; to simplify writing secure code.
1376  * See http://www.openbsd.org/cgi-bin/man.cgi?query=strlcpy
1377  * for more information.
1378  */
1379 
1380 #ifdef HAVE_STRLCPY
1381 /* Use the native ones, if available; they might be implemented in assembly */
1382 gsize
1383 g_strlcpy (gchar       *dest,
1384            const gchar *src,
1385            gsize        dest_size)
1386 {
1387   g_return_val_if_fail (dest != NULL, 0);
1388   g_return_val_if_fail (src  != NULL, 0);
1389 
1390   return strlcpy (dest, src, dest_size);
1391 }
1392 
1393 gsize
1394 g_strlcat (gchar       *dest,
1395            const gchar *src,
1396            gsize        dest_size)
1397 {
1398   g_return_val_if_fail (dest != NULL, 0);
1399   g_return_val_if_fail (src  != NULL, 0);
1400 
1401   return strlcat (dest, src, dest_size);
1402 }
1403 
1404 #else /* ! HAVE_STRLCPY */
1405 /**
1406  * g_strlcpy:
1407  * @dest: destination buffer
1408  * @src: source buffer
1409  * @dest_size: length of @dest in bytes
1410  *
1411  * Portability wrapper that calls strlcpy() on systems which have it,
1412  * and emulates strlcpy() otherwise. Copies @src to @dest; @dest is
1413  * guaranteed to be nul-terminated; @src must be nul-terminated;
1414  * @dest_size is the buffer size, not the number of bytes to copy.
1415  *
1416  * At most @dest_size - 1 characters will be copied. Always nul-terminates
1417  * (unless @dest_size is 0). This function does not allocate memory. Unlike
1418  * strncpy(), this function doesn&#39;t pad @dest (so it&#39;s often faster). It
1419  * returns the size of the attempted result, strlen (src), so if
1420  * @retval &gt;= @dest_size, truncation occurred.
1421  *
1422  * Caveat: strlcpy() is supposedly more secure than strcpy() or strncpy(),
1423  * but if you really want to avoid screwups, g_strdup() is an even better
1424  * idea.
1425  *
1426  * Returns: length of @src
1427  */
1428 gsize
1429 g_strlcpy (gchar       *dest,
1430            const gchar *src,
1431            gsize        dest_size)
1432 {
1433   gchar *d = dest;
1434   const gchar *s = src;
1435   gsize n = dest_size;
1436 
1437   g_return_val_if_fail (dest != NULL, 0);
1438   g_return_val_if_fail (src  != NULL, 0);
1439 
1440   /* Copy as many bytes as will fit */
1441   if (n != 0 &amp;&amp; --n != 0)
1442     do
1443       {
1444         gchar c = *s++;
1445 
1446         *d++ = c;
1447         if (c == 0)
1448           break;
1449       }
1450     while (--n != 0);
1451 
1452   /* If not enough room in dest, add NUL and traverse rest of src */
1453   if (n == 0)
1454     {
1455       if (dest_size != 0)
1456         *d = 0;
1457       while (*s++)
1458         ;
1459     }
1460 
1461   return s - src - 1;  /* count does not include NUL */
1462 }
1463 
1464 /**
1465  * g_strlcat:
1466  * @dest: destination buffer, already containing one nul-terminated string
1467  * @src: source buffer
1468  * @dest_size: length of @dest buffer in bytes (not length of existing string
1469  *     inside @dest)
1470  *
1471  * Portability wrapper that calls strlcat() on systems which have it,
1472  * and emulates it otherwise. Appends nul-terminated @src string to @dest,
1473  * guaranteeing nul-termination for @dest. The total size of @dest won&#39;t
1474  * exceed @dest_size.
1475  *
1476  * At most @dest_size - 1 characters will be copied. Unlike strncat(),
1477  * @dest_size is the full size of dest, not the space left over. This
1478  * function does not allocate memory. It always nul-terminates (unless
1479  * @dest_size == 0 or there were no nul characters in the @dest_size
1480  * characters of dest to start with).
1481  *
1482  * Caveat: this is supposedly a more secure alternative to strcat() or
1483  * strncat(), but for real security g_strconcat() is harder to mess up.
1484  *
1485  * Returns: size of attempted result, which is MIN (dest_size, strlen
1486  *     (original dest)) + strlen (src), so if retval &gt;= dest_size,
1487  *     truncation occurred.
1488  */
1489 gsize
1490 g_strlcat (gchar       *dest,
1491            const gchar *src,
1492            gsize        dest_size)
1493 {
1494   gchar *d = dest;
1495   const gchar *s = src;
1496   gsize bytes_left = dest_size;
1497   gsize dlength;  /* Logically, MIN (strlen (d), dest_size) */
1498 
1499   g_return_val_if_fail (dest != NULL, 0);
1500   g_return_val_if_fail (src  != NULL, 0);
1501 
1502   /* Find the end of dst and adjust bytes left but don&#39;t go past end */
1503   while (*d != 0 &amp;&amp; bytes_left-- != 0)
1504     d++;
1505   dlength = d - dest;
1506   bytes_left = dest_size - dlength;
1507 
1508   if (bytes_left == 0)
1509     return dlength + strlen (s);
1510 
1511   while (*s != 0)
1512     {
1513       if (bytes_left != 1)
1514         {
1515           *d++ = *s;
1516           bytes_left--;
1517         }
1518       s++;
1519     }
1520   *d = 0;
1521 
1522   return dlength + (s - src);  /* count does not include NUL */
1523 }
1524 #endif /* ! HAVE_STRLCPY */
1525 
1526 /**
1527  * g_ascii_strdown:
1528  * @str: a string
1529  * @len: length of @str in bytes, or -1 if @str is nul-terminated
1530  *
1531  * Converts all upper case ASCII letters to lower case ASCII letters.
1532  *
1533  * Returns: a newly-allocated string, with all the upper case
1534  *     characters in @str converted to lower case, with semantics that
1535  *     exactly match g_ascii_tolower(). (Note that this is unlike the
1536  *     old g_strdown(), which modified the string in place.)
1537  */
1538 gchar*
1539 g_ascii_strdown (const gchar *str,
1540                  gssize       len)
1541 {
1542   gchar *result, *s;
1543 
1544   g_return_val_if_fail (str != NULL, NULL);
1545 
1546   if (len &lt; 0)
1547     len = (gssize) strlen (str);
1548 
1549   result = g_strndup (str, (gsize) len);
1550   for (s = result; *s; s++)
1551     *s = g_ascii_tolower (*s);
1552 
1553   return result;
1554 }
1555 
1556 /**
1557  * g_ascii_strup:
1558  * @str: a string
1559  * @len: length of @str in bytes, or -1 if @str is nul-terminated
1560  *
1561  * Converts all lower case ASCII letters to upper case ASCII letters.
1562  *
1563  * Returns: a newly allocated string, with all the lower case
1564  *     characters in @str converted to upper case, with semantics that
1565  *     exactly match g_ascii_toupper(). (Note that this is unlike the
1566  *     old g_strup(), which modified the string in place.)
1567  */
1568 gchar*
1569 g_ascii_strup (const gchar *str,
1570                gssize       len)
1571 {
1572   gchar *result, *s;
1573 
1574   g_return_val_if_fail (str != NULL, NULL);
1575 
1576   if (len &lt; 0)
1577     len = (gssize) strlen (str);
1578 
1579   result = g_strndup (str, (gsize) len);
1580   for (s = result; *s; s++)
1581     *s = g_ascii_toupper (*s);
1582 
1583   return result;
1584 }
1585 
1586 /**
1587  * g_str_is_ascii:
1588  * @str: a string
1589  *
1590  * Determines if a string is pure ASCII. A string is pure ASCII if it
1591  * contains no bytes with the high bit set.
1592  *
1593  * Returns: %TRUE if @str is ASCII
1594  *
1595  * Since: 2.40
1596  */
1597 gboolean
1598 g_str_is_ascii (const gchar *str)
1599 {
1600   gint i;
1601 
1602   for (i = 0; str[i]; i++)
1603     if (str[i] &amp; 0x80)
1604       return FALSE;
1605 
1606   return TRUE;
1607 }
1608 
1609 /**
1610  * g_strdown:
1611  * @string: the string to convert.
1612  *
1613  * Converts a string to lower case.
1614  *
1615  * Returns: the string
1616  *
1617  * Deprecated:2.2: This function is totally broken for the reasons discussed
1618  * in the g_strncasecmp() docs - use g_ascii_strdown() or g_utf8_strdown()
1619  * instead.
1620  **/
1621 gchar*
1622 g_strdown (gchar *string)
1623 {
1624   guchar *s;
1625 
1626   g_return_val_if_fail (string != NULL, NULL);
1627 
1628   s = (guchar *) string;
1629 
1630   while (*s)
1631     {
1632       if (isupper (*s))
1633         *s = tolower (*s);
1634       s++;
1635     }
1636 
1637   return (gchar *) string;
1638 }
1639 
1640 /**
1641  * g_strup:
1642  * @string: the string to convert
1643  *
1644  * Converts a string to upper case.
1645  *
1646  * Returns: the string
1647  *
1648  * Deprecated:2.2: This function is totally broken for the reasons
1649  *     discussed in the g_strncasecmp() docs - use g_ascii_strup()
1650  *     or g_utf8_strup() instead.
1651  */
1652 gchar*
1653 g_strup (gchar *string)
1654 {
1655   guchar *s;
1656 
1657   g_return_val_if_fail (string != NULL, NULL);
1658 
1659   s = (guchar *) string;
1660 
1661   while (*s)
1662     {
1663       if (islower (*s))
1664         *s = toupper (*s);
1665       s++;
1666     }
1667 
1668   return (gchar *) string;
1669 }
1670 
1671 /**
1672  * g_strreverse:
1673  * @string: the string to reverse
1674  *
1675  * Reverses all of the bytes in a string. For example,
1676  * `g_strreverse (&quot;abcdef&quot;)` will result in &quot;fedcba&quot;.
1677  *
1678  * Note that g_strreverse() doesn&#39;t work on UTF-8 strings
1679  * containing multibyte characters. For that purpose, use
1680  * g_utf8_strreverse().
1681  *
1682  * Returns: the same pointer passed in as @string
1683  */
1684 gchar*
1685 g_strreverse (gchar *string)
1686 {
1687   g_return_val_if_fail (string != NULL, NULL);
1688 
1689   if (*string)
1690     {
1691       gchar *h, *t;
1692 
1693       h = string;
1694       t = string + strlen (string) - 1;
1695 
1696       while (h &lt; t)
1697         {
1698           gchar c;
1699 
1700           c = *h;
1701           *h = *t;
1702           h++;
1703           *t = c;
1704           t--;
1705         }
1706     }
1707 
1708   return string;
1709 }
1710 
1711 /**
1712  * g_ascii_tolower:
1713  * @c: any character
1714  *
1715  * Convert a character to ASCII lower case.
1716  *
1717  * Unlike the standard C library tolower() function, this only
1718  * recognizes standard ASCII letters and ignores the locale, returning
1719  * all non-ASCII characters unchanged, even if they are lower case
1720  * letters in a particular character set. Also unlike the standard
1721  * library function, this takes and returns a char, not an int, so
1722  * don&#39;t call it on %EOF but no need to worry about casting to #guchar
1723  * before passing a possibly non-ASCII character in.
1724  *
1725  * Returns: the result of converting @c to lower case. If @c is
1726  *     not an ASCII upper case letter, @c is returned unchanged.
1727  */
1728 gchar
1729 g_ascii_tolower (gchar c)
1730 {
1731   return g_ascii_isupper (c) ? c - &#39;A&#39; + &#39;a&#39; : c;
1732 }
1733 
1734 /**
1735  * g_ascii_toupper:
1736  * @c: any character
1737  *
1738  * Convert a character to ASCII upper case.
1739  *
1740  * Unlike the standard C library toupper() function, this only
1741  * recognizes standard ASCII letters and ignores the locale, returning
1742  * all non-ASCII characters unchanged, even if they are upper case
1743  * letters in a particular character set. Also unlike the standard
1744  * library function, this takes and returns a char, not an int, so
1745  * don&#39;t call it on %EOF but no need to worry about casting to #guchar
1746  * before passing a possibly non-ASCII character in.
1747  *
1748  * Returns: the result of converting @c to upper case. If @c is not
1749  *    an ASCII lower case letter, @c is returned unchanged.
1750  */
1751 gchar
1752 g_ascii_toupper (gchar c)
1753 {
1754   return g_ascii_islower (c) ? c - &#39;a&#39; + &#39;A&#39; : c;
1755 }
1756 
1757 /**
1758  * g_ascii_digit_value:
1759  * @c: an ASCII character
1760  *
1761  * Determines the numeric value of a character as a decimal digit.
1762  * Differs from g_unichar_digit_value() because it takes a char, so
1763  * there&#39;s no worry about sign extension if characters are signed.
1764  *
1765  * Returns: If @c is a decimal digit (according to g_ascii_isdigit()),
1766  *    its numeric value. Otherwise, -1.
1767  */
1768 int
1769 g_ascii_digit_value (gchar c)
1770 {
1771   if (g_ascii_isdigit (c))
1772     return c - &#39;0&#39;;
1773   return -1;
1774 }
1775 
1776 /**
1777  * g_ascii_xdigit_value:
1778  * @c: an ASCII character.
1779  *
1780  * Determines the numeric value of a character as a hexidecimal
1781  * digit. Differs from g_unichar_xdigit_value() because it takes
1782  * a char, so there&#39;s no worry about sign extension if characters
1783  * are signed.
1784  *
1785  * Returns: If @c is a hex digit (according to g_ascii_isxdigit()),
1786  *     its numeric value. Otherwise, -1.
1787  */
1788 int
1789 g_ascii_xdigit_value (gchar c)
1790 {
1791   if (c &gt;= &#39;A&#39; &amp;&amp; c &lt;= &#39;F&#39;)
1792     return c - &#39;A&#39; + 10;
1793   if (c &gt;= &#39;a&#39; &amp;&amp; c &lt;= &#39;f&#39;)
1794     return c - &#39;a&#39; + 10;
1795   return g_ascii_digit_value (c);
1796 }
1797 
1798 /**
1799  * g_ascii_strcasecmp:
1800  * @s1: string to compare with @s2
1801  * @s2: string to compare with @s1
1802  *
1803  * Compare two strings, ignoring the case of ASCII characters.
1804  *
1805  * Unlike the BSD strcasecmp() function, this only recognizes standard
1806  * ASCII letters and ignores the locale, treating all non-ASCII
1807  * bytes as if they are not letters.
1808  *
1809  * This function should be used only on strings that are known to be
1810  * in encodings where the bytes corresponding to ASCII letters always
1811  * represent themselves. This includes UTF-8 and the ISO-8859-*
1812  * charsets, but not for instance double-byte encodings like the
1813  * Windows Codepage 932, where the trailing bytes of double-byte
1814  * characters include all ASCII letters. If you compare two CP932
1815  * strings using this function, you will get false matches.
1816  *
1817  * Both @s1 and @s2 must be non-%NULL.
1818  *
1819  * Returns: 0 if the strings match, a negative value if @s1 &lt; @s2,
1820  *     or a positive value if @s1 &gt; @s2.
1821  */
1822 gint
1823 g_ascii_strcasecmp (const gchar *s1,
1824                     const gchar *s2)
1825 {
1826   gint c1, c2;
1827 
1828   g_return_val_if_fail (s1 != NULL, 0);
1829   g_return_val_if_fail (s2 != NULL, 0);
1830 
1831   while (*s1 &amp;&amp; *s2)
1832     {
1833       c1 = (gint)(guchar) TOLOWER (*s1);
1834       c2 = (gint)(guchar) TOLOWER (*s2);
1835       if (c1 != c2)
1836         return (c1 - c2);
1837       s1++; s2++;
1838     }
1839 
1840   return (((gint)(guchar) *s1) - ((gint)(guchar) *s2));
1841 }
1842 
1843 /**
1844  * g_ascii_strncasecmp:
1845  * @s1: string to compare with @s2
1846  * @s2: string to compare with @s1
1847  * @n: number of characters to compare
1848  *
1849  * Compare @s1 and @s2, ignoring the case of ASCII characters and any
1850  * characters after the first @n in each string.
1851  *
1852  * Unlike the BSD strcasecmp() function, this only recognizes standard
1853  * ASCII letters and ignores the locale, treating all non-ASCII
1854  * characters as if they are not letters.
1855  *
1856  * The same warning as in g_ascii_strcasecmp() applies: Use this
1857  * function only on strings known to be in encodings where bytes
1858  * corresponding to ASCII letters always represent themselves.
1859  *
1860  * Returns: 0 if the strings match, a negative value if @s1 &lt; @s2,
1861  *     or a positive value if @s1 &gt; @s2.
1862  */
1863 gint
1864 g_ascii_strncasecmp (const gchar *s1,
1865                      const gchar *s2,
1866                      gsize        n)
1867 {
1868   gint c1, c2;
1869 
1870   g_return_val_if_fail (s1 != NULL, 0);
1871   g_return_val_if_fail (s2 != NULL, 0);
1872 
1873   while (n &amp;&amp; *s1 &amp;&amp; *s2)
1874     {
1875       n -= 1;
1876       c1 = (gint)(guchar) TOLOWER (*s1);
1877       c2 = (gint)(guchar) TOLOWER (*s2);
1878       if (c1 != c2)
1879         return (c1 - c2);
1880       s1++; s2++;
1881     }
1882 
1883   if (n)
1884     return (((gint) (guchar) *s1) - ((gint) (guchar) *s2));
1885   else
1886     return 0;
1887 }
1888 
1889 /**
1890  * g_strcasecmp:
1891  * @s1: a string
1892  * @s2: a string to compare with @s1
1893  *
1894  * A case-insensitive string comparison, corresponding to the standard
1895  * strcasecmp() function on platforms which support it.
1896  *
1897  * Returns: 0 if the strings match, a negative value if @s1 &lt; @s2,
1898  *     or a positive value if @s1 &gt; @s2.
1899  *
1900  * Deprecated:2.2: See g_strncasecmp() for a discussion of why this
1901  *     function is deprecated and how to replace it.
1902  */
1903 gint
1904 g_strcasecmp (const gchar *s1,
1905               const gchar *s2)
1906 {
1907 #ifdef HAVE_STRCASECMP
1908   g_return_val_if_fail (s1 != NULL, 0);
1909   g_return_val_if_fail (s2 != NULL, 0);
1910 
1911   return strcasecmp (s1, s2);
1912 #else
1913   gint c1, c2;
1914 
1915   g_return_val_if_fail (s1 != NULL, 0);
1916   g_return_val_if_fail (s2 != NULL, 0);
1917 
1918   while (*s1 &amp;&amp; *s2)
1919     {
1920       /* According to A. Cox, some platforms have islower&#39;s that
1921        * don&#39;t work right on non-uppercase
1922        */
1923       c1 = isupper ((guchar)*s1) ? tolower ((guchar)*s1) : *s1;
1924       c2 = isupper ((guchar)*s2) ? tolower ((guchar)*s2) : *s2;
1925       if (c1 != c2)
1926         return (c1 - c2);
1927       s1++; s2++;
1928     }
1929 
1930   return (((gint)(guchar) *s1) - ((gint)(guchar) *s2));
1931 #endif
1932 }
1933 
1934 /**
1935  * g_strncasecmp:
1936  * @s1: a string
1937  * @s2: a string to compare with @s1
1938  * @n: the maximum number of characters to compare
1939  *
1940  * A case-insensitive string comparison, corresponding to the standard
1941  * strncasecmp() function on platforms which support it. It is similar
1942  * to g_strcasecmp() except it only compares the first @n characters of
1943  * the strings.
1944  *
1945  * Returns: 0 if the strings match, a negative value if @s1 &lt; @s2,
1946  *     or a positive value if @s1 &gt; @s2.
1947  *
1948  * Deprecated:2.2: The problem with g_strncasecmp() is that it does
1949  *     the comparison by calling toupper()/tolower(). These functions
1950  *     are locale-specific and operate on single bytes. However, it is
1951  *     impossible to handle things correctly from an internationalization
1952  *     standpoint by operating on bytes, since characters may be multibyte.
1953  *     Thus g_strncasecmp() is broken if your string is guaranteed to be
1954  *     ASCII, since it is locale-sensitive, and it&#39;s broken if your string
1955  *     is localized, since it doesn&#39;t work on many encodings at all,
1956  *     including UTF-8, EUC-JP, etc.
1957  *
1958  *     There are therefore two replacement techniques: g_ascii_strncasecmp(),
1959  *     which only works on ASCII and is not locale-sensitive, and
1960  *     g_utf8_casefold() followed by strcmp() on the resulting strings,
1961  *     which is good for case-insensitive sorting of UTF-8.
1962  */
1963 gint
1964 g_strncasecmp (const gchar *s1,
1965                const gchar *s2,
1966                guint n)
1967 {
1968 #ifdef HAVE_STRNCASECMP
1969   return strncasecmp (s1, s2, n);
1970 #else
1971   gint c1, c2;
1972 
1973   g_return_val_if_fail (s1 != NULL, 0);
1974   g_return_val_if_fail (s2 != NULL, 0);
1975 
1976   while (n &amp;&amp; *s1 &amp;&amp; *s2)
1977     {
1978       n -= 1;
1979       /* According to A. Cox, some platforms have islower&#39;s that
1980        * don&#39;t work right on non-uppercase
1981        */
1982       c1 = isupper ((guchar)*s1) ? tolower ((guchar)*s1) : *s1;
1983       c2 = isupper ((guchar)*s2) ? tolower ((guchar)*s2) : *s2;
1984       if (c1 != c2)
1985         return (c1 - c2);
1986       s1++; s2++;
1987     }
1988 
1989   if (n)
1990     return (((gint) (guchar) *s1) - ((gint) (guchar) *s2));
1991   else
1992     return 0;
1993 #endif
1994 }
1995 
1996 /**
1997  * g_strdelimit:
1998  * @string: the string to convert
1999  * @delimiters: (nullable): a string containing the current delimiters,
2000  *     or %NULL to use the standard delimiters defined in #G_STR_DELIMITERS
2001  * @new_delimiter: the new delimiter character
2002  *
2003  * Converts any delimiter characters in @string to @new_delimiter.
2004  * Any characters in @string which are found in @delimiters are
2005  * changed to the @new_delimiter character. Modifies @string in place,
2006  * and returns @string itself, not a copy. The return value is to
2007  * allow nesting such as
2008  * |[&lt;!-- language=&quot;C&quot; --&gt;
2009  *   g_ascii_strup (g_strdelimit (str, &quot;abc&quot;, &#39;?&#39;))
2010  * ]|
2011  *
<a name="4" id="anc4"></a>






2012  * Returns: @string
2013  */
2014 gchar *
2015 g_strdelimit (gchar       *string,
2016               const gchar *delimiters,
2017               gchar        new_delim)
2018 {
2019   gchar *c;
2020 
2021   g_return_val_if_fail (string != NULL, NULL);
2022 
2023   if (!delimiters)
2024     delimiters = G_STR_DELIMITERS;
2025 
2026   for (c = string; *c; c++)
2027     {
2028       if (strchr (delimiters, *c))
2029         *c = new_delim;
2030     }
2031 
2032   return string;
2033 }
2034 
2035 /**
2036  * g_strcanon:
2037  * @string: a nul-terminated array of bytes
2038  * @valid_chars: bytes permitted in @string
2039  * @substitutor: replacement character for disallowed bytes
2040  *
2041  * For each character in @string, if the character is not in @valid_chars,
2042  * replaces the character with @substitutor. Modifies @string in place,
2043  * and return @string itself, not a copy. The return value is to allow
2044  * nesting such as
2045  * |[&lt;!-- language=&quot;C&quot; --&gt;
2046  *   g_ascii_strup (g_strcanon (str, &quot;abc&quot;, &#39;?&#39;))
2047  * ]|
2048  *
<a name="5" id="anc5"></a>






2049  * Returns: @string
2050  */
2051 gchar *
2052 g_strcanon (gchar       *string,
2053             const gchar *valid_chars,
2054             gchar        substitutor)
2055 {
2056   gchar *c;
2057 
2058   g_return_val_if_fail (string != NULL, NULL);
2059   g_return_val_if_fail (valid_chars != NULL, NULL);
2060 
2061   for (c = string; *c; c++)
2062     {
2063       if (!strchr (valid_chars, *c))
2064         *c = substitutor;
2065     }
2066 
2067   return string;
2068 }
2069 
2070 /**
2071  * g_strcompress:
2072  * @source: a string to compress
2073  *
2074  * Replaces all escaped characters with their one byte equivalent.
2075  *
2076  * This function does the reverse conversion of g_strescape().
2077  *
2078  * Returns: a newly-allocated copy of @source with all escaped
2079  *     character compressed
2080  */
2081 gchar *
2082 g_strcompress (const gchar *source)
2083 {
2084   const gchar *p = source, *octal;
2085   gchar *dest;
2086   gchar *q;
2087 
2088   g_return_val_if_fail (source != NULL, NULL);
2089 
2090   dest = g_malloc (strlen (source) + 1);
2091   q = dest;
2092 
2093   while (*p)
2094     {
2095       if (*p == &#39;\\&#39;)
2096         {
2097           p++;
2098           switch (*p)
2099             {
2100             case &#39;\0&#39;:
2101               g_warning (&quot;g_strcompress: trailing \\&quot;);
2102               goto out;
2103             case &#39;0&#39;:  case &#39;1&#39;:  case &#39;2&#39;:  case &#39;3&#39;:  case &#39;4&#39;:
2104             case &#39;5&#39;:  case &#39;6&#39;:  case &#39;7&#39;:
2105               *q = 0;
2106               octal = p;
2107               while ((p &lt; octal + 3) &amp;&amp; (*p &gt;= &#39;0&#39;) &amp;&amp; (*p &lt;= &#39;7&#39;))
2108                 {
2109                   *q = (*q * 8) + (*p - &#39;0&#39;);
2110                   p++;
2111                 }
2112               q++;
2113               p--;
2114               break;
2115             case &#39;b&#39;:
2116               *q++ = &#39;\b&#39;;
2117               break;
2118             case &#39;f&#39;:
2119               *q++ = &#39;\f&#39;;
2120               break;
2121             case &#39;n&#39;:
2122               *q++ = &#39;\n&#39;;
2123               break;
2124             case &#39;r&#39;:
2125               *q++ = &#39;\r&#39;;
2126               break;
2127             case &#39;t&#39;:
2128               *q++ = &#39;\t&#39;;
2129               break;
2130             case &#39;v&#39;:
2131               *q++ = &#39;\v&#39;;
2132               break;
2133             default:            /* Also handles \&quot; and \\ */
2134               *q++ = *p;
2135               break;
2136             }
2137         }
2138       else
2139         *q++ = *p;
2140       p++;
2141     }
2142 out:
2143   *q = 0;
2144 
2145   return dest;
2146 }
2147 
2148 /**
2149  * g_strescape:
2150  * @source: a string to escape
2151  * @exceptions: (nullable): a string of characters not to escape in @source
2152  *
2153  * Escapes the special characters &#39;\b&#39;, &#39;\f&#39;, &#39;\n&#39;, &#39;\r&#39;, &#39;\t&#39;, &#39;\v&#39;, &#39;\&#39;
2154  * and &#39;&quot;&#39; in the string @source by inserting a &#39;\&#39; before
2155  * them. Additionally all characters in the range 0x01-0x1F (everything
2156  * below SPACE) and in the range 0x7F-0xFF (all non-ASCII chars) are
2157  * replaced with a &#39;\&#39; followed by their octal representation.
2158  * Characters supplied in @exceptions are not escaped.
2159  *
2160  * g_strcompress() does the reverse conversion.
2161  *
2162  * Returns: a newly-allocated copy of @source with certain
2163  *     characters escaped. See above.
2164  */
2165 gchar *
2166 g_strescape (const gchar *source,
2167              const gchar *exceptions)
2168 {
2169   const guchar *p;
2170   gchar *dest;
2171   gchar *q;
2172   guchar excmap[256];
2173 
2174   g_return_val_if_fail (source != NULL, NULL);
2175 
2176   p = (guchar *) source;
2177   /* Each source byte needs maximally four destination chars (\777) */
2178   q = dest = g_malloc (strlen (source) * 4 + 1);
2179 
2180   memset (excmap, 0, 256);
2181   if (exceptions)
2182     {
2183       guchar *e = (guchar *) exceptions;
2184 
2185       while (*e)
2186         {
2187           excmap[*e] = 1;
2188           e++;
2189         }
2190     }
2191 
2192   while (*p)
2193     {
2194       if (excmap[*p])
2195         *q++ = *p;
2196       else
2197         {
2198           switch (*p)
2199             {
2200             case &#39;\b&#39;:
2201               *q++ = &#39;\\&#39;;
2202               *q++ = &#39;b&#39;;
2203               break;
2204             case &#39;\f&#39;:
2205               *q++ = &#39;\\&#39;;
2206               *q++ = &#39;f&#39;;
2207               break;
2208             case &#39;\n&#39;:
2209               *q++ = &#39;\\&#39;;
2210               *q++ = &#39;n&#39;;
2211               break;
2212             case &#39;\r&#39;:
2213               *q++ = &#39;\\&#39;;
2214               *q++ = &#39;r&#39;;
2215               break;
2216             case &#39;\t&#39;:
2217               *q++ = &#39;\\&#39;;
2218               *q++ = &#39;t&#39;;
2219               break;
2220             case &#39;\v&#39;:
2221               *q++ = &#39;\\&#39;;
2222               *q++ = &#39;v&#39;;
2223               break;
2224             case &#39;\\&#39;:
2225               *q++ = &#39;\\&#39;;
2226               *q++ = &#39;\\&#39;;
2227               break;
2228             case &#39;&quot;&#39;:
2229               *q++ = &#39;\\&#39;;
2230               *q++ = &#39;&quot;&#39;;
2231               break;
2232             default:
2233               if ((*p &lt; &#39; &#39;) || (*p &gt;= 0177))
2234                 {
2235                   *q++ = &#39;\\&#39;;
2236                   *q++ = &#39;0&#39; + (((*p) &gt;&gt; 6) &amp; 07);
2237                   *q++ = &#39;0&#39; + (((*p) &gt;&gt; 3) &amp; 07);
2238                   *q++ = &#39;0&#39; + ((*p) &amp; 07);
2239                 }
2240               else
2241                 *q++ = *p;
2242               break;
2243             }
2244         }
2245       p++;
2246     }
2247   *q = 0;
2248   return dest;
2249 }
2250 
2251 /**
2252  * g_strchug:
2253  * @string: a string to remove the leading whitespace from
2254  *
2255  * Removes leading whitespace from a string, by moving the rest
2256  * of the characters forward.
2257  *
2258  * This function doesn&#39;t allocate or reallocate any memory;
2259  * it modifies @string in place. Therefore, it cannot be used on
2260  * statically allocated strings.
2261  *
2262  * The pointer to @string is returned to allow the nesting of functions.
2263  *
2264  * Also see g_strchomp() and g_strstrip().
2265  *
2266  * Returns: @string
2267  */
2268 gchar *
2269 g_strchug (gchar *string)
2270 {
2271   guchar *start;
2272 
2273   g_return_val_if_fail (string != NULL, NULL);
2274 
2275   for (start = (guchar*) string; *start &amp;&amp; g_ascii_isspace (*start); start++)
2276     ;
2277 
2278   memmove (string, start, strlen ((gchar *) start) + 1);
2279 
2280   return string;
2281 }
2282 
2283 /**
2284  * g_strchomp:
2285  * @string: a string to remove the trailing whitespace from
2286  *
2287  * Removes trailing whitespace from a string.
2288  *
2289  * This function doesn&#39;t allocate or reallocate any memory;
2290  * it modifies @string in place. Therefore, it cannot be used
2291  * on statically allocated strings.
2292  *
2293  * The pointer to @string is returned to allow the nesting of functions.
2294  *
2295  * Also see g_strchug() and g_strstrip().
2296  *
2297  * Returns: @string
2298  */
2299 gchar *
2300 g_strchomp (gchar *string)
2301 {
2302   gsize len;
2303 
2304   g_return_val_if_fail (string != NULL, NULL);
2305 
2306   len = strlen (string);
2307   while (len--)
2308     {
2309       if (g_ascii_isspace ((guchar) string[len]))
2310         string[len] = &#39;\0&#39;;
2311       else
2312         break;
2313     }
2314 
2315   return string;
2316 }
2317 
2318 /**
2319  * g_strsplit:
2320  * @string: a string to split
2321  * @delimiter: a string which specifies the places at which to split
2322  *     the string. The delimiter is not included in any of the resulting
2323  *     strings, unless @max_tokens is reached.
2324  * @max_tokens: the maximum number of pieces to split @string into.
2325  *     If this is less than 1, the string is split completely.
2326  *
2327  * Splits a string into a maximum of @max_tokens pieces, using the given
2328  * @delimiter. If @max_tokens is reached, the remainder of @string is
2329  * appended to the last token.
2330  *
2331  * As an example, the result of g_strsplit (&quot;:a:bc::d:&quot;, &quot;:&quot;, -1) is a
2332  * %NULL-terminated vector containing the six strings &quot;&quot;, &quot;a&quot;, &quot;bc&quot;, &quot;&quot;, &quot;d&quot;
2333  * and &quot;&quot;.
2334  *
2335  * As a special case, the result of splitting the empty string &quot;&quot; is an empty
2336  * vector, not a vector containing a single string. The reason for this
<a name="6" id="anc6"></a><span class="line-modified">2337  * special case is that being able to represent a empty vector is typically</span>
2338  * more useful than consistent handling of empty elements. If you do need
2339  * to represent empty elements, you&#39;ll need to check for the empty string
2340  * before calling g_strsplit().
2341  *
2342  * Returns: a newly-allocated %NULL-terminated array of strings. Use
2343  *    g_strfreev() to free it.
2344  */
2345 gchar**
2346 g_strsplit (const gchar *string,
2347             const gchar *delimiter,
2348             gint         max_tokens)
2349 {
2350   GSList *string_list = NULL, *slist;
2351   gchar **str_array, *s;
2352   guint n = 0;
2353   const gchar *remainder;
2354 
2355   g_return_val_if_fail (string != NULL, NULL);
2356   g_return_val_if_fail (delimiter != NULL, NULL);
2357   g_return_val_if_fail (delimiter[0] != &#39;\0&#39;, NULL);
2358 
2359   if (max_tokens &lt; 1)
2360     max_tokens = G_MAXINT;
2361 
2362   remainder = string;
2363   s = strstr (remainder, delimiter);
2364   if (s)
2365     {
2366       gsize delimiter_len = strlen (delimiter);
2367 
2368       while (--max_tokens &amp;&amp; s)
2369         {
2370           gsize len;
2371 
2372           len = s - remainder;
2373           string_list = g_slist_prepend (string_list,
2374                                          g_strndup (remainder, len));
2375           n++;
2376           remainder = s + delimiter_len;
2377           s = strstr (remainder, delimiter);
2378         }
2379     }
2380   if (*string)
2381     {
2382       n++;
2383       string_list = g_slist_prepend (string_list, g_strdup (remainder));
2384     }
2385 
2386   str_array = g_new (gchar*, n + 1);
2387 
2388   str_array[n--] = NULL;
2389   for (slist = string_list; slist; slist = slist-&gt;next)
2390     str_array[n--] = slist-&gt;data;
2391 
2392   g_slist_free (string_list);
2393 
2394   return str_array;
2395 }
2396 
2397 /**
2398  * g_strsplit_set:
2399  * @string: The string to be tokenized
2400  * @delimiters: A nul-terminated string containing bytes that are used
2401  *     to split the string.
2402  * @max_tokens: The maximum number of tokens to split @string into.
2403  *     If this is less than 1, the string is split completely
2404  *
2405  * Splits @string into a number of tokens not containing any of the characters
2406  * in @delimiter. A token is the (possibly empty) longest string that does not
2407  * contain any of the characters in @delimiters. If @max_tokens is reached, the
2408  * remainder is appended to the last token.
2409  *
2410  * For example the result of g_strsplit_set (&quot;abc:def/ghi&quot;, &quot;:/&quot;, -1) is a
2411  * %NULL-terminated vector containing the three strings &quot;abc&quot;, &quot;def&quot;,
2412  * and &quot;ghi&quot;.
2413  *
2414  * The result of g_strsplit_set (&quot;:def/ghi:&quot;, &quot;:/&quot;, -1) is a %NULL-terminated
2415  * vector containing the four strings &quot;&quot;, &quot;def&quot;, &quot;ghi&quot;, and &quot;&quot;.
2416  *
2417  * As a special case, the result of splitting the empty string &quot;&quot; is an empty
2418  * vector, not a vector containing a single string. The reason for this
<a name="7" id="anc7"></a><span class="line-modified">2419  * special case is that being able to represent a empty vector is typically</span>
2420  * more useful than consistent handling of empty elements. If you do need
2421  * to represent empty elements, you&#39;ll need to check for the empty string
2422  * before calling g_strsplit_set().
2423  *
2424  * Note that this function works on bytes not characters, so it can&#39;t be used
2425  * to delimit UTF-8 strings for anything but ASCII characters.
2426  *
2427  * Returns: a newly-allocated %NULL-terminated array of strings. Use
2428  *    g_strfreev() to free it.
2429  *
2430  * Since: 2.4
2431  **/
2432 gchar **
2433 g_strsplit_set (const gchar *string,
2434                 const gchar *delimiters,
2435                 gint         max_tokens)
2436 {
2437   gboolean delim_table[256];
2438   GSList *tokens, *list;
2439   gint n_tokens;
2440   const gchar *s;
2441   const gchar *current;
2442   gchar *token;
2443   gchar **result;
2444 
2445   g_return_val_if_fail (string != NULL, NULL);
2446   g_return_val_if_fail (delimiters != NULL, NULL);
2447 
2448   if (max_tokens &lt; 1)
2449     max_tokens = G_MAXINT;
2450 
2451   if (*string == &#39;\0&#39;)
2452     {
2453       result = g_new (char *, 1);
2454       result[0] = NULL;
2455       return result;
2456     }
2457 
2458   memset (delim_table, FALSE, sizeof (delim_table));
2459   for (s = delimiters; *s != &#39;\0&#39;; ++s)
2460     delim_table[*(guchar *)s] = TRUE;
2461 
2462   tokens = NULL;
2463   n_tokens = 0;
2464 
2465   s = current = string;
2466   while (*s != &#39;\0&#39;)
2467     {
2468       if (delim_table[*(guchar *)s] &amp;&amp; n_tokens + 1 &lt; max_tokens)
2469         {
2470           token = g_strndup (current, s - current);
2471           tokens = g_slist_prepend (tokens, token);
2472           ++n_tokens;
2473 
2474           current = s + 1;
2475         }
2476 
2477       ++s;
2478     }
2479 
2480   token = g_strndup (current, s - current);
2481   tokens = g_slist_prepend (tokens, token);
2482   ++n_tokens;
2483 
2484   result = g_new (gchar *, n_tokens + 1);
2485 
2486   result[n_tokens] = NULL;
2487   for (list = tokens; list != NULL; list = list-&gt;next)
2488     result[--n_tokens] = list-&gt;data;
2489 
2490   g_slist_free (tokens);
2491 
2492   return result;
2493 }
2494 
2495 /**
2496  * GStrv:
2497  *
2498  * A typedef alias for gchar**. This is mostly useful when used together with
2499  * g_auto().
2500  */
2501 
2502 /**
2503  * g_strfreev:
2504  * @str_array: (nullable): a %NULL-terminated array of strings to free
2505  *
2506  * Frees a %NULL-terminated array of strings, as well as each
2507  * string it contains.
2508  *
2509  * If @str_array is %NULL, this function simply returns.
2510  */
2511 void
2512 g_strfreev (gchar **str_array)
2513 {
2514   if (str_array)
2515     {
2516       int i;
2517 
2518       for (i = 0; str_array[i] != NULL; i++)
2519         g_free (str_array[i]);
2520 
2521       g_free (str_array);
2522     }
2523 }
2524 
2525 /**
2526  * g_strdupv:
2527  * @str_array: (nullable): a %NULL-terminated array of strings
2528  *
2529  * Copies %NULL-terminated array of strings. The copy is a deep copy;
2530  * the new array should be freed by first freeing each string, then
2531  * the array itself. g_strfreev() does this for you. If called
2532  * on a %NULL value, g_strdupv() simply returns %NULL.
2533  *
2534  * Returns: (nullable): a new %NULL-terminated array of strings.
2535  */
2536 gchar**
2537 g_strdupv (gchar **str_array)
2538 {
2539   if (str_array)
2540     {
2541       gint i;
2542       gchar **retval;
2543 
2544       i = 0;
2545       while (str_array[i])
2546         ++i;
2547 
2548       retval = g_new (gchar*, i + 1);
2549 
2550       i = 0;
2551       while (str_array[i])
2552         {
2553           retval[i] = g_strdup (str_array[i]);
2554           ++i;
2555         }
2556       retval[i] = NULL;
2557 
2558       return retval;
2559     }
2560   else
2561     return NULL;
2562 }
2563 
2564 /**
2565  * g_strjoinv:
2566  * @separator: (nullable): a string to insert between each of the
2567  *     strings, or %NULL
2568  * @str_array: a %NULL-terminated array of strings to join
2569  *
2570  * Joins a number of strings together to form one long string, with the
2571  * optional @separator inserted between each of them. The returned string
2572  * should be freed with g_free().
2573  *
2574  * If @str_array has no items, the return value will be an
2575  * empty string. If @str_array contains a single item, @separator will not
2576  * appear in the resulting string.
2577  *
2578  * Returns: a newly-allocated string containing all of the strings joined
2579  *     together, with @separator between them
2580  */
2581 gchar*
2582 g_strjoinv (const gchar  *separator,
2583             gchar       **str_array)
2584 {
2585   gchar *string;
2586   gchar *ptr;
2587 
2588   g_return_val_if_fail (str_array != NULL, NULL);
2589 
2590   if (separator == NULL)
2591     separator = &quot;&quot;;
2592 
2593   if (*str_array)
2594     {
2595       gint i;
2596       gsize len;
2597       gsize separator_len;
2598 
2599       separator_len = strlen (separator);
2600       /* First part, getting length */
2601       len = 1 + strlen (str_array[0]);
2602       for (i = 1; str_array[i] != NULL; i++)
2603         len += strlen (str_array[i]);
2604       len += separator_len * (i - 1);
2605 
2606       /* Second part, building string */
2607       string = g_new (gchar, len);
2608       ptr = g_stpcpy (string, *str_array);
2609       for (i = 1; str_array[i] != NULL; i++)
2610         {
2611           ptr = g_stpcpy (ptr, separator);
2612           ptr = g_stpcpy (ptr, str_array[i]);
2613         }
2614       }
2615   else
2616     string = g_strdup (&quot;&quot;);
2617 
2618   return string;
2619 }
2620 
2621 /**
2622  * g_strjoin:
2623  * @separator: (nullable): a string to insert between each of the
2624  *     strings, or %NULL
2625  * @...: a %NULL-terminated list of strings to join
2626  *
2627  * Joins a number of strings together to form one long string, with the
2628  * optional @separator inserted between each of them. The returned string
2629  * should be freed with g_free().
2630  *
2631  * Returns: a newly-allocated string containing all of the strings joined
2632  *     together, with @separator between them
2633  */
2634 gchar*
2635 g_strjoin (const gchar *separator,
2636            ...)
2637 {
2638   gchar *string, *s;
2639   va_list args;
2640   gsize len;
2641   gsize separator_len;
2642   gchar *ptr;
2643 
2644   if (separator == NULL)
2645     separator = &quot;&quot;;
2646 
2647   separator_len = strlen (separator);
2648 
2649   va_start (args, separator);
2650 
2651   s = va_arg (args, gchar*);
2652 
2653   if (s)
2654     {
2655       /* First part, getting length */
2656       len = 1 + strlen (s);
2657 
2658       s = va_arg (args, gchar*);
2659       while (s)
2660         {
2661           len += separator_len + strlen (s);
2662           s = va_arg (args, gchar*);
2663         }
2664       va_end (args);
2665 
2666       /* Second part, building string */
2667       string = g_new (gchar, len);
2668 
2669       va_start (args, separator);
2670 
2671       s = va_arg (args, gchar*);
2672       ptr = g_stpcpy (string, s);
2673 
2674       s = va_arg (args, gchar*);
2675       while (s)
2676         {
2677           ptr = g_stpcpy (ptr, separator);
2678           ptr = g_stpcpy (ptr, s);
2679           s = va_arg (args, gchar*);
2680         }
2681     }
2682   else
2683     string = g_strdup (&quot;&quot;);
2684 
2685   va_end (args);
2686 
2687   return string;
2688 }
2689 
2690 
2691 /**
2692  * g_strstr_len:
2693  * @haystack: a string
2694  * @haystack_len: the maximum length of @haystack. Note that -1 is
2695  *     a valid length, if @haystack is nul-terminated, meaning it will
2696  *     search through the whole string.
2697  * @needle: the string to search for
2698  *
2699  * Searches the string @haystack for the first occurrence
2700  * of the string @needle, limiting the length of the search
2701  * to @haystack_len.
2702  *
2703  * Returns: a pointer to the found occurrence, or
2704  *    %NULL if not found.
2705  */
2706 gchar *
2707 g_strstr_len (const gchar *haystack,
2708               gssize       haystack_len,
2709               const gchar *needle)
2710 {
2711   g_return_val_if_fail (haystack != NULL, NULL);
2712   g_return_val_if_fail (needle != NULL, NULL);
2713 
2714   if (haystack_len &lt; 0)
2715     return strstr (haystack, needle);
2716   else
2717     {
2718       const gchar *p = haystack;
2719       gsize needle_len = strlen (needle);
<a name="8" id="anc8"></a>
2720       const gchar *end;
2721       gsize i;
2722 
2723       if (needle_len == 0)
2724         return (gchar *)haystack;
2725 
<a name="9" id="anc9"></a><span class="line-modified">2726       if (haystack_len &lt; needle_len)</span>
2727         return NULL;
2728 
2729       end = haystack + haystack_len - needle_len;
2730 
2731       while (p &lt;= end &amp;&amp; *p)
2732         {
2733           for (i = 0; i &lt; needle_len; i++)
2734             if (p[i] != needle[i])
2735               goto next;
2736 
2737           return (gchar *)p;
2738 
2739         next:
2740           p++;
2741         }
2742 
2743       return NULL;
2744     }
2745 }
2746 
2747 /**
2748  * g_strrstr:
2749  * @haystack: a nul-terminated string
2750  * @needle: the nul-terminated string to search for
2751  *
2752  * Searches the string @haystack for the last occurrence
2753  * of the string @needle.
2754  *
2755  * Returns: a pointer to the found occurrence, or
2756  *    %NULL if not found.
2757  */
2758 gchar *
2759 g_strrstr (const gchar *haystack,
2760            const gchar *needle)
2761 {
2762   gsize i;
2763   gsize needle_len;
2764   gsize haystack_len;
2765   const gchar *p;
2766 
2767   g_return_val_if_fail (haystack != NULL, NULL);
2768   g_return_val_if_fail (needle != NULL, NULL);
2769 
2770   needle_len = strlen (needle);
2771   haystack_len = strlen (haystack);
2772 
2773   if (needle_len == 0)
2774     return (gchar *)haystack;
2775 
2776   if (haystack_len &lt; needle_len)
2777     return NULL;
2778 
2779   p = haystack + haystack_len - needle_len;
2780 
2781   while (p &gt;= haystack)
2782     {
2783       for (i = 0; i &lt; needle_len; i++)
2784         if (p[i] != needle[i])
2785           goto next;
2786 
2787       return (gchar *)p;
2788 
2789     next:
2790       p--;
2791     }
2792 
2793   return NULL;
2794 }
2795 
2796 /**
2797  * g_strrstr_len:
2798  * @haystack: a nul-terminated string
2799  * @haystack_len: the maximum length of @haystack
2800  * @needle: the nul-terminated string to search for
2801  *
2802  * Searches the string @haystack for the last occurrence
2803  * of the string @needle, limiting the length of the search
2804  * to @haystack_len.
2805  *
2806  * Returns: a pointer to the found occurrence, or
2807  *    %NULL if not found.
2808  */
2809 gchar *
2810 g_strrstr_len (const gchar *haystack,
2811                gssize        haystack_len,
2812                const gchar *needle)
2813 {
2814   g_return_val_if_fail (haystack != NULL, NULL);
2815   g_return_val_if_fail (needle != NULL, NULL);
2816 
2817   if (haystack_len &lt; 0)
2818     return g_strrstr (haystack, needle);
2819   else
2820     {
2821       gsize needle_len = strlen (needle);
2822       const gchar *haystack_max = haystack + haystack_len;
2823       const gchar *p = haystack;
2824       gsize i;
2825 
2826       while (p &lt; haystack_max &amp;&amp; *p)
2827         p++;
2828 
2829       if (p &lt; haystack + needle_len)
2830         return NULL;
2831 
2832       p -= needle_len;
2833 
2834       while (p &gt;= haystack)
2835         {
2836           for (i = 0; i &lt; needle_len; i++)
2837             if (p[i] != needle[i])
2838               goto next;
2839 
2840           return (gchar *)p;
2841 
2842         next:
2843           p--;
2844         }
2845 
2846       return NULL;
2847     }
2848 }
2849 
2850 
2851 /**
2852  * g_str_has_suffix:
2853  * @str: a nul-terminated string
2854  * @suffix: the nul-terminated suffix to look for
2855  *
2856  * Looks whether the string @str ends with @suffix.
2857  *
2858  * Returns: %TRUE if @str end with @suffix, %FALSE otherwise.
2859  *
2860  * Since: 2.2
2861  */
2862 gboolean
2863 g_str_has_suffix (const gchar *str,
2864                   const gchar *suffix)
2865 {
2866   gsize str_len;
2867   gsize suffix_len;
2868 
2869   g_return_val_if_fail (str != NULL, FALSE);
2870   g_return_val_if_fail (suffix != NULL, FALSE);
2871 
2872   str_len = strlen (str);
2873   suffix_len = strlen (suffix);
2874 
2875   if (str_len &lt; suffix_len)
2876     return FALSE;
2877 
2878   return strcmp (str + str_len - suffix_len, suffix) == 0;
2879 }
2880 
2881 /**
2882  * g_str_has_prefix:
2883  * @str: a nul-terminated string
2884  * @prefix: the nul-terminated prefix to look for
2885  *
2886  * Looks whether the string @str begins with @prefix.
2887  *
2888  * Returns: %TRUE if @str begins with @prefix, %FALSE otherwise.
2889  *
2890  * Since: 2.2
2891  */
2892 gboolean
2893 g_str_has_prefix (const gchar *str,
2894                   const gchar *prefix)
2895 {
2896   g_return_val_if_fail (str != NULL, FALSE);
2897   g_return_val_if_fail (prefix != NULL, FALSE);
2898 
2899   return strncmp (str, prefix, strlen (prefix)) == 0;
2900 }
2901 
2902 /**
2903  * g_strv_length:
2904  * @str_array: a %NULL-terminated array of strings
2905  *
2906  * Returns the length of the given %NULL-terminated
2907  * string array @str_array. @str_array must not be %NULL.
2908  *
2909  * Returns: length of @str_array.
2910  *
2911  * Since: 2.6
2912  */
2913 guint
2914 g_strv_length (gchar **str_array)
2915 {
2916   guint i = 0;
2917 
2918   g_return_val_if_fail (str_array != NULL, 0);
2919 
2920   while (str_array[i])
2921     ++i;
2922 
2923   return i;
2924 }
2925 
2926 static void
2927 index_add_folded (GPtrArray   *array,
2928                   const gchar *start,
2929                   const gchar *end)
2930 {
2931   gchar *normal;
2932 
2933   normal = g_utf8_normalize (start, end - start, G_NORMALIZE_ALL_COMPOSE);
2934 
2935   /* TODO: Invent time machine.  Converse with Mustafa Ataturk... */
2936   if (strstr (normal, &quot;i&quot;) || strstr (normal, &quot;I&quot;))
2937     {
2938       gchar *s = normal;
2939       GString *tmp;
2940 
2941       tmp = g_string_new (NULL);
2942 
2943       while (*s)
2944         {
2945           gchar *i, *I, *e;
2946 
2947           i = strstr (s, &quot;i&quot;);
2948           I = strstr (s, &quot;I&quot;);
2949 
2950           if (!i &amp;&amp; !I)
2951             break;
2952           else if (i &amp;&amp; !I)
2953             e = i;
2954           else if (I &amp;&amp; !i)
2955             e = I;
2956           else if (i &lt; I)
2957             e = i;
2958           else
2959             e = I;
2960 
2961           g_string_append_len (tmp, s, e - s);
2962           g_string_append_c (tmp, &#39;i&#39;);
2963           s = g_utf8_next_char (e);
2964         }
2965 
2966       g_string_append (tmp, s);
2967       g_free (normal);
2968       normal = g_string_free (tmp, FALSE);
2969     }
2970 
2971   g_ptr_array_add (array, g_utf8_casefold (normal, -1));
2972   g_free (normal);
2973 }
2974 
2975 static gchar **
2976 split_words (const gchar *value)
2977 {
2978   const gchar *start = NULL;
2979   GPtrArray *result;
2980   const gchar *s;
2981 
2982   result = g_ptr_array_new ();
2983 
2984   for (s = value; *s; s = g_utf8_next_char (s))
2985     {
2986       gunichar c = g_utf8_get_char (s);
2987 
2988       if (start == NULL)
2989         {
2990           if (g_unichar_isalnum (c) || g_unichar_ismark (c))
2991             start = s;
2992         }
2993       else
2994         {
2995           if (!g_unichar_isalnum (c) &amp;&amp; !g_unichar_ismark (c))
2996             {
2997               index_add_folded (result, start, s);
2998               start = NULL;
2999             }
3000         }
3001     }
3002 
3003   if (start)
3004     index_add_folded (result, start, s);
3005 
3006   g_ptr_array_add (result, NULL);
3007 
3008   return (gchar **) g_ptr_array_free (result, FALSE);
3009 }
3010 
3011 /**
3012  * g_str_tokenize_and_fold:
3013  * @string: a string
3014  * @translit_locale: (nullable): the language code (like &#39;de&#39; or
3015  *   &#39;en_GB&#39;) from which @string originates
3016  * @ascii_alternates: (out) (transfer full) (array zero-terminated=1): a
3017  *   return location for ASCII alternates
3018  *
3019  * Tokenises @string and performs folding on each token.
3020  *
3021  * A token is a non-empty sequence of alphanumeric characters in the
3022  * source string, separated by non-alphanumeric characters.  An
3023  * &quot;alphanumeric&quot; character for this purpose is one that matches
3024  * g_unichar_isalnum() or g_unichar_ismark().
3025  *
3026  * Each token is then (Unicode) normalised and case-folded.  If
3027  * @ascii_alternates is non-%NULL and some of the returned tokens
3028  * contain non-ASCII characters, ASCII alternatives will be generated.
3029  *
3030  * The number of ASCII alternatives that are generated and the method
3031  * for doing so is unspecified, but @translit_locale (if specified) may
3032  * improve the transliteration if the language of the source string is
3033  * known.
3034  *
3035  * Returns: (transfer full) (array zero-terminated=1): the folded tokens
3036  *
3037  * Since: 2.40
3038  **/
3039 gchar **
3040 g_str_tokenize_and_fold (const gchar   *string,
3041                          const gchar   *translit_locale,
3042                          gchar       ***ascii_alternates)
3043 {
3044   gchar **result;
3045 
3046   g_return_val_if_fail (string != NULL, NULL);
3047 
3048   if (ascii_alternates &amp;&amp; g_str_is_ascii (string))
3049     {
3050       *ascii_alternates = g_new0 (gchar *, 0 + 1);
3051       ascii_alternates = NULL;
3052     }
3053 
3054   result = split_words (string);
3055 
3056   if (ascii_alternates)
3057     {
3058       gint i, j, n;
3059 
3060       n = g_strv_length (result);
3061       *ascii_alternates = g_new (gchar *, n + 1);
3062       j = 0;
3063 
3064       for (i = 0; i &lt; n; i++)
3065         {
3066           if (!g_str_is_ascii (result[i]))
3067             {
3068               gchar *composed;
3069               gchar *ascii;
3070               gint k;
3071 
3072               composed = g_utf8_normalize (result[i], -1, G_NORMALIZE_ALL_COMPOSE);
3073 
3074               ascii = g_str_to_ascii (composed, translit_locale);
3075 
3076               /* Only accept strings that are now entirely alnums */
3077               for (k = 0; ascii[k]; k++)
3078                 if (!g_ascii_isalnum (ascii[k]))
3079                   break;
3080 
3081               if (ascii[k] == &#39;\0&#39;)
3082                 /* Made it to the end... */
3083                 (*ascii_alternates)[j++] = ascii;
3084               else
3085                 g_free (ascii);
3086 
3087               g_free (composed);
3088             }
3089         }
3090 
3091       (*ascii_alternates)[j] = NULL;
3092     }
3093 
3094   return result;
3095 }
3096 
3097 /**
3098  * g_str_match_string:
3099  * @search_term: the search term from the user
3100  * @potential_hit: the text that may be a hit
3101  * @accept_alternates: %TRUE to accept ASCII alternates
3102  *
3103  * Checks if a search conducted for @search_term should match
3104  * @potential_hit.
3105  *
3106  * This function calls g_str_tokenize_and_fold() on both
3107  * @search_term and @potential_hit.  ASCII alternates are never taken
3108  * for @search_term but will be taken for @potential_hit according to
3109  * the value of @accept_alternates.
3110  *
3111  * A hit occurs when each folded token in @search_term is a prefix of a
3112  * folded token from @potential_hit.
3113  *
3114  * Depending on how you&#39;re performing the search, it will typically be
3115  * faster to call g_str_tokenize_and_fold() on each string in
3116  * your corpus and build an index on the returned folded tokens, then
3117  * call g_str_tokenize_and_fold() on the search term and
3118  * perform lookups into that index.
3119  *
3120  * As some examples, searching for &quot;fred&quot; would match the potential hit
3121  * &quot;Smith, Fred&quot; and also &quot;Frederic&quot;.  Searching for &quot;Fred&quot; would match
3122  * &quot;Frederic&quot; but not &quot;Frederic&quot; (due to the one-directional nature of
3123  * accent matching).  Searching &quot;fo&quot; would match &quot;Foo&quot; and &quot;Bar Foo
3124  * Baz&quot;, but not &quot;SFO&quot; (because no word as &quot;fo&quot; as a prefix).
3125  *
3126  * Returns: %TRUE if @potential_hit is a hit
3127  *
3128  * Since: 2.40
3129  **/
3130 gboolean
3131 g_str_match_string (const gchar *search_term,
3132                     const gchar *potential_hit,
3133                     gboolean     accept_alternates)
3134 {
3135   gchar **alternates = NULL;
3136   gchar **term_tokens;
3137   gchar **hit_tokens;
3138   gboolean matched;
3139   gint i, j;
3140 
3141   g_return_val_if_fail (search_term != NULL, FALSE);
3142   g_return_val_if_fail (potential_hit != NULL, FALSE);
3143 
3144   term_tokens = g_str_tokenize_and_fold (search_term, NULL, NULL);
3145   hit_tokens = g_str_tokenize_and_fold (potential_hit, NULL, accept_alternates ? &amp;alternates : NULL);
3146 
3147   matched = TRUE;
3148 
3149   for (i = 0; term_tokens[i]; i++)
3150     {
3151       for (j = 0; hit_tokens[j]; j++)
3152         if (g_str_has_prefix (hit_tokens[j], term_tokens[i]))
3153           goto one_matched;
3154 
3155       if (accept_alternates)
3156         for (j = 0; alternates[j]; j++)
3157           if (g_str_has_prefix (alternates[j], term_tokens[i]))
3158             goto one_matched;
3159 
3160       matched = FALSE;
3161       break;
3162 
3163 one_matched:
3164       continue;
3165     }
3166 
3167   g_strfreev (term_tokens);
3168   g_strfreev (hit_tokens);
3169   g_strfreev (alternates);
3170 
3171   return matched;
3172 }
3173 
3174 /**
3175  * g_strv_contains:
3176  * @strv: a %NULL-terminated array of strings
3177  * @str: a string
3178  *
3179  * Checks if @strv contains @str. @strv must not be %NULL.
3180  *
3181  * Returns: %TRUE if @str is an element of @strv, according to g_str_equal().
3182  *
3183  * Since: 2.44
3184  */
3185 gboolean
3186 g_strv_contains (const gchar * const *strv,
3187                  const gchar         *str)
3188 {
3189   g_return_val_if_fail (strv != NULL, FALSE);
3190   g_return_val_if_fail (str != NULL, FALSE);
3191 
3192   for (; *strv != NULL; strv++)
3193     {
3194       if (g_str_equal (str, *strv))
3195         return TRUE;
3196     }
3197 
3198   return FALSE;
3199 }
3200 
<a name="10" id="anc10"></a>

































3201 static gboolean
3202 str_has_sign (const gchar *str)
3203 {
3204   return str[0] == &#39;-&#39; || str[0] == &#39;+&#39;;
3205 }
3206 
3207 static gboolean
3208 str_has_hex_prefix (const gchar *str)
3209 {
3210   return str[0] == &#39;0&#39; &amp;&amp; g_ascii_tolower (str[1]) == &#39;x&#39;;
3211 }
3212 
3213 /**
3214  * g_ascii_string_to_signed:
3215  * @str: a string
3216  * @base: base of a parsed number
3217  * @min: a lower bound (inclusive)
3218  * @max: an upper bound (inclusive)
3219  * @out_num: (out) (optional): a return location for a number
3220  * @error: a return location for #GError
3221  *
3222  * A convenience function for converting a string to a signed number.
3223  *
3224  * This function assumes that @str contains only a number of the given
3225  * @base that is within inclusive bounds limited by @min and @max. If
3226  * this is true, then the converted number is stored in @out_num. An
3227  * empty string is not a valid input. A string with leading or
3228  * trailing whitespace is also an invalid input.
3229  *
3230  * @base can be between 2 and 36 inclusive. Hexadecimal numbers must
3231  * not be prefixed with &quot;0x&quot; or &quot;0X&quot;. Such a problem does not exist
3232  * for octal numbers, since they were usually prefixed with a zero
3233  * which does not change the value of the parsed number.
3234  *
3235  * Parsing failures result in an error with the %G_NUMBER_PARSER_ERROR
3236  * domain. If the input is invalid, the error code will be
3237  * %G_NUMBER_PARSER_ERROR_INVALID. If the parsed number is out of
3238  * bounds - %G_NUMBER_PARSER_ERROR_OUT_OF_BOUNDS.
3239  *
3240  * See g_ascii_strtoll() if you have more complex needs such as
3241  * parsing a string which starts with a number, but then has other
3242  * characters.
3243  *
3244  * Returns: %TRUE if @str was a number, otherwise %FALSE.
3245  *
3246  * Since: 2.54
3247  */
3248 gboolean
3249 g_ascii_string_to_signed (const gchar  *str,
3250                           guint         base,
3251                           gint64        min,
3252                           gint64        max,
3253                           gint64       *out_num,
3254                           GError      **error)
3255 {
3256   gint64 number;
3257   const gchar *end_ptr = NULL;
3258   gint saved_errno = 0;
3259 
3260   g_return_val_if_fail (str != NULL, FALSE);
3261   g_return_val_if_fail (base &gt;= 2 &amp;&amp; base &lt;= 36, FALSE);
3262   g_return_val_if_fail (min &lt;= max, FALSE);
3263   g_return_val_if_fail (error == NULL || *error == NULL, FALSE);
3264 
3265   if (str[0] == &#39;\0&#39;)
3266     {
3267       g_set_error_literal (error,
3268                            G_NUMBER_PARSER_ERROR, G_NUMBER_PARSER_ERROR_INVALID,
3269                            _(&quot;Empty string is not a number&quot;));
3270       return FALSE;
3271     }
3272 
3273   errno = 0;
3274   number = g_ascii_strtoll (str, (gchar **)&amp;end_ptr, base);
3275   saved_errno = errno;
3276 
3277   if (/* We do not allow leading whitespace, but g_ascii_strtoll
3278        * accepts it and just skips it, so we need to check for it
3279        * ourselves.
3280        */
3281       g_ascii_isspace (str[0]) ||
3282       /* We don&#39;t support hexadecimal numbers prefixed with 0x or
3283        * 0X.
3284        */
3285       (base == 16 &amp;&amp;
3286        (str_has_sign (str) ? str_has_hex_prefix (str + 1) : str_has_hex_prefix (str))) ||
3287       (saved_errno != 0 &amp;&amp; saved_errno != ERANGE) ||
3288       end_ptr == NULL ||
3289       *end_ptr != &#39;\0&#39;)
3290     {
3291       g_set_error (error,
3292                    G_NUMBER_PARSER_ERROR, G_NUMBER_PARSER_ERROR_INVALID,
3293                    _(&quot;&#39;%s&#39; is not a signed number&quot;), str);
3294       return FALSE;
3295     }
3296   if (saved_errno == ERANGE || number &lt; min || number &gt; max)
3297     {
3298       gchar *min_str = g_strdup_printf (&quot;%&quot; G_GINT64_FORMAT, min);
3299       gchar *max_str = g_strdup_printf (&quot;%&quot; G_GINT64_FORMAT, max);
3300 
3301       g_set_error (error,
3302                    G_NUMBER_PARSER_ERROR, G_NUMBER_PARSER_ERROR_OUT_OF_BOUNDS,
3303                    _(&quot;Number &#39;%s&#39; is out of bounds [%s, %s]&quot;),
3304                    str, min_str, max_str);
3305       g_free (min_str);
3306       g_free (max_str);
3307       return FALSE;
3308     }
3309   if (out_num != NULL)
3310     *out_num = number;
3311   return TRUE;
3312 }
3313 
3314 /**
3315  * g_ascii_string_to_unsigned:
3316  * @str: a string
3317  * @base: base of a parsed number
3318  * @min: a lower bound (inclusive)
3319  * @max: an upper bound (inclusive)
3320  * @out_num: (out) (optional): a return location for a number
3321  * @error: a return location for #GError
3322  *
3323  * A convenience function for converting a string to an unsigned number.
3324  *
3325  * This function assumes that @str contains only a number of the given
3326  * @base that is within inclusive bounds limited by @min and @max. If
3327  * this is true, then the converted number is stored in @out_num. An
3328  * empty string is not a valid input. A string with leading or
<a name="11" id="anc11"></a><span class="line-modified">3329  * trailing whitespace is also an invalid input.</span>

3330  *
3331  * @base can be between 2 and 36 inclusive. Hexadecimal numbers must
3332  * not be prefixed with &quot;0x&quot; or &quot;0X&quot;. Such a problem does not exist
3333  * for octal numbers, since they were usually prefixed with a zero
3334  * which does not change the value of the parsed number.
3335  *
3336  * Parsing failures result in an error with the %G_NUMBER_PARSER_ERROR
3337  * domain. If the input is invalid, the error code will be
3338  * %G_NUMBER_PARSER_ERROR_INVALID. If the parsed number is out of
3339  * bounds - %G_NUMBER_PARSER_ERROR_OUT_OF_BOUNDS.
3340  *
3341  * See g_ascii_strtoull() if you have more complex needs such as
3342  * parsing a string which starts with a number, but then has other
3343  * characters.
3344  *
3345  * Returns: %TRUE if @str was a number, otherwise %FALSE.
3346  *
3347  * Since: 2.54
3348  */
3349 gboolean
3350 g_ascii_string_to_unsigned (const gchar  *str,
3351                             guint         base,
3352                             guint64       min,
3353                             guint64       max,
3354                             guint64      *out_num,
3355                             GError      **error)
3356 {
3357   guint64 number;
3358   const gchar *end_ptr = NULL;
3359   gint saved_errno = 0;
3360 
3361   g_return_val_if_fail (str != NULL, FALSE);
3362   g_return_val_if_fail (base &gt;= 2 &amp;&amp; base &lt;= 36, FALSE);
3363   g_return_val_if_fail (min &lt;= max, FALSE);
3364   g_return_val_if_fail (error == NULL || *error == NULL, FALSE);
3365 
3366   if (str[0] == &#39;\0&#39;)
3367     {
3368       g_set_error_literal (error,
3369                            G_NUMBER_PARSER_ERROR, G_NUMBER_PARSER_ERROR_INVALID,
3370                            _(&quot;Empty string is not a number&quot;));
3371       return FALSE;
3372     }
3373 
3374   errno = 0;
3375   number = g_ascii_strtoull (str, (gchar **)&amp;end_ptr, base);
3376   saved_errno = errno;
3377 
3378   if (/* We do not allow leading whitespace, but g_ascii_strtoull
3379        * accepts it and just skips it, so we need to check for it
3380        * ourselves.
3381        */
3382       g_ascii_isspace (str[0]) ||
3383       /* Unsigned number should have no sign.
3384        */
3385       str_has_sign (str) ||
3386       /* We don&#39;t support hexadecimal numbers prefixed with 0x or
3387        * 0X.
3388        */
3389       (base == 16 &amp;&amp; str_has_hex_prefix (str)) ||
3390       (saved_errno != 0 &amp;&amp; saved_errno != ERANGE) ||
3391       end_ptr == NULL ||
3392       *end_ptr != &#39;\0&#39;)
3393     {
3394       g_set_error (error,
3395                    G_NUMBER_PARSER_ERROR, G_NUMBER_PARSER_ERROR_INVALID,
3396                    _(&quot;&#39;%s&#39; is not an unsigned number&quot;), str);
3397       return FALSE;
3398     }
3399   if (saved_errno == ERANGE || number &lt; min || number &gt; max)
3400     {
3401       gchar *min_str = g_strdup_printf (&quot;%&quot; G_GUINT64_FORMAT, min);
3402       gchar *max_str = g_strdup_printf (&quot;%&quot; G_GUINT64_FORMAT, max);
3403 
3404       g_set_error (error,
3405                    G_NUMBER_PARSER_ERROR, G_NUMBER_PARSER_ERROR_OUT_OF_BOUNDS,
3406                    _(&quot;Number &#39;%s&#39; is out of bounds [%s, %s]&quot;),
3407                    str, min_str, max_str);
3408       g_free (min_str);
3409       g_free (max_str);
3410       return FALSE;
3411     }
3412   if (out_num != NULL)
3413     *out_num = number;
3414   return TRUE;
3415 }
3416 
3417 G_DEFINE_QUARK (g-number-parser-error-quark, g_number_parser_error)
<a name="12" id="anc12"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="12" type="hidden" />
</body>
</html>