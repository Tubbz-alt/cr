<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.media/src/main/native/gstreamer/3rd_party/glib/glib/gvariant.c</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
<a name="1" id="anc1"></a><span class="line-modified">   2  * Copyright � 2007, 2008 Ryan Lortie</span>
<span class="line-modified">   3  * Copyright � 2010 Codethink Limited</span>
   4  *
   5  * This library is free software; you can redistribute it and/or
   6  * modify it under the terms of the GNU Lesser General Public
   7  * License as published by the Free Software Foundation; either
   8  * version 2.1 of the License, or (at your option) any later version.
   9  *
  10  * This library is distributed in the hope that it will be useful,
  11  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  12  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
  13  * Lesser General Public License for more details.
  14  *
  15  * You should have received a copy of the GNU Lesser General Public
  16  * License along with this library; if not, see &lt;http://www.gnu.org/licenses/&gt;.
  17  *
  18  * Author: Ryan Lortie &lt;desrt@desrt.ca&gt;
  19  */
  20 
  21 /* Prologue {{{1 */
  22 
  23 #include &quot;config.h&quot;
  24 
  25 #include &lt;glib/gvariant-serialiser.h&gt;
  26 #include &quot;gvariant-internal.h&quot;
  27 #include &lt;glib/gvariant-core.h&gt;
  28 #include &lt;glib/gtestutils.h&gt;
  29 #include &lt;glib/gstrfuncs.h&gt;
  30 #include &lt;glib/gslice.h&gt;
  31 #include &lt;glib/ghash.h&gt;
  32 #include &lt;glib/gmem.h&gt;
  33 
  34 #include &lt;string.h&gt;
  35 
  36 
  37 /**
  38  * SECTION:gvariant
  39  * @title: GVariant
  40  * @short_description: strongly typed value datatype
  41  * @see_also: GVariantType
  42  *
  43  * #GVariant is a variant datatype; it can contain one or more values
  44  * along with information about the type of the values.
  45  *
  46  * A #GVariant may contain simple types, like an integer, or a boolean value;
  47  * or complex types, like an array of two strings, or a dictionary of key
  48  * value pairs. A #GVariant is also immutable: once it&#39;s been created neither
  49  * its type nor its content can be modified further.
  50  *
  51  * GVariant is useful whenever data needs to be serialized, for example when
  52  * sending method parameters in DBus, or when saving settings using GSettings.
  53  *
  54  * When creating a new #GVariant, you pass the data you want to store in it
  55  * along with a string representing the type of data you wish to pass to it.
  56  *
  57  * For instance, if you want to create a #GVariant holding an integer value you
  58  * can use:
  59  *
  60  * |[&lt;!-- language=&quot;C&quot; --&gt;
  61  *   GVariant *v = g_variant_new (&quot;u&quot;, 40);
  62  * ]|
  63  *
  64  * The string &quot;u&quot; in the first argument tells #GVariant that the data passed to
  65  * the constructor (40) is going to be an unsigned integer.
  66  *
  67  * More advanced examples of #GVariant in use can be found in documentation for
  68  * [GVariant format strings][gvariant-format-strings-pointers].
  69  *
  70  * The range of possible values is determined by the type.
  71  *
  72  * The type system used by #GVariant is #GVariantType.
  73  *
  74  * #GVariant instances always have a type and a value (which are given
  75  * at construction time).  The type and value of a #GVariant instance
  76  * can never change other than by the #GVariant itself being
  77  * destroyed.  A #GVariant cannot contain a pointer.
  78  *
  79  * #GVariant is reference counted using g_variant_ref() and
  80  * g_variant_unref().  #GVariant also has floating reference counts --
  81  * see g_variant_ref_sink().
  82  *
  83  * #GVariant is completely threadsafe.  A #GVariant instance can be
  84  * concurrently accessed in any way from any number of threads without
  85  * problems.
  86  *
  87  * #GVariant is heavily optimised for dealing with data in serialised
  88  * form.  It works particularly well with data located in memory-mapped
  89  * files.  It can perform nearly all deserialisation operations in a
  90  * small constant time, usually touching only a single memory page.
  91  * Serialised #GVariant data can also be sent over the network.
  92  *
  93  * #GVariant is largely compatible with D-Bus.  Almost all types of
  94  * #GVariant instances can be sent over D-Bus.  See #GVariantType for
  95  * exceptions.  (However, #GVariant&#39;s serialisation format is not the same
  96  * as the serialisation format of a D-Bus message body: use #GDBusMessage,
  97  * in the gio library, for those.)
  98  *
  99  * For space-efficiency, the #GVariant serialisation format does not
 100  * automatically include the variant&#39;s length, type or endianness,
 101  * which must either be implied from context (such as knowledge that a
 102  * particular file format always contains a little-endian
 103  * %G_VARIANT_TYPE_VARIANT which occupies the whole length of the file)
 104  * or supplied out-of-band (for instance, a length, type and/or endianness
 105  * indicator could be placed at the beginning of a file, network message
 106  * or network stream).
 107  *
 108  * A #GVariant&#39;s size is limited mainly by any lower level operating
 109  * system constraints, such as the number of bits in #gsize.  For
 110  * example, it is reasonable to have a 2GB file mapped into memory
 111  * with #GMappedFile, and call g_variant_new_from_data() on it.
 112  *
 113  * For convenience to C programmers, #GVariant features powerful
 114  * varargs-based value construction and destruction.  This feature is
 115  * designed to be embedded in other libraries.
 116  *
 117  * There is a Python-inspired text language for describing #GVariant
 118  * values.  #GVariant includes a printer for this language and a parser
 119  * with type inferencing.
 120  *
 121  * ## Memory Use
 122  *
 123  * #GVariant tries to be quite efficient with respect to memory use.
 124  * This section gives a rough idea of how much memory is used by the
 125  * current implementation.  The information here is subject to change
 126  * in the future.
 127  *
 128  * The memory allocated by #GVariant can be grouped into 4 broad
 129  * purposes: memory for serialised data, memory for the type
 130  * information cache, buffer management memory and memory for the
 131  * #GVariant structure itself.
 132  *
 133  * ## Serialised Data Memory
 134  *
 135  * This is the memory that is used for storing GVariant data in
 136  * serialised form.  This is what would be sent over the network or
 137  * what would end up on disk, not counting any indicator of the
 138  * endianness, or of the length or type of the top-level variant.
 139  *
 140  * The amount of memory required to store a boolean is 1 byte. 16,
 141  * 32 and 64 bit integers and double precision floating point numbers
 142  * use their &quot;natural&quot; size.  Strings (including object path and
 143  * signature strings) are stored with a nul terminator, and as such
 144  * use the length of the string plus 1 byte.
 145  *
 146  * Maybe types use no space at all to represent the null value and
 147  * use the same amount of space (sometimes plus one byte) as the
 148  * equivalent non-maybe-typed value to represent the non-null case.
 149  *
 150  * Arrays use the amount of space required to store each of their
 151  * members, concatenated.  Additionally, if the items stored in an
 152  * array are not of a fixed-size (ie: strings, other arrays, etc)
 153  * then an additional framing offset is stored for each item.  The
 154  * size of this offset is either 1, 2 or 4 bytes depending on the
 155  * overall size of the container.  Additionally, extra padding bytes
 156  * are added as required for alignment of child values.
 157  *
 158  * Tuples (including dictionary entries) use the amount of space
 159  * required to store each of their members, concatenated, plus one
 160  * framing offset (as per arrays) for each non-fixed-sized item in
 161  * the tuple, except for the last one.  Additionally, extra padding
 162  * bytes are added as required for alignment of child values.
 163  *
 164  * Variants use the same amount of space as the item inside of the
 165  * variant, plus 1 byte, plus the length of the type string for the
 166  * item inside the variant.
 167  *
 168  * As an example, consider a dictionary mapping strings to variants.
 169  * In the case that the dictionary is empty, 0 bytes are required for
 170  * the serialisation.
 171  *
 172  * If we add an item &quot;width&quot; that maps to the int32 value of 500 then
 173  * we will use 4 byte to store the int32 (so 6 for the variant
 174  * containing it) and 6 bytes for the string.  The variant must be
 175  * aligned to 8 after the 6 bytes of the string, so that&#39;s 2 extra
 176  * bytes.  6 (string) + 2 (padding) + 6 (variant) is 14 bytes used
 177  * for the dictionary entry.  An additional 1 byte is added to the
 178  * array as a framing offset making a total of 15 bytes.
 179  *
 180  * If we add another entry, &quot;title&quot; that maps to a nullable string
 181  * that happens to have a value of null, then we use 0 bytes for the
 182  * null value (and 3 bytes for the variant to contain it along with
 183  * its type string) plus 6 bytes for the string.  Again, we need 2
 184  * padding bytes.  That makes a total of 6 + 2 + 3 = 11 bytes.
 185  *
 186  * We now require extra padding between the two items in the array.
 187  * After the 14 bytes of the first item, that&#39;s 2 bytes required.
 188  * We now require 2 framing offsets for an extra two
 189  * bytes. 14 + 2 + 11 + 2 = 29 bytes to encode the entire two-item
 190  * dictionary.
 191  *
 192  * ## Type Information Cache
 193  *
 194  * For each GVariant type that currently exists in the program a type
 195  * information structure is kept in the type information cache.  The
 196  * type information structure is required for rapid deserialisation.
 197  *
 198  * Continuing with the above example, if a #GVariant exists with the
 199  * type &quot;a{sv}&quot; then a type information struct will exist for
 200  * &quot;a{sv}&quot;, &quot;{sv}&quot;, &quot;s&quot;, and &quot;v&quot;.  Multiple uses of the same type
 201  * will share the same type information.  Additionally, all
 202  * single-digit types are stored in read-only static memory and do
 203  * not contribute to the writable memory footprint of a program using
 204  * #GVariant.
 205  *
 206  * Aside from the type information structures stored in read-only
 207  * memory, there are two forms of type information.  One is used for
 208  * container types where there is a single element type: arrays and
 209  * maybe types.  The other is used for container types where there
 210  * are multiple element types: tuples and dictionary entries.
 211  *
 212  * Array type info structures are 6 * sizeof (void *), plus the
 213  * memory required to store the type string itself.  This means that
 214  * on 32-bit systems, the cache entry for &quot;a{sv}&quot; would require 30
 215  * bytes of memory (plus malloc overhead).
 216  *
 217  * Tuple type info structures are 6 * sizeof (void *), plus 4 *
 218  * sizeof (void *) for each item in the tuple, plus the memory
 219  * required to store the type string itself.  A 2-item tuple, for
 220  * example, would have a type information structure that consumed
 221  * writable memory in the size of 14 * sizeof (void *) (plus type
 222  * string)  This means that on 32-bit systems, the cache entry for
 223  * &quot;{sv}&quot; would require 61 bytes of memory (plus malloc overhead).
 224  *
 225  * This means that in total, for our &quot;a{sv}&quot; example, 91 bytes of
 226  * type information would be allocated.
 227  *
 228  * The type information cache, additionally, uses a #GHashTable to
<a name="2" id="anc2"></a><span class="line-modified"> 229  * store and lookup the cached items and stores a pointer to this</span>
 230  * hash table in static storage.  The hash table is freed when there
 231  * are zero items in the type cache.
 232  *
 233  * Although these sizes may seem large it is important to remember
 234  * that a program will probably only have a very small number of
 235  * different types of values in it and that only one type information
 236  * structure is required for many different values of the same type.
 237  *
 238  * ## Buffer Management Memory
 239  *
 240  * #GVariant uses an internal buffer management structure to deal
 241  * with the various different possible sources of serialised data
 242  * that it uses.  The buffer is responsible for ensuring that the
 243  * correct call is made when the data is no longer in use by
 244  * #GVariant.  This may involve a g_free() or a g_slice_free() or
 245  * even g_mapped_file_unref().
 246  *
 247  * One buffer management structure is used for each chunk of
 248  * serialised data.  The size of the buffer management structure
 249  * is 4 * (void *).  On 32-bit systems, that&#39;s 16 bytes.
 250  *
 251  * ## GVariant structure
 252  *
 253  * The size of a #GVariant structure is 6 * (void *).  On 32-bit
 254  * systems, that&#39;s 24 bytes.
 255  *
 256  * #GVariant structures only exist if they are explicitly created
 257  * with API calls.  For example, if a #GVariant is constructed out of
 258  * serialised data for the example given above (with the dictionary)
 259  * then although there are 9 individual values that comprise the
 260  * entire dictionary (two keys, two values, two variants containing
 261  * the values, two dictionary entries, plus the dictionary itself),
 262  * only 1 #GVariant instance exists -- the one referring to the
 263  * dictionary.
 264  *
 265  * If calls are made to start accessing the other values then
 266  * #GVariant instances will exist for those values only for as long
 267  * as they are in use (ie: until you call g_variant_unref()).  The
 268  * type information is shared.  The serialised data and the buffer
 269  * management structure for that serialised data is shared by the
 270  * child.
 271  *
 272  * ## Summary
 273  *
 274  * To put the entire example together, for our dictionary mapping
 275  * strings to variants (with two entries, as given above), we are
 276  * using 91 bytes of memory for type information, 29 bytes of memory
 277  * for the serialised data, 16 bytes for buffer management and 24
 278  * bytes for the #GVariant instance, or a total of 160 bytes, plus
 279  * malloc overhead.  If we were to use g_variant_get_child_value() to
 280  * access the two dictionary entries, we would use an additional 48
 281  * bytes.  If we were to have other dictionaries of the same type, we
 282  * would use more memory for the serialised data and buffer
 283  * management for those dictionaries, but the type information would
 284  * be shared.
 285  */
 286 
 287 /* definition of GVariant structure is in gvariant-core.c */
 288 
 289 /* this is a g_return_val_if_fail() for making
 290  * sure a (GVariant *) has the required type.
 291  */
 292 #define TYPE_CHECK(value, TYPE, val) \
 293   if G_UNLIKELY (!g_variant_is_of_type (value, TYPE)) {           \
 294     g_return_if_fail_warning (G_LOG_DOMAIN, G_STRFUNC,            \
 295                               &quot;g_variant_is_of_type (&quot; #value     \
 296                               &quot;, &quot; #TYPE &quot;)&quot;);                    \
 297     return val;                                                   \
 298   }
 299 
 300 /* Numeric Type Constructor/Getters {{{1 */
 301 /* &lt; private &gt;
 302  * g_variant_new_from_trusted:
 303  * @type: the #GVariantType
 304  * @data: the data to use
 305  * @size: the size of @data
 306  *
 307  * Constructs a new trusted #GVariant instance from the provided data.
 308  * This is used to implement g_variant_new_* for all the basic types.
 309  *
<a name="3" id="anc3"></a>




 310  * Returns: a new floating #GVariant
 311  */
 312 static GVariant *
 313 g_variant_new_from_trusted (const GVariantType *type,
 314                             gconstpointer       data,
 315                             gsize               size)
 316 {
 317   GVariant *value;
 318   GBytes *bytes;
 319 
 320   bytes = g_bytes_new (data, size);
 321   value = g_variant_new_from_bytes (type, bytes, TRUE);
 322   g_bytes_unref (bytes);
 323 
 324   return value;
 325 }
 326 
 327 /**
 328  * g_variant_new_boolean:
 329  * @value: a #gboolean value
 330  *
 331  * Creates a new boolean #GVariant instance -- either %TRUE or %FALSE.
 332  *
 333  * Returns: (transfer none): a floating reference to a new boolean #GVariant instance
 334  *
 335  * Since: 2.24
 336  **/
 337 GVariant *
 338 g_variant_new_boolean (gboolean value)
 339 {
 340   guchar v = value;
 341 
 342   return g_variant_new_from_trusted (G_VARIANT_TYPE_BOOLEAN, &amp;v, 1);
 343 }
 344 
 345 /**
 346  * g_variant_get_boolean:
 347  * @value: a boolean #GVariant instance
 348  *
 349  * Returns the boolean value of @value.
 350  *
 351  * It is an error to call this function with a @value of any type
 352  * other than %G_VARIANT_TYPE_BOOLEAN.
 353  *
 354  * Returns: %TRUE or %FALSE
 355  *
 356  * Since: 2.24
 357  **/
 358 gboolean
 359 g_variant_get_boolean (GVariant *value)
 360 {
 361   const guchar *data;
 362 
 363   TYPE_CHECK (value, G_VARIANT_TYPE_BOOLEAN, FALSE);
 364 
 365   data = g_variant_get_data (value);
 366 
 367   return data != NULL ? *data != 0 : FALSE;
 368 }
 369 
 370 /* the constructors and accessors for byte, int{16,32,64}, handles and
 371  * doubles all look pretty much exactly the same, so we reduce
 372  * copy/pasting here.
 373  */
 374 #define NUMERIC_TYPE(TYPE, type, ctype) \
 375   GVariant *g_variant_new_##type (ctype value) {                \
 376     return g_variant_new_from_trusted (G_VARIANT_TYPE_##TYPE,   \
 377                                        &amp;value, sizeof value);   \
 378   }                                                             \
 379   ctype g_variant_get_##type (GVariant *value) {                \
 380     const ctype *data;                                          \
 381     TYPE_CHECK (value, G_VARIANT_TYPE_ ## TYPE, 0);             \
 382     data = g_variant_get_data (value);                          \
 383     return data != NULL ? *data : 0;                            \
 384   }
 385 
 386 
 387 /**
 388  * g_variant_new_byte:
 389  * @value: a #guint8 value
 390  *
 391  * Creates a new byte #GVariant instance.
 392  *
 393  * Returns: (transfer none): a floating reference to a new byte #GVariant instance
 394  *
 395  * Since: 2.24
 396  **/
 397 /**
 398  * g_variant_get_byte:
 399  * @value: a byte #GVariant instance
 400  *
 401  * Returns the byte value of @value.
 402  *
 403  * It is an error to call this function with a @value of any type
 404  * other than %G_VARIANT_TYPE_BYTE.
 405  *
 406  * Returns: a #guint8
 407  *
 408  * Since: 2.24
 409  **/
 410 NUMERIC_TYPE (BYTE, byte, guint8)
 411 
 412 /**
 413  * g_variant_new_int16:
 414  * @value: a #gint16 value
 415  *
 416  * Creates a new int16 #GVariant instance.
 417  *
 418  * Returns: (transfer none): a floating reference to a new int16 #GVariant instance
 419  *
 420  * Since: 2.24
 421  **/
 422 /**
 423  * g_variant_get_int16:
<a name="4" id="anc4"></a><span class="line-modified"> 424  * @value: a int16 #GVariant instance</span>
 425  *
 426  * Returns the 16-bit signed integer value of @value.
 427  *
 428  * It is an error to call this function with a @value of any type
 429  * other than %G_VARIANT_TYPE_INT16.
 430  *
 431  * Returns: a #gint16
 432  *
 433  * Since: 2.24
 434  **/
 435 NUMERIC_TYPE (INT16, int16, gint16)
 436 
 437 /**
 438  * g_variant_new_uint16:
 439  * @value: a #guint16 value
 440  *
 441  * Creates a new uint16 #GVariant instance.
 442  *
 443  * Returns: (transfer none): a floating reference to a new uint16 #GVariant instance
 444  *
 445  * Since: 2.24
 446  **/
 447 /**
 448  * g_variant_get_uint16:
 449  * @value: a uint16 #GVariant instance
 450  *
 451  * Returns the 16-bit unsigned integer value of @value.
 452  *
 453  * It is an error to call this function with a @value of any type
 454  * other than %G_VARIANT_TYPE_UINT16.
 455  *
 456  * Returns: a #guint16
 457  *
 458  * Since: 2.24
 459  **/
 460 NUMERIC_TYPE (UINT16, uint16, guint16)
 461 
 462 /**
 463  * g_variant_new_int32:
 464  * @value: a #gint32 value
 465  *
 466  * Creates a new int32 #GVariant instance.
 467  *
 468  * Returns: (transfer none): a floating reference to a new int32 #GVariant instance
 469  *
 470  * Since: 2.24
 471  **/
 472 /**
 473  * g_variant_get_int32:
<a name="5" id="anc5"></a><span class="line-modified"> 474  * @value: a int32 #GVariant instance</span>
 475  *
 476  * Returns the 32-bit signed integer value of @value.
 477  *
 478  * It is an error to call this function with a @value of any type
 479  * other than %G_VARIANT_TYPE_INT32.
 480  *
 481  * Returns: a #gint32
 482  *
 483  * Since: 2.24
 484  **/
 485 NUMERIC_TYPE (INT32, int32, gint32)
 486 
 487 /**
 488  * g_variant_new_uint32:
 489  * @value: a #guint32 value
 490  *
 491  * Creates a new uint32 #GVariant instance.
 492  *
 493  * Returns: (transfer none): a floating reference to a new uint32 #GVariant instance
 494  *
 495  * Since: 2.24
 496  **/
 497 /**
 498  * g_variant_get_uint32:
 499  * @value: a uint32 #GVariant instance
 500  *
 501  * Returns the 32-bit unsigned integer value of @value.
 502  *
 503  * It is an error to call this function with a @value of any type
 504  * other than %G_VARIANT_TYPE_UINT32.
 505  *
 506  * Returns: a #guint32
 507  *
 508  * Since: 2.24
 509  **/
 510 NUMERIC_TYPE (UINT32, uint32, guint32)
 511 
 512 /**
 513  * g_variant_new_int64:
 514  * @value: a #gint64 value
 515  *
 516  * Creates a new int64 #GVariant instance.
 517  *
 518  * Returns: (transfer none): a floating reference to a new int64 #GVariant instance
 519  *
 520  * Since: 2.24
 521  **/
 522 /**
 523  * g_variant_get_int64:
<a name="6" id="anc6"></a><span class="line-modified"> 524  * @value: a int64 #GVariant instance</span>
 525  *
 526  * Returns the 64-bit signed integer value of @value.
 527  *
 528  * It is an error to call this function with a @value of any type
 529  * other than %G_VARIANT_TYPE_INT64.
 530  *
 531  * Returns: a #gint64
 532  *
 533  * Since: 2.24
 534  **/
 535 NUMERIC_TYPE (INT64, int64, gint64)
 536 
 537 /**
 538  * g_variant_new_uint64:
 539  * @value: a #guint64 value
 540  *
 541  * Creates a new uint64 #GVariant instance.
 542  *
 543  * Returns: (transfer none): a floating reference to a new uint64 #GVariant instance
 544  *
 545  * Since: 2.24
 546  **/
 547 /**
 548  * g_variant_get_uint64:
 549  * @value: a uint64 #GVariant instance
 550  *
 551  * Returns the 64-bit unsigned integer value of @value.
 552  *
 553  * It is an error to call this function with a @value of any type
 554  * other than %G_VARIANT_TYPE_UINT64.
 555  *
 556  * Returns: a #guint64
 557  *
 558  * Since: 2.24
 559  **/
 560 NUMERIC_TYPE (UINT64, uint64, guint64)
 561 
 562 /**
 563  * g_variant_new_handle:
 564  * @value: a #gint32 value
 565  *
 566  * Creates a new handle #GVariant instance.
 567  *
 568  * By convention, handles are indexes into an array of file descriptors
 569  * that are sent alongside a D-Bus message.  If you&#39;re not interacting
 570  * with D-Bus, you probably don&#39;t need them.
 571  *
 572  * Returns: (transfer none): a floating reference to a new handle #GVariant instance
 573  *
 574  * Since: 2.24
 575  **/
 576 /**
 577  * g_variant_get_handle:
 578  * @value: a handle #GVariant instance
 579  *
 580  * Returns the 32-bit signed integer value of @value.
 581  *
 582  * It is an error to call this function with a @value of any type other
 583  * than %G_VARIANT_TYPE_HANDLE.
 584  *
 585  * By convention, handles are indexes into an array of file descriptors
 586  * that are sent alongside a D-Bus message.  If you&#39;re not interacting
 587  * with D-Bus, you probably don&#39;t need them.
 588  *
 589  * Returns: a #gint32
 590  *
 591  * Since: 2.24
 592  **/
 593 NUMERIC_TYPE (HANDLE, handle, gint32)
 594 
 595 /**
 596  * g_variant_new_double:
 597  * @value: a #gdouble floating point value
 598  *
 599  * Creates a new double #GVariant instance.
 600  *
 601  * Returns: (transfer none): a floating reference to a new double #GVariant instance
 602  *
 603  * Since: 2.24
 604  **/
 605 /**
 606  * g_variant_get_double:
 607  * @value: a double #GVariant instance
 608  *
 609  * Returns the double precision floating point value of @value.
 610  *
 611  * It is an error to call this function with a @value of any type
 612  * other than %G_VARIANT_TYPE_DOUBLE.
 613  *
 614  * Returns: a #gdouble
 615  *
 616  * Since: 2.24
 617  **/
 618 NUMERIC_TYPE (DOUBLE, double, gdouble)
 619 
 620 /* Container type Constructor / Deconstructors {{{1 */
 621 /**
 622  * g_variant_new_maybe:
 623  * @child_type: (nullable): the #GVariantType of the child, or %NULL
 624  * @child: (nullable): the child value, or %NULL
 625  *
 626  * Depending on if @child is %NULL, either wraps @child inside of a
 627  * maybe container or creates a Nothing instance for the given @type.
 628  *
 629  * At least one of @child_type and @child must be non-%NULL.
 630  * If @child_type is non-%NULL then it must be a definite type.
 631  * If they are both non-%NULL then @child_type must be the type
 632  * of @child.
 633  *
 634  * If @child is a floating reference (see g_variant_ref_sink()), the new
 635  * instance takes ownership of @child.
 636  *
 637  * Returns: (transfer none): a floating reference to a new #GVariant maybe instance
 638  *
 639  * Since: 2.24
 640  **/
 641 GVariant *
 642 g_variant_new_maybe (const GVariantType *child_type,
 643                      GVariant           *child)
 644 {
 645   GVariantType *maybe_type;
 646   GVariant *value;
 647 
 648   g_return_val_if_fail (child_type == NULL || g_variant_type_is_definite
 649                         (child_type), 0);
 650   g_return_val_if_fail (child_type != NULL || child != NULL, NULL);
 651   g_return_val_if_fail (child_type == NULL || child == NULL ||
 652                         g_variant_is_of_type (child, child_type),
 653                         NULL);
 654 
 655   if (child_type == NULL)
 656     child_type = g_variant_get_type (child);
 657 
 658   maybe_type = g_variant_type_new_maybe (child_type);
 659 
 660   if (child != NULL)
 661     {
 662       GVariant **children;
 663       gboolean trusted;
 664 
 665       children = g_new (GVariant *, 1);
 666       children[0] = g_variant_ref_sink (child);
 667       trusted = g_variant_is_trusted (children[0]);
 668 
 669       value = g_variant_new_from_children (maybe_type, children, 1, trusted);
 670     }
 671   else
 672     value = g_variant_new_from_children (maybe_type, NULL, 0, TRUE);
 673 
 674   g_variant_type_free (maybe_type);
 675 
 676   return value;
 677 }
 678 
 679 /**
 680  * g_variant_get_maybe:
 681  * @value: a maybe-typed value
 682  *
 683  * Given a maybe-typed #GVariant instance, extract its value.  If the
 684  * value is Nothing, then this function returns %NULL.
 685  *
 686  * Returns: (nullable) (transfer full): the contents of @value, or %NULL
 687  *
 688  * Since: 2.24
 689  **/
 690 GVariant *
 691 g_variant_get_maybe (GVariant *value)
 692 {
 693   TYPE_CHECK (value, G_VARIANT_TYPE_MAYBE, NULL);
 694 
 695   if (g_variant_n_children (value))
 696     return g_variant_get_child_value (value, 0);
 697 
 698   return NULL;
 699 }
 700 
 701 /**
 702  * g_variant_new_variant: (constructor)
 703  * @value: a #GVariant instance
 704  *
 705  * Boxes @value.  The result is a #GVariant instance representing a
 706  * variant containing the original value.
 707  *
 708  * If @child is a floating reference (see g_variant_ref_sink()), the new
 709  * instance takes ownership of @child.
 710  *
 711  * Returns: (transfer none): a floating reference to a new variant #GVariant instance
 712  *
 713  * Since: 2.24
 714  **/
 715 GVariant *
 716 g_variant_new_variant (GVariant *value)
 717 {
 718   g_return_val_if_fail (value != NULL, NULL);
 719 
 720   g_variant_ref_sink (value);
 721 
 722   return g_variant_new_from_children (G_VARIANT_TYPE_VARIANT,
 723                                       g_memdup (&amp;value, sizeof value),
 724                                       1, g_variant_is_trusted (value));
 725 }
 726 
 727 /**
 728  * g_variant_get_variant:
 729  * @value: a variant #GVariant instance
 730  *
 731  * Unboxes @value.  The result is the #GVariant instance that was
 732  * contained in @value.
 733  *
 734  * Returns: (transfer full): the item contained in the variant
 735  *
 736  * Since: 2.24
 737  **/
 738 GVariant *
 739 g_variant_get_variant (GVariant *value)
 740 {
 741   TYPE_CHECK (value, G_VARIANT_TYPE_VARIANT, NULL);
 742 
 743   return g_variant_get_child_value (value, 0);
 744 }
 745 
 746 /**
 747  * g_variant_new_array:
 748  * @child_type: (nullable): the element type of the new array
 749  * @children: (nullable) (array length=n_children): an array of
 750  *            #GVariant pointers, the children
 751  * @n_children: the length of @children
 752  *
 753  * Creates a new #GVariant array from @children.
 754  *
 755  * @child_type must be non-%NULL if @n_children is zero.  Otherwise, the
 756  * child type is determined by inspecting the first element of the
 757  * @children array.  If @child_type is non-%NULL then it must be a
 758  * definite type.
 759  *
 760  * The items of the array are taken from the @children array.  No entry
 761  * in the @children array may be %NULL.
 762  *
 763  * All items in the array must have the same type, which must be the
 764  * same as @child_type, if given.
 765  *
 766  * If the @children are floating references (see g_variant_ref_sink()), the
 767  * new instance takes ownership of them as if via g_variant_ref_sink().
 768  *
 769  * Returns: (transfer none): a floating reference to a new #GVariant array
 770  *
 771  * Since: 2.24
 772  **/
 773 GVariant *
 774 g_variant_new_array (const GVariantType *child_type,
 775                      GVariant * const   *children,
 776                      gsize               n_children)
 777 {
 778   GVariantType *array_type;
 779   GVariant **my_children;
 780   gboolean trusted;
 781   GVariant *value;
 782   gsize i;
 783 
 784   g_return_val_if_fail (n_children &gt; 0 || child_type != NULL, NULL);
 785   g_return_val_if_fail (n_children == 0 || children != NULL, NULL);
 786   g_return_val_if_fail (child_type == NULL ||
 787                         g_variant_type_is_definite (child_type), NULL);
 788 
 789   my_children = g_new (GVariant *, n_children);
 790   trusted = TRUE;
 791 
 792   if (child_type == NULL)
 793     child_type = g_variant_get_type (children[0]);
 794   array_type = g_variant_type_new_array (child_type);
 795 
 796   for (i = 0; i &lt; n_children; i++)
 797     {
 798       TYPE_CHECK (children[i], child_type, NULL);
 799       my_children[i] = g_variant_ref_sink (children[i]);
 800       trusted &amp;= g_variant_is_trusted (children[i]);
 801     }
 802 
 803   value = g_variant_new_from_children (array_type, my_children,
 804                                        n_children, trusted);
 805   g_variant_type_free (array_type);
 806 
 807   return value;
 808 }
 809 
 810 /*&lt; private &gt;
 811  * g_variant_make_tuple_type:
 812  * @children: (array length=n_children): an array of GVariant *
 813  * @n_children: the length of @children
 814  *
 815  * Return the type of a tuple containing @children as its items.
 816  **/
 817 static GVariantType *
 818 g_variant_make_tuple_type (GVariant * const *children,
 819                            gsize             n_children)
 820 {
 821   const GVariantType **types;
 822   GVariantType *type;
 823   gsize i;
 824 
 825   types = g_new (const GVariantType *, n_children);
 826 
 827   for (i = 0; i &lt; n_children; i++)
 828     types[i] = g_variant_get_type (children[i]);
 829 
 830   type = g_variant_type_new_tuple (types, n_children);
 831   g_free (types);
 832 
 833   return type;
 834 }
 835 
 836 /**
 837  * g_variant_new_tuple:
 838  * @children: (array length=n_children): the items to make the tuple out of
 839  * @n_children: the length of @children
 840  *
 841  * Creates a new tuple #GVariant out of the items in @children.  The
 842  * type is determined from the types of @children.  No entry in the
 843  * @children array may be %NULL.
 844  *
 845  * If @n_children is 0 then the unit tuple is constructed.
 846  *
 847  * If the @children are floating references (see g_variant_ref_sink()), the
 848  * new instance takes ownership of them as if via g_variant_ref_sink().
 849  *
 850  * Returns: (transfer none): a floating reference to a new #GVariant tuple
 851  *
 852  * Since: 2.24
 853  **/
 854 GVariant *
 855 g_variant_new_tuple (GVariant * const *children,
 856                      gsize             n_children)
 857 {
 858   GVariantType *tuple_type;
 859   GVariant **my_children;
 860   gboolean trusted;
 861   GVariant *value;
 862   gsize i;
 863 
 864   g_return_val_if_fail (n_children == 0 || children != NULL, NULL);
 865 
 866   my_children = g_new (GVariant *, n_children);
 867   trusted = TRUE;
 868 
 869   for (i = 0; i &lt; n_children; i++)
 870     {
 871       my_children[i] = g_variant_ref_sink (children[i]);
 872       trusted &amp;= g_variant_is_trusted (children[i]);
 873     }
 874 
 875   tuple_type = g_variant_make_tuple_type (children, n_children);
 876   value = g_variant_new_from_children (tuple_type, my_children,
 877                                        n_children, trusted);
 878   g_variant_type_free (tuple_type);
 879 
 880   return value;
 881 }
 882 
 883 /*&lt; private &gt;
 884  * g_variant_make_dict_entry_type:
 885  * @key: a #GVariant, the key
 886  * @val: a #GVariant, the value
 887  *
 888  * Return the type of a dictionary entry containing @key and @val as its
 889  * children.
 890  **/
 891 static GVariantType *
 892 g_variant_make_dict_entry_type (GVariant *key,
 893                                 GVariant *val)
 894 {
 895   return g_variant_type_new_dict_entry (g_variant_get_type (key),
 896                                         g_variant_get_type (val));
 897 }
 898 
 899 /**
 900  * g_variant_new_dict_entry: (constructor)
 901  * @key: a basic #GVariant, the key
 902  * @value: a #GVariant, the value
 903  *
 904  * Creates a new dictionary entry #GVariant. @key and @value must be
 905  * non-%NULL. @key must be a value of a basic type (ie: not a container).
 906  *
 907  * If the @key or @value are floating references (see g_variant_ref_sink()),
 908  * the new instance takes ownership of them as if via g_variant_ref_sink().
 909  *
 910  * Returns: (transfer none): a floating reference to a new dictionary entry #GVariant
 911  *
 912  * Since: 2.24
 913  **/
 914 GVariant *
 915 g_variant_new_dict_entry (GVariant *key,
 916                           GVariant *value)
 917 {
 918   GVariantType *dict_type;
 919   GVariant **children;
 920   gboolean trusted;
 921 
 922   g_return_val_if_fail (key != NULL &amp;&amp; value != NULL, NULL);
 923   g_return_val_if_fail (!g_variant_is_container (key), NULL);
 924 
 925   children = g_new (GVariant *, 2);
 926   children[0] = g_variant_ref_sink (key);
 927   children[1] = g_variant_ref_sink (value);
 928   trusted = g_variant_is_trusted (key) &amp;&amp; g_variant_is_trusted (value);
 929 
 930   dict_type = g_variant_make_dict_entry_type (key, value);
 931   value = g_variant_new_from_children (dict_type, children, 2, trusted);
 932   g_variant_type_free (dict_type);
 933 
 934   return value;
 935 }
 936 
 937 /**
 938  * g_variant_lookup: (skip)
 939  * @dictionary: a dictionary #GVariant
<a name="7" id="anc7"></a><span class="line-modified"> 940  * @key: the key to lookup in the dictionary</span>
 941  * @format_string: a GVariant format string
 942  * @...: the arguments to unpack the value into
 943  *
 944  * Looks up a value in a dictionary #GVariant.
 945  *
 946  * This function is a wrapper around g_variant_lookup_value() and
 947  * g_variant_get().  In the case that %NULL would have been returned,
 948  * this function returns %FALSE.  Otherwise, it unpacks the returned
 949  * value and returns %TRUE.
 950  *
 951  * @format_string determines the C types that are used for unpacking
 952  * the values and also determines if the values are copied or borrowed,
 953  * see the section on
 954  * [GVariant format strings][gvariant-format-strings-pointers].
 955  *
 956  * This function is currently implemented with a linear scan.  If you
 957  * plan to do many lookups then #GVariantDict may be more efficient.
 958  *
 959  * Returns: %TRUE if a value was unpacked
 960  *
 961  * Since: 2.28
 962  */
 963 gboolean
 964 g_variant_lookup (GVariant    *dictionary,
 965                   const gchar *key,
 966                   const gchar *format_string,
 967                   ...)
 968 {
 969   GVariantType *type;
 970   GVariant *value;
 971 
 972   /* flatten */
 973   g_variant_get_data (dictionary);
 974 
 975   type = g_variant_format_string_scan_type (format_string, NULL, NULL);
 976   value = g_variant_lookup_value (dictionary, key, type);
 977   g_variant_type_free (type);
 978 
 979   if (value)
 980     {
 981       va_list ap;
 982 
 983       va_start (ap, format_string);
 984       g_variant_get_va (value, format_string, NULL, &amp;ap);
 985       g_variant_unref (value);
 986       va_end (ap);
 987 
 988       return TRUE;
 989     }
 990 
 991   else
 992     return FALSE;
 993 }
 994 
 995 /**
 996  * g_variant_lookup_value:
 997  * @dictionary: a dictionary #GVariant
<a name="8" id="anc8"></a><span class="line-modified"> 998  * @key: the key to lookup in the dictionary</span>
 999  * @expected_type: (nullable): a #GVariantType, or %NULL
1000  *
1001  * Looks up a value in a dictionary #GVariant.
1002  *
1003  * This function works with dictionaries of the type a{s*} (and equally
1004  * well with type a{o*}, but we only further discuss the string case
1005  * for sake of clarity).
1006  *
1007  * In the event that @dictionary has the type a{sv}, the @expected_type
1008  * string specifies what type of value is expected to be inside of the
1009  * variant. If the value inside the variant has a different type then
1010  * %NULL is returned. In the event that @dictionary has a value type other
<a name="9" id="anc9"></a><span class="line-modified">1011  * than v then @expected_type must directly match the key type and it is</span>
1012  * used to unpack the value directly or an error occurs.
1013  *
1014  * In either case, if @key is not found in @dictionary, %NULL is returned.
1015  *
1016  * If the key is found and the value has the correct type, it is
1017  * returned.  If @expected_type was specified then any non-%NULL return
1018  * value will have this type.
1019  *
1020  * This function is currently implemented with a linear scan.  If you
1021  * plan to do many lookups then #GVariantDict may be more efficient.
1022  *
1023  * Returns: (transfer full): the value of the dictionary key, or %NULL
1024  *
1025  * Since: 2.28
1026  */
1027 GVariant *
1028 g_variant_lookup_value (GVariant           *dictionary,
1029                         const gchar        *key,
1030                         const GVariantType *expected_type)
1031 {
1032   GVariantIter iter;
1033   GVariant *entry;
1034   GVariant *value;
1035 
1036   g_return_val_if_fail (g_variant_is_of_type (dictionary,
1037                                               G_VARIANT_TYPE (&quot;a{s*}&quot;)) ||
1038                         g_variant_is_of_type (dictionary,
1039                                               G_VARIANT_TYPE (&quot;a{o*}&quot;)),
1040                         NULL);
1041 
1042   g_variant_iter_init (&amp;iter, dictionary);
1043 
1044   while ((entry = g_variant_iter_next_value (&amp;iter)))
1045     {
1046       GVariant *entry_key;
1047       gboolean matches;
1048 
1049       entry_key = g_variant_get_child_value (entry, 0);
1050       matches = strcmp (g_variant_get_string (entry_key, NULL), key) == 0;
1051       g_variant_unref (entry_key);
1052 
1053       if (matches)
1054         break;
1055 
1056       g_variant_unref (entry);
1057     }
1058 
1059   if (entry == NULL)
1060     return NULL;
1061 
1062   value = g_variant_get_child_value (entry, 1);
1063   g_variant_unref (entry);
1064 
1065   if (g_variant_is_of_type (value, G_VARIANT_TYPE_VARIANT))
1066     {
1067       GVariant *tmp;
1068 
1069       tmp = g_variant_get_variant (value);
1070       g_variant_unref (value);
1071 
1072       if (expected_type &amp;&amp; !g_variant_is_of_type (tmp, expected_type))
1073         {
1074           g_variant_unref (tmp);
1075           tmp = NULL;
1076         }
1077 
1078       value = tmp;
1079     }
1080 
1081   g_return_val_if_fail (expected_type == NULL || value == NULL ||
1082                         g_variant_is_of_type (value, expected_type), NULL);
1083 
1084   return value;
1085 }
1086 
1087 /**
1088  * g_variant_get_fixed_array:
1089  * @value: a #GVariant array with fixed-sized elements
1090  * @n_elements: (out): a pointer to the location to store the number of items
1091  * @element_size: the size of each element
1092  *
1093  * Provides access to the serialised data for an array of fixed-sized
1094  * items.
1095  *
1096  * @value must be an array with fixed-sized elements.  Numeric types are
1097  * fixed-size, as are tuples containing only other fixed-sized types.
1098  *
1099  * @element_size must be the size of a single element in the array,
1100  * as given by the section on
1101  * [serialized data memory][gvariant-serialised-data-memory].
1102  *
1103  * In particular, arrays of these fixed-sized types can be interpreted
1104  * as an array of the given C type, with @element_size set to the size
1105  * the appropriate type:
1106  * - %G_VARIANT_TYPE_INT16 (etc.): #gint16 (etc.)
1107  * - %G_VARIANT_TYPE_BOOLEAN: #guchar (not #gboolean!)
1108  * - %G_VARIANT_TYPE_BYTE: #guint8
1109  * - %G_VARIANT_TYPE_HANDLE: #guint32
1110  * - %G_VARIANT_TYPE_DOUBLE: #gdouble
1111  *
1112  * For example, if calling this function for an array of 32-bit integers,
1113  * you might say `sizeof(gint32)`. This value isn&#39;t used except for the purpose
1114  * of a double-check that the form of the serialised data matches the caller&#39;s
1115  * expectation.
1116  *
1117  * @n_elements, which must be non-%NULL, is set equal to the number of
1118  * items in the array.
1119  *
1120  * Returns: (array length=n_elements) (transfer none): a pointer to
1121  *     the fixed array
1122  *
1123  * Since: 2.24
1124  **/
1125 gconstpointer
1126 g_variant_get_fixed_array (GVariant *value,
1127                            gsize    *n_elements,
1128                            gsize     element_size)
1129 {
1130   GVariantTypeInfo *array_info;
1131   gsize array_element_size;
1132   gconstpointer data;
1133   gsize size;
1134 
1135   TYPE_CHECK (value, G_VARIANT_TYPE_ARRAY, NULL);
1136 
1137   g_return_val_if_fail (n_elements != NULL, NULL);
1138   g_return_val_if_fail (element_size &gt; 0, NULL);
1139 
1140   array_info = g_variant_get_type_info (value);
1141   g_variant_type_info_query_element (array_info, NULL, &amp;array_element_size);
1142 
1143   g_return_val_if_fail (array_element_size, NULL);
1144 
1145   if G_UNLIKELY (array_element_size != element_size)
1146     {
1147       if (array_element_size)
1148         g_critical (&quot;g_variant_get_fixed_array: assertion &quot;
1149                     &quot;&#39;g_variant_array_has_fixed_size (value, element_size)&#39; &quot;
1150                     &quot;failed: array size %&quot;G_GSIZE_FORMAT&quot; does not match &quot;
1151                     &quot;given element_size %&quot;G_GSIZE_FORMAT&quot;.&quot;,
1152                     array_element_size, element_size);
1153       else
1154         g_critical (&quot;g_variant_get_fixed_array: assertion &quot;
1155                     &quot;&#39;g_variant_array_has_fixed_size (value, element_size)&#39; &quot;
1156                     &quot;failed: array does not have fixed size.&quot;);
1157     }
1158 
1159   data = g_variant_get_data (value);
1160   size = g_variant_get_size (value);
1161 
1162   if (size % element_size)
1163     *n_elements = 0;
1164   else
1165     *n_elements = size / element_size;
1166 
1167   if (*n_elements)
1168     return data;
1169 
1170   return NULL;
1171 }
1172 
1173 /**
1174  * g_variant_new_fixed_array:
1175  * @element_type: the #GVariantType of each element
1176  * @elements: a pointer to the fixed array of contiguous elements
1177  * @n_elements: the number of elements
1178  * @element_size: the size of each element
1179  *
1180  * Constructs a new array #GVariant instance, where the elements are
1181  * of @element_type type.
1182  *
1183  * @elements must be an array with fixed-sized elements.  Numeric types are
1184  * fixed-size as are tuples containing only other fixed-sized types.
1185  *
1186  * @element_size must be the size of a single element in the array.
1187  * For example, if calling this function for an array of 32-bit integers,
1188  * you might say sizeof(gint32). This value isn&#39;t used except for the purpose
1189  * of a double-check that the form of the serialised data matches the caller&#39;s
1190  * expectation.
1191  *
1192  * @n_elements must be the length of the @elements array.
1193  *
1194  * Returns: (transfer none): a floating reference to a new array #GVariant instance
1195  *
1196  * Since: 2.32
1197  **/
1198 GVariant *
1199 g_variant_new_fixed_array (const GVariantType  *element_type,
1200                            gconstpointer        elements,
1201                            gsize                n_elements,
1202                            gsize                element_size)
1203 {
1204   GVariantType *array_type;
1205   gsize array_element_size;
1206   GVariantTypeInfo *array_info;
1207   GVariant *value;
1208   gpointer data;
1209 
1210   g_return_val_if_fail (g_variant_type_is_definite (element_type), NULL);
1211   g_return_val_if_fail (element_size &gt; 0, NULL);
1212 
1213   array_type = g_variant_type_new_array (element_type);
1214   array_info = g_variant_type_info_get (array_type);
1215   g_variant_type_info_query_element (array_info, NULL, &amp;array_element_size);
1216   if G_UNLIKELY (array_element_size != element_size)
1217     {
1218       if (array_element_size)
1219         g_critical (&quot;g_variant_new_fixed_array: array size %&quot; G_GSIZE_FORMAT
1220                     &quot; does not match given element_size %&quot; G_GSIZE_FORMAT &quot;.&quot;,
1221                     array_element_size, element_size);
1222       else
1223         g_critical (&quot;g_variant_get_fixed_array: array does not have fixed size.&quot;);
1224       return NULL;
1225     }
1226 
1227   data = g_memdup (elements, n_elements * element_size);
1228   value = g_variant_new_from_data (array_type, data,
1229                                    n_elements * element_size,
1230                                    FALSE, g_free, data);
1231 
1232   g_variant_type_free (array_type);
1233   g_variant_type_info_unref (array_info);
1234 
1235   return value;
1236 }
1237 
1238 /* String type constructor/getters/validation {{{1 */
1239 /**
1240  * g_variant_new_string:
1241  * @string: a normal UTF-8 nul-terminated string
1242  *
1243  * Creates a string #GVariant with the contents of @string.
1244  *
1245  * @string must be valid UTF-8, and must not be %NULL. To encode
1246  * potentially-%NULL strings, use g_variant_new() with `ms` as the
1247  * [format string][gvariant-format-strings-maybe-types].
1248  *
1249  * Returns: (transfer none): a floating reference to a new string #GVariant instance
1250  *
1251  * Since: 2.24
1252  **/
1253 GVariant *
1254 g_variant_new_string (const gchar *string)
1255 {
1256   g_return_val_if_fail (string != NULL, NULL);
1257   g_return_val_if_fail (g_utf8_validate (string, -1, NULL), NULL);
1258 
1259   return g_variant_new_from_trusted (G_VARIANT_TYPE_STRING,
1260                                      string, strlen (string) + 1);
1261 }
1262 
1263 /**
1264  * g_variant_new_take_string: (skip)
1265  * @string: a normal UTF-8 nul-terminated string
1266  *
1267  * Creates a string #GVariant with the contents of @string.
1268  *
1269  * @string must be valid UTF-8, and must not be %NULL. To encode
1270  * potentially-%NULL strings, use this with g_variant_new_maybe().
1271  *
1272  * This function consumes @string.  g_free() will be called on @string
1273  * when it is no longer required.
1274  *
1275  * You must not modify or access @string in any other way after passing
1276  * it to this function.  It is even possible that @string is immediately
1277  * freed.
1278  *
1279  * Returns: (transfer none): a floating reference to a new string
1280  *   #GVariant instance
1281  *
1282  * Since: 2.38
1283  **/
1284 GVariant *
1285 g_variant_new_take_string (gchar *string)
1286 {
1287   GVariant *value;
1288   GBytes *bytes;
1289 
1290   g_return_val_if_fail (string != NULL, NULL);
1291   g_return_val_if_fail (g_utf8_validate (string, -1, NULL), NULL);
1292 
1293   bytes = g_bytes_new_take (string, strlen (string) + 1);
1294   value = g_variant_new_from_bytes (G_VARIANT_TYPE_STRING, bytes, TRUE);
1295   g_bytes_unref (bytes);
1296 
1297   return value;
1298 }
1299 
1300 /**
1301  * g_variant_new_printf: (skip)
1302  * @format_string: a printf-style format string
1303  * @...: arguments for @format_string
1304  *
1305  * Creates a string-type GVariant using printf formatting.
1306  *
1307  * This is similar to calling g_strdup_printf() and then
1308  * g_variant_new_string() but it saves a temporary variable and an
1309  * unnecessary copy.
1310  *
1311  * Returns: (transfer none): a floating reference to a new string
1312  *   #GVariant instance
1313  *
1314  * Since: 2.38
1315  **/
1316 GVariant *
1317 g_variant_new_printf (const gchar *format_string,
1318                       ...)
1319 {
1320   GVariant *value;
1321   GBytes *bytes;
1322   gchar *string;
1323   va_list ap;
1324 
1325   g_return_val_if_fail (format_string != NULL, NULL);
1326 
1327   va_start (ap, format_string);
1328   string = g_strdup_vprintf (format_string, ap);
1329   va_end (ap);
1330 
1331   bytes = g_bytes_new_take (string, strlen (string) + 1);
1332   value = g_variant_new_from_bytes (G_VARIANT_TYPE_STRING, bytes, TRUE);
1333   g_bytes_unref (bytes);
1334 
1335   return value;
1336 }
1337 
1338 /**
1339  * g_variant_new_object_path:
1340  * @object_path: a normal C nul-terminated string
1341  *
1342  * Creates a D-Bus object path #GVariant with the contents of @string.
1343  * @string must be a valid D-Bus object path.  Use
1344  * g_variant_is_object_path() if you&#39;re not sure.
1345  *
1346  * Returns: (transfer none): a floating reference to a new object path #GVariant instance
1347  *
1348  * Since: 2.24
1349  **/
1350 GVariant *
1351 g_variant_new_object_path (const gchar *object_path)
1352 {
1353   g_return_val_if_fail (g_variant_is_object_path (object_path), NULL);
1354 
1355   return g_variant_new_from_trusted (G_VARIANT_TYPE_OBJECT_PATH,
1356                                      object_path, strlen (object_path) + 1);
1357 }
1358 
1359 /**
1360  * g_variant_is_object_path:
1361  * @string: a normal C nul-terminated string
1362  *
1363  * Determines if a given string is a valid D-Bus object path.  You
1364  * should ensure that a string is a valid D-Bus object path before
1365  * passing it to g_variant_new_object_path().
1366  *
1367  * A valid object path starts with &#39;/&#39; followed by zero or more
1368  * sequences of characters separated by &#39;/&#39; characters.  Each sequence
1369  * must contain only the characters &quot;[A-Z][a-z][0-9]_&quot;.  No sequence
1370  * (including the one following the final &#39;/&#39; character) may be empty.
1371  *
1372  * Returns: %TRUE if @string is a D-Bus object path
1373  *
1374  * Since: 2.24
1375  **/
1376 gboolean
1377 g_variant_is_object_path (const gchar *string)
1378 {
1379   g_return_val_if_fail (string != NULL, FALSE);
1380 
1381   return g_variant_serialiser_is_object_path (string, strlen (string) + 1);
1382 }
1383 
1384 /**
1385  * g_variant_new_signature:
1386  * @signature: a normal C nul-terminated string
1387  *
1388  * Creates a D-Bus type signature #GVariant with the contents of
1389  * @string.  @string must be a valid D-Bus type signature.  Use
1390  * g_variant_is_signature() if you&#39;re not sure.
1391  *
1392  * Returns: (transfer none): a floating reference to a new signature #GVariant instance
1393  *
1394  * Since: 2.24
1395  **/
1396 GVariant *
1397 g_variant_new_signature (const gchar *signature)
1398 {
1399   g_return_val_if_fail (g_variant_is_signature (signature), NULL);
1400 
1401   return g_variant_new_from_trusted (G_VARIANT_TYPE_SIGNATURE,
1402                                      signature, strlen (signature) + 1);
1403 }
1404 
1405 /**
1406  * g_variant_is_signature:
1407  * @string: a normal C nul-terminated string
1408  *
1409  * Determines if a given string is a valid D-Bus type signature.  You
1410  * should ensure that a string is a valid D-Bus type signature before
1411  * passing it to g_variant_new_signature().
1412  *
1413  * D-Bus type signatures consist of zero or more definite #GVariantType
1414  * strings in sequence.
1415  *
1416  * Returns: %TRUE if @string is a D-Bus type signature
1417  *
1418  * Since: 2.24
1419  **/
1420 gboolean
1421 g_variant_is_signature (const gchar *string)
1422 {
1423   g_return_val_if_fail (string != NULL, FALSE);
1424 
1425   return g_variant_serialiser_is_signature (string, strlen (string) + 1);
1426 }
1427 
1428 /**
1429  * g_variant_get_string:
1430  * @value: a string #GVariant instance
1431  * @length: (optional) (default 0) (out): a pointer to a #gsize,
1432  *          to store the length
1433  *
1434  * Returns the string value of a #GVariant instance with a string
1435  * type.  This includes the types %G_VARIANT_TYPE_STRING,
1436  * %G_VARIANT_TYPE_OBJECT_PATH and %G_VARIANT_TYPE_SIGNATURE.
1437  *
1438  * The string will always be UTF-8 encoded, and will never be %NULL.
1439  *
1440  * If @length is non-%NULL then the length of the string (in bytes) is
1441  * returned there.  For trusted values, this information is already
1442  * known.  For untrusted values, a strlen() will be performed.
1443  *
1444  * It is an error to call this function with a @value of any type
1445  * other than those three.
1446  *
1447  * The return value remains valid as long as @value exists.
1448  *
1449  * Returns: (transfer none): the constant string, UTF-8 encoded
1450  *
1451  * Since: 2.24
1452  **/
1453 const gchar *
1454 g_variant_get_string (GVariant *value,
1455                       gsize    *length)
1456 {
1457   gconstpointer data;
1458   gsize size;
1459 
1460   g_return_val_if_fail (value != NULL, NULL);
1461   g_return_val_if_fail (
1462     g_variant_is_of_type (value, G_VARIANT_TYPE_STRING) ||
1463     g_variant_is_of_type (value, G_VARIANT_TYPE_OBJECT_PATH) ||
1464     g_variant_is_of_type (value, G_VARIANT_TYPE_SIGNATURE), NULL);
1465 
1466   data = g_variant_get_data (value);
1467   size = g_variant_get_size (value);
1468 
1469   if (!g_variant_is_trusted (value))
1470     {
1471       switch (g_variant_classify (value))
1472         {
1473         case G_VARIANT_CLASS_STRING:
1474           if (g_variant_serialiser_is_string (data, size))
1475             break;
1476 
1477           data = &quot;&quot;;
1478           size = 1;
1479           break;
1480 
1481         case G_VARIANT_CLASS_OBJECT_PATH:
1482           if (g_variant_serialiser_is_object_path (data, size))
1483             break;
1484 
1485           data = &quot;/&quot;;
1486           size = 2;
1487           break;
1488 
1489         case G_VARIANT_CLASS_SIGNATURE:
1490           if (g_variant_serialiser_is_signature (data, size))
1491             break;
1492 
1493           data = &quot;&quot;;
1494           size = 1;
1495           break;
1496 
1497         default:
1498           g_assert_not_reached ();
1499         }
1500     }
1501 
1502   if (length)
1503     *length = size - 1;
1504 
1505   return data;
1506 }
1507 
1508 /**
1509  * g_variant_dup_string:
1510  * @value: a string #GVariant instance
1511  * @length: (out): a pointer to a #gsize, to store the length
1512  *
1513  * Similar to g_variant_get_string() except that instead of returning
1514  * a constant string, the string is duplicated.
1515  *
1516  * The string will always be UTF-8 encoded.
1517  *
1518  * The return value must be freed using g_free().
1519  *
1520  * Returns: (transfer full): a newly allocated string, UTF-8 encoded
1521  *
1522  * Since: 2.24
1523  **/
1524 gchar *
1525 g_variant_dup_string (GVariant *value,
1526                       gsize    *length)
1527 {
1528   return g_strdup (g_variant_get_string (value, length));
1529 }
1530 
1531 /**
1532  * g_variant_new_strv:
1533  * @strv: (array length=length) (element-type utf8): an array of strings
1534  * @length: the length of @strv, or -1
1535  *
1536  * Constructs an array of strings #GVariant from the given array of
1537  * strings.
1538  *
1539  * If @length is -1 then @strv is %NULL-terminated.
1540  *
1541  * Returns: (transfer none): a new floating #GVariant instance
1542  *
1543  * Since: 2.24
1544  **/
1545 GVariant *
1546 g_variant_new_strv (const gchar * const *strv,
1547                     gssize               length)
1548 {
1549   GVariant **strings;
<a name="10" id="anc10"></a><span class="line-modified">1550   gsize i;</span>
1551 
1552   g_return_val_if_fail (length == 0 || strv != NULL, NULL);
1553 
1554   if (length &lt; 0)
1555     length = g_strv_length ((gchar **) strv);
<a name="11" id="anc11"></a>
1556 
<a name="12" id="anc12"></a><span class="line-modified">1557   strings = g_new (GVariant *, length);</span>
<span class="line-modified">1558   for (i = 0; i &lt; length; i++)</span>
1559     strings[i] = g_variant_ref_sink (g_variant_new_string (strv[i]));
1560 
1561   return g_variant_new_from_children (G_VARIANT_TYPE_STRING_ARRAY,
<a name="13" id="anc13"></a><span class="line-modified">1562                                       strings, length, TRUE);</span>
1563 }
1564 
1565 /**
1566  * g_variant_get_strv:
1567  * @value: an array of strings #GVariant
1568  * @length: (out) (optional): the length of the result, or %NULL
1569  *
1570  * Gets the contents of an array of strings #GVariant.  This call
1571  * makes a shallow copy; the return result should be released with
1572  * g_free(), but the individual strings must not be modified.
1573  *
1574  * If @length is non-%NULL then the number of elements in the result
1575  * is stored there.  In any case, the resulting array will be
1576  * %NULL-terminated.
1577  *
1578  * For an empty array, @length will be set to 0 and a pointer to a
1579  * %NULL pointer will be returned.
1580  *
1581  * Returns: (array length=length zero-terminated=1) (transfer container): an array of constant strings
1582  *
1583  * Since: 2.24
1584  **/
1585 const gchar **
1586 g_variant_get_strv (GVariant *value,
1587                     gsize    *length)
1588 {
1589   const gchar **strv;
1590   gsize n;
1591   gsize i;
1592 
1593   TYPE_CHECK (value, G_VARIANT_TYPE_STRING_ARRAY, NULL);
1594 
1595   g_variant_get_data (value);
1596   n = g_variant_n_children (value);
1597   strv = g_new (const gchar *, n + 1);
1598 
1599   for (i = 0; i &lt; n; i++)
1600     {
1601       GVariant *string;
1602 
1603       string = g_variant_get_child_value (value, i);
1604       strv[i] = g_variant_get_string (string, NULL);
1605       g_variant_unref (string);
1606     }
1607   strv[i] = NULL;
1608 
1609   if (length)
1610     *length = n;
1611 
1612   return strv;
1613 }
1614 
1615 /**
1616  * g_variant_dup_strv:
1617  * @value: an array of strings #GVariant
1618  * @length: (out) (optional): the length of the result, or %NULL
1619  *
1620  * Gets the contents of an array of strings #GVariant.  This call
1621  * makes a deep copy; the return result should be released with
1622  * g_strfreev().
1623  *
1624  * If @length is non-%NULL then the number of elements in the result
1625  * is stored there.  In any case, the resulting array will be
1626  * %NULL-terminated.
1627  *
1628  * For an empty array, @length will be set to 0 and a pointer to a
1629  * %NULL pointer will be returned.
1630  *
1631  * Returns: (array length=length zero-terminated=1) (transfer full): an array of strings
1632  *
1633  * Since: 2.24
1634  **/
1635 gchar **
1636 g_variant_dup_strv (GVariant *value,
1637                     gsize    *length)
1638 {
1639   gchar **strv;
1640   gsize n;
1641   gsize i;
1642 
1643   TYPE_CHECK (value, G_VARIANT_TYPE_STRING_ARRAY, NULL);
1644 
1645   n = g_variant_n_children (value);
1646   strv = g_new (gchar *, n + 1);
1647 
1648   for (i = 0; i &lt; n; i++)
1649     {
1650       GVariant *string;
1651 
1652       string = g_variant_get_child_value (value, i);
1653       strv[i] = g_variant_dup_string (string, NULL);
1654       g_variant_unref (string);
1655     }
1656   strv[i] = NULL;
1657 
1658   if (length)
1659     *length = n;
1660 
1661   return strv;
1662 }
1663 
1664 /**
1665  * g_variant_new_objv:
1666  * @strv: (array length=length) (element-type utf8): an array of strings
1667  * @length: the length of @strv, or -1
1668  *
1669  * Constructs an array of object paths #GVariant from the given array of
1670  * strings.
1671  *
1672  * Each string must be a valid #GVariant object path; see
1673  * g_variant_is_object_path().
1674  *
1675  * If @length is -1 then @strv is %NULL-terminated.
1676  *
1677  * Returns: (transfer none): a new floating #GVariant instance
1678  *
1679  * Since: 2.30
1680  **/
1681 GVariant *
1682 g_variant_new_objv (const gchar * const *strv,
1683                     gssize               length)
1684 {
1685   GVariant **strings;
<a name="14" id="anc14"></a><span class="line-modified">1686   gsize i;</span>
1687 
1688   g_return_val_if_fail (length == 0 || strv != NULL, NULL);
1689 
1690   if (length &lt; 0)
1691     length = g_strv_length ((gchar **) strv);
<a name="15" id="anc15"></a>
1692 
<a name="16" id="anc16"></a><span class="line-modified">1693   strings = g_new (GVariant *, length);</span>
<span class="line-modified">1694   for (i = 0; i &lt; length; i++)</span>
1695     strings[i] = g_variant_ref_sink (g_variant_new_object_path (strv[i]));
1696 
1697   return g_variant_new_from_children (G_VARIANT_TYPE_OBJECT_PATH_ARRAY,
<a name="17" id="anc17"></a><span class="line-modified">1698                                       strings, length, TRUE);</span>
1699 }
1700 
1701 /**
1702  * g_variant_get_objv:
1703  * @value: an array of object paths #GVariant
1704  * @length: (out) (optional): the length of the result, or %NULL
1705  *
1706  * Gets the contents of an array of object paths #GVariant.  This call
1707  * makes a shallow copy; the return result should be released with
1708  * g_free(), but the individual strings must not be modified.
1709  *
1710  * If @length is non-%NULL then the number of elements in the result
1711  * is stored there.  In any case, the resulting array will be
1712  * %NULL-terminated.
1713  *
1714  * For an empty array, @length will be set to 0 and a pointer to a
1715  * %NULL pointer will be returned.
1716  *
1717  * Returns: (array length=length zero-terminated=1) (transfer container): an array of constant strings
1718  *
1719  * Since: 2.30
1720  **/
1721 const gchar **
1722 g_variant_get_objv (GVariant *value,
1723                     gsize    *length)
1724 {
1725   const gchar **strv;
1726   gsize n;
1727   gsize i;
1728 
1729   TYPE_CHECK (value, G_VARIANT_TYPE_OBJECT_PATH_ARRAY, NULL);
1730 
1731   g_variant_get_data (value);
1732   n = g_variant_n_children (value);
1733   strv = g_new (const gchar *, n + 1);
1734 
1735   for (i = 0; i &lt; n; i++)
1736     {
1737       GVariant *string;
1738 
1739       string = g_variant_get_child_value (value, i);
1740       strv[i] = g_variant_get_string (string, NULL);
1741       g_variant_unref (string);
1742     }
1743   strv[i] = NULL;
1744 
1745   if (length)
1746     *length = n;
1747 
1748   return strv;
1749 }
1750 
1751 /**
1752  * g_variant_dup_objv:
1753  * @value: an array of object paths #GVariant
1754  * @length: (out) (optional): the length of the result, or %NULL
1755  *
1756  * Gets the contents of an array of object paths #GVariant.  This call
1757  * makes a deep copy; the return result should be released with
1758  * g_strfreev().
1759  *
1760  * If @length is non-%NULL then the number of elements in the result
1761  * is stored there.  In any case, the resulting array will be
1762  * %NULL-terminated.
1763  *
1764  * For an empty array, @length will be set to 0 and a pointer to a
1765  * %NULL pointer will be returned.
1766  *
1767  * Returns: (array length=length zero-terminated=1) (transfer full): an array of strings
1768  *
1769  * Since: 2.30
1770  **/
1771 gchar **
1772 g_variant_dup_objv (GVariant *value,
1773                     gsize    *length)
1774 {
1775   gchar **strv;
1776   gsize n;
1777   gsize i;
1778 
1779   TYPE_CHECK (value, G_VARIANT_TYPE_OBJECT_PATH_ARRAY, NULL);
1780 
1781   n = g_variant_n_children (value);
1782   strv = g_new (gchar *, n + 1);
1783 
1784   for (i = 0; i &lt; n; i++)
1785     {
1786       GVariant *string;
1787 
1788       string = g_variant_get_child_value (value, i);
1789       strv[i] = g_variant_dup_string (string, NULL);
1790       g_variant_unref (string);
1791     }
1792   strv[i] = NULL;
1793 
1794   if (length)
1795     *length = n;
1796 
1797   return strv;
1798 }
1799 
1800 
1801 /**
1802  * g_variant_new_bytestring:
1803  * @string: (array zero-terminated=1) (element-type guint8): a normal
1804  *          nul-terminated string in no particular encoding
1805  *
1806  * Creates an array-of-bytes #GVariant with the contents of @string.
1807  * This function is just like g_variant_new_string() except that the
1808  * string need not be valid UTF-8.
1809  *
1810  * The nul terminator character at the end of the string is stored in
1811  * the array.
1812  *
1813  * Returns: (transfer none): a floating reference to a new bytestring #GVariant instance
1814  *
1815  * Since: 2.26
1816  **/
1817 GVariant *
1818 g_variant_new_bytestring (const gchar *string)
1819 {
1820   g_return_val_if_fail (string != NULL, NULL);
1821 
1822   return g_variant_new_from_trusted (G_VARIANT_TYPE_BYTESTRING,
1823                                      string, strlen (string) + 1);
1824 }
1825 
1826 /**
1827  * g_variant_get_bytestring:
1828  * @value: an array-of-bytes #GVariant instance
1829  *
1830  * Returns the string value of a #GVariant instance with an
1831  * array-of-bytes type.  The string has no particular encoding.
1832  *
1833  * If the array does not end with a nul terminator character, the empty
1834  * string is returned.  For this reason, you can always trust that a
1835  * non-%NULL nul-terminated string will be returned by this function.
1836  *
1837  * If the array contains a nul terminator character somewhere other than
1838  * the last byte then the returned string is the string, up to the first
1839  * such nul character.
1840  *
1841  * g_variant_get_fixed_array() should be used instead if the array contains
1842  * arbitrary data that could not be nul-terminated or could contain nul bytes.
1843  *
1844  * It is an error to call this function with a @value that is not an
1845  * array of bytes.
1846  *
1847  * The return value remains valid as long as @value exists.
1848  *
1849  * Returns: (transfer none) (array zero-terminated=1) (element-type guint8):
1850  *          the constant string
1851  *
1852  * Since: 2.26
1853  **/
1854 const gchar *
1855 g_variant_get_bytestring (GVariant *value)
1856 {
1857   const gchar *string;
1858   gsize size;
1859 
1860   TYPE_CHECK (value, G_VARIANT_TYPE_BYTESTRING, NULL);
1861 
1862   /* Won&#39;t be NULL since this is an array type */
1863   string = g_variant_get_data (value);
1864   size = g_variant_get_size (value);
1865 
1866   if (size &amp;&amp; string[size - 1] == &#39;\0&#39;)
1867     return string;
1868   else
1869     return &quot;&quot;;
1870 }
1871 
1872 /**
1873  * g_variant_dup_bytestring:
1874  * @value: an array-of-bytes #GVariant instance
1875  * @length: (out) (optional) (default NULL): a pointer to a #gsize, to store
1876  *          the length (not including the nul terminator)
1877  *
1878  * Similar to g_variant_get_bytestring() except that instead of
1879  * returning a constant string, the string is duplicated.
1880  *
1881  * The return value must be freed using g_free().
1882  *
1883  * Returns: (transfer full) (array zero-terminated=1 length=length) (element-type guint8):
1884  *          a newly allocated string
1885  *
1886  * Since: 2.26
1887  **/
1888 gchar *
1889 g_variant_dup_bytestring (GVariant *value,
1890                           gsize    *length)
1891 {
1892   const gchar *original = g_variant_get_bytestring (value);
1893   gsize size;
1894 
1895   /* don&#39;t crash in case get_bytestring() had an assert failure */
1896   if (original == NULL)
1897     return NULL;
1898 
1899   size = strlen (original);
1900 
1901   if (length)
1902     *length = size;
1903 
1904   return g_memdup (original, size + 1);
1905 }
1906 
1907 /**
1908  * g_variant_new_bytestring_array:
1909  * @strv: (array length=length): an array of strings
1910  * @length: the length of @strv, or -1
1911  *
1912  * Constructs an array of bytestring #GVariant from the given array of
1913  * strings.
1914  *
1915  * If @length is -1 then @strv is %NULL-terminated.
1916  *
1917  * Returns: (transfer none): a new floating #GVariant instance
1918  *
1919  * Since: 2.26
1920  **/
1921 GVariant *
1922 g_variant_new_bytestring_array (const gchar * const *strv,
1923                                 gssize               length)
1924 {
1925   GVariant **strings;
<a name="18" id="anc18"></a><span class="line-modified">1926   gsize i;</span>
1927 
1928   g_return_val_if_fail (length == 0 || strv != NULL, NULL);
1929 
1930   if (length &lt; 0)
1931     length = g_strv_length ((gchar **) strv);
<a name="19" id="anc19"></a>
1932 
<a name="20" id="anc20"></a><span class="line-modified">1933   strings = g_new (GVariant *, length);</span>
<span class="line-modified">1934   for (i = 0; i &lt; length; i++)</span>
1935     strings[i] = g_variant_ref_sink (g_variant_new_bytestring (strv[i]));
1936 
1937   return g_variant_new_from_children (G_VARIANT_TYPE_BYTESTRING_ARRAY,
<a name="21" id="anc21"></a><span class="line-modified">1938                                       strings, length, TRUE);</span>
1939 }
1940 
1941 /**
1942  * g_variant_get_bytestring_array:
1943  * @value: an array of array of bytes #GVariant (&#39;aay&#39;)
1944  * @length: (out) (optional): the length of the result, or %NULL
1945  *
1946  * Gets the contents of an array of array of bytes #GVariant.  This call
1947  * makes a shallow copy; the return result should be released with
1948  * g_free(), but the individual strings must not be modified.
1949  *
1950  * If @length is non-%NULL then the number of elements in the result is
1951  * stored there.  In any case, the resulting array will be
1952  * %NULL-terminated.
1953  *
1954  * For an empty array, @length will be set to 0 and a pointer to a
1955  * %NULL pointer will be returned.
1956  *
1957  * Returns: (array length=length) (transfer container): an array of constant strings
1958  *
1959  * Since: 2.26
1960  **/
1961 const gchar **
1962 g_variant_get_bytestring_array (GVariant *value,
1963                                 gsize    *length)
1964 {
1965   const gchar **strv;
1966   gsize n;
1967   gsize i;
1968 
1969   TYPE_CHECK (value, G_VARIANT_TYPE_BYTESTRING_ARRAY, NULL);
1970 
1971   g_variant_get_data (value);
1972   n = g_variant_n_children (value);
1973   strv = g_new (const gchar *, n + 1);
1974 
1975   for (i = 0; i &lt; n; i++)
1976     {
1977       GVariant *string;
1978 
1979       string = g_variant_get_child_value (value, i);
1980       strv[i] = g_variant_get_bytestring (string);
1981       g_variant_unref (string);
1982     }
1983   strv[i] = NULL;
1984 
1985   if (length)
1986     *length = n;
1987 
1988   return strv;
1989 }
1990 
1991 /**
1992  * g_variant_dup_bytestring_array:
1993  * @value: an array of array of bytes #GVariant (&#39;aay&#39;)
1994  * @length: (out) (optional): the length of the result, or %NULL
1995  *
1996  * Gets the contents of an array of array of bytes #GVariant.  This call
1997  * makes a deep copy; the return result should be released with
1998  * g_strfreev().
1999  *
2000  * If @length is non-%NULL then the number of elements in the result is
2001  * stored there.  In any case, the resulting array will be
2002  * %NULL-terminated.
2003  *
2004  * For an empty array, @length will be set to 0 and a pointer to a
2005  * %NULL pointer will be returned.
2006  *
2007  * Returns: (array length=length) (transfer full): an array of strings
2008  *
2009  * Since: 2.26
2010  **/
2011 gchar **
2012 g_variant_dup_bytestring_array (GVariant *value,
2013                                 gsize    *length)
2014 {
2015   gchar **strv;
2016   gsize n;
2017   gsize i;
2018 
2019   TYPE_CHECK (value, G_VARIANT_TYPE_BYTESTRING_ARRAY, NULL);
2020 
2021   g_variant_get_data (value);
2022   n = g_variant_n_children (value);
2023   strv = g_new (gchar *, n + 1);
2024 
2025   for (i = 0; i &lt; n; i++)
2026     {
2027       GVariant *string;
2028 
2029       string = g_variant_get_child_value (value, i);
2030       strv[i] = g_variant_dup_bytestring (string, NULL);
2031       g_variant_unref (string);
2032     }
2033   strv[i] = NULL;
2034 
2035   if (length)
2036     *length = n;
2037 
2038   return strv;
2039 }
2040 
2041 /* Type checking and querying {{{1 */
2042 /**
2043  * g_variant_get_type:
2044  * @value: a #GVariant
2045  *
2046  * Determines the type of @value.
2047  *
2048  * The return value is valid for the lifetime of @value and must not
2049  * be freed.
2050  *
2051  * Returns: a #GVariantType
2052  *
2053  * Since: 2.24
2054  **/
2055 const GVariantType *
2056 g_variant_get_type (GVariant *value)
2057 {
2058   GVariantTypeInfo *type_info;
2059 
2060   g_return_val_if_fail (value != NULL, NULL);
2061 
2062   type_info = g_variant_get_type_info (value);
2063 
2064   return (GVariantType *) g_variant_type_info_get_type_string (type_info);
2065 }
2066 
2067 /**
2068  * g_variant_get_type_string:
2069  * @value: a #GVariant
2070  *
2071  * Returns the type string of @value.  Unlike the result of calling
2072  * g_variant_type_peek_string(), this string is nul-terminated.  This
2073  * string belongs to #GVariant and must not be freed.
2074  *
2075  * Returns: the type string for the type of @value
2076  *
2077  * Since: 2.24
2078  **/
2079 const gchar *
2080 g_variant_get_type_string (GVariant *value)
2081 {
2082   GVariantTypeInfo *type_info;
2083 
2084   g_return_val_if_fail (value != NULL, NULL);
2085 
2086   type_info = g_variant_get_type_info (value);
2087 
2088   return g_variant_type_info_get_type_string (type_info);
2089 }
2090 
2091 /**
2092  * g_variant_is_of_type:
2093  * @value: a #GVariant instance
2094  * @type: a #GVariantType
2095  *
2096  * Checks if a value has a type matching the provided type.
2097  *
2098  * Returns: %TRUE if the type of @value matches @type
2099  *
2100  * Since: 2.24
2101  **/
2102 gboolean
2103 g_variant_is_of_type (GVariant           *value,
2104                       const GVariantType *type)
2105 {
2106   return g_variant_type_is_subtype_of (g_variant_get_type (value), type);
2107 }
2108 
2109 /**
2110  * g_variant_is_container:
2111  * @value: a #GVariant instance
2112  *
2113  * Checks if @value is a container.
2114  *
2115  * Returns: %TRUE if @value is a container
2116  *
2117  * Since: 2.24
2118  */
2119 gboolean
2120 g_variant_is_container (GVariant *value)
2121 {
2122   return g_variant_type_is_container (g_variant_get_type (value));
2123 }
2124 
2125 
2126 /**
2127  * g_variant_classify:
2128  * @value: a #GVariant
2129  *
2130  * Classifies @value according to its top-level type.
2131  *
2132  * Returns: the #GVariantClass of @value
2133  *
2134  * Since: 2.24
2135  **/
2136 /**
2137  * GVariantClass:
2138  * @G_VARIANT_CLASS_BOOLEAN: The #GVariant is a boolean.
2139  * @G_VARIANT_CLASS_BYTE: The #GVariant is a byte.
2140  * @G_VARIANT_CLASS_INT16: The #GVariant is a signed 16 bit integer.
2141  * @G_VARIANT_CLASS_UINT16: The #GVariant is an unsigned 16 bit integer.
2142  * @G_VARIANT_CLASS_INT32: The #GVariant is a signed 32 bit integer.
2143  * @G_VARIANT_CLASS_UINT32: The #GVariant is an unsigned 32 bit integer.
2144  * @G_VARIANT_CLASS_INT64: The #GVariant is a signed 64 bit integer.
2145  * @G_VARIANT_CLASS_UINT64: The #GVariant is an unsigned 64 bit integer.
2146  * @G_VARIANT_CLASS_HANDLE: The #GVariant is a file handle index.
2147  * @G_VARIANT_CLASS_DOUBLE: The #GVariant is a double precision floating
2148  *                          point value.
2149  * @G_VARIANT_CLASS_STRING: The #GVariant is a normal string.
2150  * @G_VARIANT_CLASS_OBJECT_PATH: The #GVariant is a D-Bus object path
2151  *                               string.
2152  * @G_VARIANT_CLASS_SIGNATURE: The #GVariant is a D-Bus signature string.
2153  * @G_VARIANT_CLASS_VARIANT: The #GVariant is a variant.
2154  * @G_VARIANT_CLASS_MAYBE: The #GVariant is a maybe-typed value.
2155  * @G_VARIANT_CLASS_ARRAY: The #GVariant is an array.
2156  * @G_VARIANT_CLASS_TUPLE: The #GVariant is a tuple.
2157  * @G_VARIANT_CLASS_DICT_ENTRY: The #GVariant is a dictionary entry.
2158  *
2159  * The range of possible top-level types of #GVariant instances.
2160  *
2161  * Since: 2.24
2162  **/
2163 GVariantClass
2164 g_variant_classify (GVariant *value)
2165 {
2166   g_return_val_if_fail (value != NULL, 0);
2167 
2168   return *g_variant_get_type_string (value);
2169 }
2170 
2171 /* Pretty printer {{{1 */
2172 /* This function is not introspectable because if @string is NULL,
2173    @returns is (transfer full), otherwise it is (transfer none), which
2174    is not supported by GObjectIntrospection */
2175 /**
2176  * g_variant_print_string: (skip)
2177  * @value: a #GVariant
2178  * @string: (nullable) (default NULL): a #GString, or %NULL
2179  * @type_annotate: %TRUE if type information should be included in
2180  *                 the output
2181  *
2182  * Behaves as g_variant_print(), but operates on a #GString.
2183  *
2184  * If @string is non-%NULL then it is appended to and returned.  Else,
2185  * a new empty #GString is allocated and it is returned.
2186  *
2187  * Returns: a #GString containing the string
2188  *
2189  * Since: 2.24
2190  **/
2191 GString *
2192 g_variant_print_string (GVariant *value,
2193                         GString  *string,
2194                         gboolean  type_annotate)
2195 {
2196   if G_UNLIKELY (string == NULL)
2197     string = g_string_new (NULL);
2198 
2199   switch (g_variant_classify (value))
2200     {
2201     case G_VARIANT_CLASS_MAYBE:
2202       if (type_annotate)
2203         g_string_append_printf (string, &quot;@%s &quot;,
2204                                 g_variant_get_type_string (value));
2205 
2206       if (g_variant_n_children (value))
2207         {
2208           gchar *printed_child;
2209           GVariant *element;
2210 
2211           /* Nested maybes:
2212            *
2213            * Consider the case of the type &quot;mmi&quot;.  In this case we could
2214            * write &quot;just just 4&quot;, but &quot;4&quot; alone is totally unambiguous,
2215            * so we try to drop &quot;just&quot; where possible.
2216            *
2217            * We have to be careful not to always drop &quot;just&quot;, though,
2218            * since &quot;nothing&quot; needs to be distinguishable from &quot;just
2219            * nothing&quot;.  The case where we need to ensure we keep the
2220            * &quot;just&quot; is actually exactly the case where we have a nested
2221            * Nothing.
2222            *
2223            * Instead of searching for that nested Nothing, we just print
2224            * the contained value into a separate string and see if we
2225            * end up with &quot;nothing&quot; at the end of it.  If so, we need to
2226            * add &quot;just&quot; at our level.
2227            */
2228           element = g_variant_get_child_value (value, 0);
2229           printed_child = g_variant_print (element, FALSE);
2230           g_variant_unref (element);
2231 
2232           if (g_str_has_suffix (printed_child, &quot;nothing&quot;))
2233             g_string_append (string, &quot;just &quot;);
2234           g_string_append (string, printed_child);
2235           g_free (printed_child);
2236         }
2237       else
2238         g_string_append (string, &quot;nothing&quot;);
2239 
2240       break;
2241 
2242     case G_VARIANT_CLASS_ARRAY:
2243       /* it&#39;s an array so the first character of the type string is &#39;a&#39;
2244        *
2245        * if the first two characters are &#39;ay&#39; then it&#39;s a bytestring.
2246        * under certain conditions we print those as strings.
2247        */
2248       if (g_variant_get_type_string (value)[1] == &#39;y&#39;)
2249         {
2250           const gchar *str;
2251           gsize size;
2252           gsize i;
2253 
2254           /* first determine if it is a byte string.
2255            * that&#39;s when there&#39;s a single nul character: at the end.
2256            */
2257           str = g_variant_get_data (value);
2258           size = g_variant_get_size (value);
2259 
2260           for (i = 0; i &lt; size; i++)
2261             if (str[i] == &#39;\0&#39;)
2262               break;
2263 
2264           /* first nul byte is the last byte -&gt; it&#39;s a byte string. */
2265           if (i == size - 1)
2266             {
2267               gchar *escaped = g_strescape (str, NULL);
2268 
2269               /* use double quotes only if a &#39; is in the string */
2270               if (strchr (str, &#39;\&#39;&#39;))
2271                 g_string_append_printf (string, &quot;b\&quot;%s\&quot;&quot;, escaped);
2272               else
2273                 g_string_append_printf (string, &quot;b&#39;%s&#39;&quot;, escaped);
2274 
2275               g_free (escaped);
2276               break;
2277             }
2278 
2279           else
2280             {
2281               /* fall through and handle normally... */
<a name="22" id="anc22"></a><span class="line-modified">2282         }</span>
2283         }
2284 
2285       /*
2286        * if the first two characters are &#39;a{&#39; then it&#39;s an array of
2287        * dictionary entries (ie: a dictionary) so we print that
2288        * differently.
2289        */
2290       if (g_variant_get_type_string (value)[1] == &#39;{&#39;)
2291         /* dictionary */
2292         {
2293           const gchar *comma = &quot;&quot;;
2294           gsize n, i;
2295 
2296           if ((n = g_variant_n_children (value)) == 0)
2297             {
2298               if (type_annotate)
2299                 g_string_append_printf (string, &quot;@%s &quot;,
2300                                         g_variant_get_type_string (value));
2301               g_string_append (string, &quot;{}&quot;);
2302               break;
2303             }
2304 
2305           g_string_append_c (string, &#39;{&#39;);
2306           for (i = 0; i &lt; n; i++)
2307             {
2308               GVariant *entry, *key, *val;
2309 
2310               g_string_append (string, comma);
2311               comma = &quot;, &quot;;
2312 
2313               entry = g_variant_get_child_value (value, i);
2314               key = g_variant_get_child_value (entry, 0);
2315               val = g_variant_get_child_value (entry, 1);
2316               g_variant_unref (entry);
2317 
2318               g_variant_print_string (key, string, type_annotate);
2319               g_variant_unref (key);
2320               g_string_append (string, &quot;: &quot;);
2321               g_variant_print_string (val, string, type_annotate);
2322               g_variant_unref (val);
2323               type_annotate = FALSE;
2324             }
2325           g_string_append_c (string, &#39;}&#39;);
2326         }
2327       else
2328         /* normal (non-dictionary) array */
2329         {
2330           const gchar *comma = &quot;&quot;;
2331           gsize n, i;
2332 
2333           if ((n = g_variant_n_children (value)) == 0)
2334             {
2335               if (type_annotate)
2336                 g_string_append_printf (string, &quot;@%s &quot;,
2337                                         g_variant_get_type_string (value));
2338               g_string_append (string, &quot;[]&quot;);
2339               break;
2340             }
2341 
2342           g_string_append_c (string, &#39;[&#39;);
2343           for (i = 0; i &lt; n; i++)
2344             {
2345               GVariant *element;
2346 
2347               g_string_append (string, comma);
2348               comma = &quot;, &quot;;
2349 
2350               element = g_variant_get_child_value (value, i);
2351 
2352               g_variant_print_string (element, string, type_annotate);
2353               g_variant_unref (element);
2354               type_annotate = FALSE;
2355             }
2356           g_string_append_c (string, &#39;]&#39;);
2357         }
2358 
2359       break;
2360 
2361     case G_VARIANT_CLASS_TUPLE:
2362       {
2363         gsize n, i;
2364 
2365         n = g_variant_n_children (value);
2366 
2367         g_string_append_c (string, &#39;(&#39;);
2368         for (i = 0; i &lt; n; i++)
2369           {
2370             GVariant *element;
2371 
2372             element = g_variant_get_child_value (value, i);
2373             g_variant_print_string (element, string, type_annotate);
2374             g_string_append (string, &quot;, &quot;);
2375             g_variant_unref (element);
2376           }
2377 
2378         /* for &gt;1 item:  remove final &quot;, &quot;
2379          * for 1 item:   remove final &quot; &quot;, but leave the &quot;,&quot;
2380          * for 0 items:  there is only &quot;(&quot;, so remove nothing
2381          */
2382         g_string_truncate (string, string-&gt;len - (n &gt; 0) - (n &gt; 1));
2383         g_string_append_c (string, &#39;)&#39;);
2384       }
2385       break;
2386 
2387     case G_VARIANT_CLASS_DICT_ENTRY:
2388       {
2389         GVariant *element;
2390 
2391         g_string_append_c (string, &#39;{&#39;);
2392 
2393         element = g_variant_get_child_value (value, 0);
2394         g_variant_print_string (element, string, type_annotate);
2395         g_variant_unref (element);
2396 
2397         g_string_append (string, &quot;, &quot;);
2398 
2399         element = g_variant_get_child_value (value, 1);
2400         g_variant_print_string (element, string, type_annotate);
2401         g_variant_unref (element);
2402 
2403         g_string_append_c (string, &#39;}&#39;);
2404       }
2405       break;
2406 
2407     case G_VARIANT_CLASS_VARIANT:
2408       {
2409         GVariant *child = g_variant_get_variant (value);
2410 
2411         /* Always annotate types in nested variants, because they are
2412          * (by nature) of variable type.
2413          */
2414         g_string_append_c (string, &#39;&lt;&#39;);
2415         g_variant_print_string (child, string, TRUE);
2416         g_string_append_c (string, &#39;&gt;&#39;);
2417 
2418         g_variant_unref (child);
2419       }
2420       break;
2421 
2422     case G_VARIANT_CLASS_BOOLEAN:
2423       if (g_variant_get_boolean (value))
2424         g_string_append (string, &quot;true&quot;);
2425       else
2426         g_string_append (string, &quot;false&quot;);
2427       break;
2428 
2429     case G_VARIANT_CLASS_STRING:
2430       {
2431         const gchar *str = g_variant_get_string (value, NULL);
2432         gunichar quote = strchr (str, &#39;\&#39;&#39;) ? &#39;&quot;&#39; : &#39;\&#39;&#39;;
2433 
2434         g_string_append_c (string, quote);
2435 
2436         while (*str)
2437           {
2438             gunichar c = g_utf8_get_char (str);
2439 
2440             if (c == quote || c == &#39;\\&#39;)
2441               g_string_append_c (string, &#39;\\&#39;);
2442 
2443             if (g_unichar_isprint (c))
2444               g_string_append_unichar (string, c);
2445 
2446             else
2447               {
2448                 g_string_append_c (string, &#39;\\&#39;);
2449                 if (c &lt; 0x10000)
2450                   switch (c)
2451                     {
2452                     case &#39;\a&#39;:
2453                       g_string_append_c (string, &#39;a&#39;);
2454                       break;
2455 
2456                     case &#39;\b&#39;:
2457                       g_string_append_c (string, &#39;b&#39;);
2458                       break;
2459 
2460                     case &#39;\f&#39;:
2461                       g_string_append_c (string, &#39;f&#39;);
2462                       break;
2463 
2464                     case &#39;\n&#39;:
2465                       g_string_append_c (string, &#39;n&#39;);
2466                       break;
2467 
2468                     case &#39;\r&#39;:
2469                       g_string_append_c (string, &#39;r&#39;);
2470                       break;
2471 
2472                     case &#39;\t&#39;:
2473                       g_string_append_c (string, &#39;t&#39;);
2474                       break;
2475 
2476                     case &#39;\v&#39;:
2477                       g_string_append_c (string, &#39;v&#39;);
2478                       break;
2479 
2480                     default:
2481                       g_string_append_printf (string, &quot;u%04x&quot;, c);
2482                       break;
2483                     }
2484                  else
2485                    g_string_append_printf (string, &quot;U%08x&quot;, c);
2486               }
2487 
2488             str = g_utf8_next_char (str);
2489           }
2490 
2491         g_string_append_c (string, quote);
2492       }
2493       break;
2494 
2495     case G_VARIANT_CLASS_BYTE:
2496       if (type_annotate)
2497         g_string_append (string, &quot;byte &quot;);
2498       g_string_append_printf (string, &quot;0x%02x&quot;,
2499                               g_variant_get_byte (value));
2500       break;
2501 
2502     case G_VARIANT_CLASS_INT16:
2503       if (type_annotate)
2504         g_string_append (string, &quot;int16 &quot;);
2505       g_string_append_printf (string, &quot;%&quot;G_GINT16_FORMAT,
2506                               g_variant_get_int16 (value));
2507       break;
2508 
2509     case G_VARIANT_CLASS_UINT16:
2510       if (type_annotate)
2511         g_string_append (string, &quot;uint16 &quot;);
2512       g_string_append_printf (string, &quot;%&quot;G_GUINT16_FORMAT,
2513                               g_variant_get_uint16 (value));
2514       break;
2515 
2516     case G_VARIANT_CLASS_INT32:
2517       /* Never annotate this type because it is the default for numbers
2518        * (and this is a *pretty* printer)
2519        */
2520       g_string_append_printf (string, &quot;%&quot;G_GINT32_FORMAT,
2521                               g_variant_get_int32 (value));
2522       break;
2523 
2524     case G_VARIANT_CLASS_HANDLE:
2525       if (type_annotate)
2526         g_string_append (string, &quot;handle &quot;);
2527       g_string_append_printf (string, &quot;%&quot;G_GINT32_FORMAT,
2528                               g_variant_get_handle (value));
2529       break;
2530 
2531     case G_VARIANT_CLASS_UINT32:
2532       if (type_annotate)
2533         g_string_append (string, &quot;uint32 &quot;);
2534       g_string_append_printf (string, &quot;%&quot;G_GUINT32_FORMAT,
2535                               g_variant_get_uint32 (value));
2536       break;
2537 
2538     case G_VARIANT_CLASS_INT64:
2539       if (type_annotate)
2540         g_string_append (string, &quot;int64 &quot;);
2541       g_string_append_printf (string, &quot;%&quot;G_GINT64_FORMAT,
2542                               g_variant_get_int64 (value));
2543       break;
2544 
2545     case G_VARIANT_CLASS_UINT64:
2546       if (type_annotate)
2547         g_string_append (string, &quot;uint64 &quot;);
2548       g_string_append_printf (string, &quot;%&quot;G_GUINT64_FORMAT,
2549                               g_variant_get_uint64 (value));
2550       break;
2551 
2552     case G_VARIANT_CLASS_DOUBLE:
2553       {
2554         gchar buffer[100];
2555         gint i;
2556 
2557         g_ascii_dtostr (buffer, sizeof buffer, g_variant_get_double (value));
2558 
2559         for (i = 0; buffer[i]; i++)
2560           if (buffer[i] == &#39;.&#39; || buffer[i] == &#39;e&#39; ||
2561               buffer[i] == &#39;n&#39; || buffer[i] == &#39;N&#39;)
2562             break;
2563 
2564         /* if there is no &#39;.&#39; or &#39;e&#39; in the float then add one */
2565         if (buffer[i] == &#39;\0&#39;)
2566           {
2567             buffer[i++] = &#39;.&#39;;
2568             buffer[i++] = &#39;0&#39;;
2569             buffer[i++] = &#39;\0&#39;;
2570           }
2571 
2572         g_string_append (string, buffer);
2573       }
2574       break;
2575 
2576     case G_VARIANT_CLASS_OBJECT_PATH:
2577       if (type_annotate)
2578         g_string_append (string, &quot;objectpath &quot;);
2579       g_string_append_printf (string, &quot;\&#39;%s\&#39;&quot;,
2580                               g_variant_get_string (value, NULL));
2581       break;
2582 
2583     case G_VARIANT_CLASS_SIGNATURE:
2584       if (type_annotate)
2585         g_string_append (string, &quot;signature &quot;);
2586       g_string_append_printf (string, &quot;\&#39;%s\&#39;&quot;,
2587                               g_variant_get_string (value, NULL));
2588       break;
2589 
2590     default:
2591       g_assert_not_reached ();
2592   }
2593 
2594   return string;
2595 }
2596 
2597 /**
2598  * g_variant_print:
2599  * @value: a #GVariant
2600  * @type_annotate: %TRUE if type information should be included in
2601  *                 the output
2602  *
2603  * Pretty-prints @value in the format understood by g_variant_parse().
2604  *
2605  * The format is described [here][gvariant-text].
2606  *
2607  * If @type_annotate is %TRUE, then type information is included in
2608  * the output.
2609  *
2610  * Returns: (transfer full): a newly-allocated string holding the result.
2611  *
2612  * Since: 2.24
2613  */
2614 gchar *
2615 g_variant_print (GVariant *value,
2616                  gboolean  type_annotate)
2617 {
2618   return g_string_free (g_variant_print_string (value, NULL, type_annotate),
2619                         FALSE);
2620 }
2621 
2622 /* Hash, Equal, Compare {{{1 */
2623 /**
2624  * g_variant_hash:
2625  * @value: (type GVariant): a basic #GVariant value as a #gconstpointer
2626  *
2627  * Generates a hash value for a #GVariant instance.
2628  *
2629  * The output of this function is guaranteed to be the same for a given
2630  * value only per-process.  It may change between different processor
2631  * architectures or even different versions of GLib.  Do not use this
2632  * function as a basis for building protocols or file formats.
2633  *
2634  * The type of @value is #gconstpointer only to allow use of this
2635  * function with #GHashTable.  @value must be a #GVariant.
2636  *
2637  * Returns: a hash value corresponding to @value
2638  *
2639  * Since: 2.24
2640  **/
2641 guint
2642 g_variant_hash (gconstpointer value_)
2643 {
2644   GVariant *value = (GVariant *) value_;
2645 
2646   switch (g_variant_classify (value))
2647     {
2648     case G_VARIANT_CLASS_STRING:
2649     case G_VARIANT_CLASS_OBJECT_PATH:
2650     case G_VARIANT_CLASS_SIGNATURE:
2651       return g_str_hash (g_variant_get_string (value, NULL));
2652 
2653     case G_VARIANT_CLASS_BOOLEAN:
2654       /* this is a very odd thing to hash... */
2655       return g_variant_get_boolean (value);
2656 
2657     case G_VARIANT_CLASS_BYTE:
2658       return g_variant_get_byte (value);
2659 
2660     case G_VARIANT_CLASS_INT16:
2661     case G_VARIANT_CLASS_UINT16:
2662       {
2663         const guint16 *ptr;
2664 
2665         ptr = g_variant_get_data (value);
2666 
2667         if (ptr)
2668           return *ptr;
2669         else
2670           return 0;
2671       }
2672 
2673     case G_VARIANT_CLASS_INT32:
2674     case G_VARIANT_CLASS_UINT32:
2675     case G_VARIANT_CLASS_HANDLE:
2676       {
2677         const guint *ptr;
2678 
2679         ptr = g_variant_get_data (value);
2680 
2681         if (ptr)
2682           return *ptr;
2683         else
2684           return 0;
2685       }
2686 
2687     case G_VARIANT_CLASS_INT64:
2688     case G_VARIANT_CLASS_UINT64:
2689     case G_VARIANT_CLASS_DOUBLE:
2690       /* need a separate case for these guys because otherwise
2691        * performance could be quite bad on big endian systems
2692        */
2693       {
2694         const guint *ptr;
2695 
2696         ptr = g_variant_get_data (value);
2697 
2698         if (ptr)
2699           return ptr[0] + ptr[1];
2700         else
2701           return 0;
2702       }
2703 
2704     default:
2705       g_return_val_if_fail (!g_variant_is_container (value), 0);
2706       g_assert_not_reached ();
2707     }
2708 }
2709 
2710 /**
2711  * g_variant_equal:
2712  * @one: (type GVariant): a #GVariant instance
2713  * @two: (type GVariant): a #GVariant instance
2714  *
2715  * Checks if @one and @two have the same type and value.
2716  *
2717  * The types of @one and @two are #gconstpointer only to allow use of
2718  * this function with #GHashTable.  They must each be a #GVariant.
2719  *
2720  * Returns: %TRUE if @one and @two are equal
2721  *
2722  * Since: 2.24
2723  **/
2724 gboolean
2725 g_variant_equal (gconstpointer one,
2726                  gconstpointer two)
2727 {
2728   gboolean equal;
2729 
2730   g_return_val_if_fail (one != NULL &amp;&amp; two != NULL, FALSE);
2731 
2732   if (g_variant_get_type_info ((GVariant *) one) !=
2733       g_variant_get_type_info ((GVariant *) two))
2734     return FALSE;
2735 
2736   /* if both values are trusted to be in their canonical serialised form
2737    * then a simple memcmp() of their serialised data will answer the
2738    * question.
2739    *
2740    * if not, then this might generate a false negative (since it is
2741    * possible for two different byte sequences to represent the same
2742    * value).  for now we solve this by pretty-printing both values and
2743    * comparing the result.
2744    */
2745   if (g_variant_is_trusted ((GVariant *) one) &amp;&amp;
2746       g_variant_is_trusted ((GVariant *) two))
2747     {
2748       gconstpointer data_one, data_two;
2749       gsize size_one, size_two;
2750 
2751       size_one = g_variant_get_size ((GVariant *) one);
2752       size_two = g_variant_get_size ((GVariant *) two);
2753 
2754       if (size_one != size_two)
2755         return FALSE;
2756 
2757       data_one = g_variant_get_data ((GVariant *) one);
2758       data_two = g_variant_get_data ((GVariant *) two);
2759 
2760       equal = memcmp (data_one, data_two, size_one) == 0;
2761     }
2762   else
2763     {
2764       gchar *strone, *strtwo;
2765 
2766       strone = g_variant_print ((GVariant *) one, FALSE);
2767       strtwo = g_variant_print ((GVariant *) two, FALSE);
2768       equal = strcmp (strone, strtwo) == 0;
2769       g_free (strone);
2770       g_free (strtwo);
2771     }
2772 
2773   return equal;
2774 }
2775 
2776 /**
2777  * g_variant_compare:
2778  * @one: (type GVariant): a basic-typed #GVariant instance
2779  * @two: (type GVariant): a #GVariant instance of the same type
2780  *
2781  * Compares @one and @two.
2782  *
2783  * The types of @one and @two are #gconstpointer only to allow use of
2784  * this function with #GTree, #GPtrArray, etc.  They must each be a
2785  * #GVariant.
2786  *
2787  * Comparison is only defined for basic types (ie: booleans, numbers,
2788  * strings).  For booleans, %FALSE is less than %TRUE.  Numbers are
2789  * ordered in the usual way.  Strings are in ASCII lexographical order.
2790  *
2791  * It is a programmer error to attempt to compare container values or
2792  * two values that have types that are not exactly equal.  For example,
2793  * you cannot compare a 32-bit signed integer with a 32-bit unsigned
2794  * integer.  Also note that this function is not particularly
2795  * well-behaved when it comes to comparison of doubles; in particular,
2796  * the handling of incomparable values (ie: NaN) is undefined.
2797  *
2798  * If you only require an equality comparison, g_variant_equal() is more
2799  * general.
2800  *
2801  * Returns: negative value if a &lt; b;
2802  *          zero if a = b;
2803  *          positive value if a &gt; b.
2804  *
2805  * Since: 2.26
2806  **/
2807 gint
2808 g_variant_compare (gconstpointer one,
2809                    gconstpointer two)
2810 {
2811   GVariant *a = (GVariant *) one;
2812   GVariant *b = (GVariant *) two;
2813 
2814   g_return_val_if_fail (g_variant_classify (a) == g_variant_classify (b), 0);
2815 
2816   switch (g_variant_classify (a))
2817     {
2818     case G_VARIANT_CLASS_BOOLEAN:
2819       return g_variant_get_boolean (a) -
2820              g_variant_get_boolean (b);
2821 
2822     case G_VARIANT_CLASS_BYTE:
2823       return ((gint) g_variant_get_byte (a)) -
2824              ((gint) g_variant_get_byte (b));
2825 
2826     case G_VARIANT_CLASS_INT16:
2827       return ((gint) g_variant_get_int16 (a)) -
2828              ((gint) g_variant_get_int16 (b));
2829 
2830     case G_VARIANT_CLASS_UINT16:
2831       return ((gint) g_variant_get_uint16 (a)) -
2832              ((gint) g_variant_get_uint16 (b));
2833 
2834     case G_VARIANT_CLASS_INT32:
2835       {
2836         gint32 a_val = g_variant_get_int32 (a);
2837         gint32 b_val = g_variant_get_int32 (b);
2838 
2839         return (a_val == b_val) ? 0 : (a_val &gt; b_val) ? 1 : -1;
2840       }
2841 
2842     case G_VARIANT_CLASS_UINT32:
2843       {
2844         guint32 a_val = g_variant_get_uint32 (a);
2845         guint32 b_val = g_variant_get_uint32 (b);
2846 
2847         return (a_val == b_val) ? 0 : (a_val &gt; b_val) ? 1 : -1;
2848       }
2849 
2850     case G_VARIANT_CLASS_INT64:
2851       {
2852         gint64 a_val = g_variant_get_int64 (a);
2853         gint64 b_val = g_variant_get_int64 (b);
2854 
2855         return (a_val == b_val) ? 0 : (a_val &gt; b_val) ? 1 : -1;
2856       }
2857 
2858     case G_VARIANT_CLASS_UINT64:
2859       {
2860         guint64 a_val = g_variant_get_uint64 (a);
2861         guint64 b_val = g_variant_get_uint64 (b);
2862 
2863         return (a_val == b_val) ? 0 : (a_val &gt; b_val) ? 1 : -1;
2864       }
2865 
2866     case G_VARIANT_CLASS_DOUBLE:
2867       {
2868         gdouble a_val = g_variant_get_double (a);
2869         gdouble b_val = g_variant_get_double (b);
2870 
2871         return (a_val == b_val) ? 0 : (a_val &gt; b_val) ? 1 : -1;
2872       }
2873 
2874     case G_VARIANT_CLASS_STRING:
2875     case G_VARIANT_CLASS_OBJECT_PATH:
2876     case G_VARIANT_CLASS_SIGNATURE:
2877       return strcmp (g_variant_get_string (a, NULL),
2878                      g_variant_get_string (b, NULL));
2879 
2880     default:
2881       g_return_val_if_fail (!g_variant_is_container (a), 0);
2882       g_assert_not_reached ();
2883     }
2884 }
2885 
2886 /* GVariantIter {{{1 */
2887 /**
2888  * GVariantIter: (skip)
2889  *
2890  * #GVariantIter is an opaque data structure and can only be accessed
2891  * using the following functions.
2892  **/
2893 struct stack_iter
2894 {
2895   GVariant *value;
2896   gssize n, i;
2897 
2898   const gchar *loop_format;
2899 
2900   gsize padding[3];
2901   gsize magic;
2902 };
2903 
2904 G_STATIC_ASSERT (sizeof (struct stack_iter) &lt;= sizeof (GVariantIter));
2905 
2906 struct heap_iter
2907 {
2908   struct stack_iter iter;
2909 
2910   GVariant *value_ref;
2911   gsize magic;
2912 };
2913 
2914 #define GVSI(i)                 ((struct stack_iter *) (i))
2915 #define GVHI(i)                 ((struct heap_iter *) (i))
2916 #define GVSI_MAGIC              ((gsize) 3579507750u)
2917 #define GVHI_MAGIC              ((gsize) 1450270775u)
2918 #define is_valid_iter(i)        (i != NULL &amp;&amp; \
2919                                  GVSI(i)-&gt;magic == GVSI_MAGIC)
2920 #define is_valid_heap_iter(i)   (is_valid_iter(i) &amp;&amp; \
2921                                  GVHI(i)-&gt;magic == GVHI_MAGIC)
2922 
2923 /**
2924  * g_variant_iter_new:
2925  * @value: a container #GVariant
2926  *
2927  * Creates a heap-allocated #GVariantIter for iterating over the items
2928  * in @value.
2929  *
2930  * Use g_variant_iter_free() to free the return value when you no longer
2931  * need it.
2932  *
2933  * A reference is taken to @value and will be released only when
2934  * g_variant_iter_free() is called.
2935  *
2936  * Returns: (transfer full): a new heap-allocated #GVariantIter
2937  *
2938  * Since: 2.24
2939  **/
2940 GVariantIter *
2941 g_variant_iter_new (GVariant *value)
2942 {
2943   GVariantIter *iter;
2944 
2945   iter = (GVariantIter *) g_slice_new (struct heap_iter);
2946 #ifdef GSTREAMER_LITE
2947   if (iter == NULL) {
2948     return NULL;
2949   }
2950 #endif // GSTREAMER_LITE
2951   GVHI(iter)-&gt;value_ref = g_variant_ref (value);
2952   GVHI(iter)-&gt;magic = GVHI_MAGIC;
2953 
2954   g_variant_iter_init (iter, value);
2955 
2956   return iter;
2957 }
2958 
2959 /**
2960  * g_variant_iter_init: (skip)
2961  * @iter: a pointer to a #GVariantIter
2962  * @value: a container #GVariant
2963  *
2964  * Initialises (without allocating) a #GVariantIter.  @iter may be
2965  * completely uninitialised prior to this call; its old value is
2966  * ignored.
2967  *
2968  * The iterator remains valid for as long as @value exists, and need not
2969  * be freed in any way.
2970  *
2971  * Returns: the number of items in @value
2972  *
2973  * Since: 2.24
2974  **/
2975 gsize
2976 g_variant_iter_init (GVariantIter *iter,
2977                      GVariant     *value)
2978 {
2979   GVSI(iter)-&gt;magic = GVSI_MAGIC;
2980   GVSI(iter)-&gt;value = value;
2981   GVSI(iter)-&gt;n = g_variant_n_children (value);
2982   GVSI(iter)-&gt;i = -1;
2983   GVSI(iter)-&gt;loop_format = NULL;
2984 
2985   return GVSI(iter)-&gt;n;
2986 }
2987 
2988 #ifndef GSTREAMER_LITE
2989 /**
2990  * g_variant_iter_copy:
2991  * @iter: a #GVariantIter
2992  *
2993  * Creates a new heap-allocated #GVariantIter to iterate over the
2994  * container that was being iterated over by @iter.  Iteration begins on
2995  * the new iterator from the current position of the old iterator but
2996  * the two copies are independent past that point.
2997  *
2998  * Use g_variant_iter_free() to free the return value when you no longer
2999  * need it.
3000  *
3001  * A reference is taken to the container that @iter is iterating over
3002  * and will be releated only when g_variant_iter_free() is called.
3003  *
3004  * Returns: (transfer full): a new heap-allocated #GVariantIter
3005  *
3006  * Since: 2.24
3007  **/
3008 GVariantIter *
3009 g_variant_iter_copy (GVariantIter *iter)
3010 {
3011   GVariantIter *copy;
3012 
3013 #ifdef GSTREAMER_LITE
3014   if (iter == NULL) {
3015     return NULL;
3016   }
3017 #endif // GSTREAMER_LITE
3018 
3019   g_return_val_if_fail (is_valid_iter (iter), 0);
3020 
3021   copy = g_variant_iter_new (GVSI(iter)-&gt;value);
3022   GVSI(copy)-&gt;i = GVSI(iter)-&gt;i;
3023 
3024   return copy;
3025 }
3026 #endif // GSTREAMER_LITE
3027 
3028 /**
3029  * g_variant_iter_n_children:
3030  * @iter: a #GVariantIter
3031  *
3032  * Queries the number of child items in the container that we are
3033  * iterating over.  This is the total number of items -- not the number
3034  * of items remaining.
3035  *
3036  * This function might be useful for preallocation of arrays.
3037  *
3038  * Returns: the number of children in the container
3039  *
3040  * Since: 2.24
3041  **/
3042 gsize
3043 g_variant_iter_n_children (GVariantIter *iter)
3044 {
3045   g_return_val_if_fail (is_valid_iter (iter), 0);
3046 
3047   return GVSI(iter)-&gt;n;
3048 }
3049 
3050 /**
3051  * g_variant_iter_free:
3052  * @iter: (transfer full): a heap-allocated #GVariantIter
3053  *
3054  * Frees a heap-allocated #GVariantIter.  Only call this function on
3055  * iterators that were returned by g_variant_iter_new() or
3056  * g_variant_iter_copy().
3057  *
3058  * Since: 2.24
3059  **/
3060 void
3061 g_variant_iter_free (GVariantIter *iter)
3062 {
3063   g_return_if_fail (is_valid_heap_iter (iter));
3064 
3065   g_variant_unref (GVHI(iter)-&gt;value_ref);
3066   GVHI(iter)-&gt;magic = 0;
3067 
3068   g_slice_free (struct heap_iter, GVHI(iter));
3069 }
3070 
3071 /**
3072  * g_variant_iter_next_value:
3073  * @iter: a #GVariantIter
3074  *
3075  * Gets the next item in the container.  If no more items remain then
3076  * %NULL is returned.
3077  *
3078  * Use g_variant_unref() to drop your reference on the return value when
3079  * you no longer need it.
3080  *
3081  * Here is an example for iterating with g_variant_iter_next_value():
3082  * |[&lt;!-- language=&quot;C&quot; --&gt;
3083  *   // recursively iterate a container
3084  *   void
3085  *   iterate_container_recursive (GVariant *container)
3086  *   {
3087  *     GVariantIter iter;
3088  *     GVariant *child;
3089  *
3090  *     g_variant_iter_init (&amp;iter, container);
3091  *     while ((child = g_variant_iter_next_value (&amp;iter)))
3092  *       {
3093  *         g_print (&quot;type &#39;%s&#39;\n&quot;, g_variant_get_type_string (child));
3094  *
3095  *         if (g_variant_is_container (child))
3096  *           iterate_container_recursive (child);
3097  *
3098  *         g_variant_unref (child);
3099  *       }
3100  *   }
3101  * ]|
3102  *
3103  * Returns: (nullable) (transfer full): a #GVariant, or %NULL
3104  *
3105  * Since: 2.24
3106  **/
3107 GVariant *
3108 g_variant_iter_next_value (GVariantIter *iter)
3109 {
3110   g_return_val_if_fail (is_valid_iter (iter), FALSE);
3111 
3112   if G_UNLIKELY (GVSI(iter)-&gt;i &gt;= GVSI(iter)-&gt;n)
3113     {
3114       g_critical (&quot;g_variant_iter_next_value: must not be called again &quot;
3115                   &quot;after NULL has already been returned.&quot;);
3116       return NULL;
3117     }
3118 
3119   GVSI(iter)-&gt;i++;
3120 
3121   if (GVSI(iter)-&gt;i &lt; GVSI(iter)-&gt;n)
3122     return g_variant_get_child_value (GVSI(iter)-&gt;value, GVSI(iter)-&gt;i);
3123 
3124   return NULL;
3125 }
3126 
3127 /* GVariantBuilder {{{1 */
3128 /**
3129  * GVariantBuilder:
3130  *
3131  * A utility type for constructing container-type #GVariant instances.
3132  *
3133  * This is an opaque structure and may only be accessed using the
3134  * following functions.
3135  *
3136  * #GVariantBuilder is not threadsafe in any way.  Do not attempt to
3137  * access it from more than one thread.
3138  **/
3139 
3140 struct stack_builder
3141 {
3142   GVariantBuilder *parent;
3143   GVariantType *type;
3144 
3145   /* type constraint explicitly specified by &#39;type&#39;.
3146    * for tuple types, this moves along as we add more items.
3147    */
3148   const GVariantType *expected_type;
3149 
3150   /* type constraint implied by previous array item.
3151    */
3152   const GVariantType *prev_item_type;
3153 
3154   /* constraints on the number of children.  max = -1 for unlimited. */
3155   gsize min_items;
3156   gsize max_items;
3157 
3158   /* dynamically-growing pointer array */
3159   GVariant **children;
3160   gsize allocated_children;
3161   gsize offset;
3162 
3163   /* set to &#39;1&#39; if all items in the container will have the same type
3164    * (ie: maybe, array, variant) &#39;0&#39; if not (ie: tuple, dict entry)
3165    */
3166   guint uniform_item_types : 1;
3167 
3168   /* set to &#39;1&#39; initially and changed to &#39;0&#39; if an untrusted value is
3169    * added
3170    */
3171   guint trusted : 1;
3172 
3173   gsize magic;
3174 };
3175 
3176 G_STATIC_ASSERT (sizeof (struct stack_builder) &lt;= sizeof (GVariantBuilder));
3177 
3178 struct heap_builder
3179 {
3180   GVariantBuilder builder;
3181   gsize magic;
3182 
3183   gint ref_count;
3184 };
3185 
3186 #define GVSB(b)                  ((struct stack_builder *) (b))
3187 #define GVHB(b)                  ((struct heap_builder *) (b))
3188 #define GVSB_MAGIC               ((gsize) 1033660112u)
3189 #define GVSB_MAGIC_PARTIAL       ((gsize) 2942751021u)
3190 #define GVHB_MAGIC               ((gsize) 3087242682u)
3191 #define is_valid_builder(b)      (b != NULL &amp;&amp; \
3192                                   GVSB(b)-&gt;magic == GVSB_MAGIC)
3193 #define is_valid_heap_builder(b) (GVHB(b)-&gt;magic == GVHB_MAGIC)
3194 
3195 /* Just to make sure that by adding a union to GVariantBuilder, we
3196  * didn&#39;t accidentally change ABI. */
3197 G_STATIC_ASSERT (sizeof (GVariantBuilder) == sizeof (gsize[16]));
3198 
3199 static gboolean
3200 ensure_valid_builder (GVariantBuilder *builder)
3201 {
3202   if (is_valid_builder (builder))
3203     return TRUE;
3204   if (builder-&gt;u.s.partial_magic == GVSB_MAGIC_PARTIAL)
3205     {
3206       static GVariantBuilder cleared_builder;
3207 
3208       /* Make sure that only first two fields were set and the rest is
3209        * zeroed to avoid messing up the builder that had parent
3210        * address equal to GVSB_MAGIC_PARTIAL. */
3211       if (memcmp (cleared_builder.u.s.y, builder-&gt;u.s.y, sizeof cleared_builder.u.s.y))
3212         return FALSE;
3213 
3214       g_variant_builder_init (builder, builder-&gt;u.s.type);
3215     }
3216   return is_valid_builder (builder);
3217 }
3218 
3219 /**
3220  * g_variant_builder_new:
3221  * @type: a container type
3222  *
3223  * Allocates and initialises a new #GVariantBuilder.
3224  *
3225  * You should call g_variant_builder_unref() on the return value when it
3226  * is no longer needed.  The memory will not be automatically freed by
3227  * any other call.
3228  *
3229  * In most cases it is easier to place a #GVariantBuilder directly on
3230  * the stack of the calling function and initialise it with
3231  * g_variant_builder_init().
3232  *
3233  * Returns: (transfer full): a #GVariantBuilder
3234  *
3235  * Since: 2.24
3236  **/
3237 GVariantBuilder *
3238 g_variant_builder_new (const GVariantType *type)
3239 {
3240   GVariantBuilder *builder;
3241 
3242   builder = (GVariantBuilder *) g_slice_new (struct heap_builder);
3243 #ifdef GSTREAMER_LITE
3244   if (builder == NULL) {
3245     return NULL;
3246   }
3247 #endif // GSTREAMER_LITE
3248   g_variant_builder_init (builder, type);
3249   GVHB(builder)-&gt;magic = GVHB_MAGIC;
3250   GVHB(builder)-&gt;ref_count = 1;
3251 
3252   return builder;
3253 }
3254 
3255 /**
3256  * g_variant_builder_unref:
3257  * @builder: (transfer full): a #GVariantBuilder allocated by g_variant_builder_new()
3258  *
3259  * Decreases the reference count on @builder.
3260  *
3261  * In the event that there are no more references, releases all memory
3262  * associated with the #GVariantBuilder.
3263  *
3264  * Don&#39;t call this on stack-allocated #GVariantBuilder instances or bad
3265  * things will happen.
3266  *
3267  * Since: 2.24
3268  **/
3269 void
3270 g_variant_builder_unref (GVariantBuilder *builder)
3271 {
3272   g_return_if_fail (is_valid_heap_builder (builder));
3273 
3274   if (--GVHB(builder)-&gt;ref_count)
3275     return;
3276 
3277   g_variant_builder_clear (builder);
3278   GVHB(builder)-&gt;magic = 0;
3279 
3280   g_slice_free (struct heap_builder, GVHB(builder));
3281 }
3282 
3283 /**
3284  * g_variant_builder_ref:
3285  * @builder: a #GVariantBuilder allocated by g_variant_builder_new()
3286  *
3287  * Increases the reference count on @builder.
3288  *
3289  * Don&#39;t call this on stack-allocated #GVariantBuilder instances or bad
3290  * things will happen.
3291  *
3292  * Returns: (transfer full): a new reference to @builder
3293  *
3294  * Since: 2.24
3295  **/
3296 GVariantBuilder *
3297 g_variant_builder_ref (GVariantBuilder *builder)
3298 {
3299   g_return_val_if_fail (is_valid_heap_builder (builder), NULL);
3300 
3301   GVHB(builder)-&gt;ref_count++;
3302 
3303   return builder;
3304 }
3305 
3306 /**
3307  * g_variant_builder_clear: (skip)
3308  * @builder: a #GVariantBuilder
3309  *
3310  * Releases all memory associated with a #GVariantBuilder without
3311  * freeing the #GVariantBuilder structure itself.
3312  *
3313  * It typically only makes sense to do this on a stack-allocated
3314  * #GVariantBuilder if you want to abort building the value part-way
3315  * through.  This function need not be called if you call
3316  * g_variant_builder_end() and it also doesn&#39;t need to be called on
3317  * builders allocated with g_variant_builder_new() (see
3318  * g_variant_builder_unref() for that).
3319  *
3320  * This function leaves the #GVariantBuilder structure set to all-zeros.
3321  * It is valid to call this function on either an initialised
3322  * #GVariantBuilder or one that is set to all-zeros but it is not valid
3323  * to call this function on uninitialised memory.
3324  *
3325  * Since: 2.24
3326  **/
3327 void
3328 g_variant_builder_clear (GVariantBuilder *builder)
3329 {
3330   gsize i;
3331 
3332   if (GVSB(builder)-&gt;magic == 0)
3333     /* all-zeros or partial case */
3334     return;
3335 
3336   g_return_if_fail (ensure_valid_builder (builder));
3337 
3338   g_variant_type_free (GVSB(builder)-&gt;type);
3339 
3340   for (i = 0; i &lt; GVSB(builder)-&gt;offset; i++)
3341     g_variant_unref (GVSB(builder)-&gt;children[i]);
3342 
3343   g_free (GVSB(builder)-&gt;children);
3344 
3345   if (GVSB(builder)-&gt;parent)
3346     {
3347       g_variant_builder_clear (GVSB(builder)-&gt;parent);
3348       g_slice_free (GVariantBuilder, GVSB(builder)-&gt;parent);
3349     }
3350 
3351   memset (builder, 0, sizeof (GVariantBuilder));
3352 }
3353 
3354 /**
3355  * g_variant_builder_init: (skip)
3356  * @builder: a #GVariantBuilder
3357  * @type: a container type
3358  *
3359  * Initialises a #GVariantBuilder structure.
3360  *
3361  * @type must be non-%NULL.  It specifies the type of container to
3362  * construct.  It can be an indefinite type such as
3363  * %G_VARIANT_TYPE_ARRAY or a definite type such as &quot;as&quot; or &quot;(ii)&quot;.
3364  * Maybe, array, tuple, dictionary entry and variant-typed values may be
3365  * constructed.
3366  *
3367  * After the builder is initialised, values are added using
3368  * g_variant_builder_add_value() or g_variant_builder_add().
3369  *
3370  * After all the child values are added, g_variant_builder_end() frees
3371  * the memory associated with the builder and returns the #GVariant that
3372  * was created.
3373  *
3374  * This function completely ignores the previous contents of @builder.
3375  * On one hand this means that it is valid to pass in completely
3376  * uninitialised memory.  On the other hand, this means that if you are
3377  * initialising over top of an existing #GVariantBuilder you need to
3378  * first call g_variant_builder_clear() in order to avoid leaking
3379  * memory.
3380  *
3381  * You must not call g_variant_builder_ref() or
3382  * g_variant_builder_unref() on a #GVariantBuilder that was initialised
3383  * with this function.  If you ever pass a reference to a
3384  * #GVariantBuilder outside of the control of your own code then you
3385  * should assume that the person receiving that reference may try to use
3386  * reference counting; you should use g_variant_builder_new() instead of
3387  * this function.
3388  *
3389  * Since: 2.24
3390  **/
3391 void
3392 g_variant_builder_init (GVariantBuilder    *builder,
3393                         const GVariantType *type)
3394 {
3395   g_return_if_fail (type != NULL);
3396   g_return_if_fail (g_variant_type_is_container (type));
3397 
3398   memset (builder, 0, sizeof (GVariantBuilder));
3399 
3400   GVSB(builder)-&gt;type = g_variant_type_copy (type);
3401   GVSB(builder)-&gt;magic = GVSB_MAGIC;
3402   GVSB(builder)-&gt;trusted = TRUE;
3403 
3404   switch (*(const gchar *) type)
3405     {
3406     case G_VARIANT_CLASS_VARIANT:
3407       GVSB(builder)-&gt;uniform_item_types = TRUE;
3408       GVSB(builder)-&gt;allocated_children = 1;
3409       GVSB(builder)-&gt;expected_type = NULL;
3410       GVSB(builder)-&gt;min_items = 1;
3411       GVSB(builder)-&gt;max_items = 1;
3412       break;
3413 
3414     case G_VARIANT_CLASS_ARRAY:
3415       GVSB(builder)-&gt;uniform_item_types = TRUE;
3416       GVSB(builder)-&gt;allocated_children = 8;
3417       GVSB(builder)-&gt;expected_type =
3418         g_variant_type_element (GVSB(builder)-&gt;type);
3419       GVSB(builder)-&gt;min_items = 0;
3420       GVSB(builder)-&gt;max_items = -1;
3421       break;
3422 
3423     case G_VARIANT_CLASS_MAYBE:
3424       GVSB(builder)-&gt;uniform_item_types = TRUE;
3425       GVSB(builder)-&gt;allocated_children = 1;
3426       GVSB(builder)-&gt;expected_type =
3427         g_variant_type_element (GVSB(builder)-&gt;type);
3428       GVSB(builder)-&gt;min_items = 0;
3429       GVSB(builder)-&gt;max_items = 1;
3430       break;
3431 
3432     case G_VARIANT_CLASS_DICT_ENTRY:
3433       GVSB(builder)-&gt;uniform_item_types = FALSE;
3434       GVSB(builder)-&gt;allocated_children = 2;
3435       GVSB(builder)-&gt;expected_type =
3436         g_variant_type_key (GVSB(builder)-&gt;type);
3437       GVSB(builder)-&gt;min_items = 2;
3438       GVSB(builder)-&gt;max_items = 2;
3439       break;
3440 
3441     case &#39;r&#39;: /* G_VARIANT_TYPE_TUPLE was given */
3442       GVSB(builder)-&gt;uniform_item_types = FALSE;
3443       GVSB(builder)-&gt;allocated_children = 8;
3444       GVSB(builder)-&gt;expected_type = NULL;
3445       GVSB(builder)-&gt;min_items = 0;
3446       GVSB(builder)-&gt;max_items = -1;
3447       break;
3448 
3449     case G_VARIANT_CLASS_TUPLE: /* a definite tuple type was given */
3450       GVSB(builder)-&gt;allocated_children = g_variant_type_n_items (type);
3451       GVSB(builder)-&gt;expected_type =
3452         g_variant_type_first (GVSB(builder)-&gt;type);
3453       GVSB(builder)-&gt;min_items = GVSB(builder)-&gt;allocated_children;
3454       GVSB(builder)-&gt;max_items = GVSB(builder)-&gt;allocated_children;
3455       GVSB(builder)-&gt;uniform_item_types = FALSE;
3456       break;
3457 
3458     default:
3459       g_assert_not_reached ();
3460    }
3461 
3462   GVSB(builder)-&gt;children = g_new (GVariant *,
3463                                    GVSB(builder)-&gt;allocated_children);
3464 }
3465 
3466 static void
3467 g_variant_builder_make_room (struct stack_builder *builder)
3468 {
3469   if (builder-&gt;offset == builder-&gt;allocated_children)
3470     {
3471       builder-&gt;allocated_children *= 2;
3472       builder-&gt;children = g_renew (GVariant *, builder-&gt;children,
3473                                    builder-&gt;allocated_children);
3474     }
3475 }
3476 
3477 /**
3478  * g_variant_builder_add_value:
3479  * @builder: a #GVariantBuilder
3480  * @value: a #GVariant
3481  *
3482  * Adds @value to @builder.
3483  *
3484  * It is an error to call this function in any way that would create an
3485  * inconsistent value to be constructed.  Some examples of this are
3486  * putting different types of items into an array, putting the wrong
3487  * types or number of items in a tuple, putting more than one value into
3488  * a variant, etc.
3489  *
3490  * If @value is a floating reference (see g_variant_ref_sink()),
3491  * the @builder instance takes ownership of @value.
3492  *
3493  * Since: 2.24
3494  **/
3495 void
3496 g_variant_builder_add_value (GVariantBuilder *builder,
3497                              GVariant        *value)
3498 {
3499   g_return_if_fail (ensure_valid_builder (builder));
3500   g_return_if_fail (GVSB(builder)-&gt;offset &lt; GVSB(builder)-&gt;max_items);
3501   g_return_if_fail (!GVSB(builder)-&gt;expected_type ||
3502                     g_variant_is_of_type (value,
3503                                           GVSB(builder)-&gt;expected_type));
3504   g_return_if_fail (!GVSB(builder)-&gt;prev_item_type ||
3505                     g_variant_is_of_type (value,
3506                                           GVSB(builder)-&gt;prev_item_type));
3507 
3508   GVSB(builder)-&gt;trusted &amp;= g_variant_is_trusted (value);
3509 
3510   if (!GVSB(builder)-&gt;uniform_item_types)
3511     {
3512       /* advance our expected type pointers */
3513       if (GVSB(builder)-&gt;expected_type)
3514         GVSB(builder)-&gt;expected_type =
3515           g_variant_type_next (GVSB(builder)-&gt;expected_type);
3516 
3517       if (GVSB(builder)-&gt;prev_item_type)
3518         GVSB(builder)-&gt;prev_item_type =
3519           g_variant_type_next (GVSB(builder)-&gt;prev_item_type);
3520     }
3521   else
3522     GVSB(builder)-&gt;prev_item_type = g_variant_get_type (value);
3523 
3524   g_variant_builder_make_room (GVSB(builder));
3525 
3526   GVSB(builder)-&gt;children[GVSB(builder)-&gt;offset++] =
3527     g_variant_ref_sink (value);
3528 }
3529 
3530 /**
3531  * g_variant_builder_open:
3532  * @builder: a #GVariantBuilder
3533  * @type: the #GVariantType of the container
3534  *
3535  * Opens a subcontainer inside the given @builder.  When done adding
3536  * items to the subcontainer, g_variant_builder_close() must be called. @type
3537  * is the type of the container: so to build a tuple of several values, @type
3538  * must include the tuple itself.
3539  *
3540  * It is an error to call this function in any way that would cause an
3541  * inconsistent value to be constructed (ie: adding too many values or
3542  * a value of an incorrect type).
3543  *
3544  * Example of building a nested variant:
3545  * |[&lt;!-- language=&quot;C&quot; --&gt;
3546  * GVariantBuilder builder;
3547  * guint32 some_number = get_number ();
3548  * g_autoptr (GHashTable) some_dict = get_dict ();
3549  * GHashTableIter iter;
3550  * const gchar *key;
3551  * const GVariant *value;
3552  * g_autoptr (GVariant) output = NULL;
3553  *
3554  * g_variant_builder_init (&amp;builder, G_VARIANT_TYPE (&quot;(ua{sv})&quot;));
3555  * g_variant_builder_add (&amp;builder, &quot;u&quot;, some_number);
3556  * g_variant_builder_open (&amp;builder, G_VARIANT_TYPE (&quot;a{sv}&quot;));
3557  *
3558  * g_hash_table_iter_init (&amp;iter, some_dict);
3559  * while (g_hash_table_iter_next (&amp;iter, (gpointer *) &amp;key, (gpointer *) &amp;value))
3560  *   {
3561  *     g_variant_builder_open (&amp;builder, G_VARIANT_TYPE (&quot;{sv}&quot;));
3562  *     g_variant_builder_add (&amp;builder, &quot;s&quot;, key);
3563  *     g_variant_builder_add (&amp;builder, &quot;v&quot;, value);
3564  *     g_variant_builder_close (&amp;builder);
3565  *   }
3566  *
3567  * g_variant_builder_close (&amp;builder);
3568  *
3569  * output = g_variant_builder_end (&amp;builder);
3570  * ]|
3571  *
3572  * Since: 2.24
3573  **/
3574 void
3575 g_variant_builder_open (GVariantBuilder    *builder,
3576                         const GVariantType *type)
3577 {
3578   GVariantBuilder *parent;
3579 
3580   g_return_if_fail (ensure_valid_builder (builder));
3581   g_return_if_fail (GVSB(builder)-&gt;offset &lt; GVSB(builder)-&gt;max_items);
3582   g_return_if_fail (!GVSB(builder)-&gt;expected_type ||
3583                     g_variant_type_is_subtype_of (type,
3584                                                   GVSB(builder)-&gt;expected_type));
3585   g_return_if_fail (!GVSB(builder)-&gt;prev_item_type ||
3586                     g_variant_type_is_subtype_of (GVSB(builder)-&gt;prev_item_type,
3587                                                   type));
3588 
3589   parent = g_slice_dup (GVariantBuilder, builder);
3590   g_variant_builder_init (builder, type);
3591   GVSB(builder)-&gt;parent = parent;
3592 
3593   /* push the prev_item_type down into the subcontainer */
3594   if (GVSB(parent)-&gt;prev_item_type)
3595     {
3596       if (!GVSB(builder)-&gt;uniform_item_types)
3597         /* tuples and dict entries */
3598         GVSB(builder)-&gt;prev_item_type =
3599           g_variant_type_first (GVSB(parent)-&gt;prev_item_type);
3600 
3601       else if (!g_variant_type_is_variant (GVSB(builder)-&gt;type))
3602         /* maybes and arrays */
3603         GVSB(builder)-&gt;prev_item_type =
3604           g_variant_type_element (GVSB(parent)-&gt;prev_item_type);
3605     }
3606 }
3607 
3608 /**
3609  * g_variant_builder_close:
3610  * @builder: a #GVariantBuilder
3611  *
3612  * Closes the subcontainer inside the given @builder that was opened by
3613  * the most recent call to g_variant_builder_open().
3614  *
3615  * It is an error to call this function in any way that would create an
3616  * inconsistent value to be constructed (ie: too few values added to the
3617  * subcontainer).
3618  *
3619  * Since: 2.24
3620  **/
3621 void
3622 g_variant_builder_close (GVariantBuilder *builder)
3623 {
3624   GVariantBuilder *parent;
3625 
3626   g_return_if_fail (ensure_valid_builder (builder));
3627   g_return_if_fail (GVSB(builder)-&gt;parent != NULL);
3628 
3629   parent = GVSB(builder)-&gt;parent;
3630   GVSB(builder)-&gt;parent = NULL;
3631 
3632   g_variant_builder_add_value (parent, g_variant_builder_end (builder));
3633   *builder = *parent;
3634 
3635   g_slice_free (GVariantBuilder, parent);
3636 }
3637 
3638 /*&lt; private &gt;
3639  * g_variant_make_maybe_type:
3640  * @element: a #GVariant
3641  *
3642  * Return the type of a maybe containing @element.
3643  */
3644 static GVariantType *
3645 g_variant_make_maybe_type (GVariant *element)
3646 {
3647   return g_variant_type_new_maybe (g_variant_get_type (element));
3648 }
3649 
3650 /*&lt; private &gt;
3651  * g_variant_make_array_type:
3652  * @element: a #GVariant
3653  *
3654  * Return the type of an array containing @element.
3655  */
3656 static GVariantType *
3657 g_variant_make_array_type (GVariant *element)
3658 {
3659   return g_variant_type_new_array (g_variant_get_type (element));
3660 }
3661 
3662 /**
3663  * g_variant_builder_end:
3664  * @builder: a #GVariantBuilder
3665  *
3666  * Ends the builder process and returns the constructed value.
3667  *
3668  * It is not permissible to use @builder in any way after this call
3669  * except for reference counting operations (in the case of a
3670  * heap-allocated #GVariantBuilder) or by reinitialising it with
3671  * g_variant_builder_init() (in the case of stack-allocated). This
3672  * means that for the stack-allocated builders there is no need to
3673  * call g_variant_builder_clear() after the call to
3674  * g_variant_builder_end().
3675  *
3676  * It is an error to call this function in any way that would create an
3677  * inconsistent value to be constructed (ie: insufficient number of
3678  * items added to a container with a specific number of children
3679  * required).  It is also an error to call this function if the builder
3680  * was created with an indefinite array or maybe type and no children
3681  * have been added; in this case it is impossible to infer the type of
3682  * the empty array.
3683  *
3684  * Returns: (transfer none): a new, floating, #GVariant
3685  *
3686  * Since: 2.24
3687  **/
3688 GVariant *
3689 g_variant_builder_end (GVariantBuilder *builder)
3690 {
3691   GVariantType *my_type;
3692   GVariant *value;
3693 
3694   g_return_val_if_fail (ensure_valid_builder (builder), NULL);
3695   g_return_val_if_fail (GVSB(builder)-&gt;offset &gt;= GVSB(builder)-&gt;min_items,
3696                         NULL);
3697   g_return_val_if_fail (!GVSB(builder)-&gt;uniform_item_types ||
3698                         GVSB(builder)-&gt;prev_item_type != NULL ||
3699                         g_variant_type_is_definite (GVSB(builder)-&gt;type),
3700                         NULL);
3701 
3702   if (g_variant_type_is_definite (GVSB(builder)-&gt;type))
3703     my_type = g_variant_type_copy (GVSB(builder)-&gt;type);
3704 
3705   else if (g_variant_type_is_maybe (GVSB(builder)-&gt;type))
3706     my_type = g_variant_make_maybe_type (GVSB(builder)-&gt;children[0]);
3707 
3708   else if (g_variant_type_is_array (GVSB(builder)-&gt;type))
3709     my_type = g_variant_make_array_type (GVSB(builder)-&gt;children[0]);
3710 
3711   else if (g_variant_type_is_tuple (GVSB(builder)-&gt;type))
3712     my_type = g_variant_make_tuple_type (GVSB(builder)-&gt;children,
3713                                          GVSB(builder)-&gt;offset);
3714 
3715   else if (g_variant_type_is_dict_entry (GVSB(builder)-&gt;type))
3716     my_type = g_variant_make_dict_entry_type (GVSB(builder)-&gt;children[0],
3717                                               GVSB(builder)-&gt;children[1]);
3718   else
3719     g_assert_not_reached ();
3720 
3721   value = g_variant_new_from_children (my_type,
3722                                        g_renew (GVariant *,
3723                                                 GVSB(builder)-&gt;children,
3724                                                 GVSB(builder)-&gt;offset),
3725                                        GVSB(builder)-&gt;offset,
3726                                        GVSB(builder)-&gt;trusted);
3727   GVSB(builder)-&gt;children = NULL;
3728   GVSB(builder)-&gt;offset = 0;
3729 
3730   g_variant_builder_clear (builder);
3731   g_variant_type_free (my_type);
3732 
3733   return value;
3734 }
3735 
3736 /* GVariantDict {{{1 */
3737 
3738 /**
3739  * GVariantDict:
3740  *
3741  * #GVariantDict is a mutable interface to #GVariant dictionaries.
3742  *
3743  * It can be used for doing a sequence of dictionary lookups in an
3744  * efficient way on an existing #GVariant dictionary or it can be used
3745  * to construct new dictionaries with a hashtable-like interface.  It
3746  * can also be used for taking existing dictionaries and modifying them
3747  * in order to create new ones.
3748  *
3749  * #GVariantDict can only be used with %G_VARIANT_TYPE_VARDICT
3750  * dictionaries.
3751  *
3752  * It is possible to use #GVariantDict allocated on the stack or on the
3753  * heap.  When using a stack-allocated #GVariantDict, you begin with a
3754  * call to g_variant_dict_init() and free the resources with a call to
3755  * g_variant_dict_clear().
3756  *
3757  * Heap-allocated #GVariantDict follows normal refcounting rules: you
3758  * allocate it with g_variant_dict_new() and use g_variant_dict_ref()
3759  * and g_variant_dict_unref().
3760  *
3761  * g_variant_dict_end() is used to convert the #GVariantDict back into a
3762  * dictionary-type #GVariant.  When used with stack-allocated instances,
3763  * this also implicitly frees all associated memory, but for
3764  * heap-allocated instances, you must still call g_variant_dict_unref()
3765  * afterwards.
3766  *
3767  * You will typically want to use a heap-allocated #GVariantDict when
3768  * you expose it as part of an API.  For most other uses, the
3769  * stack-allocated form will be more convenient.
3770  *
3771  * Consider the following two examples that do the same thing in each
3772  * style: take an existing dictionary and look up the &quot;count&quot; uint32
3773  * key, adding 1 to it if it is found, or returning an error if the
3774  * key is not found.  Each returns the new dictionary as a floating
3775  * #GVariant.
3776  *
3777  * ## Using a stack-allocated GVariantDict
3778  *
3779  * |[&lt;!-- language=&quot;C&quot; --&gt;
3780  *   GVariant *
3781  *   add_to_count (GVariant  *orig,
3782  *                 GError   **error)
3783  *   {
3784  *     GVariantDict dict;
3785  *     guint32 count;
3786  *
3787  *     g_variant_dict_init (&amp;dict, orig);
3788  *     if (!g_variant_dict_lookup (&amp;dict, &quot;count&quot;, &quot;u&quot;, &amp;count))
3789  *       {
3790  *         g_set_error (...);
3791  *         g_variant_dict_clear (&amp;dict);
3792  *         return NULL;
3793  *       }
3794  *
3795  *     g_variant_dict_insert (&amp;dict, &quot;count&quot;, &quot;u&quot;, count + 1);
3796  *
3797  *     return g_variant_dict_end (&amp;dict);
3798  *   }
3799  * ]|
3800  *
3801  * ## Using heap-allocated GVariantDict
3802  *
3803  * |[&lt;!-- language=&quot;C&quot; --&gt;
3804  *   GVariant *
3805  *   add_to_count (GVariant  *orig,
3806  *                 GError   **error)
3807  *   {
3808  *     GVariantDict *dict;
3809  *     GVariant *result;
3810  *     guint32 count;
3811  *
3812  *     dict = g_variant_dict_new (orig);
3813  *
3814  *     if (g_variant_dict_lookup (dict, &quot;count&quot;, &quot;u&quot;, &amp;count))
3815  *       {
3816  *         g_variant_dict_insert (dict, &quot;count&quot;, &quot;u&quot;, count + 1);
3817  *         result = g_variant_dict_end (dict);
3818  *       }
3819  *     else
3820  *       {
3821  *         g_set_error (...);
3822  *         result = NULL;
3823  *       }
3824  *
3825  *     g_variant_dict_unref (dict);
3826  *
3827  *     return result;
3828  *   }
3829  * ]|
3830  *
3831  * Since: 2.40
3832  **/
3833 struct stack_dict
3834 {
3835   GHashTable *values;
3836   gsize magic;
3837 };
3838 
3839 G_STATIC_ASSERT (sizeof (struct stack_dict) &lt;= sizeof (GVariantDict));
3840 
3841 struct heap_dict
3842 {
3843   struct stack_dict dict;
3844   gint ref_count;
3845   gsize magic;
3846 };
3847 
3848 #define GVSD(d)                 ((struct stack_dict *) (d))
3849 #define GVHD(d)                 ((struct heap_dict *) (d))
3850 #define GVSD_MAGIC              ((gsize) 2579507750u)
3851 #define GVSD_MAGIC_PARTIAL      ((gsize) 3488698669u)
3852 #define GVHD_MAGIC              ((gsize) 2450270775u)
3853 #define is_valid_dict(d)        (d != NULL &amp;&amp; \
3854                                  GVSD(d)-&gt;magic == GVSD_MAGIC)
3855 #define is_valid_heap_dict(d)   (GVHD(d)-&gt;magic == GVHD_MAGIC)
3856 
3857 /* Just to make sure that by adding a union to GVariantDict, we didn&#39;t
3858  * accidentally change ABI. */
3859 G_STATIC_ASSERT (sizeof (GVariantDict) == sizeof (gsize[16]));
3860 
3861 static gboolean
3862 ensure_valid_dict (GVariantDict *dict)
3863 {
3864   if (is_valid_dict (dict))
3865     return TRUE;
3866   if (dict-&gt;u.s.partial_magic == GVSD_MAGIC_PARTIAL)
3867     {
3868       static GVariantDict cleared_dict;
3869 
3870       /* Make sure that only first two fields were set and the rest is
3871        * zeroed to avoid messing up the builder that had parent
3872        * address equal to GVSB_MAGIC_PARTIAL. */
3873       if (memcmp (cleared_dict.u.s.y, dict-&gt;u.s.y, sizeof cleared_dict.u.s.y))
3874         return FALSE;
3875 
3876       g_variant_dict_init (dict, dict-&gt;u.s.asv);
3877     }
3878   return is_valid_dict (dict);
3879 }
3880 
3881 /**
3882  * g_variant_dict_new:
3883  * @from_asv: (nullable): the #GVariant with which to initialise the
3884  *   dictionary
3885  *
3886  * Allocates and initialises a new #GVariantDict.
3887  *
3888  * You should call g_variant_dict_unref() on the return value when it
3889  * is no longer needed.  The memory will not be automatically freed by
3890  * any other call.
3891  *
3892  * In some cases it may be easier to place a #GVariantDict directly on
3893  * the stack of the calling function and initialise it with
3894  * g_variant_dict_init().  This is particularly useful when you are
3895  * using #GVariantDict to construct a #GVariant.
3896  *
3897  * Returns: (transfer full): a #GVariantDict
3898  *
3899  * Since: 2.40
3900  **/
3901 GVariantDict *
3902 g_variant_dict_new (GVariant *from_asv)
3903 {
3904   GVariantDict *dict;
3905 
3906   dict = g_slice_alloc (sizeof (struct heap_dict));
3907   g_variant_dict_init (dict, from_asv);
3908   GVHD(dict)-&gt;magic = GVHD_MAGIC;
3909   GVHD(dict)-&gt;ref_count = 1;
3910 
3911   return dict;
3912 }
3913 
3914 /**
3915  * g_variant_dict_init: (skip)
3916  * @dict: a #GVariantDict
3917  * @from_asv: (nullable): the initial value for @dict
3918  *
3919  * Initialises a #GVariantDict structure.
3920  *
3921  * If @from_asv is given, it is used to initialise the dictionary.
3922  *
3923  * This function completely ignores the previous contents of @dict.  On
3924  * one hand this means that it is valid to pass in completely
3925  * uninitialised memory.  On the other hand, this means that if you are
3926  * initialising over top of an existing #GVariantDict you need to first
3927  * call g_variant_dict_clear() in order to avoid leaking memory.
3928  *
3929  * You must not call g_variant_dict_ref() or g_variant_dict_unref() on a
3930  * #GVariantDict that was initialised with this function.  If you ever
3931  * pass a reference to a #GVariantDict outside of the control of your
3932  * own code then you should assume that the person receiving that
3933  * reference may try to use reference counting; you should use
3934  * g_variant_dict_new() instead of this function.
3935  *
3936  * Since: 2.40
3937  **/
3938 void
3939 g_variant_dict_init (GVariantDict *dict,
3940                      GVariant     *from_asv)
3941 {
3942   GVariantIter iter;
3943   gchar *key;
3944   GVariant *value;
3945 
3946   GVSD(dict)-&gt;values = g_hash_table_new_full (g_str_hash, g_str_equal, g_free, (GDestroyNotify) g_variant_unref);
3947   GVSD(dict)-&gt;magic = GVSD_MAGIC;
3948 
3949   if (from_asv)
3950     {
3951       g_variant_iter_init (&amp;iter, from_asv);
3952       while (g_variant_iter_next (&amp;iter, &quot;{sv}&quot;, &amp;key, &amp;value))
3953         g_hash_table_insert (GVSD(dict)-&gt;values, key, value);
3954     }
3955 }
3956 
3957 /**
3958  * g_variant_dict_lookup:
3959  * @dict: a #GVariantDict
<a name="23" id="anc23"></a><span class="line-modified">3960  * @key: the key to lookup in the dictionary</span>
3961  * @format_string: a GVariant format string
3962  * @...: the arguments to unpack the value into
3963  *
3964  * Looks up a value in a #GVariantDict.
3965  *
3966  * This function is a wrapper around g_variant_dict_lookup_value() and
3967  * g_variant_get().  In the case that %NULL would have been returned,
3968  * this function returns %FALSE.  Otherwise, it unpacks the returned
3969  * value and returns %TRUE.
3970  *
3971  * @format_string determines the C types that are used for unpacking the
3972  * values and also determines if the values are copied or borrowed, see the
3973  * section on [GVariant format strings][gvariant-format-strings-pointers].
3974  *
3975  * Returns: %TRUE if a value was unpacked
3976  *
3977  * Since: 2.40
3978  **/
3979 gboolean
3980 g_variant_dict_lookup (GVariantDict *dict,
3981                        const gchar  *key,
3982                        const gchar  *format_string,
3983                        ...)
3984 {
3985   GVariant *value;
3986   va_list ap;
3987 
3988   g_return_val_if_fail (ensure_valid_dict (dict), FALSE);
3989   g_return_val_if_fail (key != NULL, FALSE);
3990   g_return_val_if_fail (format_string != NULL, FALSE);
3991 
3992   value = g_hash_table_lookup (GVSD(dict)-&gt;values, key);
3993 
3994   if (value == NULL || !g_variant_check_format_string (value, format_string, FALSE))
3995     return FALSE;
3996 
3997   va_start (ap, format_string);
3998   g_variant_get_va (value, format_string, NULL, &amp;ap);
3999   va_end (ap);
4000 
4001   return TRUE;
4002 }
4003 
4004 /**
4005  * g_variant_dict_lookup_value:
4006  * @dict: a #GVariantDict
<a name="24" id="anc24"></a><span class="line-modified">4007  * @key: the key to lookup in the dictionary</span>
4008  * @expected_type: (nullable): a #GVariantType, or %NULL
4009  *
4010  * Looks up a value in a #GVariantDict.
4011  *
4012  * If @key is not found in @dictionary, %NULL is returned.
4013  *
4014  * The @expected_type string specifies what type of value is expected.
4015  * If the value associated with @key has a different type then %NULL is
4016  * returned.
4017  *
4018  * If the key is found and the value has the correct type, it is
4019  * returned.  If @expected_type was specified then any non-%NULL return
4020  * value will have this type.
4021  *
4022  * Returns: (transfer full): the value of the dictionary key, or %NULL
4023  *
4024  * Since: 2.40
4025  **/
4026 GVariant *
4027 g_variant_dict_lookup_value (GVariantDict       *dict,
4028                              const gchar        *key,
4029                              const GVariantType *expected_type)
4030 {
4031   GVariant *result;
4032 
4033   g_return_val_if_fail (ensure_valid_dict (dict), NULL);
4034   g_return_val_if_fail (key != NULL, NULL);
4035 
4036   result = g_hash_table_lookup (GVSD(dict)-&gt;values, key);
4037 
4038   if (result &amp;&amp; (!expected_type || g_variant_is_of_type (result, expected_type)))
4039     return g_variant_ref (result);
4040 
4041   return NULL;
4042 }
4043 
4044 /**
4045  * g_variant_dict_contains:
4046  * @dict: a #GVariantDict
<a name="25" id="anc25"></a><span class="line-modified">4047  * @key: the key to lookup in the dictionary</span>
4048  *
4049  * Checks if @key exists in @dict.
4050  *
4051  * Returns: %TRUE if @key is in @dict
4052  *
4053  * Since: 2.40
4054  **/
4055 gboolean
4056 g_variant_dict_contains (GVariantDict *dict,
4057                          const gchar  *key)
4058 {
4059   g_return_val_if_fail (ensure_valid_dict (dict), FALSE);
4060   g_return_val_if_fail (key != NULL, FALSE);
4061 
4062   return g_hash_table_contains (GVSD(dict)-&gt;values, key);
4063 }
4064 
4065 /**
4066  * g_variant_dict_insert:
4067  * @dict: a #GVariantDict
4068  * @key: the key to insert a value for
4069  * @format_string: a #GVariant varargs format string
4070  * @...: arguments, as per @format_string
4071  *
4072  * Inserts a value into a #GVariantDict.
4073  *
4074  * This call is a convenience wrapper that is exactly equivalent to
4075  * calling g_variant_new() followed by g_variant_dict_insert_value().
4076  *
4077  * Since: 2.40
4078  **/
4079 void
4080 g_variant_dict_insert (GVariantDict *dict,
4081                        const gchar  *key,
4082                        const gchar  *format_string,
4083                        ...)
4084 {
4085   va_list ap;
4086 
4087   g_return_if_fail (ensure_valid_dict (dict));
4088   g_return_if_fail (key != NULL);
4089   g_return_if_fail (format_string != NULL);
4090 
4091   va_start (ap, format_string);
4092   g_variant_dict_insert_value (dict, key, g_variant_new_va (format_string, NULL, &amp;ap));
4093   va_end (ap);
4094 }
4095 
4096 /**
4097  * g_variant_dict_insert_value:
4098  * @dict: a #GVariantDict
4099  * @key: the key to insert a value for
4100  * @value: the value to insert
4101  *
4102  * Inserts (or replaces) a key in a #GVariantDict.
4103  *
4104  * @value is consumed if it is floating.
4105  *
4106  * Since: 2.40
4107  **/
4108 void
4109 g_variant_dict_insert_value (GVariantDict *dict,
4110                              const gchar  *key,
4111                              GVariant     *value)
4112 {
4113   g_return_if_fail (ensure_valid_dict (dict));
4114   g_return_if_fail (key != NULL);
4115   g_return_if_fail (value != NULL);
4116 
4117   g_hash_table_insert (GVSD(dict)-&gt;values, g_strdup (key), g_variant_ref_sink (value));
4118 }
4119 
4120 /**
4121  * g_variant_dict_remove:
4122  * @dict: a #GVariantDict
4123  * @key: the key to remove
4124  *
4125  * Removes a key and its associated value from a #GVariantDict.
4126  *
4127  * Returns: %TRUE if the key was found and removed
4128  *
4129  * Since: 2.40
4130  **/
4131 gboolean
4132 g_variant_dict_remove (GVariantDict *dict,
4133                        const gchar  *key)
4134 {
4135   g_return_val_if_fail (ensure_valid_dict (dict), FALSE);
4136   g_return_val_if_fail (key != NULL, FALSE);
4137 
4138   return g_hash_table_remove (GVSD(dict)-&gt;values, key);
4139 }
4140 
4141 /**
4142  * g_variant_dict_clear:
4143  * @dict: a #GVariantDict
4144  *
4145  * Releases all memory associated with a #GVariantDict without freeing
4146  * the #GVariantDict structure itself.
4147  *
4148  * It typically only makes sense to do this on a stack-allocated
4149  * #GVariantDict if you want to abort building the value part-way
4150  * through.  This function need not be called if you call
4151  * g_variant_dict_end() and it also doesn&#39;t need to be called on dicts
4152  * allocated with g_variant_dict_new (see g_variant_dict_unref() for
4153  * that).
4154  *
4155  * It is valid to call this function on either an initialised
4156  * #GVariantDict or one that was previously cleared by an earlier call
4157  * to g_variant_dict_clear() but it is not valid to call this function
4158  * on uninitialised memory.
4159  *
4160  * Since: 2.40
4161  **/
4162 void
4163 g_variant_dict_clear (GVariantDict *dict)
4164 {
4165   if (GVSD(dict)-&gt;magic == 0)
4166     /* all-zeros case */
4167     return;
4168 
4169   g_return_if_fail (ensure_valid_dict (dict));
4170 
4171   g_hash_table_unref (GVSD(dict)-&gt;values);
4172   GVSD(dict)-&gt;values = NULL;
4173 
4174   GVSD(dict)-&gt;magic = 0;
4175 }
4176 
4177 /**
4178  * g_variant_dict_end:
4179  * @dict: a #GVariantDict
4180  *
4181  * Returns the current value of @dict as a #GVariant of type
4182  * %G_VARIANT_TYPE_VARDICT, clearing it in the process.
4183  *
4184  * It is not permissible to use @dict in any way after this call except
4185  * for reference counting operations (in the case of a heap-allocated
4186  * #GVariantDict) or by reinitialising it with g_variant_dict_init() (in
4187  * the case of stack-allocated).
4188  *
4189  * Returns: (transfer none): a new, floating, #GVariant
4190  *
4191  * Since: 2.40
4192  **/
4193 GVariant *
4194 g_variant_dict_end (GVariantDict *dict)
4195 {
4196   GVariantBuilder builder;
4197   GHashTableIter iter;
4198   gpointer key, value;
4199 
4200   g_return_val_if_fail (ensure_valid_dict (dict), NULL);
4201 
4202   g_variant_builder_init (&amp;builder, G_VARIANT_TYPE_VARDICT);
4203 
4204   g_hash_table_iter_init (&amp;iter, GVSD(dict)-&gt;values);
4205   while (g_hash_table_iter_next (&amp;iter, &amp;key, &amp;value))
4206     g_variant_builder_add (&amp;builder, &quot;{sv}&quot;, (const gchar *) key, (GVariant *) value);
4207 
4208   g_variant_dict_clear (dict);
4209 
4210   return g_variant_builder_end (&amp;builder);
4211 }
4212 
4213 /**
4214  * g_variant_dict_ref:
4215  * @dict: a heap-allocated #GVariantDict
4216  *
4217  * Increases the reference count on @dict.
4218  *
4219  * Don&#39;t call this on stack-allocated #GVariantDict instances or bad
4220  * things will happen.
4221  *
4222  * Returns: (transfer full): a new reference to @dict
4223  *
4224  * Since: 2.40
4225  **/
4226 GVariantDict *
4227 g_variant_dict_ref (GVariantDict *dict)
4228 {
4229   g_return_val_if_fail (is_valid_heap_dict (dict), NULL);
4230 
4231   GVHD(dict)-&gt;ref_count++;
4232 
4233   return dict;
4234 }
4235 
4236 /**
4237  * g_variant_dict_unref:
4238  * @dict: (transfer full): a heap-allocated #GVariantDict
4239  *
4240  * Decreases the reference count on @dict.
4241  *
4242  * In the event that there are no more references, releases all memory
4243  * associated with the #GVariantDict.
4244  *
4245  * Don&#39;t call this on stack-allocated #GVariantDict instances or bad
4246  * things will happen.
4247  *
4248  * Since: 2.40
4249  **/
4250 void
4251 g_variant_dict_unref (GVariantDict *dict)
4252 {
4253   g_return_if_fail (is_valid_heap_dict (dict));
4254 
4255   if (--GVHD(dict)-&gt;ref_count == 0)
4256     {
4257       g_variant_dict_clear (dict);
4258       g_slice_free (struct heap_dict, (struct heap_dict *) dict);
4259     }
4260 }
4261 
4262 
4263 /* Format strings {{{1 */
4264 /*&lt; private &gt;
4265  * g_variant_format_string_scan:
4266  * @string: a string that may be prefixed with a format string
4267  * @limit: (nullable) (default NULL): a pointer to the end of @string,
4268  *         or %NULL
4269  * @endptr: (nullable) (default NULL): location to store the end pointer,
4270  *          or %NULL
4271  *
4272  * Checks the string pointed to by @string for starting with a properly
4273  * formed #GVariant varargs format string.  If no valid format string is
4274  * found then %FALSE is returned.
4275  *
4276  * If @string does start with a valid format string then %TRUE is
4277  * returned.  If @endptr is non-%NULL then it is updated to point to the
4278  * first character after the format string.
4279  *
4280  * If @limit is non-%NULL then @limit (and any character after it) will
4281  * not be accessed and the effect is otherwise equivalent to if the
4282  * character at @limit were nul.
4283  *
4284  * See the section on [GVariant format strings][gvariant-format-strings].
4285  *
4286  * Returns: %TRUE if there was a valid format string
4287  *
4288  * Since: 2.24
4289  */
4290 gboolean
4291 g_variant_format_string_scan (const gchar  *string,
4292                               const gchar  *limit,
4293                               const gchar **endptr)
4294 {
4295 #define next_char() (string == limit ? &#39;\0&#39; : *string++)
4296 #define peek_char() (string == limit ? &#39;\0&#39; : *string)
4297   char c;
4298 
4299   switch (next_char())
4300     {
4301     case &#39;b&#39;: case &#39;y&#39;: case &#39;n&#39;: case &#39;q&#39;: case &#39;i&#39;: case &#39;u&#39;:
4302     case &#39;x&#39;: case &#39;t&#39;: case &#39;h&#39;: case &#39;d&#39;: case &#39;s&#39;: case &#39;o&#39;:
4303     case &#39;g&#39;: case &#39;v&#39;: case &#39;*&#39;: case &#39;?&#39;: case &#39;r&#39;:
4304       break;
4305 
4306     case &#39;m&#39;:
4307       return g_variant_format_string_scan (string, limit, endptr);
4308 
4309     case &#39;a&#39;:
4310     case &#39;@&#39;:
4311       return g_variant_type_string_scan (string, limit, endptr);
4312 
4313     case &#39;(&#39;:
4314       while (peek_char() != &#39;)&#39;)
4315         if (!g_variant_format_string_scan (string, limit, &amp;string))
4316           return FALSE;
4317 
4318       next_char(); /* consume &#39;)&#39; */
4319       break;
4320 
4321     case &#39;{&#39;:
4322       c = next_char();
4323 
4324       if (c == &#39;&amp;&#39;)
4325         {
4326           c = next_char ();
4327 
4328           if (c != &#39;s&#39; &amp;&amp; c != &#39;o&#39; &amp;&amp; c != &#39;g&#39;)
4329             return FALSE;
4330         }
4331       else
4332         {
4333           if (c == &#39;@&#39;)
4334             c = next_char ();
4335 
<a name="26" id="anc26"></a><span class="line-modified">4336           /* ISO/IEC 9899:1999 (C99) �7.21.5.2:</span>
4337            *    The terminating null character is considered to be
4338            *    part of the string.
4339            */
4340           if (c != &#39;\0&#39; &amp;&amp; strchr (&quot;bynqiuxthdsog?&quot;, c) == NULL)
4341             return FALSE;
4342         }
4343 
4344       if (!g_variant_format_string_scan (string, limit, &amp;string))
4345         return FALSE;
4346 
4347       if (next_char() != &#39;}&#39;)
4348         return FALSE;
4349 
4350       break;
4351 
4352     case &#39;^&#39;:
4353       if ((c = next_char()) == &#39;a&#39;)
4354         {
4355           if ((c = next_char()) == &#39;&amp;&#39;)
4356             {
4357               if ((c = next_char()) == &#39;a&#39;)
4358                 {
4359                   if ((c = next_char()) == &#39;y&#39;)
4360                     break;      /* &#39;^a&amp;ay&#39; */
4361                 }
4362 
4363               else if (c == &#39;s&#39; || c == &#39;o&#39;)
4364                 break;          /* &#39;^a&amp;s&#39;, &#39;^a&amp;o&#39; */
4365             }
4366 
4367           else if (c == &#39;a&#39;)
4368             {
4369               if ((c = next_char()) == &#39;y&#39;)
4370                 break;          /* &#39;^aay&#39; */
4371             }
4372 
4373           else if (c == &#39;s&#39; || c == &#39;o&#39;)
4374             break;              /* &#39;^as&#39;, &#39;^ao&#39; */
4375 
4376           else if (c == &#39;y&#39;)
4377             break;              /* &#39;^ay&#39; */
4378         }
4379       else if (c == &#39;&amp;&#39;)
4380         {
4381           if ((c = next_char()) == &#39;a&#39;)
4382             {
4383               if ((c = next_char()) == &#39;y&#39;)
4384                 break;          /* &#39;^&amp;ay&#39; */
4385             }
4386         }
4387 
4388       return FALSE;
4389 
4390     case &#39;&amp;&#39;:
4391       c = next_char();
4392 
4393       if (c != &#39;s&#39; &amp;&amp; c != &#39;o&#39; &amp;&amp; c != &#39;g&#39;)
4394         return FALSE;
4395 
4396       break;
4397 
4398     default:
4399       return FALSE;
4400     }
4401 
4402   if (endptr != NULL)
4403     *endptr = string;
4404 
4405 #undef next_char
4406 #undef peek_char
4407 
4408   return TRUE;
4409 }
4410 
4411 /**
4412  * g_variant_check_format_string:
4413  * @value: a #GVariant
4414  * @format_string: a valid #GVariant format string
4415  * @copy_only: %TRUE to ensure the format string makes deep copies
4416  *
4417  * Checks if calling g_variant_get() with @format_string on @value would
4418  * be valid from a type-compatibility standpoint.  @format_string is
4419  * assumed to be a valid format string (from a syntactic standpoint).
4420  *
4421  * If @copy_only is %TRUE then this function additionally checks that it
4422  * would be safe to call g_variant_unref() on @value immediately after
4423  * the call to g_variant_get() without invalidating the result.  This is
4424  * only possible if deep copies are made (ie: there are no pointers to
4425  * the data inside of the soon-to-be-freed #GVariant instance).  If this
4426  * check fails then a g_critical() is printed and %FALSE is returned.
4427  *
4428  * This function is meant to be used by functions that wish to provide
4429  * varargs accessors to #GVariant values of uncertain values (eg:
4430  * g_variant_lookup() or g_menu_model_get_item_attribute()).
4431  *
4432  * Returns: %TRUE if @format_string is safe to use
4433  *
4434  * Since: 2.34
4435  */
4436 gboolean
4437 g_variant_check_format_string (GVariant    *value,
4438                                const gchar *format_string,
4439                                gboolean     copy_only)
4440 {
4441   const gchar *original_format = format_string;
4442   const gchar *type_string;
4443 
4444   /* Interesting factoid: assuming a format string is valid, it can be
4445    * converted to a type string by removing all &#39;@&#39; &#39;&amp;&#39; and &#39;^&#39;
4446    * characters.
4447    *
4448    * Instead of doing that, we can just skip those characters when
4449    * comparing it to the type string of @value.
4450    *
4451    * For the copy-only case we can just drop the &#39;&amp;&#39; from the list of
4452    * characters to skip over.  A &#39;&amp;&#39; will never appear in a type string
4453    * so we know that it won&#39;t be possible to return %TRUE if it is in a
4454    * format string.
4455    */
4456   type_string = g_variant_get_type_string (value);
4457 
4458   while (*type_string || *format_string)
4459     {
4460       gchar format = *format_string++;
4461 
4462       switch (format)
4463         {
4464         case &#39;&amp;&#39;:
4465           if G_UNLIKELY (copy_only)
4466             {
4467               /* for the love of all that is good, please don&#39;t mark this string for translation... */
4468               g_critical (&quot;g_variant_check_format_string() is being called by a function with a GVariant varargs &quot;
4469                           &quot;interface to validate the passed format string for type safety.  The passed format &quot;
4470                           &quot;(%s) contains a &#39;&amp;&#39; character which would result in a pointer being returned to the &quot;
4471                           &quot;data inside of a GVariant instance that may no longer exist by the time the function &quot;
4472                           &quot;returns.  Modify your code to use a format string without &#39;&amp;&#39;.&quot;, original_format);
4473               return FALSE;
4474             }
4475 
4476           /* fall through */
4477         case &#39;^&#39;:
4478         case &#39;@&#39;:
4479           /* ignore these 2 (or 3) */
4480           continue;
4481 
4482         case &#39;?&#39;:
4483           /* attempt to consume one of &#39;bynqiuxthdsog&#39; */
4484           {
4485             char s = *type_string++;
4486 
4487             if (s == &#39;\0&#39; || strchr (&quot;bynqiuxthdsog&quot;, s) == NULL)
4488               return FALSE;
4489           }
4490           continue;
4491 
4492         case &#39;r&#39;:
4493           /* ensure it&#39;s a tuple */
4494           if (*type_string != &#39;(&#39;)
4495             return FALSE;
4496 
4497           /* fall through */
4498         case &#39;*&#39;:
4499           /* consume a full type string for the &#39;*&#39; or &#39;r&#39; */
4500           if (!g_variant_type_string_scan (type_string, NULL, &amp;type_string))
4501             return FALSE;
4502 
4503           continue;
4504 
4505         default:
4506           /* attempt to consume exactly one character equal to the format */
4507           if (format != *type_string++)
4508             return FALSE;
4509         }
4510     }
4511 
4512   return TRUE;
4513 }
4514 
4515 /*&lt; private &gt;
4516  * g_variant_format_string_scan_type:
4517  * @string: a string that may be prefixed with a format string
4518  * @limit: (nullable) (default NULL): a pointer to the end of @string,
4519  *         or %NULL
4520  * @endptr: (nullable) (default NULL): location to store the end pointer,
4521  *          or %NULL
4522  *
4523  * If @string starts with a valid format string then this function will
4524  * return the type that the format string corresponds to.  Otherwise
4525  * this function returns %NULL.
4526  *
4527  * Use g_variant_type_free() to free the return value when you no longer
4528  * need it.
4529  *
4530  * This function is otherwise exactly like
4531  * g_variant_format_string_scan().
4532  *
4533  * Returns: (nullable): a #GVariantType if there was a valid format string
4534  *
4535  * Since: 2.24
4536  */
4537 GVariantType *
4538 g_variant_format_string_scan_type (const gchar  *string,
4539                                    const gchar  *limit,
4540                                    const gchar **endptr)
4541 {
4542   const gchar *my_end;
4543   gchar *dest;
4544   gchar *new;
4545 
4546   if (endptr == NULL)
4547     endptr = &amp;my_end;
4548 
4549   if (!g_variant_format_string_scan (string, limit, endptr))
4550     return NULL;
4551 
4552   dest = new = g_malloc (*endptr - string + 1);
4553   while (string != *endptr)
4554     {
4555       if (*string != &#39;@&#39; &amp;&amp; *string != &#39;&amp;&#39; &amp;&amp; *string != &#39;^&#39;)
4556         *dest++ = *string;
4557       string++;
4558     }
4559   *dest = &#39;\0&#39;;
4560 
4561   return (GVariantType *) G_VARIANT_TYPE (new);
4562 }
4563 
4564 static gboolean
4565 valid_format_string (const gchar *format_string,
4566                      gboolean     single,
4567                      GVariant    *value)
4568 {
4569   const gchar *endptr;
4570   GVariantType *type;
4571 
4572   type = g_variant_format_string_scan_type (format_string, NULL, &amp;endptr);
4573 
4574   if G_UNLIKELY (type == NULL || (single &amp;&amp; *endptr != &#39;\0&#39;))
4575     {
4576       if (single)
4577         g_critical (&quot;&#39;%s&#39; is not a valid GVariant format string&quot;,
4578                     format_string);
4579       else
4580         g_critical (&quot;&#39;%s&#39; does not have a valid GVariant format &quot;
4581                     &quot;string as a prefix&quot;, format_string);
4582 
4583       if (type != NULL)
4584         g_variant_type_free (type);
4585 
4586       return FALSE;
4587     }
4588 
4589   if G_UNLIKELY (value &amp;&amp; !g_variant_is_of_type (value, type))
4590     {
4591       gchar *fragment;
4592       gchar *typestr;
4593 
4594       fragment = g_strndup (format_string, endptr - format_string);
4595       typestr = g_variant_type_dup_string (type);
4596 
4597       g_critical (&quot;the GVariant format string &#39;%s&#39; has a type of &quot;
4598                   &quot;&#39;%s&#39; but the given value has a type of &#39;%s&#39;&quot;,
4599                   fragment, typestr, g_variant_get_type_string (value));
4600 
4601       g_variant_type_free (type);
4602       g_free (fragment);
4603       g_free (typestr);
4604 
4605       return FALSE;
4606     }
4607 
4608   g_variant_type_free (type);
4609 
4610   return TRUE;
4611 }
4612 
4613 /* Variable Arguments {{{1 */
4614 /* We consider 2 main classes of format strings:
4615  *
4616  *   - recursive format strings
4617  *      these are ones that result in recursion and the collection of
4618  *      possibly more than one argument.  Maybe types, tuples,
4619  *      dictionary entries.
4620  *
4621  *   - leaf format string
4622  *      these result in the collection of a single argument.
4623  *
4624  * Leaf format strings are further subdivided into two categories:
4625  *
4626  *   - single non-null pointer (&quot;nnp&quot;)
4627  *      these either collect or return a single non-null pointer.
4628  *
4629  *   - other
4630  *      these collect or return something else (bool, number, etc).
4631  *
4632  * Based on the above, the varargs handling code is split into 4 main parts:
4633  *
4634  *   - nnp handling code
4635  *   - leaf handling code (which may invoke nnp code)
4636  *   - generic handling code (may be recursive, may invoke leaf code)
4637  *   - user-facing API (which invokes the generic code)
4638  *
4639  * Each section implements some of the following functions:
4640  *
4641  *   - skip:
4642  *      collect the arguments for the format string as if
4643  *      g_variant_new() had been called, but do nothing with them.  used
4644  *      for skipping over arguments when constructing a Nothing maybe
4645  *      type.
4646  *
4647  *   - new:
4648  *      create a GVariant *
4649  *
4650  *   - get:
4651  *      unpack a GVariant *
4652  *
4653  *   - free (nnp only):
4654  *      free a previously allocated item
4655  */
4656 
4657 static gboolean
4658 g_variant_format_string_is_leaf (const gchar *str)
4659 {
4660   return str[0] != &#39;m&#39; &amp;&amp; str[0] != &#39;(&#39; &amp;&amp; str[0] != &#39;{&#39;;
4661 }
4662 
4663 static gboolean
4664 g_variant_format_string_is_nnp (const gchar *str)
4665 {
4666   return str[0] == &#39;a&#39; || str[0] == &#39;s&#39; || str[0] == &#39;o&#39; || str[0] == &#39;g&#39; ||
4667          str[0] == &#39;^&#39; || str[0] == &#39;@&#39; || str[0] == &#39;*&#39; || str[0] == &#39;?&#39; ||
4668          str[0] == &#39;r&#39; || str[0] == &#39;v&#39; || str[0] == &#39;&amp;&#39;;
4669 }
4670 
4671 /* Single non-null pointer (&quot;nnp&quot;) {{{2 */
4672 static void
4673 g_variant_valist_free_nnp (const gchar *str,
4674                            gpointer     ptr)
4675 {
4676   switch (*str)
4677     {
4678     case &#39;a&#39;:
4679       g_variant_iter_free (ptr);
4680       break;
4681 
4682     case &#39;^&#39;:
4683       if (g_str_has_suffix (str, &quot;y&quot;))
4684         {
4685           if (str[2] != &#39;a&#39;) /* &#39;^a&amp;ay&#39;, &#39;^ay&#39; */
4686             g_free (ptr);
4687           else if (str[1] == &#39;a&#39;) /* &#39;^aay&#39; */
<a name="27" id="anc27"></a><span class="line-modified">4688         g_strfreev (ptr);</span>
4689           break; /* &#39;^&amp;ay&#39; */
4690         }
4691       else if (str[2] != &#39;&amp;&#39;) /* &#39;^as&#39;, &#39;^ao&#39; */
4692         g_strfreev (ptr);
4693       else                      /* &#39;^a&amp;s&#39;, &#39;^a&amp;o&#39; */
4694         g_free (ptr);
4695       break;
4696 
4697     case &#39;s&#39;:
4698     case &#39;o&#39;:
4699     case &#39;g&#39;:
4700       g_free (ptr);
4701       break;
4702 
4703     case &#39;@&#39;:
4704     case &#39;*&#39;:
4705     case &#39;?&#39;:
4706     case &#39;v&#39;:
4707       g_variant_unref (ptr);
4708       break;
4709 
4710     case &#39;&amp;&#39;:
4711       break;
4712 
4713     default:
4714       g_assert_not_reached ();
4715     }
4716 }
4717 
4718 static gchar
4719 g_variant_scan_convenience (const gchar **str,
4720                             gboolean     *constant,
4721                             guint        *arrays)
4722 {
4723   *constant = FALSE;
4724   *arrays = 0;
4725 
4726   for (;;)
4727     {
4728       char c = *(*str)++;
4729 
4730       if (c == &#39;&amp;&#39;)
4731         *constant = TRUE;
4732 
4733       else if (c == &#39;a&#39;)
4734         (*arrays)++;
4735 
4736       else
4737         return c;
4738     }
4739 }
4740 
4741 static GVariant *
4742 g_variant_valist_new_nnp (const gchar **str,
4743                           gpointer      ptr)
4744 {
4745   if (**str == &#39;&amp;&#39;)
4746     (*str)++;
4747 
4748   switch (*(*str)++)
4749     {
4750     case &#39;a&#39;:
4751       if (ptr != NULL)
4752         {
4753           const GVariantType *type;
4754           GVariant *value;
4755 
4756           value = g_variant_builder_end (ptr);
4757           type = g_variant_get_type (value);
4758 
4759           if G_UNLIKELY (!g_variant_type_is_array (type))
4760             g_error (&quot;g_variant_new: expected array GVariantBuilder but &quot;
4761                      &quot;the built value has type &#39;%s&#39;&quot;,
4762                      g_variant_get_type_string (value));
4763 
4764           type = g_variant_type_element (type);
4765 
4766           if G_UNLIKELY (!g_variant_type_is_subtype_of (type, (GVariantType *) *str))
4767             {
4768               gchar *type_string = g_variant_type_dup_string ((GVariantType *) *str);
4769               g_error (&quot;g_variant_new: expected GVariantBuilder array element &quot;
4770                        &quot;type &#39;%s&#39; but the built value has element type &#39;%s&#39;&quot;,
4771                        type_string, g_variant_get_type_string (value) + 1);
4772               g_free (type_string);
4773             }
4774 
4775           g_variant_type_string_scan (*str, NULL, str);
4776 
4777           return value;
4778         }
4779       else
4780 
4781         /* special case: NULL pointer for empty array */
4782         {
4783           const GVariantType *type = (GVariantType *) *str;
4784 
4785           g_variant_type_string_scan (*str, NULL, str);
4786 
4787           if G_UNLIKELY (!g_variant_type_is_definite (type))
4788             g_error (&quot;g_variant_new: NULL pointer given with indefinite &quot;
4789                      &quot;array type; unable to determine which type of empty &quot;
4790                      &quot;array to construct.&quot;);
4791 
4792           return g_variant_new_array (type, NULL, 0);
4793         }
4794 
4795     case &#39;s&#39;:
4796       {
4797         GVariant *value;
4798 
4799         value = g_variant_new_string (ptr);
4800 
4801         if (value == NULL)
4802           value = g_variant_new_string (&quot;[Invalid UTF-8]&quot;);
4803 
4804         return value;
4805       }
4806 
4807     case &#39;o&#39;:
4808       return g_variant_new_object_path (ptr);
4809 
4810     case &#39;g&#39;:
4811       return g_variant_new_signature (ptr);
4812 
4813     case &#39;^&#39;:
4814       {
4815         gboolean constant;
4816         guint arrays;
4817         gchar type;
4818 
4819         type = g_variant_scan_convenience (str, &amp;constant, &amp;arrays);
4820 
4821         if (type == &#39;s&#39;)
4822           return g_variant_new_strv (ptr, -1);
4823 
4824         if (type == &#39;o&#39;)
4825           return g_variant_new_objv (ptr, -1);
4826 
4827         if (arrays &gt; 1)
4828           return g_variant_new_bytestring_array (ptr, -1);
4829 
4830         return g_variant_new_bytestring (ptr);
4831       }
4832 
4833     case &#39;@&#39;:
4834       if G_UNLIKELY (!g_variant_is_of_type (ptr, (GVariantType *) *str))
4835         {
4836           gchar *type_string = g_variant_type_dup_string ((GVariantType *) *str);
4837           g_error (&quot;g_variant_new: expected GVariant of type &#39;%s&#39; but &quot;
4838                    &quot;received value has type &#39;%s&#39;&quot;,
4839                    type_string, g_variant_get_type_string (ptr));
4840           g_free (type_string);
4841         }
4842 
4843       g_variant_type_string_scan (*str, NULL, str);
4844 
4845       return ptr;
4846 
4847     case &#39;*&#39;:
4848       return ptr;
4849 
4850     case &#39;?&#39;:
4851       if G_UNLIKELY (!g_variant_type_is_basic (g_variant_get_type (ptr)))
4852         g_error (&quot;g_variant_new: format string &#39;?&#39; expects basic-typed &quot;
4853                  &quot;GVariant, but received value has type &#39;%s&#39;&quot;,
4854                  g_variant_get_type_string (ptr));
4855 
4856       return ptr;
4857 
4858     case &#39;r&#39;:
4859       if G_UNLIKELY (!g_variant_type_is_tuple (g_variant_get_type (ptr)))
4860         g_error (&quot;g_variant_new: format string &#39;r&#39; expects tuple-typed &quot;
4861                  &quot;GVariant, but received value has type &#39;%s&#39;&quot;,
4862                  g_variant_get_type_string (ptr));
4863 
4864       return ptr;
4865 
4866     case &#39;v&#39;:
4867       return g_variant_new_variant (ptr);
4868 
4869     default:
4870       g_assert_not_reached ();
4871     }
4872 }
4873 
4874 static gpointer
4875 g_variant_valist_get_nnp (const gchar **str,
4876                           GVariant     *value)
4877 {
4878   switch (*(*str)++)
4879     {
4880     case &#39;a&#39;:
4881       g_variant_type_string_scan (*str, NULL, str);
4882       return g_variant_iter_new (value);
4883 
4884     case &#39;&amp;&#39;:
4885       (*str)++;
4886       return (gchar *) g_variant_get_string (value, NULL);
4887 
4888     case &#39;s&#39;:
4889     case &#39;o&#39;:
4890     case &#39;g&#39;:
4891       return g_variant_dup_string (value, NULL);
4892 
4893     case &#39;^&#39;:
4894       {
4895         gboolean constant;
4896         guint arrays;
4897         gchar type;
4898 
4899         type = g_variant_scan_convenience (str, &amp;constant, &amp;arrays);
4900 
4901         if (type == &#39;s&#39;)
4902           {
4903             if (constant)
4904               return g_variant_get_strv (value, NULL);
4905             else
4906               return g_variant_dup_strv (value, NULL);
4907           }
4908 
4909         else if (type == &#39;o&#39;)
4910           {
4911             if (constant)
4912               return g_variant_get_objv (value, NULL);
4913             else
4914               return g_variant_dup_objv (value, NULL);
4915           }
4916 
4917         else if (arrays &gt; 1)
4918           {
4919             if (constant)
4920               return g_variant_get_bytestring_array (value, NULL);
4921             else
4922               return g_variant_dup_bytestring_array (value, NULL);
4923           }
4924 
4925         else
4926           {
4927             if (constant)
4928               return (gchar *) g_variant_get_bytestring (value);
4929             else
4930               return g_variant_dup_bytestring (value, NULL);
4931           }
4932       }
4933 
4934     case &#39;@&#39;:
4935       g_variant_type_string_scan (*str, NULL, str);
4936       /* fall through */
4937 
4938     case &#39;*&#39;:
4939     case &#39;?&#39;:
4940     case &#39;r&#39;:
4941       return g_variant_ref (value);
4942 
4943     case &#39;v&#39;:
4944       return g_variant_get_variant (value);
4945 
4946     default:
4947       g_assert_not_reached ();
4948     }
4949 }
4950 
4951 /* Leaves {{{2 */
4952 static void
4953 g_variant_valist_skip_leaf (const gchar **str,
4954                             va_list      *app)
4955 {
4956   if (g_variant_format_string_is_nnp (*str))
4957     {
4958       g_variant_format_string_scan (*str, NULL, str);
4959       va_arg (*app, gpointer);
4960       return;
4961     }
4962 
4963   switch (*(*str)++)
4964     {
4965     case &#39;b&#39;:
4966     case &#39;y&#39;:
4967     case &#39;n&#39;:
4968     case &#39;q&#39;:
4969     case &#39;i&#39;:
4970     case &#39;u&#39;:
4971     case &#39;h&#39;:
4972       va_arg (*app, int);
4973       return;
4974 
4975     case &#39;x&#39;:
4976     case &#39;t&#39;:
4977       va_arg (*app, guint64);
4978       return;
4979 
4980     case &#39;d&#39;:
4981       va_arg (*app, gdouble);
4982       return;
4983 
4984     default:
4985       g_assert_not_reached ();
4986     }
4987 }
4988 
4989 static GVariant *
4990 g_variant_valist_new_leaf (const gchar **str,
4991                            va_list      *app)
4992 {
4993   if (g_variant_format_string_is_nnp (*str))
4994     return g_variant_valist_new_nnp (str, va_arg (*app, gpointer));
4995 
4996   switch (*(*str)++)
4997     {
4998     case &#39;b&#39;:
4999       return g_variant_new_boolean (va_arg (*app, gboolean));
5000 
5001     case &#39;y&#39;:
5002       return g_variant_new_byte (va_arg (*app, guint));
5003 
5004     case &#39;n&#39;:
5005       return g_variant_new_int16 (va_arg (*app, gint));
5006 
5007     case &#39;q&#39;:
5008       return g_variant_new_uint16 (va_arg (*app, guint));
5009 
5010     case &#39;i&#39;:
5011       return g_variant_new_int32 (va_arg (*app, gint));
5012 
5013     case &#39;u&#39;:
5014       return g_variant_new_uint32 (va_arg (*app, guint));
5015 
5016     case &#39;x&#39;:
5017       return g_variant_new_int64 (va_arg (*app, gint64));
5018 
5019     case &#39;t&#39;:
5020       return g_variant_new_uint64 (va_arg (*app, guint64));
5021 
5022     case &#39;h&#39;:
5023       return g_variant_new_handle (va_arg (*app, gint));
5024 
5025     case &#39;d&#39;:
5026       return g_variant_new_double (va_arg (*app, gdouble));
5027 
5028     default:
5029       g_assert_not_reached ();
5030     }
5031 }
5032 
5033 /* The code below assumes this */
5034 G_STATIC_ASSERT (sizeof (gboolean) == sizeof (guint32));
5035 G_STATIC_ASSERT (sizeof (gdouble) == sizeof (guint64));
5036 
5037 static void
5038 g_variant_valist_get_leaf (const gchar **str,
5039                            GVariant     *value,
5040                            gboolean      free,
5041                            va_list      *app)
5042 {
5043   gpointer ptr = va_arg (*app, gpointer);
5044 
5045   if (ptr == NULL)
5046     {
5047       g_variant_format_string_scan (*str, NULL, str);
5048       return;
5049     }
5050 
5051   if (g_variant_format_string_is_nnp (*str))
5052     {
5053       gpointer *nnp = (gpointer *) ptr;
5054 
5055       if (free &amp;&amp; *nnp != NULL)
5056         g_variant_valist_free_nnp (*str, *nnp);
5057 
5058       *nnp = NULL;
5059 
5060       if (value != NULL)
5061         *nnp = g_variant_valist_get_nnp (str, value);
5062       else
5063         g_variant_format_string_scan (*str, NULL, str);
5064 
5065       return;
5066     }
5067 
5068   if (value != NULL)
5069     {
5070       switch (*(*str)++)
5071         {
5072         case &#39;b&#39;:
5073           *(gboolean *) ptr = g_variant_get_boolean (value);
5074           return;
5075 
5076         case &#39;y&#39;:
5077           *(guint8 *) ptr = g_variant_get_byte (value);
5078           return;
5079 
5080         case &#39;n&#39;:
5081           *(gint16 *) ptr = g_variant_get_int16 (value);
5082           return;
5083 
5084         case &#39;q&#39;:
5085           *(guint16 *) ptr = g_variant_get_uint16 (value);
5086           return;
5087 
5088         case &#39;i&#39;:
5089           *(gint32 *) ptr = g_variant_get_int32 (value);
5090           return;
5091 
5092         case &#39;u&#39;:
5093           *(guint32 *) ptr = g_variant_get_uint32 (value);
5094           return;
5095 
5096         case &#39;x&#39;:
5097           *(gint64 *) ptr = g_variant_get_int64 (value);
5098           return;
5099 
5100         case &#39;t&#39;:
5101           *(guint64 *) ptr = g_variant_get_uint64 (value);
5102           return;
5103 
5104         case &#39;h&#39;:
5105           *(gint32 *) ptr = g_variant_get_handle (value);
5106           return;
5107 
5108         case &#39;d&#39;:
5109           *(gdouble *) ptr = g_variant_get_double (value);
5110           return;
5111         }
5112     }
5113   else
5114     {
5115       switch (*(*str)++)
5116         {
5117         case &#39;y&#39;:
5118           *(guint8 *) ptr = 0;
5119           return;
5120 
5121         case &#39;n&#39;:
5122         case &#39;q&#39;:
5123           *(guint16 *) ptr = 0;
5124           return;
5125 
5126         case &#39;i&#39;:
5127         case &#39;u&#39;:
5128         case &#39;h&#39;:
5129         case &#39;b&#39;:
5130           *(guint32 *) ptr = 0;
5131           return;
5132 
5133         case &#39;x&#39;:
5134         case &#39;t&#39;:
5135         case &#39;d&#39;:
5136           *(guint64 *) ptr = 0;
5137           return;
5138         }
5139     }
5140 
5141   g_assert_not_reached ();
5142 }
5143 
5144 /* Generic (recursive) {{{2 */
5145 static void
5146 g_variant_valist_skip (const gchar **str,
5147                        va_list      *app)
5148 {
5149   if (g_variant_format_string_is_leaf (*str))
5150     g_variant_valist_skip_leaf (str, app);
5151 
5152   else if (**str == &#39;m&#39;) /* maybe */
5153     {
5154       (*str)++;
5155 
5156       if (!g_variant_format_string_is_nnp (*str))
5157         va_arg (*app, gboolean);
5158 
5159       g_variant_valist_skip (str, app);
5160     }
5161   else /* tuple, dictionary entry */
5162     {
5163       g_assert (**str == &#39;(&#39; || **str == &#39;{&#39;);
5164       (*str)++;
5165       while (**str != &#39;)&#39; &amp;&amp; **str != &#39;}&#39;)
5166         g_variant_valist_skip (str, app);
5167       (*str)++;
5168     }
5169 }
5170 
5171 static GVariant *
5172 g_variant_valist_new (const gchar **str,
5173                       va_list      *app)
5174 {
5175   if (g_variant_format_string_is_leaf (*str))
5176     return g_variant_valist_new_leaf (str, app);
5177 
5178   if (**str == &#39;m&#39;) /* maybe */
5179     {
5180       GVariantType *type = NULL;
5181       GVariant *value = NULL;
5182 
5183       (*str)++;
5184 
5185       if (g_variant_format_string_is_nnp (*str))
5186         {
5187           gpointer nnp = va_arg (*app, gpointer);
5188 
5189           if (nnp != NULL)
5190             value = g_variant_valist_new_nnp (str, nnp);
5191           else
5192             type = g_variant_format_string_scan_type (*str, NULL, str);
5193         }
5194       else
5195         {
5196           gboolean just = va_arg (*app, gboolean);
5197 
5198           if (just)
5199             value = g_variant_valist_new (str, app);
5200           else
5201             {
5202               type = g_variant_format_string_scan_type (*str, NULL, NULL);
5203               g_variant_valist_skip (str, app);
5204             }
5205         }
5206 
5207       value = g_variant_new_maybe (type, value);
5208 
5209       if (type != NULL)
5210         g_variant_type_free (type);
5211 
5212       return value;
5213     }
5214   else /* tuple, dictionary entry */
5215     {
5216       GVariantBuilder b;
5217 
5218       if (**str == &#39;(&#39;)
5219         g_variant_builder_init (&amp;b, G_VARIANT_TYPE_TUPLE);
5220       else
5221         {
5222           g_assert (**str == &#39;{&#39;);
5223           g_variant_builder_init (&amp;b, G_VARIANT_TYPE_DICT_ENTRY);
5224         }
5225 
5226       (*str)++; /* &#39;(&#39; */
5227       while (**str != &#39;)&#39; &amp;&amp; **str != &#39;}&#39;)
5228         g_variant_builder_add_value (&amp;b, g_variant_valist_new (str, app));
5229       (*str)++; /* &#39;)&#39; */
5230 
5231       return g_variant_builder_end (&amp;b);
5232     }
5233 }
5234 
5235 static void
5236 g_variant_valist_get (const gchar **str,
5237                       GVariant     *value,
5238                       gboolean      free,
5239                       va_list      *app)
5240 {
5241   if (g_variant_format_string_is_leaf (*str))
5242     g_variant_valist_get_leaf (str, value, free, app);
5243 
5244   else if (**str == &#39;m&#39;)
5245     {
5246       (*str)++;
5247 
5248       if (value != NULL)
5249         value = g_variant_get_maybe (value);
5250 
5251       if (!g_variant_format_string_is_nnp (*str))
5252         {
5253           gboolean *ptr = va_arg (*app, gboolean *);
5254 
5255           if (ptr != NULL)
5256             *ptr = value != NULL;
5257         }
5258 
5259       g_variant_valist_get (str, value, free, app);
5260 
5261       if (value != NULL)
5262         g_variant_unref (value);
5263     }
5264 
5265   else /* tuple, dictionary entry */
5266     {
5267       gint index = 0;
5268 
5269       g_assert (**str == &#39;(&#39; || **str == &#39;{&#39;);
5270 
5271       (*str)++;
5272       while (**str != &#39;)&#39; &amp;&amp; **str != &#39;}&#39;)
5273         {
5274           if (value != NULL)
5275             {
5276               GVariant *child = g_variant_get_child_value (value, index++);
5277               g_variant_valist_get (str, child, free, app);
5278               g_variant_unref (child);
5279             }
5280           else
5281             g_variant_valist_get (str, NULL, free, app);
5282         }
5283       (*str)++;
5284     }
5285 }
5286 
5287 /* User-facing API {{{2 */
5288 /**
5289  * g_variant_new: (skip)
5290  * @format_string: a #GVariant format string
5291  * @...: arguments, as per @format_string
5292  *
5293  * Creates a new #GVariant instance.
5294  *
5295  * Think of this function as an analogue to g_strdup_printf().
5296  *
5297  * The type of the created instance and the arguments that are expected
5298  * by this function are determined by @format_string. See the section on
5299  * [GVariant format strings][gvariant-format-strings]. Please note that
5300  * the syntax of the format string is very likely to be extended in the
5301  * future.
5302  *
5303  * The first character of the format string must not be &#39;*&#39; &#39;?&#39; &#39;@&#39; or
5304  * &#39;r&#39;; in essence, a new #GVariant must always be constructed by this
5305  * function (and not merely passed through it unmodified).
5306  *
5307  * Note that the arguments must be of the correct width for their types
5308  * specified in @format_string. This can be achieved by casting them. See
5309  * the [GVariant varargs documentation][gvariant-varargs].
5310  *
5311  * |[&lt;!-- language=&quot;C&quot; --&gt;
5312  * MyFlags some_flags = FLAG_ONE | FLAG_TWO;
5313  * const gchar *some_strings[] = { &quot;a&quot;, &quot;b&quot;, &quot;c&quot;, NULL };
5314  * GVariant *new_variant;
5315  *
5316  * new_variant = g_variant_new (&quot;(t^as)&quot;,
5317  *                              // This cast is required.
5318  *                              (guint64) some_flags,
5319  *                              some_strings);
5320  * ]|
5321  *
5322  * Returns: a new floating #GVariant instance
5323  *
5324  * Since: 2.24
5325  **/
5326 GVariant *
5327 g_variant_new (const gchar *format_string,
5328                ...)
5329 {
5330   GVariant *value;
5331   va_list ap;
5332 
5333   g_return_val_if_fail (valid_format_string (format_string, TRUE, NULL) &amp;&amp;
5334                         format_string[0] != &#39;?&#39; &amp;&amp; format_string[0] != &#39;@&#39; &amp;&amp;
5335                         format_string[0] != &#39;*&#39; &amp;&amp; format_string[0] != &#39;r&#39;,
5336                         NULL);
5337 
5338   va_start (ap, format_string);
5339   value = g_variant_new_va (format_string, NULL, &amp;ap);
5340   va_end (ap);
5341 
5342   return value;
5343 }
5344 
5345 /**
5346  * g_variant_new_va: (skip)
5347  * @format_string: a string that is prefixed with a format string
5348  * @endptr: (nullable) (default NULL): location to store the end pointer,
5349  *          or %NULL
5350  * @app: a pointer to a #va_list
5351  *
5352  * This function is intended to be used by libraries based on
5353  * #GVariant that want to provide g_variant_new()-like functionality
5354  * to their users.
5355  *
5356  * The API is more general than g_variant_new() to allow a wider range
5357  * of possible uses.
5358  *
5359  * @format_string must still point to a valid format string, but it only
5360  * needs to be nul-terminated if @endptr is %NULL.  If @endptr is
5361  * non-%NULL then it is updated to point to the first character past the
5362  * end of the format string.
5363  *
5364  * @app is a pointer to a #va_list.  The arguments, according to
5365  * @format_string, are collected from this #va_list and the list is left
5366  * pointing to the argument following the last.
5367  *
5368  * Note that the arguments in @app must be of the correct width for their
5369  * types specified in @format_string when collected into the #va_list.
5370  * See the [GVariant varargs documentation][gvariant-varargs].
5371  *
5372  * These two generalisations allow mixing of multiple calls to
5373  * g_variant_new_va() and g_variant_get_va() within a single actual
5374  * varargs call by the user.
5375  *
5376  * The return value will be floating if it was a newly created GVariant
5377  * instance (for example, if the format string was &quot;(ii)&quot;).  In the case
5378  * that the format_string was &#39;*&#39;, &#39;?&#39;, &#39;r&#39;, or a format starting with
5379  * &#39;@&#39; then the collected #GVariant pointer will be returned unmodified,
5380  * without adding any additional references.
5381  *
5382  * In order to behave correctly in all cases it is necessary for the
5383  * calling function to g_variant_ref_sink() the return result before
5384  * returning control to the user that originally provided the pointer.
5385  * At this point, the caller will have their own full reference to the
5386  * result.  This can also be done by adding the result to a container,
5387  * or by passing it to another g_variant_new() call.
5388  *
5389  * Returns: a new, usually floating, #GVariant
5390  *
5391  * Since: 2.24
5392  **/
5393 GVariant *
5394 g_variant_new_va (const gchar  *format_string,
5395                   const gchar **endptr,
5396                   va_list      *app)
5397 {
5398   GVariant *value;
5399 
5400   g_return_val_if_fail (valid_format_string (format_string, !endptr, NULL),
5401                         NULL);
5402   g_return_val_if_fail (app != NULL, NULL);
5403 
5404   value = g_variant_valist_new (&amp;format_string, app);
5405 
5406   if (endptr != NULL)
5407     *endptr = format_string;
5408 
5409   return value;
5410 }
5411 
5412 /**
5413  * g_variant_get: (skip)
5414  * @value: a #GVariant instance
5415  * @format_string: a #GVariant format string
5416  * @...: arguments, as per @format_string
5417  *
5418  * Deconstructs a #GVariant instance.
5419  *
5420  * Think of this function as an analogue to scanf().
5421  *
5422  * The arguments that are expected by this function are entirely
5423  * determined by @format_string.  @format_string also restricts the
5424  * permissible types of @value.  It is an error to give a value with
5425  * an incompatible type.  See the section on
5426  * [GVariant format strings][gvariant-format-strings].
5427  * Please note that the syntax of the format string is very likely to be
5428  * extended in the future.
5429  *
5430  * @format_string determines the C types that are used for unpacking
5431  * the values and also determines if the values are copied or borrowed,
5432  * see the section on
5433  * [GVariant format strings][gvariant-format-strings-pointers].
5434  *
5435  * Since: 2.24
5436  **/
5437 void
5438 g_variant_get (GVariant    *value,
5439                const gchar *format_string,
5440                ...)
5441 {
5442   va_list ap;
5443 
5444   g_return_if_fail (valid_format_string (format_string, TRUE, value));
5445 
5446   /* if any direct-pointer-access formats are in use, flatten first */
5447   if (strchr (format_string, &#39;&amp;&#39;))
5448     g_variant_get_data (value);
5449 
5450   va_start (ap, format_string);
5451   g_variant_get_va (value, format_string, NULL, &amp;ap);
5452   va_end (ap);
5453 }
5454 
5455 /**
5456  * g_variant_get_va: (skip)
5457  * @value: a #GVariant
5458  * @format_string: a string that is prefixed with a format string
5459  * @endptr: (nullable) (default NULL): location to store the end pointer,
5460  *          or %NULL
5461  * @app: a pointer to a #va_list
5462  *
5463  * This function is intended to be used by libraries based on #GVariant
5464  * that want to provide g_variant_get()-like functionality to their
5465  * users.
5466  *
5467  * The API is more general than g_variant_get() to allow a wider range
5468  * of possible uses.
5469  *
5470  * @format_string must still point to a valid format string, but it only
5471  * need to be nul-terminated if @endptr is %NULL.  If @endptr is
5472  * non-%NULL then it is updated to point to the first character past the
5473  * end of the format string.
5474  *
5475  * @app is a pointer to a #va_list.  The arguments, according to
5476  * @format_string, are collected from this #va_list and the list is left
5477  * pointing to the argument following the last.
5478  *
5479  * These two generalisations allow mixing of multiple calls to
5480  * g_variant_new_va() and g_variant_get_va() within a single actual
5481  * varargs call by the user.
5482  *
5483  * @format_string determines the C types that are used for unpacking
5484  * the values and also determines if the values are copied or borrowed,
5485  * see the section on
5486  * [GVariant format strings][gvariant-format-strings-pointers].
5487  *
5488  * Since: 2.24
5489  **/
5490 void
5491 g_variant_get_va (GVariant     *value,
5492                   const gchar  *format_string,
5493                   const gchar **endptr,
5494                   va_list      *app)
5495 {
5496   g_return_if_fail (valid_format_string (format_string, !endptr, value));
5497   g_return_if_fail (value != NULL);
5498   g_return_if_fail (app != NULL);
5499 
5500   /* if any direct-pointer-access formats are in use, flatten first */
5501   if (strchr (format_string, &#39;&amp;&#39;))
5502     g_variant_get_data (value);
5503 
5504   g_variant_valist_get (&amp;format_string, value, FALSE, app);
5505 
5506   if (endptr != NULL)
5507     *endptr = format_string;
5508 }
5509 
5510 /* Varargs-enabled Utility Functions {{{1 */
5511 
5512 /**
5513  * g_variant_builder_add: (skip)
5514  * @builder: a #GVariantBuilder
5515  * @format_string: a #GVariant varargs format string
5516  * @...: arguments, as per @format_string
5517  *
5518  * Adds to a #GVariantBuilder.
5519  *
5520  * This call is a convenience wrapper that is exactly equivalent to
5521  * calling g_variant_new() followed by g_variant_builder_add_value().
5522  *
5523  * Note that the arguments must be of the correct width for their types
5524  * specified in @format_string. This can be achieved by casting them. See
5525  * the [GVariant varargs documentation][gvariant-varargs].
5526  *
5527  * This function might be used as follows:
5528  *
5529  * |[&lt;!-- language=&quot;C&quot; --&gt;
5530  * GVariant *
5531  * make_pointless_dictionary (void)
5532  * {
5533  *   GVariantBuilder builder;
5534  *   int i;
5535  *
5536  *   g_variant_builder_init (&amp;builder, G_VARIANT_TYPE_ARRAY);
5537  *   for (i = 0; i &lt; 16; i++)
5538  *     {
5539  *       gchar buf[3];
5540  *
5541  *       sprintf (buf, &quot;%d&quot;, i);
5542  *       g_variant_builder_add (&amp;builder, &quot;{is}&quot;, i, buf);
5543  *     }
5544  *
5545  *   return g_variant_builder_end (&amp;builder);
5546  * }
5547  * ]|
5548  *
5549  * Since: 2.24
5550  */
5551 void
5552 g_variant_builder_add (GVariantBuilder *builder,
5553                        const gchar     *format_string,
5554                        ...)
5555 {
5556   GVariant *variant;
5557   va_list ap;
5558 
5559   va_start (ap, format_string);
5560   variant = g_variant_new_va (format_string, NULL, &amp;ap);
5561   va_end (ap);
5562 
5563   g_variant_builder_add_value (builder, variant);
5564 }
5565 
5566 /**
5567  * g_variant_get_child: (skip)
5568  * @value: a container #GVariant
5569  * @index_: the index of the child to deconstruct
5570  * @format_string: a #GVariant format string
5571  * @...: arguments, as per @format_string
5572  *
5573  * Reads a child item out of a container #GVariant instance and
5574  * deconstructs it according to @format_string.  This call is
5575  * essentially a combination of g_variant_get_child_value() and
5576  * g_variant_get().
5577  *
5578  * @format_string determines the C types that are used for unpacking
5579  * the values and also determines if the values are copied or borrowed,
5580  * see the section on
5581  * [GVariant format strings][gvariant-format-strings-pointers].
5582  *
5583  * Since: 2.24
5584  **/
5585 void
5586 g_variant_get_child (GVariant    *value,
5587                      gsize        index_,
5588                      const gchar *format_string,
5589                      ...)
5590 {
5591   GVariant *child;
5592   va_list ap;
5593 
5594   /* if any direct-pointer-access formats are in use, flatten first */
5595   if (strchr (format_string, &#39;&amp;&#39;))
5596     g_variant_get_data (value);
5597 
5598   child = g_variant_get_child_value (value, index_);
5599   g_return_if_fail (valid_format_string (format_string, TRUE, child));
5600 
5601   va_start (ap, format_string);
5602   g_variant_get_va (child, format_string, NULL, &amp;ap);
5603   va_end (ap);
5604 
5605   g_variant_unref (child);
5606 }
5607 
5608 /**
5609  * g_variant_iter_next: (skip)
5610  * @iter: a #GVariantIter
5611  * @format_string: a GVariant format string
5612  * @...: the arguments to unpack the value into
5613  *
5614  * Gets the next item in the container and unpacks it into the variable
5615  * argument list according to @format_string, returning %TRUE.
5616  *
5617  * If no more items remain then %FALSE is returned.
5618  *
5619  * All of the pointers given on the variable arguments list of this
5620  * function are assumed to point at uninitialised memory.  It is the
5621  * responsibility of the caller to free all of the values returned by
5622  * the unpacking process.
5623  *
5624  * Here is an example for memory management with g_variant_iter_next():
5625  * |[&lt;!-- language=&quot;C&quot; --&gt;
5626  *   // Iterates a dictionary of type &#39;a{sv}&#39;
5627  *   void
5628  *   iterate_dictionary (GVariant *dictionary)
5629  *   {
5630  *     GVariantIter iter;
5631  *     GVariant *value;
5632  *     gchar *key;
5633  *
5634  *     g_variant_iter_init (&amp;iter, dictionary);
5635  *     while (g_variant_iter_next (&amp;iter, &quot;{sv}&quot;, &amp;key, &amp;value))
5636  *       {
5637  *         g_print (&quot;Item &#39;%s&#39; has type &#39;%s&#39;\n&quot;, key,
5638  *                  g_variant_get_type_string (value));
5639  *
5640  *         // must free data for ourselves
5641  *         g_variant_unref (value);
5642  *         g_free (key);
5643  *       }
5644  *   }
5645  * ]|
5646  *
5647  * For a solution that is likely to be more convenient to C programmers
5648  * when dealing with loops, see g_variant_iter_loop().
5649  *
5650  * @format_string determines the C types that are used for unpacking
5651  * the values and also determines if the values are copied or borrowed.
5652  *
5653  * See the section on
5654  * [GVariant format strings][gvariant-format-strings-pointers].
5655  *
5656  * Returns: %TRUE if a value was unpacked, or %FALSE if there as no value
5657  *
5658  * Since: 2.24
5659  **/
5660 gboolean
5661 g_variant_iter_next (GVariantIter *iter,
5662                      const gchar  *format_string,
5663                      ...)
5664 {
5665   GVariant *value;
5666 
5667   value = g_variant_iter_next_value (iter);
5668 
5669   g_return_val_if_fail (valid_format_string (format_string, TRUE, value),
5670                         FALSE);
5671 
5672   if (value != NULL)
5673     {
5674       va_list ap;
5675 
5676       va_start (ap, format_string);
5677       g_variant_valist_get (&amp;format_string, value, FALSE, &amp;ap);
5678       va_end (ap);
5679 
5680       g_variant_unref (value);
5681     }
5682 
5683   return value != NULL;
5684 }
5685 
5686 /**
5687  * g_variant_iter_loop: (skip)
5688  * @iter: a #GVariantIter
5689  * @format_string: a GVariant format string
5690  * @...: the arguments to unpack the value into
5691  *
5692  * Gets the next item in the container and unpacks it into the variable
5693  * argument list according to @format_string, returning %TRUE.
5694  *
5695  * If no more items remain then %FALSE is returned.
5696  *
5697  * On the first call to this function, the pointers appearing on the
5698  * variable argument list are assumed to point at uninitialised memory.
5699  * On the second and later calls, it is assumed that the same pointers
5700  * will be given and that they will point to the memory as set by the
5701  * previous call to this function.  This allows the previous values to
5702  * be freed, as appropriate.
5703  *
5704  * This function is intended to be used with a while loop as
5705  * demonstrated in the following example.  This function can only be
5706  * used when iterating over an array.  It is only valid to call this
5707  * function with a string constant for the format string and the same
5708  * string constant must be used each time.  Mixing calls to this
5709  * function and g_variant_iter_next() or g_variant_iter_next_value() on
5710  * the same iterator causes undefined behavior.
5711  *
5712  * If you break out of a such a while loop using g_variant_iter_loop() then
5713  * you must free or unreference all the unpacked values as you would with
5714  * g_variant_get(). Failure to do so will cause a memory leak.
5715  *
5716  * Here is an example for memory management with g_variant_iter_loop():
5717  * |[&lt;!-- language=&quot;C&quot; --&gt;
5718  *   // Iterates a dictionary of type &#39;a{sv}&#39;
5719  *   void
5720  *   iterate_dictionary (GVariant *dictionary)
5721  *   {
5722  *     GVariantIter iter;
5723  *     GVariant *value;
5724  *     gchar *key;
5725  *
5726  *     g_variant_iter_init (&amp;iter, dictionary);
5727  *     while (g_variant_iter_loop (&amp;iter, &quot;{sv}&quot;, &amp;key, &amp;value))
5728  *       {
5729  *         g_print (&quot;Item &#39;%s&#39; has type &#39;%s&#39;\n&quot;, key,
5730  *                  g_variant_get_type_string (value));
5731  *
5732  *         // no need to free &#39;key&#39; and &#39;value&#39; here
5733  *         // unless breaking out of this loop
5734  *       }
5735  *   }
5736  * ]|
5737  *
5738  * For most cases you should use g_variant_iter_next().
5739  *
5740  * This function is really only useful when unpacking into #GVariant or
5741  * #GVariantIter in order to allow you to skip the call to
5742  * g_variant_unref() or g_variant_iter_free().
5743  *
5744  * For example, if you are only looping over simple integer and string
5745  * types, g_variant_iter_next() is definitely preferred.  For string
5746  * types, use the &#39;&amp;&#39; prefix to avoid allocating any memory at all (and
5747  * thereby avoiding the need to free anything as well).
5748  *
5749  * @format_string determines the C types that are used for unpacking
5750  * the values and also determines if the values are copied or borrowed.
5751  *
5752  * See the section on
5753  * [GVariant format strings][gvariant-format-strings-pointers].
5754  *
5755  * Returns: %TRUE if a value was unpacked, or %FALSE if there was no
5756  *          value
5757  *
5758  * Since: 2.24
5759  **/
5760 gboolean
5761 g_variant_iter_loop (GVariantIter *iter,
5762                      const gchar  *format_string,
5763                      ...)
5764 {
5765   gboolean first_time = GVSI(iter)-&gt;loop_format == NULL;
5766   GVariant *value;
5767   va_list ap;
5768 
5769   g_return_val_if_fail (first_time ||
5770                         format_string == GVSI(iter)-&gt;loop_format,
5771                         FALSE);
5772 
5773   if (first_time)
5774     {
5775       TYPE_CHECK (GVSI(iter)-&gt;value, G_VARIANT_TYPE_ARRAY, FALSE);
5776       GVSI(iter)-&gt;loop_format = format_string;
5777 
5778       if (strchr (format_string, &#39;&amp;&#39;))
5779         g_variant_get_data (GVSI(iter)-&gt;value);
5780     }
5781 
5782   value = g_variant_iter_next_value (iter);
5783 
5784   g_return_val_if_fail (!first_time ||
5785                         valid_format_string (format_string, TRUE, value),
5786                         FALSE);
5787 
5788   va_start (ap, format_string);
5789   g_variant_valist_get (&amp;format_string, value, !first_time, &amp;ap);
5790   va_end (ap);
5791 
5792   if (value != NULL)
5793     g_variant_unref (value);
5794 
5795   return value != NULL;
5796 }
5797 
5798 /* Serialised data {{{1 */
5799 static GVariant *
5800 g_variant_deep_copy (GVariant *value)
5801 {
5802   switch (g_variant_classify (value))
5803     {
5804     case G_VARIANT_CLASS_MAYBE:
5805     case G_VARIANT_CLASS_ARRAY:
5806     case G_VARIANT_CLASS_TUPLE:
5807     case G_VARIANT_CLASS_DICT_ENTRY:
5808     case G_VARIANT_CLASS_VARIANT:
5809       {
5810         GVariantBuilder builder;
5811         GVariantIter iter;
5812         GVariant *child;
5813 
5814         g_variant_builder_init (&amp;builder, g_variant_get_type (value));
5815         g_variant_iter_init (&amp;iter, value);
5816 
5817         while ((child = g_variant_iter_next_value (&amp;iter)))
5818           {
5819             g_variant_builder_add_value (&amp;builder, g_variant_deep_copy (child));
5820             g_variant_unref (child);
5821           }
5822 
5823         return g_variant_builder_end (&amp;builder);
5824       }
5825 
5826     case G_VARIANT_CLASS_BOOLEAN:
5827       return g_variant_new_boolean (g_variant_get_boolean (value));
5828 
5829     case G_VARIANT_CLASS_BYTE:
5830       return g_variant_new_byte (g_variant_get_byte (value));
5831 
5832     case G_VARIANT_CLASS_INT16:
5833       return g_variant_new_int16 (g_variant_get_int16 (value));
5834 
5835     case G_VARIANT_CLASS_UINT16:
5836       return g_variant_new_uint16 (g_variant_get_uint16 (value));
5837 
5838     case G_VARIANT_CLASS_INT32:
5839       return g_variant_new_int32 (g_variant_get_int32 (value));
5840 
5841     case G_VARIANT_CLASS_UINT32:
5842       return g_variant_new_uint32 (g_variant_get_uint32 (value));
5843 
5844     case G_VARIANT_CLASS_INT64:
5845       return g_variant_new_int64 (g_variant_get_int64 (value));
5846 
5847     case G_VARIANT_CLASS_UINT64:
5848       return g_variant_new_uint64 (g_variant_get_uint64 (value));
5849 
5850     case G_VARIANT_CLASS_HANDLE:
5851       return g_variant_new_handle (g_variant_get_handle (value));
5852 
5853     case G_VARIANT_CLASS_DOUBLE:
5854       return g_variant_new_double (g_variant_get_double (value));
5855 
5856     case G_VARIANT_CLASS_STRING:
5857       return g_variant_new_string (g_variant_get_string (value, NULL));
5858 
5859     case G_VARIANT_CLASS_OBJECT_PATH:
5860       return g_variant_new_object_path (g_variant_get_string (value, NULL));
5861 
5862     case G_VARIANT_CLASS_SIGNATURE:
5863       return g_variant_new_signature (g_variant_get_string (value, NULL));
5864     }
5865 
5866   g_assert_not_reached ();
5867 }
5868 
5869 /**
5870  * g_variant_get_normal_form:
5871  * @value: a #GVariant
5872  *
5873  * Gets a #GVariant instance that has the same value as @value and is
5874  * trusted to be in normal form.
5875  *
5876  * If @value is already trusted to be in normal form then a new
5877  * reference to @value is returned.
5878  *
5879  * If @value is not already trusted, then it is scanned to check if it
5880  * is in normal form.  If it is found to be in normal form then it is
5881  * marked as trusted and a new reference to it is returned.
5882  *
5883  * If @value is found not to be in normal form then a new trusted
5884  * #GVariant is created with the same value as @value.
5885  *
5886  * It makes sense to call this function if you&#39;ve received #GVariant
5887  * data from untrusted sources and you want to ensure your serialised
5888  * output is definitely in normal form.
5889  *
5890  * If @value is already in normal form, a new reference will be returned
5891  * (which will be floating if @value is floating). If it is not in normal form,
5892  * the newly created #GVariant will be returned with a single non-floating
5893  * reference. Typically, g_variant_take_ref() should be called on the return
5894  * value from this function to guarantee ownership of a single non-floating
5895  * reference to it.
5896  *
5897  * Returns: (transfer full): a trusted #GVariant
5898  *
5899  * Since: 2.24
5900  **/
5901 GVariant *
5902 g_variant_get_normal_form (GVariant *value)
5903 {
5904   GVariant *trusted;
5905 
5906   if (g_variant_is_normal_form (value))
5907     return g_variant_ref (value);
5908 
5909   trusted = g_variant_deep_copy (value);
5910   g_assert (g_variant_is_trusted (trusted));
5911 
5912   return g_variant_ref_sink (trusted);
5913 }
5914 
5915 /**
5916  * g_variant_byteswap:
5917  * @value: a #GVariant
5918  *
5919  * Performs a byteswapping operation on the contents of @value.  The
5920  * result is that all multi-byte numeric data contained in @value is
5921  * byteswapped.  That includes 16, 32, and 64bit signed and unsigned
5922  * integers as well as file handles and double precision floating point
5923  * values.
5924  *
5925  * This function is an identity mapping on any value that does not
5926  * contain multi-byte numeric data.  That include strings, booleans,
5927  * bytes and containers containing only these things (recursively).
5928  *
5929  * The returned value is always in normal form and is marked as trusted.
5930  *
5931  * Returns: (transfer full): the byteswapped form of @value
5932  *
5933  * Since: 2.24
5934  **/
5935 GVariant *
5936 g_variant_byteswap (GVariant *value)
5937 {
5938   GVariantTypeInfo *type_info;
5939   guint alignment;
5940   GVariant *new;
5941 
5942   type_info = g_variant_get_type_info (value);
5943 
5944   g_variant_type_info_query (type_info, &amp;alignment, NULL);
5945 
5946   if (alignment)
5947     /* (potentially) contains multi-byte numeric data */
5948     {
5949       GVariantSerialised serialised;
5950       GVariant *trusted;
5951       GBytes *bytes;
5952 
5953       trusted = g_variant_get_normal_form (value);
5954       serialised.type_info = g_variant_get_type_info (trusted);
5955       serialised.size = g_variant_get_size (trusted);
5956       serialised.data = g_malloc (serialised.size);
5957       g_variant_store (trusted, serialised.data);
5958       g_variant_unref (trusted);
5959 
5960       g_variant_serialised_byteswap (serialised);
5961 
5962       bytes = g_bytes_new_take (serialised.data, serialised.size);
5963 #ifdef GSTREAMER_LITE
5964       if (bytes == NULL) {
5965         return NULL;
5966       }
5967 #endif // GSTREAMER_LITE
5968       new = g_variant_new_from_bytes (g_variant_get_type (value), bytes, TRUE);
5969       g_bytes_unref (bytes);
5970     }
5971   else
5972     /* contains no multi-byte data */
5973     new = value;
5974 
5975   return g_variant_ref_sink (new);
5976 }
5977 
5978 /**
5979  * g_variant_new_from_data:
5980  * @type: a definite #GVariantType
5981  * @data: (array length=size) (element-type guint8): the serialised data
5982  * @size: the size of @data
5983  * @trusted: %TRUE if @data is definitely in normal form
5984  * @notify: (scope async): function to call when @data is no longer needed
5985  * @user_data: data for @notify
5986  *
5987  * Creates a new #GVariant instance from serialised data.
5988  *
5989  * @type is the type of #GVariant instance that will be constructed.
5990  * The interpretation of @data depends on knowing the type.
5991  *
5992  * @data is not modified by this function and must remain valid with an
5993  * unchanging value until such a time as @notify is called with
5994  * @user_data.  If the contents of @data change before that time then
5995  * the result is undefined.
5996  *
5997  * If @data is trusted to be serialised data in normal form then
5998  * @trusted should be %TRUE.  This applies to serialised data created
5999  * within this process or read from a trusted location on the disk (such
6000  * as a file installed in /usr/lib alongside your application).  You
6001  * should set trusted to %FALSE if @data is read from the network, a
6002  * file in the user&#39;s home directory, etc.
6003  *
6004  * If @data was not stored in this machine&#39;s native endianness, any multi-byte
6005  * numeric values in the returned variant will also be in non-native
6006  * endianness. g_variant_byteswap() can be used to recover the original values.
6007  *
6008  * @notify will be called with @user_data when @data is no longer
6009  * needed.  The exact time of this call is unspecified and might even be
6010  * before this function returns.
6011  *
<a name="28" id="anc28"></a>




6012  * Returns: (transfer none): a new floating #GVariant of type @type
6013  *
6014  * Since: 2.24
6015  **/
6016 GVariant *
6017 g_variant_new_from_data (const GVariantType *type,
6018                          gconstpointer       data,
6019                          gsize               size,
6020                          gboolean            trusted,
6021                          GDestroyNotify      notify,
6022                          gpointer            user_data)
6023 {
6024   GVariant *value;
6025   GBytes *bytes;
6026 
6027   g_return_val_if_fail (g_variant_type_is_definite (type), NULL);
6028   g_return_val_if_fail (data != NULL || size == 0, NULL);
6029 
6030   if (notify)
6031     bytes = g_bytes_new_with_free_func (data, size, notify, user_data);
6032   else
6033     bytes = g_bytes_new_static (data, size);
6034 
6035   value = g_variant_new_from_bytes (type, bytes, trusted);
6036   g_bytes_unref (bytes);
6037 
6038   return value;
6039 }
6040 
6041 /* Epilogue {{{1 */
6042 /* vim:set foldmethod=marker: */
<a name="29" id="anc29"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="29" type="hidden" />
</body>
</html>