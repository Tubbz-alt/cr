<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.media/src/main/native/gstreamer/gstreamer-lite/gst-plugins-base/gst-libs/gst/app/gstappsrc.c</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /* GStreamer
   2  * Copyright (C) 2007 David Schleef &lt;ds@schleef.org&gt;
   3  *           (C) 2008 Wim Taymans &lt;wim.taymans@gmail.com&gt;
   4  *
   5  * This library is free software; you can redistribute it and/or
   6  * modify it under the terms of the GNU Library General Public
   7  * License as published by the Free Software Foundation; either
   8  * version 2 of the License, or (at your option) any later version.
   9  *
  10  * This library is distributed in the hope that it will be useful,
  11  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  12  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
  13  * Library General Public License for more details.
  14  *
  15  * You should have received a copy of the GNU Library General Public
  16  * License along with this library; if not, write to the
  17  * Free Software Foundation, Inc., 51 Franklin St, Fifth Floor,
  18  * Boston, MA 02110-1301, USA.
  19  */
  20 /**
  21  * SECTION:gstappsrc
  22  * @title: GstAppSrc
  23  * @short_description: Easy way for applications to inject buffers into a
  24  *     pipeline
  25  * @see_also: #GstBaseSrc, appsink
  26  *
  27  * The appsrc element can be used by applications to insert data into a
  28  * GStreamer pipeline. Unlike most GStreamer elements, appsrc provides
  29  * external API functions.
  30  *
  31  * appsrc can be used by linking with the libgstapp library to access the
  32  * methods directly or by using the appsrc action signals.
  33  *
  34  * Before operating appsrc, the caps property must be set to fixed caps
  35  * describing the format of the data that will be pushed with appsrc. An
  36  * exception to this is when pushing buffers with unknown caps, in which case no
  37  * caps should be set. This is typically true of file-like sources that push raw
  38  * byte buffers. If you don&#39;t want to explicitly set the caps, you can use
  39  * gst_app_src_push_sample. This method gets the caps associated with the
  40  * sample and sets them on the appsrc replacing any previously set caps (if
  41  * different from sample&#39;s caps).
  42  *
  43  * The main way of handing data to the appsrc element is by calling the
  44  * gst_app_src_push_buffer() method or by emitting the push-buffer action signal.
  45  * This will put the buffer onto a queue from which appsrc will read from in its
  46  * streaming thread. It is important to note that data transport will not happen
  47  * from the thread that performed the push-buffer call.
  48  *
  49  * The &quot;max-bytes&quot; property controls how much data can be queued in appsrc
  50  * before appsrc considers the queue full. A filled internal queue will always
  51  * signal the &quot;enough-data&quot; signal, which signals the application that it should
  52  * stop pushing data into appsrc. The &quot;block&quot; property will cause appsrc to
  53  * block the push-buffer method until free data becomes available again.
  54  *
  55  * When the internal queue is running out of data, the &quot;need-data&quot; signal is
  56  * emitted, which signals the application that it should start pushing more data
  57  * into appsrc.
  58  *
  59  * In addition to the &quot;need-data&quot; and &quot;enough-data&quot; signals, appsrc can emit the
  60  * &quot;seek-data&quot; signal when the &quot;stream-mode&quot; property is set to &quot;seekable&quot; or
  61  * &quot;random-access&quot;. The signal argument will contain the new desired position in
  62  * the stream expressed in the unit set with the &quot;format&quot; property. After
  63  * receiving the seek-data signal, the application should push-buffers from the
  64  * new position.
  65  *
  66  * These signals allow the application to operate the appsrc in two different
  67  * ways:
  68  *
  69  * The push mode, in which the application repeatedly calls the push-buffer/push-sample
  70  * method with a new buffer/sample. Optionally, the queue size in the appsrc
  71  * can be controlled with the enough-data and need-data signals by respectively
  72  * stopping/starting the push-buffer/push-sample calls. This is a typical
  73  * mode of operation for the stream-type &quot;stream&quot; and &quot;seekable&quot;. Use this
  74  * mode when implementing various network protocols or hardware devices.
  75  *
  76  * The pull mode, in which the need-data signal triggers the next push-buffer call.
  77  * This mode is typically used in the &quot;random-access&quot; stream-type. Use this
  78  * mode for file access or other randomly accessable sources. In this mode, a
  79  * buffer of exactly the amount of bytes given by the need-data signal should be
  80  * pushed into appsrc.
  81  *
  82  * In all modes, the size property on appsrc should contain the total stream
  83  * size in bytes. Setting this property is mandatory in the random-access mode.
  84  * For the stream and seekable modes, setting this property is optional but
  85  * recommended.
  86  *
  87  * When the application has finished pushing data into appsrc, it should call
  88  * gst_app_src_end_of_stream() or emit the end-of-stream action signal. After
  89  * this call, no more buffers can be pushed into appsrc until a flushing seek
  90  * occurs or the state of the appsrc has gone through READY.
  91  */
  92 
  93 #ifdef HAVE_CONFIG_H
  94 #include &quot;config.h&quot;
  95 #endif
  96 
  97 #include &lt;gst/gst.h&gt;
  98 #include &lt;gst/base/base.h&gt;
  99 
 100 #include &lt;string.h&gt;
 101 
 102 #include &quot;gstappsrc.h&quot;
 103 
 104 typedef enum
 105 {
 106   NOONE_WAITING = 0,
 107   STREAM_WAITING = 1 &lt;&lt; 0,      /* streaming thread is waiting for application thread */
 108   APP_WAITING = 1 &lt;&lt; 1,         /* application thread is waiting for streaming thread */
 109 } GstAppSrcWaitStatus;
 110 
 111 struct _GstAppSrcPrivate
 112 {
 113   GCond cond;
 114   GMutex mutex;
 115   GstQueueArray *queue;
 116   GstAppSrcWaitStatus wait_status;
 117 
 118   GstCaps *last_caps;
 119   GstCaps *current_caps;
 120 
 121   gint64 size;
 122   GstClockTime duration;
 123   GstAppStreamType stream_type;
 124   guint64 max_bytes;
 125   GstFormat format;
 126   gboolean block;
 127   gchar *uri;
 128 
 129   gboolean flushing;
 130   gboolean started;
 131   gboolean is_eos;
 132   guint64 queued_bytes;
 133   guint64 offset;
 134   GstAppStreamType current_type;
 135 
 136   guint64 min_latency;
 137   guint64 max_latency;
 138   gboolean emit_signals;
 139   guint min_percent;
 140 
 141   GstAppSrcCallbacks callbacks;
 142   gpointer user_data;
 143   GDestroyNotify notify;
 144 };
 145 
 146 GST_DEBUG_CATEGORY_STATIC (app_src_debug);
 147 #define GST_CAT_DEFAULT app_src_debug
 148 
 149 enum
 150 {
 151   /* signals */
 152   SIGNAL_NEED_DATA,
 153   SIGNAL_ENOUGH_DATA,
 154   SIGNAL_SEEK_DATA,
 155 
 156   /* actions */
 157   SIGNAL_PUSH_BUFFER,
 158   SIGNAL_END_OF_STREAM,
 159   SIGNAL_PUSH_SAMPLE,
 160   SIGNAL_PUSH_BUFFER_LIST,
 161 
 162   LAST_SIGNAL
 163 };
 164 
 165 #define DEFAULT_PROP_SIZE          -1
 166 #define DEFAULT_PROP_STREAM_TYPE   GST_APP_STREAM_TYPE_STREAM
 167 #define DEFAULT_PROP_MAX_BYTES     200000
 168 #define DEFAULT_PROP_FORMAT        GST_FORMAT_BYTES
 169 #define DEFAULT_PROP_BLOCK         FALSE
 170 #define DEFAULT_PROP_IS_LIVE       FALSE
 171 #define DEFAULT_PROP_MIN_LATENCY   -1
 172 #define DEFAULT_PROP_MAX_LATENCY   -1
 173 #define DEFAULT_PROP_EMIT_SIGNALS  TRUE
 174 #define DEFAULT_PROP_MIN_PERCENT   0
 175 #define DEFAULT_PROP_CURRENT_LEVEL_BYTES   0
 176 #define DEFAULT_PROP_DURATION      GST_CLOCK_TIME_NONE
 177 
 178 enum
 179 {
 180   PROP_0,
 181   PROP_CAPS,
 182   PROP_SIZE,
 183   PROP_STREAM_TYPE,
 184   PROP_MAX_BYTES,
 185   PROP_FORMAT,
 186   PROP_BLOCK,
 187   PROP_IS_LIVE,
 188   PROP_MIN_LATENCY,
 189   PROP_MAX_LATENCY,
 190   PROP_EMIT_SIGNALS,
 191   PROP_MIN_PERCENT,
 192   PROP_CURRENT_LEVEL_BYTES,
 193   PROP_DURATION,
 194   PROP_LAST
 195 };
 196 
 197 static GstStaticPadTemplate gst_app_src_template =
 198 GST_STATIC_PAD_TEMPLATE (&quot;src&quot;,
 199     GST_PAD_SRC,
 200     GST_PAD_ALWAYS,
 201     GST_STATIC_CAPS_ANY);
 202 
 203 static void gst_app_src_uri_handler_init (gpointer g_iface,
 204     gpointer iface_data);
 205 
 206 static void gst_app_src_dispose (GObject * object);
 207 static void gst_app_src_finalize (GObject * object);
 208 
 209 static void gst_app_src_set_property (GObject * object, guint prop_id,
 210     const GValue * value, GParamSpec * pspec);
 211 static void gst_app_src_get_property (GObject * object, guint prop_id,
 212     GValue * value, GParamSpec * pspec);
 213 
 214 static gboolean gst_app_src_send_event (GstElement * element, GstEvent * event);
 215 
 216 static void gst_app_src_set_latencies (GstAppSrc * appsrc,
 217     gboolean do_min, guint64 min, gboolean do_max, guint64 max);
 218 
 219 static gboolean gst_app_src_negotiate (GstBaseSrc * basesrc);
 220 static GstCaps *gst_app_src_internal_get_caps (GstBaseSrc * bsrc,
 221     GstCaps * filter);
 222 static GstFlowReturn gst_app_src_create (GstBaseSrc * bsrc, guint64 offset,
 223     guint size, GstBuffer ** buf);
 224 static gboolean gst_app_src_start (GstBaseSrc * bsrc);
 225 static gboolean gst_app_src_stop (GstBaseSrc * bsrc);
 226 static gboolean gst_app_src_unlock (GstBaseSrc * bsrc);
 227 static gboolean gst_app_src_unlock_stop (GstBaseSrc * bsrc);
 228 static gboolean gst_app_src_do_seek (GstBaseSrc * src, GstSegment * segment);
 229 static gboolean gst_app_src_is_seekable (GstBaseSrc * src);
 230 static gboolean gst_app_src_do_get_size (GstBaseSrc * src, guint64 * size);
 231 static gboolean gst_app_src_query (GstBaseSrc * src, GstQuery * query);
 232 static gboolean gst_app_src_event (GstBaseSrc * src, GstEvent * event);
 233 
 234 static GstFlowReturn gst_app_src_push_buffer_action (GstAppSrc * appsrc,
 235     GstBuffer * buffer);
 236 static GstFlowReturn gst_app_src_push_buffer_list_action (GstAppSrc * appsrc,
 237     GstBufferList * buffer_list);
 238 static GstFlowReturn gst_app_src_push_sample_action (GstAppSrc * appsrc,
 239     GstSample * sample);
 240 
 241 static guint gst_app_src_signals[LAST_SIGNAL] = { 0 };
 242 
 243 #define gst_app_src_parent_class parent_class
 244 G_DEFINE_TYPE_WITH_CODE (GstAppSrc, gst_app_src, GST_TYPE_BASE_SRC,
<a name="1" id="anc1"></a>
 245     G_IMPLEMENT_INTERFACE (GST_TYPE_URI_HANDLER, gst_app_src_uri_handler_init));
 246 
 247 static void
 248 gst_app_src_class_init (GstAppSrcClass * klass)
 249 {
 250   GObjectClass *gobject_class = (GObjectClass *) klass;
 251   GstElementClass *element_class = (GstElementClass *) klass;
 252   GstBaseSrcClass *basesrc_class = (GstBaseSrcClass *) klass;
 253 
 254   GST_DEBUG_CATEGORY_INIT (app_src_debug, &quot;appsrc&quot;, 0, &quot;appsrc element&quot;);
 255 
 256   gobject_class-&gt;dispose = gst_app_src_dispose;
 257   gobject_class-&gt;finalize = gst_app_src_finalize;
 258 
 259   gobject_class-&gt;set_property = gst_app_src_set_property;
 260   gobject_class-&gt;get_property = gst_app_src_get_property;
 261 
 262   /**
 263    * GstAppSrc::caps:
 264    *
 265    * The GstCaps that will negotiated downstream and will be put
 266    * on outgoing buffers.
 267    */
 268   g_object_class_install_property (gobject_class, PROP_CAPS,
 269       g_param_spec_boxed (&quot;caps&quot;, &quot;Caps&quot;,
 270           &quot;The allowed caps for the src pad&quot;, GST_TYPE_CAPS,
 271           G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
 272   /**
 273    * GstAppSrc::format:
 274    *
 275    * The format to use for segment events. When the source is producing
 276    * timestamped buffers this property should be set to GST_FORMAT_TIME.
 277    */
 278   g_object_class_install_property (gobject_class, PROP_FORMAT,
 279       g_param_spec_enum (&quot;format&quot;, &quot;Format&quot;,
 280           &quot;The format of the segment events and seek&quot;, GST_TYPE_FORMAT,
 281           DEFAULT_PROP_FORMAT, G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
 282   /**
 283    * GstAppSrc::size:
 284    *
 285    * The total size in bytes of the data stream. If the total size is known, it
 286    * is recommended to configure it with this property.
 287    */
 288   g_object_class_install_property (gobject_class, PROP_SIZE,
 289       g_param_spec_int64 (&quot;size&quot;, &quot;Size&quot;,
 290           &quot;The size of the data stream in bytes (-1 if unknown)&quot;,
 291           -1, G_MAXINT64, DEFAULT_PROP_SIZE,
 292           G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
 293   /**
 294    * GstAppSrc::stream-type:
 295    *
 296    * The type of stream that this source is producing.  For seekable streams the
 297    * application should connect to the seek-data signal.
 298    */
 299   g_object_class_install_property (gobject_class, PROP_STREAM_TYPE,
 300       g_param_spec_enum (&quot;stream-type&quot;, &quot;Stream Type&quot;,
 301           &quot;the type of the stream&quot;, GST_TYPE_APP_STREAM_TYPE,
 302           DEFAULT_PROP_STREAM_TYPE,
 303           G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
 304   /**
 305    * GstAppSrc::max-bytes:
 306    *
 307    * The maximum amount of bytes that can be queued internally.
 308    * After the maximum amount of bytes are queued, appsrc will emit the
 309    * &quot;enough-data&quot; signal.
 310    */
 311   g_object_class_install_property (gobject_class, PROP_MAX_BYTES,
 312       g_param_spec_uint64 (&quot;max-bytes&quot;, &quot;Max bytes&quot;,
 313           &quot;The maximum number of bytes to queue internally (0 = unlimited)&quot;,
 314           0, G_MAXUINT64, DEFAULT_PROP_MAX_BYTES,
 315           G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
 316   /**
 317    * GstAppSrc::block:
 318    *
 319    * When max-bytes are queued and after the enough-data signal has been emitted,
 320    * block any further push-buffer calls until the amount of queued bytes drops
 321    * below the max-bytes limit.
 322    */
 323   g_object_class_install_property (gobject_class, PROP_BLOCK,
 324       g_param_spec_boolean (&quot;block&quot;, &quot;Block&quot;,
 325           &quot;Block push-buffer when max-bytes are queued&quot;,
 326           DEFAULT_PROP_BLOCK, G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
 327 
 328   /**
 329    * GstAppSrc::is-live:
 330    *
 331    * Instruct the source to behave like a live source. This includes that it
 332    * will only push out buffers in the PLAYING state.
 333    */
 334   g_object_class_install_property (gobject_class, PROP_IS_LIVE,
 335       g_param_spec_boolean (&quot;is-live&quot;, &quot;Is Live&quot;,
 336           &quot;Whether to act as a live source&quot;,
 337           DEFAULT_PROP_IS_LIVE, G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
 338   /**
 339    * GstAppSrc::min-latency:
 340    *
 341    * The minimum latency of the source. A value of -1 will use the default
 342    * latency calculations of #GstBaseSrc.
 343    */
 344   g_object_class_install_property (gobject_class, PROP_MIN_LATENCY,
 345       g_param_spec_int64 (&quot;min-latency&quot;, &quot;Min Latency&quot;,
 346           &quot;The minimum latency (-1 = default)&quot;,
 347           -1, G_MAXINT64, DEFAULT_PROP_MIN_LATENCY,
 348           G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
 349   /**
 350    * GstAppSrc::max-latency:
 351    *
 352    * The maximum latency of the source. A value of -1 means an unlimited amout
 353    * of latency.
 354    */
 355   g_object_class_install_property (gobject_class, PROP_MAX_LATENCY,
 356       g_param_spec_int64 (&quot;max-latency&quot;, &quot;Max Latency&quot;,
 357           &quot;The maximum latency (-1 = unlimited)&quot;,
 358           -1, G_MAXINT64, DEFAULT_PROP_MAX_LATENCY,
 359           G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
 360 
 361   /**
 362    * GstAppSrc::emit-signals:
 363    *
 364    * Make appsrc emit the &quot;need-data&quot;, &quot;enough-data&quot; and &quot;seek-data&quot; signals.
 365    * This option is by default enabled for backwards compatibility reasons but
 366    * can disabled when needed because signal emission is expensive.
 367    */
 368   g_object_class_install_property (gobject_class, PROP_EMIT_SIGNALS,
 369       g_param_spec_boolean (&quot;emit-signals&quot;, &quot;Emit signals&quot;,
 370           &quot;Emit need-data, enough-data and seek-data signals&quot;,
 371           DEFAULT_PROP_EMIT_SIGNALS,
 372           G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
 373 
 374   /**
<a name="2" id="anc2"></a><span class="line-modified"> 375    * GstAppSrc::empty-percent:</span>
 376    *
 377    * Make appsrc emit the &quot;need-data&quot; signal when the amount of bytes in the
 378    * queue drops below this percentage of max-bytes.
 379    */
 380   g_object_class_install_property (gobject_class, PROP_MIN_PERCENT,
 381       g_param_spec_uint (&quot;min-percent&quot;, &quot;Min Percent&quot;,
 382           &quot;Emit need-data when queued bytes drops below this percent of max-bytes&quot;,
 383           0, 100, DEFAULT_PROP_MIN_PERCENT,
 384           G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
 385 
 386   /**
 387    * GstAppSrc::current-level-bytes:
 388    *
 389    * The number of currently queued bytes inside appsrc.
 390    *
 391    * Since: 1.2
 392    */
 393   g_object_class_install_property (gobject_class, PROP_CURRENT_LEVEL_BYTES,
 394       g_param_spec_uint64 (&quot;current-level-bytes&quot;, &quot;Current Level Bytes&quot;,
 395           &quot;The number of currently queued bytes&quot;,
 396           0, G_MAXUINT64, DEFAULT_PROP_CURRENT_LEVEL_BYTES,
 397           G_PARAM_READABLE | G_PARAM_STATIC_STRINGS));
 398 
 399   /**
 400    * GstAppSrc::duration:
 401    *
 402    * The total duration in nanoseconds of the data stream. If the total duration is known, it
 403    * is recommended to configure it with this property.
 404    *
 405    * Since: 1.10
 406    */
 407   g_object_class_install_property (gobject_class, PROP_DURATION,
 408       g_param_spec_uint64 (&quot;duration&quot;, &quot;Duration&quot;,
 409           &quot;The duration of the data stream in nanoseconds (GST_CLOCK_TIME_NONE if unknown)&quot;,
 410           0, G_MAXUINT64, DEFAULT_PROP_DURATION,
 411           G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
 412 
 413   /**
 414    * GstAppSrc::need-data:
 415    * @appsrc: the appsrc element that emitted the signal
 416    * @length: the amount of bytes needed.
 417    *
 418    * Signal that the source needs more data. In the callback or from another
 419    * thread you should call push-buffer or end-of-stream.
 420    *
 421    * @length is just a hint and when it is set to -1, any number of bytes can be
 422    * pushed into @appsrc.
 423    *
 424    * You can call push-buffer multiple times until the enough-data signal is
 425    * fired.
 426    */
 427   gst_app_src_signals[SIGNAL_NEED_DATA] =
 428       g_signal_new (&quot;need-data&quot;, G_TYPE_FROM_CLASS (klass), G_SIGNAL_RUN_LAST,
 429       G_STRUCT_OFFSET (GstAppSrcClass, need_data),
 430       NULL, NULL, NULL, G_TYPE_NONE, 1, G_TYPE_UINT);
 431 
 432   /**
 433    * GstAppSrc::enough-data:
 434    * @appsrc: the appsrc element that emitted the signal
 435    *
 436    * Signal that the source has enough data. It is recommended that the
 437    * application stops calling push-buffer until the need-data signal is
 438    * emitted again to avoid excessive buffer queueing.
 439    */
 440   gst_app_src_signals[SIGNAL_ENOUGH_DATA] =
 441       g_signal_new (&quot;enough-data&quot;, G_TYPE_FROM_CLASS (klass), G_SIGNAL_RUN_LAST,
 442       G_STRUCT_OFFSET (GstAppSrcClass, enough_data),
 443       NULL, NULL, g_cclosure_marshal_VOID__VOID, G_TYPE_NONE, 0, G_TYPE_NONE);
 444 
 445   /**
 446    * GstAppSrc::seek-data:
 447    * @appsrc: the appsrc element that emitted the signal
 448    * @offset: the offset to seek to
 449    *
 450    * Seek to the given offset. The next push-buffer should produce buffers from
 451    * the new @offset.
 452    * This callback is only called for seekable stream types.
 453    *
 454    * Returns: %TRUE if the seek succeeded.
 455    */
 456   gst_app_src_signals[SIGNAL_SEEK_DATA] =
 457       g_signal_new (&quot;seek-data&quot;, G_TYPE_FROM_CLASS (klass), G_SIGNAL_RUN_LAST,
 458       G_STRUCT_OFFSET (GstAppSrcClass, seek_data),
 459       NULL, NULL, NULL, G_TYPE_BOOLEAN, 1, G_TYPE_UINT64);
 460 
 461    /**
 462     * GstAppSrc::push-buffer:
 463     * @appsrc: the appsrc
 464     * @buffer: a buffer to push
 465     *
 466     * Adds a buffer to the queue of buffers that the appsrc element will
 467     * push to its source pad. This function does not take ownership of the
 468     * buffer so the buffer needs to be unreffed after calling this function.
 469     *
 470     * When the block property is TRUE, this function can block until free space
 471     * becomes available in the queue.
 472     */
 473   gst_app_src_signals[SIGNAL_PUSH_BUFFER] =
 474       g_signal_new (&quot;push-buffer&quot;, G_TYPE_FROM_CLASS (klass),
 475       G_SIGNAL_RUN_LAST | G_SIGNAL_ACTION, G_STRUCT_OFFSET (GstAppSrcClass,
 476           push_buffer), NULL, NULL, NULL,
 477       GST_TYPE_FLOW_RETURN, 1, GST_TYPE_BUFFER);
 478 
 479    /**
 480     * GstAppSrc::push-buffer-list:
 481     * @appsrc: the appsrc
 482     * @buffer_list: a buffer list to push
 483     *
 484     * Adds a buffer list to the queue of buffers and buffer lists that the
 485     * appsrc element will push to its source pad. This function does not take
 486     * ownership of the buffer list so the buffer list needs to be unreffed
 487     * after calling this function.
 488     *
 489     * When the block property is TRUE, this function can block until free space
 490     * becomes available in the queue.
 491     *
 492     * Since: 1.14
 493     */
 494   gst_app_src_signals[SIGNAL_PUSH_BUFFER_LIST] =
 495       g_signal_new (&quot;push-buffer-list&quot;, G_TYPE_FROM_CLASS (klass),
 496       G_SIGNAL_RUN_LAST | G_SIGNAL_ACTION, G_STRUCT_OFFSET (GstAppSrcClass,
 497           push_buffer_list), NULL, NULL, NULL,
 498       GST_TYPE_FLOW_RETURN, 1, GST_TYPE_BUFFER_LIST);
 499 
 500   /**
 501     * GstAppSrc::push-sample:
 502     * @appsrc: the appsrc
 503     * @sample: a sample from which extract buffer to push
 504     *
 505     * Extract a buffer from the provided sample and adds the extracted buffer
 506     * to the queue of buffers that the appsrc element will
 507     * push to its source pad. This function set the appsrc caps based on the caps
 508     * in the sample and reset the caps if they change.
 509     * Only the caps and the buffer of the provided sample are used and not
 510     * for example the segment in the sample.
 511     * This function does not take ownership of the
 512     * sample so the sample needs to be unreffed after calling this function.
 513     *
 514     * When the block property is TRUE, this function can block until free space
 515     * becomes available in the queue.
 516     *
 517     * Since: 1.6
 518     *
 519     */
 520   gst_app_src_signals[SIGNAL_PUSH_SAMPLE] =
 521       g_signal_new (&quot;push-sample&quot;, G_TYPE_FROM_CLASS (klass),
 522       G_SIGNAL_RUN_LAST | G_SIGNAL_ACTION, G_STRUCT_OFFSET (GstAppSrcClass,
 523           push_sample), NULL, NULL, NULL,
 524       GST_TYPE_FLOW_RETURN, 1, GST_TYPE_SAMPLE);
 525 
 526 
 527    /**
 528     * GstAppSrc::end-of-stream:
 529     * @appsrc: the appsrc
 530     *
 531     * Notify @appsrc that no more buffer are available.
 532     */
 533   gst_app_src_signals[SIGNAL_END_OF_STREAM] =
 534       g_signal_new (&quot;end-of-stream&quot;, G_TYPE_FROM_CLASS (klass),
 535       G_SIGNAL_RUN_LAST | G_SIGNAL_ACTION, G_STRUCT_OFFSET (GstAppSrcClass,
 536           end_of_stream), NULL, NULL, NULL,
 537       GST_TYPE_FLOW_RETURN, 0, G_TYPE_NONE);
 538 
 539   gst_element_class_set_static_metadata (element_class, &quot;AppSrc&quot;,
 540       &quot;Generic/Source&quot;, &quot;Allow the application to feed buffers to a pipeline&quot;,
 541       &quot;David Schleef &lt;ds@schleef.org&gt;, Wim Taymans &lt;wim.taymans@gmail.com&gt;&quot;);
 542 
 543   gst_element_class_add_static_pad_template (element_class,
 544       &amp;gst_app_src_template);
 545 
 546   element_class-&gt;send_event = gst_app_src_send_event;
 547 
 548   basesrc_class-&gt;negotiate = gst_app_src_negotiate;
 549   basesrc_class-&gt;get_caps = gst_app_src_internal_get_caps;
 550   basesrc_class-&gt;create = gst_app_src_create;
 551   basesrc_class-&gt;start = gst_app_src_start;
 552   basesrc_class-&gt;stop = gst_app_src_stop;
 553   basesrc_class-&gt;unlock = gst_app_src_unlock;
 554   basesrc_class-&gt;unlock_stop = gst_app_src_unlock_stop;
 555   basesrc_class-&gt;do_seek = gst_app_src_do_seek;
 556   basesrc_class-&gt;is_seekable = gst_app_src_is_seekable;
 557   basesrc_class-&gt;get_size = gst_app_src_do_get_size;
 558   basesrc_class-&gt;query = gst_app_src_query;
 559   basesrc_class-&gt;event = gst_app_src_event;
 560 
 561   klass-&gt;push_buffer = gst_app_src_push_buffer_action;
 562   klass-&gt;push_buffer_list = gst_app_src_push_buffer_list_action;
 563   klass-&gt;push_sample = gst_app_src_push_sample_action;
 564   klass-&gt;end_of_stream = gst_app_src_end_of_stream;
<a name="3" id="anc3"></a><span class="line-removed"> 565 </span>
<span class="line-removed"> 566   g_type_class_add_private (klass, sizeof (GstAppSrcPrivate));</span>
 567 }
 568 
 569 static void
 570 gst_app_src_init (GstAppSrc * appsrc)
 571 {
 572   GstAppSrcPrivate *priv;
 573 
<a name="4" id="anc4"></a><span class="line-modified"> 574   priv = appsrc-&gt;priv = G_TYPE_INSTANCE_GET_PRIVATE (appsrc, GST_TYPE_APP_SRC,</span>
<span class="line-removed"> 575       GstAppSrcPrivate);</span>
 576 
 577   g_mutex_init (&amp;priv-&gt;mutex);
 578   g_cond_init (&amp;priv-&gt;cond);
 579   priv-&gt;queue = gst_queue_array_new (16);
 580   priv-&gt;wait_status = NOONE_WAITING;
 581 
 582   priv-&gt;size = DEFAULT_PROP_SIZE;
 583   priv-&gt;duration = DEFAULT_PROP_DURATION;
 584   priv-&gt;stream_type = DEFAULT_PROP_STREAM_TYPE;
 585   priv-&gt;max_bytes = DEFAULT_PROP_MAX_BYTES;
 586   priv-&gt;format = DEFAULT_PROP_FORMAT;
 587   priv-&gt;block = DEFAULT_PROP_BLOCK;
 588   priv-&gt;min_latency = DEFAULT_PROP_MIN_LATENCY;
 589   priv-&gt;max_latency = DEFAULT_PROP_MAX_LATENCY;
 590   priv-&gt;emit_signals = DEFAULT_PROP_EMIT_SIGNALS;
 591   priv-&gt;min_percent = DEFAULT_PROP_MIN_PERCENT;
 592 
 593   gst_base_src_set_live (GST_BASE_SRC (appsrc), DEFAULT_PROP_IS_LIVE);
 594 }
 595 
 596 /* Must be called with priv-&gt;mutex */
 597 static void
 598 gst_app_src_flush_queued (GstAppSrc * src, gboolean retain_last_caps)
 599 {
 600   GstMiniObject *obj;
 601   GstAppSrcPrivate *priv = src-&gt;priv;
 602   GstCaps *requeue_caps = NULL;
 603 
 604   while (!gst_queue_array_is_empty (priv-&gt;queue)) {
 605     obj = gst_queue_array_pop_head (priv-&gt;queue);
 606     if (obj) {
 607       if (GST_IS_CAPS (obj) &amp;&amp; retain_last_caps) {
 608         gst_caps_replace (&amp;requeue_caps, GST_CAPS_CAST (obj));
 609       }
 610       gst_mini_object_unref (obj);
 611     }
 612   }
 613 
 614   if (requeue_caps) {
 615     gst_queue_array_push_tail (priv-&gt;queue, requeue_caps);
 616   }
 617 
 618   priv-&gt;queued_bytes = 0;
 619 }
 620 
 621 static void
 622 gst_app_src_dispose (GObject * obj)
 623 {
 624   GstAppSrc *appsrc = GST_APP_SRC_CAST (obj);
 625   GstAppSrcPrivate *priv = appsrc-&gt;priv;
 626 
 627   GST_OBJECT_LOCK (appsrc);
 628   if (priv-&gt;current_caps) {
 629     gst_caps_unref (priv-&gt;current_caps);
 630     priv-&gt;current_caps = NULL;
 631   }
 632   if (priv-&gt;last_caps) {
 633     gst_caps_unref (priv-&gt;last_caps);
 634     priv-&gt;last_caps = NULL;
 635   }
 636   if (priv-&gt;notify) {
 637     priv-&gt;notify (priv-&gt;user_data);
 638   }
 639   priv-&gt;user_data = NULL;
 640   priv-&gt;notify = NULL;
 641 
 642   GST_OBJECT_UNLOCK (appsrc);
 643 
 644   g_mutex_lock (&amp;priv-&gt;mutex);
 645   gst_app_src_flush_queued (appsrc, FALSE);
 646   g_mutex_unlock (&amp;priv-&gt;mutex);
 647 
 648   G_OBJECT_CLASS (parent_class)-&gt;dispose (obj);
 649 }
 650 
 651 static void
 652 gst_app_src_finalize (GObject * obj)
 653 {
 654   GstAppSrc *appsrc = GST_APP_SRC_CAST (obj);
 655   GstAppSrcPrivate *priv = appsrc-&gt;priv;
 656 
 657   g_mutex_clear (&amp;priv-&gt;mutex);
 658   g_cond_clear (&amp;priv-&gt;cond);
 659   gst_queue_array_free (priv-&gt;queue);
 660 
 661   g_free (priv-&gt;uri);
 662 
 663   G_OBJECT_CLASS (parent_class)-&gt;finalize (obj);
 664 }
 665 
 666 static GstCaps *
 667 gst_app_src_internal_get_caps (GstBaseSrc * bsrc, GstCaps * filter)
 668 {
 669   GstAppSrc *appsrc = GST_APP_SRC (bsrc);
 670   GstCaps *caps;
 671 
 672   GST_OBJECT_LOCK (appsrc);
 673   if ((caps = appsrc-&gt;priv-&gt;current_caps))
 674     gst_caps_ref (caps);
 675   GST_OBJECT_UNLOCK (appsrc);
 676 
 677   if (filter) {
 678     if (caps) {
 679       GstCaps *intersection =
 680           gst_caps_intersect_full (filter, caps, GST_CAPS_INTERSECT_FIRST);
 681       gst_caps_unref (caps);
 682       caps = intersection;
 683     } else {
 684       caps = gst_caps_ref (filter);
 685     }
 686   }
 687 
 688   GST_DEBUG_OBJECT (appsrc, &quot;caps: %&quot; GST_PTR_FORMAT, caps);
 689   return caps;
 690 }
 691 
 692 static void
 693 gst_app_src_set_property (GObject * object, guint prop_id,
 694     const GValue * value, GParamSpec * pspec)
 695 {
 696   GstAppSrc *appsrc = GST_APP_SRC_CAST (object);
 697   GstAppSrcPrivate *priv = appsrc-&gt;priv;
 698 
 699   switch (prop_id) {
 700     case PROP_CAPS:
 701       gst_app_src_set_caps (appsrc, gst_value_get_caps (value));
 702       break;
 703     case PROP_SIZE:
 704       gst_app_src_set_size (appsrc, g_value_get_int64 (value));
 705       break;
 706     case PROP_STREAM_TYPE:
 707       gst_app_src_set_stream_type (appsrc, g_value_get_enum (value));
 708       break;
 709     case PROP_MAX_BYTES:
 710       gst_app_src_set_max_bytes (appsrc, g_value_get_uint64 (value));
 711       break;
 712     case PROP_FORMAT:
 713       priv-&gt;format = g_value_get_enum (value);
 714       break;
 715     case PROP_BLOCK:
 716       priv-&gt;block = g_value_get_boolean (value);
 717       break;
 718     case PROP_IS_LIVE:
 719       gst_base_src_set_live (GST_BASE_SRC (appsrc),
 720           g_value_get_boolean (value));
 721       break;
 722     case PROP_MIN_LATENCY:
 723       gst_app_src_set_latencies (appsrc, TRUE, g_value_get_int64 (value),
 724           FALSE, -1);
 725       break;
 726     case PROP_MAX_LATENCY:
 727       gst_app_src_set_latencies (appsrc, FALSE, -1, TRUE,
 728           g_value_get_int64 (value));
 729       break;
 730     case PROP_EMIT_SIGNALS:
 731       gst_app_src_set_emit_signals (appsrc, g_value_get_boolean (value));
 732       break;
 733     case PROP_MIN_PERCENT:
 734       priv-&gt;min_percent = g_value_get_uint (value);
 735       break;
 736     case PROP_DURATION:
 737       gst_app_src_set_duration (appsrc, g_value_get_uint64 (value));
 738       break;
 739     default:
 740       G_OBJECT_WARN_INVALID_PROPERTY_ID (object, prop_id, pspec);
 741       break;
 742   }
 743 }
 744 
 745 static void
 746 gst_app_src_get_property (GObject * object, guint prop_id, GValue * value,
 747     GParamSpec * pspec)
 748 {
 749   GstAppSrc *appsrc = GST_APP_SRC_CAST (object);
 750   GstAppSrcPrivate *priv = appsrc-&gt;priv;
 751 
 752   switch (prop_id) {
 753     case PROP_CAPS:
 754       g_value_take_boxed (value, gst_app_src_get_caps (appsrc));
 755       break;
 756     case PROP_SIZE:
 757       g_value_set_int64 (value, gst_app_src_get_size (appsrc));
 758       break;
 759     case PROP_STREAM_TYPE:
 760       g_value_set_enum (value, gst_app_src_get_stream_type (appsrc));
 761       break;
 762     case PROP_MAX_BYTES:
 763       g_value_set_uint64 (value, gst_app_src_get_max_bytes (appsrc));
 764       break;
 765     case PROP_FORMAT:
 766       g_value_set_enum (value, priv-&gt;format);
 767       break;
 768     case PROP_BLOCK:
 769       g_value_set_boolean (value, priv-&gt;block);
 770       break;
 771     case PROP_IS_LIVE:
 772       g_value_set_boolean (value, gst_base_src_is_live (GST_BASE_SRC (appsrc)));
 773       break;
 774     case PROP_MIN_LATENCY:
 775     {
 776       guint64 min = 0;
 777 
 778       gst_app_src_get_latency (appsrc, &amp;min, NULL);
 779       g_value_set_int64 (value, min);
 780       break;
 781     }
 782     case PROP_MAX_LATENCY:
 783     {
 784       guint64 max = 0;
 785 
 786       gst_app_src_get_latency (appsrc, NULL, &amp;max);
 787       g_value_set_int64 (value, max);
 788       break;
 789     }
 790     case PROP_EMIT_SIGNALS:
 791       g_value_set_boolean (value, gst_app_src_get_emit_signals (appsrc));
 792       break;
 793     case PROP_MIN_PERCENT:
 794       g_value_set_uint (value, priv-&gt;min_percent);
 795       break;
 796     case PROP_CURRENT_LEVEL_BYTES:
 797       g_value_set_uint64 (value, gst_app_src_get_current_level_bytes (appsrc));
 798       break;
 799     case PROP_DURATION:
 800       g_value_set_uint64 (value, gst_app_src_get_duration (appsrc));
 801       break;
 802     default:
 803       G_OBJECT_WARN_INVALID_PROPERTY_ID (object, prop_id, pspec);
 804       break;
 805   }
 806 }
 807 
 808 static gboolean
 809 gst_app_src_send_event (GstElement * element, GstEvent * event)
 810 {
 811   GstAppSrc *appsrc = GST_APP_SRC_CAST (element);
 812   GstAppSrcPrivate *priv = appsrc-&gt;priv;
 813 
 814   switch (GST_EVENT_TYPE (event)) {
 815     case GST_EVENT_FLUSH_STOP:
 816       g_mutex_lock (&amp;priv-&gt;mutex);
 817       gst_app_src_flush_queued (appsrc, TRUE);
 818       g_mutex_unlock (&amp;priv-&gt;mutex);
 819       break;
 820     default:
 821       break;
 822   }
 823 
 824   return GST_CALL_PARENT_WITH_DEFAULT (GST_ELEMENT_CLASS, send_event, (element,
 825           event), FALSE);
 826 }
 827 
 828 static gboolean
 829 gst_app_src_unlock (GstBaseSrc * bsrc)
 830 {
 831   GstAppSrc *appsrc = GST_APP_SRC_CAST (bsrc);
 832   GstAppSrcPrivate *priv = appsrc-&gt;priv;
 833 
 834   g_mutex_lock (&amp;priv-&gt;mutex);
 835   GST_DEBUG_OBJECT (appsrc, &quot;unlock start&quot;);
 836   priv-&gt;flushing = TRUE;
 837   g_cond_broadcast (&amp;priv-&gt;cond);
 838   g_mutex_unlock (&amp;priv-&gt;mutex);
 839 
 840   return TRUE;
 841 }
 842 
 843 static gboolean
 844 gst_app_src_unlock_stop (GstBaseSrc * bsrc)
 845 {
 846   GstAppSrc *appsrc = GST_APP_SRC_CAST (bsrc);
 847   GstAppSrcPrivate *priv = appsrc-&gt;priv;
 848 
 849   g_mutex_lock (&amp;priv-&gt;mutex);
 850   GST_DEBUG_OBJECT (appsrc, &quot;unlock stop&quot;);
 851   priv-&gt;flushing = FALSE;
 852   g_cond_broadcast (&amp;priv-&gt;cond);
 853   g_mutex_unlock (&amp;priv-&gt;mutex);
 854 
 855   return TRUE;
 856 }
 857 
 858 static gboolean
 859 gst_app_src_start (GstBaseSrc * bsrc)
 860 {
 861   GstAppSrc *appsrc = GST_APP_SRC_CAST (bsrc);
 862   GstAppSrcPrivate *priv = appsrc-&gt;priv;
 863 
 864   g_mutex_lock (&amp;priv-&gt;mutex);
 865   GST_DEBUG_OBJECT (appsrc, &quot;starting&quot;);
 866   priv-&gt;started = TRUE;
 867   /* set the offset to -1 so that we always do a first seek. This is only used
 868    * in random-access mode. */
 869   priv-&gt;offset = -1;
 870   priv-&gt;flushing = FALSE;
 871   g_mutex_unlock (&amp;priv-&gt;mutex);
 872 
 873   gst_base_src_set_format (bsrc, priv-&gt;format);
 874 
 875   return TRUE;
 876 }
 877 
 878 static gboolean
 879 gst_app_src_stop (GstBaseSrc * bsrc)
 880 {
 881   GstAppSrc *appsrc = GST_APP_SRC_CAST (bsrc);
 882   GstAppSrcPrivate *priv = appsrc-&gt;priv;
 883 
 884   g_mutex_lock (&amp;priv-&gt;mutex);
 885   GST_DEBUG_OBJECT (appsrc, &quot;stopping&quot;);
 886   priv-&gt;is_eos = FALSE;
 887   priv-&gt;flushing = TRUE;
 888   priv-&gt;started = FALSE;
 889   gst_app_src_flush_queued (appsrc, TRUE);
 890   g_cond_broadcast (&amp;priv-&gt;cond);
 891   g_mutex_unlock (&amp;priv-&gt;mutex);
 892 
 893   return TRUE;
 894 }
 895 
 896 static gboolean
 897 gst_app_src_is_seekable (GstBaseSrc * src)
 898 {
 899   GstAppSrc *appsrc = GST_APP_SRC_CAST (src);
 900   GstAppSrcPrivate *priv = appsrc-&gt;priv;
 901   gboolean res = FALSE;
 902 
 903   switch (priv-&gt;stream_type) {
 904     case GST_APP_STREAM_TYPE_STREAM:
 905       break;
 906     case GST_APP_STREAM_TYPE_SEEKABLE:
 907     case GST_APP_STREAM_TYPE_RANDOM_ACCESS:
 908       res = TRUE;
 909       break;
 910   }
 911   return res;
 912 }
 913 
 914 static gboolean
 915 gst_app_src_do_get_size (GstBaseSrc * src, guint64 * size)
 916 {
 917   GstAppSrc *appsrc = GST_APP_SRC_CAST (src);
 918 
 919   *size = gst_app_src_get_size (appsrc);
 920 
 921   return TRUE;
 922 }
 923 
 924 static gboolean
 925 gst_app_src_query (GstBaseSrc * src, GstQuery * query)
 926 {
 927   GstAppSrc *appsrc = GST_APP_SRC_CAST (src);
 928   GstAppSrcPrivate *priv = appsrc-&gt;priv;
 929   gboolean res;
 930 
 931   switch (GST_QUERY_TYPE (query)) {
 932     case GST_QUERY_LATENCY:
 933     {
 934       GstClockTime min, max;
 935       gboolean live;
 936 
 937       /* Query the parent class for the defaults */
 938       res = gst_base_src_query_latency (src, &amp;live, &amp;min, &amp;max);
 939 
 940       /* overwrite with our values when we need to */
 941       g_mutex_lock (&amp;priv-&gt;mutex);
 942       if (priv-&gt;min_latency != -1) {
 943         min = priv-&gt;min_latency;
 944         max = priv-&gt;max_latency;
 945       }
 946       g_mutex_unlock (&amp;priv-&gt;mutex);
 947 
 948       gst_query_set_latency (query, live, min, max);
 949       break;
 950     }
 951     case GST_QUERY_SCHEDULING:
 952     {
 953       gst_query_set_scheduling (query, GST_SCHEDULING_FLAG_SEEKABLE, 1, -1, 0);
 954       gst_query_add_scheduling_mode (query, GST_PAD_MODE_PUSH);
 955 
 956       switch (priv-&gt;stream_type) {
 957         case GST_APP_STREAM_TYPE_STREAM:
 958         case GST_APP_STREAM_TYPE_SEEKABLE:
 959           break;
 960         case GST_APP_STREAM_TYPE_RANDOM_ACCESS:
 961           gst_query_add_scheduling_mode (query, GST_PAD_MODE_PULL);
 962           break;
 963       }
 964       res = TRUE;
 965       break;
 966     }
 967     case GST_QUERY_DURATION:
 968     {
 969       GstFormat format;
 970       gst_query_parse_duration (query, &amp;format, NULL);
 971       if (format == GST_FORMAT_BYTES) {
 972         gst_query_set_duration (query, format, priv-&gt;size);
 973         res = TRUE;
 974       } else if (format == GST_FORMAT_TIME) {
 975         if (priv-&gt;duration != GST_CLOCK_TIME_NONE) {
 976           gst_query_set_duration (query, format, priv-&gt;duration);
 977           res = TRUE;
 978         } else {
 979           res = FALSE;
 980         }
 981       } else {
 982         res = FALSE;
 983       }
 984       break;
 985     }
 986     default:
 987       res = GST_BASE_SRC_CLASS (parent_class)-&gt;query (src, query);
 988       break;
 989   }
 990 
 991   return res;
 992 }
 993 
 994 /* will be called in push mode */
 995 static gboolean
 996 gst_app_src_do_seek (GstBaseSrc * src, GstSegment * segment)
 997 {
 998   GstAppSrc *appsrc = GST_APP_SRC_CAST (src);
 999   GstAppSrcPrivate *priv = appsrc-&gt;priv;
1000   gint64 desired_position;
1001   gboolean res = FALSE;
1002 
1003   desired_position = segment-&gt;position;
1004 
1005   /* no need to try to seek in streaming mode */
1006   if (priv-&gt;stream_type == GST_APP_STREAM_TYPE_STREAM)
1007     return TRUE;
1008 
1009   GST_DEBUG_OBJECT (appsrc, &quot;seeking to %&quot; G_GINT64_FORMAT &quot;, format %s&quot;,
1010       desired_position, gst_format_get_name (segment-&gt;format));
1011 
1012   if (priv-&gt;callbacks.seek_data)
1013     res = priv-&gt;callbacks.seek_data (appsrc, desired_position, priv-&gt;user_data);
1014   else {
1015     gboolean emit;
1016 
1017     g_mutex_lock (&amp;priv-&gt;mutex);
1018     emit = priv-&gt;emit_signals;
1019     g_mutex_unlock (&amp;priv-&gt;mutex);
1020 
1021     if (emit)
1022       g_signal_emit (appsrc, gst_app_src_signals[SIGNAL_SEEK_DATA], 0,
1023           desired_position, &amp;res);
1024   }
1025 
1026   if (res) {
1027     GST_DEBUG_OBJECT (appsrc, &quot;flushing queue&quot;);
1028     g_mutex_lock (&amp;priv-&gt;mutex);
1029     gst_app_src_flush_queued (appsrc, TRUE);
1030     g_mutex_unlock (&amp;priv-&gt;mutex);
1031     priv-&gt;is_eos = FALSE;
1032   } else {
1033     GST_WARNING_OBJECT (appsrc, &quot;seek failed&quot;);
1034   }
1035 
1036   return res;
1037 }
1038 
1039 /* must be called with the appsrc mutex */
1040 static gboolean
1041 gst_app_src_emit_seek (GstAppSrc * appsrc, guint64 offset)
1042 {
1043   gboolean res = FALSE;
1044   gboolean emit;
1045   GstAppSrcPrivate *priv = appsrc-&gt;priv;
1046 
1047   emit = priv-&gt;emit_signals;
1048   g_mutex_unlock (&amp;priv-&gt;mutex);
1049 
1050   GST_DEBUG_OBJECT (appsrc,
1051       &quot;we are at %&quot; G_GINT64_FORMAT &quot;, seek to %&quot; G_GINT64_FORMAT,
1052       priv-&gt;offset, offset);
1053 
1054   if (priv-&gt;callbacks.seek_data)
1055     res = priv-&gt;callbacks.seek_data (appsrc, offset, priv-&gt;user_data);
1056   else if (emit)
1057     g_signal_emit (appsrc, gst_app_src_signals[SIGNAL_SEEK_DATA], 0,
1058         offset, &amp;res);
1059 
1060   g_mutex_lock (&amp;priv-&gt;mutex);
1061 
1062   return res;
1063 }
1064 
1065 /* must be called with the appsrc mutex. After this call things can be
1066  * flushing */
1067 static void
1068 gst_app_src_emit_need_data (GstAppSrc * appsrc, guint size)
1069 {
1070   gboolean emit;
1071   GstAppSrcPrivate *priv = appsrc-&gt;priv;
1072 
1073   emit = priv-&gt;emit_signals;
1074   g_mutex_unlock (&amp;priv-&gt;mutex);
1075 
1076   /* we have no data, we need some. We fire the signal with the size hint. */
1077   if (priv-&gt;callbacks.need_data)
1078     priv-&gt;callbacks.need_data (appsrc, size, priv-&gt;user_data);
1079   else if (emit)
1080     g_signal_emit (appsrc, gst_app_src_signals[SIGNAL_NEED_DATA], 0, size,
1081         NULL);
1082 
1083   g_mutex_lock (&amp;priv-&gt;mutex);
1084   /* we can be flushing now because we released the lock */
1085 }
1086 
1087 /* must be called with the appsrc mutex */
1088 static gboolean
1089 gst_app_src_do_negotiate (GstBaseSrc * basesrc)
1090 {
1091   GstAppSrc *appsrc = GST_APP_SRC_CAST (basesrc);
1092   GstAppSrcPrivate *priv = appsrc-&gt;priv;
1093   gboolean result;
1094   GstCaps *caps;
1095 
1096   GST_OBJECT_LOCK (basesrc);
1097   caps = priv-&gt;current_caps ? gst_caps_ref (priv-&gt;current_caps) : NULL;
1098   GST_OBJECT_UNLOCK (basesrc);
1099 
1100   /* Avoid deadlock by unlocking mutex
1101    * otherwise we get deadlock between this and stream lock */
1102   g_mutex_unlock (&amp;priv-&gt;mutex);
1103   if (caps) {
1104     result = gst_base_src_set_caps (basesrc, caps);
1105     gst_caps_unref (caps);
1106   } else {
1107     result = GST_BASE_SRC_CLASS (parent_class)-&gt;negotiate (basesrc);
1108   }
1109   g_mutex_lock (&amp;priv-&gt;mutex);
1110 
1111   return result;
1112 }
1113 
1114 static gboolean
1115 gst_app_src_negotiate (GstBaseSrc * basesrc)
1116 {
1117   GstAppSrc *appsrc = GST_APP_SRC_CAST (basesrc);
1118   GstAppSrcPrivate *priv = appsrc-&gt;priv;
1119   gboolean result;
1120 
1121   g_mutex_lock (&amp;priv-&gt;mutex);
1122   result = gst_app_src_do_negotiate (basesrc);
1123   g_mutex_unlock (&amp;priv-&gt;mutex);
1124   return result;
1125 }
1126 
1127 static GstFlowReturn
1128 gst_app_src_create (GstBaseSrc * bsrc, guint64 offset, guint size,
1129     GstBuffer ** buf)
1130 {
1131   GstAppSrc *appsrc = GST_APP_SRC_CAST (bsrc);
1132   GstAppSrcPrivate *priv = appsrc-&gt;priv;
1133   GstFlowReturn ret;
1134 
1135   GST_OBJECT_LOCK (appsrc);
1136   if (G_UNLIKELY (priv-&gt;size != bsrc-&gt;segment.duration &amp;&amp;
1137           bsrc-&gt;segment.format == GST_FORMAT_BYTES)) {
1138     GST_DEBUG_OBJECT (appsrc,
1139         &quot;Size changed from %&quot; G_GINT64_FORMAT &quot; to %&quot; G_GINT64_FORMAT,
1140         bsrc-&gt;segment.duration, priv-&gt;size);
1141     bsrc-&gt;segment.duration = priv-&gt;size;
1142     GST_OBJECT_UNLOCK (appsrc);
1143 
1144     gst_element_post_message (GST_ELEMENT (appsrc),
1145         gst_message_new_duration_changed (GST_OBJECT (appsrc)));
1146   } else if (G_UNLIKELY (priv-&gt;duration != bsrc-&gt;segment.duration &amp;&amp;
1147           bsrc-&gt;segment.format == GST_FORMAT_TIME)) {
1148     GST_DEBUG_OBJECT (appsrc,
1149         &quot;Duration changed from %&quot; GST_TIME_FORMAT &quot; to %&quot; GST_TIME_FORMAT,
1150         GST_TIME_ARGS (bsrc-&gt;segment.duration), GST_TIME_ARGS (priv-&gt;duration));
1151     bsrc-&gt;segment.duration = priv-&gt;duration;
1152     GST_OBJECT_UNLOCK (appsrc);
1153 
1154     gst_element_post_message (GST_ELEMENT (appsrc),
1155         gst_message_new_duration_changed (GST_OBJECT (appsrc)));
1156   } else {
1157     GST_OBJECT_UNLOCK (appsrc);
1158   }
1159 
1160   g_mutex_lock (&amp;priv-&gt;mutex);
1161   /* check flushing first */
1162   if (G_UNLIKELY (priv-&gt;flushing))
1163     goto flushing;
1164 
1165   if (priv-&gt;stream_type == GST_APP_STREAM_TYPE_RANDOM_ACCESS) {
1166     /* if we are dealing with a random-access stream, issue a seek if the offset
1167      * changed. */
1168     if (G_UNLIKELY (priv-&gt;offset != offset)) {
1169       gboolean res;
1170 
1171       /* do the seek */
1172       res = gst_app_src_emit_seek (appsrc, offset);
1173 
1174       if (G_UNLIKELY (!res))
1175         /* failing to seek is fatal */
1176         goto seek_error;
1177 
1178       priv-&gt;offset = offset;
1179       priv-&gt;is_eos = FALSE;
1180     }
1181   }
1182 
1183   while (TRUE) {
1184     /* return data as long as we have some */
1185     if (!gst_queue_array_is_empty (priv-&gt;queue)) {
1186       guint buf_size;
1187       GstMiniObject *obj = gst_queue_array_pop_head (priv-&gt;queue);
1188 
1189       if (GST_IS_CAPS (obj)) {
1190         GstCaps *next_caps = GST_CAPS (obj);
1191         gboolean caps_changed = TRUE;
1192 
1193         if (next_caps &amp;&amp; priv-&gt;current_caps)
1194           caps_changed = !gst_caps_is_equal (next_caps, priv-&gt;current_caps);
1195         else
1196           caps_changed = (next_caps != priv-&gt;current_caps);
1197 
1198         gst_caps_replace (&amp;priv-&gt;current_caps, next_caps);
1199 
1200         if (next_caps) {
1201           gst_caps_unref (next_caps);
1202         }
1203 
1204         if (caps_changed)
<a name="5" id="anc5"></a><span class="line-modified">1205         gst_app_src_do_negotiate (bsrc);</span>
1206 
1207         /* Lock has released so now may need
1208          *- flushing
1209          *- new caps change
1210          *- check queue has data */
1211         if (G_UNLIKELY (priv-&gt;flushing))
1212           goto flushing;
1213 
1214         /* Continue checks caps and queue */
1215         continue;
1216       }
1217 
1218       if (GST_IS_BUFFER (obj)) {
1219         *buf = GST_BUFFER (obj);
<a name="6" id="anc6"></a><span class="line-modified">1220       buf_size = gst_buffer_get_size (*buf);</span>
1221         GST_LOG_OBJECT (appsrc, &quot;have buffer %p of size %u&quot;, *buf, buf_size);
1222       } else {
1223         GstBufferList *buffer_list;
1224 
1225         g_assert (GST_IS_BUFFER_LIST (obj));
1226 
1227         buffer_list = GST_BUFFER_LIST (obj);
1228 
1229         buf_size = gst_buffer_list_calculate_size (buffer_list);
1230 
1231         GST_LOG_OBJECT (appsrc, &quot;have buffer list %p of size %u, %u buffers&quot;,
1232             buffer_list, buf_size, gst_buffer_list_length (buffer_list));
1233 
1234         gst_base_src_submit_buffer_list (bsrc, buffer_list);
1235         *buf = NULL;
1236       }
1237 
1238       priv-&gt;queued_bytes -= buf_size;
1239 
1240       /* only update the offset when in random_access mode */
1241       if (priv-&gt;stream_type == GST_APP_STREAM_TYPE_RANDOM_ACCESS)
1242         priv-&gt;offset += buf_size;
1243 
1244       /* signal that we removed an item */
1245       if ((priv-&gt;wait_status &amp; APP_WAITING))
<a name="7" id="anc7"></a><span class="line-modified">1246       g_cond_broadcast (&amp;priv-&gt;cond);</span>
1247 
<a name="8" id="anc8"></a><span class="line-modified">1248       /* see if we go lower than the empty-percent */</span>
1249       if (priv-&gt;min_percent &amp;&amp; priv-&gt;max_bytes) {
1250         if (priv-&gt;queued_bytes * 100 / priv-&gt;max_bytes &lt;= priv-&gt;min_percent)
1251           /* ignore flushing state, we got a buffer and we will return it now.
1252            * Errors will be handled in the next round */
1253           gst_app_src_emit_need_data (appsrc, size);
1254       }
1255       ret = GST_FLOW_OK;
1256       break;
1257     } else {
1258       gst_app_src_emit_need_data (appsrc, size);
1259 
1260       /* we can be flushing now because we released the lock above */
1261       if (G_UNLIKELY (priv-&gt;flushing))
1262         goto flushing;
1263 
1264       /* if we have a buffer now, continue the loop and try to return it. In
1265        * random-access mode (where a buffer is normally pushed in the above
1266        * signal) we can still be empty because the pushed buffer got flushed or
1267        * when the application pushes the requested buffer later, we support both
1268        * possibilities. */
1269       if (!gst_queue_array_is_empty (priv-&gt;queue))
1270         continue;
1271 
1272       /* no buffer yet, maybe we are EOS, if not, block for more data. */
1273     }
1274 
1275     /* check EOS */
1276     if (G_UNLIKELY (priv-&gt;is_eos))
1277       goto eos;
1278 
1279     /* nothing to return, wait a while for new data or flushing. */
1280     priv-&gt;wait_status |= STREAM_WAITING;
1281     g_cond_wait (&amp;priv-&gt;cond, &amp;priv-&gt;mutex);
1282     priv-&gt;wait_status &amp;= ~STREAM_WAITING;
1283   }
1284   g_mutex_unlock (&amp;priv-&gt;mutex);
1285   return ret;
1286 
1287   /* ERRORS */
1288 flushing:
1289   {
1290     GST_DEBUG_OBJECT (appsrc, &quot;we are flushing&quot;);
1291     g_mutex_unlock (&amp;priv-&gt;mutex);
1292     return GST_FLOW_FLUSHING;
1293   }
1294 eos:
1295   {
1296     GST_DEBUG_OBJECT (appsrc, &quot;we are EOS&quot;);
1297     g_mutex_unlock (&amp;priv-&gt;mutex);
1298     return GST_FLOW_EOS;
1299   }
1300 seek_error:
1301   {
1302     g_mutex_unlock (&amp;priv-&gt;mutex);
1303     GST_ELEMENT_ERROR (appsrc, RESOURCE, READ, (&quot;failed to seek&quot;),
1304         GST_ERROR_SYSTEM);
1305     return GST_FLOW_ERROR;
1306   }
1307 }
1308 
1309 /* external API */
1310 
1311 /**
1312  * gst_app_src_set_caps:
1313  * @appsrc: a #GstAppSrc
1314  * @caps: caps to set
1315  *
1316  * Set the capabilities on the appsrc element.  This function takes
1317  * a copy of the caps structure. After calling this method, the source will
1318  * only produce caps that match @caps. @caps must be fixed and the caps on the
1319  * buffers must match the caps or left NULL.
1320  */
1321 void
1322 gst_app_src_set_caps (GstAppSrc * appsrc, const GstCaps * caps)
1323 {
1324   GstAppSrcPrivate *priv;
1325   gboolean caps_changed;
1326 
1327   g_return_if_fail (GST_IS_APP_SRC (appsrc));
1328 
1329   priv = appsrc-&gt;priv;
1330 
1331   g_mutex_lock (&amp;priv-&gt;mutex);
1332 
1333   GST_OBJECT_LOCK (appsrc);
1334   if (caps &amp;&amp; priv-&gt;last_caps)
1335     caps_changed = !gst_caps_is_equal (caps, priv-&gt;last_caps);
1336   else
1337     caps_changed = (caps != priv-&gt;last_caps);
1338 
1339   if (caps_changed) {
1340     GstCaps *new_caps;
1341     gpointer t;
1342 
1343     new_caps = caps ? gst_caps_copy (caps) : NULL;
<a name="9" id="anc9"></a><span class="line-modified">1344   GST_DEBUG_OBJECT (appsrc, &quot;setting caps to %&quot; GST_PTR_FORMAT, caps);</span>
1345 
1346     while ((t = gst_queue_array_peek_tail (priv-&gt;queue)) &amp;&amp; GST_IS_CAPS (t)) {
1347       gst_caps_unref (gst_queue_array_pop_tail (priv-&gt;queue));
<a name="10" id="anc10"></a><span class="line-modified">1348   }</span>
1349     gst_queue_array_push_tail (priv-&gt;queue, new_caps);
1350     gst_caps_replace (&amp;priv-&gt;last_caps, new_caps);
1351   }
1352 
1353   GST_OBJECT_UNLOCK (appsrc);
1354 
1355   g_mutex_unlock (&amp;priv-&gt;mutex);
1356 }
1357 
1358 /**
1359  * gst_app_src_get_caps:
1360  * @appsrc: a #GstAppSrc
1361  *
1362  * Get the configured caps on @appsrc.
1363  *
1364  * Returns: the #GstCaps produced by the source. gst_caps_unref() after usage.
1365  */
1366 GstCaps *
1367 gst_app_src_get_caps (GstAppSrc * appsrc)
1368 {
1369 
1370   GstCaps *caps;
1371 
1372   g_return_val_if_fail (GST_IS_APP_SRC (appsrc), NULL);
1373 
1374   GST_OBJECT_LOCK (appsrc);
1375   if ((caps = appsrc-&gt;priv-&gt;last_caps))
1376     gst_caps_ref (caps);
1377   GST_OBJECT_UNLOCK (appsrc);
1378 
1379   return caps;
1380 
1381 }
1382 
1383 /**
1384  * gst_app_src_set_size:
1385  * @appsrc: a #GstAppSrc
1386  * @size: the size to set
1387  *
1388  * Set the size of the stream in bytes. A value of -1 means that the size is
1389  * not known.
1390  */
1391 void
1392 gst_app_src_set_size (GstAppSrc * appsrc, gint64 size)
1393 {
1394   GstAppSrcPrivate *priv;
1395 
1396   g_return_if_fail (GST_IS_APP_SRC (appsrc));
1397 
1398   priv = appsrc-&gt;priv;
1399 
1400   GST_OBJECT_LOCK (appsrc);
1401   GST_DEBUG_OBJECT (appsrc, &quot;setting size of %&quot; G_GINT64_FORMAT, size);
1402   priv-&gt;size = size;
1403   GST_OBJECT_UNLOCK (appsrc);
1404 }
1405 
1406 /**
1407  * gst_app_src_get_size:
1408  * @appsrc: a #GstAppSrc
1409  *
1410  * Get the size of the stream in bytes. A value of -1 means that the size is
1411  * not known.
1412  *
1413  * Returns: the size of the stream previously set with gst_app_src_set_size();
1414  */
1415 gint64
1416 gst_app_src_get_size (GstAppSrc * appsrc)
1417 {
1418   gint64 size;
1419   GstAppSrcPrivate *priv;
1420 
1421   g_return_val_if_fail (GST_IS_APP_SRC (appsrc), -1);
1422 
1423   priv = appsrc-&gt;priv;
1424 
1425   GST_OBJECT_LOCK (appsrc);
1426   size = priv-&gt;size;
1427   GST_DEBUG_OBJECT (appsrc, &quot;getting size of %&quot; G_GINT64_FORMAT, size);
1428   GST_OBJECT_UNLOCK (appsrc);
1429 
1430   return size;
1431 }
1432 
1433 /**
1434  * gst_app_src_set_duration:
1435  * @appsrc: a #GstAppSrc
1436  * @duration: the duration to set
1437  *
1438  * Set the duration of the stream in nanoseconds. A value of GST_CLOCK_TIME_NONE means that the duration is
1439  * not known.
1440  *
1441  * Since: 1.10
1442  */
1443 void
1444 gst_app_src_set_duration (GstAppSrc * appsrc, GstClockTime duration)
1445 {
1446   GstAppSrcPrivate *priv;
1447 
1448   g_return_if_fail (GST_IS_APP_SRC (appsrc));
1449 
1450   priv = appsrc-&gt;priv;
1451 
1452   GST_OBJECT_LOCK (appsrc);
1453   GST_DEBUG_OBJECT (appsrc, &quot;setting duration of %&quot; GST_TIME_FORMAT,
1454       GST_TIME_ARGS (duration));
1455   priv-&gt;duration = duration;
1456   GST_OBJECT_UNLOCK (appsrc);
1457 }
1458 
1459 /**
1460  * gst_app_src_get_duration:
1461  * @appsrc: a #GstAppSrc
1462  *
1463  * Get the duration of the stream in nanoseconds. A value of GST_CLOCK_TIME_NONE means that the duration is
1464  * not known.
1465  *
1466  * Returns: the duration of the stream previously set with gst_app_src_set_duration();
1467  *
1468  * Since: 1.10
1469  */
1470 GstClockTime
1471 gst_app_src_get_duration (GstAppSrc * appsrc)
1472 {
1473   GstClockTime duration;
1474   GstAppSrcPrivate *priv;
1475 
1476   g_return_val_if_fail (GST_IS_APP_SRC (appsrc), GST_CLOCK_TIME_NONE);
1477 
1478   priv = appsrc-&gt;priv;
1479 
1480   GST_OBJECT_LOCK (appsrc);
1481   duration = priv-&gt;duration;
1482   GST_DEBUG_OBJECT (appsrc, &quot;getting duration of %&quot; GST_TIME_FORMAT,
1483       GST_TIME_ARGS (duration));
1484   GST_OBJECT_UNLOCK (appsrc);
1485 
1486   return duration;
1487 }
1488 
1489 /**
1490  * gst_app_src_set_stream_type:
1491  * @appsrc: a #GstAppSrc
1492  * @type: the new state
1493  *
1494  * Set the stream type on @appsrc. For seekable streams, the &quot;seek&quot; signal must
1495  * be connected to.
1496  *
1497  * A stream_type stream
1498  */
1499 void
1500 gst_app_src_set_stream_type (GstAppSrc * appsrc, GstAppStreamType type)
1501 {
1502   GstAppSrcPrivate *priv;
1503 
1504   g_return_if_fail (GST_IS_APP_SRC (appsrc));
1505 
1506   priv = appsrc-&gt;priv;
1507 
1508   GST_OBJECT_LOCK (appsrc);
1509   GST_DEBUG_OBJECT (appsrc, &quot;setting stream_type of %d&quot;, type);
1510   priv-&gt;stream_type = type;
1511   GST_OBJECT_UNLOCK (appsrc);
1512 }
1513 
1514 /**
1515  * gst_app_src_get_stream_type:
1516  * @appsrc: a #GstAppSrc
1517  *
1518  * Get the stream type. Control the stream type of @appsrc
1519  * with gst_app_src_set_stream_type().
1520  *
1521  * Returns: the stream type.
1522  */
1523 GstAppStreamType
1524 gst_app_src_get_stream_type (GstAppSrc * appsrc)
1525 {
1526   gboolean stream_type;
1527   GstAppSrcPrivate *priv;
1528 
1529   g_return_val_if_fail (GST_IS_APP_SRC (appsrc), FALSE);
1530 
1531   priv = appsrc-&gt;priv;
1532 
1533   GST_OBJECT_LOCK (appsrc);
1534   stream_type = priv-&gt;stream_type;
1535   GST_DEBUG_OBJECT (appsrc, &quot;getting stream_type of %d&quot;, stream_type);
1536   GST_OBJECT_UNLOCK (appsrc);
1537 
1538   return stream_type;
1539 }
1540 
1541 /**
1542  * gst_app_src_set_max_bytes:
1543  * @appsrc: a #GstAppSrc
1544  * @max: the maximum number of bytes to queue
1545  *
1546  * Set the maximum amount of bytes that can be queued in @appsrc.
1547  * After the maximum amount of bytes are queued, @appsrc will emit the
1548  * &quot;enough-data&quot; signal.
1549  */
1550 void
1551 gst_app_src_set_max_bytes (GstAppSrc * appsrc, guint64 max)
1552 {
1553   GstAppSrcPrivate *priv;
1554 
1555   g_return_if_fail (GST_IS_APP_SRC (appsrc));
1556 
1557   priv = appsrc-&gt;priv;
1558 
1559   g_mutex_lock (&amp;priv-&gt;mutex);
1560   if (max != priv-&gt;max_bytes) {
1561     GST_DEBUG_OBJECT (appsrc, &quot;setting max-bytes to %&quot; G_GUINT64_FORMAT, max);
1562     priv-&gt;max_bytes = max;
1563     /* signal the change */
1564     g_cond_broadcast (&amp;priv-&gt;cond);
1565   }
1566   g_mutex_unlock (&amp;priv-&gt;mutex);
1567 }
1568 
1569 /**
1570  * gst_app_src_get_max_bytes:
1571  * @appsrc: a #GstAppSrc
1572  *
1573  * Get the maximum amount of bytes that can be queued in @appsrc.
1574  *
1575  * Returns: The maximum amount of bytes that can be queued.
1576  */
1577 guint64
1578 gst_app_src_get_max_bytes (GstAppSrc * appsrc)
1579 {
1580   guint64 result;
1581   GstAppSrcPrivate *priv;
1582 
1583   g_return_val_if_fail (GST_IS_APP_SRC (appsrc), 0);
1584 
1585   priv = appsrc-&gt;priv;
1586 
1587   g_mutex_lock (&amp;priv-&gt;mutex);
1588   result = priv-&gt;max_bytes;
1589   GST_DEBUG_OBJECT (appsrc, &quot;getting max-bytes of %&quot; G_GUINT64_FORMAT, result);
1590   g_mutex_unlock (&amp;priv-&gt;mutex);
1591 
1592   return result;
1593 }
1594 
1595 /**
1596  * gst_app_src_get_current_level_bytes:
1597  * @appsrc: a #GstAppSrc
1598  *
1599  * Get the number of currently queued bytes inside @appsrc.
1600  *
1601  * Returns: The number of currently queued bytes.
1602  *
1603  * Since: 1.2
1604  */
1605 guint64
1606 gst_app_src_get_current_level_bytes (GstAppSrc * appsrc)
1607 {
1608   gint64 queued;
1609   GstAppSrcPrivate *priv;
1610 
1611   g_return_val_if_fail (GST_IS_APP_SRC (appsrc), -1);
1612 
1613   priv = appsrc-&gt;priv;
1614 
1615   GST_OBJECT_LOCK (appsrc);
1616   queued = priv-&gt;queued_bytes;
1617   GST_DEBUG_OBJECT (appsrc, &quot;current level bytes is %&quot; G_GUINT64_FORMAT,
1618       queued);
1619   GST_OBJECT_UNLOCK (appsrc);
1620 
1621   return queued;
1622 }
1623 
1624 static void
1625 gst_app_src_set_latencies (GstAppSrc * appsrc, gboolean do_min, guint64 min,
1626     gboolean do_max, guint64 max)
1627 {
1628   GstAppSrcPrivate *priv = appsrc-&gt;priv;
1629   gboolean changed = FALSE;
1630 
1631   g_mutex_lock (&amp;priv-&gt;mutex);
1632   if (do_min &amp;&amp; priv-&gt;min_latency != min) {
1633     priv-&gt;min_latency = min;
1634     changed = TRUE;
1635   }
1636   if (do_max &amp;&amp; priv-&gt;max_latency != max) {
1637     priv-&gt;max_latency = max;
1638     changed = TRUE;
1639   }
1640   g_mutex_unlock (&amp;priv-&gt;mutex);
1641 
1642   if (changed) {
1643     GST_DEBUG_OBJECT (appsrc, &quot;posting latency changed&quot;);
1644     gst_element_post_message (GST_ELEMENT_CAST (appsrc),
1645         gst_message_new_latency (GST_OBJECT_CAST (appsrc)));
1646   }
1647 }
1648 
1649 /**
1650  * gst_app_src_set_latency:
1651  * @appsrc: a #GstAppSrc
1652  * @min: the min latency
1653  * @max: the max latency
1654  *
1655  * Configure the @min and @max latency in @src. If @min is set to -1, the
1656  * default latency calculations for pseudo-live sources will be used.
1657  */
1658 void
1659 gst_app_src_set_latency (GstAppSrc * appsrc, guint64 min, guint64 max)
1660 {
1661   gst_app_src_set_latencies (appsrc, TRUE, min, TRUE, max);
1662 }
1663 
1664 /**
1665  * gst_app_src_get_latency:
1666  * @appsrc: a #GstAppSrc
1667  * @min: (out): the min latency
1668  * @max: (out): the max latency
1669  *
1670  * Retrieve the min and max latencies in @min and @max respectively.
1671  */
1672 void
1673 gst_app_src_get_latency (GstAppSrc * appsrc, guint64 * min, guint64 * max)
1674 {
1675   GstAppSrcPrivate *priv;
1676 
1677   g_return_if_fail (GST_IS_APP_SRC (appsrc));
1678 
1679   priv = appsrc-&gt;priv;
1680 
1681   g_mutex_lock (&amp;priv-&gt;mutex);
1682   if (min)
1683     *min = priv-&gt;min_latency;
1684   if (max)
1685     *max = priv-&gt;max_latency;
1686   g_mutex_unlock (&amp;priv-&gt;mutex);
1687 }
1688 
1689 /**
1690  * gst_app_src_set_emit_signals:
1691  * @appsrc: a #GstAppSrc
1692  * @emit: the new state
1693  *
1694  * Make appsrc emit the &quot;new-preroll&quot; and &quot;new-buffer&quot; signals. This option is
1695  * by default disabled because signal emission is expensive and unneeded when
1696  * the application prefers to operate in pull mode.
1697  */
1698 void
1699 gst_app_src_set_emit_signals (GstAppSrc * appsrc, gboolean emit)
1700 {
1701   GstAppSrcPrivate *priv;
1702 
1703   g_return_if_fail (GST_IS_APP_SRC (appsrc));
1704 
1705   priv = appsrc-&gt;priv;
1706 
1707   g_mutex_lock (&amp;priv-&gt;mutex);
1708   priv-&gt;emit_signals = emit;
1709   g_mutex_unlock (&amp;priv-&gt;mutex);
1710 }
1711 
1712 /**
1713  * gst_app_src_get_emit_signals:
1714  * @appsrc: a #GstAppSrc
1715  *
1716  * Check if appsrc will emit the &quot;new-preroll&quot; and &quot;new-buffer&quot; signals.
1717  *
1718  * Returns: %TRUE if @appsrc is emitting the &quot;new-preroll&quot; and &quot;new-buffer&quot;
1719  * signals.
1720  */
1721 gboolean
1722 gst_app_src_get_emit_signals (GstAppSrc * appsrc)
1723 {
1724   gboolean result;
1725   GstAppSrcPrivate *priv;
1726 
1727   g_return_val_if_fail (GST_IS_APP_SRC (appsrc), FALSE);
1728 
1729   priv = appsrc-&gt;priv;
1730 
1731   g_mutex_lock (&amp;priv-&gt;mutex);
1732   result = priv-&gt;emit_signals;
1733   g_mutex_unlock (&amp;priv-&gt;mutex);
1734 
1735   return result;
1736 }
1737 
1738 static GstFlowReturn
1739 gst_app_src_push_internal (GstAppSrc * appsrc, GstBuffer * buffer,
1740     GstBufferList * buflist, gboolean steal_ref)
1741 {
1742   gboolean first = TRUE;
1743   GstAppSrcPrivate *priv;
1744 
1745   g_return_val_if_fail (GST_IS_APP_SRC (appsrc), GST_FLOW_ERROR);
1746 
1747   priv = appsrc-&gt;priv;
1748 
1749   if (buffer != NULL)
1750     g_return_val_if_fail (GST_IS_BUFFER (buffer), GST_FLOW_ERROR);
1751   else
1752     g_return_val_if_fail (GST_IS_BUFFER_LIST (buflist), GST_FLOW_ERROR);
1753 
1754   if (buflist != NULL) {
1755     if (gst_buffer_list_length (buflist) == 0)
1756       return GST_FLOW_OK;
1757 
1758     buffer = gst_buffer_list_get (buflist, 0);
1759   }
1760 
1761   if (GST_BUFFER_DTS (buffer) == GST_CLOCK_TIME_NONE &amp;&amp;
1762       GST_BUFFER_PTS (buffer) == GST_CLOCK_TIME_NONE &amp;&amp;
1763       gst_base_src_get_do_timestamp (GST_BASE_SRC_CAST (appsrc))) {
1764     GstClock *clock;
1765 
1766     clock = gst_element_get_clock (GST_ELEMENT_CAST (appsrc));
1767     if (clock) {
1768       GstClockTime now;
1769       GstClockTime base_time =
1770           gst_element_get_base_time (GST_ELEMENT_CAST (appsrc));
1771 
1772       now = gst_clock_get_time (clock);
1773       if (now &gt; base_time)
1774         now -= base_time;
1775       else
1776         now = 0;
1777       gst_object_unref (clock);
1778 
1779       if (buflist == NULL) {
1780         if (!steal_ref) {
1781           buffer = gst_buffer_copy (buffer);
1782           steal_ref = TRUE;
1783         } else {
1784           buffer = gst_buffer_make_writable (buffer);
1785         }
1786       } else {
1787         if (!steal_ref) {
1788           buflist = gst_buffer_list_copy (buflist);
1789           steal_ref = TRUE;
1790         } else {
1791           buflist = gst_buffer_list_make_writable (buflist);
1792         }
1793         buffer = gst_buffer_list_get_writable (buflist, 0);
1794       }
1795 
1796       GST_BUFFER_PTS (buffer) = now;
1797       GST_BUFFER_DTS (buffer) = now;
1798     } else {
1799       GST_WARNING_OBJECT (appsrc,
1800           &quot;do-timestamp=TRUE but buffers are provided before &quot;
1801           &quot;reaching the PLAYING state and having a clock. Timestamps will &quot;
1802           &quot;not be accurate!&quot;);
1803     }
1804   }
1805 
1806   g_mutex_lock (&amp;priv-&gt;mutex);
1807 
1808   while (TRUE) {
1809     /* can&#39;t accept buffers when we are flushing or EOS */
1810     if (priv-&gt;flushing)
1811       goto flushing;
1812 
1813     if (priv-&gt;is_eos)
1814       goto eos;
1815 
1816     if (priv-&gt;max_bytes &amp;&amp; priv-&gt;queued_bytes &gt;= priv-&gt;max_bytes) {
1817       GST_DEBUG_OBJECT (appsrc,
1818           &quot;queue filled (%&quot; G_GUINT64_FORMAT &quot; &gt;= %&quot; G_GUINT64_FORMAT &quot;)&quot;,
1819           priv-&gt;queued_bytes, priv-&gt;max_bytes);
1820 
1821       if (first) {
1822         gboolean emit;
1823 
1824         emit = priv-&gt;emit_signals;
1825         /* only signal on the first push */
1826         g_mutex_unlock (&amp;priv-&gt;mutex);
1827 
1828         if (priv-&gt;callbacks.enough_data)
1829           priv-&gt;callbacks.enough_data (appsrc, priv-&gt;user_data);
1830         else if (emit)
1831           g_signal_emit (appsrc, gst_app_src_signals[SIGNAL_ENOUGH_DATA], 0,
1832               NULL);
1833 
1834         g_mutex_lock (&amp;priv-&gt;mutex);
1835         /* continue to check for flushing/eos after releasing the lock */
1836         first = FALSE;
1837         continue;
1838       }
1839       if (priv-&gt;block) {
1840         GST_DEBUG_OBJECT (appsrc, &quot;waiting for free space&quot;);
1841         /* we are filled, wait until a buffer gets popped or when we
1842          * flush. */
1843         priv-&gt;wait_status |= APP_WAITING;
1844         g_cond_wait (&amp;priv-&gt;cond, &amp;priv-&gt;mutex);
1845         priv-&gt;wait_status &amp;= ~APP_WAITING;
1846       } else {
1847         /* no need to wait for free space, we just pump more data into the
1848          * queue hoping that the caller reacts to the enough-data signal and
1849          * stops pushing buffers. */
1850         break;
1851       }
1852     } else
1853       break;
1854   }
1855 
1856   if (buflist != NULL) {
1857     GST_DEBUG_OBJECT (appsrc, &quot;queueing buffer list %p&quot;, buflist);
1858     if (!steal_ref)
1859       gst_buffer_list_ref (buflist);
1860     gst_queue_array_push_tail (priv-&gt;queue, buflist);
1861     priv-&gt;queued_bytes += gst_buffer_list_calculate_size (buflist);
1862   } else {
<a name="11" id="anc11"></a><span class="line-modified">1863   GST_DEBUG_OBJECT (appsrc, &quot;queueing buffer %p&quot;, buffer);</span>
<span class="line-modified">1864   if (!steal_ref)</span>
<span class="line-modified">1865     gst_buffer_ref (buffer);</span>
1866     gst_queue_array_push_tail (priv-&gt;queue, buffer);
<a name="12" id="anc12"></a><span class="line-modified">1867   priv-&gt;queued_bytes += gst_buffer_get_size (buffer);</span>
1868   }
1869 
1870   if ((priv-&gt;wait_status &amp; STREAM_WAITING))
<a name="13" id="anc13"></a><span class="line-modified">1871   g_cond_broadcast (&amp;priv-&gt;cond);</span>
1872 
1873   g_mutex_unlock (&amp;priv-&gt;mutex);
1874 
1875   return GST_FLOW_OK;
1876 
1877   /* ERRORS */
1878 flushing:
1879   {
1880     GST_DEBUG_OBJECT (appsrc, &quot;refuse buffer %p, we are flushing&quot;, buffer);
1881     if (steal_ref)
1882       gst_buffer_unref (buffer);
1883     g_mutex_unlock (&amp;priv-&gt;mutex);
1884     return GST_FLOW_FLUSHING;
1885   }
1886 eos:
1887   {
1888     GST_DEBUG_OBJECT (appsrc, &quot;refuse buffer %p, we are EOS&quot;, buffer);
1889     if (steal_ref)
1890       gst_buffer_unref (buffer);
1891     g_mutex_unlock (&amp;priv-&gt;mutex);
1892     return GST_FLOW_EOS;
1893   }
1894 }
1895 
1896 static GstFlowReturn
1897 gst_app_src_push_buffer_full (GstAppSrc * appsrc, GstBuffer * buffer,
1898     gboolean steal_ref)
1899 {
1900   return gst_app_src_push_internal (appsrc, buffer, NULL, steal_ref);
1901 }
1902 
1903 static GstFlowReturn
1904 gst_app_src_push_sample_internal (GstAppSrc * appsrc, GstSample * sample)
1905 {
1906   GstBufferList *buffer_list;
1907   GstBuffer *buffer;
1908   GstCaps *caps;
1909 
1910   g_return_val_if_fail (GST_IS_SAMPLE (sample), GST_FLOW_ERROR);
1911 
1912   caps = gst_sample_get_caps (sample);
1913   if (caps != NULL) {
1914     gst_app_src_set_caps (appsrc, caps);
1915   } else {
1916     GST_WARNING_OBJECT (appsrc, &quot;received sample without caps&quot;);
1917   }
1918 
1919   buffer = gst_sample_get_buffer (sample);
1920   if (buffer != NULL)
1921     return gst_app_src_push_buffer_full (appsrc, buffer, FALSE);
1922 
1923   buffer_list = gst_sample_get_buffer_list (sample);
1924   if (buffer_list != NULL)
1925     return gst_app_src_push_internal (appsrc, NULL, buffer_list, FALSE);
1926 
1927   GST_WARNING_OBJECT (appsrc, &quot;received sample without buffer or buffer list&quot;);
1928   return GST_FLOW_OK;
1929 }
1930 
1931 /**
1932  * gst_app_src_push_buffer:
1933  * @appsrc: a #GstAppSrc
1934  * @buffer: (transfer full): a #GstBuffer to push
1935  *
1936  * Adds a buffer to the queue of buffers that the appsrc element will
1937  * push to its source pad.  This function takes ownership of the buffer.
1938  *
1939  * When the block property is TRUE, this function can block until free
1940  * space becomes available in the queue.
1941  *
1942  * Returns: #GST_FLOW_OK when the buffer was successfuly queued.
1943  * #GST_FLOW_FLUSHING when @appsrc is not PAUSED or PLAYING.
1944  * #GST_FLOW_EOS when EOS occured.
1945  */
1946 GstFlowReturn
1947 gst_app_src_push_buffer (GstAppSrc * appsrc, GstBuffer * buffer)
1948 {
1949   return gst_app_src_push_buffer_full (appsrc, buffer, TRUE);
1950 }
1951 
1952 /**
1953  * gst_app_src_push_buffer_list:
1954  * @appsrc: a #GstAppSrc
1955  * @buffer_list: (transfer full): a #GstBufferList to push
1956  *
1957  * Adds a buffer list to the queue of buffers and buffer lists that the
1958  * appsrc element will push to its source pad.  This function takes ownership
1959  * of @buffer_list.
1960  *
1961  * When the block property is TRUE, this function can block until free
1962  * space becomes available in the queue.
1963  *
1964  * Returns: #GST_FLOW_OK when the buffer list was successfuly queued.
1965  * #GST_FLOW_FLUSHING when @appsrc is not PAUSED or PLAYING.
1966  * #GST_FLOW_EOS when EOS occured.
1967  *
1968  * Since: 1.14
1969  */
1970 GstFlowReturn
1971 gst_app_src_push_buffer_list (GstAppSrc * appsrc, GstBufferList * buffer_list)
1972 {
1973   return gst_app_src_push_internal (appsrc, NULL, buffer_list, TRUE);
1974 }
1975 
1976 /**
1977  * gst_app_src_push_sample:
1978  * @appsrc: a #GstAppSrc
1979  * @sample: (transfer none): a #GstSample from which buffer and caps may be
1980  * extracted
1981  *
1982  * Extract a buffer from the provided sample and adds it to the queue of
1983  * buffers that the appsrc element will push to its source pad. Any
1984  * previous caps that were set on appsrc will be replaced by the caps
1985  * associated with the sample if not equal.
1986  *
<a name="14" id="anc14"></a>


1987  * When the block property is TRUE, this function can block until free
1988  * space becomes available in the queue.
1989  *
1990  * Returns: #GST_FLOW_OK when the buffer was successfuly queued.
1991  * #GST_FLOW_FLUSHING when @appsrc is not PAUSED or PLAYING.
1992  * #GST_FLOW_EOS when EOS occured.
1993  *
1994  * Since: 1.6
1995  *
1996  */
1997 GstFlowReturn
1998 gst_app_src_push_sample (GstAppSrc * appsrc, GstSample * sample)
1999 {
2000   return gst_app_src_push_sample_internal (appsrc, sample);
2001 }
2002 
2003 /* push a buffer without stealing the ref of the buffer. This is used for the
2004  * action signal. */
2005 static GstFlowReturn
2006 gst_app_src_push_buffer_action (GstAppSrc * appsrc, GstBuffer * buffer)
2007 {
2008   return gst_app_src_push_buffer_full (appsrc, buffer, FALSE);
2009 }
2010 
2011 /* push a buffer list without stealing the ref of the buffer list. This is
2012  * used for the action signal. */
2013 static GstFlowReturn
2014 gst_app_src_push_buffer_list_action (GstAppSrc * appsrc,
2015     GstBufferList * buffer_list)
2016 {
2017   return gst_app_src_push_internal (appsrc, NULL, buffer_list, FALSE);
2018 }
2019 
2020 /* push a sample without stealing the ref. This is used for the
2021  * action signal. */
2022 static GstFlowReturn
2023 gst_app_src_push_sample_action (GstAppSrc * appsrc, GstSample * sample)
2024 {
2025   return gst_app_src_push_sample_internal (appsrc, sample);
2026 }
2027 
2028 /**
2029  * gst_app_src_end_of_stream:
2030  * @appsrc: a #GstAppSrc
2031  *
2032  * Indicates to the appsrc element that the last buffer queued in the
2033  * element is the last buffer of the stream.
2034  *
2035  * Returns: #GST_FLOW_OK when the EOS was successfuly queued.
2036  * #GST_FLOW_FLUSHING when @appsrc is not PAUSED or PLAYING.
2037  */
2038 GstFlowReturn
2039 gst_app_src_end_of_stream (GstAppSrc * appsrc)
2040 {
2041   GstAppSrcPrivate *priv;
2042 
2043   g_return_val_if_fail (GST_IS_APP_SRC (appsrc), GST_FLOW_ERROR);
2044 
2045   priv = appsrc-&gt;priv;
2046 
2047   g_mutex_lock (&amp;priv-&gt;mutex);
2048   /* can&#39;t accept buffers when we are flushing. We can accept them when we are
2049    * EOS although it will not do anything. */
2050   if (priv-&gt;flushing)
2051     goto flushing;
2052 
2053   GST_DEBUG_OBJECT (appsrc, &quot;sending EOS&quot;);
2054   priv-&gt;is_eos = TRUE;
2055   g_cond_broadcast (&amp;priv-&gt;cond);
2056   g_mutex_unlock (&amp;priv-&gt;mutex);
2057 
2058   return GST_FLOW_OK;
2059 
2060   /* ERRORS */
2061 flushing:
2062   {
2063     g_mutex_unlock (&amp;priv-&gt;mutex);
2064     GST_DEBUG_OBJECT (appsrc, &quot;refuse EOS, we are flushing&quot;);
2065     return GST_FLOW_FLUSHING;
2066   }
2067 }
2068 
2069 /**
2070  * gst_app_src_set_callbacks: (skip)
2071  * @appsrc: a #GstAppSrc
2072  * @callbacks: the callbacks
2073  * @user_data: a user_data argument for the callbacks
2074  * @notify: a destroy notify function
2075  *
2076  * Set callbacks which will be executed when data is needed, enough data has
2077  * been collected or when a seek should be performed.
2078  * This is an alternative to using the signals, it has lower overhead and is thus
2079  * less expensive, but also less flexible.
2080  *
2081  * If callbacks are installed, no signals will be emitted for performance
2082  * reasons.
2083  */
2084 void
2085 gst_app_src_set_callbacks (GstAppSrc * appsrc,
2086     GstAppSrcCallbacks * callbacks, gpointer user_data, GDestroyNotify notify)
2087 {
2088   GDestroyNotify old_notify;
2089   GstAppSrcPrivate *priv;
2090 
2091   g_return_if_fail (GST_IS_APP_SRC (appsrc));
2092   g_return_if_fail (callbacks != NULL);
2093 
2094   priv = appsrc-&gt;priv;
2095 
2096   GST_OBJECT_LOCK (appsrc);
2097   old_notify = priv-&gt;notify;
2098 
2099   if (old_notify) {
2100     gpointer old_data;
2101 
2102     old_data = priv-&gt;user_data;
2103 
2104     priv-&gt;user_data = NULL;
2105     priv-&gt;notify = NULL;
2106     GST_OBJECT_UNLOCK (appsrc);
2107 
2108     old_notify (old_data);
2109 
2110     GST_OBJECT_LOCK (appsrc);
2111   }
2112   priv-&gt;callbacks = *callbacks;
2113   priv-&gt;user_data = user_data;
2114   priv-&gt;notify = notify;
2115   GST_OBJECT_UNLOCK (appsrc);
2116 }
2117 
2118 /*** GSTURIHANDLER INTERFACE *************************************************/
2119 
2120 static GstURIType
2121 gst_app_src_uri_get_type (GType type)
2122 {
2123   return GST_URI_SRC;
2124 }
2125 
2126 static const gchar *const *
2127 gst_app_src_uri_get_protocols (GType type)
2128 {
2129   static const gchar *protocols[] = { &quot;appsrc&quot;, NULL };
2130 
2131   return protocols;
2132 }
2133 
2134 static gchar *
2135 gst_app_src_uri_get_uri (GstURIHandler * handler)
2136 {
2137   GstAppSrc *appsrc = GST_APP_SRC (handler);
2138 
2139   return appsrc-&gt;priv-&gt;uri ? g_strdup (appsrc-&gt;priv-&gt;uri) : NULL;
2140 }
2141 
2142 static gboolean
2143 gst_app_src_uri_set_uri (GstURIHandler * handler, const gchar * uri,
2144     GError ** error)
2145 {
2146   GstAppSrc *appsrc = GST_APP_SRC (handler);
2147 
2148   g_free (appsrc-&gt;priv-&gt;uri);
2149   appsrc-&gt;priv-&gt;uri = uri ? g_strdup (uri) : NULL;
2150 
2151   return TRUE;
2152 }
2153 
2154 static void
2155 gst_app_src_uri_handler_init (gpointer g_iface, gpointer iface_data)
2156 {
2157   GstURIHandlerInterface *iface = (GstURIHandlerInterface *) g_iface;
2158 
2159   iface-&gt;get_type = gst_app_src_uri_get_type;
2160   iface-&gt;get_protocols = gst_app_src_uri_get_protocols;
2161   iface-&gt;get_uri = gst_app_src_uri_get_uri;
2162   iface-&gt;set_uri = gst_app_src_uri_set_uri;
2163 }
2164 
2165 static gboolean
2166 gst_app_src_event (GstBaseSrc * src, GstEvent * event)
2167 {
2168   GstAppSrc *appsrc = GST_APP_SRC_CAST (src);
2169   GstAppSrcPrivate *priv = appsrc-&gt;priv;
2170 
2171   switch (GST_EVENT_TYPE (event)) {
2172     case GST_EVENT_FLUSH_STOP:
2173       g_mutex_lock (&amp;priv-&gt;mutex);
2174       priv-&gt;is_eos = FALSE;
2175       g_mutex_unlock (&amp;priv-&gt;mutex);
2176       break;
2177     default:
2178       break;
2179   }
2180 
2181   return GST_BASE_SRC_CLASS (parent_class)-&gt;event (src, event);
2182 }
<a name="15" id="anc15"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="15" type="hidden" />
</body>
</html>