<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.media/src/main/native/gstreamer/3rd_party/glib/glib/gwin32.c</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="gwakeup.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="gwin32.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.media/src/main/native/gstreamer/3rd_party/glib/glib/gwin32.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 36,11 ***</span>
  #include &lt;string.h&gt;
  #include &lt;wchar.h&gt;
  #include &lt;errno.h&gt;
  #include &lt;fcntl.h&gt;
  
<span class="line-modified">! #define STRICT          /* Strict typing, please */</span>
  #include &lt;windows.h&gt;
  #undef STRICT
  #ifndef G_WITH_CYGWIN
  #include &lt;direct.h&gt;
  #endif
<span class="line-new-header">--- 36,11 ---</span>
  #include &lt;string.h&gt;
  #include &lt;wchar.h&gt;
  #include &lt;errno.h&gt;
  #include &lt;fcntl.h&gt;
  
<span class="line-modified">! #define STRICT      /* Strict typing, please */</span>
  #include &lt;windows.h&gt;
  #undef STRICT
  #ifndef G_WITH_CYGWIN
  #include &lt;direct.h&gt;
  #endif
</pre>
<hr />
<pre>
<span class="line-old-header">*** 77,11 ***</span>
  
  #ifndef G_WITH_CYGWIN
  
  gint
  g_win32_ftruncate (gint  fd,
<span class="line-modified">!            guint size)</span>
  {
    return _chsize (fd, size);
  }
  
  #endif
<span class="line-new-header">--- 77,11 ---</span>
  
  #ifndef G_WITH_CYGWIN
  
  gint
  g_win32_ftruncate (gint  fd,
<span class="line-modified">!        guint size)</span>
  {
    return _chsize (fd, size);
  }
  
  #endif
</pre>
<hr />
<pre>
<span class="line-old-header">*** 141,38 ***</span>
    /* Handle special cases */
    switch (primary)
      {
      case LANG_AZERI:
        switch (sub)
<span class="line-modified">!     {</span>
<span class="line-modified">!     case SUBLANG_AZERI_LATIN:</span>
<span class="line-modified">!       script = &quot;@Latn&quot;;</span>
<span class="line-modified">!       break;</span>
<span class="line-modified">!     case SUBLANG_AZERI_CYRILLIC:</span>
<span class="line-modified">!       script = &quot;@Cyrl&quot;;</span>
<span class="line-modified">!       break;</span>
<span class="line-modified">!     }</span>
        break;
<span class="line-modified">!     case LANG_SERBIAN:      /* LANG_CROATIAN == LANG_SERBIAN */</span>
        switch (sub)
<span class="line-modified">!     {</span>
<span class="line-modified">!     case SUBLANG_SERBIAN_LATIN:</span>
<span class="line-modified">!     case 0x06: /* Serbian (Latin) - Bosnia and Herzegovina */</span>
<span class="line-modified">!       script = &quot;@Latn&quot;;</span>
<span class="line-modified">!       break;</span>
<span class="line-modified">!     }</span>
        break;
      case LANG_UZBEK:
        switch (sub)
<span class="line-modified">!     {</span>
<span class="line-modified">!     case SUBLANG_UZBEK_LATIN:</span>
<span class="line-modified">!       script = &quot;@Latn&quot;;</span>
<span class="line-modified">!       break;</span>
<span class="line-modified">!     case SUBLANG_UZBEK_CYRILLIC:</span>
<span class="line-modified">!       script = &quot;@Cyrl&quot;;</span>
<span class="line-modified">!       break;</span>
<span class="line-modified">!     }</span>
        break;
      }
    return g_strconcat (iso639, &quot;_&quot;, iso3166, script, NULL);
  }
  
<span class="line-new-header">--- 141,38 ---</span>
    /* Handle special cases */
    switch (primary)
      {
      case LANG_AZERI:
        switch (sub)
<span class="line-modified">!   {</span>
<span class="line-modified">!   case SUBLANG_AZERI_LATIN:</span>
<span class="line-modified">!     script = &quot;@Latn&quot;;</span>
<span class="line-modified">!     break;</span>
<span class="line-modified">!   case SUBLANG_AZERI_CYRILLIC:</span>
<span class="line-modified">!     script = &quot;@Cyrl&quot;;</span>
<span class="line-modified">!     break;</span>
<span class="line-modified">!   }</span>
        break;
<span class="line-modified">!     case LANG_SERBIAN:    /* LANG_CROATIAN == LANG_SERBIAN */</span>
        switch (sub)
<span class="line-modified">!   {</span>
<span class="line-modified">!   case SUBLANG_SERBIAN_LATIN:</span>
<span class="line-modified">!   case 0x06: /* Serbian (Latin) - Bosnia and Herzegovina */</span>
<span class="line-modified">!     script = &quot;@Latn&quot;;</span>
<span class="line-modified">!     break;</span>
<span class="line-modified">!   }</span>
        break;
      case LANG_UZBEK:
        switch (sub)
<span class="line-modified">!   {</span>
<span class="line-modified">!   case SUBLANG_UZBEK_LATIN:</span>
<span class="line-modified">!     script = &quot;@Latn&quot;;</span>
<span class="line-modified">!     break;</span>
<span class="line-modified">!   case SUBLANG_UZBEK_CYRILLIC:</span>
<span class="line-modified">!     script = &quot;@Cyrl&quot;;</span>
<span class="line-modified">!     break;</span>
<span class="line-modified">!   }</span>
        break;
      }
    return g_strconcat (iso639, &quot;_&quot;, iso3166, script, NULL);
  }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 195,14 ***</span>
    gchar *retval;
    wchar_t *msg = NULL;
    size_t nchars;
  
    FormatMessageW (FORMAT_MESSAGE_ALLOCATE_BUFFER
<span class="line-modified">!           |FORMAT_MESSAGE_IGNORE_INSERTS</span>
<span class="line-modified">!           |FORMAT_MESSAGE_FROM_SYSTEM,</span>
<span class="line-modified">!           NULL, error, 0,</span>
<span class="line-modified">!           (LPWSTR) &amp;msg, 0, NULL);</span>
    if (msg != NULL)
      {
        nchars = wcslen (msg);
  
        if (nchars &gt;= 2 &amp;&amp; msg[nchars-1] == L&#39;\n&#39; &amp;&amp; msg[nchars-2] == L&#39;\r&#39;)
<span class="line-new-header">--- 195,14 ---</span>
    gchar *retval;
    wchar_t *msg = NULL;
    size_t nchars;
  
    FormatMessageW (FORMAT_MESSAGE_ALLOCATE_BUFFER
<span class="line-modified">!       |FORMAT_MESSAGE_IGNORE_INSERTS</span>
<span class="line-modified">!       |FORMAT_MESSAGE_FROM_SYSTEM,</span>
<span class="line-modified">!       NULL, error, 0,</span>
<span class="line-modified">!       (LPWSTR) &amp;msg, 0, NULL);</span>
    if (msg != NULL)
      {
        nchars = wcslen (msg);
  
        if (nchars &gt;= 2 &amp;&amp; msg[nchars-1] == L&#39;\n&#39; &amp;&amp; msg[nchars-2] == L&#39;\r&#39;)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 335,14 ***</span>
        wchar_t *wc_module_name = g_utf8_to_utf16 (module_name, -1, NULL, NULL, NULL);
        hmodule = GetModuleHandleW (wc_module_name);
        g_free (wc_module_name);
  
        if (!hmodule)
<span class="line-modified">!     {</span>
<span class="line-modified">!       G_UNLOCK (module_dirs);</span>
<span class="line-modified">!       return NULL;</span>
<span class="line-modified">!     }</span>
      }
  
    fn = g_win32_get_package_installation_directory_of_module (hmodule);
  
    if (fn == NULL)
<span class="line-new-header">--- 335,14 ---</span>
        wchar_t *wc_module_name = g_utf8_to_utf16 (module_name, -1, NULL, NULL, NULL);
        hmodule = GetModuleHandleW (wc_module_name);
        g_free (wc_module_name);
  
        if (!hmodule)
<span class="line-modified">!   {</span>
<span class="line-modified">!     G_UNLOCK (module_dirs);</span>
<span class="line-modified">!     return NULL;</span>
<span class="line-modified">!   }</span>
      }
  
    fn = g_win32_get_package_installation_directory_of_module (hmodule);
  
    if (fn == NULL)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1016,6 ***</span>
<span class="line-new-header">--- 1016,221 ---</span>
  
        _close (new_fd);
      }
  }
  
<span class="line-added">+ #ifndef GSTREAMER_LITE</span>
<span class="line-added">+ /* This is a handle to the Vectored Exception Handler that</span>
<span class="line-added">+  * we install on library initialization. If installed correctly,</span>
<span class="line-added">+  * it will be non-NULL. Only used to later de-install the handler</span>
<span class="line-added">+  * on library de-initialization.</span>
<span class="line-added">+  */</span>
<span class="line-added">+ static void *WinVEH_handle = NULL;</span>
<span class="line-added">+ </span>
<span class="line-added">+ #include &quot;gwin32-private.c&quot;</span>
<span class="line-added">+ </span>
<span class="line-added">+ /* Handles exceptions (useful for debugging).</span>
<span class="line-added">+  * Issues a DebugBreak() call if the process is being debugged (not really</span>
<span class="line-added">+  * useful - if the process is being debugged, this handler won&#39;t be invoked</span>
<span class="line-added">+  * anyway). If it is not, runs a debugger from G_DEBUGGER env var,</span>
<span class="line-added">+  * substituting first %p in it for PID, and the first %e for the event handle -</span>
<span class="line-added">+  * that event should be set once the debugger attaches itself (otherwise the</span>
<span class="line-added">+  * only way out of WaitForSingleObject() is to time out after 1 minute).</span>
<span class="line-added">+  * For example, G_DEBUGGER can be set to the following command:</span>
<span class="line-added">+  * ```</span>
<span class="line-added">+  * gdb.exe -ex &quot;attach %p&quot; -ex &quot;signal-event %e&quot; -ex &quot;bt&quot; -ex &quot;c&quot;</span>
<span class="line-added">+  * ```</span>
<span class="line-added">+  * This will make GDB attach to the process, signal the event (GDB must be</span>
<span class="line-added">+  * recent enough for the signal-event command to be available),</span>
<span class="line-added">+  * show the backtrace and resume execution, which should make it catch</span>
<span class="line-added">+  * the exception when Windows re-raises it again.</span>
<span class="line-added">+  * The command line can&#39;t be longer than MAX_PATH (260 characters).</span>
<span class="line-added">+  *</span>
<span class="line-added">+  * This function will only stop (and run a debugger) on the following exceptions:</span>
<span class="line-added">+  * * EXCEPTION_ACCESS_VIOLATION</span>
<span class="line-added">+  * * EXCEPTION_STACK_OVERFLOW</span>
<span class="line-added">+  * * EXCEPTION_ILLEGAL_INSTRUCTION</span>
<span class="line-added">+  * To make it stop at other exceptions one should set the G_VEH_CATCH</span>
<span class="line-added">+  * environment variable to a list of comma-separated hexademical numbers,</span>
<span class="line-added">+  * where each number is the code of an exception that should be caught.</span>
<span class="line-added">+  * This is done to prevent GLib from breaking when Windows uses</span>
<span class="line-added">+  * exceptions to shuttle information (SetThreadName(), OutputDebugString())</span>
<span class="line-added">+  * or for control flow.</span>
<span class="line-added">+  *</span>
<span class="line-added">+  * This function deliberately avoids calling any GLib code.</span>
<span class="line-added">+  */</span>
<span class="line-added">+ static LONG __stdcall</span>
<span class="line-added">+ g_win32_veh_handler (PEXCEPTION_POINTERS ExceptionInfo)</span>
<span class="line-added">+ {</span>
<span class="line-added">+   EXCEPTION_RECORD    *er;</span>
<span class="line-added">+   char                 debugger[MAX_PATH + 1];</span>
<span class="line-added">+   const char          *debugger_env = NULL;</span>
<span class="line-added">+   const char          *catch_list;</span>
<span class="line-added">+   gboolean             catch = FALSE;</span>
<span class="line-added">+   STARTUPINFO          si;</span>
<span class="line-added">+   PROCESS_INFORMATION  pi;</span>
<span class="line-added">+   HANDLE               event;</span>
<span class="line-added">+   SECURITY_ATTRIBUTES  sa;</span>
<span class="line-added">+ </span>
<span class="line-added">+   if (ExceptionInfo == NULL ||</span>
<span class="line-added">+       ExceptionInfo-&gt;ExceptionRecord == NULL)</span>
<span class="line-added">+     return EXCEPTION_CONTINUE_SEARCH;</span>
<span class="line-added">+ </span>
<span class="line-added">+   er = ExceptionInfo-&gt;ExceptionRecord;</span>
<span class="line-added">+ </span>
<span class="line-added">+   switch (er-&gt;ExceptionCode)</span>
<span class="line-added">+     {</span>
<span class="line-added">+     case EXCEPTION_ACCESS_VIOLATION:</span>
<span class="line-added">+     case EXCEPTION_STACK_OVERFLOW:</span>
<span class="line-added">+     case EXCEPTION_ILLEGAL_INSTRUCTION:</span>
<span class="line-added">+     case EXCEPTION_BREAKPOINT: /* DebugBreak() raises this */</span>
<span class="line-added">+       break;</span>
<span class="line-added">+     default:</span>
<span class="line-added">+       catch_list = getenv (&quot;G_VEH_CATCH&quot;);</span>
<span class="line-added">+ </span>
<span class="line-added">+       while (!catch &amp;&amp;</span>
<span class="line-added">+              catch_list != NULL &amp;&amp;</span>
<span class="line-added">+              catch_list[0] != 0)</span>
<span class="line-added">+         {</span>
<span class="line-added">+           unsigned long  catch_code;</span>
<span class="line-added">+           char          *end;</span>
<span class="line-added">+           errno = 0;</span>
<span class="line-added">+           catch_code = strtoul (catch_list, &amp;end, 16);</span>
<span class="line-added">+           if (errno != NO_ERROR)</span>
<span class="line-added">+             break;</span>
<span class="line-added">+           catch_list = end;</span>
<span class="line-added">+           if (catch_list != NULL &amp;&amp; catch_list[0] == &#39;,&#39;)</span>
<span class="line-added">+             catch_list++;</span>
<span class="line-added">+           if (catch_code == er-&gt;ExceptionCode)</span>
<span class="line-added">+             catch = TRUE;</span>
<span class="line-added">+         }</span>
<span class="line-added">+ </span>
<span class="line-added">+       if (catch)</span>
<span class="line-added">+         break;</span>
<span class="line-added">+ </span>
<span class="line-added">+       return EXCEPTION_CONTINUE_SEARCH;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+   if (IsDebuggerPresent ())</span>
<span class="line-added">+     {</span>
<span class="line-added">+       /* This shouldn&#39;t happen, but still try to</span>
<span class="line-added">+        * avoid recursion with EXCEPTION_BREAKPOINT and</span>
<span class="line-added">+        * DebugBreak().</span>
<span class="line-added">+        */</span>
<span class="line-added">+       if (er-&gt;ExceptionCode != EXCEPTION_BREAKPOINT)</span>
<span class="line-added">+         DebugBreak ();</span>
<span class="line-added">+       return EXCEPTION_CONTINUE_EXECUTION;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+   fprintf_s (stderr,</span>
<span class="line-added">+              &quot;Exception code=0x%lx flags=0x%lx at 0x%p&quot;,</span>
<span class="line-added">+              er-&gt;ExceptionCode,</span>
<span class="line-added">+              er-&gt;ExceptionFlags,</span>
<span class="line-added">+              er-&gt;ExceptionAddress);</span>
<span class="line-added">+ </span>
<span class="line-added">+   switch (er-&gt;ExceptionCode)</span>
<span class="line-added">+     {</span>
<span class="line-added">+     case EXCEPTION_ACCESS_VIOLATION:</span>
<span class="line-added">+       fprintf_s (stderr,</span>
<span class="line-added">+                  &quot;. Access violation - attempting to %s at address 0x%p\n&quot;,</span>
<span class="line-added">+                  er-&gt;ExceptionInformation[0] == 0 ? &quot;read data&quot; :</span>
<span class="line-added">+                  er-&gt;ExceptionInformation[0] == 1 ? &quot;write data&quot; :</span>
<span class="line-added">+                  er-&gt;ExceptionInformation[0] == 8 ? &quot;execute data&quot; :</span>
<span class="line-added">+                  &quot;do something bad&quot;,</span>
<span class="line-added">+                  (void *) er-&gt;ExceptionInformation[1]);</span>
<span class="line-added">+       break;</span>
<span class="line-added">+     case EXCEPTION_IN_PAGE_ERROR:</span>
<span class="line-added">+       fprintf_s (stderr,</span>
<span class="line-added">+                  &quot;. Page access violation - attempting to %s at address 0x%p with status %Ix\n&quot;,</span>
<span class="line-added">+                  er-&gt;ExceptionInformation[0] == 0 ? &quot;read from an inaccessible page&quot; :</span>
<span class="line-added">+                  er-&gt;ExceptionInformation[0] == 1 ? &quot;write to an inaccessible page&quot; :</span>
<span class="line-added">+                  er-&gt;ExceptionInformation[0] == 8 ? &quot;execute data in page&quot; :</span>
<span class="line-added">+                  &quot;do something bad with a page&quot;,</span>
<span class="line-added">+                  (void *) er-&gt;ExceptionInformation[1],</span>
<span class="line-added">+                  er-&gt;ExceptionInformation[2]);</span>
<span class="line-added">+       break;</span>
<span class="line-added">+     default:</span>
<span class="line-added">+       fprintf_s (stderr, &quot;\n&quot;);</span>
<span class="line-added">+       break;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+   fflush (stderr);</span>
<span class="line-added">+ </span>
<span class="line-added">+   debugger_env = getenv (&quot;G_DEBUGGER&quot;);</span>
<span class="line-added">+ </span>
<span class="line-added">+   if (debugger_env == NULL)</span>
<span class="line-added">+     return EXCEPTION_CONTINUE_SEARCH;</span>
<span class="line-added">+ </span>
<span class="line-added">+   /* Create an inheritable event */</span>
<span class="line-added">+   memset (&amp;si, 0, sizeof (si));</span>
<span class="line-added">+   memset (&amp;pi, 0, sizeof (pi));</span>
<span class="line-added">+   memset (&amp;sa, 0, sizeof (sa));</span>
<span class="line-added">+   si.cb = sizeof (si);</span>
<span class="line-added">+   sa.nLength = sizeof (sa);</span>
<span class="line-added">+   sa.bInheritHandle = TRUE;</span>
<span class="line-added">+   event = CreateEvent (&amp;sa, FALSE, FALSE, NULL);</span>
<span class="line-added">+ </span>
<span class="line-added">+   /* Put process ID and event handle into debugger commandline */</span>
<span class="line-added">+   if (!_g_win32_subst_pid_and_event (debugger, G_N_ELEMENTS (debugger),</span>
<span class="line-added">+                                      debugger_env, GetCurrentProcessId (),</span>
<span class="line-added">+                                      (guintptr) event))</span>
<span class="line-added">+     {</span>
<span class="line-added">+       CloseHandle (event);</span>
<span class="line-added">+       return EXCEPTION_CONTINUE_SEARCH;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+   /* Run the debugger */</span>
<span class="line-added">+   debugger[MAX_PATH] = &#39;\0&#39;;</span>
<span class="line-added">+   if (0 != CreateProcessA (NULL,</span>
<span class="line-added">+                            debugger,</span>
<span class="line-added">+                            NULL,</span>
<span class="line-added">+                            NULL,</span>
<span class="line-added">+                            TRUE,</span>
<span class="line-added">+                            getenv (&quot;G_DEBUGGER_OLD_CONSOLE&quot;) != NULL ? 0 : CREATE_NEW_CONSOLE,</span>
<span class="line-added">+                            NULL,</span>
<span class="line-added">+                            NULL,</span>
<span class="line-added">+                            &amp;si,</span>
<span class="line-added">+                            &amp;pi))</span>
<span class="line-added">+     {</span>
<span class="line-added">+       CloseHandle (pi.hProcess);</span>
<span class="line-added">+       CloseHandle (pi.hThread);</span>
<span class="line-added">+       /* If successful, wait for 60 seconds on the event</span>
<span class="line-added">+        * we passed. The debugger should signal that event.</span>
<span class="line-added">+        * 60 second limit is here to prevent us from hanging</span>
<span class="line-added">+        * up forever in case the debugger does not support</span>
<span class="line-added">+        * event signalling.</span>
<span class="line-added">+        */</span>
<span class="line-added">+       WaitForSingleObject (event, 60000);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+   CloseHandle (event);</span>
<span class="line-added">+ </span>
<span class="line-added">+   /* Now the debugger is present, and we can try</span>
<span class="line-added">+    * resuming execution, re-triggering the exception,</span>
<span class="line-added">+    * which will be caught by debugger this time around.</span>
<span class="line-added">+    */</span>
<span class="line-added">+   if (IsDebuggerPresent ())</span>
<span class="line-added">+     return EXCEPTION_CONTINUE_EXECUTION;</span>
<span class="line-added">+ </span>
<span class="line-added">+   return EXCEPTION_CONTINUE_SEARCH;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ void</span>
<span class="line-added">+ g_crash_handler_win32_init (void)</span>
<span class="line-added">+ {</span>
<span class="line-added">+   if (WinVEH_handle != NULL)</span>
<span class="line-added">+     return;</span>
<span class="line-added">+ </span>
<span class="line-added">+   WinVEH_handle = AddVectoredExceptionHandler (0, &amp;g_win32_veh_handler);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ void</span>
<span class="line-added">+ g_crash_handler_win32_deinit (void)</span>
<span class="line-added">+ {</span>
<span class="line-added">+   if (WinVEH_handle != NULL)</span>
<span class="line-added">+     RemoveVectoredExceptionHandler (WinVEH_handle);</span>
<span class="line-added">+ </span>
<span class="line-added">+   WinVEH_handle = NULL;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ #endif // GSTREAMER_LITE</span>
<span class="line-added">+ </span>
  #endif
</pre>
<center><a href="gwakeup.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="gwin32.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>