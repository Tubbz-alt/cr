<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.media/src/main/native/gstreamer/3rd_party/glib/glib/gtestutils.c</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /* GLib testing utilities
   2  * Copyright (C) 2007 Imendio AB
   3  * Authors: Tim Janik, Sven Herzberg
   4  *
   5  * This library is free software; you can redistribute it and/or
   6  * modify it under the terms of the GNU Lesser General Public
   7  * License as published by the Free Software Foundation; either
   8  * version 2.1 of the License, or (at your option) any later version.
   9  *
  10  * This library is distributed in the hope that it will be useful,
  11  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  12  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
  13  * Lesser General Public License for more details.
  14  *
  15  * You should have received a copy of the GNU Lesser General Public
  16  * License along with this library; if not, see &lt;http://www.gnu.org/licenses/&gt;.
  17  */
  18 
  19 #include &quot;config.h&quot;
  20 
  21 #include &quot;gtestutils.h&quot;
  22 #include &quot;gfileutils.h&quot;
  23 
  24 #include &lt;sys/types.h&gt;
  25 #ifdef G_OS_UNIX
  26 #include &lt;sys/wait.h&gt;
  27 #include &lt;sys/time.h&gt;
  28 #include &lt;fcntl.h&gt;
  29 #include &lt;unistd.h&gt;
<a name="1" id="anc1"></a>
  30 #endif
  31 #include &lt;string.h&gt;
  32 #include &lt;stdlib.h&gt;
  33 #include &lt;stdio.h&gt;
  34 #ifdef HAVE_SYS_RESOURCE_H
  35 #include &lt;sys/resource.h&gt;
  36 #endif
  37 #ifdef G_OS_WIN32
  38 #include &lt;io.h&gt;
  39 #include &lt;windows.h&gt;
  40 #endif
  41 #include &lt;errno.h&gt;
  42 #include &lt;signal.h&gt;
  43 #ifdef HAVE_SYS_SELECT_H
  44 #include &lt;sys/select.h&gt;
  45 #endif /* HAVE_SYS_SELECT_H */
<a name="2" id="anc2"></a><span class="line-added">  46 #include &lt;glib/gstdio.h&gt;</span>
  47 
  48 #include &quot;gmain.h&quot;
  49 #include &quot;gpattern.h&quot;
  50 #include &quot;grand.h&quot;
  51 #include &quot;gstrfuncs.h&quot;
  52 #include &quot;gtimer.h&quot;
  53 #include &quot;gslice.h&quot;
  54 #include &quot;gspawn.h&quot;
  55 #include &quot;glib-private.h&quot;
<a name="3" id="anc3"></a><span class="line-added">  56 #include &quot;gutilsprivate.h&quot;</span>
  57 
  58 
  59 /**
  60  * SECTION:testing
  61  * @title: Testing
  62  * @short_description: a test framework
<a name="4" id="anc4"></a>
  63  *
  64  * GLib provides a framework for writing and maintaining unit tests
  65  * in parallel to the code they are testing. The API is designed according
  66  * to established concepts found in the other test frameworks (JUnit, NUnit,
  67  * RUnit), which in turn is based on smalltalk unit testing concepts.
  68  *
  69  * - Test case: Tests (test methods) are grouped together with their
  70  *   fixture into test cases.
  71  *
  72  * - Fixture: A test fixture consists of fixture data and setup and
  73  *   teardown methods to establish the environment for the test
  74  *   functions. We use fresh fixtures, i.e. fixtures are newly set
  75  *   up and torn down around each test invocation to avoid dependencies
  76  *   between tests.
  77  *
  78  * - Test suite: Test cases can be grouped into test suites, to allow
  79  *   subsets of the available tests to be run. Test suites can be
  80  *   grouped into other test suites as well.
  81  *
  82  * The API is designed to handle creation and registration of test suites
  83  * and test cases implicitly. A simple call like
  84  * |[&lt;!-- language=&quot;C&quot; --&gt;
  85  *   g_test_add_func (&quot;/misc/assertions&quot;, test_assertions);
  86  * ]|
  87  * creates a test suite called &quot;misc&quot; with a single test case named
  88  * &quot;assertions&quot;, which consists of running the test_assertions function.
  89  *
  90  * In addition to the traditional g_assert_true(), the test framework provides
  91  * an extended set of assertions for comparisons: g_assert_cmpfloat(),
  92  * g_assert_cmpfloat_with_epsilon(), g_assert_cmpint(), g_assert_cmpuint(),
<a name="5" id="anc5"></a><span class="line-modified">  93  * g_assert_cmphex(), g_assert_cmpstr(), g_assert_cmpmem() and</span>
<span class="line-added">  94  * g_assert_cmpvariant(). The</span>
  95  * advantage of these variants over plain g_assert_true() is that the assertion
  96  * messages can be more elaborate, and include the values of the compared
  97  * entities.
  98  *
  99  * Note that g_assert() should not be used in unit tests, since it is a no-op
 100  * when compiling with `G_DISABLE_ASSERT`. Use g_assert() in production code,
 101  * and g_assert_true() in unit tests.
 102  *
 103  * A full example of creating a test suite with two tests using fixtures:
 104  * |[&lt;!-- language=&quot;C&quot; --&gt;
 105  * #include &lt;glib.h&gt;
 106  * #include &lt;locale.h&gt;
 107  *
 108  * typedef struct {
 109  *   MyObject *obj;
 110  *   OtherObject *helper;
 111  * } MyObjectFixture;
 112  *
 113  * static void
 114  * my_object_fixture_set_up (MyObjectFixture *fixture,
 115  *                           gconstpointer user_data)
 116  * {
 117  *   fixture-&gt;obj = my_object_new ();
 118  *   my_object_set_prop1 (fixture-&gt;obj, &quot;some-value&quot;);
 119  *   my_object_do_some_complex_setup (fixture-&gt;obj, user_data);
 120  *
 121  *   fixture-&gt;helper = other_object_new ();
 122  * }
 123  *
 124  * static void
 125  * my_object_fixture_tear_down (MyObjectFixture *fixture,
 126  *                              gconstpointer user_data)
 127  * {
 128  *   g_clear_object (&amp;fixture-&gt;helper);
 129  *   g_clear_object (&amp;fixture-&gt;obj);
 130  * }
 131  *
 132  * static void
 133  * test_my_object_test1 (MyObjectFixture *fixture,
 134  *                       gconstpointer user_data)
 135  * {
 136  *   g_assert_cmpstr (my_object_get_property (fixture-&gt;obj), ==, &quot;initial-value&quot;);
 137  * }
 138  *
 139  * static void
 140  * test_my_object_test2 (MyObjectFixture *fixture,
 141  *                       gconstpointer user_data)
 142  * {
 143  *   my_object_do_some_work_using_helper (fixture-&gt;obj, fixture-&gt;helper);
 144  *   g_assert_cmpstr (my_object_get_property (fixture-&gt;obj), ==, &quot;updated-value&quot;);
 145  * }
 146  *
 147  * int
 148  * main (int argc, char *argv[])
 149  * {
 150  *   setlocale (LC_ALL, &quot;&quot;);
 151  *
 152  *   g_test_init (&amp;argc, &amp;argv, NULL);
<a name="6" id="anc6"></a>
 153  *
 154  *   // Define the tests.
 155  *   g_test_add (&quot;/my-object/test1&quot;, MyObjectFixture, &quot;some-user-data&quot;,
 156  *               my_object_fixture_set_up, test_my_object_test1,
 157  *               my_object_fixture_tear_down);
 158  *   g_test_add (&quot;/my-object/test2&quot;, MyObjectFixture, &quot;some-user-data&quot;,
 159  *               my_object_fixture_set_up, test_my_object_test2,
 160  *               my_object_fixture_tear_down);
 161  *
 162  *   return g_test_run ();
 163  * }
 164  * ]|
 165  *
 166  * ### Integrating GTest in your project
 167  *
 168  * If you are using the [Meson](http://mesonbuild.com) build system, you will
 169  * typically use the provided `test()` primitive to call the test binaries,
 170  * e.g.:
 171  *
 172  * |[&lt;!-- language=&quot;plain&quot; --&gt;
 173  *   test(
 174  *     &#39;foo&#39;,
 175  *     executable(&#39;foo&#39;, &#39;foo.c&#39;, dependencies: deps),
 176  *     env: [
 177  *       &#39;G_TEST_SRCDIR=@0@&#39;.format(meson.current_source_dir()),
 178  *       &#39;G_TEST_BUILDDIR=@0@&#39;.format(meson.current_build_dir()),
 179  *     ],
 180  *   )
 181  *
 182  *   test(
 183  *     &#39;bar&#39;,
 184  *     executable(&#39;bar&#39;, &#39;bar.c&#39;, dependencies: deps),
 185  *     env: [
 186  *       &#39;G_TEST_SRCDIR=@0@&#39;.format(meson.current_source_dir()),
 187  *       &#39;G_TEST_BUILDDIR=@0@&#39;.format(meson.current_build_dir()),
 188  *     ],
 189  *   )
 190  * ]|
 191  *
 192  * If you are using Autotools, you&#39;re strongly encouraged to use the Automake
 193  * [TAP](https://testanything.org/) harness; GLib provides template files for
 194  * easily integrating with it:
 195  *
<a name="7" id="anc7"></a><span class="line-modified"> 196  *   - [glib-tap.mk](https://gitlab.gnome.org/GNOME/glib/blob/glib-2-58/glib-tap.mk)</span>
<span class="line-modified"> 197  *   - [tap-test](https://gitlab.gnome.org/GNOME/glib/blob/glib-2-58/tap-test)</span>
<span class="line-modified"> 198  *   - [tap-driver.sh](https://gitlab.gnome.org/GNOME/glib/blob/glib-2-58/tap-driver.sh)</span>
 199  *
 200  * You can copy these files in your own project&#39;s root directory, and then
 201  * set up your `Makefile.am` file to reference them, for instance:
 202  *
 203  * |[&lt;!-- language=&quot;plain&quot; --&gt;
 204  * include $(top_srcdir)/glib-tap.mk
 205  *
 206  * # test binaries
 207  * test_programs = \
 208  *   foo \
 209  *   bar
 210  *
 211  * # data distributed in the tarball
 212  * dist_test_data = \
 213  *   foo.data.txt \
 214  *   bar.data.txt
 215  *
 216  * # data not distributed in the tarball
 217  * test_data = \
 218  *   blah.data.txt
 219  * ]|
 220  *
 221  * Make sure to distribute the TAP files, using something like the following
 222  * in your top-level `Makefile.am`:
 223  *
 224  * |[&lt;!-- language=&quot;plain&quot; --&gt;
 225  * EXTRA_DIST += \
 226  *   tap-driver.sh \
 227  *   tap-test
 228  * ]|
 229  *
 230  * `glib-tap.mk` will be distributed implicitly due to being included in a
 231  * `Makefile.am`. All three files should be added to version control.
 232  *
 233  * If you don&#39;t have access to the Autotools TAP harness, you can use the
 234  * [gtester][gtester] and [gtester-report][gtester-report] tools, and use
<a name="8" id="anc8"></a><span class="line-modified"> 235  * the [glib.mk](https://gitlab.gnome.org/GNOME/glib/blob/glib-2-58/glib.mk)</span>
<span class="line-modified"> 236  * Automake template provided by GLib. Note, however, that since GLib 2.62,</span>
<span class="line-added"> 237  * [gtester][gtester] and [gtester-report][gtester-report] have been deprecated</span>
<span class="line-added"> 238  * in favour of using TAP. The `--tap` argument to tests is enabled by default</span>
<span class="line-added"> 239  * as of GLib 2.62.</span>
 240  */
 241 
 242 /**
 243  * g_test_initialized:
 244  *
 245  * Returns %TRUE if g_test_init() has been called.
 246  *
 247  * Returns: %TRUE if g_test_init() has been called.
 248  *
 249  * Since: 2.36
 250  */
 251 
 252 /**
 253  * g_test_quick:
 254  *
 255  * Returns %TRUE if tests are run in quick mode.
 256  * Exactly one of g_test_quick() and g_test_slow() is active in any run;
 257  * there is no &quot;medium speed&quot;.
 258  *
 259  * By default, tests are run in quick mode. In tests that use
 260  * g_test_init(), the options `-m quick`, `-m slow` and `-m thorough`
 261  * can be used to change this.
 262  *
 263  * Returns: %TRUE if in quick mode
 264  */
 265 
 266 /**
 267  * g_test_slow:
 268  *
 269  * Returns %TRUE if tests are run in slow mode.
 270  * Exactly one of g_test_quick() and g_test_slow() is active in any run;
 271  * there is no &quot;medium speed&quot;.
 272  *
 273  * By default, tests are run in quick mode. In tests that use
 274  * g_test_init(), the options `-m quick`, `-m slow` and `-m thorough`
 275  * can be used to change this.
 276  *
 277  * Returns: the opposite of g_test_quick()
 278  */
 279 
 280 /**
 281  * g_test_thorough:
 282  *
 283  * Returns %TRUE if tests are run in thorough mode, equivalent to
 284  * g_test_slow().
 285  *
 286  * By default, tests are run in quick mode. In tests that use
 287  * g_test_init(), the options `-m quick`, `-m slow` and `-m thorough`
 288  * can be used to change this.
 289  *
 290  * Returns: the same thing as g_test_slow()
 291  */
 292 
 293 /**
 294  * g_test_perf:
 295  *
 296  * Returns %TRUE if tests are run in performance mode.
 297  *
 298  * By default, tests are run in quick mode. In tests that use
 299  * g_test_init(), the option `-m perf` enables performance tests, while
 300  * `-m quick` disables them.
 301  *
 302  * Returns: %TRUE if in performance mode
 303  */
 304 
 305 /**
 306  * g_test_undefined:
 307  *
 308  * Returns %TRUE if tests may provoke assertions and other formally-undefined
 309  * behaviour, to verify that appropriate warnings are given. It might, in some
 310  * cases, be useful to turn this off with if running tests under valgrind;
 311  * in tests that use g_test_init(), the option `-m no-undefined` disables
 312  * those tests, while `-m undefined` explicitly enables them (the default
 313  * behaviour).
 314  *
 315  * Returns: %TRUE if tests may provoke programming errors
 316  */
 317 
 318 /**
 319  * g_test_verbose:
 320  *
 321  * Returns %TRUE if tests are run in verbose mode.
 322  * In tests that use g_test_init(), the option `--verbose` enables this,
 323  * while `-q` or `--quiet` disables it.
 324  * The default is neither g_test_verbose() nor g_test_quiet().
 325  *
 326  * Returns: %TRUE if in verbose mode
 327  */
 328 
 329 /**
 330  * g_test_quiet:
 331  *
 332  * Returns %TRUE if tests are run in quiet mode.
 333  * In tests that use g_test_init(), the option `-q` or `--quiet` enables
 334  * this, while `--verbose` disables it.
 335  * The default is neither g_test_verbose() nor g_test_quiet().
 336  *
 337  * Returns: %TRUE if in quiet mode
 338  */
 339 
 340 /**
 341  * g_test_queue_unref:
 342  * @gobject: the object to unref
 343  *
 344  * Enqueue an object to be released with g_object_unref() during
 345  * the next teardown phase. This is equivalent to calling
 346  * g_test_queue_destroy() with a destroy callback of g_object_unref().
 347  *
 348  * Since: 2.16
 349  */
 350 
<a name="9" id="anc9"></a>





















 351 /**
 352  * GTestSubprocessFlags:
 353  * @G_TEST_SUBPROCESS_INHERIT_STDIN: If this flag is given, the child
 354  *     process will inherit the parent&#39;s stdin. Otherwise, the child&#39;s
 355  *     stdin is redirected to `/dev/null`.
 356  * @G_TEST_SUBPROCESS_INHERIT_STDOUT: If this flag is given, the child
 357  *     process will inherit the parent&#39;s stdout. Otherwise, the child&#39;s
 358  *     stdout will not be visible, but it will be captured to allow
 359  *     later tests with g_test_trap_assert_stdout().
 360  * @G_TEST_SUBPROCESS_INHERIT_STDERR: If this flag is given, the child
 361  *     process will inherit the parent&#39;s stderr. Otherwise, the child&#39;s
 362  *     stderr will not be visible, but it will be captured to allow
 363  *     later tests with g_test_trap_assert_stderr().
 364  *
 365  * Flags to pass to g_test_trap_subprocess() to control input and output.
 366  *
 367  * Note that in contrast with g_test_trap_fork(), the default is to
 368  * not show stdout and stderr.
 369  */
 370 
 371 /**
 372  * g_test_trap_assert_passed:
 373  *
 374  * Assert that the last test subprocess passed.
 375  * See g_test_trap_subprocess().
 376  *
 377  * Since: 2.16
 378  */
 379 
 380 /**
 381  * g_test_trap_assert_failed:
 382  *
 383  * Assert that the last test subprocess failed.
 384  * See g_test_trap_subprocess().
 385  *
 386  * This is sometimes used to test situations that are formally considered to
 387  * be undefined behaviour, like inputs that fail a g_return_if_fail()
 388  * check. In these situations you should skip the entire test, including the
 389  * call to g_test_trap_subprocess(), unless g_test_undefined() returns %TRUE
 390  * to indicate that undefined behaviour may be tested.
 391  *
 392  * Since: 2.16
 393  */
 394 
 395 /**
 396  * g_test_trap_assert_stdout:
 397  * @soutpattern: a glob-style [pattern][glib-Glob-style-pattern-matching]
 398  *
 399  * Assert that the stdout output of the last test subprocess matches
 400  * @soutpattern. See g_test_trap_subprocess().
 401  *
 402  * Since: 2.16
 403  */
 404 
 405 /**
 406  * g_test_trap_assert_stdout_unmatched:
 407  * @soutpattern: a glob-style [pattern][glib-Glob-style-pattern-matching]
 408  *
 409  * Assert that the stdout output of the last test subprocess
 410  * does not match @soutpattern. See g_test_trap_subprocess().
 411  *
 412  * Since: 2.16
 413  */
 414 
 415 /**
 416  * g_test_trap_assert_stderr:
 417  * @serrpattern: a glob-style [pattern][glib-Glob-style-pattern-matching]
 418  *
 419  * Assert that the stderr output of the last test subprocess
 420  * matches @serrpattern. See  g_test_trap_subprocess().
 421  *
 422  * This is sometimes used to test situations that are formally
 423  * considered to be undefined behaviour, like code that hits a
 424  * g_assert() or g_error(). In these situations you should skip the
 425  * entire test, including the call to g_test_trap_subprocess(), unless
 426  * g_test_undefined() returns %TRUE to indicate that undefined
 427  * behaviour may be tested.
 428  *
 429  * Since: 2.16
 430  */
 431 
 432 /**
 433  * g_test_trap_assert_stderr_unmatched:
 434  * @serrpattern: a glob-style [pattern][glib-Glob-style-pattern-matching]
 435  *
 436  * Assert that the stderr output of the last test subprocess
 437  * does not match @serrpattern. See g_test_trap_subprocess().
 438  *
 439  * Since: 2.16
 440  */
 441 
 442 /**
 443  * g_test_rand_bit:
 444  *
 445  * Get a reproducible random bit (0 or 1), see g_test_rand_int()
 446  * for details on test case random numbers.
 447  *
 448  * Since: 2.16
 449  */
 450 
 451 /**
 452  * g_assert:
 453  * @expr: the expression to check
 454  *
 455  * Debugging macro to terminate the application if the assertion
 456  * fails. If the assertion fails (i.e. the expression is not true),
 457  * an error message is logged and the application is terminated.
 458  *
 459  * The macro can be turned off in final releases of code by defining
 460  * `G_DISABLE_ASSERT` when compiling the application, so code must
 461  * not depend on any side effects from @expr. Similarly, it must not be used
 462  * in unit tests, otherwise the unit tests will be ineffective if compiled with
 463  * `G_DISABLE_ASSERT`. Use g_assert_true() and related macros in unit tests
 464  * instead.
 465  */
 466 
 467 /**
 468  * g_assert_not_reached:
 469  *
 470  * Debugging macro to terminate the application if it is ever
 471  * reached. If it is reached, an error message is logged and the
 472  * application is terminated.
 473  *
 474  * The macro can be turned off in final releases of code by defining
 475  * `G_DISABLE_ASSERT` when compiling the application. Hence, it should not be
 476  * used in unit tests, where assertions should always be effective.
 477  */
 478 
 479 /**
 480  * g_assert_true:
 481  * @expr: the expression to check
 482  *
 483  * Debugging macro to check that an expression is true.
 484  *
 485  * If the assertion fails (i.e. the expression is not true),
 486  * an error message is logged and the application is either
 487  * terminated or the testcase marked as failed.
 488  *
 489  * Note that unlike g_assert(), this macro is unaffected by whether
 490  * `G_DISABLE_ASSERT` is defined. Hence it should only be used in tests and,
 491  * conversely, g_assert() should not be used in tests.
 492  *
 493  * See g_test_set_nonfatal_assertions().
 494  *
 495  * Since: 2.38
 496  */
 497 
 498 /**
 499  * g_assert_false:
 500  * @expr: the expression to check
 501  *
 502  * Debugging macro to check an expression is false.
 503  *
 504  * If the assertion fails (i.e. the expression is not false),
 505  * an error message is logged and the application is either
 506  * terminated or the testcase marked as failed.
 507  *
 508  * Note that unlike g_assert(), this macro is unaffected by whether
 509  * `G_DISABLE_ASSERT` is defined. Hence it should only be used in tests and,
 510  * conversely, g_assert() should not be used in tests.
 511  *
 512  * See g_test_set_nonfatal_assertions().
 513  *
 514  * Since: 2.38
 515  */
 516 
 517 /**
 518  * g_assert_null:
 519  * @expr: the expression to check
 520  *
 521  * Debugging macro to check an expression is %NULL.
 522  *
 523  * If the assertion fails (i.e. the expression is not %NULL),
 524  * an error message is logged and the application is either
 525  * terminated or the testcase marked as failed.
 526  *
 527  * Note that unlike g_assert(), this macro is unaffected by whether
 528  * `G_DISABLE_ASSERT` is defined. Hence it should only be used in tests and,
 529  * conversely, g_assert() should not be used in tests.
 530  *
 531  * See g_test_set_nonfatal_assertions().
 532  *
 533  * Since: 2.38
 534  */
 535 
 536 /**
 537  * g_assert_nonnull:
 538  * @expr: the expression to check
 539  *
 540  * Debugging macro to check an expression is not %NULL.
 541  *
 542  * If the assertion fails (i.e. the expression is %NULL),
 543  * an error message is logged and the application is either
 544  * terminated or the testcase marked as failed.
 545  *
 546  * Note that unlike g_assert(), this macro is unaffected by whether
 547  * `G_DISABLE_ASSERT` is defined. Hence it should only be used in tests and,
 548  * conversely, g_assert() should not be used in tests.
 549  *
 550  * See g_test_set_nonfatal_assertions().
 551  *
 552  * Since: 2.40
 553  */
 554 
 555 /**
 556  * g_assert_cmpstr:
 557  * @s1: a string (may be %NULL)
 558  * @cmp: The comparison operator to use.
<a name="10" id="anc10"></a><span class="line-modified"> 559  *     One of `==`, `!=`, `&lt;`, `&gt;`, `&lt;=`, `&gt;=`.</span>
 560  * @s2: another string (may be %NULL)
 561  *
 562  * Debugging macro to compare two strings. If the comparison fails,
 563  * an error message is logged and the application is either terminated
 564  * or the testcase marked as failed.
 565  * The strings are compared using g_strcmp0().
 566  *
 567  * The effect of `g_assert_cmpstr (s1, op, s2)` is
 568  * the same as `g_assert_true (g_strcmp0 (s1, s2) op 0)`.
 569  * The advantage of this macro is that it can produce a message that
 570  * includes the actual values of @s1 and @s2.
 571  *
 572  * |[&lt;!-- language=&quot;C&quot; --&gt;
 573  *   g_assert_cmpstr (mystring, ==, &quot;fubar&quot;);
 574  * ]|
 575  *
 576  * Since: 2.16
 577  */
 578 
 579 /**
 580  * g_assert_cmpint:
 581  * @n1: an integer
 582  * @cmp: The comparison operator to use.
<a name="11" id="anc11"></a><span class="line-modified"> 583  *     One of `==`, `!=`, `&lt;`, `&gt;`, `&lt;=`, `&gt;=`.</span>
 584  * @n2: another integer
 585  *
 586  * Debugging macro to compare two integers.
 587  *
 588  * The effect of `g_assert_cmpint (n1, op, n2)` is
 589  * the same as `g_assert_true (n1 op n2)`. The advantage
 590  * of this macro is that it can produce a message that includes the
 591  * actual values of @n1 and @n2.
 592  *
 593  * Since: 2.16
 594  */
 595 
 596 /**
 597  * g_assert_cmpuint:
 598  * @n1: an unsigned integer
 599  * @cmp: The comparison operator to use.
<a name="12" id="anc12"></a><span class="line-modified"> 600  *     One of `==`, `!=`, `&lt;`, `&gt;`, `&lt;=`, `&gt;=`.</span>
 601  * @n2: another unsigned integer
 602  *
 603  * Debugging macro to compare two unsigned integers.
 604  *
 605  * The effect of `g_assert_cmpuint (n1, op, n2)` is
 606  * the same as `g_assert_true (n1 op n2)`. The advantage
 607  * of this macro is that it can produce a message that includes the
 608  * actual values of @n1 and @n2.
 609  *
 610  * Since: 2.16
 611  */
 612 
 613 /**
 614  * g_assert_cmphex:
 615  * @n1: an unsigned integer
 616  * @cmp: The comparison operator to use.
<a name="13" id="anc13"></a><span class="line-modified"> 617  *     One of `==`, `!=`, `&lt;`, `&gt;`, `&lt;=`, `&gt;=`.</span>
 618  * @n2: another unsigned integer
 619  *
 620  * Debugging macro to compare to unsigned integers.
 621  *
 622  * This is a variant of g_assert_cmpuint() that displays the numbers
 623  * in hexadecimal notation in the message.
 624  *
 625  * Since: 2.16
 626  */
 627 
 628 /**
 629  * g_assert_cmpfloat:
<a name="14" id="anc14"></a><span class="line-modified"> 630  * @n1: a floating point number</span>
 631  * @cmp: The comparison operator to use.
<a name="15" id="anc15"></a><span class="line-modified"> 632  *     One of `==`, `!=`, `&lt;`, `&gt;`, `&lt;=`, `&gt;=`.</span>
 633  * @n2: another floating point number
 634  *
 635  * Debugging macro to compare two floating point numbers.
 636  *
 637  * The effect of `g_assert_cmpfloat (n1, op, n2)` is
 638  * the same as `g_assert_true (n1 op n2)`. The advantage
 639  * of this macro is that it can produce a message that includes the
 640  * actual values of @n1 and @n2.
 641  *
 642  * Since: 2.16
 643  */
 644 
 645 /**
 646  * g_assert_cmpfloat_with_epsilon:
<a name="16" id="anc16"></a><span class="line-modified"> 647  * @n1: a floating point number</span>
 648  * @n2: another floating point number
 649  * @epsilon: a numeric value that expresses the expected tolerance
 650  *   between @n1 and @n2
 651  *
 652  * Debugging macro to compare two floating point numbers within an epsilon.
 653  *
 654  * The effect of `g_assert_cmpfloat_with_epsilon (n1, n2, epsilon)` is
 655  * the same as `g_assert_true (abs (n1 - n2) &lt; epsilon)`. The advantage
 656  * of this macro is that it can produce a message that includes the
 657  * actual values of @n1 and @n2.
 658  *
 659  * Since: 2.58
 660  */
 661 
 662 /**
 663  * g_assert_cmpmem:
 664  * @m1: pointer to a buffer
 665  * @l1: length of @m1
 666  * @m2: pointer to another buffer
 667  * @l2: length of @m2
 668  *
 669  * Debugging macro to compare memory regions. If the comparison fails,
 670  * an error message is logged and the application is either terminated
 671  * or the testcase marked as failed.
 672  *
 673  * The effect of `g_assert_cmpmem (m1, l1, m2, l2)` is
 674  * the same as `g_assert_true (l1 == l2 &amp;&amp; memcmp (m1, m2, l1) == 0)`.
 675  * The advantage of this macro is that it can produce a message that
 676  * includes the actual values of @l1 and @l2.
 677  *
 678  * |[&lt;!-- language=&quot;C&quot; --&gt;
 679  *   g_assert_cmpmem (buf-&gt;data, buf-&gt;len, expected, sizeof (expected));
 680  * ]|
 681  *
 682  * Since: 2.46
 683  */
 684 
<a name="17" id="anc17"></a><span class="line-added"> 685 /**</span>
<span class="line-added"> 686  * g_assert_cmpvariant:</span>
<span class="line-added"> 687  * @v1: pointer to a #GVariant</span>
<span class="line-added"> 688  * @v2: pointer to another #GVariant</span>
<span class="line-added"> 689  *</span>
<span class="line-added"> 690  * Debugging macro to compare two #GVariants. If the comparison fails,</span>
<span class="line-added"> 691  * an error message is logged and the application is either terminated</span>
<span class="line-added"> 692  * or the testcase marked as failed. The variants are compared using</span>
<span class="line-added"> 693  * g_variant_equal().</span>
<span class="line-added"> 694  *</span>
<span class="line-added"> 695  * The effect of `g_assert_cmpvariant (v1, v2)` is the same as</span>
<span class="line-added"> 696  * `g_assert_true (g_variant_equal (v1, v2))`. The advantage of this macro is</span>
<span class="line-added"> 697  * that it can produce a message that includes the actual values of @v1 and @v2.</span>
<span class="line-added"> 698  *</span>
<span class="line-added"> 699  * Since: 2.60</span>
<span class="line-added"> 700  */</span>
<span class="line-added"> 701 </span>
 702 /**
 703  * g_assert_no_error:
 704  * @err: a #GError, possibly %NULL
 705  *
 706  * Debugging macro to check that a #GError is not set.
 707  *
 708  * The effect of `g_assert_no_error (err)` is
 709  * the same as `g_assert_true (err == NULL)`. The advantage
 710  * of this macro is that it can produce a message that includes
 711  * the error message and code.
 712  *
 713  * Since: 2.20
 714  */
 715 
 716 /**
 717  * g_assert_error:
 718  * @err: a #GError, possibly %NULL
 719  * @dom: the expected error domain (a #GQuark)
 720  * @c: the expected error code
 721  *
 722  * Debugging macro to check that a method has returned
 723  * the correct #GError.
 724  *
 725  * The effect of `g_assert_error (err, dom, c)` is
 726  * the same as `g_assert_true (err != NULL &amp;&amp; err-&gt;domain
 727  * == dom &amp;&amp; err-&gt;code == c)`. The advantage of this
 728  * macro is that it can produce a message that includes the incorrect
 729  * error message and code.
 730  *
 731  * This can only be used to test for a specific error. If you want to
 732  * test that @err is set, but don&#39;t care what it&#39;s set to, just use
<a name="18" id="anc18"></a><span class="line-modified"> 733  * `g_assert_nonnull (err)`.</span>
 734  *
 735  * Since: 2.20
 736  */
 737 
 738 /**
 739  * GTestCase:
 740  *
 741  * An opaque structure representing a test case.
 742  */
 743 
 744 /**
 745  * GTestSuite:
 746  *
 747  * An opaque structure representing a test suite.
 748  */
 749 
 750 
 751 /* Global variable for storing assertion messages; this is the counterpart to
 752  * glibc&#39;s (private) __abort_msg variable, and allows developers and crash
 753  * analysis systems like Apport and ABRT to fish out assertion messages from
 754  * core dumps, instead of having to catch them on screen output.
 755  */
 756 GLIB_VAR char *__glib_assert_msg;
 757 char *__glib_assert_msg = NULL;
 758 
 759 /* --- constants --- */
 760 #define G_TEST_STATUS_TIMED_OUT 1024
 761 
 762 /* --- structures --- */
 763 struct GTestCase
 764 {
 765   gchar  *name;
 766   guint   fixture_size;
 767   void   (*fixture_setup)    (void*, gconstpointer);
 768   void   (*fixture_test)     (void*, gconstpointer);
 769   void   (*fixture_teardown) (void*, gconstpointer);
 770   gpointer test_data;
 771 };
 772 struct GTestSuite
 773 {
 774   gchar  *name;
 775   GSList *suites;
 776   GSList *cases;
 777 };
 778 typedef struct DestroyEntry DestroyEntry;
 779 struct DestroyEntry
 780 {
 781   DestroyEntry *next;
 782   GDestroyNotify destroy_func;
 783   gpointer       destroy_data;
 784 };
 785 
 786 /* --- prototypes --- */
 787 static void     test_run_seed                   (const gchar *rseed);
 788 static void     test_trap_clear                 (void);
 789 static guint8*  g_test_log_dump                 (GTestLogMsg *msg,
 790                                                  guint       *len);
 791 static void     gtest_default_log_handler       (const gchar    *log_domain,
 792                                                  GLogLevelFlags  log_level,
 793                                                  const gchar    *message,
 794                                                  gpointer        unused_data);
 795 
 796 
 797 static const char * const g_test_result_names[] = {
 798   &quot;OK&quot;,
 799   &quot;SKIP&quot;,
 800   &quot;FAIL&quot;,
 801   &quot;TODO&quot;
 802 };
 803 
 804 /* --- variables --- */
 805 static int         test_log_fd = -1;
 806 static gboolean    test_mode_fatal = TRUE;
 807 static gboolean    g_test_run_once = TRUE;
<a name="19" id="anc19"></a><span class="line-added"> 808 static gboolean    test_isolate_dirs = FALSE;</span>
<span class="line-added"> 809 static gchar      *test_isolate_dirs_tmpdir = NULL;</span>
<span class="line-added"> 810 static const gchar *test_tmpdir = NULL;</span>
 811 static gboolean    test_run_list = FALSE;
 812 static gchar      *test_run_seedstr = NULL;
<a name="20" id="anc20"></a><span class="line-added"> 813 G_LOCK_DEFINE_STATIC (test_run_rand);</span>
 814 static GRand      *test_run_rand = NULL;
 815 static gchar      *test_run_name = &quot;&quot;;
 816 static GSList    **test_filename_free_list;
 817 static guint       test_run_forks = 0;
 818 static guint       test_run_count = 0;
 819 static guint       test_count = 0;
 820 static guint       test_skipped_count = 0;
 821 static GTestResult test_run_success = G_TEST_RUN_FAILURE;
 822 static gchar      *test_run_msg = NULL;
 823 static guint       test_startup_skip_count = 0;
 824 static GTimer     *test_user_timer = NULL;
 825 static double      test_user_stamp = 0;
 826 static GSList     *test_paths = NULL;
 827 static GSList     *test_paths_skipped = NULL;
 828 static GTestSuite *test_suite_root = NULL;
 829 static int         test_trap_last_status = 0;  /* unmodified platform-specific status */
 830 static GPid        test_trap_last_pid = 0;
 831 static char       *test_trap_last_subprocess = NULL;
 832 static char       *test_trap_last_stdout = NULL;
 833 static char       *test_trap_last_stderr = NULL;
 834 static char       *test_uri_base = NULL;
 835 static gboolean    test_debug_log = FALSE;
<a name="21" id="anc21"></a><span class="line-modified"> 836 static gboolean    test_tap_log = TRUE;  /* default to TAP as of GLib 2.62; see #1619; the non-TAP output mode is deprecated */</span>
 837 static gboolean    test_nonfatal_assertions = FALSE;
 838 static DestroyEntry *test_destroy_queue = NULL;
 839 static char       *test_argv0 = NULL;
 840 static char       *test_argv0_dirname;
 841 static const char *test_disted_files_dir;
 842 static const char *test_built_files_dir;
 843 static char       *test_initial_cwd = NULL;
 844 static gboolean    test_in_forked_child = FALSE;
 845 static gboolean    test_in_subprocess = FALSE;
 846 static GTestConfig mutable_test_config_vars = {
 847   FALSE,        /* test_initialized */
 848   TRUE,         /* test_quick */
 849   FALSE,        /* test_perf */
 850   FALSE,        /* test_verbose */
 851   FALSE,        /* test_quiet */
 852   TRUE,         /* test_undefined */
 853 };
 854 const GTestConfig * const g_test_config_vars = &amp;mutable_test_config_vars;
 855 static gboolean  no_g_set_prgname = FALSE;
 856 
 857 /* --- functions --- */
 858 const char*
 859 g_test_log_type_name (GTestLogType log_type)
 860 {
 861   switch (log_type)
 862     {
 863     case G_TEST_LOG_NONE:               return &quot;none&quot;;
 864     case G_TEST_LOG_ERROR:              return &quot;error&quot;;
 865     case G_TEST_LOG_START_BINARY:       return &quot;binary&quot;;
 866     case G_TEST_LOG_LIST_CASE:          return &quot;list&quot;;
 867     case G_TEST_LOG_SKIP_CASE:          return &quot;skip&quot;;
 868     case G_TEST_LOG_START_CASE:         return &quot;start&quot;;
 869     case G_TEST_LOG_STOP_CASE:          return &quot;stop&quot;;
 870     case G_TEST_LOG_MIN_RESULT:         return &quot;minperf&quot;;
 871     case G_TEST_LOG_MAX_RESULT:         return &quot;maxperf&quot;;
 872     case G_TEST_LOG_MESSAGE:            return &quot;message&quot;;
 873     case G_TEST_LOG_START_SUITE:        return &quot;start suite&quot;;
 874     case G_TEST_LOG_STOP_SUITE:         return &quot;stop suite&quot;;
 875     }
 876   return &quot;???&quot;;
 877 }
 878 
 879 static void
 880 g_test_log_send (guint         n_bytes,
 881                  const guint8 *buffer)
 882 {
 883   if (test_log_fd &gt;= 0)
 884     {
 885       int r;
 886       do
 887         r = write (test_log_fd, buffer, n_bytes);
 888       while (r &lt; 0 &amp;&amp; errno == EINTR);
 889     }
 890   if (test_debug_log)
 891     {
 892       GTestLogBuffer *lbuffer = g_test_log_buffer_new ();
 893       GTestLogMsg *msg;
 894       guint ui;
 895       g_test_log_buffer_push (lbuffer, n_bytes, buffer);
 896       msg = g_test_log_buffer_pop (lbuffer);
 897       g_warn_if_fail (msg != NULL);
 898       g_warn_if_fail (lbuffer-&gt;data-&gt;len == 0);
 899       g_test_log_buffer_free (lbuffer);
 900       /* print message */
 901       g_printerr (&quot;{*LOG(%s)&quot;, g_test_log_type_name (msg-&gt;log_type));
 902       for (ui = 0; ui &lt; msg-&gt;n_strings; ui++)
 903         g_printerr (&quot;:{%s}&quot;, msg-&gt;strings[ui]);
 904       if (msg-&gt;n_nums)
 905         {
 906           g_printerr (&quot;:(&quot;);
 907           for (ui = 0; ui &lt; msg-&gt;n_nums; ui++)
 908             {
 909               if ((long double) (long) msg-&gt;nums[ui] == msg-&gt;nums[ui])
 910                 g_printerr (&quot;%s%ld&quot;, ui ? &quot;;&quot; : &quot;&quot;, (long) msg-&gt;nums[ui]);
 911               else
 912                 g_printerr (&quot;%s%.16g&quot;, ui ? &quot;;&quot; : &quot;&quot;, (double) msg-&gt;nums[ui]);
 913             }
 914           g_printerr (&quot;)&quot;);
 915         }
 916       g_printerr (&quot;:LOG*}\n&quot;);
 917       g_test_log_msg_free (msg);
 918     }
 919 }
 920 
 921 static void
 922 g_test_log (GTestLogType lbit,
 923             const gchar *string1,
 924             const gchar *string2,
 925             guint        n_args,
 926             long double *largs)
 927 {
 928   GTestResult result;
 929   gboolean fail;
 930   GTestLogMsg msg;
 931   gchar *astrings[3] = { NULL, NULL, NULL };
 932   guint8 *dbuffer;
 933   guint32 dbufferlen;
 934 
 935   switch (lbit)
 936     {
 937     case G_TEST_LOG_START_BINARY:
 938       if (test_tap_log)
 939         g_print (&quot;# random seed: %s\n&quot;, string2);
 940       else if (g_test_verbose ())
 941         g_print (&quot;GTest: random seed: %s\n&quot;, string2);
 942       break;
 943     case G_TEST_LOG_START_SUITE:
 944       if (test_tap_log)
 945         {
<a name="22" id="anc22"></a><span class="line-added"> 946           /* We only print the TAP &quot;plan&quot; (1..n) ahead of time if we did</span>
<span class="line-added"> 947            * not use the -p option to select specific tests to be run. */</span>
 948           if (string1[0] != 0)
 949             g_print (&quot;# Start of %s tests\n&quot;, string1);
<a name="23" id="anc23"></a><span class="line-modified"> 950           else if (test_paths == NULL)</span>
 951             g_print (&quot;1..%d\n&quot;, test_count);
 952         }
 953       break;
 954     case G_TEST_LOG_STOP_SUITE:
 955       if (test_tap_log)
 956         {
<a name="24" id="anc24"></a><span class="line-added"> 957           /* If we didn&#39;t print the TAP &quot;plan&quot; at the beginning because</span>
<span class="line-added"> 958            * we were using -p, we need to print how many tests we ran at</span>
<span class="line-added"> 959            * the end instead. */</span>
 960           if (string1[0] != 0)
 961             g_print (&quot;# End of %s tests\n&quot;, string1);
<a name="25" id="anc25"></a><span class="line-added"> 962           else if (test_paths != NULL)</span>
<span class="line-added"> 963             g_print (&quot;1..%d\n&quot;, test_run_count);</span>
 964         }
 965       break;
 966     case G_TEST_LOG_STOP_CASE:
 967       result = largs[0];
 968       fail = result == G_TEST_RUN_FAILURE;
 969       if (test_tap_log)
 970         {
 971           const gchar *ok;
 972 
 973           /* The TAP representation for an expected failure starts with
 974            * &quot;not ok&quot;, even though it does not actually count as failing
 975            * due to the use of the TODO directive. &quot;ok # TODO&quot; would mean
 976            * a test that was expected to fail unexpectedly succeeded,
 977            * for which GTestResult does not currently have a
 978            * representation. */
 979           if (fail || result == G_TEST_RUN_INCOMPLETE)
 980             ok = &quot;not ok&quot;;
 981           else
 982             ok = &quot;ok&quot;;
 983 
 984           g_print (&quot;%s %d %s&quot;, ok, test_run_count, string1);
 985           if (result == G_TEST_RUN_INCOMPLETE)
 986             g_print (&quot; # TODO %s\n&quot;, string2 ? string2 : &quot;&quot;);
 987           else if (result == G_TEST_RUN_SKIPPED)
 988             g_print (&quot; # SKIP %s\n&quot;, string2 ? string2 : &quot;&quot;);
 989           else
 990             g_print (&quot;\n&quot;);
 991         }
 992       else if (g_test_verbose ())
 993         g_print (&quot;GTest: result: %s\n&quot;, g_test_result_names[result]);
 994       else if (!g_test_quiet ())
 995         g_print (&quot;%s\n&quot;, g_test_result_names[result]);
 996       if (fail &amp;&amp; test_mode_fatal)
 997         {
 998           if (test_tap_log)
 999             g_print (&quot;Bail out!\n&quot;);
1000           g_abort ();
1001         }
1002       if (result == G_TEST_RUN_SKIPPED || result == G_TEST_RUN_INCOMPLETE)
1003         test_skipped_count++;
1004       break;
<a name="26" id="anc26"></a><span class="line-added">1005     case G_TEST_LOG_SKIP_CASE:</span>
<span class="line-added">1006       if (test_tap_log)</span>
<span class="line-added">1007           g_print (&quot;ok %d %s # SKIP\n&quot;, test_run_count, string1);</span>
<span class="line-added">1008       break;</span>
1009     case G_TEST_LOG_MIN_RESULT:
1010       if (test_tap_log)
1011         g_print (&quot;# min perf: %s\n&quot;, string1);
1012       else if (g_test_verbose ())
1013         g_print (&quot;(MINPERF:%s)\n&quot;, string1);
1014       break;
1015     case G_TEST_LOG_MAX_RESULT:
1016       if (test_tap_log)
1017         g_print (&quot;# max perf: %s\n&quot;, string1);
1018       else if (g_test_verbose ())
1019         g_print (&quot;(MAXPERF:%s)\n&quot;, string1);
1020       break;
1021     case G_TEST_LOG_MESSAGE:
1022       if (test_tap_log)
1023         g_print (&quot;# %s\n&quot;, string1);
1024       else if (g_test_verbose ())
1025         g_print (&quot;(MSG: %s)\n&quot;, string1);
1026       break;
1027     case G_TEST_LOG_ERROR:
1028       if (test_tap_log)
1029         g_print (&quot;Bail out! %s\n&quot;, string1);
1030       else if (g_test_verbose ())
1031         g_print (&quot;(ERROR: %s)\n&quot;, string1);
1032       break;
1033     default: ;
1034     }
1035 
1036   msg.log_type = lbit;
1037   msg.n_strings = (string1 != NULL) + (string1 &amp;&amp; string2);
1038   msg.strings = astrings;
1039   astrings[0] = (gchar*) string1;
1040   astrings[1] = astrings[0] ? (gchar*) string2 : NULL;
1041   msg.n_nums = n_args;
1042   msg.nums = largs;
1043   dbuffer = g_test_log_dump (&amp;msg, &amp;dbufferlen);
1044   g_test_log_send (dbufferlen, dbuffer);
1045   g_free (dbuffer);
1046 
1047   switch (lbit)
1048     {
1049     case G_TEST_LOG_START_CASE:
1050       if (test_tap_log)
1051         ;
1052       else if (g_test_verbose ())
1053         g_print (&quot;GTest: run: %s\n&quot;, string1);
1054       else if (!g_test_quiet ())
1055         g_print (&quot;%s: &quot;, string1);
1056       break;
1057     default: ;
1058     }
1059 }
1060 
1061 /* We intentionally parse the command line without GOptionContext
1062  * because otherwise you would never be able to test it.
1063  */
1064 static void
1065 parse_args (gint    *argc_p,
1066             gchar ***argv_p)
1067 {
1068   guint argc = *argc_p;
1069   gchar **argv = *argv_p;
1070   guint i, e;
1071 
1072   test_argv0 = argv[0];
1073   test_initial_cwd = g_get_current_dir ();
1074 
1075   /* parse known args */
1076   for (i = 1; i &lt; argc; i++)
1077     {
1078       if (strcmp (argv[i], &quot;--g-fatal-warnings&quot;) == 0)
1079         {
1080           GLogLevelFlags fatal_mask = (GLogLevelFlags) g_log_set_always_fatal ((GLogLevelFlags) G_LOG_FATAL_MASK);
1081           fatal_mask = (GLogLevelFlags) (fatal_mask | G_LOG_LEVEL_WARNING | G_LOG_LEVEL_CRITICAL);
1082           g_log_set_always_fatal (fatal_mask);
1083           argv[i] = NULL;
1084         }
1085       else if (strcmp (argv[i], &quot;--keep-going&quot;) == 0 ||
1086                strcmp (argv[i], &quot;-k&quot;) == 0)
1087         {
1088           test_mode_fatal = FALSE;
1089           argv[i] = NULL;
1090         }
1091       else if (strcmp (argv[i], &quot;--debug-log&quot;) == 0)
1092         {
1093           test_debug_log = TRUE;
1094           argv[i] = NULL;
1095         }
1096       else if (strcmp (argv[i], &quot;--tap&quot;) == 0)
1097         {
1098           test_tap_log = TRUE;
1099           argv[i] = NULL;
1100         }
1101       else if (strcmp (&quot;--GTestLogFD&quot;, argv[i]) == 0 || strncmp (&quot;--GTestLogFD=&quot;, argv[i], 13) == 0)
1102         {
1103           gchar *equal = argv[i] + 12;
1104           if (*equal == &#39;=&#39;)
1105             test_log_fd = g_ascii_strtoull (equal + 1, NULL, 0);
1106           else if (i + 1 &lt; argc)
1107             {
1108               argv[i++] = NULL;
1109               test_log_fd = g_ascii_strtoull (argv[i], NULL, 0);
1110             }
1111           argv[i] = NULL;
<a name="27" id="anc27"></a><span class="line-added">1112 </span>
<span class="line-added">1113           /* Force non-TAP output when using gtester */</span>
<span class="line-added">1114           test_tap_log = FALSE;</span>
1115         }
1116       else if (strcmp (&quot;--GTestSkipCount&quot;, argv[i]) == 0 || strncmp (&quot;--GTestSkipCount=&quot;, argv[i], 17) == 0)
1117         {
1118           gchar *equal = argv[i] + 16;
1119           if (*equal == &#39;=&#39;)
1120             test_startup_skip_count = g_ascii_strtoull (equal + 1, NULL, 0);
1121           else if (i + 1 &lt; argc)
1122             {
1123               argv[i++] = NULL;
1124               test_startup_skip_count = g_ascii_strtoull (argv[i], NULL, 0);
1125             }
1126           argv[i] = NULL;
1127         }
1128       else if (strcmp (&quot;--GTestSubprocess&quot;, argv[i]) == 0)
1129         {
1130           test_in_subprocess = TRUE;
1131           /* We typically expect these child processes to crash, and some
1132            * tests spawn a *lot* of them.  Avoid spamming system crash
1133            * collection programs such as systemd-coredump and abrt.
1134            */
1135 #ifdef HAVE_SYS_RESOURCE_H
1136           {
1137             struct rlimit limit = { 0, 0 };
1138             (void) setrlimit (RLIMIT_CORE, &amp;limit);
1139           }
1140 #endif
1141           argv[i] = NULL;
<a name="28" id="anc28"></a><span class="line-added">1142 </span>
<span class="line-added">1143           /* Force non-TAP output when spawning a subprocess, since people often</span>
<span class="line-added">1144            * test the stdout/stderr of the subprocess strictly */</span>
<span class="line-added">1145           test_tap_log = FALSE;</span>
1146         }
1147       else if (strcmp (&quot;-p&quot;, argv[i]) == 0 || strncmp (&quot;-p=&quot;, argv[i], 3) == 0)
1148         {
1149           gchar *equal = argv[i] + 2;
1150           if (*equal == &#39;=&#39;)
1151             test_paths = g_slist_prepend (test_paths, equal + 1);
1152           else if (i + 1 &lt; argc)
1153             {
1154               argv[i++] = NULL;
1155               test_paths = g_slist_prepend (test_paths, argv[i]);
1156             }
1157           argv[i] = NULL;
1158         }
1159       else if (strcmp (&quot;-s&quot;, argv[i]) == 0 || strncmp (&quot;-s=&quot;, argv[i], 3) == 0)
1160         {
1161           gchar *equal = argv[i] + 2;
1162           if (*equal == &#39;=&#39;)
1163             test_paths_skipped = g_slist_prepend (test_paths_skipped, equal + 1);
1164           else if (i + 1 &lt; argc)
1165             {
1166               argv[i++] = NULL;
1167               test_paths_skipped = g_slist_prepend (test_paths_skipped, argv[i]);
1168             }
1169           argv[i] = NULL;
1170         }
1171       else if (strcmp (&quot;-m&quot;, argv[i]) == 0 || strncmp (&quot;-m=&quot;, argv[i], 3) == 0)
1172         {
1173           gchar *equal = argv[i] + 2;
1174           const gchar *mode = &quot;&quot;;
1175           if (*equal == &#39;=&#39;)
1176             mode = equal + 1;
1177           else if (i + 1 &lt; argc)
1178             {
1179               argv[i++] = NULL;
1180               mode = argv[i];
1181             }
1182           if (strcmp (mode, &quot;perf&quot;) == 0)
1183             mutable_test_config_vars.test_perf = TRUE;
1184           else if (strcmp (mode, &quot;slow&quot;) == 0)
1185             mutable_test_config_vars.test_quick = FALSE;
1186           else if (strcmp (mode, &quot;thorough&quot;) == 0)
1187             mutable_test_config_vars.test_quick = FALSE;
1188           else if (strcmp (mode, &quot;quick&quot;) == 0)
1189             {
1190               mutable_test_config_vars.test_quick = TRUE;
1191               mutable_test_config_vars.test_perf = FALSE;
1192             }
1193           else if (strcmp (mode, &quot;undefined&quot;) == 0)
1194             mutable_test_config_vars.test_undefined = TRUE;
1195           else if (strcmp (mode, &quot;no-undefined&quot;) == 0)
1196             mutable_test_config_vars.test_undefined = FALSE;
1197           else
1198             g_error (&quot;unknown test mode: -m %s&quot;, mode);
1199           argv[i] = NULL;
1200         }
1201       else if (strcmp (&quot;-q&quot;, argv[i]) == 0 || strcmp (&quot;--quiet&quot;, argv[i]) == 0)
1202         {
1203           mutable_test_config_vars.test_quiet = TRUE;
1204           mutable_test_config_vars.test_verbose = FALSE;
1205           argv[i] = NULL;
1206         }
1207       else if (strcmp (&quot;--verbose&quot;, argv[i]) == 0)
1208         {
1209           mutable_test_config_vars.test_quiet = FALSE;
1210           mutable_test_config_vars.test_verbose = TRUE;
1211           argv[i] = NULL;
1212         }
1213       else if (strcmp (&quot;-l&quot;, argv[i]) == 0)
1214         {
1215           test_run_list = TRUE;
1216           argv[i] = NULL;
1217         }
1218       else if (strcmp (&quot;--seed&quot;, argv[i]) == 0 || strncmp (&quot;--seed=&quot;, argv[i], 7) == 0)
1219         {
1220           gchar *equal = argv[i] + 6;
1221           if (*equal == &#39;=&#39;)
1222             test_run_seedstr = equal + 1;
1223           else if (i + 1 &lt; argc)
1224             {
1225               argv[i++] = NULL;
1226               test_run_seedstr = argv[i];
1227             }
1228           argv[i] = NULL;
1229         }
1230       else if (strcmp (&quot;-?&quot;, argv[i]) == 0 ||
1231                strcmp (&quot;-h&quot;, argv[i]) == 0 ||
1232                strcmp (&quot;--help&quot;, argv[i]) == 0)
1233         {
1234           printf (&quot;Usage:\n&quot;
1235                   &quot;  %s [OPTION...]\n\n&quot;
1236                   &quot;Help Options:\n&quot;
1237                   &quot;  -h, --help                     Show help options\n\n&quot;
1238                   &quot;Test Options:\n&quot;
1239                   &quot;  --g-fatal-warnings             Make all warnings fatal\n&quot;
1240                   &quot;  -l                             List test cases available in a test executable\n&quot;
1241                   &quot;  -m {perf|slow|thorough|quick}  Execute tests according to mode\n&quot;
1242                   &quot;  -m {undefined|no-undefined}    Execute tests according to mode\n&quot;
1243                   &quot;  -p TESTPATH                    Only start test cases matching TESTPATH\n&quot;
1244                   &quot;  -s TESTPATH                    Skip all tests matching TESTPATH\n&quot;
1245                   &quot;  --seed=SEEDSTRING              Start tests with random seed SEEDSTRING\n&quot;
1246                   &quot;  --debug-log                    debug test logging output\n&quot;
1247                   &quot;  -q, --quiet                    Run tests quietly\n&quot;
1248                   &quot;  --verbose                      Run tests verbosely\n&quot;,
1249                   argv[0]);
1250           exit (0);
1251         }
1252     }
<a name="29" id="anc29"></a><span class="line-added">1253 </span>
<span class="line-added">1254   /* We&#39;ve been prepending to test_paths, but its order matters, so</span>
<span class="line-added">1255    * permute it */</span>
<span class="line-added">1256   test_paths = g_slist_reverse (test_paths);</span>
<span class="line-added">1257 </span>
1258   /* collapse argv */
1259   e = 1;
1260   for (i = 1; i &lt; argc; i++)
1261     if (argv[i])
1262       {
1263         argv[e++] = argv[i];
1264         if (i &gt;= e)
1265           argv[i] = NULL;
1266       }
1267   *argc_p = e;
1268 }
1269 
<a name="30" id="anc30"></a><span class="line-added">1270 /* A fairly naive `rm -rf` implementation to clean up after unit tests. */</span>
<span class="line-added">1271 static void</span>
<span class="line-added">1272 rm_rf (const gchar *path)</span>
<span class="line-added">1273 {</span>
<span class="line-added">1274   GDir *dir = NULL;</span>
<span class="line-added">1275   const gchar *entry;</span>
<span class="line-added">1276 </span>
<span class="line-added">1277   dir = g_dir_open (path, 0, NULL);</span>
<span class="line-added">1278   if (dir == NULL)</span>
<span class="line-added">1279     {</span>
<span class="line-added">1280       /* Assume it&#39;s a file. */</span>
<span class="line-added">1281       g_remove (path);</span>
<span class="line-added">1282       return;</span>
<span class="line-added">1283     }</span>
<span class="line-added">1284 </span>
<span class="line-added">1285   while ((entry = g_dir_read_name (dir)) != NULL)</span>
<span class="line-added">1286     {</span>
<span class="line-added">1287       gchar *sub_path = g_build_filename (path, entry, NULL);</span>
<span class="line-added">1288       rm_rf (sub_path);</span>
<span class="line-added">1289       g_free (sub_path);</span>
<span class="line-added">1290     }</span>
<span class="line-added">1291 </span>
<span class="line-added">1292   g_dir_close (dir);</span>
<span class="line-added">1293 </span>
<span class="line-added">1294   g_rmdir (path);</span>
<span class="line-added">1295 }</span>
<span class="line-added">1296 </span>
<span class="line-added">1297 /* Implement the %G_TEST_OPTION_ISOLATE_DIRS option, iff it&#39;s enabled. Create</span>
<span class="line-added">1298  * a temporary directory for this unit test (disambiguated using @test_run_name)</span>
<span class="line-added">1299  * and use g_set_user_dirs() to point various XDG directories into it, without</span>
<span class="line-added">1300  * having to call setenv() in a process which potentially has threads running.</span>
<span class="line-added">1301  *</span>
<span class="line-added">1302  * Note that this is called for each unit test, and hence won&#39;t have taken</span>
<span class="line-added">1303  * effect before g_test_run() is called in the unit test&#39;s main(). Hence</span>
<span class="line-added">1304  * references to XDG variables in main() will not be using the temporary</span>
<span class="line-added">1305  * directory. */</span>
<span class="line-added">1306 static gboolean</span>
<span class="line-added">1307 test_do_isolate_dirs (GError **error)</span>
<span class="line-added">1308 {</span>
<span class="line-added">1309   gchar *subdir = NULL;</span>
<span class="line-added">1310   gchar *home_dir = NULL, *cache_dir = NULL, *config_dir = NULL;</span>
<span class="line-added">1311   gchar *data_dir = NULL, *runtime_dir = NULL;</span>
<span class="line-added">1312   gchar *config_dirs[3];</span>
<span class="line-added">1313   gchar *data_dirs[3];</span>
<span class="line-added">1314 </span>
<span class="line-added">1315   if (!test_isolate_dirs)</span>
<span class="line-added">1316     return TRUE;</span>
<span class="line-added">1317 </span>
<span class="line-added">1318   /* The @test_run_name includes the test suites, so may be several directories</span>
<span class="line-added">1319    * deep. Add a `.dirs` directory to contain all the paths we create, and</span>
<span class="line-added">1320    * guarantee none of them clash with test paths below the current one - test</span>
<span class="line-added">1321    * paths may not contain components starting with `.`. */</span>
<span class="line-added">1322   subdir = g_build_filename (test_tmpdir, test_run_name, &quot;.dirs&quot;, NULL);</span>
<span class="line-added">1323 </span>
<span class="line-added">1324   /* We have to create the runtime directory (because it must be bound to</span>
<span class="line-added">1325    * the session lifetime, which we consider to be the lifetime of the unit</span>
<span class="line-added">1326    * test for testing purposes - see</span>
<span class="line-added">1327    * https://standards.freedesktop.org/basedir-spec/basedir-spec-latest.html.</span>
<span class="line-added">1328    * We don&#39;t need to create the other directories - the specification</span>
<span class="line-added">1329    * requires that client code create them if they don&#39;t exist. Not creating</span>
<span class="line-added">1330    * them automatically is a good test of clients&#39; adherence to the spec</span>
<span class="line-added">1331    * and error handling of missing directories. */</span>
<span class="line-added">1332   runtime_dir = g_build_filename (subdir, &quot;runtime&quot;, NULL);</span>
<span class="line-added">1333   if (g_mkdir_with_parents (runtime_dir, 0700) != 0)</span>
<span class="line-added">1334     {</span>
<span class="line-added">1335       gint saved_errno = errno;</span>
<span class="line-added">1336       g_set_error (error, G_FILE_ERROR, g_file_error_from_errno (saved_errno),</span>
<span class="line-added">1337                    &quot;Failed to create XDG_RUNTIME_DIR &#39;%s&#39;: %s&quot;,</span>
<span class="line-added">1338                   runtime_dir, g_strerror (saved_errno));</span>
<span class="line-added">1339       g_free (runtime_dir);</span>
<span class="line-added">1340       g_free (subdir);</span>
<span class="line-added">1341       return FALSE;</span>
<span class="line-added">1342     }</span>
<span class="line-added">1343 </span>
<span class="line-added">1344   home_dir = g_build_filename (subdir, &quot;home&quot;, NULL);</span>
<span class="line-added">1345   cache_dir = g_build_filename (subdir, &quot;cache&quot;, NULL);</span>
<span class="line-added">1346   config_dir = g_build_filename (subdir, &quot;config&quot;, NULL);</span>
<span class="line-added">1347   data_dir = g_build_filename (subdir, &quot;data&quot;, NULL);</span>
<span class="line-added">1348 </span>
<span class="line-added">1349   config_dirs[0] = g_build_filename (subdir, &quot;system-config1&quot;, NULL);</span>
<span class="line-added">1350   config_dirs[1] = g_build_filename (subdir, &quot;system-config2&quot;, NULL);</span>
<span class="line-added">1351   config_dirs[2] = NULL;</span>
<span class="line-added">1352 </span>
<span class="line-added">1353   data_dirs[0] = g_build_filename (subdir, &quot;system-data1&quot;, NULL);</span>
<span class="line-added">1354   data_dirs[1] = g_build_filename (subdir, &quot;system-data2&quot;, NULL);</span>
<span class="line-added">1355   data_dirs[2] = NULL;</span>
<span class="line-added">1356 </span>
<span class="line-added">1357   /* Remember to update the documentation for %G_TEST_OPTION_ISOLATE_DIRS if</span>
<span class="line-added">1358    * this list changes. */</span>
<span class="line-added">1359   g_set_user_dirs (&quot;HOME&quot;, home_dir,</span>
<span class="line-added">1360                    &quot;XDG_CACHE_HOME&quot;, cache_dir,</span>
<span class="line-added">1361                    &quot;XDG_CONFIG_DIRS&quot;, config_dirs,</span>
<span class="line-added">1362                    &quot;XDG_CONFIG_HOME&quot;, config_dir,</span>
<span class="line-added">1363                    &quot;XDG_DATA_DIRS&quot;, data_dirs,</span>
<span class="line-added">1364                    &quot;XDG_DATA_HOME&quot;, data_dir,</span>
<span class="line-added">1365                    &quot;XDG_RUNTIME_DIR&quot;, runtime_dir,</span>
<span class="line-added">1366                    NULL);</span>
<span class="line-added">1367 </span>
<span class="line-added">1368   g_free (runtime_dir);</span>
<span class="line-added">1369   g_free (data_dir);</span>
<span class="line-added">1370   g_free (config_dir);</span>
<span class="line-added">1371   g_free (cache_dir);</span>
<span class="line-added">1372   g_free (home_dir);</span>
<span class="line-added">1373   g_free (data_dirs[1]);</span>
<span class="line-added">1374   g_free (data_dirs[0]);</span>
<span class="line-added">1375   g_free (config_dirs[1]);</span>
<span class="line-added">1376   g_free (config_dirs[0]);</span>
<span class="line-added">1377   g_free (subdir);</span>
<span class="line-added">1378 </span>
<span class="line-added">1379   return TRUE;</span>
<span class="line-added">1380 }</span>
<span class="line-added">1381 </span>
<span class="line-added">1382 /* Clean up after test_do_isolate_dirs(). */</span>
<span class="line-added">1383 static void</span>
<span class="line-added">1384 test_rm_isolate_dirs (void)</span>
<span class="line-added">1385 {</span>
<span class="line-added">1386   gchar *subdir = NULL;</span>
<span class="line-added">1387 </span>
<span class="line-added">1388   if (!test_isolate_dirs)</span>
<span class="line-added">1389     return;</span>
<span class="line-added">1390 </span>
<span class="line-added">1391   subdir = g_build_filename (test_tmpdir, test_run_name, NULL);</span>
<span class="line-added">1392   rm_rf (subdir);</span>
<span class="line-added">1393   g_free (subdir);</span>
<span class="line-added">1394 }</span>
<span class="line-added">1395 </span>
1396 /**
1397  * g_test_init:
1398  * @argc: Address of the @argc parameter of the main() function.
1399  *        Changed if any arguments were handled.
1400  * @argv: Address of the @argv parameter of main().
1401  *        Any parameters understood by g_test_init() stripped before return.
<a name="31" id="anc31"></a><span class="line-modified">1402  * @...: %NULL-terminated list of special options, documented below.</span>


1403  *
1404  * Initialize the GLib testing framework, e.g. by seeding the
1405  * test random number generator, the name for g_get_prgname()
1406  * and parsing test related command line args.
1407  *
1408  * So far, the following arguments are understood:
1409  *
1410  * - `-l`: List test cases available in a test executable.
1411  * - `--seed=SEED`: Provide a random seed to reproduce test
1412  *   runs using random numbers.
1413  * - `--verbose`: Run tests verbosely.
1414  * - `-q`, `--quiet`: Run tests quietly.
1415  * - `-p PATH`: Execute all tests matching the given path.
1416  * - `-s PATH`: Skip all tests matching the given path.
1417  *   This can also be used to force a test to run that would otherwise
1418  *   be skipped (ie, a test whose name contains &quot;/subprocess&quot;).
1419  * - `-m {perf|slow|thorough|quick|undefined|no-undefined}`: Execute tests according to these test modes:
1420  *
1421  *   `perf`: Performance tests, may take long and report results (off by default).
1422  *
1423  *   `slow`, `thorough`: Slow and thorough tests, may take quite long and maximize coverage
1424  *   (off by default).
1425  *
1426  *   `quick`: Quick tests, should run really quickly and give good coverage (the default).
1427  *
1428  *   `undefined`: Tests for undefined behaviour, may provoke programming errors
1429  *   under g_test_trap_subprocess() or g_test_expect_message() to check
1430  *   that appropriate assertions or warnings are given (the default).
1431  *
1432  *   `no-undefined`: Avoid tests for undefined behaviour
1433  *
1434  * - `--debug-log`: Debug test logging output.
1435  *
<a name="32" id="anc32"></a><span class="line-added">1436  * Options which can be passed to @... are:</span>
<span class="line-added">1437  *</span>
<span class="line-added">1438  *  - `&quot;no_g_set_prgname&quot;`: Causes g_test_init() to not call g_set_prgname().</span>
<span class="line-added">1439  *  - %G_TEST_OPTION_ISOLATE_DIRS: Creates a unique temporary directory for each</span>
<span class="line-added">1440  *    unit test and uses g_set_user_dirs() to set XDG directories to point into</span>
<span class="line-added">1441  *    that temporary directory for the duration of the unit test. See the</span>
<span class="line-added">1442  *    documentation for %G_TEST_OPTION_ISOLATE_DIRS.</span>
<span class="line-added">1443  *</span>
1444  * Since 2.58, if tests are compiled with `G_DISABLE_ASSERT` defined,
1445  * g_test_init() will print an error and exit. This is to prevent no-op tests
1446  * from being executed, as g_assert() is commonly (erroneously) used in unit
1447  * tests, and is a no-op when compiled with `G_DISABLE_ASSERT`. Ensure your
1448  * tests are compiled without `G_DISABLE_ASSERT` defined.
1449  *
1450  * Since: 2.16
1451  */
1452 void
1453 (g_test_init) (int    *argc,
1454                char ***argv,
1455                ...)
1456 {
1457   static char seedstr[4 + 4 * 8 + 1];
1458   va_list args;
1459   gpointer option;
1460   /* make warnings and criticals fatal for all test programs */
1461   GLogLevelFlags fatal_mask = (GLogLevelFlags) g_log_set_always_fatal ((GLogLevelFlags) G_LOG_FATAL_MASK);
1462 
1463   fatal_mask = (GLogLevelFlags) (fatal_mask | G_LOG_LEVEL_WARNING | G_LOG_LEVEL_CRITICAL);
1464   g_log_set_always_fatal (fatal_mask);
1465   /* check caller args */
1466   g_return_if_fail (argc != NULL);
1467   g_return_if_fail (argv != NULL);
1468   g_return_if_fail (g_test_config_vars-&gt;test_initialized == FALSE);
1469   mutable_test_config_vars.test_initialized = TRUE;
1470 
1471   va_start (args, argv);
1472   while ((option = va_arg (args, char *)))
1473     {
1474       if (g_strcmp0 (option, &quot;no_g_set_prgname&quot;) == 0)
1475         no_g_set_prgname = TRUE;
<a name="33" id="anc33"></a><span class="line-added">1476       else if (g_strcmp0 (option, G_TEST_OPTION_ISOLATE_DIRS) == 0)</span>
<span class="line-added">1477         test_isolate_dirs = TRUE;</span>
1478     }
1479   va_end (args);
1480 
1481   /* setup random seed string */
1482   g_snprintf (seedstr, sizeof (seedstr), &quot;R02S%08x%08x%08x%08x&quot;, g_random_int(), g_random_int(), g_random_int(), g_random_int());
1483   test_run_seedstr = seedstr;
1484 
1485   /* parse args, sets up mode, changes seed, etc. */
1486   parse_args (argc, argv);
1487 
1488   if (!g_get_prgname() &amp;&amp; !no_g_set_prgname)
1489     g_set_prgname ((*argv)[0]);
1490 
<a name="34" id="anc34"></a><span class="line-modified">1491   /* Set up the temporary directory for isolating the test. We have to do this</span>
<span class="line-modified">1492    * early, as we want the return values from g_get_user_data_dir() (and</span>
<span class="line-added">1493    * friends) to return subdirectories of the temporary directory throughout</span>
<span class="line-added">1494    * the setup function, test, and teardown function, for each unit test.</span>
<span class="line-added">1495    * See test_do_isolate_dirs().</span>
<span class="line-added">1496    *</span>
<span class="line-added">1497    * The directory is deleted at the bottom of g_test_run().</span>
<span class="line-added">1498    *</span>
<span class="line-added">1499    * Rather than setting the XDG_* environment variables we use a new</span>
<span class="line-added">1500    * G_TEST_TMPDIR variable which gives the top-level temporary directory. This</span>
<span class="line-added">1501    * allows test subprocesses to reuse the same temporary directory when</span>
<span class="line-added">1502    * g_test_init() is called in them. */</span>
<span class="line-added">1503   if (test_isolate_dirs)</span>
1504     {
<a name="35" id="anc35"></a><span class="line-modified">1505       if (g_getenv (&quot;G_TEST_TMPDIR&quot;) == NULL)</span>
1506         {
<a name="36" id="anc36"></a><span class="line-modified">1507           gchar *test_prgname = NULL;</span>
<span class="line-modified">1508           gchar *tmpl = NULL;</span>
<span class="line-modified">1509           GError *local_error = NULL;</span>
<span class="line-modified">1510 </span>
<span class="line-added">1511           test_prgname = g_path_get_basename (g_get_prgname ());</span>
<span class="line-added">1512           if (*test_prgname == &#39;\0&#39;)</span>
<span class="line-added">1513             test_prgname = g_strdup (&quot;unknown&quot;);</span>
<span class="line-added">1514           tmpl = g_strdup_printf (&quot;test_%s_XXXXXX&quot;, test_prgname);</span>
<span class="line-added">1515           g_free (test_prgname);</span>
<span class="line-added">1516 </span>
<span class="line-added">1517           test_isolate_dirs_tmpdir = g_dir_make_tmp (tmpl, &amp;local_error);</span>
<span class="line-added">1518           if (local_error != NULL)</span>
<span class="line-added">1519             {</span>
<span class="line-added">1520               g_printerr (&quot;%s: Failed to create temporary directory: %s\n&quot;,</span>
<span class="line-added">1521                           (*argv)[0], local_error-&gt;message);</span>
<span class="line-added">1522               g_error_free (local_error);</span>
<span class="line-added">1523               exit (1);</span>
<span class="line-added">1524             }</span>
<span class="line-added">1525           g_free (tmpl);</span>
<span class="line-added">1526 </span>
<span class="line-added">1527           /* Propagate the temporary directory to subprocesses. */</span>
<span class="line-added">1528           g_setenv (&quot;G_TEST_TMPDIR&quot;, test_isolate_dirs_tmpdir, TRUE);</span>
<span class="line-added">1529 </span>
<span class="line-added">1530           /* And clear the traditional environment variables so subprocesses</span>
<span class="line-added">1531            * spawned by the code under test can&#39;t trash anything. If a test</span>
<span class="line-added">1532            * spawns a process, the test is responsible for propagating</span>
<span class="line-added">1533            * appropriate environment variables.</span>
<span class="line-added">1534            *</span>
<span class="line-added">1535            * We assume that any in-process code will use g_get_user_data_dir()</span>
<span class="line-added">1536            * and friends, rather than getenv() directly.</span>
<span class="line-added">1537            *</span>
<span class="line-added">1538            * We set them to &#39;/dev/null&#39; as that should fairly obviously not</span>
<span class="line-added">1539            * accidentally work, and should be fairly greppable. */</span>
<span class="line-added">1540             {</span>
<span class="line-added">1541               const gchar *overridden_environment_variables[] =</span>
<span class="line-added">1542                 {</span>
<span class="line-added">1543                   &quot;HOME&quot;,</span>
<span class="line-added">1544                   &quot;XDG_CACHE_HOME&quot;,</span>
<span class="line-added">1545                   &quot;XDG_CONFIG_DIRS&quot;,</span>
<span class="line-added">1546                   &quot;XDG_CONFIG_HOME&quot;,</span>
<span class="line-added">1547                   &quot;XDG_DATA_DIRS&quot;,</span>
<span class="line-added">1548                   &quot;XDG_DATA_HOME&quot;,</span>
<span class="line-added">1549                   &quot;XDG_RUNTIME_DIR&quot;,</span>
<span class="line-added">1550                 };</span>
<span class="line-added">1551               gsize i;</span>
<span class="line-added">1552 </span>
<span class="line-added">1553               for (i = 0; i &lt; G_N_ELEMENTS (overridden_environment_variables); i++)</span>
<span class="line-added">1554                 g_setenv (overridden_environment_variables[i], &quot;/dev/null&quot;, TRUE);</span>
<span class="line-added">1555             }</span>
1556         }
<a name="37" id="anc37"></a><span class="line-added">1557 </span>
<span class="line-added">1558       /* Cache this for the remainder of this process&#39; lifetime. */</span>
<span class="line-added">1559       test_tmpdir = g_getenv (&quot;G_TEST_TMPDIR&quot;);</span>
1560     }
1561 
1562   /* verify GRand reliability, needed for reliable seeds */
1563   if (1)
1564     {
1565       GRand *rg = g_rand_new_with_seed (0xc8c49fb6);
1566       guint32 t1 = g_rand_int (rg), t2 = g_rand_int (rg), t3 = g_rand_int (rg), t4 = g_rand_int (rg);
1567       /* g_print (&quot;GRand-current: 0x%x 0x%x 0x%x 0x%x\n&quot;, t1, t2, t3, t4); */
1568       if (t1 != 0xfab39f9b || t2 != 0xb948fb0e || t3 != 0x3d31be26 || t4 != 0x43a19d66)
1569         g_warning (&quot;random numbers are not GRand-2.2 compatible, seeds may be broken (check $G_RANDOM_VERSION)&quot;);
1570       g_rand_free (rg);
1571     }
1572 
1573   /* check rand seed */
1574   test_run_seed (test_run_seedstr);
1575 
1576   /* report program start */
1577   g_log_set_default_handler (gtest_default_log_handler, NULL);
1578   g_test_log (G_TEST_LOG_START_BINARY, g_get_prgname(), test_run_seedstr, 0, NULL);
1579 
1580   test_argv0_dirname = g_path_get_dirname (test_argv0);
1581 
1582   /* Make sure we get the real dirname that the test was run from */
1583   if (g_str_has_suffix (test_argv0_dirname, &quot;/.libs&quot;))
1584     {
1585       gchar *tmp;
1586       tmp = g_path_get_dirname (test_argv0_dirname);
1587       g_free (test_argv0_dirname);
1588       test_argv0_dirname = tmp;
1589     }
1590 
1591   test_disted_files_dir = g_getenv (&quot;G_TEST_SRCDIR&quot;);
1592   if (!test_disted_files_dir)
1593     test_disted_files_dir = test_argv0_dirname;
1594 
1595   test_built_files_dir = g_getenv (&quot;G_TEST_BUILDDIR&quot;);
1596   if (!test_built_files_dir)
1597     test_built_files_dir = test_argv0_dirname;
1598 }
1599 
1600 static void
1601 test_run_seed (const gchar *rseed)
1602 {
1603   guint seed_failed = 0;
1604   if (test_run_rand)
1605     g_rand_free (test_run_rand);
1606   test_run_rand = NULL;
1607   while (strchr (&quot; \t\v\r\n\f&quot;, *rseed))
1608     rseed++;
1609   if (strncmp (rseed, &quot;R02S&quot;, 4) == 0)  /* seed for random generator 02 (GRand-2.2) */
1610     {
1611       const char *s = rseed + 4;
1612       if (strlen (s) &gt;= 32)             /* require 4 * 8 chars */
1613         {
1614           guint32 seedarray[4];
1615           gchar *p, hexbuf[9] = { 0, };
1616           memcpy (hexbuf, s + 0, 8);
1617           seedarray[0] = g_ascii_strtoull (hexbuf, &amp;p, 16);
1618           seed_failed += p != NULL &amp;&amp; *p != 0;
1619           memcpy (hexbuf, s + 8, 8);
1620           seedarray[1] = g_ascii_strtoull (hexbuf, &amp;p, 16);
1621           seed_failed += p != NULL &amp;&amp; *p != 0;
1622           memcpy (hexbuf, s + 16, 8);
1623           seedarray[2] = g_ascii_strtoull (hexbuf, &amp;p, 16);
1624           seed_failed += p != NULL &amp;&amp; *p != 0;
1625           memcpy (hexbuf, s + 24, 8);
1626           seedarray[3] = g_ascii_strtoull (hexbuf, &amp;p, 16);
1627           seed_failed += p != NULL &amp;&amp; *p != 0;
1628           if (!seed_failed)
1629             {
1630               test_run_rand = g_rand_new_with_seed_array (seedarray, 4);
1631               return;
1632             }
1633         }
1634     }
1635   g_error (&quot;Unknown or invalid random seed: %s&quot;, rseed);
1636 }
1637 
1638 /**
1639  * g_test_rand_int:
1640  *
1641  * Get a reproducible random integer number.
1642  *
1643  * The random numbers generated by the g_test_rand_*() family of functions
1644  * change with every new test program start, unless the --seed option is
1645  * given when starting test programs.
1646  *
1647  * For individual test cases however, the random number generator is
1648  * reseeded, to avoid dependencies between tests and to make --seed
1649  * effective for all test cases.
1650  *
1651  * Returns: a random number from the seeded random number generator.
1652  *
1653  * Since: 2.16
1654  */
1655 gint32
1656 g_test_rand_int (void)
1657 {
<a name="38" id="anc38"></a><span class="line-modified">1658   gint32 r;</span>
<span class="line-added">1659 </span>
<span class="line-added">1660   G_LOCK (test_run_rand);</span>
<span class="line-added">1661   r = g_rand_int (test_run_rand);</span>
<span class="line-added">1662   G_UNLOCK (test_run_rand);</span>
<span class="line-added">1663 </span>
<span class="line-added">1664   return r;</span>
1665 }
1666 
1667 /**
1668  * g_test_rand_int_range:
1669  * @begin: the minimum value returned by this function
1670  * @end:   the smallest value not to be returned by this function
1671  *
1672  * Get a reproducible random integer number out of a specified range,
1673  * see g_test_rand_int() for details on test case random numbers.
1674  *
1675  * Returns: a number with @begin &lt;= number &lt; @end.
1676  *
1677  * Since: 2.16
1678  */
1679 gint32
1680 g_test_rand_int_range (gint32          begin,
1681                        gint32          end)
1682 {
<a name="39" id="anc39"></a><span class="line-modified">1683   gint32 r;</span>
<span class="line-added">1684 </span>
<span class="line-added">1685   G_LOCK (test_run_rand);</span>
<span class="line-added">1686   r = g_rand_int_range (test_run_rand, begin, end);</span>
<span class="line-added">1687   G_UNLOCK (test_run_rand);</span>
<span class="line-added">1688 </span>
<span class="line-added">1689   return r;</span>
1690 }
1691 
1692 /**
1693  * g_test_rand_double:
1694  *
1695  * Get a reproducible random floating point number,
1696  * see g_test_rand_int() for details on test case random numbers.
1697  *
1698  * Returns: a random number from the seeded random number generator.
1699  *
1700  * Since: 2.16
1701  */
1702 double
1703 g_test_rand_double (void)
1704 {
<a name="40" id="anc40"></a><span class="line-modified">1705   double r;</span>
<span class="line-added">1706 </span>
<span class="line-added">1707   G_LOCK (test_run_rand);</span>
<span class="line-added">1708   r = g_rand_double (test_run_rand);</span>
<span class="line-added">1709   G_UNLOCK (test_run_rand);</span>
<span class="line-added">1710 </span>
<span class="line-added">1711   return r;</span>
1712 }
1713 
1714 /**
1715  * g_test_rand_double_range:
1716  * @range_start: the minimum value returned by this function
1717  * @range_end: the minimum value not returned by this function
1718  *
1719  * Get a reproducible random floating pointer number out of a specified range,
1720  * see g_test_rand_int() for details on test case random numbers.
1721  *
1722  * Returns: a number with @range_start &lt;= number &lt; @range_end.
1723  *
1724  * Since: 2.16
1725  */
1726 double
1727 g_test_rand_double_range (double          range_start,
1728                           double          range_end)
1729 {
<a name="41" id="anc41"></a><span class="line-modified">1730   double r;</span>
<span class="line-added">1731 </span>
<span class="line-added">1732   G_LOCK (test_run_rand);</span>
<span class="line-added">1733   r = g_rand_double_range (test_run_rand, range_start, range_end);</span>
<span class="line-added">1734   G_UNLOCK (test_run_rand);</span>
<span class="line-added">1735 </span>
<span class="line-added">1736   return r;</span>
1737 }
1738 
1739 /**
1740  * g_test_timer_start:
1741  *
1742  * Start a timing test. Call g_test_timer_elapsed() when the task is supposed
1743  * to be done. Call this function again to restart the timer.
1744  *
1745  * Since: 2.16
1746  */
1747 void
1748 g_test_timer_start (void)
1749 {
1750   if (!test_user_timer)
1751     test_user_timer = g_timer_new();
1752   test_user_stamp = 0;
1753   g_timer_start (test_user_timer);
1754 }
1755 
1756 /**
1757  * g_test_timer_elapsed:
1758  *
1759  * Get the time since the last start of the timer with g_test_timer_start().
1760  *
1761  * Returns: the time since the last start of the timer, as a double
1762  *
1763  * Since: 2.16
1764  */
1765 double
1766 g_test_timer_elapsed (void)
1767 {
1768   test_user_stamp = test_user_timer ? g_timer_elapsed (test_user_timer, NULL) : 0;
1769   return test_user_stamp;
1770 }
1771 
1772 /**
1773  * g_test_timer_last:
1774  *
1775  * Report the last result of g_test_timer_elapsed().
1776  *
1777  * Returns: the last result of g_test_timer_elapsed(), as a double
1778  *
1779  * Since: 2.16
1780  */
1781 double
1782 g_test_timer_last (void)
1783 {
1784   return test_user_stamp;
1785 }
1786 
1787 /**
1788  * g_test_minimized_result:
1789  * @minimized_quantity: the reported value
1790  * @format: the format string of the report message
1791  * @...: arguments to pass to the printf() function
1792  *
1793  * Report the result of a performance or measurement test.
1794  * The test should generally strive to minimize the reported
1795  * quantities (smaller values are better than larger ones),
1796  * this and @minimized_quantity can determine sorting
1797  * order for test result reports.
1798  *
1799  * Since: 2.16
1800  */
1801 void
1802 g_test_minimized_result (double          minimized_quantity,
1803                          const char     *format,
1804                          ...)
1805 {
1806   long double largs = minimized_quantity;
1807   gchar *buffer;
1808   va_list args;
1809 
1810   va_start (args, format);
1811   buffer = g_strdup_vprintf (format, args);
1812   va_end (args);
1813 
1814   g_test_log (G_TEST_LOG_MIN_RESULT, buffer, NULL, 1, &amp;largs);
1815   g_free (buffer);
1816 }
1817 
1818 /**
1819  * g_test_maximized_result:
1820  * @maximized_quantity: the reported value
1821  * @format: the format string of the report message
1822  * @...: arguments to pass to the printf() function
1823  *
1824  * Report the result of a performance or measurement test.
1825  * The test should generally strive to maximize the reported
1826  * quantities (larger values are better than smaller ones),
1827  * this and @maximized_quantity can determine sorting
1828  * order for test result reports.
1829  *
1830  * Since: 2.16
1831  */
1832 void
1833 g_test_maximized_result (double          maximized_quantity,
1834                          const char     *format,
1835                          ...)
1836 {
1837   long double largs = maximized_quantity;
1838   gchar *buffer;
1839   va_list args;
1840 
1841   va_start (args, format);
1842   buffer = g_strdup_vprintf (format, args);
1843   va_end (args);
1844 
1845   g_test_log (G_TEST_LOG_MAX_RESULT, buffer, NULL, 1, &amp;largs);
1846   g_free (buffer);
1847 }
1848 
1849 /**
1850  * g_test_message:
1851  * @format: the format string
1852  * @...:    printf-like arguments to @format
1853  *
1854  * Add a message to the test report.
1855  *
1856  * Since: 2.16
1857  */
1858 void
1859 g_test_message (const char *format,
1860                 ...)
1861 {
1862   gchar *buffer;
1863   va_list args;
1864 
1865   va_start (args, format);
1866   buffer = g_strdup_vprintf (format, args);
1867   va_end (args);
1868 
1869   g_test_log (G_TEST_LOG_MESSAGE, buffer, NULL, 0, NULL);
1870   g_free (buffer);
1871 }
1872 
1873 /**
1874  * g_test_bug_base:
1875  * @uri_pattern: the base pattern for bug URIs
1876  *
1877  * Specify the base URI for bug reports.
1878  *
1879  * The base URI is used to construct bug report messages for
1880  * g_test_message() when g_test_bug() is called.
1881  * Calling this function outside of a test case sets the
1882  * default base URI for all test cases. Calling it from within
1883  * a test case changes the base URI for the scope of the test
1884  * case only.
1885  * Bug URIs are constructed by appending a bug specific URI
1886  * portion to @uri_pattern, or by replacing the special string
1887  * &#39;\%s&#39; within @uri_pattern if that is present.
1888  *
<a name="42" id="anc42"></a><span class="line-added">1889  * If g_test_bug_base() is not called, bug URIs are formed solely</span>
<span class="line-added">1890  * from the value provided by g_test_bug().</span>
<span class="line-added">1891  *</span>
1892  * Since: 2.16
1893  */
1894 void
1895 g_test_bug_base (const char *uri_pattern)
1896 {
1897   g_free (test_uri_base);
1898   test_uri_base = g_strdup (uri_pattern);
1899 }
1900 
1901 /**
1902  * g_test_bug:
1903  * @bug_uri_snippet: Bug specific bug tracker URI portion.
1904  *
1905  * This function adds a message to test reports that
1906  * associates a bug URI with a test case.
1907  * Bug URIs are constructed from a base URI set with g_test_bug_base()
<a name="43" id="anc43"></a><span class="line-modified">1908  * and @bug_uri_snippet. If g_test_bug_base() has not been called, it is</span>
<span class="line-added">1909  * assumed to be the empty string, so a full URI can be provided to</span>
<span class="line-added">1910  * g_test_bug() instead.</span>
1911  *
1912  * Since: 2.16
<a name="44" id="anc44"></a><span class="line-added">1913  * See also: g_test_summary()</span>
1914  */
1915 void
1916 g_test_bug (const char *bug_uri_snippet)
1917 {
<a name="45" id="anc45"></a><span class="line-modified">1918   const char *c = NULL;</span>
1919 
<a name="46" id="anc46"></a>
1920   g_return_if_fail (bug_uri_snippet != NULL);
1921 
<a name="47" id="anc47"></a><span class="line-modified">1922   if (test_uri_base != NULL)</span>
<span class="line-added">1923     c = strstr (test_uri_base, &quot;%s&quot;);</span>
1924   if (c)
1925     {
1926       char *b = g_strndup (test_uri_base, c - test_uri_base);
1927       char *s = g_strconcat (b, bug_uri_snippet, c + 2, NULL);
1928       g_free (b);
1929       g_test_message (&quot;Bug Reference: %s&quot;, s);
1930       g_free (s);
1931     }
1932   else
<a name="48" id="anc48"></a><span class="line-modified">1933     g_test_message (&quot;Bug Reference: %s%s&quot;,</span>
<span class="line-added">1934                     test_uri_base ? test_uri_base : &quot;&quot;, bug_uri_snippet);</span>
<span class="line-added">1935 }</span>
<span class="line-added">1936 </span>
<span class="line-added">1937 /**</span>
<span class="line-added">1938  * g_test_summary:</span>
<span class="line-added">1939  * @summary: One or two sentences summarising what the test checks, and how it</span>
<span class="line-added">1940  *    checks it.</span>
<span class="line-added">1941  *</span>
<span class="line-added">1942  * Set the summary for a test, which describes what the test checks, and how it</span>
<span class="line-added">1943  * goes about checking it. This may be included in test report output, and is</span>
<span class="line-added">1944  * useful documentation for anyone reading the source code or modifying a test</span>
<span class="line-added">1945  * in future. It must be a single line.</span>
<span class="line-added">1946  *</span>
<span class="line-added">1947  * This should be called at the top of a test function.</span>
<span class="line-added">1948  *</span>
<span class="line-added">1949  * For example:</span>
<span class="line-added">1950  * |[&lt;!-- language=&quot;C&quot; --&gt;</span>
<span class="line-added">1951  * static void</span>
<span class="line-added">1952  * test_array_sort (void)</span>
<span class="line-added">1953  * {</span>
<span class="line-added">1954  *   g_test_summary (&quot;Test my_array_sort() sorts the array correctly and stably, &quot;</span>
<span class="line-added">1955  *                   &quot;including testing zero length and one-element arrays.&quot;);</span>
<span class="line-added">1956  *</span>
<span class="line-added">1957  * }</span>
<span class="line-added">1958  * ]|</span>
<span class="line-added">1959  *</span>
<span class="line-added">1960  * Since: 2.62</span>
<span class="line-added">1961  * See also: g_test_bug()</span>
<span class="line-added">1962  */</span>
<span class="line-added">1963 void</span>
<span class="line-added">1964 g_test_summary (const char *summary)</span>
<span class="line-added">1965 {</span>
<span class="line-added">1966   g_return_if_fail (summary != NULL);</span>
<span class="line-added">1967   g_return_if_fail (strchr (summary, &#39;\n&#39;) == NULL);</span>
<span class="line-added">1968   g_return_if_fail (strchr (summary, &#39;\r&#39;) == NULL);</span>
<span class="line-added">1969 </span>
<span class="line-added">1970   g_test_message (&quot;%s summary: %s&quot;, test_run_name, summary);</span>
1971 }
1972 
1973 /**
1974  * g_test_get_root:
1975  *
1976  * Get the toplevel test suite for the test path API.
1977  *
1978  * Returns: the toplevel #GTestSuite
1979  *
1980  * Since: 2.16
1981  */
1982 GTestSuite*
1983 g_test_get_root (void)
1984 {
1985   if (!test_suite_root)
1986     {
1987       test_suite_root = g_test_create_suite (&quot;root&quot;);
1988       g_free (test_suite_root-&gt;name);
1989       test_suite_root-&gt;name = g_strdup (&quot;&quot;);
1990     }
1991 
1992   return test_suite_root;
1993 }
1994 
1995 /**
1996  * g_test_run:
1997  *
1998  * Runs all tests under the toplevel suite which can be retrieved
1999  * with g_test_get_root(). Similar to g_test_run_suite(), the test
2000  * cases to be run are filtered according to test path arguments
2001  * (`-p testpath` and `-s testpath`) as parsed by g_test_init().
2002  * g_test_run_suite() or g_test_run() may only be called once in a
2003  * program.
2004  *
2005  * In general, the tests and sub-suites within each suite are run in
2006  * the order in which they are defined. However, note that prior to
2007  * GLib 2.36, there was a bug in the `g_test_add_*`
2008  * functions which caused them to create multiple suites with the same
2009  * name, meaning that if you created tests &quot;/foo/simple&quot;,
2010  * &quot;/bar/simple&quot;, and &quot;/foo/using-bar&quot; in that order, they would get
2011  * run in that order (since g_test_run() would run the first &quot;/foo&quot;
2012  * suite, then the &quot;/bar&quot; suite, then the second &quot;/foo&quot; suite). As of
2013  * 2.36, this bug is fixed, and adding the tests in that order would
2014  * result in a running order of &quot;/foo/simple&quot;, &quot;/foo/using-bar&quot;,
2015  * &quot;/bar/simple&quot;. If this new ordering is sub-optimal (because it puts
2016  * more-complicated tests before simpler ones, making it harder to
2017  * figure out exactly what has failed), you can fix it by changing the
2018  * test paths to group tests by suite in a way that will result in the
2019  * desired running order. Eg, &quot;/simple/foo&quot;, &quot;/simple/bar&quot;,
2020  * &quot;/complex/foo-using-bar&quot;.
2021  *
2022  * However, you should never make the actual result of a test depend
2023  * on the order that tests are run in. If you need to ensure that some
2024  * particular code runs before or after a given test case, use
2025  * g_test_add(), which lets you specify setup and teardown functions.
2026  *
2027  * If all tests are skipped or marked as incomplete (expected failures),
2028  * this function will return 0 if producing TAP output, or 77 (treated
2029  * as &quot;skip test&quot; by Automake) otherwise.
2030  *
2031  * Returns: 0 on success, 1 on failure (assuming it returns at all),
2032  *   0 or 77 if all tests were skipped with g_test_skip() and/or
2033  *   g_test_incomplete()
2034  *
2035  * Since: 2.16
2036  */
2037 int
2038 g_test_run (void)
2039 {
2040   if (g_test_run_suite (g_test_get_root()) != 0)
2041     return 1;
2042 
<a name="49" id="anc49"></a><span class="line-added">2043   /* Clean up the temporary directory. */</span>
<span class="line-added">2044   if (test_isolate_dirs_tmpdir != NULL)</span>
<span class="line-added">2045     {</span>
<span class="line-added">2046       rm_rf (test_isolate_dirs_tmpdir);</span>
<span class="line-added">2047       g_free (test_isolate_dirs_tmpdir);</span>
<span class="line-added">2048       test_isolate_dirs_tmpdir = NULL;</span>
<span class="line-added">2049     }</span>
<span class="line-added">2050 </span>
2051   /* 77 is special to Automake&#39;s default driver, but not Automake&#39;s TAP driver
2052    * or Perl&#39;s prove(1) TAP driver. */
2053   if (test_tap_log)
2054     return 0;
2055 
2056   if (test_run_count &gt; 0 &amp;&amp; test_run_count == test_skipped_count)
2057     return 77;
2058   else
2059     return 0;
2060 }
2061 
2062 /**
2063  * g_test_create_case:
2064  * @test_name:     the name for the test case
2065  * @data_size:     the size of the fixture data structure
2066  * @test_data:     test data argument for the test functions
2067  * @data_setup:    (scope async): the function to set up the fixture data
2068  * @data_test:     (scope async): the actual test function
2069  * @data_teardown: (scope async): the function to teardown the fixture data
2070  *
2071  * Create a new #GTestCase, named @test_name, this API is fairly
2072  * low level, calling g_test_add() or g_test_add_func() is preferable.
2073  * When this test is executed, a fixture structure of size @data_size
2074  * will be automatically allocated and filled with zeros. Then @data_setup is
2075  * called to initialize the fixture. After fixture setup, the actual test
2076  * function @data_test is called. Once the test run completes, the
2077  * fixture structure is torn down by calling @data_teardown and
2078  * after that the memory is automatically released by the test framework.
2079  *
2080  * Splitting up a test run into fixture setup, test function and
2081  * fixture teardown is most useful if the same fixture is used for
2082  * multiple tests. In this cases, g_test_create_case() will be
2083  * called with the same fixture, but varying @test_name and
2084  * @data_test arguments.
2085  *
2086  * Returns: a newly allocated #GTestCase.
2087  *
2088  * Since: 2.16
2089  */
2090 GTestCase*
2091 g_test_create_case (const char       *test_name,
2092                     gsize             data_size,
2093                     gconstpointer     test_data,
2094                     GTestFixtureFunc  data_setup,
2095                     GTestFixtureFunc  data_test,
2096                     GTestFixtureFunc  data_teardown)
2097 {
2098   GTestCase *tc;
2099 
2100   g_return_val_if_fail (test_name != NULL, NULL);
2101   g_return_val_if_fail (strchr (test_name, &#39;/&#39;) == NULL, NULL);
2102   g_return_val_if_fail (test_name[0] != 0, NULL);
2103   g_return_val_if_fail (data_test != NULL, NULL);
2104 
2105   tc = g_slice_new0 (GTestCase);
2106   tc-&gt;name = g_strdup (test_name);
2107   tc-&gt;test_data = (gpointer) test_data;
2108   tc-&gt;fixture_size = data_size;
2109   tc-&gt;fixture_setup = (void*) data_setup;
2110   tc-&gt;fixture_test = (void*) data_test;
2111   tc-&gt;fixture_teardown = (void*) data_teardown;
2112 
2113   return tc;
2114 }
2115 
2116 static gint
2117 find_suite (gconstpointer l, gconstpointer s)
2118 {
2119   const GTestSuite *suite = l;
2120   const gchar *str = s;
2121 
2122   return strcmp (suite-&gt;name, str);
2123 }
2124 
2125 static gint
2126 find_case (gconstpointer l, gconstpointer s)
2127 {
2128   const GTestCase *tc = l;
2129   const gchar *str = s;
2130 
2131   return strcmp (tc-&gt;name, str);
2132 }
2133 
2134 /**
2135  * GTestFixtureFunc:
2136  * @fixture: (not nullable): the test fixture
2137  * @user_data: the data provided when registering the test
2138  *
2139  * The type used for functions that operate on test fixtures.  This is
2140  * used for the fixture setup and teardown functions as well as for the
2141  * testcases themselves.
2142  *
2143  * @user_data is a pointer to the data that was given when registering
2144  * the test case.
2145  *
2146  * @fixture will be a pointer to the area of memory allocated by the
2147  * test framework, of the size requested.  If the requested size was
2148  * zero then @fixture will be equal to @user_data.
2149  *
2150  * Since: 2.28
2151  */
2152 void
2153 g_test_add_vtable (const char       *testpath,
2154                    gsize             data_size,
2155                    gconstpointer     test_data,
2156                    GTestFixtureFunc  data_setup,
2157                    GTestFixtureFunc  fixture_test_func,
2158                    GTestFixtureFunc  data_teardown)
2159 {
2160   gchar **segments;
2161   guint ui;
2162   GTestSuite *suite;
2163 
2164   g_return_if_fail (testpath != NULL);
2165   g_return_if_fail (g_path_is_absolute (testpath));
2166   g_return_if_fail (fixture_test_func != NULL);
<a name="50" id="anc50"></a><span class="line-added">2167   g_return_if_fail (!test_isolate_dirs || strstr (testpath, &quot;/.&quot;) == NULL);</span>
2168 
2169   suite = g_test_get_root();
2170   segments = g_strsplit (testpath, &quot;/&quot;, -1);
2171   for (ui = 0; segments[ui] != NULL; ui++)
2172     {
2173       const char *seg = segments[ui];
2174       gboolean islast = segments[ui + 1] == NULL;
2175       if (islast &amp;&amp; !seg[0])
2176         g_error (&quot;invalid test case path: %s&quot;, testpath);
2177       else if (!seg[0])
2178         continue;       /* initial or duplicate slash */
2179       else if (!islast)
2180         {
2181           GSList *l;
2182           GTestSuite *csuite;
2183           l = g_slist_find_custom (suite-&gt;suites, seg, find_suite);
2184           if (l)
2185             {
2186               csuite = l-&gt;data;
2187             }
2188           else
2189             {
2190               csuite = g_test_create_suite (seg);
2191               g_test_suite_add_suite (suite, csuite);
2192             }
2193           suite = csuite;
2194         }
2195       else /* islast */
2196         {
2197           GTestCase *tc;
2198 
2199           if (g_slist_find_custom (suite-&gt;cases, seg, find_case))
2200             g_error (&quot;duplicate test case path: %s&quot;, testpath);
2201 
2202           tc = g_test_create_case (seg, data_size, test_data, data_setup, fixture_test_func, data_teardown);
2203           g_test_suite_add (suite, tc);
2204         }
2205     }
2206   g_strfreev (segments);
2207 }
2208 
2209 /**
2210  * g_test_fail:
2211  *
2212  * Indicates that a test failed. This function can be called
2213  * multiple times from the same test. You can use this function
2214  * if your test failed in a recoverable way.
2215  *
2216  * Do not use this function if the failure of a test could cause
2217  * other tests to malfunction.
2218  *
2219  * Calling this function will not stop the test from running, you
2220  * need to return from the test function yourself. So you can
2221  * produce additional diagnostic messages or even continue running
2222  * the test.
2223  *
2224  * If not called from inside a test, this function does nothing.
2225  *
2226  * Since: 2.30
2227  **/
2228 void
2229 g_test_fail (void)
2230 {
2231   test_run_success = G_TEST_RUN_FAILURE;
2232 }
2233 
2234 /**
2235  * g_test_incomplete:
2236  * @msg: (nullable): explanation
2237  *
2238  * Indicates that a test failed because of some incomplete
2239  * functionality. This function can be called multiple times
2240  * from the same test.
2241  *
2242  * Calling this function will not stop the test from running, you
2243  * need to return from the test function yourself. So you can
2244  * produce additional diagnostic messages or even continue running
2245  * the test.
2246  *
2247  * If not called from inside a test, this function does nothing.
2248  *
2249  * Since: 2.38
2250  */
2251 void
2252 g_test_incomplete (const gchar *msg)
2253 {
2254   test_run_success = G_TEST_RUN_INCOMPLETE;
2255   g_free (test_run_msg);
2256   test_run_msg = g_strdup (msg);
2257 }
2258 
2259 /**
2260  * g_test_skip:
2261  * @msg: (nullable): explanation
2262  *
2263  * Indicates that a test was skipped.
2264  *
2265  * Calling this function will not stop the test from running, you
2266  * need to return from the test function yourself. So you can
2267  * produce additional diagnostic messages or even continue running
2268  * the test.
2269  *
2270  * If not called from inside a test, this function does nothing.
2271  *
2272  * Since: 2.38
2273  */
2274 void
2275 g_test_skip (const gchar *msg)
2276 {
2277   test_run_success = G_TEST_RUN_SKIPPED;
2278   g_free (test_run_msg);
2279   test_run_msg = g_strdup (msg);
2280 }
2281 
2282 /**
2283  * g_test_failed:
2284  *
2285  * Returns whether a test has already failed. This will
2286  * be the case when g_test_fail(), g_test_incomplete()
2287  * or g_test_skip() have been called, but also if an
2288  * assertion has failed.
2289  *
2290  * This can be useful to return early from a test if
2291  * continuing after a failed assertion might be harmful.
2292  *
2293  * The return value of this function is only meaningful
2294  * if it is called from inside a test function.
2295  *
2296  * Returns: %TRUE if the test has failed
2297  *
2298  * Since: 2.38
2299  */
2300 gboolean
2301 g_test_failed (void)
2302 {
2303   return test_run_success != G_TEST_RUN_SUCCESS;
2304 }
2305 
2306 /**
2307  * g_test_set_nonfatal_assertions:
2308  *
2309  * Changes the behaviour of g_assert_cmpstr(), g_assert_cmpint(),
2310  * g_assert_cmpuint(), g_assert_cmphex(), g_assert_cmpfloat(),
2311  * g_assert_true(), g_assert_false(), g_assert_null(), g_assert_no_error(),
2312  * g_assert_error(), g_test_assert_expected_messages() and the various
2313  * g_test_trap_assert_*() macros to not abort to program, but instead
2314  * call g_test_fail() and continue. (This also changes the behavior of
2315  * g_test_fail() so that it will not cause the test program to abort
2316  * after completing the failed test.)
2317  *
2318  * Note that the g_assert_not_reached() and g_assert() are not
2319  * affected by this.
2320  *
2321  * This function can only be called after g_test_init().
2322  *
2323  * Since: 2.38
2324  */
2325 void
2326 g_test_set_nonfatal_assertions (void)
2327 {
2328   if (!g_test_config_vars-&gt;test_initialized)
2329     g_error (&quot;g_test_set_nonfatal_assertions called without g_test_init&quot;);
2330   test_nonfatal_assertions = TRUE;
2331   test_mode_fatal = FALSE;
2332 }
2333 
2334 /**
2335  * GTestFunc:
2336  *
2337  * The type used for test case functions.
2338  *
2339  * Since: 2.28
2340  */
2341 
2342 /**
2343  * g_test_add_func:
2344  * @testpath:  /-separated test case path name for the test.
2345  * @test_func: (scope async):  The test function to invoke for this test.
2346  *
2347  * Create a new test case, similar to g_test_create_case(). However
2348  * the test is assumed to use no fixture, and test suites are automatically
2349  * created on the fly and added to the root fixture, based on the
2350  * slash-separated portions of @testpath.
2351  *
2352  * If @testpath includes the component &quot;subprocess&quot; anywhere in it,
2353  * the test will be skipped by default, and only run if explicitly
2354  * required via the `-p` command-line option or g_test_trap_subprocess().
2355  *
<a name="51" id="anc51"></a><span class="line-added">2356  * No component of @testpath may start with a dot (`.`) if the</span>
<span class="line-added">2357  * %G_TEST_OPTION_ISOLATE_DIRS option is being used; and it is recommended to</span>
<span class="line-added">2358  * do so even if it isn&#39;t.</span>
<span class="line-added">2359  *</span>
2360  * Since: 2.16
2361  */
2362 void
2363 g_test_add_func (const char *testpath,
2364                  GTestFunc   test_func)
2365 {
2366   g_return_if_fail (testpath != NULL);
2367   g_return_if_fail (testpath[0] == &#39;/&#39;);
2368   g_return_if_fail (test_func != NULL);
2369   g_test_add_vtable (testpath, 0, NULL, NULL, (GTestFixtureFunc) test_func, NULL);
2370 }
2371 
2372 /**
2373  * GTestDataFunc:
2374  * @user_data: the data provided when registering the test
2375  *
2376  * The type used for test case functions that take an extra pointer
2377  * argument.
2378  *
2379  * Since: 2.28
2380  */
2381 
2382 /**
2383  * g_test_add_data_func:
2384  * @testpath:  /-separated test case path name for the test.
2385  * @test_data: Test data argument for the test function.
2386  * @test_func: (scope async): The test function to invoke for this test.
2387  *
2388  * Create a new test case, similar to g_test_create_case(). However
2389  * the test is assumed to use no fixture, and test suites are automatically
2390  * created on the fly and added to the root fixture, based on the
2391  * slash-separated portions of @testpath. The @test_data argument
2392  * will be passed as first argument to @test_func.
2393  *
2394  * If @testpath includes the component &quot;subprocess&quot; anywhere in it,
2395  * the test will be skipped by default, and only run if explicitly
2396  * required via the `-p` command-line option or g_test_trap_subprocess().
2397  *
<a name="52" id="anc52"></a><span class="line-added">2398  * No component of @testpath may start with a dot (`.`) if the</span>
<span class="line-added">2399  * %G_TEST_OPTION_ISOLATE_DIRS option is being used; and it is recommended to</span>
<span class="line-added">2400  * do so even if it isn&#39;t.</span>
<span class="line-added">2401  *</span>
2402  * Since: 2.16
2403  */
2404 void
2405 g_test_add_data_func (const char     *testpath,
2406                       gconstpointer   test_data,
2407                       GTestDataFunc   test_func)
2408 {
2409   g_return_if_fail (testpath != NULL);
2410   g_return_if_fail (testpath[0] == &#39;/&#39;);
2411   g_return_if_fail (test_func != NULL);
2412 
2413   g_test_add_vtable (testpath, 0, test_data, NULL, (GTestFixtureFunc) test_func, NULL);
2414 }
2415 
2416 /**
2417  * g_test_add_data_func_full:
2418  * @testpath: /-separated test case path name for the test.
2419  * @test_data: Test data argument for the test function.
2420  * @test_func: The test function to invoke for this test.
2421  * @data_free_func: #GDestroyNotify for @test_data.
2422  *
2423  * Create a new test case, as with g_test_add_data_func(), but freeing
2424  * @test_data after the test run is complete.
2425  *
2426  * Since: 2.34
2427  */
2428 void
2429 g_test_add_data_func_full (const char     *testpath,
2430                            gpointer        test_data,
2431                            GTestDataFunc   test_func,
2432                            GDestroyNotify  data_free_func)
2433 {
2434   g_return_if_fail (testpath != NULL);
2435   g_return_if_fail (testpath[0] == &#39;/&#39;);
2436   g_return_if_fail (test_func != NULL);
2437 
2438   g_test_add_vtable (testpath, 0, test_data, NULL,
2439                      (GTestFixtureFunc) test_func,
2440                      (GTestFixtureFunc) data_free_func);
2441 }
2442 
2443 static gboolean
2444 g_test_suite_case_exists (GTestSuite *suite,
2445                           const char *test_path)
2446 {
2447   GSList *iter;
2448   char *slash;
2449   GTestCase *tc;
2450 
2451   test_path++;
2452   slash = strchr (test_path, &#39;/&#39;);
2453 
2454   if (slash)
2455     {
2456       for (iter = suite-&gt;suites; iter; iter = iter-&gt;next)
2457         {
2458           GTestSuite *child_suite = iter-&gt;data;
2459 
2460           if (!strncmp (child_suite-&gt;name, test_path, slash - test_path))
2461             if (g_test_suite_case_exists (child_suite, slash))
2462               return TRUE;
2463         }
2464     }
2465   else
2466     {
2467       for (iter = suite-&gt;cases; iter; iter = iter-&gt;next)
2468         {
2469           tc = iter-&gt;data;
2470           if (!strcmp (tc-&gt;name, test_path))
2471             return TRUE;
2472         }
2473     }
2474 
2475   return FALSE;
2476 }
2477 
2478 /**
2479  * g_test_create_suite:
2480  * @suite_name: a name for the suite
2481  *
2482  * Create a new test suite with the name @suite_name.
2483  *
2484  * Returns: A newly allocated #GTestSuite instance.
2485  *
2486  * Since: 2.16
2487  */
2488 GTestSuite*
2489 g_test_create_suite (const char *suite_name)
2490 {
2491   GTestSuite *ts;
2492   g_return_val_if_fail (suite_name != NULL, NULL);
2493   g_return_val_if_fail (strchr (suite_name, &#39;/&#39;) == NULL, NULL);
2494   g_return_val_if_fail (suite_name[0] != 0, NULL);
2495   ts = g_slice_new0 (GTestSuite);
2496   ts-&gt;name = g_strdup (suite_name);
2497   return ts;
2498 }
2499 
2500 /**
2501  * g_test_suite_add:
2502  * @suite: a #GTestSuite
2503  * @test_case: a #GTestCase
2504  *
2505  * Adds @test_case to @suite.
2506  *
2507  * Since: 2.16
2508  */
2509 void
2510 g_test_suite_add (GTestSuite     *suite,
2511                   GTestCase      *test_case)
2512 {
2513   g_return_if_fail (suite != NULL);
2514   g_return_if_fail (test_case != NULL);
2515 
2516   suite-&gt;cases = g_slist_append (suite-&gt;cases, test_case);
2517 }
2518 
2519 /**
2520  * g_test_suite_add_suite:
2521  * @suite:       a #GTestSuite
2522  * @nestedsuite: another #GTestSuite
2523  *
2524  * Adds @nestedsuite to @suite.
2525  *
2526  * Since: 2.16
2527  */
2528 void
2529 g_test_suite_add_suite (GTestSuite     *suite,
2530                         GTestSuite     *nestedsuite)
2531 {
2532   g_return_if_fail (suite != NULL);
2533   g_return_if_fail (nestedsuite != NULL);
2534 
2535   suite-&gt;suites = g_slist_append (suite-&gt;suites, nestedsuite);
2536 }
2537 
2538 /**
2539  * g_test_queue_free:
2540  * @gfree_pointer: the pointer to be stored.
2541  *
2542  * Enqueue a pointer to be released with g_free() during the next
2543  * teardown phase. This is equivalent to calling g_test_queue_destroy()
2544  * with a destroy callback of g_free().
2545  *
2546  * Since: 2.16
2547  */
2548 void
2549 g_test_queue_free (gpointer gfree_pointer)
2550 {
2551   if (gfree_pointer)
2552     g_test_queue_destroy (g_free, gfree_pointer);
2553 }
2554 
2555 /**
2556  * g_test_queue_destroy:
2557  * @destroy_func:       Destroy callback for teardown phase.
2558  * @destroy_data:       Destroy callback data.
2559  *
2560  * This function enqueus a callback @destroy_func to be executed
2561  * during the next test case teardown phase. This is most useful
2562  * to auto destruct allocated test resources at the end of a test run.
2563  * Resources are released in reverse queue order, that means enqueueing
2564  * callback A before callback B will cause B() to be called before
2565  * A() during teardown.
2566  *
2567  * Since: 2.16
2568  */
2569 void
2570 g_test_queue_destroy (GDestroyNotify destroy_func,
2571                       gpointer       destroy_data)
2572 {
2573   DestroyEntry *dentry;
2574 
2575   g_return_if_fail (destroy_func != NULL);
2576 
2577   dentry = g_slice_new0 (DestroyEntry);
2578   dentry-&gt;destroy_func = destroy_func;
2579   dentry-&gt;destroy_data = destroy_data;
2580   dentry-&gt;next = test_destroy_queue;
2581   test_destroy_queue = dentry;
2582 }
2583 
2584 static gboolean
2585 test_case_run (GTestCase *tc)
2586 {
2587   gchar *old_base = g_strdup (test_uri_base);
2588   GSList **old_free_list, *filename_free_list = NULL;
2589   gboolean success = G_TEST_RUN_SUCCESS;
2590 
2591   old_free_list = test_filename_free_list;
2592   test_filename_free_list = &amp;filename_free_list;
2593 
2594   if (++test_run_count &lt;= test_startup_skip_count)
2595     g_test_log (G_TEST_LOG_SKIP_CASE, test_run_name, NULL, 0, NULL);
2596   else if (test_run_list)
2597     {
2598       g_print (&quot;%s\n&quot;, test_run_name);
2599       g_test_log (G_TEST_LOG_LIST_CASE, test_run_name, NULL, 0, NULL);
2600     }
2601   else
2602     {
2603       GTimer *test_run_timer = g_timer_new();
2604       long double largs[3];
2605       void *fixture;
2606       g_test_log (G_TEST_LOG_START_CASE, test_run_name, NULL, 0, NULL);
2607       test_run_forks = 0;
2608       test_run_success = G_TEST_RUN_SUCCESS;
2609       g_clear_pointer (&amp;test_run_msg, g_free);
2610       g_test_log_set_fatal_handler (NULL, NULL);
2611       if (test_paths_skipped &amp;&amp; g_slist_find_custom (test_paths_skipped, test_run_name, (GCompareFunc)g_strcmp0))
2612         g_test_skip (&quot;by request (-s option)&quot;);
2613       else
2614         {
<a name="53" id="anc53"></a><span class="line-modified">2615           GError *local_error = NULL;</span>
<span class="line-modified">2616 </span>
<span class="line-modified">2617           if (!test_do_isolate_dirs (&amp;local_error))</span>
<span class="line-modified">2618             {</span>
<span class="line-modified">2619               g_test_log (G_TEST_LOG_ERROR, local_error-&gt;message, NULL, 0, NULL);</span>
<span class="line-modified">2620               g_test_fail ();</span>
<span class="line-modified">2621               g_error_free (local_error);</span>
<span class="line-modified">2622             }</span>
<span class="line-added">2623           else</span>
2624             {
<a name="54" id="anc54"></a><span class="line-modified">2625               g_timer_start (test_run_timer);</span>
<span class="line-modified">2626               fixture = tc-&gt;fixture_size ? g_malloc0 (tc-&gt;fixture_size) : tc-&gt;test_data;</span>
<span class="line-modified">2627               test_run_seed (test_run_seedstr);</span>
<span class="line-modified">2628               if (tc-&gt;fixture_setup)</span>
<span class="line-added">2629                 tc-&gt;fixture_setup (fixture, tc-&gt;test_data);</span>
<span class="line-added">2630               tc-&gt;fixture_test (fixture, tc-&gt;test_data);</span>
<span class="line-added">2631               test_trap_clear();</span>
<span class="line-added">2632               while (test_destroy_queue)</span>
<span class="line-added">2633                 {</span>
<span class="line-added">2634                   DestroyEntry *dentry = test_destroy_queue;</span>
<span class="line-added">2635                   test_destroy_queue = dentry-&gt;next;</span>
<span class="line-added">2636                   dentry-&gt;destroy_func (dentry-&gt;destroy_data);</span>
<span class="line-added">2637                   g_slice_free (DestroyEntry, dentry);</span>
<span class="line-added">2638                 }</span>
<span class="line-added">2639               if (tc-&gt;fixture_teardown)</span>
<span class="line-added">2640                 tc-&gt;fixture_teardown (fixture, tc-&gt;test_data);</span>
<span class="line-added">2641               if (tc-&gt;fixture_size)</span>
<span class="line-added">2642                 g_free (fixture);</span>
<span class="line-added">2643               g_timer_stop (test_run_timer);</span>
2644             }
<a name="55" id="anc55"></a><span class="line-modified">2645 </span>
<span class="line-modified">2646           test_rm_isolate_dirs ();</span>



2647         }
2648       success = test_run_success;
2649       test_run_success = G_TEST_RUN_FAILURE;
2650       largs[0] = success; /* OK */
2651       largs[1] = test_run_forks;
2652       largs[2] = g_timer_elapsed (test_run_timer, NULL);
2653       g_test_log (G_TEST_LOG_STOP_CASE, test_run_name, test_run_msg, G_N_ELEMENTS (largs), largs);
2654       g_clear_pointer (&amp;test_run_msg, g_free);
2655       g_timer_destroy (test_run_timer);
2656     }
2657 
2658   g_slist_free_full (filename_free_list, g_free);
2659   test_filename_free_list = old_free_list;
2660   g_free (test_uri_base);
2661   test_uri_base = old_base;
2662 
2663   return (success == G_TEST_RUN_SUCCESS ||
2664           success == G_TEST_RUN_SKIPPED ||
2665           success == G_TEST_RUN_INCOMPLETE);
2666 }
2667 
2668 static gboolean
2669 path_has_prefix (const char *path,
2670                  const char *prefix)
2671 {
2672   int prefix_len = strlen (prefix);
2673 
2674   return (strncmp (path, prefix, prefix_len) == 0 &amp;&amp;
2675           (path[prefix_len] == &#39;\0&#39; ||
2676            path[prefix_len] == &#39;/&#39;));
2677 }
2678 
2679 static gboolean
2680 test_should_run (const char *test_path,
2681                  const char *cmp_path)
2682 {
2683   if (strstr (test_run_name, &quot;/subprocess&quot;))
2684     {
2685       if (g_strcmp0 (test_path, cmp_path) == 0)
2686         return TRUE;
2687 
2688       if (g_test_verbose ())
2689         g_print (&quot;GTest: skipping: %s\n&quot;, test_run_name);
2690       return FALSE;
2691     }
2692 
2693   return !cmp_path || path_has_prefix (test_path, cmp_path);
2694 }
2695 
2696 /* Recurse through @suite, running tests matching @path (or all tests
2697  * if @path is %NULL).
2698  */
2699 static int
2700 g_test_run_suite_internal (GTestSuite *suite,
2701                            const char *path)
2702 {
2703   guint n_bad = 0;
2704   gchar *old_name = test_run_name;
2705   GSList *iter;
2706 
2707   g_return_val_if_fail (suite != NULL, -1);
2708 
2709   g_test_log (G_TEST_LOG_START_SUITE, suite-&gt;name, NULL, 0, NULL);
2710 
2711   for (iter = suite-&gt;cases; iter; iter = iter-&gt;next)
2712     {
2713       GTestCase *tc = iter-&gt;data;
2714 
2715       test_run_name = g_build_path (&quot;/&quot;, old_name, tc-&gt;name, NULL);
2716       if (test_should_run (test_run_name, path))
2717         {
2718           if (!test_case_run (tc))
2719             n_bad++;
2720         }
2721       g_free (test_run_name);
2722     }
2723 
2724   for (iter = suite-&gt;suites; iter; iter = iter-&gt;next)
2725     {
2726       GTestSuite *ts = iter-&gt;data;
2727 
2728       test_run_name = g_build_path (&quot;/&quot;, old_name, ts-&gt;name, NULL);
2729       if (!path || path_has_prefix (path, test_run_name))
2730         n_bad += g_test_run_suite_internal (ts, path);
2731       g_free (test_run_name);
2732     }
2733 
2734   test_run_name = old_name;
2735 
2736   g_test_log (G_TEST_LOG_STOP_SUITE, suite-&gt;name, NULL, 0, NULL);
2737 
2738   return n_bad;
2739 }
2740 
2741 static int
2742 g_test_suite_count (GTestSuite *suite)
2743 {
2744   int n = 0;
2745   GSList *iter;
2746 
2747   g_return_val_if_fail (suite != NULL, -1);
2748 
2749   for (iter = suite-&gt;cases; iter; iter = iter-&gt;next)
2750     {
2751       GTestCase *tc = iter-&gt;data;
2752 
2753       if (strcmp (tc-&gt;name, &quot;subprocess&quot;) != 0)
2754         n++;
2755     }
2756 
2757   for (iter = suite-&gt;suites; iter; iter = iter-&gt;next)
2758     {
2759       GTestSuite *ts = iter-&gt;data;
2760 
2761       if (strcmp (ts-&gt;name, &quot;subprocess&quot;) != 0)
2762         n += g_test_suite_count (ts);
2763     }
2764 
2765   return n;
2766 }
2767 
2768 /**
2769  * g_test_run_suite:
2770  * @suite: a #GTestSuite
2771  *
2772  * Execute the tests within @suite and all nested #GTestSuites.
2773  * The test suites to be executed are filtered according to
2774  * test path arguments (`-p testpath` and `-s testpath`) as parsed by
2775  * g_test_init(). See the g_test_run() documentation for more
2776  * information on the order that tests are run in.
2777  *
2778  * g_test_run_suite() or g_test_run() may only be called once
2779  * in a program.
2780  *
2781  * Returns: 0 on success
2782  *
2783  * Since: 2.16
2784  */
2785 int
2786 g_test_run_suite (GTestSuite *suite)
2787 {
2788   int n_bad = 0;
2789 
2790   g_return_val_if_fail (g_test_run_once == TRUE, -1);
2791 
2792   g_test_run_once = FALSE;
2793   test_count = g_test_suite_count (suite);
2794 
2795   test_run_name = g_strdup_printf (&quot;/%s&quot;, suite-&gt;name);
2796 
2797   if (test_paths)
2798     {
2799       GSList *iter;
2800 
2801       for (iter = test_paths; iter; iter = iter-&gt;next)
2802         n_bad += g_test_run_suite_internal (suite, iter-&gt;data);
2803     }
2804   else
2805     n_bad = g_test_run_suite_internal (suite, NULL);
2806 
2807   g_free (test_run_name);
2808   test_run_name = NULL;
2809 
2810   return n_bad;
2811 }
2812 
2813 static void
2814 gtest_default_log_handler (const gchar    *log_domain,
2815                            GLogLevelFlags  log_level,
2816                            const gchar    *message,
2817                            gpointer        unused_data)
2818 {
2819   const gchar *strv[16];
2820   gboolean fatal = FALSE;
2821   gchar *msg;
2822   guint i = 0;
2823 
2824   if (log_domain)
2825     {
2826       strv[i++] = log_domain;
2827       strv[i++] = &quot;-&quot;;
2828     }
2829   if (log_level &amp; G_LOG_FLAG_FATAL)
2830     {
2831       strv[i++] = &quot;FATAL-&quot;;
2832       fatal = TRUE;
2833     }
2834   if (log_level &amp; G_LOG_FLAG_RECURSION)
2835     strv[i++] = &quot;RECURSIVE-&quot;;
2836   if (log_level &amp; G_LOG_LEVEL_ERROR)
2837     strv[i++] = &quot;ERROR&quot;;
2838   if (log_level &amp; G_LOG_LEVEL_CRITICAL)
2839     strv[i++] = &quot;CRITICAL&quot;;
2840   if (log_level &amp; G_LOG_LEVEL_WARNING)
2841     strv[i++] = &quot;WARNING&quot;;
2842   if (log_level &amp; G_LOG_LEVEL_MESSAGE)
2843     strv[i++] = &quot;MESSAGE&quot;;
2844   if (log_level &amp; G_LOG_LEVEL_INFO)
2845     strv[i++] = &quot;INFO&quot;;
2846   if (log_level &amp; G_LOG_LEVEL_DEBUG)
2847     strv[i++] = &quot;DEBUG&quot;;
2848   strv[i++] = &quot;: &quot;;
2849   strv[i++] = message;
2850   strv[i++] = NULL;
2851 
2852   msg = g_strjoinv (&quot;&quot;, (gchar**) strv);
2853   g_test_log (fatal ? G_TEST_LOG_ERROR : G_TEST_LOG_MESSAGE, msg, NULL, 0, NULL);
2854   g_log_default_handler (log_domain, log_level, message, unused_data);
2855 
2856   g_free (msg);
2857 }
2858 
2859 void
2860 g_assertion_message (const char     *domain,
2861                      const char     *file,
2862                      int             line,
2863                      const char     *func,
2864                      const char     *message)
2865 {
2866   char lstr[32];
2867   char *s;
2868 
2869   if (!message)
2870     message = &quot;code should not be reached&quot;;
2871   g_snprintf (lstr, 32, &quot;%d&quot;, line);
2872   s = g_strconcat (domain ? domain : &quot;&quot;, domain &amp;&amp; domain[0] ? &quot;:&quot; : &quot;&quot;,
2873                    &quot;ERROR:&quot;, file, &quot;:&quot;, lstr, &quot;:&quot;,
2874                    func, func[0] ? &quot;:&quot; : &quot;&quot;,
2875                    &quot; &quot;, message, NULL);
2876   g_printerr (&quot;**\n%s\n&quot;, s);
2877 
2878   /* Don&#39;t print a fatal error indication if assertions are non-fatal, or
2879    * if we are a child process that might be sharing the parent&#39;s stdout. */
2880   if (test_nonfatal_assertions || test_in_subprocess || test_in_forked_child)
2881     g_test_log (G_TEST_LOG_MESSAGE, s, NULL, 0, NULL);
2882   else
2883     g_test_log (G_TEST_LOG_ERROR, s, NULL, 0, NULL);
2884 
2885   if (test_nonfatal_assertions)
2886     {
2887       g_free (s);
2888       g_test_fail ();
2889       return;
2890     }
2891 
2892   /* store assertion message in global variable, so that it can be found in a
2893    * core dump */
2894   if (__glib_assert_msg != NULL)
2895     /* free the old one */
2896     free (__glib_assert_msg);
2897   __glib_assert_msg = (char*) malloc (strlen (s) + 1);
2898   strcpy (__glib_assert_msg, s);
2899 
2900   g_free (s);
2901 
2902   if (test_in_subprocess)
2903     {
2904       /* If this is a test case subprocess then it probably hit this
2905        * assertion on purpose, so just exit() rather than abort()ing,
2906        * to avoid triggering any system crash-reporting daemon.
2907        */
2908       _exit (1);
2909     }
2910   else
2911     g_abort ();
2912 }
2913 
2914 /**
2915  * g_assertion_message_expr: (skip)
<a name="56" id="anc56"></a><span class="line-modified">2916  * @domain: (nullable): log domain</span>
<span class="line-modified">2917  * @file: file containing the assertion</span>
<span class="line-modified">2918  * @line: line number of the assertion</span>
<span class="line-modified">2919  * @func: function containing the assertion</span>
<span class="line-modified">2920  * @expr: (nullable): expression which failed</span>
<span class="line-added">2921  *</span>
<span class="line-added">2922  * Internal function used to print messages from the public g_assert() and</span>
<span class="line-added">2923  * g_assert_not_reached() macros.</span>
2924  */
2925 void
2926 g_assertion_message_expr (const char     *domain,
2927                           const char     *file,
2928                           int             line,
2929                           const char     *func,
2930                           const char     *expr)
2931 {
2932   char *s;
2933   if (!expr)
2934     s = g_strdup (&quot;code should not be reached&quot;);
2935   else
2936     s = g_strconcat (&quot;assertion failed: (&quot;, expr, &quot;)&quot;, NULL);
2937   g_assertion_message (domain, file, line, func, s);
2938   g_free (s);
2939 
2940   /* Normally g_assertion_message() won&#39;t return, but we need this for
2941    * when test_nonfatal_assertions is set, since
2942    * g_assertion_message_expr() is used for always-fatal assertions.
2943    */
2944   if (test_in_subprocess)
2945     _exit (1);
2946   else
2947     g_abort ();
2948 }
2949 
2950 void
2951 g_assertion_message_cmpnum (const char     *domain,
2952                             const char     *file,
2953                             int             line,
2954                             const char     *func,
2955                             const char     *expr,
2956                             long double     arg1,
2957                             const char     *cmp,
2958                             long double     arg2,
2959                             char            numtype)
2960 {
2961   char *s = NULL;
2962 
2963   switch (numtype)
2964     {
2965     case &#39;i&#39;:   s = g_strdup_printf (&quot;assertion failed (%s): (%&quot; G_GINT64_MODIFIER &quot;i %s %&quot; G_GINT64_MODIFIER &quot;i)&quot;, expr, (gint64) arg1, cmp, (gint64) arg2); break;
2966     case &#39;x&#39;:   s = g_strdup_printf (&quot;assertion failed (%s): (0x%08&quot; G_GINT64_MODIFIER &quot;x %s 0x%08&quot; G_GINT64_MODIFIER &quot;x)&quot;, expr, (guint64) arg1, cmp, (guint64) arg2); break;
2967     case &#39;f&#39;:   s = g_strdup_printf (&quot;assertion failed (%s): (%.9g %s %.9g)&quot;, expr, (double) arg1, cmp, (double) arg2); break;
2968       /* ideally use: floats=%.7g double=%.17g */
2969     }
2970   g_assertion_message (domain, file, line, func, s);
2971   g_free (s);
2972 }
2973 
2974 void
2975 g_assertion_message_cmpstr (const char     *domain,
2976                             const char     *file,
2977                             int             line,
2978                             const char     *func,
2979                             const char     *expr,
2980                             const char     *arg1,
2981                             const char     *cmp,
2982                             const char     *arg2)
2983 {
2984   char *a1, *a2, *s, *t1 = NULL, *t2 = NULL;
2985   a1 = arg1 ? g_strconcat (&quot;\&quot;&quot;, t1 = g_strescape (arg1, NULL), &quot;\&quot;&quot;, NULL) : g_strdup (&quot;NULL&quot;);
2986   a2 = arg2 ? g_strconcat (&quot;\&quot;&quot;, t2 = g_strescape (arg2, NULL), &quot;\&quot;&quot;, NULL) : g_strdup (&quot;NULL&quot;);
2987   g_free (t1);
2988   g_free (t2);
2989   s = g_strdup_printf (&quot;assertion failed (%s): (%s %s %s)&quot;, expr, a1, cmp, a2);
2990   g_free (a1);
2991   g_free (a2);
2992   g_assertion_message (domain, file, line, func, s);
2993   g_free (s);
2994 }
2995 
2996 void
2997 g_assertion_message_error (const char     *domain,
<a name="57" id="anc57"></a><span class="line-modified">2998          const char     *file,</span>
<span class="line-modified">2999          int             line,</span>
<span class="line-modified">3000          const char     *func,</span>
<span class="line-modified">3001          const char     *expr,</span>
<span class="line-modified">3002          const GError   *error,</span>
<span class="line-modified">3003          GQuark          error_domain,</span>
<span class="line-modified">3004          int             error_code)</span>
3005 {
3006   GString *gstring;
3007 
3008   /* This is used by both g_assert_error() and g_assert_no_error(), so there
3009    * are three cases: expected an error but got the wrong error, expected
3010    * an error but got no error, and expected no error but got an error.
3011    */
3012 
3013   gstring = g_string_new (&quot;assertion failed &quot;);
3014   if (error_domain)
3015       g_string_append_printf (gstring, &quot;(%s == (%s, %d)): &quot;, expr,
<a name="58" id="anc58"></a><span class="line-modified">3016             g_quark_to_string (error_domain), error_code);</span>
3017   else
3018     g_string_append_printf (gstring, &quot;(%s == NULL): &quot;, expr);
3019 
3020   if (error)
3021       g_string_append_printf (gstring, &quot;%s (%s, %d)&quot;, error-&gt;message,
<a name="59" id="anc59"></a><span class="line-modified">3022             g_quark_to_string (error-&gt;domain), error-&gt;code);</span>
3023   else
3024     g_string_append_printf (gstring, &quot;%s is NULL&quot;, expr);
3025 
3026   g_assertion_message (domain, file, line, func, gstring-&gt;str);
3027   g_string_free (gstring, TRUE);
3028 }
3029 
3030 /**
3031  * g_strcmp0:
3032  * @str1: (nullable): a C string or %NULL
3033  * @str2: (nullable): another C string or %NULL
3034  *
3035  * Compares @str1 and @str2 like strcmp(). Handles %NULL
3036  * gracefully by sorting it before non-%NULL strings.
3037  * Comparing two %NULL pointers returns 0.
3038  *
3039  * Returns: an integer less than, equal to, or greater than zero, if @str1 is &lt;, == or &gt; than @str2.
3040  *
3041  * Since: 2.16
3042  */
3043 int
3044 g_strcmp0 (const char     *str1,
3045            const char     *str2)
3046 {
3047   if (!str1)
3048     return -(str1 != str2);
3049   if (!str2)
3050     return str1 != str2;
3051   return strcmp (str1, str2);
3052 }
3053 
3054 static void
3055 test_trap_clear (void)
3056 {
3057   test_trap_last_status = 0;
3058   test_trap_last_pid = 0;
3059   g_clear_pointer (&amp;test_trap_last_subprocess, g_free);
3060   g_clear_pointer (&amp;test_trap_last_stdout, g_free);
3061   g_clear_pointer (&amp;test_trap_last_stderr, g_free);
3062 }
3063 
3064 #ifdef G_OS_UNIX
3065 
3066 static int
3067 sane_dup2 (int fd1,
3068            int fd2)
3069 {
3070   int ret;
3071   do
3072     ret = dup2 (fd1, fd2);
3073   while (ret &lt; 0 &amp;&amp; errno == EINTR);
3074   return ret;
3075 }
3076 
3077 #endif
3078 
3079 typedef struct {
3080   GPid pid;
3081   GMainLoop *loop;
3082   int child_status;  /* unmodified platform-specific status */
3083 
3084   GIOChannel *stdout_io;
3085   gboolean echo_stdout;
3086   GString *stdout_str;
3087 
3088   GIOChannel *stderr_io;
3089   gboolean echo_stderr;
3090   GString *stderr_str;
3091 } WaitForChildData;
3092 
3093 static void
3094 check_complete (WaitForChildData *data)
3095 {
3096   if (data-&gt;child_status != -1 &amp;&amp; data-&gt;stdout_io == NULL &amp;&amp; data-&gt;stderr_io == NULL)
3097     g_main_loop_quit (data-&gt;loop);
3098 }
3099 
3100 static void
3101 child_exited (GPid     pid,
3102               gint     status,
3103               gpointer user_data)
3104 {
3105   WaitForChildData *data = user_data;
3106 
3107   g_assert (status != -1);
3108   data-&gt;child_status = status;
3109 
3110   check_complete (data);
3111 }
3112 
3113 static gboolean
3114 child_timeout (gpointer user_data)
3115 {
3116   WaitForChildData *data = user_data;
3117 
3118 #ifdef G_OS_WIN32
3119   TerminateProcess (data-&gt;pid, G_TEST_STATUS_TIMED_OUT);
3120 #else
3121   kill (data-&gt;pid, SIGALRM);
3122 #endif
3123 
3124   return FALSE;
3125 }
3126 
3127 static gboolean
3128 child_read (GIOChannel *io, GIOCondition cond, gpointer user_data)
3129 {
3130   WaitForChildData *data = user_data;
3131   GIOStatus status;
3132   gsize nread, nwrote, total;
3133   gchar buf[4096];
3134   FILE *echo_file = NULL;
3135 
3136   status = g_io_channel_read_chars (io, buf, sizeof (buf), &amp;nread, NULL);
3137   if (status == G_IO_STATUS_ERROR || status == G_IO_STATUS_EOF)
3138     {
3139       // FIXME data-&gt;error = (status == G_IO_STATUS_ERROR);
3140       if (io == data-&gt;stdout_io)
3141         g_clear_pointer (&amp;data-&gt;stdout_io, g_io_channel_unref);
3142       else
3143         g_clear_pointer (&amp;data-&gt;stderr_io, g_io_channel_unref);
3144 
3145       check_complete (data);
3146       return FALSE;
3147     }
3148   else if (status == G_IO_STATUS_AGAIN)
3149     return TRUE;
3150 
3151   if (io == data-&gt;stdout_io)
3152     {
3153       g_string_append_len (data-&gt;stdout_str, buf, nread);
3154       if (data-&gt;echo_stdout)
3155         echo_file = stdout;
3156     }
3157   else
3158     {
3159       g_string_append_len (data-&gt;stderr_str, buf, nread);
3160       if (data-&gt;echo_stderr)
3161         echo_file = stderr;
3162     }
3163 
3164   if (echo_file)
3165     {
3166       for (total = 0; total &lt; nread; total += nwrote)
3167         {
3168           int errsv;
3169 
3170           nwrote = fwrite (buf + total, 1, nread - total, echo_file);
3171           errsv = errno;
3172           if (nwrote == 0)
3173             g_error (&quot;write failed: %s&quot;, g_strerror (errsv));
3174         }
3175     }
3176 
3177   return TRUE;
3178 }
3179 
3180 static void
3181 wait_for_child (GPid pid,
3182                 int stdout_fd, gboolean echo_stdout,
3183                 int stderr_fd, gboolean echo_stderr,
3184                 guint64 timeout)
3185 {
3186   WaitForChildData data;
3187   GMainContext *context;
3188   GSource *source;
3189 
3190   data.pid = pid;
3191   data.child_status = -1;
3192 
3193   context = g_main_context_new ();
3194   data.loop = g_main_loop_new (context, FALSE);
3195 
3196   source = g_child_watch_source_new (pid);
3197   g_source_set_callback (source, (GSourceFunc) child_exited, &amp;data, NULL);
3198   g_source_attach (source, context);
3199   g_source_unref (source);
3200 
3201   data.echo_stdout = echo_stdout;
3202   data.stdout_str = g_string_new (NULL);
3203   data.stdout_io = g_io_channel_unix_new (stdout_fd);
3204   g_io_channel_set_close_on_unref (data.stdout_io, TRUE);
3205   g_io_channel_set_encoding (data.stdout_io, NULL, NULL);
3206   g_io_channel_set_buffered (data.stdout_io, FALSE);
3207   source = g_io_create_watch (data.stdout_io, G_IO_IN | G_IO_ERR | G_IO_HUP);
3208   g_source_set_callback (source, (GSourceFunc) child_read, &amp;data, NULL);
3209   g_source_attach (source, context);
3210   g_source_unref (source);
3211 
3212   data.echo_stderr = echo_stderr;
3213   data.stderr_str = g_string_new (NULL);
3214   data.stderr_io = g_io_channel_unix_new (stderr_fd);
3215   g_io_channel_set_close_on_unref (data.stderr_io, TRUE);
3216   g_io_channel_set_encoding (data.stderr_io, NULL, NULL);
3217   g_io_channel_set_buffered (data.stderr_io, FALSE);
3218   source = g_io_create_watch (data.stderr_io, G_IO_IN | G_IO_ERR | G_IO_HUP);
3219   g_source_set_callback (source, (GSourceFunc) child_read, &amp;data, NULL);
3220   g_source_attach (source, context);
3221   g_source_unref (source);
3222 
3223   if (timeout)
3224     {
3225       source = g_timeout_source_new (0);
3226       g_source_set_ready_time (source, g_get_monotonic_time () + timeout);
3227       g_source_set_callback (source, (GSourceFunc) child_timeout, &amp;data, NULL);
3228       g_source_attach (source, context);
3229       g_source_unref (source);
3230     }
3231 
3232   g_main_loop_run (data.loop);
3233   g_main_loop_unref (data.loop);
3234   g_main_context_unref (context);
3235 
3236   test_trap_last_pid = pid;
3237   test_trap_last_status = data.child_status;
3238   test_trap_last_stdout = g_string_free (data.stdout_str, FALSE);
3239   test_trap_last_stderr = g_string_free (data.stderr_str, FALSE);
3240 
3241   g_clear_pointer (&amp;data.stdout_io, g_io_channel_unref);
3242   g_clear_pointer (&amp;data.stderr_io, g_io_channel_unref);
3243 }
3244 
3245 /**
3246  * g_test_trap_fork:
3247  * @usec_timeout:    Timeout for the forked test in micro seconds.
3248  * @test_trap_flags: Flags to modify forking behaviour.
3249  *
3250  * Fork the current test program to execute a test case that might
3251  * not return or that might abort.
3252  *
3253  * If @usec_timeout is non-0, the forked test case is aborted and
3254  * considered failing if its run time exceeds it.
3255  *
3256  * The forking behavior can be configured with the #GTestTrapFlags flags.
3257  *
3258  * In the following example, the test code forks, the forked child
3259  * process produces some sample output and exits successfully.
3260  * The forking parent process then asserts successful child program
3261  * termination and validates child program outputs.
3262  *
3263  * |[&lt;!-- language=&quot;C&quot; --&gt;
3264  *   static void
3265  *   test_fork_patterns (void)
3266  *   {
3267  *     if (g_test_trap_fork (0, G_TEST_TRAP_SILENCE_STDOUT | G_TEST_TRAP_SILENCE_STDERR))
3268  *       {
3269  *         g_print (&quot;some stdout text: somagic17\n&quot;);
3270  *         g_printerr (&quot;some stderr text: semagic43\n&quot;);
3271  *         exit (0); // successful test run
3272  *       }
3273  *     g_test_trap_assert_passed ();
3274  *     g_test_trap_assert_stdout (&quot;*somagic17*&quot;);
3275  *     g_test_trap_assert_stderr (&quot;*semagic43*&quot;);
3276  *   }
3277  * ]|
3278  *
3279  * Returns: %TRUE for the forked child and %FALSE for the executing parent process.
3280  *
3281  * Since: 2.16
3282  *
3283  * Deprecated: This function is implemented only on Unix platforms,
3284  * and is not always reliable due to problems inherent in
3285  * fork-without-exec. Use g_test_trap_subprocess() instead.
3286  */
<a name="60" id="anc60"></a><span class="line-added">3287 G_GNUC_BEGIN_IGNORE_DEPRECATIONS</span>
3288 gboolean
3289 g_test_trap_fork (guint64        usec_timeout,
3290                   GTestTrapFlags test_trap_flags)
3291 {
3292 #ifdef G_OS_UNIX
3293   int stdout_pipe[2] = { -1, -1 };
3294   int stderr_pipe[2] = { -1, -1 };
3295   int errsv;
3296 
3297   test_trap_clear();
3298   if (pipe (stdout_pipe) &lt; 0 || pipe (stderr_pipe) &lt; 0)
3299     {
3300       errsv = errno;
3301       g_error (&quot;failed to create pipes to fork test program: %s&quot;, g_strerror (errsv));
3302     }
3303   test_trap_last_pid = fork ();
3304   errsv = errno;
3305   if (test_trap_last_pid &lt; 0)
3306     g_error (&quot;failed to fork test program: %s&quot;, g_strerror (errsv));
3307   if (test_trap_last_pid == 0)  /* child */
3308     {
3309       int fd0 = -1;
3310       test_in_forked_child = TRUE;
3311       close (stdout_pipe[0]);
3312       close (stderr_pipe[0]);
3313       if (!(test_trap_flags &amp; G_TEST_TRAP_INHERIT_STDIN))
3314         {
3315           fd0 = g_open (&quot;/dev/null&quot;, O_RDONLY, 0);
3316           if (fd0 &lt; 0)
3317             g_error (&quot;failed to open /dev/null for stdin redirection&quot;);
3318         }
3319       if (sane_dup2 (stdout_pipe[1], 1) &lt; 0 || sane_dup2 (stderr_pipe[1], 2) &lt; 0 || (fd0 &gt;= 0 &amp;&amp; sane_dup2 (fd0, 0) &lt; 0))
3320         {
3321           errsv = errno;
3322           g_error (&quot;failed to dup2() in forked test program: %s&quot;, g_strerror (errsv));
3323         }
3324       if (fd0 &gt;= 3)
3325         close (fd0);
3326       if (stdout_pipe[1] &gt;= 3)
3327         close (stdout_pipe[1]);
3328       if (stderr_pipe[1] &gt;= 3)
3329         close (stderr_pipe[1]);
<a name="61" id="anc61"></a><span class="line-added">3330 </span>
<span class="line-added">3331       /* We typically expect these child processes to crash, and some</span>
<span class="line-added">3332        * tests spawn a *lot* of them.  Avoid spamming system crash</span>
<span class="line-added">3333        * collection programs such as systemd-coredump and abrt.</span>
<span class="line-added">3334        */</span>
<span class="line-added">3335 #ifdef HAVE_SYS_RESOURCE_H</span>
<span class="line-added">3336       {</span>
<span class="line-added">3337         struct rlimit limit = { 0, 0 };</span>
<span class="line-added">3338         (void) setrlimit (RLIMIT_CORE, &amp;limit);</span>
<span class="line-added">3339       }</span>
<span class="line-added">3340 #endif</span>
<span class="line-added">3341 </span>
3342       return TRUE;
3343     }
3344   else                          /* parent */
3345     {
3346       test_run_forks++;
3347       close (stdout_pipe[1]);
3348       close (stderr_pipe[1]);
3349 
3350       wait_for_child (test_trap_last_pid,
3351                       stdout_pipe[0], !(test_trap_flags &amp; G_TEST_TRAP_SILENCE_STDOUT),
3352                       stderr_pipe[0], !(test_trap_flags &amp; G_TEST_TRAP_SILENCE_STDERR),
3353                       usec_timeout);
3354       return FALSE;
3355     }
3356 #else
3357   g_message (&quot;Not implemented: g_test_trap_fork&quot;);
3358 
3359   return FALSE;
3360 #endif
3361 }
<a name="62" id="anc62"></a><span class="line-added">3362 G_GNUC_END_IGNORE_DEPRECATIONS</span>
3363 
3364 /**
3365  * g_test_trap_subprocess:
3366  * @test_path: (nullable): Test to run in a subprocess
3367  * @usec_timeout: Timeout for the subprocess test in micro seconds.
3368  * @test_flags:   Flags to modify subprocess behaviour.
3369  *
3370  * Respawns the test program to run only @test_path in a subprocess.
3371  * This can be used for a test case that might not return, or that
3372  * might abort.
3373  *
3374  * If @test_path is %NULL then the same test is re-run in a subprocess.
3375  * You can use g_test_subprocess() to determine whether the test is in
3376  * a subprocess or not.
3377  *
3378  * @test_path can also be the name of the parent test, followed by
3379  * &quot;`/subprocess/`&quot; and then a name for the specific subtest (or just
3380  * ending with &quot;`/subprocess`&quot; if the test only has one child test);
3381  * tests with names of this form will automatically be skipped in the
3382  * parent process.
3383  *
3384  * If @usec_timeout is non-0, the test subprocess is aborted and
3385  * considered failing if its run time exceeds it.
3386  *
3387  * The subprocess behavior can be configured with the
3388  * #GTestSubprocessFlags flags.
3389  *
3390  * You can use methods such as g_test_trap_assert_passed(),
3391  * g_test_trap_assert_failed(), and g_test_trap_assert_stderr() to
3392  * check the results of the subprocess. (But note that
3393  * g_test_trap_assert_stdout() and g_test_trap_assert_stderr()
3394  * cannot be used if @test_flags specifies that the child should
3395  * inherit the parent stdout/stderr.)
3396  *
3397  * If your `main ()` needs to behave differently in
3398  * the subprocess, you can call g_test_subprocess() (after calling
3399  * g_test_init()) to see whether you are in a subprocess.
3400  *
3401  * The following example tests that calling
3402  * `my_object_new(1000000)` will abort with an error
3403  * message.
3404  *
3405  * |[&lt;!-- language=&quot;C&quot; --&gt;
3406  *   static void
3407  *   test_create_large_object (void)
3408  *   {
3409  *     if (g_test_subprocess ())
3410  *       {
3411  *         my_object_new (1000000);
3412  *         return;
3413  *       }
3414  *
3415  *     // Reruns this same test in a subprocess
3416  *     g_test_trap_subprocess (NULL, 0, 0);
3417  *     g_test_trap_assert_failed ();
3418  *     g_test_trap_assert_stderr (&quot;*ERROR*too large*&quot;);
3419  *   }
3420  *
3421  *   int
3422  *   main (int argc, char **argv)
3423  *   {
3424  *     g_test_init (&amp;argc, &amp;argv, NULL);
3425  *
3426  *     g_test_add_func (&quot;/myobject/create_large_object&quot;,
3427  *                      test_create_large_object);
3428  *     return g_test_run ();
3429  *   }
3430  * ]|
3431  *
3432  * Since: 2.38
3433  */
3434 void
3435 g_test_trap_subprocess (const char           *test_path,
3436                         guint64               usec_timeout,
3437                         GTestSubprocessFlags  test_flags)
3438 {
3439   GError *error = NULL;
3440   GPtrArray *argv;
3441   GSpawnFlags flags;
3442   int stdout_fd, stderr_fd;
3443   GPid pid;
3444 
3445   /* Sanity check that they used GTestSubprocessFlags, not GTestTrapFlags */
3446   g_assert ((test_flags &amp; (G_TEST_TRAP_INHERIT_STDIN | G_TEST_TRAP_SILENCE_STDOUT | G_TEST_TRAP_SILENCE_STDERR)) == 0);
3447 
3448   if (test_path)
3449     {
3450       if (!g_test_suite_case_exists (g_test_get_root (), test_path))
3451         g_error (&quot;g_test_trap_subprocess: test does not exist: %s&quot;, test_path);
3452     }
3453   else
3454     {
3455       test_path = test_run_name;
3456     }
3457 
3458   if (g_test_verbose ())
3459     g_print (&quot;GTest: subprocess: %s\n&quot;, test_path);
3460 
3461   test_trap_clear ();
3462   test_trap_last_subprocess = g_strdup (test_path);
3463 
3464   argv = g_ptr_array_new ();
3465   g_ptr_array_add (argv, test_argv0);
3466   g_ptr_array_add (argv, &quot;-q&quot;);
3467   g_ptr_array_add (argv, &quot;-p&quot;);
3468   g_ptr_array_add (argv, (char *)test_path);
3469   g_ptr_array_add (argv, &quot;--GTestSubprocess&quot;);
3470   if (test_log_fd != -1)
3471     {
3472       char log_fd_buf[128];
3473 
3474       g_ptr_array_add (argv, &quot;--GTestLogFD&quot;);
3475       g_snprintf (log_fd_buf, sizeof (log_fd_buf), &quot;%d&quot;, test_log_fd);
3476       g_ptr_array_add (argv, log_fd_buf);
3477     }
3478   g_ptr_array_add (argv, NULL);
3479 
3480   flags = G_SPAWN_DO_NOT_REAP_CHILD;
<a name="63" id="anc63"></a><span class="line-added">3481   if (test_log_fd != -1)</span>
<span class="line-added">3482     flags |= G_SPAWN_LEAVE_DESCRIPTORS_OPEN;</span>
3483   if (test_flags &amp; G_TEST_TRAP_INHERIT_STDIN)
3484     flags |= G_SPAWN_CHILD_INHERITS_STDIN;
3485 
3486   if (!g_spawn_async_with_pipes (test_initial_cwd,
3487                                  (char **)argv-&gt;pdata,
3488                                  NULL, flags,
3489                                  NULL, NULL,
3490                                  &amp;pid, NULL, &amp;stdout_fd, &amp;stderr_fd,
3491                                  &amp;error))
3492     {
3493       g_error (&quot;g_test_trap_subprocess() failed: %s&quot;,
3494                error-&gt;message);
3495     }
3496   g_ptr_array_free (argv, TRUE);
3497 
3498   wait_for_child (pid,
3499                   stdout_fd, !!(test_flags &amp; G_TEST_SUBPROCESS_INHERIT_STDOUT),
3500                   stderr_fd, !!(test_flags &amp; G_TEST_SUBPROCESS_INHERIT_STDERR),
3501                   usec_timeout);
3502 }
3503 
3504 /**
3505  * g_test_subprocess:
3506  *
3507  * Returns %TRUE (after g_test_init() has been called) if the test
3508  * program is running under g_test_trap_subprocess().
3509  *
3510  * Returns: %TRUE if the test program is running under
3511  * g_test_trap_subprocess().
3512  *
3513  * Since: 2.38
3514  */
3515 gboolean
3516 g_test_subprocess (void)
3517 {
3518   return test_in_subprocess;
3519 }
3520 
3521 /**
3522  * g_test_trap_has_passed:
3523  *
3524  * Check the result of the last g_test_trap_subprocess() call.
3525  *
3526  * Returns: %TRUE if the last test subprocess terminated successfully.
3527  *
3528  * Since: 2.16
3529  */
3530 gboolean
3531 g_test_trap_has_passed (void)
3532 {
3533 #ifdef G_OS_UNIX
3534   return (WIFEXITED (test_trap_last_status) &amp;&amp;
3535       WEXITSTATUS (test_trap_last_status) == 0);
3536 #else
3537   return test_trap_last_status == 0;
3538 #endif
3539 }
3540 
3541 /**
3542  * g_test_trap_reached_timeout:
3543  *
3544  * Check the result of the last g_test_trap_subprocess() call.
3545  *
3546  * Returns: %TRUE if the last test subprocess got killed due to a timeout.
3547  *
3548  * Since: 2.16
3549  */
3550 gboolean
3551 g_test_trap_reached_timeout (void)
3552 {
3553 #ifdef G_OS_UNIX
3554   return (WIFSIGNALED (test_trap_last_status) &amp;&amp;
3555       WTERMSIG (test_trap_last_status) == SIGALRM);
3556 #else
3557   return test_trap_last_status == G_TEST_STATUS_TIMED_OUT;
3558 #endif
3559 }
3560 
3561 static gboolean
3562 log_child_output (const gchar *process_id)
3563 {
3564   gchar *escaped;
3565 
3566 #ifdef G_OS_UNIX
3567   if (WIFEXITED (test_trap_last_status)) /* normal exit */
3568     {
3569       if (WEXITSTATUS (test_trap_last_status) == 0)
3570         g_test_message (&quot;child process (%s) exit status: 0 (success)&quot;,
3571             process_id);
3572       else
3573         g_test_message (&quot;child process (%s) exit status: %d (error)&quot;,
3574             process_id, WEXITSTATUS (test_trap_last_status));
3575     }
3576   else if (WIFSIGNALED (test_trap_last_status) &amp;&amp;
3577       WTERMSIG (test_trap_last_status) == SIGALRM)
3578     {
3579       g_test_message (&quot;child process (%s) timed out&quot;, process_id);
3580     }
3581   else if (WIFSIGNALED (test_trap_last_status))
3582     {
3583       const gchar *maybe_dumped_core = &quot;&quot;;
3584 
3585 #ifdef WCOREDUMP
3586       if (WCOREDUMP (test_trap_last_status))
3587         maybe_dumped_core = &quot;, core dumped&quot;;
3588 #endif
3589 
3590       g_test_message (&quot;child process (%s) killed by signal %d (%s)%s&quot;,
3591           process_id, WTERMSIG (test_trap_last_status),
3592           g_strsignal (WTERMSIG (test_trap_last_status)),
3593           maybe_dumped_core);
3594     }
3595   else
3596     {
3597       g_test_message (&quot;child process (%s) unknown wait status %d&quot;,
3598           process_id, test_trap_last_status);
3599     }
3600 #else
3601   if (test_trap_last_status == 0)
3602     g_test_message (&quot;child process (%s) exit status: 0 (success)&quot;,
3603         process_id);
3604   else
3605     g_test_message (&quot;child process (%s) exit status: %d (error)&quot;,
3606         process_id, test_trap_last_status);
3607 #endif
3608 
3609   escaped = g_strescape (test_trap_last_stdout, NULL);
3610   g_test_message (&quot;child process (%s) stdout: \&quot;%s\&quot;&quot;, process_id, escaped);
3611   g_free (escaped);
3612 
3613   escaped = g_strescape (test_trap_last_stderr, NULL);
3614   g_test_message (&quot;child process (%s) stderr: \&quot;%s\&quot;&quot;, process_id, escaped);
3615   g_free (escaped);
3616 
3617   /* so we can use short-circuiting:
3618    * logged_child_output = logged_child_output || log_child_output (...) */
3619   return TRUE;
3620 }
3621 
3622 void
3623 g_test_trap_assertions (const char     *domain,
3624                         const char     *file,
3625                         int             line,
3626                         const char     *func,
3627                         guint64         assertion_flags, /* 0-pass, 1-fail, 2-outpattern, 4-errpattern */
3628                         const char     *pattern)
3629 {
3630   gboolean must_pass = assertion_flags == 0;
3631   gboolean must_fail = assertion_flags == 1;
3632   gboolean match_result = 0 == (assertion_flags &amp; 1);
3633   gboolean logged_child_output = FALSE;
3634   const char *stdout_pattern = (assertion_flags &amp; 2) ? pattern : NULL;
3635   const char *stderr_pattern = (assertion_flags &amp; 4) ? pattern : NULL;
3636   const char *match_error = match_result ? &quot;failed to match&quot; : &quot;contains invalid match&quot;;
3637   char *process_id;
3638 
3639 #ifdef G_OS_UNIX
3640   if (test_trap_last_subprocess != NULL)
3641     {
3642       process_id = g_strdup_printf (&quot;%s [%d]&quot;, test_trap_last_subprocess,
3643                                     test_trap_last_pid);
3644     }
3645   else if (test_trap_last_pid != 0)
3646     process_id = g_strdup_printf (&quot;%d&quot;, test_trap_last_pid);
3647 #else
3648   if (test_trap_last_subprocess != NULL)
3649     process_id = g_strdup (test_trap_last_subprocess);
3650 #endif
3651   else
3652     g_error (&quot;g_test_trap_ assertion with no trapped test&quot;);
3653 
3654   if (must_pass &amp;&amp; !g_test_trap_has_passed())
3655     {
3656       char *msg;
3657 
3658       logged_child_output = logged_child_output || log_child_output (process_id);
3659 
3660       msg = g_strdup_printf (&quot;child process (%s) failed unexpectedly&quot;, process_id);
3661       g_assertion_message (domain, file, line, func, msg);
3662       g_free (msg);
3663     }
3664   if (must_fail &amp;&amp; g_test_trap_has_passed())
3665     {
3666       char *msg;
3667 
3668       logged_child_output = logged_child_output || log_child_output (process_id);
3669 
3670       msg = g_strdup_printf (&quot;child process (%s) did not fail as expected&quot;, process_id);
3671       g_assertion_message (domain, file, line, func, msg);
3672       g_free (msg);
3673     }
3674   if (stdout_pattern &amp;&amp; match_result == !g_pattern_match_simple (stdout_pattern, test_trap_last_stdout))
3675     {
3676       char *msg;
3677 
3678       logged_child_output = logged_child_output || log_child_output (process_id);
3679 
<a name="64" id="anc64"></a><span class="line-modified">3680       msg = g_strdup_printf (&quot;stdout of child process (%s) %s: %s\nstdout was:\n%s&quot;,</span>
<span class="line-added">3681                              process_id, match_error, stdout_pattern, test_trap_last_stdout);</span>
3682       g_assertion_message (domain, file, line, func, msg);
3683       g_free (msg);
3684     }
3685   if (stderr_pattern &amp;&amp; match_result == !g_pattern_match_simple (stderr_pattern, test_trap_last_stderr))
3686     {
3687       char *msg;
3688 
3689       logged_child_output = logged_child_output || log_child_output (process_id);
3690 
<a name="65" id="anc65"></a><span class="line-modified">3691       msg = g_strdup_printf (&quot;stderr of child process (%s) %s: %s\nstderr was:\n%s&quot;,</span>
<span class="line-added">3692                              process_id, match_error, stderr_pattern, test_trap_last_stderr);</span>
3693       g_assertion_message (domain, file, line, func, msg);
3694       g_free (msg);
3695     }
3696   g_free (process_id);
3697 }
3698 
3699 static void
3700 gstring_overwrite_int (GString *gstring,
3701                        guint    pos,
3702                        guint32  vuint)
3703 {
3704   vuint = g_htonl (vuint);
3705   g_string_overwrite_len (gstring, pos, (const gchar*) &amp;vuint, 4);
3706 }
3707 
3708 static void
3709 gstring_append_int (GString *gstring,
3710                     guint32  vuint)
3711 {
3712   vuint = g_htonl (vuint);
3713   g_string_append_len (gstring, (const gchar*) &amp;vuint, 4);
3714 }
3715 
3716 static void
3717 gstring_append_double (GString *gstring,
3718                        double   vdouble)
3719 {
3720   union { double vdouble; guint64 vuint64; } u;
3721   u.vdouble = vdouble;
3722   u.vuint64 = GUINT64_TO_BE (u.vuint64);
3723   g_string_append_len (gstring, (const gchar*) &amp;u.vuint64, 8);
3724 }
3725 
3726 static guint8*
3727 g_test_log_dump (GTestLogMsg *msg,
3728                  guint       *len)
3729 {
3730   GString *gstring = g_string_sized_new (1024);
3731   guint ui;
3732   gstring_append_int (gstring, 0);              /* message length */
3733   gstring_append_int (gstring, msg-&gt;log_type);
3734   gstring_append_int (gstring, msg-&gt;n_strings);
3735   gstring_append_int (gstring, msg-&gt;n_nums);
3736   gstring_append_int (gstring, 0);      /* reserved */
3737   for (ui = 0; ui &lt; msg-&gt;n_strings; ui++)
3738     {
3739       guint l = strlen (msg-&gt;strings[ui]);
3740       gstring_append_int (gstring, l);
3741       g_string_append_len (gstring, msg-&gt;strings[ui], l);
3742     }
3743   for (ui = 0; ui &lt; msg-&gt;n_nums; ui++)
3744     gstring_append_double (gstring, msg-&gt;nums[ui]);
3745   *len = gstring-&gt;len;
3746   gstring_overwrite_int (gstring, 0, *len);     /* message length */
3747   return (guint8*) g_string_free (gstring, FALSE);
3748 }
3749 
3750 static inline long double
3751 net_double (const gchar **ipointer)
3752 {
3753   union { guint64 vuint64; double vdouble; } u;
3754   guint64 aligned_int64;
3755   memcpy (&amp;aligned_int64, *ipointer, 8);
3756   *ipointer += 8;
3757   u.vuint64 = GUINT64_FROM_BE (aligned_int64);
3758   return u.vdouble;
3759 }
3760 
3761 static inline guint32
3762 net_int (const gchar **ipointer)
3763 {
3764   guint32 aligned_int;
3765   memcpy (&amp;aligned_int, *ipointer, 4);
3766   *ipointer += 4;
3767   return g_ntohl (aligned_int);
3768 }
3769 
3770 static gboolean
3771 g_test_log_extract (GTestLogBuffer *tbuffer)
3772 {
3773   const gchar *p = tbuffer-&gt;data-&gt;str;
3774   GTestLogMsg msg;
3775   guint mlength;
3776   if (tbuffer-&gt;data-&gt;len &lt; 4 * 5)
3777     return FALSE;
3778   mlength = net_int (&amp;p);
3779   if (tbuffer-&gt;data-&gt;len &lt; mlength)
3780     return FALSE;
3781   msg.log_type = net_int (&amp;p);
3782   msg.n_strings = net_int (&amp;p);
3783   msg.n_nums = net_int (&amp;p);
3784   if (net_int (&amp;p) == 0)
3785     {
3786       guint ui;
3787       msg.strings = g_new0 (gchar*, msg.n_strings + 1);
3788       msg.nums = g_new0 (long double, msg.n_nums);
3789       for (ui = 0; ui &lt; msg.n_strings; ui++)
3790         {
3791           guint sl = net_int (&amp;p);
3792           msg.strings[ui] = g_strndup (p, sl);
3793           p += sl;
3794         }
3795       for (ui = 0; ui &lt; msg.n_nums; ui++)
3796         msg.nums[ui] = net_double (&amp;p);
3797       if (p &lt;= tbuffer-&gt;data-&gt;str + mlength)
3798         {
3799           g_string_erase (tbuffer-&gt;data, 0, mlength);
3800           tbuffer-&gt;msgs = g_slist_prepend (tbuffer-&gt;msgs, g_memdup (&amp;msg, sizeof (msg)));
3801           return TRUE;
3802         }
3803 
3804       g_free (msg.nums);
3805       g_strfreev (msg.strings);
3806     }
3807 
3808   g_error (&quot;corrupt log stream from test program&quot;);
3809   return FALSE;
3810 }
3811 
3812 /**
3813  * g_test_log_buffer_new:
3814  *
3815  * Internal function for gtester to decode test log messages, no ABI guarantees provided.
3816  */
3817 GTestLogBuffer*
3818 g_test_log_buffer_new (void)
3819 {
3820   GTestLogBuffer *tb = g_new0 (GTestLogBuffer, 1);
3821   tb-&gt;data = g_string_sized_new (1024);
3822   return tb;
3823 }
3824 
3825 /**
3826  * g_test_log_buffer_free:
3827  *
3828  * Internal function for gtester to free test log messages, no ABI guarantees provided.
3829  */
3830 void
3831 g_test_log_buffer_free (GTestLogBuffer *tbuffer)
3832 {
3833   g_return_if_fail (tbuffer != NULL);
3834   while (tbuffer-&gt;msgs)
3835     g_test_log_msg_free (g_test_log_buffer_pop (tbuffer));
3836   g_string_free (tbuffer-&gt;data, TRUE);
3837   g_free (tbuffer);
3838 }
3839 
3840 /**
3841  * g_test_log_buffer_push:
3842  *
3843  * Internal function for gtester to decode test log messages, no ABI guarantees provided.
3844  */
3845 void
3846 g_test_log_buffer_push (GTestLogBuffer *tbuffer,
3847                         guint           n_bytes,
3848                         const guint8   *bytes)
3849 {
3850   g_return_if_fail (tbuffer != NULL);
3851   if (n_bytes)
3852     {
3853       gboolean more_messages;
3854       g_return_if_fail (bytes != NULL);
3855       g_string_append_len (tbuffer-&gt;data, (const gchar*) bytes, n_bytes);
3856       do
3857         more_messages = g_test_log_extract (tbuffer);
3858       while (more_messages);
3859     }
3860 }
3861 
3862 /**
3863  * g_test_log_buffer_pop:
3864  *
3865  * Internal function for gtester to retrieve test log messages, no ABI guarantees provided.
3866  */
3867 GTestLogMsg*
3868 g_test_log_buffer_pop (GTestLogBuffer *tbuffer)
3869 {
3870   GTestLogMsg *msg = NULL;
3871   g_return_val_if_fail (tbuffer != NULL, NULL);
3872   if (tbuffer-&gt;msgs)
3873     {
3874       GSList *slist = g_slist_last (tbuffer-&gt;msgs);
3875       msg = slist-&gt;data;
3876       tbuffer-&gt;msgs = g_slist_delete_link (tbuffer-&gt;msgs, slist);
3877     }
3878   return msg;
3879 }
3880 
3881 /**
3882  * g_test_log_msg_free:
3883  *
3884  * Internal function for gtester to free test log messages, no ABI guarantees provided.
3885  */
3886 void
3887 g_test_log_msg_free (GTestLogMsg *tmsg)
3888 {
3889   g_return_if_fail (tmsg != NULL);
3890   g_strfreev (tmsg-&gt;strings);
3891   g_free (tmsg-&gt;nums);
3892   g_free (tmsg);
3893 }
3894 
3895 static gchar *
3896 g_test_build_filename_va (GTestFileType  file_type,
3897                           const gchar   *first_path,
3898                           va_list        ap)
3899 {
3900   const gchar *pathv[16];
<a name="66" id="anc66"></a><span class="line-modified">3901   gsize num_path_segments;</span>
3902 
3903   if (file_type == G_TEST_DIST)
3904     pathv[0] = test_disted_files_dir;
3905   else if (file_type == G_TEST_BUILT)
3906     pathv[0] = test_built_files_dir;
3907   else
3908     g_assert_not_reached ();
3909 
3910   pathv[1] = first_path;
3911 
3912   for (num_path_segments = 2; num_path_segments &lt; G_N_ELEMENTS (pathv); num_path_segments++)
3913     {
3914       pathv[num_path_segments] = va_arg (ap, const char *);
3915       if (pathv[num_path_segments] == NULL)
3916         break;
3917     }
3918 
3919   g_assert_cmpint (num_path_segments, &lt;, G_N_ELEMENTS (pathv));
3920 
3921   return g_build_filenamev ((gchar **) pathv);
3922 }
3923 
3924 /**
3925  * g_test_build_filename:
3926  * @file_type: the type of file (built vs. distributed)
3927  * @first_path: the first segment of the pathname
3928  * @...: %NULL-terminated additional path segments
3929  *
3930  * Creates the pathname to a data file that is required for a test.
3931  *
3932  * This function is conceptually similar to g_build_filename() except
3933  * that the first argument has been replaced with a #GTestFileType
3934  * argument.
3935  *
3936  * The data file should either have been distributed with the module
3937  * containing the test (%G_TEST_DIST) or built as part of the build
3938  * system of that module (%G_TEST_BUILT).
3939  *
3940  * In order for this function to work in srcdir != builddir situations,
3941  * the G_TEST_SRCDIR and G_TEST_BUILDDIR environment variables need to
3942  * have been defined.  As of 2.38, this is done by the glib.mk
3943  * included in GLib.  Please ensure that your copy is up to date before
3944  * using this function.
3945  *
3946  * In case neither variable is set, this function will fall back to
3947  * using the dirname portion of argv[0], possibly removing &quot;.libs&quot;.
3948  * This allows for casual running of tests directly from the commandline
3949  * in the srcdir == builddir case and should also support running of
3950  * installed tests, assuming the data files have been installed in the
3951  * same relative path as the test binary.
3952  *
3953  * Returns: the path of the file, to be freed using g_free()
3954  *
3955  * Since: 2.38
3956  **/
3957 /**
3958  * GTestFileType:
3959  * @G_TEST_DIST: a file that was included in the distribution tarball
3960  * @G_TEST_BUILT: a file that was built on the compiling machine
3961  *
3962  * The type of file to return the filename for, when used with
3963  * g_test_build_filename().
3964  *
3965  * These two options correspond rather directly to the &#39;dist&#39; and
3966  * &#39;built&#39; terminology that automake uses and are explicitly used to
3967  * distinguish between the &#39;srcdir&#39; and &#39;builddir&#39; being separate.  All
3968  * files in your project should either be dist (in the
3969  * `EXTRA_DIST` or `dist_schema_DATA`
3970  * sense, in which case they will always be in the srcdir) or built (in
3971  * the `BUILT_SOURCES` sense, in which case they will
3972  * always be in the builddir).
3973  *
3974  * Note: as a general rule of automake, files that are generated only as
3975  * part of the build-from-git process (but then are distributed with the
3976  * tarball) always go in srcdir (even if doing a srcdir != builddir
3977  * build from git) and are considered as distributed files.
3978  *
3979  * Since: 2.38
3980  **/
3981 gchar *
3982 g_test_build_filename (GTestFileType  file_type,
3983                        const gchar   *first_path,
3984                        ...)
3985 {
3986   gchar *result;
3987   va_list ap;
3988 
3989   g_assert (g_test_initialized ());
3990 
3991   va_start (ap, first_path);
3992   result = g_test_build_filename_va (file_type, first_path, ap);
3993   va_end (ap);
3994 
3995   return result;
3996 }
3997 
3998 #ifndef GSTREAMER_LITE
3999 /**
4000  * g_test_get_dir:
4001  * @file_type: the type of file (built vs. distributed)
4002  *
4003  * Gets the pathname of the directory containing test files of the type
4004  * specified by @file_type.
4005  *
4006  * This is approximately the same as calling g_test_build_filename(&quot;.&quot;),
4007  * but you don&#39;t need to free the return value.
4008  *
4009  * Returns: (type filename): the path of the directory, owned by GLib
4010  *
4011  * Since: 2.38
4012  **/
4013 const gchar *
4014 g_test_get_dir (GTestFileType file_type)
4015 {
4016   g_assert (g_test_initialized ());
4017 
4018   if (file_type == G_TEST_DIST)
4019     return test_disted_files_dir;
4020   else if (file_type == G_TEST_BUILT)
4021     return test_built_files_dir;
4022 
4023   g_assert_not_reached ();
4024 }
4025 #endif // GSTREAMER_LITE
4026 
4027 /**
4028  * g_test_get_filename:
4029  * @file_type: the type of file (built vs. distributed)
4030  * @first_path: the first segment of the pathname
4031  * @...: %NULL-terminated additional path segments
4032  *
4033  * Gets the pathname to a data file that is required for a test.
4034  *
4035  * This is the same as g_test_build_filename() with two differences.
4036  * The first difference is that must only use this function from within
4037  * a testcase function.  The second difference is that you need not free
4038  * the return value -- it will be automatically freed when the testcase
4039  * finishes running.
4040  *
4041  * It is safe to use this function from a thread inside of a testcase
4042  * but you must ensure that all such uses occur before the main testcase
4043  * function returns (ie: it is best to ensure that all threads have been
4044  * joined).
4045  *
4046  * Returns: the path, automatically freed at the end of the testcase
4047  *
4048  * Since: 2.38
4049  **/
4050 const gchar *
4051 g_test_get_filename (GTestFileType  file_type,
4052                      const gchar   *first_path,
4053                      ...)
4054 {
4055   gchar *result;
4056   GSList *node;
4057   va_list ap;
4058 
4059   g_assert (g_test_initialized ());
4060   if (test_filename_free_list == NULL)
4061     g_error (&quot;g_test_get_filename() can only be used within testcase functions&quot;);
4062 
4063   va_start (ap, first_path);
4064   result = g_test_build_filename_va (file_type, first_path, ap);
4065   va_end (ap);
4066 
4067   node = g_slist_prepend (NULL, result);
4068   do
4069     node-&gt;next = *test_filename_free_list;
4070   while (!g_atomic_pointer_compare_and_exchange (test_filename_free_list, node-&gt;next, node));
4071 
4072   return result;
4073 }
<a name="67" id="anc67"></a>





















<a name="68" id="anc68"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="68" type="hidden" />
</body>
</html>