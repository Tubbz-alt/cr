<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.media/src/main/native/gstreamer/gstreamer-lite/gstreamer/libs/gst/base/gstadapter.c</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="base.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="gstbaseparse.c.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.media/src/main/native/gstreamer/gstreamer-lite/gstreamer/libs/gst/base/gstadapter.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 125,10 ***</span>
<span class="line-new-header">--- 125,11 ---</span>
   */
  
  #include &lt;gst/gst_private.h&gt;
  #include &quot;gstadapter.h&quot;
  #include &lt;string.h&gt;
<span class="line-added">+ #include &lt;gst/base/gstqueuearray.h&gt;</span>
  
  /* default size for the assembled data buffer */
  #define DEFAULT_SIZE 4096
  
  static void gst_adapter_flush_unchecked (GstAdapter * adapter, gsize flush);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 139,12 ***</span>
  struct _GstAdapter
  {
    GObject object;
  
    /*&lt; private &gt; */
<span class="line-modified">!   GSList *buflist;</span>
<span class="line-removed">-   GSList *buflist_end;</span>
    gsize size;
    gsize skip;
    guint count;
  
    /* we keep state of assembled pieces */
<span class="line-new-header">--- 140,11 ---</span>
  struct _GstAdapter
  {
    GObject object;
  
    /*&lt; private &gt; */
<span class="line-modified">!   GstQueueArray *bufqueue;</span>
    gsize size;
    gsize skip;
    guint count;
  
    /* we keep state of assembled pieces */
</pre>
<hr />
<pre>
<span class="line-old-header">*** 158,11 ***</span>
    guint64 dts_distance;
    guint64 offset;
    guint64 offset_distance;
  
    gsize scan_offset;
<span class="line-modified">!   GSList *scan_entry;</span>
  
    GstClockTime pts_at_discont;
    GstClockTime dts_at_discont;
    guint64 offset_at_discont;
  
<span class="line-new-header">--- 158,12 ---</span>
    guint64 dts_distance;
    guint64 offset;
    guint64 offset_distance;
  
    gsize scan_offset;
<span class="line-modified">!   /* G_MAXUINT when unset */</span>
<span class="line-added">+   guint scan_entry_idx;</span>
  
    GstClockTime pts_at_discont;
    GstClockTime dts_at_discont;
    guint64 offset_at_discont;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 206,10 ***</span>
<span class="line-new-header">--- 207,11 ---</span>
    adapter-&gt;offset_distance = 0;
    adapter-&gt;pts_at_discont = GST_CLOCK_TIME_NONE;
    adapter-&gt;dts_at_discont = GST_CLOCK_TIME_NONE;
    adapter-&gt;offset_at_discont = GST_BUFFER_OFFSET_NONE;
    adapter-&gt;distance_from_discont = 0;
<span class="line-added">+   adapter-&gt;bufqueue = gst_queue_array_new (10);</span>
  }
  
  static void
  gst_adapter_dispose (GObject * object)
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 225,10 ***</span>
<span class="line-new-header">--- 227,12 ---</span>
  {
    GstAdapter *adapter = GST_ADAPTER (object);
  
    g_free (adapter-&gt;assembled_data);
  
<span class="line-added">+   gst_queue_array_free (adapter-&gt;bufqueue);</span>
<span class="line-added">+ </span>
    GST_CALL_PARENT (G_OBJECT_CLASS, finalize, (object));
  }
  
  /**
   * gst_adapter_new:
</pre>
<hr />
<pre>
<span class="line-old-header">*** 250,19 ***</span>
   * Removes all buffers from @adapter.
   */
  void
  gst_adapter_clear (GstAdapter * adapter)
  {
    g_return_if_fail (GST_IS_ADAPTER (adapter));
  
    if (adapter-&gt;info.memory)
      gst_adapter_unmap (adapter);
  
<span class="line-modified">!   g_slist_foreach (adapter-&gt;buflist, (GFunc) gst_mini_object_unref, NULL);</span>
<span class="line-modified">!   g_slist_free (adapter-&gt;buflist);</span>
<span class="line-modified">!   adapter-&gt;buflist = NULL;</span>
<span class="line-removed">-   adapter-&gt;buflist_end = NULL;</span>
    adapter-&gt;count = 0;
    adapter-&gt;size = 0;
    adapter-&gt;skip = 0;
    adapter-&gt;assembled_len = 0;
    adapter-&gt;pts = GST_CLOCK_TIME_NONE;
<span class="line-new-header">--- 254,19 ---</span>
   * Removes all buffers from @adapter.
   */
  void
  gst_adapter_clear (GstAdapter * adapter)
  {
<span class="line-added">+   GstMiniObject *obj;</span>
    g_return_if_fail (GST_IS_ADAPTER (adapter));
  
    if (adapter-&gt;info.memory)
      gst_adapter_unmap (adapter);
  
<span class="line-modified">!   while ((obj = gst_queue_array_pop_head (adapter-&gt;bufqueue)))</span>
<span class="line-modified">!     gst_mini_object_unref (obj);</span>
<span class="line-modified">! </span>
    adapter-&gt;count = 0;
    adapter-&gt;size = 0;
    adapter-&gt;skip = 0;
    adapter-&gt;assembled_len = 0;
    adapter-&gt;pts = GST_CLOCK_TIME_NONE;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 274,11 ***</span>
    adapter-&gt;pts_at_discont = GST_CLOCK_TIME_NONE;
    adapter-&gt;dts_at_discont = GST_CLOCK_TIME_NONE;
    adapter-&gt;offset_at_discont = GST_BUFFER_OFFSET_NONE;
    adapter-&gt;distance_from_discont = 0;
    adapter-&gt;scan_offset = 0;
<span class="line-modified">!   adapter-&gt;scan_entry = NULL;</span>
  }
  
  static inline void
  update_timestamps_and_offset (GstAdapter * adapter, GstBuffer * buf)
  {
<span class="line-new-header">--- 278,11 ---</span>
    adapter-&gt;pts_at_discont = GST_CLOCK_TIME_NONE;
    adapter-&gt;dts_at_discont = GST_CLOCK_TIME_NONE;
    adapter-&gt;offset_at_discont = GST_BUFFER_OFFSET_NONE;
    adapter-&gt;distance_from_discont = 0;
    adapter-&gt;scan_offset = 0;
<span class="line-modified">!   adapter-&gt;scan_entry_idx = G_MAXUINT;</span>
  }
  
  static inline void
  update_timestamps_and_offset (GstAdapter * adapter, GstBuffer * buf)
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 316,28 ***</span>
  /* copy data into @dest, skipping @skip bytes from the head buffers */
  static void
  copy_into_unchecked (GstAdapter * adapter, guint8 * dest, gsize skip,
      gsize size)
  {
<span class="line-removed">-   GSList *g;</span>
    GstBuffer *buf;
    gsize bsize, csize;
  
    /* first step, do skipping */
    /* we might well be copying where we were scanning */
<span class="line-modified">!   if (adapter-&gt;scan_entry &amp;&amp; (adapter-&gt;scan_offset &lt;= skip)) {</span>
<span class="line-modified">!     g = adapter-&gt;scan_entry;</span>
      skip -= adapter-&gt;scan_offset;
    } else {
<span class="line-modified">!     g = adapter-&gt;buflist;</span>
    }
<span class="line-modified">!   buf = g-&gt;data;</span>
    bsize = gst_buffer_get_size (buf);
    while (G_UNLIKELY (skip &gt;= bsize)) {
      skip -= bsize;
<span class="line-modified">!     g = g_slist_next (g);</span>
<span class="line-removed">-     buf = g-&gt;data;</span>
      bsize = gst_buffer_get_size (buf);
    }
    /* copy partial buffer */
    csize = MIN (bsize - skip, size);
    GST_DEBUG (&quot;bsize %&quot; G_GSIZE_FORMAT &quot;, skip %&quot; G_GSIZE_FORMAT &quot;, csize %&quot;
<span class="line-new-header">--- 320,27 ---</span>
  /* copy data into @dest, skipping @skip bytes from the head buffers */
  static void
  copy_into_unchecked (GstAdapter * adapter, guint8 * dest, gsize skip,
      gsize size)
  {
    GstBuffer *buf;
    gsize bsize, csize;
<span class="line-added">+   guint idx = 0;</span>
  
    /* first step, do skipping */
    /* we might well be copying where we were scanning */
<span class="line-modified">!   if (adapter-&gt;scan_entry_idx != G_MAXUINT &amp;&amp; (adapter-&gt;scan_offset &lt;= skip)) {</span>
<span class="line-modified">!     idx = adapter-&gt;scan_entry_idx;</span>
      skip -= adapter-&gt;scan_offset;
    } else {
<span class="line-modified">!     idx = 0;</span>
    }
<span class="line-modified">!   buf = gst_queue_array_peek_nth (adapter-&gt;bufqueue, idx++);</span>
    bsize = gst_buffer_get_size (buf);
    while (G_UNLIKELY (skip &gt;= bsize)) {
      skip -= bsize;
<span class="line-modified">!     buf = gst_queue_array_peek_nth (adapter-&gt;bufqueue, idx++);</span>
      bsize = gst_buffer_get_size (buf);
    }
    /* copy partial buffer */
    csize = MIN (bsize - skip, size);
    GST_DEBUG (&quot;bsize %&quot; G_GSIZE_FORMAT &quot;, skip %&quot; G_GSIZE_FORMAT &quot;, csize %&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 348,12 ***</span>
    size -= csize;
    dest += csize;
  
    /* second step, copy remainder */
    while (size &gt; 0) {
<span class="line-modified">!     g = g_slist_next (g);</span>
<span class="line-removed">-     buf = g-&gt;data;</span>
      bsize = gst_buffer_get_size (buf);
      if (G_LIKELY (bsize &gt; 0)) {
        csize = MIN (bsize, size);
        GST_CAT_LOG_OBJECT (GST_CAT_PERFORMANCE, adapter,
            &quot;extract %&quot; G_GSIZE_FORMAT &quot; bytes&quot;, csize);
<span class="line-new-header">--- 351,11 ---</span>
    size -= csize;
    dest += csize;
  
    /* second step, copy remainder */
    while (size &gt; 0) {
<span class="line-modified">!     buf = gst_queue_array_peek_nth (adapter-&gt;bufqueue, idx++);</span>
      bsize = gst_buffer_get_size (buf);
      if (G_LIKELY (bsize &gt; 0)) {
        csize = MIN (bsize, size);
        GST_CAT_LOG_OBJECT (GST_CAT_PERFORMANCE, adapter,
            &quot;extract %&quot; G_GSIZE_FORMAT &quot; bytes&quot;, csize);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 382,21 ***</span>
  
    size = gst_buffer_get_size (buf);
    adapter-&gt;size += size;
  
    /* Note: merging buffers at this point is premature. */
<span class="line-modified">!   if (G_UNLIKELY (adapter-&gt;buflist == NULL)) {</span>
      GST_LOG_OBJECT (adapter, &quot;pushing %p first %&quot; G_GSIZE_FORMAT &quot; bytes&quot;,
          buf, size);
<span class="line-modified">!     adapter-&gt;buflist = adapter-&gt;buflist_end = g_slist_append (NULL, buf);</span>
      update_timestamps_and_offset (adapter, buf);
    } else {
      /* Otherwise append to the end, and advance our end pointer */
      GST_LOG_OBJECT (adapter, &quot;pushing %p %&quot; G_GSIZE_FORMAT &quot; bytes at end, &quot;
          &quot;size now %&quot; G_GSIZE_FORMAT, buf, size, adapter-&gt;size);
<span class="line-modified">!     adapter-&gt;buflist_end = g_slist_append (adapter-&gt;buflist_end, buf);</span>
<span class="line-removed">-     adapter-&gt;buflist_end = g_slist_next (adapter-&gt;buflist_end);</span>
    }
    ++adapter-&gt;count;
  }
  
  #if 0
<span class="line-new-header">--- 384,20 ---</span>
  
    size = gst_buffer_get_size (buf);
    adapter-&gt;size += size;
  
    /* Note: merging buffers at this point is premature. */
<span class="line-modified">!   if (gst_queue_array_is_empty (adapter-&gt;bufqueue)) {</span>
      GST_LOG_OBJECT (adapter, &quot;pushing %p first %&quot; G_GSIZE_FORMAT &quot; bytes&quot;,
          buf, size);
<span class="line-modified">!     gst_queue_array_push_tail (adapter-&gt;bufqueue, buf);</span>
      update_timestamps_and_offset (adapter, buf);
    } else {
      /* Otherwise append to the end, and advance our end pointer */
      GST_LOG_OBJECT (adapter, &quot;pushing %p %&quot; G_GSIZE_FORMAT &quot; bytes at end, &quot;
          &quot;size now %&quot; G_GSIZE_FORMAT, buf, size, adapter-&gt;size);
<span class="line-modified">!     gst_queue_array_push_tail (adapter-&gt;bufqueue, buf);</span>
    }
    ++adapter-&gt;count;
  }
  
  #if 0
</pre>
<hr />
<pre>
<span class="line-old-header">*** 504,11 ***</span>
      return adapter-&gt;assembled_data;
  
  #if 0
    do {
  #endif
<span class="line-modified">!     cur = adapter-&gt;buflist-&gt;data;</span>
      skip = adapter-&gt;skip;
  
      csize = gst_buffer_get_size (cur);
      if (csize &gt;= size + skip) {
        if (!gst_buffer_map (cur, &amp;adapter-&gt;info, GST_MAP_READ))
<span class="line-new-header">--- 505,11 ---</span>
      return adapter-&gt;assembled_data;
  
  #if 0
    do {
  #endif
<span class="line-modified">!     cur = gst_queue_array_peek_head (adapter-&gt;bufqueue);</span>
      skip = adapter-&gt;skip;
  
      csize = gst_buffer_get_size (cur);
      if (csize &gt;= size + skip) {
        if (!gst_buffer_map (cur, &amp;adapter-&gt;info, GST_MAP_READ))
</pre>
<hr />
<pre>
<span class="line-old-header">*** 565,11 ***</span>
  gst_adapter_unmap (GstAdapter * adapter)
  {
    g_return_if_fail (GST_IS_ADAPTER (adapter));
  
    if (adapter-&gt;info.memory) {
<span class="line-modified">!     GstBuffer *cur = adapter-&gt;buflist-&gt;data;</span>
      GST_LOG_OBJECT (adapter, &quot;unmap memory buffer %p&quot;, cur);
      gst_buffer_unmap (cur, &amp;adapter-&gt;info);
      adapter-&gt;info.memory = NULL;
    }
  }
<span class="line-new-header">--- 566,11 ---</span>
  gst_adapter_unmap (GstAdapter * adapter)
  {
    g_return_if_fail (GST_IS_ADAPTER (adapter));
  
    if (adapter-&gt;info.memory) {
<span class="line-modified">!     GstBuffer *cur = gst_queue_array_peek_head (adapter-&gt;bufqueue);</span>
      GST_LOG_OBJECT (adapter, &quot;unmap memory buffer %p&quot;, cur);
      gst_buffer_unmap (cur, &amp;adapter-&gt;info);
      adapter-&gt;info.memory = NULL;
    }
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 627,11 ***</span>
  static void
  gst_adapter_flush_unchecked (GstAdapter * adapter, gsize flush)
  {
    GstBuffer *cur;
    gsize size;
<span class="line-removed">-   GSList *g;</span>
  
    GST_LOG_OBJECT (adapter, &quot;flushing %&quot; G_GSIZE_FORMAT &quot; bytes&quot;, flush);
  
    if (adapter-&gt;info.memory)
      gst_adapter_unmap (adapter);
<span class="line-new-header">--- 628,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 646,46 ***</span>
    adapter-&gt;pts_distance -= adapter-&gt;skip;
    adapter-&gt;dts_distance -= adapter-&gt;skip;
    adapter-&gt;offset_distance -= adapter-&gt;skip;
    adapter-&gt;distance_from_discont -= adapter-&gt;skip;
  
<span class="line-modified">!   g = adapter-&gt;buflist;</span>
<span class="line-removed">-   cur = g-&gt;data;</span>
    size = gst_buffer_get_size (cur);
    while (flush &gt;= size) {
      /* can skip whole buffer */
      GST_LOG_OBJECT (adapter, &quot;flushing out head buffer&quot;);
      adapter-&gt;pts_distance += size;
      adapter-&gt;dts_distance += size;
      adapter-&gt;offset_distance += size;
      adapter-&gt;distance_from_discont += size;
      flush -= size;
  
<span class="line-removed">-     gst_buffer_unref (cur);</span>
<span class="line-removed">-     g = g_slist_delete_link (g, g);</span>
      --adapter-&gt;count;
  
<span class="line-modified">!     if (G_UNLIKELY (g == NULL)) {</span>
        GST_LOG_OBJECT (adapter, &quot;adapter empty now&quot;);
<span class="line-removed">-       adapter-&gt;buflist_end = NULL;</span>
        break;
      }
      /* there is a new head buffer, update the timestamps */
<span class="line-modified">!     cur = g-&gt;data;</span>
      update_timestamps_and_offset (adapter, cur);
      size = gst_buffer_get_size (cur);
    }
<span class="line-removed">-   adapter-&gt;buflist = g;</span>
    /* account for the remaining bytes */
    adapter-&gt;skip = flush;
    adapter-&gt;pts_distance += flush;
    adapter-&gt;dts_distance += flush;
    adapter-&gt;offset_distance += flush;
    adapter-&gt;distance_from_discont += flush;
    /* invalidate scan position */
    adapter-&gt;scan_offset = 0;
<span class="line-modified">!   adapter-&gt;scan_entry = NULL;</span>
  }
  
  /**
   * gst_adapter_flush:
   * @adapter: a #GstAdapter
<span class="line-new-header">--- 646,44 ---</span>
    adapter-&gt;pts_distance -= adapter-&gt;skip;
    adapter-&gt;dts_distance -= adapter-&gt;skip;
    adapter-&gt;offset_distance -= adapter-&gt;skip;
    adapter-&gt;distance_from_discont -= adapter-&gt;skip;
  
<span class="line-modified">!   cur = gst_queue_array_peek_head (adapter-&gt;bufqueue);</span>
    size = gst_buffer_get_size (cur);
    while (flush &gt;= size) {
      /* can skip whole buffer */
      GST_LOG_OBJECT (adapter, &quot;flushing out head buffer&quot;);
      adapter-&gt;pts_distance += size;
      adapter-&gt;dts_distance += size;
      adapter-&gt;offset_distance += size;
      adapter-&gt;distance_from_discont += size;
      flush -= size;
  
      --adapter-&gt;count;
  
<span class="line-modified">!     cur = NULL;</span>
<span class="line-added">+     gst_buffer_unref (gst_queue_array_pop_head (adapter-&gt;bufqueue));</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (gst_queue_array_is_empty (adapter-&gt;bufqueue)) {</span>
        GST_LOG_OBJECT (adapter, &quot;adapter empty now&quot;);
        break;
      }
      /* there is a new head buffer, update the timestamps */
<span class="line-modified">!     cur = gst_queue_array_peek_head (adapter-&gt;bufqueue);</span>
      update_timestamps_and_offset (adapter, cur);
      size = gst_buffer_get_size (cur);
    }
    /* account for the remaining bytes */
    adapter-&gt;skip = flush;
    adapter-&gt;pts_distance += flush;
    adapter-&gt;dts_distance += flush;
    adapter-&gt;offset_distance += flush;
    adapter-&gt;distance_from_discont += flush;
    /* invalidate scan position */
    adapter-&gt;scan_offset = 0;
<span class="line-modified">!   adapter-&gt;scan_entry_idx = G_MAXUINT;</span>
  }
  
  /**
   * gst_adapter_flush:
   * @adapter: a #GstAdapter
</pre>
<hr />
<pre>
<span class="line-old-header">*** 811,13 ***</span>
  GstBuffer *
  gst_adapter_get_buffer_fast (GstAdapter * adapter, gsize nbytes)
  {
    GstBuffer *buffer = NULL;
    GstBuffer *cur;
<span class="line-removed">-   GSList *item;</span>
    gsize skip;
    gsize left = nbytes;
  
    g_return_val_if_fail (GST_IS_ADAPTER (adapter), NULL);
    g_return_val_if_fail (nbytes &gt; 0, NULL);
  
    GST_LOG_OBJECT (adapter, &quot;getting buffer of %&quot; G_GSIZE_FORMAT &quot; bytes&quot;,
<span class="line-new-header">--- 809,13 ---</span>
  GstBuffer *
  gst_adapter_get_buffer_fast (GstAdapter * adapter, gsize nbytes)
  {
    GstBuffer *buffer = NULL;
    GstBuffer *cur;
    gsize skip;
    gsize left = nbytes;
<span class="line-added">+   guint idx, len;</span>
  
    g_return_val_if_fail (GST_IS_ADAPTER (adapter), NULL);
    g_return_val_if_fail (nbytes &gt; 0, NULL);
  
    GST_LOG_OBJECT (adapter, &quot;getting buffer of %&quot; G_GSIZE_FORMAT &quot; bytes&quot;,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 828,23 ***</span>
     * random size. */
    if (G_UNLIKELY (nbytes &gt; adapter-&gt;size))
      return NULL;
  
    skip = adapter-&gt;skip;
<span class="line-modified">!   cur = adapter-&gt;buflist-&gt;data;</span>
  
    if (skip == 0 &amp;&amp; gst_buffer_get_size (cur) == nbytes) {
      GST_LOG_OBJECT (adapter, &quot;providing buffer of %&quot; G_GSIZE_FORMAT &quot; bytes&quot;
          &quot; as head buffer&quot;, nbytes);
      buffer = gst_buffer_ref (cur);
      goto done;
    }
  
<span class="line-modified">!   for (item = adapter-&gt;buflist; item &amp;&amp; left &gt; 0; item = item-&gt;next) {</span>
      gsize size, cur_size;
  
<span class="line-modified">!     cur = item-&gt;data;</span>
      cur_size = gst_buffer_get_size (cur);
      size = MIN (cur_size - skip, left);
  
      GST_LOG_OBJECT (adapter, &quot;appending %&quot; G_GSIZE_FORMAT &quot; bytes&quot;
          &quot; via region copy&quot;, size);
<span class="line-new-header">--- 826,25 ---</span>
     * random size. */
    if (G_UNLIKELY (nbytes &gt; adapter-&gt;size))
      return NULL;
  
    skip = adapter-&gt;skip;
<span class="line-modified">!   cur = gst_queue_array_peek_head (adapter-&gt;bufqueue);</span>
  
    if (skip == 0 &amp;&amp; gst_buffer_get_size (cur) == nbytes) {
      GST_LOG_OBJECT (adapter, &quot;providing buffer of %&quot; G_GSIZE_FORMAT &quot; bytes&quot;
          &quot; as head buffer&quot;, nbytes);
      buffer = gst_buffer_ref (cur);
      goto done;
    }
  
<span class="line-modified">!   len = gst_queue_array_get_length (adapter-&gt;bufqueue);</span>
<span class="line-added">+ </span>
<span class="line-added">+   for (idx = 0; idx &lt; len &amp;&amp; left &gt; 0; idx++) {</span>
      gsize size, cur_size;
  
<span class="line-modified">!     cur = gst_queue_array_peek_nth (adapter-&gt;bufqueue, idx);</span>
      cur_size = gst_buffer_get_size (cur);
      size = MIN (cur_size - skip, left);
  
      GST_LOG_OBJECT (adapter, &quot;appending %&quot; G_GSIZE_FORMAT &quot; bytes&quot;
          &quot; via region copy&quot;, size);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 977,11 ***</span>
     * as one usually does an _available() first instead of grabbing a
     * random size. */
    if (G_UNLIKELY (nbytes &gt; adapter-&gt;size))
      return NULL;
  
<span class="line-modified">!   cur = adapter-&gt;buflist-&gt;data;</span>
    skip = adapter-&gt;skip;
    hsize = gst_buffer_get_size (cur);
  
    /* our head buffer has enough data left, return it */
    if (skip == 0 &amp;&amp; hsize == nbytes) {
<span class="line-new-header">--- 977,11 ---</span>
     * as one usually does an _available() first instead of grabbing a
     * random size. */
    if (G_UNLIKELY (nbytes &gt; adapter-&gt;size))
      return NULL;
  
<span class="line-modified">!   cur = gst_queue_array_peek_head (adapter-&gt;bufqueue);</span>
    skip = adapter-&gt;skip;
    hsize = gst_buffer_get_size (cur);
  
    /* our head buffer has enough data left, return it */
    if (skip == 0 &amp;&amp; hsize == nbytes) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1012,22 ***</span>
    data = gst_adapter_get_internal (adapter, nbytes);
  
    buffer = gst_buffer_new_wrapped (data, nbytes);
  
    {
<span class="line-modified">!     GSList *g;</span>
      GstBuffer *cur;
      gsize read_offset = 0;
  
<span class="line-modified">!     g = adapter-&gt;buflist;</span>
<span class="line-modified">!     while (g &amp;&amp; read_offset &lt; nbytes + adapter-&gt;skip) {</span>
<span class="line-modified">!       cur = g-&gt;data;</span>
  
        gst_buffer_foreach_meta (cur, foreach_metadata, buffer);
        read_offset += gst_buffer_get_size (cur);
  
<span class="line-modified">!       g = g_slist_next (g);</span>
      }
    }
  
  done:
  
<span class="line-new-header">--- 1012,24 ---</span>
    data = gst_adapter_get_internal (adapter, nbytes);
  
    buffer = gst_buffer_new_wrapped (data, nbytes);
  
    {
<span class="line-modified">!     guint idx, len;</span>
      GstBuffer *cur;
      gsize read_offset = 0;
  
<span class="line-modified">!     idx = 0;</span>
<span class="line-modified">!     len = gst_queue_array_get_length (adapter-&gt;bufqueue);</span>
<span class="line-modified">! </span>
<span class="line-added">+     while (idx &lt; len &amp;&amp; read_offset &lt; nbytes + adapter-&gt;skip) {</span>
<span class="line-added">+       cur = gst_queue_array_peek_nth (adapter-&gt;bufqueue, idx);</span>
  
        gst_buffer_foreach_meta (cur, foreach_metadata, buffer);
        read_offset += gst_buffer_get_size (cur);
  
<span class="line-modified">!       idx++;</span>
      }
    }
  
  done:
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1106,11 ***</span>
    g_return_val_if_fail (nbytes &lt;= adapter-&gt;size, NULL);
  
    GST_LOG_OBJECT (adapter, &quot;taking %&quot; G_GSIZE_FORMAT &quot; bytes&quot;, nbytes);
  
    while (nbytes &gt; 0) {
<span class="line-modified">!     cur = adapter-&gt;buflist-&gt;data;</span>
      skip = adapter-&gt;skip;
      cur_size = gst_buffer_get_size (cur);
      hsize = MIN (nbytes, cur_size - skip);
  
      cur = gst_adapter_take_buffer (adapter, hsize);
<span class="line-new-header">--- 1108,11 ---</span>
    g_return_val_if_fail (nbytes &lt;= adapter-&gt;size, NULL);
  
    GST_LOG_OBJECT (adapter, &quot;taking %&quot; G_GSIZE_FORMAT &quot; bytes&quot;, nbytes);
  
    while (nbytes &gt; 0) {
<span class="line-modified">!     cur = gst_queue_array_peek_head (adapter-&gt;bufqueue);</span>
      skip = adapter-&gt;skip;
      cur_size = gst_buffer_get_size (cur);
      hsize = MIN (nbytes, cur_size - skip);
  
      cur = gst_adapter_take_buffer (adapter, hsize);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1144,22 ***</span>
  gst_adapter_get_list (GstAdapter * adapter, gsize nbytes)
  {
    GQueue queue = G_QUEUE_INIT;
    GstBuffer *cur, *buffer;
    gsize hsize, skip, cur_size;
<span class="line-modified">!   GSList *g = NULL;</span>
  
    g_return_val_if_fail (GST_IS_ADAPTER (adapter), NULL);
    g_return_val_if_fail (nbytes &lt;= adapter-&gt;size, NULL);
  
    GST_LOG_OBJECT (adapter, &quot;getting %&quot; G_GSIZE_FORMAT &quot; bytes&quot;, nbytes);
  
<span class="line-modified">!   g = adapter-&gt;buflist;</span>
    skip = adapter-&gt;skip;
  
    while (nbytes &gt; 0) {
<span class="line-modified">!     cur = g-&gt;data;</span>
      cur_size = gst_buffer_get_size (cur);
      hsize = MIN (nbytes, cur_size - skip);
  
      if (skip == 0 &amp;&amp; cur_size == hsize) {
        GST_LOG_OBJECT (adapter,
<span class="line-new-header">--- 1146,22 ---</span>
  gst_adapter_get_list (GstAdapter * adapter, gsize nbytes)
  {
    GQueue queue = G_QUEUE_INIT;
    GstBuffer *cur, *buffer;
    gsize hsize, skip, cur_size;
<span class="line-modified">!   guint idx;</span>
  
    g_return_val_if_fail (GST_IS_ADAPTER (adapter), NULL);
    g_return_val_if_fail (nbytes &lt;= adapter-&gt;size, NULL);
  
    GST_LOG_OBJECT (adapter, &quot;getting %&quot; G_GSIZE_FORMAT &quot; bytes&quot;, nbytes);
  
<span class="line-modified">!   idx = 0;</span>
    skip = adapter-&gt;skip;
  
    while (nbytes &gt; 0) {
<span class="line-modified">!     cur = gst_queue_array_peek_nth (adapter-&gt;bufqueue, idx++);</span>
      cur_size = gst_buffer_get_size (cur);
      hsize = MIN (nbytes, cur_size - skip);
  
      if (skip == 0 &amp;&amp; cur_size == hsize) {
        GST_LOG_OBJECT (adapter,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1173,11 ***</span>
  
      g_queue_push_tail (&amp;queue, buffer);
  
      nbytes -= hsize;
      skip = 0;
<span class="line-removed">-     g = g_slist_next (g);</span>
    }
  
    return queue.head;
  }
  
<span class="line-new-header">--- 1175,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1222,11 ***</span>
      n_bufs = (adapter-&gt;count * nbytes * 1.2 / adapter-&gt;size) + 1;
  
    buffer_list = gst_buffer_list_new_sized (n_bufs);
  
    while (nbytes &gt; 0) {
<span class="line-modified">!     cur = adapter-&gt;buflist-&gt;data;</span>
      skip = adapter-&gt;skip;
      cur_size = gst_buffer_get_size (cur);
      hsize = MIN (nbytes, cur_size - skip);
  
      gst_buffer_list_add (buffer_list, gst_adapter_take_buffer (adapter, hsize));
<span class="line-new-header">--- 1223,11 ---</span>
      n_bufs = (adapter-&gt;count * nbytes * 1.2 / adapter-&gt;size) + 1;
  
    buffer_list = gst_buffer_list_new_sized (n_bufs);
  
    while (nbytes &gt; 0) {
<span class="line-modified">!     cur = gst_queue_array_peek_head (adapter-&gt;bufqueue);</span>
      skip = adapter-&gt;skip;
      cur_size = gst_buffer_get_size (cur);
      hsize = MIN (nbytes, cur_size - skip);
  
      gst_buffer_list_add (buffer_list, gst_adapter_take_buffer (adapter, hsize));
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1258,11 ***</span>
  {
    GstBufferList *buffer_list;
    GstBuffer *cur, *buffer;
    gsize hsize, skip, cur_size;
    guint n_bufs;
<span class="line-modified">!   GSList *g = NULL;</span>
  
    g_return_val_if_fail (GST_IS_ADAPTER (adapter), NULL);
  
    if (nbytes &gt; adapter-&gt;size)
      return NULL;
<span class="line-new-header">--- 1259,11 ---</span>
  {
    GstBufferList *buffer_list;
    GstBuffer *cur, *buffer;
    gsize hsize, skip, cur_size;
    guint n_bufs;
<span class="line-modified">!   guint idx;</span>
  
    g_return_val_if_fail (GST_IS_ADAPTER (adapter), NULL);
  
    if (nbytes &gt; adapter-&gt;size)
      return NULL;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1275,15 ***</span>
    else
      n_bufs = (adapter-&gt;count * nbytes * 1.2 / adapter-&gt;size) + 1;
  
    buffer_list = gst_buffer_list_new_sized (n_bufs);
  
<span class="line-modified">!   g = adapter-&gt;buflist;</span>
    skip = adapter-&gt;skip;
  
    while (nbytes &gt; 0) {
<span class="line-modified">!     cur = g-&gt;data;</span>
      cur_size = gst_buffer_get_size (cur);
      hsize = MIN (nbytes, cur_size - skip);
  
      if (skip == 0 &amp;&amp; cur_size == hsize) {
        GST_LOG_OBJECT (adapter,
<span class="line-new-header">--- 1276,15 ---</span>
    else
      n_bufs = (adapter-&gt;count * nbytes * 1.2 / adapter-&gt;size) + 1;
  
    buffer_list = gst_buffer_list_new_sized (n_bufs);
  
<span class="line-modified">!   idx = 0;</span>
    skip = adapter-&gt;skip;
  
    while (nbytes &gt; 0) {
<span class="line-modified">!     cur = gst_queue_array_peek_nth (adapter-&gt;bufqueue, idx++);</span>
      cur_size = gst_buffer_get_size (cur);
      hsize = MIN (nbytes, cur_size - skip);
  
      if (skip == 0 &amp;&amp; cur_size == hsize) {
        GST_LOG_OBJECT (adapter,
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1297,11 ***</span>
  
      gst_buffer_list_add (buffer_list, buffer);
  
      nbytes -= hsize;
      skip = 0;
<span class="line-removed">-     g = g_slist_next (g);</span>
    }
  
    return buffer_list;
  }
  
<span class="line-new-header">--- 1298,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1337,11 ***</span>
  gsize
  gst_adapter_available_fast (GstAdapter * adapter)
  {
    GstBuffer *cur;
    gsize size;
<span class="line-modified">!   GSList *g;</span>
  
    g_return_val_if_fail (GST_IS_ADAPTER (adapter), 0);
  
    /* no data */
    if (adapter-&gt;size == 0)
<span class="line-new-header">--- 1337,11 ---</span>
  gsize
  gst_adapter_available_fast (GstAdapter * adapter)
  {
    GstBuffer *cur;
    gsize size;
<span class="line-modified">!   guint idx;</span>
  
    g_return_val_if_fail (GST_IS_ADAPTER (adapter), 0);
  
    /* no data */
    if (adapter-&gt;size == 0)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1350,17 ***</span>
    /* some stuff we already assembled */
    if (adapter-&gt;assembled_len)
      return adapter-&gt;assembled_len;
  
    /* take the first non-zero buffer */
<span class="line-modified">!   g = adapter-&gt;buflist;</span>
    while (TRUE) {
<span class="line-modified">!     cur = g-&gt;data;</span>
      size = gst_buffer_get_size (cur);
      if (size != 0)
        break;
<span class="line-removed">-     g = g_slist_next (g);</span>
    }
  
    /* we can quickly get the (remaining) data of the first buffer */
    return size - adapter-&gt;skip;
  }
<span class="line-new-header">--- 1350,16 ---</span>
    /* some stuff we already assembled */
    if (adapter-&gt;assembled_len)
      return adapter-&gt;assembled_len;
  
    /* take the first non-zero buffer */
<span class="line-modified">!   idx = 0;</span>
    while (TRUE) {
<span class="line-modified">!     cur = gst_queue_array_peek_nth (adapter-&gt;bufqueue, idx++);</span>
      size = gst_buffer_get_size (cur);
      if (size != 0)
        break;
    }
  
    /* we can quickly get the (remaining) data of the first buffer */
    return size - adapter-&gt;skip;
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1547,29 ***</span>
  GstClockTime
  gst_adapter_prev_pts_at_offset (GstAdapter * adapter, gsize offset,
      guint64 * distance)
  {
    GstBuffer *cur;
<span class="line-removed">-   GSList *g;</span>
    gsize read_offset = 0;
    gsize pts_offset = 0;
    GstClockTime pts = adapter-&gt;pts;
  
    g_return_val_if_fail (GST_IS_ADAPTER (adapter), GST_CLOCK_TIME_NONE);
  
<span class="line-modified">!   g = adapter-&gt;buflist;</span>
  
<span class="line-modified">!   while (g &amp;&amp; read_offset &lt; offset + adapter-&gt;skip) {</span>
<span class="line-modified">!     cur = g-&gt;data;</span>
  
      if (GST_CLOCK_TIME_IS_VALID (GST_BUFFER_PTS (cur))) {
        pts = GST_BUFFER_PTS (cur);
        pts_offset = read_offset;
      }
  
      read_offset += gst_buffer_get_size (cur);
<span class="line-removed">-     g = g_slist_next (g);</span>
    }
  
    if (distance)
      *distance = adapter-&gt;pts_distance + offset - pts_offset;
  
<span class="line-new-header">--- 1546,29 ---</span>
  GstClockTime
  gst_adapter_prev_pts_at_offset (GstAdapter * adapter, gsize offset,
      guint64 * distance)
  {
    GstBuffer *cur;
    gsize read_offset = 0;
    gsize pts_offset = 0;
    GstClockTime pts = adapter-&gt;pts;
<span class="line-added">+   guint idx, len;</span>
  
    g_return_val_if_fail (GST_IS_ADAPTER (adapter), GST_CLOCK_TIME_NONE);
  
<span class="line-modified">!   idx = 0;</span>
<span class="line-added">+   len = gst_queue_array_get_length (adapter-&gt;bufqueue);</span>
  
<span class="line-modified">!   while (idx &lt; len &amp;&amp; read_offset &lt; offset + adapter-&gt;skip) {</span>
<span class="line-modified">!     cur = gst_queue_array_peek_nth (adapter-&gt;bufqueue, idx++);</span>
  
      if (GST_CLOCK_TIME_IS_VALID (GST_BUFFER_PTS (cur))) {
        pts = GST_BUFFER_PTS (cur);
        pts_offset = read_offset;
      }
  
      read_offset += gst_buffer_get_size (cur);
    }
  
    if (distance)
      *distance = adapter-&gt;pts_distance + offset - pts_offset;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1597,29 ***</span>
  GstClockTime
  gst_adapter_prev_dts_at_offset (GstAdapter * adapter, gsize offset,
      guint64 * distance)
  {
    GstBuffer *cur;
<span class="line-removed">-   GSList *g;</span>
    gsize read_offset = 0;
    gsize dts_offset = 0;
    GstClockTime dts = adapter-&gt;dts;
  
    g_return_val_if_fail (GST_IS_ADAPTER (adapter), GST_CLOCK_TIME_NONE);
  
<span class="line-modified">!   g = adapter-&gt;buflist;</span>
  
<span class="line-modified">!   while (g &amp;&amp; read_offset &lt; offset + adapter-&gt;skip) {</span>
<span class="line-modified">!     cur = g-&gt;data;</span>
  
      if (GST_CLOCK_TIME_IS_VALID (GST_BUFFER_DTS (cur))) {
        dts = GST_BUFFER_DTS (cur);
        dts_offset = read_offset;
      }
  
      read_offset += gst_buffer_get_size (cur);
<span class="line-removed">-     g = g_slist_next (g);</span>
    }
  
    if (distance)
      *distance = adapter-&gt;dts_distance + offset - dts_offset;
  
<span class="line-new-header">--- 1596,29 ---</span>
  GstClockTime
  gst_adapter_prev_dts_at_offset (GstAdapter * adapter, gsize offset,
      guint64 * distance)
  {
    GstBuffer *cur;
    gsize read_offset = 0;
    gsize dts_offset = 0;
    GstClockTime dts = adapter-&gt;dts;
<span class="line-added">+   guint idx, len;</span>
  
    g_return_val_if_fail (GST_IS_ADAPTER (adapter), GST_CLOCK_TIME_NONE);
  
<span class="line-modified">!   idx = 0;</span>
<span class="line-added">+   len = gst_queue_array_get_length (adapter-&gt;bufqueue);</span>
  
<span class="line-modified">!   while (idx &lt; len &amp;&amp; read_offset &lt; offset + adapter-&gt;skip) {</span>
<span class="line-modified">!     cur = gst_queue_array_peek_nth (adapter-&gt;bufqueue, idx++);</span>
  
      if (GST_CLOCK_TIME_IS_VALID (GST_BUFFER_DTS (cur))) {
        dts = GST_BUFFER_DTS (cur);
        dts_offset = read_offset;
      }
  
      read_offset += gst_buffer_get_size (cur);
    }
  
    if (distance)
      *distance = adapter-&gt;dts_distance + offset - dts_offset;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1651,16 ***</span>
   */
  gssize
  gst_adapter_masked_scan_uint32_peek (GstAdapter * adapter, guint32 mask,
      guint32 pattern, gsize offset, gsize size, guint32 * value)
  {
<span class="line-removed">-   GSList *g;</span>
    gsize skip, bsize, i;
    guint32 state;
    GstMapInfo info;
    guint8 *bdata;
    GstBuffer *buf;
  
    g_return_val_if_fail (size &gt; 0, -1);
    g_return_val_if_fail (offset + size &lt;= adapter-&gt;size, -1);
    g_return_val_if_fail (((~mask) &amp; pattern) == 0, -1);
  
<span class="line-new-header">--- 1650,16 ---</span>
   */
  gssize
  gst_adapter_masked_scan_uint32_peek (GstAdapter * adapter, guint32 mask,
      guint32 pattern, gsize offset, gsize size, guint32 * value)
  {
    gsize skip, bsize, i;
    guint32 state;
    GstMapInfo info;
    guint8 *bdata;
    GstBuffer *buf;
<span class="line-added">+   guint idx;</span>
  
    g_return_val_if_fail (size &gt; 0, -1);
    g_return_val_if_fail (offset + size &lt;= adapter-&gt;size, -1);
    g_return_val_if_fail (((~mask) &amp; pattern) == 0, -1);
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1670,26 ***</span>
  
    skip = offset + adapter-&gt;skip;
  
    /* first step, do skipping and position on the first buffer */
    /* optimistically assume scanning continues sequentially */
<span class="line-modified">!   if (adapter-&gt;scan_entry &amp;&amp; (adapter-&gt;scan_offset &lt;= skip)) {</span>
<span class="line-modified">!     g = adapter-&gt;scan_entry;</span>
      skip -= adapter-&gt;scan_offset;
    } else {
<span class="line-modified">!     g = adapter-&gt;buflist;</span>
      adapter-&gt;scan_offset = 0;
<span class="line-modified">!     adapter-&gt;scan_entry = NULL;</span>
    }
<span class="line-modified">!   buf = g-&gt;data;</span>
    bsize = gst_buffer_get_size (buf);
    while (G_UNLIKELY (skip &gt;= bsize)) {
      skip -= bsize;
<span class="line-removed">-     g = g_slist_next (g);</span>
      adapter-&gt;scan_offset += bsize;
<span class="line-modified">!     adapter-&gt;scan_entry = g;</span>
<span class="line-modified">!     buf = g-&gt;data;</span>
      bsize = gst_buffer_get_size (buf);
    }
    /* get the data now */
    if (!gst_buffer_map (buf, &amp;info, GST_MAP_READ))
      return -1;
<span class="line-new-header">--- 1669,25 ---</span>
  
    skip = offset + adapter-&gt;skip;
  
    /* first step, do skipping and position on the first buffer */
    /* optimistically assume scanning continues sequentially */
<span class="line-modified">!   if (adapter-&gt;scan_entry_idx != G_MAXUINT &amp;&amp; (adapter-&gt;scan_offset &lt;= skip)) {</span>
<span class="line-modified">!     idx = adapter-&gt;scan_entry_idx;</span>
      skip -= adapter-&gt;scan_offset;
    } else {
<span class="line-modified">!     idx = 0;</span>
      adapter-&gt;scan_offset = 0;
<span class="line-modified">!     adapter-&gt;scan_entry_idx = G_MAXUINT;</span>
    }
<span class="line-modified">!   buf = gst_queue_array_peek_nth (adapter-&gt;bufqueue, idx++);</span>
    bsize = gst_buffer_get_size (buf);
    while (G_UNLIKELY (skip &gt;= bsize)) {
      skip -= bsize;
      adapter-&gt;scan_offset += bsize;
<span class="line-modified">!     adapter-&gt;scan_entry_idx = idx;</span>
<span class="line-modified">!     buf = gst_queue_array_peek_nth (adapter-&gt;bufqueue, idx++);</span>
      bsize = gst_buffer_get_size (buf);
    }
    /* get the data now */
    if (!gst_buffer_map (buf, &amp;info, GST_MAP_READ))
      return -1;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1721,15 ***</span>
      if (size == 0)
        break;
  
      /* nothing found yet, go to next buffer */
      skip += bsize;
<span class="line-removed">-     g = g_slist_next (g);</span>
      adapter-&gt;scan_offset += info.size;
<span class="line-modified">!     adapter-&gt;scan_entry = g;</span>
      gst_buffer_unmap (buf, &amp;info);
<span class="line-modified">!     buf = g-&gt;data;</span>
  
      if (!gst_buffer_map (buf, &amp;info, GST_MAP_READ))
        return -1;
  
      bsize = info.size;
<span class="line-new-header">--- 1719,14 ---</span>
      if (size == 0)
        break;
  
      /* nothing found yet, go to next buffer */
      skip += bsize;
      adapter-&gt;scan_offset += info.size;
<span class="line-modified">!     adapter-&gt;scan_entry_idx = idx;</span>
      gst_buffer_unmap (buf, &amp;info);
<span class="line-modified">!     buf = gst_queue_array_peek_nth (adapter-&gt;bufqueue, idx++);</span>
  
      if (!gst_buffer_map (buf, &amp;info, GST_MAP_READ))
        return -1;
  
      bsize = info.size;
</pre>
<center><a href="base.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="gstbaseparse.c.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>