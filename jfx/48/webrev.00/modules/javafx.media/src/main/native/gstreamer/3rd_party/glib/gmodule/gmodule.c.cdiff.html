<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.media/src/main/native/gstreamer/3rd_party/glib/gmodule/gmodule.c</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="gmodule-win32.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="gmodule.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.media/src/main/native/gstreamer/3rd_party/glib/gmodule/gmodule.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 38,11 ***</span>
  #include &lt;fcntl.h&gt;
  #ifdef G_OS_UNIX
  #include &lt;unistd.h&gt;
  #endif
  #ifdef G_OS_WIN32
<span class="line-modified">! #include &lt;io.h&gt;     /* For open() and close() prototypes. */</span>
  #endif
  
  #include &quot;gmoduleconf.h&quot;
  #include &quot;gstdio.h&quot;
  
<span class="line-new-header">--- 38,11 ---</span>
  #include &lt;fcntl.h&gt;
  #ifdef G_OS_UNIX
  #include &lt;unistd.h&gt;
  #endif
  #ifdef G_OS_WIN32
<span class="line-modified">! #include &lt;io.h&gt;   /* For open() and close() prototypes. */</span>
  #endif
  
  #include &quot;gmoduleconf.h&quot;
  #include &quot;gstdio.h&quot;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 202,31 ***</span>
    GModule *next;
  };
  
  
  /* --- prototypes --- */
<span class="line-modified">! static gpointer     _g_module_open      (const gchar    *file_name,</span>
<span class="line-modified">!                          gboolean    bind_lazy,</span>
<span class="line-modified">!                          gboolean    bind_local);</span>
<span class="line-modified">! static void     _g_module_close     (gpointer    handle,</span>
<span class="line-modified">!                          gboolean    is_unref);</span>
<span class="line-modified">! static gpointer     _g_module_self      (void);</span>
<span class="line-modified">! static gpointer     _g_module_symbol    (gpointer    handle,</span>
<span class="line-modified">!                          const gchar    *symbol_name);</span>
<span class="line-modified">! static gchar*       _g_module_build_path    (const gchar    *directory,</span>
<span class="line-modified">!                          const gchar    *module_name);</span>
<span class="line-modified">! static inline void  g_module_set_error  (const gchar    *error);</span>
<span class="line-modified">! static inline GModule*  g_module_find_by_handle (gpointer    handle);</span>
<span class="line-modified">! static inline GModule*  g_module_find_by_name   (const gchar    *name);</span>
  
  
  /* --- variables --- */
  static GModule       *modules = NULL;
  static GModule       *main_module = NULL;
  static GPrivate       module_error_private = G_PRIVATE_INIT (g_free);
  static gboolean       module_debug_initialized = FALSE;
<span class="line-modified">! static guint          module_debug_flags = 0;</span>
  
  
  /* --- inline functions --- */
  static inline GModule*
  g_module_find_by_handle (gpointer handle)
<span class="line-new-header">--- 202,31 ---</span>
    GModule *next;
  };
  
  
  /* --- prototypes --- */
<span class="line-modified">! static gpointer   _g_module_open    (const gchar  *file_name,</span>
<span class="line-modified">!              gboolean  bind_lazy,</span>
<span class="line-modified">!              gboolean  bind_local);</span>
<span class="line-modified">! static void   _g_module_close   (gpointer  handle,</span>
<span class="line-modified">!              gboolean  is_unref);</span>
<span class="line-modified">! static gpointer   _g_module_self    (void);</span>
<span class="line-modified">! static gpointer   _g_module_symbol  (gpointer  handle,</span>
<span class="line-modified">!              const gchar  *symbol_name);</span>
<span class="line-modified">! static gchar*   _g_module_build_path  (const gchar  *directory,</span>
<span class="line-modified">!              const gchar  *module_name);</span>
<span class="line-modified">! static inline void  g_module_set_error  (const gchar  *error);</span>
<span class="line-modified">! static inline GModule*  g_module_find_by_handle (gpointer  handle);</span>
<span class="line-modified">! static inline GModule*  g_module_find_by_name (const gchar  *name);</span>
  
  
  /* --- variables --- */
  static GModule       *modules = NULL;
  static GModule       *main_module = NULL;
  static GPrivate       module_error_private = G_PRIVATE_INIT (g_free);
  static gboolean       module_debug_initialized = FALSE;
<span class="line-modified">! static guint        module_debug_flags = 0;</span>
  
  
  /* --- inline functions --- */
  static inline GModule*
  g_module_find_by_handle (gpointer handle)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 237,14 ***</span>
    if (main_module &amp;&amp; main_module-&gt;handle == handle)
      retval = main_module;
    else
      for (module = modules; module; module = module-&gt;next)
        if (handle == module-&gt;handle)
<span class="line-modified">!     {</span>
<span class="line-modified">!       retval = module;</span>
<span class="line-modified">!       break;</span>
<span class="line-modified">!     }</span>
  
    return retval;
  }
  
  static inline GModule*
<span class="line-new-header">--- 237,14 ---</span>
    if (main_module &amp;&amp; main_module-&gt;handle == handle)
      retval = main_module;
    else
      for (module = modules; module; module = module-&gt;next)
        if (handle == module-&gt;handle)
<span class="line-modified">!   {</span>
<span class="line-modified">!     retval = module;</span>
<span class="line-modified">!     break;</span>
<span class="line-modified">!   }</span>
  
    return retval;
  }
  
  static inline GModule*
</pre>
<hr />
<pre>
<span class="line-old-header">*** 253,14 ***</span>
    GModule *module;
    GModule *retval = NULL;
  
    for (module = modules; module; module = module-&gt;next)
      if (strcmp (name, module-&gt;file_name) == 0)
<span class="line-modified">!     {</span>
<span class="line-modified">!       retval = module;</span>
<span class="line-modified">!       break;</span>
<span class="line-modified">!     }</span>
  
    return retval;
  }
  
  static inline void
<span class="line-new-header">--- 253,14 ---</span>
    GModule *module;
    GModule *retval = NULL;
  
    for (module = modules; module; module = module-&gt;next)
      if (strcmp (name, module-&gt;file_name) == 0)
<span class="line-modified">!   {</span>
<span class="line-modified">!     retval = module;</span>
<span class="line-modified">!     break;</span>
<span class="line-modified">!   }</span>
  
    return retval;
  }
  
  static inline void
</pre>
<hr />
<pre>
<span class="line-old-header">*** 276,49 ***</span>
    g_module_set_error_unduped (g_strdup (error));
  }
  
  
  /* --- include platform specifc code --- */
<span class="line-modified">! #define SUPPORT_OR_RETURN(rv)   { g_module_set_error (NULL); }</span>
  #if (G_MODULE_IMPL == G_MODULE_IMPL_DL)
  #include &quot;gmodule-dl.c&quot;
<span class="line-modified">! #elif   (G_MODULE_IMPL == G_MODULE_IMPL_WIN32)</span>
  #include &quot;gmodule-win32.c&quot;
<span class="line-modified">! #elif   (G_MODULE_IMPL == G_MODULE_IMPL_DYLD)</span>
  #include &quot;gmodule-dyld.c&quot;
<span class="line-modified">! #elif   (G_MODULE_IMPL == G_MODULE_IMPL_AR)</span>
  #include &quot;gmodule-ar.c&quot;
  #else
  #undef  SUPPORT_OR_RETURN
<span class="line-modified">! #define SUPPORT_OR_RETURN(rv)   { g_module_set_error (&quot;dynamic modules are &quot; \</span>
                                                &quot;not supported by this system&quot;); return rv; }
  static gpointer
  _g_module_open (const gchar *file_name,
<span class="line-modified">!         gboolean     bind_lazy,</span>
<span class="line-modified">!         gboolean     bind_local)</span>
  {
    return NULL;
  }
  static void
<span class="line-modified">! _g_module_close (gpointer    handle,</span>
<span class="line-modified">!          gboolean    is_unref)</span>
  {
  }
  static gpointer
  _g_module_self (void)
  {
    return NULL;
  }
  static gpointer
  _g_module_symbol (gpointer   handle,
<span class="line-modified">!           const gchar   *symbol_name)</span>
  {
    return NULL;
  }
  static gchar*
  _g_module_build_path (const gchar *directory,
<span class="line-modified">!               const gchar *module_name)</span>
  {
    return NULL;
  }
  #endif  /* no implementation */
  
<span class="line-new-header">--- 276,49 ---</span>
    g_module_set_error_unduped (g_strdup (error));
  }
  
  
  /* --- include platform specifc code --- */
<span class="line-modified">! #define SUPPORT_OR_RETURN(rv) { g_module_set_error (NULL); }</span>
  #if (G_MODULE_IMPL == G_MODULE_IMPL_DL)
  #include &quot;gmodule-dl.c&quot;
<span class="line-modified">! #elif (G_MODULE_IMPL == G_MODULE_IMPL_WIN32)</span>
  #include &quot;gmodule-win32.c&quot;
<span class="line-modified">! #elif (G_MODULE_IMPL == G_MODULE_IMPL_DYLD)</span>
  #include &quot;gmodule-dyld.c&quot;
<span class="line-modified">! #elif (G_MODULE_IMPL == G_MODULE_IMPL_AR)</span>
  #include &quot;gmodule-ar.c&quot;
  #else
  #undef  SUPPORT_OR_RETURN
<span class="line-modified">! #define SUPPORT_OR_RETURN(rv) { g_module_set_error (&quot;dynamic modules are &quot; \</span>
                                                &quot;not supported by this system&quot;); return rv; }
  static gpointer
  _g_module_open (const gchar *file_name,
<span class="line-modified">!     gboolean   bind_lazy,</span>
<span class="line-modified">!     gboolean   bind_local)</span>
  {
    return NULL;
  }
  static void
<span class="line-modified">! _g_module_close (gpointer  handle,</span>
<span class="line-modified">!      gboolean  is_unref)</span>
  {
  }
  static gpointer
  _g_module_self (void)
  {
    return NULL;
  }
  static gpointer
  _g_module_symbol (gpointer   handle,
<span class="line-modified">!       const gchar *symbol_name)</span>
  {
    return NULL;
  }
  static gchar*
  _g_module_build_path (const gchar *directory,
<span class="line-modified">!           const gchar *module_name)</span>
  {
    return NULL;
  }
  #endif  /* no implementation */
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 363,54 ***</span>
    /* search libtool&#39;s dlname specification  */
    scanner = g_scanner_new (NULL);
    g_scanner_input_file (scanner, fd);
    scanner-&gt;config-&gt;symbol_2_token = TRUE;
    g_scanner_scope_add_symbol (scanner, 0, &quot;dlname&quot;,
<span class="line-modified">!                   GUINT_TO_POINTER (TOKEN_DLNAME));</span>
    g_scanner_scope_add_symbol (scanner, 0, &quot;installed&quot;,
<span class="line-modified">!                   GUINT_TO_POINTER (TOKEN_INSTALLED));</span>
    g_scanner_scope_add_symbol (scanner, 0, &quot;libdir&quot;,
<span class="line-modified">!                   GUINT_TO_POINTER (TOKEN_LIBDIR));</span>
    while (!g_scanner_eof (scanner))
      {
        token = g_scanner_get_next_token (scanner);
        if (token == TOKEN_DLNAME || token == TOKEN_INSTALLED ||
<span class="line-modified">!       token == TOKEN_LIBDIR)</span>
      {
<span class="line-modified">!       if (g_scanner_get_next_token (scanner) != &#39;=&#39; ||</span>
<span class="line-modified">!           g_scanner_get_next_token (scanner) !=</span>
<span class="line-modified">!           (token == TOKEN_INSTALLED ?</span>
<span class="line-modified">!            G_TOKEN_IDENTIFIER : G_TOKEN_STRING))</span>
<span class="line-modified">!         {</span>
<span class="line-modified">!           gchar *display_libtool_name = g_filename_display_name (libtool_name);</span>
<span class="line-modified">!           g_module_set_error_unduped (g_strdup_printf (&quot;unable to parse libtool archive \&quot;%s\&quot;&quot;, display_libtool_name));</span>
<span class="line-modified">!           g_free (display_libtool_name);</span>
<span class="line-modified">! </span>
<span class="line-modified">!           g_free (lt_dlname);</span>
<span class="line-removed">-           g_free (lt_libdir);</span>
<span class="line-removed">-           g_scanner_destroy (scanner);</span>
<span class="line-removed">-           close (fd);</span>
<span class="line-removed">- </span>
<span class="line-removed">-           return NULL;</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-       else</span>
<span class="line-removed">-         {</span>
<span class="line-removed">-           if (token == TOKEN_DLNAME)</span>
<span class="line-removed">-         {</span>
<span class="line-removed">-           g_free (lt_dlname);</span>
<span class="line-removed">-           lt_dlname = g_strdup (scanner-&gt;value.v_string);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-           else if (token == TOKEN_INSTALLED)</span>
<span class="line-removed">-         lt_installed =</span>
<span class="line-removed">-           strcmp (scanner-&gt;value.v_identifier, &quot;yes&quot;) == 0;</span>
<span class="line-removed">-           else /* token == TOKEN_LIBDIR */</span>
<span class="line-removed">-         {</span>
<span class="line-removed">-           g_free (lt_libdir);</span>
<span class="line-removed">-           lt_libdir = g_strdup (scanner-&gt;value.v_string);</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-         }</span>
      }
      }
  
    if (!lt_installed)
      {
        gchar *dir = g_path_get_dirname (libtool_name);
<span class="line-new-header">--- 363,54 ---</span>
    /* search libtool&#39;s dlname specification  */
    scanner = g_scanner_new (NULL);
    g_scanner_input_file (scanner, fd);
    scanner-&gt;config-&gt;symbol_2_token = TRUE;
    g_scanner_scope_add_symbol (scanner, 0, &quot;dlname&quot;,
<span class="line-modified">!             GUINT_TO_POINTER (TOKEN_DLNAME));</span>
    g_scanner_scope_add_symbol (scanner, 0, &quot;installed&quot;,
<span class="line-modified">!             GUINT_TO_POINTER (TOKEN_INSTALLED));</span>
    g_scanner_scope_add_symbol (scanner, 0, &quot;libdir&quot;,
<span class="line-modified">!             GUINT_TO_POINTER (TOKEN_LIBDIR));</span>
    while (!g_scanner_eof (scanner))
      {
        token = g_scanner_get_next_token (scanner);
        if (token == TOKEN_DLNAME || token == TOKEN_INSTALLED ||
<span class="line-modified">!     token == TOKEN_LIBDIR)</span>
<span class="line-added">+   {</span>
<span class="line-added">+     if (g_scanner_get_next_token (scanner) != &#39;=&#39; ||</span>
<span class="line-added">+         g_scanner_get_next_token (scanner) !=</span>
<span class="line-added">+         (token == TOKEN_INSTALLED ?</span>
<span class="line-added">+          G_TOKEN_IDENTIFIER : G_TOKEN_STRING))</span>
<span class="line-added">+       {</span>
<span class="line-added">+         gchar *display_libtool_name = g_filename_display_name (libtool_name);</span>
<span class="line-added">+         g_module_set_error_unduped (g_strdup_printf (&quot;unable to parse libtool archive \&quot;%s\&quot;&quot;, display_libtool_name));</span>
<span class="line-added">+         g_free (display_libtool_name);</span>
<span class="line-added">+ </span>
<span class="line-added">+         g_free (lt_dlname);</span>
<span class="line-added">+         g_free (lt_libdir);</span>
<span class="line-added">+         g_scanner_destroy (scanner);</span>
<span class="line-added">+         close (fd);</span>
<span class="line-added">+ </span>
<span class="line-added">+         return NULL;</span>
<span class="line-added">+       }</span>
<span class="line-added">+     else</span>
<span class="line-added">+       {</span>
<span class="line-added">+         if (token == TOKEN_DLNAME)</span>
      {
<span class="line-modified">!       g_free (lt_dlname);</span>
<span class="line-modified">!       lt_dlname = g_strdup (scanner-&gt;value.v_string);</span>
<span class="line-modified">!     }</span>
<span class="line-modified">!         else if (token == TOKEN_INSTALLED)</span>
<span class="line-modified">!     lt_installed =</span>
<span class="line-modified">!       strcmp (scanner-&gt;value.v_identifier, &quot;yes&quot;) == 0;</span>
<span class="line-modified">!         else /* token == TOKEN_LIBDIR */</span>
<span class="line-modified">!     {</span>
<span class="line-modified">!       g_free (lt_libdir);</span>
<span class="line-modified">!       lt_libdir = g_strdup (scanner-&gt;value.v_string);</span>
      }
<span class="line-added">+       }</span>
<span class="line-added">+   }</span>
      }
  
    if (!lt_installed)
      {
        gchar *dir = g_path_get_dirname (libtool_name);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 429,11 ***</span>
    return name;
  }
  
  static inline gboolean
  str_check_suffix (const gchar* string,
<span class="line-modified">!           const gchar* suffix)</span>
  {
    gsize string_len = strlen (string);
    gsize suffix_len = strlen (suffix);
  
    return string_len &gt;= suffix_len &amp;&amp;
<span class="line-new-header">--- 429,11 ---</span>
    return name;
  }
  
  static inline gboolean
  str_check_suffix (const gchar* string,
<span class="line-modified">!       const gchar* suffix)</span>
  {
    gsize string_len = strlen (string);
    gsize suffix_len = strlen (suffix);
  
    return string_len &gt;= suffix_len &amp;&amp;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 487,11 ***</span>
   *
   * Returns: a #GModule on success, or %NULL on failure
   */
  GModule*
  g_module_open (const gchar    *file_name,
<span class="line-modified">!            GModuleFlags    flags)</span>
  {
    GModule *module;
    gpointer handle = NULL;
    gchar *name = NULL;
  
<span class="line-new-header">--- 487,11 ---</span>
   *
   * Returns: a #GModule on success, or %NULL on failure
   */
  GModule*
  g_module_open (const gchar    *file_name,
<span class="line-modified">!          GModuleFlags    flags)</span>
  {
    GModule *module;
    gpointer handle = NULL;
    gchar *name = NULL;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 506,29 ***</span>
      flags &amp;= ~G_MODULE_BIND_LAZY;
  
    if (!file_name)
      {
        if (!main_module)
<span class="line-modified">!     {</span>
<span class="line-modified">!       handle = _g_module_self ();</span>
  /* On Android 64 bit, RTLD_DEFAULT is (void *)0x0
   * so it always fails to create main_module if file_name is NULL */
  #if !defined(__BIONIC__) || !defined(__LP64__)
<span class="line-modified">!       if (handle)</span>
  #endif
<span class="line-modified">!         {</span>
<span class="line-modified">!           main_module = g_new (GModule, 1);</span>
<span class="line-modified">!           main_module-&gt;file_name = NULL;</span>
<span class="line-modified">!           main_module-&gt;handle = handle;</span>
<span class="line-modified">!           main_module-&gt;ref_count = 1;</span>
<span class="line-modified">!           main_module-&gt;is_resident = TRUE;</span>
<span class="line-modified">!           main_module-&gt;unload = NULL;</span>
<span class="line-modified">!           main_module-&gt;next = NULL;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!     }</span>
        else
<span class="line-modified">!     main_module-&gt;ref_count++;</span>
  
        g_rec_mutex_unlock (&amp;g_module_global_lock);
        return main_module;
      }
  
<span class="line-new-header">--- 506,29 ---</span>
      flags &amp;= ~G_MODULE_BIND_LAZY;
  
    if (!file_name)
      {
        if (!main_module)
<span class="line-modified">!   {</span>
<span class="line-modified">!     handle = _g_module_self ();</span>
  /* On Android 64 bit, RTLD_DEFAULT is (void *)0x0
   * so it always fails to create main_module if file_name is NULL */
  #if !defined(__BIONIC__) || !defined(__LP64__)
<span class="line-modified">!     if (handle)</span>
  #endif
<span class="line-modified">!       {</span>
<span class="line-modified">!         main_module = g_new (GModule, 1);</span>
<span class="line-modified">!         main_module-&gt;file_name = NULL;</span>
<span class="line-modified">!         main_module-&gt;handle = handle;</span>
<span class="line-modified">!         main_module-&gt;ref_count = 1;</span>
<span class="line-modified">!         main_module-&gt;is_resident = TRUE;</span>
<span class="line-modified">!         main_module-&gt;unload = NULL;</span>
<span class="line-modified">!         main_module-&gt;next = NULL;</span>
<span class="line-modified">!       }</span>
<span class="line-modified">!   }</span>
        else
<span class="line-modified">!   main_module-&gt;ref_count++;</span>
  
        g_rec_mutex_unlock (&amp;g_module_global_lock);
        return main_module;
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 548,24 ***</span>
    /* try completing file name with standard library suffix */
    if (!name)
      {
        name = g_strconcat (file_name, &quot;.&quot; G_MODULE_SUFFIX, NULL);
        if (!g_file_test (name, G_FILE_TEST_IS_REGULAR))
<span class="line-modified">!     {</span>
<span class="line-modified">!       g_free (name);</span>
<span class="line-modified">!       name = NULL;</span>
<span class="line-modified">!     }</span>
      }
    /* try completing by appending libtool suffix */
    if (!name)
      {
        name = g_strconcat (file_name, &quot;.la&quot;, NULL);
        if (!g_file_test (name, G_FILE_TEST_IS_REGULAR))
<span class="line-modified">!     {</span>
<span class="line-modified">!       g_free (name);</span>
<span class="line-modified">!       name = NULL;</span>
<span class="line-modified">!     }</span>
      }
    /* we can&#39;t access() the file, lets hope the platform backends finds
     * it via library paths
     */
    if (!name)
<span class="line-new-header">--- 548,24 ---</span>
    /* try completing file name with standard library suffix */
    if (!name)
      {
        name = g_strconcat (file_name, &quot;.&quot; G_MODULE_SUFFIX, NULL);
        if (!g_file_test (name, G_FILE_TEST_IS_REGULAR))
<span class="line-modified">!   {</span>
<span class="line-modified">!     g_free (name);</span>
<span class="line-modified">!     name = NULL;</span>
<span class="line-modified">!   }</span>
      }
    /* try completing by appending libtool suffix */
    if (!name)
      {
        name = g_strconcat (file_name, &quot;.la&quot;, NULL);
        if (!g_file_test (name, G_FILE_TEST_IS_REGULAR))
<span class="line-modified">!   {</span>
<span class="line-modified">!     g_free (name);</span>
<span class="line-modified">!     name = NULL;</span>
<span class="line-modified">!   }</span>
      }
    /* we can&#39;t access() the file, lets hope the platform backends finds
     * it via library paths
     */
    if (!name)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 573,33 ***</span>
        gchar *dot = strrchr (file_name, &#39;.&#39;);
        gchar *slash = strrchr (file_name, G_DIR_SEPARATOR);
  
        /* make sure the name has a suffix */
        if (!dot || dot &lt; slash)
<span class="line-modified">!     name = g_strconcat (file_name, &quot;.&quot; G_MODULE_SUFFIX, NULL);</span>
        else
<span class="line-modified">!     name = g_strdup (file_name);</span>
      }
  
    /* ok, try loading the module */
    if (name)
      {
        /* if it&#39;s a libtool archive, figure library file to load */
        if (str_check_suffix (name, &quot;.la&quot;)) /* libtool archive? */
<span class="line-modified">!     {</span>
<span class="line-modified">!       gchar *real_name = parse_libtool_archive (name);</span>
  
<span class="line-modified">!       /* real_name might be NULL, but then module error is already set */</span>
<span class="line-modified">!       if (real_name)</span>
<span class="line-modified">!         {</span>
<span class="line-modified">!           g_free (name);</span>
<span class="line-modified">!           name = real_name;</span>
              }
<span class="line-modified">!     }</span>
        if (name)
<span class="line-modified">!     handle = _g_module_open (name, (flags &amp; G_MODULE_BIND_LAZY) != 0,</span>
<span class="line-modified">!             (flags &amp; G_MODULE_BIND_LOCAL) != 0);</span>
      }
    else
      {
        gchar *display_file_name = g_filename_display_name (file_name);
        g_module_set_error_unduped (g_strdup_printf (&quot;unable to access file \&quot;%s\&quot;&quot;, display_file_name));
<span class="line-new-header">--- 573,33 ---</span>
        gchar *dot = strrchr (file_name, &#39;.&#39;);
        gchar *slash = strrchr (file_name, G_DIR_SEPARATOR);
  
        /* make sure the name has a suffix */
        if (!dot || dot &lt; slash)
<span class="line-modified">!   name = g_strconcat (file_name, &quot;.&quot; G_MODULE_SUFFIX, NULL);</span>
        else
<span class="line-modified">!   name = g_strdup (file_name);</span>
      }
  
    /* ok, try loading the module */
    if (name)
      {
        /* if it&#39;s a libtool archive, figure library file to load */
        if (str_check_suffix (name, &quot;.la&quot;)) /* libtool archive? */
<span class="line-modified">!   {</span>
<span class="line-modified">!     gchar *real_name = parse_libtool_archive (name);</span>
  
<span class="line-modified">!     /* real_name might be NULL, but then module error is already set */</span>
<span class="line-modified">!     if (real_name)</span>
<span class="line-modified">!       {</span>
<span class="line-modified">!         g_free (name);</span>
<span class="line-modified">!         name = real_name;</span>
              }
<span class="line-modified">!   }</span>
        if (name)
<span class="line-modified">!   handle = _g_module_open (name, (flags &amp; G_MODULE_BIND_LAZY) != 0,</span>
<span class="line-modified">!       (flags &amp; G_MODULE_BIND_LOCAL) != 0);</span>
      }
    else
      {
        gchar *display_file_name = g_filename_display_name (file_name);
        g_module_set_error_unduped (g_strdup_printf (&quot;unable to access file \&quot;%s\&quot;&quot;, display_file_name));
</pre>
<hr />
<pre>
<span class="line-old-header">*** 614,18 ***</span>
        const gchar *check_failed = NULL;
  
        /* search the module list by handle, since file names are not unique */
        module = g_module_find_by_handle (handle);
        if (module)
<span class="line-modified">!     {</span>
<span class="line-modified">!       _g_module_close (module-&gt;handle, TRUE);</span>
<span class="line-modified">!       module-&gt;ref_count++;</span>
<span class="line-modified">!       g_module_set_error (NULL);</span>
  
<span class="line-modified">!       g_rec_mutex_unlock (&amp;g_module_global_lock);</span>
<span class="line-modified">!       return module;</span>
<span class="line-modified">!     }</span>
  
        saved_error = g_strdup (g_module_error ());
        g_module_set_error (NULL);
  
        module = g_new (GModule, 1);
<span class="line-new-header">--- 614,18 ---</span>
        const gchar *check_failed = NULL;
  
        /* search the module list by handle, since file names are not unique */
        module = g_module_find_by_handle (handle);
        if (module)
<span class="line-modified">!   {</span>
<span class="line-modified">!     _g_module_close (module-&gt;handle, TRUE);</span>
<span class="line-modified">!     module-&gt;ref_count++;</span>
<span class="line-modified">!     g_module_set_error (NULL);</span>
  
<span class="line-modified">!     g_rec_mutex_unlock (&amp;g_module_global_lock);</span>
<span class="line-modified">!     return module;</span>
<span class="line-modified">!   }</span>
  
        saved_error = g_strdup (g_module_error ());
        g_module_set_error (NULL);
  
        module = g_new (GModule, 1);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 637,30 ***</span>
        module-&gt;next = modules;
        modules = module;
  
        /* check initialization */
        if (g_module_symbol (module, &quot;g_module_check_init&quot;, (gpointer) &amp;check_init) &amp;&amp; check_init != NULL)
<span class="line-modified">!     check_failed = check_init (module);</span>
  
        /* we don&#39;t call unload() if the initialization check failed. */
        if (!check_failed)
<span class="line-modified">!     g_module_symbol (module, &quot;g_module_unload&quot;, (gpointer) &amp;module-&gt;unload);</span>
  
        if (check_failed)
<span class="line-modified">!     {</span>
<span class="line-modified">!       gchar *error;</span>
  
<span class="line-modified">!       error = g_strconcat (&quot;GModule (&quot;, file_name, &quot;) &quot;,</span>
                                 &quot;initialization check failed: &quot;,
                                 check_failed, NULL);
<span class="line-modified">!       g_module_close (module);</span>
<span class="line-modified">!       module = NULL;</span>
<span class="line-modified">!       g_module_set_error (error);</span>
<span class="line-modified">!       g_free (error);</span>
<span class="line-modified">!     }</span>
        else
<span class="line-modified">!     g_module_set_error (saved_error);</span>
  
        g_free (saved_error);
      }
  
    if (module != NULL &amp;&amp;
<span class="line-new-header">--- 637,30 ---</span>
        module-&gt;next = modules;
        modules = module;
  
        /* check initialization */
        if (g_module_symbol (module, &quot;g_module_check_init&quot;, (gpointer) &amp;check_init) &amp;&amp; check_init != NULL)
<span class="line-modified">!   check_failed = check_init (module);</span>
  
        /* we don&#39;t call unload() if the initialization check failed. */
        if (!check_failed)
<span class="line-modified">!   g_module_symbol (module, &quot;g_module_unload&quot;, (gpointer) &amp;module-&gt;unload);</span>
  
        if (check_failed)
<span class="line-modified">!   {</span>
<span class="line-modified">!     gchar *error;</span>
  
<span class="line-modified">!     error = g_strconcat (&quot;GModule (&quot;, file_name, &quot;) &quot;,</span>
                                 &quot;initialization check failed: &quot;,
                                 check_failed, NULL);
<span class="line-modified">!     g_module_close (module);</span>
<span class="line-modified">!     module = NULL;</span>
<span class="line-modified">!     g_module_set_error (error);</span>
<span class="line-modified">!     g_free (error);</span>
<span class="line-modified">!   }</span>
        else
<span class="line-modified">!   g_module_set_error (saved_error);</span>
  
        g_free (saved_error);
      }
  
    if (module != NULL &amp;&amp;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 707,22 ***</span>
  
        last = NULL;
  
        node = modules;
        while (node)
<span class="line-modified">!     {</span>
<span class="line-modified">!       if (node == module)</span>
<span class="line-modified">!         {</span>
<span class="line-modified">!           if (last)</span>
<span class="line-modified">!         last-&gt;next = node-&gt;next;</span>
<span class="line-modified">!           else</span>
<span class="line-modified">!         modules = node-&gt;next;</span>
<span class="line-modified">!           break;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!       last = node;</span>
<span class="line-modified">!       node = last-&gt;next;</span>
<span class="line-modified">!     }</span>
        module-&gt;next = NULL;
  
        _g_module_close (module-&gt;handle, FALSE);
        g_free (module-&gt;file_name);
        g_free (module);
<span class="line-new-header">--- 707,22 ---</span>
  
        last = NULL;
  
        node = modules;
        while (node)
<span class="line-modified">!   {</span>
<span class="line-modified">!     if (node == module)</span>
<span class="line-modified">!       {</span>
<span class="line-modified">!         if (last)</span>
<span class="line-modified">!     last-&gt;next = node-&gt;next;</span>
<span class="line-modified">!         else</span>
<span class="line-modified">!     modules = node-&gt;next;</span>
<span class="line-modified">!         break;</span>
<span class="line-modified">!       }</span>
<span class="line-modified">!     last = node;</span>
<span class="line-modified">!     node = last-&gt;next;</span>
<span class="line-modified">!   }</span>
        module-&gt;next = NULL;
  
        _g_module_close (module-&gt;handle, FALSE);
        g_free (module-&gt;file_name);
        g_free (module);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 794,11 ***</span>
  
      name = g_strconcat (&quot;_&quot;, symbol_name, NULL);
      *symbol = _g_module_symbol (module-&gt;handle, name);
      g_free (name);
    }
<span class="line-modified">! #else   /* !G_MODULE_NEED_USCORE */</span>
    *symbol = _g_module_symbol (module-&gt;handle, symbol_name);
  #endif  /* !G_MODULE_NEED_USCORE */
  
    module_error = g_module_error ();
    if (module_error)
<span class="line-new-header">--- 794,11 ---</span>
  
      name = g_strconcat (&quot;_&quot;, symbol_name, NULL);
      *symbol = _g_module_symbol (module-&gt;handle, name);
      g_free (name);
    }
<span class="line-modified">! #else /* !G_MODULE_NEED_USCORE */</span>
    *symbol = _g_module_symbol (module-&gt;handle, symbol_name);
  #endif  /* !G_MODULE_NEED_USCORE */
  
    module_error = g_module_error ();
    if (module_error)
</pre>
<center><a href="gmodule-win32.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="gmodule.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>