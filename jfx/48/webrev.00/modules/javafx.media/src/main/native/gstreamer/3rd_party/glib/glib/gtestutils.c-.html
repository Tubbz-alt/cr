<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old modules/javafx.media/src/main/native/gstreamer/3rd_party/glib/glib/gtestutils.c</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /* GLib testing utilities
   2  * Copyright (C) 2007 Imendio AB
   3  * Authors: Tim Janik, Sven Herzberg
   4  *
   5  * This library is free software; you can redistribute it and/or
   6  * modify it under the terms of the GNU Lesser General Public
   7  * License as published by the Free Software Foundation; either
   8  * version 2.1 of the License, or (at your option) any later version.
   9  *
  10  * This library is distributed in the hope that it will be useful,
  11  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  12  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
  13  * Lesser General Public License for more details.
  14  *
  15  * You should have received a copy of the GNU Lesser General Public
  16  * License along with this library; if not, see &lt;http://www.gnu.org/licenses/&gt;.
  17  */
  18 
  19 #include &quot;config.h&quot;
  20 
  21 #include &quot;gtestutils.h&quot;
  22 #include &quot;gfileutils.h&quot;
  23 
  24 #include &lt;sys/types.h&gt;
  25 #ifdef G_OS_UNIX
  26 #include &lt;sys/wait.h&gt;
  27 #include &lt;sys/time.h&gt;
  28 #include &lt;fcntl.h&gt;
  29 #include &lt;unistd.h&gt;
  30 #include &lt;glib/gstdio.h&gt;
  31 #endif
  32 #include &lt;string.h&gt;
  33 #include &lt;stdlib.h&gt;
  34 #include &lt;stdio.h&gt;
  35 #ifdef HAVE_SYS_RESOURCE_H
  36 #include &lt;sys/resource.h&gt;
  37 #endif
  38 #ifdef G_OS_WIN32
  39 #include &lt;io.h&gt;
  40 #include &lt;windows.h&gt;
  41 #endif
  42 #include &lt;errno.h&gt;
  43 #include &lt;signal.h&gt;
  44 #ifdef HAVE_SYS_SELECT_H
  45 #include &lt;sys/select.h&gt;
  46 #endif /* HAVE_SYS_SELECT_H */
  47 
  48 #include &quot;gmain.h&quot;
  49 #include &quot;gpattern.h&quot;
  50 #include &quot;grand.h&quot;
  51 #include &quot;gstrfuncs.h&quot;
  52 #include &quot;gtimer.h&quot;
  53 #include &quot;gslice.h&quot;
  54 #include &quot;gspawn.h&quot;
  55 #include &quot;glib-private.h&quot;
  56 
  57 
  58 /**
  59  * SECTION:testing
  60  * @title: Testing
  61  * @short_description: a test framework
  62  * @see_also: [gtester][gtester], [gtester-report][gtester-report]
  63  *
  64  * GLib provides a framework for writing and maintaining unit tests
  65  * in parallel to the code they are testing. The API is designed according
  66  * to established concepts found in the other test frameworks (JUnit, NUnit,
  67  * RUnit), which in turn is based on smalltalk unit testing concepts.
  68  *
  69  * - Test case: Tests (test methods) are grouped together with their
  70  *   fixture into test cases.
  71  *
  72  * - Fixture: A test fixture consists of fixture data and setup and
  73  *   teardown methods to establish the environment for the test
  74  *   functions. We use fresh fixtures, i.e. fixtures are newly set
  75  *   up and torn down around each test invocation to avoid dependencies
  76  *   between tests.
  77  *
  78  * - Test suite: Test cases can be grouped into test suites, to allow
  79  *   subsets of the available tests to be run. Test suites can be
  80  *   grouped into other test suites as well.
  81  *
  82  * The API is designed to handle creation and registration of test suites
  83  * and test cases implicitly. A simple call like
  84  * |[&lt;!-- language=&quot;C&quot; --&gt;
  85  *   g_test_add_func (&quot;/misc/assertions&quot;, test_assertions);
  86  * ]|
  87  * creates a test suite called &quot;misc&quot; with a single test case named
  88  * &quot;assertions&quot;, which consists of running the test_assertions function.
  89  *
  90  * In addition to the traditional g_assert_true(), the test framework provides
  91  * an extended set of assertions for comparisons: g_assert_cmpfloat(),
  92  * g_assert_cmpfloat_with_epsilon(), g_assert_cmpint(), g_assert_cmpuint(),
  93  * g_assert_cmphex(), g_assert_cmpstr(), and g_assert_cmpmem(). The
  94  * advantage of these variants over plain g_assert_true() is that the assertion
  95  * messages can be more elaborate, and include the values of the compared
  96  * entities.
  97  *
  98  * Note that g_assert() should not be used in unit tests, since it is a no-op
  99  * when compiling with `G_DISABLE_ASSERT`. Use g_assert() in production code,
 100  * and g_assert_true() in unit tests.
 101  *
 102  * A full example of creating a test suite with two tests using fixtures:
 103  * |[&lt;!-- language=&quot;C&quot; --&gt;
 104  * #include &lt;glib.h&gt;
 105  * #include &lt;locale.h&gt;
 106  *
 107  * typedef struct {
 108  *   MyObject *obj;
 109  *   OtherObject *helper;
 110  * } MyObjectFixture;
 111  *
 112  * static void
 113  * my_object_fixture_set_up (MyObjectFixture *fixture,
 114  *                           gconstpointer user_data)
 115  * {
 116  *   fixture-&gt;obj = my_object_new ();
 117  *   my_object_set_prop1 (fixture-&gt;obj, &quot;some-value&quot;);
 118  *   my_object_do_some_complex_setup (fixture-&gt;obj, user_data);
 119  *
 120  *   fixture-&gt;helper = other_object_new ();
 121  * }
 122  *
 123  * static void
 124  * my_object_fixture_tear_down (MyObjectFixture *fixture,
 125  *                              gconstpointer user_data)
 126  * {
 127  *   g_clear_object (&amp;fixture-&gt;helper);
 128  *   g_clear_object (&amp;fixture-&gt;obj);
 129  * }
 130  *
 131  * static void
 132  * test_my_object_test1 (MyObjectFixture *fixture,
 133  *                       gconstpointer user_data)
 134  * {
 135  *   g_assert_cmpstr (my_object_get_property (fixture-&gt;obj), ==, &quot;initial-value&quot;);
 136  * }
 137  *
 138  * static void
 139  * test_my_object_test2 (MyObjectFixture *fixture,
 140  *                       gconstpointer user_data)
 141  * {
 142  *   my_object_do_some_work_using_helper (fixture-&gt;obj, fixture-&gt;helper);
 143  *   g_assert_cmpstr (my_object_get_property (fixture-&gt;obj), ==, &quot;updated-value&quot;);
 144  * }
 145  *
 146  * int
 147  * main (int argc, char *argv[])
 148  * {
 149  *   setlocale (LC_ALL, &quot;&quot;);
 150  *
 151  *   g_test_init (&amp;argc, &amp;argv, NULL);
 152  *   g_test_bug_base (&quot;http://bugzilla.gnome.org/show_bug.cgi?id=&quot;);
 153  *
 154  *   // Define the tests.
 155  *   g_test_add (&quot;/my-object/test1&quot;, MyObjectFixture, &quot;some-user-data&quot;,
 156  *               my_object_fixture_set_up, test_my_object_test1,
 157  *               my_object_fixture_tear_down);
 158  *   g_test_add (&quot;/my-object/test2&quot;, MyObjectFixture, &quot;some-user-data&quot;,
 159  *               my_object_fixture_set_up, test_my_object_test2,
 160  *               my_object_fixture_tear_down);
 161  *
 162  *   return g_test_run ();
 163  * }
 164  * ]|
 165  *
 166  * ### Integrating GTest in your project
 167  *
 168  * If you are using the [Meson](http://mesonbuild.com) build system, you will
 169  * typically use the provided `test()` primitive to call the test binaries,
 170  * e.g.:
 171  *
 172  * |[&lt;!-- language=&quot;plain&quot; --&gt;
 173  *   test(
 174  *     &#39;foo&#39;,
 175  *     executable(&#39;foo&#39;, &#39;foo.c&#39;, dependencies: deps),
 176  *     env: [
 177  *       &#39;G_TEST_SRCDIR=@0@&#39;.format(meson.current_source_dir()),
 178  *       &#39;G_TEST_BUILDDIR=@0@&#39;.format(meson.current_build_dir()),
 179  *     ],
 180  *   )
 181  *
 182  *   test(
 183  *     &#39;bar&#39;,
 184  *     executable(&#39;bar&#39;, &#39;bar.c&#39;, dependencies: deps),
 185  *     env: [
 186  *       &#39;G_TEST_SRCDIR=@0@&#39;.format(meson.current_source_dir()),
 187  *       &#39;G_TEST_BUILDDIR=@0@&#39;.format(meson.current_build_dir()),
 188  *     ],
 189  *   )
 190  * ]|
 191  *
 192  * If you are using Autotools, you&#39;re strongly encouraged to use the Automake
 193  * [TAP](https://testanything.org/) harness; GLib provides template files for
 194  * easily integrating with it:
 195  *
 196  *   - [glib-tap.mk](https://git.gnome.org/browse/glib/tree/glib-tap.mk)
 197  *   - [tap-test](https://git.gnome.org/browse/glib/tree/tap-test)
 198  *   - [tap-driver.sh](https://git.gnome.org/browse/glib/tree/tap-driver.sh)
 199  *
 200  * You can copy these files in your own project&#39;s root directory, and then
 201  * set up your `Makefile.am` file to reference them, for instance:
 202  *
 203  * |[&lt;!-- language=&quot;plain&quot; --&gt;
 204  * include $(top_srcdir)/glib-tap.mk
 205  *
 206  * # test binaries
 207  * test_programs = \
 208  *   foo \
 209  *   bar
 210  *
 211  * # data distributed in the tarball
 212  * dist_test_data = \
 213  *   foo.data.txt \
 214  *   bar.data.txt
 215  *
 216  * # data not distributed in the tarball
 217  * test_data = \
 218  *   blah.data.txt
 219  * ]|
 220  *
 221  * Make sure to distribute the TAP files, using something like the following
 222  * in your top-level `Makefile.am`:
 223  *
 224  * |[&lt;!-- language=&quot;plain&quot; --&gt;
 225  * EXTRA_DIST += \
 226  *   tap-driver.sh \
 227  *   tap-test
 228  * ]|
 229  *
 230  * `glib-tap.mk` will be distributed implicitly due to being included in a
 231  * `Makefile.am`. All three files should be added to version control.
 232  *
 233  * If you don&#39;t have access to the Autotools TAP harness, you can use the
 234  * [gtester][gtester] and [gtester-report][gtester-report] tools, and use
 235  * the [glib.mk](https://git.gnome.org/browse/glib/tree/glib.mk) Automake
 236  * template provided by GLib.
 237  */
 238 
 239 /**
 240  * g_test_initialized:
 241  *
 242  * Returns %TRUE if g_test_init() has been called.
 243  *
 244  * Returns: %TRUE if g_test_init() has been called.
 245  *
 246  * Since: 2.36
 247  */
 248 
 249 /**
 250  * g_test_quick:
 251  *
 252  * Returns %TRUE if tests are run in quick mode.
 253  * Exactly one of g_test_quick() and g_test_slow() is active in any run;
 254  * there is no &quot;medium speed&quot;.
 255  *
 256  * By default, tests are run in quick mode. In tests that use
 257  * g_test_init(), the options `-m quick`, `-m slow` and `-m thorough`
 258  * can be used to change this.
 259  *
 260  * Returns: %TRUE if in quick mode
 261  */
 262 
 263 /**
 264  * g_test_slow:
 265  *
 266  * Returns %TRUE if tests are run in slow mode.
 267  * Exactly one of g_test_quick() and g_test_slow() is active in any run;
 268  * there is no &quot;medium speed&quot;.
 269  *
 270  * By default, tests are run in quick mode. In tests that use
 271  * g_test_init(), the options `-m quick`, `-m slow` and `-m thorough`
 272  * can be used to change this.
 273  *
 274  * Returns: the opposite of g_test_quick()
 275  */
 276 
 277 /**
 278  * g_test_thorough:
 279  *
 280  * Returns %TRUE if tests are run in thorough mode, equivalent to
 281  * g_test_slow().
 282  *
 283  * By default, tests are run in quick mode. In tests that use
 284  * g_test_init(), the options `-m quick`, `-m slow` and `-m thorough`
 285  * can be used to change this.
 286  *
 287  * Returns: the same thing as g_test_slow()
 288  */
 289 
 290 /**
 291  * g_test_perf:
 292  *
 293  * Returns %TRUE if tests are run in performance mode.
 294  *
 295  * By default, tests are run in quick mode. In tests that use
 296  * g_test_init(), the option `-m perf` enables performance tests, while
 297  * `-m quick` disables them.
 298  *
 299  * Returns: %TRUE if in performance mode
 300  */
 301 
 302 /**
 303  * g_test_undefined:
 304  *
 305  * Returns %TRUE if tests may provoke assertions and other formally-undefined
 306  * behaviour, to verify that appropriate warnings are given. It might, in some
 307  * cases, be useful to turn this off with if running tests under valgrind;
 308  * in tests that use g_test_init(), the option `-m no-undefined` disables
 309  * those tests, while `-m undefined` explicitly enables them (the default
 310  * behaviour).
 311  *
 312  * Returns: %TRUE if tests may provoke programming errors
 313  */
 314 
 315 /**
 316  * g_test_verbose:
 317  *
 318  * Returns %TRUE if tests are run in verbose mode.
 319  * In tests that use g_test_init(), the option `--verbose` enables this,
 320  * while `-q` or `--quiet` disables it.
 321  * The default is neither g_test_verbose() nor g_test_quiet().
 322  *
 323  * Returns: %TRUE if in verbose mode
 324  */
 325 
 326 /**
 327  * g_test_quiet:
 328  *
 329  * Returns %TRUE if tests are run in quiet mode.
 330  * In tests that use g_test_init(), the option `-q` or `--quiet` enables
 331  * this, while `--verbose` disables it.
 332  * The default is neither g_test_verbose() nor g_test_quiet().
 333  *
 334  * Returns: %TRUE if in quiet mode
 335  */
 336 
 337 /**
 338  * g_test_queue_unref:
 339  * @gobject: the object to unref
 340  *
 341  * Enqueue an object to be released with g_object_unref() during
 342  * the next teardown phase. This is equivalent to calling
 343  * g_test_queue_destroy() with a destroy callback of g_object_unref().
 344  *
 345  * Since: 2.16
 346  */
 347 
 348 /**
 349  * GTestTrapFlags:
 350  * @G_TEST_TRAP_SILENCE_STDOUT: Redirect stdout of the test child to
 351  *     `/dev/null` so it cannot be observed on the console during test
 352  *     runs. The actual output is still captured though to allow later
 353  *     tests with g_test_trap_assert_stdout().
 354  * @G_TEST_TRAP_SILENCE_STDERR: Redirect stderr of the test child to
 355  *     `/dev/null` so it cannot be observed on the console during test
 356  *     runs. The actual output is still captured though to allow later
 357  *     tests with g_test_trap_assert_stderr().
 358  * @G_TEST_TRAP_INHERIT_STDIN: If this flag is given, stdin of the
 359  *     child process is shared with stdin of its parent process.
 360  *     It is redirected to `/dev/null` otherwise.
 361  *
 362  * Test traps are guards around forked tests.
 363  * These flags determine what traps to set.
 364  *
 365  * Deprecated: #GTestTrapFlags is used only with g_test_trap_fork(),
 366  * which is deprecated. g_test_trap_subprocess() uses
 367  * #GTestSubprocessFlags.
 368  */
 369 
 370 /**
 371  * GTestSubprocessFlags:
 372  * @G_TEST_SUBPROCESS_INHERIT_STDIN: If this flag is given, the child
 373  *     process will inherit the parent&#39;s stdin. Otherwise, the child&#39;s
 374  *     stdin is redirected to `/dev/null`.
 375  * @G_TEST_SUBPROCESS_INHERIT_STDOUT: If this flag is given, the child
 376  *     process will inherit the parent&#39;s stdout. Otherwise, the child&#39;s
 377  *     stdout will not be visible, but it will be captured to allow
 378  *     later tests with g_test_trap_assert_stdout().
 379  * @G_TEST_SUBPROCESS_INHERIT_STDERR: If this flag is given, the child
 380  *     process will inherit the parent&#39;s stderr. Otherwise, the child&#39;s
 381  *     stderr will not be visible, but it will be captured to allow
 382  *     later tests with g_test_trap_assert_stderr().
 383  *
 384  * Flags to pass to g_test_trap_subprocess() to control input and output.
 385  *
 386  * Note that in contrast with g_test_trap_fork(), the default is to
 387  * not show stdout and stderr.
 388  */
 389 
 390 /**
 391  * g_test_trap_assert_passed:
 392  *
 393  * Assert that the last test subprocess passed.
 394  * See g_test_trap_subprocess().
 395  *
 396  * Since: 2.16
 397  */
 398 
 399 /**
 400  * g_test_trap_assert_failed:
 401  *
 402  * Assert that the last test subprocess failed.
 403  * See g_test_trap_subprocess().
 404  *
 405  * This is sometimes used to test situations that are formally considered to
 406  * be undefined behaviour, like inputs that fail a g_return_if_fail()
 407  * check. In these situations you should skip the entire test, including the
 408  * call to g_test_trap_subprocess(), unless g_test_undefined() returns %TRUE
 409  * to indicate that undefined behaviour may be tested.
 410  *
 411  * Since: 2.16
 412  */
 413 
 414 /**
 415  * g_test_trap_assert_stdout:
 416  * @soutpattern: a glob-style [pattern][glib-Glob-style-pattern-matching]
 417  *
 418  * Assert that the stdout output of the last test subprocess matches
 419  * @soutpattern. See g_test_trap_subprocess().
 420  *
 421  * Since: 2.16
 422  */
 423 
 424 /**
 425  * g_test_trap_assert_stdout_unmatched:
 426  * @soutpattern: a glob-style [pattern][glib-Glob-style-pattern-matching]
 427  *
 428  * Assert that the stdout output of the last test subprocess
 429  * does not match @soutpattern. See g_test_trap_subprocess().
 430  *
 431  * Since: 2.16
 432  */
 433 
 434 /**
 435  * g_test_trap_assert_stderr:
 436  * @serrpattern: a glob-style [pattern][glib-Glob-style-pattern-matching]
 437  *
 438  * Assert that the stderr output of the last test subprocess
 439  * matches @serrpattern. See  g_test_trap_subprocess().
 440  *
 441  * This is sometimes used to test situations that are formally
 442  * considered to be undefined behaviour, like code that hits a
 443  * g_assert() or g_error(). In these situations you should skip the
 444  * entire test, including the call to g_test_trap_subprocess(), unless
 445  * g_test_undefined() returns %TRUE to indicate that undefined
 446  * behaviour may be tested.
 447  *
 448  * Since: 2.16
 449  */
 450 
 451 /**
 452  * g_test_trap_assert_stderr_unmatched:
 453  * @serrpattern: a glob-style [pattern][glib-Glob-style-pattern-matching]
 454  *
 455  * Assert that the stderr output of the last test subprocess
 456  * does not match @serrpattern. See g_test_trap_subprocess().
 457  *
 458  * Since: 2.16
 459  */
 460 
 461 /**
 462  * g_test_rand_bit:
 463  *
 464  * Get a reproducible random bit (0 or 1), see g_test_rand_int()
 465  * for details on test case random numbers.
 466  *
 467  * Since: 2.16
 468  */
 469 
 470 /**
 471  * g_assert:
 472  * @expr: the expression to check
 473  *
 474  * Debugging macro to terminate the application if the assertion
 475  * fails. If the assertion fails (i.e. the expression is not true),
 476  * an error message is logged and the application is terminated.
 477  *
 478  * The macro can be turned off in final releases of code by defining
 479  * `G_DISABLE_ASSERT` when compiling the application, so code must
 480  * not depend on any side effects from @expr. Similarly, it must not be used
 481  * in unit tests, otherwise the unit tests will be ineffective if compiled with
 482  * `G_DISABLE_ASSERT`. Use g_assert_true() and related macros in unit tests
 483  * instead.
 484  */
 485 
 486 /**
 487  * g_assert_not_reached:
 488  *
 489  * Debugging macro to terminate the application if it is ever
 490  * reached. If it is reached, an error message is logged and the
 491  * application is terminated.
 492  *
 493  * The macro can be turned off in final releases of code by defining
 494  * `G_DISABLE_ASSERT` when compiling the application. Hence, it should not be
 495  * used in unit tests, where assertions should always be effective.
 496  */
 497 
 498 /**
 499  * g_assert_true:
 500  * @expr: the expression to check
 501  *
 502  * Debugging macro to check that an expression is true.
 503  *
 504  * If the assertion fails (i.e. the expression is not true),
 505  * an error message is logged and the application is either
 506  * terminated or the testcase marked as failed.
 507  *
 508  * Note that unlike g_assert(), this macro is unaffected by whether
 509  * `G_DISABLE_ASSERT` is defined. Hence it should only be used in tests and,
 510  * conversely, g_assert() should not be used in tests.
 511  *
 512  * See g_test_set_nonfatal_assertions().
 513  *
 514  * Since: 2.38
 515  */
 516 
 517 /**
 518  * g_assert_false:
 519  * @expr: the expression to check
 520  *
 521  * Debugging macro to check an expression is false.
 522  *
 523  * If the assertion fails (i.e. the expression is not false),
 524  * an error message is logged and the application is either
 525  * terminated or the testcase marked as failed.
 526  *
 527  * Note that unlike g_assert(), this macro is unaffected by whether
 528  * `G_DISABLE_ASSERT` is defined. Hence it should only be used in tests and,
 529  * conversely, g_assert() should not be used in tests.
 530  *
 531  * See g_test_set_nonfatal_assertions().
 532  *
 533  * Since: 2.38
 534  */
 535 
 536 /**
 537  * g_assert_null:
 538  * @expr: the expression to check
 539  *
 540  * Debugging macro to check an expression is %NULL.
 541  *
 542  * If the assertion fails (i.e. the expression is not %NULL),
 543  * an error message is logged and the application is either
 544  * terminated or the testcase marked as failed.
 545  *
 546  * Note that unlike g_assert(), this macro is unaffected by whether
 547  * `G_DISABLE_ASSERT` is defined. Hence it should only be used in tests and,
 548  * conversely, g_assert() should not be used in tests.
 549  *
 550  * See g_test_set_nonfatal_assertions().
 551  *
 552  * Since: 2.38
 553  */
 554 
 555 /**
 556  * g_assert_nonnull:
 557  * @expr: the expression to check
 558  *
 559  * Debugging macro to check an expression is not %NULL.
 560  *
 561  * If the assertion fails (i.e. the expression is %NULL),
 562  * an error message is logged and the application is either
 563  * terminated or the testcase marked as failed.
 564  *
 565  * Note that unlike g_assert(), this macro is unaffected by whether
 566  * `G_DISABLE_ASSERT` is defined. Hence it should only be used in tests and,
 567  * conversely, g_assert() should not be used in tests.
 568  *
 569  * See g_test_set_nonfatal_assertions().
 570  *
 571  * Since: 2.40
 572  */
 573 
 574 /**
 575  * g_assert_cmpstr:
 576  * @s1: a string (may be %NULL)
 577  * @cmp: The comparison operator to use.
 578  *     One of ==, !=, &lt;, &gt;, &lt;=, &gt;=.
 579  * @s2: another string (may be %NULL)
 580  *
 581  * Debugging macro to compare two strings. If the comparison fails,
 582  * an error message is logged and the application is either terminated
 583  * or the testcase marked as failed.
 584  * The strings are compared using g_strcmp0().
 585  *
 586  * The effect of `g_assert_cmpstr (s1, op, s2)` is
 587  * the same as `g_assert_true (g_strcmp0 (s1, s2) op 0)`.
 588  * The advantage of this macro is that it can produce a message that
 589  * includes the actual values of @s1 and @s2.
 590  *
 591  * |[&lt;!-- language=&quot;C&quot; --&gt;
 592  *   g_assert_cmpstr (mystring, ==, &quot;fubar&quot;);
 593  * ]|
 594  *
 595  * Since: 2.16
 596  */
 597 
 598 /**
 599  * g_assert_cmpint:
 600  * @n1: an integer
 601  * @cmp: The comparison operator to use.
 602  *     One of ==, !=, &lt;, &gt;, &lt;=, &gt;=.
 603  * @n2: another integer
 604  *
 605  * Debugging macro to compare two integers.
 606  *
 607  * The effect of `g_assert_cmpint (n1, op, n2)` is
 608  * the same as `g_assert_true (n1 op n2)`. The advantage
 609  * of this macro is that it can produce a message that includes the
 610  * actual values of @n1 and @n2.
 611  *
 612  * Since: 2.16
 613  */
 614 
 615 /**
 616  * g_assert_cmpuint:
 617  * @n1: an unsigned integer
 618  * @cmp: The comparison operator to use.
 619  *     One of ==, !=, &lt;, &gt;, &lt;=, &gt;=.
 620  * @n2: another unsigned integer
 621  *
 622  * Debugging macro to compare two unsigned integers.
 623  *
 624  * The effect of `g_assert_cmpuint (n1, op, n2)` is
 625  * the same as `g_assert_true (n1 op n2)`. The advantage
 626  * of this macro is that it can produce a message that includes the
 627  * actual values of @n1 and @n2.
 628  *
 629  * Since: 2.16
 630  */
 631 
 632 /**
 633  * g_assert_cmphex:
 634  * @n1: an unsigned integer
 635  * @cmp: The comparison operator to use.
 636  *     One of ==, !=, &lt;, &gt;, &lt;=, &gt;=.
 637  * @n2: another unsigned integer
 638  *
 639  * Debugging macro to compare to unsigned integers.
 640  *
 641  * This is a variant of g_assert_cmpuint() that displays the numbers
 642  * in hexadecimal notation in the message.
 643  *
 644  * Since: 2.16
 645  */
 646 
 647 /**
 648  * g_assert_cmpfloat:
 649  * @n1: an floating point number
 650  * @cmp: The comparison operator to use.
 651  *     One of ==, !=, &lt;, &gt;, &lt;=, &gt;=.
 652  * @n2: another floating point number
 653  *
 654  * Debugging macro to compare two floating point numbers.
 655  *
 656  * The effect of `g_assert_cmpfloat (n1, op, n2)` is
 657  * the same as `g_assert_true (n1 op n2)`. The advantage
 658  * of this macro is that it can produce a message that includes the
 659  * actual values of @n1 and @n2.
 660  *
 661  * Since: 2.16
 662  */
 663 
 664 /**
 665  * g_assert_cmpfloat_with_epsilon:
 666  * @n1: an floating point number
 667  * @n2: another floating point number
 668  * @epsilon: a numeric value that expresses the expected tolerance
 669  *   between @n1 and @n2
 670  *
 671  * Debugging macro to compare two floating point numbers within an epsilon.
 672  *
 673  * The effect of `g_assert_cmpfloat_with_epsilon (n1, n2, epsilon)` is
 674  * the same as `g_assert_true (abs (n1 - n2) &lt; epsilon)`. The advantage
 675  * of this macro is that it can produce a message that includes the
 676  * actual values of @n1 and @n2.
 677  *
 678  * Since: 2.58
 679  */
 680 
 681 /**
 682  * g_assert_cmpmem:
 683  * @m1: pointer to a buffer
 684  * @l1: length of @m1
 685  * @m2: pointer to another buffer
 686  * @l2: length of @m2
 687  *
 688  * Debugging macro to compare memory regions. If the comparison fails,
 689  * an error message is logged and the application is either terminated
 690  * or the testcase marked as failed.
 691  *
 692  * The effect of `g_assert_cmpmem (m1, l1, m2, l2)` is
 693  * the same as `g_assert_true (l1 == l2 &amp;&amp; memcmp (m1, m2, l1) == 0)`.
 694  * The advantage of this macro is that it can produce a message that
 695  * includes the actual values of @l1 and @l2.
 696  *
 697  * |[&lt;!-- language=&quot;C&quot; --&gt;
 698  *   g_assert_cmpmem (buf-&gt;data, buf-&gt;len, expected, sizeof (expected));
 699  * ]|
 700  *
 701  * Since: 2.46
 702  */
 703 
 704 /**
 705  * g_assert_no_error:
 706  * @err: a #GError, possibly %NULL
 707  *
 708  * Debugging macro to check that a #GError is not set.
 709  *
 710  * The effect of `g_assert_no_error (err)` is
 711  * the same as `g_assert_true (err == NULL)`. The advantage
 712  * of this macro is that it can produce a message that includes
 713  * the error message and code.
 714  *
 715  * Since: 2.20
 716  */
 717 
 718 /**
 719  * g_assert_error:
 720  * @err: a #GError, possibly %NULL
 721  * @dom: the expected error domain (a #GQuark)
 722  * @c: the expected error code
 723  *
 724  * Debugging macro to check that a method has returned
 725  * the correct #GError.
 726  *
 727  * The effect of `g_assert_error (err, dom, c)` is
 728  * the same as `g_assert_true (err != NULL &amp;&amp; err-&gt;domain
 729  * == dom &amp;&amp; err-&gt;code == c)`. The advantage of this
 730  * macro is that it can produce a message that includes the incorrect
 731  * error message and code.
 732  *
 733  * This can only be used to test for a specific error. If you want to
 734  * test that @err is set, but don&#39;t care what it&#39;s set to, just use
 735  * `g_assert (err != NULL)`
 736  *
 737  * Since: 2.20
 738  */
 739 
 740 /**
 741  * GTestCase:
 742  *
 743  * An opaque structure representing a test case.
 744  */
 745 
 746 /**
 747  * GTestSuite:
 748  *
 749  * An opaque structure representing a test suite.
 750  */
 751 
 752 
 753 /* Global variable for storing assertion messages; this is the counterpart to
 754  * glibc&#39;s (private) __abort_msg variable, and allows developers and crash
 755  * analysis systems like Apport and ABRT to fish out assertion messages from
 756  * core dumps, instead of having to catch them on screen output.
 757  */
 758 GLIB_VAR char *__glib_assert_msg;
 759 char *__glib_assert_msg = NULL;
 760 
 761 /* --- constants --- */
 762 #define G_TEST_STATUS_TIMED_OUT 1024
 763 
 764 /* --- structures --- */
 765 struct GTestCase
 766 {
 767   gchar  *name;
 768   guint   fixture_size;
 769   void   (*fixture_setup)    (void*, gconstpointer);
 770   void   (*fixture_test)     (void*, gconstpointer);
 771   void   (*fixture_teardown) (void*, gconstpointer);
 772   gpointer test_data;
 773 };
 774 struct GTestSuite
 775 {
 776   gchar  *name;
 777   GSList *suites;
 778   GSList *cases;
 779 };
 780 typedef struct DestroyEntry DestroyEntry;
 781 struct DestroyEntry
 782 {
 783   DestroyEntry *next;
 784   GDestroyNotify destroy_func;
 785   gpointer       destroy_data;
 786 };
 787 
 788 /* --- prototypes --- */
 789 static void     test_run_seed                   (const gchar *rseed);
 790 static void     test_trap_clear                 (void);
 791 static guint8*  g_test_log_dump                 (GTestLogMsg *msg,
 792                                                  guint       *len);
 793 static void     gtest_default_log_handler       (const gchar    *log_domain,
 794                                                  GLogLevelFlags  log_level,
 795                                                  const gchar    *message,
 796                                                  gpointer        unused_data);
 797 
 798 
 799 static const char * const g_test_result_names[] = {
 800   &quot;OK&quot;,
 801   &quot;SKIP&quot;,
 802   &quot;FAIL&quot;,
 803   &quot;TODO&quot;
 804 };
 805 
 806 /* --- variables --- */
 807 static int         test_log_fd = -1;
 808 static gboolean    test_mode_fatal = TRUE;
 809 static gboolean    g_test_run_once = TRUE;
 810 static gboolean    test_run_list = FALSE;
 811 static gchar      *test_run_seedstr = NULL;
 812 static GRand      *test_run_rand = NULL;
 813 static gchar      *test_run_name = &quot;&quot;;
 814 static GSList    **test_filename_free_list;
 815 static guint       test_run_forks = 0;
 816 static guint       test_run_count = 0;
 817 static guint       test_count = 0;
 818 static guint       test_skipped_count = 0;
 819 static GTestResult test_run_success = G_TEST_RUN_FAILURE;
 820 static gchar      *test_run_msg = NULL;
 821 static guint       test_startup_skip_count = 0;
 822 static GTimer     *test_user_timer = NULL;
 823 static double      test_user_stamp = 0;
 824 static GSList     *test_paths = NULL;
 825 static GSList     *test_paths_skipped = NULL;
 826 static GTestSuite *test_suite_root = NULL;
 827 static int         test_trap_last_status = 0;  /* unmodified platform-specific status */
 828 static GPid        test_trap_last_pid = 0;
 829 static char       *test_trap_last_subprocess = NULL;
 830 static char       *test_trap_last_stdout = NULL;
 831 static char       *test_trap_last_stderr = NULL;
 832 static char       *test_uri_base = NULL;
 833 static gboolean    test_debug_log = FALSE;
 834 static gboolean    test_tap_log = FALSE;
 835 static gboolean    test_nonfatal_assertions = FALSE;
 836 static DestroyEntry *test_destroy_queue = NULL;
 837 static char       *test_argv0 = NULL;
 838 static char       *test_argv0_dirname;
 839 static const char *test_disted_files_dir;
 840 static const char *test_built_files_dir;
 841 static char       *test_initial_cwd = NULL;
 842 static gboolean    test_in_forked_child = FALSE;
 843 static gboolean    test_in_subprocess = FALSE;
 844 static GTestConfig mutable_test_config_vars = {
 845   FALSE,        /* test_initialized */
 846   TRUE,         /* test_quick */
 847   FALSE,        /* test_perf */
 848   FALSE,        /* test_verbose */
 849   FALSE,        /* test_quiet */
 850   TRUE,         /* test_undefined */
 851 };
 852 const GTestConfig * const g_test_config_vars = &amp;mutable_test_config_vars;
 853 static gboolean  no_g_set_prgname = FALSE;
 854 
 855 /* --- functions --- */
 856 const char*
 857 g_test_log_type_name (GTestLogType log_type)
 858 {
 859   switch (log_type)
 860     {
 861     case G_TEST_LOG_NONE:               return &quot;none&quot;;
 862     case G_TEST_LOG_ERROR:              return &quot;error&quot;;
 863     case G_TEST_LOG_START_BINARY:       return &quot;binary&quot;;
 864     case G_TEST_LOG_LIST_CASE:          return &quot;list&quot;;
 865     case G_TEST_LOG_SKIP_CASE:          return &quot;skip&quot;;
 866     case G_TEST_LOG_START_CASE:         return &quot;start&quot;;
 867     case G_TEST_LOG_STOP_CASE:          return &quot;stop&quot;;
 868     case G_TEST_LOG_MIN_RESULT:         return &quot;minperf&quot;;
 869     case G_TEST_LOG_MAX_RESULT:         return &quot;maxperf&quot;;
 870     case G_TEST_LOG_MESSAGE:            return &quot;message&quot;;
 871     case G_TEST_LOG_START_SUITE:        return &quot;start suite&quot;;
 872     case G_TEST_LOG_STOP_SUITE:         return &quot;stop suite&quot;;
 873     }
 874   return &quot;???&quot;;
 875 }
 876 
 877 static void
 878 g_test_log_send (guint         n_bytes,
 879                  const guint8 *buffer)
 880 {
 881   if (test_log_fd &gt;= 0)
 882     {
 883       int r;
 884       do
 885         r = write (test_log_fd, buffer, n_bytes);
 886       while (r &lt; 0 &amp;&amp; errno == EINTR);
 887     }
 888   if (test_debug_log)
 889     {
 890       GTestLogBuffer *lbuffer = g_test_log_buffer_new ();
 891       GTestLogMsg *msg;
 892       guint ui;
 893       g_test_log_buffer_push (lbuffer, n_bytes, buffer);
 894       msg = g_test_log_buffer_pop (lbuffer);
 895       g_warn_if_fail (msg != NULL);
 896       g_warn_if_fail (lbuffer-&gt;data-&gt;len == 0);
 897       g_test_log_buffer_free (lbuffer);
 898       /* print message */
 899       g_printerr (&quot;{*LOG(%s)&quot;, g_test_log_type_name (msg-&gt;log_type));
 900       for (ui = 0; ui &lt; msg-&gt;n_strings; ui++)
 901         g_printerr (&quot;:{%s}&quot;, msg-&gt;strings[ui]);
 902       if (msg-&gt;n_nums)
 903         {
 904           g_printerr (&quot;:(&quot;);
 905           for (ui = 0; ui &lt; msg-&gt;n_nums; ui++)
 906             {
 907               if ((long double) (long) msg-&gt;nums[ui] == msg-&gt;nums[ui])
 908                 g_printerr (&quot;%s%ld&quot;, ui ? &quot;;&quot; : &quot;&quot;, (long) msg-&gt;nums[ui]);
 909               else
 910                 g_printerr (&quot;%s%.16g&quot;, ui ? &quot;;&quot; : &quot;&quot;, (double) msg-&gt;nums[ui]);
 911             }
 912           g_printerr (&quot;)&quot;);
 913         }
 914       g_printerr (&quot;:LOG*}\n&quot;);
 915       g_test_log_msg_free (msg);
 916     }
 917 }
 918 
 919 static void
 920 g_test_log (GTestLogType lbit,
 921             const gchar *string1,
 922             const gchar *string2,
 923             guint        n_args,
 924             long double *largs)
 925 {
 926   GTestResult result;
 927   gboolean fail;
 928   GTestLogMsg msg;
 929   gchar *astrings[3] = { NULL, NULL, NULL };
 930   guint8 *dbuffer;
 931   guint32 dbufferlen;
 932 
 933   switch (lbit)
 934     {
 935     case G_TEST_LOG_START_BINARY:
 936       if (test_tap_log)
 937         g_print (&quot;# random seed: %s\n&quot;, string2);
 938       else if (g_test_verbose ())
 939         g_print (&quot;GTest: random seed: %s\n&quot;, string2);
 940       break;
 941     case G_TEST_LOG_START_SUITE:
 942       if (test_tap_log)
 943         {
 944           if (string1[0] != 0)
 945             g_print (&quot;# Start of %s tests\n&quot;, string1);
 946           else
 947             g_print (&quot;1..%d\n&quot;, test_count);
 948         }
 949       break;
 950     case G_TEST_LOG_STOP_SUITE:
 951       if (test_tap_log)
 952         {
 953           if (string1[0] != 0)
 954             g_print (&quot;# End of %s tests\n&quot;, string1);
 955         }
 956       break;
 957     case G_TEST_LOG_STOP_CASE:
 958       result = largs[0];
 959       fail = result == G_TEST_RUN_FAILURE;
 960       if (test_tap_log)
 961         {
 962           const gchar *ok;
 963 
 964           /* The TAP representation for an expected failure starts with
 965            * &quot;not ok&quot;, even though it does not actually count as failing
 966            * due to the use of the TODO directive. &quot;ok # TODO&quot; would mean
 967            * a test that was expected to fail unexpectedly succeeded,
 968            * for which GTestResult does not currently have a
 969            * representation. */
 970           if (fail || result == G_TEST_RUN_INCOMPLETE)
 971             ok = &quot;not ok&quot;;
 972           else
 973             ok = &quot;ok&quot;;
 974 
 975           g_print (&quot;%s %d %s&quot;, ok, test_run_count, string1);
 976           if (result == G_TEST_RUN_INCOMPLETE)
 977             g_print (&quot; # TODO %s\n&quot;, string2 ? string2 : &quot;&quot;);
 978           else if (result == G_TEST_RUN_SKIPPED)
 979             g_print (&quot; # SKIP %s\n&quot;, string2 ? string2 : &quot;&quot;);
 980           else
 981             g_print (&quot;\n&quot;);
 982         }
 983       else if (g_test_verbose ())
 984         g_print (&quot;GTest: result: %s\n&quot;, g_test_result_names[result]);
 985       else if (!g_test_quiet ())
 986         g_print (&quot;%s\n&quot;, g_test_result_names[result]);
 987       if (fail &amp;&amp; test_mode_fatal)
 988         {
 989           if (test_tap_log)
 990             g_print (&quot;Bail out!\n&quot;);
 991           g_abort ();
 992         }
 993       if (result == G_TEST_RUN_SKIPPED || result == G_TEST_RUN_INCOMPLETE)
 994         test_skipped_count++;
 995       break;
 996     case G_TEST_LOG_MIN_RESULT:
 997       if (test_tap_log)
 998         g_print (&quot;# min perf: %s\n&quot;, string1);
 999       else if (g_test_verbose ())
1000         g_print (&quot;(MINPERF:%s)\n&quot;, string1);
1001       break;
1002     case G_TEST_LOG_MAX_RESULT:
1003       if (test_tap_log)
1004         g_print (&quot;# max perf: %s\n&quot;, string1);
1005       else if (g_test_verbose ())
1006         g_print (&quot;(MAXPERF:%s)\n&quot;, string1);
1007       break;
1008     case G_TEST_LOG_MESSAGE:
1009       if (test_tap_log)
1010         g_print (&quot;# %s\n&quot;, string1);
1011       else if (g_test_verbose ())
1012         g_print (&quot;(MSG: %s)\n&quot;, string1);
1013       break;
1014     case G_TEST_LOG_ERROR:
1015       if (test_tap_log)
1016         g_print (&quot;Bail out! %s\n&quot;, string1);
1017       else if (g_test_verbose ())
1018         g_print (&quot;(ERROR: %s)\n&quot;, string1);
1019       break;
1020     default: ;
1021     }
1022 
1023   msg.log_type = lbit;
1024   msg.n_strings = (string1 != NULL) + (string1 &amp;&amp; string2);
1025   msg.strings = astrings;
1026   astrings[0] = (gchar*) string1;
1027   astrings[1] = astrings[0] ? (gchar*) string2 : NULL;
1028   msg.n_nums = n_args;
1029   msg.nums = largs;
1030   dbuffer = g_test_log_dump (&amp;msg, &amp;dbufferlen);
1031   g_test_log_send (dbufferlen, dbuffer);
1032   g_free (dbuffer);
1033 
1034   switch (lbit)
1035     {
1036     case G_TEST_LOG_START_CASE:
1037       if (test_tap_log)
1038         ;
1039       else if (g_test_verbose ())
1040         g_print (&quot;GTest: run: %s\n&quot;, string1);
1041       else if (!g_test_quiet ())
1042         g_print (&quot;%s: &quot;, string1);
1043       break;
1044     default: ;
1045     }
1046 }
1047 
1048 /* We intentionally parse the command line without GOptionContext
1049  * because otherwise you would never be able to test it.
1050  */
1051 static void
1052 parse_args (gint    *argc_p,
1053             gchar ***argv_p)
1054 {
1055   guint argc = *argc_p;
1056   gchar **argv = *argv_p;
1057   guint i, e;
1058 
1059   test_argv0 = argv[0];
1060   test_initial_cwd = g_get_current_dir ();
1061 
1062   /* parse known args */
1063   for (i = 1; i &lt; argc; i++)
1064     {
1065       if (strcmp (argv[i], &quot;--g-fatal-warnings&quot;) == 0)
1066         {
1067           GLogLevelFlags fatal_mask = (GLogLevelFlags) g_log_set_always_fatal ((GLogLevelFlags) G_LOG_FATAL_MASK);
1068           fatal_mask = (GLogLevelFlags) (fatal_mask | G_LOG_LEVEL_WARNING | G_LOG_LEVEL_CRITICAL);
1069           g_log_set_always_fatal (fatal_mask);
1070           argv[i] = NULL;
1071         }
1072       else if (strcmp (argv[i], &quot;--keep-going&quot;) == 0 ||
1073                strcmp (argv[i], &quot;-k&quot;) == 0)
1074         {
1075           test_mode_fatal = FALSE;
1076           argv[i] = NULL;
1077         }
1078       else if (strcmp (argv[i], &quot;--debug-log&quot;) == 0)
1079         {
1080           test_debug_log = TRUE;
1081           argv[i] = NULL;
1082         }
1083       else if (strcmp (argv[i], &quot;--tap&quot;) == 0)
1084         {
1085           test_tap_log = TRUE;
1086           argv[i] = NULL;
1087         }
1088       else if (strcmp (&quot;--GTestLogFD&quot;, argv[i]) == 0 || strncmp (&quot;--GTestLogFD=&quot;, argv[i], 13) == 0)
1089         {
1090           gchar *equal = argv[i] + 12;
1091           if (*equal == &#39;=&#39;)
1092             test_log_fd = g_ascii_strtoull (equal + 1, NULL, 0);
1093           else if (i + 1 &lt; argc)
1094             {
1095               argv[i++] = NULL;
1096               test_log_fd = g_ascii_strtoull (argv[i], NULL, 0);
1097             }
1098           argv[i] = NULL;
1099         }
1100       else if (strcmp (&quot;--GTestSkipCount&quot;, argv[i]) == 0 || strncmp (&quot;--GTestSkipCount=&quot;, argv[i], 17) == 0)
1101         {
1102           gchar *equal = argv[i] + 16;
1103           if (*equal == &#39;=&#39;)
1104             test_startup_skip_count = g_ascii_strtoull (equal + 1, NULL, 0);
1105           else if (i + 1 &lt; argc)
1106             {
1107               argv[i++] = NULL;
1108               test_startup_skip_count = g_ascii_strtoull (argv[i], NULL, 0);
1109             }
1110           argv[i] = NULL;
1111         }
1112       else if (strcmp (&quot;--GTestSubprocess&quot;, argv[i]) == 0)
1113         {
1114           test_in_subprocess = TRUE;
1115           /* We typically expect these child processes to crash, and some
1116            * tests spawn a *lot* of them.  Avoid spamming system crash
1117            * collection programs such as systemd-coredump and abrt.
1118            */
1119 #ifdef HAVE_SYS_RESOURCE_H
1120           {
1121             struct rlimit limit = { 0, 0 };
1122             (void) setrlimit (RLIMIT_CORE, &amp;limit);
1123           }
1124 #endif
1125           argv[i] = NULL;
1126         }
1127       else if (strcmp (&quot;-p&quot;, argv[i]) == 0 || strncmp (&quot;-p=&quot;, argv[i], 3) == 0)
1128         {
1129           gchar *equal = argv[i] + 2;
1130           if (*equal == &#39;=&#39;)
1131             test_paths = g_slist_prepend (test_paths, equal + 1);
1132           else if (i + 1 &lt; argc)
1133             {
1134               argv[i++] = NULL;
1135               test_paths = g_slist_prepend (test_paths, argv[i]);
1136             }
1137           argv[i] = NULL;
1138         }
1139       else if (strcmp (&quot;-s&quot;, argv[i]) == 0 || strncmp (&quot;-s=&quot;, argv[i], 3) == 0)
1140         {
1141           gchar *equal = argv[i] + 2;
1142           if (*equal == &#39;=&#39;)
1143             test_paths_skipped = g_slist_prepend (test_paths_skipped, equal + 1);
1144           else if (i + 1 &lt; argc)
1145             {
1146               argv[i++] = NULL;
1147               test_paths_skipped = g_slist_prepend (test_paths_skipped, argv[i]);
1148             }
1149           argv[i] = NULL;
1150         }
1151       else if (strcmp (&quot;-m&quot;, argv[i]) == 0 || strncmp (&quot;-m=&quot;, argv[i], 3) == 0)
1152         {
1153           gchar *equal = argv[i] + 2;
1154           const gchar *mode = &quot;&quot;;
1155           if (*equal == &#39;=&#39;)
1156             mode = equal + 1;
1157           else if (i + 1 &lt; argc)
1158             {
1159               argv[i++] = NULL;
1160               mode = argv[i];
1161             }
1162           if (strcmp (mode, &quot;perf&quot;) == 0)
1163             mutable_test_config_vars.test_perf = TRUE;
1164           else if (strcmp (mode, &quot;slow&quot;) == 0)
1165             mutable_test_config_vars.test_quick = FALSE;
1166           else if (strcmp (mode, &quot;thorough&quot;) == 0)
1167             mutable_test_config_vars.test_quick = FALSE;
1168           else if (strcmp (mode, &quot;quick&quot;) == 0)
1169             {
1170               mutable_test_config_vars.test_quick = TRUE;
1171               mutable_test_config_vars.test_perf = FALSE;
1172             }
1173           else if (strcmp (mode, &quot;undefined&quot;) == 0)
1174             mutable_test_config_vars.test_undefined = TRUE;
1175           else if (strcmp (mode, &quot;no-undefined&quot;) == 0)
1176             mutable_test_config_vars.test_undefined = FALSE;
1177           else
1178             g_error (&quot;unknown test mode: -m %s&quot;, mode);
1179           argv[i] = NULL;
1180         }
1181       else if (strcmp (&quot;-q&quot;, argv[i]) == 0 || strcmp (&quot;--quiet&quot;, argv[i]) == 0)
1182         {
1183           mutable_test_config_vars.test_quiet = TRUE;
1184           mutable_test_config_vars.test_verbose = FALSE;
1185           argv[i] = NULL;
1186         }
1187       else if (strcmp (&quot;--verbose&quot;, argv[i]) == 0)
1188         {
1189           mutable_test_config_vars.test_quiet = FALSE;
1190           mutable_test_config_vars.test_verbose = TRUE;
1191           argv[i] = NULL;
1192         }
1193       else if (strcmp (&quot;-l&quot;, argv[i]) == 0)
1194         {
1195           test_run_list = TRUE;
1196           argv[i] = NULL;
1197         }
1198       else if (strcmp (&quot;--seed&quot;, argv[i]) == 0 || strncmp (&quot;--seed=&quot;, argv[i], 7) == 0)
1199         {
1200           gchar *equal = argv[i] + 6;
1201           if (*equal == &#39;=&#39;)
1202             test_run_seedstr = equal + 1;
1203           else if (i + 1 &lt; argc)
1204             {
1205               argv[i++] = NULL;
1206               test_run_seedstr = argv[i];
1207             }
1208           argv[i] = NULL;
1209         }
1210       else if (strcmp (&quot;-?&quot;, argv[i]) == 0 ||
1211                strcmp (&quot;-h&quot;, argv[i]) == 0 ||
1212                strcmp (&quot;--help&quot;, argv[i]) == 0)
1213         {
1214           printf (&quot;Usage:\n&quot;
1215                   &quot;  %s [OPTION...]\n\n&quot;
1216                   &quot;Help Options:\n&quot;
1217                   &quot;  -h, --help                     Show help options\n\n&quot;
1218                   &quot;Test Options:\n&quot;
1219                   &quot;  --g-fatal-warnings             Make all warnings fatal\n&quot;
1220                   &quot;  -l                             List test cases available in a test executable\n&quot;
1221                   &quot;  -m {perf|slow|thorough|quick}  Execute tests according to mode\n&quot;
1222                   &quot;  -m {undefined|no-undefined}    Execute tests according to mode\n&quot;
1223                   &quot;  -p TESTPATH                    Only start test cases matching TESTPATH\n&quot;
1224                   &quot;  -s TESTPATH                    Skip all tests matching TESTPATH\n&quot;
1225                   &quot;  --seed=SEEDSTRING              Start tests with random seed SEEDSTRING\n&quot;
1226                   &quot;  --debug-log                    debug test logging output\n&quot;
1227                   &quot;  -q, --quiet                    Run tests quietly\n&quot;
1228                   &quot;  --verbose                      Run tests verbosely\n&quot;,
1229                   argv[0]);
1230           exit (0);
1231         }
1232     }
1233   /* collapse argv */
1234   e = 1;
1235   for (i = 1; i &lt; argc; i++)
1236     if (argv[i])
1237       {
1238         argv[e++] = argv[i];
1239         if (i &gt;= e)
1240           argv[i] = NULL;
1241       }
1242   *argc_p = e;
1243 }
1244 
1245 /**
1246  * g_test_init:
1247  * @argc: Address of the @argc parameter of the main() function.
1248  *        Changed if any arguments were handled.
1249  * @argv: Address of the @argv parameter of main().
1250  *        Any parameters understood by g_test_init() stripped before return.
1251  * @...: %NULL-terminated list of special options. Currently the only
1252  *       defined option is `&quot;no_g_set_prgname&quot;`, which
1253  *       will cause g_test_init() to not call g_set_prgname().
1254  *
1255  * Initialize the GLib testing framework, e.g. by seeding the
1256  * test random number generator, the name for g_get_prgname()
1257  * and parsing test related command line args.
1258  *
1259  * So far, the following arguments are understood:
1260  *
1261  * - `-l`: List test cases available in a test executable.
1262  * - `--seed=SEED`: Provide a random seed to reproduce test
1263  *   runs using random numbers.
1264  * - `--verbose`: Run tests verbosely.
1265  * - `-q`, `--quiet`: Run tests quietly.
1266  * - `-p PATH`: Execute all tests matching the given path.
1267  * - `-s PATH`: Skip all tests matching the given path.
1268  *   This can also be used to force a test to run that would otherwise
1269  *   be skipped (ie, a test whose name contains &quot;/subprocess&quot;).
1270  * - `-m {perf|slow|thorough|quick|undefined|no-undefined}`: Execute tests according to these test modes:
1271  *
1272  *   `perf`: Performance tests, may take long and report results (off by default).
1273  *
1274  *   `slow`, `thorough`: Slow and thorough tests, may take quite long and maximize coverage
1275  *   (off by default).
1276  *
1277  *   `quick`: Quick tests, should run really quickly and give good coverage (the default).
1278  *
1279  *   `undefined`: Tests for undefined behaviour, may provoke programming errors
1280  *   under g_test_trap_subprocess() or g_test_expect_message() to check
1281  *   that appropriate assertions or warnings are given (the default).
1282  *
1283  *   `no-undefined`: Avoid tests for undefined behaviour
1284  *
1285  * - `--debug-log`: Debug test logging output.
1286  *
1287  * Since 2.58, if tests are compiled with `G_DISABLE_ASSERT` defined,
1288  * g_test_init() will print an error and exit. This is to prevent no-op tests
1289  * from being executed, as g_assert() is commonly (erroneously) used in unit
1290  * tests, and is a no-op when compiled with `G_DISABLE_ASSERT`. Ensure your
1291  * tests are compiled without `G_DISABLE_ASSERT` defined.
1292  *
1293  * Since: 2.16
1294  */
1295 void
1296 (g_test_init) (int    *argc,
1297                char ***argv,
1298                ...)
1299 {
1300   static char seedstr[4 + 4 * 8 + 1];
1301   va_list args;
1302   gpointer option;
1303   /* make warnings and criticals fatal for all test programs */
1304   GLogLevelFlags fatal_mask = (GLogLevelFlags) g_log_set_always_fatal ((GLogLevelFlags) G_LOG_FATAL_MASK);
1305 
1306   fatal_mask = (GLogLevelFlags) (fatal_mask | G_LOG_LEVEL_WARNING | G_LOG_LEVEL_CRITICAL);
1307   g_log_set_always_fatal (fatal_mask);
1308   /* check caller args */
1309   g_return_if_fail (argc != NULL);
1310   g_return_if_fail (argv != NULL);
1311   g_return_if_fail (g_test_config_vars-&gt;test_initialized == FALSE);
1312   mutable_test_config_vars.test_initialized = TRUE;
1313 
1314   va_start (args, argv);
1315   while ((option = va_arg (args, char *)))
1316     {
1317       if (g_strcmp0 (option, &quot;no_g_set_prgname&quot;) == 0)
1318         no_g_set_prgname = TRUE;
1319     }
1320   va_end (args);
1321 
1322   /* setup random seed string */
1323   g_snprintf (seedstr, sizeof (seedstr), &quot;R02S%08x%08x%08x%08x&quot;, g_random_int(), g_random_int(), g_random_int(), g_random_int());
1324   test_run_seedstr = seedstr;
1325 
1326   /* parse args, sets up mode, changes seed, etc. */
1327   parse_args (argc, argv);
1328 
1329   if (!g_get_prgname() &amp;&amp; !no_g_set_prgname)
1330     g_set_prgname ((*argv)[0]);
1331 
1332   /* sanity check */
1333   if (test_tap_log)
1334     {
1335       if (test_paths || test_startup_skip_count)
1336         {
1337           /* Not invoking every test (even if SKIPped) breaks the &quot;1..XX&quot; plan */
1338           g_printerr (&quot;%s: -p and --GTestSkipCount options are incompatible with --tap\n&quot;,
1339                       (*argv)[0]);
1340           exit (1);
1341         }
1342     }
1343 
1344   /* verify GRand reliability, needed for reliable seeds */
1345   if (1)
1346     {
1347       GRand *rg = g_rand_new_with_seed (0xc8c49fb6);
1348       guint32 t1 = g_rand_int (rg), t2 = g_rand_int (rg), t3 = g_rand_int (rg), t4 = g_rand_int (rg);
1349       /* g_print (&quot;GRand-current: 0x%x 0x%x 0x%x 0x%x\n&quot;, t1, t2, t3, t4); */
1350       if (t1 != 0xfab39f9b || t2 != 0xb948fb0e || t3 != 0x3d31be26 || t4 != 0x43a19d66)
1351         g_warning (&quot;random numbers are not GRand-2.2 compatible, seeds may be broken (check $G_RANDOM_VERSION)&quot;);
1352       g_rand_free (rg);
1353     }
1354 
1355   /* check rand seed */
1356   test_run_seed (test_run_seedstr);
1357 
1358   /* report program start */
1359   g_log_set_default_handler (gtest_default_log_handler, NULL);
1360   g_test_log (G_TEST_LOG_START_BINARY, g_get_prgname(), test_run_seedstr, 0, NULL);
1361 
1362   test_argv0_dirname = g_path_get_dirname (test_argv0);
1363 
1364   /* Make sure we get the real dirname that the test was run from */
1365   if (g_str_has_suffix (test_argv0_dirname, &quot;/.libs&quot;))
1366     {
1367       gchar *tmp;
1368       tmp = g_path_get_dirname (test_argv0_dirname);
1369       g_free (test_argv0_dirname);
1370       test_argv0_dirname = tmp;
1371     }
1372 
1373   test_disted_files_dir = g_getenv (&quot;G_TEST_SRCDIR&quot;);
1374   if (!test_disted_files_dir)
1375     test_disted_files_dir = test_argv0_dirname;
1376 
1377   test_built_files_dir = g_getenv (&quot;G_TEST_BUILDDIR&quot;);
1378   if (!test_built_files_dir)
1379     test_built_files_dir = test_argv0_dirname;
1380 }
1381 
1382 static void
1383 test_run_seed (const gchar *rseed)
1384 {
1385   guint seed_failed = 0;
1386   if (test_run_rand)
1387     g_rand_free (test_run_rand);
1388   test_run_rand = NULL;
1389   while (strchr (&quot; \t\v\r\n\f&quot;, *rseed))
1390     rseed++;
1391   if (strncmp (rseed, &quot;R02S&quot;, 4) == 0)  /* seed for random generator 02 (GRand-2.2) */
1392     {
1393       const char *s = rseed + 4;
1394       if (strlen (s) &gt;= 32)             /* require 4 * 8 chars */
1395         {
1396           guint32 seedarray[4];
1397           gchar *p, hexbuf[9] = { 0, };
1398           memcpy (hexbuf, s + 0, 8);
1399           seedarray[0] = g_ascii_strtoull (hexbuf, &amp;p, 16);
1400           seed_failed += p != NULL &amp;&amp; *p != 0;
1401           memcpy (hexbuf, s + 8, 8);
1402           seedarray[1] = g_ascii_strtoull (hexbuf, &amp;p, 16);
1403           seed_failed += p != NULL &amp;&amp; *p != 0;
1404           memcpy (hexbuf, s + 16, 8);
1405           seedarray[2] = g_ascii_strtoull (hexbuf, &amp;p, 16);
1406           seed_failed += p != NULL &amp;&amp; *p != 0;
1407           memcpy (hexbuf, s + 24, 8);
1408           seedarray[3] = g_ascii_strtoull (hexbuf, &amp;p, 16);
1409           seed_failed += p != NULL &amp;&amp; *p != 0;
1410           if (!seed_failed)
1411             {
1412               test_run_rand = g_rand_new_with_seed_array (seedarray, 4);
1413               return;
1414             }
1415         }
1416     }
1417   g_error (&quot;Unknown or invalid random seed: %s&quot;, rseed);
1418 }
1419 
1420 /**
1421  * g_test_rand_int:
1422  *
1423  * Get a reproducible random integer number.
1424  *
1425  * The random numbers generated by the g_test_rand_*() family of functions
1426  * change with every new test program start, unless the --seed option is
1427  * given when starting test programs.
1428  *
1429  * For individual test cases however, the random number generator is
1430  * reseeded, to avoid dependencies between tests and to make --seed
1431  * effective for all test cases.
1432  *
1433  * Returns: a random number from the seeded random number generator.
1434  *
1435  * Since: 2.16
1436  */
1437 gint32
1438 g_test_rand_int (void)
1439 {
1440   return g_rand_int (test_run_rand);
1441 }
1442 
1443 /**
1444  * g_test_rand_int_range:
1445  * @begin: the minimum value returned by this function
1446  * @end:   the smallest value not to be returned by this function
1447  *
1448  * Get a reproducible random integer number out of a specified range,
1449  * see g_test_rand_int() for details on test case random numbers.
1450  *
1451  * Returns: a number with @begin &lt;= number &lt; @end.
1452  *
1453  * Since: 2.16
1454  */
1455 gint32
1456 g_test_rand_int_range (gint32          begin,
1457                        gint32          end)
1458 {
1459   return g_rand_int_range (test_run_rand, begin, end);
1460 }
1461 
1462 /**
1463  * g_test_rand_double:
1464  *
1465  * Get a reproducible random floating point number,
1466  * see g_test_rand_int() for details on test case random numbers.
1467  *
1468  * Returns: a random number from the seeded random number generator.
1469  *
1470  * Since: 2.16
1471  */
1472 double
1473 g_test_rand_double (void)
1474 {
1475   return g_rand_double (test_run_rand);
1476 }
1477 
1478 /**
1479  * g_test_rand_double_range:
1480  * @range_start: the minimum value returned by this function
1481  * @range_end: the minimum value not returned by this function
1482  *
1483  * Get a reproducible random floating pointer number out of a specified range,
1484  * see g_test_rand_int() for details on test case random numbers.
1485  *
1486  * Returns: a number with @range_start &lt;= number &lt; @range_end.
1487  *
1488  * Since: 2.16
1489  */
1490 double
1491 g_test_rand_double_range (double          range_start,
1492                           double          range_end)
1493 {
1494   return g_rand_double_range (test_run_rand, range_start, range_end);
1495 }
1496 
1497 /**
1498  * g_test_timer_start:
1499  *
1500  * Start a timing test. Call g_test_timer_elapsed() when the task is supposed
1501  * to be done. Call this function again to restart the timer.
1502  *
1503  * Since: 2.16
1504  */
1505 void
1506 g_test_timer_start (void)
1507 {
1508   if (!test_user_timer)
1509     test_user_timer = g_timer_new();
1510   test_user_stamp = 0;
1511   g_timer_start (test_user_timer);
1512 }
1513 
1514 /**
1515  * g_test_timer_elapsed:
1516  *
1517  * Get the time since the last start of the timer with g_test_timer_start().
1518  *
1519  * Returns: the time since the last start of the timer, as a double
1520  *
1521  * Since: 2.16
1522  */
1523 double
1524 g_test_timer_elapsed (void)
1525 {
1526   test_user_stamp = test_user_timer ? g_timer_elapsed (test_user_timer, NULL) : 0;
1527   return test_user_stamp;
1528 }
1529 
1530 /**
1531  * g_test_timer_last:
1532  *
1533  * Report the last result of g_test_timer_elapsed().
1534  *
1535  * Returns: the last result of g_test_timer_elapsed(), as a double
1536  *
1537  * Since: 2.16
1538  */
1539 double
1540 g_test_timer_last (void)
1541 {
1542   return test_user_stamp;
1543 }
1544 
1545 /**
1546  * g_test_minimized_result:
1547  * @minimized_quantity: the reported value
1548  * @format: the format string of the report message
1549  * @...: arguments to pass to the printf() function
1550  *
1551  * Report the result of a performance or measurement test.
1552  * The test should generally strive to minimize the reported
1553  * quantities (smaller values are better than larger ones),
1554  * this and @minimized_quantity can determine sorting
1555  * order for test result reports.
1556  *
1557  * Since: 2.16
1558  */
1559 void
1560 g_test_minimized_result (double          minimized_quantity,
1561                          const char     *format,
1562                          ...)
1563 {
1564   long double largs = minimized_quantity;
1565   gchar *buffer;
1566   va_list args;
1567 
1568   va_start (args, format);
1569   buffer = g_strdup_vprintf (format, args);
1570   va_end (args);
1571 
1572   g_test_log (G_TEST_LOG_MIN_RESULT, buffer, NULL, 1, &amp;largs);
1573   g_free (buffer);
1574 }
1575 
1576 /**
1577  * g_test_maximized_result:
1578  * @maximized_quantity: the reported value
1579  * @format: the format string of the report message
1580  * @...: arguments to pass to the printf() function
1581  *
1582  * Report the result of a performance or measurement test.
1583  * The test should generally strive to maximize the reported
1584  * quantities (larger values are better than smaller ones),
1585  * this and @maximized_quantity can determine sorting
1586  * order for test result reports.
1587  *
1588  * Since: 2.16
1589  */
1590 void
1591 g_test_maximized_result (double          maximized_quantity,
1592                          const char     *format,
1593                          ...)
1594 {
1595   long double largs = maximized_quantity;
1596   gchar *buffer;
1597   va_list args;
1598 
1599   va_start (args, format);
1600   buffer = g_strdup_vprintf (format, args);
1601   va_end (args);
1602 
1603   g_test_log (G_TEST_LOG_MAX_RESULT, buffer, NULL, 1, &amp;largs);
1604   g_free (buffer);
1605 }
1606 
1607 /**
1608  * g_test_message:
1609  * @format: the format string
1610  * @...:    printf-like arguments to @format
1611  *
1612  * Add a message to the test report.
1613  *
1614  * Since: 2.16
1615  */
1616 void
1617 g_test_message (const char *format,
1618                 ...)
1619 {
1620   gchar *buffer;
1621   va_list args;
1622 
1623   va_start (args, format);
1624   buffer = g_strdup_vprintf (format, args);
1625   va_end (args);
1626 
1627   g_test_log (G_TEST_LOG_MESSAGE, buffer, NULL, 0, NULL);
1628   g_free (buffer);
1629 }
1630 
1631 /**
1632  * g_test_bug_base:
1633  * @uri_pattern: the base pattern for bug URIs
1634  *
1635  * Specify the base URI for bug reports.
1636  *
1637  * The base URI is used to construct bug report messages for
1638  * g_test_message() when g_test_bug() is called.
1639  * Calling this function outside of a test case sets the
1640  * default base URI for all test cases. Calling it from within
1641  * a test case changes the base URI for the scope of the test
1642  * case only.
1643  * Bug URIs are constructed by appending a bug specific URI
1644  * portion to @uri_pattern, or by replacing the special string
1645  * &#39;\%s&#39; within @uri_pattern if that is present.
1646  *
1647  * Since: 2.16
1648  */
1649 void
1650 g_test_bug_base (const char *uri_pattern)
1651 {
1652   g_free (test_uri_base);
1653   test_uri_base = g_strdup (uri_pattern);
1654 }
1655 
1656 /**
1657  * g_test_bug:
1658  * @bug_uri_snippet: Bug specific bug tracker URI portion.
1659  *
1660  * This function adds a message to test reports that
1661  * associates a bug URI with a test case.
1662  * Bug URIs are constructed from a base URI set with g_test_bug_base()
1663  * and @bug_uri_snippet.
1664  *
1665  * Since: 2.16
1666  */
1667 void
1668 g_test_bug (const char *bug_uri_snippet)
1669 {
1670   char *c;
1671 
1672   g_return_if_fail (test_uri_base != NULL);
1673   g_return_if_fail (bug_uri_snippet != NULL);
1674 
1675   c = strstr (test_uri_base, &quot;%s&quot;);
1676   if (c)
1677     {
1678       char *b = g_strndup (test_uri_base, c - test_uri_base);
1679       char *s = g_strconcat (b, bug_uri_snippet, c + 2, NULL);
1680       g_free (b);
1681       g_test_message (&quot;Bug Reference: %s&quot;, s);
1682       g_free (s);
1683     }
1684   else
1685     g_test_message (&quot;Bug Reference: %s%s&quot;, test_uri_base, bug_uri_snippet);
1686 }
1687 
1688 /**
1689  * g_test_get_root:
1690  *
1691  * Get the toplevel test suite for the test path API.
1692  *
1693  * Returns: the toplevel #GTestSuite
1694  *
1695  * Since: 2.16
1696  */
1697 GTestSuite*
1698 g_test_get_root (void)
1699 {
1700   if (!test_suite_root)
1701     {
1702       test_suite_root = g_test_create_suite (&quot;root&quot;);
1703       g_free (test_suite_root-&gt;name);
1704       test_suite_root-&gt;name = g_strdup (&quot;&quot;);
1705     }
1706 
1707   return test_suite_root;
1708 }
1709 
1710 /**
1711  * g_test_run:
1712  *
1713  * Runs all tests under the toplevel suite which can be retrieved
1714  * with g_test_get_root(). Similar to g_test_run_suite(), the test
1715  * cases to be run are filtered according to test path arguments
1716  * (`-p testpath` and `-s testpath`) as parsed by g_test_init().
1717  * g_test_run_suite() or g_test_run() may only be called once in a
1718  * program.
1719  *
1720  * In general, the tests and sub-suites within each suite are run in
1721  * the order in which they are defined. However, note that prior to
1722  * GLib 2.36, there was a bug in the `g_test_add_*`
1723  * functions which caused them to create multiple suites with the same
1724  * name, meaning that if you created tests &quot;/foo/simple&quot;,
1725  * &quot;/bar/simple&quot;, and &quot;/foo/using-bar&quot; in that order, they would get
1726  * run in that order (since g_test_run() would run the first &quot;/foo&quot;
1727  * suite, then the &quot;/bar&quot; suite, then the second &quot;/foo&quot; suite). As of
1728  * 2.36, this bug is fixed, and adding the tests in that order would
1729  * result in a running order of &quot;/foo/simple&quot;, &quot;/foo/using-bar&quot;,
1730  * &quot;/bar/simple&quot;. If this new ordering is sub-optimal (because it puts
1731  * more-complicated tests before simpler ones, making it harder to
1732  * figure out exactly what has failed), you can fix it by changing the
1733  * test paths to group tests by suite in a way that will result in the
1734  * desired running order. Eg, &quot;/simple/foo&quot;, &quot;/simple/bar&quot;,
1735  * &quot;/complex/foo-using-bar&quot;.
1736  *
1737  * However, you should never make the actual result of a test depend
1738  * on the order that tests are run in. If you need to ensure that some
1739  * particular code runs before or after a given test case, use
1740  * g_test_add(), which lets you specify setup and teardown functions.
1741  *
1742  * If all tests are skipped or marked as incomplete (expected failures),
1743  * this function will return 0 if producing TAP output, or 77 (treated
1744  * as &quot;skip test&quot; by Automake) otherwise.
1745  *
1746  * Returns: 0 on success, 1 on failure (assuming it returns at all),
1747  *   0 or 77 if all tests were skipped with g_test_skip() and/or
1748  *   g_test_incomplete()
1749  *
1750  * Since: 2.16
1751  */
1752 int
1753 g_test_run (void)
1754 {
1755   if (g_test_run_suite (g_test_get_root()) != 0)
1756     return 1;
1757 
1758   /* 77 is special to Automake&#39;s default driver, but not Automake&#39;s TAP driver
1759    * or Perl&#39;s prove(1) TAP driver. */
1760   if (test_tap_log)
1761     return 0;
1762 
1763   if (test_run_count &gt; 0 &amp;&amp; test_run_count == test_skipped_count)
1764     return 77;
1765   else
1766     return 0;
1767 }
1768 
1769 /**
1770  * g_test_create_case:
1771  * @test_name:     the name for the test case
1772  * @data_size:     the size of the fixture data structure
1773  * @test_data:     test data argument for the test functions
1774  * @data_setup:    (scope async): the function to set up the fixture data
1775  * @data_test:     (scope async): the actual test function
1776  * @data_teardown: (scope async): the function to teardown the fixture data
1777  *
1778  * Create a new #GTestCase, named @test_name, this API is fairly
1779  * low level, calling g_test_add() or g_test_add_func() is preferable.
1780  * When this test is executed, a fixture structure of size @data_size
1781  * will be automatically allocated and filled with zeros. Then @data_setup is
1782  * called to initialize the fixture. After fixture setup, the actual test
1783  * function @data_test is called. Once the test run completes, the
1784  * fixture structure is torn down by calling @data_teardown and
1785  * after that the memory is automatically released by the test framework.
1786  *
1787  * Splitting up a test run into fixture setup, test function and
1788  * fixture teardown is most useful if the same fixture is used for
1789  * multiple tests. In this cases, g_test_create_case() will be
1790  * called with the same fixture, but varying @test_name and
1791  * @data_test arguments.
1792  *
1793  * Returns: a newly allocated #GTestCase.
1794  *
1795  * Since: 2.16
1796  */
1797 GTestCase*
1798 g_test_create_case (const char       *test_name,
1799                     gsize             data_size,
1800                     gconstpointer     test_data,
1801                     GTestFixtureFunc  data_setup,
1802                     GTestFixtureFunc  data_test,
1803                     GTestFixtureFunc  data_teardown)
1804 {
1805   GTestCase *tc;
1806 
1807   g_return_val_if_fail (test_name != NULL, NULL);
1808   g_return_val_if_fail (strchr (test_name, &#39;/&#39;) == NULL, NULL);
1809   g_return_val_if_fail (test_name[0] != 0, NULL);
1810   g_return_val_if_fail (data_test != NULL, NULL);
1811 
1812   tc = g_slice_new0 (GTestCase);
1813   tc-&gt;name = g_strdup (test_name);
1814   tc-&gt;test_data = (gpointer) test_data;
1815   tc-&gt;fixture_size = data_size;
1816   tc-&gt;fixture_setup = (void*) data_setup;
1817   tc-&gt;fixture_test = (void*) data_test;
1818   tc-&gt;fixture_teardown = (void*) data_teardown;
1819 
1820   return tc;
1821 }
1822 
1823 static gint
1824 find_suite (gconstpointer l, gconstpointer s)
1825 {
1826   const GTestSuite *suite = l;
1827   const gchar *str = s;
1828 
1829   return strcmp (suite-&gt;name, str);
1830 }
1831 
1832 static gint
1833 find_case (gconstpointer l, gconstpointer s)
1834 {
1835   const GTestCase *tc = l;
1836   const gchar *str = s;
1837 
1838   return strcmp (tc-&gt;name, str);
1839 }
1840 
1841 /**
1842  * GTestFixtureFunc:
1843  * @fixture: (not nullable): the test fixture
1844  * @user_data: the data provided when registering the test
1845  *
1846  * The type used for functions that operate on test fixtures.  This is
1847  * used for the fixture setup and teardown functions as well as for the
1848  * testcases themselves.
1849  *
1850  * @user_data is a pointer to the data that was given when registering
1851  * the test case.
1852  *
1853  * @fixture will be a pointer to the area of memory allocated by the
1854  * test framework, of the size requested.  If the requested size was
1855  * zero then @fixture will be equal to @user_data.
1856  *
1857  * Since: 2.28
1858  */
1859 void
1860 g_test_add_vtable (const char       *testpath,
1861                    gsize             data_size,
1862                    gconstpointer     test_data,
1863                    GTestFixtureFunc  data_setup,
1864                    GTestFixtureFunc  fixture_test_func,
1865                    GTestFixtureFunc  data_teardown)
1866 {
1867   gchar **segments;
1868   guint ui;
1869   GTestSuite *suite;
1870 
1871   g_return_if_fail (testpath != NULL);
1872   g_return_if_fail (g_path_is_absolute (testpath));
1873   g_return_if_fail (fixture_test_func != NULL);
1874 
1875   suite = g_test_get_root();
1876   segments = g_strsplit (testpath, &quot;/&quot;, -1);
1877   for (ui = 0; segments[ui] != NULL; ui++)
1878     {
1879       const char *seg = segments[ui];
1880       gboolean islast = segments[ui + 1] == NULL;
1881       if (islast &amp;&amp; !seg[0])
1882         g_error (&quot;invalid test case path: %s&quot;, testpath);
1883       else if (!seg[0])
1884         continue;       /* initial or duplicate slash */
1885       else if (!islast)
1886         {
1887           GSList *l;
1888           GTestSuite *csuite;
1889           l = g_slist_find_custom (suite-&gt;suites, seg, find_suite);
1890           if (l)
1891             {
1892               csuite = l-&gt;data;
1893             }
1894           else
1895             {
1896               csuite = g_test_create_suite (seg);
1897               g_test_suite_add_suite (suite, csuite);
1898             }
1899           suite = csuite;
1900         }
1901       else /* islast */
1902         {
1903           GTestCase *tc;
1904 
1905           if (g_slist_find_custom (suite-&gt;cases, seg, find_case))
1906             g_error (&quot;duplicate test case path: %s&quot;, testpath);
1907 
1908           tc = g_test_create_case (seg, data_size, test_data, data_setup, fixture_test_func, data_teardown);
1909           g_test_suite_add (suite, tc);
1910         }
1911     }
1912   g_strfreev (segments);
1913 }
1914 
1915 /**
1916  * g_test_fail:
1917  *
1918  * Indicates that a test failed. This function can be called
1919  * multiple times from the same test. You can use this function
1920  * if your test failed in a recoverable way.
1921  *
1922  * Do not use this function if the failure of a test could cause
1923  * other tests to malfunction.
1924  *
1925  * Calling this function will not stop the test from running, you
1926  * need to return from the test function yourself. So you can
1927  * produce additional diagnostic messages or even continue running
1928  * the test.
1929  *
1930  * If not called from inside a test, this function does nothing.
1931  *
1932  * Since: 2.30
1933  **/
1934 void
1935 g_test_fail (void)
1936 {
1937   test_run_success = G_TEST_RUN_FAILURE;
1938 }
1939 
1940 /**
1941  * g_test_incomplete:
1942  * @msg: (nullable): explanation
1943  *
1944  * Indicates that a test failed because of some incomplete
1945  * functionality. This function can be called multiple times
1946  * from the same test.
1947  *
1948  * Calling this function will not stop the test from running, you
1949  * need to return from the test function yourself. So you can
1950  * produce additional diagnostic messages or even continue running
1951  * the test.
1952  *
1953  * If not called from inside a test, this function does nothing.
1954  *
1955  * Since: 2.38
1956  */
1957 void
1958 g_test_incomplete (const gchar *msg)
1959 {
1960   test_run_success = G_TEST_RUN_INCOMPLETE;
1961   g_free (test_run_msg);
1962   test_run_msg = g_strdup (msg);
1963 }
1964 
1965 /**
1966  * g_test_skip:
1967  * @msg: (nullable): explanation
1968  *
1969  * Indicates that a test was skipped.
1970  *
1971  * Calling this function will not stop the test from running, you
1972  * need to return from the test function yourself. So you can
1973  * produce additional diagnostic messages or even continue running
1974  * the test.
1975  *
1976  * If not called from inside a test, this function does nothing.
1977  *
1978  * Since: 2.38
1979  */
1980 void
1981 g_test_skip (const gchar *msg)
1982 {
1983   test_run_success = G_TEST_RUN_SKIPPED;
1984   g_free (test_run_msg);
1985   test_run_msg = g_strdup (msg);
1986 }
1987 
1988 /**
1989  * g_test_failed:
1990  *
1991  * Returns whether a test has already failed. This will
1992  * be the case when g_test_fail(), g_test_incomplete()
1993  * or g_test_skip() have been called, but also if an
1994  * assertion has failed.
1995  *
1996  * This can be useful to return early from a test if
1997  * continuing after a failed assertion might be harmful.
1998  *
1999  * The return value of this function is only meaningful
2000  * if it is called from inside a test function.
2001  *
2002  * Returns: %TRUE if the test has failed
2003  *
2004  * Since: 2.38
2005  */
2006 gboolean
2007 g_test_failed (void)
2008 {
2009   return test_run_success != G_TEST_RUN_SUCCESS;
2010 }
2011 
2012 /**
2013  * g_test_set_nonfatal_assertions:
2014  *
2015  * Changes the behaviour of g_assert_cmpstr(), g_assert_cmpint(),
2016  * g_assert_cmpuint(), g_assert_cmphex(), g_assert_cmpfloat(),
2017  * g_assert_true(), g_assert_false(), g_assert_null(), g_assert_no_error(),
2018  * g_assert_error(), g_test_assert_expected_messages() and the various
2019  * g_test_trap_assert_*() macros to not abort to program, but instead
2020  * call g_test_fail() and continue. (This also changes the behavior of
2021  * g_test_fail() so that it will not cause the test program to abort
2022  * after completing the failed test.)
2023  *
2024  * Note that the g_assert_not_reached() and g_assert() are not
2025  * affected by this.
2026  *
2027  * This function can only be called after g_test_init().
2028  *
2029  * Since: 2.38
2030  */
2031 void
2032 g_test_set_nonfatal_assertions (void)
2033 {
2034   if (!g_test_config_vars-&gt;test_initialized)
2035     g_error (&quot;g_test_set_nonfatal_assertions called without g_test_init&quot;);
2036   test_nonfatal_assertions = TRUE;
2037   test_mode_fatal = FALSE;
2038 }
2039 
2040 /**
2041  * GTestFunc:
2042  *
2043  * The type used for test case functions.
2044  *
2045  * Since: 2.28
2046  */
2047 
2048 /**
2049  * g_test_add_func:
2050  * @testpath:  /-separated test case path name for the test.
2051  * @test_func: (scope async):  The test function to invoke for this test.
2052  *
2053  * Create a new test case, similar to g_test_create_case(). However
2054  * the test is assumed to use no fixture, and test suites are automatically
2055  * created on the fly and added to the root fixture, based on the
2056  * slash-separated portions of @testpath.
2057  *
2058  * If @testpath includes the component &quot;subprocess&quot; anywhere in it,
2059  * the test will be skipped by default, and only run if explicitly
2060  * required via the `-p` command-line option or g_test_trap_subprocess().
2061  *
2062  * Since: 2.16
2063  */
2064 void
2065 g_test_add_func (const char *testpath,
2066                  GTestFunc   test_func)
2067 {
2068   g_return_if_fail (testpath != NULL);
2069   g_return_if_fail (testpath[0] == &#39;/&#39;);
2070   g_return_if_fail (test_func != NULL);
2071   g_test_add_vtable (testpath, 0, NULL, NULL, (GTestFixtureFunc) test_func, NULL);
2072 }
2073 
2074 /**
2075  * GTestDataFunc:
2076  * @user_data: the data provided when registering the test
2077  *
2078  * The type used for test case functions that take an extra pointer
2079  * argument.
2080  *
2081  * Since: 2.28
2082  */
2083 
2084 /**
2085  * g_test_add_data_func:
2086  * @testpath:  /-separated test case path name for the test.
2087  * @test_data: Test data argument for the test function.
2088  * @test_func: (scope async): The test function to invoke for this test.
2089  *
2090  * Create a new test case, similar to g_test_create_case(). However
2091  * the test is assumed to use no fixture, and test suites are automatically
2092  * created on the fly and added to the root fixture, based on the
2093  * slash-separated portions of @testpath. The @test_data argument
2094  * will be passed as first argument to @test_func.
2095  *
2096  * If @testpath includes the component &quot;subprocess&quot; anywhere in it,
2097  * the test will be skipped by default, and only run if explicitly
2098  * required via the `-p` command-line option or g_test_trap_subprocess().
2099  *
2100  * Since: 2.16
2101  */
2102 void
2103 g_test_add_data_func (const char     *testpath,
2104                       gconstpointer   test_data,
2105                       GTestDataFunc   test_func)
2106 {
2107   g_return_if_fail (testpath != NULL);
2108   g_return_if_fail (testpath[0] == &#39;/&#39;);
2109   g_return_if_fail (test_func != NULL);
2110 
2111   g_test_add_vtable (testpath, 0, test_data, NULL, (GTestFixtureFunc) test_func, NULL);
2112 }
2113 
2114 /**
2115  * g_test_add_data_func_full:
2116  * @testpath: /-separated test case path name for the test.
2117  * @test_data: Test data argument for the test function.
2118  * @test_func: The test function to invoke for this test.
2119  * @data_free_func: #GDestroyNotify for @test_data.
2120  *
2121  * Create a new test case, as with g_test_add_data_func(), but freeing
2122  * @test_data after the test run is complete.
2123  *
2124  * Since: 2.34
2125  */
2126 void
2127 g_test_add_data_func_full (const char     *testpath,
2128                            gpointer        test_data,
2129                            GTestDataFunc   test_func,
2130                            GDestroyNotify  data_free_func)
2131 {
2132   g_return_if_fail (testpath != NULL);
2133   g_return_if_fail (testpath[0] == &#39;/&#39;);
2134   g_return_if_fail (test_func != NULL);
2135 
2136   g_test_add_vtable (testpath, 0, test_data, NULL,
2137                      (GTestFixtureFunc) test_func,
2138                      (GTestFixtureFunc) data_free_func);
2139 }
2140 
2141 static gboolean
2142 g_test_suite_case_exists (GTestSuite *suite,
2143                           const char *test_path)
2144 {
2145   GSList *iter;
2146   char *slash;
2147   GTestCase *tc;
2148 
2149   test_path++;
2150   slash = strchr (test_path, &#39;/&#39;);
2151 
2152   if (slash)
2153     {
2154       for (iter = suite-&gt;suites; iter; iter = iter-&gt;next)
2155         {
2156           GTestSuite *child_suite = iter-&gt;data;
2157 
2158           if (!strncmp (child_suite-&gt;name, test_path, slash - test_path))
2159             if (g_test_suite_case_exists (child_suite, slash))
2160               return TRUE;
2161         }
2162     }
2163   else
2164     {
2165       for (iter = suite-&gt;cases; iter; iter = iter-&gt;next)
2166         {
2167           tc = iter-&gt;data;
2168           if (!strcmp (tc-&gt;name, test_path))
2169             return TRUE;
2170         }
2171     }
2172 
2173   return FALSE;
2174 }
2175 
2176 /**
2177  * g_test_create_suite:
2178  * @suite_name: a name for the suite
2179  *
2180  * Create a new test suite with the name @suite_name.
2181  *
2182  * Returns: A newly allocated #GTestSuite instance.
2183  *
2184  * Since: 2.16
2185  */
2186 GTestSuite*
2187 g_test_create_suite (const char *suite_name)
2188 {
2189   GTestSuite *ts;
2190   g_return_val_if_fail (suite_name != NULL, NULL);
2191   g_return_val_if_fail (strchr (suite_name, &#39;/&#39;) == NULL, NULL);
2192   g_return_val_if_fail (suite_name[0] != 0, NULL);
2193   ts = g_slice_new0 (GTestSuite);
2194   ts-&gt;name = g_strdup (suite_name);
2195   return ts;
2196 }
2197 
2198 /**
2199  * g_test_suite_add:
2200  * @suite: a #GTestSuite
2201  * @test_case: a #GTestCase
2202  *
2203  * Adds @test_case to @suite.
2204  *
2205  * Since: 2.16
2206  */
2207 void
2208 g_test_suite_add (GTestSuite     *suite,
2209                   GTestCase      *test_case)
2210 {
2211   g_return_if_fail (suite != NULL);
2212   g_return_if_fail (test_case != NULL);
2213 
2214   suite-&gt;cases = g_slist_append (suite-&gt;cases, test_case);
2215 }
2216 
2217 /**
2218  * g_test_suite_add_suite:
2219  * @suite:       a #GTestSuite
2220  * @nestedsuite: another #GTestSuite
2221  *
2222  * Adds @nestedsuite to @suite.
2223  *
2224  * Since: 2.16
2225  */
2226 void
2227 g_test_suite_add_suite (GTestSuite     *suite,
2228                         GTestSuite     *nestedsuite)
2229 {
2230   g_return_if_fail (suite != NULL);
2231   g_return_if_fail (nestedsuite != NULL);
2232 
2233   suite-&gt;suites = g_slist_append (suite-&gt;suites, nestedsuite);
2234 }
2235 
2236 /**
2237  * g_test_queue_free:
2238  * @gfree_pointer: the pointer to be stored.
2239  *
2240  * Enqueue a pointer to be released with g_free() during the next
2241  * teardown phase. This is equivalent to calling g_test_queue_destroy()
2242  * with a destroy callback of g_free().
2243  *
2244  * Since: 2.16
2245  */
2246 void
2247 g_test_queue_free (gpointer gfree_pointer)
2248 {
2249   if (gfree_pointer)
2250     g_test_queue_destroy (g_free, gfree_pointer);
2251 }
2252 
2253 /**
2254  * g_test_queue_destroy:
2255  * @destroy_func:       Destroy callback for teardown phase.
2256  * @destroy_data:       Destroy callback data.
2257  *
2258  * This function enqueus a callback @destroy_func to be executed
2259  * during the next test case teardown phase. This is most useful
2260  * to auto destruct allocated test resources at the end of a test run.
2261  * Resources are released in reverse queue order, that means enqueueing
2262  * callback A before callback B will cause B() to be called before
2263  * A() during teardown.
2264  *
2265  * Since: 2.16
2266  */
2267 void
2268 g_test_queue_destroy (GDestroyNotify destroy_func,
2269                       gpointer       destroy_data)
2270 {
2271   DestroyEntry *dentry;
2272 
2273   g_return_if_fail (destroy_func != NULL);
2274 
2275   dentry = g_slice_new0 (DestroyEntry);
2276   dentry-&gt;destroy_func = destroy_func;
2277   dentry-&gt;destroy_data = destroy_data;
2278   dentry-&gt;next = test_destroy_queue;
2279   test_destroy_queue = dentry;
2280 }
2281 
2282 static gboolean
2283 test_case_run (GTestCase *tc)
2284 {
2285   gchar *old_base = g_strdup (test_uri_base);
2286   GSList **old_free_list, *filename_free_list = NULL;
2287   gboolean success = G_TEST_RUN_SUCCESS;
2288 
2289   old_free_list = test_filename_free_list;
2290   test_filename_free_list = &amp;filename_free_list;
2291 
2292   if (++test_run_count &lt;= test_startup_skip_count)
2293     g_test_log (G_TEST_LOG_SKIP_CASE, test_run_name, NULL, 0, NULL);
2294   else if (test_run_list)
2295     {
2296       g_print (&quot;%s\n&quot;, test_run_name);
2297       g_test_log (G_TEST_LOG_LIST_CASE, test_run_name, NULL, 0, NULL);
2298     }
2299   else
2300     {
2301       GTimer *test_run_timer = g_timer_new();
2302       long double largs[3];
2303       void *fixture;
2304       g_test_log (G_TEST_LOG_START_CASE, test_run_name, NULL, 0, NULL);
2305       test_run_forks = 0;
2306       test_run_success = G_TEST_RUN_SUCCESS;
2307       g_clear_pointer (&amp;test_run_msg, g_free);
2308       g_test_log_set_fatal_handler (NULL, NULL);
2309       if (test_paths_skipped &amp;&amp; g_slist_find_custom (test_paths_skipped, test_run_name, (GCompareFunc)g_strcmp0))
2310         g_test_skip (&quot;by request (-s option)&quot;);
2311       else
2312         {
2313           g_timer_start (test_run_timer);
2314           fixture = tc-&gt;fixture_size ? g_malloc0 (tc-&gt;fixture_size) : tc-&gt;test_data;
2315           test_run_seed (test_run_seedstr);
2316           if (tc-&gt;fixture_setup)
2317             tc-&gt;fixture_setup (fixture, tc-&gt;test_data);
2318           tc-&gt;fixture_test (fixture, tc-&gt;test_data);
2319           test_trap_clear();
2320           while (test_destroy_queue)
2321             {
2322               DestroyEntry *dentry = test_destroy_queue;
2323               test_destroy_queue = dentry-&gt;next;
2324               dentry-&gt;destroy_func (dentry-&gt;destroy_data);
2325               g_slice_free (DestroyEntry, dentry);
2326             }
2327           if (tc-&gt;fixture_teardown)
2328             tc-&gt;fixture_teardown (fixture, tc-&gt;test_data);
2329           if (tc-&gt;fixture_size)
2330             g_free (fixture);
2331           g_timer_stop (test_run_timer);
2332         }
2333       success = test_run_success;
2334       test_run_success = G_TEST_RUN_FAILURE;
2335       largs[0] = success; /* OK */
2336       largs[1] = test_run_forks;
2337       largs[2] = g_timer_elapsed (test_run_timer, NULL);
2338       g_test_log (G_TEST_LOG_STOP_CASE, test_run_name, test_run_msg, G_N_ELEMENTS (largs), largs);
2339       g_clear_pointer (&amp;test_run_msg, g_free);
2340       g_timer_destroy (test_run_timer);
2341     }
2342 
2343   g_slist_free_full (filename_free_list, g_free);
2344   test_filename_free_list = old_free_list;
2345   g_free (test_uri_base);
2346   test_uri_base = old_base;
2347 
2348   return (success == G_TEST_RUN_SUCCESS ||
2349           success == G_TEST_RUN_SKIPPED ||
2350           success == G_TEST_RUN_INCOMPLETE);
2351 }
2352 
2353 static gboolean
2354 path_has_prefix (const char *path,
2355                  const char *prefix)
2356 {
2357   int prefix_len = strlen (prefix);
2358 
2359   return (strncmp (path, prefix, prefix_len) == 0 &amp;&amp;
2360           (path[prefix_len] == &#39;\0&#39; ||
2361            path[prefix_len] == &#39;/&#39;));
2362 }
2363 
2364 static gboolean
2365 test_should_run (const char *test_path,
2366                  const char *cmp_path)
2367 {
2368   if (strstr (test_run_name, &quot;/subprocess&quot;))
2369     {
2370       if (g_strcmp0 (test_path, cmp_path) == 0)
2371         return TRUE;
2372 
2373       if (g_test_verbose ())
2374         g_print (&quot;GTest: skipping: %s\n&quot;, test_run_name);
2375       return FALSE;
2376     }
2377 
2378   return !cmp_path || path_has_prefix (test_path, cmp_path);
2379 }
2380 
2381 /* Recurse through @suite, running tests matching @path (or all tests
2382  * if @path is %NULL).
2383  */
2384 static int
2385 g_test_run_suite_internal (GTestSuite *suite,
2386                            const char *path)
2387 {
2388   guint n_bad = 0;
2389   gchar *old_name = test_run_name;
2390   GSList *iter;
2391 
2392   g_return_val_if_fail (suite != NULL, -1);
2393 
2394   g_test_log (G_TEST_LOG_START_SUITE, suite-&gt;name, NULL, 0, NULL);
2395 
2396   for (iter = suite-&gt;cases; iter; iter = iter-&gt;next)
2397     {
2398       GTestCase *tc = iter-&gt;data;
2399 
2400       test_run_name = g_build_path (&quot;/&quot;, old_name, tc-&gt;name, NULL);
2401       if (test_should_run (test_run_name, path))
2402         {
2403           if (!test_case_run (tc))
2404             n_bad++;
2405         }
2406       g_free (test_run_name);
2407     }
2408 
2409   for (iter = suite-&gt;suites; iter; iter = iter-&gt;next)
2410     {
2411       GTestSuite *ts = iter-&gt;data;
2412 
2413       test_run_name = g_build_path (&quot;/&quot;, old_name, ts-&gt;name, NULL);
2414       if (!path || path_has_prefix (path, test_run_name))
2415         n_bad += g_test_run_suite_internal (ts, path);
2416       g_free (test_run_name);
2417     }
2418 
2419   test_run_name = old_name;
2420 
2421   g_test_log (G_TEST_LOG_STOP_SUITE, suite-&gt;name, NULL, 0, NULL);
2422 
2423   return n_bad;
2424 }
2425 
2426 static int
2427 g_test_suite_count (GTestSuite *suite)
2428 {
2429   int n = 0;
2430   GSList *iter;
2431 
2432   g_return_val_if_fail (suite != NULL, -1);
2433 
2434   for (iter = suite-&gt;cases; iter; iter = iter-&gt;next)
2435     {
2436       GTestCase *tc = iter-&gt;data;
2437 
2438       if (strcmp (tc-&gt;name, &quot;subprocess&quot;) != 0)
2439         n++;
2440     }
2441 
2442   for (iter = suite-&gt;suites; iter; iter = iter-&gt;next)
2443     {
2444       GTestSuite *ts = iter-&gt;data;
2445 
2446       if (strcmp (ts-&gt;name, &quot;subprocess&quot;) != 0)
2447         n += g_test_suite_count (ts);
2448     }
2449 
2450   return n;
2451 }
2452 
2453 /**
2454  * g_test_run_suite:
2455  * @suite: a #GTestSuite
2456  *
2457  * Execute the tests within @suite and all nested #GTestSuites.
2458  * The test suites to be executed are filtered according to
2459  * test path arguments (`-p testpath` and `-s testpath`) as parsed by
2460  * g_test_init(). See the g_test_run() documentation for more
2461  * information on the order that tests are run in.
2462  *
2463  * g_test_run_suite() or g_test_run() may only be called once
2464  * in a program.
2465  *
2466  * Returns: 0 on success
2467  *
2468  * Since: 2.16
2469  */
2470 int
2471 g_test_run_suite (GTestSuite *suite)
2472 {
2473   int n_bad = 0;
2474 
2475   g_return_val_if_fail (g_test_run_once == TRUE, -1);
2476 
2477   g_test_run_once = FALSE;
2478   test_count = g_test_suite_count (suite);
2479 
2480   test_run_name = g_strdup_printf (&quot;/%s&quot;, suite-&gt;name);
2481 
2482   if (test_paths)
2483     {
2484       GSList *iter;
2485 
2486       for (iter = test_paths; iter; iter = iter-&gt;next)
2487         n_bad += g_test_run_suite_internal (suite, iter-&gt;data);
2488     }
2489   else
2490     n_bad = g_test_run_suite_internal (suite, NULL);
2491 
2492   g_free (test_run_name);
2493   test_run_name = NULL;
2494 
2495   return n_bad;
2496 }
2497 
2498 static void
2499 gtest_default_log_handler (const gchar    *log_domain,
2500                            GLogLevelFlags  log_level,
2501                            const gchar    *message,
2502                            gpointer        unused_data)
2503 {
2504   const gchar *strv[16];
2505   gboolean fatal = FALSE;
2506   gchar *msg;
2507   guint i = 0;
2508 
2509   if (log_domain)
2510     {
2511       strv[i++] = log_domain;
2512       strv[i++] = &quot;-&quot;;
2513     }
2514   if (log_level &amp; G_LOG_FLAG_FATAL)
2515     {
2516       strv[i++] = &quot;FATAL-&quot;;
2517       fatal = TRUE;
2518     }
2519   if (log_level &amp; G_LOG_FLAG_RECURSION)
2520     strv[i++] = &quot;RECURSIVE-&quot;;
2521   if (log_level &amp; G_LOG_LEVEL_ERROR)
2522     strv[i++] = &quot;ERROR&quot;;
2523   if (log_level &amp; G_LOG_LEVEL_CRITICAL)
2524     strv[i++] = &quot;CRITICAL&quot;;
2525   if (log_level &amp; G_LOG_LEVEL_WARNING)
2526     strv[i++] = &quot;WARNING&quot;;
2527   if (log_level &amp; G_LOG_LEVEL_MESSAGE)
2528     strv[i++] = &quot;MESSAGE&quot;;
2529   if (log_level &amp; G_LOG_LEVEL_INFO)
2530     strv[i++] = &quot;INFO&quot;;
2531   if (log_level &amp; G_LOG_LEVEL_DEBUG)
2532     strv[i++] = &quot;DEBUG&quot;;
2533   strv[i++] = &quot;: &quot;;
2534   strv[i++] = message;
2535   strv[i++] = NULL;
2536 
2537   msg = g_strjoinv (&quot;&quot;, (gchar**) strv);
2538   g_test_log (fatal ? G_TEST_LOG_ERROR : G_TEST_LOG_MESSAGE, msg, NULL, 0, NULL);
2539   g_log_default_handler (log_domain, log_level, message, unused_data);
2540 
2541   g_free (msg);
2542 }
2543 
2544 void
2545 g_assertion_message (const char     *domain,
2546                      const char     *file,
2547                      int             line,
2548                      const char     *func,
2549                      const char     *message)
2550 {
2551   char lstr[32];
2552   char *s;
2553 
2554   if (!message)
2555     message = &quot;code should not be reached&quot;;
2556   g_snprintf (lstr, 32, &quot;%d&quot;, line);
2557   s = g_strconcat (domain ? domain : &quot;&quot;, domain &amp;&amp; domain[0] ? &quot;:&quot; : &quot;&quot;,
2558                    &quot;ERROR:&quot;, file, &quot;:&quot;, lstr, &quot;:&quot;,
2559                    func, func[0] ? &quot;:&quot; : &quot;&quot;,
2560                    &quot; &quot;, message, NULL);
2561   g_printerr (&quot;**\n%s\n&quot;, s);
2562 
2563   /* Don&#39;t print a fatal error indication if assertions are non-fatal, or
2564    * if we are a child process that might be sharing the parent&#39;s stdout. */
2565   if (test_nonfatal_assertions || test_in_subprocess || test_in_forked_child)
2566     g_test_log (G_TEST_LOG_MESSAGE, s, NULL, 0, NULL);
2567   else
2568     g_test_log (G_TEST_LOG_ERROR, s, NULL, 0, NULL);
2569 
2570   if (test_nonfatal_assertions)
2571     {
2572       g_free (s);
2573       g_test_fail ();
2574       return;
2575     }
2576 
2577   /* store assertion message in global variable, so that it can be found in a
2578    * core dump */
2579   if (__glib_assert_msg != NULL)
2580     /* free the old one */
2581     free (__glib_assert_msg);
2582   __glib_assert_msg = (char*) malloc (strlen (s) + 1);
2583   strcpy (__glib_assert_msg, s);
2584 
2585   g_free (s);
2586 
2587   if (test_in_subprocess)
2588     {
2589       /* If this is a test case subprocess then it probably hit this
2590        * assertion on purpose, so just exit() rather than abort()ing,
2591        * to avoid triggering any system crash-reporting daemon.
2592        */
2593       _exit (1);
2594     }
2595   else
2596     g_abort ();
2597 }
2598 
2599 /**
2600  * g_assertion_message_expr: (skip)
2601  * @domain: (nullable):
2602  * @file:
2603  * @line:
2604  * @func:
2605  * @expr: (nullable):
2606  */
2607 void
2608 g_assertion_message_expr (const char     *domain,
2609                           const char     *file,
2610                           int             line,
2611                           const char     *func,
2612                           const char     *expr)
2613 {
2614   char *s;
2615   if (!expr)
2616     s = g_strdup (&quot;code should not be reached&quot;);
2617   else
2618     s = g_strconcat (&quot;assertion failed: (&quot;, expr, &quot;)&quot;, NULL);
2619   g_assertion_message (domain, file, line, func, s);
2620   g_free (s);
2621 
2622   /* Normally g_assertion_message() won&#39;t return, but we need this for
2623    * when test_nonfatal_assertions is set, since
2624    * g_assertion_message_expr() is used for always-fatal assertions.
2625    */
2626   if (test_in_subprocess)
2627     _exit (1);
2628   else
2629     g_abort ();
2630 }
2631 
2632 void
2633 g_assertion_message_cmpnum (const char     *domain,
2634                             const char     *file,
2635                             int             line,
2636                             const char     *func,
2637                             const char     *expr,
2638                             long double     arg1,
2639                             const char     *cmp,
2640                             long double     arg2,
2641                             char            numtype)
2642 {
2643   char *s = NULL;
2644 
2645   switch (numtype)
2646     {
2647     case &#39;i&#39;:   s = g_strdup_printf (&quot;assertion failed (%s): (%&quot; G_GINT64_MODIFIER &quot;i %s %&quot; G_GINT64_MODIFIER &quot;i)&quot;, expr, (gint64) arg1, cmp, (gint64) arg2); break;
2648     case &#39;x&#39;:   s = g_strdup_printf (&quot;assertion failed (%s): (0x%08&quot; G_GINT64_MODIFIER &quot;x %s 0x%08&quot; G_GINT64_MODIFIER &quot;x)&quot;, expr, (guint64) arg1, cmp, (guint64) arg2); break;
2649     case &#39;f&#39;:   s = g_strdup_printf (&quot;assertion failed (%s): (%.9g %s %.9g)&quot;, expr, (double) arg1, cmp, (double) arg2); break;
2650       /* ideally use: floats=%.7g double=%.17g */
2651     }
2652   g_assertion_message (domain, file, line, func, s);
2653   g_free (s);
2654 }
2655 
2656 void
2657 g_assertion_message_cmpstr (const char     *domain,
2658                             const char     *file,
2659                             int             line,
2660                             const char     *func,
2661                             const char     *expr,
2662                             const char     *arg1,
2663                             const char     *cmp,
2664                             const char     *arg2)
2665 {
2666   char *a1, *a2, *s, *t1 = NULL, *t2 = NULL;
2667   a1 = arg1 ? g_strconcat (&quot;\&quot;&quot;, t1 = g_strescape (arg1, NULL), &quot;\&quot;&quot;, NULL) : g_strdup (&quot;NULL&quot;);
2668   a2 = arg2 ? g_strconcat (&quot;\&quot;&quot;, t2 = g_strescape (arg2, NULL), &quot;\&quot;&quot;, NULL) : g_strdup (&quot;NULL&quot;);
2669   g_free (t1);
2670   g_free (t2);
2671   s = g_strdup_printf (&quot;assertion failed (%s): (%s %s %s)&quot;, expr, a1, cmp, a2);
2672   g_free (a1);
2673   g_free (a2);
2674   g_assertion_message (domain, file, line, func, s);
2675   g_free (s);
2676 }
2677 
2678 void
2679 g_assertion_message_error (const char     *domain,
2680                const char     *file,
2681                int             line,
2682                const char     *func,
2683                const char     *expr,
2684                const GError   *error,
2685                GQuark          error_domain,
2686                int             error_code)
2687 {
2688   GString *gstring;
2689 
2690   /* This is used by both g_assert_error() and g_assert_no_error(), so there
2691    * are three cases: expected an error but got the wrong error, expected
2692    * an error but got no error, and expected no error but got an error.
2693    */
2694 
2695   gstring = g_string_new (&quot;assertion failed &quot;);
2696   if (error_domain)
2697       g_string_append_printf (gstring, &quot;(%s == (%s, %d)): &quot;, expr,
2698                   g_quark_to_string (error_domain), error_code);
2699   else
2700     g_string_append_printf (gstring, &quot;(%s == NULL): &quot;, expr);
2701 
2702   if (error)
2703       g_string_append_printf (gstring, &quot;%s (%s, %d)&quot;, error-&gt;message,
2704                   g_quark_to_string (error-&gt;domain), error-&gt;code);
2705   else
2706     g_string_append_printf (gstring, &quot;%s is NULL&quot;, expr);
2707 
2708   g_assertion_message (domain, file, line, func, gstring-&gt;str);
2709   g_string_free (gstring, TRUE);
2710 }
2711 
2712 /**
2713  * g_strcmp0:
2714  * @str1: (nullable): a C string or %NULL
2715  * @str2: (nullable): another C string or %NULL
2716  *
2717  * Compares @str1 and @str2 like strcmp(). Handles %NULL
2718  * gracefully by sorting it before non-%NULL strings.
2719  * Comparing two %NULL pointers returns 0.
2720  *
2721  * Returns: an integer less than, equal to, or greater than zero, if @str1 is &lt;, == or &gt; than @str2.
2722  *
2723  * Since: 2.16
2724  */
2725 int
2726 g_strcmp0 (const char     *str1,
2727            const char     *str2)
2728 {
2729   if (!str1)
2730     return -(str1 != str2);
2731   if (!str2)
2732     return str1 != str2;
2733   return strcmp (str1, str2);
2734 }
2735 
2736 static void
2737 test_trap_clear (void)
2738 {
2739   test_trap_last_status = 0;
2740   test_trap_last_pid = 0;
2741   g_clear_pointer (&amp;test_trap_last_subprocess, g_free);
2742   g_clear_pointer (&amp;test_trap_last_stdout, g_free);
2743   g_clear_pointer (&amp;test_trap_last_stderr, g_free);
2744 }
2745 
2746 #ifdef G_OS_UNIX
2747 
2748 static int
2749 sane_dup2 (int fd1,
2750            int fd2)
2751 {
2752   int ret;
2753   do
2754     ret = dup2 (fd1, fd2);
2755   while (ret &lt; 0 &amp;&amp; errno == EINTR);
2756   return ret;
2757 }
2758 
2759 #endif
2760 
2761 typedef struct {
2762   GPid pid;
2763   GMainLoop *loop;
2764   int child_status;  /* unmodified platform-specific status */
2765 
2766   GIOChannel *stdout_io;
2767   gboolean echo_stdout;
2768   GString *stdout_str;
2769 
2770   GIOChannel *stderr_io;
2771   gboolean echo_stderr;
2772   GString *stderr_str;
2773 } WaitForChildData;
2774 
2775 static void
2776 check_complete (WaitForChildData *data)
2777 {
2778   if (data-&gt;child_status != -1 &amp;&amp; data-&gt;stdout_io == NULL &amp;&amp; data-&gt;stderr_io == NULL)
2779     g_main_loop_quit (data-&gt;loop);
2780 }
2781 
2782 static void
2783 child_exited (GPid     pid,
2784               gint     status,
2785               gpointer user_data)
2786 {
2787   WaitForChildData *data = user_data;
2788 
2789   g_assert (status != -1);
2790   data-&gt;child_status = status;
2791 
2792   check_complete (data);
2793 }
2794 
2795 static gboolean
2796 child_timeout (gpointer user_data)
2797 {
2798   WaitForChildData *data = user_data;
2799 
2800 #ifdef G_OS_WIN32
2801   TerminateProcess (data-&gt;pid, G_TEST_STATUS_TIMED_OUT);
2802 #else
2803   kill (data-&gt;pid, SIGALRM);
2804 #endif
2805 
2806   return FALSE;
2807 }
2808 
2809 static gboolean
2810 child_read (GIOChannel *io, GIOCondition cond, gpointer user_data)
2811 {
2812   WaitForChildData *data = user_data;
2813   GIOStatus status;
2814   gsize nread, nwrote, total;
2815   gchar buf[4096];
2816   FILE *echo_file = NULL;
2817 
2818   status = g_io_channel_read_chars (io, buf, sizeof (buf), &amp;nread, NULL);
2819   if (status == G_IO_STATUS_ERROR || status == G_IO_STATUS_EOF)
2820     {
2821       // FIXME data-&gt;error = (status == G_IO_STATUS_ERROR);
2822       if (io == data-&gt;stdout_io)
2823         g_clear_pointer (&amp;data-&gt;stdout_io, g_io_channel_unref);
2824       else
2825         g_clear_pointer (&amp;data-&gt;stderr_io, g_io_channel_unref);
2826 
2827       check_complete (data);
2828       return FALSE;
2829     }
2830   else if (status == G_IO_STATUS_AGAIN)
2831     return TRUE;
2832 
2833   if (io == data-&gt;stdout_io)
2834     {
2835       g_string_append_len (data-&gt;stdout_str, buf, nread);
2836       if (data-&gt;echo_stdout)
2837         echo_file = stdout;
2838     }
2839   else
2840     {
2841       g_string_append_len (data-&gt;stderr_str, buf, nread);
2842       if (data-&gt;echo_stderr)
2843         echo_file = stderr;
2844     }
2845 
2846   if (echo_file)
2847     {
2848       for (total = 0; total &lt; nread; total += nwrote)
2849         {
2850           int errsv;
2851 
2852           nwrote = fwrite (buf + total, 1, nread - total, echo_file);
2853           errsv = errno;
2854           if (nwrote == 0)
2855             g_error (&quot;write failed: %s&quot;, g_strerror (errsv));
2856         }
2857     }
2858 
2859   return TRUE;
2860 }
2861 
2862 static void
2863 wait_for_child (GPid pid,
2864                 int stdout_fd, gboolean echo_stdout,
2865                 int stderr_fd, gboolean echo_stderr,
2866                 guint64 timeout)
2867 {
2868   WaitForChildData data;
2869   GMainContext *context;
2870   GSource *source;
2871 
2872   data.pid = pid;
2873   data.child_status = -1;
2874 
2875   context = g_main_context_new ();
2876   data.loop = g_main_loop_new (context, FALSE);
2877 
2878   source = g_child_watch_source_new (pid);
2879   g_source_set_callback (source, (GSourceFunc) child_exited, &amp;data, NULL);
2880   g_source_attach (source, context);
2881   g_source_unref (source);
2882 
2883   data.echo_stdout = echo_stdout;
2884   data.stdout_str = g_string_new (NULL);
2885   data.stdout_io = g_io_channel_unix_new (stdout_fd);
2886   g_io_channel_set_close_on_unref (data.stdout_io, TRUE);
2887   g_io_channel_set_encoding (data.stdout_io, NULL, NULL);
2888   g_io_channel_set_buffered (data.stdout_io, FALSE);
2889   source = g_io_create_watch (data.stdout_io, G_IO_IN | G_IO_ERR | G_IO_HUP);
2890   g_source_set_callback (source, (GSourceFunc) child_read, &amp;data, NULL);
2891   g_source_attach (source, context);
2892   g_source_unref (source);
2893 
2894   data.echo_stderr = echo_stderr;
2895   data.stderr_str = g_string_new (NULL);
2896   data.stderr_io = g_io_channel_unix_new (stderr_fd);
2897   g_io_channel_set_close_on_unref (data.stderr_io, TRUE);
2898   g_io_channel_set_encoding (data.stderr_io, NULL, NULL);
2899   g_io_channel_set_buffered (data.stderr_io, FALSE);
2900   source = g_io_create_watch (data.stderr_io, G_IO_IN | G_IO_ERR | G_IO_HUP);
2901   g_source_set_callback (source, (GSourceFunc) child_read, &amp;data, NULL);
2902   g_source_attach (source, context);
2903   g_source_unref (source);
2904 
2905   if (timeout)
2906     {
2907       source = g_timeout_source_new (0);
2908       g_source_set_ready_time (source, g_get_monotonic_time () + timeout);
2909       g_source_set_callback (source, (GSourceFunc) child_timeout, &amp;data, NULL);
2910       g_source_attach (source, context);
2911       g_source_unref (source);
2912     }
2913 
2914   g_main_loop_run (data.loop);
2915   g_main_loop_unref (data.loop);
2916   g_main_context_unref (context);
2917 
2918   test_trap_last_pid = pid;
2919   test_trap_last_status = data.child_status;
2920   test_trap_last_stdout = g_string_free (data.stdout_str, FALSE);
2921   test_trap_last_stderr = g_string_free (data.stderr_str, FALSE);
2922 
2923   g_clear_pointer (&amp;data.stdout_io, g_io_channel_unref);
2924   g_clear_pointer (&amp;data.stderr_io, g_io_channel_unref);
2925 }
2926 
2927 /**
2928  * g_test_trap_fork:
2929  * @usec_timeout:    Timeout for the forked test in micro seconds.
2930  * @test_trap_flags: Flags to modify forking behaviour.
2931  *
2932  * Fork the current test program to execute a test case that might
2933  * not return or that might abort.
2934  *
2935  * If @usec_timeout is non-0, the forked test case is aborted and
2936  * considered failing if its run time exceeds it.
2937  *
2938  * The forking behavior can be configured with the #GTestTrapFlags flags.
2939  *
2940  * In the following example, the test code forks, the forked child
2941  * process produces some sample output and exits successfully.
2942  * The forking parent process then asserts successful child program
2943  * termination and validates child program outputs.
2944  *
2945  * |[&lt;!-- language=&quot;C&quot; --&gt;
2946  *   static void
2947  *   test_fork_patterns (void)
2948  *   {
2949  *     if (g_test_trap_fork (0, G_TEST_TRAP_SILENCE_STDOUT | G_TEST_TRAP_SILENCE_STDERR))
2950  *       {
2951  *         g_print (&quot;some stdout text: somagic17\n&quot;);
2952  *         g_printerr (&quot;some stderr text: semagic43\n&quot;);
2953  *         exit (0); // successful test run
2954  *       }
2955  *     g_test_trap_assert_passed ();
2956  *     g_test_trap_assert_stdout (&quot;*somagic17*&quot;);
2957  *     g_test_trap_assert_stderr (&quot;*semagic43*&quot;);
2958  *   }
2959  * ]|
2960  *
2961  * Returns: %TRUE for the forked child and %FALSE for the executing parent process.
2962  *
2963  * Since: 2.16
2964  *
2965  * Deprecated: This function is implemented only on Unix platforms,
2966  * and is not always reliable due to problems inherent in
2967  * fork-without-exec. Use g_test_trap_subprocess() instead.
2968  */
2969 gboolean
2970 g_test_trap_fork (guint64        usec_timeout,
2971                   GTestTrapFlags test_trap_flags)
2972 {
2973 #ifdef G_OS_UNIX
2974   int stdout_pipe[2] = { -1, -1 };
2975   int stderr_pipe[2] = { -1, -1 };
2976   int errsv;
2977 
2978   test_trap_clear();
2979   if (pipe (stdout_pipe) &lt; 0 || pipe (stderr_pipe) &lt; 0)
2980     {
2981       errsv = errno;
2982       g_error (&quot;failed to create pipes to fork test program: %s&quot;, g_strerror (errsv));
2983     }
2984   test_trap_last_pid = fork ();
2985   errsv = errno;
2986   if (test_trap_last_pid &lt; 0)
2987     g_error (&quot;failed to fork test program: %s&quot;, g_strerror (errsv));
2988   if (test_trap_last_pid == 0)  /* child */
2989     {
2990       int fd0 = -1;
2991       test_in_forked_child = TRUE;
2992       close (stdout_pipe[0]);
2993       close (stderr_pipe[0]);
2994       if (!(test_trap_flags &amp; G_TEST_TRAP_INHERIT_STDIN))
2995         {
2996           fd0 = g_open (&quot;/dev/null&quot;, O_RDONLY, 0);
2997           if (fd0 &lt; 0)
2998             g_error (&quot;failed to open /dev/null for stdin redirection&quot;);
2999         }
3000       if (sane_dup2 (stdout_pipe[1], 1) &lt; 0 || sane_dup2 (stderr_pipe[1], 2) &lt; 0 || (fd0 &gt;= 0 &amp;&amp; sane_dup2 (fd0, 0) &lt; 0))
3001         {
3002           errsv = errno;
3003           g_error (&quot;failed to dup2() in forked test program: %s&quot;, g_strerror (errsv));
3004         }
3005       if (fd0 &gt;= 3)
3006         close (fd0);
3007       if (stdout_pipe[1] &gt;= 3)
3008         close (stdout_pipe[1]);
3009       if (stderr_pipe[1] &gt;= 3)
3010         close (stderr_pipe[1]);
3011       return TRUE;
3012     }
3013   else                          /* parent */
3014     {
3015       test_run_forks++;
3016       close (stdout_pipe[1]);
3017       close (stderr_pipe[1]);
3018 
3019       wait_for_child (test_trap_last_pid,
3020                       stdout_pipe[0], !(test_trap_flags &amp; G_TEST_TRAP_SILENCE_STDOUT),
3021                       stderr_pipe[0], !(test_trap_flags &amp; G_TEST_TRAP_SILENCE_STDERR),
3022                       usec_timeout);
3023       return FALSE;
3024     }
3025 #else
3026   g_message (&quot;Not implemented: g_test_trap_fork&quot;);
3027 
3028   return FALSE;
3029 #endif
3030 }
3031 
3032 /**
3033  * g_test_trap_subprocess:
3034  * @test_path: (nullable): Test to run in a subprocess
3035  * @usec_timeout: Timeout for the subprocess test in micro seconds.
3036  * @test_flags:   Flags to modify subprocess behaviour.
3037  *
3038  * Respawns the test program to run only @test_path in a subprocess.
3039  * This can be used for a test case that might not return, or that
3040  * might abort.
3041  *
3042  * If @test_path is %NULL then the same test is re-run in a subprocess.
3043  * You can use g_test_subprocess() to determine whether the test is in
3044  * a subprocess or not.
3045  *
3046  * @test_path can also be the name of the parent test, followed by
3047  * &quot;`/subprocess/`&quot; and then a name for the specific subtest (or just
3048  * ending with &quot;`/subprocess`&quot; if the test only has one child test);
3049  * tests with names of this form will automatically be skipped in the
3050  * parent process.
3051  *
3052  * If @usec_timeout is non-0, the test subprocess is aborted and
3053  * considered failing if its run time exceeds it.
3054  *
3055  * The subprocess behavior can be configured with the
3056  * #GTestSubprocessFlags flags.
3057  *
3058  * You can use methods such as g_test_trap_assert_passed(),
3059  * g_test_trap_assert_failed(), and g_test_trap_assert_stderr() to
3060  * check the results of the subprocess. (But note that
3061  * g_test_trap_assert_stdout() and g_test_trap_assert_stderr()
3062  * cannot be used if @test_flags specifies that the child should
3063  * inherit the parent stdout/stderr.)
3064  *
3065  * If your `main ()` needs to behave differently in
3066  * the subprocess, you can call g_test_subprocess() (after calling
3067  * g_test_init()) to see whether you are in a subprocess.
3068  *
3069  * The following example tests that calling
3070  * `my_object_new(1000000)` will abort with an error
3071  * message.
3072  *
3073  * |[&lt;!-- language=&quot;C&quot; --&gt;
3074  *   static void
3075  *   test_create_large_object (void)
3076  *   {
3077  *     if (g_test_subprocess ())
3078  *       {
3079  *         my_object_new (1000000);
3080  *         return;
3081  *       }
3082  *
3083  *     // Reruns this same test in a subprocess
3084  *     g_test_trap_subprocess (NULL, 0, 0);
3085  *     g_test_trap_assert_failed ();
3086  *     g_test_trap_assert_stderr (&quot;*ERROR*too large*&quot;);
3087  *   }
3088  *
3089  *   int
3090  *   main (int argc, char **argv)
3091  *   {
3092  *     g_test_init (&amp;argc, &amp;argv, NULL);
3093  *
3094  *     g_test_add_func (&quot;/myobject/create_large_object&quot;,
3095  *                      test_create_large_object);
3096  *     return g_test_run ();
3097  *   }
3098  * ]|
3099  *
3100  * Since: 2.38
3101  */
3102 void
3103 g_test_trap_subprocess (const char           *test_path,
3104                         guint64               usec_timeout,
3105                         GTestSubprocessFlags  test_flags)
3106 {
3107   GError *error = NULL;
3108   GPtrArray *argv;
3109   GSpawnFlags flags;
3110   int stdout_fd, stderr_fd;
3111   GPid pid;
3112 
3113   /* Sanity check that they used GTestSubprocessFlags, not GTestTrapFlags */
3114   g_assert ((test_flags &amp; (G_TEST_TRAP_INHERIT_STDIN | G_TEST_TRAP_SILENCE_STDOUT | G_TEST_TRAP_SILENCE_STDERR)) == 0);
3115 
3116   if (test_path)
3117     {
3118       if (!g_test_suite_case_exists (g_test_get_root (), test_path))
3119         g_error (&quot;g_test_trap_subprocess: test does not exist: %s&quot;, test_path);
3120     }
3121   else
3122     {
3123       test_path = test_run_name;
3124     }
3125 
3126   if (g_test_verbose ())
3127     g_print (&quot;GTest: subprocess: %s\n&quot;, test_path);
3128 
3129   test_trap_clear ();
3130   test_trap_last_subprocess = g_strdup (test_path);
3131 
3132   argv = g_ptr_array_new ();
3133   g_ptr_array_add (argv, test_argv0);
3134   g_ptr_array_add (argv, &quot;-q&quot;);
3135   g_ptr_array_add (argv, &quot;-p&quot;);
3136   g_ptr_array_add (argv, (char *)test_path);
3137   g_ptr_array_add (argv, &quot;--GTestSubprocess&quot;);
3138   if (test_log_fd != -1)
3139     {
3140       char log_fd_buf[128];
3141 
3142       g_ptr_array_add (argv, &quot;--GTestLogFD&quot;);
3143       g_snprintf (log_fd_buf, sizeof (log_fd_buf), &quot;%d&quot;, test_log_fd);
3144       g_ptr_array_add (argv, log_fd_buf);
3145     }
3146   g_ptr_array_add (argv, NULL);
3147 
3148   flags = G_SPAWN_DO_NOT_REAP_CHILD;
3149   if (test_flags &amp; G_TEST_TRAP_INHERIT_STDIN)
3150     flags |= G_SPAWN_CHILD_INHERITS_STDIN;
3151 
3152   if (!g_spawn_async_with_pipes (test_initial_cwd,
3153                                  (char **)argv-&gt;pdata,
3154                                  NULL, flags,
3155                                  NULL, NULL,
3156                                  &amp;pid, NULL, &amp;stdout_fd, &amp;stderr_fd,
3157                                  &amp;error))
3158     {
3159       g_error (&quot;g_test_trap_subprocess() failed: %s&quot;,
3160                error-&gt;message);
3161     }
3162   g_ptr_array_free (argv, TRUE);
3163 
3164   wait_for_child (pid,
3165                   stdout_fd, !!(test_flags &amp; G_TEST_SUBPROCESS_INHERIT_STDOUT),
3166                   stderr_fd, !!(test_flags &amp; G_TEST_SUBPROCESS_INHERIT_STDERR),
3167                   usec_timeout);
3168 }
3169 
3170 /**
3171  * g_test_subprocess:
3172  *
3173  * Returns %TRUE (after g_test_init() has been called) if the test
3174  * program is running under g_test_trap_subprocess().
3175  *
3176  * Returns: %TRUE if the test program is running under
3177  * g_test_trap_subprocess().
3178  *
3179  * Since: 2.38
3180  */
3181 gboolean
3182 g_test_subprocess (void)
3183 {
3184   return test_in_subprocess;
3185 }
3186 
3187 /**
3188  * g_test_trap_has_passed:
3189  *
3190  * Check the result of the last g_test_trap_subprocess() call.
3191  *
3192  * Returns: %TRUE if the last test subprocess terminated successfully.
3193  *
3194  * Since: 2.16
3195  */
3196 gboolean
3197 g_test_trap_has_passed (void)
3198 {
3199 #ifdef G_OS_UNIX
3200   return (WIFEXITED (test_trap_last_status) &amp;&amp;
3201       WEXITSTATUS (test_trap_last_status) == 0);
3202 #else
3203   return test_trap_last_status == 0;
3204 #endif
3205 }
3206 
3207 /**
3208  * g_test_trap_reached_timeout:
3209  *
3210  * Check the result of the last g_test_trap_subprocess() call.
3211  *
3212  * Returns: %TRUE if the last test subprocess got killed due to a timeout.
3213  *
3214  * Since: 2.16
3215  */
3216 gboolean
3217 g_test_trap_reached_timeout (void)
3218 {
3219 #ifdef G_OS_UNIX
3220   return (WIFSIGNALED (test_trap_last_status) &amp;&amp;
3221       WTERMSIG (test_trap_last_status) == SIGALRM);
3222 #else
3223   return test_trap_last_status == G_TEST_STATUS_TIMED_OUT;
3224 #endif
3225 }
3226 
3227 static gboolean
3228 log_child_output (const gchar *process_id)
3229 {
3230   gchar *escaped;
3231 
3232 #ifdef G_OS_UNIX
3233   if (WIFEXITED (test_trap_last_status)) /* normal exit */
3234     {
3235       if (WEXITSTATUS (test_trap_last_status) == 0)
3236         g_test_message (&quot;child process (%s) exit status: 0 (success)&quot;,
3237             process_id);
3238       else
3239         g_test_message (&quot;child process (%s) exit status: %d (error)&quot;,
3240             process_id, WEXITSTATUS (test_trap_last_status));
3241     }
3242   else if (WIFSIGNALED (test_trap_last_status) &amp;&amp;
3243       WTERMSIG (test_trap_last_status) == SIGALRM)
3244     {
3245       g_test_message (&quot;child process (%s) timed out&quot;, process_id);
3246     }
3247   else if (WIFSIGNALED (test_trap_last_status))
3248     {
3249       const gchar *maybe_dumped_core = &quot;&quot;;
3250 
3251 #ifdef WCOREDUMP
3252       if (WCOREDUMP (test_trap_last_status))
3253         maybe_dumped_core = &quot;, core dumped&quot;;
3254 #endif
3255 
3256       g_test_message (&quot;child process (%s) killed by signal %d (%s)%s&quot;,
3257           process_id, WTERMSIG (test_trap_last_status),
3258           g_strsignal (WTERMSIG (test_trap_last_status)),
3259           maybe_dumped_core);
3260     }
3261   else
3262     {
3263       g_test_message (&quot;child process (%s) unknown wait status %d&quot;,
3264           process_id, test_trap_last_status);
3265     }
3266 #else
3267   if (test_trap_last_status == 0)
3268     g_test_message (&quot;child process (%s) exit status: 0 (success)&quot;,
3269         process_id);
3270   else
3271     g_test_message (&quot;child process (%s) exit status: %d (error)&quot;,
3272         process_id, test_trap_last_status);
3273 #endif
3274 
3275   escaped = g_strescape (test_trap_last_stdout, NULL);
3276   g_test_message (&quot;child process (%s) stdout: \&quot;%s\&quot;&quot;, process_id, escaped);
3277   g_free (escaped);
3278 
3279   escaped = g_strescape (test_trap_last_stderr, NULL);
3280   g_test_message (&quot;child process (%s) stderr: \&quot;%s\&quot;&quot;, process_id, escaped);
3281   g_free (escaped);
3282 
3283   /* so we can use short-circuiting:
3284    * logged_child_output = logged_child_output || log_child_output (...) */
3285   return TRUE;
3286 }
3287 
3288 void
3289 g_test_trap_assertions (const char     *domain,
3290                         const char     *file,
3291                         int             line,
3292                         const char     *func,
3293                         guint64         assertion_flags, /* 0-pass, 1-fail, 2-outpattern, 4-errpattern */
3294                         const char     *pattern)
3295 {
3296   gboolean must_pass = assertion_flags == 0;
3297   gboolean must_fail = assertion_flags == 1;
3298   gboolean match_result = 0 == (assertion_flags &amp; 1);
3299   gboolean logged_child_output = FALSE;
3300   const char *stdout_pattern = (assertion_flags &amp; 2) ? pattern : NULL;
3301   const char *stderr_pattern = (assertion_flags &amp; 4) ? pattern : NULL;
3302   const char *match_error = match_result ? &quot;failed to match&quot; : &quot;contains invalid match&quot;;
3303   char *process_id;
3304 
3305 #ifdef G_OS_UNIX
3306   if (test_trap_last_subprocess != NULL)
3307     {
3308       process_id = g_strdup_printf (&quot;%s [%d]&quot;, test_trap_last_subprocess,
3309                                     test_trap_last_pid);
3310     }
3311   else if (test_trap_last_pid != 0)
3312     process_id = g_strdup_printf (&quot;%d&quot;, test_trap_last_pid);
3313 #else
3314   if (test_trap_last_subprocess != NULL)
3315     process_id = g_strdup (test_trap_last_subprocess);
3316 #endif
3317   else
3318     g_error (&quot;g_test_trap_ assertion with no trapped test&quot;);
3319 
3320   if (must_pass &amp;&amp; !g_test_trap_has_passed())
3321     {
3322       char *msg;
3323 
3324       logged_child_output = logged_child_output || log_child_output (process_id);
3325 
3326       msg = g_strdup_printf (&quot;child process (%s) failed unexpectedly&quot;, process_id);
3327       g_assertion_message (domain, file, line, func, msg);
3328       g_free (msg);
3329     }
3330   if (must_fail &amp;&amp; g_test_trap_has_passed())
3331     {
3332       char *msg;
3333 
3334       logged_child_output = logged_child_output || log_child_output (process_id);
3335 
3336       msg = g_strdup_printf (&quot;child process (%s) did not fail as expected&quot;, process_id);
3337       g_assertion_message (domain, file, line, func, msg);
3338       g_free (msg);
3339     }
3340   if (stdout_pattern &amp;&amp; match_result == !g_pattern_match_simple (stdout_pattern, test_trap_last_stdout))
3341     {
3342       char *msg;
3343 
3344       logged_child_output = logged_child_output || log_child_output (process_id);
3345 
3346       msg = g_strdup_printf (&quot;stdout of child process (%s) %s: %s&quot;, process_id, match_error, stdout_pattern);
3347       g_assertion_message (domain, file, line, func, msg);
3348       g_free (msg);
3349     }
3350   if (stderr_pattern &amp;&amp; match_result == !g_pattern_match_simple (stderr_pattern, test_trap_last_stderr))
3351     {
3352       char *msg;
3353 
3354       logged_child_output = logged_child_output || log_child_output (process_id);
3355 
3356       msg = g_strdup_printf (&quot;stderr of child process (%s) %s: %s&quot;, process_id, match_error, stderr_pattern);
3357       g_assertion_message (domain, file, line, func, msg);
3358       g_free (msg);
3359     }
3360   g_free (process_id);
3361 }
3362 
3363 static void
3364 gstring_overwrite_int (GString *gstring,
3365                        guint    pos,
3366                        guint32  vuint)
3367 {
3368   vuint = g_htonl (vuint);
3369   g_string_overwrite_len (gstring, pos, (const gchar*) &amp;vuint, 4);
3370 }
3371 
3372 static void
3373 gstring_append_int (GString *gstring,
3374                     guint32  vuint)
3375 {
3376   vuint = g_htonl (vuint);
3377   g_string_append_len (gstring, (const gchar*) &amp;vuint, 4);
3378 }
3379 
3380 static void
3381 gstring_append_double (GString *gstring,
3382                        double   vdouble)
3383 {
3384   union { double vdouble; guint64 vuint64; } u;
3385   u.vdouble = vdouble;
3386   u.vuint64 = GUINT64_TO_BE (u.vuint64);
3387   g_string_append_len (gstring, (const gchar*) &amp;u.vuint64, 8);
3388 }
3389 
3390 static guint8*
3391 g_test_log_dump (GTestLogMsg *msg,
3392                  guint       *len)
3393 {
3394   GString *gstring = g_string_sized_new (1024);
3395   guint ui;
3396   gstring_append_int (gstring, 0);              /* message length */
3397   gstring_append_int (gstring, msg-&gt;log_type);
3398   gstring_append_int (gstring, msg-&gt;n_strings);
3399   gstring_append_int (gstring, msg-&gt;n_nums);
3400   gstring_append_int (gstring, 0);      /* reserved */
3401   for (ui = 0; ui &lt; msg-&gt;n_strings; ui++)
3402     {
3403       guint l = strlen (msg-&gt;strings[ui]);
3404       gstring_append_int (gstring, l);
3405       g_string_append_len (gstring, msg-&gt;strings[ui], l);
3406     }
3407   for (ui = 0; ui &lt; msg-&gt;n_nums; ui++)
3408     gstring_append_double (gstring, msg-&gt;nums[ui]);
3409   *len = gstring-&gt;len;
3410   gstring_overwrite_int (gstring, 0, *len);     /* message length */
3411   return (guint8*) g_string_free (gstring, FALSE);
3412 }
3413 
3414 static inline long double
3415 net_double (const gchar **ipointer)
3416 {
3417   union { guint64 vuint64; double vdouble; } u;
3418   guint64 aligned_int64;
3419   memcpy (&amp;aligned_int64, *ipointer, 8);
3420   *ipointer += 8;
3421   u.vuint64 = GUINT64_FROM_BE (aligned_int64);
3422   return u.vdouble;
3423 }
3424 
3425 static inline guint32
3426 net_int (const gchar **ipointer)
3427 {
3428   guint32 aligned_int;
3429   memcpy (&amp;aligned_int, *ipointer, 4);
3430   *ipointer += 4;
3431   return g_ntohl (aligned_int);
3432 }
3433 
3434 static gboolean
3435 g_test_log_extract (GTestLogBuffer *tbuffer)
3436 {
3437   const gchar *p = tbuffer-&gt;data-&gt;str;
3438   GTestLogMsg msg;
3439   guint mlength;
3440   if (tbuffer-&gt;data-&gt;len &lt; 4 * 5)
3441     return FALSE;
3442   mlength = net_int (&amp;p);
3443   if (tbuffer-&gt;data-&gt;len &lt; mlength)
3444     return FALSE;
3445   msg.log_type = net_int (&amp;p);
3446   msg.n_strings = net_int (&amp;p);
3447   msg.n_nums = net_int (&amp;p);
3448   if (net_int (&amp;p) == 0)
3449     {
3450       guint ui;
3451       msg.strings = g_new0 (gchar*, msg.n_strings + 1);
3452       msg.nums = g_new0 (long double, msg.n_nums);
3453       for (ui = 0; ui &lt; msg.n_strings; ui++)
3454         {
3455           guint sl = net_int (&amp;p);
3456           msg.strings[ui] = g_strndup (p, sl);
3457           p += sl;
3458         }
3459       for (ui = 0; ui &lt; msg.n_nums; ui++)
3460         msg.nums[ui] = net_double (&amp;p);
3461       if (p &lt;= tbuffer-&gt;data-&gt;str + mlength)
3462         {
3463           g_string_erase (tbuffer-&gt;data, 0, mlength);
3464           tbuffer-&gt;msgs = g_slist_prepend (tbuffer-&gt;msgs, g_memdup (&amp;msg, sizeof (msg)));
3465           return TRUE;
3466         }
3467 
3468       g_free (msg.nums);
3469       g_strfreev (msg.strings);
3470     }
3471 
3472   g_error (&quot;corrupt log stream from test program&quot;);
3473   return FALSE;
3474 }
3475 
3476 /**
3477  * g_test_log_buffer_new:
3478  *
3479  * Internal function for gtester to decode test log messages, no ABI guarantees provided.
3480  */
3481 GTestLogBuffer*
3482 g_test_log_buffer_new (void)
3483 {
3484   GTestLogBuffer *tb = g_new0 (GTestLogBuffer, 1);
3485   tb-&gt;data = g_string_sized_new (1024);
3486   return tb;
3487 }
3488 
3489 /**
3490  * g_test_log_buffer_free:
3491  *
3492  * Internal function for gtester to free test log messages, no ABI guarantees provided.
3493  */
3494 void
3495 g_test_log_buffer_free (GTestLogBuffer *tbuffer)
3496 {
3497   g_return_if_fail (tbuffer != NULL);
3498   while (tbuffer-&gt;msgs)
3499     g_test_log_msg_free (g_test_log_buffer_pop (tbuffer));
3500   g_string_free (tbuffer-&gt;data, TRUE);
3501   g_free (tbuffer);
3502 }
3503 
3504 /**
3505  * g_test_log_buffer_push:
3506  *
3507  * Internal function for gtester to decode test log messages, no ABI guarantees provided.
3508  */
3509 void
3510 g_test_log_buffer_push (GTestLogBuffer *tbuffer,
3511                         guint           n_bytes,
3512                         const guint8   *bytes)
3513 {
3514   g_return_if_fail (tbuffer != NULL);
3515   if (n_bytes)
3516     {
3517       gboolean more_messages;
3518       g_return_if_fail (bytes != NULL);
3519       g_string_append_len (tbuffer-&gt;data, (const gchar*) bytes, n_bytes);
3520       do
3521         more_messages = g_test_log_extract (tbuffer);
3522       while (more_messages);
3523     }
3524 }
3525 
3526 /**
3527  * g_test_log_buffer_pop:
3528  *
3529  * Internal function for gtester to retrieve test log messages, no ABI guarantees provided.
3530  */
3531 GTestLogMsg*
3532 g_test_log_buffer_pop (GTestLogBuffer *tbuffer)
3533 {
3534   GTestLogMsg *msg = NULL;
3535   g_return_val_if_fail (tbuffer != NULL, NULL);
3536   if (tbuffer-&gt;msgs)
3537     {
3538       GSList *slist = g_slist_last (tbuffer-&gt;msgs);
3539       msg = slist-&gt;data;
3540       tbuffer-&gt;msgs = g_slist_delete_link (tbuffer-&gt;msgs, slist);
3541     }
3542   return msg;
3543 }
3544 
3545 /**
3546  * g_test_log_msg_free:
3547  *
3548  * Internal function for gtester to free test log messages, no ABI guarantees provided.
3549  */
3550 void
3551 g_test_log_msg_free (GTestLogMsg *tmsg)
3552 {
3553   g_return_if_fail (tmsg != NULL);
3554   g_strfreev (tmsg-&gt;strings);
3555   g_free (tmsg-&gt;nums);
3556   g_free (tmsg);
3557 }
3558 
3559 static gchar *
3560 g_test_build_filename_va (GTestFileType  file_type,
3561                           const gchar   *first_path,
3562                           va_list        ap)
3563 {
3564   const gchar *pathv[16];
3565   gint num_path_segments;
3566 
3567   if (file_type == G_TEST_DIST)
3568     pathv[0] = test_disted_files_dir;
3569   else if (file_type == G_TEST_BUILT)
3570     pathv[0] = test_built_files_dir;
3571   else
3572     g_assert_not_reached ();
3573 
3574   pathv[1] = first_path;
3575 
3576   for (num_path_segments = 2; num_path_segments &lt; G_N_ELEMENTS (pathv); num_path_segments++)
3577     {
3578       pathv[num_path_segments] = va_arg (ap, const char *);
3579       if (pathv[num_path_segments] == NULL)
3580         break;
3581     }
3582 
3583   g_assert_cmpint (num_path_segments, &lt;, G_N_ELEMENTS (pathv));
3584 
3585   return g_build_filenamev ((gchar **) pathv);
3586 }
3587 
3588 /**
3589  * g_test_build_filename:
3590  * @file_type: the type of file (built vs. distributed)
3591  * @first_path: the first segment of the pathname
3592  * @...: %NULL-terminated additional path segments
3593  *
3594  * Creates the pathname to a data file that is required for a test.
3595  *
3596  * This function is conceptually similar to g_build_filename() except
3597  * that the first argument has been replaced with a #GTestFileType
3598  * argument.
3599  *
3600  * The data file should either have been distributed with the module
3601  * containing the test (%G_TEST_DIST) or built as part of the build
3602  * system of that module (%G_TEST_BUILT).
3603  *
3604  * In order for this function to work in srcdir != builddir situations,
3605  * the G_TEST_SRCDIR and G_TEST_BUILDDIR environment variables need to
3606  * have been defined.  As of 2.38, this is done by the glib.mk
3607  * included in GLib.  Please ensure that your copy is up to date before
3608  * using this function.
3609  *
3610  * In case neither variable is set, this function will fall back to
3611  * using the dirname portion of argv[0], possibly removing &quot;.libs&quot;.
3612  * This allows for casual running of tests directly from the commandline
3613  * in the srcdir == builddir case and should also support running of
3614  * installed tests, assuming the data files have been installed in the
3615  * same relative path as the test binary.
3616  *
3617  * Returns: the path of the file, to be freed using g_free()
3618  *
3619  * Since: 2.38
3620  **/
3621 /**
3622  * GTestFileType:
3623  * @G_TEST_DIST: a file that was included in the distribution tarball
3624  * @G_TEST_BUILT: a file that was built on the compiling machine
3625  *
3626  * The type of file to return the filename for, when used with
3627  * g_test_build_filename().
3628  *
3629  * These two options correspond rather directly to the &#39;dist&#39; and
3630  * &#39;built&#39; terminology that automake uses and are explicitly used to
3631  * distinguish between the &#39;srcdir&#39; and &#39;builddir&#39; being separate.  All
3632  * files in your project should either be dist (in the
3633  * `EXTRA_DIST` or `dist_schema_DATA`
3634  * sense, in which case they will always be in the srcdir) or built (in
3635  * the `BUILT_SOURCES` sense, in which case they will
3636  * always be in the builddir).
3637  *
3638  * Note: as a general rule of automake, files that are generated only as
3639  * part of the build-from-git process (but then are distributed with the
3640  * tarball) always go in srcdir (even if doing a srcdir != builddir
3641  * build from git) and are considered as distributed files.
3642  *
3643  * Since: 2.38
3644  **/
3645 gchar *
3646 g_test_build_filename (GTestFileType  file_type,
3647                        const gchar   *first_path,
3648                        ...)
3649 {
3650   gchar *result;
3651   va_list ap;
3652 
3653   g_assert (g_test_initialized ());
3654 
3655   va_start (ap, first_path);
3656   result = g_test_build_filename_va (file_type, first_path, ap);
3657   va_end (ap);
3658 
3659   return result;
3660 }
3661 
3662 #ifndef GSTREAMER_LITE
3663 /**
3664  * g_test_get_dir:
3665  * @file_type: the type of file (built vs. distributed)
3666  *
3667  * Gets the pathname of the directory containing test files of the type
3668  * specified by @file_type.
3669  *
3670  * This is approximately the same as calling g_test_build_filename(&quot;.&quot;),
3671  * but you don&#39;t need to free the return value.
3672  *
3673  * Returns: (type filename): the path of the directory, owned by GLib
3674  *
3675  * Since: 2.38
3676  **/
3677 const gchar *
3678 g_test_get_dir (GTestFileType file_type)
3679 {
3680   g_assert (g_test_initialized ());
3681 
3682   if (file_type == G_TEST_DIST)
3683     return test_disted_files_dir;
3684   else if (file_type == G_TEST_BUILT)
3685     return test_built_files_dir;
3686 
3687   g_assert_not_reached ();
3688 }
3689 #endif // GSTREAMER_LITE
3690 
3691 /**
3692  * g_test_get_filename:
3693  * @file_type: the type of file (built vs. distributed)
3694  * @first_path: the first segment of the pathname
3695  * @...: %NULL-terminated additional path segments
3696  *
3697  * Gets the pathname to a data file that is required for a test.
3698  *
3699  * This is the same as g_test_build_filename() with two differences.
3700  * The first difference is that must only use this function from within
3701  * a testcase function.  The second difference is that you need not free
3702  * the return value -- it will be automatically freed when the testcase
3703  * finishes running.
3704  *
3705  * It is safe to use this function from a thread inside of a testcase
3706  * but you must ensure that all such uses occur before the main testcase
3707  * function returns (ie: it is best to ensure that all threads have been
3708  * joined).
3709  *
3710  * Returns: the path, automatically freed at the end of the testcase
3711  *
3712  * Since: 2.38
3713  **/
3714 const gchar *
3715 g_test_get_filename (GTestFileType  file_type,
3716                      const gchar   *first_path,
3717                      ...)
3718 {
3719   gchar *result;
3720   GSList *node;
3721   va_list ap;
3722 
3723   g_assert (g_test_initialized ());
3724   if (test_filename_free_list == NULL)
3725     g_error (&quot;g_test_get_filename() can only be used within testcase functions&quot;);
3726 
3727   va_start (ap, first_path);
3728   result = g_test_build_filename_va (file_type, first_path, ap);
3729   va_end (ap);
3730 
3731   node = g_slist_prepend (NULL, result);
3732   do
3733     node-&gt;next = *test_filename_free_list;
3734   while (!g_atomic_pointer_compare_and_exchange (test_filename_free_list, node-&gt;next, node));
3735 
3736   return result;
3737 }
3738 
3739 /* --- macros docs START --- */
3740 /**
3741  * g_test_add:
3742  * @testpath:  The test path for a new test case.
3743  * @Fixture:   The type of a fixture data structure.
3744  * @tdata:     Data argument for the test functions.
3745  * @fsetup:    The function to set up the fixture data.
3746  * @ftest:     The actual test function.
3747  * @fteardown: The function to tear down the fixture data.
3748  *
3749  * Hook up a new test case at @testpath, similar to g_test_add_func().
3750  * A fixture data structure with setup and teardown functions may be provided,
3751  * similar to g_test_create_case().
3752  *
3753  * g_test_add() is implemented as a macro, so that the fsetup(), ftest() and
3754  * fteardown() callbacks can expect a @Fixture pointer as their first argument
3755  * in a type safe manner. They otherwise have type #GTestFixtureFunc.
3756  *
3757  * Since: 2.16
3758  **/
3759 /* --- macros docs END --- */
    </pre>
  </body>
</html>