<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.media/src/main/native/gstreamer/3rd_party/glib/glib/gmain.c</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="gmacros.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="gmain.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.media/src/main/native/gstreamer/3rd_party/glib/glib/gmain.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -85,10 +85,11 @@</span>
  #include &quot;ghash.h&quot;
  #include &quot;ghook.h&quot;
  #include &quot;gqueue.h&quot;
  #include &quot;gstrfuncs.h&quot;
  #include &quot;gtestutils.h&quot;
<span class="udiff-line-added">+ #include &quot;gthreadprivate.h&quot;</span>
  
  #ifdef G_OS_WIN32
  #include &quot;gwin32.h&quot;
  #endif
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -188,11 +189,11 @@</span>
   *
   * There are two options for memory management of the user data passed to a
   * #GSource to be passed to its callback on invocation. This data is provided
   * in calls to g_timeout_add(), g_timeout_add_full(), g_idle_add(), etc. and
   * more generally, using g_source_set_callback(). This data is typically an
<span class="udiff-line-modified-removed">-  * object which �owns� the timeout or idle callback, such as a widget or a</span>
<span class="udiff-line-modified-added">+  * object which &#39;owns&#39; the timeout or idle callback, such as a widget or a</span>
   * network protocol implementation. In many cases, it is an error for the
   * callback to be invoked after this owning object has been destroyed, as that
   * results in use of freed memory.
   *
   * The first, and preferred, option is to store the source ID returned by
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -200,14 +201,14 @@</span>
   * remove that source from the main context using g_source_remove() when the
   * owning object is finalized. This ensures that the callback can only be
   * invoked while the object is still alive.
   *
   * The second option is to hold a strong reference to the object in the
<span class="udiff-line-modified-removed">-  * callback, and to release it in the callback�s #GDestroyNotify. This ensures</span>
<span class="udiff-line-modified-added">+  * callback, and to release it in the callback&#39;s #GDestroyNotify. This ensures</span>
   * that the object is kept alive until after the source is finalized, which is
   * guaranteed to be after it is invoked for the final time. The #GDestroyNotify
<span class="udiff-line-modified-removed">-  * is another callback passed to the �full� variants of #GSource functions (for</span>
<span class="udiff-line-modified-added">+  * is another callback passed to the &#39;full&#39; variants of #GSource functions (for</span>
   * example, g_timeout_add_full()). It is called when the source is finalized,
   * and is designed for releasing references like this.
   *
   * One important caveat of this second approach is that it will keep the object
   * alive indefinitely if the main loop is stopped before the #GSource is
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -271,11 +272,11 @@</span>
    volatile gint ref_count;
  
    GHashTable *sources;              /* guint -&gt; GSource */
  
    GPtrArray *pending_dispatches;
<span class="udiff-line-modified-removed">-   gint timeout;         /* Timeout for current iteration */</span>
<span class="udiff-line-modified-added">+   gint timeout;     /* Timeout for current iteration */</span>
  
    guint next_id;
    GList *source_lists;
    gint in_check_or_prepare;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -306,17 +307,18 @@</span>
  };
  
  struct _GMainLoop
  {
    GMainContext *context;
<span class="udiff-line-modified-removed">-   gboolean is_running;</span>
<span class="udiff-line-modified-added">+   gboolean is_running; /* (atomic) */</span>
    volatile gint ref_count;
  };
  
  struct _GTimeoutSource
  {
    GSource     source;
<span class="udiff-line-added">+   /* Measured in seconds if &#39;seconds&#39; is TRUE, or milliseconds otherwise. */</span>
    guint       interval;
    gboolean    seconds;
  };
  
  struct _GChildWatchSource
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -325,19 +327,19 @@</span>
    GPid        pid;
    gint        child_status;
  #ifdef G_OS_WIN32
    GPollFD     poll;
  #else /* G_OS_WIN32 */
<span class="udiff-line-modified-removed">-   gboolean    child_exited;</span>
<span class="udiff-line-modified-added">+   gboolean    child_exited; /* (atomic) */</span>
  #endif /* G_OS_WIN32 */
  };
  
  struct _GUnixSignalWatchSource
  {
    GSource     source;
    int         signum;
<span class="udiff-line-modified-removed">-   gboolean    pending;</span>
<span class="udiff-line-modified-added">+   gboolean    pending; /* (atomic) */</span>
  };
  
  struct _GPollRec
  {
    GPollFD *fd;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -372,77 +374,68 @@</span>
  #define G_THREAD_SELF g_thread_self ()
  
  #define SOURCE_DESTROYED(source) (((source)-&gt;flags &amp; G_HOOK_FLAG_ACTIVE) == 0)
  #define SOURCE_BLOCKED(source) (((source)-&gt;flags &amp; G_SOURCE_BLOCKED) != 0)
  
<span class="udiff-line-removed">- #define SOURCE_UNREF(source, context)                       \</span>
<span class="udiff-line-removed">-    G_STMT_START {                                           \</span>
<span class="udiff-line-removed">-     if ((source)-&gt;ref_count &gt; 1)                            \</span>
<span class="udiff-line-removed">-       (source)-&gt;ref_count--;                                \</span>
<span class="udiff-line-removed">-     else                                                    \</span>
<span class="udiff-line-removed">-       g_source_unref_internal ((source), (context), TRUE);  \</span>
<span class="udiff-line-removed">-    } G_STMT_END</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
  /* Forward declarations */
  
  static void g_source_unref_internal             (GSource      *source,
<span class="udiff-line-modified-removed">-                          GMainContext *context,</span>
<span class="udiff-line-modified-removed">-                          gboolean      have_lock);</span>
<span class="udiff-line-modified-added">+              GMainContext *context,</span>
<span class="udiff-line-modified-added">+              gboolean      have_lock);</span>
  static void g_source_destroy_internal           (GSource      *source,
<span class="udiff-line-modified-removed">-                          GMainContext *context,</span>
<span class="udiff-line-modified-removed">-                          gboolean      have_lock);</span>
<span class="udiff-line-modified-added">+              GMainContext *context,</span>
<span class="udiff-line-modified-added">+              gboolean      have_lock);</span>
  static void g_source_set_priority_unlocked      (GSource      *source,
<span class="udiff-line-modified-removed">-                          GMainContext *context,</span>
<span class="udiff-line-modified-removed">-                          gint          priority);</span>
<span class="udiff-line-modified-added">+              GMainContext *context,</span>
<span class="udiff-line-modified-added">+              gint          priority);</span>
  static void g_child_source_remove_internal      (GSource      *child_source,
                                                   GMainContext *context);
  
  static void g_main_context_poll                 (GMainContext *context,
<span class="udiff-line-modified-removed">-                          gint          timeout,</span>
<span class="udiff-line-modified-removed">-                          gint          priority,</span>
<span class="udiff-line-modified-removed">-                          GPollFD      *fds,</span>
<span class="udiff-line-modified-removed">-                          gint          n_fds);</span>
<span class="udiff-line-modified-added">+              gint          timeout,</span>
<span class="udiff-line-modified-added">+              gint          priority,</span>
<span class="udiff-line-modified-added">+              GPollFD      *fds,</span>
<span class="udiff-line-modified-added">+              gint          n_fds);</span>
  static void g_main_context_add_poll_unlocked    (GMainContext *context,
<span class="udiff-line-modified-removed">-                          gint          priority,</span>
<span class="udiff-line-modified-removed">-                          GPollFD      *fd);</span>
<span class="udiff-line-modified-added">+              gint          priority,</span>
<span class="udiff-line-modified-added">+              GPollFD      *fd);</span>
  static void g_main_context_remove_poll_unlocked (GMainContext *context,
<span class="udiff-line-modified-removed">-                          GPollFD      *fd);</span>
<span class="udiff-line-modified-added">+              GPollFD      *fd);</span>
  
  static void     g_source_iter_init  (GSourceIter   *iter,
<span class="udiff-line-modified-removed">-                      GMainContext  *context,</span>
<span class="udiff-line-modified-removed">-                      gboolean       may_modify);</span>
<span class="udiff-line-modified-added">+              GMainContext  *context,</span>
<span class="udiff-line-modified-added">+              gboolean       may_modify);</span>
  static gboolean g_source_iter_next  (GSourceIter   *iter,
<span class="udiff-line-modified-removed">-                      GSource      **source);</span>
<span class="udiff-line-modified-added">+              GSource      **source);</span>
  static void     g_source_iter_clear (GSourceIter   *iter);
  
  static gboolean g_timeout_dispatch (GSource     *source,
<span class="udiff-line-modified-removed">-                     GSourceFunc  callback,</span>
<span class="udiff-line-modified-removed">-                     gpointer     user_data);</span>
<span class="udiff-line-modified-added">+             GSourceFunc  callback,</span>
<span class="udiff-line-modified-added">+             gpointer     user_data);</span>
  static gboolean g_child_watch_prepare  (GSource     *source,
<span class="udiff-line-modified-removed">-                         gint        *timeout);</span>
<span class="udiff-line-modified-added">+                 gint        *timeout);</span>
  static gboolean g_child_watch_check    (GSource     *source);
  static gboolean g_child_watch_dispatch (GSource     *source,
<span class="udiff-line-modified-removed">-                     GSourceFunc  callback,</span>
<span class="udiff-line-modified-removed">-                     gpointer     user_data);</span>
<span class="udiff-line-modified-added">+           GSourceFunc  callback,</span>
<span class="udiff-line-modified-added">+           gpointer     user_data);</span>
  static void     g_child_watch_finalize (GSource     *source);
  #ifdef G_OS_UNIX
  static void g_unix_signal_handler (int signum);
  static gboolean g_unix_signal_watch_prepare  (GSource     *source,
<span class="udiff-line-modified-removed">-                           gint        *timeout);</span>
<span class="udiff-line-modified-added">+                 gint        *timeout);</span>
  static gboolean g_unix_signal_watch_check    (GSource     *source);
  static gboolean g_unix_signal_watch_dispatch (GSource     *source,
<span class="udiff-line-modified-removed">-                           GSourceFunc  callback,</span>
<span class="udiff-line-modified-removed">-                           gpointer     user_data);</span>
<span class="udiff-line-modified-added">+                 GSourceFunc  callback,</span>
<span class="udiff-line-modified-added">+                 gpointer     user_data);</span>
  static void     g_unix_signal_watch_finalize  (GSource     *source);
  #endif
  static gboolean g_idle_prepare     (GSource     *source,
<span class="udiff-line-modified-removed">-                     gint        *timeout);</span>
<span class="udiff-line-modified-added">+             gint        *timeout);</span>
  static gboolean g_idle_check       (GSource     *source);
  static gboolean g_idle_dispatch    (GSource     *source,
<span class="udiff-line-modified-removed">-                     GSourceFunc  callback,</span>
<span class="udiff-line-modified-removed">-                     gpointer     user_data);</span>
<span class="udiff-line-modified-added">+             GSourceFunc  callback,</span>
<span class="udiff-line-modified-added">+             gpointer     user_data);</span>
  
  static void block_source (GSource *source);
  
  static GMainContext *glib_worker_context;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -460,50 +453,52 @@</span>
  static volatile sig_atomic_t any_unix_signal_pending;
  #else
  static volatile int unix_signal_pending[NSIG];
  static volatile int any_unix_signal_pending;
  #endif
<span class="udiff-line-removed">- static volatile guint unix_signal_refcount[NSIG];</span>
  
  /* Guards all the data below */
  G_LOCK_DEFINE_STATIC (unix_signal_lock);
<span class="udiff-line-added">+ static guint unix_signal_refcount[NSIG];</span>
  static GSList *unix_signal_watches;
  static GSList *unix_child_watches;
  
  GSourceFuncs g_unix_signal_funcs =
  {
    g_unix_signal_watch_prepare,
    g_unix_signal_watch_check,
    g_unix_signal_watch_dispatch,
<span class="udiff-line-modified-removed">-   g_unix_signal_watch_finalize</span>
<span class="udiff-line-modified-added">+   g_unix_signal_watch_finalize,</span>
<span class="udiff-line-added">+   NULL, NULL</span>
  };
  #endif /* !G_OS_WIN32 */
  G_LOCK_DEFINE_STATIC (main_context_list);
  static GSList *main_context_list = NULL;
  
  GSourceFuncs g_timeout_funcs =
  {
    NULL, /* prepare */
    NULL, /* check */
    g_timeout_dispatch,
<span class="udiff-line-modified-removed">-   NULL</span>
<span class="udiff-line-modified-added">+   NULL, NULL, NULL</span>
  };
  
  GSourceFuncs g_child_watch_funcs =
  {
    g_child_watch_prepare,
    g_child_watch_check,
    g_child_watch_dispatch,
<span class="udiff-line-modified-removed">-   g_child_watch_finalize</span>
<span class="udiff-line-modified-added">+   g_child_watch_finalize,</span>
<span class="udiff-line-added">+   NULL, NULL</span>
  };
  
  GSourceFuncs g_idle_funcs =
  {
    g_idle_prepare,
    g_idle_check,
    g_idle_dispatch,
<span class="udiff-line-modified-removed">-   NULL</span>
<span class="udiff-line-modified-added">+   NULL, NULL, NULL</span>
  };
  
  /**
   * g_main_context_ref:
   * @context: a #GMainContext
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -523,11 +518,11 @@</span>
    return context;
  }
  
  static inline void
  poll_rec_list_free (GMainContext *context,
<span class="udiff-line-modified-removed">-             GPollRec     *list)</span>
<span class="udiff-line-modified-added">+         GPollRec     *list)</span>
  {
    g_slice_free_chain (GPollRec, list, next);
  }
  
  /**
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -693,11 +688,11 @@</span>
  
        TRACE (GLIB_MAIN_CONTEXT_DEFAULT (default_main_context));
  
  #ifdef G_MAIN_POLL_DEBUG
        if (_g_main_poll_debug)
<span class="udiff-line-modified-removed">-     g_print (&quot;default context=%p\n&quot;, default_main_context);</span>
<span class="udiff-line-modified-added">+   g_print (&quot;default context=%p\n&quot;, default_main_context);</span>
  #endif
      }
  
    G_UNLOCK (main_loop);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -903,11 +898,11 @@</span>
   *
   * Returns: the newly-created #GSource.
   **/
  GSource *
  g_source_new (GSourceFuncs *source_funcs,
<span class="udiff-line-modified-removed">-           guint         struct_size)</span>
<span class="udiff-line-modified-added">+         guint         struct_size)</span>
  {
    GSource *source;
  
    g_return_val_if_fail (source_funcs != NULL, NULL);
    g_return_val_if_fail (struct_size &gt;= sizeof (GSource), NULL);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -944,12 +939,12 @@</span>
  }
  
  /* Holds context&#39;s lock */
  static void
  g_source_iter_init (GSourceIter  *iter,
<span class="udiff-line-modified-removed">-             GMainContext *context,</span>
<span class="udiff-line-modified-removed">-             gboolean      may_modify)</span>
<span class="udiff-line-modified-added">+         GMainContext *context,</span>
<span class="udiff-line-modified-added">+         gboolean      may_modify)</span>
  {
    iter-&gt;context = context;
    iter-&gt;current_list = NULL;
    iter-&gt;source = NULL;
    iter-&gt;may_modify = may_modify;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -967,33 +962,33 @@</span>
      next_source = NULL;
  
    if (!next_source)
      {
        if (iter-&gt;current_list)
<span class="udiff-line-modified-removed">-     iter-&gt;current_list = iter-&gt;current_list-&gt;next;</span>
<span class="udiff-line-modified-added">+   iter-&gt;current_list = iter-&gt;current_list-&gt;next;</span>
        else
<span class="udiff-line-modified-removed">-     iter-&gt;current_list = iter-&gt;context-&gt;source_lists;</span>
<span class="udiff-line-modified-added">+   iter-&gt;current_list = iter-&gt;context-&gt;source_lists;</span>
  
        if (iter-&gt;current_list)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       GSourceList *source_list = iter-&gt;current_list-&gt;data;</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     GSourceList *source_list = iter-&gt;current_list-&gt;data;</span>
  
<span class="udiff-line-modified-removed">-       next_source = source_list-&gt;head;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+     next_source = source_list-&gt;head;</span>
<span class="udiff-line-modified-added">+   }</span>
      }
  
    /* Note: unreffing iter-&gt;source could potentially cause its
     * GSourceList to be removed from source_lists (if iter-&gt;source is
     * the only source in its list, and it is destroyed), so we have to
     * keep it reffed until after we advance iter-&gt;current_list, above.
     */
  
    if (iter-&gt;source &amp;&amp; iter-&gt;may_modify)
<span class="udiff-line-modified-removed">-     SOURCE_UNREF (iter-&gt;source, iter-&gt;context);</span>
<span class="udiff-line-modified-added">+     g_source_unref_internal (iter-&gt;source, iter-&gt;context, TRUE);</span>
    iter-&gt;source = next_source;
    if (iter-&gt;source &amp;&amp; iter-&gt;may_modify)
<span class="udiff-line-modified-removed">-     iter-&gt;source-&gt;ref_count++;</span>
<span class="udiff-line-modified-added">+     g_source_ref (iter-&gt;source);</span>
  
    *source = iter-&gt;source;
    return *source != NULL;
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1003,45 +998,45 @@</span>
  static void
  g_source_iter_clear (GSourceIter *iter)
  {
    if (iter-&gt;source &amp;&amp; iter-&gt;may_modify)
      {
<span class="udiff-line-modified-removed">-       SOURCE_UNREF (iter-&gt;source, iter-&gt;context);</span>
<span class="udiff-line-modified-added">+       g_source_unref_internal (iter-&gt;source, iter-&gt;context, TRUE);</span>
        iter-&gt;source = NULL;
      }
  }
  
  /* Holds context&#39;s lock
   */
  static GSourceList *
  find_source_list_for_priority (GMainContext *context,
<span class="udiff-line-modified-removed">-                    gint          priority,</span>
<span class="udiff-line-modified-removed">-                    gboolean      create)</span>
<span class="udiff-line-modified-added">+              gint          priority,</span>
<span class="udiff-line-modified-added">+              gboolean      create)</span>
  {
    GList *iter, *last;
    GSourceList *source_list;
  
    last = NULL;
    for (iter = context-&gt;source_lists; iter != NULL; last = iter, iter = iter-&gt;next)
      {
        source_list = iter-&gt;data;
  
        if (source_list-&gt;priority == priority)
<span class="udiff-line-modified-removed">-     return source_list;</span>
<span class="udiff-line-modified-added">+   return source_list;</span>
  
        if (source_list-&gt;priority &gt; priority)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       if (!create)</span>
<span class="udiff-line-modified-removed">-         return NULL;</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-       source_list = g_slice_new0 (GSourceList);</span>
<span class="udiff-line-modified-removed">-       source_list-&gt;priority = priority;</span>
<span class="udiff-line-modified-removed">-       context-&gt;source_lists = g_list_insert_before (context-&gt;source_lists,</span>
<span class="udiff-line-modified-removed">-                             iter,</span>
<span class="udiff-line-modified-removed">-                             source_list);</span>
<span class="udiff-line-modified-removed">-       return source_list;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     if (!create)</span>
<span class="udiff-line-modified-added">+       return NULL;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     source_list = g_slice_new0 (GSourceList);</span>
<span class="udiff-line-modified-added">+     source_list-&gt;priority = priority;</span>
<span class="udiff-line-modified-added">+     context-&gt;source_lists = g_list_insert_before (context-&gt;source_lists,</span>
<span class="udiff-line-modified-added">+               iter,</span>
<span class="udiff-line-modified-added">+               source_list);</span>
<span class="udiff-line-modified-added">+     return source_list;</span>
<span class="udiff-line-modified-added">+   }</span>
      }
  
    if (!create)
      return NULL;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1062,11 +1057,11 @@</span>
  
  /* Holds context&#39;s lock
   */
  static void
  source_add_to_context (GSource      *source,
<span class="udiff-line-modified-removed">-                GMainContext *context)</span>
<span class="udiff-line-modified-added">+            GMainContext *context)</span>
  {
    GSourceList *source_list;
    GSource *prev, *next;
  
    source_list = find_source_list_for_priority (context, source-&gt;priority, TRUE);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1100,11 +1095,11 @@</span>
  
  /* Holds context&#39;s lock
   */
  static void
  source_remove_from_context (GSource      *source,
<span class="udiff-line-modified-removed">-                 GMainContext *context)</span>
<span class="udiff-line-modified-added">+           GMainContext *context)</span>
  {
    GSourceList *source_list;
  
    source_list = find_source_list_for_priority (context, source-&gt;priority, FALSE);
    g_return_if_fail (source_list != NULL);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1148,11 +1143,11 @@</span>
      id = context-&gt;next_id++;
    while (id == 0 || g_hash_table_contains (context-&gt;sources, GUINT_TO_POINTER (id)));
  
    source-&gt;context = context;
    source-&gt;source_id = id;
<span class="udiff-line-modified-removed">-   source-&gt;ref_count++;</span>
<span class="udiff-line-modified-added">+   g_source_ref (source);</span>
  
    g_hash_table_insert (context-&gt;sources, GUINT_TO_POINTER (id), source);
  
    source_add_to_context (source, context);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1196,11 +1191,11 @@</span>
   * Returns: the ID (greater than 0) for the source within the
   *   #GMainContext.
   **/
  guint
  g_source_attach (GSource      *source,
<span class="udiff-line-modified-removed">-          GMainContext *context)</span>
<span class="udiff-line-modified-added">+      GMainContext *context)</span>
  {
    guint result = 0;
  
  #ifdef GSTREAMER_LITE
    if (source == NULL) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1226,12 +1221,12 @@</span>
    return result;
  }
  
  static void
  g_source_destroy_internal (GSource      *source,
<span class="udiff-line-modified-removed">-                GMainContext *context,</span>
<span class="udiff-line-modified-removed">-                gboolean      have_lock)</span>
<span class="udiff-line-modified-added">+          GMainContext *context,</span>
<span class="udiff-line-modified-added">+          gboolean      have_lock)</span>
  {
    TRACE (GLIB_MAIN_SOURCE_DESTROY (g_source_get_name (source), source,
                                     context));
  
    if (!have_lock)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1250,28 +1245,28 @@</span>
  
        source-&gt;callback_data = NULL;
        source-&gt;callback_funcs = NULL;
  
        if (old_cb_funcs)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       UNLOCK_CONTEXT (context);</span>
<span class="udiff-line-modified-removed">-       old_cb_funcs-&gt;unref (old_cb_data);</span>
<span class="udiff-line-modified-removed">-       LOCK_CONTEXT (context);</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     UNLOCK_CONTEXT (context);</span>
<span class="udiff-line-modified-added">+     old_cb_funcs-&gt;unref (old_cb_data);</span>
<span class="udiff-line-modified-added">+     LOCK_CONTEXT (context);</span>
<span class="udiff-line-modified-added">+   }</span>
  
        if (!SOURCE_BLOCKED (source))
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       tmp_list = source-&gt;poll_fds;</span>
<span class="udiff-line-modified-removed">-       while (tmp_list)</span>
<span class="udiff-line-modified-removed">-         {</span>
<span class="udiff-line-modified-removed">-           g_main_context_remove_poll_unlocked (context, tmp_list-&gt;data);</span>
<span class="udiff-line-modified-removed">-           tmp_list = tmp_list-&gt;next;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     tmp_list = source-&gt;poll_fds;</span>
<span class="udiff-line-modified-added">+     while (tmp_list)</span>
<span class="udiff-line-modified-added">+       {</span>
<span class="udiff-line-modified-added">+         g_main_context_remove_poll_unlocked (context, tmp_list-&gt;data);</span>
<span class="udiff-line-modified-added">+         tmp_list = tmp_list-&gt;next;</span>
<span class="udiff-line-modified-added">+       }</span>
  
            for (tmp_list = source-&gt;priv-&gt;fds; tmp_list; tmp_list = tmp_list-&gt;next)
              g_main_context_remove_poll_unlocked (context, tmp_list-&gt;data);
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   }</span>
  
        while (source-&gt;priv-&gt;child_sources)
          g_child_source_remove_internal (source-&gt;priv-&gt;child_sources-&gt;data, context);
  
        if (source-&gt;priv-&gt;parent_source)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1290,11 +1285,14 @@</span>
   *
   * Removes a source from its #GMainContext, if any, and mark it as
   * destroyed.  The source cannot be subsequently added to another
   * context. It is safe to call this on sources which have already been
   * removed from their context.
<span class="udiff-line-modified-removed">-  **/</span>
<span class="udiff-line-modified-added">+  *</span>
<span class="udiff-line-added">+  * This does not unref the #GSource: if you still hold a reference, use</span>
<span class="udiff-line-added">+  * g_source_unref() to drop it.</span>
<span class="udiff-line-added">+  */</span>
  void
  g_source_destroy (GSource *source)
  {
    GMainContext *context;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1383,11 +1381,11 @@</span>
   * main loop iteration.  Newly-written event sources should try to use
   * g_source_add_unix_fd() instead of this API.
   **/
  void
  g_source_add_poll (GSource *source,
<span class="udiff-line-modified-removed">-            GPollFD *fd)</span>
<span class="udiff-line-modified-added">+        GPollFD *fd)</span>
  {
    GMainContext *context;
  
    g_return_if_fail (source != NULL);
    g_return_if_fail (fd != NULL);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1406,11 +1404,11 @@</span>
    source-&gt;poll_fds = g_slist_prepend (source-&gt;poll_fds, fd);
  
    if (context)
      {
        if (!SOURCE_BLOCKED (source))
<span class="udiff-line-modified-removed">-     g_main_context_add_poll_unlocked (context, source-&gt;priority, fd);</span>
<span class="udiff-line-modified-added">+   g_main_context_add_poll_unlocked (context, source-&gt;priority, fd);</span>
        UNLOCK_CONTEXT (context);
      }
  }
  
  /**
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1424,11 +1422,11 @@</span>
   * This API is only intended to be used by implementations of #GSource.
   * Do not call this API on a #GSource that you did not create.
   **/
  void
  g_source_remove_poll (GSource *source,
<span class="udiff-line-modified-removed">-               GPollFD *fd)</span>
<span class="udiff-line-modified-added">+           GPollFD *fd)</span>
  {
    GMainContext *context;
  
    g_return_if_fail (source != NULL);
    g_return_if_fail (fd != NULL);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1442,11 +1440,11 @@</span>
    source-&gt;poll_fds = g_slist_remove (source-&gt;poll_fds, fd);
  
    if (context)
      {
        if (!SOURCE_BLOCKED (source))
<span class="udiff-line-modified-removed">-     g_main_context_remove_poll_unlocked (context, fd);</span>
<span class="udiff-line-modified-added">+   g_main_context_remove_poll_unlocked (context, fd);</span>
        UNLOCK_CONTEXT (context);
      }
  }
  
  /**
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1474,11 +1472,11 @@</span>
   *
   * Since: 2.28
   **/
  void
  g_source_add_child_source (GSource *source,
<span class="udiff-line-modified-removed">-                GSource *child_source)</span>
<span class="udiff-line-modified-added">+          GSource *child_source)</span>
  {
    GMainContext *context;
  
    g_return_if_fail (source != NULL);
    g_return_if_fail (child_source != NULL);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1493,11 +1491,11 @@</span>
      LOCK_CONTEXT (context);
  
    TRACE (GLIB_SOURCE_ADD_CHILD_SOURCE (source, child_source));
  
    source-&gt;priv-&gt;child_sources = g_slist_prepend (source-&gt;priv-&gt;child_sources,
<span class="udiff-line-modified-removed">-                          g_source_ref (child_source));</span>
<span class="udiff-line-modified-added">+              g_source_ref (child_source));</span>
    child_source-&gt;priv-&gt;parent_source = source;
    g_source_set_priority_unlocked (child_source, NULL, source-&gt;priority);
    if (SOURCE_BLOCKED (source))
      block_source (child_source);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1535,11 +1533,11 @@</span>
   *
   * Since: 2.28
   **/
  void
  g_source_remove_child_source (GSource *source,
<span class="udiff-line-modified-removed">-                   GSource *child_source)</span>
<span class="udiff-line-modified-added">+             GSource *child_source)</span>
  {
    GMainContext *context;
  
    g_return_if_fail (source != NULL);
    g_return_if_fail (child_source != NULL);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1579,13 +1577,13 @@</span>
      }
  }
  
  static void
  g_source_callback_get (gpointer     cb_data,
<span class="udiff-line-modified-removed">-                GSource     *source,</span>
<span class="udiff-line-modified-removed">-                GSourceFunc *func,</span>
<span class="udiff-line-modified-removed">-                gpointer    *data)</span>
<span class="udiff-line-modified-added">+            GSource     *source,</span>
<span class="udiff-line-modified-added">+            GSourceFunc *func,</span>
<span class="udiff-line-modified-added">+            gpointer    *data)</span>
  {
    GSourceCallback *callback = cb_data;
  
    *func = callback-&gt;func;
    *data = callback-&gt;data;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1608,15 +1606,19 @@</span>
   * &quot;object&quot;. This is used internally. Note that calling
   * g_source_set_callback_indirect() assumes
   * an initial reference count on @callback_data, and thus
   * @callback_funcs-&gt;unref will eventually be called once more
   * than @callback_funcs-&gt;ref.
<span class="udiff-line-added">+  *</span>
<span class="udiff-line-added">+  * It is safe to call this function multiple times on a source which has already</span>
<span class="udiff-line-added">+  * been attached to a context. The changes will take effect for the next time</span>
<span class="udiff-line-added">+  * the source is dispatched after this call returns.</span>
   **/
  void
  g_source_set_callback_indirect (GSource              *source,
<span class="udiff-line-modified-removed">-                 gpointer              callback_data,</span>
<span class="udiff-line-modified-removed">-                 GSourceCallbackFuncs *callback_funcs)</span>
<span class="udiff-line-modified-added">+         gpointer              callback_data,</span>
<span class="udiff-line-modified-added">+         GSourceCallbackFuncs *callback_funcs)</span>
  {
    GMainContext *context;
    gpointer old_cb_data;
    GSourceCallbackFuncs *old_cb_funcs;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1627,14 +1629,16 @@</span>
  
    if (context)
      LOCK_CONTEXT (context);
  
    if (callback_funcs != &amp;g_source_callback_funcs)
<span class="udiff-line-modified-removed">-     TRACE (GLIB_SOURCE_SET_CALLBACK_INDIRECT (source, callback_data,</span>
<span class="udiff-line-modified-removed">-                                               callback_funcs-&gt;ref,</span>
<span class="udiff-line-modified-removed">-                                               callback_funcs-&gt;unref,</span>
<span class="udiff-line-modified-removed">-                                               callback_funcs-&gt;get));</span>
<span class="udiff-line-modified-added">+     {</span>
<span class="udiff-line-modified-added">+       TRACE (GLIB_SOURCE_SET_CALLBACK_INDIRECT (source, callback_data,</span>
<span class="udiff-line-modified-added">+                                                 callback_funcs-&gt;ref,</span>
<span class="udiff-line-modified-added">+                                                 callback_funcs-&gt;unref,</span>
<span class="udiff-line-added">+                                                 callback_funcs-&gt;get));</span>
<span class="udiff-line-added">+     }</span>
  
    old_cb_data = source-&gt;callback_data;
    old_cb_funcs = source-&gt;callback_funcs;
  
    source-&gt;callback_data = callback_data;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1664,17 +1668,21 @@</span>
   *
   * See [memory management of sources][mainloop-memory-management] for details
   * on how to handle memory management of @data.
   *
   * Typically, you won&#39;t use this function. Instead use functions specific
<span class="udiff-line-modified-removed">-  * to the type of source you are using.</span>
<span class="udiff-line-modified-added">+  * to the type of source you are using, such as g_idle_add() or g_timeout_add().</span>
<span class="udiff-line-added">+  *</span>
<span class="udiff-line-added">+  * It is safe to call this function multiple times on a source which has already</span>
<span class="udiff-line-added">+  * been attached to a context. The changes will take effect for the next time</span>
<span class="udiff-line-added">+  * the source is dispatched after this call returns.</span>
   **/
  void
  g_source_set_callback (GSource        *source,
<span class="udiff-line-modified-removed">-                GSourceFunc     func,</span>
<span class="udiff-line-modified-removed">-                gpointer        data,</span>
<span class="udiff-line-modified-removed">-                GDestroyNotify  notify)</span>
<span class="udiff-line-modified-added">+            GSourceFunc     func,</span>
<span class="udiff-line-modified-added">+            gpointer        data,</span>
<span class="udiff-line-modified-added">+            GDestroyNotify  notify)</span>
  {
    GSourceCallback *new_callback;
  
    g_return_if_fail (source != NULL);
  #ifdef GSTREAMER_LITE
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1705,24 +1713,24 @@</span>
   *
   * Since: 2.12
   */
  void
  g_source_set_funcs (GSource     *source,
<span class="udiff-line-modified-removed">-                GSourceFuncs *funcs)</span>
<span class="udiff-line-modified-added">+              GSourceFuncs *funcs)</span>
  {
    g_return_if_fail (source != NULL);
    g_return_if_fail (source-&gt;context == NULL);
<span class="udiff-line-modified-removed">-   g_return_if_fail (source-&gt;ref_count &gt; 0);</span>
<span class="udiff-line-modified-added">+   g_return_if_fail (g_atomic_int_get (&amp;source-&gt;ref_count) &gt; 0);</span>
    g_return_if_fail (funcs != NULL);
  
    source-&gt;source_funcs = funcs;
  }
  
  static void
  g_source_set_priority_unlocked (GSource      *source,
<span class="udiff-line-modified-removed">-                 GMainContext *context,</span>
<span class="udiff-line-modified-removed">-                 gint          priority)</span>
<span class="udiff-line-modified-added">+         GMainContext *context,</span>
<span class="udiff-line-modified-added">+         gint          priority)</span>
  {
    GSList *tmp_list;
  
  #ifdef GSTREAMER_LITE
    if (source == NULL || source-&gt;priv == NULL || source-&gt;priv-&gt;parent_source == NULL)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1731,11 +1739,11 @@</span>
    if (context == NULL)
      return;
  #endif // GSTREAMER_LITE
  
    g_return_if_fail (source-&gt;priv-&gt;parent_source == NULL ||
<span class="udiff-line-modified-removed">-             source-&gt;priv-&gt;parent_source-&gt;priority == priority);</span>
<span class="udiff-line-modified-added">+         source-&gt;priv-&gt;parent_source-&gt;priority == priority);</span>
  
    TRACE (GLIB_SOURCE_SET_PRIORITY (source, context, priority));
  
    if (context)
      {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1750,36 +1758,36 @@</span>
    if (context)
      {
        source_add_to_context (source, source-&gt;context);
  
        if (!SOURCE_BLOCKED (source))
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       tmp_list = source-&gt;poll_fds;</span>
<span class="udiff-line-modified-removed">-       while (tmp_list)</span>
<span class="udiff-line-modified-removed">-         {</span>
<span class="udiff-line-modified-removed">-           g_main_context_remove_poll_unlocked (context, tmp_list-&gt;data);</span>
<span class="udiff-line-modified-removed">-           g_main_context_add_poll_unlocked (context, priority, tmp_list-&gt;data);</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     tmp_list = source-&gt;poll_fds;</span>
<span class="udiff-line-modified-added">+     while (tmp_list)</span>
<span class="udiff-line-modified-added">+       {</span>
<span class="udiff-line-modified-added">+         g_main_context_remove_poll_unlocked (context, tmp_list-&gt;data);</span>
<span class="udiff-line-modified-added">+         g_main_context_add_poll_unlocked (context, priority, tmp_list-&gt;data);</span>
  
<span class="udiff-line-modified-removed">-           tmp_list = tmp_list-&gt;next;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-added">+         tmp_list = tmp_list-&gt;next;</span>
<span class="udiff-line-modified-added">+       }</span>
  
            for (tmp_list = source-&gt;priv-&gt;fds; tmp_list; tmp_list = tmp_list-&gt;next)
              {
                g_main_context_remove_poll_unlocked (context, tmp_list-&gt;data);
                g_main_context_add_poll_unlocked (context, priority, tmp_list-&gt;data);
              }
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   }</span>
      }
  
    if (source-&gt;priv-&gt;child_sources)
      {
        tmp_list = source-&gt;priv-&gt;child_sources;
        while (tmp_list)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       g_source_set_priority_unlocked (tmp_list-&gt;data, context, priority);</span>
<span class="udiff-line-modified-removed">-       tmp_list = tmp_list-&gt;next;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     g_source_set_priority_unlocked (tmp_list-&gt;data, context, priority);</span>
<span class="udiff-line-modified-added">+     tmp_list = tmp_list-&gt;next;</span>
<span class="udiff-line-modified-added">+   }</span>
      }
  }
  
  /**
   * g_source_set_priority:
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1795,11 +1803,11 @@</span>
   * permitted to change the priority of a source once it has been added
   * as a child of another source.
   **/
  void
  g_source_set_priority (GSource  *source,
<span class="udiff-line-modified-removed">-                gint      priority)</span>
<span class="udiff-line-modified-added">+            gint      priority)</span>
  {
    GMainContext *context;
  
  #ifdef GSTREAMER_LITE
    if (source == NULL || source-&gt;priv == NULL || source-&gt;priv-&gt;parent_source == NULL)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1943,11 +1951,11 @@</span>
   * will be processed normally. Otherwise, all processing of this
   * source is blocked until the dispatch function returns.
   **/
  void
  g_source_set_can_recurse (GSource  *source,
<span class="udiff-line-modified-removed">-               gboolean  can_recurse)</span>
<span class="udiff-line-modified-added">+         gboolean  can_recurse)</span>
  {
    GMainContext *context;
  
    g_return_if_fail (source != NULL);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2102,44 +2110,33 @@</span>
   * Returns: @source
   **/
  GSource *
  g_source_ref (GSource *source)
  {
<span class="udiff-line-removed">-   GMainContext *context;</span>
<span class="udiff-line-removed">- </span>
    g_return_val_if_fail (source != NULL, NULL);
  
<span class="udiff-line-modified-removed">-   context = source-&gt;context;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   if (context)</span>
<span class="udiff-line-removed">-     LOCK_CONTEXT (context);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   source-&gt;ref_count++;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   if (context)</span>
<span class="udiff-line-removed">-     UNLOCK_CONTEXT (context);</span>
<span class="udiff-line-modified-added">+   g_atomic_int_inc (&amp;source-&gt;ref_count);</span>
  
    return source;
  }
  
  /* g_source_unref() but possible to call within context lock
   */
  static void
  g_source_unref_internal (GSource      *source,
<span class="udiff-line-modified-removed">-              GMainContext *context,</span>
<span class="udiff-line-modified-removed">-              gboolean      have_lock)</span>
<span class="udiff-line-modified-added">+        GMainContext *context,</span>
<span class="udiff-line-modified-added">+        gboolean      have_lock)</span>
  {
    gpointer old_cb_data = NULL;
    GSourceCallbackFuncs *old_cb_funcs = NULL;
  
    g_return_if_fail (source != NULL);
  
    if (!have_lock &amp;&amp; context)
      LOCK_CONTEXT (context);
  
<span class="udiff-line-modified-removed">-   source-&gt;ref_count--;</span>
<span class="udiff-line-removed">-   if (source-&gt;ref_count == 0)</span>
<span class="udiff-line-modified-added">+   if (g_atomic_int_dec_and_test (&amp;source-&gt;ref_count))</span>
      {
        TRACE (GLIB_SOURCE_BEFORE_FREE (source, context,
                                        source-&gt;source_funcs-&gt;finalize));
  
        old_cb_data = source-&gt;callback_data;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2147,44 +2144,44 @@</span>
  
        source-&gt;callback_data = NULL;
        source-&gt;callback_funcs = NULL;
  
        if (context)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       if (!SOURCE_DESTROYED (source))</span>
<span class="udiff-line-modified-removed">-         g_warning (G_STRLOC &quot;: ref_count == 0, but source was still attached to a context!&quot;);</span>
<span class="udiff-line-modified-removed">-       source_remove_from_context (source, context);</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     if (!SOURCE_DESTROYED (source))</span>
<span class="udiff-line-modified-added">+       g_warning (G_STRLOC &quot;: ref_count == 0, but source was still attached to a context!&quot;);</span>
<span class="udiff-line-modified-added">+     source_remove_from_context (source, context);</span>
  
            g_hash_table_remove (context-&gt;sources, GUINT_TO_POINTER (source-&gt;source_id));
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   }</span>
  
        if (source-&gt;source_funcs-&gt;finalize)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-added">+   {</span>
            /* Temporarily increase the ref count again so that GSource methods
             * can be called from finalize(). */
<span class="udiff-line-modified-removed">-           source-&gt;ref_count++;</span>
<span class="udiff-line-modified-removed">-       if (context)</span>
<span class="udiff-line-modified-removed">-         UNLOCK_CONTEXT (context);</span>
<span class="udiff-line-modified-removed">-       source-&gt;source_funcs-&gt;finalize (source);</span>
<span class="udiff-line-modified-removed">-       if (context)</span>
<span class="udiff-line-modified-removed">-         LOCK_CONTEXT (context);</span>
<span class="udiff-line-modified-removed">-           source-&gt;ref_count--;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+           g_atomic_int_inc (&amp;source-&gt;ref_count);</span>
<span class="udiff-line-modified-added">+     if (context)</span>
<span class="udiff-line-modified-added">+       UNLOCK_CONTEXT (context);</span>
<span class="udiff-line-modified-added">+     source-&gt;source_funcs-&gt;finalize (source);</span>
<span class="udiff-line-modified-added">+     if (context)</span>
<span class="udiff-line-modified-added">+       LOCK_CONTEXT (context);</span>
<span class="udiff-line-modified-added">+           g_atomic_int_add (&amp;source-&gt;ref_count, -1);</span>
<span class="udiff-line-modified-added">+   }</span>
  
        if (old_cb_funcs)
          {
            /* Temporarily increase the ref count again so that GSource methods
             * can be called from callback_funcs.unref(). */
<span class="udiff-line-modified-removed">-           source-&gt;ref_count++;</span>
<span class="udiff-line-modified-added">+           g_atomic_int_inc (&amp;source-&gt;ref_count);</span>
            if (context)
              UNLOCK_CONTEXT (context);
  
            old_cb_funcs-&gt;unref (old_cb_data);
  
            if (context)
              LOCK_CONTEXT (context);
<span class="udiff-line-modified-removed">-           source-&gt;ref_count--;</span>
<span class="udiff-line-modified-added">+           g_atomic_int_add (&amp;source-&gt;ref_count, -1);</span>
          }
  
        g_free (source-&gt;name);
        source-&gt;name = NULL;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2210,11 +2207,11 @@</span>
        g_free (source);
      }
  
    if (!have_lock &amp;&amp; context)
      UNLOCK_CONTEXT (context);
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+ }</span>
  
  /**
   * g_source_unref:
   * @source: a #GSource
   *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2239,11 +2236,11 @@</span>
   * @context: (nullable): a #GMainContext (if %NULL, the default context will be used)
   * @source_id: the source ID, as returned by g_source_get_id().
   *
   * Finds a #GSource given a pair of context and ID.
   *
<span class="udiff-line-modified-removed">-  * It is a programmer error to attempt to lookup a non-existent source.</span>
<span class="udiff-line-modified-added">+  * It is a programmer error to attempt to look up a non-existent source.</span>
   *
   * More specifically: source IDs can be reissued after a source has been
   * destroyed and therefore it is never valid to use this function with a
   * source ID which may have already been removed.  An example is when
   * scheduling an idle to run in another thread with g_idle_add(): the
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2287,12 +2284,12 @@</span>
   *
   * Returns: (transfer none): the source, if one was found, otherwise %NULL
   **/
  GSource *
  g_main_context_find_source_by_funcs_user_data (GMainContext *context,
<span class="udiff-line-modified-removed">-                            GSourceFuncs *funcs,</span>
<span class="udiff-line-modified-removed">-                            gpointer      user_data)</span>
<span class="udiff-line-modified-added">+                  GSourceFuncs *funcs,</span>
<span class="udiff-line-modified-added">+                  gpointer      user_data)</span>
  {
    GSourceIter iter;
    GSource *source;
  
    g_return_val_if_fail (funcs != NULL, NULL);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2304,21 +2301,21 @@</span>
  
    g_source_iter_init (&amp;iter, context, FALSE);
    while (g_source_iter_next (&amp;iter, &amp;source))
      {
        if (!SOURCE_DESTROYED (source) &amp;&amp;
<span class="udiff-line-modified-removed">-       source-&gt;source_funcs == funcs &amp;&amp;</span>
<span class="udiff-line-modified-removed">-       source-&gt;callback_funcs)</span>
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       GSourceFunc callback;</span>
<span class="udiff-line-modified-removed">-       gpointer callback_data;</span>
<span class="udiff-line-modified-added">+     source-&gt;source_funcs == funcs &amp;&amp;</span>
<span class="udiff-line-modified-added">+     source-&gt;callback_funcs)</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     GSourceFunc callback;</span>
<span class="udiff-line-modified-added">+     gpointer callback_data;</span>
  
<span class="udiff-line-modified-removed">-       source-&gt;callback_funcs-&gt;get (source-&gt;callback_data, source, &amp;callback, &amp;callback_data);</span>
<span class="udiff-line-modified-added">+     source-&gt;callback_funcs-&gt;get (source-&gt;callback_data, source, &amp;callback, &amp;callback_data);</span>
  
<span class="udiff-line-modified-removed">-       if (callback_data == user_data)</span>
<span class="udiff-line-modified-removed">-         break;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+     if (callback_data == user_data)</span>
<span class="udiff-line-modified-added">+       break;</span>
<span class="udiff-line-modified-added">+   }</span>
      }
    g_source_iter_clear (&amp;iter);
  
    UNLOCK_CONTEXT (context);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2336,11 +2333,11 @@</span>
   *
   * Returns: (transfer none): the source, if one was found, otherwise %NULL
   **/
  GSource *
  g_main_context_find_source_by_user_data (GMainContext *context,
<span class="udiff-line-modified-removed">-                      gpointer      user_data)</span>
<span class="udiff-line-modified-added">+            gpointer      user_data)</span>
  {
    GSourceIter iter;
    GSource *source;
  
    if (context == NULL)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2350,20 +2347,20 @@</span>
  
    g_source_iter_init (&amp;iter, context, FALSE);
    while (g_source_iter_next (&amp;iter, &amp;source))
      {
        if (!SOURCE_DESTROYED (source) &amp;&amp;
<span class="udiff-line-modified-removed">-       source-&gt;callback_funcs)</span>
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       GSourceFunc callback;</span>
<span class="udiff-line-modified-removed">-       gpointer callback_data = NULL;</span>
<span class="udiff-line-modified-added">+     source-&gt;callback_funcs)</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     GSourceFunc callback;</span>
<span class="udiff-line-modified-added">+     gpointer callback_data = NULL;</span>
  
<span class="udiff-line-modified-removed">-       source-&gt;callback_funcs-&gt;get (source-&gt;callback_data, source, &amp;callback, &amp;callback_data);</span>
<span class="udiff-line-modified-added">+     source-&gt;callback_funcs-&gt;get (source-&gt;callback_data, source, &amp;callback, &amp;callback_data);</span>
  
<span class="udiff-line-modified-removed">-       if (callback_data == user_data)</span>
<span class="udiff-line-modified-removed">-         break;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+     if (callback_data == user_data)</span>
<span class="udiff-line-modified-added">+       break;</span>
<span class="udiff-line-modified-added">+   }</span>
      }
    g_source_iter_clear (&amp;iter);
  
    UNLOCK_CONTEXT (context);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2448,11 +2445,11 @@</span>
   *
   * Returns: %TRUE if a source was found and removed.
   **/
  gboolean
  g_source_remove_by_funcs_user_data (GSourceFuncs *funcs,
<span class="udiff-line-modified-removed">-                     gpointer      user_data)</span>
<span class="udiff-line-modified-added">+             gpointer      user_data)</span>
  {
    GSource *source;
  
    g_return_val_if_fail (funcs != NULL, FALSE);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2684,43 +2681,28 @@</span>
   * @result: #GTimeVal structure in which to store current time.
   *
   * Equivalent to the UNIX gettimeofday() function, but portable.
   *
   * You may find g_get_real_time() to be more convenient.
<span class="udiff-line-added">+  *</span>
<span class="udiff-line-added">+  * Deprecated: 2.62: #GTimeVal is not year-2038-safe. Use g_get_real_time()</span>
<span class="udiff-line-added">+  *    instead.</span>
   **/
<span class="udiff-line-added">+ G_GNUC_BEGIN_IGNORE_DEPRECATIONS</span>
  void
  g_get_current_time (GTimeVal *result)
  {
<span class="udiff-line-modified-removed">- #ifndef G_OS_WIN32</span>
<span class="udiff-line-removed">-   struct timeval r;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   g_return_if_fail (result != NULL);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   /*this is required on alpha, there the timeval structs are int&#39;s</span>
<span class="udiff-line-removed">-     not longs and a cast only would fail horribly*/</span>
<span class="udiff-line-removed">-   gettimeofday (&amp;r, NULL);</span>
<span class="udiff-line-removed">-   result-&gt;tv_sec = r.tv_sec;</span>
<span class="udiff-line-removed">-   result-&gt;tv_usec = r.tv_usec;</span>
<span class="udiff-line-removed">- #else</span>
<span class="udiff-line-removed">-   FILETIME ft;</span>
<span class="udiff-line-removed">-   guint64 time64;</span>
<span class="udiff-line-modified-added">+   gint64 tv;</span>
  
    g_return_if_fail (result != NULL);
  
<span class="udiff-line-modified-removed">-   GetSystemTimeAsFileTime (&amp;ft);</span>
<span class="udiff-line-removed">-   memmove (&amp;time64, &amp;ft, sizeof (FILETIME));</span>
<span class="udiff-line-modified-added">+   tv = g_get_real_time ();</span>
  
<span class="udiff-line-modified-removed">-   /* Convert from 100s of nanoseconds since 1601-01-01</span>
<span class="udiff-line-modified-removed">-    * to Unix epoch. Yes, this is Y2038 unsafe.</span>
<span class="udiff-line-removed">-    */</span>
<span class="udiff-line-removed">-   time64 -= G_GINT64_CONSTANT (116444736000000000);</span>
<span class="udiff-line-removed">-   time64 /= 10;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-   result-&gt;tv_sec = time64 / 1000000;</span>
<span class="udiff-line-removed">-   result-&gt;tv_usec = time64 % 1000000;</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-modified-added">+   result-&gt;tv_sec = tv / 1000000;</span>
<span class="udiff-line-modified-added">+   result-&gt;tv_usec = tv % 1000000;</span>
  }
<span class="udiff-line-added">+ G_GNUC_END_IGNORE_DEPRECATIONS</span>
  
  /**
   * g_get_real_time:
   *
   * Queries the system wall-clock time.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2738,15 +2720,33 @@</span>
   * Since: 2.28
   **/
  gint64
  g_get_real_time (void)
  {
<span class="udiff-line-modified-removed">-   GTimeVal tv;</span>
<span class="udiff-line-modified-added">+ #ifndef G_OS_WIN32</span>
<span class="udiff-line-added">+   struct timeval r;</span>
  
<span class="udiff-line-modified-removed">-   g_get_current_time (&amp;tv);</span>
<span class="udiff-line-modified-added">+   /* this is required on alpha, there the timeval structs are ints</span>
<span class="udiff-line-added">+    * not longs and a cast only would fail horribly */</span>
<span class="udiff-line-added">+   gettimeofday (&amp;r, NULL);</span>
  
<span class="udiff-line-modified-removed">-   return (((gint64) tv.tv_sec) * 1000000) + tv.tv_usec;</span>
<span class="udiff-line-modified-added">+   return (((gint64) r.tv_sec) * 1000000) + r.tv_usec;</span>
<span class="udiff-line-added">+ #else</span>
<span class="udiff-line-added">+   FILETIME ft;</span>
<span class="udiff-line-added">+   guint64 time64;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   GetSystemTimeAsFileTime (&amp;ft);</span>
<span class="udiff-line-added">+   memmove (&amp;time64, &amp;ft, sizeof (FILETIME));</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   /* Convert from 100s of nanoseconds since 1601-01-01</span>
<span class="udiff-line-added">+    * to Unix epoch. This is Y2038 safe.</span>
<span class="udiff-line-added">+    */</span>
<span class="udiff-line-added">+   time64 -= G_GINT64_CONSTANT (116444736000000000);</span>
<span class="udiff-line-added">+   time64 /= 10;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   return time64;</span>
<span class="udiff-line-added">+ #endif</span>
  }
  
  /**
   * g_get_monotonic_time:
   *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2783,11 +2783,11 @@</span>
    if (!QueryPerformanceFrequency (&amp;freq) || freq.QuadPart == 0)
      {
        /* The documentation says that this should never happen */
        g_assert_not_reached ();
        return;
<span class="udiff-line-modified-removed">- }</span>
<span class="udiff-line-modified-added">+     }</span>
  
    g_monotonic_usec_per_tick = (gdouble)G_USEC_PER_SEC / freq.QuadPart;
  }
  
  gint64
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2803,11 +2803,11 @@</span>
        g_warning (&quot;QueryPerformanceCounter Failed (%lu)&quot;, GetLastError ());
        g_monotonic_usec_per_tick = 0;
      }
  
    return 0;
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-added">+ }</span>
  #elif defined(HAVE_MACH_MACH_TIME_H) /* Mac OS */
  gint64
  g_get_monotonic_time (void)
  {
    static mach_timebase_info_data_t timebase_info;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2869,11 +2869,11 @@</span>
  #endif
  
  static void
  g_main_dispatch_free (gpointer dispatch)
  {
<span class="udiff-line-modified-removed">-   g_slice_free (GMainDispatch, dispatch);</span>
<span class="udiff-line-modified-added">+   g_free (dispatch);</span>
  }
  
  /* Running the main loop */
  
  static GMainDispatch *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2883,14 +2883,11 @@</span>
    GMainDispatch *dispatch;
  
    dispatch = g_private_get (&amp;depth_private);
  
    if (!dispatch)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-removed">-       dispatch = g_slice_new0 (GMainDispatch);</span>
<span class="udiff-line-removed">-       g_private_set (&amp;depth_private, dispatch);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+     dispatch = g_private_set_alloc0 (&amp;depth_private, sizeof (GMainDispatch));</span>
  
    return dispatch;
  }
  
  /**
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3133,14 +3130,14 @@</span>
  
    if (source-&gt;priv &amp;&amp; source-&gt;priv-&gt;child_sources)
      {
        tmp_list = source-&gt;priv-&gt;child_sources;
        while (tmp_list)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       block_source (tmp_list-&gt;data);</span>
<span class="udiff-line-modified-removed">-       tmp_list = tmp_list-&gt;next;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     block_source (tmp_list-&gt;data);</span>
<span class="udiff-line-modified-added">+     tmp_list = tmp_list-&gt;next;</span>
<span class="udiff-line-modified-added">+   }</span>
      }
  }
  
  /* HOLDS: source-&gt;context&#39;s lock */
  static void
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3165,14 +3162,14 @@</span>
  
    if (source-&gt;priv &amp;&amp; source-&gt;priv-&gt;child_sources)
      {
        tmp_list = source-&gt;priv-&gt;child_sources;
        while (tmp_list)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       unblock_source (tmp_list-&gt;data);</span>
<span class="udiff-line-modified-removed">-       tmp_list = tmp_list-&gt;next;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     unblock_source (tmp_list-&gt;data);</span>
<span class="udiff-line-modified-added">+     tmp_list = tmp_list-&gt;next;</span>
<span class="udiff-line-modified-added">+   }</span>
      }
  }
  
  /* HOLDS: context&#39;s lock */
  static void
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3189,40 +3186,40 @@</span>
        g_assert (source);
  
        source-&gt;flags &amp;= ~G_SOURCE_READY;
  
        if (!SOURCE_DESTROYED (source))
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       gboolean was_in_call;</span>
<span class="udiff-line-modified-removed">-       gpointer user_data = NULL;</span>
<span class="udiff-line-modified-removed">-       GSourceFunc callback = NULL;</span>
<span class="udiff-line-modified-removed">-       GSourceCallbackFuncs *cb_funcs;</span>
<span class="udiff-line-modified-removed">-       gpointer cb_data;</span>
<span class="udiff-line-modified-removed">-       gboolean need_destroy;</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-       gboolean (*dispatch) (GSource *,</span>
<span class="udiff-line-modified-removed">-                 GSourceFunc,</span>
<span class="udiff-line-modified-removed">-                 gpointer);</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     gboolean was_in_call;</span>
<span class="udiff-line-modified-added">+     gpointer user_data = NULL;</span>
<span class="udiff-line-modified-added">+     GSourceFunc callback = NULL;</span>
<span class="udiff-line-modified-added">+     GSourceCallbackFuncs *cb_funcs;</span>
<span class="udiff-line-modified-added">+     gpointer cb_data;</span>
<span class="udiff-line-modified-added">+     gboolean need_destroy;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     gboolean (*dispatch) (GSource *,</span>
<span class="udiff-line-modified-added">+         GSourceFunc,</span>
<span class="udiff-line-modified-added">+         gpointer);</span>
            GSource *prev_source;
  
<span class="udiff-line-modified-removed">-       dispatch = source-&gt;source_funcs-&gt;dispatch;</span>
<span class="udiff-line-modified-removed">-       cb_funcs = source-&gt;callback_funcs;</span>
<span class="udiff-line-modified-removed">-       cb_data = source-&gt;callback_data;</span>
<span class="udiff-line-modified-added">+     dispatch = source-&gt;source_funcs-&gt;dispatch;</span>
<span class="udiff-line-modified-added">+     cb_funcs = source-&gt;callback_funcs;</span>
<span class="udiff-line-modified-added">+     cb_data = source-&gt;callback_data;</span>
  
<span class="udiff-line-modified-removed">-       if (cb_funcs)</span>
<span class="udiff-line-modified-removed">-         cb_funcs-&gt;ref (cb_data);</span>
<span class="udiff-line-modified-added">+     if (cb_funcs)</span>
<span class="udiff-line-modified-added">+       cb_funcs-&gt;ref (cb_data);</span>
  
<span class="udiff-line-modified-removed">-       if ((source-&gt;flags &amp; G_SOURCE_CAN_RECURSE) == 0)</span>
<span class="udiff-line-modified-removed">-         block_source (source);</span>
<span class="udiff-line-modified-added">+     if ((source-&gt;flags &amp; G_SOURCE_CAN_RECURSE) == 0)</span>
<span class="udiff-line-modified-added">+       block_source (source);</span>
  
<span class="udiff-line-modified-removed">-       was_in_call = source-&gt;flags &amp; G_HOOK_FLAG_IN_CALL;</span>
<span class="udiff-line-modified-removed">-       source-&gt;flags |= G_HOOK_FLAG_IN_CALL;</span>
<span class="udiff-line-modified-added">+     was_in_call = source-&gt;flags &amp; G_HOOK_FLAG_IN_CALL;</span>
<span class="udiff-line-modified-added">+     source-&gt;flags |= G_HOOK_FLAG_IN_CALL;</span>
  
<span class="udiff-line-modified-removed">-       if (cb_funcs)</span>
<span class="udiff-line-modified-removed">-         cb_funcs-&gt;get (cb_data, source, &amp;callback, &amp;user_data);</span>
<span class="udiff-line-modified-added">+     if (cb_funcs)</span>
<span class="udiff-line-modified-added">+       cb_funcs-&gt;get (cb_data, source, &amp;callback, &amp;user_data);</span>
  
<span class="udiff-line-modified-removed">-       UNLOCK_CONTEXT (context);</span>
<span class="udiff-line-modified-added">+     UNLOCK_CONTEXT (context);</span>
  
            /* These operations are safe because &#39;current&#39; is thread-local
             * and not modified from anywhere but this function.
             */
            prev_source = current-&gt;source;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3236,32 +3233,32 @@</span>
                                             dispatch, need_destroy));
  
            current-&gt;source = prev_source;
            current-&gt;depth--;
  
<span class="udiff-line-modified-removed">-       if (cb_funcs)</span>
<span class="udiff-line-modified-removed">-         cb_funcs-&gt;unref (cb_data);</span>
<span class="udiff-line-modified-added">+     if (cb_funcs)</span>
<span class="udiff-line-modified-added">+       cb_funcs-&gt;unref (cb_data);</span>
  
<span class="udiff-line-modified-removed">-       LOCK_CONTEXT (context);</span>
<span class="udiff-line-modified-added">+     LOCK_CONTEXT (context);</span>
  
<span class="udiff-line-modified-removed">-       if (!was_in_call)</span>
<span class="udiff-line-modified-removed">-         source-&gt;flags &amp;= ~G_HOOK_FLAG_IN_CALL;</span>
<span class="udiff-line-modified-added">+     if (!was_in_call)</span>
<span class="udiff-line-modified-added">+       source-&gt;flags &amp;= ~G_HOOK_FLAG_IN_CALL;</span>
  
<span class="udiff-line-modified-removed">-       if (SOURCE_BLOCKED (source) &amp;&amp; !SOURCE_DESTROYED (source))</span>
<span class="udiff-line-modified-removed">-         unblock_source (source);</span>
<span class="udiff-line-modified-added">+     if (SOURCE_BLOCKED (source) &amp;&amp; !SOURCE_DESTROYED (source))</span>
<span class="udiff-line-modified-added">+       unblock_source (source);</span>
  
<span class="udiff-line-modified-removed">-       /* Note: this depends on the fact that we can&#39;t switch</span>
<span class="udiff-line-modified-removed">-        * sources from one main context to another</span>
<span class="udiff-line-modified-removed">-        */</span>
<span class="udiff-line-modified-removed">-       if (need_destroy &amp;&amp; !SOURCE_DESTROYED (source))</span>
<span class="udiff-line-modified-removed">-         {</span>
<span class="udiff-line-modified-removed">-           g_assert (source-&gt;context == context);</span>
<span class="udiff-line-modified-removed">-           g_source_destroy_internal (source, context, TRUE);</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+     /* Note: this depends on the fact that we can&#39;t switch</span>
<span class="udiff-line-modified-added">+      * sources from one main context to another</span>
<span class="udiff-line-modified-added">+      */</span>
<span class="udiff-line-modified-added">+     if (need_destroy &amp;&amp; !SOURCE_DESTROYED (source))</span>
<span class="udiff-line-modified-added">+       {</span>
<span class="udiff-line-modified-added">+         g_assert (source-&gt;context == context);</span>
<span class="udiff-line-modified-added">+         g_source_destroy_internal (source, context, TRUE);</span>
<span class="udiff-line-modified-added">+       }</span>
<span class="udiff-line-modified-added">+   }</span>
  
<span class="udiff-line-modified-removed">-       SOURCE_UNREF (source, context);</span>
<span class="udiff-line-modified-added">+       g_source_unref_internal (source, context, TRUE);</span>
      }
  
    g_ptr_array_set_size (context-&gt;pending_dispatches, 0);
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3339,32 +3336,32 @@</span>
        TRACE (GLIB_MAIN_CONTEXT_RELEASE (context));
  
        context-&gt;owner = NULL;
  
        if (context-&gt;waiters)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       GMainWaiter *waiter = context-&gt;waiters-&gt;data;</span>
<span class="udiff-line-modified-removed">-       gboolean loop_internal_waiter = (waiter-&gt;mutex == &amp;context-&gt;mutex);</span>
<span class="udiff-line-modified-removed">-       context-&gt;waiters = g_slist_delete_link (context-&gt;waiters,</span>
<span class="udiff-line-modified-removed">-                           context-&gt;waiters);</span>
<span class="udiff-line-modified-removed">-       if (!loop_internal_waiter)</span>
<span class="udiff-line-modified-removed">-         g_mutex_lock (waiter-&gt;mutex);</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     GMainWaiter *waiter = context-&gt;waiters-&gt;data;</span>
<span class="udiff-line-modified-added">+     gboolean loop_internal_waiter = (waiter-&gt;mutex == &amp;context-&gt;mutex);</span>
<span class="udiff-line-modified-added">+     context-&gt;waiters = g_slist_delete_link (context-&gt;waiters,</span>
<span class="udiff-line-modified-added">+               context-&gt;waiters);</span>
<span class="udiff-line-modified-added">+     if (!loop_internal_waiter)</span>
<span class="udiff-line-modified-added">+       g_mutex_lock (waiter-&gt;mutex);</span>
  
<span class="udiff-line-modified-removed">-       g_cond_signal (waiter-&gt;cond);</span>
<span class="udiff-line-modified-added">+     g_cond_signal (waiter-&gt;cond);</span>
  
<span class="udiff-line-modified-removed">-       if (!loop_internal_waiter)</span>
<span class="udiff-line-modified-removed">-         g_mutex_unlock (waiter-&gt;mutex);</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+     if (!loop_internal_waiter)</span>
<span class="udiff-line-modified-added">+       g_mutex_unlock (waiter-&gt;mutex);</span>
<span class="udiff-line-modified-added">+   }</span>
      }
  
    UNLOCK_CONTEXT (context);
  }
  
  static gboolean
  g_main_context_wait_internal (GMainContext *context,
<span class="udiff-line-modified-removed">-              GCond        *cond,</span>
<span class="udiff-line-modified-removed">-              GMutex       *mutex)</span>
<span class="udiff-line-modified-added">+                               GCond        *cond,</span>
<span class="udiff-line-modified-added">+                               GMutex       *mutex)</span>
  {
    gboolean result = FALSE;
    GThread *self = G_THREAD_SELF;
    gboolean loop_internal_waiter;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3384,14 +3381,14 @@</span>
        waiter.mutex = mutex;
  
        context-&gt;waiters = g_slist_append (context-&gt;waiters, &amp;waiter);
  
        if (!loop_internal_waiter)
<span class="udiff-line-modified-removed">-     UNLOCK_CONTEXT (context);</span>
<span class="udiff-line-modified-added">+         UNLOCK_CONTEXT (context);</span>
        g_cond_wait (cond, mutex);
        if (!loop_internal_waiter)
<span class="udiff-line-modified-removed">-     LOCK_CONTEXT (context);</span>
<span class="udiff-line-modified-added">+         LOCK_CONTEXT (context);</span>
  
        context-&gt;waiters = g_slist_remove (context-&gt;waiters, &amp;waiter);
      }
  
    if (!context-&gt;owner)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3452,11 +3449,11 @@</span>
  }
  
  /**
   * g_main_context_prepare:
   * @context: a #GMainContext
<span class="udiff-line-modified-removed">-  * @priority: location to store priority of highest priority</span>
<span class="udiff-line-modified-added">+  * @priority: (out) (optional): location to store priority of highest priority</span>
   *            source already ready.
   *
   * Prepares to poll sources within a main loop. The resulting information
   * for polling is determined by calling g_main_context_query ().
   *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3466,11 +3463,11 @@</span>
   * Returns: %TRUE if some source is ready to be dispatched
   *               prior to polling.
   **/
  gboolean
  g_main_context_prepare (GMainContext *context,
<span class="udiff-line-modified-removed">-             gint         *priority)</span>
<span class="udiff-line-modified-added">+       gint         *priority)</span>
  {
    guint i;
    gint n_ready = 0;
    gint current_priority = G_MAXINT;
    GSource *source;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3484,11 +3481,11 @@</span>
    context-&gt;time_is_fresh = FALSE;
  
    if (context-&gt;in_check_or_prepare)
      {
        g_warning (&quot;g_main_context_prepare() called recursively from within a source&#39;s check() or &quot;
<span class="udiff-line-modified-removed">-          &quot;prepare() member.&quot;);</span>
<span class="udiff-line-modified-added">+      &quot;prepare() member.&quot;);</span>
        UNLOCK_CONTEXT (context);
        return FALSE;
      }
  
    TRACE (GLIB_MAIN_CONTEXT_BEFORE_PREPARE (context));
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3496,11 +3493,11 @@</span>
  #if 0
    /* If recursing, finish up current dispatch, before starting over */
    if (context-&gt;pending_dispatches)
      {
        if (dispatch)
<span class="udiff-line-modified-removed">-     g_main_dispatch (context, &amp;current_time);</span>
<span class="udiff-line-modified-added">+   g_main_dispatch (context, &amp;current_time);</span>
  
        UNLOCK_CONTEXT (context);
        return TRUE;
      }
  #endif
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3508,11 +3505,11 @@</span>
    /* If recursing, clear list of pending dispatches */
  
    for (i = 0; i &lt; context-&gt;pending_dispatches-&gt;len; i++)
      {
        if (context-&gt;pending_dispatches-&gt;pdata[i])
<span class="udiff-line-modified-removed">-     SOURCE_UNREF ((GSource *)context-&gt;pending_dispatches-&gt;pdata[i], context);</span>
<span class="udiff-line-modified-added">+         g_source_unref_internal ((GSource *)context-&gt;pending_dispatches-&gt;pdata[i], context, TRUE);</span>
      }
    g_ptr_array_set_size (context-&gt;pending_dispatches, 0);
  
    /* Prepare all sources */
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3522,18 +3519,18 @@</span>
    while (g_source_iter_next (&amp;iter, &amp;source))
      {
        gint source_timeout = -1;
  
        if (SOURCE_DESTROYED (source) || SOURCE_BLOCKED (source))
<span class="udiff-line-modified-removed">-     continue;</span>
<span class="udiff-line-modified-added">+   continue;</span>
        if ((n_ready &gt; 0) &amp;&amp; (source-&gt;priority &gt; current_priority))
<span class="udiff-line-modified-removed">-     break;</span>
<span class="udiff-line-modified-added">+   break;</span>
  
        if (!(source-&gt;flags &amp; G_SOURCE_READY))
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       gboolean result;</span>
<span class="udiff-line-modified-removed">-       gboolean (* prepare) (GSource  *source,</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     gboolean result;</span>
<span class="udiff-line-modified-added">+     gboolean (* prepare) (GSource  *source,</span>
                                  gint     *timeout);
  
            prepare = source-&gt;source_funcs-&gt;prepare;
  
            if (prepare)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3566,46 +3563,46 @@</span>
                    source_timeout = 0;
                    result = TRUE;
                  }
                else
                  {
<span class="udiff-line-modified-removed">-                   gint timeout;</span>
<span class="udiff-line-modified-added">+                   gint64 timeout;</span>
  
                    /* rounding down will lead to spinning, so always round up */
                    timeout = (source-&gt;priv-&gt;ready_time - context-&gt;time + 999) / 1000;
  
                    if (source_timeout &lt; 0 || timeout &lt; source_timeout)
<span class="udiff-line-modified-removed">-                     source_timeout = timeout;</span>
<span class="udiff-line-modified-added">+                     source_timeout = MIN (timeout, G_MAXINT);</span>
                  }
              }
  
<span class="udiff-line-modified-removed">-       if (result)</span>
<span class="udiff-line-modified-removed">-         {</span>
<span class="udiff-line-modified-removed">-           GSource *ready_source = source;</span>
<span class="udiff-line-modified-added">+     if (result)</span>
<span class="udiff-line-modified-added">+       {</span>
<span class="udiff-line-modified-added">+         GSource *ready_source = source;</span>
  
<span class="udiff-line-modified-removed">-           while (ready_source)</span>
<span class="udiff-line-modified-removed">-         {</span>
<span class="udiff-line-modified-removed">-           ready_source-&gt;flags |= G_SOURCE_READY;</span>
<span class="udiff-line-modified-removed">-           ready_source = ready_source-&gt;priv-&gt;parent_source;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+         while (ready_source)</span>
<span class="udiff-line-modified-added">+     {</span>
<span class="udiff-line-modified-added">+       ready_source-&gt;flags |= G_SOURCE_READY;</span>
<span class="udiff-line-modified-added">+       ready_source = ready_source-&gt;priv-&gt;parent_source;</span>
      }
<span class="udiff-line-added">+       }</span>
<span class="udiff-line-added">+   }</span>
  
        if (source-&gt;flags &amp; G_SOURCE_READY)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       n_ready++;</span>
<span class="udiff-line-modified-removed">-       current_priority = source-&gt;priority;</span>
<span class="udiff-line-modified-removed">-       context-&gt;timeout = 0;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     n_ready++;</span>
<span class="udiff-line-modified-added">+     current_priority = source-&gt;priority;</span>
<span class="udiff-line-modified-added">+     context-&gt;timeout = 0;</span>
<span class="udiff-line-modified-added">+   }</span>
  
        if (source_timeout &gt;= 0)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       if (context-&gt;timeout &lt; 0)</span>
<span class="udiff-line-modified-removed">-         context-&gt;timeout = source_timeout;</span>
<span class="udiff-line-modified-removed">-       else</span>
<span class="udiff-line-modified-removed">-         context-&gt;timeout = MIN (context-&gt;timeout, source_timeout);</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     if (context-&gt;timeout &lt; 0)</span>
<span class="udiff-line-modified-added">+       context-&gt;timeout = source_timeout;</span>
<span class="udiff-line-modified-added">+     else</span>
<span class="udiff-line-modified-added">+       context-&gt;timeout = MIN (context-&gt;timeout, source_timeout);</span>
<span class="udiff-line-modified-added">+   }</span>
      }
    g_source_iter_clear (&amp;iter);
  
    TRACE (GLIB_MAIN_CONTEXT_AFTER_PREPARE (context, current_priority, n_ready));
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3635,14 +3632,14 @@</span>
   *   or, if more than @n_fds records need to be stored, the number
   *   of records that need to be stored.
   **/
  gint
  g_main_context_query (GMainContext *context,
<span class="udiff-line-modified-removed">-               gint          max_priority,</span>
<span class="udiff-line-modified-removed">-               gint         *timeout,</span>
<span class="udiff-line-modified-removed">-               GPollFD      *fds,</span>
<span class="udiff-line-modified-removed">-               gint          n_fds)</span>
<span class="udiff-line-modified-added">+           gint          max_priority,</span>
<span class="udiff-line-modified-added">+           gint         *timeout,</span>
<span class="udiff-line-modified-added">+           GPollFD      *fds,</span>
<span class="udiff-line-modified-added">+           gint          n_fds)</span>
  {
    gint n_poll;
    GPollRec *pollrec, *lastpollrec;
    gushort events;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3673,15 +3670,15 @@</span>
          {
            if (n_poll &lt; n_fds)
              {
                fds[n_poll].fd = pollrec-&gt;fd-&gt;fd;
                fds[n_poll].events = events;
<span class="udiff-line-modified-removed">-       fds[n_poll].revents = 0;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+               fds[n_poll].revents = 0;</span>
<span class="udiff-line-modified-added">+             }</span>
  
<span class="udiff-line-modified-removed">-       n_poll++;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+           n_poll++;</span>
<span class="udiff-line-modified-added">+         }</span>
  
        lastpollrec = pollrec;
      }
  
    context-&gt;poll_changed = FALSE;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3716,13 +3713,13 @@</span>
   *
   * Returns: %TRUE if some sources are ready to be dispatched.
   **/
  gboolean
  g_main_context_check (GMainContext *context,
<span class="udiff-line-modified-removed">-               gint          max_priority,</span>
<span class="udiff-line-modified-removed">-               GPollFD      *fds,</span>
<span class="udiff-line-modified-removed">-               gint          n_fds)</span>
<span class="udiff-line-modified-added">+           gint          max_priority,</span>
<span class="udiff-line-modified-added">+           GPollFD      *fds,</span>
<span class="udiff-line-modified-added">+           gint          n_fds)</span>
  {
    GSource *source;
    GSourceIter iter;
    GPollRec *pollrec;
    gint n_ready = 0;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3731,11 +3728,11 @@</span>
    LOCK_CONTEXT (context);
  
    if (context-&gt;in_check_or_prepare)
      {
        g_warning (&quot;g_main_context_check() called recursively from within a source&#39;s check() or &quot;
<span class="udiff-line-modified-removed">-          &quot;prepare() member.&quot;);</span>
<span class="udiff-line-modified-added">+      &quot;prepare() member.&quot;);</span>
        UNLOCK_CONTEXT (context);
        return FALSE;
      }
  
    TRACE (GLIB_MAIN_CONTEXT_BEFORE_CHECK (context, max_priority, fds, n_fds));
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3745,11 +3742,11 @@</span>
        if (fds[i].fd == context-&gt;wake_up_rec.fd)
          {
            if (fds[i].revents)
              {
                TRACE (GLIB_MAIN_CONTEXT_WAKEUP_ACKNOWLEDGE (context));
<span class="udiff-line-modified-removed">-     g_wakeup_acknowledge (context-&gt;wakeup);</span>
<span class="udiff-line-modified-added">+               g_wakeup_acknowledge (context-&gt;wakeup);</span>
              }
            break;
          }
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3783,16 +3780,16 @@</span>
  
    g_source_iter_init (&amp;iter, context, TRUE);
    while (g_source_iter_next (&amp;iter, &amp;source))
      {
        if (SOURCE_DESTROYED (source) || SOURCE_BLOCKED (source))
<span class="udiff-line-modified-removed">-     continue;</span>
<span class="udiff-line-modified-added">+   continue;</span>
        if ((n_ready &gt; 0) &amp;&amp; (source-&gt;priority &gt; max_priority))
<span class="udiff-line-modified-removed">-     break;</span>
<span class="udiff-line-modified-added">+   break;</span>
  
        if (!(source-&gt;flags &amp; G_SOURCE_READY))
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-added">+   {</span>
            gboolean result;
            gboolean (* check) (GSource *source);
  
            check = source-&gt;source_funcs-&gt;check;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3842,34 +3839,34 @@</span>
  
                if (source-&gt;priv-&gt;ready_time &lt;= context-&gt;time)
                  result = TRUE;
              }
  
<span class="udiff-line-modified-removed">-       if (result)</span>
<span class="udiff-line-modified-removed">-         {</span>
<span class="udiff-line-modified-removed">-           GSource *ready_source = source;</span>
<span class="udiff-line-modified-added">+     if (result)</span>
<span class="udiff-line-modified-added">+       {</span>
<span class="udiff-line-modified-added">+         GSource *ready_source = source;</span>
  
<span class="udiff-line-modified-removed">-           while (ready_source)</span>
<span class="udiff-line-modified-removed">-         {</span>
<span class="udiff-line-modified-removed">-           ready_source-&gt;flags |= G_SOURCE_READY;</span>
<span class="udiff-line-modified-removed">-           ready_source = ready_source-&gt;priv-&gt;parent_source;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+         while (ready_source)</span>
<span class="udiff-line-modified-added">+     {</span>
<span class="udiff-line-modified-added">+       ready_source-&gt;flags |= G_SOURCE_READY;</span>
<span class="udiff-line-modified-added">+       ready_source = ready_source-&gt;priv-&gt;parent_source;</span>
      }
<span class="udiff-line-added">+       }</span>
<span class="udiff-line-added">+   }</span>
  
        if (source-&gt;flags &amp; G_SOURCE_READY)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       source-&gt;ref_count++;</span>
<span class="udiff-line-modified-removed">-       g_ptr_array_add (context-&gt;pending_dispatches, source);</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+           g_source_ref (source);</span>
<span class="udiff-line-modified-added">+     g_ptr_array_add (context-&gt;pending_dispatches, source);</span>
  
<span class="udiff-line-modified-removed">-       n_ready++;</span>
<span class="udiff-line-modified-added">+     n_ready++;</span>
  
            /* never dispatch sources with less priority than the first
             * one we choose to dispatch
             */
            max_priority = source-&gt;priority;
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   }</span>
      }
    g_source_iter_clear (&amp;iter);
  
    TRACE (GLIB_MAIN_CONTEXT_AFTER_CHECK (context, n_ready));
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3905,13 +3902,13 @@</span>
  }
  
  /* HOLDS context lock */
  static gboolean
  g_main_context_iterate (GMainContext *context,
<span class="udiff-line-modified-removed">-             gboolean      block,</span>
<span class="udiff-line-modified-removed">-             gboolean      dispatch,</span>
<span class="udiff-line-modified-removed">-             GThread      *self)</span>
<span class="udiff-line-modified-added">+       gboolean      block,</span>
<span class="udiff-line-modified-added">+       gboolean      dispatch,</span>
<span class="udiff-line-modified-added">+       GThread      *self)</span>
  {
    gint max_priority;
    gint timeout;
    gboolean some_ready;
    gint nfds, allocated_nfds;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3924,18 +3921,18 @@</span>
        gboolean got_ownership;
  
        LOCK_CONTEXT (context);
  
        if (!block)
<span class="udiff-line-modified-removed">-     return FALSE;</span>
<span class="udiff-line-modified-added">+   return FALSE;</span>
  
        got_ownership = g_main_context_wait_internal (context,
                                                      &amp;context-&gt;cond,
                                                      &amp;context-&gt;mutex);
  
        if (!got_ownership)
<span class="udiff-line-modified-removed">-     return FALSE;</span>
<span class="udiff-line-modified-added">+   return FALSE;</span>
      }
    else
      LOCK_CONTEXT (context);
  
    if (!context-&gt;cached_poll_array)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3950,11 +3947,11 @@</span>
    UNLOCK_CONTEXT (context);
  
    g_main_context_prepare (context, &amp;max_priority);
  
    while ((nfds = g_main_context_query (context, max_priority, &amp;timeout, fds,
<span class="udiff-line-modified-removed">-                        allocated_nfds)) &gt; allocated_nfds)</span>
<span class="udiff-line-modified-added">+                allocated_nfds)) &gt; allocated_nfds)</span>
      {
        LOCK_CONTEXT (context);
        g_free (fds);
        context-&gt;cached_poll_array_size = allocated_nfds = nfds;
        context-&gt;cached_poll_array = fds = g_new (GPollFD, nfds);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4052,11 +4049,11 @@</span>
   *
   * Returns: a new #GMainLoop.
   **/
  GMainLoop *
  g_main_loop_new (GMainContext *context,
<span class="udiff-line-modified-removed">-          gboolean      is_running)</span>
<span class="udiff-line-modified-added">+      gboolean      is_running)</span>
  {
    GMainLoop *loop;
  
    if (!context)
      context = g_main_context_default();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4135,43 +4132,41 @@</span>
  
        /* Another thread owns this context */
        LOCK_CONTEXT (loop-&gt;context);
  
        g_atomic_int_inc (&amp;loop-&gt;ref_count);
<span class="udiff-line-added">+       g_atomic_int_set (&amp;loop-&gt;is_running, TRUE);</span>
  
<span class="udiff-line-modified-removed">-       if (!loop-&gt;is_running)</span>
<span class="udiff-line-removed">-     loop-&gt;is_running = TRUE;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-       while (loop-&gt;is_running &amp;&amp; !got_ownership)</span>
<span class="udiff-line-modified-added">+       while (g_atomic_int_get (&amp;loop-&gt;is_running) &amp;&amp; !got_ownership)</span>
          got_ownership = g_main_context_wait_internal (loop-&gt;context,
                                                        &amp;loop-&gt;context-&gt;cond,
                                                        &amp;loop-&gt;context-&gt;mutex);
  
<span class="udiff-line-modified-removed">-       if (!loop-&gt;is_running)</span>
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       UNLOCK_CONTEXT (loop-&gt;context);</span>
<span class="udiff-line-modified-removed">-       if (got_ownership)</span>
<span class="udiff-line-modified-removed">-         g_main_context_release (loop-&gt;context);</span>
<span class="udiff-line-modified-removed">-       g_main_loop_unref (loop);</span>
<span class="udiff-line-modified-removed">-       return;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+       if (!g_atomic_int_get (&amp;loop-&gt;is_running))</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     UNLOCK_CONTEXT (loop-&gt;context);</span>
<span class="udiff-line-modified-added">+     if (got_ownership)</span>
<span class="udiff-line-modified-added">+       g_main_context_release (loop-&gt;context);</span>
<span class="udiff-line-modified-added">+     g_main_loop_unref (loop);</span>
<span class="udiff-line-modified-added">+     return;</span>
<span class="udiff-line-modified-added">+   }</span>
  
        g_assert (got_ownership);
      }
    else
      LOCK_CONTEXT (loop-&gt;context);
  
    if (loop-&gt;context-&gt;in_check_or_prepare)
      {
        g_warning (&quot;g_main_loop_run(): called recursively from within a source&#39;s &quot;
<span class="udiff-line-modified-removed">-          &quot;check() or prepare() member, iteration not possible.&quot;);</span>
<span class="udiff-line-modified-added">+      &quot;check() or prepare() member, iteration not possible.&quot;);</span>
        return;
      }
  
    g_atomic_int_inc (&amp;loop-&gt;ref_count);
<span class="udiff-line-modified-removed">-   loop-&gt;is_running = TRUE;</span>
<span class="udiff-line-modified-removed">-   while (loop-&gt;is_running)</span>
<span class="udiff-line-modified-added">+   g_atomic_int_set (&amp;loop-&gt;is_running, TRUE);</span>
<span class="udiff-line-modified-added">+   while (g_atomic_int_get (&amp;loop-&gt;is_running))</span>
      g_main_context_iterate (loop-&gt;context, TRUE, TRUE, self);
  
    UNLOCK_CONTEXT (loop-&gt;context);
  
    g_main_context_release (loop-&gt;context);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4194,11 +4189,11 @@</span>
  {
    g_return_if_fail (loop != NULL);
    g_return_if_fail (g_atomic_int_get (&amp;loop-&gt;ref_count) &gt; 0);
  
    LOCK_CONTEXT (loop-&gt;context);
<span class="udiff-line-modified-removed">-   loop-&gt;is_running = FALSE;</span>
<span class="udiff-line-modified-added">+   g_atomic_int_set (&amp;loop-&gt;is_running, FALSE);</span>
    g_wakeup_signal (loop-&gt;context-&gt;wakeup);
  
    g_cond_broadcast (&amp;loop-&gt;context-&gt;cond);
  
    UNLOCK_CONTEXT (loop-&gt;context);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4218,11 +4213,11 @@</span>
  g_main_loop_is_running (GMainLoop *loop)
  {
    g_return_val_if_fail (loop != NULL, FALSE);
    g_return_val_if_fail (g_atomic_int_get (&amp;loop-&gt;ref_count) &gt; 0, FALSE);
  
<span class="udiff-line-modified-removed">-   return loop-&gt;is_running;</span>
<span class="udiff-line-modified-added">+   return g_atomic_int_get (&amp;loop-&gt;is_running);</span>
  }
  
  /**
   * g_main_loop_get_context:
   * @loop: a #GMainLoop.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4241,14 +4236,14 @@</span>
  }
  
  /* HOLDS: context&#39;s lock */
  static void
  g_main_context_poll (GMainContext *context,
<span class="udiff-line-modified-removed">-              gint          timeout,</span>
<span class="udiff-line-modified-removed">-              gint          priority,</span>
<span class="udiff-line-modified-removed">-              GPollFD      *fds,</span>
<span class="udiff-line-modified-removed">-              gint          n_fds)</span>
<span class="udiff-line-modified-added">+          gint          timeout,</span>
<span class="udiff-line-modified-added">+          gint          priority,</span>
<span class="udiff-line-modified-added">+          GPollFD      *fds,</span>
<span class="udiff-line-modified-added">+          gint          n_fds)</span>
  {
  #ifdef  G_MAIN_POLL_DEBUG
    GTimer *poll_timer;
    GPollRec *pollrec;
    gint i;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4261,78 +4256,78 @@</span>
        int ret, errsv;
  
  #ifdef  G_MAIN_POLL_DEBUG
        poll_timer = NULL;
        if (_g_main_poll_debug)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       g_print (&quot;polling context=%p n=%d timeout=%d\n&quot;,</span>
<span class="udiff-line-modified-removed">-            context, n_fds, timeout);</span>
<span class="udiff-line-modified-removed">-       poll_timer = g_timer_new ();</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     g_print (&quot;polling context=%p n=%d timeout=%d\n&quot;,</span>
<span class="udiff-line-modified-added">+        context, n_fds, timeout);</span>
<span class="udiff-line-modified-added">+     poll_timer = g_timer_new ();</span>
<span class="udiff-line-modified-added">+   }</span>
  #endif
  
        LOCK_CONTEXT (context);
  
        poll_func = context-&gt;poll_func;
  
        UNLOCK_CONTEXT (context);
        ret = (*poll_func) (fds, n_fds, timeout);
        errsv = errno;
        if (ret &lt; 0 &amp;&amp; errsv != EINTR)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-added">+   {</span>
  #ifndef G_OS_WIN32
<span class="udiff-line-modified-removed">-       g_warning (&quot;poll(2) failed due to: %s.&quot;,</span>
<span class="udiff-line-modified-removed">-              g_strerror (errsv));</span>
<span class="udiff-line-modified-added">+     g_warning (&quot;poll(2) failed due to: %s.&quot;,</span>
<span class="udiff-line-modified-added">+          g_strerror (errsv));</span>
  #else
<span class="udiff-line-modified-removed">-       /* If g_poll () returns -1, it has already called g_warning() */</span>
<span class="udiff-line-modified-added">+     /* If g_poll () returns -1, it has already called g_warning() */</span>
  #endif
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   }</span>
  
  #ifdef  G_MAIN_POLL_DEBUG
        if (_g_main_poll_debug)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       LOCK_CONTEXT (context);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-       g_print (&quot;g_main_poll(%d) timeout: %d - elapsed %12.10f seconds&quot;,</span>
<span class="udiff-line-removed">-            n_fds,</span>
<span class="udiff-line-removed">-            timeout,</span>
<span class="udiff-line-removed">-            g_timer_elapsed (poll_timer, NULL));</span>
<span class="udiff-line-removed">-       g_timer_destroy (poll_timer);</span>
<span class="udiff-line-removed">-       pollrec = context-&gt;poll_records;</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     LOCK_CONTEXT (context);</span>
  
<span class="udiff-line-modified-removed">-       while (pollrec != NULL)</span>
<span class="udiff-line-modified-removed">-         {</span>
<span class="udiff-line-modified-removed">-           i = 0;</span>
<span class="udiff-line-modified-removed">-           while (i &lt; n_fds)</span>
<span class="udiff-line-modified-added">+     g_print (&quot;g_main_poll(%d) timeout: %d - elapsed %12.10f seconds&quot;,</span>
<span class="udiff-line-modified-added">+        n_fds,</span>
<span class="udiff-line-modified-added">+        timeout,</span>
<span class="udiff-line-modified-added">+        g_timer_elapsed (poll_timer, NULL));</span>
<span class="udiff-line-added">+     g_timer_destroy (poll_timer);</span>
<span class="udiff-line-added">+     pollrec = context-&gt;poll_records;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     while (pollrec != NULL)</span>
<span class="udiff-line-added">+       {</span>
<span class="udiff-line-added">+         i = 0;</span>
<span class="udiff-line-added">+         while (i &lt; n_fds)</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       if (fds[i].fd == pollrec-&gt;fd-&gt;fd &amp;&amp;</span>
<span class="udiff-line-added">+           pollrec-&gt;fd-&gt;events &amp;&amp;</span>
<span class="udiff-line-added">+           fds[i].revents)</span>
          {
<span class="udiff-line-modified-removed">-           if (fds[i].fd == pollrec-&gt;fd-&gt;fd &amp;&amp;</span>
<span class="udiff-line-modified-removed">-               pollrec-&gt;fd-&gt;events &amp;&amp;</span>
<span class="udiff-line-modified-removed">-               fds[i].revents)</span>
<span class="udiff-line-modified-removed">-             {</span>
<span class="udiff-line-modified-removed">-               g_print (&quot; [&quot; G_POLLFD_FORMAT &quot; :&quot;, fds[i].fd);</span>
<span class="udiff-line-modified-removed">-               if (fds[i].revents &amp; G_IO_IN)</span>
<span class="udiff-line-modified-removed">-             g_print (&quot;i&quot;);</span>
<span class="udiff-line-modified-removed">-               if (fds[i].revents &amp; G_IO_OUT)</span>
<span class="udiff-line-modified-removed">-             g_print (&quot;o&quot;);</span>
<span class="udiff-line-modified-removed">-               if (fds[i].revents &amp; G_IO_PRI)</span>
<span class="udiff-line-modified-removed">-             g_print (&quot;p&quot;);</span>
<span class="udiff-line-modified-removed">-               if (fds[i].revents &amp; G_IO_ERR)</span>
<span class="udiff-line-modified-removed">-             g_print (&quot;e&quot;);</span>
<span class="udiff-line-modified-removed">-               if (fds[i].revents &amp; G_IO_HUP)</span>
<span class="udiff-line-removed">-             g_print (&quot;h&quot;);</span>
<span class="udiff-line-removed">-               if (fds[i].revents &amp; G_IO_NVAL)</span>
<span class="udiff-line-removed">-             g_print (&quot;n&quot;);</span>
<span class="udiff-line-removed">-               g_print (&quot;]&quot;);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-           i++;</span>
<span class="udiff-line-modified-added">+           g_print (&quot; [&quot; G_POLLFD_FORMAT &quot; :&quot;, fds[i].fd);</span>
<span class="udiff-line-modified-added">+           if (fds[i].revents &amp; G_IO_IN)</span>
<span class="udiff-line-modified-added">+       g_print (&quot;i&quot;);</span>
<span class="udiff-line-modified-added">+           if (fds[i].revents &amp; G_IO_OUT)</span>
<span class="udiff-line-modified-added">+       g_print (&quot;o&quot;);</span>
<span class="udiff-line-modified-added">+           if (fds[i].revents &amp; G_IO_PRI)</span>
<span class="udiff-line-modified-added">+       g_print (&quot;p&quot;);</span>
<span class="udiff-line-modified-added">+           if (fds[i].revents &amp; G_IO_ERR)</span>
<span class="udiff-line-modified-added">+       g_print (&quot;e&quot;);</span>
<span class="udiff-line-modified-added">+           if (fds[i].revents &amp; G_IO_HUP)</span>
<span class="udiff-line-modified-added">+       g_print (&quot;h&quot;);</span>
<span class="udiff-line-modified-added">+           if (fds[i].revents &amp; G_IO_NVAL)</span>
<span class="udiff-line-modified-added">+       g_print (&quot;n&quot;);</span>
<span class="udiff-line-modified-added">+           g_print (&quot;]&quot;);</span>
          }
<span class="udiff-line-modified-removed">-           pollrec = pollrec-&gt;next;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-       g_print (&quot;\n&quot;);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-       UNLOCK_CONTEXT (context);</span>
<span class="udiff-line-modified-added">+       i++;</span>
      }
<span class="udiff-line-added">+         pollrec = pollrec-&gt;next;</span>
<span class="udiff-line-added">+       }</span>
<span class="udiff-line-added">+     g_print (&quot;\n&quot;);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     UNLOCK_CONTEXT (context);</span>
<span class="udiff-line-added">+   }</span>
  #endif
      } /* if (n_fds || timeout != 0) */
  }
  
  /**
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4348,12 +4343,12 @@</span>
   * this context. This will very seldom be used directly. Instead
   * a typical event source will use g_source_add_unix_fd() instead.
   **/
  void
  g_main_context_add_poll (GMainContext *context,
<span class="udiff-line-modified-removed">-              GPollFD      *fd,</span>
<span class="udiff-line-modified-removed">-              gint          priority)</span>
<span class="udiff-line-modified-added">+        GPollFD      *fd,</span>
<span class="udiff-line-modified-added">+        gint          priority)</span>
  {
    if (!context)
      context = g_main_context_default ();
  
    g_return_if_fail (g_atomic_int_get (&amp;context-&gt;ref_count) &gt; 0);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4365,12 +4360,12 @@</span>
  }
  
  /* HOLDS: main_loop_lock */
  static void
  g_main_context_add_poll_unlocked (GMainContext *context,
<span class="udiff-line-modified-removed">-                   gint          priority,</span>
<span class="udiff-line-modified-removed">-                   GPollFD      *fd)</span>
<span class="udiff-line-modified-added">+           gint          priority,</span>
<span class="udiff-line-modified-added">+           GPollFD      *fd)</span>
  {
    GPollRec *prevrec, *nextrec;
    GPollRec *newrec = g_slice_new (GPollRec);
  #ifdef GSTREAMER_LITE
    if (newrec == NULL) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4420,11 +4415,11 @@</span>
   * Removes file descriptor from the set of file descriptors to be
   * polled for a particular context.
   **/
  void
  g_main_context_remove_poll (GMainContext *context,
<span class="udiff-line-modified-removed">-                 GPollFD      *fd)</span>
<span class="udiff-line-modified-added">+           GPollFD      *fd)</span>
  {
    if (!context)
      context = g_main_context_default ();
  
    g_return_if_fail (g_atomic_int_get (&amp;context-&gt;ref_count) &gt; 0);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4435,35 +4430,35 @@</span>
    UNLOCK_CONTEXT (context);
  }
  
  static void
  g_main_context_remove_poll_unlocked (GMainContext *context,
<span class="udiff-line-modified-removed">-                      GPollFD      *fd)</span>
<span class="udiff-line-modified-added">+              GPollFD      *fd)</span>
  {
    GPollRec *pollrec, *prevrec, *nextrec;
  
    prevrec = NULL;
    pollrec = context-&gt;poll_records;
  
    while (pollrec)
      {
        nextrec = pollrec-&gt;next;
        if (pollrec-&gt;fd == fd)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       if (prevrec != NULL)</span>
<span class="udiff-line-modified-removed">-         prevrec-&gt;next = nextrec;</span>
<span class="udiff-line-modified-removed">-       else</span>
<span class="udiff-line-modified-removed">-         context-&gt;poll_records = nextrec;</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     if (prevrec != NULL)</span>
<span class="udiff-line-modified-added">+       prevrec-&gt;next = nextrec;</span>
<span class="udiff-line-modified-added">+     else</span>
<span class="udiff-line-modified-added">+       context-&gt;poll_records = nextrec;</span>
  
<span class="udiff-line-modified-removed">-       if (nextrec != NULL)</span>
<span class="udiff-line-modified-removed">-         nextrec-&gt;prev = prevrec;</span>
<span class="udiff-line-modified-added">+     if (nextrec != NULL)</span>
<span class="udiff-line-modified-added">+       nextrec-&gt;prev = prevrec;</span>
  
<span class="udiff-line-modified-removed">-       g_slice_free (GPollRec, pollrec);</span>
<span class="udiff-line-modified-added">+     g_slice_free (GPollRec, pollrec);</span>
  
<span class="udiff-line-modified-removed">-       context-&gt;n_poll_records--;</span>
<span class="udiff-line-modified-removed">-       break;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+     context-&gt;n_poll_records--;</span>
<span class="udiff-line-modified-added">+     break;</span>
<span class="udiff-line-modified-added">+   }</span>
        prevrec = pollrec;
        pollrec = nextrec;
      }
  
    context-&gt;poll_changed = TRUE;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4480,16 +4475,18 @@</span>
   * This function ignores @source and is otherwise the same as
   * g_get_current_time().
   *
   * Deprecated: 2.28: use g_source_get_time() instead
   **/
<span class="udiff-line-added">+ G_GNUC_BEGIN_IGNORE_DEPRECATIONS</span>
  void
  g_source_get_current_time (GSource  *source,
<span class="udiff-line-modified-removed">-                GTimeVal *timeval)</span>
<span class="udiff-line-modified-added">+          GTimeVal *timeval)</span>
  {
    g_get_current_time (timeval);
  }
<span class="udiff-line-added">+ G_GNUC_END_IGNORE_DEPRECATIONS</span>
  
  /**
   * g_source_get_time:
   * @source: a #GSource
   *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4543,11 +4540,11 @@</span>
   * This function could possibly be used to integrate the GLib event
   * loop with an external event loop.
   **/
  void
  g_main_context_set_poll_func (GMainContext *context,
<span class="udiff-line-modified-removed">-                   GPollFunc     func)</span>
<span class="udiff-line-modified-added">+             GPollFunc     func)</span>
  {
    if (!context)
      context = g_main_context_default ();
  
    g_return_if_fail (g_atomic_int_get (&amp;context-&gt;ref_count) &gt; 0);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4667,12 +4664,10 @@</span>
  g_timeout_set_expiration (GTimeoutSource *timeout_source,
                            gint64          current_time)
  {
    gint64 expiration;
  
<span class="udiff-line-removed">-   expiration = current_time + (guint64) timeout_source-&gt;interval * 1000;</span>
<span class="udiff-line-removed">- </span>
    if (timeout_source-&gt;seconds)
      {
        gint64 remainder;
        static gint timer_perturb = -1;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4690,10 +4685,12 @@</span>
              timer_perturb = ABS ((gint) g_str_hash (session_bus_address)) % 1000000;
            else
              timer_perturb = 0;
          }
  
<span class="udiff-line-added">+       expiration = current_time + (guint64) timeout_source-&gt;interval * 1000 * 1000;</span>
<span class="udiff-line-added">+ </span>
        /* We want the microseconds part of the timeout to land on the
         * &#39;timer_perturb&#39; mark, but we need to make sure we don&#39;t try to
         * set the timeout in the past.  We do this by ensuring that we
         * always only *increase* the expiration time by adding a full
         * second in the case that the microsecond portion decreases.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4705,10 +4702,14 @@</span>
          expiration += 1000000;
  
        expiration -= remainder;
        expiration += timer_perturb;
      }
<span class="udiff-line-added">+   else</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       expiration = current_time + (guint64) timeout_source-&gt;interval * 1000;</span>
<span class="udiff-line-added">+     }</span>
  
    g_source_set_ready_time ((GSource *) timeout_source, expiration);
  }
  
  static gboolean
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4792,11 +4793,11 @@</span>
  g_timeout_source_new_seconds (guint interval)
  {
    GSource *source = g_source_new (&amp;g_timeout_funcs, sizeof (GTimeoutSource));
    GTimeoutSource *timeout_source = (GTimeoutSource *)source;
  
<span class="udiff-line-modified-removed">-   timeout_source-&gt;interval = 1000 * interval;</span>
<span class="udiff-line-modified-added">+   timeout_source-&gt;interval = interval;</span>
    timeout_source-&gt;seconds = TRUE;
  
    g_timeout_set_expiration (timeout_source, g_get_monotonic_time ());
  
    return source;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4841,14 +4842,14 @@</span>
   *
   * Returns: the ID (greater than 0) of the event source.
   **/
  guint
  g_timeout_add_full (gint           priority,
<span class="udiff-line-modified-removed">-             guint          interval,</span>
<span class="udiff-line-modified-removed">-             GSourceFunc    function,</span>
<span class="udiff-line-modified-removed">-             gpointer       data,</span>
<span class="udiff-line-modified-removed">-             GDestroyNotify notify)</span>
<span class="udiff-line-modified-added">+         guint          interval,</span>
<span class="udiff-line-modified-added">+         GSourceFunc    function,</span>
<span class="udiff-line-modified-added">+         gpointer       data,</span>
<span class="udiff-line-modified-added">+         GDestroyNotify notify)</span>
  {
    GSource *source;
    guint id;
  
    g_return_val_if_fail (function != NULL, 0);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4910,15 +4911,15 @@</span>
   *
   * Returns: the ID (greater than 0) of the event source.
   **/
  guint
  g_timeout_add (guint32        interval,
<span class="udiff-line-modified-removed">-            GSourceFunc    function,</span>
<span class="udiff-line-modified-removed">-            gpointer       data)</span>
<span class="udiff-line-modified-added">+          GSourceFunc    function,</span>
<span class="udiff-line-modified-added">+          gpointer       data)</span>
  {
    return g_timeout_add_full (G_PRIORITY_DEFAULT,
<span class="udiff-line-modified-removed">-                  interval, function, data, NULL);</span>
<span class="udiff-line-modified-added">+            interval, function, data, NULL);</span>
  }
  
  #ifndef GSTREAMER_LITE
  /**
   * g_timeout_add_seconds_full: (rename-to g_timeout_add_seconds)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -5039,11 +5040,11 @@</span>
  
  #ifdef G_OS_WIN32
  
  static gboolean
  g_child_watch_prepare (GSource *source,
<span class="udiff-line-modified-removed">-                gint    *timeout)</span>
<span class="udiff-line-modified-added">+            gint    *timeout)</span>
  {
    *timeout = -1;
    return FALSE;
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -5067,18 +5068,18 @@</span>
         * problems if the child process &quot;happens to return STILL_ACTIVE(259)&quot;
         * as Microsoft&#39;s Platform SDK puts it.
         */
        if (!GetExitCodeProcess (child_watch_source-&gt;pid, &amp;child_status))
          {
<span class="udiff-line-modified-removed">-       gchar *emsg = g_win32_error_message (GetLastError ());</span>
<span class="udiff-line-modified-removed">-       g_warning (G_STRLOC &quot;: GetExitCodeProcess() failed: %s&quot;, emsg);</span>
<span class="udiff-line-modified-removed">-       g_free (emsg);</span>
<span class="udiff-line-modified-added">+     gchar *emsg = g_win32_error_message (GetLastError ());</span>
<span class="udiff-line-modified-added">+     g_warning (G_STRLOC &quot;: GetExitCodeProcess() failed: %s&quot;, emsg);</span>
<span class="udiff-line-modified-added">+     g_free (emsg);</span>
  
<span class="udiff-line-modified-removed">-       child_watch_source-&gt;child_status = -1;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+     child_watch_source-&gt;child_status = -1;</span>
<span class="udiff-line-modified-added">+   }</span>
        else
<span class="udiff-line-modified-removed">-     child_watch_source-&gt;child_status = child_status;</span>
<span class="udiff-line-modified-added">+   child_watch_source-&gt;child_status = child_status;</span>
      }
  
    return child_exited;
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -5171,28 +5172,28 @@</span>
         */
        for (node = unix_child_watches; node; node = node-&gt;next)
          {
            GChildWatchSource *source = node-&gt;data;
  
<span class="udiff-line-modified-removed">-           if (!source-&gt;child_exited)</span>
<span class="udiff-line-modified-added">+           if (!g_atomic_int_get (&amp;source-&gt;child_exited))</span>
              {
                pid_t pid;
                do
                  {
                    g_assert (source-&gt;pid &gt; 0);
  
                    pid = waitpid (source-&gt;pid, &amp;source-&gt;child_status, WNOHANG);
                    if (pid &gt; 0)
                      {
<span class="udiff-line-modified-removed">-                       source-&gt;child_exited = TRUE;</span>
<span class="udiff-line-modified-added">+                       g_atomic_int_set (&amp;source-&gt;child_exited, TRUE);</span>
                        wake_source ((GSource *) source);
                      }
                    else if (pid == -1 &amp;&amp; errno == ECHILD)
                      {
                        g_warning (&quot;GChildWatchSource: Exit status of a child process was requested but ECHILD was received by waitpid(). See the documentation of g_child_watch_source_new() for possible causes.&quot;);
<span class="udiff-line-removed">-                       source-&gt;child_exited = TRUE;</span>
                        source-&gt;child_status = 0;
<span class="udiff-line-added">+                       g_atomic_int_set (&amp;source-&gt;child_exited, TRUE);</span>
                        wake_source ((GSource *) source);
                      }
                  }
                while (pid == -1 &amp;&amp; errno == EINTR);
              }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -5202,18 +5203,14 @@</span>
    /* handle GUnixSignalWatchSource instances */
    for (node = unix_signal_watches; node; node = node-&gt;next)
      {
        GUnixSignalWatchSource *source = node-&gt;data;
  
<span class="udiff-line-modified-removed">-       if (!source-&gt;pending)</span>
<span class="udiff-line-modified-added">+       if (pending[source-&gt;signum] &amp;&amp;</span>
<span class="udiff-line-added">+           g_atomic_int_compare_and_exchange (&amp;source-&gt;pending, FALSE, TRUE))</span>
          {
<span class="udiff-line-modified-removed">-           if (pending[source-&gt;signum])</span>
<span class="udiff-line-removed">-             {</span>
<span class="udiff-line-removed">-               source-&gt;pending = TRUE;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-               wake_source ((GSource *) source);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-modified-added">+           wake_source ((GSource *) source);</span>
          }
      }
  
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -5225,70 +5222,70 @@</span>
    G_UNLOCK(unix_signal_lock);
  }
  
  static gboolean
  g_child_watch_prepare (GSource *source,
<span class="udiff-line-modified-removed">-                gint    *timeout)</span>
<span class="udiff-line-modified-added">+            gint    *timeout)</span>
  {
    GChildWatchSource *child_watch_source;
  
    child_watch_source = (GChildWatchSource *) source;
  
<span class="udiff-line-modified-removed">-   return child_watch_source-&gt;child_exited;</span>
<span class="udiff-line-modified-added">+   return g_atomic_int_get (&amp;child_watch_source-&gt;child_exited);</span>
  }
  
  static gboolean
  g_child_watch_check (GSource *source)
  {
    GChildWatchSource *child_watch_source;
  
    child_watch_source = (GChildWatchSource *) source;
  
<span class="udiff-line-modified-removed">-   return child_watch_source-&gt;child_exited;</span>
<span class="udiff-line-modified-added">+   return g_atomic_int_get (&amp;child_watch_source-&gt;child_exited);</span>
  }
  
  static gboolean
  g_unix_signal_watch_prepare (GSource *source,
<span class="udiff-line-modified-removed">-                  gint    *timeout)</span>
<span class="udiff-line-modified-added">+            gint    *timeout)</span>
  {
    GUnixSignalWatchSource *unix_signal_source;
  
    unix_signal_source = (GUnixSignalWatchSource *) source;
  
<span class="udiff-line-modified-removed">-   return unix_signal_source-&gt;pending;</span>
<span class="udiff-line-modified-added">+   return g_atomic_int_get (&amp;unix_signal_source-&gt;pending);</span>
  }
  
  static gboolean
  g_unix_signal_watch_check (GSource  *source)
  {
    GUnixSignalWatchSource *unix_signal_source;
  
    unix_signal_source = (GUnixSignalWatchSource *) source;
  
<span class="udiff-line-modified-removed">-   return unix_signal_source-&gt;pending;</span>
<span class="udiff-line-modified-added">+   return g_atomic_int_get (&amp;unix_signal_source-&gt;pending);</span>
  }
  
  static gboolean
  g_unix_signal_watch_dispatch (GSource    *source,
<span class="udiff-line-modified-removed">-                   GSourceFunc callback,</span>
<span class="udiff-line-modified-removed">-                   gpointer    user_data)</span>
<span class="udiff-line-modified-added">+             GSourceFunc callback,</span>
<span class="udiff-line-modified-added">+             gpointer    user_data)</span>
  {
    GUnixSignalWatchSource *unix_signal_source;
    gboolean again;
  
    unix_signal_source = (GUnixSignalWatchSource *) source;
  
    if (!callback)
      {
        g_warning (&quot;Unix signal source dispatched without callback. &quot;
<span class="udiff-line-modified-removed">-          &quot;You must call g_source_set_callback().&quot;);</span>
<span class="udiff-line-modified-added">+      &quot;You must call g_source_set_callback().&quot;);</span>
        return FALSE;
      }
  
<span class="udiff-line-modified-removed">-   again = (callback) (user_data);</span>
<span class="udiff-line-modified-added">+   g_atomic_int_set (&amp;unix_signal_source-&gt;pending, FALSE);</span>
  
<span class="udiff-line-modified-removed">-   unix_signal_source-&gt;pending = FALSE;</span>
<span class="udiff-line-modified-added">+   again = (callback) (user_data);</span>
  
    return again;
  }
  
  static void
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -5435,22 +5432,22 @@</span>
  
  #endif /* G_OS_WIN32 */
  
  static gboolean
  g_child_watch_dispatch (GSource    *source,
<span class="udiff-line-modified-removed">-             GSourceFunc callback,</span>
<span class="udiff-line-modified-removed">-             gpointer    user_data)</span>
<span class="udiff-line-modified-added">+       GSourceFunc callback,</span>
<span class="udiff-line-modified-added">+       gpointer    user_data)</span>
  {
    GChildWatchSource *child_watch_source;
    GChildWatchFunc child_watch_callback = (GChildWatchFunc) callback;
  
    child_watch_source = (GChildWatchSource *) source;
  
    if (!callback)
      {
        g_warning (&quot;Child watch source dispatched without callback. &quot;
<span class="udiff-line-modified-removed">-          &quot;You must call g_source_set_callback().&quot;);</span>
<span class="udiff-line-modified-added">+      &quot;You must call g_source_set_callback().&quot;);</span>
        return FALSE;
      }
  
    (child_watch_callback) (child_watch_source-&gt;pid, child_watch_source-&gt;child_status, user_data);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -5595,14 +5592,14 @@</span>
   *
   * Since: 2.4
   **/
  guint
  g_child_watch_add_full (gint            priority,
<span class="udiff-line-modified-removed">-             GPid            pid,</span>
<span class="udiff-line-modified-removed">-             GChildWatchFunc function,</span>
<span class="udiff-line-modified-removed">-             gpointer        data,</span>
<span class="udiff-line-modified-removed">-             GDestroyNotify  notify)</span>
<span class="udiff-line-modified-added">+       GPid            pid,</span>
<span class="udiff-line-modified-added">+       GChildWatchFunc function,</span>
<span class="udiff-line-modified-added">+       gpointer        data,</span>
<span class="udiff-line-modified-added">+       GDestroyNotify  notify)</span>
  {
    GSource *source;
    guint id;
  
    g_return_val_if_fail (function != NULL, 0);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -5655,22 +5652,22 @@</span>
   *
   * Since: 2.4
   **/
  guint
  g_child_watch_add (GPid            pid,
<span class="udiff-line-modified-removed">-            GChildWatchFunc function,</span>
<span class="udiff-line-modified-removed">-            gpointer        data)</span>
<span class="udiff-line-modified-added">+        GChildWatchFunc function,</span>
<span class="udiff-line-modified-added">+        gpointer        data)</span>
  {
    return g_child_watch_add_full (G_PRIORITY_DEFAULT, pid, function, data, NULL);
  }
  
  
  /* Idle functions */
  
  static gboolean
  g_idle_prepare  (GSource  *source,
<span class="udiff-line-modified-removed">-          gint     *timeout)</span>
<span class="udiff-line-modified-added">+      gint     *timeout)</span>
  {
    *timeout = 0;
  
    return TRUE;
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -5681,19 +5678,19 @@</span>
    return TRUE;
  }
  
  static gboolean
  g_idle_dispatch (GSource    *source,
<span class="udiff-line-modified-removed">-          GSourceFunc callback,</span>
<span class="udiff-line-modified-removed">-          gpointer    user_data)</span>
<span class="udiff-line-modified-added">+      GSourceFunc callback,</span>
<span class="udiff-line-modified-added">+      gpointer    user_data)</span>
  {
    gboolean again;
  
    if (!callback)
      {
        g_warning (&quot;Idle source dispatched without callback. &quot;
<span class="udiff-line-modified-removed">-          &quot;You must call g_source_set_callback().&quot;);</span>
<span class="udiff-line-modified-added">+      &quot;You must call g_source_set_callback().&quot;);</span>
        return FALSE;
      }
  
    again = callback (user_data);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -5752,13 +5749,13 @@</span>
   *
   * Returns: the ID (greater than 0) of the event source.
   **/
  guint
  g_idle_add_full (gint           priority,
<span class="udiff-line-modified-removed">-          GSourceFunc    function,</span>
<span class="udiff-line-modified-removed">-          gpointer       data,</span>
<span class="udiff-line-modified-removed">-          GDestroyNotify notify)</span>
<span class="udiff-line-modified-added">+      GSourceFunc    function,</span>
<span class="udiff-line-modified-added">+      gpointer       data,</span>
<span class="udiff-line-modified-added">+      GDestroyNotify notify)</span>
  {
    GSource *source;
    guint id;
  
    g_return_val_if_fail (function != NULL, 0);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -5800,11 +5797,11 @@</span>
   *
   * Returns: the ID (greater than 0) of the event source.
   **/
  guint
  g_idle_add (GSourceFunc    function,
<span class="udiff-line-modified-removed">-         gpointer       data)</span>
<span class="udiff-line-modified-added">+       gpointer       data)</span>
  {
    return g_idle_add_full (G_PRIORITY_DEFAULT_IDLE, function, data, NULL);
  }
  
  /**
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -5828,12 +5825,12 @@</span>
   * @data: data to pass to @function
   *
   * Invokes a function in such a way that @context is owned during the
   * invocation of @function.
   *
<span class="udiff-line-modified-removed">-  * If @context is %NULL then the global default main context as</span>
<span class="udiff-line-modified-removed">-  * returned by g_main_context_default() is used.</span>
<span class="udiff-line-modified-added">+  * If @context is %NULL then the global default main context - as</span>
<span class="udiff-line-modified-added">+  * returned by g_main_context_default() - is used.</span>
   *
   * If @context is owned by the current thread, @function is called
   * directly.  Otherwise, if @context is the thread-default main context
   * of the current thread and g_main_context_acquire() succeeds, then
   * @function is called and g_main_context_release() is called
</pre>
<center><a href="gmacros.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="gmain.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>