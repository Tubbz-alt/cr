<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New modules/javafx.media/src/main/native/gstreamer/3rd_party/glib/glib/gvariant.c</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (C) 2007, 2008 Ryan Lortie
   3  * Copyright (C) 2010 Codethink Limited
   4  *
   5  * This library is free software; you can redistribute it and/or
   6  * modify it under the terms of the GNU Lesser General Public
   7  * License as published by the Free Software Foundation; either
   8  * version 2.1 of the License, or (at your option) any later version.
   9  *
  10  * This library is distributed in the hope that it will be useful,
  11  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  12  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
  13  * Lesser General Public License for more details.
  14  *
  15  * You should have received a copy of the GNU Lesser General Public
  16  * License along with this library; if not, see &lt;http://www.gnu.org/licenses/&gt;.
  17  *
  18  * Author: Ryan Lortie &lt;desrt@desrt.ca&gt;
  19  */
  20 
  21 /* Prologue {{{1 */
  22 
  23 #include &quot;config.h&quot;
  24 
  25 #include &lt;glib/gvariant-serialiser.h&gt;
  26 #include &quot;gvariant-internal.h&quot;
  27 #include &lt;glib/gvariant-core.h&gt;
  28 #include &lt;glib/gtestutils.h&gt;
  29 #include &lt;glib/gstrfuncs.h&gt;
  30 #include &lt;glib/gslice.h&gt;
  31 #include &lt;glib/ghash.h&gt;
  32 #include &lt;glib/gmem.h&gt;
  33 
  34 #include &lt;string.h&gt;
  35 
  36 
  37 /**
  38  * SECTION:gvariant
  39  * @title: GVariant
  40  * @short_description: strongly typed value datatype
  41  * @see_also: GVariantType
  42  *
  43  * #GVariant is a variant datatype; it can contain one or more values
  44  * along with information about the type of the values.
  45  *
  46  * A #GVariant may contain simple types, like an integer, or a boolean value;
  47  * or complex types, like an array of two strings, or a dictionary of key
  48  * value pairs. A #GVariant is also immutable: once it&#39;s been created neither
  49  * its type nor its content can be modified further.
  50  *
  51  * GVariant is useful whenever data needs to be serialized, for example when
  52  * sending method parameters in DBus, or when saving settings using GSettings.
  53  *
  54  * When creating a new #GVariant, you pass the data you want to store in it
  55  * along with a string representing the type of data you wish to pass to it.
  56  *
  57  * For instance, if you want to create a #GVariant holding an integer value you
  58  * can use:
  59  *
  60  * |[&lt;!-- language=&quot;C&quot; --&gt;
  61  *   GVariant *v = g_variant_new (&quot;u&quot;, 40);
  62  * ]|
  63  *
  64  * The string &quot;u&quot; in the first argument tells #GVariant that the data passed to
  65  * the constructor (40) is going to be an unsigned integer.
  66  *
  67  * More advanced examples of #GVariant in use can be found in documentation for
  68  * [GVariant format strings][gvariant-format-strings-pointers].
  69  *
  70  * The range of possible values is determined by the type.
  71  *
  72  * The type system used by #GVariant is #GVariantType.
  73  *
  74  * #GVariant instances always have a type and a value (which are given
  75  * at construction time).  The type and value of a #GVariant instance
  76  * can never change other than by the #GVariant itself being
  77  * destroyed.  A #GVariant cannot contain a pointer.
  78  *
  79  * #GVariant is reference counted using g_variant_ref() and
  80  * g_variant_unref().  #GVariant also has floating reference counts --
  81  * see g_variant_ref_sink().
  82  *
  83  * #GVariant is completely threadsafe.  A #GVariant instance can be
  84  * concurrently accessed in any way from any number of threads without
  85  * problems.
  86  *
  87  * #GVariant is heavily optimised for dealing with data in serialised
  88  * form.  It works particularly well with data located in memory-mapped
  89  * files.  It can perform nearly all deserialisation operations in a
  90  * small constant time, usually touching only a single memory page.
  91  * Serialised #GVariant data can also be sent over the network.
  92  *
  93  * #GVariant is largely compatible with D-Bus.  Almost all types of
  94  * #GVariant instances can be sent over D-Bus.  See #GVariantType for
  95  * exceptions.  (However, #GVariant&#39;s serialisation format is not the same
  96  * as the serialisation format of a D-Bus message body: use #GDBusMessage,
  97  * in the gio library, for those.)
  98  *
  99  * For space-efficiency, the #GVariant serialisation format does not
 100  * automatically include the variant&#39;s length, type or endianness,
 101  * which must either be implied from context (such as knowledge that a
 102  * particular file format always contains a little-endian
 103  * %G_VARIANT_TYPE_VARIANT which occupies the whole length of the file)
 104  * or supplied out-of-band (for instance, a length, type and/or endianness
 105  * indicator could be placed at the beginning of a file, network message
 106  * or network stream).
 107  *
 108  * A #GVariant&#39;s size is limited mainly by any lower level operating
 109  * system constraints, such as the number of bits in #gsize.  For
 110  * example, it is reasonable to have a 2GB file mapped into memory
 111  * with #GMappedFile, and call g_variant_new_from_data() on it.
 112  *
 113  * For convenience to C programmers, #GVariant features powerful
 114  * varargs-based value construction and destruction.  This feature is
 115  * designed to be embedded in other libraries.
 116  *
 117  * There is a Python-inspired text language for describing #GVariant
 118  * values.  #GVariant includes a printer for this language and a parser
 119  * with type inferencing.
 120  *
 121  * ## Memory Use
 122  *
 123  * #GVariant tries to be quite efficient with respect to memory use.
 124  * This section gives a rough idea of how much memory is used by the
 125  * current implementation.  The information here is subject to change
 126  * in the future.
 127  *
 128  * The memory allocated by #GVariant can be grouped into 4 broad
 129  * purposes: memory for serialised data, memory for the type
 130  * information cache, buffer management memory and memory for the
 131  * #GVariant structure itself.
 132  *
 133  * ## Serialised Data Memory
 134  *
 135  * This is the memory that is used for storing GVariant data in
 136  * serialised form.  This is what would be sent over the network or
 137  * what would end up on disk, not counting any indicator of the
 138  * endianness, or of the length or type of the top-level variant.
 139  *
 140  * The amount of memory required to store a boolean is 1 byte. 16,
 141  * 32 and 64 bit integers and double precision floating point numbers
 142  * use their &quot;natural&quot; size.  Strings (including object path and
 143  * signature strings) are stored with a nul terminator, and as such
 144  * use the length of the string plus 1 byte.
 145  *
 146  * Maybe types use no space at all to represent the null value and
 147  * use the same amount of space (sometimes plus one byte) as the
 148  * equivalent non-maybe-typed value to represent the non-null case.
 149  *
 150  * Arrays use the amount of space required to store each of their
 151  * members, concatenated.  Additionally, if the items stored in an
 152  * array are not of a fixed-size (ie: strings, other arrays, etc)
 153  * then an additional framing offset is stored for each item.  The
 154  * size of this offset is either 1, 2 or 4 bytes depending on the
 155  * overall size of the container.  Additionally, extra padding bytes
 156  * are added as required for alignment of child values.
 157  *
 158  * Tuples (including dictionary entries) use the amount of space
 159  * required to store each of their members, concatenated, plus one
 160  * framing offset (as per arrays) for each non-fixed-sized item in
 161  * the tuple, except for the last one.  Additionally, extra padding
 162  * bytes are added as required for alignment of child values.
 163  *
 164  * Variants use the same amount of space as the item inside of the
 165  * variant, plus 1 byte, plus the length of the type string for the
 166  * item inside the variant.
 167  *
 168  * As an example, consider a dictionary mapping strings to variants.
 169  * In the case that the dictionary is empty, 0 bytes are required for
 170  * the serialisation.
 171  *
 172  * If we add an item &quot;width&quot; that maps to the int32 value of 500 then
 173  * we will use 4 byte to store the int32 (so 6 for the variant
 174  * containing it) and 6 bytes for the string.  The variant must be
 175  * aligned to 8 after the 6 bytes of the string, so that&#39;s 2 extra
 176  * bytes.  6 (string) + 2 (padding) + 6 (variant) is 14 bytes used
 177  * for the dictionary entry.  An additional 1 byte is added to the
 178  * array as a framing offset making a total of 15 bytes.
 179  *
 180  * If we add another entry, &quot;title&quot; that maps to a nullable string
 181  * that happens to have a value of null, then we use 0 bytes for the
 182  * null value (and 3 bytes for the variant to contain it along with
 183  * its type string) plus 6 bytes for the string.  Again, we need 2
 184  * padding bytes.  That makes a total of 6 + 2 + 3 = 11 bytes.
 185  *
 186  * We now require extra padding between the two items in the array.
 187  * After the 14 bytes of the first item, that&#39;s 2 bytes required.
 188  * We now require 2 framing offsets for an extra two
 189  * bytes. 14 + 2 + 11 + 2 = 29 bytes to encode the entire two-item
 190  * dictionary.
 191  *
 192  * ## Type Information Cache
 193  *
 194  * For each GVariant type that currently exists in the program a type
 195  * information structure is kept in the type information cache.  The
 196  * type information structure is required for rapid deserialisation.
 197  *
 198  * Continuing with the above example, if a #GVariant exists with the
 199  * type &quot;a{sv}&quot; then a type information struct will exist for
 200  * &quot;a{sv}&quot;, &quot;{sv}&quot;, &quot;s&quot;, and &quot;v&quot;.  Multiple uses of the same type
 201  * will share the same type information.  Additionally, all
 202  * single-digit types are stored in read-only static memory and do
 203  * not contribute to the writable memory footprint of a program using
 204  * #GVariant.
 205  *
 206  * Aside from the type information structures stored in read-only
 207  * memory, there are two forms of type information.  One is used for
 208  * container types where there is a single element type: arrays and
 209  * maybe types.  The other is used for container types where there
 210  * are multiple element types: tuples and dictionary entries.
 211  *
 212  * Array type info structures are 6 * sizeof (void *), plus the
 213  * memory required to store the type string itself.  This means that
 214  * on 32-bit systems, the cache entry for &quot;a{sv}&quot; would require 30
 215  * bytes of memory (plus malloc overhead).
 216  *
 217  * Tuple type info structures are 6 * sizeof (void *), plus 4 *
 218  * sizeof (void *) for each item in the tuple, plus the memory
 219  * required to store the type string itself.  A 2-item tuple, for
 220  * example, would have a type information structure that consumed
 221  * writable memory in the size of 14 * sizeof (void *) (plus type
 222  * string)  This means that on 32-bit systems, the cache entry for
 223  * &quot;{sv}&quot; would require 61 bytes of memory (plus malloc overhead).
 224  *
 225  * This means that in total, for our &quot;a{sv}&quot; example, 91 bytes of
 226  * type information would be allocated.
 227  *
 228  * The type information cache, additionally, uses a #GHashTable to
 229  * store and look up the cached items and stores a pointer to this
 230  * hash table in static storage.  The hash table is freed when there
 231  * are zero items in the type cache.
 232  *
 233  * Although these sizes may seem large it is important to remember
 234  * that a program will probably only have a very small number of
 235  * different types of values in it and that only one type information
 236  * structure is required for many different values of the same type.
 237  *
 238  * ## Buffer Management Memory
 239  *
 240  * #GVariant uses an internal buffer management structure to deal
 241  * with the various different possible sources of serialised data
 242  * that it uses.  The buffer is responsible for ensuring that the
 243  * correct call is made when the data is no longer in use by
 244  * #GVariant.  This may involve a g_free() or a g_slice_free() or
 245  * even g_mapped_file_unref().
 246  *
 247  * One buffer management structure is used for each chunk of
 248  * serialised data.  The size of the buffer management structure
 249  * is 4 * (void *).  On 32-bit systems, that&#39;s 16 bytes.
 250  *
 251  * ## GVariant structure
 252  *
 253  * The size of a #GVariant structure is 6 * (void *).  On 32-bit
 254  * systems, that&#39;s 24 bytes.
 255  *
 256  * #GVariant structures only exist if they are explicitly created
 257  * with API calls.  For example, if a #GVariant is constructed out of
 258  * serialised data for the example given above (with the dictionary)
 259  * then although there are 9 individual values that comprise the
 260  * entire dictionary (two keys, two values, two variants containing
 261  * the values, two dictionary entries, plus the dictionary itself),
 262  * only 1 #GVariant instance exists -- the one referring to the
 263  * dictionary.
 264  *
 265  * If calls are made to start accessing the other values then
 266  * #GVariant instances will exist for those values only for as long
 267  * as they are in use (ie: until you call g_variant_unref()).  The
 268  * type information is shared.  The serialised data and the buffer
 269  * management structure for that serialised data is shared by the
 270  * child.
 271  *
 272  * ## Summary
 273  *
 274  * To put the entire example together, for our dictionary mapping
 275  * strings to variants (with two entries, as given above), we are
 276  * using 91 bytes of memory for type information, 29 bytes of memory
 277  * for the serialised data, 16 bytes for buffer management and 24
 278  * bytes for the #GVariant instance, or a total of 160 bytes, plus
 279  * malloc overhead.  If we were to use g_variant_get_child_value() to
 280  * access the two dictionary entries, we would use an additional 48
 281  * bytes.  If we were to have other dictionaries of the same type, we
 282  * would use more memory for the serialised data and buffer
 283  * management for those dictionaries, but the type information would
 284  * be shared.
 285  */
 286 
 287 /* definition of GVariant structure is in gvariant-core.c */
 288 
 289 /* this is a g_return_val_if_fail() for making
 290  * sure a (GVariant *) has the required type.
 291  */
 292 #define TYPE_CHECK(value, TYPE, val) \
 293   if G_UNLIKELY (!g_variant_is_of_type (value, TYPE)) {           \
 294     g_return_if_fail_warning (G_LOG_DOMAIN, G_STRFUNC,            \
 295                               &quot;g_variant_is_of_type (&quot; #value     \
 296                               &quot;, &quot; #TYPE &quot;)&quot;);                    \
 297     return val;                                                   \
 298   }
 299 
 300 /* Numeric Type Constructor/Getters {{{1 */
 301 /* &lt; private &gt;
 302  * g_variant_new_from_trusted:
 303  * @type: the #GVariantType
 304  * @data: the data to use
 305  * @size: the size of @data
 306  *
 307  * Constructs a new trusted #GVariant instance from the provided data.
 308  * This is used to implement g_variant_new_* for all the basic types.
 309  *
 310  * Note: @data must be backed by memory that is aligned appropriately for the
 311  * @type being loaded. Otherwise this function will internally create a copy of
 312  * the memory (since GLib 2.60) or (in older versions) fail and exit the
 313  * process.
 314  *
 315  * Returns: a new floating #GVariant
 316  */
 317 static GVariant *
 318 g_variant_new_from_trusted (const GVariantType *type,
 319                             gconstpointer       data,
 320                             gsize               size)
 321 {
 322   GVariant *value;
 323   GBytes *bytes;
 324 
 325   bytes = g_bytes_new (data, size);
 326   value = g_variant_new_from_bytes (type, bytes, TRUE);
 327   g_bytes_unref (bytes);
 328 
 329   return value;
 330 }
 331 
 332 /**
 333  * g_variant_new_boolean:
 334  * @value: a #gboolean value
 335  *
 336  * Creates a new boolean #GVariant instance -- either %TRUE or %FALSE.
 337  *
 338  * Returns: (transfer none): a floating reference to a new boolean #GVariant instance
 339  *
 340  * Since: 2.24
 341  **/
 342 GVariant *
 343 g_variant_new_boolean (gboolean value)
 344 {
 345   guchar v = value;
 346 
 347   return g_variant_new_from_trusted (G_VARIANT_TYPE_BOOLEAN, &amp;v, 1);
 348 }
 349 
 350 /**
 351  * g_variant_get_boolean:
 352  * @value: a boolean #GVariant instance
 353  *
 354  * Returns the boolean value of @value.
 355  *
 356  * It is an error to call this function with a @value of any type
 357  * other than %G_VARIANT_TYPE_BOOLEAN.
 358  *
 359  * Returns: %TRUE or %FALSE
 360  *
 361  * Since: 2.24
 362  **/
 363 gboolean
 364 g_variant_get_boolean (GVariant *value)
 365 {
 366   const guchar *data;
 367 
 368   TYPE_CHECK (value, G_VARIANT_TYPE_BOOLEAN, FALSE);
 369 
 370   data = g_variant_get_data (value);
 371 
 372   return data != NULL ? *data != 0 : FALSE;
 373 }
 374 
 375 /* the constructors and accessors for byte, int{16,32,64}, handles and
 376  * doubles all look pretty much exactly the same, so we reduce
 377  * copy/pasting here.
 378  */
 379 #define NUMERIC_TYPE(TYPE, type, ctype) \
 380   GVariant *g_variant_new_##type (ctype value) {                \
 381     return g_variant_new_from_trusted (G_VARIANT_TYPE_##TYPE,   \
 382                                        &amp;value, sizeof value);   \
 383   }                                                             \
 384   ctype g_variant_get_##type (GVariant *value) {                \
 385     const ctype *data;                                          \
 386     TYPE_CHECK (value, G_VARIANT_TYPE_ ## TYPE, 0);             \
 387     data = g_variant_get_data (value);                          \
 388     return data != NULL ? *data : 0;                            \
 389   }
 390 
 391 
 392 /**
 393  * g_variant_new_byte:
 394  * @value: a #guint8 value
 395  *
 396  * Creates a new byte #GVariant instance.
 397  *
 398  * Returns: (transfer none): a floating reference to a new byte #GVariant instance
 399  *
 400  * Since: 2.24
 401  **/
 402 /**
 403  * g_variant_get_byte:
 404  * @value: a byte #GVariant instance
 405  *
 406  * Returns the byte value of @value.
 407  *
 408  * It is an error to call this function with a @value of any type
 409  * other than %G_VARIANT_TYPE_BYTE.
 410  *
 411  * Returns: a #guint8
 412  *
 413  * Since: 2.24
 414  **/
 415 NUMERIC_TYPE (BYTE, byte, guint8)
 416 
 417 /**
 418  * g_variant_new_int16:
 419  * @value: a #gint16 value
 420  *
 421  * Creates a new int16 #GVariant instance.
 422  *
 423  * Returns: (transfer none): a floating reference to a new int16 #GVariant instance
 424  *
 425  * Since: 2.24
 426  **/
 427 /**
 428  * g_variant_get_int16:
 429  * @value: an int16 #GVariant instance
 430  *
 431  * Returns the 16-bit signed integer value of @value.
 432  *
 433  * It is an error to call this function with a @value of any type
 434  * other than %G_VARIANT_TYPE_INT16.
 435  *
 436  * Returns: a #gint16
 437  *
 438  * Since: 2.24
 439  **/
 440 NUMERIC_TYPE (INT16, int16, gint16)
 441 
 442 /**
 443  * g_variant_new_uint16:
 444  * @value: a #guint16 value
 445  *
 446  * Creates a new uint16 #GVariant instance.
 447  *
 448  * Returns: (transfer none): a floating reference to a new uint16 #GVariant instance
 449  *
 450  * Since: 2.24
 451  **/
 452 /**
 453  * g_variant_get_uint16:
 454  * @value: a uint16 #GVariant instance
 455  *
 456  * Returns the 16-bit unsigned integer value of @value.
 457  *
 458  * It is an error to call this function with a @value of any type
 459  * other than %G_VARIANT_TYPE_UINT16.
 460  *
 461  * Returns: a #guint16
 462  *
 463  * Since: 2.24
 464  **/
 465 NUMERIC_TYPE (UINT16, uint16, guint16)
 466 
 467 /**
 468  * g_variant_new_int32:
 469  * @value: a #gint32 value
 470  *
 471  * Creates a new int32 #GVariant instance.
 472  *
 473  * Returns: (transfer none): a floating reference to a new int32 #GVariant instance
 474  *
 475  * Since: 2.24
 476  **/
 477 /**
 478  * g_variant_get_int32:
 479  * @value: an int32 #GVariant instance
 480  *
 481  * Returns the 32-bit signed integer value of @value.
 482  *
 483  * It is an error to call this function with a @value of any type
 484  * other than %G_VARIANT_TYPE_INT32.
 485  *
 486  * Returns: a #gint32
 487  *
 488  * Since: 2.24
 489  **/
 490 NUMERIC_TYPE (INT32, int32, gint32)
 491 
 492 /**
 493  * g_variant_new_uint32:
 494  * @value: a #guint32 value
 495  *
 496  * Creates a new uint32 #GVariant instance.
 497  *
 498  * Returns: (transfer none): a floating reference to a new uint32 #GVariant instance
 499  *
 500  * Since: 2.24
 501  **/
 502 /**
 503  * g_variant_get_uint32:
 504  * @value: a uint32 #GVariant instance
 505  *
 506  * Returns the 32-bit unsigned integer value of @value.
 507  *
 508  * It is an error to call this function with a @value of any type
 509  * other than %G_VARIANT_TYPE_UINT32.
 510  *
 511  * Returns: a #guint32
 512  *
 513  * Since: 2.24
 514  **/
 515 NUMERIC_TYPE (UINT32, uint32, guint32)
 516 
 517 /**
 518  * g_variant_new_int64:
 519  * @value: a #gint64 value
 520  *
 521  * Creates a new int64 #GVariant instance.
 522  *
 523  * Returns: (transfer none): a floating reference to a new int64 #GVariant instance
 524  *
 525  * Since: 2.24
 526  **/
 527 /**
 528  * g_variant_get_int64:
 529  * @value: an int64 #GVariant instance
 530  *
 531  * Returns the 64-bit signed integer value of @value.
 532  *
 533  * It is an error to call this function with a @value of any type
 534  * other than %G_VARIANT_TYPE_INT64.
 535  *
 536  * Returns: a #gint64
 537  *
 538  * Since: 2.24
 539  **/
 540 NUMERIC_TYPE (INT64, int64, gint64)
 541 
 542 /**
 543  * g_variant_new_uint64:
 544  * @value: a #guint64 value
 545  *
 546  * Creates a new uint64 #GVariant instance.
 547  *
 548  * Returns: (transfer none): a floating reference to a new uint64 #GVariant instance
 549  *
 550  * Since: 2.24
 551  **/
 552 /**
 553  * g_variant_get_uint64:
 554  * @value: a uint64 #GVariant instance
 555  *
 556  * Returns the 64-bit unsigned integer value of @value.
 557  *
 558  * It is an error to call this function with a @value of any type
 559  * other than %G_VARIANT_TYPE_UINT64.
 560  *
 561  * Returns: a #guint64
 562  *
 563  * Since: 2.24
 564  **/
 565 NUMERIC_TYPE (UINT64, uint64, guint64)
 566 
 567 /**
 568  * g_variant_new_handle:
 569  * @value: a #gint32 value
 570  *
 571  * Creates a new handle #GVariant instance.
 572  *
 573  * By convention, handles are indexes into an array of file descriptors
 574  * that are sent alongside a D-Bus message.  If you&#39;re not interacting
 575  * with D-Bus, you probably don&#39;t need them.
 576  *
 577  * Returns: (transfer none): a floating reference to a new handle #GVariant instance
 578  *
 579  * Since: 2.24
 580  **/
 581 /**
 582  * g_variant_get_handle:
 583  * @value: a handle #GVariant instance
 584  *
 585  * Returns the 32-bit signed integer value of @value.
 586  *
 587  * It is an error to call this function with a @value of any type other
 588  * than %G_VARIANT_TYPE_HANDLE.
 589  *
 590  * By convention, handles are indexes into an array of file descriptors
 591  * that are sent alongside a D-Bus message.  If you&#39;re not interacting
 592  * with D-Bus, you probably don&#39;t need them.
 593  *
 594  * Returns: a #gint32
 595  *
 596  * Since: 2.24
 597  **/
 598 NUMERIC_TYPE (HANDLE, handle, gint32)
 599 
 600 /**
 601  * g_variant_new_double:
 602  * @value: a #gdouble floating point value
 603  *
 604  * Creates a new double #GVariant instance.
 605  *
 606  * Returns: (transfer none): a floating reference to a new double #GVariant instance
 607  *
 608  * Since: 2.24
 609  **/
 610 /**
 611  * g_variant_get_double:
 612  * @value: a double #GVariant instance
 613  *
 614  * Returns the double precision floating point value of @value.
 615  *
 616  * It is an error to call this function with a @value of any type
 617  * other than %G_VARIANT_TYPE_DOUBLE.
 618  *
 619  * Returns: a #gdouble
 620  *
 621  * Since: 2.24
 622  **/
 623 NUMERIC_TYPE (DOUBLE, double, gdouble)
 624 
 625 /* Container type Constructor / Deconstructors {{{1 */
 626 /**
 627  * g_variant_new_maybe:
 628  * @child_type: (nullable): the #GVariantType of the child, or %NULL
 629  * @child: (nullable): the child value, or %NULL
 630  *
 631  * Depending on if @child is %NULL, either wraps @child inside of a
 632  * maybe container or creates a Nothing instance for the given @type.
 633  *
 634  * At least one of @child_type and @child must be non-%NULL.
 635  * If @child_type is non-%NULL then it must be a definite type.
 636  * If they are both non-%NULL then @child_type must be the type
 637  * of @child.
 638  *
 639  * If @child is a floating reference (see g_variant_ref_sink()), the new
 640  * instance takes ownership of @child.
 641  *
 642  * Returns: (transfer none): a floating reference to a new #GVariant maybe instance
 643  *
 644  * Since: 2.24
 645  **/
 646 GVariant *
 647 g_variant_new_maybe (const GVariantType *child_type,
 648                      GVariant           *child)
 649 {
 650   GVariantType *maybe_type;
 651   GVariant *value;
 652 
 653   g_return_val_if_fail (child_type == NULL || g_variant_type_is_definite
 654                         (child_type), 0);
 655   g_return_val_if_fail (child_type != NULL || child != NULL, NULL);
 656   g_return_val_if_fail (child_type == NULL || child == NULL ||
 657                         g_variant_is_of_type (child, child_type),
 658                         NULL);
 659 
 660   if (child_type == NULL)
 661     child_type = g_variant_get_type (child);
 662 
 663   maybe_type = g_variant_type_new_maybe (child_type);
 664 
 665   if (child != NULL)
 666     {
 667       GVariant **children;
 668       gboolean trusted;
 669 
 670       children = g_new (GVariant *, 1);
 671       children[0] = g_variant_ref_sink (child);
 672       trusted = g_variant_is_trusted (children[0]);
 673 
 674       value = g_variant_new_from_children (maybe_type, children, 1, trusted);
 675     }
 676   else
 677     value = g_variant_new_from_children (maybe_type, NULL, 0, TRUE);
 678 
 679   g_variant_type_free (maybe_type);
 680 
 681   return value;
 682 }
 683 
 684 /**
 685  * g_variant_get_maybe:
 686  * @value: a maybe-typed value
 687  *
 688  * Given a maybe-typed #GVariant instance, extract its value.  If the
 689  * value is Nothing, then this function returns %NULL.
 690  *
 691  * Returns: (nullable) (transfer full): the contents of @value, or %NULL
 692  *
 693  * Since: 2.24
 694  **/
 695 GVariant *
 696 g_variant_get_maybe (GVariant *value)
 697 {
 698   TYPE_CHECK (value, G_VARIANT_TYPE_MAYBE, NULL);
 699 
 700   if (g_variant_n_children (value))
 701     return g_variant_get_child_value (value, 0);
 702 
 703   return NULL;
 704 }
 705 
 706 /**
 707  * g_variant_new_variant: (constructor)
 708  * @value: a #GVariant instance
 709  *
 710  * Boxes @value.  The result is a #GVariant instance representing a
 711  * variant containing the original value.
 712  *
 713  * If @child is a floating reference (see g_variant_ref_sink()), the new
 714  * instance takes ownership of @child.
 715  *
 716  * Returns: (transfer none): a floating reference to a new variant #GVariant instance
 717  *
 718  * Since: 2.24
 719  **/
 720 GVariant *
 721 g_variant_new_variant (GVariant *value)
 722 {
 723   g_return_val_if_fail (value != NULL, NULL);
 724 
 725   g_variant_ref_sink (value);
 726 
 727   return g_variant_new_from_children (G_VARIANT_TYPE_VARIANT,
 728                                       g_memdup (&amp;value, sizeof value),
 729                                       1, g_variant_is_trusted (value));
 730 }
 731 
 732 /**
 733  * g_variant_get_variant:
 734  * @value: a variant #GVariant instance
 735  *
 736  * Unboxes @value.  The result is the #GVariant instance that was
 737  * contained in @value.
 738  *
 739  * Returns: (transfer full): the item contained in the variant
 740  *
 741  * Since: 2.24
 742  **/
 743 GVariant *
 744 g_variant_get_variant (GVariant *value)
 745 {
 746   TYPE_CHECK (value, G_VARIANT_TYPE_VARIANT, NULL);
 747 
 748   return g_variant_get_child_value (value, 0);
 749 }
 750 
 751 /**
 752  * g_variant_new_array:
 753  * @child_type: (nullable): the element type of the new array
 754  * @children: (nullable) (array length=n_children): an array of
 755  *            #GVariant pointers, the children
 756  * @n_children: the length of @children
 757  *
 758  * Creates a new #GVariant array from @children.
 759  *
 760  * @child_type must be non-%NULL if @n_children is zero.  Otherwise, the
 761  * child type is determined by inspecting the first element of the
 762  * @children array.  If @child_type is non-%NULL then it must be a
 763  * definite type.
 764  *
 765  * The items of the array are taken from the @children array.  No entry
 766  * in the @children array may be %NULL.
 767  *
 768  * All items in the array must have the same type, which must be the
 769  * same as @child_type, if given.
 770  *
 771  * If the @children are floating references (see g_variant_ref_sink()), the
 772  * new instance takes ownership of them as if via g_variant_ref_sink().
 773  *
 774  * Returns: (transfer none): a floating reference to a new #GVariant array
 775  *
 776  * Since: 2.24
 777  **/
 778 GVariant *
 779 g_variant_new_array (const GVariantType *child_type,
 780                      GVariant * const   *children,
 781                      gsize               n_children)
 782 {
 783   GVariantType *array_type;
 784   GVariant **my_children;
 785   gboolean trusted;
 786   GVariant *value;
 787   gsize i;
 788 
 789   g_return_val_if_fail (n_children &gt; 0 || child_type != NULL, NULL);
 790   g_return_val_if_fail (n_children == 0 || children != NULL, NULL);
 791   g_return_val_if_fail (child_type == NULL ||
 792                         g_variant_type_is_definite (child_type), NULL);
 793 
 794   my_children = g_new (GVariant *, n_children);
 795   trusted = TRUE;
 796 
 797   if (child_type == NULL)
 798     child_type = g_variant_get_type (children[0]);
 799   array_type = g_variant_type_new_array (child_type);
 800 
 801   for (i = 0; i &lt; n_children; i++)
 802     {
 803       TYPE_CHECK (children[i], child_type, NULL);
 804       my_children[i] = g_variant_ref_sink (children[i]);
 805       trusted &amp;= g_variant_is_trusted (children[i]);
 806     }
 807 
 808   value = g_variant_new_from_children (array_type, my_children,
 809                                        n_children, trusted);
 810   g_variant_type_free (array_type);
 811 
 812   return value;
 813 }
 814 
 815 /*&lt; private &gt;
 816  * g_variant_make_tuple_type:
 817  * @children: (array length=n_children): an array of GVariant *
 818  * @n_children: the length of @children
 819  *
 820  * Return the type of a tuple containing @children as its items.
 821  **/
 822 static GVariantType *
 823 g_variant_make_tuple_type (GVariant * const *children,
 824                            gsize             n_children)
 825 {
 826   const GVariantType **types;
 827   GVariantType *type;
 828   gsize i;
 829 
 830   types = g_new (const GVariantType *, n_children);
 831 
 832   for (i = 0; i &lt; n_children; i++)
 833     types[i] = g_variant_get_type (children[i]);
 834 
 835   type = g_variant_type_new_tuple (types, n_children);
 836   g_free (types);
 837 
 838   return type;
 839 }
 840 
 841 /**
 842  * g_variant_new_tuple:
 843  * @children: (array length=n_children): the items to make the tuple out of
 844  * @n_children: the length of @children
 845  *
 846  * Creates a new tuple #GVariant out of the items in @children.  The
 847  * type is determined from the types of @children.  No entry in the
 848  * @children array may be %NULL.
 849  *
 850  * If @n_children is 0 then the unit tuple is constructed.
 851  *
 852  * If the @children are floating references (see g_variant_ref_sink()), the
 853  * new instance takes ownership of them as if via g_variant_ref_sink().
 854  *
 855  * Returns: (transfer none): a floating reference to a new #GVariant tuple
 856  *
 857  * Since: 2.24
 858  **/
 859 GVariant *
 860 g_variant_new_tuple (GVariant * const *children,
 861                      gsize             n_children)
 862 {
 863   GVariantType *tuple_type;
 864   GVariant **my_children;
 865   gboolean trusted;
 866   GVariant *value;
 867   gsize i;
 868 
 869   g_return_val_if_fail (n_children == 0 || children != NULL, NULL);
 870 
 871   my_children = g_new (GVariant *, n_children);
 872   trusted = TRUE;
 873 
 874   for (i = 0; i &lt; n_children; i++)
 875     {
 876       my_children[i] = g_variant_ref_sink (children[i]);
 877       trusted &amp;= g_variant_is_trusted (children[i]);
 878     }
 879 
 880   tuple_type = g_variant_make_tuple_type (children, n_children);
 881   value = g_variant_new_from_children (tuple_type, my_children,
 882                                        n_children, trusted);
 883   g_variant_type_free (tuple_type);
 884 
 885   return value;
 886 }
 887 
 888 /*&lt; private &gt;
 889  * g_variant_make_dict_entry_type:
 890  * @key: a #GVariant, the key
 891  * @val: a #GVariant, the value
 892  *
 893  * Return the type of a dictionary entry containing @key and @val as its
 894  * children.
 895  **/
 896 static GVariantType *
 897 g_variant_make_dict_entry_type (GVariant *key,
 898                                 GVariant *val)
 899 {
 900   return g_variant_type_new_dict_entry (g_variant_get_type (key),
 901                                         g_variant_get_type (val));
 902 }
 903 
 904 /**
 905  * g_variant_new_dict_entry: (constructor)
 906  * @key: a basic #GVariant, the key
 907  * @value: a #GVariant, the value
 908  *
 909  * Creates a new dictionary entry #GVariant. @key and @value must be
 910  * non-%NULL. @key must be a value of a basic type (ie: not a container).
 911  *
 912  * If the @key or @value are floating references (see g_variant_ref_sink()),
 913  * the new instance takes ownership of them as if via g_variant_ref_sink().
 914  *
 915  * Returns: (transfer none): a floating reference to a new dictionary entry #GVariant
 916  *
 917  * Since: 2.24
 918  **/
 919 GVariant *
 920 g_variant_new_dict_entry (GVariant *key,
 921                           GVariant *value)
 922 {
 923   GVariantType *dict_type;
 924   GVariant **children;
 925   gboolean trusted;
 926 
 927   g_return_val_if_fail (key != NULL &amp;&amp; value != NULL, NULL);
 928   g_return_val_if_fail (!g_variant_is_container (key), NULL);
 929 
 930   children = g_new (GVariant *, 2);
 931   children[0] = g_variant_ref_sink (key);
 932   children[1] = g_variant_ref_sink (value);
 933   trusted = g_variant_is_trusted (key) &amp;&amp; g_variant_is_trusted (value);
 934 
 935   dict_type = g_variant_make_dict_entry_type (key, value);
 936   value = g_variant_new_from_children (dict_type, children, 2, trusted);
 937   g_variant_type_free (dict_type);
 938 
 939   return value;
 940 }
 941 
 942 /**
 943  * g_variant_lookup: (skip)
 944  * @dictionary: a dictionary #GVariant
 945  * @key: the key to look up in the dictionary
 946  * @format_string: a GVariant format string
 947  * @...: the arguments to unpack the value into
 948  *
 949  * Looks up a value in a dictionary #GVariant.
 950  *
 951  * This function is a wrapper around g_variant_lookup_value() and
 952  * g_variant_get().  In the case that %NULL would have been returned,
 953  * this function returns %FALSE.  Otherwise, it unpacks the returned
 954  * value and returns %TRUE.
 955  *
 956  * @format_string determines the C types that are used for unpacking
 957  * the values and also determines if the values are copied or borrowed,
 958  * see the section on
 959  * [GVariant format strings][gvariant-format-strings-pointers].
 960  *
 961  * This function is currently implemented with a linear scan.  If you
 962  * plan to do many lookups then #GVariantDict may be more efficient.
 963  *
 964  * Returns: %TRUE if a value was unpacked
 965  *
 966  * Since: 2.28
 967  */
 968 gboolean
 969 g_variant_lookup (GVariant    *dictionary,
 970                   const gchar *key,
 971                   const gchar *format_string,
 972                   ...)
 973 {
 974   GVariantType *type;
 975   GVariant *value;
 976 
 977   /* flatten */
 978   g_variant_get_data (dictionary);
 979 
 980   type = g_variant_format_string_scan_type (format_string, NULL, NULL);
 981   value = g_variant_lookup_value (dictionary, key, type);
 982   g_variant_type_free (type);
 983 
 984   if (value)
 985     {
 986       va_list ap;
 987 
 988       va_start (ap, format_string);
 989       g_variant_get_va (value, format_string, NULL, &amp;ap);
 990       g_variant_unref (value);
 991       va_end (ap);
 992 
 993       return TRUE;
 994     }
 995 
 996   else
 997     return FALSE;
 998 }
 999 
1000 /**
1001  * g_variant_lookup_value:
1002  * @dictionary: a dictionary #GVariant
1003  * @key: the key to look up in the dictionary
1004  * @expected_type: (nullable): a #GVariantType, or %NULL
1005  *
1006  * Looks up a value in a dictionary #GVariant.
1007  *
1008  * This function works with dictionaries of the type a{s*} (and equally
1009  * well with type a{o*}, but we only further discuss the string case
1010  * for sake of clarity).
1011  *
1012  * In the event that @dictionary has the type a{sv}, the @expected_type
1013  * string specifies what type of value is expected to be inside of the
1014  * variant. If the value inside the variant has a different type then
1015  * %NULL is returned. In the event that @dictionary has a value type other
1016  * than v then @expected_type must directly match the value type and it is
1017  * used to unpack the value directly or an error occurs.
1018  *
1019  * In either case, if @key is not found in @dictionary, %NULL is returned.
1020  *
1021  * If the key is found and the value has the correct type, it is
1022  * returned.  If @expected_type was specified then any non-%NULL return
1023  * value will have this type.
1024  *
1025  * This function is currently implemented with a linear scan.  If you
1026  * plan to do many lookups then #GVariantDict may be more efficient.
1027  *
1028  * Returns: (transfer full): the value of the dictionary key, or %NULL
1029  *
1030  * Since: 2.28
1031  */
1032 GVariant *
1033 g_variant_lookup_value (GVariant           *dictionary,
1034                         const gchar        *key,
1035                         const GVariantType *expected_type)
1036 {
1037   GVariantIter iter;
1038   GVariant *entry;
1039   GVariant *value;
1040 
1041   g_return_val_if_fail (g_variant_is_of_type (dictionary,
1042                                               G_VARIANT_TYPE (&quot;a{s*}&quot;)) ||
1043                         g_variant_is_of_type (dictionary,
1044                                               G_VARIANT_TYPE (&quot;a{o*}&quot;)),
1045                         NULL);
1046 
1047   g_variant_iter_init (&amp;iter, dictionary);
1048 
1049   while ((entry = g_variant_iter_next_value (&amp;iter)))
1050     {
1051       GVariant *entry_key;
1052       gboolean matches;
1053 
1054       entry_key = g_variant_get_child_value (entry, 0);
1055       matches = strcmp (g_variant_get_string (entry_key, NULL), key) == 0;
1056       g_variant_unref (entry_key);
1057 
1058       if (matches)
1059         break;
1060 
1061       g_variant_unref (entry);
1062     }
1063 
1064   if (entry == NULL)
1065     return NULL;
1066 
1067   value = g_variant_get_child_value (entry, 1);
1068   g_variant_unref (entry);
1069 
1070   if (g_variant_is_of_type (value, G_VARIANT_TYPE_VARIANT))
1071     {
1072       GVariant *tmp;
1073 
1074       tmp = g_variant_get_variant (value);
1075       g_variant_unref (value);
1076 
1077       if (expected_type &amp;&amp; !g_variant_is_of_type (tmp, expected_type))
1078         {
1079           g_variant_unref (tmp);
1080           tmp = NULL;
1081         }
1082 
1083       value = tmp;
1084     }
1085 
1086   g_return_val_if_fail (expected_type == NULL || value == NULL ||
1087                         g_variant_is_of_type (value, expected_type), NULL);
1088 
1089   return value;
1090 }
1091 
1092 /**
1093  * g_variant_get_fixed_array:
1094  * @value: a #GVariant array with fixed-sized elements
1095  * @n_elements: (out): a pointer to the location to store the number of items
1096  * @element_size: the size of each element
1097  *
1098  * Provides access to the serialised data for an array of fixed-sized
1099  * items.
1100  *
1101  * @value must be an array with fixed-sized elements.  Numeric types are
1102  * fixed-size, as are tuples containing only other fixed-sized types.
1103  *
1104  * @element_size must be the size of a single element in the array,
1105  * as given by the section on
1106  * [serialized data memory][gvariant-serialised-data-memory].
1107  *
1108  * In particular, arrays of these fixed-sized types can be interpreted
1109  * as an array of the given C type, with @element_size set to the size
1110  * the appropriate type:
1111  * - %G_VARIANT_TYPE_INT16 (etc.): #gint16 (etc.)
1112  * - %G_VARIANT_TYPE_BOOLEAN: #guchar (not #gboolean!)
1113  * - %G_VARIANT_TYPE_BYTE: #guint8
1114  * - %G_VARIANT_TYPE_HANDLE: #guint32
1115  * - %G_VARIANT_TYPE_DOUBLE: #gdouble
1116  *
1117  * For example, if calling this function for an array of 32-bit integers,
1118  * you might say `sizeof(gint32)`. This value isn&#39;t used except for the purpose
1119  * of a double-check that the form of the serialised data matches the caller&#39;s
1120  * expectation.
1121  *
1122  * @n_elements, which must be non-%NULL, is set equal to the number of
1123  * items in the array.
1124  *
1125  * Returns: (array length=n_elements) (transfer none): a pointer to
1126  *     the fixed array
1127  *
1128  * Since: 2.24
1129  **/
1130 gconstpointer
1131 g_variant_get_fixed_array (GVariant *value,
1132                            gsize    *n_elements,
1133                            gsize     element_size)
1134 {
1135   GVariantTypeInfo *array_info;
1136   gsize array_element_size;
1137   gconstpointer data;
1138   gsize size;
1139 
1140   TYPE_CHECK (value, G_VARIANT_TYPE_ARRAY, NULL);
1141 
1142   g_return_val_if_fail (n_elements != NULL, NULL);
1143   g_return_val_if_fail (element_size &gt; 0, NULL);
1144 
1145   array_info = g_variant_get_type_info (value);
1146   g_variant_type_info_query_element (array_info, NULL, &amp;array_element_size);
1147 
1148   g_return_val_if_fail (array_element_size, NULL);
1149 
1150   if G_UNLIKELY (array_element_size != element_size)
1151     {
1152       if (array_element_size)
1153         g_critical (&quot;g_variant_get_fixed_array: assertion &quot;
1154                     &quot;&#39;g_variant_array_has_fixed_size (value, element_size)&#39; &quot;
1155                     &quot;failed: array size %&quot;G_GSIZE_FORMAT&quot; does not match &quot;
1156                     &quot;given element_size %&quot;G_GSIZE_FORMAT&quot;.&quot;,
1157                     array_element_size, element_size);
1158       else
1159         g_critical (&quot;g_variant_get_fixed_array: assertion &quot;
1160                     &quot;&#39;g_variant_array_has_fixed_size (value, element_size)&#39; &quot;
1161                     &quot;failed: array does not have fixed size.&quot;);
1162     }
1163 
1164   data = g_variant_get_data (value);
1165   size = g_variant_get_size (value);
1166 
1167   if (size % element_size)
1168     *n_elements = 0;
1169   else
1170     *n_elements = size / element_size;
1171 
1172   if (*n_elements)
1173     return data;
1174 
1175   return NULL;
1176 }
1177 
1178 /**
1179  * g_variant_new_fixed_array:
1180  * @element_type: the #GVariantType of each element
1181  * @elements: a pointer to the fixed array of contiguous elements
1182  * @n_elements: the number of elements
1183  * @element_size: the size of each element
1184  *
1185  * Constructs a new array #GVariant instance, where the elements are
1186  * of @element_type type.
1187  *
1188  * @elements must be an array with fixed-sized elements.  Numeric types are
1189  * fixed-size as are tuples containing only other fixed-sized types.
1190  *
1191  * @element_size must be the size of a single element in the array.
1192  * For example, if calling this function for an array of 32-bit integers,
1193  * you might say sizeof(gint32). This value isn&#39;t used except for the purpose
1194  * of a double-check that the form of the serialised data matches the caller&#39;s
1195  * expectation.
1196  *
1197  * @n_elements must be the length of the @elements array.
1198  *
1199  * Returns: (transfer none): a floating reference to a new array #GVariant instance
1200  *
1201  * Since: 2.32
1202  **/
1203 GVariant *
1204 g_variant_new_fixed_array (const GVariantType  *element_type,
1205                            gconstpointer        elements,
1206                            gsize                n_elements,
1207                            gsize                element_size)
1208 {
1209   GVariantType *array_type;
1210   gsize array_element_size;
1211   GVariantTypeInfo *array_info;
1212   GVariant *value;
1213   gpointer data;
1214 
1215   g_return_val_if_fail (g_variant_type_is_definite (element_type), NULL);
1216   g_return_val_if_fail (element_size &gt; 0, NULL);
1217 
1218   array_type = g_variant_type_new_array (element_type);
1219   array_info = g_variant_type_info_get (array_type);
1220   g_variant_type_info_query_element (array_info, NULL, &amp;array_element_size);
1221   if G_UNLIKELY (array_element_size != element_size)
1222     {
1223       if (array_element_size)
1224         g_critical (&quot;g_variant_new_fixed_array: array size %&quot; G_GSIZE_FORMAT
1225                     &quot; does not match given element_size %&quot; G_GSIZE_FORMAT &quot;.&quot;,
1226                     array_element_size, element_size);
1227       else
1228         g_critical (&quot;g_variant_get_fixed_array: array does not have fixed size.&quot;);
1229       return NULL;
1230     }
1231 
1232   data = g_memdup (elements, n_elements * element_size);
1233   value = g_variant_new_from_data (array_type, data,
1234                                    n_elements * element_size,
1235                                    FALSE, g_free, data);
1236 
1237   g_variant_type_free (array_type);
1238   g_variant_type_info_unref (array_info);
1239 
1240   return value;
1241 }
1242 
1243 /* String type constructor/getters/validation {{{1 */
1244 /**
1245  * g_variant_new_string:
1246  * @string: a normal UTF-8 nul-terminated string
1247  *
1248  * Creates a string #GVariant with the contents of @string.
1249  *
1250  * @string must be valid UTF-8, and must not be %NULL. To encode
1251  * potentially-%NULL strings, use g_variant_new() with `ms` as the
1252  * [format string][gvariant-format-strings-maybe-types].
1253  *
1254  * Returns: (transfer none): a floating reference to a new string #GVariant instance
1255  *
1256  * Since: 2.24
1257  **/
1258 GVariant *
1259 g_variant_new_string (const gchar *string)
1260 {
1261   g_return_val_if_fail (string != NULL, NULL);
1262   g_return_val_if_fail (g_utf8_validate (string, -1, NULL), NULL);
1263 
1264   return g_variant_new_from_trusted (G_VARIANT_TYPE_STRING,
1265                                      string, strlen (string) + 1);
1266 }
1267 
1268 /**
1269  * g_variant_new_take_string: (skip)
1270  * @string: a normal UTF-8 nul-terminated string
1271  *
1272  * Creates a string #GVariant with the contents of @string.
1273  *
1274  * @string must be valid UTF-8, and must not be %NULL. To encode
1275  * potentially-%NULL strings, use this with g_variant_new_maybe().
1276  *
1277  * This function consumes @string.  g_free() will be called on @string
1278  * when it is no longer required.
1279  *
1280  * You must not modify or access @string in any other way after passing
1281  * it to this function.  It is even possible that @string is immediately
1282  * freed.
1283  *
1284  * Returns: (transfer none): a floating reference to a new string
1285  *   #GVariant instance
1286  *
1287  * Since: 2.38
1288  **/
1289 GVariant *
1290 g_variant_new_take_string (gchar *string)
1291 {
1292   GVariant *value;
1293   GBytes *bytes;
1294 
1295   g_return_val_if_fail (string != NULL, NULL);
1296   g_return_val_if_fail (g_utf8_validate (string, -1, NULL), NULL);
1297 
1298   bytes = g_bytes_new_take (string, strlen (string) + 1);
1299   value = g_variant_new_from_bytes (G_VARIANT_TYPE_STRING, bytes, TRUE);
1300   g_bytes_unref (bytes);
1301 
1302   return value;
1303 }
1304 
1305 /**
1306  * g_variant_new_printf: (skip)
1307  * @format_string: a printf-style format string
1308  * @...: arguments for @format_string
1309  *
1310  * Creates a string-type GVariant using printf formatting.
1311  *
1312  * This is similar to calling g_strdup_printf() and then
1313  * g_variant_new_string() but it saves a temporary variable and an
1314  * unnecessary copy.
1315  *
1316  * Returns: (transfer none): a floating reference to a new string
1317  *   #GVariant instance
1318  *
1319  * Since: 2.38
1320  **/
1321 GVariant *
1322 g_variant_new_printf (const gchar *format_string,
1323                       ...)
1324 {
1325   GVariant *value;
1326   GBytes *bytes;
1327   gchar *string;
1328   va_list ap;
1329 
1330   g_return_val_if_fail (format_string != NULL, NULL);
1331 
1332   va_start (ap, format_string);
1333   string = g_strdup_vprintf (format_string, ap);
1334   va_end (ap);
1335 
1336   bytes = g_bytes_new_take (string, strlen (string) + 1);
1337   value = g_variant_new_from_bytes (G_VARIANT_TYPE_STRING, bytes, TRUE);
1338   g_bytes_unref (bytes);
1339 
1340   return value;
1341 }
1342 
1343 /**
1344  * g_variant_new_object_path:
1345  * @object_path: a normal C nul-terminated string
1346  *
1347  * Creates a D-Bus object path #GVariant with the contents of @string.
1348  * @string must be a valid D-Bus object path.  Use
1349  * g_variant_is_object_path() if you&#39;re not sure.
1350  *
1351  * Returns: (transfer none): a floating reference to a new object path #GVariant instance
1352  *
1353  * Since: 2.24
1354  **/
1355 GVariant *
1356 g_variant_new_object_path (const gchar *object_path)
1357 {
1358   g_return_val_if_fail (g_variant_is_object_path (object_path), NULL);
1359 
1360   return g_variant_new_from_trusted (G_VARIANT_TYPE_OBJECT_PATH,
1361                                      object_path, strlen (object_path) + 1);
1362 }
1363 
1364 /**
1365  * g_variant_is_object_path:
1366  * @string: a normal C nul-terminated string
1367  *
1368  * Determines if a given string is a valid D-Bus object path.  You
1369  * should ensure that a string is a valid D-Bus object path before
1370  * passing it to g_variant_new_object_path().
1371  *
1372  * A valid object path starts with &#39;/&#39; followed by zero or more
1373  * sequences of characters separated by &#39;/&#39; characters.  Each sequence
1374  * must contain only the characters &quot;[A-Z][a-z][0-9]_&quot;.  No sequence
1375  * (including the one following the final &#39;/&#39; character) may be empty.
1376  *
1377  * Returns: %TRUE if @string is a D-Bus object path
1378  *
1379  * Since: 2.24
1380  **/
1381 gboolean
1382 g_variant_is_object_path (const gchar *string)
1383 {
1384   g_return_val_if_fail (string != NULL, FALSE);
1385 
1386   return g_variant_serialiser_is_object_path (string, strlen (string) + 1);
1387 }
1388 
1389 /**
1390  * g_variant_new_signature:
1391  * @signature: a normal C nul-terminated string
1392  *
1393  * Creates a D-Bus type signature #GVariant with the contents of
1394  * @string.  @string must be a valid D-Bus type signature.  Use
1395  * g_variant_is_signature() if you&#39;re not sure.
1396  *
1397  * Returns: (transfer none): a floating reference to a new signature #GVariant instance
1398  *
1399  * Since: 2.24
1400  **/
1401 GVariant *
1402 g_variant_new_signature (const gchar *signature)
1403 {
1404   g_return_val_if_fail (g_variant_is_signature (signature), NULL);
1405 
1406   return g_variant_new_from_trusted (G_VARIANT_TYPE_SIGNATURE,
1407                                      signature, strlen (signature) + 1);
1408 }
1409 
1410 /**
1411  * g_variant_is_signature:
1412  * @string: a normal C nul-terminated string
1413  *
1414  * Determines if a given string is a valid D-Bus type signature.  You
1415  * should ensure that a string is a valid D-Bus type signature before
1416  * passing it to g_variant_new_signature().
1417  *
1418  * D-Bus type signatures consist of zero or more definite #GVariantType
1419  * strings in sequence.
1420  *
1421  * Returns: %TRUE if @string is a D-Bus type signature
1422  *
1423  * Since: 2.24
1424  **/
1425 gboolean
1426 g_variant_is_signature (const gchar *string)
1427 {
1428   g_return_val_if_fail (string != NULL, FALSE);
1429 
1430   return g_variant_serialiser_is_signature (string, strlen (string) + 1);
1431 }
1432 
1433 /**
1434  * g_variant_get_string:
1435  * @value: a string #GVariant instance
1436  * @length: (optional) (default 0) (out): a pointer to a #gsize,
1437  *          to store the length
1438  *
1439  * Returns the string value of a #GVariant instance with a string
1440  * type.  This includes the types %G_VARIANT_TYPE_STRING,
1441  * %G_VARIANT_TYPE_OBJECT_PATH and %G_VARIANT_TYPE_SIGNATURE.
1442  *
1443  * The string will always be UTF-8 encoded, and will never be %NULL.
1444  *
1445  * If @length is non-%NULL then the length of the string (in bytes) is
1446  * returned there.  For trusted values, this information is already
1447  * known.  For untrusted values, a strlen() will be performed.
1448  *
1449  * It is an error to call this function with a @value of any type
1450  * other than those three.
1451  *
1452  * The return value remains valid as long as @value exists.
1453  *
1454  * Returns: (transfer none): the constant string, UTF-8 encoded
1455  *
1456  * Since: 2.24
1457  **/
1458 const gchar *
1459 g_variant_get_string (GVariant *value,
1460                       gsize    *length)
1461 {
1462   gconstpointer data;
1463   gsize size;
1464 
1465   g_return_val_if_fail (value != NULL, NULL);
1466   g_return_val_if_fail (
1467     g_variant_is_of_type (value, G_VARIANT_TYPE_STRING) ||
1468     g_variant_is_of_type (value, G_VARIANT_TYPE_OBJECT_PATH) ||
1469     g_variant_is_of_type (value, G_VARIANT_TYPE_SIGNATURE), NULL);
1470 
1471   data = g_variant_get_data (value);
1472   size = g_variant_get_size (value);
1473 
1474   if (!g_variant_is_trusted (value))
1475     {
1476       switch (g_variant_classify (value))
1477         {
1478         case G_VARIANT_CLASS_STRING:
1479           if (g_variant_serialiser_is_string (data, size))
1480             break;
1481 
1482           data = &quot;&quot;;
1483           size = 1;
1484           break;
1485 
1486         case G_VARIANT_CLASS_OBJECT_PATH:
1487           if (g_variant_serialiser_is_object_path (data, size))
1488             break;
1489 
1490           data = &quot;/&quot;;
1491           size = 2;
1492           break;
1493 
1494         case G_VARIANT_CLASS_SIGNATURE:
1495           if (g_variant_serialiser_is_signature (data, size))
1496             break;
1497 
1498           data = &quot;&quot;;
1499           size = 1;
1500           break;
1501 
1502         default:
1503           g_assert_not_reached ();
1504         }
1505     }
1506 
1507   if (length)
1508     *length = size - 1;
1509 
1510   return data;
1511 }
1512 
1513 /**
1514  * g_variant_dup_string:
1515  * @value: a string #GVariant instance
1516  * @length: (out): a pointer to a #gsize, to store the length
1517  *
1518  * Similar to g_variant_get_string() except that instead of returning
1519  * a constant string, the string is duplicated.
1520  *
1521  * The string will always be UTF-8 encoded.
1522  *
1523  * The return value must be freed using g_free().
1524  *
1525  * Returns: (transfer full): a newly allocated string, UTF-8 encoded
1526  *
1527  * Since: 2.24
1528  **/
1529 gchar *
1530 g_variant_dup_string (GVariant *value,
1531                       gsize    *length)
1532 {
1533   return g_strdup (g_variant_get_string (value, length));
1534 }
1535 
1536 /**
1537  * g_variant_new_strv:
1538  * @strv: (array length=length) (element-type utf8): an array of strings
1539  * @length: the length of @strv, or -1
1540  *
1541  * Constructs an array of strings #GVariant from the given array of
1542  * strings.
1543  *
1544  * If @length is -1 then @strv is %NULL-terminated.
1545  *
1546  * Returns: (transfer none): a new floating #GVariant instance
1547  *
1548  * Since: 2.24
1549  **/
1550 GVariant *
1551 g_variant_new_strv (const gchar * const *strv,
1552                     gssize               length)
1553 {
1554   GVariant **strings;
1555   gsize i, length_unsigned;
1556 
1557   g_return_val_if_fail (length == 0 || strv != NULL, NULL);
1558 
1559   if (length &lt; 0)
1560     length = g_strv_length ((gchar **) strv);
1561   length_unsigned = length;
1562 
1563   strings = g_new (GVariant *, length_unsigned);
1564   for (i = 0; i &lt; length_unsigned; i++)
1565     strings[i] = g_variant_ref_sink (g_variant_new_string (strv[i]));
1566 
1567   return g_variant_new_from_children (G_VARIANT_TYPE_STRING_ARRAY,
1568                                       strings, length_unsigned, TRUE);
1569 }
1570 
1571 /**
1572  * g_variant_get_strv:
1573  * @value: an array of strings #GVariant
1574  * @length: (out) (optional): the length of the result, or %NULL
1575  *
1576  * Gets the contents of an array of strings #GVariant.  This call
1577  * makes a shallow copy; the return result should be released with
1578  * g_free(), but the individual strings must not be modified.
1579  *
1580  * If @length is non-%NULL then the number of elements in the result
1581  * is stored there.  In any case, the resulting array will be
1582  * %NULL-terminated.
1583  *
1584  * For an empty array, @length will be set to 0 and a pointer to a
1585  * %NULL pointer will be returned.
1586  *
1587  * Returns: (array length=length zero-terminated=1) (transfer container): an array of constant strings
1588  *
1589  * Since: 2.24
1590  **/
1591 const gchar **
1592 g_variant_get_strv (GVariant *value,
1593                     gsize    *length)
1594 {
1595   const gchar **strv;
1596   gsize n;
1597   gsize i;
1598 
1599   TYPE_CHECK (value, G_VARIANT_TYPE_STRING_ARRAY, NULL);
1600 
1601   g_variant_get_data (value);
1602   n = g_variant_n_children (value);
1603   strv = g_new (const gchar *, n + 1);
1604 
1605   for (i = 0; i &lt; n; i++)
1606     {
1607       GVariant *string;
1608 
1609       string = g_variant_get_child_value (value, i);
1610       strv[i] = g_variant_get_string (string, NULL);
1611       g_variant_unref (string);
1612     }
1613   strv[i] = NULL;
1614 
1615   if (length)
1616     *length = n;
1617 
1618   return strv;
1619 }
1620 
1621 /**
1622  * g_variant_dup_strv:
1623  * @value: an array of strings #GVariant
1624  * @length: (out) (optional): the length of the result, or %NULL
1625  *
1626  * Gets the contents of an array of strings #GVariant.  This call
1627  * makes a deep copy; the return result should be released with
1628  * g_strfreev().
1629  *
1630  * If @length is non-%NULL then the number of elements in the result
1631  * is stored there.  In any case, the resulting array will be
1632  * %NULL-terminated.
1633  *
1634  * For an empty array, @length will be set to 0 and a pointer to a
1635  * %NULL pointer will be returned.
1636  *
1637  * Returns: (array length=length zero-terminated=1) (transfer full): an array of strings
1638  *
1639  * Since: 2.24
1640  **/
1641 gchar **
1642 g_variant_dup_strv (GVariant *value,
1643                     gsize    *length)
1644 {
1645   gchar **strv;
1646   gsize n;
1647   gsize i;
1648 
1649   TYPE_CHECK (value, G_VARIANT_TYPE_STRING_ARRAY, NULL);
1650 
1651   n = g_variant_n_children (value);
1652   strv = g_new (gchar *, n + 1);
1653 
1654   for (i = 0; i &lt; n; i++)
1655     {
1656       GVariant *string;
1657 
1658       string = g_variant_get_child_value (value, i);
1659       strv[i] = g_variant_dup_string (string, NULL);
1660       g_variant_unref (string);
1661     }
1662   strv[i] = NULL;
1663 
1664   if (length)
1665     *length = n;
1666 
1667   return strv;
1668 }
1669 
1670 /**
1671  * g_variant_new_objv:
1672  * @strv: (array length=length) (element-type utf8): an array of strings
1673  * @length: the length of @strv, or -1
1674  *
1675  * Constructs an array of object paths #GVariant from the given array of
1676  * strings.
1677  *
1678  * Each string must be a valid #GVariant object path; see
1679  * g_variant_is_object_path().
1680  *
1681  * If @length is -1 then @strv is %NULL-terminated.
1682  *
1683  * Returns: (transfer none): a new floating #GVariant instance
1684  *
1685  * Since: 2.30
1686  **/
1687 GVariant *
1688 g_variant_new_objv (const gchar * const *strv,
1689                     gssize               length)
1690 {
1691   GVariant **strings;
1692   gsize i, length_unsigned;
1693 
1694   g_return_val_if_fail (length == 0 || strv != NULL, NULL);
1695 
1696   if (length &lt; 0)
1697     length = g_strv_length ((gchar **) strv);
1698   length_unsigned = length;
1699 
1700   strings = g_new (GVariant *, length_unsigned);
1701   for (i = 0; i &lt; length_unsigned; i++)
1702     strings[i] = g_variant_ref_sink (g_variant_new_object_path (strv[i]));
1703 
1704   return g_variant_new_from_children (G_VARIANT_TYPE_OBJECT_PATH_ARRAY,
1705                                       strings, length_unsigned, TRUE);
1706 }
1707 
1708 /**
1709  * g_variant_get_objv:
1710  * @value: an array of object paths #GVariant
1711  * @length: (out) (optional): the length of the result, or %NULL
1712  *
1713  * Gets the contents of an array of object paths #GVariant.  This call
1714  * makes a shallow copy; the return result should be released with
1715  * g_free(), but the individual strings must not be modified.
1716  *
1717  * If @length is non-%NULL then the number of elements in the result
1718  * is stored there.  In any case, the resulting array will be
1719  * %NULL-terminated.
1720  *
1721  * For an empty array, @length will be set to 0 and a pointer to a
1722  * %NULL pointer will be returned.
1723  *
1724  * Returns: (array length=length zero-terminated=1) (transfer container): an array of constant strings
1725  *
1726  * Since: 2.30
1727  **/
1728 const gchar **
1729 g_variant_get_objv (GVariant *value,
1730                     gsize    *length)
1731 {
1732   const gchar **strv;
1733   gsize n;
1734   gsize i;
1735 
1736   TYPE_CHECK (value, G_VARIANT_TYPE_OBJECT_PATH_ARRAY, NULL);
1737 
1738   g_variant_get_data (value);
1739   n = g_variant_n_children (value);
1740   strv = g_new (const gchar *, n + 1);
1741 
1742   for (i = 0; i &lt; n; i++)
1743     {
1744       GVariant *string;
1745 
1746       string = g_variant_get_child_value (value, i);
1747       strv[i] = g_variant_get_string (string, NULL);
1748       g_variant_unref (string);
1749     }
1750   strv[i] = NULL;
1751 
1752   if (length)
1753     *length = n;
1754 
1755   return strv;
1756 }
1757 
1758 /**
1759  * g_variant_dup_objv:
1760  * @value: an array of object paths #GVariant
1761  * @length: (out) (optional): the length of the result, or %NULL
1762  *
1763  * Gets the contents of an array of object paths #GVariant.  This call
1764  * makes a deep copy; the return result should be released with
1765  * g_strfreev().
1766  *
1767  * If @length is non-%NULL then the number of elements in the result
1768  * is stored there.  In any case, the resulting array will be
1769  * %NULL-terminated.
1770  *
1771  * For an empty array, @length will be set to 0 and a pointer to a
1772  * %NULL pointer will be returned.
1773  *
1774  * Returns: (array length=length zero-terminated=1) (transfer full): an array of strings
1775  *
1776  * Since: 2.30
1777  **/
1778 gchar **
1779 g_variant_dup_objv (GVariant *value,
1780                     gsize    *length)
1781 {
1782   gchar **strv;
1783   gsize n;
1784   gsize i;
1785 
1786   TYPE_CHECK (value, G_VARIANT_TYPE_OBJECT_PATH_ARRAY, NULL);
1787 
1788   n = g_variant_n_children (value);
1789   strv = g_new (gchar *, n + 1);
1790 
1791   for (i = 0; i &lt; n; i++)
1792     {
1793       GVariant *string;
1794 
1795       string = g_variant_get_child_value (value, i);
1796       strv[i] = g_variant_dup_string (string, NULL);
1797       g_variant_unref (string);
1798     }
1799   strv[i] = NULL;
1800 
1801   if (length)
1802     *length = n;
1803 
1804   return strv;
1805 }
1806 
1807 
1808 /**
1809  * g_variant_new_bytestring:
1810  * @string: (array zero-terminated=1) (element-type guint8): a normal
1811  *          nul-terminated string in no particular encoding
1812  *
1813  * Creates an array-of-bytes #GVariant with the contents of @string.
1814  * This function is just like g_variant_new_string() except that the
1815  * string need not be valid UTF-8.
1816  *
1817  * The nul terminator character at the end of the string is stored in
1818  * the array.
1819  *
1820  * Returns: (transfer none): a floating reference to a new bytestring #GVariant instance
1821  *
1822  * Since: 2.26
1823  **/
1824 GVariant *
1825 g_variant_new_bytestring (const gchar *string)
1826 {
1827   g_return_val_if_fail (string != NULL, NULL);
1828 
1829   return g_variant_new_from_trusted (G_VARIANT_TYPE_BYTESTRING,
1830                                      string, strlen (string) + 1);
1831 }
1832 
1833 /**
1834  * g_variant_get_bytestring:
1835  * @value: an array-of-bytes #GVariant instance
1836  *
1837  * Returns the string value of a #GVariant instance with an
1838  * array-of-bytes type.  The string has no particular encoding.
1839  *
1840  * If the array does not end with a nul terminator character, the empty
1841  * string is returned.  For this reason, you can always trust that a
1842  * non-%NULL nul-terminated string will be returned by this function.
1843  *
1844  * If the array contains a nul terminator character somewhere other than
1845  * the last byte then the returned string is the string, up to the first
1846  * such nul character.
1847  *
1848  * g_variant_get_fixed_array() should be used instead if the array contains
1849  * arbitrary data that could not be nul-terminated or could contain nul bytes.
1850  *
1851  * It is an error to call this function with a @value that is not an
1852  * array of bytes.
1853  *
1854  * The return value remains valid as long as @value exists.
1855  *
1856  * Returns: (transfer none) (array zero-terminated=1) (element-type guint8):
1857  *          the constant string
1858  *
1859  * Since: 2.26
1860  **/
1861 const gchar *
1862 g_variant_get_bytestring (GVariant *value)
1863 {
1864   const gchar *string;
1865   gsize size;
1866 
1867   TYPE_CHECK (value, G_VARIANT_TYPE_BYTESTRING, NULL);
1868 
1869   /* Won&#39;t be NULL since this is an array type */
1870   string = g_variant_get_data (value);
1871   size = g_variant_get_size (value);
1872 
1873   if (size &amp;&amp; string[size - 1] == &#39;\0&#39;)
1874     return string;
1875   else
1876     return &quot;&quot;;
1877 }
1878 
1879 /**
1880  * g_variant_dup_bytestring:
1881  * @value: an array-of-bytes #GVariant instance
1882  * @length: (out) (optional) (default NULL): a pointer to a #gsize, to store
1883  *          the length (not including the nul terminator)
1884  *
1885  * Similar to g_variant_get_bytestring() except that instead of
1886  * returning a constant string, the string is duplicated.
1887  *
1888  * The return value must be freed using g_free().
1889  *
1890  * Returns: (transfer full) (array zero-terminated=1 length=length) (element-type guint8):
1891  *          a newly allocated string
1892  *
1893  * Since: 2.26
1894  **/
1895 gchar *
1896 g_variant_dup_bytestring (GVariant *value,
1897                           gsize    *length)
1898 {
1899   const gchar *original = g_variant_get_bytestring (value);
1900   gsize size;
1901 
1902   /* don&#39;t crash in case get_bytestring() had an assert failure */
1903   if (original == NULL)
1904     return NULL;
1905 
1906   size = strlen (original);
1907 
1908   if (length)
1909     *length = size;
1910 
1911   return g_memdup (original, size + 1);
1912 }
1913 
1914 /**
1915  * g_variant_new_bytestring_array:
1916  * @strv: (array length=length): an array of strings
1917  * @length: the length of @strv, or -1
1918  *
1919  * Constructs an array of bytestring #GVariant from the given array of
1920  * strings.
1921  *
1922  * If @length is -1 then @strv is %NULL-terminated.
1923  *
1924  * Returns: (transfer none): a new floating #GVariant instance
1925  *
1926  * Since: 2.26
1927  **/
1928 GVariant *
1929 g_variant_new_bytestring_array (const gchar * const *strv,
1930                                 gssize               length)
1931 {
1932   GVariant **strings;
1933   gsize i, length_unsigned;
1934 
1935   g_return_val_if_fail (length == 0 || strv != NULL, NULL);
1936 
1937   if (length &lt; 0)
1938     length = g_strv_length ((gchar **) strv);
1939   length_unsigned = length;
1940 
1941   strings = g_new (GVariant *, length_unsigned);
1942   for (i = 0; i &lt; length_unsigned; i++)
1943     strings[i] = g_variant_ref_sink (g_variant_new_bytestring (strv[i]));
1944 
1945   return g_variant_new_from_children (G_VARIANT_TYPE_BYTESTRING_ARRAY,
1946                                       strings, length_unsigned, TRUE);
1947 }
1948 
1949 /**
1950  * g_variant_get_bytestring_array:
1951  * @value: an array of array of bytes #GVariant (&#39;aay&#39;)
1952  * @length: (out) (optional): the length of the result, or %NULL
1953  *
1954  * Gets the contents of an array of array of bytes #GVariant.  This call
1955  * makes a shallow copy; the return result should be released with
1956  * g_free(), but the individual strings must not be modified.
1957  *
1958  * If @length is non-%NULL then the number of elements in the result is
1959  * stored there.  In any case, the resulting array will be
1960  * %NULL-terminated.
1961  *
1962  * For an empty array, @length will be set to 0 and a pointer to a
1963  * %NULL pointer will be returned.
1964  *
1965  * Returns: (array length=length) (transfer container): an array of constant strings
1966  *
1967  * Since: 2.26
1968  **/
1969 const gchar **
1970 g_variant_get_bytestring_array (GVariant *value,
1971                                 gsize    *length)
1972 {
1973   const gchar **strv;
1974   gsize n;
1975   gsize i;
1976 
1977   TYPE_CHECK (value, G_VARIANT_TYPE_BYTESTRING_ARRAY, NULL);
1978 
1979   g_variant_get_data (value);
1980   n = g_variant_n_children (value);
1981   strv = g_new (const gchar *, n + 1);
1982 
1983   for (i = 0; i &lt; n; i++)
1984     {
1985       GVariant *string;
1986 
1987       string = g_variant_get_child_value (value, i);
1988       strv[i] = g_variant_get_bytestring (string);
1989       g_variant_unref (string);
1990     }
1991   strv[i] = NULL;
1992 
1993   if (length)
1994     *length = n;
1995 
1996   return strv;
1997 }
1998 
1999 /**
2000  * g_variant_dup_bytestring_array:
2001  * @value: an array of array of bytes #GVariant (&#39;aay&#39;)
2002  * @length: (out) (optional): the length of the result, or %NULL
2003  *
2004  * Gets the contents of an array of array of bytes #GVariant.  This call
2005  * makes a deep copy; the return result should be released with
2006  * g_strfreev().
2007  *
2008  * If @length is non-%NULL then the number of elements in the result is
2009  * stored there.  In any case, the resulting array will be
2010  * %NULL-terminated.
2011  *
2012  * For an empty array, @length will be set to 0 and a pointer to a
2013  * %NULL pointer will be returned.
2014  *
2015  * Returns: (array length=length) (transfer full): an array of strings
2016  *
2017  * Since: 2.26
2018  **/
2019 gchar **
2020 g_variant_dup_bytestring_array (GVariant *value,
2021                                 gsize    *length)
2022 {
2023   gchar **strv;
2024   gsize n;
2025   gsize i;
2026 
2027   TYPE_CHECK (value, G_VARIANT_TYPE_BYTESTRING_ARRAY, NULL);
2028 
2029   g_variant_get_data (value);
2030   n = g_variant_n_children (value);
2031   strv = g_new (gchar *, n + 1);
2032 
2033   for (i = 0; i &lt; n; i++)
2034     {
2035       GVariant *string;
2036 
2037       string = g_variant_get_child_value (value, i);
2038       strv[i] = g_variant_dup_bytestring (string, NULL);
2039       g_variant_unref (string);
2040     }
2041   strv[i] = NULL;
2042 
2043   if (length)
2044     *length = n;
2045 
2046   return strv;
2047 }
2048 
2049 /* Type checking and querying {{{1 */
2050 /**
2051  * g_variant_get_type:
2052  * @value: a #GVariant
2053  *
2054  * Determines the type of @value.
2055  *
2056  * The return value is valid for the lifetime of @value and must not
2057  * be freed.
2058  *
2059  * Returns: a #GVariantType
2060  *
2061  * Since: 2.24
2062  **/
2063 const GVariantType *
2064 g_variant_get_type (GVariant *value)
2065 {
2066   GVariantTypeInfo *type_info;
2067 
2068   g_return_val_if_fail (value != NULL, NULL);
2069 
2070   type_info = g_variant_get_type_info (value);
2071 
2072   return (GVariantType *) g_variant_type_info_get_type_string (type_info);
2073 }
2074 
2075 /**
2076  * g_variant_get_type_string:
2077  * @value: a #GVariant
2078  *
2079  * Returns the type string of @value.  Unlike the result of calling
2080  * g_variant_type_peek_string(), this string is nul-terminated.  This
2081  * string belongs to #GVariant and must not be freed.
2082  *
2083  * Returns: the type string for the type of @value
2084  *
2085  * Since: 2.24
2086  **/
2087 const gchar *
2088 g_variant_get_type_string (GVariant *value)
2089 {
2090   GVariantTypeInfo *type_info;
2091 
2092   g_return_val_if_fail (value != NULL, NULL);
2093 
2094   type_info = g_variant_get_type_info (value);
2095 
2096   return g_variant_type_info_get_type_string (type_info);
2097 }
2098 
2099 /**
2100  * g_variant_is_of_type:
2101  * @value: a #GVariant instance
2102  * @type: a #GVariantType
2103  *
2104  * Checks if a value has a type matching the provided type.
2105  *
2106  * Returns: %TRUE if the type of @value matches @type
2107  *
2108  * Since: 2.24
2109  **/
2110 gboolean
2111 g_variant_is_of_type (GVariant           *value,
2112                       const GVariantType *type)
2113 {
2114   return g_variant_type_is_subtype_of (g_variant_get_type (value), type);
2115 }
2116 
2117 /**
2118  * g_variant_is_container:
2119  * @value: a #GVariant instance
2120  *
2121  * Checks if @value is a container.
2122  *
2123  * Returns: %TRUE if @value is a container
2124  *
2125  * Since: 2.24
2126  */
2127 gboolean
2128 g_variant_is_container (GVariant *value)
2129 {
2130   return g_variant_type_is_container (g_variant_get_type (value));
2131 }
2132 
2133 
2134 /**
2135  * g_variant_classify:
2136  * @value: a #GVariant
2137  *
2138  * Classifies @value according to its top-level type.
2139  *
2140  * Returns: the #GVariantClass of @value
2141  *
2142  * Since: 2.24
2143  **/
2144 /**
2145  * GVariantClass:
2146  * @G_VARIANT_CLASS_BOOLEAN: The #GVariant is a boolean.
2147  * @G_VARIANT_CLASS_BYTE: The #GVariant is a byte.
2148  * @G_VARIANT_CLASS_INT16: The #GVariant is a signed 16 bit integer.
2149  * @G_VARIANT_CLASS_UINT16: The #GVariant is an unsigned 16 bit integer.
2150  * @G_VARIANT_CLASS_INT32: The #GVariant is a signed 32 bit integer.
2151  * @G_VARIANT_CLASS_UINT32: The #GVariant is an unsigned 32 bit integer.
2152  * @G_VARIANT_CLASS_INT64: The #GVariant is a signed 64 bit integer.
2153  * @G_VARIANT_CLASS_UINT64: The #GVariant is an unsigned 64 bit integer.
2154  * @G_VARIANT_CLASS_HANDLE: The #GVariant is a file handle index.
2155  * @G_VARIANT_CLASS_DOUBLE: The #GVariant is a double precision floating
2156  *                          point value.
2157  * @G_VARIANT_CLASS_STRING: The #GVariant is a normal string.
2158  * @G_VARIANT_CLASS_OBJECT_PATH: The #GVariant is a D-Bus object path
2159  *                               string.
2160  * @G_VARIANT_CLASS_SIGNATURE: The #GVariant is a D-Bus signature string.
2161  * @G_VARIANT_CLASS_VARIANT: The #GVariant is a variant.
2162  * @G_VARIANT_CLASS_MAYBE: The #GVariant is a maybe-typed value.
2163  * @G_VARIANT_CLASS_ARRAY: The #GVariant is an array.
2164  * @G_VARIANT_CLASS_TUPLE: The #GVariant is a tuple.
2165  * @G_VARIANT_CLASS_DICT_ENTRY: The #GVariant is a dictionary entry.
2166  *
2167  * The range of possible top-level types of #GVariant instances.
2168  *
2169  * Since: 2.24
2170  **/
2171 GVariantClass
2172 g_variant_classify (GVariant *value)
2173 {
2174   g_return_val_if_fail (value != NULL, 0);
2175 
2176   return *g_variant_get_type_string (value);
2177 }
2178 
2179 /* Pretty printer {{{1 */
2180 /* This function is not introspectable because if @string is NULL,
2181    @returns is (transfer full), otherwise it is (transfer none), which
2182    is not supported by GObjectIntrospection */
2183 /**
2184  * g_variant_print_string: (skip)
2185  * @value: a #GVariant
2186  * @string: (nullable) (default NULL): a #GString, or %NULL
2187  * @type_annotate: %TRUE if type information should be included in
2188  *                 the output
2189  *
2190  * Behaves as g_variant_print(), but operates on a #GString.
2191  *
2192  * If @string is non-%NULL then it is appended to and returned.  Else,
2193  * a new empty #GString is allocated and it is returned.
2194  *
2195  * Returns: a #GString containing the string
2196  *
2197  * Since: 2.24
2198  **/
2199 GString *
2200 g_variant_print_string (GVariant *value,
2201                         GString  *string,
2202                         gboolean  type_annotate)
2203 {
2204   if G_UNLIKELY (string == NULL)
2205     string = g_string_new (NULL);
2206 
2207   switch (g_variant_classify (value))
2208     {
2209     case G_VARIANT_CLASS_MAYBE:
2210       if (type_annotate)
2211         g_string_append_printf (string, &quot;@%s &quot;,
2212                                 g_variant_get_type_string (value));
2213 
2214       if (g_variant_n_children (value))
2215         {
2216           gchar *printed_child;
2217           GVariant *element;
2218 
2219           /* Nested maybes:
2220            *
2221            * Consider the case of the type &quot;mmi&quot;.  In this case we could
2222            * write &quot;just just 4&quot;, but &quot;4&quot; alone is totally unambiguous,
2223            * so we try to drop &quot;just&quot; where possible.
2224            *
2225            * We have to be careful not to always drop &quot;just&quot;, though,
2226            * since &quot;nothing&quot; needs to be distinguishable from &quot;just
2227            * nothing&quot;.  The case where we need to ensure we keep the
2228            * &quot;just&quot; is actually exactly the case where we have a nested
2229            * Nothing.
2230            *
2231            * Instead of searching for that nested Nothing, we just print
2232            * the contained value into a separate string and see if we
2233            * end up with &quot;nothing&quot; at the end of it.  If so, we need to
2234            * add &quot;just&quot; at our level.
2235            */
2236           element = g_variant_get_child_value (value, 0);
2237           printed_child = g_variant_print (element, FALSE);
2238           g_variant_unref (element);
2239 
2240           if (g_str_has_suffix (printed_child, &quot;nothing&quot;))
2241             g_string_append (string, &quot;just &quot;);
2242           g_string_append (string, printed_child);
2243           g_free (printed_child);
2244         }
2245       else
2246         g_string_append (string, &quot;nothing&quot;);
2247 
2248       break;
2249 
2250     case G_VARIANT_CLASS_ARRAY:
2251       /* it&#39;s an array so the first character of the type string is &#39;a&#39;
2252        *
2253        * if the first two characters are &#39;ay&#39; then it&#39;s a bytestring.
2254        * under certain conditions we print those as strings.
2255        */
2256       if (g_variant_get_type_string (value)[1] == &#39;y&#39;)
2257         {
2258           const gchar *str;
2259           gsize size;
2260           gsize i;
2261 
2262           /* first determine if it is a byte string.
2263            * that&#39;s when there&#39;s a single nul character: at the end.
2264            */
2265           str = g_variant_get_data (value);
2266           size = g_variant_get_size (value);
2267 
2268           for (i = 0; i &lt; size; i++)
2269             if (str[i] == &#39;\0&#39;)
2270               break;
2271 
2272           /* first nul byte is the last byte -&gt; it&#39;s a byte string. */
2273           if (i == size - 1)
2274             {
2275               gchar *escaped = g_strescape (str, NULL);
2276 
2277               /* use double quotes only if a &#39; is in the string */
2278               if (strchr (str, &#39;\&#39;&#39;))
2279                 g_string_append_printf (string, &quot;b\&quot;%s\&quot;&quot;, escaped);
2280               else
2281                 g_string_append_printf (string, &quot;b&#39;%s&#39;&quot;, escaped);
2282 
2283               g_free (escaped);
2284               break;
2285             }
2286 
2287           else
2288             {
2289               /* fall through and handle normally... */
2290             }
2291         }
2292 
2293       /*
2294        * if the first two characters are &#39;a{&#39; then it&#39;s an array of
2295        * dictionary entries (ie: a dictionary) so we print that
2296        * differently.
2297        */
2298       if (g_variant_get_type_string (value)[1] == &#39;{&#39;)
2299         /* dictionary */
2300         {
2301           const gchar *comma = &quot;&quot;;
2302           gsize n, i;
2303 
2304           if ((n = g_variant_n_children (value)) == 0)
2305             {
2306               if (type_annotate)
2307                 g_string_append_printf (string, &quot;@%s &quot;,
2308                                         g_variant_get_type_string (value));
2309               g_string_append (string, &quot;{}&quot;);
2310               break;
2311             }
2312 
2313           g_string_append_c (string, &#39;{&#39;);
2314           for (i = 0; i &lt; n; i++)
2315             {
2316               GVariant *entry, *key, *val;
2317 
2318               g_string_append (string, comma);
2319               comma = &quot;, &quot;;
2320 
2321               entry = g_variant_get_child_value (value, i);
2322               key = g_variant_get_child_value (entry, 0);
2323               val = g_variant_get_child_value (entry, 1);
2324               g_variant_unref (entry);
2325 
2326               g_variant_print_string (key, string, type_annotate);
2327               g_variant_unref (key);
2328               g_string_append (string, &quot;: &quot;);
2329               g_variant_print_string (val, string, type_annotate);
2330               g_variant_unref (val);
2331               type_annotate = FALSE;
2332             }
2333           g_string_append_c (string, &#39;}&#39;);
2334         }
2335       else
2336         /* normal (non-dictionary) array */
2337         {
2338           const gchar *comma = &quot;&quot;;
2339           gsize n, i;
2340 
2341           if ((n = g_variant_n_children (value)) == 0)
2342             {
2343               if (type_annotate)
2344                 g_string_append_printf (string, &quot;@%s &quot;,
2345                                         g_variant_get_type_string (value));
2346               g_string_append (string, &quot;[]&quot;);
2347               break;
2348             }
2349 
2350           g_string_append_c (string, &#39;[&#39;);
2351           for (i = 0; i &lt; n; i++)
2352             {
2353               GVariant *element;
2354 
2355               g_string_append (string, comma);
2356               comma = &quot;, &quot;;
2357 
2358               element = g_variant_get_child_value (value, i);
2359 
2360               g_variant_print_string (element, string, type_annotate);
2361               g_variant_unref (element);
2362               type_annotate = FALSE;
2363             }
2364           g_string_append_c (string, &#39;]&#39;);
2365         }
2366 
2367       break;
2368 
2369     case G_VARIANT_CLASS_TUPLE:
2370       {
2371         gsize n, i;
2372 
2373         n = g_variant_n_children (value);
2374 
2375         g_string_append_c (string, &#39;(&#39;);
2376         for (i = 0; i &lt; n; i++)
2377           {
2378             GVariant *element;
2379 
2380             element = g_variant_get_child_value (value, i);
2381             g_variant_print_string (element, string, type_annotate);
2382             g_string_append (string, &quot;, &quot;);
2383             g_variant_unref (element);
2384           }
2385 
2386         /* for &gt;1 item:  remove final &quot;, &quot;
2387          * for 1 item:   remove final &quot; &quot;, but leave the &quot;,&quot;
2388          * for 0 items:  there is only &quot;(&quot;, so remove nothing
2389          */
2390         g_string_truncate (string, string-&gt;len - (n &gt; 0) - (n &gt; 1));
2391         g_string_append_c (string, &#39;)&#39;);
2392       }
2393       break;
2394 
2395     case G_VARIANT_CLASS_DICT_ENTRY:
2396       {
2397         GVariant *element;
2398 
2399         g_string_append_c (string, &#39;{&#39;);
2400 
2401         element = g_variant_get_child_value (value, 0);
2402         g_variant_print_string (element, string, type_annotate);
2403         g_variant_unref (element);
2404 
2405         g_string_append (string, &quot;, &quot;);
2406 
2407         element = g_variant_get_child_value (value, 1);
2408         g_variant_print_string (element, string, type_annotate);
2409         g_variant_unref (element);
2410 
2411         g_string_append_c (string, &#39;}&#39;);
2412       }
2413       break;
2414 
2415     case G_VARIANT_CLASS_VARIANT:
2416       {
2417         GVariant *child = g_variant_get_variant (value);
2418 
2419         /* Always annotate types in nested variants, because they are
2420          * (by nature) of variable type.
2421          */
2422         g_string_append_c (string, &#39;&lt;&#39;);
2423         g_variant_print_string (child, string, TRUE);
2424         g_string_append_c (string, &#39;&gt;&#39;);
2425 
2426         g_variant_unref (child);
2427       }
2428       break;
2429 
2430     case G_VARIANT_CLASS_BOOLEAN:
2431       if (g_variant_get_boolean (value))
2432         g_string_append (string, &quot;true&quot;);
2433       else
2434         g_string_append (string, &quot;false&quot;);
2435       break;
2436 
2437     case G_VARIANT_CLASS_STRING:
2438       {
2439         const gchar *str = g_variant_get_string (value, NULL);
2440         gunichar quote = strchr (str, &#39;\&#39;&#39;) ? &#39;&quot;&#39; : &#39;\&#39;&#39;;
2441 
2442         g_string_append_c (string, quote);
2443 
2444         while (*str)
2445           {
2446             gunichar c = g_utf8_get_char (str);
2447 
2448             if (c == quote || c == &#39;\\&#39;)
2449               g_string_append_c (string, &#39;\\&#39;);
2450 
2451             if (g_unichar_isprint (c))
2452               g_string_append_unichar (string, c);
2453 
2454             else
2455               {
2456                 g_string_append_c (string, &#39;\\&#39;);
2457                 if (c &lt; 0x10000)
2458                   switch (c)
2459                     {
2460                     case &#39;\a&#39;:
2461                       g_string_append_c (string, &#39;a&#39;);
2462                       break;
2463 
2464                     case &#39;\b&#39;:
2465                       g_string_append_c (string, &#39;b&#39;);
2466                       break;
2467 
2468                     case &#39;\f&#39;:
2469                       g_string_append_c (string, &#39;f&#39;);
2470                       break;
2471 
2472                     case &#39;\n&#39;:
2473                       g_string_append_c (string, &#39;n&#39;);
2474                       break;
2475 
2476                     case &#39;\r&#39;:
2477                       g_string_append_c (string, &#39;r&#39;);
2478                       break;
2479 
2480                     case &#39;\t&#39;:
2481                       g_string_append_c (string, &#39;t&#39;);
2482                       break;
2483 
2484                     case &#39;\v&#39;:
2485                       g_string_append_c (string, &#39;v&#39;);
2486                       break;
2487 
2488                     default:
2489                       g_string_append_printf (string, &quot;u%04x&quot;, c);
2490                       break;
2491                     }
2492                  else
2493                    g_string_append_printf (string, &quot;U%08x&quot;, c);
2494               }
2495 
2496             str = g_utf8_next_char (str);
2497           }
2498 
2499         g_string_append_c (string, quote);
2500       }
2501       break;
2502 
2503     case G_VARIANT_CLASS_BYTE:
2504       if (type_annotate)
2505         g_string_append (string, &quot;byte &quot;);
2506       g_string_append_printf (string, &quot;0x%02x&quot;,
2507                               g_variant_get_byte (value));
2508       break;
2509 
2510     case G_VARIANT_CLASS_INT16:
2511       if (type_annotate)
2512         g_string_append (string, &quot;int16 &quot;);
2513       g_string_append_printf (string, &quot;%&quot;G_GINT16_FORMAT,
2514                               g_variant_get_int16 (value));
2515       break;
2516 
2517     case G_VARIANT_CLASS_UINT16:
2518       if (type_annotate)
2519         g_string_append (string, &quot;uint16 &quot;);
2520       g_string_append_printf (string, &quot;%&quot;G_GUINT16_FORMAT,
2521                               g_variant_get_uint16 (value));
2522       break;
2523 
2524     case G_VARIANT_CLASS_INT32:
2525       /* Never annotate this type because it is the default for numbers
2526        * (and this is a *pretty* printer)
2527        */
2528       g_string_append_printf (string, &quot;%&quot;G_GINT32_FORMAT,
2529                               g_variant_get_int32 (value));
2530       break;
2531 
2532     case G_VARIANT_CLASS_HANDLE:
2533       if (type_annotate)
2534         g_string_append (string, &quot;handle &quot;);
2535       g_string_append_printf (string, &quot;%&quot;G_GINT32_FORMAT,
2536                               g_variant_get_handle (value));
2537       break;
2538 
2539     case G_VARIANT_CLASS_UINT32:
2540       if (type_annotate)
2541         g_string_append (string, &quot;uint32 &quot;);
2542       g_string_append_printf (string, &quot;%&quot;G_GUINT32_FORMAT,
2543                               g_variant_get_uint32 (value));
2544       break;
2545 
2546     case G_VARIANT_CLASS_INT64:
2547       if (type_annotate)
2548         g_string_append (string, &quot;int64 &quot;);
2549       g_string_append_printf (string, &quot;%&quot;G_GINT64_FORMAT,
2550                               g_variant_get_int64 (value));
2551       break;
2552 
2553     case G_VARIANT_CLASS_UINT64:
2554       if (type_annotate)
2555         g_string_append (string, &quot;uint64 &quot;);
2556       g_string_append_printf (string, &quot;%&quot;G_GUINT64_FORMAT,
2557                               g_variant_get_uint64 (value));
2558       break;
2559 
2560     case G_VARIANT_CLASS_DOUBLE:
2561       {
2562         gchar buffer[100];
2563         gint i;
2564 
2565         g_ascii_dtostr (buffer, sizeof buffer, g_variant_get_double (value));
2566 
2567         for (i = 0; buffer[i]; i++)
2568           if (buffer[i] == &#39;.&#39; || buffer[i] == &#39;e&#39; ||
2569               buffer[i] == &#39;n&#39; || buffer[i] == &#39;N&#39;)
2570             break;
2571 
2572         /* if there is no &#39;.&#39; or &#39;e&#39; in the float then add one */
2573         if (buffer[i] == &#39;\0&#39;)
2574           {
2575             buffer[i++] = &#39;.&#39;;
2576             buffer[i++] = &#39;0&#39;;
2577             buffer[i++] = &#39;\0&#39;;
2578           }
2579 
2580         g_string_append (string, buffer);
2581       }
2582       break;
2583 
2584     case G_VARIANT_CLASS_OBJECT_PATH:
2585       if (type_annotate)
2586         g_string_append (string, &quot;objectpath &quot;);
2587       g_string_append_printf (string, &quot;\&#39;%s\&#39;&quot;,
2588                               g_variant_get_string (value, NULL));
2589       break;
2590 
2591     case G_VARIANT_CLASS_SIGNATURE:
2592       if (type_annotate)
2593         g_string_append (string, &quot;signature &quot;);
2594       g_string_append_printf (string, &quot;\&#39;%s\&#39;&quot;,
2595                               g_variant_get_string (value, NULL));
2596       break;
2597 
2598     default:
2599       g_assert_not_reached ();
2600   }
2601 
2602   return string;
2603 }
2604 
2605 /**
2606  * g_variant_print:
2607  * @value: a #GVariant
2608  * @type_annotate: %TRUE if type information should be included in
2609  *                 the output
2610  *
2611  * Pretty-prints @value in the format understood by g_variant_parse().
2612  *
2613  * The format is described [here][gvariant-text].
2614  *
2615  * If @type_annotate is %TRUE, then type information is included in
2616  * the output.
2617  *
2618  * Returns: (transfer full): a newly-allocated string holding the result.
2619  *
2620  * Since: 2.24
2621  */
2622 gchar *
2623 g_variant_print (GVariant *value,
2624                  gboolean  type_annotate)
2625 {
2626   return g_string_free (g_variant_print_string (value, NULL, type_annotate),
2627                         FALSE);
2628 }
2629 
2630 /* Hash, Equal, Compare {{{1 */
2631 /**
2632  * g_variant_hash:
2633  * @value: (type GVariant): a basic #GVariant value as a #gconstpointer
2634  *
2635  * Generates a hash value for a #GVariant instance.
2636  *
2637  * The output of this function is guaranteed to be the same for a given
2638  * value only per-process.  It may change between different processor
2639  * architectures or even different versions of GLib.  Do not use this
2640  * function as a basis for building protocols or file formats.
2641  *
2642  * The type of @value is #gconstpointer only to allow use of this
2643  * function with #GHashTable.  @value must be a #GVariant.
2644  *
2645  * Returns: a hash value corresponding to @value
2646  *
2647  * Since: 2.24
2648  **/
2649 guint
2650 g_variant_hash (gconstpointer value_)
2651 {
2652   GVariant *value = (GVariant *) value_;
2653 
2654   switch (g_variant_classify (value))
2655     {
2656     case G_VARIANT_CLASS_STRING:
2657     case G_VARIANT_CLASS_OBJECT_PATH:
2658     case G_VARIANT_CLASS_SIGNATURE:
2659       return g_str_hash (g_variant_get_string (value, NULL));
2660 
2661     case G_VARIANT_CLASS_BOOLEAN:
2662       /* this is a very odd thing to hash... */
2663       return g_variant_get_boolean (value);
2664 
2665     case G_VARIANT_CLASS_BYTE:
2666       return g_variant_get_byte (value);
2667 
2668     case G_VARIANT_CLASS_INT16:
2669     case G_VARIANT_CLASS_UINT16:
2670       {
2671         const guint16 *ptr;
2672 
2673         ptr = g_variant_get_data (value);
2674 
2675         if (ptr)
2676           return *ptr;
2677         else
2678           return 0;
2679       }
2680 
2681     case G_VARIANT_CLASS_INT32:
2682     case G_VARIANT_CLASS_UINT32:
2683     case G_VARIANT_CLASS_HANDLE:
2684       {
2685         const guint *ptr;
2686 
2687         ptr = g_variant_get_data (value);
2688 
2689         if (ptr)
2690           return *ptr;
2691         else
2692           return 0;
2693       }
2694 
2695     case G_VARIANT_CLASS_INT64:
2696     case G_VARIANT_CLASS_UINT64:
2697     case G_VARIANT_CLASS_DOUBLE:
2698       /* need a separate case for these guys because otherwise
2699        * performance could be quite bad on big endian systems
2700        */
2701       {
2702         const guint *ptr;
2703 
2704         ptr = g_variant_get_data (value);
2705 
2706         if (ptr)
2707           return ptr[0] + ptr[1];
2708         else
2709           return 0;
2710       }
2711 
2712     default:
2713       g_return_val_if_fail (!g_variant_is_container (value), 0);
2714       g_assert_not_reached ();
2715     }
2716 }
2717 
2718 /**
2719  * g_variant_equal:
2720  * @one: (type GVariant): a #GVariant instance
2721  * @two: (type GVariant): a #GVariant instance
2722  *
2723  * Checks if @one and @two have the same type and value.
2724  *
2725  * The types of @one and @two are #gconstpointer only to allow use of
2726  * this function with #GHashTable.  They must each be a #GVariant.
2727  *
2728  * Returns: %TRUE if @one and @two are equal
2729  *
2730  * Since: 2.24
2731  **/
2732 gboolean
2733 g_variant_equal (gconstpointer one,
2734                  gconstpointer two)
2735 {
2736   gboolean equal;
2737 
2738   g_return_val_if_fail (one != NULL &amp;&amp; two != NULL, FALSE);
2739 
2740   if (g_variant_get_type_info ((GVariant *) one) !=
2741       g_variant_get_type_info ((GVariant *) two))
2742     return FALSE;
2743 
2744   /* if both values are trusted to be in their canonical serialised form
2745    * then a simple memcmp() of their serialised data will answer the
2746    * question.
2747    *
2748    * if not, then this might generate a false negative (since it is
2749    * possible for two different byte sequences to represent the same
2750    * value).  for now we solve this by pretty-printing both values and
2751    * comparing the result.
2752    */
2753   if (g_variant_is_trusted ((GVariant *) one) &amp;&amp;
2754       g_variant_is_trusted ((GVariant *) two))
2755     {
2756       gconstpointer data_one, data_two;
2757       gsize size_one, size_two;
2758 
2759       size_one = g_variant_get_size ((GVariant *) one);
2760       size_two = g_variant_get_size ((GVariant *) two);
2761 
2762       if (size_one != size_two)
2763         return FALSE;
2764 
2765       data_one = g_variant_get_data ((GVariant *) one);
2766       data_two = g_variant_get_data ((GVariant *) two);
2767 
2768       equal = memcmp (data_one, data_two, size_one) == 0;
2769     }
2770   else
2771     {
2772       gchar *strone, *strtwo;
2773 
2774       strone = g_variant_print ((GVariant *) one, FALSE);
2775       strtwo = g_variant_print ((GVariant *) two, FALSE);
2776       equal = strcmp (strone, strtwo) == 0;
2777       g_free (strone);
2778       g_free (strtwo);
2779     }
2780 
2781   return equal;
2782 }
2783 
2784 /**
2785  * g_variant_compare:
2786  * @one: (type GVariant): a basic-typed #GVariant instance
2787  * @two: (type GVariant): a #GVariant instance of the same type
2788  *
2789  * Compares @one and @two.
2790  *
2791  * The types of @one and @two are #gconstpointer only to allow use of
2792  * this function with #GTree, #GPtrArray, etc.  They must each be a
2793  * #GVariant.
2794  *
2795  * Comparison is only defined for basic types (ie: booleans, numbers,
2796  * strings).  For booleans, %FALSE is less than %TRUE.  Numbers are
2797  * ordered in the usual way.  Strings are in ASCII lexographical order.
2798  *
2799  * It is a programmer error to attempt to compare container values or
2800  * two values that have types that are not exactly equal.  For example,
2801  * you cannot compare a 32-bit signed integer with a 32-bit unsigned
2802  * integer.  Also note that this function is not particularly
2803  * well-behaved when it comes to comparison of doubles; in particular,
2804  * the handling of incomparable values (ie: NaN) is undefined.
2805  *
2806  * If you only require an equality comparison, g_variant_equal() is more
2807  * general.
2808  *
2809  * Returns: negative value if a &lt; b;
2810  *          zero if a = b;
2811  *          positive value if a &gt; b.
2812  *
2813  * Since: 2.26
2814  **/
2815 gint
2816 g_variant_compare (gconstpointer one,
2817                    gconstpointer two)
2818 {
2819   GVariant *a = (GVariant *) one;
2820   GVariant *b = (GVariant *) two;
2821 
2822   g_return_val_if_fail (g_variant_classify (a) == g_variant_classify (b), 0);
2823 
2824   switch (g_variant_classify (a))
2825     {
2826     case G_VARIANT_CLASS_BOOLEAN:
2827       return g_variant_get_boolean (a) -
2828              g_variant_get_boolean (b);
2829 
2830     case G_VARIANT_CLASS_BYTE:
2831       return ((gint) g_variant_get_byte (a)) -
2832              ((gint) g_variant_get_byte (b));
2833 
2834     case G_VARIANT_CLASS_INT16:
2835       return ((gint) g_variant_get_int16 (a)) -
2836              ((gint) g_variant_get_int16 (b));
2837 
2838     case G_VARIANT_CLASS_UINT16:
2839       return ((gint) g_variant_get_uint16 (a)) -
2840              ((gint) g_variant_get_uint16 (b));
2841 
2842     case G_VARIANT_CLASS_INT32:
2843       {
2844         gint32 a_val = g_variant_get_int32 (a);
2845         gint32 b_val = g_variant_get_int32 (b);
2846 
2847         return (a_val == b_val) ? 0 : (a_val &gt; b_val) ? 1 : -1;
2848       }
2849 
2850     case G_VARIANT_CLASS_UINT32:
2851       {
2852         guint32 a_val = g_variant_get_uint32 (a);
2853         guint32 b_val = g_variant_get_uint32 (b);
2854 
2855         return (a_val == b_val) ? 0 : (a_val &gt; b_val) ? 1 : -1;
2856       }
2857 
2858     case G_VARIANT_CLASS_INT64:
2859       {
2860         gint64 a_val = g_variant_get_int64 (a);
2861         gint64 b_val = g_variant_get_int64 (b);
2862 
2863         return (a_val == b_val) ? 0 : (a_val &gt; b_val) ? 1 : -1;
2864       }
2865 
2866     case G_VARIANT_CLASS_UINT64:
2867       {
2868         guint64 a_val = g_variant_get_uint64 (a);
2869         guint64 b_val = g_variant_get_uint64 (b);
2870 
2871         return (a_val == b_val) ? 0 : (a_val &gt; b_val) ? 1 : -1;
2872       }
2873 
2874     case G_VARIANT_CLASS_DOUBLE:
2875       {
2876         gdouble a_val = g_variant_get_double (a);
2877         gdouble b_val = g_variant_get_double (b);
2878 
2879         return (a_val == b_val) ? 0 : (a_val &gt; b_val) ? 1 : -1;
2880       }
2881 
2882     case G_VARIANT_CLASS_STRING:
2883     case G_VARIANT_CLASS_OBJECT_PATH:
2884     case G_VARIANT_CLASS_SIGNATURE:
2885       return strcmp (g_variant_get_string (a, NULL),
2886                      g_variant_get_string (b, NULL));
2887 
2888     default:
2889       g_return_val_if_fail (!g_variant_is_container (a), 0);
2890       g_assert_not_reached ();
2891     }
2892 }
2893 
2894 /* GVariantIter {{{1 */
2895 /**
2896  * GVariantIter: (skip)
2897  *
2898  * #GVariantIter is an opaque data structure and can only be accessed
2899  * using the following functions.
2900  **/
2901 struct stack_iter
2902 {
2903   GVariant *value;
2904   gssize n, i;
2905 
2906   const gchar *loop_format;
2907 
2908   gsize padding[3];
2909   gsize magic;
2910 };
2911 
2912 G_STATIC_ASSERT (sizeof (struct stack_iter) &lt;= sizeof (GVariantIter));
2913 
2914 struct heap_iter
2915 {
2916   struct stack_iter iter;
2917 
2918   GVariant *value_ref;
2919   gsize magic;
2920 };
2921 
2922 #define GVSI(i)                 ((struct stack_iter *) (i))
2923 #define GVHI(i)                 ((struct heap_iter *) (i))
2924 #define GVSI_MAGIC              ((gsize) 3579507750u)
2925 #define GVHI_MAGIC              ((gsize) 1450270775u)
2926 #define is_valid_iter(i)        (i != NULL &amp;&amp; \
2927                                  GVSI(i)-&gt;magic == GVSI_MAGIC)
2928 #define is_valid_heap_iter(i)   (is_valid_iter(i) &amp;&amp; \
2929                                  GVHI(i)-&gt;magic == GVHI_MAGIC)
2930 
2931 /**
2932  * g_variant_iter_new:
2933  * @value: a container #GVariant
2934  *
2935  * Creates a heap-allocated #GVariantIter for iterating over the items
2936  * in @value.
2937  *
2938  * Use g_variant_iter_free() to free the return value when you no longer
2939  * need it.
2940  *
2941  * A reference is taken to @value and will be released only when
2942  * g_variant_iter_free() is called.
2943  *
2944  * Returns: (transfer full): a new heap-allocated #GVariantIter
2945  *
2946  * Since: 2.24
2947  **/
2948 GVariantIter *
2949 g_variant_iter_new (GVariant *value)
2950 {
2951   GVariantIter *iter;
2952 
2953   iter = (GVariantIter *) g_slice_new (struct heap_iter);
2954 #ifdef GSTREAMER_LITE
2955   if (iter == NULL) {
2956     return NULL;
2957   }
2958 #endif // GSTREAMER_LITE
2959   GVHI(iter)-&gt;value_ref = g_variant_ref (value);
2960   GVHI(iter)-&gt;magic = GVHI_MAGIC;
2961 
2962   g_variant_iter_init (iter, value);
2963 
2964   return iter;
2965 }
2966 
2967 /**
2968  * g_variant_iter_init: (skip)
2969  * @iter: a pointer to a #GVariantIter
2970  * @value: a container #GVariant
2971  *
2972  * Initialises (without allocating) a #GVariantIter.  @iter may be
2973  * completely uninitialised prior to this call; its old value is
2974  * ignored.
2975  *
2976  * The iterator remains valid for as long as @value exists, and need not
2977  * be freed in any way.
2978  *
2979  * Returns: the number of items in @value
2980  *
2981  * Since: 2.24
2982  **/
2983 gsize
2984 g_variant_iter_init (GVariantIter *iter,
2985                      GVariant     *value)
2986 {
2987   GVSI(iter)-&gt;magic = GVSI_MAGIC;
2988   GVSI(iter)-&gt;value = value;
2989   GVSI(iter)-&gt;n = g_variant_n_children (value);
2990   GVSI(iter)-&gt;i = -1;
2991   GVSI(iter)-&gt;loop_format = NULL;
2992 
2993   return GVSI(iter)-&gt;n;
2994 }
2995 
2996 #ifndef GSTREAMER_LITE
2997 /**
2998  * g_variant_iter_copy:
2999  * @iter: a #GVariantIter
3000  *
3001  * Creates a new heap-allocated #GVariantIter to iterate over the
3002  * container that was being iterated over by @iter.  Iteration begins on
3003  * the new iterator from the current position of the old iterator but
3004  * the two copies are independent past that point.
3005  *
3006  * Use g_variant_iter_free() to free the return value when you no longer
3007  * need it.
3008  *
3009  * A reference is taken to the container that @iter is iterating over
3010  * and will be releated only when g_variant_iter_free() is called.
3011  *
3012  * Returns: (transfer full): a new heap-allocated #GVariantIter
3013  *
3014  * Since: 2.24
3015  **/
3016 GVariantIter *
3017 g_variant_iter_copy (GVariantIter *iter)
3018 {
3019   GVariantIter *copy;
3020 
3021 #ifdef GSTREAMER_LITE
3022   if (iter == NULL) {
3023     return NULL;
3024   }
3025 #endif // GSTREAMER_LITE
3026 
3027   g_return_val_if_fail (is_valid_iter (iter), 0);
3028 
3029   copy = g_variant_iter_new (GVSI(iter)-&gt;value);
3030   GVSI(copy)-&gt;i = GVSI(iter)-&gt;i;
3031 
3032   return copy;
3033 }
3034 #endif // GSTREAMER_LITE
3035 
3036 /**
3037  * g_variant_iter_n_children:
3038  * @iter: a #GVariantIter
3039  *
3040  * Queries the number of child items in the container that we are
3041  * iterating over.  This is the total number of items -- not the number
3042  * of items remaining.
3043  *
3044  * This function might be useful for preallocation of arrays.
3045  *
3046  * Returns: the number of children in the container
3047  *
3048  * Since: 2.24
3049  **/
3050 gsize
3051 g_variant_iter_n_children (GVariantIter *iter)
3052 {
3053   g_return_val_if_fail (is_valid_iter (iter), 0);
3054 
3055   return GVSI(iter)-&gt;n;
3056 }
3057 
3058 /**
3059  * g_variant_iter_free:
3060  * @iter: (transfer full): a heap-allocated #GVariantIter
3061  *
3062  * Frees a heap-allocated #GVariantIter.  Only call this function on
3063  * iterators that were returned by g_variant_iter_new() or
3064  * g_variant_iter_copy().
3065  *
3066  * Since: 2.24
3067  **/
3068 void
3069 g_variant_iter_free (GVariantIter *iter)
3070 {
3071   g_return_if_fail (is_valid_heap_iter (iter));
3072 
3073   g_variant_unref (GVHI(iter)-&gt;value_ref);
3074   GVHI(iter)-&gt;magic = 0;
3075 
3076   g_slice_free (struct heap_iter, GVHI(iter));
3077 }
3078 
3079 /**
3080  * g_variant_iter_next_value:
3081  * @iter: a #GVariantIter
3082  *
3083  * Gets the next item in the container.  If no more items remain then
3084  * %NULL is returned.
3085  *
3086  * Use g_variant_unref() to drop your reference on the return value when
3087  * you no longer need it.
3088  *
3089  * Here is an example for iterating with g_variant_iter_next_value():
3090  * |[&lt;!-- language=&quot;C&quot; --&gt;
3091  *   // recursively iterate a container
3092  *   void
3093  *   iterate_container_recursive (GVariant *container)
3094  *   {
3095  *     GVariantIter iter;
3096  *     GVariant *child;
3097  *
3098  *     g_variant_iter_init (&amp;iter, container);
3099  *     while ((child = g_variant_iter_next_value (&amp;iter)))
3100  *       {
3101  *         g_print (&quot;type &#39;%s&#39;\n&quot;, g_variant_get_type_string (child));
3102  *
3103  *         if (g_variant_is_container (child))
3104  *           iterate_container_recursive (child);
3105  *
3106  *         g_variant_unref (child);
3107  *       }
3108  *   }
3109  * ]|
3110  *
3111  * Returns: (nullable) (transfer full): a #GVariant, or %NULL
3112  *
3113  * Since: 2.24
3114  **/
3115 GVariant *
3116 g_variant_iter_next_value (GVariantIter *iter)
3117 {
3118   g_return_val_if_fail (is_valid_iter (iter), FALSE);
3119 
3120   if G_UNLIKELY (GVSI(iter)-&gt;i &gt;= GVSI(iter)-&gt;n)
3121     {
3122       g_critical (&quot;g_variant_iter_next_value: must not be called again &quot;
3123                   &quot;after NULL has already been returned.&quot;);
3124       return NULL;
3125     }
3126 
3127   GVSI(iter)-&gt;i++;
3128 
3129   if (GVSI(iter)-&gt;i &lt; GVSI(iter)-&gt;n)
3130     return g_variant_get_child_value (GVSI(iter)-&gt;value, GVSI(iter)-&gt;i);
3131 
3132   return NULL;
3133 }
3134 
3135 /* GVariantBuilder {{{1 */
3136 /**
3137  * GVariantBuilder:
3138  *
3139  * A utility type for constructing container-type #GVariant instances.
3140  *
3141  * This is an opaque structure and may only be accessed using the
3142  * following functions.
3143  *
3144  * #GVariantBuilder is not threadsafe in any way.  Do not attempt to
3145  * access it from more than one thread.
3146  **/
3147 
3148 struct stack_builder
3149 {
3150   GVariantBuilder *parent;
3151   GVariantType *type;
3152 
3153   /* type constraint explicitly specified by &#39;type&#39;.
3154    * for tuple types, this moves along as we add more items.
3155    */
3156   const GVariantType *expected_type;
3157 
3158   /* type constraint implied by previous array item.
3159    */
3160   const GVariantType *prev_item_type;
3161 
3162   /* constraints on the number of children.  max = -1 for unlimited. */
3163   gsize min_items;
3164   gsize max_items;
3165 
3166   /* dynamically-growing pointer array */
3167   GVariant **children;
3168   gsize allocated_children;
3169   gsize offset;
3170 
3171   /* set to &#39;1&#39; if all items in the container will have the same type
3172    * (ie: maybe, array, variant) &#39;0&#39; if not (ie: tuple, dict entry)
3173    */
3174   guint uniform_item_types : 1;
3175 
3176   /* set to &#39;1&#39; initially and changed to &#39;0&#39; if an untrusted value is
3177    * added
3178    */
3179   guint trusted : 1;
3180 
3181   gsize magic;
3182 };
3183 
3184 G_STATIC_ASSERT (sizeof (struct stack_builder) &lt;= sizeof (GVariantBuilder));
3185 
3186 struct heap_builder
3187 {
3188   GVariantBuilder builder;
3189   gsize magic;
3190 
3191   gint ref_count;
3192 };
3193 
3194 #define GVSB(b)                  ((struct stack_builder *) (b))
3195 #define GVHB(b)                  ((struct heap_builder *) (b))
3196 #define GVSB_MAGIC               ((gsize) 1033660112u)
3197 #define GVSB_MAGIC_PARTIAL       ((gsize) 2942751021u)
3198 #define GVHB_MAGIC               ((gsize) 3087242682u)
3199 #define is_valid_builder(b)      (b != NULL &amp;&amp; \
3200                                   GVSB(b)-&gt;magic == GVSB_MAGIC)
3201 #define is_valid_heap_builder(b) (GVHB(b)-&gt;magic == GVHB_MAGIC)
3202 
3203 /* Just to make sure that by adding a union to GVariantBuilder, we
3204  * didn&#39;t accidentally change ABI. */
3205 G_STATIC_ASSERT (sizeof (GVariantBuilder) == sizeof (gsize[16]));
3206 
3207 static gboolean
3208 ensure_valid_builder (GVariantBuilder *builder)
3209 {
3210   if (is_valid_builder (builder))
3211     return TRUE;
3212   if (builder-&gt;u.s.partial_magic == GVSB_MAGIC_PARTIAL)
3213     {
3214       static GVariantBuilder cleared_builder;
3215 
3216       /* Make sure that only first two fields were set and the rest is
3217        * zeroed to avoid messing up the builder that had parent
3218        * address equal to GVSB_MAGIC_PARTIAL. */
3219       if (memcmp (cleared_builder.u.s.y, builder-&gt;u.s.y, sizeof cleared_builder.u.s.y))
3220         return FALSE;
3221 
3222       g_variant_builder_init (builder, builder-&gt;u.s.type);
3223     }
3224   return is_valid_builder (builder);
3225 }
3226 
3227 /**
3228  * g_variant_builder_new:
3229  * @type: a container type
3230  *
3231  * Allocates and initialises a new #GVariantBuilder.
3232  *
3233  * You should call g_variant_builder_unref() on the return value when it
3234  * is no longer needed.  The memory will not be automatically freed by
3235  * any other call.
3236  *
3237  * In most cases it is easier to place a #GVariantBuilder directly on
3238  * the stack of the calling function and initialise it with
3239  * g_variant_builder_init().
3240  *
3241  * Returns: (transfer full): a #GVariantBuilder
3242  *
3243  * Since: 2.24
3244  **/
3245 GVariantBuilder *
3246 g_variant_builder_new (const GVariantType *type)
3247 {
3248   GVariantBuilder *builder;
3249 
3250   builder = (GVariantBuilder *) g_slice_new (struct heap_builder);
3251 #ifdef GSTREAMER_LITE
3252   if (builder == NULL) {
3253     return NULL;
3254   }
3255 #endif // GSTREAMER_LITE
3256   g_variant_builder_init (builder, type);
3257   GVHB(builder)-&gt;magic = GVHB_MAGIC;
3258   GVHB(builder)-&gt;ref_count = 1;
3259 
3260   return builder;
3261 }
3262 
3263 /**
3264  * g_variant_builder_unref:
3265  * @builder: (transfer full): a #GVariantBuilder allocated by g_variant_builder_new()
3266  *
3267  * Decreases the reference count on @builder.
3268  *
3269  * In the event that there are no more references, releases all memory
3270  * associated with the #GVariantBuilder.
3271  *
3272  * Don&#39;t call this on stack-allocated #GVariantBuilder instances or bad
3273  * things will happen.
3274  *
3275  * Since: 2.24
3276  **/
3277 void
3278 g_variant_builder_unref (GVariantBuilder *builder)
3279 {
3280   g_return_if_fail (is_valid_heap_builder (builder));
3281 
3282   if (--GVHB(builder)-&gt;ref_count)
3283     return;
3284 
3285   g_variant_builder_clear (builder);
3286   GVHB(builder)-&gt;magic = 0;
3287 
3288   g_slice_free (struct heap_builder, GVHB(builder));
3289 }
3290 
3291 /**
3292  * g_variant_builder_ref:
3293  * @builder: a #GVariantBuilder allocated by g_variant_builder_new()
3294  *
3295  * Increases the reference count on @builder.
3296  *
3297  * Don&#39;t call this on stack-allocated #GVariantBuilder instances or bad
3298  * things will happen.
3299  *
3300  * Returns: (transfer full): a new reference to @builder
3301  *
3302  * Since: 2.24
3303  **/
3304 GVariantBuilder *
3305 g_variant_builder_ref (GVariantBuilder *builder)
3306 {
3307   g_return_val_if_fail (is_valid_heap_builder (builder), NULL);
3308 
3309   GVHB(builder)-&gt;ref_count++;
3310 
3311   return builder;
3312 }
3313 
3314 /**
3315  * g_variant_builder_clear: (skip)
3316  * @builder: a #GVariantBuilder
3317  *
3318  * Releases all memory associated with a #GVariantBuilder without
3319  * freeing the #GVariantBuilder structure itself.
3320  *
3321  * It typically only makes sense to do this on a stack-allocated
3322  * #GVariantBuilder if you want to abort building the value part-way
3323  * through.  This function need not be called if you call
3324  * g_variant_builder_end() and it also doesn&#39;t need to be called on
3325  * builders allocated with g_variant_builder_new() (see
3326  * g_variant_builder_unref() for that).
3327  *
3328  * This function leaves the #GVariantBuilder structure set to all-zeros.
3329  * It is valid to call this function on either an initialised
3330  * #GVariantBuilder or one that is set to all-zeros but it is not valid
3331  * to call this function on uninitialised memory.
3332  *
3333  * Since: 2.24
3334  **/
3335 void
3336 g_variant_builder_clear (GVariantBuilder *builder)
3337 {
3338   gsize i;
3339 
3340   if (GVSB(builder)-&gt;magic == 0)
3341     /* all-zeros or partial case */
3342     return;
3343 
3344   g_return_if_fail (ensure_valid_builder (builder));
3345 
3346   g_variant_type_free (GVSB(builder)-&gt;type);
3347 
3348   for (i = 0; i &lt; GVSB(builder)-&gt;offset; i++)
3349     g_variant_unref (GVSB(builder)-&gt;children[i]);
3350 
3351   g_free (GVSB(builder)-&gt;children);
3352 
3353   if (GVSB(builder)-&gt;parent)
3354     {
3355       g_variant_builder_clear (GVSB(builder)-&gt;parent);
3356       g_slice_free (GVariantBuilder, GVSB(builder)-&gt;parent);
3357     }
3358 
3359   memset (builder, 0, sizeof (GVariantBuilder));
3360 }
3361 
3362 /**
3363  * g_variant_builder_init: (skip)
3364  * @builder: a #GVariantBuilder
3365  * @type: a container type
3366  *
3367  * Initialises a #GVariantBuilder structure.
3368  *
3369  * @type must be non-%NULL.  It specifies the type of container to
3370  * construct.  It can be an indefinite type such as
3371  * %G_VARIANT_TYPE_ARRAY or a definite type such as &quot;as&quot; or &quot;(ii)&quot;.
3372  * Maybe, array, tuple, dictionary entry and variant-typed values may be
3373  * constructed.
3374  *
3375  * After the builder is initialised, values are added using
3376  * g_variant_builder_add_value() or g_variant_builder_add().
3377  *
3378  * After all the child values are added, g_variant_builder_end() frees
3379  * the memory associated with the builder and returns the #GVariant that
3380  * was created.
3381  *
3382  * This function completely ignores the previous contents of @builder.
3383  * On one hand this means that it is valid to pass in completely
3384  * uninitialised memory.  On the other hand, this means that if you are
3385  * initialising over top of an existing #GVariantBuilder you need to
3386  * first call g_variant_builder_clear() in order to avoid leaking
3387  * memory.
3388  *
3389  * You must not call g_variant_builder_ref() or
3390  * g_variant_builder_unref() on a #GVariantBuilder that was initialised
3391  * with this function.  If you ever pass a reference to a
3392  * #GVariantBuilder outside of the control of your own code then you
3393  * should assume that the person receiving that reference may try to use
3394  * reference counting; you should use g_variant_builder_new() instead of
3395  * this function.
3396  *
3397  * Since: 2.24
3398  **/
3399 void
3400 g_variant_builder_init (GVariantBuilder    *builder,
3401                         const GVariantType *type)
3402 {
3403   g_return_if_fail (type != NULL);
3404   g_return_if_fail (g_variant_type_is_container (type));
3405 
3406   memset (builder, 0, sizeof (GVariantBuilder));
3407 
3408   GVSB(builder)-&gt;type = g_variant_type_copy (type);
3409   GVSB(builder)-&gt;magic = GVSB_MAGIC;
3410   GVSB(builder)-&gt;trusted = TRUE;
3411 
3412   switch (*(const gchar *) type)
3413     {
3414     case G_VARIANT_CLASS_VARIANT:
3415       GVSB(builder)-&gt;uniform_item_types = TRUE;
3416       GVSB(builder)-&gt;allocated_children = 1;
3417       GVSB(builder)-&gt;expected_type = NULL;
3418       GVSB(builder)-&gt;min_items = 1;
3419       GVSB(builder)-&gt;max_items = 1;
3420       break;
3421 
3422     case G_VARIANT_CLASS_ARRAY:
3423       GVSB(builder)-&gt;uniform_item_types = TRUE;
3424       GVSB(builder)-&gt;allocated_children = 8;
3425       GVSB(builder)-&gt;expected_type =
3426         g_variant_type_element (GVSB(builder)-&gt;type);
3427       GVSB(builder)-&gt;min_items = 0;
3428       GVSB(builder)-&gt;max_items = -1;
3429       break;
3430 
3431     case G_VARIANT_CLASS_MAYBE:
3432       GVSB(builder)-&gt;uniform_item_types = TRUE;
3433       GVSB(builder)-&gt;allocated_children = 1;
3434       GVSB(builder)-&gt;expected_type =
3435         g_variant_type_element (GVSB(builder)-&gt;type);
3436       GVSB(builder)-&gt;min_items = 0;
3437       GVSB(builder)-&gt;max_items = 1;
3438       break;
3439 
3440     case G_VARIANT_CLASS_DICT_ENTRY:
3441       GVSB(builder)-&gt;uniform_item_types = FALSE;
3442       GVSB(builder)-&gt;allocated_children = 2;
3443       GVSB(builder)-&gt;expected_type =
3444         g_variant_type_key (GVSB(builder)-&gt;type);
3445       GVSB(builder)-&gt;min_items = 2;
3446       GVSB(builder)-&gt;max_items = 2;
3447       break;
3448 
3449     case &#39;r&#39;: /* G_VARIANT_TYPE_TUPLE was given */
3450       GVSB(builder)-&gt;uniform_item_types = FALSE;
3451       GVSB(builder)-&gt;allocated_children = 8;
3452       GVSB(builder)-&gt;expected_type = NULL;
3453       GVSB(builder)-&gt;min_items = 0;
3454       GVSB(builder)-&gt;max_items = -1;
3455       break;
3456 
3457     case G_VARIANT_CLASS_TUPLE: /* a definite tuple type was given */
3458       GVSB(builder)-&gt;allocated_children = g_variant_type_n_items (type);
3459       GVSB(builder)-&gt;expected_type =
3460         g_variant_type_first (GVSB(builder)-&gt;type);
3461       GVSB(builder)-&gt;min_items = GVSB(builder)-&gt;allocated_children;
3462       GVSB(builder)-&gt;max_items = GVSB(builder)-&gt;allocated_children;
3463       GVSB(builder)-&gt;uniform_item_types = FALSE;
3464       break;
3465 
3466     default:
3467       g_assert_not_reached ();
3468    }
3469 
3470   GVSB(builder)-&gt;children = g_new (GVariant *,
3471                                    GVSB(builder)-&gt;allocated_children);
3472 }
3473 
3474 static void
3475 g_variant_builder_make_room (struct stack_builder *builder)
3476 {
3477   if (builder-&gt;offset == builder-&gt;allocated_children)
3478     {
3479       builder-&gt;allocated_children *= 2;
3480       builder-&gt;children = g_renew (GVariant *, builder-&gt;children,
3481                                    builder-&gt;allocated_children);
3482     }
3483 }
3484 
3485 /**
3486  * g_variant_builder_add_value:
3487  * @builder: a #GVariantBuilder
3488  * @value: a #GVariant
3489  *
3490  * Adds @value to @builder.
3491  *
3492  * It is an error to call this function in any way that would create an
3493  * inconsistent value to be constructed.  Some examples of this are
3494  * putting different types of items into an array, putting the wrong
3495  * types or number of items in a tuple, putting more than one value into
3496  * a variant, etc.
3497  *
3498  * If @value is a floating reference (see g_variant_ref_sink()),
3499  * the @builder instance takes ownership of @value.
3500  *
3501  * Since: 2.24
3502  **/
3503 void
3504 g_variant_builder_add_value (GVariantBuilder *builder,
3505                              GVariant        *value)
3506 {
3507   g_return_if_fail (ensure_valid_builder (builder));
3508   g_return_if_fail (GVSB(builder)-&gt;offset &lt; GVSB(builder)-&gt;max_items);
3509   g_return_if_fail (!GVSB(builder)-&gt;expected_type ||
3510                     g_variant_is_of_type (value,
3511                                           GVSB(builder)-&gt;expected_type));
3512   g_return_if_fail (!GVSB(builder)-&gt;prev_item_type ||
3513                     g_variant_is_of_type (value,
3514                                           GVSB(builder)-&gt;prev_item_type));
3515 
3516   GVSB(builder)-&gt;trusted &amp;= g_variant_is_trusted (value);
3517 
3518   if (!GVSB(builder)-&gt;uniform_item_types)
3519     {
3520       /* advance our expected type pointers */
3521       if (GVSB(builder)-&gt;expected_type)
3522         GVSB(builder)-&gt;expected_type =
3523           g_variant_type_next (GVSB(builder)-&gt;expected_type);
3524 
3525       if (GVSB(builder)-&gt;prev_item_type)
3526         GVSB(builder)-&gt;prev_item_type =
3527           g_variant_type_next (GVSB(builder)-&gt;prev_item_type);
3528     }
3529   else
3530     GVSB(builder)-&gt;prev_item_type = g_variant_get_type (value);
3531 
3532   g_variant_builder_make_room (GVSB(builder));
3533 
3534   GVSB(builder)-&gt;children[GVSB(builder)-&gt;offset++] =
3535     g_variant_ref_sink (value);
3536 }
3537 
3538 /**
3539  * g_variant_builder_open:
3540  * @builder: a #GVariantBuilder
3541  * @type: the #GVariantType of the container
3542  *
3543  * Opens a subcontainer inside the given @builder.  When done adding
3544  * items to the subcontainer, g_variant_builder_close() must be called. @type
3545  * is the type of the container: so to build a tuple of several values, @type
3546  * must include the tuple itself.
3547  *
3548  * It is an error to call this function in any way that would cause an
3549  * inconsistent value to be constructed (ie: adding too many values or
3550  * a value of an incorrect type).
3551  *
3552  * Example of building a nested variant:
3553  * |[&lt;!-- language=&quot;C&quot; --&gt;
3554  * GVariantBuilder builder;
3555  * guint32 some_number = get_number ();
3556  * g_autoptr (GHashTable) some_dict = get_dict ();
3557  * GHashTableIter iter;
3558  * const gchar *key;
3559  * const GVariant *value;
3560  * g_autoptr (GVariant) output = NULL;
3561  *
3562  * g_variant_builder_init (&amp;builder, G_VARIANT_TYPE (&quot;(ua{sv})&quot;));
3563  * g_variant_builder_add (&amp;builder, &quot;u&quot;, some_number);
3564  * g_variant_builder_open (&amp;builder, G_VARIANT_TYPE (&quot;a{sv}&quot;));
3565  *
3566  * g_hash_table_iter_init (&amp;iter, some_dict);
3567  * while (g_hash_table_iter_next (&amp;iter, (gpointer *) &amp;key, (gpointer *) &amp;value))
3568  *   {
3569  *     g_variant_builder_open (&amp;builder, G_VARIANT_TYPE (&quot;{sv}&quot;));
3570  *     g_variant_builder_add (&amp;builder, &quot;s&quot;, key);
3571  *     g_variant_builder_add (&amp;builder, &quot;v&quot;, value);
3572  *     g_variant_builder_close (&amp;builder);
3573  *   }
3574  *
3575  * g_variant_builder_close (&amp;builder);
3576  *
3577  * output = g_variant_builder_end (&amp;builder);
3578  * ]|
3579  *
3580  * Since: 2.24
3581  **/
3582 void
3583 g_variant_builder_open (GVariantBuilder    *builder,
3584                         const GVariantType *type)
3585 {
3586   GVariantBuilder *parent;
3587 
3588   g_return_if_fail (ensure_valid_builder (builder));
3589   g_return_if_fail (GVSB(builder)-&gt;offset &lt; GVSB(builder)-&gt;max_items);
3590   g_return_if_fail (!GVSB(builder)-&gt;expected_type ||
3591                     g_variant_type_is_subtype_of (type,
3592                                                   GVSB(builder)-&gt;expected_type));
3593   g_return_if_fail (!GVSB(builder)-&gt;prev_item_type ||
3594                     g_variant_type_is_subtype_of (GVSB(builder)-&gt;prev_item_type,
3595                                                   type));
3596 
3597   parent = g_slice_dup (GVariantBuilder, builder);
3598   g_variant_builder_init (builder, type);
3599   GVSB(builder)-&gt;parent = parent;
3600 
3601   /* push the prev_item_type down into the subcontainer */
3602   if (GVSB(parent)-&gt;prev_item_type)
3603     {
3604       if (!GVSB(builder)-&gt;uniform_item_types)
3605         /* tuples and dict entries */
3606         GVSB(builder)-&gt;prev_item_type =
3607           g_variant_type_first (GVSB(parent)-&gt;prev_item_type);
3608 
3609       else if (!g_variant_type_is_variant (GVSB(builder)-&gt;type))
3610         /* maybes and arrays */
3611         GVSB(builder)-&gt;prev_item_type =
3612           g_variant_type_element (GVSB(parent)-&gt;prev_item_type);
3613     }
3614 }
3615 
3616 /**
3617  * g_variant_builder_close:
3618  * @builder: a #GVariantBuilder
3619  *
3620  * Closes the subcontainer inside the given @builder that was opened by
3621  * the most recent call to g_variant_builder_open().
3622  *
3623  * It is an error to call this function in any way that would create an
3624  * inconsistent value to be constructed (ie: too few values added to the
3625  * subcontainer).
3626  *
3627  * Since: 2.24
3628  **/
3629 void
3630 g_variant_builder_close (GVariantBuilder *builder)
3631 {
3632   GVariantBuilder *parent;
3633 
3634   g_return_if_fail (ensure_valid_builder (builder));
3635   g_return_if_fail (GVSB(builder)-&gt;parent != NULL);
3636 
3637   parent = GVSB(builder)-&gt;parent;
3638   GVSB(builder)-&gt;parent = NULL;
3639 
3640   g_variant_builder_add_value (parent, g_variant_builder_end (builder));
3641   *builder = *parent;
3642 
3643   g_slice_free (GVariantBuilder, parent);
3644 }
3645 
3646 /*&lt; private &gt;
3647  * g_variant_make_maybe_type:
3648  * @element: a #GVariant
3649  *
3650  * Return the type of a maybe containing @element.
3651  */
3652 static GVariantType *
3653 g_variant_make_maybe_type (GVariant *element)
3654 {
3655   return g_variant_type_new_maybe (g_variant_get_type (element));
3656 }
3657 
3658 /*&lt; private &gt;
3659  * g_variant_make_array_type:
3660  * @element: a #GVariant
3661  *
3662  * Return the type of an array containing @element.
3663  */
3664 static GVariantType *
3665 g_variant_make_array_type (GVariant *element)
3666 {
3667   return g_variant_type_new_array (g_variant_get_type (element));
3668 }
3669 
3670 /**
3671  * g_variant_builder_end:
3672  * @builder: a #GVariantBuilder
3673  *
3674  * Ends the builder process and returns the constructed value.
3675  *
3676  * It is not permissible to use @builder in any way after this call
3677  * except for reference counting operations (in the case of a
3678  * heap-allocated #GVariantBuilder) or by reinitialising it with
3679  * g_variant_builder_init() (in the case of stack-allocated). This
3680  * means that for the stack-allocated builders there is no need to
3681  * call g_variant_builder_clear() after the call to
3682  * g_variant_builder_end().
3683  *
3684  * It is an error to call this function in any way that would create an
3685  * inconsistent value to be constructed (ie: insufficient number of
3686  * items added to a container with a specific number of children
3687  * required).  It is also an error to call this function if the builder
3688  * was created with an indefinite array or maybe type and no children
3689  * have been added; in this case it is impossible to infer the type of
3690  * the empty array.
3691  *
3692  * Returns: (transfer none): a new, floating, #GVariant
3693  *
3694  * Since: 2.24
3695  **/
3696 GVariant *
3697 g_variant_builder_end (GVariantBuilder *builder)
3698 {
3699   GVariantType *my_type;
3700   GVariant *value;
3701 
3702   g_return_val_if_fail (ensure_valid_builder (builder), NULL);
3703   g_return_val_if_fail (GVSB(builder)-&gt;offset &gt;= GVSB(builder)-&gt;min_items,
3704                         NULL);
3705   g_return_val_if_fail (!GVSB(builder)-&gt;uniform_item_types ||
3706                         GVSB(builder)-&gt;prev_item_type != NULL ||
3707                         g_variant_type_is_definite (GVSB(builder)-&gt;type),
3708                         NULL);
3709 
3710   if (g_variant_type_is_definite (GVSB(builder)-&gt;type))
3711     my_type = g_variant_type_copy (GVSB(builder)-&gt;type);
3712 
3713   else if (g_variant_type_is_maybe (GVSB(builder)-&gt;type))
3714     my_type = g_variant_make_maybe_type (GVSB(builder)-&gt;children[0]);
3715 
3716   else if (g_variant_type_is_array (GVSB(builder)-&gt;type))
3717     my_type = g_variant_make_array_type (GVSB(builder)-&gt;children[0]);
3718 
3719   else if (g_variant_type_is_tuple (GVSB(builder)-&gt;type))
3720     my_type = g_variant_make_tuple_type (GVSB(builder)-&gt;children,
3721                                          GVSB(builder)-&gt;offset);
3722 
3723   else if (g_variant_type_is_dict_entry (GVSB(builder)-&gt;type))
3724     my_type = g_variant_make_dict_entry_type (GVSB(builder)-&gt;children[0],
3725                                               GVSB(builder)-&gt;children[1]);
3726   else
3727     g_assert_not_reached ();
3728 
3729   value = g_variant_new_from_children (my_type,
3730                                        g_renew (GVariant *,
3731                                                 GVSB(builder)-&gt;children,
3732                                                 GVSB(builder)-&gt;offset),
3733                                        GVSB(builder)-&gt;offset,
3734                                        GVSB(builder)-&gt;trusted);
3735   GVSB(builder)-&gt;children = NULL;
3736   GVSB(builder)-&gt;offset = 0;
3737 
3738   g_variant_builder_clear (builder);
3739   g_variant_type_free (my_type);
3740 
3741   return value;
3742 }
3743 
3744 /* GVariantDict {{{1 */
3745 
3746 /**
3747  * GVariantDict:
3748  *
3749  * #GVariantDict is a mutable interface to #GVariant dictionaries.
3750  *
3751  * It can be used for doing a sequence of dictionary lookups in an
3752  * efficient way on an existing #GVariant dictionary or it can be used
3753  * to construct new dictionaries with a hashtable-like interface.  It
3754  * can also be used for taking existing dictionaries and modifying them
3755  * in order to create new ones.
3756  *
3757  * #GVariantDict can only be used with %G_VARIANT_TYPE_VARDICT
3758  * dictionaries.
3759  *
3760  * It is possible to use #GVariantDict allocated on the stack or on the
3761  * heap.  When using a stack-allocated #GVariantDict, you begin with a
3762  * call to g_variant_dict_init() and free the resources with a call to
3763  * g_variant_dict_clear().
3764  *
3765  * Heap-allocated #GVariantDict follows normal refcounting rules: you
3766  * allocate it with g_variant_dict_new() and use g_variant_dict_ref()
3767  * and g_variant_dict_unref().
3768  *
3769  * g_variant_dict_end() is used to convert the #GVariantDict back into a
3770  * dictionary-type #GVariant.  When used with stack-allocated instances,
3771  * this also implicitly frees all associated memory, but for
3772  * heap-allocated instances, you must still call g_variant_dict_unref()
3773  * afterwards.
3774  *
3775  * You will typically want to use a heap-allocated #GVariantDict when
3776  * you expose it as part of an API.  For most other uses, the
3777  * stack-allocated form will be more convenient.
3778  *
3779  * Consider the following two examples that do the same thing in each
3780  * style: take an existing dictionary and look up the &quot;count&quot; uint32
3781  * key, adding 1 to it if it is found, or returning an error if the
3782  * key is not found.  Each returns the new dictionary as a floating
3783  * #GVariant.
3784  *
3785  * ## Using a stack-allocated GVariantDict
3786  *
3787  * |[&lt;!-- language=&quot;C&quot; --&gt;
3788  *   GVariant *
3789  *   add_to_count (GVariant  *orig,
3790  *                 GError   **error)
3791  *   {
3792  *     GVariantDict dict;
3793  *     guint32 count;
3794  *
3795  *     g_variant_dict_init (&amp;dict, orig);
3796  *     if (!g_variant_dict_lookup (&amp;dict, &quot;count&quot;, &quot;u&quot;, &amp;count))
3797  *       {
3798  *         g_set_error (...);
3799  *         g_variant_dict_clear (&amp;dict);
3800  *         return NULL;
3801  *       }
3802  *
3803  *     g_variant_dict_insert (&amp;dict, &quot;count&quot;, &quot;u&quot;, count + 1);
3804  *
3805  *     return g_variant_dict_end (&amp;dict);
3806  *   }
3807  * ]|
3808  *
3809  * ## Using heap-allocated GVariantDict
3810  *
3811  * |[&lt;!-- language=&quot;C&quot; --&gt;
3812  *   GVariant *
3813  *   add_to_count (GVariant  *orig,
3814  *                 GError   **error)
3815  *   {
3816  *     GVariantDict *dict;
3817  *     GVariant *result;
3818  *     guint32 count;
3819  *
3820  *     dict = g_variant_dict_new (orig);
3821  *
3822  *     if (g_variant_dict_lookup (dict, &quot;count&quot;, &quot;u&quot;, &amp;count))
3823  *       {
3824  *         g_variant_dict_insert (dict, &quot;count&quot;, &quot;u&quot;, count + 1);
3825  *         result = g_variant_dict_end (dict);
3826  *       }
3827  *     else
3828  *       {
3829  *         g_set_error (...);
3830  *         result = NULL;
3831  *       }
3832  *
3833  *     g_variant_dict_unref (dict);
3834  *
3835  *     return result;
3836  *   }
3837  * ]|
3838  *
3839  * Since: 2.40
3840  **/
3841 struct stack_dict
3842 {
3843   GHashTable *values;
3844   gsize magic;
3845 };
3846 
3847 G_STATIC_ASSERT (sizeof (struct stack_dict) &lt;= sizeof (GVariantDict));
3848 
3849 struct heap_dict
3850 {
3851   struct stack_dict dict;
3852   gint ref_count;
3853   gsize magic;
3854 };
3855 
3856 #define GVSD(d)                 ((struct stack_dict *) (d))
3857 #define GVHD(d)                 ((struct heap_dict *) (d))
3858 #define GVSD_MAGIC              ((gsize) 2579507750u)
3859 #define GVSD_MAGIC_PARTIAL      ((gsize) 3488698669u)
3860 #define GVHD_MAGIC              ((gsize) 2450270775u)
3861 #define is_valid_dict(d)        (d != NULL &amp;&amp; \
3862                                  GVSD(d)-&gt;magic == GVSD_MAGIC)
3863 #define is_valid_heap_dict(d)   (GVHD(d)-&gt;magic == GVHD_MAGIC)
3864 
3865 /* Just to make sure that by adding a union to GVariantDict, we didn&#39;t
3866  * accidentally change ABI. */
3867 G_STATIC_ASSERT (sizeof (GVariantDict) == sizeof (gsize[16]));
3868 
3869 static gboolean
3870 ensure_valid_dict (GVariantDict *dict)
3871 {
3872   if (is_valid_dict (dict))
3873     return TRUE;
3874   if (dict-&gt;u.s.partial_magic == GVSD_MAGIC_PARTIAL)
3875     {
3876       static GVariantDict cleared_dict;
3877 
3878       /* Make sure that only first two fields were set and the rest is
3879        * zeroed to avoid messing up the builder that had parent
3880        * address equal to GVSB_MAGIC_PARTIAL. */
3881       if (memcmp (cleared_dict.u.s.y, dict-&gt;u.s.y, sizeof cleared_dict.u.s.y))
3882         return FALSE;
3883 
3884       g_variant_dict_init (dict, dict-&gt;u.s.asv);
3885     }
3886   return is_valid_dict (dict);
3887 }
3888 
3889 /**
3890  * g_variant_dict_new:
3891  * @from_asv: (nullable): the #GVariant with which to initialise the
3892  *   dictionary
3893  *
3894  * Allocates and initialises a new #GVariantDict.
3895  *
3896  * You should call g_variant_dict_unref() on the return value when it
3897  * is no longer needed.  The memory will not be automatically freed by
3898  * any other call.
3899  *
3900  * In some cases it may be easier to place a #GVariantDict directly on
3901  * the stack of the calling function and initialise it with
3902  * g_variant_dict_init().  This is particularly useful when you are
3903  * using #GVariantDict to construct a #GVariant.
3904  *
3905  * Returns: (transfer full): a #GVariantDict
3906  *
3907  * Since: 2.40
3908  **/
3909 GVariantDict *
3910 g_variant_dict_new (GVariant *from_asv)
3911 {
3912   GVariantDict *dict;
3913 
3914   dict = g_slice_alloc (sizeof (struct heap_dict));
3915   g_variant_dict_init (dict, from_asv);
3916   GVHD(dict)-&gt;magic = GVHD_MAGIC;
3917   GVHD(dict)-&gt;ref_count = 1;
3918 
3919   return dict;
3920 }
3921 
3922 /**
3923  * g_variant_dict_init: (skip)
3924  * @dict: a #GVariantDict
3925  * @from_asv: (nullable): the initial value for @dict
3926  *
3927  * Initialises a #GVariantDict structure.
3928  *
3929  * If @from_asv is given, it is used to initialise the dictionary.
3930  *
3931  * This function completely ignores the previous contents of @dict.  On
3932  * one hand this means that it is valid to pass in completely
3933  * uninitialised memory.  On the other hand, this means that if you are
3934  * initialising over top of an existing #GVariantDict you need to first
3935  * call g_variant_dict_clear() in order to avoid leaking memory.
3936  *
3937  * You must not call g_variant_dict_ref() or g_variant_dict_unref() on a
3938  * #GVariantDict that was initialised with this function.  If you ever
3939  * pass a reference to a #GVariantDict outside of the control of your
3940  * own code then you should assume that the person receiving that
3941  * reference may try to use reference counting; you should use
3942  * g_variant_dict_new() instead of this function.
3943  *
3944  * Since: 2.40
3945  **/
3946 void
3947 g_variant_dict_init (GVariantDict *dict,
3948                      GVariant     *from_asv)
3949 {
3950   GVariantIter iter;
3951   gchar *key;
3952   GVariant *value;
3953 
3954   GVSD(dict)-&gt;values = g_hash_table_new_full (g_str_hash, g_str_equal, g_free, (GDestroyNotify) g_variant_unref);
3955   GVSD(dict)-&gt;magic = GVSD_MAGIC;
3956 
3957   if (from_asv)
3958     {
3959       g_variant_iter_init (&amp;iter, from_asv);
3960       while (g_variant_iter_next (&amp;iter, &quot;{sv}&quot;, &amp;key, &amp;value))
3961         g_hash_table_insert (GVSD(dict)-&gt;values, key, value);
3962     }
3963 }
3964 
3965 /**
3966  * g_variant_dict_lookup:
3967  * @dict: a #GVariantDict
3968  * @key: the key to look up in the dictionary
3969  * @format_string: a GVariant format string
3970  * @...: the arguments to unpack the value into
3971  *
3972  * Looks up a value in a #GVariantDict.
3973  *
3974  * This function is a wrapper around g_variant_dict_lookup_value() and
3975  * g_variant_get().  In the case that %NULL would have been returned,
3976  * this function returns %FALSE.  Otherwise, it unpacks the returned
3977  * value and returns %TRUE.
3978  *
3979  * @format_string determines the C types that are used for unpacking the
3980  * values and also determines if the values are copied or borrowed, see the
3981  * section on [GVariant format strings][gvariant-format-strings-pointers].
3982  *
3983  * Returns: %TRUE if a value was unpacked
3984  *
3985  * Since: 2.40
3986  **/
3987 gboolean
3988 g_variant_dict_lookup (GVariantDict *dict,
3989                        const gchar  *key,
3990                        const gchar  *format_string,
3991                        ...)
3992 {
3993   GVariant *value;
3994   va_list ap;
3995 
3996   g_return_val_if_fail (ensure_valid_dict (dict), FALSE);
3997   g_return_val_if_fail (key != NULL, FALSE);
3998   g_return_val_if_fail (format_string != NULL, FALSE);
3999 
4000   value = g_hash_table_lookup (GVSD(dict)-&gt;values, key);
4001 
4002   if (value == NULL || !g_variant_check_format_string (value, format_string, FALSE))
4003     return FALSE;
4004 
4005   va_start (ap, format_string);
4006   g_variant_get_va (value, format_string, NULL, &amp;ap);
4007   va_end (ap);
4008 
4009   return TRUE;
4010 }
4011 
4012 /**
4013  * g_variant_dict_lookup_value:
4014  * @dict: a #GVariantDict
4015  * @key: the key to look up in the dictionary
4016  * @expected_type: (nullable): a #GVariantType, or %NULL
4017  *
4018  * Looks up a value in a #GVariantDict.
4019  *
4020  * If @key is not found in @dictionary, %NULL is returned.
4021  *
4022  * The @expected_type string specifies what type of value is expected.
4023  * If the value associated with @key has a different type then %NULL is
4024  * returned.
4025  *
4026  * If the key is found and the value has the correct type, it is
4027  * returned.  If @expected_type was specified then any non-%NULL return
4028  * value will have this type.
4029  *
4030  * Returns: (transfer full): the value of the dictionary key, or %NULL
4031  *
4032  * Since: 2.40
4033  **/
4034 GVariant *
4035 g_variant_dict_lookup_value (GVariantDict       *dict,
4036                              const gchar        *key,
4037                              const GVariantType *expected_type)
4038 {
4039   GVariant *result;
4040 
4041   g_return_val_if_fail (ensure_valid_dict (dict), NULL);
4042   g_return_val_if_fail (key != NULL, NULL);
4043 
4044   result = g_hash_table_lookup (GVSD(dict)-&gt;values, key);
4045 
4046   if (result &amp;&amp; (!expected_type || g_variant_is_of_type (result, expected_type)))
4047     return g_variant_ref (result);
4048 
4049   return NULL;
4050 }
4051 
4052 /**
4053  * g_variant_dict_contains:
4054  * @dict: a #GVariantDict
4055  * @key: the key to look up in the dictionary
4056  *
4057  * Checks if @key exists in @dict.
4058  *
4059  * Returns: %TRUE if @key is in @dict
4060  *
4061  * Since: 2.40
4062  **/
4063 gboolean
4064 g_variant_dict_contains (GVariantDict *dict,
4065                          const gchar  *key)
4066 {
4067   g_return_val_if_fail (ensure_valid_dict (dict), FALSE);
4068   g_return_val_if_fail (key != NULL, FALSE);
4069 
4070   return g_hash_table_contains (GVSD(dict)-&gt;values, key);
4071 }
4072 
4073 /**
4074  * g_variant_dict_insert:
4075  * @dict: a #GVariantDict
4076  * @key: the key to insert a value for
4077  * @format_string: a #GVariant varargs format string
4078  * @...: arguments, as per @format_string
4079  *
4080  * Inserts a value into a #GVariantDict.
4081  *
4082  * This call is a convenience wrapper that is exactly equivalent to
4083  * calling g_variant_new() followed by g_variant_dict_insert_value().
4084  *
4085  * Since: 2.40
4086  **/
4087 void
4088 g_variant_dict_insert (GVariantDict *dict,
4089                        const gchar  *key,
4090                        const gchar  *format_string,
4091                        ...)
4092 {
4093   va_list ap;
4094 
4095   g_return_if_fail (ensure_valid_dict (dict));
4096   g_return_if_fail (key != NULL);
4097   g_return_if_fail (format_string != NULL);
4098 
4099   va_start (ap, format_string);
4100   g_variant_dict_insert_value (dict, key, g_variant_new_va (format_string, NULL, &amp;ap));
4101   va_end (ap);
4102 }
4103 
4104 /**
4105  * g_variant_dict_insert_value:
4106  * @dict: a #GVariantDict
4107  * @key: the key to insert a value for
4108  * @value: the value to insert
4109  *
4110  * Inserts (or replaces) a key in a #GVariantDict.
4111  *
4112  * @value is consumed if it is floating.
4113  *
4114  * Since: 2.40
4115  **/
4116 void
4117 g_variant_dict_insert_value (GVariantDict *dict,
4118                              const gchar  *key,
4119                              GVariant     *value)
4120 {
4121   g_return_if_fail (ensure_valid_dict (dict));
4122   g_return_if_fail (key != NULL);
4123   g_return_if_fail (value != NULL);
4124 
4125   g_hash_table_insert (GVSD(dict)-&gt;values, g_strdup (key), g_variant_ref_sink (value));
4126 }
4127 
4128 /**
4129  * g_variant_dict_remove:
4130  * @dict: a #GVariantDict
4131  * @key: the key to remove
4132  *
4133  * Removes a key and its associated value from a #GVariantDict.
4134  *
4135  * Returns: %TRUE if the key was found and removed
4136  *
4137  * Since: 2.40
4138  **/
4139 gboolean
4140 g_variant_dict_remove (GVariantDict *dict,
4141                        const gchar  *key)
4142 {
4143   g_return_val_if_fail (ensure_valid_dict (dict), FALSE);
4144   g_return_val_if_fail (key != NULL, FALSE);
4145 
4146   return g_hash_table_remove (GVSD(dict)-&gt;values, key);
4147 }
4148 
4149 /**
4150  * g_variant_dict_clear:
4151  * @dict: a #GVariantDict
4152  *
4153  * Releases all memory associated with a #GVariantDict without freeing
4154  * the #GVariantDict structure itself.
4155  *
4156  * It typically only makes sense to do this on a stack-allocated
4157  * #GVariantDict if you want to abort building the value part-way
4158  * through.  This function need not be called if you call
4159  * g_variant_dict_end() and it also doesn&#39;t need to be called on dicts
4160  * allocated with g_variant_dict_new (see g_variant_dict_unref() for
4161  * that).
4162  *
4163  * It is valid to call this function on either an initialised
4164  * #GVariantDict or one that was previously cleared by an earlier call
4165  * to g_variant_dict_clear() but it is not valid to call this function
4166  * on uninitialised memory.
4167  *
4168  * Since: 2.40
4169  **/
4170 void
4171 g_variant_dict_clear (GVariantDict *dict)
4172 {
4173   if (GVSD(dict)-&gt;magic == 0)
4174     /* all-zeros case */
4175     return;
4176 
4177   g_return_if_fail (ensure_valid_dict (dict));
4178 
4179   g_hash_table_unref (GVSD(dict)-&gt;values);
4180   GVSD(dict)-&gt;values = NULL;
4181 
4182   GVSD(dict)-&gt;magic = 0;
4183 }
4184 
4185 /**
4186  * g_variant_dict_end:
4187  * @dict: a #GVariantDict
4188  *
4189  * Returns the current value of @dict as a #GVariant of type
4190  * %G_VARIANT_TYPE_VARDICT, clearing it in the process.
4191  *
4192  * It is not permissible to use @dict in any way after this call except
4193  * for reference counting operations (in the case of a heap-allocated
4194  * #GVariantDict) or by reinitialising it with g_variant_dict_init() (in
4195  * the case of stack-allocated).
4196  *
4197  * Returns: (transfer none): a new, floating, #GVariant
4198  *
4199  * Since: 2.40
4200  **/
4201 GVariant *
4202 g_variant_dict_end (GVariantDict *dict)
4203 {
4204   GVariantBuilder builder;
4205   GHashTableIter iter;
4206   gpointer key, value;
4207 
4208   g_return_val_if_fail (ensure_valid_dict (dict), NULL);
4209 
4210   g_variant_builder_init (&amp;builder, G_VARIANT_TYPE_VARDICT);
4211 
4212   g_hash_table_iter_init (&amp;iter, GVSD(dict)-&gt;values);
4213   while (g_hash_table_iter_next (&amp;iter, &amp;key, &amp;value))
4214     g_variant_builder_add (&amp;builder, &quot;{sv}&quot;, (const gchar *) key, (GVariant *) value);
4215 
4216   g_variant_dict_clear (dict);
4217 
4218   return g_variant_builder_end (&amp;builder);
4219 }
4220 
4221 /**
4222  * g_variant_dict_ref:
4223  * @dict: a heap-allocated #GVariantDict
4224  *
4225  * Increases the reference count on @dict.
4226  *
4227  * Don&#39;t call this on stack-allocated #GVariantDict instances or bad
4228  * things will happen.
4229  *
4230  * Returns: (transfer full): a new reference to @dict
4231  *
4232  * Since: 2.40
4233  **/
4234 GVariantDict *
4235 g_variant_dict_ref (GVariantDict *dict)
4236 {
4237   g_return_val_if_fail (is_valid_heap_dict (dict), NULL);
4238 
4239   GVHD(dict)-&gt;ref_count++;
4240 
4241   return dict;
4242 }
4243 
4244 /**
4245  * g_variant_dict_unref:
4246  * @dict: (transfer full): a heap-allocated #GVariantDict
4247  *
4248  * Decreases the reference count on @dict.
4249  *
4250  * In the event that there are no more references, releases all memory
4251  * associated with the #GVariantDict.
4252  *
4253  * Don&#39;t call this on stack-allocated #GVariantDict instances or bad
4254  * things will happen.
4255  *
4256  * Since: 2.40
4257  **/
4258 void
4259 g_variant_dict_unref (GVariantDict *dict)
4260 {
4261   g_return_if_fail (is_valid_heap_dict (dict));
4262 
4263   if (--GVHD(dict)-&gt;ref_count == 0)
4264     {
4265       g_variant_dict_clear (dict);
4266       g_slice_free (struct heap_dict, (struct heap_dict *) dict);
4267     }
4268 }
4269 
4270 
4271 /* Format strings {{{1 */
4272 /*&lt; private &gt;
4273  * g_variant_format_string_scan:
4274  * @string: a string that may be prefixed with a format string
4275  * @limit: (nullable) (default NULL): a pointer to the end of @string,
4276  *         or %NULL
4277  * @endptr: (nullable) (default NULL): location to store the end pointer,
4278  *          or %NULL
4279  *
4280  * Checks the string pointed to by @string for starting with a properly
4281  * formed #GVariant varargs format string.  If no valid format string is
4282  * found then %FALSE is returned.
4283  *
4284  * If @string does start with a valid format string then %TRUE is
4285  * returned.  If @endptr is non-%NULL then it is updated to point to the
4286  * first character after the format string.
4287  *
4288  * If @limit is non-%NULL then @limit (and any character after it) will
4289  * not be accessed and the effect is otherwise equivalent to if the
4290  * character at @limit were nul.
4291  *
4292  * See the section on [GVariant format strings][gvariant-format-strings].
4293  *
4294  * Returns: %TRUE if there was a valid format string
4295  *
4296  * Since: 2.24
4297  */
4298 gboolean
4299 g_variant_format_string_scan (const gchar  *string,
4300                               const gchar  *limit,
4301                               const gchar **endptr)
4302 {
4303 #define next_char() (string == limit ? &#39;\0&#39; : *string++)
4304 #define peek_char() (string == limit ? &#39;\0&#39; : *string)
4305   char c;
4306 
4307   switch (next_char())
4308     {
4309     case &#39;b&#39;: case &#39;y&#39;: case &#39;n&#39;: case &#39;q&#39;: case &#39;i&#39;: case &#39;u&#39;:
4310     case &#39;x&#39;: case &#39;t&#39;: case &#39;h&#39;: case &#39;d&#39;: case &#39;s&#39;: case &#39;o&#39;:
4311     case &#39;g&#39;: case &#39;v&#39;: case &#39;*&#39;: case &#39;?&#39;: case &#39;r&#39;:
4312       break;
4313 
4314     case &#39;m&#39;:
4315       return g_variant_format_string_scan (string, limit, endptr);
4316 
4317     case &#39;a&#39;:
4318     case &#39;@&#39;:
4319       return g_variant_type_string_scan (string, limit, endptr);
4320 
4321     case &#39;(&#39;:
4322       while (peek_char() != &#39;)&#39;)
4323         if (!g_variant_format_string_scan (string, limit, &amp;string))
4324           return FALSE;
4325 
4326       next_char(); /* consume &#39;)&#39; */
4327       break;
4328 
4329     case &#39;{&#39;:
4330       c = next_char();
4331 
4332       if (c == &#39;&amp;&#39;)
4333         {
4334           c = next_char ();
4335 
4336           if (c != &#39;s&#39; &amp;&amp; c != &#39;o&#39; &amp;&amp; c != &#39;g&#39;)
4337             return FALSE;
4338         }
4339       else
4340         {
4341           if (c == &#39;@&#39;)
4342             c = next_char ();
4343 
4344           /* ISO/IEC 9899:1999 (C99) 7.21.5.2:
4345            *    The terminating null character is considered to be
4346            *    part of the string.
4347            */
4348           if (c != &#39;\0&#39; &amp;&amp; strchr (&quot;bynqiuxthdsog?&quot;, c) == NULL)
4349             return FALSE;
4350         }
4351 
4352       if (!g_variant_format_string_scan (string, limit, &amp;string))
4353         return FALSE;
4354 
4355       if (next_char() != &#39;}&#39;)
4356         return FALSE;
4357 
4358       break;
4359 
4360     case &#39;^&#39;:
4361       if ((c = next_char()) == &#39;a&#39;)
4362         {
4363           if ((c = next_char()) == &#39;&amp;&#39;)
4364             {
4365               if ((c = next_char()) == &#39;a&#39;)
4366                 {
4367                   if ((c = next_char()) == &#39;y&#39;)
4368                     break;      /* &#39;^a&amp;ay&#39; */
4369                 }
4370 
4371               else if (c == &#39;s&#39; || c == &#39;o&#39;)
4372                 break;          /* &#39;^a&amp;s&#39;, &#39;^a&amp;o&#39; */
4373             }
4374 
4375           else if (c == &#39;a&#39;)
4376             {
4377               if ((c = next_char()) == &#39;y&#39;)
4378                 break;          /* &#39;^aay&#39; */
4379             }
4380 
4381           else if (c == &#39;s&#39; || c == &#39;o&#39;)
4382             break;              /* &#39;^as&#39;, &#39;^ao&#39; */
4383 
4384           else if (c == &#39;y&#39;)
4385             break;              /* &#39;^ay&#39; */
4386         }
4387       else if (c == &#39;&amp;&#39;)
4388         {
4389           if ((c = next_char()) == &#39;a&#39;)
4390             {
4391               if ((c = next_char()) == &#39;y&#39;)
4392                 break;          /* &#39;^&amp;ay&#39; */
4393             }
4394         }
4395 
4396       return FALSE;
4397 
4398     case &#39;&amp;&#39;:
4399       c = next_char();
4400 
4401       if (c != &#39;s&#39; &amp;&amp; c != &#39;o&#39; &amp;&amp; c != &#39;g&#39;)
4402         return FALSE;
4403 
4404       break;
4405 
4406     default:
4407       return FALSE;
4408     }
4409 
4410   if (endptr != NULL)
4411     *endptr = string;
4412 
4413 #undef next_char
4414 #undef peek_char
4415 
4416   return TRUE;
4417 }
4418 
4419 /**
4420  * g_variant_check_format_string:
4421  * @value: a #GVariant
4422  * @format_string: a valid #GVariant format string
4423  * @copy_only: %TRUE to ensure the format string makes deep copies
4424  *
4425  * Checks if calling g_variant_get() with @format_string on @value would
4426  * be valid from a type-compatibility standpoint.  @format_string is
4427  * assumed to be a valid format string (from a syntactic standpoint).
4428  *
4429  * If @copy_only is %TRUE then this function additionally checks that it
4430  * would be safe to call g_variant_unref() on @value immediately after
4431  * the call to g_variant_get() without invalidating the result.  This is
4432  * only possible if deep copies are made (ie: there are no pointers to
4433  * the data inside of the soon-to-be-freed #GVariant instance).  If this
4434  * check fails then a g_critical() is printed and %FALSE is returned.
4435  *
4436  * This function is meant to be used by functions that wish to provide
4437  * varargs accessors to #GVariant values of uncertain values (eg:
4438  * g_variant_lookup() or g_menu_model_get_item_attribute()).
4439  *
4440  * Returns: %TRUE if @format_string is safe to use
4441  *
4442  * Since: 2.34
4443  */
4444 gboolean
4445 g_variant_check_format_string (GVariant    *value,
4446                                const gchar *format_string,
4447                                gboolean     copy_only)
4448 {
4449   const gchar *original_format = format_string;
4450   const gchar *type_string;
4451 
4452   /* Interesting factoid: assuming a format string is valid, it can be
4453    * converted to a type string by removing all &#39;@&#39; &#39;&amp;&#39; and &#39;^&#39;
4454    * characters.
4455    *
4456    * Instead of doing that, we can just skip those characters when
4457    * comparing it to the type string of @value.
4458    *
4459    * For the copy-only case we can just drop the &#39;&amp;&#39; from the list of
4460    * characters to skip over.  A &#39;&amp;&#39; will never appear in a type string
4461    * so we know that it won&#39;t be possible to return %TRUE if it is in a
4462    * format string.
4463    */
4464   type_string = g_variant_get_type_string (value);
4465 
4466   while (*type_string || *format_string)
4467     {
4468       gchar format = *format_string++;
4469 
4470       switch (format)
4471         {
4472         case &#39;&amp;&#39;:
4473           if G_UNLIKELY (copy_only)
4474             {
4475               /* for the love of all that is good, please don&#39;t mark this string for translation... */
4476               g_critical (&quot;g_variant_check_format_string() is being called by a function with a GVariant varargs &quot;
4477                           &quot;interface to validate the passed format string for type safety.  The passed format &quot;
4478                           &quot;(%s) contains a &#39;&amp;&#39; character which would result in a pointer being returned to the &quot;
4479                           &quot;data inside of a GVariant instance that may no longer exist by the time the function &quot;
4480                           &quot;returns.  Modify your code to use a format string without &#39;&amp;&#39;.&quot;, original_format);
4481               return FALSE;
4482             }
4483 
4484           /* fall through */
4485         case &#39;^&#39;:
4486         case &#39;@&#39;:
4487           /* ignore these 2 (or 3) */
4488           continue;
4489 
4490         case &#39;?&#39;:
4491           /* attempt to consume one of &#39;bynqiuxthdsog&#39; */
4492           {
4493             char s = *type_string++;
4494 
4495             if (s == &#39;\0&#39; || strchr (&quot;bynqiuxthdsog&quot;, s) == NULL)
4496               return FALSE;
4497           }
4498           continue;
4499 
4500         case &#39;r&#39;:
4501           /* ensure it&#39;s a tuple */
4502           if (*type_string != &#39;(&#39;)
4503             return FALSE;
4504 
4505           /* fall through */
4506         case &#39;*&#39;:
4507           /* consume a full type string for the &#39;*&#39; or &#39;r&#39; */
4508           if (!g_variant_type_string_scan (type_string, NULL, &amp;type_string))
4509             return FALSE;
4510 
4511           continue;
4512 
4513         default:
4514           /* attempt to consume exactly one character equal to the format */
4515           if (format != *type_string++)
4516             return FALSE;
4517         }
4518     }
4519 
4520   return TRUE;
4521 }
4522 
4523 /*&lt; private &gt;
4524  * g_variant_format_string_scan_type:
4525  * @string: a string that may be prefixed with a format string
4526  * @limit: (nullable) (default NULL): a pointer to the end of @string,
4527  *         or %NULL
4528  * @endptr: (nullable) (default NULL): location to store the end pointer,
4529  *          or %NULL
4530  *
4531  * If @string starts with a valid format string then this function will
4532  * return the type that the format string corresponds to.  Otherwise
4533  * this function returns %NULL.
4534  *
4535  * Use g_variant_type_free() to free the return value when you no longer
4536  * need it.
4537  *
4538  * This function is otherwise exactly like
4539  * g_variant_format_string_scan().
4540  *
4541  * Returns: (nullable): a #GVariantType if there was a valid format string
4542  *
4543  * Since: 2.24
4544  */
4545 GVariantType *
4546 g_variant_format_string_scan_type (const gchar  *string,
4547                                    const gchar  *limit,
4548                                    const gchar **endptr)
4549 {
4550   const gchar *my_end;
4551   gchar *dest;
4552   gchar *new;
4553 
4554   if (endptr == NULL)
4555     endptr = &amp;my_end;
4556 
4557   if (!g_variant_format_string_scan (string, limit, endptr))
4558     return NULL;
4559 
4560   dest = new = g_malloc (*endptr - string + 1);
4561   while (string != *endptr)
4562     {
4563       if (*string != &#39;@&#39; &amp;&amp; *string != &#39;&amp;&#39; &amp;&amp; *string != &#39;^&#39;)
4564         *dest++ = *string;
4565       string++;
4566     }
4567   *dest = &#39;\0&#39;;
4568 
4569   return (GVariantType *) G_VARIANT_TYPE (new);
4570 }
4571 
4572 static gboolean
4573 valid_format_string (const gchar *format_string,
4574                      gboolean     single,
4575                      GVariant    *value)
4576 {
4577   const gchar *endptr;
4578   GVariantType *type;
4579 
4580   type = g_variant_format_string_scan_type (format_string, NULL, &amp;endptr);
4581 
4582   if G_UNLIKELY (type == NULL || (single &amp;&amp; *endptr != &#39;\0&#39;))
4583     {
4584       if (single)
4585         g_critical (&quot;&#39;%s&#39; is not a valid GVariant format string&quot;,
4586                     format_string);
4587       else
4588         g_critical (&quot;&#39;%s&#39; does not have a valid GVariant format &quot;
4589                     &quot;string as a prefix&quot;, format_string);
4590 
4591       if (type != NULL)
4592         g_variant_type_free (type);
4593 
4594       return FALSE;
4595     }
4596 
4597   if G_UNLIKELY (value &amp;&amp; !g_variant_is_of_type (value, type))
4598     {
4599       gchar *fragment;
4600       gchar *typestr;
4601 
4602       fragment = g_strndup (format_string, endptr - format_string);
4603       typestr = g_variant_type_dup_string (type);
4604 
4605       g_critical (&quot;the GVariant format string &#39;%s&#39; has a type of &quot;
4606                   &quot;&#39;%s&#39; but the given value has a type of &#39;%s&#39;&quot;,
4607                   fragment, typestr, g_variant_get_type_string (value));
4608 
4609       g_variant_type_free (type);
4610       g_free (fragment);
4611       g_free (typestr);
4612 
4613       return FALSE;
4614     }
4615 
4616   g_variant_type_free (type);
4617 
4618   return TRUE;
4619 }
4620 
4621 /* Variable Arguments {{{1 */
4622 /* We consider 2 main classes of format strings:
4623  *
4624  *   - recursive format strings
4625  *      these are ones that result in recursion and the collection of
4626  *      possibly more than one argument.  Maybe types, tuples,
4627  *      dictionary entries.
4628  *
4629  *   - leaf format string
4630  *      these result in the collection of a single argument.
4631  *
4632  * Leaf format strings are further subdivided into two categories:
4633  *
4634  *   - single non-null pointer (&quot;nnp&quot;)
4635  *      these either collect or return a single non-null pointer.
4636  *
4637  *   - other
4638  *      these collect or return something else (bool, number, etc).
4639  *
4640  * Based on the above, the varargs handling code is split into 4 main parts:
4641  *
4642  *   - nnp handling code
4643  *   - leaf handling code (which may invoke nnp code)
4644  *   - generic handling code (may be recursive, may invoke leaf code)
4645  *   - user-facing API (which invokes the generic code)
4646  *
4647  * Each section implements some of the following functions:
4648  *
4649  *   - skip:
4650  *      collect the arguments for the format string as if
4651  *      g_variant_new() had been called, but do nothing with them.  used
4652  *      for skipping over arguments when constructing a Nothing maybe
4653  *      type.
4654  *
4655  *   - new:
4656  *      create a GVariant *
4657  *
4658  *   - get:
4659  *      unpack a GVariant *
4660  *
4661  *   - free (nnp only):
4662  *      free a previously allocated item
4663  */
4664 
4665 static gboolean
4666 g_variant_format_string_is_leaf (const gchar *str)
4667 {
4668   return str[0] != &#39;m&#39; &amp;&amp; str[0] != &#39;(&#39; &amp;&amp; str[0] != &#39;{&#39;;
4669 }
4670 
4671 static gboolean
4672 g_variant_format_string_is_nnp (const gchar *str)
4673 {
4674   return str[0] == &#39;a&#39; || str[0] == &#39;s&#39; || str[0] == &#39;o&#39; || str[0] == &#39;g&#39; ||
4675          str[0] == &#39;^&#39; || str[0] == &#39;@&#39; || str[0] == &#39;*&#39; || str[0] == &#39;?&#39; ||
4676          str[0] == &#39;r&#39; || str[0] == &#39;v&#39; || str[0] == &#39;&amp;&#39;;
4677 }
4678 
4679 /* Single non-null pointer (&quot;nnp&quot;) {{{2 */
4680 static void
4681 g_variant_valist_free_nnp (const gchar *str,
4682                            gpointer     ptr)
4683 {
4684   switch (*str)
4685     {
4686     case &#39;a&#39;:
4687       g_variant_iter_free (ptr);
4688       break;
4689 
4690     case &#39;^&#39;:
4691       if (g_str_has_suffix (str, &quot;y&quot;))
4692         {
4693           if (str[2] != &#39;a&#39;) /* &#39;^a&amp;ay&#39;, &#39;^ay&#39; */
4694             g_free (ptr);
4695           else if (str[1] == &#39;a&#39;) /* &#39;^aay&#39; */
4696             g_strfreev (ptr);
4697           break; /* &#39;^&amp;ay&#39; */
4698         }
4699       else if (str[2] != &#39;&amp;&#39;) /* &#39;^as&#39;, &#39;^ao&#39; */
4700         g_strfreev (ptr);
4701       else                      /* &#39;^a&amp;s&#39;, &#39;^a&amp;o&#39; */
4702         g_free (ptr);
4703       break;
4704 
4705     case &#39;s&#39;:
4706     case &#39;o&#39;:
4707     case &#39;g&#39;:
4708       g_free (ptr);
4709       break;
4710 
4711     case &#39;@&#39;:
4712     case &#39;*&#39;:
4713     case &#39;?&#39;:
4714     case &#39;v&#39;:
4715       g_variant_unref (ptr);
4716       break;
4717 
4718     case &#39;&amp;&#39;:
4719       break;
4720 
4721     default:
4722       g_assert_not_reached ();
4723     }
4724 }
4725 
4726 static gchar
4727 g_variant_scan_convenience (const gchar **str,
4728                             gboolean     *constant,
4729                             guint        *arrays)
4730 {
4731   *constant = FALSE;
4732   *arrays = 0;
4733 
4734   for (;;)
4735     {
4736       char c = *(*str)++;
4737 
4738       if (c == &#39;&amp;&#39;)
4739         *constant = TRUE;
4740 
4741       else if (c == &#39;a&#39;)
4742         (*arrays)++;
4743 
4744       else
4745         return c;
4746     }
4747 }
4748 
4749 static GVariant *
4750 g_variant_valist_new_nnp (const gchar **str,
4751                           gpointer      ptr)
4752 {
4753   if (**str == &#39;&amp;&#39;)
4754     (*str)++;
4755 
4756   switch (*(*str)++)
4757     {
4758     case &#39;a&#39;:
4759       if (ptr != NULL)
4760         {
4761           const GVariantType *type;
4762           GVariant *value;
4763 
4764           value = g_variant_builder_end (ptr);
4765           type = g_variant_get_type (value);
4766 
4767           if G_UNLIKELY (!g_variant_type_is_array (type))
4768             g_error (&quot;g_variant_new: expected array GVariantBuilder but &quot;
4769                      &quot;the built value has type &#39;%s&#39;&quot;,
4770                      g_variant_get_type_string (value));
4771 
4772           type = g_variant_type_element (type);
4773 
4774           if G_UNLIKELY (!g_variant_type_is_subtype_of (type, (GVariantType *) *str))
4775             {
4776               gchar *type_string = g_variant_type_dup_string ((GVariantType *) *str);
4777               g_error (&quot;g_variant_new: expected GVariantBuilder array element &quot;
4778                        &quot;type &#39;%s&#39; but the built value has element type &#39;%s&#39;&quot;,
4779                        type_string, g_variant_get_type_string (value) + 1);
4780               g_free (type_string);
4781             }
4782 
4783           g_variant_type_string_scan (*str, NULL, str);
4784 
4785           return value;
4786         }
4787       else
4788 
4789         /* special case: NULL pointer for empty array */
4790         {
4791           const GVariantType *type = (GVariantType *) *str;
4792 
4793           g_variant_type_string_scan (*str, NULL, str);
4794 
4795           if G_UNLIKELY (!g_variant_type_is_definite (type))
4796             g_error (&quot;g_variant_new: NULL pointer given with indefinite &quot;
4797                      &quot;array type; unable to determine which type of empty &quot;
4798                      &quot;array to construct.&quot;);
4799 
4800           return g_variant_new_array (type, NULL, 0);
4801         }
4802 
4803     case &#39;s&#39;:
4804       {
4805         GVariant *value;
4806 
4807         value = g_variant_new_string (ptr);
4808 
4809         if (value == NULL)
4810           value = g_variant_new_string (&quot;[Invalid UTF-8]&quot;);
4811 
4812         return value;
4813       }
4814 
4815     case &#39;o&#39;:
4816       return g_variant_new_object_path (ptr);
4817 
4818     case &#39;g&#39;:
4819       return g_variant_new_signature (ptr);
4820 
4821     case &#39;^&#39;:
4822       {
4823         gboolean constant;
4824         guint arrays;
4825         gchar type;
4826 
4827         type = g_variant_scan_convenience (str, &amp;constant, &amp;arrays);
4828 
4829         if (type == &#39;s&#39;)
4830           return g_variant_new_strv (ptr, -1);
4831 
4832         if (type == &#39;o&#39;)
4833           return g_variant_new_objv (ptr, -1);
4834 
4835         if (arrays &gt; 1)
4836           return g_variant_new_bytestring_array (ptr, -1);
4837 
4838         return g_variant_new_bytestring (ptr);
4839       }
4840 
4841     case &#39;@&#39;:
4842       if G_UNLIKELY (!g_variant_is_of_type (ptr, (GVariantType *) *str))
4843         {
4844           gchar *type_string = g_variant_type_dup_string ((GVariantType *) *str);
4845           g_error (&quot;g_variant_new: expected GVariant of type &#39;%s&#39; but &quot;
4846                    &quot;received value has type &#39;%s&#39;&quot;,
4847                    type_string, g_variant_get_type_string (ptr));
4848           g_free (type_string);
4849         }
4850 
4851       g_variant_type_string_scan (*str, NULL, str);
4852 
4853       return ptr;
4854 
4855     case &#39;*&#39;:
4856       return ptr;
4857 
4858     case &#39;?&#39;:
4859       if G_UNLIKELY (!g_variant_type_is_basic (g_variant_get_type (ptr)))
4860         g_error (&quot;g_variant_new: format string &#39;?&#39; expects basic-typed &quot;
4861                  &quot;GVariant, but received value has type &#39;%s&#39;&quot;,
4862                  g_variant_get_type_string (ptr));
4863 
4864       return ptr;
4865 
4866     case &#39;r&#39;:
4867       if G_UNLIKELY (!g_variant_type_is_tuple (g_variant_get_type (ptr)))
4868         g_error (&quot;g_variant_new: format string &#39;r&#39; expects tuple-typed &quot;
4869                  &quot;GVariant, but received value has type &#39;%s&#39;&quot;,
4870                  g_variant_get_type_string (ptr));
4871 
4872       return ptr;
4873 
4874     case &#39;v&#39;:
4875       return g_variant_new_variant (ptr);
4876 
4877     default:
4878       g_assert_not_reached ();
4879     }
4880 }
4881 
4882 static gpointer
4883 g_variant_valist_get_nnp (const gchar **str,
4884                           GVariant     *value)
4885 {
4886   switch (*(*str)++)
4887     {
4888     case &#39;a&#39;:
4889       g_variant_type_string_scan (*str, NULL, str);
4890       return g_variant_iter_new (value);
4891 
4892     case &#39;&amp;&#39;:
4893       (*str)++;
4894       return (gchar *) g_variant_get_string (value, NULL);
4895 
4896     case &#39;s&#39;:
4897     case &#39;o&#39;:
4898     case &#39;g&#39;:
4899       return g_variant_dup_string (value, NULL);
4900 
4901     case &#39;^&#39;:
4902       {
4903         gboolean constant;
4904         guint arrays;
4905         gchar type;
4906 
4907         type = g_variant_scan_convenience (str, &amp;constant, &amp;arrays);
4908 
4909         if (type == &#39;s&#39;)
4910           {
4911             if (constant)
4912               return g_variant_get_strv (value, NULL);
4913             else
4914               return g_variant_dup_strv (value, NULL);
4915           }
4916 
4917         else if (type == &#39;o&#39;)
4918           {
4919             if (constant)
4920               return g_variant_get_objv (value, NULL);
4921             else
4922               return g_variant_dup_objv (value, NULL);
4923           }
4924 
4925         else if (arrays &gt; 1)
4926           {
4927             if (constant)
4928               return g_variant_get_bytestring_array (value, NULL);
4929             else
4930               return g_variant_dup_bytestring_array (value, NULL);
4931           }
4932 
4933         else
4934           {
4935             if (constant)
4936               return (gchar *) g_variant_get_bytestring (value);
4937             else
4938               return g_variant_dup_bytestring (value, NULL);
4939           }
4940       }
4941 
4942     case &#39;@&#39;:
4943       g_variant_type_string_scan (*str, NULL, str);
4944       /* fall through */
4945 
4946     case &#39;*&#39;:
4947     case &#39;?&#39;:
4948     case &#39;r&#39;:
4949       return g_variant_ref (value);
4950 
4951     case &#39;v&#39;:
4952       return g_variant_get_variant (value);
4953 
4954     default:
4955       g_assert_not_reached ();
4956     }
4957 }
4958 
4959 /* Leaves {{{2 */
4960 static void
4961 g_variant_valist_skip_leaf (const gchar **str,
4962                             va_list      *app)
4963 {
4964   if (g_variant_format_string_is_nnp (*str))
4965     {
4966       g_variant_format_string_scan (*str, NULL, str);
4967       va_arg (*app, gpointer);
4968       return;
4969     }
4970 
4971   switch (*(*str)++)
4972     {
4973     case &#39;b&#39;:
4974     case &#39;y&#39;:
4975     case &#39;n&#39;:
4976     case &#39;q&#39;:
4977     case &#39;i&#39;:
4978     case &#39;u&#39;:
4979     case &#39;h&#39;:
4980       va_arg (*app, int);
4981       return;
4982 
4983     case &#39;x&#39;:
4984     case &#39;t&#39;:
4985       va_arg (*app, guint64);
4986       return;
4987 
4988     case &#39;d&#39;:
4989       va_arg (*app, gdouble);
4990       return;
4991 
4992     default:
4993       g_assert_not_reached ();
4994     }
4995 }
4996 
4997 static GVariant *
4998 g_variant_valist_new_leaf (const gchar **str,
4999                            va_list      *app)
5000 {
5001   if (g_variant_format_string_is_nnp (*str))
5002     return g_variant_valist_new_nnp (str, va_arg (*app, gpointer));
5003 
5004   switch (*(*str)++)
5005     {
5006     case &#39;b&#39;:
5007       return g_variant_new_boolean (va_arg (*app, gboolean));
5008 
5009     case &#39;y&#39;:
5010       return g_variant_new_byte (va_arg (*app, guint));
5011 
5012     case &#39;n&#39;:
5013       return g_variant_new_int16 (va_arg (*app, gint));
5014 
5015     case &#39;q&#39;:
5016       return g_variant_new_uint16 (va_arg (*app, guint));
5017 
5018     case &#39;i&#39;:
5019       return g_variant_new_int32 (va_arg (*app, gint));
5020 
5021     case &#39;u&#39;:
5022       return g_variant_new_uint32 (va_arg (*app, guint));
5023 
5024     case &#39;x&#39;:
5025       return g_variant_new_int64 (va_arg (*app, gint64));
5026 
5027     case &#39;t&#39;:
5028       return g_variant_new_uint64 (va_arg (*app, guint64));
5029 
5030     case &#39;h&#39;:
5031       return g_variant_new_handle (va_arg (*app, gint));
5032 
5033     case &#39;d&#39;:
5034       return g_variant_new_double (va_arg (*app, gdouble));
5035 
5036     default:
5037       g_assert_not_reached ();
5038     }
5039 }
5040 
5041 /* The code below assumes this */
5042 G_STATIC_ASSERT (sizeof (gboolean) == sizeof (guint32));
5043 G_STATIC_ASSERT (sizeof (gdouble) == sizeof (guint64));
5044 
5045 static void
5046 g_variant_valist_get_leaf (const gchar **str,
5047                            GVariant     *value,
5048                            gboolean      free,
5049                            va_list      *app)
5050 {
5051   gpointer ptr = va_arg (*app, gpointer);
5052 
5053   if (ptr == NULL)
5054     {
5055       g_variant_format_string_scan (*str, NULL, str);
5056       return;
5057     }
5058 
5059   if (g_variant_format_string_is_nnp (*str))
5060     {
5061       gpointer *nnp = (gpointer *) ptr;
5062 
5063       if (free &amp;&amp; *nnp != NULL)
5064         g_variant_valist_free_nnp (*str, *nnp);
5065 
5066       *nnp = NULL;
5067 
5068       if (value != NULL)
5069         *nnp = g_variant_valist_get_nnp (str, value);
5070       else
5071         g_variant_format_string_scan (*str, NULL, str);
5072 
5073       return;
5074     }
5075 
5076   if (value != NULL)
5077     {
5078       switch (*(*str)++)
5079         {
5080         case &#39;b&#39;:
5081           *(gboolean *) ptr = g_variant_get_boolean (value);
5082           return;
5083 
5084         case &#39;y&#39;:
5085           *(guint8 *) ptr = g_variant_get_byte (value);
5086           return;
5087 
5088         case &#39;n&#39;:
5089           *(gint16 *) ptr = g_variant_get_int16 (value);
5090           return;
5091 
5092         case &#39;q&#39;:
5093           *(guint16 *) ptr = g_variant_get_uint16 (value);
5094           return;
5095 
5096         case &#39;i&#39;:
5097           *(gint32 *) ptr = g_variant_get_int32 (value);
5098           return;
5099 
5100         case &#39;u&#39;:
5101           *(guint32 *) ptr = g_variant_get_uint32 (value);
5102           return;
5103 
5104         case &#39;x&#39;:
5105           *(gint64 *) ptr = g_variant_get_int64 (value);
5106           return;
5107 
5108         case &#39;t&#39;:
5109           *(guint64 *) ptr = g_variant_get_uint64 (value);
5110           return;
5111 
5112         case &#39;h&#39;:
5113           *(gint32 *) ptr = g_variant_get_handle (value);
5114           return;
5115 
5116         case &#39;d&#39;:
5117           *(gdouble *) ptr = g_variant_get_double (value);
5118           return;
5119         }
5120     }
5121   else
5122     {
5123       switch (*(*str)++)
5124         {
5125         case &#39;y&#39;:
5126           *(guint8 *) ptr = 0;
5127           return;
5128 
5129         case &#39;n&#39;:
5130         case &#39;q&#39;:
5131           *(guint16 *) ptr = 0;
5132           return;
5133 
5134         case &#39;i&#39;:
5135         case &#39;u&#39;:
5136         case &#39;h&#39;:
5137         case &#39;b&#39;:
5138           *(guint32 *) ptr = 0;
5139           return;
5140 
5141         case &#39;x&#39;:
5142         case &#39;t&#39;:
5143         case &#39;d&#39;:
5144           *(guint64 *) ptr = 0;
5145           return;
5146         }
5147     }
5148 
5149   g_assert_not_reached ();
5150 }
5151 
5152 /* Generic (recursive) {{{2 */
5153 static void
5154 g_variant_valist_skip (const gchar **str,
5155                        va_list      *app)
5156 {
5157   if (g_variant_format_string_is_leaf (*str))
5158     g_variant_valist_skip_leaf (str, app);
5159 
5160   else if (**str == &#39;m&#39;) /* maybe */
5161     {
5162       (*str)++;
5163 
5164       if (!g_variant_format_string_is_nnp (*str))
5165         va_arg (*app, gboolean);
5166 
5167       g_variant_valist_skip (str, app);
5168     }
5169   else /* tuple, dictionary entry */
5170     {
5171       g_assert (**str == &#39;(&#39; || **str == &#39;{&#39;);
5172       (*str)++;
5173       while (**str != &#39;)&#39; &amp;&amp; **str != &#39;}&#39;)
5174         g_variant_valist_skip (str, app);
5175       (*str)++;
5176     }
5177 }
5178 
5179 static GVariant *
5180 g_variant_valist_new (const gchar **str,
5181                       va_list      *app)
5182 {
5183   if (g_variant_format_string_is_leaf (*str))
5184     return g_variant_valist_new_leaf (str, app);
5185 
5186   if (**str == &#39;m&#39;) /* maybe */
5187     {
5188       GVariantType *type = NULL;
5189       GVariant *value = NULL;
5190 
5191       (*str)++;
5192 
5193       if (g_variant_format_string_is_nnp (*str))
5194         {
5195           gpointer nnp = va_arg (*app, gpointer);
5196 
5197           if (nnp != NULL)
5198             value = g_variant_valist_new_nnp (str, nnp);
5199           else
5200             type = g_variant_format_string_scan_type (*str, NULL, str);
5201         }
5202       else
5203         {
5204           gboolean just = va_arg (*app, gboolean);
5205 
5206           if (just)
5207             value = g_variant_valist_new (str, app);
5208           else
5209             {
5210               type = g_variant_format_string_scan_type (*str, NULL, NULL);
5211               g_variant_valist_skip (str, app);
5212             }
5213         }
5214 
5215       value = g_variant_new_maybe (type, value);
5216 
5217       if (type != NULL)
5218         g_variant_type_free (type);
5219 
5220       return value;
5221     }
5222   else /* tuple, dictionary entry */
5223     {
5224       GVariantBuilder b;
5225 
5226       if (**str == &#39;(&#39;)
5227         g_variant_builder_init (&amp;b, G_VARIANT_TYPE_TUPLE);
5228       else
5229         {
5230           g_assert (**str == &#39;{&#39;);
5231           g_variant_builder_init (&amp;b, G_VARIANT_TYPE_DICT_ENTRY);
5232         }
5233 
5234       (*str)++; /* &#39;(&#39; */
5235       while (**str != &#39;)&#39; &amp;&amp; **str != &#39;}&#39;)
5236         g_variant_builder_add_value (&amp;b, g_variant_valist_new (str, app));
5237       (*str)++; /* &#39;)&#39; */
5238 
5239       return g_variant_builder_end (&amp;b);
5240     }
5241 }
5242 
5243 static void
5244 g_variant_valist_get (const gchar **str,
5245                       GVariant     *value,
5246                       gboolean      free,
5247                       va_list      *app)
5248 {
5249   if (g_variant_format_string_is_leaf (*str))
5250     g_variant_valist_get_leaf (str, value, free, app);
5251 
5252   else if (**str == &#39;m&#39;)
5253     {
5254       (*str)++;
5255 
5256       if (value != NULL)
5257         value = g_variant_get_maybe (value);
5258 
5259       if (!g_variant_format_string_is_nnp (*str))
5260         {
5261           gboolean *ptr = va_arg (*app, gboolean *);
5262 
5263           if (ptr != NULL)
5264             *ptr = value != NULL;
5265         }
5266 
5267       g_variant_valist_get (str, value, free, app);
5268 
5269       if (value != NULL)
5270         g_variant_unref (value);
5271     }
5272 
5273   else /* tuple, dictionary entry */
5274     {
5275       gint index = 0;
5276 
5277       g_assert (**str == &#39;(&#39; || **str == &#39;{&#39;);
5278 
5279       (*str)++;
5280       while (**str != &#39;)&#39; &amp;&amp; **str != &#39;}&#39;)
5281         {
5282           if (value != NULL)
5283             {
5284               GVariant *child = g_variant_get_child_value (value, index++);
5285               g_variant_valist_get (str, child, free, app);
5286               g_variant_unref (child);
5287             }
5288           else
5289             g_variant_valist_get (str, NULL, free, app);
5290         }
5291       (*str)++;
5292     }
5293 }
5294 
5295 /* User-facing API {{{2 */
5296 /**
5297  * g_variant_new: (skip)
5298  * @format_string: a #GVariant format string
5299  * @...: arguments, as per @format_string
5300  *
5301  * Creates a new #GVariant instance.
5302  *
5303  * Think of this function as an analogue to g_strdup_printf().
5304  *
5305  * The type of the created instance and the arguments that are expected
5306  * by this function are determined by @format_string. See the section on
5307  * [GVariant format strings][gvariant-format-strings]. Please note that
5308  * the syntax of the format string is very likely to be extended in the
5309  * future.
5310  *
5311  * The first character of the format string must not be &#39;*&#39; &#39;?&#39; &#39;@&#39; or
5312  * &#39;r&#39;; in essence, a new #GVariant must always be constructed by this
5313  * function (and not merely passed through it unmodified).
5314  *
5315  * Note that the arguments must be of the correct width for their types
5316  * specified in @format_string. This can be achieved by casting them. See
5317  * the [GVariant varargs documentation][gvariant-varargs].
5318  *
5319  * |[&lt;!-- language=&quot;C&quot; --&gt;
5320  * MyFlags some_flags = FLAG_ONE | FLAG_TWO;
5321  * const gchar *some_strings[] = { &quot;a&quot;, &quot;b&quot;, &quot;c&quot;, NULL };
5322  * GVariant *new_variant;
5323  *
5324  * new_variant = g_variant_new (&quot;(t^as)&quot;,
5325  *                              // This cast is required.
5326  *                              (guint64) some_flags,
5327  *                              some_strings);
5328  * ]|
5329  *
5330  * Returns: a new floating #GVariant instance
5331  *
5332  * Since: 2.24
5333  **/
5334 GVariant *
5335 g_variant_new (const gchar *format_string,
5336                ...)
5337 {
5338   GVariant *value;
5339   va_list ap;
5340 
5341   g_return_val_if_fail (valid_format_string (format_string, TRUE, NULL) &amp;&amp;
5342                         format_string[0] != &#39;?&#39; &amp;&amp; format_string[0] != &#39;@&#39; &amp;&amp;
5343                         format_string[0] != &#39;*&#39; &amp;&amp; format_string[0] != &#39;r&#39;,
5344                         NULL);
5345 
5346   va_start (ap, format_string);
5347   value = g_variant_new_va (format_string, NULL, &amp;ap);
5348   va_end (ap);
5349 
5350   return value;
5351 }
5352 
5353 /**
5354  * g_variant_new_va: (skip)
5355  * @format_string: a string that is prefixed with a format string
5356  * @endptr: (nullable) (default NULL): location to store the end pointer,
5357  *          or %NULL
5358  * @app: a pointer to a #va_list
5359  *
5360  * This function is intended to be used by libraries based on
5361  * #GVariant that want to provide g_variant_new()-like functionality
5362  * to their users.
5363  *
5364  * The API is more general than g_variant_new() to allow a wider range
5365  * of possible uses.
5366  *
5367  * @format_string must still point to a valid format string, but it only
5368  * needs to be nul-terminated if @endptr is %NULL.  If @endptr is
5369  * non-%NULL then it is updated to point to the first character past the
5370  * end of the format string.
5371  *
5372  * @app is a pointer to a #va_list.  The arguments, according to
5373  * @format_string, are collected from this #va_list and the list is left
5374  * pointing to the argument following the last.
5375  *
5376  * Note that the arguments in @app must be of the correct width for their
5377  * types specified in @format_string when collected into the #va_list.
5378  * See the [GVariant varargs documentation][gvariant-varargs].
5379  *
5380  * These two generalisations allow mixing of multiple calls to
5381  * g_variant_new_va() and g_variant_get_va() within a single actual
5382  * varargs call by the user.
5383  *
5384  * The return value will be floating if it was a newly created GVariant
5385  * instance (for example, if the format string was &quot;(ii)&quot;).  In the case
5386  * that the format_string was &#39;*&#39;, &#39;?&#39;, &#39;r&#39;, or a format starting with
5387  * &#39;@&#39; then the collected #GVariant pointer will be returned unmodified,
5388  * without adding any additional references.
5389  *
5390  * In order to behave correctly in all cases it is necessary for the
5391  * calling function to g_variant_ref_sink() the return result before
5392  * returning control to the user that originally provided the pointer.
5393  * At this point, the caller will have their own full reference to the
5394  * result.  This can also be done by adding the result to a container,
5395  * or by passing it to another g_variant_new() call.
5396  *
5397  * Returns: a new, usually floating, #GVariant
5398  *
5399  * Since: 2.24
5400  **/
5401 GVariant *
5402 g_variant_new_va (const gchar  *format_string,
5403                   const gchar **endptr,
5404                   va_list      *app)
5405 {
5406   GVariant *value;
5407 
5408   g_return_val_if_fail (valid_format_string (format_string, !endptr, NULL),
5409                         NULL);
5410   g_return_val_if_fail (app != NULL, NULL);
5411 
5412   value = g_variant_valist_new (&amp;format_string, app);
5413 
5414   if (endptr != NULL)
5415     *endptr = format_string;
5416 
5417   return value;
5418 }
5419 
5420 /**
5421  * g_variant_get: (skip)
5422  * @value: a #GVariant instance
5423  * @format_string: a #GVariant format string
5424  * @...: arguments, as per @format_string
5425  *
5426  * Deconstructs a #GVariant instance.
5427  *
5428  * Think of this function as an analogue to scanf().
5429  *
5430  * The arguments that are expected by this function are entirely
5431  * determined by @format_string.  @format_string also restricts the
5432  * permissible types of @value.  It is an error to give a value with
5433  * an incompatible type.  See the section on
5434  * [GVariant format strings][gvariant-format-strings].
5435  * Please note that the syntax of the format string is very likely to be
5436  * extended in the future.
5437  *
5438  * @format_string determines the C types that are used for unpacking
5439  * the values and also determines if the values are copied or borrowed,
5440  * see the section on
5441  * [GVariant format strings][gvariant-format-strings-pointers].
5442  *
5443  * Since: 2.24
5444  **/
5445 void
5446 g_variant_get (GVariant    *value,
5447                const gchar *format_string,
5448                ...)
5449 {
5450   va_list ap;
5451 
5452   g_return_if_fail (valid_format_string (format_string, TRUE, value));
5453 
5454   /* if any direct-pointer-access formats are in use, flatten first */
5455   if (strchr (format_string, &#39;&amp;&#39;))
5456     g_variant_get_data (value);
5457 
5458   va_start (ap, format_string);
5459   g_variant_get_va (value, format_string, NULL, &amp;ap);
5460   va_end (ap);
5461 }
5462 
5463 /**
5464  * g_variant_get_va: (skip)
5465  * @value: a #GVariant
5466  * @format_string: a string that is prefixed with a format string
5467  * @endptr: (nullable) (default NULL): location to store the end pointer,
5468  *          or %NULL
5469  * @app: a pointer to a #va_list
5470  *
5471  * This function is intended to be used by libraries based on #GVariant
5472  * that want to provide g_variant_get()-like functionality to their
5473  * users.
5474  *
5475  * The API is more general than g_variant_get() to allow a wider range
5476  * of possible uses.
5477  *
5478  * @format_string must still point to a valid format string, but it only
5479  * need to be nul-terminated if @endptr is %NULL.  If @endptr is
5480  * non-%NULL then it is updated to point to the first character past the
5481  * end of the format string.
5482  *
5483  * @app is a pointer to a #va_list.  The arguments, according to
5484  * @format_string, are collected from this #va_list and the list is left
5485  * pointing to the argument following the last.
5486  *
5487  * These two generalisations allow mixing of multiple calls to
5488  * g_variant_new_va() and g_variant_get_va() within a single actual
5489  * varargs call by the user.
5490  *
5491  * @format_string determines the C types that are used for unpacking
5492  * the values and also determines if the values are copied or borrowed,
5493  * see the section on
5494  * [GVariant format strings][gvariant-format-strings-pointers].
5495  *
5496  * Since: 2.24
5497  **/
5498 void
5499 g_variant_get_va (GVariant     *value,
5500                   const gchar  *format_string,
5501                   const gchar **endptr,
5502                   va_list      *app)
5503 {
5504   g_return_if_fail (valid_format_string (format_string, !endptr, value));
5505   g_return_if_fail (value != NULL);
5506   g_return_if_fail (app != NULL);
5507 
5508   /* if any direct-pointer-access formats are in use, flatten first */
5509   if (strchr (format_string, &#39;&amp;&#39;))
5510     g_variant_get_data (value);
5511 
5512   g_variant_valist_get (&amp;format_string, value, FALSE, app);
5513 
5514   if (endptr != NULL)
5515     *endptr = format_string;
5516 }
5517 
5518 /* Varargs-enabled Utility Functions {{{1 */
5519 
5520 /**
5521  * g_variant_builder_add: (skip)
5522  * @builder: a #GVariantBuilder
5523  * @format_string: a #GVariant varargs format string
5524  * @...: arguments, as per @format_string
5525  *
5526  * Adds to a #GVariantBuilder.
5527  *
5528  * This call is a convenience wrapper that is exactly equivalent to
5529  * calling g_variant_new() followed by g_variant_builder_add_value().
5530  *
5531  * Note that the arguments must be of the correct width for their types
5532  * specified in @format_string. This can be achieved by casting them. See
5533  * the [GVariant varargs documentation][gvariant-varargs].
5534  *
5535  * This function might be used as follows:
5536  *
5537  * |[&lt;!-- language=&quot;C&quot; --&gt;
5538  * GVariant *
5539  * make_pointless_dictionary (void)
5540  * {
5541  *   GVariantBuilder builder;
5542  *   int i;
5543  *
5544  *   g_variant_builder_init (&amp;builder, G_VARIANT_TYPE_ARRAY);
5545  *   for (i = 0; i &lt; 16; i++)
5546  *     {
5547  *       gchar buf[3];
5548  *
5549  *       sprintf (buf, &quot;%d&quot;, i);
5550  *       g_variant_builder_add (&amp;builder, &quot;{is}&quot;, i, buf);
5551  *     }
5552  *
5553  *   return g_variant_builder_end (&amp;builder);
5554  * }
5555  * ]|
5556  *
5557  * Since: 2.24
5558  */
5559 void
5560 g_variant_builder_add (GVariantBuilder *builder,
5561                        const gchar     *format_string,
5562                        ...)
5563 {
5564   GVariant *variant;
5565   va_list ap;
5566 
5567   va_start (ap, format_string);
5568   variant = g_variant_new_va (format_string, NULL, &amp;ap);
5569   va_end (ap);
5570 
5571   g_variant_builder_add_value (builder, variant);
5572 }
5573 
5574 /**
5575  * g_variant_get_child: (skip)
5576  * @value: a container #GVariant
5577  * @index_: the index of the child to deconstruct
5578  * @format_string: a #GVariant format string
5579  * @...: arguments, as per @format_string
5580  *
5581  * Reads a child item out of a container #GVariant instance and
5582  * deconstructs it according to @format_string.  This call is
5583  * essentially a combination of g_variant_get_child_value() and
5584  * g_variant_get().
5585  *
5586  * @format_string determines the C types that are used for unpacking
5587  * the values and also determines if the values are copied or borrowed,
5588  * see the section on
5589  * [GVariant format strings][gvariant-format-strings-pointers].
5590  *
5591  * Since: 2.24
5592  **/
5593 void
5594 g_variant_get_child (GVariant    *value,
5595                      gsize        index_,
5596                      const gchar *format_string,
5597                      ...)
5598 {
5599   GVariant *child;
5600   va_list ap;
5601 
5602   /* if any direct-pointer-access formats are in use, flatten first */
5603   if (strchr (format_string, &#39;&amp;&#39;))
5604     g_variant_get_data (value);
5605 
5606   child = g_variant_get_child_value (value, index_);
5607   g_return_if_fail (valid_format_string (format_string, TRUE, child));
5608 
5609   va_start (ap, format_string);
5610   g_variant_get_va (child, format_string, NULL, &amp;ap);
5611   va_end (ap);
5612 
5613   g_variant_unref (child);
5614 }
5615 
5616 /**
5617  * g_variant_iter_next: (skip)
5618  * @iter: a #GVariantIter
5619  * @format_string: a GVariant format string
5620  * @...: the arguments to unpack the value into
5621  *
5622  * Gets the next item in the container and unpacks it into the variable
5623  * argument list according to @format_string, returning %TRUE.
5624  *
5625  * If no more items remain then %FALSE is returned.
5626  *
5627  * All of the pointers given on the variable arguments list of this
5628  * function are assumed to point at uninitialised memory.  It is the
5629  * responsibility of the caller to free all of the values returned by
5630  * the unpacking process.
5631  *
5632  * Here is an example for memory management with g_variant_iter_next():
5633  * |[&lt;!-- language=&quot;C&quot; --&gt;
5634  *   // Iterates a dictionary of type &#39;a{sv}&#39;
5635  *   void
5636  *   iterate_dictionary (GVariant *dictionary)
5637  *   {
5638  *     GVariantIter iter;
5639  *     GVariant *value;
5640  *     gchar *key;
5641  *
5642  *     g_variant_iter_init (&amp;iter, dictionary);
5643  *     while (g_variant_iter_next (&amp;iter, &quot;{sv}&quot;, &amp;key, &amp;value))
5644  *       {
5645  *         g_print (&quot;Item &#39;%s&#39; has type &#39;%s&#39;\n&quot;, key,
5646  *                  g_variant_get_type_string (value));
5647  *
5648  *         // must free data for ourselves
5649  *         g_variant_unref (value);
5650  *         g_free (key);
5651  *       }
5652  *   }
5653  * ]|
5654  *
5655  * For a solution that is likely to be more convenient to C programmers
5656  * when dealing with loops, see g_variant_iter_loop().
5657  *
5658  * @format_string determines the C types that are used for unpacking
5659  * the values and also determines if the values are copied or borrowed.
5660  *
5661  * See the section on
5662  * [GVariant format strings][gvariant-format-strings-pointers].
5663  *
5664  * Returns: %TRUE if a value was unpacked, or %FALSE if there as no value
5665  *
5666  * Since: 2.24
5667  **/
5668 gboolean
5669 g_variant_iter_next (GVariantIter *iter,
5670                      const gchar  *format_string,
5671                      ...)
5672 {
5673   GVariant *value;
5674 
5675   value = g_variant_iter_next_value (iter);
5676 
5677   g_return_val_if_fail (valid_format_string (format_string, TRUE, value),
5678                         FALSE);
5679 
5680   if (value != NULL)
5681     {
5682       va_list ap;
5683 
5684       va_start (ap, format_string);
5685       g_variant_valist_get (&amp;format_string, value, FALSE, &amp;ap);
5686       va_end (ap);
5687 
5688       g_variant_unref (value);
5689     }
5690 
5691   return value != NULL;
5692 }
5693 
5694 /**
5695  * g_variant_iter_loop: (skip)
5696  * @iter: a #GVariantIter
5697  * @format_string: a GVariant format string
5698  * @...: the arguments to unpack the value into
5699  *
5700  * Gets the next item in the container and unpacks it into the variable
5701  * argument list according to @format_string, returning %TRUE.
5702  *
5703  * If no more items remain then %FALSE is returned.
5704  *
5705  * On the first call to this function, the pointers appearing on the
5706  * variable argument list are assumed to point at uninitialised memory.
5707  * On the second and later calls, it is assumed that the same pointers
5708  * will be given and that they will point to the memory as set by the
5709  * previous call to this function.  This allows the previous values to
5710  * be freed, as appropriate.
5711  *
5712  * This function is intended to be used with a while loop as
5713  * demonstrated in the following example.  This function can only be
5714  * used when iterating over an array.  It is only valid to call this
5715  * function with a string constant for the format string and the same
5716  * string constant must be used each time.  Mixing calls to this
5717  * function and g_variant_iter_next() or g_variant_iter_next_value() on
5718  * the same iterator causes undefined behavior.
5719  *
5720  * If you break out of a such a while loop using g_variant_iter_loop() then
5721  * you must free or unreference all the unpacked values as you would with
5722  * g_variant_get(). Failure to do so will cause a memory leak.
5723  *
5724  * Here is an example for memory management with g_variant_iter_loop():
5725  * |[&lt;!-- language=&quot;C&quot; --&gt;
5726  *   // Iterates a dictionary of type &#39;a{sv}&#39;
5727  *   void
5728  *   iterate_dictionary (GVariant *dictionary)
5729  *   {
5730  *     GVariantIter iter;
5731  *     GVariant *value;
5732  *     gchar *key;
5733  *
5734  *     g_variant_iter_init (&amp;iter, dictionary);
5735  *     while (g_variant_iter_loop (&amp;iter, &quot;{sv}&quot;, &amp;key, &amp;value))
5736  *       {
5737  *         g_print (&quot;Item &#39;%s&#39; has type &#39;%s&#39;\n&quot;, key,
5738  *                  g_variant_get_type_string (value));
5739  *
5740  *         // no need to free &#39;key&#39; and &#39;value&#39; here
5741  *         // unless breaking out of this loop
5742  *       }
5743  *   }
5744  * ]|
5745  *
5746  * For most cases you should use g_variant_iter_next().
5747  *
5748  * This function is really only useful when unpacking into #GVariant or
5749  * #GVariantIter in order to allow you to skip the call to
5750  * g_variant_unref() or g_variant_iter_free().
5751  *
5752  * For example, if you are only looping over simple integer and string
5753  * types, g_variant_iter_next() is definitely preferred.  For string
5754  * types, use the &#39;&amp;&#39; prefix to avoid allocating any memory at all (and
5755  * thereby avoiding the need to free anything as well).
5756  *
5757  * @format_string determines the C types that are used for unpacking
5758  * the values and also determines if the values are copied or borrowed.
5759  *
5760  * See the section on
5761  * [GVariant format strings][gvariant-format-strings-pointers].
5762  *
5763  * Returns: %TRUE if a value was unpacked, or %FALSE if there was no
5764  *          value
5765  *
5766  * Since: 2.24
5767  **/
5768 gboolean
5769 g_variant_iter_loop (GVariantIter *iter,
5770                      const gchar  *format_string,
5771                      ...)
5772 {
5773   gboolean first_time = GVSI(iter)-&gt;loop_format == NULL;
5774   GVariant *value;
5775   va_list ap;
5776 
5777   g_return_val_if_fail (first_time ||
5778                         format_string == GVSI(iter)-&gt;loop_format,
5779                         FALSE);
5780 
5781   if (first_time)
5782     {
5783       TYPE_CHECK (GVSI(iter)-&gt;value, G_VARIANT_TYPE_ARRAY, FALSE);
5784       GVSI(iter)-&gt;loop_format = format_string;
5785 
5786       if (strchr (format_string, &#39;&amp;&#39;))
5787         g_variant_get_data (GVSI(iter)-&gt;value);
5788     }
5789 
5790   value = g_variant_iter_next_value (iter);
5791 
5792   g_return_val_if_fail (!first_time ||
5793                         valid_format_string (format_string, TRUE, value),
5794                         FALSE);
5795 
5796   va_start (ap, format_string);
5797   g_variant_valist_get (&amp;format_string, value, !first_time, &amp;ap);
5798   va_end (ap);
5799 
5800   if (value != NULL)
5801     g_variant_unref (value);
5802 
5803   return value != NULL;
5804 }
5805 
5806 /* Serialised data {{{1 */
5807 static GVariant *
5808 g_variant_deep_copy (GVariant *value)
5809 {
5810   switch (g_variant_classify (value))
5811     {
5812     case G_VARIANT_CLASS_MAYBE:
5813     case G_VARIANT_CLASS_ARRAY:
5814     case G_VARIANT_CLASS_TUPLE:
5815     case G_VARIANT_CLASS_DICT_ENTRY:
5816     case G_VARIANT_CLASS_VARIANT:
5817       {
5818         GVariantBuilder builder;
5819         GVariantIter iter;
5820         GVariant *child;
5821 
5822         g_variant_builder_init (&amp;builder, g_variant_get_type (value));
5823         g_variant_iter_init (&amp;iter, value);
5824 
5825         while ((child = g_variant_iter_next_value (&amp;iter)))
5826           {
5827             g_variant_builder_add_value (&amp;builder, g_variant_deep_copy (child));
5828             g_variant_unref (child);
5829           }
5830 
5831         return g_variant_builder_end (&amp;builder);
5832       }
5833 
5834     case G_VARIANT_CLASS_BOOLEAN:
5835       return g_variant_new_boolean (g_variant_get_boolean (value));
5836 
5837     case G_VARIANT_CLASS_BYTE:
5838       return g_variant_new_byte (g_variant_get_byte (value));
5839 
5840     case G_VARIANT_CLASS_INT16:
5841       return g_variant_new_int16 (g_variant_get_int16 (value));
5842 
5843     case G_VARIANT_CLASS_UINT16:
5844       return g_variant_new_uint16 (g_variant_get_uint16 (value));
5845 
5846     case G_VARIANT_CLASS_INT32:
5847       return g_variant_new_int32 (g_variant_get_int32 (value));
5848 
5849     case G_VARIANT_CLASS_UINT32:
5850       return g_variant_new_uint32 (g_variant_get_uint32 (value));
5851 
5852     case G_VARIANT_CLASS_INT64:
5853       return g_variant_new_int64 (g_variant_get_int64 (value));
5854 
5855     case G_VARIANT_CLASS_UINT64:
5856       return g_variant_new_uint64 (g_variant_get_uint64 (value));
5857 
5858     case G_VARIANT_CLASS_HANDLE:
5859       return g_variant_new_handle (g_variant_get_handle (value));
5860 
5861     case G_VARIANT_CLASS_DOUBLE:
5862       return g_variant_new_double (g_variant_get_double (value));
5863 
5864     case G_VARIANT_CLASS_STRING:
5865       return g_variant_new_string (g_variant_get_string (value, NULL));
5866 
5867     case G_VARIANT_CLASS_OBJECT_PATH:
5868       return g_variant_new_object_path (g_variant_get_string (value, NULL));
5869 
5870     case G_VARIANT_CLASS_SIGNATURE:
5871       return g_variant_new_signature (g_variant_get_string (value, NULL));
5872     }
5873 
5874   g_assert_not_reached ();
5875 }
5876 
5877 /**
5878  * g_variant_get_normal_form:
5879  * @value: a #GVariant
5880  *
5881  * Gets a #GVariant instance that has the same value as @value and is
5882  * trusted to be in normal form.
5883  *
5884  * If @value is already trusted to be in normal form then a new
5885  * reference to @value is returned.
5886  *
5887  * If @value is not already trusted, then it is scanned to check if it
5888  * is in normal form.  If it is found to be in normal form then it is
5889  * marked as trusted and a new reference to it is returned.
5890  *
5891  * If @value is found not to be in normal form then a new trusted
5892  * #GVariant is created with the same value as @value.
5893  *
5894  * It makes sense to call this function if you&#39;ve received #GVariant
5895  * data from untrusted sources and you want to ensure your serialised
5896  * output is definitely in normal form.
5897  *
5898  * If @value is already in normal form, a new reference will be returned
5899  * (which will be floating if @value is floating). If it is not in normal form,
5900  * the newly created #GVariant will be returned with a single non-floating
5901  * reference. Typically, g_variant_take_ref() should be called on the return
5902  * value from this function to guarantee ownership of a single non-floating
5903  * reference to it.
5904  *
5905  * Returns: (transfer full): a trusted #GVariant
5906  *
5907  * Since: 2.24
5908  **/
5909 GVariant *
5910 g_variant_get_normal_form (GVariant *value)
5911 {
5912   GVariant *trusted;
5913 
5914   if (g_variant_is_normal_form (value))
5915     return g_variant_ref (value);
5916 
5917   trusted = g_variant_deep_copy (value);
5918   g_assert (g_variant_is_trusted (trusted));
5919 
5920   return g_variant_ref_sink (trusted);
5921 }
5922 
5923 /**
5924  * g_variant_byteswap:
5925  * @value: a #GVariant
5926  *
5927  * Performs a byteswapping operation on the contents of @value.  The
5928  * result is that all multi-byte numeric data contained in @value is
5929  * byteswapped.  That includes 16, 32, and 64bit signed and unsigned
5930  * integers as well as file handles and double precision floating point
5931  * values.
5932  *
5933  * This function is an identity mapping on any value that does not
5934  * contain multi-byte numeric data.  That include strings, booleans,
5935  * bytes and containers containing only these things (recursively).
5936  *
5937  * The returned value is always in normal form and is marked as trusted.
5938  *
5939  * Returns: (transfer full): the byteswapped form of @value
5940  *
5941  * Since: 2.24
5942  **/
5943 GVariant *
5944 g_variant_byteswap (GVariant *value)
5945 {
5946   GVariantTypeInfo *type_info;
5947   guint alignment;
5948   GVariant *new;
5949 
5950   type_info = g_variant_get_type_info (value);
5951 
5952   g_variant_type_info_query (type_info, &amp;alignment, NULL);
5953 
5954   if (alignment)
5955     /* (potentially) contains multi-byte numeric data */
5956     {
5957       GVariantSerialised serialised;
5958       GVariant *trusted;
5959       GBytes *bytes;
5960 
5961       trusted = g_variant_get_normal_form (value);
5962       serialised.type_info = g_variant_get_type_info (trusted);
5963       serialised.size = g_variant_get_size (trusted);
5964       serialised.data = g_malloc (serialised.size);
5965       g_variant_store (trusted, serialised.data);
5966       g_variant_unref (trusted);
5967 
5968       g_variant_serialised_byteswap (serialised);
5969 
5970       bytes = g_bytes_new_take (serialised.data, serialised.size);
5971 #ifdef GSTREAMER_LITE
5972       if (bytes == NULL) {
5973         return NULL;
5974       }
5975 #endif // GSTREAMER_LITE
5976       new = g_variant_new_from_bytes (g_variant_get_type (value), bytes, TRUE);
5977       g_bytes_unref (bytes);
5978     }
5979   else
5980     /* contains no multi-byte data */
5981     new = value;
5982 
5983   return g_variant_ref_sink (new);
5984 }
5985 
5986 /**
5987  * g_variant_new_from_data:
5988  * @type: a definite #GVariantType
5989  * @data: (array length=size) (element-type guint8): the serialised data
5990  * @size: the size of @data
5991  * @trusted: %TRUE if @data is definitely in normal form
5992  * @notify: (scope async): function to call when @data is no longer needed
5993  * @user_data: data for @notify
5994  *
5995  * Creates a new #GVariant instance from serialised data.
5996  *
5997  * @type is the type of #GVariant instance that will be constructed.
5998  * The interpretation of @data depends on knowing the type.
5999  *
6000  * @data is not modified by this function and must remain valid with an
6001  * unchanging value until such a time as @notify is called with
6002  * @user_data.  If the contents of @data change before that time then
6003  * the result is undefined.
6004  *
6005  * If @data is trusted to be serialised data in normal form then
6006  * @trusted should be %TRUE.  This applies to serialised data created
6007  * within this process or read from a trusted location on the disk (such
6008  * as a file installed in /usr/lib alongside your application).  You
6009  * should set trusted to %FALSE if @data is read from the network, a
6010  * file in the user&#39;s home directory, etc.
6011  *
6012  * If @data was not stored in this machine&#39;s native endianness, any multi-byte
6013  * numeric values in the returned variant will also be in non-native
6014  * endianness. g_variant_byteswap() can be used to recover the original values.
6015  *
6016  * @notify will be called with @user_data when @data is no longer
6017  * needed.  The exact time of this call is unspecified and might even be
6018  * before this function returns.
6019  *
6020  * Note: @data must be backed by memory that is aligned appropriately for the
6021  * @type being loaded. Otherwise this function will internally create a copy of
6022  * the memory (since GLib 2.60) or (in older versions) fail and exit the
6023  * process.
6024  *
6025  * Returns: (transfer none): a new floating #GVariant of type @type
6026  *
6027  * Since: 2.24
6028  **/
6029 GVariant *
6030 g_variant_new_from_data (const GVariantType *type,
6031                          gconstpointer       data,
6032                          gsize               size,
6033                          gboolean            trusted,
6034                          GDestroyNotify      notify,
6035                          gpointer            user_data)
6036 {
6037   GVariant *value;
6038   GBytes *bytes;
6039 
6040   g_return_val_if_fail (g_variant_type_is_definite (type), NULL);
6041   g_return_val_if_fail (data != NULL || size == 0, NULL);
6042 
6043   if (notify)
6044     bytes = g_bytes_new_with_free_func (data, size, notify, user_data);
6045   else
6046     bytes = g_bytes_new_static (data, size);
6047 
6048   value = g_variant_new_from_bytes (type, bytes, trusted);
6049   g_bytes_unref (bytes);
6050 
6051   return value;
6052 }
6053 
6054 /* Epilogue {{{1 */
6055 /* vim:set foldmethod=marker: */
    </pre>
  </body>
</html>