<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.media/src/main/native/gstreamer/3rd_party/glib/glib/giochannel.c</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ghostutils.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="giochannel.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.media/src/main/native/gstreamer/3rd_party/glib/glib/giochannel.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 37,11 ***</span>
  #include &quot;giochannel.h&quot;
  
  #include &quot;gstrfuncs.h&quot;
  #include &quot;gtestutils.h&quot;
  #include &quot;glibintl.h&quot;
<span class="line-removed">- #include &quot;gunicodeprivate.h&quot;</span>
  
  
  /**
   * SECTION:iochannels
   * @title: IO Channels
<span class="line-new-header">--- 37,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 151,29 ***</span>
   **/
  
  #define G_IO_NICE_BUF_SIZE  1024
  
  /* This needs to be as wide as the largest character in any possible encoding */
<span class="line-modified">! #define MAX_CHAR_SIZE       10</span>
  
  /* Some simplifying macros, which reduce the need to worry whether the
   * buffers have been allocated. These also make USE_BUF () an lvalue,
   * which is used in g_io_channel_read_to_end ().
   */
<span class="line-modified">! #define USE_BUF(channel)    ((channel)-&gt;encoding ? (channel)-&gt;encoded_read_buf \</span>
<span class="line-modified">!                  : (channel)-&gt;read_buf)</span>
<span class="line-modified">! #define BUF_LEN(string)     ((string) ? (string)-&gt;len : 0)</span>
<span class="line-modified">! </span>
<span class="line-modified">! static GIOError     g_io_error_get_from_g_error (GIOStatus    status,</span>
<span class="line-modified">!                              GError      *err);</span>
<span class="line-modified">! static void     g_io_channel_purge      (GIOChannel  *channel);</span>
<span class="line-modified">! static GIOStatus    g_io_channel_fill_buffer    (GIOChannel  *channel,</span>
<span class="line-modified">!                              GError     **err);</span>
<span class="line-modified">! static GIOStatus    g_io_channel_read_line_backend  (GIOChannel  *channel,</span>
<span class="line-modified">!                              gsize       *length,</span>
<span class="line-modified">!                              gsize       *terminator_pos,</span>
<span class="line-modified">!                              GError     **error);</span>
  
  /**
   * g_io_channel_init:
   * @channel: a #GIOChannel
   *
<span class="line-new-header">--- 150,29 ---</span>
   **/
  
  #define G_IO_NICE_BUF_SIZE  1024
  
  /* This needs to be as wide as the largest character in any possible encoding */
<span class="line-modified">! #define MAX_CHAR_SIZE   10</span>
  
  /* Some simplifying macros, which reduce the need to worry whether the
   * buffers have been allocated. These also make USE_BUF () an lvalue,
   * which is used in g_io_channel_read_to_end ().
   */
<span class="line-modified">! #define USE_BUF(channel)  ((channel)-&gt;encoding ? (channel)-&gt;encoded_read_buf \</span>
<span class="line-modified">!          : (channel)-&gt;read_buf)</span>
<span class="line-modified">! #define BUF_LEN(string)   ((string) ? (string)-&gt;len : 0)</span>
<span class="line-modified">! </span>
<span class="line-modified">! static GIOError   g_io_error_get_from_g_error (GIOStatus    status,</span>
<span class="line-modified">!                GError      *err);</span>
<span class="line-modified">! static void   g_io_channel_purge    (GIOChannel  *channel);</span>
<span class="line-modified">! static GIOStatus  g_io_channel_fill_buffer  (GIOChannel  *channel,</span>
<span class="line-modified">!                GError     **err);</span>
<span class="line-modified">! static GIOStatus  g_io_channel_read_line_backend  (GIOChannel  *channel,</span>
<span class="line-modified">!                gsize       *length,</span>
<span class="line-modified">!                gsize       *terminator_pos,</span>
<span class="line-modified">!                GError     **error);</span>
  
  /**
   * g_io_channel_init:
   * @channel: a #GIOChannel
   *
</pre>
<hr />
<pre>
<span class="line-old-header">*** 257,21 ***</span>
      }
  }
  
  static GIOError
  g_io_error_get_from_g_error (GIOStatus  status,
<span class="line-modified">!                  GError    *err)</span>
  {
    switch (status)
      {
        case G_IO_STATUS_NORMAL:
        case G_IO_STATUS_EOF:
          return G_IO_ERROR_NONE;
        case G_IO_STATUS_AGAIN:
          return G_IO_ERROR_AGAIN;
        case G_IO_STATUS_ERROR:
<span class="line-modified">!     g_return_val_if_fail (err != NULL, G_IO_ERROR_UNKNOWN);</span>
  
          if (err-&gt;domain != G_IO_CHANNEL_ERROR)
            return G_IO_ERROR_UNKNOWN;
          switch (err-&gt;code)
            {
<span class="line-new-header">--- 256,21 ---</span>
      }
  }
  
  static GIOError
  g_io_error_get_from_g_error (GIOStatus  status,
<span class="line-modified">!            GError    *err)</span>
  {
    switch (status)
      {
        case G_IO_STATUS_NORMAL:
        case G_IO_STATUS_EOF:
          return G_IO_ERROR_NONE;
        case G_IO_STATUS_AGAIN:
          return G_IO_ERROR_AGAIN;
        case G_IO_STATUS_ERROR:
<span class="line-modified">!   g_return_val_if_fail (err != NULL, G_IO_ERROR_UNKNOWN);</span>
  
          if (err-&gt;domain != G_IO_CHANNEL_ERROR)
            return G_IO_ERROR_UNKNOWN;
          switch (err-&gt;code)
            {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 299,13 ***</span>
   *
   * Deprecated:2.2: Use g_io_channel_read_chars() instead.
   **/
  GIOError
  g_io_channel_read (GIOChannel *channel,
<span class="line-modified">!            gchar      *buf,</span>
<span class="line-modified">!            gsize       count,</span>
<span class="line-modified">!            gsize      *bytes_read)</span>
  {
    GError *err = NULL;
    GIOError error;
    GIOStatus status;
  
<span class="line-new-header">--- 298,13 ---</span>
   *
   * Deprecated:2.2: Use g_io_channel_read_chars() instead.
   **/
  GIOError
  g_io_channel_read (GIOChannel *channel,
<span class="line-modified">!        gchar      *buf,</span>
<span class="line-modified">!        gsize       count,</span>
<span class="line-modified">!        gsize      *bytes_read)</span>
  {
    GError *err = NULL;
    GIOError error;
    GIOStatus status;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 344,13 ***</span>
   *
   * Deprecated:2.2: Use g_io_channel_write_chars() instead.
   **/
  GIOError
  g_io_channel_write (GIOChannel  *channel,
<span class="line-modified">!             const gchar *buf,</span>
<span class="line-modified">!             gsize        count,</span>
<span class="line-modified">!             gsize       *bytes_written)</span>
  {
    GError *err = NULL;
    GIOError error;
    GIOStatus status;
  
<span class="line-new-header">--- 343,13 ---</span>
   *
   * Deprecated:2.2: Use g_io_channel_write_chars() instead.
   **/
  GIOError
  g_io_channel_write (GIOChannel  *channel,
<span class="line-modified">!         const gchar *buf,</span>
<span class="line-modified">!         gsize        count,</span>
<span class="line-modified">!         gsize       *bytes_written)</span>
  {
    GError *err = NULL;
    GIOError error;
    GIOStatus status;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 383,12 ***</span>
   *
   * Deprecated:2.2: Use g_io_channel_seek_position() instead.
   **/
  GIOError
  g_io_channel_seek (GIOChannel *channel,
<span class="line-modified">!            gint64      offset,</span>
<span class="line-modified">!            GSeekType   type)</span>
  {
    GError *err = NULL;
    GIOError error;
    GIOStatus status;
  
<span class="line-new-header">--- 382,12 ---</span>
   *
   * Deprecated:2.2: Use g_io_channel_seek_position() instead.
   **/
  GIOError
  g_io_channel_seek (GIOChannel *channel,
<span class="line-modified">!        gint64      offset,</span>
<span class="line-modified">!        GSeekType   type)</span>
  {
    GError *err = NULL;
    GIOError error;
    GIOStatus status;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 481,12 ***</span>
   *
   * Returns: the status of the operation.
   **/
  GIOStatus
  g_io_channel_shutdown (GIOChannel  *channel,
<span class="line-modified">!                gboolean     flush,</span>
<span class="line-modified">!                GError     **err)</span>
  {
    GIOStatus status, result;
    GError *tmperr = NULL;
  
    g_return_val_if_fail (channel != NULL, G_IO_STATUS_ERROR);
<span class="line-new-header">--- 480,12 ---</span>
   *
   * Returns: the status of the operation.
   **/
  GIOStatus
  g_io_channel_shutdown (GIOChannel  *channel,
<span class="line-modified">!            gboolean     flush,</span>
<span class="line-modified">!            GError     **err)</span>
  {
    GIOStatus status, result;
    GError *tmperr = NULL;
  
    g_return_val_if_fail (channel != NULL, G_IO_STATUS_ERROR);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 607,11 ***</span>
   *
   * Returns: a new #GSource
   */
  GSource *
  g_io_create_watch (GIOChannel   *channel,
<span class="line-modified">!            GIOCondition  condition)</span>
  {
    g_return_val_if_fail (channel != NULL, NULL);
  
    return channel-&gt;funcs-&gt;io_create_watch (channel, condition);
  }
<span class="line-new-header">--- 606,11 ---</span>
   *
   * Returns: a new #GSource
   */
  GSource *
  g_io_create_watch (GIOChannel   *channel,
<span class="line-modified">!        GIOCondition  condition)</span>
  {
    g_return_val_if_fail (channel != NULL, NULL);
  
    return channel-&gt;funcs-&gt;io_create_watch (channel, condition);
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 634,15 ***</span>
   *
   * Returns: the event source id
   */
  guint
  g_io_add_watch_full (GIOChannel    *channel,
<span class="line-modified">!              gint           priority,</span>
<span class="line-modified">!              GIOCondition   condition,</span>
<span class="line-modified">!              GIOFunc        func,</span>
<span class="line-modified">!              gpointer       user_data,</span>
<span class="line-modified">!              GDestroyNotify notify)</span>
  {
    GSource *source;
    guint id;
  
    g_return_val_if_fail (channel != NULL, 0);
<span class="line-new-header">--- 633,15 ---</span>
   *
   * Returns: the event source id
   */
  guint
  g_io_add_watch_full (GIOChannel    *channel,
<span class="line-modified">!          gint           priority,</span>
<span class="line-modified">!          GIOCondition   condition,</span>
<span class="line-modified">!          GIOFunc        func,</span>
<span class="line-modified">!          gpointer       user_data,</span>
<span class="line-modified">!          GDestroyNotify notify)</span>
  {
    GSource *source;
    guint id;
  
    g_return_val_if_fail (channel != NULL, 0);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 697,13 ***</span>
   * A bitwise combination representing a condition to watch for on an
   * event source.
   **/
  guint
  g_io_add_watch (GIOChannel   *channel,
<span class="line-modified">!         GIOCondition  condition,</span>
<span class="line-modified">!         GIOFunc       func,</span>
<span class="line-modified">!         gpointer      user_data)</span>
  {
    return g_io_add_watch_full (channel, G_PRIORITY_DEFAULT, condition, func, user_data, NULL);
  }
  
  /**
<span class="line-new-header">--- 696,13 ---</span>
   * A bitwise combination representing a condition to watch for on an
   * event source.
   **/
  guint
  g_io_add_watch (GIOChannel   *channel,
<span class="line-modified">!     GIOCondition  condition,</span>
<span class="line-modified">!     GIOFunc       func,</span>
<span class="line-modified">!     gpointer      user_data)</span>
  {
    return g_io_add_watch_full (channel, G_PRIORITY_DEFAULT, condition, func, user_data, NULL);
  }
  
  /**
</pre>
<hr />
<pre>
<span class="line-old-header">*** 880,11 ***</span>
   * where in the file a line break occurs.
   **/
  void
  g_io_channel_set_line_term (GIOChannel  *channel,
                              const gchar *line_term,
<span class="line-modified">!                 gint         length)</span>
  {
    g_return_if_fail (channel != NULL);
    g_return_if_fail (line_term == NULL || length != 0); /* Disallow &quot;&quot; */
  
    if (line_term == NULL)
<span class="line-new-header">--- 879,11 ---</span>
   * where in the file a line break occurs.
   **/
  void
  g_io_channel_set_line_term (GIOChannel  *channel,
                              const gchar *line_term,
<span class="line-modified">!           gint         length)</span>
  {
    g_return_if_fail (channel != NULL);
    g_return_if_fail (line_term == NULL || length != 0); /* Disallow &quot;&quot; */
  
    if (line_term == NULL)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 909,11 ***</span>
   * Returns: The line termination string. This value
   *   is owned by GLib and must not be freed.
   **/
  const gchar *
  g_io_channel_get_line_term (GIOChannel *channel,
<span class="line-modified">!                 gint       *length)</span>
  {
    g_return_val_if_fail (channel != NULL, NULL);
  
    if (length)
      *length = channel-&gt;line_term_len;
<span class="line-new-header">--- 908,11 ---</span>
   * Returns: The line termination string. This value
   *   is owned by GLib and must not be freed.
   **/
  const gchar *
  g_io_channel_get_line_term (GIOChannel *channel,
<span class="line-modified">!           gint       *length)</span>
  {
    g_return_val_if_fail (channel != NULL, NULL);
  
    if (length)
      *length = channel-&gt;line_term_len;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 963,15 ***</span>
                          GIOFlags     flags,
                          GError     **error)
  {
    g_return_val_if_fail (channel != NULL, G_IO_STATUS_ERROR);
    g_return_val_if_fail ((error == NULL) || (*error == NULL),
<span class="line-modified">!             G_IO_STATUS_ERROR);</span>
  
    return (*channel-&gt;funcs-&gt;io_set_flags) (channel,
<span class="line-modified">!                       flags &amp; G_IO_FLAG_SET_MASK,</span>
<span class="line-modified">!                       error);</span>
  }
  
  /**
   * g_io_channel_get_flags:
   * @channel: a #GIOChannel
<span class="line-new-header">--- 962,15 ---</span>
                          GIOFlags     flags,
                          GError     **error)
  {
    g_return_val_if_fail (channel != NULL, G_IO_STATUS_ERROR);
    g_return_val_if_fail ((error == NULL) || (*error == NULL),
<span class="line-modified">!       G_IO_STATUS_ERROR);</span>
  
    return (*channel-&gt;funcs-&gt;io_set_flags) (channel,
<span class="line-modified">!             flags &amp; G_IO_FLAG_SET_MASK,</span>
<span class="line-modified">!             error);</span>
  }
  
  /**
   * g_io_channel_get_flags:
   * @channel: a #GIOChannel
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1022,11 ***</span>
   * Setting this flag to %TRUE for a channel you have already closed
   * can cause problems when the final reference to the #GIOChannel is dropped.
   **/
  void
  g_io_channel_set_close_on_unref (GIOChannel *channel,
<span class="line-modified">!                                  gboolean    do_close)</span>
  {
    g_return_if_fail (channel != NULL);
  
    channel-&gt;close_on_unref = do_close;
  }
<span class="line-new-header">--- 1021,11 ---</span>
   * Setting this flag to %TRUE for a channel you have already closed
   * can cause problems when the final reference to the #GIOChannel is dropped.
   **/
  void
  g_io_channel_set_close_on_unref (GIOChannel *channel,
<span class="line-modified">!          gboolean    do_close)</span>
  {
    g_return_if_fail (channel != NULL);
  
    channel-&gt;close_on_unref = do_close;
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1085,11 ***</span>
     * For sockets, both can contain data.
     */
  
    g_return_val_if_fail (channel != NULL, G_IO_STATUS_ERROR);
    g_return_val_if_fail ((error == NULL) || (*error == NULL),
<span class="line-modified">!             G_IO_STATUS_ERROR);</span>
    g_return_val_if_fail (channel-&gt;is_seekable, G_IO_STATUS_ERROR);
  
    switch (type)
      {
        case G_SEEK_CUR: /* The user is seeking relative to the head of the buffer */
<span class="line-new-header">--- 1084,11 ---</span>
     * For sockets, both can contain data.
     */
  
    g_return_val_if_fail (channel != NULL, G_IO_STATUS_ERROR);
    g_return_val_if_fail ((error == NULL) || (*error == NULL),
<span class="line-modified">!       G_IO_STATUS_ERROR);</span>
    g_return_val_if_fail (channel-&gt;is_seekable, G_IO_STATUS_ERROR);
  
    switch (type)
      {
        case G_SEEK_CUR: /* The user is seeking relative to the head of the buffer */
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1172,11 ***</span>
   *   #G_IO_STATUS_NORMAL, #G_IO_STATUS_AGAIN, or
   *   #G_IO_STATUS_ERROR.
   **/
  GIOStatus
  g_io_channel_flush (GIOChannel  *channel,
<span class="line-modified">!                     GError     **error)</span>
  {
    GIOStatus status;
    gsize this_time = 1, bytes_written = 0;
  
    g_return_val_if_fail (channel != NULL, G_IO_STATUS_ERROR);
<span class="line-new-header">--- 1171,11 ---</span>
   *   #G_IO_STATUS_NORMAL, #G_IO_STATUS_AGAIN, or
   *   #G_IO_STATUS_ERROR.
   **/
  GIOStatus
  g_io_channel_flush (GIOChannel  *channel,
<span class="line-modified">!         GError     **error)</span>
  {
    GIOStatus status;
    gsize this_time = 1, bytes_written = 0;
  
    g_return_val_if_fail (channel != NULL, G_IO_STATUS_ERROR);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1188,13 ***</span>
    do
      {
        g_assert (this_time &gt; 0);
  
        status = channel-&gt;funcs-&gt;io_write (channel,
<span class="line-modified">!                      channel-&gt;write_buf-&gt;str + bytes_written,</span>
<span class="line-modified">!                      channel-&gt;write_buf-&gt;len - bytes_written,</span>
<span class="line-modified">!                      &amp;this_time, error);</span>
        bytes_written += this_time;
      }
    while ((bytes_written &lt; channel-&gt;write_buf-&gt;len)
           &amp;&amp; (status == G_IO_STATUS_NORMAL));
  
<span class="line-new-header">--- 1187,13 ---</span>
    do
      {
        g_assert (this_time &gt; 0);
  
        status = channel-&gt;funcs-&gt;io_write (channel,
<span class="line-modified">!            channel-&gt;write_buf-&gt;str + bytes_written,</span>
<span class="line-modified">!            channel-&gt;write_buf-&gt;len - bytes_written,</span>
<span class="line-modified">!            &amp;this_time, error);</span>
        bytes_written += this_time;
      }
    while ((bytes_written &lt; channel-&gt;write_buf-&gt;len)
           &amp;&amp; (status == G_IO_STATUS_NORMAL));
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1305,24 ***</span>
   * calling one of the API &quot;read&quot; functions.
   *
   * Return Value: %G_IO_STATUS_NORMAL if the encoding was successfully set
   */
  GIOStatus
<span class="line-modified">! g_io_channel_set_encoding (GIOChannel   *channel,</span>
                             const gchar  *encoding,
<span class="line-modified">!                            GError      **error)</span>
  {
    GIConv read_cd, write_cd;
    gboolean did_encode;
  
    g_return_val_if_fail (channel != NULL, G_IO_STATUS_ERROR);
    g_return_val_if_fail ((error == NULL) || (*error == NULL), G_IO_STATUS_ERROR);
  
    /* Make sure the encoded buffers are empty */
  
    g_return_val_if_fail (!channel-&gt;do_encode || !channel-&gt;encoded_read_buf ||
<span class="line-modified">!             channel-&gt;encoded_read_buf-&gt;len == 0, G_IO_STATUS_ERROR);</span>
  
    if (!channel-&gt;use_buffer)
      {
        g_warning (&quot;Need to set the channel buffered before setting the encoding.&quot;);
        g_warning (&quot;Assuming this is what you meant and acting accordingly.&quot;);
<span class="line-new-header">--- 1304,26 ---</span>
   * calling one of the API &quot;read&quot; functions.
   *
   * Return Value: %G_IO_STATUS_NORMAL if the encoding was successfully set
   */
  GIOStatus
<span class="line-modified">! g_io_channel_set_encoding (GIOChannel *channel,</span>
                             const gchar  *encoding,
<span class="line-modified">!          GError      **error)</span>
  {
    GIConv read_cd, write_cd;
<span class="line-added">+ #ifndef G_DISABLE_ASSERT</span>
    gboolean did_encode;
<span class="line-added">+ #endif</span>
  
    g_return_val_if_fail (channel != NULL, G_IO_STATUS_ERROR);
    g_return_val_if_fail ((error == NULL) || (*error == NULL), G_IO_STATUS_ERROR);
  
    /* Make sure the encoded buffers are empty */
  
    g_return_val_if_fail (!channel-&gt;do_encode || !channel-&gt;encoded_read_buf ||
<span class="line-modified">!       channel-&gt;encoded_read_buf-&gt;len == 0, G_IO_STATUS_ERROR);</span>
  
    if (!channel-&gt;use_buffer)
      {
        g_warning (&quot;Need to set the channel buffered before setting the encoding.&quot;);
        g_warning (&quot;Assuming this is what you meant and acting accordingly.&quot;);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1334,11 ***</span>
<span class="line-new-header">--- 1335,13 ---</span>
      {
        g_warning (&quot;Partial character at end of write buffer not flushed.&quot;);
        channel-&gt;partial_write_buf[0] = &#39;\0&#39;;
      }
  
<span class="line-added">+ #ifndef G_DISABLE_ASSERT</span>
    did_encode = channel-&gt;do_encode;
<span class="line-added">+ #endif</span>
  
    if (!encoding || strcmp (encoding, &quot;UTF8&quot;) == 0 || strcmp (encoding, &quot;UTF-8&quot;) == 0)
      {
        channel-&gt;do_encode = FALSE;
        read_cd = write_cd = (GIConv) -1;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1518,22 ***</span>
                           channel-&gt;encoded_read_buf-&gt;len + outbytes_left);
        outbuf = channel-&gt;encoded_read_buf-&gt;str + channel-&gt;encoded_read_buf-&gt;len
                 - outbytes_left;
  
        errnum = g_iconv (channel-&gt;read_cd, &amp;inbuf, &amp;inbytes_left,
<span class="line-modified">!             &amp;outbuf, &amp;outbytes_left);</span>
        errval = errno;
  
        g_assert (inbuf + inbytes_left == channel-&gt;read_buf-&gt;str
                  + channel-&gt;read_buf-&gt;len);
        g_assert (outbuf + outbytes_left == channel-&gt;encoded_read_buf-&gt;str
                  + channel-&gt;encoded_read_buf-&gt;len);
  
        g_string_erase (channel-&gt;read_buf, 0,
<span class="line-modified">!               channel-&gt;read_buf-&gt;len - inbytes_left);</span>
        g_string_truncate (channel-&gt;encoded_read_buf,
<span class="line-modified">!              channel-&gt;encoded_read_buf-&gt;len - outbytes_left);</span>
  
        if (errnum == (gsize) -1)
          {
            switch (errval)
              {
<span class="line-new-header">--- 1521,22 ---</span>
                           channel-&gt;encoded_read_buf-&gt;len + outbytes_left);
        outbuf = channel-&gt;encoded_read_buf-&gt;str + channel-&gt;encoded_read_buf-&gt;len
                 - outbytes_left;
  
        errnum = g_iconv (channel-&gt;read_cd, &amp;inbuf, &amp;inbytes_left,
<span class="line-modified">!       &amp;outbuf, &amp;outbytes_left);</span>
        errval = errno;
  
        g_assert (inbuf + inbytes_left == channel-&gt;read_buf-&gt;str
                  + channel-&gt;read_buf-&gt;len);
        g_assert (outbuf + outbytes_left == channel-&gt;encoded_read_buf-&gt;str
                  + channel-&gt;encoded_read_buf-&gt;len);
  
        g_string_erase (channel-&gt;read_buf, 0,
<span class="line-modified">!           channel-&gt;read_buf-&gt;len - inbytes_left);</span>
        g_string_truncate (channel-&gt;encoded_read_buf,
<span class="line-modified">!        channel-&gt;encoded_read_buf-&gt;len - outbytes_left);</span>
  
        if (errnum == (gsize) -1)
          {
            switch (errval)
              {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1642,20 ***</span>
   **/
  GIOStatus
  g_io_channel_read_line (GIOChannel  *channel,
                          gchar      **str_return,
                          gsize       *length,
<span class="line-modified">!             gsize       *terminator_pos,</span>
<span class="line-modified">!                 GError     **error)</span>
  {
    GIOStatus status;
    gsize got_length;
  
    g_return_val_if_fail (channel != NULL, G_IO_STATUS_ERROR);
    g_return_val_if_fail (str_return != NULL, G_IO_STATUS_ERROR);
    g_return_val_if_fail ((error == NULL) || (*error == NULL),
<span class="line-modified">!             G_IO_STATUS_ERROR);</span>
    g_return_val_if_fail (channel-&gt;is_readable, G_IO_STATUS_ERROR);
  
    status = g_io_channel_read_line_backend (channel, &amp;got_length, terminator_pos, error);
  
    if (length &amp;&amp; status != G_IO_STATUS_ERROR)
<span class="line-new-header">--- 1645,20 ---</span>
   **/
  GIOStatus
  g_io_channel_read_line (GIOChannel  *channel,
                          gchar      **str_return,
                          gsize       *length,
<span class="line-modified">!       gsize       *terminator_pos,</span>
<span class="line-modified">!             GError     **error)</span>
  {
    GIOStatus status;
    gsize got_length;
  
    g_return_val_if_fail (channel != NULL, G_IO_STATUS_ERROR);
    g_return_val_if_fail (str_return != NULL, G_IO_STATUS_ERROR);
    g_return_val_if_fail ((error == NULL) || (*error == NULL),
<span class="line-modified">!       G_IO_STATUS_ERROR);</span>
    g_return_val_if_fail (channel-&gt;is_readable, G_IO_STATUS_ERROR);
  
    status = g_io_channel_read_line_backend (channel, &amp;got_length, terminator_pos, error);
  
    if (length &amp;&amp; status != G_IO_STATUS_ERROR)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1688,20 ***</span>
   * Returns: the status of the operation.
   **/
  GIOStatus
  g_io_channel_read_line_string (GIOChannel  *channel,
                                 GString     *buffer,
<span class="line-modified">!                                gsize       *terminator_pos,</span>
<span class="line-modified">!                                GError     **error)</span>
  {
    gsize length;
    GIOStatus status;
  
    g_return_val_if_fail (channel != NULL, G_IO_STATUS_ERROR);
    g_return_val_if_fail (buffer != NULL, G_IO_STATUS_ERROR);
    g_return_val_if_fail ((error == NULL) || (*error == NULL),
<span class="line-modified">!             G_IO_STATUS_ERROR);</span>
    g_return_val_if_fail (channel-&gt;is_readable, G_IO_STATUS_ERROR);
  
    if (buffer-&gt;len &gt; 0)
      g_string_truncate (buffer, 0); /* clear out the buffer */
  
<span class="line-new-header">--- 1691,20 ---</span>
   * Returns: the status of the operation.
   **/
  GIOStatus
  g_io_channel_read_line_string (GIOChannel  *channel,
                                 GString     *buffer,
<span class="line-modified">!              gsize       *terminator_pos,</span>
<span class="line-modified">!                                GError   **error)</span>
  {
    gsize length;
    GIOStatus status;
  
    g_return_val_if_fail (channel != NULL, G_IO_STATUS_ERROR);
    g_return_val_if_fail (buffer != NULL, G_IO_STATUS_ERROR);
    g_return_val_if_fail ((error == NULL) || (*error == NULL),
<span class="line-modified">!       G_IO_STATUS_ERROR);</span>
    g_return_val_if_fail (channel-&gt;is_readable, G_IO_STATUS_ERROR);
  
    if (buffer-&gt;len &gt; 0)
      g_string_truncate (buffer, 0); /* clear out the buffer */
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1867,13 ***</span>
            got_term_len = 0;
            break;
          }
  
        if (use_buf-&gt;len &gt; line_term_len - 1)
<span class="line-modified">!     checked_to = use_buf-&gt;len - (line_term_len - 1);</span>
        else
<span class="line-modified">!     checked_to = 0;</span>
      }
  
  done:
  
    if (terminator_pos)
<span class="line-new-header">--- 1870,13 ---</span>
            got_term_len = 0;
            break;
          }
  
        if (use_buf-&gt;len &gt; line_term_len - 1)
<span class="line-modified">!   checked_to = use_buf-&gt;len - (line_term_len - 1);</span>
        else
<span class="line-modified">!   checked_to = 0;</span>
      }
  
  done:
  
    if (terminator_pos)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1956,13 ***</span>
          *str_return = g_string_free (USE_BUF (channel), FALSE);
        else
          g_string_free (USE_BUF (channel), TRUE);
  
        if (channel-&gt;encoding)
<span class="line-modified">!     channel-&gt;encoded_read_buf = NULL;</span>
        else
<span class="line-modified">!     channel-&gt;read_buf = NULL;</span>
      }
  
    return G_IO_STATUS_NORMAL;
  }
  
<span class="line-new-header">--- 1959,13 ---</span>
          *str_return = g_string_free (USE_BUF (channel), FALSE);
        else
          g_string_free (USE_BUF (channel), TRUE);
  
        if (channel-&gt;encoding)
<span class="line-modified">!   channel-&gt;encoded_read_buf = NULL;</span>
        else
<span class="line-modified">!   channel-&gt;read_buf = NULL;</span>
      }
  
    return G_IO_STATUS_NORMAL;
  }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2098,19 ***</span>
   *
   * Returns: a #GIOStatus
   **/
  GIOStatus
  g_io_channel_read_unichar (GIOChannel  *channel,
<span class="line-modified">!                gunichar    *thechar,</span>
<span class="line-modified">!                GError     **error)</span>
  {
    GIOStatus status = G_IO_STATUS_NORMAL;
  
    g_return_val_if_fail (channel != NULL, G_IO_STATUS_ERROR);
    g_return_val_if_fail (channel-&gt;encoding != NULL, G_IO_STATUS_ERROR);
    g_return_val_if_fail ((error == NULL) || (*error == NULL),
<span class="line-modified">!             G_IO_STATUS_ERROR);</span>
    g_return_val_if_fail (channel-&gt;is_readable, G_IO_STATUS_ERROR);
  
    while (BUF_LEN (channel-&gt;encoded_read_buf) == 0 &amp;&amp; status == G_IO_STATUS_NORMAL)
      status = g_io_channel_fill_buffer (channel, error);
  
<span class="line-new-header">--- 2101,19 ---</span>
   *
   * Returns: a #GIOStatus
   **/
  GIOStatus
  g_io_channel_read_unichar (GIOChannel  *channel,
<span class="line-modified">!          gunichar    *thechar,</span>
<span class="line-modified">!          GError     **error)</span>
  {
    GIOStatus status = G_IO_STATUS_NORMAL;
  
    g_return_val_if_fail (channel != NULL, G_IO_STATUS_ERROR);
    g_return_val_if_fail (channel-&gt;encoding != NULL, G_IO_STATUS_ERROR);
    g_return_val_if_fail ((error == NULL) || (*error == NULL),
<span class="line-modified">!       G_IO_STATUS_ERROR);</span>
    g_return_val_if_fail (channel-&gt;is_readable, G_IO_STATUS_ERROR);
  
    while (BUF_LEN (channel-&gt;encoded_read_buf) == 0 &amp;&amp; status == G_IO_STATUS_NORMAL)
      status = g_io_channel_fill_buffer (channel, error);
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2172,47 ***</span>
   **/
  GIOStatus
  g_io_channel_write_chars (GIOChannel   *channel,
                            const gchar  *buf,
                            gssize        count,
<span class="line-modified">!               gsize        *bytes_written,</span>
                            GError      **error)
  {
    GIOStatus status;
    gssize wrote_bytes = 0;
  
    g_return_val_if_fail (channel != NULL, G_IO_STATUS_ERROR);
    g_return_val_if_fail ((error == NULL) || (*error == NULL),
<span class="line-modified">!             G_IO_STATUS_ERROR);</span>
    g_return_val_if_fail (channel-&gt;is_writeable, G_IO_STATUS_ERROR);
  
    if ((count &lt; 0) &amp;&amp; buf)
      count = strlen (buf);
  
<span class="line-modified">!   if (count == 0)</span>
      {
        if (bytes_written)
          *bytes_written = 0;
        return G_IO_STATUS_NORMAL;
      }
  
    g_return_val_if_fail (buf != NULL, G_IO_STATUS_ERROR);
<span class="line-modified">!   g_return_val_if_fail (count &gt; 0, G_IO_STATUS_ERROR);</span>
  
    /* Raw write case */
  
    if (!channel-&gt;use_buffer)
      {
        gsize tmp_bytes;
  
        g_assert (!channel-&gt;write_buf || channel-&gt;write_buf-&gt;len == 0);
        g_assert (channel-&gt;partial_write_buf[0] == &#39;\0&#39;);
  
<span class="line-modified">!       status = channel-&gt;funcs-&gt;io_write (channel, buf, count, &amp;tmp_bytes, error);</span>
  
        if (bytes_written)
<span class="line-modified">!     *bytes_written = tmp_bytes;</span>
  
        return status;
      }
  
    /* General case */
<span class="line-new-header">--- 2175,50 ---</span>
   **/
  GIOStatus
  g_io_channel_write_chars (GIOChannel   *channel,
                            const gchar  *buf,
                            gssize        count,
<span class="line-modified">!         gsize        *bytes_written,</span>
                            GError      **error)
  {
<span class="line-added">+   gsize count_unsigned;</span>
    GIOStatus status;
    gssize wrote_bytes = 0;
  
    g_return_val_if_fail (channel != NULL, G_IO_STATUS_ERROR);
    g_return_val_if_fail ((error == NULL) || (*error == NULL),
<span class="line-modified">!       G_IO_STATUS_ERROR);</span>
    g_return_val_if_fail (channel-&gt;is_writeable, G_IO_STATUS_ERROR);
  
    if ((count &lt; 0) &amp;&amp; buf)
      count = strlen (buf);
<span class="line-added">+   count_unsigned = count;</span>
  
<span class="line-modified">!   if (count_unsigned == 0)</span>
      {
        if (bytes_written)
          *bytes_written = 0;
        return G_IO_STATUS_NORMAL;
      }
  
    g_return_val_if_fail (buf != NULL, G_IO_STATUS_ERROR);
<span class="line-modified">!   g_return_val_if_fail (count_unsigned &gt; 0, G_IO_STATUS_ERROR);</span>
  
    /* Raw write case */
  
    if (!channel-&gt;use_buffer)
      {
        gsize tmp_bytes;
  
        g_assert (!channel-&gt;write_buf || channel-&gt;write_buf-&gt;len == 0);
        g_assert (channel-&gt;partial_write_buf[0] == &#39;\0&#39;);
  
<span class="line-modified">!       status = channel-&gt;funcs-&gt;io_write (channel, buf, count_unsigned,</span>
<span class="line-added">+                                          &amp;tmp_bytes, error);</span>
  
        if (bytes_written)
<span class="line-modified">!   *bytes_written = tmp_bytes;</span>
  
        return status;
      }
  
    /* General case */
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2281,11 ***</span>
         */
        g_assert (space_in_buf &gt;= MAX_CHAR_SIZE);
  
        if (!channel-&gt;encoding)
          {
<span class="line-modified">!           gssize write_this = MIN (space_in_buf, count - wrote_bytes);</span>
  
            g_string_append_len (channel-&gt;write_buf, buf, write_this);
            buf += write_this;
            wrote_bytes += write_this;
          }
<span class="line-new-header">--- 2287,11 ---</span>
         */
        g_assert (space_in_buf &gt;= MAX_CHAR_SIZE);
  
        if (!channel-&gt;encoding)
          {
<span class="line-modified">!           gssize write_this = MIN (space_in_buf, count_unsigned - wrote_bytes);</span>
  
            g_string_append_len (channel-&gt;write_buf, buf, write_this);
            buf += write_this;
            wrote_bytes += write_this;
          }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2301,19 ***</span>
                g_assert (wrote_bytes == 0);
  
                from_buf = channel-&gt;partial_write_buf;
                from_buf_old_len = strlen (channel-&gt;partial_write_buf);
                g_assert (from_buf_old_len &gt; 0);
<span class="line-modified">!               from_buf_len = MIN (6, from_buf_old_len + count);</span>
  
                memcpy (channel-&gt;partial_write_buf + from_buf_old_len, buf,
                        from_buf_len - from_buf_old_len);
              }
            else
              {
                from_buf = buf;
<span class="line-modified">!               from_buf_len = count - wrote_bytes;</span>
                from_buf_old_len = 0;
              }
  
  reconvert:
  
<span class="line-new-header">--- 2307,19 ---</span>
                g_assert (wrote_bytes == 0);
  
                from_buf = channel-&gt;partial_write_buf;
                from_buf_old_len = strlen (channel-&gt;partial_write_buf);
                g_assert (from_buf_old_len &gt; 0);
<span class="line-modified">!               from_buf_len = MIN (6, from_buf_old_len + count_unsigned);</span>
  
                memcpy (channel-&gt;partial_write_buf + from_buf_old_len, buf,
                        from_buf_len - from_buf_old_len);
              }
            else
              {
                from_buf = buf;
<span class="line-modified">!               from_buf_len = count_unsigned - wrote_bytes;</span>
                from_buf_old_len = 0;
              }
  
  reconvert:
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2322,11 ***</span>
                const gchar *badchar;
                gsize try_len = MIN (from_buf_len, space_in_buf);
  
                /* UTF-8, just validate, emulate g_iconv */
  
<span class="line-modified">!               if (!_g_utf8_validate_len (from_buf, try_len, &amp;badchar))</span>
                  {
                    gunichar try_char;
                    gsize incomplete_len = from_buf + try_len - badchar;
  
                    left_len = from_buf + from_buf_len - badchar;
<span class="line-new-header">--- 2328,11 ---</span>
                const gchar *badchar;
                gsize try_len = MIN (from_buf_len, space_in_buf);
  
                /* UTF-8, just validate, emulate g_iconv */
  
<span class="line-modified">!               if (!g_utf8_validate_len (from_buf, try_len, &amp;badchar))</span>
                  {
                    gunichar try_char;
                    gsize incomplete_len = from_buf + try_len - badchar;
  
                    left_len = from_buf + from_buf_len - badchar;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2388,22 ***</span>
              }
  
            if (err == (gsize) -1)
              {
                switch (errnum)
<span class="line-modified">!             {</span>
                    case EINVAL:
                      g_assert (left_len &lt; 6);
  
                      if (from_buf_old_len == 0)
                        {
                          /* Not from partial_write_buf */
  
                          memcpy (channel-&gt;partial_write_buf, from_buf, left_len);
                          channel-&gt;partial_write_buf[left_len] = &#39;\0&#39;;
                          if (bytes_written)
<span class="line-modified">!                           *bytes_written = count;</span>
                          return G_IO_STATUS_NORMAL;
                        }
  
                      /* Working in partial_write_buf */
  
<span class="line-new-header">--- 2394,22 ---</span>
              }
  
            if (err == (gsize) -1)
              {
                switch (errnum)
<span class="line-modified">!           {</span>
                    case EINVAL:
                      g_assert (left_len &lt; 6);
  
                      if (from_buf_old_len == 0)
                        {
                          /* Not from partial_write_buf */
  
                          memcpy (channel-&gt;partial_write_buf, from_buf, left_len);
                          channel-&gt;partial_write_buf[left_len] = &#39;\0&#39;;
                          if (bytes_written)
<span class="line-modified">!                           *bytes_written = count_unsigned;</span>
                          return G_IO_STATUS_NORMAL;
                        }
  
                      /* Working in partial_write_buf */
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2411,16 ***</span>
                        {
                          /* Didn&#39;t convert anything, must still have
                           * less than a full character
                           */
  
<span class="line-modified">!                         g_assert (count == from_buf_len - from_buf_old_len);</span>
  
                          channel-&gt;partial_write_buf[from_buf_len] = &#39;\0&#39;;
  
                          if (bytes_written)
<span class="line-modified">!                           *bytes_written = count;</span>
  
                          return G_IO_STATUS_NORMAL;
                        }
  
                      g_assert (from_buf_len - left_len &gt;= from_buf_old_len);
<span class="line-new-header">--- 2417,16 ---</span>
                        {
                          /* Didn&#39;t convert anything, must still have
                           * less than a full character
                           */
  
<span class="line-modified">!                         g_assert (count_unsigned == from_buf_len - from_buf_old_len);</span>
  
                          channel-&gt;partial_write_buf[from_buf_len] = &#39;\0&#39;;
  
                          if (bytes_written)
<span class="line-modified">!                           *bytes_written = count_unsigned;</span>
  
                          return G_IO_STATUS_NORMAL;
                        }
  
                      g_assert (from_buf_len - left_len &gt;= from_buf_old_len);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2478,11 ***</span>
              buf = from_buf;
          }
      }
  
    if (bytes_written)
<span class="line-modified">!     *bytes_written = count;</span>
  
    return G_IO_STATUS_NORMAL;
  }
  
  /**
<span class="line-new-header">--- 2484,11 ---</span>
              buf = from_buf;
          }
      }
  
    if (bytes_written)
<span class="line-modified">!     *bytes_written = count_unsigned;</span>
  
    return G_IO_STATUS_NORMAL;
  }
  
  /**
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2497,21 ***</span>
   *
   * Returns: a #GIOStatus
   **/
  GIOStatus
  g_io_channel_write_unichar (GIOChannel  *channel,
<span class="line-modified">!                 gunichar     thechar,</span>
<span class="line-modified">!                 GError     **error)</span>
  {
    GIOStatus status;
    gchar static_buf[6];
    gsize char_len, wrote_len;
  
    g_return_val_if_fail (channel != NULL, G_IO_STATUS_ERROR);
    g_return_val_if_fail (channel-&gt;encoding != NULL, G_IO_STATUS_ERROR);
    g_return_val_if_fail ((error == NULL) || (*error == NULL),
<span class="line-modified">!             G_IO_STATUS_ERROR);</span>
    g_return_val_if_fail (channel-&gt;is_writeable, G_IO_STATUS_ERROR);
  
    char_len = g_unichar_to_utf8 (thechar, static_buf);
  
    if (channel-&gt;partial_write_buf[0] != &#39;\0&#39;)
<span class="line-new-header">--- 2503,21 ---</span>
   *
   * Returns: a #GIOStatus
   **/
  GIOStatus
  g_io_channel_write_unichar (GIOChannel  *channel,
<span class="line-modified">!           gunichar     thechar,</span>
<span class="line-modified">!           GError     **error)</span>
  {
    GIOStatus status;
    gchar static_buf[6];
    gsize char_len, wrote_len;
  
    g_return_val_if_fail (channel != NULL, G_IO_STATUS_ERROR);
    g_return_val_if_fail (channel-&gt;encoding != NULL, G_IO_STATUS_ERROR);
    g_return_val_if_fail ((error == NULL) || (*error == NULL),
<span class="line-modified">!       G_IO_STATUS_ERROR);</span>
    g_return_val_if_fail (channel-&gt;is_writeable, G_IO_STATUS_ERROR);
  
    char_len = g_unichar_to_utf8 (thechar, static_buf);
  
    if (channel-&gt;partial_write_buf[0] != &#39;\0&#39;)
</pre>
<center><a href="ghostutils.c.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="giochannel.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>