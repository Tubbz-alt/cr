<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.media/src/main/native/gstreamer/3rd_party/glib/glib/gutf8.c</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="gurifuncs.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="gutils.c.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.media/src/main/native/gstreamer/3rd_party/glib/glib/gutf8.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -37,65 +37,64 @@</span>
  #include &quot;gstrfuncs.h&quot;
  #include &quot;gtestutils.h&quot;
  #include &quot;gtypes.h&quot;
  #include &quot;gthread.h&quot;
  #include &quot;glibintl.h&quot;
<span class="udiff-line-modified-removed">- #include &quot;gunicodeprivate.h&quot;</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">- #define UTF8_COMPUTE(Char, Mask, Len)                         \</span>
<span class="udiff-line-modified-removed">-   if (Char &lt; 128)                                 \</span>
<span class="udiff-line-modified-removed">-     {                                         \</span>
<span class="udiff-line-modified-removed">-       Len = 1;                                    \</span>
<span class="udiff-line-modified-removed">-       Mask = 0x7f;                                \</span>
<span class="udiff-line-modified-removed">-     }                                         \</span>
<span class="udiff-line-modified-removed">-   else if ((Char &amp; 0xe0) == 0xc0)                         \</span>
<span class="udiff-line-modified-removed">-     {                                         \</span>
<span class="udiff-line-modified-removed">-       Len = 2;                                    \</span>
<span class="udiff-line-modified-removed">-       Mask = 0x1f;                                \</span>
<span class="udiff-line-modified-removed">-     }                                         \</span>
<span class="udiff-line-modified-removed">-   else if ((Char &amp; 0xf0) == 0xe0)                         \</span>
<span class="udiff-line-modified-removed">-     {                                         \</span>
<span class="udiff-line-modified-removed">-       Len = 3;                                    \</span>
<span class="udiff-line-modified-removed">-       Mask = 0x0f;                                \</span>
<span class="udiff-line-modified-removed">-     }                                         \</span>
<span class="udiff-line-modified-removed">-   else if ((Char &amp; 0xf8) == 0xf0)                         \</span>
<span class="udiff-line-modified-removed">-     {                                         \</span>
<span class="udiff-line-modified-removed">-       Len = 4;                                    \</span>
<span class="udiff-line-modified-removed">-       Mask = 0x07;                                \</span>
<span class="udiff-line-modified-removed">-     }                                         \</span>
<span class="udiff-line-modified-removed">-   else if ((Char &amp; 0xfc) == 0xf8)                         \</span>
<span class="udiff-line-modified-removed">-     {                                         \</span>
<span class="udiff-line-modified-removed">-       Len = 5;                                    \</span>
<span class="udiff-line-modified-removed">-       Mask = 0x03;                                \</span>
<span class="udiff-line-modified-removed">-     }                                         \</span>
<span class="udiff-line-modified-removed">-   else if ((Char &amp; 0xfe) == 0xfc)                         \</span>
<span class="udiff-line-modified-removed">-     {                                         \</span>
<span class="udiff-line-modified-removed">-       Len = 6;                                    \</span>
<span class="udiff-line-modified-removed">-       Mask = 0x01;                                \</span>
<span class="udiff-line-modified-removed">-     }                                         \</span>
<span class="udiff-line-removed">-   else                                        \</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+ #define UTF8_COMPUTE(Char, Mask, Len)               \</span>
<span class="udiff-line-modified-added">+   if (Char &lt; 128)                   \</span>
<span class="udiff-line-modified-added">+     {                       \</span>
<span class="udiff-line-modified-added">+       Len = 1;                      \</span>
<span class="udiff-line-modified-added">+       Mask = 0x7f;                    \</span>
<span class="udiff-line-modified-added">+     }                       \</span>
<span class="udiff-line-modified-added">+   else if ((Char &amp; 0xe0) == 0xc0)               \</span>
<span class="udiff-line-modified-added">+     {                       \</span>
<span class="udiff-line-modified-added">+       Len = 2;                      \</span>
<span class="udiff-line-modified-added">+       Mask = 0x1f;                    \</span>
<span class="udiff-line-modified-added">+     }                       \</span>
<span class="udiff-line-modified-added">+   else if ((Char &amp; 0xf0) == 0xe0)               \</span>
<span class="udiff-line-modified-added">+     {                       \</span>
<span class="udiff-line-modified-added">+       Len = 3;                      \</span>
<span class="udiff-line-modified-added">+       Mask = 0x0f;                    \</span>
<span class="udiff-line-modified-added">+     }                       \</span>
<span class="udiff-line-modified-added">+   else if ((Char &amp; 0xf8) == 0xf0)               \</span>
<span class="udiff-line-modified-added">+     {                       \</span>
<span class="udiff-line-modified-added">+       Len = 4;                      \</span>
<span class="udiff-line-modified-added">+       Mask = 0x07;                    \</span>
<span class="udiff-line-modified-added">+     }                       \</span>
<span class="udiff-line-modified-added">+   else if ((Char &amp; 0xfc) == 0xf8)               \</span>
<span class="udiff-line-modified-added">+     {                       \</span>
<span class="udiff-line-modified-added">+       Len = 5;                      \</span>
<span class="udiff-line-modified-added">+       Mask = 0x03;                    \</span>
<span class="udiff-line-modified-added">+     }                       \</span>
<span class="udiff-line-modified-added">+   else if ((Char &amp; 0xfe) == 0xfc)               \</span>
<span class="udiff-line-modified-added">+     {                       \</span>
<span class="udiff-line-modified-added">+       Len = 6;                      \</span>
<span class="udiff-line-modified-added">+       Mask = 0x01;                    \</span>
<span class="udiff-line-modified-added">+     }                       \</span>
<span class="udiff-line-modified-added">+   else                        \</span>
      Len = -1;
  
  #define UTF8_LENGTH(Char)              \
    ((Char) &lt; 0x80 ? 1 :                 \
     ((Char) &lt; 0x800 ? 2 :               \
      ((Char) &lt; 0x10000 ? 3 :            \
       ((Char) &lt; 0x200000 ? 4 :          \
        ((Char) &lt; 0x4000000 ? 5 : 6)))))
  
  
<span class="udiff-line-modified-removed">- #define UTF8_GET(Result, Chars, Count, Mask, Len)                 \</span>
<span class="udiff-line-modified-removed">-   (Result) = (Chars)[0] &amp; (Mask);                         \</span>
<span class="udiff-line-modified-removed">-   for ((Count) = 1; (Count) &lt; (Len); ++(Count))                   \</span>
<span class="udiff-line-modified-removed">-     {                                         \</span>
<span class="udiff-line-modified-removed">-       if (((Chars)[(Count)] &amp; 0xc0) != 0x80)                      \</span>
<span class="udiff-line-modified-removed">-     {                                     \</span>
<span class="udiff-line-modified-removed">-       (Result) = -1;                              \</span>
<span class="udiff-line-modified-removed">-       break;                                  \</span>
<span class="udiff-line-modified-removed">-     }                                     \</span>
<span class="udiff-line-modified-removed">-       (Result) &lt;&lt;= 6;                                 \</span>
<span class="udiff-line-modified-removed">-       (Result) |= ((Chars)[(Count)] &amp; 0x3f);                      \</span>
<span class="udiff-line-modified-added">+ #define UTF8_GET(Result, Chars, Count, Mask, Len)           \</span>
<span class="udiff-line-modified-added">+   (Result) = (Chars)[0] &amp; (Mask);               \</span>
<span class="udiff-line-modified-added">+   for ((Count) = 1; (Count) &lt; (Len); ++(Count))             \</span>
<span class="udiff-line-modified-added">+     {                       \</span>
<span class="udiff-line-modified-added">+       if (((Chars)[(Count)] &amp; 0xc0) != 0x80)              \</span>
<span class="udiff-line-modified-added">+   {                     \</span>
<span class="udiff-line-modified-added">+     (Result) = -1;                  \</span>
<span class="udiff-line-modified-added">+     break;                    \</span>
<span class="udiff-line-modified-added">+   }                     \</span>
<span class="udiff-line-modified-added">+       (Result) &lt;&lt;= 6;                   \</span>
<span class="udiff-line-modified-added">+       (Result) |= ((Chars)[(Count)] &amp; 0x3f);              \</span>
      }
  
  /*
   * Check whether a Unicode (5.2) char is in a valid range.
   *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -135,20 +134,20 @@</span>
   *
   * @p does not have to be at the beginning of a UTF-8 character. No check
   * is made to see if the character found is actually valid other than
   * it starts with an appropriate byte.
   *
<span class="udiff-line-modified-removed">-  * Returns: a pointer to the found character or %NULL.</span>
<span class="udiff-line-modified-added">+  * Returns: (transfer none) (nullable): a pointer to the found character or %NULL.</span>
   */
  gchar *
  g_utf8_find_prev_char (const char *str,
<span class="udiff-line-modified-removed">-                const char *p)</span>
<span class="udiff-line-modified-added">+            const char *p)</span>
  {
    for (--p; p &gt;= str; --p)
      {
        if ((*p &amp; 0xc0) != 0x80)
<span class="udiff-line-modified-removed">-     return (gchar *)p;</span>
<span class="udiff-line-modified-added">+   return (gchar *)p;</span>
      }
    return NULL;
  }
  
  /**
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -166,16 +165,16 @@</span>
   * If @end is %NULL, the return value will never be %NULL: if the end of the
   * string is reached, a pointer to the terminating nul byte is returned. If
   * @end is non-%NULL, the return value will be %NULL if the end of the string
   * is reached.
   *
<span class="udiff-line-modified-removed">-  * Returns: (nullable): a pointer to the found character or %NULL if @end is</span>
<span class="udiff-line-modified-added">+  * Returns: (transfer none) (nullable): a pointer to the found character or %NULL if @end is</span>
   *    set and is reached
   */
  gchar *
  g_utf8_find_next_char (const gchar *p,
<span class="udiff-line-modified-removed">-                const gchar *end)</span>
<span class="udiff-line-modified-added">+            const gchar *end)</span>
  {
    if (end)
      {
        for (++p; p &lt; end &amp;&amp; (*p &amp; 0xc0) == 0x80; ++p)
          ;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -198,20 +197,20 @@</span>
   * @p does not have to be at the beginning of a UTF-8 character. No check
   * is made to see if the character found is actually valid other than
   * it starts with an appropriate byte. If @p might be the first
   * character of the string, you must use g_utf8_find_prev_char() instead.
   *
<span class="udiff-line-modified-removed">-  * Returns: a pointer to the found character</span>
<span class="udiff-line-modified-added">+  * Returns: (transfer none) (not nullable): a pointer to the found character</span>
   */
  gchar *
  g_utf8_prev_char (const gchar *p)
  {
    while (TRUE)
      {
        p--;
        if ((*p &amp; 0xc0) != 0x80)
<span class="udiff-line-modified-removed">-     return (gchar *)p;</span>
<span class="udiff-line-modified-added">+   return (gchar *)p;</span>
      }
  }
  
  /**
   * g_utf8_strlen:
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -274,11 +273,11 @@</span>
   * @end_pos: another character offset within @str
   *
   * Copies a substring out of a UTF-8 encoded string.
   * The substring will contain @end_pos - @start_pos characters.
   *
<span class="udiff-line-modified-removed">-  * Returns: a newly allocated copy of the requested</span>
<span class="udiff-line-modified-added">+  * Returns: (transfer full): a newly allocated copy of the requested</span>
   *     substring. Free with g_free() when no longer needed.
   *
   * Since: 2.30
   */
  gchar *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -343,15 +342,15 @@</span>
   * Therefore you should be sure that @offset is within string boundaries
   * before calling that function. Call g_utf8_strlen() when unsure.
   * This limitation exists as this function is called frequently during
   * text rendering and therefore has to be as fast as possible.
   *
<span class="udiff-line-modified-removed">-  * Returns: the resulting pointer</span>
<span class="udiff-line-modified-added">+  * Returns: (transfer none): the resulting pointer</span>
   */
  gchar *
  g_utf8_offset_to_pointer  (const gchar *str,
<span class="udiff-line-modified-removed">-                glong        offset)</span>
<span class="udiff-line-modified-added">+          glong        offset)</span>
  {
    const gchar *s = str;
  
    if (offset &gt; 0)
      while (offset--)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -363,59 +362,59 @@</span>
        /* This nice technique for fast backwards stepping
         * through a UTF-8 string was dubbed &quot;stutter stepping&quot;
         * by its inventor, Larry Ewing.
         */
        while (offset)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       s1 = s;</span>
<span class="udiff-line-modified-removed">-       s += offset;</span>
<span class="udiff-line-modified-removed">-       while ((*s &amp; 0xc0) == 0x80)</span>
<span class="udiff-line-modified-removed">-         s--;</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     s1 = s;</span>
<span class="udiff-line-modified-added">+     s += offset;</span>
<span class="udiff-line-modified-added">+     while ((*s &amp; 0xc0) == 0x80)</span>
<span class="udiff-line-modified-added">+       s--;</span>
  
<span class="udiff-line-modified-removed">-       offset += g_utf8_pointer_to_offset (s, s1);</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+     offset += g_utf8_pointer_to_offset (s, s1);</span>
<span class="udiff-line-modified-added">+   }</span>
      }
  
    return (gchar *)s;
  }
  
  /**
   * g_utf8_pointer_to_offset:
   * @str: a UTF-8 encoded string
   * @pos: a pointer to a position within @str
   *
<span class="udiff-line-modified-removed">-  * Converts from a pointer to position within a string to a integer</span>
<span class="udiff-line-modified-added">+  * Converts from a pointer to position within a string to an integer</span>
   * character offset.
   *
   * Since 2.10, this function allows @pos to be before @str, and returns
   * a negative offset in this case.
   *
   * Returns: the resulting character offset
   */
  glong
  g_utf8_pointer_to_offset (const gchar *str,
<span class="udiff-line-modified-removed">-               const gchar *pos)</span>
<span class="udiff-line-modified-added">+         const gchar *pos)</span>
  {
    const gchar *s = str;
    glong offset = 0;
  
    if (pos &lt; str)
      offset = - g_utf8_pointer_to_offset (pos, str);
    else
      while (s &lt; pos)
        {
<span class="udiff-line-modified-removed">-     s = g_utf8_next_char (s);</span>
<span class="udiff-line-modified-removed">-     offset++;</span>
<span class="udiff-line-modified-added">+   s = g_utf8_next_char (s);</span>
<span class="udiff-line-modified-added">+   offset++;</span>
        }
  
    return offset;
  }
  
  
  /**
   * g_utf8_strncpy:
<span class="udiff-line-modified-removed">-  * @dest: buffer to fill with characters from @src</span>
<span class="udiff-line-modified-added">+  * @dest: (transfer none): buffer to fill with characters from @src</span>
   * @src: UTF-8 encoded string
   * @n: character count
   *
   * Like the standard C strncpy() function, but copies a given number
   * of characters instead of a given number of bytes. The @src string
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -423,16 +422,16 @@</span>
   * text before trying to use UTF-8 utility functions with it.)
   *
   * Note you must ensure @dest is at least 4 * @n to fit the
   * largest possible UTF-8 characters
   *
<span class="udiff-line-modified-removed">-  * Returns: @dest</span>
<span class="udiff-line-modified-added">+  * Returns: (transfer none): @dest</span>
   */
  gchar *
  g_utf8_strncpy (gchar       *dest,
<span class="udiff-line-modified-removed">-         const gchar *src,</span>
<span class="udiff-line-modified-removed">-         gsize        n)</span>
<span class="udiff-line-modified-added">+     const gchar *src,</span>
<span class="udiff-line-modified-added">+     gsize        n)</span>
  {
    const gchar *s = src;
    while (n &amp;&amp; *s)
      {
        s = g_utf8_next_char(s);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -456,11 +455,11 @@</span>
   *
   * Returns: number of bytes written
   */
  int
  g_unichar_to_utf8 (gunichar c,
<span class="udiff-line-modified-removed">-            gchar   *outbuf)</span>
<span class="udiff-line-modified-added">+        gchar   *outbuf)</span>
  {
    /* If this gets modified, also update the copy in g_string_insert_unichar() */
    guint len = 0;
    int first;
    int i;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -497,14 +496,14 @@</span>
      }
  
    if (outbuf)
      {
        for (i = len - 1; i &gt; 0; --i)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       outbuf[i] = (c &amp; 0x3f) | 0x80;</span>
<span class="udiff-line-modified-removed">-       c &gt;&gt;= 6;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     outbuf[i] = (c &amp; 0x3f) | 0x80;</span>
<span class="udiff-line-modified-added">+     c &gt;&gt;= 6;</span>
<span class="udiff-line-modified-added">+   }</span>
        outbuf[0] = c | first;
      }
  
    return len;
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -517,18 +516,18 @@</span>
   *
   * Finds the leftmost occurrence of the given Unicode character
   * in a UTF-8 encoded string, while limiting the search to @len bytes.
   * If @len is -1, allow unbounded search.
   *
<span class="udiff-line-modified-removed">-  * Returns: %NULL if the string does not contain the character,</span>
<span class="udiff-line-modified-added">+  * Returns: (transfer none) (nullable): %NULL if the string does not contain the character,</span>
   *     otherwise, a pointer to the start of the leftmost occurrence
   *     of the character in the string.
   */
  gchar *
  g_utf8_strchr (const char *p,
<span class="udiff-line-modified-removed">-            gssize      len,</span>
<span class="udiff-line-modified-removed">-            gunichar    c)</span>
<span class="udiff-line-modified-added">+          gssize      len,</span>
<span class="udiff-line-modified-added">+          gunichar    c)</span>
  {
    gchar ch[10];
  
    gint charlen = g_unichar_to_utf8 (c, ch);
    ch[charlen] = &#39;\0&#39;;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -545,18 +544,18 @@</span>
   *
   * Find the rightmost occurrence of the given Unicode character
   * in a UTF-8 encoded string, while limiting the search to @len bytes.
   * If @len is -1, allow unbounded search.
   *
<span class="udiff-line-modified-removed">-  * Returns: %NULL if the string does not contain the character,</span>
<span class="udiff-line-modified-added">+  * Returns: (transfer none) (nullable): %NULL if the string does not contain the character,</span>
   *     otherwise, a pointer to the start of the rightmost occurrence
   *     of the character in the string.
   */
  gchar *
  g_utf8_strrchr (const char *p,
<span class="udiff-line-modified-removed">-         gssize      len,</span>
<span class="udiff-line-modified-removed">-         gunichar    c)</span>
<span class="udiff-line-modified-added">+     gssize      len,</span>
<span class="udiff-line-modified-added">+     gunichar    c)</span>
  {
    gchar ch[10];
  
    gint charlen = g_unichar_to_utf8 (c, ch);
    ch[charlen] = &#39;\0&#39;;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -570,11 +569,11 @@</span>
   * also check for malformed or overlong sequences
   * and return (gunichar)-1 in this case.
   */
  static inline gunichar
  g_utf8_get_char_extended (const  gchar *p,
<span class="udiff-line-modified-removed">-               gssize max_len)</span>
<span class="udiff-line-modified-added">+         gssize max_len)</span>
  {
    guint i, len;
    gunichar min_code;
    gunichar wc = (guchar) *p;
    const gunichar partial_sequence = (gunichar) -2;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -624,28 +623,28 @@</span>
      }
  
    if (G_UNLIKELY (max_len &gt;= 0 &amp;&amp; len &gt; max_len))
      {
        for (i = 1; i &lt; max_len; i++)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       if ((((guchar *)p)[i] &amp; 0xc0) != 0x80)</span>
<span class="udiff-line-modified-removed">-         return malformed_sequence;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     if ((((guchar *)p)[i] &amp; 0xc0) != 0x80)</span>
<span class="udiff-line-modified-added">+       return malformed_sequence;</span>
<span class="udiff-line-modified-added">+   }</span>
        return partial_sequence;
      }
  
    for (i = 1; i &lt; len; ++i)
      {
        gunichar ch = ((guchar *)p)[i];
  
        if (G_UNLIKELY ((ch &amp; 0xc0) != 0x80))
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       if (ch)</span>
<span class="udiff-line-modified-removed">-         return malformed_sequence;</span>
<span class="udiff-line-modified-removed">-       else</span>
<span class="udiff-line-modified-removed">-         return partial_sequence;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     if (ch)</span>
<span class="udiff-line-modified-added">+       return malformed_sequence;</span>
<span class="udiff-line-modified-added">+     else</span>
<span class="udiff-line-modified-added">+       return partial_sequence;</span>
<span class="udiff-line-modified-added">+   }</span>
  
        wc &lt;&lt;= 6;
        wc |= (ch &amp; 0x3f);
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -675,11 +674,11 @@</span>
   *     otherwise, if @p does not point to a valid UTF-8 encoded
   *     Unicode character, returns (gunichar)-1.
   */
  gunichar
  g_utf8_get_char_validated (const gchar *p,
<span class="udiff-line-modified-removed">-                gssize       max_len)</span>
<span class="udiff-line-modified-added">+          gssize       max_len)</span>
  {
    gunichar result;
  
    if (max_len == 0)
      return (gunichar)-2;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -708,17 +707,17 @@</span>
   * representation as UCS-4, assuming valid UTF-8 input.
   * This function is roughly twice as fast as g_utf8_to_ucs4()
   * but does no error checking on the input. A trailing 0 character
   * will be added to the string after the converted text.
   *
<span class="udiff-line-modified-removed">-  * Returns: a pointer to a newly allocated UCS-4 string.</span>
<span class="udiff-line-modified-added">+  * Returns: (transfer full): a pointer to a newly allocated UCS-4 string.</span>
   *     This value must be freed with g_free().
   */
  gunichar *
  g_utf8_to_ucs4_fast (const gchar *str,
<span class="udiff-line-modified-removed">-              glong        len,</span>
<span class="udiff-line-modified-removed">-              glong       *items_written)</span>
<span class="udiff-line-modified-added">+          glong        len,</span>
<span class="udiff-line-modified-added">+          glong       *items_written)</span>
  {
    gunichar *result;
    gint n_chars, i;
    const gchar *p;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -727,22 +726,22 @@</span>
    p = str;
    n_chars = 0;
    if (len &lt; 0)
      {
        while (*p)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       p = g_utf8_next_char (p);</span>
<span class="udiff-line-modified-removed">-       ++n_chars;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     p = g_utf8_next_char (p);</span>
<span class="udiff-line-modified-added">+     ++n_chars;</span>
<span class="udiff-line-modified-added">+   }</span>
      }
    else
      {
        while (p &lt; str + len &amp;&amp; *p)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       p = g_utf8_next_char (p);</span>
<span class="udiff-line-modified-removed">-       ++n_chars;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     p = g_utf8_next_char (p);</span>
<span class="udiff-line-modified-added">+     ++n_chars;</span>
<span class="udiff-line-modified-added">+   }</span>
      }
  
    result = g_new (gunichar, n_chars + 1);
  
    p = str;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -750,19 +749,19 @@</span>
      {
        guchar first = (guchar)*p++;
        gunichar wc;
  
        if (first &lt; 0xc0)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-added">+   {</span>
            /* We really hope first &lt; 0x80, but we don&#39;t want to test an
             * extra branch for invalid input, which this function
             * does not care about. Handling unexpected continuation bytes
             * here will do the least damage. */
<span class="udiff-line-modified-removed">-       wc = first;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+     wc = first;</span>
<span class="udiff-line-modified-added">+   }</span>
        else
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-added">+   {</span>
            gunichar c1 = CONT_BYTE_FAST(p);
            if (first &lt; 0xe0)
              {
                wc = ((first &amp; 0x1f) &lt;&lt; 6) | c1;
              }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -790,11 +789,11 @@</span>
                          }
                        wc &amp;= mask - 1;
                      }
                  }
              }
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   }</span>
        result[i] = wc;
      }
    result[i] = 0;
  
    if (items_written)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -833,20 +832,20 @@</span>
   *
   * Convert a string from UTF-8 to a 32-bit fixed width
   * representation as UCS-4. A trailing 0 character will be added to the
   * string after the converted text.
   *
<span class="udiff-line-modified-removed">-  * Returns: a pointer to a newly allocated UCS-4 string.</span>
<span class="udiff-line-modified-added">+  * Returns: (transfer full): a pointer to a newly allocated UCS-4 string.</span>
   *     This value must be freed with g_free(). If an error occurs,
   *     %NULL will be returned and @error set.
   */
  gunichar *
  g_utf8_to_ucs4 (const gchar *str,
<span class="udiff-line-modified-removed">-         glong        len,</span>
<span class="udiff-line-modified-removed">-         glong       *items_read,</span>
<span class="udiff-line-modified-removed">-         glong       *items_written,</span>
<span class="udiff-line-modified-removed">-         GError     **error)</span>
<span class="udiff-line-modified-added">+     glong        len,</span>
<span class="udiff-line-modified-added">+     glong       *items_read,</span>
<span class="udiff-line-modified-added">+     glong       *items_written,</span>
<span class="udiff-line-modified-added">+     GError     **error)</span>
  {
    gunichar *result = NULL;
    gint n_chars, i;
    const gchar *in;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -854,25 +853,25 @@</span>
    n_chars = 0;
    while ((len &lt; 0 || str + len - in &gt; 0) &amp;&amp; *in)
      {
        gunichar wc = g_utf8_get_char_extended (in, len &lt; 0 ? 6 : str + len - in);
        if (wc &amp; 0x80000000)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       if (wc == (gunichar)-2)</span>
<span class="udiff-line-modified-removed">-         {</span>
<span class="udiff-line-modified-removed">-           if (items_read)</span>
<span class="udiff-line-modified-removed">-         break;</span>
<span class="udiff-line-modified-removed">-           else</span>
<span class="udiff-line-modified-removed">-         g_set_error_literal (error, G_CONVERT_ERROR, G_CONVERT_ERROR_PARTIAL_INPUT,</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     if (wc == (gunichar)-2)</span>
<span class="udiff-line-modified-added">+       {</span>
<span class="udiff-line-modified-added">+         if (items_read)</span>
<span class="udiff-line-modified-added">+     break;</span>
<span class="udiff-line-modified-added">+         else</span>
<span class="udiff-line-modified-added">+     g_set_error_literal (error, G_CONVERT_ERROR, G_CONVERT_ERROR_PARTIAL_INPUT,</span>
                                       _(&quot;Partial character sequence at end of input&quot;));
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-       else</span>
<span class="udiff-line-modified-removed">-         g_set_error_literal (error, G_CONVERT_ERROR, G_CONVERT_ERROR_ILLEGAL_SEQUENCE,</span>
<span class="udiff-line-modified-added">+       }</span>
<span class="udiff-line-modified-added">+     else</span>
<span class="udiff-line-modified-added">+       g_set_error_literal (error, G_CONVERT_ERROR, G_CONVERT_ERROR_ILLEGAL_SEQUENCE,</span>
                                   _(&quot;Invalid byte sequence in conversion input&quot;));
  
<span class="udiff-line-modified-removed">-       goto err_out;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+     goto err_out;</span>
<span class="udiff-line-modified-added">+   }</span>
  
        n_chars++;
  
        in = g_utf8_next_char (in);
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -914,39 +913,39 @@</span>
   *         %G_CONVERT_ERROR_NO_CONVERSION may occur.
   *
   * Convert a string from a 32-bit fixed width representation as UCS-4.
   * to UTF-8. The result will be terminated with a 0 byte.
   *
<span class="udiff-line-modified-removed">-  * Returns: a pointer to a newly allocated UTF-8 string.</span>
<span class="udiff-line-modified-added">+  * Returns: (transfer full): a pointer to a newly allocated UTF-8 string.</span>
   *     This value must be freed with g_free(). If an error occurs,
   *     %NULL will be returned and @error set. In that case, @items_read
   *     will be set to the position of the first invalid input character.
   */
  gchar *
  g_ucs4_to_utf8 (const gunichar *str,
<span class="udiff-line-modified-removed">-         glong           len,</span>
<span class="udiff-line-modified-removed">-         glong          *items_read,</span>
<span class="udiff-line-modified-removed">-         glong          *items_written,</span>
<span class="udiff-line-modified-removed">-         GError        **error)</span>
<span class="udiff-line-modified-added">+     glong           len,</span>
<span class="udiff-line-modified-added">+     glong          *items_read,</span>
<span class="udiff-line-modified-added">+     glong          *items_written,</span>
<span class="udiff-line-modified-added">+     GError        **error)</span>
  {
    gint result_length;
    gchar *result = NULL;
    gchar *p;
    gint i;
  
    result_length = 0;
    for (i = 0; len &lt; 0 || i &lt; len ; i++)
      {
        if (!str[i])
<span class="udiff-line-modified-removed">-     break;</span>
<span class="udiff-line-modified-added">+   break;</span>
  
        if (str[i] &gt;= 0x80000000)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       g_set_error_literal (error, G_CONVERT_ERROR, G_CONVERT_ERROR_ILLEGAL_SEQUENCE,</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     g_set_error_literal (error, G_CONVERT_ERROR, G_CONVERT_ERROR_ILLEGAL_SEQUENCE,</span>
                                 _(&quot;Character out of range for UTF-8&quot;));
<span class="udiff-line-modified-removed">-       goto err_out;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+     goto err_out;</span>
<span class="udiff-line-modified-added">+   }</span>
  
        result_length += UTF8_LENGTH (str[i]);
      }
  
    result = try_malloc_n (result_length + 1, 1, error);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1001,20 +1000,20 @@</span>
   * string; it may e.g. include embedded NUL characters. The only
   * validation done by this function is to ensure that the input can
   * be correctly interpreted as UTF-16, i.e. it doesn&#39;t contain
   * things unpaired surrogates.
   *
<span class="udiff-line-modified-removed">-  * Returns: a pointer to a newly allocated UTF-8 string.</span>
<span class="udiff-line-modified-added">+  * Returns: (transfer full): a pointer to a newly allocated UTF-8 string.</span>
   *     This value must be freed with g_free(). If an error occurs,
   *     %NULL will be returned and @error set.
   **/
  gchar *
  g_utf16_to_utf8 (const gunichar2  *str,
<span class="udiff-line-modified-removed">-          glong             len,</span>
<span class="udiff-line-modified-removed">-          glong            *items_read,</span>
<span class="udiff-line-modified-removed">-          glong            *items_written,</span>
<span class="udiff-line-modified-removed">-          GError          **error)</span>
<span class="udiff-line-modified-added">+      glong             len,</span>
<span class="udiff-line-modified-added">+      glong            *items_read,</span>
<span class="udiff-line-modified-added">+      glong            *items_written,</span>
<span class="udiff-line-modified-added">+      GError          **error)</span>
  {
    /* This function and g_utf16_to_ucs4 are almost exactly identical -
     * The lines that differ are marked.
     */
    const gunichar2 *in;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1032,40 +1031,40 @@</span>
      {
        gunichar2 c = *in;
        gunichar wc;
  
        if (c &gt;= 0xdc00 &amp;&amp; c &lt; 0xe000) /* low surrogate */
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       if (high_surrogate)</span>
<span class="udiff-line-modified-removed">-         {</span>
<span class="udiff-line-modified-removed">-           wc = SURROGATE_VALUE (high_surrogate, c);</span>
<span class="udiff-line-modified-removed">-           high_surrogate = 0;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-       else</span>
<span class="udiff-line-modified-removed">-         {</span>
<span class="udiff-line-modified-removed">-           g_set_error_literal (error, G_CONVERT_ERROR, G_CONVERT_ERROR_ILLEGAL_SEQUENCE,</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     if (high_surrogate)</span>
<span class="udiff-line-modified-added">+       {</span>
<span class="udiff-line-modified-added">+         wc = SURROGATE_VALUE (high_surrogate, c);</span>
<span class="udiff-line-modified-added">+         high_surrogate = 0;</span>
<span class="udiff-line-modified-added">+       }</span>
<span class="udiff-line-modified-added">+     else</span>
<span class="udiff-line-modified-added">+       {</span>
<span class="udiff-line-modified-added">+         g_set_error_literal (error, G_CONVERT_ERROR, G_CONVERT_ERROR_ILLEGAL_SEQUENCE,</span>
                                     _(&quot;Invalid sequence in conversion input&quot;));
<span class="udiff-line-modified-removed">-           goto err_out;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+         goto err_out;</span>
<span class="udiff-line-modified-added">+       }</span>
<span class="udiff-line-modified-added">+   }</span>
        else
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       if (high_surrogate)</span>
<span class="udiff-line-modified-removed">-         {</span>
<span class="udiff-line-modified-removed">-           g_set_error_literal (error, G_CONVERT_ERROR, G_CONVERT_ERROR_ILLEGAL_SEQUENCE,</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     if (high_surrogate)</span>
<span class="udiff-line-modified-added">+       {</span>
<span class="udiff-line-modified-added">+         g_set_error_literal (error, G_CONVERT_ERROR, G_CONVERT_ERROR_ILLEGAL_SEQUENCE,</span>
                                     _(&quot;Invalid sequence in conversion input&quot;));
<span class="udiff-line-modified-removed">-           goto err_out;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-added">+         goto err_out;</span>
<span class="udiff-line-modified-added">+       }</span>
  
<span class="udiff-line-modified-removed">-       if (c &gt;= 0xd800 &amp;&amp; c &lt; 0xdc00) /* high surrogate */</span>
<span class="udiff-line-modified-removed">-         {</span>
<span class="udiff-line-modified-removed">-           high_surrogate = c;</span>
<span class="udiff-line-modified-removed">-           goto next1;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-       else</span>
<span class="udiff-line-modified-removed">-         wc = c;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+     if (c &gt;= 0xd800 &amp;&amp; c &lt; 0xdc00) /* high surrogate */</span>
<span class="udiff-line-modified-added">+       {</span>
<span class="udiff-line-modified-added">+         high_surrogate = c;</span>
<span class="udiff-line-modified-added">+         goto next1;</span>
<span class="udiff-line-modified-added">+       }</span>
<span class="udiff-line-modified-added">+     else</span>
<span class="udiff-line-modified-added">+       wc = c;</span>
<span class="udiff-line-modified-added">+   }</span>
  
        /********** DIFFERENT for UTF8/UCS4 **********/
        n_bytes += UTF8_LENGTH (wc);
  
      next1:
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1093,21 +1092,21 @@</span>
      {
        gunichar2 c = *in;
        gunichar wc;
  
        if (c &gt;= 0xdc00 &amp;&amp; c &lt; 0xe000) /* low surrogate */
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       wc = SURROGATE_VALUE (high_surrogate, c);</span>
<span class="udiff-line-modified-removed">-       high_surrogate = 0;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     wc = SURROGATE_VALUE (high_surrogate, c);</span>
<span class="udiff-line-modified-added">+     high_surrogate = 0;</span>
<span class="udiff-line-modified-added">+   }</span>
        else if (c &gt;= 0xd800 &amp;&amp; c &lt; 0xdc00) /* high surrogate */
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       high_surrogate = c;</span>
<span class="udiff-line-modified-removed">-       goto next2;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     high_surrogate = c;</span>
<span class="udiff-line-modified-added">+     goto next2;</span>
<span class="udiff-line-modified-added">+   }</span>
        else
<span class="udiff-line-modified-removed">-     wc = c;</span>
<span class="udiff-line-modified-added">+   wc = c;</span>
  
        /********** DIFFERENT for UTF8/UCS4 **********/
        out += g_unichar_to_utf8 (wc, out);
  
      next2:
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1145,20 +1144,20 @@</span>
   *     %G_CONVERT_ERROR_NO_CONVERSION may occur.
   *
   * Convert a string from UTF-16 to UCS-4. The result will be
   * nul-terminated.
   *
<span class="udiff-line-modified-removed">-  * Returns: a pointer to a newly allocated UCS-4 string.</span>
<span class="udiff-line-modified-added">+  * Returns: (transfer full): a pointer to a newly allocated UCS-4 string.</span>
   *     This value must be freed with g_free(). If an error occurs,
   *     %NULL will be returned and @error set.
   */
  gunichar *
  g_utf16_to_ucs4 (const gunichar2  *str,
<span class="udiff-line-modified-removed">-          glong             len,</span>
<span class="udiff-line-modified-removed">-          glong            *items_read,</span>
<span class="udiff-line-modified-removed">-          glong            *items_written,</span>
<span class="udiff-line-modified-removed">-          GError          **error)</span>
<span class="udiff-line-modified-added">+      glong             len,</span>
<span class="udiff-line-modified-added">+      glong            *items_read,</span>
<span class="udiff-line-modified-added">+      glong            *items_written,</span>
<span class="udiff-line-modified-added">+      GError          **error)</span>
  {
    const gunichar2 *in;
    gchar *out;
    gchar *result = NULL;
    gint n_bytes;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1172,37 +1171,37 @@</span>
    while ((len &lt; 0 || in - str &lt; len) &amp;&amp; *in)
      {
        gunichar2 c = *in;
  
        if (c &gt;= 0xdc00 &amp;&amp; c &lt; 0xe000) /* low surrogate */
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       if (high_surrogate)</span>
<span class="udiff-line-modified-removed">-         {</span>
<span class="udiff-line-modified-removed">-           high_surrogate = 0;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-       else</span>
<span class="udiff-line-modified-removed">-         {</span>
<span class="udiff-line-modified-removed">-           g_set_error_literal (error, G_CONVERT_ERROR, G_CONVERT_ERROR_ILLEGAL_SEQUENCE,</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     if (high_surrogate)</span>
<span class="udiff-line-modified-added">+       {</span>
<span class="udiff-line-modified-added">+         high_surrogate = 0;</span>
<span class="udiff-line-modified-added">+       }</span>
<span class="udiff-line-modified-added">+     else</span>
<span class="udiff-line-modified-added">+       {</span>
<span class="udiff-line-modified-added">+         g_set_error_literal (error, G_CONVERT_ERROR, G_CONVERT_ERROR_ILLEGAL_SEQUENCE,</span>
                                     _(&quot;Invalid sequence in conversion input&quot;));
<span class="udiff-line-modified-removed">-           goto err_out;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+         goto err_out;</span>
<span class="udiff-line-modified-added">+       }</span>
<span class="udiff-line-modified-added">+   }</span>
        else
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       if (high_surrogate)</span>
<span class="udiff-line-modified-removed">-         {</span>
<span class="udiff-line-modified-removed">-           g_set_error_literal (error, G_CONVERT_ERROR, G_CONVERT_ERROR_ILLEGAL_SEQUENCE,</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     if (high_surrogate)</span>
<span class="udiff-line-modified-added">+       {</span>
<span class="udiff-line-modified-added">+         g_set_error_literal (error, G_CONVERT_ERROR, G_CONVERT_ERROR_ILLEGAL_SEQUENCE,</span>
                                     _(&quot;Invalid sequence in conversion input&quot;));
<span class="udiff-line-modified-removed">-           goto err_out;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-added">+         goto err_out;</span>
<span class="udiff-line-modified-added">+       }</span>
  
<span class="udiff-line-modified-removed">-       if (c &gt;= 0xd800 &amp;&amp; c &lt; 0xdc00) /* high surrogate */</span>
<span class="udiff-line-modified-removed">-         {</span>
<span class="udiff-line-modified-removed">-           high_surrogate = c;</span>
<span class="udiff-line-modified-removed">-           goto next1;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+     if (c &gt;= 0xd800 &amp;&amp; c &lt; 0xdc00) /* high surrogate */</span>
<span class="udiff-line-modified-added">+       {</span>
<span class="udiff-line-modified-added">+         high_surrogate = c;</span>
<span class="udiff-line-modified-added">+         goto next1;</span>
<span class="udiff-line-modified-added">+       }</span>
<span class="udiff-line-modified-added">+   }</span>
  
        /********** DIFFERENT for UTF8/UCS4 **********/
        n_bytes += sizeof (gunichar);
  
      next1:
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1230,21 +1229,21 @@</span>
      {
        gunichar2 c = *in;
        gunichar wc;
  
        if (c &gt;= 0xdc00 &amp;&amp; c &lt; 0xe000) /* low surrogate */
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       wc = SURROGATE_VALUE (high_surrogate, c);</span>
<span class="udiff-line-modified-removed">-       high_surrogate = 0;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     wc = SURROGATE_VALUE (high_surrogate, c);</span>
<span class="udiff-line-modified-added">+     high_surrogate = 0;</span>
<span class="udiff-line-modified-added">+   }</span>
        else if (c &gt;= 0xd800 &amp;&amp; c &lt; 0xdc00) /* high surrogate */
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       high_surrogate = c;</span>
<span class="udiff-line-modified-removed">-       goto next2;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     high_surrogate = c;</span>
<span class="udiff-line-modified-added">+     goto next2;</span>
<span class="udiff-line-modified-added">+   }</span>
        else
<span class="udiff-line-modified-removed">-     wc = c;</span>
<span class="udiff-line-modified-added">+   wc = c;</span>
  
        /********** DIFFERENT for UTF8/UCS4 **********/
        *(gunichar *)out = wc;
        out += sizeof (gunichar);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1283,20 +1282,20 @@</span>
   *     %G_CONVERT_ERROR_NO_CONVERSION may occur.
   *
   * Convert a string from UTF-8 to UTF-16. A 0 character will be
   * added to the result after the converted text.
   *
<span class="udiff-line-modified-removed">-  * Returns: a pointer to a newly allocated UTF-16 string.</span>
<span class="udiff-line-modified-added">+  * Returns: (transfer full): a pointer to a newly allocated UTF-16 string.</span>
   *     This value must be freed with g_free(). If an error occurs,
   *     %NULL will be returned and @error set.
   */
  gunichar2 *
  g_utf8_to_utf16 (const gchar *str,
<span class="udiff-line-modified-removed">-          glong        len,</span>
<span class="udiff-line-modified-removed">-          glong       *items_read,</span>
<span class="udiff-line-modified-removed">-          glong       *items_written,</span>
<span class="udiff-line-modified-removed">-          GError     **error)</span>
<span class="udiff-line-modified-added">+      glong        len,</span>
<span class="udiff-line-modified-added">+      glong       *items_read,</span>
<span class="udiff-line-modified-added">+      glong       *items_written,</span>
<span class="udiff-line-modified-added">+      GError     **error)</span>
  {
    gunichar2 *result = NULL;
    gint n16;
    const gchar *in;
    gint i;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1307,46 +1306,46 @@</span>
    n16 = 0;
    while ((len &lt; 0 || str + len - in &gt; 0) &amp;&amp; *in)
      {
        gunichar wc = g_utf8_get_char_extended (in, len &lt; 0 ? 6 : str + len - in);
        if (wc &amp; 0x80000000)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       if (wc == (gunichar)-2)</span>
<span class="udiff-line-modified-removed">-         {</span>
<span class="udiff-line-modified-removed">-           if (items_read)</span>
<span class="udiff-line-modified-removed">-         break;</span>
<span class="udiff-line-modified-removed">-           else</span>
<span class="udiff-line-modified-removed">-         g_set_error_literal (error, G_CONVERT_ERROR, G_CONVERT_ERROR_PARTIAL_INPUT,</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     if (wc == (gunichar)-2)</span>
<span class="udiff-line-modified-added">+       {</span>
<span class="udiff-line-modified-added">+         if (items_read)</span>
<span class="udiff-line-modified-added">+     break;</span>
<span class="udiff-line-modified-added">+         else</span>
<span class="udiff-line-modified-added">+     g_set_error_literal (error, G_CONVERT_ERROR, G_CONVERT_ERROR_PARTIAL_INPUT,</span>
                                       _(&quot;Partial character sequence at end of input&quot;));
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-       else</span>
<span class="udiff-line-modified-removed">-         g_set_error_literal (error, G_CONVERT_ERROR, G_CONVERT_ERROR_ILLEGAL_SEQUENCE,</span>
<span class="udiff-line-modified-added">+       }</span>
<span class="udiff-line-modified-added">+     else</span>
<span class="udiff-line-modified-added">+       g_set_error_literal (error, G_CONVERT_ERROR, G_CONVERT_ERROR_ILLEGAL_SEQUENCE,</span>
                                   _(&quot;Invalid byte sequence in conversion input&quot;));
  
<span class="udiff-line-modified-removed">-       goto err_out;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+     goto err_out;</span>
<span class="udiff-line-modified-added">+   }</span>
  
        if (wc &lt; 0xd800)
<span class="udiff-line-modified-removed">-     n16 += 1;</span>
<span class="udiff-line-modified-added">+   n16 += 1;</span>
        else if (wc &lt; 0xe000)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       g_set_error_literal (error, G_CONVERT_ERROR, G_CONVERT_ERROR_ILLEGAL_SEQUENCE,</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     g_set_error_literal (error, G_CONVERT_ERROR, G_CONVERT_ERROR_ILLEGAL_SEQUENCE,</span>
                                 _(&quot;Invalid sequence in conversion input&quot;));
  
<span class="udiff-line-modified-removed">-       goto err_out;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+     goto err_out;</span>
<span class="udiff-line-modified-added">+   }</span>
        else if (wc &lt; 0x10000)
<span class="udiff-line-modified-removed">-     n16 += 1;</span>
<span class="udiff-line-modified-added">+   n16 += 1;</span>
        else if (wc &lt; 0x110000)
<span class="udiff-line-modified-removed">-     n16 += 2;</span>
<span class="udiff-line-modified-added">+   n16 += 2;</span>
        else
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       g_set_error_literal (error, G_CONVERT_ERROR, G_CONVERT_ERROR_ILLEGAL_SEQUENCE,</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     g_set_error_literal (error, G_CONVERT_ERROR, G_CONVERT_ERROR_ILLEGAL_SEQUENCE,</span>
                                 _(&quot;Character out of range for UTF-16&quot;));
  
<span class="udiff-line-modified-removed">-       goto err_out;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+     goto err_out;</span>
<span class="udiff-line-modified-added">+   }</span>
  
        in = g_utf8_next_char (in);
      }
  
    result = try_malloc_n (n16 + 1, sizeof (gunichar2), error);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1357,18 +1356,18 @@</span>
    for (i = 0; i &lt; n16;)
      {
        gunichar wc = g_utf8_get_char (in);
  
        if (wc &lt; 0x10000)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       result[i++] = wc;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     result[i++] = wc;</span>
<span class="udiff-line-modified-added">+   }</span>
        else
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       result[i++] = (wc - 0x10000) / 0x400 + 0xd800;</span>
<span class="udiff-line-modified-removed">-       result[i++] = (wc - 0x10000) % 0x400 + 0xdc00;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     result[i++] = (wc - 0x10000) / 0x400 + 0xd800;</span>
<span class="udiff-line-modified-added">+     result[i++] = (wc - 0x10000) % 0x400 + 0xdc00;</span>
<span class="udiff-line-modified-added">+   }</span>
  
        in = g_utf8_next_char (in);
      }
  
    result[i] = 0;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1399,20 +1398,20 @@</span>
   *     %G_CONVERT_ERROR_NO_CONVERSION may occur.
   *
   * Convert a string from UCS-4 to UTF-16. A 0 character will be
   * added to the result after the converted text.
   *
<span class="udiff-line-modified-removed">-  * Returns: a pointer to a newly allocated UTF-16 string.</span>
<span class="udiff-line-modified-added">+  * Returns: (transfer full): a pointer to a newly allocated UTF-16 string.</span>
   *     This value must be freed with g_free(). If an error occurs,
   *     %NULL will be returned and @error set.
   */
  gunichar2 *
  g_ucs4_to_utf16 (const gunichar  *str,
<span class="udiff-line-modified-removed">-          glong            len,</span>
<span class="udiff-line-modified-removed">-          glong           *items_read,</span>
<span class="udiff-line-modified-removed">-          glong           *items_written,</span>
<span class="udiff-line-modified-removed">-          GError         **error)</span>
<span class="udiff-line-modified-added">+      glong            len,</span>
<span class="udiff-line-modified-added">+      glong           *items_read,</span>
<span class="udiff-line-modified-added">+      glong           *items_written,</span>
<span class="udiff-line-modified-added">+      GError         **error)</span>
  {
    gunichar2 *result = NULL;
    gint n16;
    gint i, j;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1421,29 +1420,29 @@</span>
    while ((len &lt; 0 || i &lt; len) &amp;&amp; str[i])
      {
        gunichar wc = str[i];
  
        if (wc &lt; 0xd800)
<span class="udiff-line-modified-removed">-     n16 += 1;</span>
<span class="udiff-line-modified-added">+   n16 += 1;</span>
        else if (wc &lt; 0xe000)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       g_set_error_literal (error, G_CONVERT_ERROR, G_CONVERT_ERROR_ILLEGAL_SEQUENCE,</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     g_set_error_literal (error, G_CONVERT_ERROR, G_CONVERT_ERROR_ILLEGAL_SEQUENCE,</span>
                                 _(&quot;Invalid sequence in conversion input&quot;));
  
<span class="udiff-line-modified-removed">-       goto err_out;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+     goto err_out;</span>
<span class="udiff-line-modified-added">+   }</span>
        else if (wc &lt; 0x10000)
<span class="udiff-line-modified-removed">-     n16 += 1;</span>
<span class="udiff-line-modified-added">+   n16 += 1;</span>
        else if (wc &lt; 0x110000)
<span class="udiff-line-modified-removed">-     n16 += 2;</span>
<span class="udiff-line-modified-added">+   n16 += 2;</span>
        else
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       g_set_error_literal (error, G_CONVERT_ERROR, G_CONVERT_ERROR_ILLEGAL_SEQUENCE,</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     g_set_error_literal (error, G_CONVERT_ERROR, G_CONVERT_ERROR_ILLEGAL_SEQUENCE,</span>
                                 _(&quot;Character out of range for UTF-16&quot;));
  
<span class="udiff-line-modified-removed">-       goto err_out;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+     goto err_out;</span>
<span class="udiff-line-modified-added">+   }</span>
  
        i++;
      }
  
    result = try_malloc_n (n16 + 1, sizeof (gunichar2), error);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1453,18 +1452,18 @@</span>
    for (i = 0, j = 0; j &lt; n16; i++)
      {
        gunichar wc = str[i];
  
        if (wc &lt; 0x10000)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       result[j++] = wc;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     result[j++] = wc;</span>
<span class="udiff-line-modified-added">+   }</span>
        else
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       result[j++] = (wc - 0x10000) / 0x400 + 0xd800;</span>
<span class="udiff-line-modified-removed">-       result[j++] = (wc - 0x10000) % 0x400 + 0xdc00;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     result[j++] = (wc - 0x10000) / 0x400 + 0xd800;</span>
<span class="udiff-line-modified-added">+     result[j++] = (wc - 0x10000) % 0x400 + 0xdc00;</span>
<span class="udiff-line-modified-added">+   }</span>
      }
    result[j] = 0;
  
    if (items_written)
      *items_written = n16;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1491,150 +1490,150 @@</span>
    const gchar *p;
  
    for (p = str; *p; p++)
      {
        if (*(guchar *)p &lt; 128)
<span class="udiff-line-modified-removed">-     /* done */;</span>
<span class="udiff-line-modified-added">+   /* done */;</span>
        else
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       const gchar *last;</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     const gchar *last;</span>
  
<span class="udiff-line-modified-removed">-       last = p;</span>
<span class="udiff-line-modified-removed">-       if (*(guchar *)p &lt; 0xe0) /* 110xxxxx */</span>
<span class="udiff-line-modified-removed">-         {</span>
<span class="udiff-line-modified-removed">-           if (G_UNLIKELY (*(guchar *)p &lt; 0xc2))</span>
<span class="udiff-line-modified-removed">-         goto error;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-       else</span>
<span class="udiff-line-modified-removed">-         {</span>
<span class="udiff-line-modified-removed">-           if (*(guchar *)p &lt; 0xf0) /* 1110xxxx */</span>
<span class="udiff-line-modified-added">+     last = p;</span>
<span class="udiff-line-modified-added">+     if (*(guchar *)p &lt; 0xe0) /* 110xxxxx */</span>
<span class="udiff-line-modified-added">+       {</span>
<span class="udiff-line-modified-added">+         if (G_UNLIKELY (*(guchar *)p &lt; 0xc2))</span>
<span class="udiff-line-modified-added">+     goto error;</span>
<span class="udiff-line-modified-added">+       }</span>
<span class="udiff-line-modified-added">+     else</span>
<span class="udiff-line-modified-added">+       {</span>
<span class="udiff-line-modified-added">+         if (*(guchar *)p &lt; 0xf0) /* 1110xxxx */</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       switch (*(guchar *)p++ &amp; 0x0f)</span>
          {
<span class="udiff-line-modified-removed">-           switch (*(guchar *)p++ &amp; 0x0f)</span>
<span class="udiff-line-modified-removed">-             {</span>
<span class="udiff-line-modified-removed">-             case 0:</span>
<span class="udiff-line-modified-removed">-               VALIDATE_BYTE(0xe0, 0xa0); /* 0xa0 ... 0xbf */</span>
<span class="udiff-line-modified-removed">-               break;</span>
<span class="udiff-line-modified-removed">-             case 0x0d:</span>
<span class="udiff-line-modified-removed">-               VALIDATE_BYTE(0xe0, 0x80); /* 0x80 ... 0x9f */</span>
<span class="udiff-line-modified-removed">-               break;</span>
<span class="udiff-line-removed">-             default:</span>
<span class="udiff-line-removed">-               VALIDATE_BYTE(0xc0, 0x80); /* 10xxxxxx */</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-modified-added">+         case 0:</span>
<span class="udiff-line-modified-added">+           VALIDATE_BYTE(0xe0, 0xa0); /* 0xa0 ... 0xbf */</span>
<span class="udiff-line-modified-added">+           break;</span>
<span class="udiff-line-modified-added">+         case 0x0d:</span>
<span class="udiff-line-modified-added">+           VALIDATE_BYTE(0xe0, 0x80); /* 0x80 ... 0x9f */</span>
<span class="udiff-line-modified-added">+           break;</span>
<span class="udiff-line-modified-added">+         default:</span>
<span class="udiff-line-modified-added">+           VALIDATE_BYTE(0xc0, 0x80); /* 10xxxxxx */</span>
          }
<span class="udiff-line-modified-removed">-           else if (*(guchar *)p &lt; 0xf5) /* 11110xxx excluding out-of-range */</span>
<span class="udiff-line-modified-added">+     }</span>
<span class="udiff-line-added">+         else if (*(guchar *)p &lt; 0xf5) /* 11110xxx excluding out-of-range */</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       switch (*(guchar *)p++ &amp; 0x07)</span>
          {
<span class="udiff-line-modified-removed">-           switch (*(guchar *)p++ &amp; 0x07)</span>
<span class="udiff-line-modified-removed">-             {</span>
<span class="udiff-line-modified-removed">-             case 0:</span>
<span class="udiff-line-modified-removed">-               VALIDATE_BYTE(0xc0, 0x80); /* 10xxxxxx */</span>
<span class="udiff-line-modified-removed">-               if (G_UNLIKELY((*(guchar *)p &amp; 0x30) == 0))</span>
<span class="udiff-line-modified-removed">-             goto error;</span>
<span class="udiff-line-modified-removed">-               break;</span>
<span class="udiff-line-modified-removed">-             case 4:</span>
<span class="udiff-line-modified-removed">-               VALIDATE_BYTE(0xf0, 0x80); /* 0x80 ... 0x8f */</span>
<span class="udiff-line-removed">-               break;</span>
<span class="udiff-line-removed">-             default:</span>
<span class="udiff-line-removed">-               VALIDATE_BYTE(0xc0, 0x80); /* 10xxxxxx */</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-           p++;</span>
<span class="udiff-line-modified-added">+         case 0:</span>
<span class="udiff-line-modified-added">+           VALIDATE_BYTE(0xc0, 0x80); /* 10xxxxxx */</span>
<span class="udiff-line-modified-added">+           if (G_UNLIKELY((*(guchar *)p &amp; 0x30) == 0))</span>
<span class="udiff-line-modified-added">+       goto error;</span>
<span class="udiff-line-modified-added">+           break;</span>
<span class="udiff-line-modified-added">+         case 4:</span>
<span class="udiff-line-modified-added">+           VALIDATE_BYTE(0xf0, 0x80); /* 0x80 ... 0x8f */</span>
<span class="udiff-line-modified-added">+           break;</span>
<span class="udiff-line-modified-added">+         default:</span>
            VALIDATE_BYTE(0xc0, 0x80); /* 10xxxxxx */
          }
<span class="udiff-line-removed">-           else</span>
<span class="udiff-line-removed">-         goto error;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
        p++;
        VALIDATE_BYTE(0xc0, 0x80); /* 10xxxxxx */
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+         else</span>
<span class="udiff-line-added">+     goto error;</span>
<span class="udiff-line-added">+       }</span>
  
<span class="udiff-line-modified-removed">-       continue;</span>
<span class="udiff-line-modified-added">+     p++;</span>
<span class="udiff-line-added">+     VALIDATE_BYTE(0xc0, 0x80); /* 10xxxxxx */</span>
  
<span class="udiff-line-modified-removed">-     error:</span>
<span class="udiff-line-modified-removed">-       return last;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+     continue;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   error:</span>
<span class="udiff-line-added">+     return last;</span>
<span class="udiff-line-added">+   }</span>
      }
  
    return p;
  }
  
  static const gchar *
  fast_validate_len (const char *str,
<span class="udiff-line-modified-removed">-            gssize      max_len)</span>
<span class="udiff-line-modified-added">+        gssize      max_len)</span>
  
  {
    const gchar *p;
  
    g_assert (max_len &gt;= 0);
  
    for (p = str; ((p - str) &lt; max_len) &amp;&amp; *p; p++)
      {
        if (*(guchar *)p &lt; 128)
<span class="udiff-line-modified-removed">-     /* done */;</span>
<span class="udiff-line-modified-added">+   /* done */;</span>
        else
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       const gchar *last;</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     const gchar *last;</span>
  
<span class="udiff-line-modified-removed">-       last = p;</span>
<span class="udiff-line-modified-removed">-       if (*(guchar *)p &lt; 0xe0) /* 110xxxxx */</span>
<span class="udiff-line-modified-removed">-         {</span>
<span class="udiff-line-modified-removed">-           if (G_UNLIKELY (max_len - (p - str) &lt; 2))</span>
<span class="udiff-line-modified-removed">-         goto error;</span>
<span class="udiff-line-modified-added">+     last = p;</span>
<span class="udiff-line-modified-added">+     if (*(guchar *)p &lt; 0xe0) /* 110xxxxx */</span>
<span class="udiff-line-modified-added">+       {</span>
<span class="udiff-line-modified-added">+         if (G_UNLIKELY (max_len - (p - str) &lt; 2))</span>
<span class="udiff-line-modified-added">+     goto error;</span>
  
<span class="udiff-line-modified-removed">-           if (G_UNLIKELY (*(guchar *)p &lt; 0xc2))</span>
<span class="udiff-line-modified-added">+         if (G_UNLIKELY (*(guchar *)p &lt; 0xc2))</span>
<span class="udiff-line-added">+     goto error;</span>
<span class="udiff-line-added">+       }</span>
<span class="udiff-line-added">+     else</span>
<span class="udiff-line-added">+       {</span>
<span class="udiff-line-added">+         if (*(guchar *)p &lt; 0xf0) /* 1110xxxx */</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       if (G_UNLIKELY (max_len - (p - str) &lt; 3))</span>
          goto error;
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-       else</span>
<span class="udiff-line-removed">-         {</span>
<span class="udiff-line-removed">-           if (*(guchar *)p &lt; 0xf0) /* 1110xxxx */</span>
<span class="udiff-line-removed">-         {</span>
<span class="udiff-line-removed">-           if (G_UNLIKELY (max_len - (p - str) &lt; 3))</span>
<span class="udiff-line-removed">-             goto error;</span>
  
<span class="udiff-line-modified-removed">-           switch (*(guchar *)p++ &amp; 0x0f)</span>
<span class="udiff-line-removed">-             {</span>
<span class="udiff-line-removed">-             case 0:</span>
<span class="udiff-line-removed">-               VALIDATE_BYTE(0xe0, 0xa0); /* 0xa0 ... 0xbf */</span>
<span class="udiff-line-removed">-               break;</span>
<span class="udiff-line-removed">-             case 0x0d:</span>
<span class="udiff-line-removed">-               VALIDATE_BYTE(0xe0, 0x80); /* 0x80 ... 0x9f */</span>
<span class="udiff-line-removed">-               break;</span>
<span class="udiff-line-removed">-             default:</span>
<span class="udiff-line-removed">-               VALIDATE_BYTE(0xc0, 0x80); /* 10xxxxxx */</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-           else if (*(guchar *)p &lt; 0xf5) /* 11110xxx excluding out-of-range */</span>
<span class="udiff-line-modified-added">+       switch (*(guchar *)p++ &amp; 0x0f)</span>
          {
<span class="udiff-line-modified-removed">-           if (G_UNLIKELY (max_len - (p - str) &lt; 4))</span>
<span class="udiff-line-modified-removed">-             goto error;</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-           switch (*(guchar *)p++ &amp; 0x07)</span>
<span class="udiff-line-modified-removed">-             {</span>
<span class="udiff-line-modified-removed">-             case 0:</span>
<span class="udiff-line-modified-removed">-               VALIDATE_BYTE(0xc0, 0x80); /* 10xxxxxx */</span>
<span class="udiff-line-removed">-               if (G_UNLIKELY((*(guchar *)p &amp; 0x30) == 0))</span>
<span class="udiff-line-removed">-             goto error;</span>
<span class="udiff-line-removed">-               break;</span>
<span class="udiff-line-removed">-             case 4:</span>
<span class="udiff-line-removed">-               VALIDATE_BYTE(0xf0, 0x80); /* 0x80 ... 0x8f */</span>
<span class="udiff-line-removed">-               break;</span>
<span class="udiff-line-removed">-             default:</span>
<span class="udiff-line-removed">-               VALIDATE_BYTE(0xc0, 0x80); /* 10xxxxxx */</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-           p++;</span>
<span class="udiff-line-modified-added">+         case 0:</span>
<span class="udiff-line-modified-added">+           VALIDATE_BYTE(0xe0, 0xa0); /* 0xa0 ... 0xbf */</span>
<span class="udiff-line-modified-added">+           break;</span>
<span class="udiff-line-modified-added">+         case 0x0d:</span>
<span class="udiff-line-modified-added">+           VALIDATE_BYTE(0xe0, 0x80); /* 0x80 ... 0x9f */</span>
<span class="udiff-line-modified-added">+           break;</span>
<span class="udiff-line-modified-added">+         default:</span>
            VALIDATE_BYTE(0xc0, 0x80); /* 10xxxxxx */
          }
<span class="udiff-line-modified-removed">-           else</span>
<span class="udiff-line-modified-added">+     }</span>
<span class="udiff-line-added">+         else if (*(guchar *)p &lt; 0xf5) /* 11110xxx excluding out-of-range */</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       if (G_UNLIKELY (max_len - (p - str) &lt; 4))</span>
          goto error;
<span class="udiff-line-removed">-         }</span>
  
<span class="udiff-line-added">+       switch (*(guchar *)p++ &amp; 0x07)</span>
<span class="udiff-line-added">+         {</span>
<span class="udiff-line-added">+         case 0:</span>
<span class="udiff-line-added">+           VALIDATE_BYTE(0xc0, 0x80); /* 10xxxxxx */</span>
<span class="udiff-line-added">+           if (G_UNLIKELY((*(guchar *)p &amp; 0x30) == 0))</span>
<span class="udiff-line-added">+       goto error;</span>
<span class="udiff-line-added">+           break;</span>
<span class="udiff-line-added">+         case 4:</span>
<span class="udiff-line-added">+           VALIDATE_BYTE(0xf0, 0x80); /* 0x80 ... 0x8f */</span>
<span class="udiff-line-added">+           break;</span>
<span class="udiff-line-added">+         default:</span>
<span class="udiff-line-added">+           VALIDATE_BYTE(0xc0, 0x80); /* 10xxxxxx */</span>
<span class="udiff-line-added">+         }</span>
        p++;
        VALIDATE_BYTE(0xc0, 0x80); /* 10xxxxxx */
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+         else</span>
<span class="udiff-line-added">+     goto error;</span>
<span class="udiff-line-added">+       }</span>
  
<span class="udiff-line-modified-removed">-       continue;</span>
<span class="udiff-line-modified-added">+     p++;</span>
<span class="udiff-line-added">+     VALIDATE_BYTE(0xc0, 0x80); /* 10xxxxxx */</span>
  
<span class="udiff-line-modified-removed">-     error:</span>
<span class="udiff-line-modified-removed">-       return last;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+     continue;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   error:</span>
<span class="udiff-line-added">+     return last;</span>
<span class="udiff-line-added">+   }</span>
      }
  
    return p;
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1662,53 +1661,53 @@</span>
   *
   * Returns: %TRUE if the text was valid UTF-8
   */
  gboolean
  g_utf8_validate (const char   *str,
<span class="udiff-line-modified-removed">-          gssize        max_len,</span>
<span class="udiff-line-modified-removed">-          const gchar **end)</span>
<span class="udiff-line-modified-added">+      gssize        max_len,</span>
<span class="udiff-line-modified-added">+      const gchar **end)</span>
  
  {
    const gchar *p;
  
    if (max_len &gt;= 0)
<span class="udiff-line-modified-removed">-     return _g_utf8_validate_len (str, max_len, end);</span>
<span class="udiff-line-modified-added">+     return g_utf8_validate_len (str, max_len, end);</span>
  
<span class="udiff-line-modified-removed">-     p = fast_validate (str);</span>
<span class="udiff-line-modified-added">+   p = fast_validate (str);</span>
  
    if (end)
      *end = p;
  
    if (*p != &#39;\0&#39;)
      return FALSE;
    else
      return TRUE;
  }
  
<span class="udiff-line-modified-removed">- /*</span>
<span class="udiff-line-modified-removed">-  * _g_utf8_validate_len:</span>
<span class="udiff-line-modified-added">+ /**</span>
<span class="udiff-line-modified-added">+  * g_utf8_validate_len:</span>
   * @str: (array length=max_len) (element-type guint8): a pointer to character data
   * @max_len: max bytes to validate
   * @end: (out) (optional) (transfer none): return location for end of valid data
   *
   * Validates UTF-8 encoded text.
   *
   * As with g_utf8_validate(), but @max_len must be set, and hence this function
   * will always return %FALSE if any of the bytes of @str are nul.
   *
   * Returns: %TRUE if the text was valid UTF-8
<span class="udiff-line-modified-removed">-  * Since: 2.60 (backported to 2.58)</span>
<span class="udiff-line-modified-added">+  * Since: 2.60</span>
   */
  gboolean
<span class="udiff-line-modified-removed">- _g_utf8_validate_len (const char   *str,</span>
<span class="udiff-line-modified-removed">-                       gsize         max_len,</span>
<span class="udiff-line-modified-removed">-                       const gchar **end)</span>
<span class="udiff-line-modified-added">+ g_utf8_validate_len (const char   *str,</span>
<span class="udiff-line-modified-added">+                      gsize         max_len,</span>
<span class="udiff-line-modified-added">+                      const gchar **end)</span>
  
  {
    const gchar *p;
  
<span class="udiff-line-modified-removed">-     p = fast_validate_len (str, max_len);</span>
<span class="udiff-line-modified-added">+   p = fast_validate_len (str, max_len);</span>
  
    if (end)
      *end = p;
  
    if (p != str + max_len)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1751,17 +1750,17 @@</span>
   *
   * Note that unlike g_strreverse(), this function returns
   * newly-allocated memory, which should be freed with g_free() when
   * no longer needed.
   *
<span class="udiff-line-modified-removed">-  * Returns: a newly-allocated string which is the reverse of @str</span>
<span class="udiff-line-modified-added">+  * Returns: (transfer full): a newly-allocated string which is the reverse of @str</span>
   *
   * Since: 2.2
   */
  gchar *
  g_utf8_strreverse (const gchar *str,
<span class="udiff-line-modified-removed">-            gssize       len)</span>
<span class="udiff-line-modified-added">+        gssize       len)</span>
  {
    gchar *r, *result;
    const gchar *p;
  
    if (len &lt; 0)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1772,10 +1771,11 @@</span>
    p = str;
    while (r &gt; result)
      {
        gchar *m, skip = g_utf8_skip[*(guchar*) p];
        r -= skip;
<span class="udiff-line-added">+       g_assert (r &gt;= result);</span>
        for (m = r; skip; skip--)
          *m++ = *p++;
      }
    result[len] = 0;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1820,15 +1820,15 @@</span>
    remaining_bytes = len;
  
    while (remaining_bytes != 0)
      {
        if (g_utf8_validate (remainder, remaining_bytes, &amp;invalid))
<span class="udiff-line-modified-removed">-     break;</span>
<span class="udiff-line-modified-added">+   break;</span>
        valid_bytes = invalid - remainder;
  
        if (string == NULL)
<span class="udiff-line-modified-removed">-     string = g_string_sized_new (remaining_bytes);</span>
<span class="udiff-line-modified-added">+   string = g_string_sized_new (remaining_bytes);</span>
  
        g_string_append_len (string, remainder, valid_bytes);
        /* append U+FFFD REPLACEMENT CHARACTER */
        g_string_append (string, &quot;\357\277\275&quot;);
  
</pre>
<center><a href="gurifuncs.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="gutils.c.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>