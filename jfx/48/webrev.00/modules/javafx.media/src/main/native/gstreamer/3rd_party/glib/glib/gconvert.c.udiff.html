<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.media/src/main/native/gstreamer/3rd_party/glib/glib/gconvert.c</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="gconstructor.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="gconvert.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.media/src/main/native/gstreamer/3rd_party/glib/glib/gconvert.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -44,23 +44,16 @@</span>
  #include &quot;gcharsetprivate.h&quot;
  #include &quot;gslist.h&quot;
  #include &quot;gstrfuncs.h&quot;
  #include &quot;gtestutils.h&quot;
  #include &quot;gthread.h&quot;
<span class="udiff-line-added">+ #include &quot;gthreadprivate.h&quot;</span>
  #include &quot;gunicode.h&quot;
  #include &quot;gfileutils.h&quot;
  
  #include &quot;glibintl.h&quot;
  
<span class="udiff-line-removed">- #if defined(USE_LIBICONV_GNU) &amp;&amp; !defined (_LIBICONV_H)</span>
<span class="udiff-line-removed">- #error GNU libiconv in use but included iconv.h not from libiconv</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- #if !defined(USE_LIBICONV_GNU) &amp;&amp; defined (_LIBICONV_H) \</span>
<span class="udiff-line-removed">-      &amp;&amp; !defined (__APPLE_CC__) &amp;&amp; !defined (__LP_64__)</span>
<span class="udiff-line-removed">- #error GNU libiconv not in use but included iconv.h is from libiconv</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- </span>
  
  /**
   * SECTION:conversions
   * @title: Character Set Conversion
   * @short_description: convert strings between different character sets
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -167,12 +160,12 @@</span>
  
  G_DEFINE_QUARK (g_convert_error, g_convert_error)
  
  static gboolean
  try_conversion (const char *to_codeset,
<span class="udiff-line-modified-removed">-         const char *from_codeset,</span>
<span class="udiff-line-modified-removed">-         iconv_t    *cd)</span>
<span class="udiff-line-modified-added">+     const char *from_codeset,</span>
<span class="udiff-line-modified-added">+     iconv_t    *cd)</span>
  {
    *cd = iconv_open (to_codeset, from_codeset);
  
    if (*cd == (iconv_t)-1 &amp;&amp; errno == EINVAL)
      return FALSE;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -180,23 +173,23 @@</span>
      return TRUE;
  }
  
  static gboolean
  try_to_aliases (const char **to_aliases,
<span class="udiff-line-modified-removed">-         const char  *from_codeset,</span>
<span class="udiff-line-modified-removed">-         iconv_t     *cd)</span>
<span class="udiff-line-modified-added">+     const char  *from_codeset,</span>
<span class="udiff-line-modified-added">+     iconv_t     *cd)</span>
  {
    if (to_aliases)
      {
        const char **p = to_aliases;
        while (*p)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       if (try_conversion (*p, from_codeset, cd))</span>
<span class="udiff-line-modified-removed">-         return TRUE;</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     if (try_conversion (*p, from_codeset, cd))</span>
<span class="udiff-line-modified-added">+       return TRUE;</span>
  
<span class="udiff-line-modified-removed">-       p++;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+     p++;</span>
<span class="udiff-line-modified-added">+   }</span>
      }
  
    return FALSE;
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -215,36 +208,36 @@</span>
   * Returns: a &quot;conversion descriptor&quot;, or (GIConv)-1 if
   *  opening the converter failed.
   **/
  GIConv
  g_iconv_open (const gchar  *to_codeset,
<span class="udiff-line-modified-removed">-           const gchar  *from_codeset)</span>
<span class="udiff-line-modified-added">+         const gchar  *from_codeset)</span>
  {
    iconv_t cd;
  
    if (!try_conversion (to_codeset, from_codeset, &amp;cd))
      {
        const char **to_aliases = _g_charset_get_aliases (to_codeset);
        const char **from_aliases = _g_charset_get_aliases (from_codeset);
  
        if (from_aliases)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       const char **p = from_aliases;</span>
<span class="udiff-line-modified-removed">-       while (*p)</span>
<span class="udiff-line-modified-removed">-         {</span>
<span class="udiff-line-modified-removed">-           if (try_conversion (to_codeset, *p, &amp;cd))</span>
<span class="udiff-line-modified-removed">-         goto out;</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     const char **p = from_aliases;</span>
<span class="udiff-line-modified-added">+     while (*p)</span>
<span class="udiff-line-modified-added">+       {</span>
<span class="udiff-line-modified-added">+         if (try_conversion (to_codeset, *p, &amp;cd))</span>
<span class="udiff-line-modified-added">+     goto out;</span>
  
<span class="udiff-line-modified-removed">-           if (try_to_aliases (to_aliases, *p, &amp;cd))</span>
<span class="udiff-line-modified-removed">-         goto out;</span>
<span class="udiff-line-modified-added">+         if (try_to_aliases (to_aliases, *p, &amp;cd))</span>
<span class="udiff-line-modified-added">+     goto out;</span>
  
<span class="udiff-line-modified-removed">-           p++;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+         p++;</span>
<span class="udiff-line-modified-added">+       }</span>
<span class="udiff-line-modified-added">+   }</span>
  
        if (try_to_aliases (to_aliases, from_codeset, &amp;cd))
<span class="udiff-line-modified-removed">-     goto out;</span>
<span class="udiff-line-modified-added">+   goto out;</span>
      }
  
   out:
    return (cd == (iconv_t)-1) ? (GIConv)-1 : (GIConv)cd;
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -273,14 +266,14 @@</span>
   *
   * Returns: count of non-reversible conversions, or -1 on error
   **/
  gsize
  g_iconv (GIConv   converter,
<span class="udiff-line-modified-removed">-      gchar  **inbuf,</span>
<span class="udiff-line-modified-removed">-      gsize   *inbytes_left,</span>
<span class="udiff-line-modified-removed">-      gchar  **outbuf,</span>
<span class="udiff-line-modified-removed">-      gsize   *outbytes_left)</span>
<span class="udiff-line-modified-added">+    gchar  **inbuf,</span>
<span class="udiff-line-modified-added">+    gsize   *inbytes_left,</span>
<span class="udiff-line-modified-added">+    gchar  **outbuf,</span>
<span class="udiff-line-modified-added">+    gsize   *outbytes_left)</span>
  {
    iconv_t cd = (iconv_t)converter;
  
    return iconv (cd, inbuf, inbytes_left, outbuf, outbytes_left);
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -308,31 +301,31 @@</span>
    return iconv_close (cd);
  }
  
  static GIConv
  open_converter (const gchar *to_codeset,
<span class="udiff-line-modified-removed">-         const gchar *from_codeset,</span>
<span class="udiff-line-modified-removed">-         GError     **error)</span>
<span class="udiff-line-modified-added">+     const gchar *from_codeset,</span>
<span class="udiff-line-modified-added">+     GError     **error)</span>
  {
    GIConv cd;
  
    cd = g_iconv_open (to_codeset, from_codeset);
  
    if (cd == (GIConv) -1)
      {
        /* Something went wrong.  */
        if (error)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       if (errno == EINVAL)</span>
<span class="udiff-line-modified-removed">-         g_set_error (error, G_CONVERT_ERROR, G_CONVERT_ERROR_NO_CONVERSION,</span>
<span class="udiff-line-modified-removed">-              _(&quot;Conversion from character set &#39;%s&#39; to &#39;%s&#39; is not supported&quot;),</span>
<span class="udiff-line-modified-removed">-              from_codeset, to_codeset);</span>
<span class="udiff-line-modified-removed">-       else</span>
<span class="udiff-line-modified-removed">-         g_set_error (error, G_CONVERT_ERROR, G_CONVERT_ERROR_FAILED,</span>
<span class="udiff-line-modified-removed">-              _(&quot;Could not open converter from &#39;%s&#39; to &#39;%s&#39;&quot;),</span>
<span class="udiff-line-modified-removed">-              from_codeset, to_codeset);</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     if (errno == EINVAL)</span>
<span class="udiff-line-modified-added">+       g_set_error (error, G_CONVERT_ERROR, G_CONVERT_ERROR_NO_CONVERSION,</span>
<span class="udiff-line-modified-added">+        _(&quot;Conversion from character set &#39;%s&#39; to &#39;%s&#39; is not supported&quot;),</span>
<span class="udiff-line-modified-added">+        from_codeset, to_codeset);</span>
<span class="udiff-line-modified-added">+     else</span>
<span class="udiff-line-modified-added">+       g_set_error (error, G_CONVERT_ERROR, G_CONVERT_ERROR_FAILED,</span>
<span class="udiff-line-modified-added">+        _(&quot;Could not open converter from &#39;%s&#39; to &#39;%s&#39;&quot;),</span>
<span class="udiff-line-modified-added">+        from_codeset, to_codeset);</span>
<span class="udiff-line-modified-added">+   }</span>
      }
  
    return cd;
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -392,15 +385,15 @@</span>
   *               containing the converted string, which must be freed with
   *               g_free(). Otherwise %NULL and @error will be set.
   **/
  gchar*
  g_convert_with_iconv (const gchar *str,
<span class="udiff-line-modified-removed">-               gssize       len,</span>
<span class="udiff-line-modified-removed">-               GIConv       converter,</span>
<span class="udiff-line-modified-removed">-               gsize       *bytes_read,</span>
<span class="udiff-line-modified-removed">-               gsize       *bytes_written,</span>
<span class="udiff-line-modified-removed">-               GError     **error)</span>
<span class="udiff-line-modified-added">+           gssize       len,</span>
<span class="udiff-line-modified-added">+           GIConv       converter,</span>
<span class="udiff-line-modified-added">+           gsize       *bytes_read,</span>
<span class="udiff-line-modified-added">+           gsize       *bytes_written,</span>
<span class="udiff-line-modified-added">+           GError     **error)</span>
  {
    gchar *dest;
    gchar *outp;
    const gchar *p;
    gsize inbytes_remaining;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -429,84 +422,84 @@</span>
          err = g_iconv (converter, NULL, &amp;inbytes_remaining, &amp;outp, &amp;outbytes_remaining);
        else
          err = g_iconv (converter, (char **)&amp;p, &amp;inbytes_remaining, &amp;outp, &amp;outbytes_remaining);
  
        if (err == (gsize) -1)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       switch (errno)</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     switch (errno)</span>
<span class="udiff-line-added">+       {</span>
<span class="udiff-line-added">+       case EINVAL:</span>
<span class="udiff-line-added">+         /* Incomplete text, do not report an error */</span>
<span class="udiff-line-added">+         done = TRUE;</span>
<span class="udiff-line-added">+         break;</span>
<span class="udiff-line-added">+       case E2BIG:</span>
          {
<span class="udiff-line-modified-removed">-         case EINVAL:</span>
<span class="udiff-line-modified-removed">-           /* Incomplete text, do not report an error */</span>
<span class="udiff-line-modified-removed">-           done = TRUE;</span>
<span class="udiff-line-modified-removed">-           break;</span>
<span class="udiff-line-modified-removed">-         case E2BIG:</span>
<span class="udiff-line-modified-removed">-           {</span>
<span class="udiff-line-modified-removed">-         gsize used = outp - dest;</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-         outbuf_size *= 2;</span>
<span class="udiff-line-modified-removed">-         dest = g_realloc (dest, outbuf_size);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         outp = dest + used;</span>
<span class="udiff-line-removed">-         outbytes_remaining = outbuf_size - used - NUL_TERMINATOR_LENGTH;</span>
<span class="udiff-line-removed">-           }</span>
<span class="udiff-line-removed">-           break;</span>
<span class="udiff-line-removed">-         case EILSEQ:</span>
<span class="udiff-line-modified-added">+     gsize used = outp - dest;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     outbuf_size *= 2;</span>
<span class="udiff-line-modified-added">+     dest = g_realloc (dest, outbuf_size);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     outp = dest + used;</span>
<span class="udiff-line-modified-added">+     outbytes_remaining = outbuf_size - used - NUL_TERMINATOR_LENGTH;</span>
<span class="udiff-line-modified-added">+         }</span>
<span class="udiff-line-modified-added">+         break;</span>
<span class="udiff-line-modified-added">+       case EILSEQ:</span>
                g_set_error_literal (error, G_CONVERT_ERROR, G_CONVERT_ERROR_ILLEGAL_SEQUENCE,
                                     _(&quot;Invalid byte sequence in conversion input&quot;));
<span class="udiff-line-modified-removed">-           have_error = TRUE;</span>
<span class="udiff-line-modified-removed">-           break;</span>
<span class="udiff-line-modified-removed">-         default:</span>
<span class="udiff-line-modified-added">+         have_error = TRUE;</span>
<span class="udiff-line-modified-added">+         break;</span>
<span class="udiff-line-modified-added">+       default:</span>
                {
                  int errsv = errno;
  
                  g_set_error (error, G_CONVERT_ERROR, G_CONVERT_ERROR_FAILED,
                               _(&quot;Error during conversion: %s&quot;),
                               g_strerror (errsv));
                }
<span class="udiff-line-modified-removed">-           have_error = TRUE;</span>
<span class="udiff-line-modified-removed">-           break;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+         have_error = TRUE;</span>
<span class="udiff-line-modified-added">+         break;</span>
<span class="udiff-line-modified-added">+       }</span>
<span class="udiff-line-modified-added">+   }</span>
        else if (err &gt; 0)
          {
            /* @err gives the number of replacement characters used. */
            g_set_error_literal (error, G_CONVERT_ERROR, G_CONVERT_ERROR_ILLEGAL_SEQUENCE,
                                 _(&quot;Unrepresentable character in conversion input&quot;));
            have_error = TRUE;
          }
        else
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       if (!reset)</span>
<span class="udiff-line-modified-removed">-         {</span>
<span class="udiff-line-modified-removed">-           /* call g_iconv with NULL inbuf to cleanup shift state */</span>
<span class="udiff-line-modified-removed">-           reset = TRUE;</span>
<span class="udiff-line-modified-removed">-           inbytes_remaining = 0;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-       else</span>
<span class="udiff-line-modified-removed">-         done = TRUE;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     if (!reset)</span>
<span class="udiff-line-modified-added">+       {</span>
<span class="udiff-line-modified-added">+         /* call g_iconv with NULL inbuf to cleanup shift state */</span>
<span class="udiff-line-modified-added">+         reset = TRUE;</span>
<span class="udiff-line-modified-added">+         inbytes_remaining = 0;</span>
<span class="udiff-line-modified-added">+       }</span>
<span class="udiff-line-modified-added">+     else</span>
<span class="udiff-line-modified-added">+       done = TRUE;</span>
<span class="udiff-line-modified-added">+   }</span>
      }
  
    memset (outp, 0, NUL_TERMINATOR_LENGTH);
  
    if (bytes_read)
      *bytes_read = p - str;
    else
      {
        if ((p - str) != len)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-added">+   {</span>
            if (!have_error)
              {
                g_set_error_literal (error, G_CONVERT_ERROR, G_CONVERT_ERROR_PARTIAL_INPUT,
                                     _(&quot;Partial character sequence at end of input&quot;));
                have_error = TRUE;
              }
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   }</span>
      }
  
    if (bytes_written)
<span class="udiff-line-modified-removed">-     *bytes_written = outp - dest;   /* Doesn&#39;t include &#39;\0&#39; */</span>
<span class="udiff-line-modified-added">+     *bytes_written = outp - dest; /* Doesn&#39;t include &#39;\0&#39; */</span>
  
    if (have_error)
      {
        g_free (dest);
        return NULL;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -562,12 +555,12 @@</span>
  g_convert (const gchar *str,
             gssize       len,
             const gchar *to_codeset,
             const gchar *from_codeset,
             gsize       *bytes_read,
<span class="udiff-line-modified-removed">-        gsize       *bytes_written,</span>
<span class="udiff-line-modified-removed">-        GError     **error)</span>
<span class="udiff-line-modified-added">+      gsize       *bytes_written,</span>
<span class="udiff-line-modified-added">+      GError     **error)</span>
  {
    gchar *res;
    GIConv cd;
  
    g_return_val_if_fail (str != NULL, NULL);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -586,12 +579,12 @@</span>
  
        return NULL;
      }
  
    res = g_convert_with_iconv (str, len, cd,
<span class="udiff-line-modified-removed">-                   bytes_read, bytes_written,</span>
<span class="udiff-line-modified-removed">-                   error);</span>
<span class="udiff-line-modified-added">+             bytes_read, bytes_written,</span>
<span class="udiff-line-modified-added">+             error);</span>
  
    close_converter (cd);
  
    return res;
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -644,17 +637,17 @@</span>
   *          containing the converted string, which must be freed with g_free().
   *          Otherwise %NULL and @error will be set.
   **/
  gchar*
  g_convert_with_fallback (const gchar *str,
<span class="udiff-line-modified-removed">-              gssize       len,</span>
<span class="udiff-line-modified-removed">-              const gchar *to_codeset,</span>
<span class="udiff-line-modified-removed">-              const gchar *from_codeset,</span>
<span class="udiff-line-modified-removed">-              const gchar *fallback,</span>
<span class="udiff-line-modified-removed">-              gsize       *bytes_read,</span>
<span class="udiff-line-modified-removed">-              gsize       *bytes_written,</span>
<span class="udiff-line-modified-removed">-              GError     **error)</span>
<span class="udiff-line-modified-added">+        gssize       len,</span>
<span class="udiff-line-modified-added">+        const gchar *to_codeset,</span>
<span class="udiff-line-modified-added">+        const gchar *from_codeset,</span>
<span class="udiff-line-modified-added">+        const gchar *fallback,</span>
<span class="udiff-line-modified-added">+        gsize       *bytes_read,</span>
<span class="udiff-line-modified-added">+        gsize       *bytes_written,</span>
<span class="udiff-line-modified-added">+        GError     **error)</span>
  {
    gchar *utf8;
    gchar *dest;
    gchar *outp;
    const gchar *insert_str = NULL;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -680,11 +673,11 @@</span>
  
    /* Try an exact conversion; we only proceed if this fails
     * due to an illegal sequence in the input string.
     */
    dest = g_convert (str, len, to_codeset, from_codeset,
<span class="udiff-line-modified-removed">-             bytes_read, bytes_written, &amp;local_error);</span>
<span class="udiff-line-modified-added">+         bytes_read, bytes_written, &amp;local_error);</span>
    if (!local_error)
      return dest;
  
    if (!g_error_matches (local_error, G_CONVERT_ERROR, G_CONVERT_ERROR_ILLEGAL_SEQUENCE))
      {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -710,11 +703,11 @@</span>
  
        return NULL;
      }
  
    utf8 = g_convert (str, len, &quot;UTF-8&quot;, from_codeset,
<span class="udiff-line-modified-removed">-             bytes_read, &amp;inbytes_remaining, error);</span>
<span class="udiff-line-modified-added">+         bytes_read, &amp;inbytes_remaining, error);</span>
    if (!utf8)
      {
        close_converter (cd);
        if (bytes_written)
          *bytes_written = 0;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -740,106 +733,107 @@</span>
        gsize inbytes_tmp = inbytes_remaining;
        err = g_iconv (cd, (char **)&amp;p, &amp;inbytes_tmp, &amp;outp, &amp;outbytes_remaining);
        inbytes_remaining = inbytes_tmp;
  
        if (err == (gsize) -1)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       switch (errno)</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     switch (errno)</span>
<span class="udiff-line-added">+       {</span>
<span class="udiff-line-added">+       case EINVAL:</span>
<span class="udiff-line-added">+         g_assert_not_reached();</span>
<span class="udiff-line-added">+         break;</span>
<span class="udiff-line-added">+       case E2BIG:</span>
          {
<span class="udiff-line-modified-removed">-         case EINVAL:</span>
<span class="udiff-line-removed">-           g_assert_not_reached();</span>
<span class="udiff-line-removed">-           break;</span>
<span class="udiff-line-removed">-         case E2BIG:</span>
<span class="udiff-line-removed">-           {</span>
<span class="udiff-line-removed">-         gsize used = outp - dest;</span>
<span class="udiff-line-modified-added">+     gsize used = outp - dest;</span>
  
<span class="udiff-line-modified-removed">-         outbuf_size *= 2;</span>
<span class="udiff-line-modified-removed">-         dest = g_realloc (dest, outbuf_size);</span>
<span class="udiff-line-modified-added">+     outbuf_size *= 2;</span>
<span class="udiff-line-modified-added">+     dest = g_realloc (dest, outbuf_size);</span>
  
<span class="udiff-line-modified-removed">-         outp = dest + used;</span>
<span class="udiff-line-modified-removed">-         outbytes_remaining = outbuf_size - used - NUL_TERMINATOR_LENGTH;</span>
<span class="udiff-line-modified-added">+     outp = dest + used;</span>
<span class="udiff-line-modified-added">+     outbytes_remaining = outbuf_size - used - NUL_TERMINATOR_LENGTH;</span>
  
<span class="udiff-line-modified-removed">-         break;</span>
<span class="udiff-line-removed">-           }</span>
<span class="udiff-line-removed">-         case EILSEQ:</span>
<span class="udiff-line-removed">-           if (save_p)</span>
<span class="udiff-line-removed">-         {</span>
<span class="udiff-line-removed">-           /* Error converting fallback string - fatal</span>
<span class="udiff-line-removed">-            */</span>
<span class="udiff-line-removed">-           g_set_error (error, G_CONVERT_ERROR, G_CONVERT_ERROR_ILLEGAL_SEQUENCE,</span>
<span class="udiff-line-removed">-                    _(&quot;Cannot convert fallback &#39;%s&#39; to codeset &#39;%s&#39;&quot;),</span>
<span class="udiff-line-removed">-                    insert_str, to_codeset);</span>
<span class="udiff-line-removed">-           have_error = TRUE;</span>
<span class="udiff-line-removed">-           break;</span>
<span class="udiff-line-modified-added">+     break;</span>
          }
<span class="udiff-line-modified-removed">-           else if (p)</span>
<span class="udiff-line-modified-added">+       case EILSEQ:</span>
<span class="udiff-line-added">+         if (save_p)</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       /* Error converting fallback string - fatal</span>
<span class="udiff-line-added">+        */</span>
<span class="udiff-line-added">+       g_set_error (error, G_CONVERT_ERROR, G_CONVERT_ERROR_ILLEGAL_SEQUENCE,</span>
<span class="udiff-line-added">+              _(&quot;Cannot convert fallback &#39;%s&#39; to codeset &#39;%s&#39;&quot;),</span>
<span class="udiff-line-added">+              insert_str, to_codeset);</span>
<span class="udiff-line-added">+       have_error = TRUE;</span>
<span class="udiff-line-added">+       break;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+         else if (p)</span>
<span class="udiff-line-added">+     {</span>
<span class="udiff-line-added">+       if (!fallback)</span>
          {
<span class="udiff-line-modified-removed">-           if (!fallback)</span>
<span class="udiff-line-modified-removed">-             {</span>
<span class="udiff-line-modified-removed">-               gunichar ch = g_utf8_get_char (p);</span>
<span class="udiff-line-removed">-               insert_str = g_strdup_printf (ch &lt; 0x10000 ? &quot;\\u%04x&quot; : &quot;\\U%08x&quot;,</span>
<span class="udiff-line-removed">-                             ch);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-           else</span>
<span class="udiff-line-removed">-             insert_str = fallback;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-           save_p = g_utf8_next_char (p);</span>
<span class="udiff-line-removed">-           save_inbytes = inbytes_remaining - (save_p - p);</span>
<span class="udiff-line-removed">-           p = insert_str;</span>
<span class="udiff-line-removed">-           inbytes_remaining = strlen (p);</span>
<span class="udiff-line-removed">-           break;</span>
<span class="udiff-line-modified-added">+           gunichar ch = g_utf8_get_char (p);</span>
<span class="udiff-line-modified-added">+           insert_str = g_strdup_printf (ch &lt; 0x10000 ? &quot;\\u%04x&quot; : &quot;\\U%08x&quot;,</span>
<span class="udiff-line-modified-added">+                 ch);</span>
          }
<span class="udiff-line-modified-removed">-           /* fall thru if p is NULL */</span>
<span class="udiff-line-modified-removed">-         default:</span>
<span class="udiff-line-modified-added">+       else</span>
<span class="udiff-line-modified-added">+         insert_str = fallback;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+       save_p = g_utf8_next_char (p);</span>
<span class="udiff-line-added">+       save_inbytes = inbytes_remaining - (save_p - p);</span>
<span class="udiff-line-added">+       p = insert_str;</span>
<span class="udiff-line-added">+       inbytes_remaining = strlen (p);</span>
<span class="udiff-line-added">+       break;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+               /* if p is null */</span>
<span class="udiff-line-added">+               G_GNUC_FALLTHROUGH;</span>
<span class="udiff-line-added">+       default:</span>
                {
                  int errsv = errno;
  
                  g_set_error (error, G_CONVERT_ERROR, G_CONVERT_ERROR_FAILED,
                               _(&quot;Error during conversion: %s&quot;),
                               g_strerror (errsv));
                }
  
<span class="udiff-line-modified-removed">-           have_error = TRUE;</span>
<span class="udiff-line-modified-removed">-           break;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-removed">-       else</span>
<span class="udiff-line-removed">-     {</span>
<span class="udiff-line-removed">-       if (save_p)</span>
<span class="udiff-line-removed">-         {</span>
<span class="udiff-line-removed">-           if (!fallback)</span>
<span class="udiff-line-removed">-         g_free ((gchar *)insert_str);</span>
<span class="udiff-line-removed">-           p = save_p;</span>
<span class="udiff-line-removed">-           inbytes_remaining = save_inbytes;</span>
<span class="udiff-line-removed">-           save_p = NULL;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-       else if (p)</span>
<span class="udiff-line-removed">-         {</span>
<span class="udiff-line-removed">-           /* call g_iconv with NULL inbuf to cleanup shift state */</span>
<span class="udiff-line-removed">-           p = NULL;</span>
<span class="udiff-line-removed">-           inbytes_remaining = 0;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+         have_error = TRUE;</span>
<span class="udiff-line-modified-added">+         break;</span>
<span class="udiff-line-modified-added">+       }</span>
<span class="udiff-line-modified-added">+   }</span>
        else
<span class="udiff-line-modified-removed">-         done = TRUE;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     if (save_p)</span>
<span class="udiff-line-added">+       {</span>
<span class="udiff-line-added">+         if (!fallback)</span>
<span class="udiff-line-added">+     g_free ((gchar *)insert_str);</span>
<span class="udiff-line-added">+         p = save_p;</span>
<span class="udiff-line-added">+         inbytes_remaining = save_inbytes;</span>
<span class="udiff-line-added">+         save_p = NULL;</span>
<span class="udiff-line-added">+       }</span>
<span class="udiff-line-added">+     else if (p)</span>
<span class="udiff-line-added">+       {</span>
<span class="udiff-line-added">+         /* call g_iconv with NULL inbuf to cleanup shift state */</span>
<span class="udiff-line-added">+         p = NULL;</span>
<span class="udiff-line-added">+         inbytes_remaining = 0;</span>
<span class="udiff-line-added">+       }</span>
<span class="udiff-line-added">+     else</span>
<span class="udiff-line-added">+       done = TRUE;</span>
<span class="udiff-line-added">+   }</span>
      }
  
    /* Cleanup
     */
    memset (outp, 0, NUL_TERMINATOR_LENGTH);
  
    close_converter (cd);
  
    if (bytes_written)
<span class="udiff-line-modified-removed">-     *bytes_written = outp - dest;   /* Doesn&#39;t include &#39;\0&#39; */</span>
<span class="udiff-line-modified-added">+     *bytes_written = outp - dest; /* Doesn&#39;t include &#39;\0&#39; */</span>
  
    g_free (utf8);
  
    if (have_error)
      {
        if (save_p &amp;&amp; !fallback)
<span class="udiff-line-modified-removed">-     g_free ((gchar *)insert_str);</span>
<span class="udiff-line-modified-added">+   g_free ((gchar *)insert_str);</span>
        g_free (dest);
        return NULL;
      }
    else
      return dest;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -862,24 +856,24 @@</span>
   * On error, @bytes_read will be set to the byte offset after the last valid
   * and non-nul UTF-8 sequence in @string, and @bytes_written will be set to 0.
   */
  static gchar *
  strdup_len (const gchar *string,
<span class="udiff-line-modified-removed">-         gssize       len,</span>
<span class="udiff-line-modified-removed">-         gsize       *bytes_read,</span>
<span class="udiff-line-modified-removed">-         gsize       *bytes_written,</span>
<span class="udiff-line-modified-removed">-         GError     **error)</span>
<span class="udiff-line-modified-added">+       gssize       len,</span>
<span class="udiff-line-modified-added">+       gsize       *bytes_read,</span>
<span class="udiff-line-modified-added">+       gsize       *bytes_written,</span>
<span class="udiff-line-modified-added">+       GError     **error)</span>
  {
    gsize real_len;
    const gchar *end_valid;
  
    if (!g_utf8_validate (string, len, &amp;end_valid))
      {
        if (bytes_read)
<span class="udiff-line-modified-removed">-     *bytes_read = end_valid - string;</span>
<span class="udiff-line-modified-added">+   *bytes_read = end_valid - string;</span>
        if (bytes_written)
<span class="udiff-line-modified-removed">-     *bytes_written = 0;</span>
<span class="udiff-line-modified-added">+   *bytes_written = 0;</span>
  
        g_set_error_literal (error, G_CONVERT_ERROR, G_CONVERT_ERROR_ILLEGAL_SEQUENCE,
                             _(&quot;Invalid byte sequence in conversion input&quot;));
        return NULL;
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1003,14 +997,14 @@</span>
   *
   * Returns: (type utf8): The converted string, or %NULL on an error.
   **/
  gchar *
  g_locale_to_utf8 (const gchar  *opsysstring,
<span class="udiff-line-modified-removed">-           gssize        len,</span>
<span class="udiff-line-modified-removed">-           gsize        *bytes_read,</span>
<span class="udiff-line-modified-removed">-           gsize        *bytes_written,</span>
<span class="udiff-line-modified-removed">-           GError      **error)</span>
<span class="udiff-line-modified-added">+       gssize        len,</span>
<span class="udiff-line-modified-added">+       gsize        *bytes_read,</span>
<span class="udiff-line-modified-added">+       gsize        *bytes_written,</span>
<span class="udiff-line-modified-added">+       GError      **error)</span>
  {
    const char *charset;
  
    if (g_get_charset (&amp;charset))
      return strdup_len (opsysstring, len, bytes_read, bytes_written, error);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1052,14 +1046,14 @@</span>
   *          A newly-allocated buffer containing the converted string,
   *          or %NULL on an error, and error will be set.
   **/
  gchar *
  g_locale_from_utf8 (const gchar *utf8string,
<span class="udiff-line-modified-removed">-             gssize       len,</span>
<span class="udiff-line-modified-removed">-             gsize       *bytes_read,</span>
<span class="udiff-line-modified-removed">-             gsize       *bytes_written,</span>
<span class="udiff-line-modified-removed">-             GError     **error)</span>
<span class="udiff-line-modified-added">+         gssize       len,</span>
<span class="udiff-line-modified-added">+         gsize       *bytes_read,</span>
<span class="udiff-line-modified-added">+         gsize       *bytes_written,</span>
<span class="udiff-line-modified-added">+         GError     **error)</span>
  {
    const gchar *charset;
  
    if (g_get_charset (&amp;charset))
      return strdup_len (utf8string, len, bytes_read, bytes_written, error);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1128,14 +1122,11 @@</span>
    static GPrivate cache_private = G_PRIVATE_INIT (filename_charset_cache_free);
    GFilenameCharsetCache *cache = g_private_get (&amp;cache_private);
    const gchar *charset;
  
    if (!cache)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-removed">-       cache = g_new0 (GFilenameCharsetCache, 1);</span>
<span class="udiff-line-removed">-       g_private_set (&amp;cache_private, cache);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+     cache = g_private_set_alloc0 (&amp;cache_private, sizeof (GFilenameCharsetCache));</span>
  
    g_get_charset (&amp;charset);
  
    if (!(cache-&gt;charset &amp;&amp; strcmp (cache-&gt;charset, charset) == 0))
      {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1147,38 +1138,38 @@</span>
        g_strfreev (cache-&gt;filename_charsets);
        cache-&gt;charset = g_strdup (charset);
  
        p = getenv (&quot;G_FILENAME_ENCODING&quot;);
        if (p != NULL &amp;&amp; p[0] != &#39;\0&#39;)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       cache-&gt;filename_charsets = g_strsplit (p, &quot;,&quot;, 0);</span>
<span class="udiff-line-modified-removed">-       cache-&gt;is_utf8 = (strcmp (cache-&gt;filename_charsets[0], &quot;UTF-8&quot;) == 0);</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     cache-&gt;filename_charsets = g_strsplit (p, &quot;,&quot;, 0);</span>
<span class="udiff-line-modified-added">+     cache-&gt;is_utf8 = (strcmp (cache-&gt;filename_charsets[0], &quot;UTF-8&quot;) == 0);</span>
  
<span class="udiff-line-modified-removed">-       for (i = 0; cache-&gt;filename_charsets[i]; i++)</span>
<span class="udiff-line-modified-removed">-         {</span>
<span class="udiff-line-modified-removed">-           if (strcmp (&quot;@locale&quot;, cache-&gt;filename_charsets[i]) == 0)</span>
<span class="udiff-line-removed">-         {</span>
<span class="udiff-line-removed">-           g_get_charset (&amp;new_charset);</span>
<span class="udiff-line-removed">-           g_free (cache-&gt;filename_charsets[i]);</span>
<span class="udiff-line-removed">-           cache-&gt;filename_charsets[i] = g_strdup (new_charset);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-       else if (getenv (&quot;G_BROKEN_FILENAMES&quot;) != NULL)</span>
<span class="udiff-line-modified-added">+     for (i = 0; cache-&gt;filename_charsets[i]; i++)</span>
<span class="udiff-line-modified-added">+       {</span>
<span class="udiff-line-modified-added">+         if (strcmp (&quot;@locale&quot;, cache-&gt;filename_charsets[i]) == 0)</span>
      {
<span class="udiff-line-modified-removed">-       cache-&gt;filename_charsets = g_new0 (gchar *, 2);</span>
<span class="udiff-line-modified-removed">-       cache-&gt;is_utf8 = g_get_charset (&amp;new_charset);</span>
<span class="udiff-line-modified-removed">-       cache-&gt;filename_charsets[0] = g_strdup (new_charset);</span>
<span class="udiff-line-modified-added">+       g_get_charset (&amp;new_charset);</span>
<span class="udiff-line-modified-added">+       g_free (cache-&gt;filename_charsets[i]);</span>
<span class="udiff-line-modified-added">+       cache-&gt;filename_charsets[i] = g_strdup (new_charset);</span>
      }
<span class="udiff-line-added">+       }</span>
<span class="udiff-line-added">+   }</span>
<span class="udiff-line-added">+       else if (getenv (&quot;G_BROKEN_FILENAMES&quot;) != NULL)</span>
<span class="udiff-line-added">+   {</span>
<span class="udiff-line-added">+     cache-&gt;filename_charsets = g_new0 (gchar *, 2);</span>
<span class="udiff-line-added">+     cache-&gt;is_utf8 = g_get_charset (&amp;new_charset);</span>
<span class="udiff-line-added">+     cache-&gt;filename_charsets[0] = g_strdup (new_charset);</span>
<span class="udiff-line-added">+   }</span>
        else
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       cache-&gt;filename_charsets = g_new0 (gchar *, 3);</span>
<span class="udiff-line-modified-removed">-       cache-&gt;is_utf8 = TRUE;</span>
<span class="udiff-line-modified-removed">-       cache-&gt;filename_charsets[0] = g_strdup (&quot;UTF-8&quot;);</span>
<span class="udiff-line-modified-removed">-       if (!g_get_charset (&amp;new_charset))</span>
<span class="udiff-line-modified-removed">-         cache-&gt;filename_charsets[1] = g_strdup (new_charset);</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     cache-&gt;filename_charsets = g_new0 (gchar *, 3);</span>
<span class="udiff-line-modified-added">+     cache-&gt;is_utf8 = TRUE;</span>
<span class="udiff-line-modified-added">+     cache-&gt;filename_charsets[0] = g_strdup (&quot;UTF-8&quot;);</span>
<span class="udiff-line-modified-added">+     if (!g_get_charset (&amp;new_charset))</span>
<span class="udiff-line-modified-added">+       cache-&gt;filename_charsets[1] = g_strdup (new_charset);</span>
<span class="udiff-line-modified-added">+   }</span>
      }
  
    if (filename_charsets)
      *filename_charsets = (const gchar **)cache-&gt;filename_charsets;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1265,14 +1256,14 @@</span>
   *
   * Returns: (type utf8): The converted string, or %NULL on an error.
   **/
  gchar*
  g_filename_to_utf8 (const gchar *opsysstring,
<span class="udiff-line-modified-removed">-             gssize       len,</span>
<span class="udiff-line-modified-removed">-             gsize       *bytes_read,</span>
<span class="udiff-line-modified-removed">-             gsize       *bytes_written,</span>
<span class="udiff-line-modified-removed">-             GError     **error)</span>
<span class="udiff-line-modified-added">+         gssize       len,</span>
<span class="udiff-line-modified-added">+         gsize       *bytes_read,</span>
<span class="udiff-line-modified-added">+         gsize       *bytes_written,</span>
<span class="udiff-line-modified-added">+         GError     **error)</span>
  {
    const gchar *charset;
  
    g_return_val_if_fail (opsysstring != NULL, NULL);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1317,14 +1308,14 @@</span>
   * Returns: (type filename):
   *               The converted string, or %NULL on an error.
   **/
  gchar*
  g_filename_from_utf8 (const gchar *utf8string,
<span class="udiff-line-modified-removed">-               gssize       len,</span>
<span class="udiff-line-modified-removed">-               gsize       *bytes_read,</span>
<span class="udiff-line-modified-removed">-               gsize       *bytes_written,</span>
<span class="udiff-line-modified-removed">-               GError     **error)</span>
<span class="udiff-line-modified-added">+           gssize       len,</span>
<span class="udiff-line-modified-added">+           gsize       *bytes_read,</span>
<span class="udiff-line-modified-added">+           gsize       *bytes_written,</span>
<span class="udiff-line-modified-added">+           GError     **error)</span>
  {
    const gchar *charset;
  
    if (get_filename_charset (&amp;charset))
      return strdup_len (utf8string, len, bytes_read, bytes_written, error);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1346,11 +1337,11 @@</span>
    /* Eat one character at a time. */
    h = haystack;
    n = needle;
  
    while (*n &amp;&amp; *h &amp;&amp;
<span class="udiff-line-modified-removed">-      g_ascii_tolower (*n) == g_ascii_tolower (*h))</span>
<span class="udiff-line-modified-added">+    g_ascii_tolower (*n) == g_ascii_tolower (*h))</span>
      {
        n++;
        h++;
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1385,11 +1376,11 @@</span>
  
  /* Note: This escape function works on file: URIs, but if you want to
   * escape something else, please read RFC-2396 */
  static gchar *
  g_escape_uri_string (const gchar *string,
<span class="udiff-line-modified-removed">-              UnsafeCharacterSet mask)</span>
<span class="udiff-line-modified-added">+          UnsafeCharacterSet mask)</span>
  {
  #define ACCEPTABLE(a) ((a)&gt;=32 &amp;&amp; (a)&lt;128 &amp;&amp; (acceptable[(a)-32] &amp; use_mask))
  
    const gchar *p;
    gchar *q;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1397,50 +1388,50 @@</span>
    int c;
    gint unacceptable;
    UnsafeCharacterSet use_mask;
  
    g_return_val_if_fail (mask == UNSAFE_ALL
<span class="udiff-line-modified-removed">-             || mask == UNSAFE_ALLOW_PLUS</span>
<span class="udiff-line-modified-removed">-             || mask == UNSAFE_PATH</span>
<span class="udiff-line-modified-removed">-             || mask == UNSAFE_HOST</span>
<span class="udiff-line-modified-removed">-             || mask == UNSAFE_SLASHES, NULL);</span>
<span class="udiff-line-modified-added">+       || mask == UNSAFE_ALLOW_PLUS</span>
<span class="udiff-line-modified-added">+       || mask == UNSAFE_PATH</span>
<span class="udiff-line-modified-added">+       || mask == UNSAFE_HOST</span>
<span class="udiff-line-modified-added">+       || mask == UNSAFE_SLASHES, NULL);</span>
  
    unacceptable = 0;
    use_mask = mask;
    for (p = string; *p != &#39;\0&#39;; p++)
      {
        c = (guchar) *p;
        if (!ACCEPTABLE (c))
<span class="udiff-line-modified-removed">-     unacceptable++;</span>
<span class="udiff-line-modified-added">+   unacceptable++;</span>
      }
  
    result = g_malloc (p - string + unacceptable * 2 + 1);
  
    use_mask = mask;
    for (q = result, p = string; *p != &#39;\0&#39;; p++)
      {
        c = (guchar) *p;
  
        if (!ACCEPTABLE (c))
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       *q++ = &#39;%&#39;; /* means hex coming */</span>
<span class="udiff-line-modified-removed">-       *q++ = hex[c &gt;&gt; 4];</span>
<span class="udiff-line-modified-removed">-       *q++ = hex[c &amp; 15];</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     *q++ = &#39;%&#39;; /* means hex coming */</span>
<span class="udiff-line-modified-added">+     *q++ = hex[c &gt;&gt; 4];</span>
<span class="udiff-line-modified-added">+     *q++ = hex[c &amp; 15];</span>
<span class="udiff-line-modified-added">+   }</span>
        else
<span class="udiff-line-modified-removed">-     *q++ = *p;</span>
<span class="udiff-line-modified-added">+   *q++ = *p;</span>
      }
  
    *q = &#39;\0&#39;;
  
    return result;
  }
  
  
  static gchar *
  g_escape_file_uri (const gchar *hostname,
<span class="udiff-line-modified-removed">-            const gchar *pathname)</span>
<span class="udiff-line-modified-added">+        const gchar *pathname)</span>
  {
    char *escaped_hostname = NULL;
    char *escaped_path;
    char *res;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1467,14 +1458,14 @@</span>
      }
  
    escaped_path = g_escape_uri_string (pathname, UNSAFE_PATH);
  
    res = g_strconcat (&quot;file://&quot;,
<span class="udiff-line-modified-removed">-              (escaped_hostname) ? escaped_hostname : &quot;&quot;,</span>
<span class="udiff-line-modified-removed">-              (*escaped_path != &#39;/&#39;) ? &quot;/&quot; : &quot;&quot;,</span>
<span class="udiff-line-modified-removed">-              escaped_path,</span>
<span class="udiff-line-modified-removed">-              NULL);</span>
<span class="udiff-line-modified-added">+          (escaped_hostname) ? escaped_hostname : &quot;&quot;,</span>
<span class="udiff-line-modified-added">+          (*escaped_path != &#39;/&#39;) ? &quot;/&quot; : &quot;&quot;,</span>
<span class="udiff-line-modified-added">+          escaped_path,</span>
<span class="udiff-line-modified-added">+          NULL);</span>
  
  #ifdef G_OS_WIN32
    g_free ((char *) pathname);
  #endif
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1501,13 +1492,13 @@</span>
    return (first_digit &lt;&lt; 4) | second_digit;
  }
  
  static gchar *
  g_unescape_uri_string (const char *escaped,
<span class="udiff-line-modified-removed">-                int         len,</span>
<span class="udiff-line-modified-removed">-                const char *illegal_escaped_characters,</span>
<span class="udiff-line-modified-removed">-                gboolean    ascii_must_not_be_escaped)</span>
<span class="udiff-line-modified-added">+            int         len,</span>
<span class="udiff-line-modified-added">+            const char *illegal_escaped_characters,</span>
<span class="udiff-line-modified-added">+            gboolean    ascii_must_not_be_escaped)</span>
  {
    const gchar *in, *in_end;
    gchar *out, *result;
    int c;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1523,31 +1514,31 @@</span>
    for (in = escaped, in_end = escaped + len; in &lt; in_end; in++)
      {
        c = *in;
  
        if (c == &#39;%&#39;)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       /* catch partial escape sequences past the end of the substring */</span>
<span class="udiff-line-modified-removed">-       if (in + 3 &gt; in_end)</span>
<span class="udiff-line-modified-removed">-         break;</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     /* catch partial escape sequences past the end of the substring */</span>
<span class="udiff-line-modified-added">+     if (in + 3 &gt; in_end)</span>
<span class="udiff-line-modified-added">+       break;</span>
  
<span class="udiff-line-modified-removed">-       c = unescape_character (in + 1);</span>
<span class="udiff-line-modified-added">+     c = unescape_character (in + 1);</span>
  
<span class="udiff-line-modified-removed">-       /* catch bad escape sequences and NUL characters */</span>
<span class="udiff-line-modified-removed">-       if (c &lt;= 0)</span>
<span class="udiff-line-modified-removed">-         break;</span>
<span class="udiff-line-modified-added">+     /* catch bad escape sequences and NUL characters */</span>
<span class="udiff-line-modified-added">+     if (c &lt;= 0)</span>
<span class="udiff-line-modified-added">+       break;</span>
  
<span class="udiff-line-modified-removed">-       /* catch escaped ASCII */</span>
<span class="udiff-line-modified-removed">-       if (ascii_must_not_be_escaped &amp;&amp; c &lt;= 0x7F)</span>
<span class="udiff-line-modified-removed">-         break;</span>
<span class="udiff-line-modified-added">+     /* catch escaped ASCII */</span>
<span class="udiff-line-modified-added">+     if (ascii_must_not_be_escaped &amp;&amp; c &lt;= 0x7F)</span>
<span class="udiff-line-modified-added">+       break;</span>
  
<span class="udiff-line-modified-removed">-       /* catch other illegal escaped characters */</span>
<span class="udiff-line-modified-removed">-       if (strchr (illegal_escaped_characters, c) != NULL)</span>
<span class="udiff-line-modified-removed">-         break;</span>
<span class="udiff-line-modified-added">+     /* catch other illegal escaped characters */</span>
<span class="udiff-line-modified-added">+     if (strchr (illegal_escaped_characters, c) != NULL)</span>
<span class="udiff-line-modified-added">+       break;</span>
  
<span class="udiff-line-modified-removed">-       in += 2;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+     in += 2;</span>
<span class="udiff-line-modified-added">+   }</span>
  
        *out++ = c;
      }
  
    g_assert (out - result &lt;= len);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1588,25 +1579,25 @@</span>
      {
        /* read in a label */
        c = g_utf8_get_char (p);
        p = g_utf8_next_char (p);
        if (!is_asciialphanum (c))
<span class="udiff-line-modified-removed">-     return FALSE;</span>
<span class="udiff-line-modified-added">+   return FALSE;</span>
        first_char = c;
        do
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       last_char = c;</span>
<span class="udiff-line-modified-removed">-       c = g_utf8_get_char (p);</span>
<span class="udiff-line-modified-removed">-       p = g_utf8_next_char (p);</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     last_char = c;</span>
<span class="udiff-line-modified-added">+     c = g_utf8_get_char (p);</span>
<span class="udiff-line-modified-added">+     p = g_utf8_next_char (p);</span>
<span class="udiff-line-modified-added">+   }</span>
        while (is_asciialphanum (c) || c == &#39;-&#39;);
        if (last_char == &#39;-&#39;)
<span class="udiff-line-modified-removed">-     return FALSE;</span>
<span class="udiff-line-modified-added">+   return FALSE;</span>
  
        /* if that was the last label, check that it was a toplabel */
        if (c == &#39;\0&#39; || (c == &#39;.&#39; &amp;&amp; *p == &#39;\0&#39;))
<span class="udiff-line-modified-removed">-     return is_asciialpha (first_char);</span>
<span class="udiff-line-modified-added">+   return is_asciialpha (first_char);</span>
      }
    while (c == &#39;.&#39;);
    return FALSE;
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1625,12 +1616,12 @@</span>
   * Returns: (type filename): a newly-allocated string holding
   *               the resulting filename, or %NULL on an error.
   **/
  gchar *
  g_filename_from_uri (const gchar *uri,
<span class="udiff-line-modified-removed">-              gchar      **hostname,</span>
<span class="udiff-line-modified-removed">-              GError     **error)</span>
<span class="udiff-line-modified-added">+          gchar      **hostname,</span>
<span class="udiff-line-modified-added">+          GError     **error)</span>
  {
    const char *path_part;
    const char *host_part;
    char *unescaped_hostname;
    char *result;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1644,22 +1635,22 @@</span>
      *hostname = NULL;
  
    if (!has_case_prefix (uri, &quot;file:/&quot;))
      {
        g_set_error (error, G_CONVERT_ERROR, G_CONVERT_ERROR_BAD_URI,
<span class="udiff-line-modified-removed">-            _(&quot;The URI &#39;%s&#39; is not an absolute URI using the &#39;file&#39; scheme&quot;),</span>
<span class="udiff-line-modified-removed">-            uri);</span>
<span class="udiff-line-modified-added">+        _(&quot;The URI &#39;%s&#39; is not an absolute URI using the &#39;file&#39; scheme&quot;),</span>
<span class="udiff-line-modified-added">+        uri);</span>
        return NULL;
      }
  
    path_part = uri + strlen (&quot;file:&quot;);
  
    if (strchr (path_part, &#39;#&#39;) != NULL)
      {
        g_set_error (error, G_CONVERT_ERROR, G_CONVERT_ERROR_BAD_URI,
<span class="udiff-line-modified-removed">-            _(&quot;The local file URI &#39;%s&#39; may not include a &#39;#&#39;&quot;),</span>
<span class="udiff-line-modified-removed">-            uri);</span>
<span class="udiff-line-modified-added">+        _(&quot;The local file URI &#39;%s&#39; may not include a &#39;#&#39;&quot;),</span>
<span class="udiff-line-modified-added">+        uri);</span>
        return NULL;
      }
  
    if (has_case_prefix (path_part, &quot;///&quot;))
      path_part += 2;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1669,42 +1660,42 @@</span>
        host_part = path_part;
  
        path_part = strchr (path_part, &#39;/&#39;);
  
        if (path_part == NULL)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       g_set_error (error, G_CONVERT_ERROR, G_CONVERT_ERROR_BAD_URI,</span>
<span class="udiff-line-modified-removed">-                _(&quot;The URI &#39;%s&#39; is invalid&quot;),</span>
<span class="udiff-line-modified-removed">-                uri);</span>
<span class="udiff-line-modified-removed">-       return NULL;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     g_set_error (error, G_CONVERT_ERROR, G_CONVERT_ERROR_BAD_URI,</span>
<span class="udiff-line-modified-added">+            _(&quot;The URI &#39;%s&#39; is invalid&quot;),</span>
<span class="udiff-line-modified-added">+            uri);</span>
<span class="udiff-line-modified-added">+     return NULL;</span>
<span class="udiff-line-modified-added">+   }</span>
  
        unescaped_hostname = g_unescape_uri_string (host_part, path_part - host_part, &quot;&quot;, TRUE);
  
        if (unescaped_hostname == NULL ||
<span class="udiff-line-modified-removed">-       !hostname_validate (unescaped_hostname))</span>
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       g_free (unescaped_hostname);</span>
<span class="udiff-line-modified-removed">-       g_set_error (error, G_CONVERT_ERROR, G_CONVERT_ERROR_BAD_URI,</span>
<span class="udiff-line-modified-removed">-                _(&quot;The hostname of the URI &#39;%s&#39; is invalid&quot;),</span>
<span class="udiff-line-modified-removed">-                uri);</span>
<span class="udiff-line-modified-removed">-       return NULL;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+     !hostname_validate (unescaped_hostname))</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     g_free (unescaped_hostname);</span>
<span class="udiff-line-modified-added">+     g_set_error (error, G_CONVERT_ERROR, G_CONVERT_ERROR_BAD_URI,</span>
<span class="udiff-line-modified-added">+            _(&quot;The hostname of the URI &#39;%s&#39; is invalid&quot;),</span>
<span class="udiff-line-modified-added">+            uri);</span>
<span class="udiff-line-modified-added">+     return NULL;</span>
<span class="udiff-line-modified-added">+   }</span>
  
        if (hostname)
<span class="udiff-line-modified-removed">-     *hostname = unescaped_hostname;</span>
<span class="udiff-line-modified-added">+   *hostname = unescaped_hostname;</span>
        else
<span class="udiff-line-modified-removed">-     g_free (unescaped_hostname);</span>
<span class="udiff-line-modified-added">+   g_free (unescaped_hostname);</span>
      }
  
    filename = g_unescape_uri_string (path_part, -1, &quot;/&quot;, FALSE);
  
    if (filename == NULL)
      {
        g_set_error (error, G_CONVERT_ERROR, G_CONVERT_ERROR_BAD_URI,
<span class="udiff-line-modified-removed">-            _(&quot;The URI &#39;%s&#39; contains invalidly escaped characters&quot;),</span>
<span class="udiff-line-modified-removed">-            uri);</span>
<span class="udiff-line-modified-added">+        _(&quot;The URI &#39;%s&#39; contains invalidly escaped characters&quot;),</span>
<span class="udiff-line-modified-added">+        uri);</span>
        return NULL;
      }
  
    offs = 0;
  #ifdef G_OS_WIN32
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1729,16 +1720,16 @@</span>
     * the filename from the drive letter.
     */
    if (g_ascii_isalpha (filename[1]))
      {
        if (filename[2] == &#39;:&#39;)
<span class="udiff-line-modified-removed">-     offs = 1;</span>
<span class="udiff-line-modified-added">+   offs = 1;</span>
        else if (filename[2] == &#39;|&#39;)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       filename[2] = &#39;:&#39;;</span>
<span class="udiff-line-modified-removed">-       offs = 1;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     filename[2] = &#39;:&#39;;</span>
<span class="udiff-line-modified-added">+     offs = 1;</span>
<span class="udiff-line-modified-added">+   }</span>
      }
  #endif
  
    result = g_strdup (filename + offs);
    g_free (filename);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1761,28 +1752,28 @@</span>
   * Returns: a newly-allocated string holding the resulting
   *               URI, or %NULL on an error.
   **/
  gchar *
  g_filename_to_uri (const gchar *filename,
<span class="udiff-line-modified-removed">-            const gchar *hostname,</span>
<span class="udiff-line-modified-removed">-            GError     **error)</span>
<span class="udiff-line-modified-added">+        const gchar *hostname,</span>
<span class="udiff-line-modified-added">+        GError     **error)</span>
  {
    char *escaped_uri;
  
    g_return_val_if_fail (filename != NULL, NULL);
  
    if (!g_path_is_absolute (filename))
      {
        g_set_error (error, G_CONVERT_ERROR, G_CONVERT_ERROR_NOT_ABSOLUTE_PATH,
<span class="udiff-line-modified-removed">-            _(&quot;The pathname &#39;%s&#39; is not an absolute path&quot;),</span>
<span class="udiff-line-modified-removed">-            filename);</span>
<span class="udiff-line-modified-added">+        _(&quot;The pathname &#39;%s&#39; is not an absolute path&quot;),</span>
<span class="udiff-line-modified-added">+        filename);</span>
        return NULL;
      }
  
    if (hostname &amp;&amp;
        !(g_utf8_validate (hostname, -1, NULL)
<span class="udiff-line-modified-removed">-     &amp;&amp; hostname_validate (hostname)))</span>
<span class="udiff-line-modified-added">+   &amp;&amp; hostname_validate (hostname)))</span>
      {
        g_set_error_literal (error, G_CONVERT_ERROR, G_CONVERT_ERROR_ILLEGAL_SEQUENCE,
                             _(&quot;Invalid hostname&quot;));
        return NULL;
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1832,34 +1823,34 @@</span>
     * We do allow comments like specified in RFC 2483.
     */
    while (p)
      {
        if (*p != &#39;#&#39;)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       while (g_ascii_isspace (*p))</span>
<span class="udiff-line-modified-removed">-         p++;</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     while (g_ascii_isspace (*p))</span>
<span class="udiff-line-modified-added">+       p++;</span>
  
<span class="udiff-line-modified-removed">-       q = p;</span>
<span class="udiff-line-modified-removed">-       while (*q &amp;&amp; (*q != &#39;\n&#39;) &amp;&amp; (*q != &#39;\r&#39;))</span>
<span class="udiff-line-modified-removed">-         q++;</span>
<span class="udiff-line-modified-added">+     q = p;</span>
<span class="udiff-line-modified-added">+     while (*q &amp;&amp; (*q != &#39;\n&#39;) &amp;&amp; (*q != &#39;\r&#39;))</span>
<span class="udiff-line-modified-added">+       q++;</span>
  
<span class="udiff-line-modified-removed">-       if (q &gt; p)</span>
<span class="udiff-line-modified-removed">-         {</span>
<span class="udiff-line-removed">-           q--;</span>
<span class="udiff-line-removed">-           while (q &gt; p &amp;&amp; g_ascii_isspace (*q))</span>
<span class="udiff-line-modified-added">+     if (q &gt; p)</span>
<span class="udiff-line-modified-added">+       {</span>
          q--;
<span class="udiff-line-added">+         while (q &gt; p &amp;&amp; g_ascii_isspace (*q))</span>
<span class="udiff-line-added">+     q--;</span>
  
<span class="udiff-line-modified-removed">-           if (q &gt; p)</span>
<span class="udiff-line-modified-removed">-         {</span>
<span class="udiff-line-modified-removed">-           uris = g_slist_prepend (uris, g_strndup (p, q - p + 1));</span>
<span class="udiff-line-modified-removed">-           n_uris++;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+         if (q &gt; p)</span>
<span class="udiff-line-modified-added">+     {</span>
<span class="udiff-line-modified-added">+       uris = g_slist_prepend (uris, g_strndup (p, q - p + 1));</span>
<span class="udiff-line-modified-added">+       n_uris++;</span>
      }
<span class="udiff-line-added">+       }</span>
<span class="udiff-line-added">+   }</span>
        p = strchr (p, &#39;\n&#39;);
        if (p)
<span class="udiff-line-modified-removed">-     p++;</span>
<span class="udiff-line-modified-added">+   p++;</span>
      }
  
    result = g_new (gchar *, n_uris + 1);
  
    result[n_uris--] = NULL;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1949,26 +1940,26 @@</span>
    is_utf8 = g_get_filename_charsets (&amp;charsets);
  
    if (is_utf8)
      {
        if (g_utf8_validate (filename, -1, NULL))
<span class="udiff-line-modified-removed">-     display_name = g_strdup (filename);</span>
<span class="udiff-line-modified-added">+   display_name = g_strdup (filename);</span>
      }
  
    if (!display_name)
      {
        /* Try to convert from the filename charsets to UTF-8.
         * Skip the first charset if it is UTF-8.
         */
        for (i = is_utf8 ? 1 : 0; charsets[i]; i++)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       display_name = g_convert (filename, -1, &quot;UTF-8&quot;, charsets[i],</span>
<span class="udiff-line-modified-removed">-                     NULL, NULL, NULL);</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     display_name = g_convert (filename, -1, &quot;UTF-8&quot;, charsets[i],</span>
<span class="udiff-line-modified-added">+             NULL, NULL, NULL);</span>
  
<span class="udiff-line-modified-removed">-       if (display_name)</span>
<span class="udiff-line-modified-removed">-         break;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+     if (display_name)</span>
<span class="udiff-line-modified-added">+       break;</span>
<span class="udiff-line-modified-added">+   }</span>
      }
  
    /* if all conversions failed, we replace invalid UTF-8
     * by a question mark
     */
</pre>
<center><a href="gconstructor.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="gconvert.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>