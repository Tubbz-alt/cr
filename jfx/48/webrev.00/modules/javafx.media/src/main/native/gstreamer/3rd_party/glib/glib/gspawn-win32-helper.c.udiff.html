<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.media/src/main/native/gstreamer/3rd_party/glib/glib/gspawn-win32-helper.c</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="gslist.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="gspawn-win32.c.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.media/src/main/native/gstreamer/3rd_party/glib/glib/gspawn-win32-helper.c</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -36,16 +36,16 @@</span>
  #endif
  
  #undef G_LOG_DOMAIN
  #include &quot;glib.h&quot;
  #define GSPAWN_HELPER
<span class="udiff-line-modified-removed">- #include &quot;gspawn-win32.c&quot;   /* For shared definitions */</span>
<span class="udiff-line-modified-added">+ #include &quot;gspawn-win32.c&quot; /* For shared definitions */</span>
  
  
  static void
  write_err_and_exit (gint    fd,
<span class="udiff-line-modified-removed">-             gintptr msg)</span>
<span class="udiff-line-modified-added">+         gintptr msg)</span>
  {
    gintptr en = errno;
  
    write (fd, &amp;msg, sizeof(gintptr));
    write (fd, &amp;en, sizeof(gintptr));
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -67,12 +67,12 @@</span>
  
  /* Copy of protect_argv that handles wchar_t strings */
  
  static gint
  protect_wargv (gint       argc,
<span class="udiff-line-modified-removed">-            wchar_t  **wargv,</span>
<span class="udiff-line-modified-removed">-            wchar_t ***new_wargv)</span>
<span class="udiff-line-modified-added">+          wchar_t  **wargv,</span>
<span class="udiff-line-modified-added">+          wchar_t ***new_wargv)</span>
  {
    gint i;
  
    *new_wargv = g_new (wchar_t *, argc+1);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -80,63 +80,74 @@</span>
     * reconstructed correctly in the C runtime startup code.  Note that
     * the unquoting algorithm in the C runtime is really weird, and
     * rather different than what Unix shells do. See stdargv.c in the C
     * runtime sources (in the Platform SDK, in src/crt).
     *
<span class="udiff-line-modified-removed">-    * Note that an new_wargv[0] constructed by this function should</span>
<span class="udiff-line-modified-added">+    * Note that a new_wargv[0] constructed by this function should</span>
     * *not* be passed as the filename argument to a _wspawn* or _wexec*
     * family function. That argument should be the real file name
     * without any quoting.
     */
    for (i = 0; i &lt; argc; i++)
      {
        wchar_t *p = wargv[i];
        wchar_t *q;
        gint len = 0;
<span class="udiff-line-added">+       gint pre_bslash = 0;</span>
        gboolean need_dblquotes = FALSE;
        while (*p)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       if (*p == &#39; &#39; || *p == &#39;\t&#39;)</span>
<span class="udiff-line-modified-removed">-         need_dblquotes = TRUE;</span>
<span class="udiff-line-modified-removed">-       else if (*p == &#39;&quot;&#39;)</span>
<span class="udiff-line-modified-removed">-         len++;</span>
<span class="udiff-line-modified-removed">-       else if (*p == &#39;\\&#39;)</span>
<span class="udiff-line-modified-removed">-         {</span>
<span class="udiff-line-modified-removed">-           wchar_t *pp = p;</span>
<span class="udiff-line-modified-removed">-           while (*pp &amp;&amp; *pp == &#39;\\&#39;)</span>
<span class="udiff-line-modified-removed">-         pp++;</span>
<span class="udiff-line-removed">-           if (*pp == &#39;&quot;&#39;)</span>
<span class="udiff-line-removed">-         len++;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-       len++;</span>
<span class="udiff-line-removed">-       p++;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     if (*p == &#39; &#39; || *p == &#39;\t&#39;)</span>
<span class="udiff-line-modified-added">+       need_dblquotes = TRUE;</span>
<span class="udiff-line-modified-added">+     /* estimate max len, assuming that all escapable chracters will be escaped */</span>
<span class="udiff-line-modified-added">+     if (*p == &#39;&quot;&#39; || *p == &#39;\\&#39;)</span>
<span class="udiff-line-modified-added">+       len += 2;</span>
<span class="udiff-line-modified-added">+     else</span>
<span class="udiff-line-modified-added">+       len += 1;</span>
<span class="udiff-line-modified-added">+     p++;</span>
<span class="udiff-line-modified-added">+   }</span>
  
        q = (*new_wargv)[i] = g_new (wchar_t, len + need_dblquotes*2 + 1);
        p = wargv[i];
  
        if (need_dblquotes)
<span class="udiff-line-modified-removed">-     *q++ = &#39;&quot;&#39;;</span>
<span class="udiff-line-modified-added">+   *q++ = &#39;&quot;&#39;;</span>
  
<span class="udiff-line-added">+       /* Only quotes and backslashes preceeding quotes are escaped:</span>
<span class="udiff-line-added">+        * see &quot;Parsing C Command-Line Arguments&quot; at</span>
<span class="udiff-line-added">+        * https://docs.microsoft.com/en-us/cpp/c-language/parsing-c-command-line-arguments</span>
<span class="udiff-line-added">+        */</span>
        while (*p)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       if (*p == &#39;&quot;&#39;)</span>
<span class="udiff-line-modified-removed">-         *q++ = &#39;\\&#39;;</span>
<span class="udiff-line-modified-removed">-       else if (*p == &#39;\\&#39;)</span>
<span class="udiff-line-removed">-         {</span>
<span class="udiff-line-removed">-           wchar_t *pp = p;</span>
<span class="udiff-line-removed">-           while (*pp &amp;&amp; *pp == &#39;\\&#39;)</span>
<span class="udiff-line-removed">-         pp++;</span>
<span class="udiff-line-removed">-           if (*pp == &#39;&quot;&#39;)</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     if (*p == &#39;&quot;&#39;)</span>
<span class="udiff-line-modified-added">+       {</span>
<span class="udiff-line-modified-added">+         /* Add backslash for escaping quote itself */</span>
          *q++ = &#39;\\&#39;;
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-       *q++ = *p;</span>
<span class="udiff-line-modified-removed">-       p++;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+         /* Add backslash for every preceeding backslash for escaping it */</span>
<span class="udiff-line-modified-added">+         for (;pre_bslash &gt; 0; --pre_bslash)</span>
<span class="udiff-line-modified-added">+     *q++ = &#39;\\&#39;;</span>
<span class="udiff-line-modified-added">+       }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     /* Count length of continuous sequence of preceeding backslashes. */</span>
<span class="udiff-line-added">+     if (*p == &#39;\\&#39;)</span>
<span class="udiff-line-added">+       ++pre_bslash;</span>
<span class="udiff-line-added">+     else</span>
<span class="udiff-line-added">+       pre_bslash = 0;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     *q++ = *p;</span>
<span class="udiff-line-added">+     p++;</span>
<span class="udiff-line-added">+   }</span>
  
        if (need_dblquotes)
<span class="udiff-line-added">+   {</span>
<span class="udiff-line-added">+     /* Add backslash for every preceeding backslash for escaping it,</span>
<span class="udiff-line-added">+      * do NOT escape quote itself.</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     for (;pre_bslash &gt; 0; --pre_bslash)</span>
<span class="udiff-line-added">+       *q++ = &#39;\\&#39;;</span>
      *q++ = &#39;&quot;&#39;;
<span class="udiff-line-added">+   }</span>
        *q++ = &#39;\0&#39;;
      }
    (*new_wargv)[argc] = NULL;
  
    return argc;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -167,20 +178,21 @@</span>
  
  #ifndef GSTREAMER_LITE
  #ifndef HELPER_CONSOLE
  int _stdcall
  WinMain (struct HINSTANCE__ *hInstance,
<span class="udiff-line-modified-removed">-      struct HINSTANCE__ *hPrevInstance,</span>
<span class="udiff-line-modified-removed">-      char               *lpszCmdLine,</span>
<span class="udiff-line-modified-removed">-      int                 nCmdShow)</span>
<span class="udiff-line-modified-added">+    struct HINSTANCE__ *hPrevInstance,</span>
<span class="udiff-line-modified-added">+    char               *lpszCmdLine,</span>
<span class="udiff-line-modified-added">+    int                 nCmdShow)</span>
  #else
  int
  main (int ignored_argc, char **ignored_argv)
  #endif
  {
    int child_err_report_fd = -1;
    int helper_sync_fd = -1;
<span class="udiff-line-added">+   int saved_stderr_fd = -1;</span>
    int i;
    int fd;
    int mode;
    gintptr handle;
    int saved_errno;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -242,65 +254,66 @@</span>
      ; /* Nothing */
    else if (argv[ARG_STDIN][0] == &#39;z&#39;)
      {
        fd = open (&quot;NUL:&quot;, O_RDONLY);
        if (fd != 0)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       dup2 (fd, 0);</span>
<span class="udiff-line-modified-removed">-       close (fd);</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     dup2 (fd, 0);</span>
<span class="udiff-line-modified-added">+     close (fd);</span>
<span class="udiff-line-modified-added">+   }</span>
      }
    else
      {
        fd = atoi (argv[ARG_STDIN]);
        if (fd != 0)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       dup2 (fd, 0);</span>
<span class="udiff-line-modified-removed">-       close (fd);</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     dup2 (fd, 0);</span>
<span class="udiff-line-modified-added">+     close (fd);</span>
<span class="udiff-line-modified-added">+   }</span>
      }
  
    if (argv[ARG_STDOUT][0] == &#39;-&#39;)
      ; /* Nothing */
    else if (argv[ARG_STDOUT][0] == &#39;z&#39;)
      {
        fd = open (&quot;NUL:&quot;, O_WRONLY);
        if (fd != 1)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       dup2 (fd, 1);</span>
<span class="udiff-line-modified-removed">-       close (fd);</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     dup2 (fd, 1);</span>
<span class="udiff-line-modified-added">+     close (fd);</span>
<span class="udiff-line-modified-added">+   }</span>
      }
    else
      {
        fd = atoi (argv[ARG_STDOUT]);
        if (fd != 1)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       dup2 (fd, 1);</span>
<span class="udiff-line-modified-removed">-       close (fd);</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     dup2 (fd, 1);</span>
<span class="udiff-line-modified-added">+     close (fd);</span>
<span class="udiff-line-modified-added">+   }</span>
      }
  
<span class="udiff-line-added">+   saved_stderr_fd = reopen_noninherited (dup (2), _O_WRONLY);</span>
    if (argv[ARG_STDERR][0] == &#39;-&#39;)
      ; /* Nothing */
    else if (argv[ARG_STDERR][0] == &#39;z&#39;)
      {
        fd = open (&quot;NUL:&quot;, O_WRONLY);
        if (fd != 2)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       dup2 (fd, 2);</span>
<span class="udiff-line-modified-removed">-       close (fd);</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     dup2 (fd, 2);</span>
<span class="udiff-line-modified-added">+     close (fd);</span>
<span class="udiff-line-modified-added">+   }</span>
      }
    else
      {
        fd = atoi (argv[ARG_STDERR]);
        if (fd != 2)
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-       dup2 (fd, 2);</span>
<span class="udiff-line-modified-removed">-       close (fd);</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+   {</span>
<span class="udiff-line-modified-added">+     dup2 (fd, 2);</span>
<span class="udiff-line-modified-added">+     close (fd);</span>
<span class="udiff-line-modified-added">+   }</span>
      }
  
    /* argv[ARG_WORKING_DIRECTORY] is the directory in which to run the
     * process.  If &quot;-&quot;, don&#39;t change directory.
     */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -313,19 +326,19 @@</span>
    /* argv[ARG_CLOSE_DESCRIPTORS] is &quot;y&quot; if file descriptors from 3
     *  upwards should be closed
     */
    if (argv[ARG_CLOSE_DESCRIPTORS][0] == &#39;y&#39;)
      for (i = 3; i &lt; 1000; i++)  /* FIXME real limit? */
<span class="udiff-line-modified-removed">-       if (i != child_err_report_fd &amp;&amp; i != helper_sync_fd)</span>
<span class="udiff-line-modified-added">+       if (i != child_err_report_fd &amp;&amp; i != helper_sync_fd &amp;&amp; i != saved_stderr_fd)</span>
          if (_get_osfhandle (i) != -1)
            close (i);
  
    /* We don&#39;t want our child to inherit the error report and
     * helper sync fds.
     */
<span class="udiff-line-modified-removed">-   child_err_report_fd = dup_noninherited (child_err_report_fd, _O_WRONLY);</span>
<span class="udiff-line-modified-removed">-   helper_sync_fd = dup_noninherited (helper_sync_fd, _O_RDONLY);</span>
<span class="udiff-line-modified-added">+   child_err_report_fd = reopen_noninherited (child_err_report_fd, _O_WRONLY);</span>
<span class="udiff-line-modified-added">+   helper_sync_fd = reopen_noninherited (helper_sync_fd, _O_RDONLY);</span>
  
    /* argv[ARG_WAIT] is &quot;w&quot; to wait for the program to exit */
    if (argv[ARG_WAIT][0] == &#39;w&#39;)
      mode = P_WAIT;
    else
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -349,10 +362,15 @@</span>
    else
      handle = _wspawnv (mode, wargv[ARG_PROGRAM], (const wchar_t **) new_wargv);
  
    saved_errno = errno;
  
<span class="udiff-line-added">+   /* Some coverage warnings may be printed on stderr during this process exit.</span>
<span class="udiff-line-added">+    * Remove redirection so that they would go to original stderr</span>
<span class="udiff-line-added">+    * instead of being treated as part of stderr of child process.</span>
<span class="udiff-line-added">+    */</span>
<span class="udiff-line-added">+   dup2 (saved_stderr_fd, 2);</span>
    if (handle == -1 &amp;&amp; saved_errno != 0)
      {
        int ec = (saved_errno == ENOENT)
            ? CHILD_SPAWN_NOENT
            : CHILD_SPAWN_FAILED;
</pre>
<center><a href="gslist.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="gspawn-win32.c.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>