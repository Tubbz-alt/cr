<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/ThirdParty/icu/source/common/utrie2_builder.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="utrie2.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="utrie2_impl.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/ThirdParty/icu/source/common/utrie2_builder.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -22,20 +22,27 @@</span>
  *   See utrie2.h for a comparison.
  *
  *   This file contains only the builder code.
  *   See utrie2.c for the runtime and enumeration code.
  */
<span class="udiff-line-added">+ // #define UTRIE2_DEBUG</span>
  #ifdef UTRIE2_DEBUG
  #   include &lt;stdio.h&gt;
  #endif
<span class="udiff-line-added">+ // #define UCPTRIE_DEBUG</span>
  
  #include &quot;unicode/utypes.h&quot;
<span class="udiff-line-added">+ #ifdef UCPTRIE_DEBUG</span>
<span class="udiff-line-added">+ #include &quot;unicode/ucptrie.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;unicode/umutablecptrie.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;ucptrie_impl.h&quot;</span>
<span class="udiff-line-added">+ #endif</span>
  #include &quot;cmemory.h&quot;
  #include &quot;utrie2.h&quot;
  #include &quot;utrie2_impl.h&quot;
  
<span class="udiff-line-modified-removed">- #include &quot;utrie.h&quot; /* for utrie2_fromUTrie() and utrie_swap() */</span>
<span class="udiff-line-modified-added">+ #include &quot;utrie.h&quot;  // for utrie2_fromUTrie()</span>
  
  /* Implementation notes ----------------------------------------------------- */
  
  /*
   * The UTRIE2_SHIFT_1, UTRIE2_SHIFT_2, UTRIE2_INDEX_SHIFT and other values
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -130,12 +137,18 @@</span>
      uprv_memset(trie, 0, sizeof(UTrie2));
      trie-&gt;initialValue=initialValue;
      trie-&gt;errorValue=errorValue;
      trie-&gt;highStart=0x110000;
      trie-&gt;newTrie=newTrie;
<span class="udiff-line-added">+ #ifdef UTRIE2_DEBUG</span>
<span class="udiff-line-added">+     trie-&gt;name=&quot;open&quot;;</span>
<span class="udiff-line-added">+ #endif</span>
  
      newTrie-&gt;data=data;
<span class="udiff-line-added">+ #ifdef UCPTRIE_DEBUG</span>
<span class="udiff-line-added">+     newTrie-&gt;t3=umutablecptrie_open(initialValue, errorValue, pErrorCode);</span>
<span class="udiff-line-added">+ #endif</span>
      newTrie-&gt;dataCapacity=UNEWTRIE2_INITIAL_DATA_LENGTH;
      newTrie-&gt;initialValue=initialValue;
      newTrie-&gt;errorValue=errorValue;
      newTrie-&gt;highStart=0x110000;
      newTrie-&gt;firstFreeBlock=0;  /* no free block in the list */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -244,10 +257,18 @@</span>
      trie-&gt;data=(uint32_t *)uprv_malloc(other-&gt;dataCapacity*4);
      if(trie-&gt;data==NULL) {
          uprv_free(trie);
          return NULL;
      }
<span class="udiff-line-added">+ #ifdef UCPTRIE_DEBUG</span>
<span class="udiff-line-added">+     if(other-&gt;t3==nullptr) {</span>
<span class="udiff-line-added">+         trie-&gt;t3=nullptr;</span>
<span class="udiff-line-added">+     } else {</span>
<span class="udiff-line-added">+         UErrorCode errorCode=U_ZERO_ERROR;</span>
<span class="udiff-line-added">+         trie-&gt;t3=umutablecptrie_clone(other-&gt;t3, &amp;errorCode);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ #endif</span>
      trie-&gt;dataCapacity=other-&gt;dataCapacity;
  
      /* clone data */
      uprv_memcpy(trie-&gt;index1, other-&gt;index1, sizeof(trie-&gt;index1));
      uprv_memcpy(trie-&gt;index2, other-&gt;index2, (size_t)other-&gt;index2Length*4);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -286,10 +307,11 @@</span>
          return NULL;
      }
  
      trie=(UTrie2 *)uprv_malloc(sizeof(UTrie2));
      if(trie==NULL) {
<span class="udiff-line-added">+         *pErrorCode=U_MEMORY_ALLOCATION_ERROR;</span>
          return NULL;
      }
      uprv_memcpy(trie, other, sizeof(UTrie2));
  
      if(other-&gt;memory!=NULL) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -310,10 +332,11 @@</span>
      } else /* other-&gt;newTrie!=NULL */ {
          trie-&gt;newTrie=cloneBuilder(other-&gt;newTrie);
      }
  
      if(trie-&gt;memory==NULL &amp;&amp; trie-&gt;newTrie==NULL) {
<span class="udiff-line-added">+         *pErrorCode=U_MEMORY_ALLOCATION_ERROR;</span>
          uprv_free(trie);
          trie=NULL;
      }
      return trie;
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -341,10 +364,26 @@</span>
          return TRUE;
      }
  }
  
  #ifdef UTRIE2_DEBUG
<span class="udiff-line-added">+ static long countInitial(const UTrie2 *trie) {</span>
<span class="udiff-line-added">+     uint32_t initialValue=trie-&gt;initialValue;</span>
<span class="udiff-line-added">+     int32_t length=trie-&gt;dataLength;</span>
<span class="udiff-line-added">+     long count=0;</span>
<span class="udiff-line-added">+     if(trie-&gt;data16!=nullptr) {</span>
<span class="udiff-line-added">+         for(int32_t i=0; i&lt;length; ++i) {</span>
<span class="udiff-line-added">+             if(trie-&gt;data16[i]==initialValue) { ++count; }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     } else {</span>
<span class="udiff-line-added">+         for(int32_t i=0; i&lt;length; ++i) {</span>
<span class="udiff-line-added">+             if(trie-&gt;data32[i]==initialValue) { ++count; }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     return count;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  static void
  utrie_printLengths(const UTrie *trie) {
      long indexLength=trie-&gt;indexLength;
      long dataLength=(long)trie-&gt;dataLength;
      long totalLength=(long)sizeof(UTrieHeader)+indexLength*2+dataLength*(trie-&gt;data32!=NULL ? 4 : 2);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -355,12 +394,12 @@</span>
  static void
  utrie2_printLengths(const UTrie2 *trie, const char *which) {
      long indexLength=trie-&gt;indexLength;
      long dataLength=(long)trie-&gt;dataLength;
      long totalLength=(long)sizeof(UTrie2Header)+indexLength*2+dataLength*(trie-&gt;data32!=NULL ? 4 : 2);
<span class="udiff-line-modified-removed">-     printf(&quot;**UTrie2Lengths(%s)** index:%6ld  data:%6ld  serialized:%6ld\n&quot;,</span>
<span class="udiff-line-modified-removed">-            which, indexLength, dataLength, totalLength);</span>
<span class="udiff-line-modified-added">+     printf(&quot;**UTrie2Lengths(%s %s)** index:%6ld  data:%6ld  countInitial:%6ld  serialized:%6ld\n&quot;,</span>
<span class="udiff-line-modified-added">+            which, trie-&gt;name, indexLength, dataLength, countInitial(trie), totalLength);</span>
  }
  #endif
  
  U_CAPI UTrie2 * U_EXPORT2
  utrie2_cloneAsThawed(const UTrie2 *other, UErrorCode *pErrorCode) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -620,10 +659,13 @@</span>
  
      if(trie==NULL || trie-&gt;isCompacted) {
          *pErrorCode=U_NO_WRITE_PERMISSION;
          return;
      }
<span class="udiff-line-added">+ #ifdef UCPTRIE_DEBUG</span>
<span class="udiff-line-added">+     umutablecptrie_set(trie-&gt;t3, c, value, pErrorCode);</span>
<span class="udiff-line-added">+ #endif</span>
  
      block=getDataBlock(trie, c, forLSCP);
      if(block&lt;0) {
          *pErrorCode=U_MEMORY_ALLOCATION_ERROR;
          return;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -715,10 +757,13 @@</span>
      newTrie=trie-&gt;newTrie;
      if(newTrie==NULL || newTrie-&gt;isCompacted) {
          *pErrorCode=U_NO_WRITE_PERMISSION;
          return;
      }
<span class="udiff-line-added">+ #ifdef UCPTRIE_DEBUG</span>
<span class="udiff-line-added">+     umutablecptrie_setRange(newTrie-&gt;t3, start, end, value, pErrorCode);</span>
<span class="udiff-line-added">+ #endif</span>
      if(!overwrite &amp;&amp; value==newTrie-&gt;initialValue) {
          return; /* nothing to do */
      }
  
      limit=end+1;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -730,11 +775,11 @@</span>
          if(block&lt;0) {
              *pErrorCode=U_MEMORY_ALLOCATION_ERROR;
              return;
          }
  
<span class="udiff-line-modified-removed">-         nextStart=(start+UTRIE2_DATA_BLOCK_LENGTH)&amp;~UTRIE2_DATA_MASK;</span>
<span class="udiff-line-modified-added">+         nextStart=(start+UTRIE2_DATA_MASK)&amp;~UTRIE2_DATA_MASK;</span>
          if(nextStart&lt;=limit) {
              fillBlock(newTrie-&gt;data+block, start&amp;UTRIE2_DATA_MASK, UTRIE2_DATA_BLOCK_LENGTH,
                        value, newTrie-&gt;initialValue, overwrite);
              start=nextStart;
          } else {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -981,10 +1026,14 @@</span>
   * It does not
   * - try to move and overlap blocks that are not already adjacent
   */
  static void
  compactData(UNewTrie2 *trie) {
<span class="udiff-line-added">+ #ifdef UTRIE2_DEBUG</span>
<span class="udiff-line-added">+     int32_t countSame=0, sumOverlaps=0;</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
      int32_t start, newStart, movedStart;
      int32_t blockLength, overlap;
      int32_t i, mapIndex, blockCount;
  
      /* do not compact linear-ASCII data */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1021,10 +1070,13 @@</span>
  
          /* search for an identical block */
          if( (movedStart=findSameDataBlock(trie-&gt;data, newStart, start, blockLength))
               &gt;=0
          ) {
<span class="udiff-line-added">+ #ifdef UTRIE2_DEBUG</span>
<span class="udiff-line-added">+             ++countSame;</span>
<span class="udiff-line-added">+ #endif</span>
              /* found an identical block, set the other block&#39;s index value for the current block */
              for(i=blockCount, mapIndex=start&gt;&gt;UTRIE2_SHIFT_2; i&gt;0; --i) {
                  trie-&gt;map[mapIndex++]=movedStart;
                  movedStart+=UTRIE2_DATA_BLOCK_LENGTH;
              }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1040,10 +1092,13 @@</span>
          /* look for maximum overlap (modulo granularity) with the previous, adjacent block */
          for(overlap=blockLength-UTRIE2_DATA_GRANULARITY;
              overlap&gt;0 &amp;&amp; !equal_uint32(trie-&gt;data+(newStart-overlap), trie-&gt;data+start, overlap);
              overlap-=UTRIE2_DATA_GRANULARITY) {}
  
<span class="udiff-line-added">+ #ifdef UTRIE2_DEBUG</span>
<span class="udiff-line-added">+             sumOverlaps+=overlap;</span>
<span class="udiff-line-added">+ #endif</span>
          if(overlap&gt;0 || newStart&lt;start) {
              /* some overlap, or just move the whole block */
              movedStart=newStart-overlap;
              for(i=blockCount, mapIndex=start&gt;&gt;UTRIE2_SHIFT_2; i&gt;0; --i) {
                  trie-&gt;map[mapIndex++]=movedStart;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1079,12 +1134,12 @@</span>
          trie-&gt;data[newStart++]=trie-&gt;initialValue;
      }
  
  #ifdef UTRIE2_DEBUG
      /* we saved some space */
<span class="udiff-line-modified-removed">-     printf(&quot;compacting UTrie2: count of 32-bit data words %lu-&gt;%lu\n&quot;,</span>
<span class="udiff-line-modified-removed">-             (long)trie-&gt;dataLength, (long)newStart);</span>
<span class="udiff-line-modified-added">+     printf(&quot;compacting UTrie2: count of 32-bit data words %lu-&gt;%lu  countSame=%ld  sumOverlaps=%ld\n&quot;,</span>
<span class="udiff-line-modified-added">+             (long)trie-&gt;dataLength, (long)newStart, (long)countSame, (long)sumOverlaps);</span>
  #endif
  
      trie-&gt;dataLength=newStart;
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1161,11 +1216,11 @@</span>
          trie-&gt;index2[newStart++]=(int32_t)0xffff&lt;&lt;UTRIE2_INDEX_SHIFT;
      }
  
  #ifdef UTRIE2_DEBUG
      /* we saved some space */
<span class="udiff-line-modified-removed">-     printf(&quot;compacting UTrie2: count of 16-bit index-2 words %lu-&gt;%lu\n&quot;,</span>
<span class="udiff-line-modified-added">+     printf(&quot;compacting UTrie2: count of 16-bit index words %lu-&gt;%lu\n&quot;,</span>
              (long)trie-&gt;index2Length, (long)newStart);
  #endif
  
      trie-&gt;index2Length=newStart;
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1191,11 +1246,11 @@</span>
       * Otherwise utrie2_get32(trie, highStart) would try to read the highValue.
       */
      trie-&gt;highStart=newTrie-&gt;highStart=highStart;
  
  #ifdef UTRIE2_DEBUG
<span class="udiff-line-modified-removed">-     printf(&quot;UTrie2: highStart U+%04lx  highValue 0x%lx  initialValue 0x%lx\n&quot;,</span>
<span class="udiff-line-modified-added">+     printf(&quot;UTrie2: highStart U+%06lx  highValue 0x%lx  initialValue 0x%lx\n&quot;,</span>
              (long)highStart, (long)highValue, (long)trie-&gt;initialValue);
  #endif
  
      if(highStart&lt;0x110000) {
          /* Blank out [highStart..10ffff] to release associated data blocks. */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1209,11 +1264,11 @@</span>
      compactData(newTrie);
      if(highStart&gt;0x10000) {
          compactIndex2(newTrie);
  #ifdef UTRIE2_DEBUG
      } else {
<span class="udiff-line-modified-removed">-         printf(&quot;UTrie2: highStart U+%04lx  count of 16-bit index-2 words %lu-&gt;%lu\n&quot;,</span>
<span class="udiff-line-modified-added">+         printf(&quot;UTrie2: highStart U+%04lx  count of 16-bit index words %lu-&gt;%lu\n&quot;,</span>
                  (long)highStart, (long)trie-&gt;newTrie-&gt;index2Length, (long)UTRIE2_INDEX_1_OFFSET);
  #endif
      }
  
      /*
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1332,11 +1387,11 @@</span>
      trie-&gt;indexLength=allIndexesLength;
      trie-&gt;dataLength=newTrie-&gt;dataLength;
      if(highStart&lt;=0x10000) {
          trie-&gt;index2NullOffset=0xffff;
      } else {
<span class="udiff-line-modified-removed">-         trie-&gt;index2NullOffset=UTRIE2_INDEX_2_OFFSET+newTrie-&gt;index2NullOffset;</span>
<span class="udiff-line-modified-added">+         trie-&gt;index2NullOffset=static_cast&lt;uint16_t&gt;(UTRIE2_INDEX_2_OFFSET+newTrie-&gt;index2NullOffset);</span>
      }
      trie-&gt;dataNullOffset=(uint16_t)(dataMove+newTrie-&gt;dataNullOffset);
      trie-&gt;highValueIndex=dataMove+trie-&gt;dataLength-UTRIE2_DATA_GRANULARITY;
  
      /* set the header fields */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1409,33 +1464,20 @@</span>
      default:
          *pErrorCode=U_ILLEGAL_ARGUMENT_ERROR;
          return;
      }
  
<span class="udiff-line-added">+ #ifdef UTRIE2_DEBUG</span>
<span class="udiff-line-added">+     utrie2_printLengths(trie, &quot;&quot;);</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #ifdef UCPTRIE_DEBUG</span>
<span class="udiff-line-added">+     umutablecptrie_setName(newTrie-&gt;t3, trie-&gt;name);</span>
<span class="udiff-line-added">+     ucptrie_close(</span>
<span class="udiff-line-added">+         umutablecptrie_buildImmutable(</span>
<span class="udiff-line-added">+             newTrie-&gt;t3, UCPTRIE_TYPE_FAST, (UCPTrieValueWidth)valueBits, pErrorCode));</span>
<span class="udiff-line-added">+ #endif</span>
      /* Delete the UNewTrie2. */
      uprv_free(newTrie-&gt;data);
      uprv_free(newTrie);
      trie-&gt;newTrie=NULL;
  }
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- /*</span>
<span class="udiff-line-removed">-  * This is here to avoid a dependency from utrie2.cpp on utrie.c.</span>
<span class="udiff-line-removed">-  * This file already depends on utrie.c.</span>
<span class="udiff-line-removed">-  * Otherwise, this should be in utrie2.cpp right after utrie2_swap().</span>
<span class="udiff-line-removed">-  */</span>
<span class="udiff-line-removed">- U_CAPI int32_t U_EXPORT2</span>
<span class="udiff-line-removed">- utrie2_swapAnyVersion(const UDataSwapper *ds,</span>
<span class="udiff-line-removed">-                       const void *inData, int32_t length, void *outData,</span>
<span class="udiff-line-removed">-                       UErrorCode *pErrorCode) {</span>
<span class="udiff-line-removed">-     if(U_SUCCESS(*pErrorCode)) {</span>
<span class="udiff-line-removed">-         switch(utrie2_getVersion(inData, length, TRUE)) {</span>
<span class="udiff-line-removed">-         case 1:</span>
<span class="udiff-line-removed">-             return utrie_swap(ds, inData, length, outData, pErrorCode);</span>
<span class="udiff-line-removed">-         case 2:</span>
<span class="udiff-line-removed">-             return utrie2_swap(ds, inData, length, outData, pErrorCode);</span>
<span class="udiff-line-removed">-         default:</span>
<span class="udiff-line-removed">-             *pErrorCode=U_INVALID_FORMAT_ERROR;</span>
<span class="udiff-line-removed">-             return 0;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     return 0;</span>
<span class="udiff-line-removed">- }</span>
</pre>
<center><a href="utrie2.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="utrie2_impl.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>