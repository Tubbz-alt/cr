<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/ThirdParty/icu/source/i18n/coll.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="chnsecal.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="collationbuilder.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/ThirdParty/icu/source/i18n/coll.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 209     return gService;
 210 }
 211 
 212 // -------------------------------------
 213 
 214 static inline UBool
 215 hasService(void)
 216 {
 217     UBool retVal = !gServiceInitOnce.isReset() &amp;&amp; (getService() != NULL);
 218     return retVal;
 219 }
 220 
 221 #endif /* UCONFIG_NO_SERVICE */
 222 
 223 static void U_CALLCONV
 224 initAvailableLocaleList(UErrorCode &amp;status) {
 225     U_ASSERT(availableLocaleListCount == 0);
 226     U_ASSERT(availableLocaleList == NULL);
 227     // for now, there is a hardcoded list, so just walk through that list and set it up.
 228     UResourceBundle *index = NULL;
<span class="line-modified"> 229     UResourceBundle installed;</span>
 230     int32_t i = 0;
 231 
<span class="line-removed"> 232     ures_initStackObject(&amp;installed);</span>
 233     index = ures_openDirect(U_ICUDATA_COLL, &quot;res_index&quot;, &amp;status);
<span class="line-modified"> 234     ures_getByKey(index, &quot;InstalledLocales&quot;, &amp;installed, &amp;status);</span>
 235 
 236     if(U_SUCCESS(status)) {
<span class="line-modified"> 237         availableLocaleListCount = ures_getSize(&amp;installed);</span>
 238         availableLocaleList = new Locale[availableLocaleListCount];
 239 
 240         if (availableLocaleList != NULL) {
<span class="line-modified"> 241             ures_resetIterator(&amp;installed);</span>
<span class="line-modified"> 242             while(ures_hasNext(&amp;installed)) {</span>
 243                 const char *tempKey = NULL;
<span class="line-modified"> 244                 ures_getNextString(&amp;installed, NULL, &amp;tempKey, &amp;status);</span>
 245                 availableLocaleList[i++] = Locale(tempKey);
 246             }
 247         }
 248         U_ASSERT(availableLocaleListCount == i);
<span class="line-removed"> 249         ures_close(&amp;installed);</span>
 250     }
 251     ures_close(index);
 252     ucln_i18n_registerCleanup(UCLN_I18N_COLLATOR, collator_cleanup);
 253 }
 254 
 255 static UBool isAvailableLocaleListInitialized(UErrorCode &amp;status) {
 256     umtx_initOnce(gAvailableLocaleListInitOnce, &amp;initAvailableLocaleList, status);
 257     return U_SUCCESS(status);
 258 }
 259 
 260 
 261 // Collator public methods -----------------------------------------------
 262 
 263 namespace {
 264 
 265 static const struct {
 266     const char *name;
 267     UColAttribute attr;
 268 } collAttributes[] = {
 269     { &quot;colStrength&quot;, UCOL_STRENGTH },
</pre>
<hr />
<pre>
 431 Collator* U_EXPORT2 Collator::createInstance(const Locale&amp; desiredLocale,
 432                                    UErrorCode&amp; status)
 433 {
 434     if (U_FAILURE(status))
 435         return 0;
 436     if (desiredLocale.isBogus()) {
 437         // Locale constructed from malformed locale ID or language tag.
 438         status = U_ILLEGAL_ARGUMENT_ERROR;
 439         return NULL;
 440     }
 441 
 442     Collator* coll;
 443 #if !UCONFIG_NO_SERVICE
 444     if (hasService()) {
 445         Locale actualLoc;
 446         coll = (Collator*)gService-&gt;get(desiredLocale, &amp;actualLoc, status);
 447     } else
 448 #endif
 449     {
 450         coll = makeInstance(desiredLocale, status);







 451     }
 452     setAttributesFromKeywords(desiredLocale, *coll, status);
 453     if (U_FAILURE(status)) {
 454         delete coll;
 455         return NULL;
 456     }
 457     return coll;
 458 }
 459 
 460 
 461 Collator* Collator::makeInstance(const Locale&amp;  desiredLocale, UErrorCode&amp; status) {
 462     const CollationCacheEntry *entry = CollationLoader::loadTailoring(desiredLocale, status);
 463     if (U_SUCCESS(status)) {
 464         Collator *result = new RuleBasedCollator(entry);
 465         if (result != NULL) {
 466             // Both the unified cache&#39;s get() and the RBC constructor
 467             // did addRef(). Undo one of them.
 468             entry-&gt;removeRef();
 469             return result;
 470         }
</pre>
<hr />
<pre>
 969 Collator::internalGetShortDefinitionString(const char * /*locale*/,
 970                                                              char * /*buffer*/,
 971                                                              int32_t /*capacity*/,
 972                                                              UErrorCode &amp;status) const {
 973   if(U_SUCCESS(status)) {
 974     status = U_UNSUPPORTED_ERROR; /* Shouldn&#39;t happen, internal function */
 975   }
 976   return 0;
 977 }
 978 
 979 UCollationResult
 980 Collator::internalCompareUTF8(const char *left, int32_t leftLength,
 981                               const char *right, int32_t rightLength,
 982                               UErrorCode &amp;errorCode) const {
 983     if(U_FAILURE(errorCode)) { return UCOL_EQUAL; }
 984     if((left == NULL &amp;&amp; leftLength != 0) || (right == NULL &amp;&amp; rightLength != 0)) {
 985         errorCode = U_ILLEGAL_ARGUMENT_ERROR;
 986         return UCOL_EQUAL;
 987     }
 988     return compareUTF8(
<span class="line-modified"> 989             StringPiece(left, (leftLength &lt; 0) ? uprv_strlen(left) : leftLength),</span>
<span class="line-modified"> 990             StringPiece(right, (rightLength &lt; 0) ? uprv_strlen(right) : rightLength),</span>
 991             errorCode);
 992 }
 993 
 994 int32_t
 995 Collator::internalNextSortKeyPart(UCharIterator * /*iter*/, uint32_t /*state*/[2],
 996                                   uint8_t * /*dest*/, int32_t /*count*/, UErrorCode &amp;errorCode) const {
 997     if (U_SUCCESS(errorCode)) {
 998         errorCode = U_UNSUPPORTED_ERROR;
 999     }
1000     return 0;
1001 }
1002 
1003 // UCollator private data members ----------------------------------------
1004 
1005 /* This is useless information */
1006 /*const UVersionInfo Collator::fVersion = {1, 1, 0, 0};*/
1007 
1008 // -------------------------------------
1009 
1010 U_NAMESPACE_END
</pre>
</td>
<td>
<hr />
<pre>
 209     return gService;
 210 }
 211 
 212 // -------------------------------------
 213 
 214 static inline UBool
 215 hasService(void)
 216 {
 217     UBool retVal = !gServiceInitOnce.isReset() &amp;&amp; (getService() != NULL);
 218     return retVal;
 219 }
 220 
 221 #endif /* UCONFIG_NO_SERVICE */
 222 
 223 static void U_CALLCONV
 224 initAvailableLocaleList(UErrorCode &amp;status) {
 225     U_ASSERT(availableLocaleListCount == 0);
 226     U_ASSERT(availableLocaleList == NULL);
 227     // for now, there is a hardcoded list, so just walk through that list and set it up.
 228     UResourceBundle *index = NULL;
<span class="line-modified"> 229     StackUResourceBundle installed;</span>
 230     int32_t i = 0;
 231 

 232     index = ures_openDirect(U_ICUDATA_COLL, &quot;res_index&quot;, &amp;status);
<span class="line-modified"> 233     ures_getByKey(index, &quot;InstalledLocales&quot;, installed.getAlias(), &amp;status);</span>
 234 
 235     if(U_SUCCESS(status)) {
<span class="line-modified"> 236         availableLocaleListCount = ures_getSize(installed.getAlias());</span>
 237         availableLocaleList = new Locale[availableLocaleListCount];
 238 
 239         if (availableLocaleList != NULL) {
<span class="line-modified"> 240             ures_resetIterator(installed.getAlias());</span>
<span class="line-modified"> 241             while(ures_hasNext(installed.getAlias())) {</span>
 242                 const char *tempKey = NULL;
<span class="line-modified"> 243                 ures_getNextString(installed.getAlias(), NULL, &amp;tempKey, &amp;status);</span>
 244                 availableLocaleList[i++] = Locale(tempKey);
 245             }
 246         }
 247         U_ASSERT(availableLocaleListCount == i);

 248     }
 249     ures_close(index);
 250     ucln_i18n_registerCleanup(UCLN_I18N_COLLATOR, collator_cleanup);
 251 }
 252 
 253 static UBool isAvailableLocaleListInitialized(UErrorCode &amp;status) {
 254     umtx_initOnce(gAvailableLocaleListInitOnce, &amp;initAvailableLocaleList, status);
 255     return U_SUCCESS(status);
 256 }
 257 
 258 
 259 // Collator public methods -----------------------------------------------
 260 
 261 namespace {
 262 
 263 static const struct {
 264     const char *name;
 265     UColAttribute attr;
 266 } collAttributes[] = {
 267     { &quot;colStrength&quot;, UCOL_STRENGTH },
</pre>
<hr />
<pre>
 429 Collator* U_EXPORT2 Collator::createInstance(const Locale&amp; desiredLocale,
 430                                    UErrorCode&amp; status)
 431 {
 432     if (U_FAILURE(status))
 433         return 0;
 434     if (desiredLocale.isBogus()) {
 435         // Locale constructed from malformed locale ID or language tag.
 436         status = U_ILLEGAL_ARGUMENT_ERROR;
 437         return NULL;
 438     }
 439 
 440     Collator* coll;
 441 #if !UCONFIG_NO_SERVICE
 442     if (hasService()) {
 443         Locale actualLoc;
 444         coll = (Collator*)gService-&gt;get(desiredLocale, &amp;actualLoc, status);
 445     } else
 446 #endif
 447     {
 448         coll = makeInstance(desiredLocale, status);
<span class="line-added"> 449         // Either returns NULL with U_FAILURE(status), or non-NULL with U_SUCCESS(status)</span>
<span class="line-added"> 450     }</span>
<span class="line-added"> 451     // The use of *coll in setAttributesFromKeywords can cause the NULL check to be</span>
<span class="line-added"> 452     // optimized out of the delete even though setAttributesFromKeywords returns</span>
<span class="line-added"> 453     // immediately if U_FAILURE(status), so we add a check here.</span>
<span class="line-added"> 454     if (U_FAILURE(status)) {</span>
<span class="line-added"> 455         return NULL;</span>
 456     }
 457     setAttributesFromKeywords(desiredLocale, *coll, status);
 458     if (U_FAILURE(status)) {
 459         delete coll;
 460         return NULL;
 461     }
 462     return coll;
 463 }
 464 
 465 
 466 Collator* Collator::makeInstance(const Locale&amp;  desiredLocale, UErrorCode&amp; status) {
 467     const CollationCacheEntry *entry = CollationLoader::loadTailoring(desiredLocale, status);
 468     if (U_SUCCESS(status)) {
 469         Collator *result = new RuleBasedCollator(entry);
 470         if (result != NULL) {
 471             // Both the unified cache&#39;s get() and the RBC constructor
 472             // did addRef(). Undo one of them.
 473             entry-&gt;removeRef();
 474             return result;
 475         }
</pre>
<hr />
<pre>
 974 Collator::internalGetShortDefinitionString(const char * /*locale*/,
 975                                                              char * /*buffer*/,
 976                                                              int32_t /*capacity*/,
 977                                                              UErrorCode &amp;status) const {
 978   if(U_SUCCESS(status)) {
 979     status = U_UNSUPPORTED_ERROR; /* Shouldn&#39;t happen, internal function */
 980   }
 981   return 0;
 982 }
 983 
 984 UCollationResult
 985 Collator::internalCompareUTF8(const char *left, int32_t leftLength,
 986                               const char *right, int32_t rightLength,
 987                               UErrorCode &amp;errorCode) const {
 988     if(U_FAILURE(errorCode)) { return UCOL_EQUAL; }
 989     if((left == NULL &amp;&amp; leftLength != 0) || (right == NULL &amp;&amp; rightLength != 0)) {
 990         errorCode = U_ILLEGAL_ARGUMENT_ERROR;
 991         return UCOL_EQUAL;
 992     }
 993     return compareUTF8(
<span class="line-modified"> 994             StringPiece(left, (leftLength &lt; 0) ? static_cast&lt;int32_t&gt;(uprv_strlen(left)) : leftLength),</span>
<span class="line-modified"> 995             StringPiece(right, (rightLength &lt; 0) ? static_cast&lt;int32_t&gt;(uprv_strlen(right)) : rightLength),</span>
 996             errorCode);
 997 }
 998 
 999 int32_t
1000 Collator::internalNextSortKeyPart(UCharIterator * /*iter*/, uint32_t /*state*/[2],
1001                                   uint8_t * /*dest*/, int32_t /*count*/, UErrorCode &amp;errorCode) const {
1002     if (U_SUCCESS(errorCode)) {
1003         errorCode = U_UNSUPPORTED_ERROR;
1004     }
1005     return 0;
1006 }
1007 
1008 // UCollator private data members ----------------------------------------
1009 
1010 /* This is useless information */
1011 /*const UVersionInfo Collator::fVersion = {1, 1, 0, 0};*/
1012 
1013 // -------------------------------------
1014 
1015 U_NAMESPACE_END
</pre>
</td>
</tr>
</table>
<center><a href="chnsecal.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="collationbuilder.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>