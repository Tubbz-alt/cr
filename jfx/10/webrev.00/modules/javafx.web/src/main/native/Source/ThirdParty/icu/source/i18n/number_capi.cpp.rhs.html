<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/ThirdParty/icu/source/i18n/number_capi.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 // Â© 2018 and later: Unicode, Inc. and others.
  2 // License &amp; terms of use: http://www.unicode.org/copyright.html
  3 
  4 #include &quot;unicode/utypes.h&quot;
  5 
  6 #if !UCONFIG_NO_FORMATTING
  7 
  8 // Allow implicit conversion from char16_t* to UnicodeString for this file:
  9 // Helpful in toString methods and elsewhere.
 10 #define UNISTR_FROM_STRING_EXPLICIT
 11 
 12 #include &quot;fphdlimp.h&quot;
 13 #include &quot;number_utypes.h&quot;
 14 #include &quot;numparse_types.h&quot;
<a name="1" id="anc1"></a><span class="line-added"> 15 #include &quot;formattedval_impl.h&quot;</span>
 16 #include &quot;unicode/numberformatter.h&quot;
 17 #include &quot;unicode/unumberformatter.h&quot;
 18 
 19 using namespace icu;
 20 using namespace icu::number;
 21 using namespace icu::number::impl;
 22 
 23 
<a name="2" id="anc2"></a><span class="line-modified"> 24 U_NAMESPACE_BEGIN</span>
<span class="line-modified"> 25 namespace number {</span>
<span class="line-modified"> 26 namespace impl {</span>
 27 
<a name="3" id="anc3"></a><span class="line-modified"> 28 /**</span>
<span class="line-modified"> 29  * Implementation class for UNumberFormatter. Wraps a LocalizedNumberFormatter.</span>
<span class="line-modified"> 30  */</span>
<span class="line-modified"> 31 struct UNumberFormatterData : public UMemory,</span>
<span class="line-modified"> 32         // Magic number as ASCII == &quot;NFR&quot; (NumberFormatteR)</span>
<span class="line-added"> 33         public IcuCApiHelper&lt;UNumberFormatter, UNumberFormatterData, 0x4E465200&gt; {</span>
<span class="line-added"> 34     LocalizedNumberFormatter fFormatter;</span>
<span class="line-added"> 35 };</span>
 36 
<a name="4" id="anc4"></a><span class="line-modified"> 37 struct UFormattedNumberImpl;</span>
<span class="line-modified"> 38 </span>
<span class="line-modified"> 39 // Magic number as ASCII == &quot;FDN&quot; (FormatteDNumber)</span>
<span class="line-modified"> 40 typedef IcuCApiHelper&lt;UFormattedNumber, UFormattedNumberImpl, 0x46444E00&gt; UFormattedNumberApiHelper;</span>
<span class="line-modified"> 41 </span>
<span class="line-modified"> 42 struct UFormattedNumberImpl : public UFormattedValueImpl, public UFormattedNumberApiHelper {</span>
<span class="line-modified"> 43     UFormattedNumberImpl();</span>
<span class="line-modified"> 44     ~UFormattedNumberImpl();</span>
<span class="line-modified"> 45 </span>
<span class="line-modified"> 46     FormattedNumber fImpl;</span>
<span class="line-modified"> 47     UFormattedNumberData fData;</span>
<span class="line-modified"> 48 };</span>
<span class="line-modified"> 49 </span>
<span class="line-modified"> 50 UFormattedNumberImpl::UFormattedNumberImpl()</span>
<span class="line-modified"> 51         : fImpl(&amp;fData) {</span>
<span class="line-added"> 52     fFormattedValue = &amp;fImpl;</span>
 53 }
 54 
<a name="5" id="anc5"></a><span class="line-modified"> 55 UFormattedNumberImpl::~UFormattedNumberImpl() {</span>
<span class="line-modified"> 56     // Disown the data from fImpl so it doesn&#39;t get deleted twice</span>
<span class="line-added"> 57     fImpl.fData = nullptr;</span>
 58 }
 59 
<a name="6" id="anc6"></a>



 60 }
<a name="7" id="anc7"></a><span class="line-added"> 61 }</span>
<span class="line-added"> 62 U_NAMESPACE_END</span>
<span class="line-added"> 63 </span>
<span class="line-added"> 64 </span>
<span class="line-added"> 65 UPRV_FORMATTED_VALUE_CAPI_NO_IMPLTYPE_AUTO_IMPL(</span>
<span class="line-added"> 66     UFormattedNumber,</span>
<span class="line-added"> 67     UFormattedNumberImpl,</span>
<span class="line-added"> 68     UFormattedNumberApiHelper,</span>
<span class="line-added"> 69     unumf)</span>
<span class="line-added"> 70 </span>
 71 
<a name="8" id="anc8"></a><span class="line-modified"> 72 const DecimalQuantity* icu::number::impl::validateUFormattedNumberToDecimalQuantity(</span>
<span class="line-modified"> 73         const UFormattedNumber* uresult, UErrorCode&amp; status) {</span>
<span class="line-added"> 74     auto* result = UFormattedNumberApiHelper::validate(uresult, status);</span>
 75     if (U_FAILURE(status)) {
 76         return nullptr;
 77     }
<a name="9" id="anc9"></a><span class="line-modified"> 78     return &amp;result-&gt;fData.quantity;</span>









 79 }
 80 
<a name="10" id="anc10"></a>






 81 
 82 
 83 U_CAPI UNumberFormatter* U_EXPORT2
 84 unumf_openForSkeletonAndLocale(const UChar* skeleton, int32_t skeletonLen, const char* locale,
 85                                UErrorCode* ec) {
 86     auto* impl = new UNumberFormatterData();
 87     if (impl == nullptr) {
 88         *ec = U_MEMORY_ALLOCATION_ERROR;
 89         return nullptr;
 90     }
 91     // Readonly-alias constructor (first argument is whether we are NUL-terminated)
 92     UnicodeString skeletonString(skeletonLen == -1, skeleton, skeletonLen);
 93     impl-&gt;fFormatter = NumberFormatter::forSkeleton(skeletonString, *ec).locale(locale);
 94     return impl-&gt;exportForC();
 95 }
 96 
<a name="11" id="anc11"></a><span class="line-modified"> 97 U_CAPI UNumberFormatter* U_EXPORT2</span>
<span class="line-modified"> 98 unumf_openForSkeletonAndLocaleWithError(const UChar* skeleton, int32_t skeletonLen, const char* locale,</span>
<span class="line-modified"> 99                                          UParseError* perror, UErrorCode* ec) {</span>
<span class="line-added">100     auto* impl = new UNumberFormatterData();</span>
101     if (impl == nullptr) {
102         *ec = U_MEMORY_ALLOCATION_ERROR;
103         return nullptr;
104     }
<a name="12" id="anc12"></a><span class="line-added">105     // Readonly-alias constructor (first argument is whether we are NUL-terminated)</span>
<span class="line-added">106     UnicodeString skeletonString(skeletonLen == -1, skeleton, skeletonLen);</span>
<span class="line-added">107     impl-&gt;fFormatter = NumberFormatter::forSkeleton(skeletonString, *perror, *ec).locale(locale);</span>
108     return impl-&gt;exportForC();
109 }
110 
111 U_CAPI void U_EXPORT2
112 unumf_formatInt(const UNumberFormatter* uformatter, int64_t value, UFormattedNumber* uresult,
113                 UErrorCode* ec) {
114     const UNumberFormatterData* formatter = UNumberFormatterData::validate(uformatter, *ec);
<a name="13" id="anc13"></a><span class="line-modified">115     auto* result = UFormattedNumberApiHelper::validate(uresult, *ec);</span>
116     if (U_FAILURE(*ec)) { return; }
117 
<a name="14" id="anc14"></a><span class="line-modified">118     result-&gt;fData.getStringRef().clear();</span>
<span class="line-modified">119     result-&gt;fData.quantity.setToLong(value);</span>
<span class="line-modified">120     formatter-&gt;fFormatter.formatImpl(&amp;result-&gt;fData, *ec);</span>
121 }
122 
123 U_CAPI void U_EXPORT2
124 unumf_formatDouble(const UNumberFormatter* uformatter, double value, UFormattedNumber* uresult,
125                    UErrorCode* ec) {
126     const UNumberFormatterData* formatter = UNumberFormatterData::validate(uformatter, *ec);
<a name="15" id="anc15"></a><span class="line-modified">127     auto* result = UFormattedNumberApiHelper::validate(uresult, *ec);</span>
128     if (U_FAILURE(*ec)) { return; }
129 
<a name="16" id="anc16"></a><span class="line-modified">130     result-&gt;fData.getStringRef().clear();</span>
<span class="line-modified">131     result-&gt;fData.quantity.setToDouble(value);</span>
<span class="line-modified">132     formatter-&gt;fFormatter.formatImpl(&amp;result-&gt;fData, *ec);</span>
133 }
134 
135 U_CAPI void U_EXPORT2
136 unumf_formatDecimal(const UNumberFormatter* uformatter, const char* value, int32_t valueLen,
137                     UFormattedNumber* uresult, UErrorCode* ec) {
138     const UNumberFormatterData* formatter = UNumberFormatterData::validate(uformatter, *ec);
<a name="17" id="anc17"></a><span class="line-modified">139     auto* result = UFormattedNumberApiHelper::validate(uresult, *ec);</span>
140     if (U_FAILURE(*ec)) { return; }
141 
<a name="18" id="anc18"></a><span class="line-modified">142     result-&gt;fData.getStringRef().clear();</span>
<span class="line-modified">143     result-&gt;fData.quantity.setToDecNumber({value, valueLen}, *ec);</span>
144     if (U_FAILURE(*ec)) { return; }
<a name="19" id="anc19"></a><span class="line-modified">145     formatter-&gt;fFormatter.formatImpl(&amp;result-&gt;fData, *ec);</span>
146 }
147 
148 U_CAPI int32_t U_EXPORT2
149 unumf_resultToString(const UFormattedNumber* uresult, UChar* buffer, int32_t bufferCapacity,
150                      UErrorCode* ec) {
<a name="20" id="anc20"></a><span class="line-modified">151     const auto* result = UFormattedNumberApiHelper::validate(uresult, *ec);</span>
152     if (U_FAILURE(*ec)) { return 0; }
153 
154     if (buffer == nullptr ? bufferCapacity != 0 : bufferCapacity &lt; 0) {
155         *ec = U_ILLEGAL_ARGUMENT_ERROR;
156         return 0;
157     }
158 
<a name="21" id="anc21"></a><span class="line-modified">159     return result-&gt;fImpl.toTempString(*ec).extract(buffer, bufferCapacity, *ec);</span>
160 }
161 
162 U_CAPI UBool U_EXPORT2
163 unumf_resultNextFieldPosition(const UFormattedNumber* uresult, UFieldPosition* ufpos, UErrorCode* ec) {
<a name="22" id="anc22"></a><span class="line-modified">164     const auto* result = UFormattedNumberApiHelper::validate(uresult, *ec);</span>
165     if (U_FAILURE(*ec)) { return FALSE; }
166 
167     if (ufpos == nullptr) {
168         *ec = U_ILLEGAL_ARGUMENT_ERROR;
169         return FALSE;
170     }
171 
172     FieldPosition fp;
173     fp.setField(ufpos-&gt;field);
174     fp.setBeginIndex(ufpos-&gt;beginIndex);
175     fp.setEndIndex(ufpos-&gt;endIndex);
<a name="23" id="anc23"></a><span class="line-modified">176     bool retval = result-&gt;fImpl.nextFieldPosition(fp, *ec);</span>
177     ufpos-&gt;beginIndex = fp.getBeginIndex();
178     ufpos-&gt;endIndex = fp.getEndIndex();
179     // NOTE: MSVC sometimes complains when implicitly converting between bool and UBool
180     return retval ? TRUE : FALSE;
181 }
182 
183 U_CAPI void U_EXPORT2
184 unumf_resultGetAllFieldPositions(const UFormattedNumber* uresult, UFieldPositionIterator* ufpositer,
185                                  UErrorCode* ec) {
<a name="24" id="anc24"></a><span class="line-modified">186     const auto* result = UFormattedNumberApiHelper::validate(uresult, *ec);</span>
187     if (U_FAILURE(*ec)) { return; }
188 
189     if (ufpositer == nullptr) {
190         *ec = U_ILLEGAL_ARGUMENT_ERROR;
191         return;
192     }
193 
194     auto* fpi = reinterpret_cast&lt;FieldPositionIterator*&gt;(ufpositer);
<a name="25" id="anc25"></a><span class="line-modified">195     result-&gt;fImpl.getAllFieldPositions(*fpi, *ec);</span>








196 }
197 
198 U_CAPI void U_EXPORT2
199 unumf_close(UNumberFormatter* f) {
200     UErrorCode localStatus = U_ZERO_ERROR;
201     const UNumberFormatterData* impl = UNumberFormatterData::validate(f, localStatus);
202     delete impl;
203 }
204 
205 
206 #endif /* #if !UCONFIG_NO_FORMATTING */
207 
208 
209 
210 
211 
212 
213 
214 
215 
216 
217 
218 
219 
220 
221 
222 
223 
224 
225 
226 
227 
228 
229 
230 
231 
232 
233 
<a name="26" id="anc26"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="26" type="hidden" />
</body>
</html>