<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/ThirdParty/icu/source/common/loclikely.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="locid.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="locmap.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/ThirdParty/icu/source/common/loclikely.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -17,22 +17,32 @@</span>
  *
  *   Code for likely and minimized locale subtags, separated out from other .cpp files
  *   that then do not depend on resource bundle code and likely-subtags data.
  */
  
<span class="udiff-line-added">+ #include &quot;unicode/bytestream.h&quot;</span>
  #include &quot;unicode/utypes.h&quot;
  #include &quot;unicode/locid.h&quot;
  #include &quot;unicode/putil.h&quot;
  #include &quot;unicode/uchar.h&quot;
  #include &quot;unicode/uloc.h&quot;
<span class="udiff-line-added">+ #include &quot;bytesinkutil.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;charstr.h&quot;</span>
  #include &quot;cmemory.h&quot;
  #include &quot;cstring.h&quot;
  #include &quot;ulocimp.h&quot;
  #include &quot;ustr_imp.h&quot;
  
<span class="udiff-line-added">+ /**</span>
<span class="udiff-line-added">+  * These are the canonical strings for unknown languages, scripts and regions.</span>
<span class="udiff-line-added">+  **/</span>
<span class="udiff-line-added">+ static const char* const unknownLanguage = &quot;und&quot;;</span>
<span class="udiff-line-added">+ static const char* const unknownScript = &quot;Zzzz&quot;;</span>
<span class="udiff-line-added">+ static const char* const unknownRegion = &quot;ZZ&quot;;</span>
<span class="udiff-line-added">+ </span>
  /**
   * This function looks for the localeID in the likelySubtags resource.
   *
   * @param localeID The tag to find.
   * @param buffer A buffer to hold the matching entry
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -48,13 +58,26 @@</span>
  
      if (!U_FAILURE(*err)) {
          int32_t resLen = 0;
          const UChar* s = NULL;
          UErrorCode tmpErr = U_ZERO_ERROR;
<span class="udiff-line-modified-removed">-         UResourceBundle* subtags = ures_openDirect(NULL, &quot;likelySubtags&quot;, &amp;tmpErr);</span>
<span class="udiff-line-modified-added">+         icu::LocalUResourceBundlePointer subtags(ures_openDirect(NULL, &quot;likelySubtags&quot;, &amp;tmpErr));</span>
          if (U_SUCCESS(tmpErr)) {
<span class="udiff-line-modified-removed">-             s = ures_getStringByKey(subtags, localeID, &amp;resLen, &amp;tmpErr);</span>
<span class="udiff-line-modified-added">+             icu::CharString und;</span>
<span class="udiff-line-added">+             if (localeID != NULL) {</span>
<span class="udiff-line-added">+                 if (*localeID == &#39;\0&#39;) {</span>
<span class="udiff-line-added">+                     localeID = unknownLanguage;</span>
<span class="udiff-line-added">+                 } else if (*localeID == &#39;_&#39;) {</span>
<span class="udiff-line-added">+                     und.append(unknownLanguage, *err);</span>
<span class="udiff-line-added">+                     und.append(localeID, *err);</span>
<span class="udiff-line-added">+                     if (U_FAILURE(*err)) {</span>
<span class="udiff-line-added">+                         return NULL;</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                     localeID = und.data();</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             s = ures_getStringByKey(subtags.getAlias(), localeID, &amp;resLen, &amp;tmpErr);</span>
  
              if (U_FAILURE(tmpErr)) {
                  /*
                   * If a resource is missing, it&#39;s not really an error, it&#39;s
                   * just that we don&#39;t have any data for that particular locale ID.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -67,14 +90,17 @@</span>
                  /* The buffer should never overflow. */
                  *err = U_INTERNAL_PROGRAM_ERROR;
              }
              else {
                  u_UCharsToChars(s, buffer, resLen + 1);
<span class="udiff-line-added">+                 if (resLen &gt;= 3 &amp;&amp;</span>
<span class="udiff-line-added">+                     uprv_strnicmp(buffer, unknownLanguage, 3) == 0 &amp;&amp;</span>
<span class="udiff-line-added">+                     (resLen == 3 || buffer[3] == &#39;_&#39;)) {</span>
<span class="udiff-line-added">+                     uprv_memmove(buffer, buffer + 3, resLen - 3 + 1);</span>
<span class="udiff-line-added">+                 }</span>
                  result = buffer;
              }
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             ures_close(subtags);</span>
          } else {
              *err = tmpErr;
          }
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -94,13 +120,14 @@</span>
  static void U_CALLCONV
  appendTag(
      const char* tag,
      int32_t tagLength,
      char* buffer,
<span class="udiff-line-modified-removed">-     int32_t* bufferLength) {</span>
<span class="udiff-line-modified-added">+     int32_t* bufferLength,</span>
<span class="udiff-line-added">+     UBool withSeparator) {</span>
  
<span class="udiff-line-modified-removed">-     if (*bufferLength &gt; 0) {</span>
<span class="udiff-line-modified-added">+     if (withSeparator) {</span>
          buffer[*bufferLength] = &#39;_&#39;;
          ++(*bufferLength);
      }
  
      uprv_memmove(
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -109,17 +136,10 @@</span>
          tagLength);
  
      *bufferLength += tagLength;
  }
  
<span class="udiff-line-removed">- /**</span>
<span class="udiff-line-removed">-  * These are the canonical strings for unknown languages, scripts and regions.</span>
<span class="udiff-line-removed">-  **/</span>
<span class="udiff-line-removed">- static const char* const unknownLanguage = &quot;und&quot;;</span>
<span class="udiff-line-removed">- static const char* const unknownScript = &quot;Zzzz&quot;;</span>
<span class="udiff-line-removed">- static const char* const unknownRegion = &quot;ZZ&quot;;</span>
<span class="udiff-line-removed">- </span>
  /**
   * Create a tag string from the supplied parameters.  The lang, script and region
   * parameters may be NULL pointers. If they are, their corresponding length parameters
   * must be less than or equal to 0.
   *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -145,36 +165,31 @@</span>
   * @param region The region tag to use.
   * @param regionLength The length of the region tag.
   * @param trailing Any trailing data to append to the new tag.
   * @param trailingLength The length of the trailing data.
   * @param alternateTags A string containing any alternate tags.
<span class="udiff-line-modified-removed">-  * @param tag The output buffer.</span>
<span class="udiff-line-removed">-  * @param tagCapacity The capacity of the output buffer.</span>
<span class="udiff-line-modified-added">+  * @param sink The output sink receiving the tag string.</span>
   * @param err A pointer to a UErrorCode for error reporting.
<span class="udiff-line-removed">-  * @return The length of the tag string, which may be greater than tagCapacity, or -1 on error.</span>
   **/
<span class="udiff-line-modified-removed">- static int32_t U_CALLCONV</span>
<span class="udiff-line-modified-added">+ static void U_CALLCONV</span>
  createTagStringWithAlternates(
      const char* lang,
      int32_t langLength,
      const char* script,
      int32_t scriptLength,
      const char* region,
      int32_t regionLength,
      const char* trailing,
      int32_t trailingLength,
      const char* alternateTags,
<span class="udiff-line-modified-removed">-     char* tag,</span>
<span class="udiff-line-removed">-     int32_t tagCapacity,</span>
<span class="udiff-line-modified-added">+     icu::ByteSink&amp; sink,</span>
      UErrorCode* err) {
  
      if (U_FAILURE(*err)) {
          goto error;
      }
<span class="udiff-line-modified-removed">-     else if (tag == NULL ||</span>
<span class="udiff-line-removed">-              tagCapacity &lt;= 0 ||</span>
<span class="udiff-line-removed">-              langLength &gt;= ULOC_LANG_CAPACITY ||</span>
<span class="udiff-line-modified-added">+     else if (langLength &gt;= ULOC_LANG_CAPACITY ||</span>
               scriptLength &gt;= ULOC_SCRIPT_CAPACITY ||
               regionLength &gt;= ULOC_COUNTRY_CAPACITY) {
          goto error;
      }
      else {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -184,30 +199,25 @@</span>
           * script and region code without worrying about overrunning
           * the user-supplied buffer.
           **/
          char tagBuffer[ULOC_FULLNAME_CAPACITY];
          int32_t tagLength = 0;
<span class="udiff-line-removed">-         int32_t capacityRemaining = tagCapacity;</span>
          UBool regionAppended = FALSE;
  
          if (langLength &gt; 0) {
              appendTag(
                  lang,
                  langLength,
                  tagBuffer,
<span class="udiff-line-modified-removed">-                 &amp;tagLength);</span>
<span class="udiff-line-modified-added">+                 &amp;tagLength,</span>
<span class="udiff-line-added">+                 /*withSeparator=*/FALSE);</span>
          }
          else if (alternateTags == NULL) {
              /*
<span class="udiff-line-modified-removed">-              * Append the value for an unknown language, if</span>
<span class="udiff-line-modified-added">+              * Use the empty string for an unknown language, if</span>
               * we found no language.
               */
<span class="udiff-line-removed">-             appendTag(</span>
<span class="udiff-line-removed">-                 unknownLanguage,</span>
<span class="udiff-line-removed">-                 (int32_t)uprv_strlen(unknownLanguage),</span>
<span class="udiff-line-removed">-                 tagBuffer,</span>
<span class="udiff-line-removed">-                 &amp;tagLength);</span>
          }
          else {
              /*
               * Parse the alternateTags string for the language.
               */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -224,34 +234,31 @@</span>
                  alternateLangLength &gt;= ULOC_LANG_CAPACITY) {
                  goto error;
              }
              else if (alternateLangLength == 0) {
                  /*
<span class="udiff-line-modified-removed">-                  * Append the value for an unknown language, if</span>
<span class="udiff-line-modified-added">+                  * Use the empty string for an unknown language, if</span>
                   * we found no language.
                   */
<span class="udiff-line-removed">-                 appendTag(</span>
<span class="udiff-line-removed">-                     unknownLanguage,</span>
<span class="udiff-line-removed">-                     (int32_t)uprv_strlen(unknownLanguage),</span>
<span class="udiff-line-removed">-                     tagBuffer,</span>
<span class="udiff-line-removed">-                     &amp;tagLength);</span>
              }
              else {
                  appendTag(
                      alternateLang,
                      alternateLangLength,
                      tagBuffer,
<span class="udiff-line-modified-removed">-                     &amp;tagLength);</span>
<span class="udiff-line-modified-added">+                     &amp;tagLength,</span>
<span class="udiff-line-added">+                     /*withSeparator=*/FALSE);</span>
              }
          }
  
          if (scriptLength &gt; 0) {
              appendTag(
                  script,
                  scriptLength,
                  tagBuffer,
<span class="udiff-line-modified-removed">-                 &amp;tagLength);</span>
<span class="udiff-line-modified-added">+                 &amp;tagLength,</span>
<span class="udiff-line-added">+                 /*withSeparator=*/TRUE);</span>
          }
          else if (alternateTags != NULL) {
              /*
               * Parse the alternateTags string for the script.
               */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -271,20 +278,22 @@</span>
              else if (alternateScriptLength &gt; 0) {
                  appendTag(
                      alternateScript,
                      alternateScriptLength,
                      tagBuffer,
<span class="udiff-line-modified-removed">-                     &amp;tagLength);</span>
<span class="udiff-line-modified-added">+                     &amp;tagLength,</span>
<span class="udiff-line-added">+                     /*withSeparator=*/TRUE);</span>
              }
          }
  
          if (regionLength &gt; 0) {
              appendTag(
                  region,
                  regionLength,
                  tagBuffer,
<span class="udiff-line-modified-removed">-                 &amp;tagLength);</span>
<span class="udiff-line-modified-added">+                 &amp;tagLength,</span>
<span class="udiff-line-added">+                 /*withSeparator=*/TRUE);</span>
  
              regionAppended = TRUE;
          }
          else if (alternateTags != NULL) {
              /*
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -305,65 +314,39 @@</span>
              else if (alternateRegionLength &gt; 0) {
                  appendTag(
                      alternateRegion,
                      alternateRegionLength,
                      tagBuffer,
<span class="udiff-line-modified-removed">-                     &amp;tagLength);</span>
<span class="udiff-line-modified-added">+                     &amp;tagLength,</span>
<span class="udiff-line-added">+                     /*withSeparator=*/TRUE);</span>
  
                  regionAppended = TRUE;
              }
          }
  
<span class="udiff-line-modified-removed">-         {</span>
<span class="udiff-line-modified-removed">-             const int32_t toCopy =</span>
<span class="udiff-line-modified-removed">-                 tagLength &gt;= tagCapacity ? tagCapacity : tagLength;</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-             /**</span>
<span class="udiff-line-removed">-              * Copy the partial tag from our internal buffer to the supplied</span>
<span class="udiff-line-removed">-              * target.</span>
<span class="udiff-line-removed">-              **/</span>
<span class="udiff-line-removed">-             uprv_memcpy(</span>
<span class="udiff-line-removed">-                 tag,</span>
<span class="udiff-line-removed">-                 tagBuffer,</span>
<span class="udiff-line-removed">-                 toCopy);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             capacityRemaining -= toCopy;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+         /**</span>
<span class="udiff-line-modified-added">+          * Copy the partial tag from our internal buffer to the supplied</span>
<span class="udiff-line-modified-added">+          * target.</span>
<span class="udiff-line-modified-added">+          **/</span>
<span class="udiff-line-modified-added">+         sink.Append(tagBuffer, tagLength);</span>
  
          if (trailingLength &gt; 0) {
<span class="udiff-line-modified-removed">-             if (*trailing != &#39;@&#39; &amp;&amp; capacityRemaining &gt; 0) {</span>
<span class="udiff-line-modified-removed">-                 tag[tagLength++] = &#39;_&#39;;</span>
<span class="udiff-line-modified-removed">-                 --capacityRemaining;</span>
<span class="udiff-line-removed">-                 if (capacityRemaining &gt; 0 &amp;&amp; !regionAppended) {</span>
<span class="udiff-line-modified-added">+             if (*trailing != &#39;@&#39;) {</span>
<span class="udiff-line-modified-added">+                 sink.Append(&quot;_&quot;, 1);</span>
<span class="udiff-line-modified-added">+                 if (!regionAppended) {</span>
                      /* extra separator is required */
<span class="udiff-line-modified-removed">-                     tag[tagLength++] = &#39;_&#39;;</span>
<span class="udiff-line-removed">-                     --capacityRemaining;</span>
<span class="udiff-line-modified-added">+                     sink.Append(&quot;_&quot;, 1);</span>
                  }
              }
  
<span class="udiff-line-modified-removed">-             if (capacityRemaining &gt; 0) {</span>
<span class="udiff-line-modified-removed">-                 /*</span>
<span class="udiff-line-modified-removed">-                  * Copy the trailing data into the supplied buffer.  Use uprv_memmove, since we</span>
<span class="udiff-line-modified-removed">-                  * don&#39;t know if the user-supplied buffers overlap.</span>
<span class="udiff-line-removed">-                  */</span>
<span class="udiff-line-removed">-                 const int32_t toCopy =</span>
<span class="udiff-line-removed">-                     trailingLength &gt;= capacityRemaining ? capacityRemaining : trailingLength;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                 uprv_memmove(</span>
<span class="udiff-line-removed">-                     &amp;tag[tagLength],</span>
<span class="udiff-line-removed">-                     trailing,</span>
<span class="udiff-line-removed">-                     toCopy);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-modified-added">+             /*</span>
<span class="udiff-line-modified-added">+              * Copy the trailing data into the supplied buffer.</span>
<span class="udiff-line-modified-added">+              */</span>
<span class="udiff-line-modified-added">+             sink.Append(trailing, trailingLength);</span>
          }
  
<span class="udiff-line-modified-removed">-         tagLength += trailingLength;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         return u_terminateChars(</span>
<span class="udiff-line-removed">-                     tag,</span>
<span class="udiff-line-removed">-                     tagCapacity,</span>
<span class="udiff-line-removed">-                     tagLength,</span>
<span class="udiff-line-removed">-                     err);</span>
<span class="udiff-line-modified-added">+         return;</span>
      }
  
  error:
  
      /**
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -373,12 +356,10 @@</span>
       **/
      if (*err ==  U_BUFFER_OVERFLOW_ERROR ||
          U_SUCCESS(*err)) {
          *err = U_ILLEGAL_ARGUMENT_ERROR;
      }
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     return -1;</span>
  }
  
  /**
   * Create a tag string from the supplied parameters.  The lang, script and region
   * parameters may be NULL pointers. If they are, their corresponding length parameters
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -398,41 +379,37 @@</span>
   * @param scriptLength The length of the script tag.
   * @param region The region tag to use.
   * @param regionLength The length of the region tag.
   * @param trailing Any trailing data to append to the new tag.
   * @param trailingLength The length of the trailing data.
<span class="udiff-line-modified-removed">-  * @param tag The output buffer.</span>
<span class="udiff-line-removed">-  * @param tagCapacity The capacity of the output buffer.</span>
<span class="udiff-line-modified-added">+  * @param sink The output sink receiving the tag string.</span>
   * @param err A pointer to a UErrorCode for error reporting.
<span class="udiff-line-removed">-  * @return The length of the tag string, which may be greater than tagCapacity.</span>
   **/
<span class="udiff-line-modified-removed">- static int32_t U_CALLCONV</span>
<span class="udiff-line-modified-added">+ static void U_CALLCONV</span>
  createTagString(
      const char* lang,
      int32_t langLength,
      const char* script,
      int32_t scriptLength,
      const char* region,
      int32_t regionLength,
      const char* trailing,
      int32_t trailingLength,
<span class="udiff-line-modified-removed">-     char* tag,</span>
<span class="udiff-line-removed">-     int32_t tagCapacity,</span>
<span class="udiff-line-modified-added">+     icu::ByteSink&amp; sink,</span>
      UErrorCode* err)
  {
<span class="udiff-line-modified-removed">-     return createTagStringWithAlternates(</span>
<span class="udiff-line-modified-added">+     createTagStringWithAlternates(</span>
                  lang,
                  langLength,
                  script,
                  scriptLength,
                  region,
                  regionLength,
                  trailing,
                  trailingLength,
                  NULL,
<span class="udiff-line-modified-removed">-                 tag,</span>
<span class="udiff-line-removed">-                 tagCapacity,</span>
<span class="udiff-line-modified-added">+                 sink,</span>
                  err);
  }
  
  /**
   * Parse the language, script, and region subtags from a tag string, and copy the
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -500,19 +477,13 @@</span>
      }
  
      *langLength = subtagLength;
  
      /*
<span class="udiff-line-modified-removed">-      * If no language was present, use the value of unknownLanguage</span>
<span class="udiff-line-modified-removed">-      * instead.  Otherwise, move past any separator.</span>
<span class="udiff-line-modified-added">+      * If no language was present, use the empty string instead.</span>
<span class="udiff-line-modified-added">+      * Otherwise, move past any separator.</span>
       */
<span class="udiff-line-removed">-     if (*langLength == 0) {</span>
<span class="udiff-line-removed">-         uprv_strcpy(</span>
<span class="udiff-line-removed">-             lang,</span>
<span class="udiff-line-removed">-             unknownLanguage);</span>
<span class="udiff-line-removed">-         *langLength = (int32_t)uprv_strlen(lang);</span>
<span class="udiff-line-removed">-     }</span>
      if (_isIDSeparator(*position)) {
          ++position;
      }
  
      subtagLength = ulocimp_getScript(position, script, *scriptLength, &amp;position);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -576,31 +547,28 @@</span>
      }
  
      goto exit;
  }
  
<span class="udiff-line-modified-removed">- static int32_t U_CALLCONV</span>
<span class="udiff-line-modified-added">+ static UBool U_CALLCONV</span>
  createLikelySubtagsString(
      const char* lang,
      int32_t langLength,
      const char* script,
      int32_t scriptLength,
      const char* region,
      int32_t regionLength,
      const char* variants,
      int32_t variantsLength,
<span class="udiff-line-modified-removed">-     char* tag,</span>
<span class="udiff-line-modified-removed">-     int32_t tagCapacity,</span>
<span class="udiff-line-removed">-     UErrorCode* err)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+     icu::ByteSink&amp; sink,</span>
<span class="udiff-line-modified-added">+     UErrorCode* err) {</span>
      /**
       * ULOC_FULLNAME_CAPACITY will provide enough capacity
       * that we can build a string that contains the language,
       * script and region code without worrying about overrunning
       * the user-supplied buffer.
<span class="udiff-line-removed">-     char tagBuffer[ULOC_FULLNAME_CAPACITY];</span>
      char likelySubtagsBuffer[ULOC_FULLNAME_CAPACITY];
  
      if(U_FAILURE(*err)) {
          goto error;
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -610,29 +578,32 @@</span>
       **/
      if (scriptLength &gt; 0 &amp;&amp; regionLength &gt; 0) {
  
          const char* likelySubtags = NULL;
  
<span class="udiff-line-modified-removed">-         createTagString(</span>
<span class="udiff-line-modified-removed">-             lang,</span>
<span class="udiff-line-modified-removed">-             langLength,</span>
<span class="udiff-line-modified-removed">-             script,</span>
<span class="udiff-line-modified-removed">-             scriptLength,</span>
<span class="udiff-line-modified-removed">-             region,</span>
<span class="udiff-line-modified-removed">-             regionLength,</span>
<span class="udiff-line-modified-removed">-             NULL,</span>
<span class="udiff-line-modified-removed">-             0,</span>
<span class="udiff-line-modified-removed">-             tagBuffer,</span>
<span class="udiff-line-modified-removed">-             sizeof(tagBuffer),</span>
<span class="udiff-line-modified-removed">-             err);</span>
<span class="udiff-line-modified-added">+         icu::CharString tagBuffer;</span>
<span class="udiff-line-modified-added">+         {</span>
<span class="udiff-line-modified-added">+             icu::CharStringByteSink sink(&amp;tagBuffer);</span>
<span class="udiff-line-modified-added">+             createTagString(</span>
<span class="udiff-line-modified-added">+                 lang,</span>
<span class="udiff-line-modified-added">+                 langLength,</span>
<span class="udiff-line-modified-added">+                 script,</span>
<span class="udiff-line-modified-added">+                 scriptLength,</span>
<span class="udiff-line-modified-added">+                 region,</span>
<span class="udiff-line-modified-added">+                 regionLength,</span>
<span class="udiff-line-modified-added">+                 NULL,</span>
<span class="udiff-line-modified-added">+                 0,</span>
<span class="udiff-line-added">+                 sink,</span>
<span class="udiff-line-added">+                 err);</span>
<span class="udiff-line-added">+         }</span>
          if(U_FAILURE(*err)) {
              goto error;
          }
  
          likelySubtags =
              findLikelySubtags(
<span class="udiff-line-modified-removed">-                 tagBuffer,</span>
<span class="udiff-line-modified-added">+                 tagBuffer.data(),</span>
                  likelySubtagsBuffer,
                  sizeof(likelySubtagsBuffer),
                  err);
          if(U_FAILURE(*err)) {
              goto error;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -640,52 +611,55 @@</span>
  
          if (likelySubtags != NULL) {
              /* Always use the language tag from the
                 maximal string, since it may be more
                 specific than the one provided. */
<span class="udiff-line-modified-removed">-             return createTagStringWithAlternates(</span>
<span class="udiff-line-modified-added">+             createTagStringWithAlternates(</span>
                          NULL,
                          0,
                          NULL,
                          0,
                          NULL,
                          0,
                          variants,
                          variantsLength,
                          likelySubtags,
<span class="udiff-line-modified-removed">-                         tag,</span>
<span class="udiff-line-removed">-                         tagCapacity,</span>
<span class="udiff-line-modified-added">+                         sink,</span>
                          err);
<span class="udiff-line-added">+             return TRUE;</span>
          }
      }
  
      /**
       * Try the language with just the script.
       **/
      if (scriptLength &gt; 0) {
  
          const char* likelySubtags = NULL;
  
<span class="udiff-line-modified-removed">-         createTagString(</span>
<span class="udiff-line-modified-removed">-             lang,</span>
<span class="udiff-line-modified-removed">-             langLength,</span>
<span class="udiff-line-modified-removed">-             script,</span>
<span class="udiff-line-modified-removed">-             scriptLength,</span>
<span class="udiff-line-modified-removed">-             NULL,</span>
<span class="udiff-line-modified-removed">-             0,</span>
<span class="udiff-line-modified-removed">-             NULL,</span>
<span class="udiff-line-modified-removed">-             0,</span>
<span class="udiff-line-modified-removed">-             tagBuffer,</span>
<span class="udiff-line-modified-removed">-             sizeof(tagBuffer),</span>
<span class="udiff-line-modified-removed">-             err);</span>
<span class="udiff-line-modified-added">+         icu::CharString tagBuffer;</span>
<span class="udiff-line-modified-added">+         {</span>
<span class="udiff-line-modified-added">+             icu::CharStringByteSink sink(&amp;tagBuffer);</span>
<span class="udiff-line-modified-added">+             createTagString(</span>
<span class="udiff-line-modified-added">+                 lang,</span>
<span class="udiff-line-modified-added">+                 langLength,</span>
<span class="udiff-line-modified-added">+                 script,</span>
<span class="udiff-line-modified-added">+                 scriptLength,</span>
<span class="udiff-line-modified-added">+                 NULL,</span>
<span class="udiff-line-modified-added">+                 0,</span>
<span class="udiff-line-modified-added">+                 NULL,</span>
<span class="udiff-line-modified-added">+                 0,</span>
<span class="udiff-line-added">+                 sink,</span>
<span class="udiff-line-added">+                 err);</span>
<span class="udiff-line-added">+         }</span>
          if(U_FAILURE(*err)) {
              goto error;
          }
  
          likelySubtags =
              findLikelySubtags(
<span class="udiff-line-modified-removed">-                 tagBuffer,</span>
<span class="udiff-line-modified-added">+                 tagBuffer.data(),</span>
                  likelySubtagsBuffer,
                  sizeof(likelySubtagsBuffer),
                  err);
          if(U_FAILURE(*err)) {
              goto error;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -693,52 +667,55 @@</span>
  
          if (likelySubtags != NULL) {
              /* Always use the language tag from the
                 maximal string, since it may be more
                 specific than the one provided. */
<span class="udiff-line-modified-removed">-             return createTagStringWithAlternates(</span>
<span class="udiff-line-modified-added">+             createTagStringWithAlternates(</span>
                          NULL,
                          0,
                          NULL,
                          0,
                          region,
                          regionLength,
                          variants,
                          variantsLength,
                          likelySubtags,
<span class="udiff-line-modified-removed">-                         tag,</span>
<span class="udiff-line-removed">-                         tagCapacity,</span>
<span class="udiff-line-modified-added">+                         sink,</span>
                          err);
<span class="udiff-line-added">+             return TRUE;</span>
          }
      }
  
      /**
       * Try the language with just the region.
       **/
      if (regionLength &gt; 0) {
  
          const char* likelySubtags = NULL;
  
<span class="udiff-line-modified-removed">-         createTagString(</span>
<span class="udiff-line-modified-removed">-             lang,</span>
<span class="udiff-line-modified-removed">-             langLength,</span>
<span class="udiff-line-modified-removed">-             NULL,</span>
<span class="udiff-line-modified-removed">-             0,</span>
<span class="udiff-line-modified-removed">-             region,</span>
<span class="udiff-line-modified-removed">-             regionLength,</span>
<span class="udiff-line-modified-removed">-             NULL,</span>
<span class="udiff-line-modified-removed">-             0,</span>
<span class="udiff-line-modified-removed">-             tagBuffer,</span>
<span class="udiff-line-modified-removed">-             sizeof(tagBuffer),</span>
<span class="udiff-line-modified-removed">-             err);</span>
<span class="udiff-line-modified-added">+         icu::CharString tagBuffer;</span>
<span class="udiff-line-modified-added">+         {</span>
<span class="udiff-line-modified-added">+             icu::CharStringByteSink sink(&amp;tagBuffer);</span>
<span class="udiff-line-modified-added">+             createTagString(</span>
<span class="udiff-line-modified-added">+                 lang,</span>
<span class="udiff-line-modified-added">+                 langLength,</span>
<span class="udiff-line-modified-added">+                 NULL,</span>
<span class="udiff-line-modified-added">+                 0,</span>
<span class="udiff-line-modified-added">+                 region,</span>
<span class="udiff-line-modified-added">+                 regionLength,</span>
<span class="udiff-line-modified-added">+                 NULL,</span>
<span class="udiff-line-modified-added">+                 0,</span>
<span class="udiff-line-added">+                 sink,</span>
<span class="udiff-line-added">+                 err);</span>
<span class="udiff-line-added">+         }</span>
          if(U_FAILURE(*err)) {
              goto error;
          }
  
          likelySubtags =
              findLikelySubtags(
<span class="udiff-line-modified-removed">-                 tagBuffer,</span>
<span class="udiff-line-modified-added">+                 tagBuffer.data(),</span>
                  likelySubtagsBuffer,
                  sizeof(likelySubtagsBuffer),
                  err);
          if(U_FAILURE(*err)) {
              goto error;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -746,51 +723,54 @@</span>
  
          if (likelySubtags != NULL) {
              /* Always use the language tag from the
                 maximal string, since it may be more
                 specific than the one provided. */
<span class="udiff-line-modified-removed">-             return createTagStringWithAlternates(</span>
<span class="udiff-line-modified-added">+             createTagStringWithAlternates(</span>
                          NULL,
                          0,
                          script,
                          scriptLength,
                          NULL,
                          0,
                          variants,
                          variantsLength,
                          likelySubtags,
<span class="udiff-line-modified-removed">-                         tag,</span>
<span class="udiff-line-removed">-                         tagCapacity,</span>
<span class="udiff-line-modified-added">+                         sink,</span>
                          err);
<span class="udiff-line-added">+             return TRUE;</span>
          }
      }
  
      /**
       * Finally, try just the language.
       **/
      {
          const char* likelySubtags = NULL;
  
<span class="udiff-line-modified-removed">-         createTagString(</span>
<span class="udiff-line-modified-removed">-             lang,</span>
<span class="udiff-line-modified-removed">-             langLength,</span>
<span class="udiff-line-modified-removed">-             NULL,</span>
<span class="udiff-line-modified-removed">-             0,</span>
<span class="udiff-line-modified-removed">-             NULL,</span>
<span class="udiff-line-modified-removed">-             0,</span>
<span class="udiff-line-modified-removed">-             NULL,</span>
<span class="udiff-line-modified-removed">-             0,</span>
<span class="udiff-line-modified-removed">-             tagBuffer,</span>
<span class="udiff-line-modified-removed">-             sizeof(tagBuffer),</span>
<span class="udiff-line-modified-removed">-             err);</span>
<span class="udiff-line-modified-added">+         icu::CharString tagBuffer;</span>
<span class="udiff-line-modified-added">+         {</span>
<span class="udiff-line-modified-added">+             icu::CharStringByteSink sink(&amp;tagBuffer);</span>
<span class="udiff-line-modified-added">+             createTagString(</span>
<span class="udiff-line-modified-added">+                 lang,</span>
<span class="udiff-line-modified-added">+                 langLength,</span>
<span class="udiff-line-modified-added">+                 NULL,</span>
<span class="udiff-line-modified-added">+                 0,</span>
<span class="udiff-line-modified-added">+                 NULL,</span>
<span class="udiff-line-modified-added">+                 0,</span>
<span class="udiff-line-modified-added">+                 NULL,</span>
<span class="udiff-line-modified-added">+                 0,</span>
<span class="udiff-line-added">+                 sink,</span>
<span class="udiff-line-added">+                 err);</span>
<span class="udiff-line-added">+         }</span>
          if(U_FAILURE(*err)) {
              goto error;
          }
  
          likelySubtags =
              findLikelySubtags(
<span class="udiff-line-modified-removed">-                 tagBuffer,</span>
<span class="udiff-line-modified-added">+                 tagBuffer.data(),</span>
                  likelySubtagsBuffer,
                  sizeof(likelySubtagsBuffer),
                  err);
          if(U_FAILURE(*err)) {
              goto error;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -798,39 +778,35 @@</span>
  
          if (likelySubtags != NULL) {
              /* Always use the language tag from the
                 maximal string, since it may be more
                 specific than the one provided. */
<span class="udiff-line-modified-removed">-             return createTagStringWithAlternates(</span>
<span class="udiff-line-modified-added">+             createTagStringWithAlternates(</span>
                          NULL,
                          0,
                          script,
                          scriptLength,
                          region,
                          regionLength,
                          variants,
                          variantsLength,
                          likelySubtags,
<span class="udiff-line-modified-removed">-                         tag,</span>
<span class="udiff-line-removed">-                         tagCapacity,</span>
<span class="udiff-line-modified-added">+                         sink,</span>
                          err);
<span class="udiff-line-added">+             return TRUE;</span>
          }
      }
  
<span class="udiff-line-modified-removed">-     return u_terminateChars(</span>
<span class="udiff-line-removed">-                 tag,</span>
<span class="udiff-line-removed">-                 tagCapacity,</span>
<span class="udiff-line-removed">-                 0,</span>
<span class="udiff-line-removed">-                 err);</span>
<span class="udiff-line-modified-added">+     return FALSE;</span>
  
  error:
  
      if (!U_FAILURE(*err)) {
          *err = U_ILLEGAL_ARGUMENT_ERROR;
      }
  
<span class="udiff-line-modified-removed">-     return -1;</span>
<span class="udiff-line-modified-added">+     return FALSE;</span>
  }
  
  #define CHECK_TRAILING_VARIANT_SIZE(trailing, trailingLength) \
      {   int32_t count = 0; \
          int32_t i; \
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -848,33 +824,29 @@</span>
                  count++; \
              } \
          } \
      }
  
<span class="udiff-line-modified-removed">- static int32_t</span>
<span class="udiff-line-modified-removed">- _uloc_addLikelySubtags(const char*    localeID,</span>
<span class="udiff-line-modified-removed">-          char* maximizedLocaleID,</span>
<span class="udiff-line-modified-removed">-          int32_t maximizedLocaleIDCapacity,</span>
<span class="udiff-line-removed">-          UErrorCode* err)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+ static void</span>
<span class="udiff-line-modified-added">+ _uloc_addLikelySubtags(const char* localeID,</span>
<span class="udiff-line-modified-added">+                        icu::ByteSink&amp; sink,</span>
<span class="udiff-line-modified-added">+                        UErrorCode* err) {</span>
      char lang[ULOC_LANG_CAPACITY];
      int32_t langLength = sizeof(lang);
      char script[ULOC_SCRIPT_CAPACITY];
      int32_t scriptLength = sizeof(script);
      char region[ULOC_COUNTRY_CAPACITY];
      int32_t regionLength = sizeof(region);
      const char* trailing = &quot;&quot;;
      int32_t trailingLength = 0;
      int32_t trailingIndex = 0;
<span class="udiff-line-modified-removed">-     int32_t resultLength = 0;</span>
<span class="udiff-line-modified-added">+     UBool success = FALSE;</span>
  
      if(U_FAILURE(*err)) {
          goto error;
      }
<span class="udiff-line-modified-removed">-     else if (localeID == NULL ||</span>
<span class="udiff-line-removed">-              maximizedLocaleID == NULL ||</span>
<span class="udiff-line-removed">-              maximizedLocaleIDCapacity &lt;= 0) {</span>
<span class="udiff-line-modified-added">+     if (localeID == NULL) {</span>
          goto error;
      }
  
      trailingIndex = parseTagString(
          localeID,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -901,69 +873,46 @@</span>
      trailing = &amp;localeID[trailingIndex];
      trailingLength = (int32_t)uprv_strlen(trailing);
  
      CHECK_TRAILING_VARIANT_SIZE(trailing, trailingLength);
  
<span class="udiff-line-modified-removed">-     resultLength =</span>
<span class="udiff-line-modified-added">+     success =</span>
          createLikelySubtagsString(
              lang,
              langLength,
              script,
              scriptLength,
              region,
              regionLength,
              trailing,
              trailingLength,
<span class="udiff-line-modified-removed">-             maximizedLocaleID,</span>
<span class="udiff-line-removed">-             maximizedLocaleIDCapacity,</span>
<span class="udiff-line-modified-added">+             sink,</span>
              err);
  
<span class="udiff-line-modified-removed">-     if (resultLength == 0) {</span>
<span class="udiff-line-modified-added">+     if (!success) {</span>
          const int32_t localIDLength = (int32_t)uprv_strlen(localeID);
  
          /*
           * If we get here, we need to return localeID.
           */
<span class="udiff-line-modified-removed">-         uprv_memcpy(</span>
<span class="udiff-line-removed">-             maximizedLocaleID,</span>
<span class="udiff-line-removed">-             localeID,</span>
<span class="udiff-line-removed">-             localIDLength &lt;= maximizedLocaleIDCapacity ?</span>
<span class="udiff-line-removed">-                 localIDLength : maximizedLocaleIDCapacity);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         resultLength =</span>
<span class="udiff-line-removed">-             u_terminateChars(</span>
<span class="udiff-line-removed">-                 maximizedLocaleID,</span>
<span class="udiff-line-removed">-                 maximizedLocaleIDCapacity,</span>
<span class="udiff-line-removed">-                 localIDLength,</span>
<span class="udiff-line-removed">-                 err);</span>
<span class="udiff-line-modified-added">+         sink.Append(localeID, localIDLength);</span>
      }
  
<span class="udiff-line-modified-removed">-     return resultLength;</span>
<span class="udiff-line-modified-added">+     return;</span>
  
  error:
  
      if (!U_FAILURE(*err)) {
          *err = U_ILLEGAL_ARGUMENT_ERROR;
      }
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     return -1;</span>
  }
  
<span class="udiff-line-modified-removed">- static int32_t</span>
<span class="udiff-line-modified-removed">- _uloc_minimizeSubtags(const char*    localeID,</span>
<span class="udiff-line-modified-removed">-          char* minimizedLocaleID,</span>
<span class="udiff-line-modified-removed">-          int32_t minimizedLocaleIDCapacity,</span>
<span class="udiff-line-modified-removed">-          UErrorCode* err)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     /**</span>
<span class="udiff-line-removed">-      * ULOC_FULLNAME_CAPACITY will provide enough capacity</span>
<span class="udiff-line-removed">-      * that we can build a string that contains the language,</span>
<span class="udiff-line-removed">-      * script and region code without worrying about overrunning</span>
<span class="udiff-line-removed">-      * the user-supplied buffer.</span>
<span class="udiff-line-removed">-      **/</span>
<span class="udiff-line-removed">-     char maximizedTagBuffer[ULOC_FULLNAME_CAPACITY];</span>
<span class="udiff-line-removed">-     int32_t maximizedTagBufferLength = sizeof(maximizedTagBuffer);</span>
<span class="udiff-line-modified-added">+ static void</span>
<span class="udiff-line-modified-added">+ _uloc_minimizeSubtags(const char* localeID,</span>
<span class="udiff-line-modified-added">+                       icu::ByteSink&amp; sink,</span>
<span class="udiff-line-modified-added">+                       UErrorCode* err) {</span>
<span class="udiff-line-modified-added">+     icu::CharString maximizedTagBuffer;</span>
  
      char lang[ULOC_LANG_CAPACITY];
      int32_t langLength = sizeof(lang);
      char script[ULOC_SCRIPT_CAPACITY];
      int32_t scriptLength = sizeof(script);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -974,13 +923,11 @@</span>
      int32_t trailingIndex = 0;
  
      if(U_FAILURE(*err)) {
          goto error;
      }
<span class="udiff-line-modified-removed">-     else if (localeID == NULL ||</span>
<span class="udiff-line-removed">-              minimizedLocaleID == NULL ||</span>
<span class="udiff-line-removed">-              minimizedLocaleIDCapacity &lt;= 0) {</span>
<span class="udiff-line-modified-added">+     else if (localeID == NULL) {</span>
          goto error;
      }
  
      trailingIndex =
          parseTagString(
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1009,201 +956,187 @@</span>
      trailing = &amp;localeID[trailingIndex];
      trailingLength = (int32_t)uprv_strlen(trailing);
  
      CHECK_TRAILING_VARIANT_SIZE(trailing, trailingLength);
  
<span class="udiff-line-modified-removed">-     createTagString(</span>
<span class="udiff-line-modified-removed">-         lang,</span>
<span class="udiff-line-modified-removed">-         langLength,</span>
<span class="udiff-line-modified-removed">-         script,</span>
<span class="udiff-line-modified-removed">-         scriptLength,</span>
<span class="udiff-line-modified-removed">-         region,</span>
<span class="udiff-line-modified-removed">-         regionLength,</span>
<span class="udiff-line-modified-removed">-         NULL,</span>
<span class="udiff-line-modified-removed">-         0,</span>
<span class="udiff-line-modified-removed">-         maximizedTagBuffer,</span>
<span class="udiff-line-modified-removed">-         maximizedTagBufferLength,</span>
<span class="udiff-line-modified-removed">-         err);</span>
<span class="udiff-line-modified-removed">-     if(U_FAILURE(*err)) {</span>
<span class="udiff-line-modified-removed">-         goto error;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+     {</span>
<span class="udiff-line-modified-added">+         icu::CharString base;</span>
<span class="udiff-line-modified-added">+         {</span>
<span class="udiff-line-modified-added">+             icu::CharStringByteSink sink(&amp;base);</span>
<span class="udiff-line-modified-added">+             createTagString(</span>
<span class="udiff-line-modified-added">+                 lang,</span>
<span class="udiff-line-modified-added">+                 langLength,</span>
<span class="udiff-line-modified-added">+                 script,</span>
<span class="udiff-line-modified-added">+                 scriptLength,</span>
<span class="udiff-line-modified-added">+                 region,</span>
<span class="udiff-line-modified-added">+                 regionLength,</span>
<span class="udiff-line-modified-added">+                 NULL,</span>
<span class="udiff-line-modified-added">+                 0,</span>
<span class="udiff-line-modified-added">+                 sink,</span>
<span class="udiff-line-modified-added">+                 err);</span>
<span class="udiff-line-added">+         }</span>
  
<span class="udiff-line-modified-removed">-     /**</span>
<span class="udiff-line-modified-removed">-      * First, we need to first get the maximization</span>
<span class="udiff-line-modified-removed">-      * from AddLikelySubtags.</span>
<span class="udiff-line-modified-removed">-      **/</span>
<span class="udiff-line-modified-removed">-     maximizedTagBufferLength =</span>
<span class="udiff-line-modified-removed">-         uloc_addLikelySubtags(</span>
<span class="udiff-line-modified-removed">-             maximizedTagBuffer,</span>
<span class="udiff-line-modified-removed">-             maximizedTagBuffer,</span>
<span class="udiff-line-modified-removed">-             maximizedTagBufferLength,</span>
<span class="udiff-line-removed">-             err);</span>
<span class="udiff-line-modified-added">+         /**</span>
<span class="udiff-line-modified-added">+          * First, we need to first get the maximization</span>
<span class="udiff-line-modified-added">+          * from AddLikelySubtags.</span>
<span class="udiff-line-modified-added">+          **/</span>
<span class="udiff-line-modified-added">+         {</span>
<span class="udiff-line-modified-added">+             icu::CharStringByteSink sink(&amp;maximizedTagBuffer);</span>
<span class="udiff-line-modified-added">+             ulocimp_addLikelySubtags(base.data(), sink, err);</span>
<span class="udiff-line-modified-added">+         }</span>
<span class="udiff-line-modified-added">+     }</span>
  
      if(U_FAILURE(*err)) {
          goto error;
      }
  
      /**
       * Start first with just the language.
       **/
      {
<span class="udiff-line-modified-removed">-         char tagBuffer[ULOC_FULLNAME_CAPACITY];</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-         const int32_t tagBufferLength =</span>
<span class="udiff-line-modified-added">+         icu::CharString tagBuffer;</span>
<span class="udiff-line-modified-added">+         {</span>
<span class="udiff-line-modified-added">+             icu::CharStringByteSink sink(&amp;tagBuffer);</span>
              createLikelySubtagsString(
                  lang,
                  langLength,
                  NULL,
                  0,
                  NULL,
                  0,
                  NULL,
                  0,
<span class="udiff-line-modified-removed">-                 tagBuffer,</span>
<span class="udiff-line-removed">-                 sizeof(tagBuffer),</span>
<span class="udiff-line-modified-added">+                 sink,</span>
                  err);
<span class="udiff-line-added">+         }</span>
  
          if(U_FAILURE(*err)) {
              goto error;
          }
<span class="udiff-line-modified-removed">-         else if (uprv_strnicmp(</span>
<span class="udiff-line-modified-removed">-                     maximizedTagBuffer,</span>
<span class="udiff-line-modified-removed">-                     tagBuffer,</span>
<span class="udiff-line-modified-removed">-                     tagBufferLength) == 0) {</span>
<span class="udiff-line-modified-added">+         else if (!tagBuffer.isEmpty() &amp;&amp; uprv_strnicmp(</span>
<span class="udiff-line-modified-added">+                     maximizedTagBuffer.data(),</span>
<span class="udiff-line-modified-added">+                     tagBuffer.data(),</span>
<span class="udiff-line-modified-added">+                     tagBuffer.length()) == 0) {</span>
  
<span class="udiff-line-modified-removed">-             return createTagString(</span>
<span class="udiff-line-modified-added">+             createTagString(</span>
                          lang,
                          langLength,
                          NULL,
                          0,
                          NULL,
                          0,
                          trailing,
                          trailingLength,
<span class="udiff-line-modified-removed">-                         minimizedLocaleID,</span>
<span class="udiff-line-removed">-                         minimizedLocaleIDCapacity,</span>
<span class="udiff-line-modified-added">+                         sink,</span>
                          err);
<span class="udiff-line-added">+             return;</span>
          }
      }
  
      /**
       * Next, try the language and region.
       **/
      if (regionLength &gt; 0) {
  
<span class="udiff-line-modified-removed">-         char tagBuffer[ULOC_FULLNAME_CAPACITY];</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-         const int32_t tagBufferLength =</span>
<span class="udiff-line-modified-added">+         icu::CharString tagBuffer;</span>
<span class="udiff-line-modified-added">+         {</span>
<span class="udiff-line-modified-added">+             icu::CharStringByteSink sink(&amp;tagBuffer);</span>
              createLikelySubtagsString(
                  lang,
                  langLength,
                  NULL,
                  0,
                  region,
                  regionLength,
                  NULL,
                  0,
<span class="udiff-line-modified-removed">-                 tagBuffer,</span>
<span class="udiff-line-removed">-                 sizeof(tagBuffer),</span>
<span class="udiff-line-modified-added">+                 sink,</span>
                  err);
<span class="udiff-line-added">+         }</span>
  
          if(U_FAILURE(*err)) {
              goto error;
          }
          else if (uprv_strnicmp(
<span class="udiff-line-modified-removed">-                     maximizedTagBuffer,</span>
<span class="udiff-line-modified-removed">-                     tagBuffer,</span>
<span class="udiff-line-modified-removed">-                     tagBufferLength) == 0) {</span>
<span class="udiff-line-modified-added">+                     maximizedTagBuffer.data(),</span>
<span class="udiff-line-modified-added">+                     tagBuffer.data(),</span>
<span class="udiff-line-modified-added">+                     tagBuffer.length()) == 0) {</span>
  
<span class="udiff-line-modified-removed">-             return createTagString(</span>
<span class="udiff-line-modified-added">+             createTagString(</span>
                          lang,
                          langLength,
                          NULL,
                          0,
                          region,
                          regionLength,
                          trailing,
                          trailingLength,
<span class="udiff-line-modified-removed">-                         minimizedLocaleID,</span>
<span class="udiff-line-removed">-                         minimizedLocaleIDCapacity,</span>
<span class="udiff-line-modified-added">+                         sink,</span>
                          err);
<span class="udiff-line-added">+             return;</span>
          }
      }
  
      /**
       * Finally, try the language and script.  This is our last chance,
       * since trying with all three subtags would only yield the
       * maximal version that we already have.
       **/
      if (scriptLength &gt; 0 &amp;&amp; regionLength &gt; 0) {
<span class="udiff-line-modified-removed">-         char tagBuffer[ULOC_FULLNAME_CAPACITY];</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-         const int32_t tagBufferLength =</span>
<span class="udiff-line-modified-added">+         icu::CharString tagBuffer;</span>
<span class="udiff-line-modified-added">+         {</span>
<span class="udiff-line-modified-added">+             icu::CharStringByteSink sink(&amp;tagBuffer);</span>
              createLikelySubtagsString(
                  lang,
                  langLength,
                  script,
                  scriptLength,
                  NULL,
                  0,
                  NULL,
                  0,
<span class="udiff-line-modified-removed">-                 tagBuffer,</span>
<span class="udiff-line-removed">-                 sizeof(tagBuffer),</span>
<span class="udiff-line-modified-added">+                 sink,</span>
                  err);
<span class="udiff-line-added">+         }</span>
  
          if(U_FAILURE(*err)) {
              goto error;
          }
          else if (uprv_strnicmp(
<span class="udiff-line-modified-removed">-                     maximizedTagBuffer,</span>
<span class="udiff-line-modified-removed">-                     tagBuffer,</span>
<span class="udiff-line-modified-removed">-                     tagBufferLength) == 0) {</span>
<span class="udiff-line-modified-added">+                     maximizedTagBuffer.data(),</span>
<span class="udiff-line-modified-added">+                     tagBuffer.data(),</span>
<span class="udiff-line-modified-added">+                     tagBuffer.length()) == 0) {</span>
  
<span class="udiff-line-modified-removed">-             return createTagString(</span>
<span class="udiff-line-modified-added">+             createTagString(</span>
                          lang,
                          langLength,
                          script,
                          scriptLength,
                          NULL,
                          0,
                          trailing,
                          trailingLength,
<span class="udiff-line-modified-removed">-                         minimizedLocaleID,</span>
<span class="udiff-line-removed">-                         minimizedLocaleIDCapacity,</span>
<span class="udiff-line-modified-added">+                         sink,</span>
                          err);
<span class="udiff-line-added">+             return;</span>
          }
      }
  
      {
          /**
           * If we got here, return the locale ID parameter.
           **/
          const int32_t localeIDLength = (int32_t)uprv_strlen(localeID);
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-         uprv_memcpy(</span>
<span class="udiff-line-removed">-             minimizedLocaleID,</span>
<span class="udiff-line-removed">-             localeID,</span>
<span class="udiff-line-removed">-             localeIDLength &lt;= minimizedLocaleIDCapacity ?</span>
<span class="udiff-line-removed">-                 localeIDLength : minimizedLocaleIDCapacity);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         return u_terminateChars(</span>
<span class="udiff-line-removed">-                     minimizedLocaleID,</span>
<span class="udiff-line-removed">-                     minimizedLocaleIDCapacity,</span>
<span class="udiff-line-removed">-                     localeIDLength,</span>
<span class="udiff-line-removed">-                     err);</span>
<span class="udiff-line-modified-added">+         sink.Append(localeID, localeIDLength);</span>
<span class="udiff-line-modified-added">+         return;</span>
      }
  
  error:
  
      if (!U_FAILURE(*err)) {
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     return -1;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
  }
  
  static UBool
  do_canonicalize(const char*    localeID,
           char* buffer,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1230,63 +1163,95 @@</span>
          return TRUE;
      }
  }
  
  U_CAPI int32_t U_EXPORT2
<span class="udiff-line-modified-removed">- uloc_addLikelySubtags(const char*    localeID,</span>
<span class="udiff-line-modified-removed">-          char* maximizedLocaleID,</span>
<span class="udiff-line-modified-removed">-          int32_t maximizedLocaleIDCapacity,</span>
<span class="udiff-line-modified-removed">-          UErrorCode* err)</span>
<span class="udiff-line-modified-removed">- {</span>
<span class="udiff-line-modified-removed">-     char localeBuffer[ULOC_FULLNAME_CAPACITY];</span>
<span class="udiff-line-modified-added">+ uloc_addLikelySubtags(const char* localeID,</span>
<span class="udiff-line-modified-added">+                       char* maximizedLocaleID,</span>
<span class="udiff-line-modified-added">+                       int32_t maximizedLocaleIDCapacity,</span>
<span class="udiff-line-modified-added">+                       UErrorCode* status) {</span>
<span class="udiff-line-modified-added">+     if (U_FAILURE(*status)) {</span>
<span class="udiff-line-modified-added">+         return 0;</span>
<span class="udiff-line-added">+     }</span>
  
<span class="udiff-line-modified-removed">-     if (!do_canonicalize(</span>
<span class="udiff-line-modified-removed">-         localeID,</span>
<span class="udiff-line-modified-removed">-         localeBuffer,</span>
<span class="udiff-line-modified-removed">-         sizeof(localeBuffer),</span>
<span class="udiff-line-modified-removed">-         err)) {</span>
<span class="udiff-line-modified-removed">-         return -1;</span>
<span class="udiff-line-modified-added">+     icu::CheckedArrayByteSink sink(</span>
<span class="udiff-line-modified-added">+             maximizedLocaleID, maximizedLocaleIDCapacity);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     ulocimp_addLikelySubtags(localeID, sink, status);</span>
<span class="udiff-line-modified-added">+     int32_t reslen = sink.NumberOfBytesAppended();</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+     if (U_FAILURE(*status)) {</span>
<span class="udiff-line-added">+         return sink.Overflowed() ? reslen : -1;</span>
      }
<span class="udiff-line-modified-removed">-     else {</span>
<span class="udiff-line-modified-removed">-         return _uloc_addLikelySubtags(</span>
<span class="udiff-line-modified-removed">-                     localeBuffer,</span>
<span class="udiff-line-modified-removed">-                     maximizedLocaleID,</span>
<span class="udiff-line-modified-removed">-                     maximizedLocaleIDCapacity,</span>
<span class="udiff-line-modified-removed">-                     err);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     if (sink.Overflowed()) {</span>
<span class="udiff-line-modified-added">+         *status = U_BUFFER_OVERFLOW_ERROR;</span>
<span class="udiff-line-modified-added">+     } else {</span>
<span class="udiff-line-modified-added">+         u_terminateChars(</span>
<span class="udiff-line-modified-added">+                 maximizedLocaleID, maximizedLocaleIDCapacity, reslen, status);</span>
      }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return reslen;</span>
  }
  
<span class="udiff-line-modified-removed">- U_CAPI int32_t U_EXPORT2</span>
<span class="udiff-line-modified-removed">- uloc_minimizeSubtags(const char*    localeID,</span>
<span class="udiff-line-modified-removed">-          char* minimizedLocaleID,</span>
<span class="udiff-line-modified-removed">-          int32_t minimizedLocaleIDCapacity,</span>
<span class="udiff-line-removed">-          UErrorCode* err)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-modified-added">+ U_CAPI void U_EXPORT2</span>
<span class="udiff-line-modified-added">+ ulocimp_addLikelySubtags(const char* localeID,</span>
<span class="udiff-line-modified-added">+                          icu::ByteSink&amp; sink,</span>
<span class="udiff-line-modified-added">+                          UErrorCode* status) {</span>
      char localeBuffer[ULOC_FULLNAME_CAPACITY];
  
<span class="udiff-line-modified-removed">-     if (!do_canonicalize(</span>
<span class="udiff-line-modified-removed">-         localeID,</span>
<span class="udiff-line-removed">-         localeBuffer,</span>
<span class="udiff-line-removed">-         sizeof(localeBuffer),</span>
<span class="udiff-line-removed">-         err)) {</span>
<span class="udiff-line-removed">-         return -1;</span>
<span class="udiff-line-modified-added">+     if (do_canonicalize(localeID, localeBuffer, sizeof localeBuffer, status)) {</span>
<span class="udiff-line-modified-added">+         _uloc_addLikelySubtags(localeBuffer, sink, status);</span>
      }
<span class="udiff-line-modified-removed">-     else {</span>
<span class="udiff-line-modified-removed">-         return _uloc_minimizeSubtags(</span>
<span class="udiff-line-modified-removed">-                     localeBuffer,</span>
<span class="udiff-line-modified-removed">-                     minimizedLocaleID,</span>
<span class="udiff-line-modified-removed">-                     minimizedLocaleIDCapacity,</span>
<span class="udiff-line-modified-removed">-                     err);</span>
<span class="udiff-line-modified-added">+ }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+ U_CAPI int32_t U_EXPORT2</span>
<span class="udiff-line-modified-added">+ uloc_minimizeSubtags(const char* localeID,</span>
<span class="udiff-line-modified-added">+                      char* minimizedLocaleID,</span>
<span class="udiff-line-modified-added">+                      int32_t minimizedLocaleIDCapacity,</span>
<span class="udiff-line-added">+                      UErrorCode* status) {</span>
<span class="udiff-line-added">+     if (U_FAILURE(*status)) {</span>
<span class="udiff-line-added">+         return 0;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     icu::CheckedArrayByteSink sink(</span>
<span class="udiff-line-added">+             minimizedLocaleID, minimizedLocaleIDCapacity);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     ulocimp_minimizeSubtags(localeID, sink, status);</span>
<span class="udiff-line-added">+     int32_t reslen = sink.NumberOfBytesAppended();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (U_FAILURE(*status)) {</span>
<span class="udiff-line-added">+         return sink.Overflowed() ? reslen : -1;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (sink.Overflowed()) {</span>
<span class="udiff-line-added">+         *status = U_BUFFER_OVERFLOW_ERROR;</span>
<span class="udiff-line-added">+     } else {</span>
<span class="udiff-line-added">+         u_terminateChars(</span>
<span class="udiff-line-added">+                 minimizedLocaleID, minimizedLocaleIDCapacity, reslen, status);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return reslen;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ U_CAPI void U_EXPORT2</span>
<span class="udiff-line-added">+ ulocimp_minimizeSubtags(const char* localeID,</span>
<span class="udiff-line-added">+                         icu::ByteSink&amp; sink,</span>
<span class="udiff-line-added">+                         UErrorCode* status) {</span>
<span class="udiff-line-added">+     char localeBuffer[ULOC_FULLNAME_CAPACITY];</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (do_canonicalize(localeID, localeBuffer, sizeof localeBuffer, status)) {</span>
<span class="udiff-line-added">+         _uloc_minimizeSubtags(localeBuffer, sink, status);</span>
      }
  }
  
  // Pairs of (language subtag, + or -) for finding out fast if common languages
  // are LTR (minus) or RTL (plus).
  static const char LANG_DIR_STRING[] =
          &quot;root-en-es-pt-zh-ja-ko-de-fr-it-ar+he+fa+ru-nl-pl-th-tr-&quot;;
  
<span class="udiff-line-modified-removed">- // Implemented here because this calls uloc_addLikelySubtags().</span>
<span class="udiff-line-modified-added">+ // Implemented here because this calls ulocimp_addLikelySubtags().</span>
  U_CAPI UBool U_EXPORT2
  uloc_isRightToLeft(const char *locale) {
      UErrorCode errorCode = U_ZERO_ERROR;
      char script[8];
      int32_t scriptLength = uloc_getScript(locale, script, UPRV_LENGTHOF(script), &amp;errorCode);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1295,30 +1260,34 @@</span>
          // Fastpath: We know the likely scripts and their writing direction
          // for some common languages.
          errorCode = U_ZERO_ERROR;
          char lang[8];
          int32_t langLength = uloc_getLanguage(locale, lang, UPRV_LENGTHOF(lang), &amp;errorCode);
<span class="udiff-line-modified-removed">-         if (U_FAILURE(errorCode) || errorCode == U_STRING_NOT_TERMINATED_WARNING ||</span>
<span class="udiff-line-removed">-                 langLength == 0) {</span>
<span class="udiff-line-modified-added">+         if (U_FAILURE(errorCode) || errorCode == U_STRING_NOT_TERMINATED_WARNING) {</span>
              return FALSE;
          }
<span class="udiff-line-modified-removed">-         const char* langPtr = uprv_strstr(LANG_DIR_STRING, lang);</span>
<span class="udiff-line-modified-removed">-         if (langPtr != NULL) {</span>
<span class="udiff-line-modified-removed">-             switch (langPtr[langLength]) {</span>
<span class="udiff-line-modified-removed">-             case &#39;-&#39;: return FALSE;</span>
<span class="udiff-line-modified-removed">-             case &#39;+&#39;: return TRUE;</span>
<span class="udiff-line-modified-removed">-             default: break;  // partial match of a longer code</span>
<span class="udiff-line-modified-added">+         if (langLength &gt; 0) {</span>
<span class="udiff-line-modified-added">+             const char* langPtr = uprv_strstr(LANG_DIR_STRING, lang);</span>
<span class="udiff-line-modified-added">+             if (langPtr != NULL) {</span>
<span class="udiff-line-modified-added">+                 switch (langPtr[langLength]) {</span>
<span class="udiff-line-modified-added">+                 case &#39;-&#39;: return FALSE;</span>
<span class="udiff-line-modified-added">+                 case &#39;+&#39;: return TRUE;</span>
<span class="udiff-line-added">+                 default: break;  // partial match of a longer code</span>
<span class="udiff-line-added">+                 }</span>
              }
          }
          // Otherwise, find the likely script.
          errorCode = U_ZERO_ERROR;
<span class="udiff-line-modified-removed">-         char likely[ULOC_FULLNAME_CAPACITY];</span>
<span class="udiff-line-modified-removed">-         (void)uloc_addLikelySubtags(locale, likely, UPRV_LENGTHOF(likely), &amp;errorCode);</span>
<span class="udiff-line-modified-added">+         icu::CharString likely;</span>
<span class="udiff-line-modified-added">+         {</span>
<span class="udiff-line-added">+             icu::CharStringByteSink sink(&amp;likely);</span>
<span class="udiff-line-added">+             ulocimp_addLikelySubtags(locale, sink, &amp;errorCode);</span>
<span class="udiff-line-added">+         }</span>
          if (U_FAILURE(errorCode) || errorCode == U_STRING_NOT_TERMINATED_WARNING) {
              return FALSE;
          }
<span class="udiff-line-modified-removed">-         scriptLength = uloc_getScript(likely, script, UPRV_LENGTHOF(script), &amp;errorCode);</span>
<span class="udiff-line-modified-added">+         scriptLength = uloc_getScript(likely.data(), script, UPRV_LENGTHOF(script), &amp;errorCode);</span>
          if (U_FAILURE(errorCode) || errorCode == U_STRING_NOT_TERMINATED_WARNING ||
                  scriptLength == 0) {
              return FALSE;
          }
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1365,15 +1334,18 @@</span>
          rgLen = uloc_getCountry(localeID, rgBuf, ULOC_RG_BUFLEN, status);
          if (U_FAILURE(*status)) {
              rgLen = 0;
          } else if (rgLen == 0 &amp;&amp; inferRegion) {
              // no unicode_region_subtag but inferRegion TRUE, try likely subtags
<span class="udiff-line-removed">-             char locBuf[ULOC_FULLNAME_CAPACITY];</span>
              rgStatus = U_ZERO_ERROR;
<span class="udiff-line-modified-removed">-             (void)uloc_addLikelySubtags(localeID, locBuf, ULOC_FULLNAME_CAPACITY, &amp;rgStatus);</span>
<span class="udiff-line-modified-added">+             icu::CharString locBuf;</span>
<span class="udiff-line-added">+             {</span>
<span class="udiff-line-added">+                 icu::CharStringByteSink sink(&amp;locBuf);</span>
<span class="udiff-line-added">+                 ulocimp_addLikelySubtags(localeID, sink, &amp;rgStatus);</span>
<span class="udiff-line-added">+             }</span>
              if (U_SUCCESS(rgStatus)) {
<span class="udiff-line-modified-removed">-                 rgLen = uloc_getCountry(locBuf, rgBuf, ULOC_RG_BUFLEN, status);</span>
<span class="udiff-line-modified-added">+                 rgLen = uloc_getCountry(locBuf.data(), rgBuf, ULOC_RG_BUFLEN, status);</span>
                  if (U_FAILURE(*status)) {
                      rgLen = 0;
                  }
              }
          }
</pre>
<center><a href="locid.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="locmap.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>