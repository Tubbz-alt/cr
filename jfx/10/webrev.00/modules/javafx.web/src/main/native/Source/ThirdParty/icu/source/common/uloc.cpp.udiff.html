<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/ThirdParty/icu/source/common/uloc.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="uinvchar.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="uloc_keytype.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/ThirdParty/icu/source/common/uloc.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -455,77 +455,27 @@</span>
  };
  
  typedef struct CanonicalizationMap {
      const char *id;          /* input ID */
      const char *canonicalID; /* canonicalized output ID */
<span class="udiff-line-removed">-     const char *keyword;     /* keyword, or NULL if none */</span>
<span class="udiff-line-removed">-     const char *value;       /* keyword value, or NULL if kw==NULL */</span>
  } CanonicalizationMap;
  
  /**
   * A map to canonicalize locale IDs.  This handles a variety of
   * different semantic kinds of transformations.
   */
  static const CanonicalizationMap CANONICALIZE_MAP[] = {
<span class="udiff-line-modified-removed">-     { &quot;&quot;,               &quot;en_US_POSIX&quot;, NULL, NULL }, /* .NET name */</span>
<span class="udiff-line-modified-removed">-     { &quot;c&quot;,              &quot;en_US_POSIX&quot;, NULL, NULL }, /* POSIX name */</span>
<span class="udiff-line-modified-removed">-     { &quot;posix&quot;,          &quot;en_US_POSIX&quot;, NULL, NULL }, /* POSIX name (alias of C) */</span>
<span class="udiff-line-modified-removed">-     { &quot;art_LOJBAN&quot;,     &quot;jbo&quot;, NULL, NULL }, /* registered name */</span>
<span class="udiff-line-modified-removed">-     { &quot;az_AZ_CYRL&quot;,     &quot;az_Cyrl_AZ&quot;, NULL, NULL }, /* .NET name */</span>
<span class="udiff-line-modified-removed">-     { &quot;az_AZ_LATN&quot;,     &quot;az_Latn_AZ&quot;, NULL, NULL }, /* .NET name */</span>
<span class="udiff-line-modified-removed">-     { &quot;ca_ES_PREEURO&quot;,  &quot;ca_ES&quot;, &quot;currency&quot;, &quot;ESP&quot; },</span>
<span class="udiff-line-modified-removed">-     { &quot;de__PHONEBOOK&quot;,  &quot;de&quot;, &quot;collation&quot;, &quot;phonebook&quot; }, /* Old ICU name */</span>
<span class="udiff-line-modified-removed">-     { &quot;de_AT_PREEURO&quot;,  &quot;de_AT&quot;, &quot;currency&quot;, &quot;ATS&quot; },</span>
<span class="udiff-line-modified-removed">-     { &quot;de_DE_PREEURO&quot;,  &quot;de_DE&quot;, &quot;currency&quot;, &quot;DEM&quot; },</span>
<span class="udiff-line-removed">-     { &quot;de_LU_PREEURO&quot;,  &quot;de_LU&quot;, &quot;currency&quot;, &quot;LUF&quot; },</span>
<span class="udiff-line-removed">-     { &quot;el_GR_PREEURO&quot;,  &quot;el_GR&quot;, &quot;currency&quot;, &quot;GRD&quot; },</span>
<span class="udiff-line-removed">-     { &quot;en_BE_PREEURO&quot;,  &quot;en_BE&quot;, &quot;currency&quot;, &quot;BEF&quot; },</span>
<span class="udiff-line-removed">-     { &quot;en_IE_PREEURO&quot;,  &quot;en_IE&quot;, &quot;currency&quot;, &quot;IEP&quot; },</span>
<span class="udiff-line-removed">-     { &quot;es__TRADITIONAL&quot;, &quot;es&quot;, &quot;collation&quot;, &quot;traditional&quot; }, /* Old ICU name */</span>
<span class="udiff-line-removed">-     { &quot;es_ES_PREEURO&quot;,  &quot;es_ES&quot;, &quot;currency&quot;, &quot;ESP&quot; },</span>
<span class="udiff-line-removed">-     { &quot;eu_ES_PREEURO&quot;,  &quot;eu_ES&quot;, &quot;currency&quot;, &quot;ESP&quot; },</span>
<span class="udiff-line-removed">-     { &quot;fi_FI_PREEURO&quot;,  &quot;fi_FI&quot;, &quot;currency&quot;, &quot;FIM&quot; },</span>
<span class="udiff-line-removed">-     { &quot;fr_BE_PREEURO&quot;,  &quot;fr_BE&quot;, &quot;currency&quot;, &quot;BEF&quot; },</span>
<span class="udiff-line-removed">-     { &quot;fr_FR_PREEURO&quot;,  &quot;fr_FR&quot;, &quot;currency&quot;, &quot;FRF&quot; },</span>
<span class="udiff-line-removed">-     { &quot;fr_LU_PREEURO&quot;,  &quot;fr_LU&quot;, &quot;currency&quot;, &quot;LUF&quot; },</span>
<span class="udiff-line-removed">-     { &quot;ga_IE_PREEURO&quot;,  &quot;ga_IE&quot;, &quot;currency&quot;, &quot;IEP&quot; },</span>
<span class="udiff-line-removed">-     { &quot;gl_ES_PREEURO&quot;,  &quot;gl_ES&quot;, &quot;currency&quot;, &quot;ESP&quot; },</span>
<span class="udiff-line-removed">-     { &quot;hi__DIRECT&quot;,     &quot;hi&quot;, &quot;collation&quot;, &quot;direct&quot; }, /* Old ICU name */</span>
<span class="udiff-line-removed">-     { &quot;it_IT_PREEURO&quot;,  &quot;it_IT&quot;, &quot;currency&quot;, &quot;ITL&quot; },</span>
<span class="udiff-line-removed">-     { &quot;ja_JP_TRADITIONAL&quot;, &quot;ja_JP&quot;, &quot;calendar&quot;, &quot;japanese&quot; }, /* Old ICU name */</span>
<span class="udiff-line-removed">-     { &quot;nb_NO_NY&quot;,       &quot;nn_NO&quot;, NULL, NULL },  /* &quot;markus said this was ok&quot; :-) */</span>
<span class="udiff-line-removed">-     { &quot;nl_BE_PREEURO&quot;,  &quot;nl_BE&quot;, &quot;currency&quot;, &quot;BEF&quot; },</span>
<span class="udiff-line-removed">-     { &quot;nl_NL_PREEURO&quot;,  &quot;nl_NL&quot;, &quot;currency&quot;, &quot;NLG&quot; },</span>
<span class="udiff-line-removed">-     { &quot;pt_PT_PREEURO&quot;,  &quot;pt_PT&quot;, &quot;currency&quot;, &quot;PTE&quot; },</span>
<span class="udiff-line-removed">-     { &quot;sr_SP_CYRL&quot;,     &quot;sr_Cyrl_RS&quot;, NULL, NULL }, /* .NET name */</span>
<span class="udiff-line-removed">-     { &quot;sr_SP_LATN&quot;,     &quot;sr_Latn_RS&quot;, NULL, NULL }, /* .NET name */</span>
<span class="udiff-line-removed">-     { &quot;sr_YU_CYRILLIC&quot;, &quot;sr_Cyrl_RS&quot;, NULL, NULL }, /* Linux name */</span>
<span class="udiff-line-removed">-     { &quot;th_TH_TRADITIONAL&quot;, &quot;th_TH&quot;, &quot;calendar&quot;, &quot;buddhist&quot; }, /* Old ICU name */</span>
<span class="udiff-line-removed">-     { &quot;uz_UZ_CYRILLIC&quot;, &quot;uz_Cyrl_UZ&quot;, NULL, NULL }, /* Linux name */</span>
<span class="udiff-line-removed">-     { &quot;uz_UZ_CYRL&quot;,     &quot;uz_Cyrl_UZ&quot;, NULL, NULL }, /* .NET name */</span>
<span class="udiff-line-removed">-     { &quot;uz_UZ_LATN&quot;,     &quot;uz_Latn_UZ&quot;, NULL, NULL }, /* .NET name */</span>
<span class="udiff-line-removed">-     { &quot;zh_CHS&quot;,         &quot;zh_Hans&quot;, NULL, NULL }, /* .NET name */</span>
<span class="udiff-line-removed">-     { &quot;zh_CHT&quot;,         &quot;zh_Hant&quot;, NULL, NULL }, /* .NET name */</span>
<span class="udiff-line-removed">-     { &quot;zh_GAN&quot;,         &quot;gan&quot;, NULL, NULL }, /* registered name */</span>
<span class="udiff-line-removed">-     { &quot;zh_GUOYU&quot;,       &quot;zh&quot;, NULL, NULL }, /* registered name */</span>
<span class="udiff-line-removed">-     { &quot;zh_HAKKA&quot;,       &quot;hak&quot;, NULL, NULL }, /* registered name */</span>
<span class="udiff-line-removed">-     { &quot;zh_MIN_NAN&quot;,     &quot;nan&quot;, NULL, NULL }, /* registered name */</span>
<span class="udiff-line-removed">-     { &quot;zh_WUU&quot;,         &quot;wuu&quot;, NULL, NULL }, /* registered name */</span>
<span class="udiff-line-removed">-     { &quot;zh_XIANG&quot;,       &quot;hsn&quot;, NULL, NULL }, /* registered name */</span>
<span class="udiff-line-removed">-     { &quot;zh_YUE&quot;,         &quot;yue&quot;, NULL, NULL }, /* registered name */</span>
<span class="udiff-line-removed">- };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- typedef struct VariantMap {</span>
<span class="udiff-line-removed">-     const char *variant;          /* input ID */</span>
<span class="udiff-line-removed">-     const char *keyword;     /* keyword, or NULL if none */</span>
<span class="udiff-line-removed">-     const char *value;       /* keyword value, or NULL if kw==NULL */</span>
<span class="udiff-line-removed">- } VariantMap;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- static const VariantMap VARIANT_MAP[] = {</span>
<span class="udiff-line-removed">-     { &quot;EURO&quot;,   &quot;currency&quot;, &quot;EUR&quot; },</span>
<span class="udiff-line-removed">-     { &quot;PINYIN&quot;, &quot;collation&quot;, &quot;pinyin&quot; }, /* Solaris variant */</span>
<span class="udiff-line-removed">-     { &quot;STROKE&quot;, &quot;collation&quot;, &quot;stroke&quot; }  /* Solaris variant */</span>
<span class="udiff-line-modified-added">+     { &quot;art_LOJBAN&quot;,     &quot;jbo&quot; }, /* registered name */</span>
<span class="udiff-line-modified-added">+     { &quot;hy__AREVELA&quot;,    &quot;hy&quot; }, /* Registered IANA variant */</span>
<span class="udiff-line-modified-added">+     { &quot;hy__AREVMDA&quot;,    &quot;hyw&quot; }, /* Registered IANA variant */</span>
<span class="udiff-line-modified-added">+     { &quot;zh_GAN&quot;,         &quot;gan&quot; }, /* registered name */</span>
<span class="udiff-line-modified-added">+     { &quot;zh_GUOYU&quot;,       &quot;zh&quot; }, /* registered name */</span>
<span class="udiff-line-modified-added">+     { &quot;zh_HAKKA&quot;,       &quot;hak&quot; }, /* registered name */</span>
<span class="udiff-line-modified-added">+     { &quot;zh_MIN_NAN&quot;,     &quot;nan&quot; }, /* registered name */</span>
<span class="udiff-line-modified-added">+     { &quot;zh_WUU&quot;,         &quot;wuu&quot; }, /* registered name */</span>
<span class="udiff-line-modified-added">+     { &quot;zh_XIANG&quot;,       &quot;hsn&quot; }, /* registered name */</span>
<span class="udiff-line-modified-added">+     { &quot;zh_YUE&quot;,         &quot;yue&quot; }, /* registered name */</span>
  };
  
  /* ### BCP47 Conversion *******************************************/
  /* Test if the locale id has BCP47 u extension and does not have &#39;@&#39; */
  #define _hasBCP47Extension(id) (id &amp;&amp; uprv_strstr(id, &quot;@&quot;) == NULL &amp;&amp; getShortestSubtagLength(localeID) == 1)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -641,24 +591,16 @@</span>
      const char* leftString = ((const KeywordStruct *)left)-&gt;keyword;
      const char* rightString = ((const KeywordStruct *)right)-&gt;keyword;
      return uprv_strcmp(leftString, rightString);
  }
  
<span class="udiff-line-removed">- /**</span>
<span class="udiff-line-removed">-  * Both addKeyword and addValue must already be in canonical form.</span>
<span class="udiff-line-removed">-  * Either both addKeyword and addValue are NULL, or neither is NULL.</span>
<span class="udiff-line-removed">-  * If they are not NULL they must be zero terminated.</span>
<span class="udiff-line-removed">-  * If addKeyword is not NULL is must have length small enough to fit in KeywordStruct.keyword.</span>
<span class="udiff-line-removed">-  */</span>
  static int32_t
  _getKeywords(const char *localeID,
               char prev,
               char *keywords, int32_t keywordCapacity,
               char *values, int32_t valuesCapacity, int32_t *valLen,
<span class="udiff-line-removed">-              const char* addKeyword,</span>
<span class="udiff-line-removed">-              const char* addValue,</span>
               UErrorCode *status)
  {
      KeywordStruct keywordList[ULOC_MAX_NO_KEYWORDS];
  
      int32_t maxKeywords = ULOC_MAX_NO_KEYWORDS;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -753,37 +695,10 @@</span>
              if (!duplicate) {
                  ++numKeywords;
              }
          } while(pos);
  
<span class="udiff-line-removed">-         /* Handle addKeyword/addValue. */</span>
<span class="udiff-line-removed">-         if (addKeyword != NULL) {</span>
<span class="udiff-line-removed">-             UBool duplicate = FALSE;</span>
<span class="udiff-line-removed">-             U_ASSERT(addValue != NULL);</span>
<span class="udiff-line-removed">-             /* Search for duplicate; if found, do nothing. Explicit keyword</span>
<span class="udiff-line-removed">-                overrides addKeyword. */</span>
<span class="udiff-line-removed">-             for (j=0; j&lt;numKeywords; ++j) {</span>
<span class="udiff-line-removed">-                 if (uprv_strcmp(keywordList[j].keyword, addKeyword) == 0) {</span>
<span class="udiff-line-removed">-                     duplicate = TRUE;</span>
<span class="udiff-line-removed">-                     break;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             if (!duplicate) {</span>
<span class="udiff-line-removed">-                 if (numKeywords == maxKeywords) {</span>
<span class="udiff-line-removed">-                     *status = U_INTERNAL_PROGRAM_ERROR;</span>
<span class="udiff-line-removed">-                     return 0;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-                 uprv_strcpy(keywordList[numKeywords].keyword, addKeyword);</span>
<span class="udiff-line-removed">-                 keywordList[numKeywords].keywordLen = (int32_t)uprv_strlen(addKeyword);</span>
<span class="udiff-line-removed">-                 keywordList[numKeywords].valueStart = addValue;</span>
<span class="udiff-line-removed">-                 keywordList[numKeywords].valueLen = (int32_t)uprv_strlen(addValue);</span>
<span class="udiff-line-removed">-                 ++numKeywords;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         } else {</span>
<span class="udiff-line-removed">-             U_ASSERT(addValue == NULL);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
          /* now we have a list of keywords */
          /* we need to sort it */
          uprv_sortArray(keywordList, numKeywords, sizeof(KeywordStruct), compareKeywordStructs, NULL, FALSE, status);
  
          /* Now construct the keyword part */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -796,11 +711,11 @@</span>
                      keywords[keywordsLen + keywordList[i].keywordLen] = 0;
                  }
              }
              keywordsLen += keywordList[i].keywordLen + 1;
              if(valuesToo) {
<span class="udiff-line-modified-removed">-                 if(keywordsLen + keywordList[i].valueLen &lt; keywordCapacity) {</span>
<span class="udiff-line-modified-added">+                 if(keywordsLen + keywordList[i].valueLen &lt;= keywordCapacity) {</span>
                      uprv_strncpy(keywords+keywordsLen, keywordList[i].valueStart, keywordList[i].valueLen);
                  }
                  keywordsLen += keywordList[i].valueLen;
  
                  if(i &lt; numKeywords - 1) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -837,11 +752,11 @@</span>
                     char *values, int32_t valuesCapacity, int32_t *valLen,
                     UBool valuesToo,
                     UErrorCode *status) {
      return _getKeywords(localeID, prev, keywords, keywordCapacity,
                          values, valuesCapacity, valLen, valuesToo,
<span class="udiff-line-modified-removed">-                         NULL, NULL, status);</span>
<span class="udiff-line-modified-added">+                         status);</span>
  }
  
  U_CAPI int32_t U_EXPORT2
  uloc_getKeywordValue(const char* localeID,
                       const char* keywordName,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1131,11 +1046,11 @@</span>
              /* copy the current entry */
              updatedKeysAndValues.append(keyValuePrefix, *status);
              keyValuePrefix = &#39;;&#39;; /* for any subsequent key-value pair */
              updatedKeysAndValues.append(localeKeywordNameBuffer, keyValueLen, *status);
              updatedKeysAndValues.append(&#39;=&#39;, *status);
<span class="udiff-line-modified-removed">-             updatedKeysAndValues.append(nextEqualsign, keyValueTail-nextEqualsign, *status);</span>
<span class="udiff-line-modified-added">+             updatedKeysAndValues.append(nextEqualsign, static_cast&lt;int32_t&gt;(keyValueTail-nextEqualsign), *status);</span>
          }
          if (!nextSeparator &amp;&amp; keywordValueLen &gt; 0 &amp;&amp; !handledInputKeyAndValue) {
              /* append new entry at the end, it sorts later than existing entries */
              updatedKeysAndValues.append(keyValuePrefix, *status);
              /* skip keyValuePrefix update, no subsequent key-value pair */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1186,24 +1101,10 @@</span>
  /* Dot terminates it because of POSIX form  where dot precedes the codepage
   * except for variant
   */
  #define _isTerminator(a)  ((a==0)||(a==&#39;.&#39;)||(a==&#39;@&#39;))
  
<span class="udiff-line-removed">- static char* _strnchr(const char* str, int32_t len, char c) {</span>
<span class="udiff-line-removed">-     U_ASSERT(str != 0 &amp;&amp; len &gt;= 0);</span>
<span class="udiff-line-removed">-     while (len-- != 0) {</span>
<span class="udiff-line-removed">-         char d = *str;</span>
<span class="udiff-line-removed">-         if (d == c) {</span>
<span class="udiff-line-removed">-             return (char*) str;</span>
<span class="udiff-line-removed">-         } else if (d == 0) {</span>
<span class="udiff-line-removed">-             break;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         ++str;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     return NULL;</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  /**
   * Lookup &#39;key&#39; in the array &#39;list&#39;.  The array &#39;list&#39; should contain
   * a NULL entry, followed by more entries, and a second NULL entry.
   *
   * The &#39;list&#39; param should be LANGUAGES, LANGUAGES_3, COUNTRIES, or
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1277,10 +1178,20 @@</span>
                      const char **pEnd) {
      int32_t i=0;
      int32_t offset;
      char lang[4]={ 0, 0, 0, 0 }; /* temporary buffer to hold language code for searching */
  
<span class="udiff-line-added">+     if (uprv_stricmp(localeID, &quot;root&quot;) == 0) {</span>
<span class="udiff-line-added">+         localeID += 4;</span>
<span class="udiff-line-added">+     } else if (uprv_strnicmp(localeID, &quot;und&quot;, 3) == 0 &amp;&amp;</span>
<span class="udiff-line-added">+                (localeID[3] == &#39;\0&#39; ||</span>
<span class="udiff-line-added">+                 localeID[3] == &#39;-&#39; ||</span>
<span class="udiff-line-added">+                 localeID[3] == &#39;_&#39; ||</span>
<span class="udiff-line-added">+                 localeID[3] == &#39;@&#39;)) {</span>
<span class="udiff-line-added">+         localeID += 3;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      /* if it starts with i- or x- then copy that prefix */
      if(_isIDPrefix(localeID)) {
          if(i&lt;languageCapacity) {
              language[i]=(char)uprv_tolower(*localeID);
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1474,54 +1385,10 @@</span>
              char prev,
              char *variant, int32_t variantCapacity) {
      return _getVariantEx(localeID, prev, variant, variantCapacity, FALSE);
  }
  
<span class="udiff-line-removed">- /**</span>
<span class="udiff-line-removed">-  * Delete ALL instances of a variant from the given list of one or</span>
<span class="udiff-line-removed">-  * more variants.  Example: &quot;FOO_EURO_BAR_EURO&quot; =&gt; &quot;FOO_BAR&quot;.</span>
<span class="udiff-line-removed">-  * @param variants the source string of one or more variants,</span>
<span class="udiff-line-removed">-  * separated by &#39;_&#39;.  This will be MODIFIED IN PLACE.  Not zero</span>
<span class="udiff-line-removed">-  * terminated; if it is, trailing zero will NOT be maintained.</span>
<span class="udiff-line-removed">-  * @param variantsLen length of variants</span>
<span class="udiff-line-removed">-  * @param toDelete variant to delete, without separators, e.g.  &quot;EURO&quot;</span>
<span class="udiff-line-removed">-  * or &quot;PREEURO&quot;; not zero terminated</span>
<span class="udiff-line-removed">-  * @param toDeleteLen length of toDelete</span>
<span class="udiff-line-removed">-  * @return number of characters deleted from variants</span>
<span class="udiff-line-removed">-  */</span>
<span class="udiff-line-removed">- static int32_t</span>
<span class="udiff-line-removed">- _deleteVariant(char* variants, int32_t variantsLen,</span>
<span class="udiff-line-removed">-                const char* toDelete, int32_t toDeleteLen)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     int32_t delta = 0; /* number of chars deleted */</span>
<span class="udiff-line-removed">-     for (;;) {</span>
<span class="udiff-line-removed">-         UBool flag = FALSE;</span>
<span class="udiff-line-removed">-         if (variantsLen &lt; toDeleteLen) {</span>
<span class="udiff-line-removed">-             return delta;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         if (uprv_strncmp(variants, toDelete, toDeleteLen) == 0 &amp;&amp;</span>
<span class="udiff-line-removed">-             (variantsLen == toDeleteLen ||</span>
<span class="udiff-line-removed">-              (flag=(variants[toDeleteLen] == &#39;_&#39;))))</span>
<span class="udiff-line-removed">-         {</span>
<span class="udiff-line-removed">-             int32_t d = toDeleteLen + (flag?1:0);</span>
<span class="udiff-line-removed">-             variantsLen -= d;</span>
<span class="udiff-line-removed">-             delta += d;</span>
<span class="udiff-line-removed">-             if (variantsLen &gt; 0) {</span>
<span class="udiff-line-removed">-                 uprv_memmove(variants, variants+d, variantsLen);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         } else {</span>
<span class="udiff-line-removed">-             char* p = _strnchr(variants, variantsLen, &#39;_&#39;);</span>
<span class="udiff-line-removed">-             if (p == NULL) {</span>
<span class="udiff-line-removed">-                 return delta;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             ++p;</span>
<span class="udiff-line-removed">-             variantsLen -= (int32_t)(p - variants);</span>
<span class="udiff-line-removed">-             variants = p;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  /* Keyword enumeration */
  
  typedef struct UKeywordsContext {
      char* keywords;
      char* current;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1696,12 +1563,10 @@</span>
      char tempBuffer[ULOC_FULLNAME_CAPACITY];
      const char* origLocaleID;
      const char* tmpLocaleID;
      const char* keywordAssign = NULL;
      const char* separatorIndicator = NULL;
<span class="udiff-line-removed">-     const char* addKeyword = NULL;</span>
<span class="udiff-line-removed">-     const char* addValue = NULL;</span>
      char* name;
      char* variant = NULL; /* pointer into name, or NULL */
  
      if (U_FAILURE(*err)) {
          return 0;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1736,11 +1601,11 @@</span>
          const char *d = uloc_getDefault();
  
          len = (int32_t)uprv_strlen(d);
  
          if (name != NULL) {
<span class="udiff-line-modified-removed">-             uprv_strncpy(name, d, len);</span>
<span class="udiff-line-modified-added">+             uprv_memcpy(name, d, len);</span>
          }
      } else if(_isIDSeparator(*tmpLocaleID)) {
          const char *scriptID;
  
          ++fieldCount;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1862,44 +1727,19 @@</span>
                  len += posixVariantSize;
                  variantSize += posixVariantSize;
              }
          }
  
<span class="udiff-line-removed">-         /* Handle generic variants first */</span>
<span class="udiff-line-removed">-         if (variant) {</span>
<span class="udiff-line-removed">-             for (j=0; j&lt;UPRV_LENGTHOF(VARIANT_MAP); j++) {</span>
<span class="udiff-line-removed">-                 const char* variantToCompare = VARIANT_MAP[j].variant;</span>
<span class="udiff-line-removed">-                 int32_t n = (int32_t)uprv_strlen(variantToCompare);</span>
<span class="udiff-line-removed">-                 int32_t variantLen = _deleteVariant(variant, uprv_min(variantSize, (nameCapacity-len)), variantToCompare, n);</span>
<span class="udiff-line-removed">-                 len -= variantLen;</span>
<span class="udiff-line-removed">-                 if (variantLen &gt; 0) {</span>
<span class="udiff-line-removed">-                     if (len &gt; 0 &amp;&amp; name[len-1] == &#39;_&#39;) { /* delete trailing &#39;_&#39; */</span>
<span class="udiff-line-removed">-                         --len;</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-removed">-                     addKeyword = VARIANT_MAP[j].keyword;</span>
<span class="udiff-line-removed">-                     addValue = VARIANT_MAP[j].value;</span>
<span class="udiff-line-removed">-                     break;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             if (len &gt; 0 &amp;&amp; len &lt;= nameCapacity &amp;&amp; name[len-1] == &#39;_&#39;) { /* delete trailing &#39;_&#39; */</span>
<span class="udiff-line-removed">-                 --len;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
          /* Look up the ID in the canonicalization map */
          for (j=0; j&lt;UPRV_LENGTHOF(CANONICALIZE_MAP); j++) {
              const char* id = CANONICALIZE_MAP[j].id;
              int32_t n = (int32_t)uprv_strlen(id);
              if (len == n &amp;&amp; uprv_strncmp(name, id, n) == 0) {
<span class="udiff-line-removed">-                 if (CANONICALIZE_MAP[j].keyword) {</span>
<span class="udiff-line-removed">-                     addKeyword = CANONICALIZE_MAP[j].keyword;</span>
<span class="udiff-line-removed">-                     addValue = CANONICALIZE_MAP[j].value;</span>
<span class="udiff-line-removed">-                 }</span>
                  break;
              }
          }
      }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1910,18 +1750,11 @@</span>
                  name[len]=&#39;@&#39;;
              }
              ++len;
              ++fieldCount;
              len += _getKeywords(tmpLocaleID+1, &#39;@&#39;, (len&lt;nameCapacity ? name+len : NULL), nameCapacity-len,
<span class="udiff-line-modified-removed">-                                 NULL, 0, NULL, TRUE, addKeyword, addValue, err);</span>
<span class="udiff-line-removed">-         } else if (addKeyword != NULL) {</span>
<span class="udiff-line-removed">-             U_ASSERT(addValue != NULL &amp;&amp; len &lt; nameCapacity);</span>
<span class="udiff-line-removed">-             /* inelegant but works -- later make _getKeywords do this? */</span>
<span class="udiff-line-removed">-             len += _copyCount(name+len, nameCapacity-len, &quot;@&quot;);</span>
<span class="udiff-line-removed">-             len += _copyCount(name+len, nameCapacity-len, addKeyword);</span>
<span class="udiff-line-removed">-             len += _copyCount(name+len, nameCapacity-len, &quot;=&quot;);</span>
<span class="udiff-line-removed">-             len += _copyCount(name+len, nameCapacity-len, addValue);</span>
<span class="udiff-line-modified-added">+                                 NULL, 0, NULL, TRUE, err);</span>
          }
      }
  
      if (U_SUCCESS(*err) &amp;&amp; result != NULL &amp;&amp; name == localeBuffer) {
          uprv_strncpy(result, localeBuffer, (len &gt; resultCapacity) ? resultCapacity : len);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1952,13 +1785,20 @@</span>
          i=(int32_t)(lastUnderscore-localeID);
      } else {
          i=0;
      }
  
<span class="udiff-line-modified-removed">-     if(i&gt;0 &amp;&amp; parent != localeID) {</span>
<span class="udiff-line-modified-removed">-         uprv_memcpy(parent, localeID, uprv_min(i, parentCapacity));</span>
<span class="udiff-line-modified-added">+     if (i &gt; 0) {</span>
<span class="udiff-line-modified-added">+         if (uprv_strnicmp(localeID, &quot;und_&quot;, 4) == 0) {</span>
<span class="udiff-line-added">+             localeID += 3;</span>
<span class="udiff-line-added">+             i -= 3;</span>
<span class="udiff-line-added">+             uprv_memmove(parent, localeID, uprv_min(i, parentCapacity));</span>
<span class="udiff-line-added">+         } else if (parent != localeID) {</span>
<span class="udiff-line-added">+             uprv_memcpy(parent, localeID, uprv_min(i, parentCapacity));</span>
<span class="udiff-line-added">+         }</span>
      }
<span class="udiff-line-added">+ </span>
      return u_terminateChars(parent, parentCapacity, i, err);
  }
  
  U_CAPI int32_t U_EXPORT2
  uloc_getLanguage(const char*    localeID,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2177,20 +2017,23 @@</span>
      /* Check for incomplete id. */
      if (!localeID || uprv_strlen(localeID) &lt; 2) {
          return 0;
      }
  
<span class="udiff-line-modified-removed">-     // Attempt platform lookup if available</span>
<span class="udiff-line-modified-removed">-     lcid = uprv_convertToLCIDPlatform(localeID);</span>
<span class="udiff-line-modified-removed">-     if (lcid &gt; 0)</span>
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-added">+     // First, attempt Windows platform lookup if available, but fall</span>
<span class="udiff-line-modified-added">+     // through to catch any special cases (ICU vs Windows name differences).</span>
<span class="udiff-line-modified-added">+     lcid = uprv_convertToLCIDPlatform(localeID, &amp;status);</span>
<span class="udiff-line-modified-added">+     if (U_FAILURE(status)) {</span>
<span class="udiff-line-added">+         return 0;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     if (lcid &gt; 0) {</span>
          // Windows found an LCID, return that
          return lcid;
      }
  
      uloc_getLanguage(localeID, langID, sizeof(langID), &amp;status);
<span class="udiff-line-modified-removed">-     if (U_FAILURE(status)) {</span>
<span class="udiff-line-modified-added">+     if (U_FAILURE(status) || status == U_STRING_NOT_TERMINATED_WARNING) {</span>
          return 0;
      }
  
      if (uprv_strchr(localeID, &#39;@&#39;)) {
          // uprv_convertToLCID does not support keywords other than collation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2410,11 +2253,11 @@</span>
          }
          items[n].dummy=0;
          /* eat spaces prior to semi */
          for(t=(paramEnd-1);(paramEnd&gt;s)&amp;&amp;isspace(*t);t--)
              ;
<span class="udiff-line-modified-removed">-         int32_t slen = ((t+1)-s);</span>
<span class="udiff-line-modified-added">+         int32_t slen = static_cast&lt;int32_t&gt;(((t+1)-s));</span>
          if(slen &gt; ULOC_FULLNAME_CAPACITY) {
            *status = U_BUFFER_OVERFLOW_ERROR;
            return -1; // too big
          }
          uprv_strncpy(items[n].locale, s, slen);
</pre>
<center><a href="uinvchar.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="uloc_keytype.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>