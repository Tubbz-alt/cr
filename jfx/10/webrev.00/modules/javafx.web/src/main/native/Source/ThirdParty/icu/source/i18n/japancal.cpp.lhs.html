<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/ThirdParty/icu/source/i18n/japancal.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 // Â© 2016 and later: Unicode, Inc. and others.
  2 // License &amp; terms of use: http://www.unicode.org/copyright.html
  3 /*
  4 *******************************************************************************
  5 * Copyright (C) 2003-2009,2012,2016 International Business Machines Corporation and
  6 * others. All Rights Reserved.
  7 *******************************************************************************
  8 *
  9 * File JAPANCAL.CPP
 10 *
 11 * Modification History:
 12 *  05/16/2003    srl     copied from buddhcal.cpp
 13 *
 14 */
 15 
 16 #include &quot;unicode/utypes.h&quot;
 17 
 18 #if !UCONFIG_NO_FORMATTING
<a name="1" id="anc1"></a><span class="line-modified"> 19 </span>












 20 #include &quot;cmemory.h&quot;
<a name="2" id="anc2"></a>
 21 #include &quot;japancal.h&quot;
 22 #include &quot;unicode/gregocal.h&quot;
 23 #include &quot;umutex.h&quot;
 24 #include &quot;uassert.h&quot;
<a name="3" id="anc3"></a><span class="line-modified"> 25 </span>
<span class="line-modified"> 26 //#define U_DEBUG_JCAL</span>
<span class="line-modified"> 27 </span>
<span class="line-modified"> 28 #ifdef U_DEBUG_JCAL</span>
<span class="line-modified"> 29 #include &lt;stdio.h&gt;</span>
<span class="line-modified"> 30 #endif</span>












 31 
 32 U_NAMESPACE_BEGIN
 33 
 34 UOBJECT_DEFINE_RTTI_IMPLEMENTATION(JapaneseCalendar)
 35 
<a name="4" id="anc4"></a><span class="line-removed"> 36 //  Gregorian date of each emperor&#39;s ascension</span>
<span class="line-removed"> 37 //  Years are AD, months are 1-based.</span>
<span class="line-removed"> 38 static const struct {</span>
<span class="line-removed"> 39     int16_t year;</span>
<span class="line-removed"> 40     int8_t  month;</span>
<span class="line-removed"> 41     int8_t  day;</span>
<span class="line-removed"> 42 } kEraInfo[] =  {</span>
<span class="line-removed"> 43     //  Year  Month Day</span>
<span class="line-removed"> 44     {   645,    6, 19 },   // Taika   0</span>
<span class="line-removed"> 45     {   650,    2, 15 },   // Hakuchi 1</span>
<span class="line-removed"> 46     {   672,    1,  1 },   // Hakuho  2</span>
<span class="line-removed"> 47     {   686,    7, 20 },   // Shucho  3</span>
<span class="line-removed"> 48     {   701,    3, 21 },   // Taiho   4</span>
<span class="line-removed"> 49     {   704,    5, 10 },   // Keiun   5</span>
<span class="line-removed"> 50     {   708,    1, 11 },   // Wado    6</span>
<span class="line-removed"> 51     {   715,    9,  2 },   // Reiki   7</span>
<span class="line-removed"> 52     {   717,   11, 17 },   // Yoro    8</span>
<span class="line-removed"> 53     {   724,    2,  4 },   // Jinki   9</span>
<span class="line-removed"> 54     {   729,    8,  5 },   // Tempyo  10</span>
<span class="line-removed"> 55     {   749,    4, 14 },   // Tempyo-kampo 11</span>
<span class="line-removed"> 56     {   749,    7,  2 },   // Tempyo-shoho 12</span>
<span class="line-removed"> 57     {   757,    8, 18 },   // Tempyo-hoji  13</span>
<span class="line-removed"> 58     {   765,    1,  7 },   // Tempho-jingo 14</span>
<span class="line-removed"> 59     {   767,    8, 16 },   // Jingo-keiun  15</span>
<span class="line-removed"> 60     {   770,   10,  1 },   // Hoki         16</span>
<span class="line-removed"> 61     {   781,    1,  1 },   // Ten-o        17</span>
<span class="line-removed"> 62     {   782,    8, 19 },   // Enryaku      18</span>
<span class="line-removed"> 63     {   806,    5, 18 },   // Daido        19</span>
<span class="line-removed"> 64     {   810,    9, 19 },   // Konin        20</span>
<span class="line-removed"> 65     {   824,    1,  5 },   // Tencho</span>
<span class="line-removed"> 66     {   834,    1,  3 },   // Showa</span>
<span class="line-removed"> 67     {   848,    6, 13 },   // Kajo</span>
<span class="line-removed"> 68     {   851,    4, 28 },   // Ninju</span>
<span class="line-removed"> 69     {   854,   11, 30 },   // Saiko</span>
<span class="line-removed"> 70     {   857,    2, 21 },   // Tennan</span>
<span class="line-removed"> 71     {   859,    4, 15 },   // Jogan</span>
<span class="line-removed"> 72     {   877,    4, 16 },   // Genkei</span>
<span class="line-removed"> 73     {   885,    2, 21 },   // Ninna</span>
<span class="line-removed"> 74     {   889,    4, 27 },   // Kampyo       30</span>
<span class="line-removed"> 75     {   898,    4, 26 },   // Shotai</span>
<span class="line-removed"> 76     {   901,    7, 15 },   // Engi</span>
<span class="line-removed"> 77     {   923,    4, 11 },   // Encho</span>
<span class="line-removed"> 78     {   931,    4, 26 },   // Shohei</span>
<span class="line-removed"> 79     {   938,    5, 22 },   // Tengyo</span>
<span class="line-removed"> 80     {   947,    4, 22 },   // Tenryaku</span>
<span class="line-removed"> 81     {   957,   10, 27 },   // Tentoku</span>
<span class="line-removed"> 82     {   961,    2, 16 },   // Owa</span>
<span class="line-removed"> 83     {   964,    7, 10 },   // Koho</span>
<span class="line-removed"> 84     {   968,    8, 13 },   // Anna        40</span>
<span class="line-removed"> 85     {   970,    3, 25 },   // Tenroku</span>
<span class="line-removed"> 86     {   973,   12, 20 },   // Ten-en</span>
<span class="line-removed"> 87     {   976,    7, 13 },   // Jogen</span>
<span class="line-removed"> 88     {   978,   11, 29 },   // Tengen</span>
<span class="line-removed"> 89     {   983,    4, 15 },   // Eikan</span>
<span class="line-removed"> 90     {   985,    4, 27 },   // Kanna</span>
<span class="line-removed"> 91     {   987,    4,  5 },   // Ei-en</span>
<span class="line-removed"> 92     {   989,    8,  8 },   // Eiso</span>
<span class="line-removed"> 93     {   990,   11,  7 },   // Shoryaku</span>
<span class="line-removed"> 94     {   995,    2, 22 },   // Chotoku      50</span>
<span class="line-removed"> 95     {   999,    1, 13 },   // Choho</span>
<span class="line-removed"> 96     {  1004,    7, 20 },   // Kanko</span>
<span class="line-removed"> 97     {  1012,   12, 25 },   // Chowa</span>
<span class="line-removed"> 98     {  1017,    4, 23 },   // Kannin</span>
<span class="line-removed"> 99     {  1021,    2,  2 },   // Jian</span>
<span class="line-removed">100     {  1024,    7, 13 },   // Manju</span>
<span class="line-removed">101     {  1028,    7, 25 },   // Chogen</span>
<span class="line-removed">102     {  1037,    4, 21 },   // Choryaku</span>
<span class="line-removed">103     {  1040,   11, 10 },   // Chokyu</span>
<span class="line-removed">104     {  1044,   11, 24 },   // Kantoku      60</span>
<span class="line-removed">105     {  1046,    4, 14 },   // Eisho</span>
<span class="line-removed">106     {  1053,    1, 11 },   // Tengi</span>
<span class="line-removed">107     {  1058,    8, 29 },   // Kohei</span>
<span class="line-removed">108     {  1065,    8,  2 },   // Jiryaku</span>
<span class="line-removed">109     {  1069,    4, 13 },   // Enkyu</span>
<span class="line-removed">110     {  1074,    8, 23 },   // Shoho</span>
<span class="line-removed">111     {  1077,   11, 17 },   // Shoryaku</span>
<span class="line-removed">112     {  1081,    2, 10 },   // Eiho</span>
<span class="line-removed">113     {  1084,    2,  7 },   // Otoku</span>
<span class="line-removed">114     {  1087,    4,  7 },   // Kanji       70</span>
<span class="line-removed">115     {  1094,   12, 15 },   // Kaho</span>
<span class="line-removed">116     {  1096,   12, 17 },   // Eicho</span>
<span class="line-removed">117     {  1097,   11, 21 },   // Shotoku</span>
<span class="line-removed">118     {  1099,    8, 28 },   // Kowa</span>
<span class="line-removed">119     {  1104,    2, 10 },   // Choji</span>
<span class="line-removed">120     {  1106,    4,  9 },   // Kasho</span>
<span class="line-removed">121     {  1108,    8,  3 },   // Tennin</span>
<span class="line-removed">122     {  1110,    7, 13 },   // Ten-ei</span>
<span class="line-removed">123     {  1113,    7, 13 },   // Eikyu</span>
<span class="line-removed">124     {  1118,    4,  3 },   // Gen-ei      80</span>
<span class="line-removed">125     {  1120,    4, 10 },   // Hoan</span>
<span class="line-removed">126     {  1124,    4,  3 },   // Tenji</span>
<span class="line-removed">127     {  1126,    1, 22 },   // Daiji</span>
<span class="line-removed">128     {  1131,    1, 29 },   // Tensho</span>
<span class="line-removed">129     {  1132,    8, 11 },   // Chosho</span>
<span class="line-removed">130     {  1135,    4, 27 },   // Hoen</span>
<span class="line-removed">131     {  1141,    7, 10 },   // Eiji</span>
<span class="line-removed">132     {  1142,    4, 28 },   // Koji</span>
<span class="line-removed">133     {  1144,    2, 23 },   // Tenyo</span>
<span class="line-removed">134     {  1145,    7, 22 },   // Kyuan      90</span>
<span class="line-removed">135     {  1151,    1, 26 },   // Ninpei</span>
<span class="line-removed">136     {  1154,   10, 28 },   // Kyuju</span>
<span class="line-removed">137     {  1156,    4, 27 },   // Hogen</span>
<span class="line-removed">138     {  1159,    4, 20 },   // Heiji</span>
<span class="line-removed">139     {  1160,    1, 10 },   // Eiryaku</span>
<span class="line-removed">140     {  1161,    9,  4 },   // Oho</span>
<span class="line-removed">141     {  1163,    3, 29 },   // Chokan</span>
<span class="line-removed">142     {  1165,    6,  5 },   // Eiman</span>
<span class="line-removed">143     {  1166,    8, 27 },   // Nin-an</span>
<span class="line-removed">144     {  1169,    4,  8 },   // Kao       100</span>
<span class="line-removed">145     {  1171,    4, 21 },   // Shoan</span>
<span class="line-removed">146     {  1175,    7, 28 },   // Angen</span>
<span class="line-removed">147     {  1177,    8,  4 },   // Jisho</span>
<span class="line-removed">148     {  1181,    7, 14 },   // Yowa</span>
<span class="line-removed">149     {  1182,    5, 27 },   // Juei</span>
<span class="line-removed">150     {  1184,    4, 16 },   // Genryuku</span>
<span class="line-removed">151     {  1185,    8, 14 },   // Bunji</span>
<span class="line-removed">152     {  1190,    4, 11 },   // Kenkyu</span>
<span class="line-removed">153     {  1199,    4, 27 },   // Shoji</span>
<span class="line-removed">154     {  1201,    2, 13 },   // Kennin     110</span>
<span class="line-removed">155     {  1204,    2, 20 },   // Genkyu</span>
<span class="line-removed">156     {  1206,    4, 27 },   // Ken-ei</span>
<span class="line-removed">157     {  1207,   10, 25 },   // Shogen</span>
<span class="line-removed">158     {  1211,    3,  9 },   // Kenryaku</span>
<span class="line-removed">159     {  1213,   12,  6 },   // Kenpo</span>
<span class="line-removed">160     {  1219,    4, 12 },   // Shokyu</span>
<span class="line-removed">161     {  1222,    4, 13 },   // Joo</span>
<span class="line-removed">162     {  1224,   11, 20 },   // Gennin</span>
<span class="line-removed">163     {  1225,    4, 20 },   // Karoku</span>
<span class="line-removed">164     {  1227,   12, 10 },   // Antei      120</span>
<span class="line-removed">165     {  1229,    3,  5 },   // Kanki</span>
<span class="line-removed">166     {  1232,    4,  2 },   // Joei</span>
<span class="line-removed">167     {  1233,    4, 15 },   // Tempuku</span>
<span class="line-removed">168     {  1234,   11,  5 },   // Bunryaku</span>
<span class="line-removed">169     {  1235,    9, 19 },   // Katei</span>
<span class="line-removed">170     {  1238,   11, 23 },   // Ryakunin</span>
<span class="line-removed">171     {  1239,    2,  7 },   // En-o</span>
<span class="line-removed">172     {  1240,    7, 16 },   // Ninji</span>
<span class="line-removed">173     {  1243,    2, 26 },   // Kangen</span>
<span class="line-removed">174     {  1247,    2, 28 },   // Hoji      130</span>
<span class="line-removed">175     {  1249,    3, 18 },   // Kencho</span>
<span class="line-removed">176     {  1256,   10,  5 },   // Kogen</span>
<span class="line-removed">177     {  1257,    3, 14 },   // Shoka</span>
<span class="line-removed">178     {  1259,    3, 26 },   // Shogen</span>
<span class="line-removed">179     {  1260,    4, 13 },   // Bun-o</span>
<span class="line-removed">180     {  1261,    2, 20 },   // Kocho</span>
<span class="line-removed">181     {  1264,    2, 28 },   // Bun-ei</span>
<span class="line-removed">182     {  1275,    4, 25 },   // Kenji</span>
<span class="line-removed">183     {  1278,    2, 29 },   // Koan</span>
<span class="line-removed">184     {  1288,    4, 28 },   // Shoo      140</span>
<span class="line-removed">185     {  1293,    8, 55 },   // Einin</span>
<span class="line-removed">186     {  1299,    4, 25 },   // Shoan</span>
<span class="line-removed">187     {  1302,   11, 21 },   // Kengen</span>
<span class="line-removed">188     {  1303,    8,  5 },   // Kagen</span>
<span class="line-removed">189     {  1306,   12, 14 },   // Tokuji</span>
<span class="line-removed">190     {  1308,   10,  9 },   // Enkei</span>
<span class="line-removed">191     {  1311,    4, 28 },   // Ocho</span>
<span class="line-removed">192     {  1312,    3, 20 },   // Showa</span>
<span class="line-removed">193     {  1317,    2,  3 },   // Bunpo</span>
<span class="line-removed">194     {  1319,    4, 28 },   // Geno      150</span>
<span class="line-removed">195     {  1321,    2, 23 },   // Genkyo</span>
<span class="line-removed">196     {  1324,   12,  9 },   // Shochu</span>
<span class="line-removed">197     {  1326,    4, 26 },   // Kareki</span>
<span class="line-removed">198     {  1329,    8, 29 },   // Gentoku</span>
<span class="line-removed">199     {  1331,    8,  9 },   // Genko</span>
<span class="line-removed">200     {  1334,    1, 29 },   // Kemmu</span>
<span class="line-removed">201     {  1336,    2, 29 },   // Engen</span>
<span class="line-removed">202     {  1340,    4, 28 },   // Kokoku</span>
<span class="line-removed">203     {  1346,   12,  8 },   // Shohei</span>
<span class="line-removed">204     {  1370,    7, 24 },   // Kentoku       160</span>
<span class="line-removed">205     {  1372,    4,  1 },   // Bunch\u0169</span>
<span class="line-removed">206     {  1375,    5, 27 },   // Tenju</span>
<span class="line-removed">207     {  1379,    3, 22 },   // Koryaku</span>
<span class="line-removed">208     {  1381,    2, 10 },   // Kowa</span>
<span class="line-removed">209     {  1384,    4, 28 },   // Gench\u0169</span>
<span class="line-removed">210     {  1384,    2, 27 },   // Meitoku</span>
<span class="line-removed">211     {  1387,    8, 23 },   // Kakei</span>
<span class="line-removed">212     {  1389,    2,  9 },   // Koo</span>
<span class="line-removed">213     {  1390,    3, 26 },   // Meitoku</span>
<span class="line-removed">214     {  1394,    7,  5 },   // Oei           170</span>
<span class="line-removed">215     {  1428,    4, 27 },   // Shocho</span>
<span class="line-removed">216     {  1429,    9,  5 },   // Eikyo</span>
<span class="line-removed">217     {  1441,    2, 17 },   // Kakitsu</span>
<span class="line-removed">218     {  1444,    2,  5 },   // Bun-an</span>
<span class="line-removed">219     {  1449,    7, 28 },   // Hotoku</span>
<span class="line-removed">220     {  1452,    7, 25 },   // Kyotoku</span>
<span class="line-removed">221     {  1455,    7, 25 },   // Kosho</span>
<span class="line-removed">222     {  1457,    9, 28 },   // Choroku</span>
<span class="line-removed">223     {  1460,   12, 21 },   // Kansho</span>
<span class="line-removed">224     {  1466,    2, 28 },   // Bunsho        180</span>
<span class="line-removed">225     {  1467,    3,  3 },   // Onin</span>
<span class="line-removed">226     {  1469,    4, 28 },   // Bunmei</span>
<span class="line-removed">227     {  1487,    7, 29 },   // Chokyo</span>
<span class="line-removed">228     {  1489,    8, 21 },   // Entoku</span>
<span class="line-removed">229     {  1492,    7, 19 },   // Meio</span>
<span class="line-removed">230     {  1501,    2, 29 },   // Bunki</span>
<span class="line-removed">231     {  1504,    2, 30 },   // Eisho</span>
<span class="line-removed">232     {  1521,    8, 23 },   // Taiei</span>
<span class="line-removed">233     {  1528,    8, 20 },   // Kyoroku</span>
<span class="line-removed">234     {  1532,    7, 29 },   // Tenmon       190</span>
<span class="line-removed">235     {  1555,   10, 23 },   // Koji</span>
<span class="line-removed">236     {  1558,    2, 28 },   // Eiroku</span>
<span class="line-removed">237     {  1570,    4, 23 },   // Genki</span>
<span class="line-removed">238     {  1573,    7, 28 },   // Tensho</span>
<span class="line-removed">239     {  1592,   12,  8 },   // Bunroku</span>
<span class="line-removed">240     {  1596,   10, 27 },   // Keicho</span>
<span class="line-removed">241     {  1615,    7, 13 },   // Genwa</span>
<span class="line-removed">242     {  1624,    2, 30 },   // Kan-ei</span>
<span class="line-removed">243     {  1644,   12, 16 },   // Shoho</span>
<span class="line-removed">244     {  1648,    2, 15 },   // Keian       200</span>
<span class="line-removed">245     {  1652,    9, 18 },   // Shoo</span>
<span class="line-removed">246     {  1655,    4, 13 },   // Meiryaku</span>
<span class="line-removed">247     {  1658,    7, 23 },   // Manji</span>
<span class="line-removed">248     {  1661,    4, 25 },   // Kanbun</span>
<span class="line-removed">249     {  1673,    9, 21 },   // Enpo</span>
<span class="line-removed">250     {  1681,    9, 29 },   // Tenwa</span>
<span class="line-removed">251     {  1684,    2, 21 },   // Jokyo</span>
<span class="line-removed">252     {  1688,    9, 30 },   // Genroku</span>
<span class="line-removed">253     {  1704,    3, 13 },   // Hoei</span>
<span class="line-removed">254     {  1711,    4, 25 },   // Shotoku      210</span>
<span class="line-removed">255     {  1716,    6, 22 },   // Kyoho</span>
<span class="line-removed">256     {  1736,    4, 28 },   // Genbun</span>
<span class="line-removed">257     {  1741,    2, 27 },   // Kanpo</span>
<span class="line-removed">258     {  1744,    2, 21 },   // Enkyo</span>
<span class="line-removed">259     {  1748,    7, 12 },   // Kan-en</span>
<span class="line-removed">260     {  1751,   10, 27 },   // Horyaku</span>
<span class="line-removed">261     {  1764,    6,  2 },   // Meiwa</span>
<span class="line-removed">262     {  1772,   11, 16 },   // An-ei</span>
<span class="line-removed">263     {  1781,    4,  2 },   // Tenmei</span>
<span class="line-removed">264     {  1789,    1, 25 },   // Kansei      220</span>
<span class="line-removed">265     {  1801,    2,  5 },   // Kyowa</span>
<span class="line-removed">266     {  1804,    2, 11 },   // Bunka</span>
<span class="line-removed">267     {  1818,    4, 22 },   // Bunsei</span>
<span class="line-removed">268     {  1830,   12, 10 },   // Tenpo</span>
<span class="line-removed">269     {  1844,   12,  2 },   // Koka</span>
<span class="line-removed">270     {  1848,    2, 28 },   // Kaei</span>
<span class="line-removed">271     {  1854,   11, 27 },   // Ansei</span>
<span class="line-removed">272     {  1860,    3, 18 },   // Man-en</span>
<span class="line-removed">273     {  1861,    2, 19 },   // Bunkyu</span>
<span class="line-removed">274     {  1864,    2, 20 },   // Genji        230</span>
<span class="line-removed">275     {  1865,    4,  7 },   // Keio     231</span>
<span class="line-removed">276     {  1868,    9,  8 },   // Meiji    232</span>
<span class="line-removed">277     {  1912,    7, 30 },   // Taisho   233</span>
<span class="line-removed">278     {  1926,   12, 25 },   // Showa    234</span>
<span class="line-removed">279     {  1989,    1,  8 }   // Heisei    235</span>
<span class="line-removed">280 };</span>
<span class="line-removed">281 </span>
<span class="line-removed">282 #define kEraCount UPRV_LENGTHOF(kEraInfo)</span>
<span class="line-removed">283 </span>
<span class="line-removed">284 /**</span>
<span class="line-removed">285  * The current era, for reference.</span>
<span class="line-removed">286  */</span>
<span class="line-removed">287 static const int32_t kCurrentEra = (kEraCount-1);  // int32_t to match the calendar field type</span>
<span class="line-removed">288 </span>
289 static const int32_t kGregorianEpoch = 1970;    // used as the default value of EXTENDED_YEAR
<a name="5" id="anc5"></a>













































290 
291 /* Some platforms don&#39;t like to export constants, like old Palm OS and some z/OS configurations. */
292 uint32_t JapaneseCalendar::getCurrentEra() {
<a name="6" id="anc6"></a><span class="line-modified">293     return kCurrentEra;</span>
294 }
295 
296 JapaneseCalendar::JapaneseCalendar(const Locale&amp; aLocale, UErrorCode&amp; success)
297 :   GregorianCalendar(aLocale, success)
298 {
<a name="7" id="anc7"></a>
299     setTimeInMillis(getNow(), success); // Call this again now that the vtable is set up properly.
300 }
301 
302 JapaneseCalendar::~JapaneseCalendar()
303 {
304 }
305 
306 JapaneseCalendar::JapaneseCalendar(const JapaneseCalendar&amp; source)
307 : GregorianCalendar(source)
308 {
<a name="8" id="anc8"></a>


309 }
310 
311 JapaneseCalendar&amp; JapaneseCalendar::operator= ( const JapaneseCalendar&amp; right)
312 {
313     GregorianCalendar::operator=(right);
314     return *this;
315 }
316 
317 Calendar* JapaneseCalendar::clone(void) const
318 {
319     return new JapaneseCalendar(*this);
320 }
321 
322 const char *JapaneseCalendar::getType() const
323 {
324     return &quot;japanese&quot;;
325 }
326 
327 int32_t JapaneseCalendar::getDefaultMonthInYear(int32_t eyear)
328 {
329     int32_t era = internalGetEra();
330     // TODO do we assume we can trust &#39;era&#39;?  What if it is denormalized?
331 
332     int32_t month = 0;
333 
334     // Find out if we are at the edge of an era
<a name="9" id="anc9"></a><span class="line-modified">335 </span>
<span class="line-modified">336     if(eyear == kEraInfo[era].year) {</span>



337         // Yes, we&#39;re in the first year of this era.
<a name="10" id="anc10"></a><span class="line-modified">338         return kEraInfo[era].month-1;</span>

339     }
340 
341     return month;
342 }
343 
344 int32_t JapaneseCalendar::getDefaultDayInMonth(int32_t eyear, int32_t month)
345 {
346     int32_t era = internalGetEra();
347     int32_t day = 1;
348 
<a name="11" id="anc11"></a><span class="line-modified">349     if(eyear == kEraInfo[era].year) {</span>
<span class="line-modified">350         if(month == (kEraInfo[era].month-1)) {</span>
<span class="line-modified">351             return kEraInfo[era].day;</span>




352         }
353     }
354 
355     return day;
356 }
357 
358 
359 int32_t JapaneseCalendar::internalGetEra() const
360 {
<a name="12" id="anc12"></a><span class="line-modified">361     return internalGet(UCAL_ERA, kCurrentEra);</span>
362 }
363 
364 int32_t JapaneseCalendar::handleGetExtendedYear()
365 {
366     // EXTENDED_YEAR in JapaneseCalendar is a Gregorian year
367     // The default value of EXTENDED_YEAR is 1970 (Showa 45)
368     int32_t year;
369 
370     if (newerField(UCAL_EXTENDED_YEAR, UCAL_YEAR) == UCAL_EXTENDED_YEAR &amp;&amp;
371         newerField(UCAL_EXTENDED_YEAR, UCAL_ERA) == UCAL_EXTENDED_YEAR) {
<a name="13" id="anc13"></a><span class="line-modified">372             year = internalGet(UCAL_EXTENDED_YEAR, kGregorianEpoch);</span>
<span class="line-modified">373         } else {</span>
<span class="line-modified">374             // Subtract one because year starts at 1</span>
<span class="line-modified">375             year = internalGet(UCAL_YEAR) + kEraInfo[internalGetEra()].year - 1;</span>
<span class="line-modified">376         }</span>
<span class="line-modified">377         return year;</span>






378 }
379 
380 
381 void JapaneseCalendar::handleComputeFields(int32_t julianDay, UErrorCode&amp; status)
382 {
383     //Calendar::timeToFields(theTime, quick, status);
384     GregorianCalendar::handleComputeFields(julianDay, status);
385     int32_t year = internalGet(UCAL_EXTENDED_YEAR); // Gregorian year
<a name="14" id="anc14"></a>
386 
<a name="15" id="anc15"></a><span class="line-modified">387     int32_t low = 0;</span>
<span class="line-modified">388 </span>
<span class="line-removed">389     // Short circuit for recent years.  Most modern computations will</span>
<span class="line-removed">390     // occur in the current era and won&#39;t require the binary search.</span>
<span class="line-removed">391     // Note that if the year is == the current era year, then we use</span>
<span class="line-removed">392     // the binary search to handle the month/dom comparison.</span>
<span class="line-removed">393 #ifdef U_DEBUG_JCAL</span>
<span class="line-removed">394     fprintf(stderr, &quot;==  %d \n&quot;, year);</span>
<span class="line-removed">395 #endif</span>
<span class="line-removed">396 </span>
<span class="line-removed">397     if (year &gt; kEraInfo[kCurrentEra].year) {</span>
<span class="line-removed">398         low = kCurrentEra;</span>
<span class="line-removed">399 #ifdef U_DEBUG_JCAL</span>
<span class="line-removed">400         fprintf(stderr, &quot; low=%d (special)\n&quot;, low);</span>
<span class="line-removed">401 #endif</span>
<span class="line-removed">402     } else {</span>
<span class="line-removed">403         // Binary search</span>
<span class="line-removed">404         int32_t high = kEraCount;</span>
<span class="line-removed">405 </span>
<span class="line-removed">406 #ifdef U_DEBUG_JCAL</span>
<span class="line-removed">407         fprintf(stderr, &quot; high=%d\n&quot;, high);</span>
<span class="line-removed">408 #endif</span>
<span class="line-removed">409         while (low &lt; high - 1) {</span>
<span class="line-removed">410             int32_t i = (low + high) / 2;</span>
<span class="line-removed">411             int32_t diff = year - kEraInfo[i].year;</span>
<span class="line-removed">412 </span>
<span class="line-removed">413 #ifdef U_DEBUG_JCAL</span>
<span class="line-removed">414             fprintf(stderr, &quot;  d=%d   low=%d, high=%d. Considering %d:M%d D%d Y%d. { we are ?:M%d D%d Y%d }\n&quot;,</span>
<span class="line-removed">415                 diff,low, high, i, kEraInfo[i].month-1, kEraInfo[i].day,  kEraInfo[i].year, internalGet(UCAL_MONTH), internalGet(UCAL_DATE),year);</span>
<span class="line-removed">416 #endif</span>
<span class="line-removed">417 </span>
<span class="line-removed">418             // If years are the same, then compare the months, and if those</span>
<span class="line-removed">419             // are the same, compare days of month.  In the ERAS array</span>
<span class="line-removed">420             // months are 1-based for easier maintenance.</span>
<span class="line-removed">421             if (diff == 0) {</span>
<span class="line-removed">422                 diff = internalGet(UCAL_MONTH) - (kEraInfo[i].month - 1);</span>
<span class="line-removed">423 #ifdef U_DEBUG_JCAL</span>
<span class="line-removed">424                 fprintf(stderr, &quot;diff now %d (M)  = %d - %d - 1\n&quot;, diff, internalGet(UCAL_MONTH), kEraInfo[i].month);</span>
<span class="line-removed">425 #endif</span>
<span class="line-removed">426                 if (diff == 0) {</span>
<span class="line-removed">427                     diff = internalGet(UCAL_DATE) - kEraInfo[i].day;</span>
<span class="line-removed">428 #ifdef U_DEBUG_JCAL</span>
<span class="line-removed">429                     fprintf(stderr, &quot;diff now %d (D)\n&quot;, diff);</span>
<span class="line-removed">430 #endif</span>
<span class="line-removed">431                 }</span>
<span class="line-removed">432             }</span>
<span class="line-removed">433             if (diff &gt;= 0) {</span>
<span class="line-removed">434                 low = i;</span>
<span class="line-removed">435             } else {</span>
<span class="line-removed">436                 high = i;</span>
<span class="line-removed">437             }</span>
<span class="line-removed">438 #ifdef U_DEBUG_JCAL</span>
<span class="line-removed">439             fprintf(stderr, &quot;. low=%d, high=%d, i=%d, diff=%d.. %d\n&quot;, low, high, i, diff, year);</span>
<span class="line-removed">440 #endif</span>
<span class="line-removed">441 </span>
<span class="line-removed">442         }</span>
<span class="line-removed">443     }</span>
<span class="line-removed">444 </span>
<span class="line-removed">445 #ifdef U_DEBUG_JCAL</span>
<span class="line-removed">446     fprintf(stderr, &quot;  low[era]=%d,.. %d\n&quot;, low, year);</span>
<span class="line-removed">447 #endif</span>
<span class="line-removed">448     // Now we&#39;ve found the last era that starts before this date, so</span>
<span class="line-removed">449     // adjust the year to count from the start of that era.  Note that</span>
<span class="line-removed">450     // all dates before the first era will fall into the first era by</span>
<span class="line-removed">451     // the algorithm.</span>
<span class="line-removed">452 </span>
<span class="line-removed">453     internalSet(UCAL_ERA, low);</span>
<span class="line-removed">454     internalSet(UCAL_YEAR, year - kEraInfo[low].year + 1);</span>
<span class="line-removed">455 #ifdef U_DEBUG_JCAL</span>
<span class="line-removed">456     fprintf(stderr, &quot;  Set ERA=%d, year=%d\n&quot;, low, year-kEraInfo[low].year+1);</span>
<span class="line-removed">457 #endif</span>
<span class="line-removed">458 </span>
459 }
460 
461 /*
462 Disable pivoting
463 */
464 UBool JapaneseCalendar::haveDefaultCentury() const
465 {
466     return FALSE;
467 }
468 
469 UDate JapaneseCalendar::defaultCenturyStart() const
470 {
471     return 0;// WRONG
472 }
473 
474 int32_t JapaneseCalendar::defaultCenturyStartYear() const
475 {
476     return 0;
477 }
478 
479 int32_t JapaneseCalendar::handleGetLimit(UCalendarDateFields field, ELimitType limitType) const
480 {
481     switch(field) {
482     case UCAL_ERA:
483         if (limitType == UCAL_LIMIT_MINIMUM || limitType == UCAL_LIMIT_GREATEST_MINIMUM) {
484             return 0;
485         }
<a name="16" id="anc16"></a><span class="line-modified">486         return kCurrentEra;</span>
487     case UCAL_YEAR:
488         {
489             switch (limitType) {
490             case UCAL_LIMIT_MINIMUM:
491             case UCAL_LIMIT_GREATEST_MINIMUM:
492                 return 1;
493             case UCAL_LIMIT_LEAST_MAXIMUM:
494                 return 1;
495             case  UCAL_LIMIT_COUNT: //added to avoid warning
496             case UCAL_LIMIT_MAXIMUM:
<a name="17" id="anc17"></a><span class="line-modified">497                 return GregorianCalendar::handleGetLimit(UCAL_YEAR, UCAL_LIMIT_MAXIMUM) - kEraInfo[kCurrentEra].year;</span>





498             default:
499                 return 1;    // Error condition, invalid limitType
500             }
501         }
502     default:
503         return GregorianCalendar::handleGetLimit(field,limitType);
504     }
505 }
506 
507 int32_t JapaneseCalendar::getActualMaximum(UCalendarDateFields field, UErrorCode&amp; status) const {
508     if (field == UCAL_YEAR) {
509         int32_t era = get(UCAL_ERA, status);
510         if (U_FAILURE(status)) {
511             return 0; // error case... any value
512         }
<a name="18" id="anc18"></a><span class="line-modified">513         if (era == kCurrentEra) {</span>
514             // TODO: Investigate what value should be used here - revisit after 4.0.
515             return handleGetLimit(UCAL_YEAR, UCAL_LIMIT_MAXIMUM);
516         } else {
<a name="19" id="anc19"></a><span class="line-modified">517             int32_t nextEraYear = kEraInfo[era + 1].year;</span>
<span class="line-modified">518             int32_t nextEraMonth = kEraInfo[era + 1].month;</span>
<span class="line-modified">519             int32_t nextEraDate = kEraInfo[era + 1].day;</span>
<span class="line-modified">520 </span>
<span class="line-modified">521             int32_t maxYear = nextEraYear - kEraInfo[era].year + 1; // 1-base</span>



522             if (nextEraMonth == 1 &amp;&amp; nextEraDate == 1) {
523                 // Subtract 1, because the next era starts at Jan 1
524                 maxYear--;
525             }
526             return maxYear;
527         }
528     }
529     return GregorianCalendar::getActualMaximum(field, status);
530 }
531 
532 U_NAMESPACE_END
533 
534 #endif
<a name="20" id="anc20"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="20" type="hidden" />
</body>
</html>