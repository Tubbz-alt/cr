<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/ThirdParty/icu/source/i18n/ucol_res.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ucln_in.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="udat.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/ThirdParty/icu/source/i18n/ucol_res.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
331             // fall back to the default type
332             typesTried |= TRIED_DEFAULT;
333             uprv_strcpy(type, defaultType);
334         } else if((typesTried &amp; TRIED_STANDARD) == 0) {
335             // fall back to the &quot;standard&quot; type
336             typesTried |= TRIED_STANDARD;
337             uprv_strcpy(type, &quot;standard&quot;);
338         } else {
339             // Return the root tailoring with the validLocale, without collation type.
340             return makeCacheEntryFromRoot(validLocale, errorCode);
341         }
342         locale.setKeywordValue(&quot;collation&quot;, type, errorCode);
343         return getCacheEntry(errorCode);
344     }
345     if(U_FAILURE(errorCode)) { return NULL; }
346 
347     data = localData.orphan();
348     const char *actualLocale = ures_getLocaleByType(data, ULOC_ACTUAL_LOCALE, &amp;errorCode);
349     if(U_FAILURE(errorCode)) { return NULL; }
350     const char *vLocale = validLocale.getBaseName();
<span class="line-modified">351     UBool actualAndValidLocalesAreDifferent = uprv_strcmp(actualLocale, vLocale) != 0;</span>
352 
353     // Set the collation types on the informational locales,
354     // except when they match the default types (for brevity and backwards compatibility).
355     // For the valid locale, suppress the default type.
356     if(uprv_strcmp(type, defaultType) != 0) {
357         validLocale.setKeywordValue(&quot;collation&quot;, type, errorCode);
358         if(U_FAILURE(errorCode)) { return NULL; }
359     }
360 
361     // Is this the same as the root collator? If so, then use that instead.
362     if((*actualLocale == 0 || uprv_strcmp(actualLocale, &quot;root&quot;) == 0) &amp;&amp;
363             uprv_strcmp(type, &quot;standard&quot;) == 0) {
364         if(typeFallback) {
365             errorCode = U_USING_DEFAULT_WARNING;
366         }
367         return makeCacheEntryFromRoot(validLocale, errorCode);
368     }
369 
370     locale = Locale(actualLocale);
371     if(actualAndValidLocalesAreDifferent) {
</pre>
<hr />
<pre>
383     LocalPointer&lt;CollationTailoring&gt; t(new CollationTailoring(rootEntry-&gt;tailoring-&gt;settings));
384     if(t.isNull() || t-&gt;isBogus()) {
385         errorCode = U_MEMORY_ALLOCATION_ERROR;
386         return NULL;
387     }
388 
389     // deserialize
390     LocalUResourceBundlePointer binary(ures_getByKey(data, &quot;%%CollationBin&quot;, NULL, &amp;errorCode));
391     // Note: U_MISSING_RESOURCE_ERROR --&gt; The old code built from rules if available
392     // but that created undesirable dependencies.
393     int32_t length;
394     const uint8_t *inBytes = ures_getBinary(binary.getAlias(), &amp;length, &amp;errorCode);
395     CollationDataReader::read(rootEntry-&gt;tailoring, inBytes, length, *t, errorCode);
396     // Note: U_COLLATOR_VERSION_MISMATCH --&gt; The old code built from rules if available
397     // but that created undesirable dependencies.
398     if(U_FAILURE(errorCode)) { return NULL; }
399 
400     // Try to fetch the optional rules string.
401     {
402         UErrorCode internalErrorCode = U_ZERO_ERROR;
<span class="line-modified">403         int32_t length;</span>
<span class="line-modified">404         const UChar *s = ures_getStringByKey(data, &quot;Sequence&quot;, &amp;length,</span>
405                                              &amp;internalErrorCode);
406         if(U_SUCCESS(internalErrorCode)) {
<span class="line-modified">407             t-&gt;rules.setTo(TRUE, s, length);</span>
408         }
409     }
410 
411     const char *actualLocale = locale.getBaseName();  // without type
412     const char *vLocale = validLocale.getBaseName();
<span class="line-modified">413     UBool actualAndValidLocalesAreDifferent = uprv_strcmp(actualLocale, vLocale) != 0;</span>
414 
415     // For the actual locale, suppress the default type *according to the actual locale*.
416     // For example, zh has default=pinyin and contains all of the Chinese tailorings.
417     // zh_Hant has default=stroke but has no other data.
418     // For the valid locale &quot;zh_Hant&quot; we need to suppress stroke.
419     // For the actual locale &quot;zh&quot; we need to suppress pinyin instead.
420     if(actualAndValidLocalesAreDifferent) {
421         // Opening a bundle for the actual locale should always succeed.
422         LocalUResourceBundlePointer actualBundle(
423                 ures_open(U_ICUDATA_COLL, actualLocale, &amp;errorCode));
424         if(U_FAILURE(errorCode)) { return NULL; }
425         UErrorCode internalErrorCode = U_ZERO_ERROR;
426         LocalUResourceBundlePointer def(
427                 ures_getByKeyWithFallback(actualBundle.getAlias(), &quot;collations/default&quot;, NULL,
428                                           &amp;internalErrorCode));
<span class="line-modified">429         int32_t length;</span>
<span class="line-modified">430         const UChar *s = ures_getString(def.getAlias(), &amp;length, &amp;internalErrorCode);</span>
<span class="line-modified">431         if(U_SUCCESS(internalErrorCode) &amp;&amp; length &lt; UPRV_LENGTHOF(defaultType)) {</span>
<span class="line-modified">432             u_UCharsToChars(s, defaultType, length + 1);</span>
433         } else {
434             uprv_strcpy(defaultType, &quot;standard&quot;);
435         }
436     }
437     t-&gt;actualLocale = locale;
438     if(uprv_strcmp(type, defaultType) != 0) {
439         t-&gt;actualLocale.setKeywordValue(&quot;collation&quot;, type, errorCode);
440     } else if(uprv_strcmp(locale.getName(), locale.getBaseName()) != 0) {
441         // Remove the collation keyword if it was set.
442         t-&gt;actualLocale.setKeywordValue(&quot;collation&quot;, NULL, errorCode);
443     }
444     if(U_FAILURE(errorCode)) { return NULL; }
445 
446     if(typeFallback) {
447         errorCode = U_USING_DEFAULT_WARNING;
448     }
449     t-&gt;bundle = bundle;
450     bundle = NULL;
451     const CollationCacheEntry *entry = new CollationCacheEntry(validLocale, t.getAlias());
452     if(entry == NULL) {
</pre>
</td>
<td>
<hr />
<pre>
331             // fall back to the default type
332             typesTried |= TRIED_DEFAULT;
333             uprv_strcpy(type, defaultType);
334         } else if((typesTried &amp; TRIED_STANDARD) == 0) {
335             // fall back to the &quot;standard&quot; type
336             typesTried |= TRIED_STANDARD;
337             uprv_strcpy(type, &quot;standard&quot;);
338         } else {
339             // Return the root tailoring with the validLocale, without collation type.
340             return makeCacheEntryFromRoot(validLocale, errorCode);
341         }
342         locale.setKeywordValue(&quot;collation&quot;, type, errorCode);
343         return getCacheEntry(errorCode);
344     }
345     if(U_FAILURE(errorCode)) { return NULL; }
346 
347     data = localData.orphan();
348     const char *actualLocale = ures_getLocaleByType(data, ULOC_ACTUAL_LOCALE, &amp;errorCode);
349     if(U_FAILURE(errorCode)) { return NULL; }
350     const char *vLocale = validLocale.getBaseName();
<span class="line-modified">351     UBool actualAndValidLocalesAreDifferent = Locale(actualLocale) != Locale(vLocale);</span>
352 
353     // Set the collation types on the informational locales,
354     // except when they match the default types (for brevity and backwards compatibility).
355     // For the valid locale, suppress the default type.
356     if(uprv_strcmp(type, defaultType) != 0) {
357         validLocale.setKeywordValue(&quot;collation&quot;, type, errorCode);
358         if(U_FAILURE(errorCode)) { return NULL; }
359     }
360 
361     // Is this the same as the root collator? If so, then use that instead.
362     if((*actualLocale == 0 || uprv_strcmp(actualLocale, &quot;root&quot;) == 0) &amp;&amp;
363             uprv_strcmp(type, &quot;standard&quot;) == 0) {
364         if(typeFallback) {
365             errorCode = U_USING_DEFAULT_WARNING;
366         }
367         return makeCacheEntryFromRoot(validLocale, errorCode);
368     }
369 
370     locale = Locale(actualLocale);
371     if(actualAndValidLocalesAreDifferent) {
</pre>
<hr />
<pre>
383     LocalPointer&lt;CollationTailoring&gt; t(new CollationTailoring(rootEntry-&gt;tailoring-&gt;settings));
384     if(t.isNull() || t-&gt;isBogus()) {
385         errorCode = U_MEMORY_ALLOCATION_ERROR;
386         return NULL;
387     }
388 
389     // deserialize
390     LocalUResourceBundlePointer binary(ures_getByKey(data, &quot;%%CollationBin&quot;, NULL, &amp;errorCode));
391     // Note: U_MISSING_RESOURCE_ERROR --&gt; The old code built from rules if available
392     // but that created undesirable dependencies.
393     int32_t length;
394     const uint8_t *inBytes = ures_getBinary(binary.getAlias(), &amp;length, &amp;errorCode);
395     CollationDataReader::read(rootEntry-&gt;tailoring, inBytes, length, *t, errorCode);
396     // Note: U_COLLATOR_VERSION_MISMATCH --&gt; The old code built from rules if available
397     // but that created undesirable dependencies.
398     if(U_FAILURE(errorCode)) { return NULL; }
399 
400     // Try to fetch the optional rules string.
401     {
402         UErrorCode internalErrorCode = U_ZERO_ERROR;
<span class="line-modified">403         int32_t len;</span>
<span class="line-modified">404         const UChar *s = ures_getStringByKey(data, &quot;Sequence&quot;, &amp;len,</span>
405                                              &amp;internalErrorCode);
406         if(U_SUCCESS(internalErrorCode)) {
<span class="line-modified">407             t-&gt;rules.setTo(TRUE, s, len);</span>
408         }
409     }
410 
411     const char *actualLocale = locale.getBaseName();  // without type
412     const char *vLocale = validLocale.getBaseName();
<span class="line-modified">413     UBool actualAndValidLocalesAreDifferent = Locale(actualLocale) != Locale(vLocale);</span>
414 
415     // For the actual locale, suppress the default type *according to the actual locale*.
416     // For example, zh has default=pinyin and contains all of the Chinese tailorings.
417     // zh_Hant has default=stroke but has no other data.
418     // For the valid locale &quot;zh_Hant&quot; we need to suppress stroke.
419     // For the actual locale &quot;zh&quot; we need to suppress pinyin instead.
420     if(actualAndValidLocalesAreDifferent) {
421         // Opening a bundle for the actual locale should always succeed.
422         LocalUResourceBundlePointer actualBundle(
423                 ures_open(U_ICUDATA_COLL, actualLocale, &amp;errorCode));
424         if(U_FAILURE(errorCode)) { return NULL; }
425         UErrorCode internalErrorCode = U_ZERO_ERROR;
426         LocalUResourceBundlePointer def(
427                 ures_getByKeyWithFallback(actualBundle.getAlias(), &quot;collations/default&quot;, NULL,
428                                           &amp;internalErrorCode));
<span class="line-modified">429         int32_t len;</span>
<span class="line-modified">430         const UChar *s = ures_getString(def.getAlias(), &amp;len, &amp;internalErrorCode);</span>
<span class="line-modified">431         if(U_SUCCESS(internalErrorCode) &amp;&amp; len &lt; UPRV_LENGTHOF(defaultType)) {</span>
<span class="line-modified">432             u_UCharsToChars(s, defaultType, len + 1);</span>
433         } else {
434             uprv_strcpy(defaultType, &quot;standard&quot;);
435         }
436     }
437     t-&gt;actualLocale = locale;
438     if(uprv_strcmp(type, defaultType) != 0) {
439         t-&gt;actualLocale.setKeywordValue(&quot;collation&quot;, type, errorCode);
440     } else if(uprv_strcmp(locale.getName(), locale.getBaseName()) != 0) {
441         // Remove the collation keyword if it was set.
442         t-&gt;actualLocale.setKeywordValue(&quot;collation&quot;, NULL, errorCode);
443     }
444     if(U_FAILURE(errorCode)) { return NULL; }
445 
446     if(typeFallback) {
447         errorCode = U_USING_DEFAULT_WARNING;
448     }
449     t-&gt;bundle = bundle;
450     bundle = NULL;
451     const CollationCacheEntry *entry = new CollationCacheEntry(validLocale, t.getAlias());
452     if(entry == NULL) {
</pre>
</td>
</tr>
</table>
<center><a href="ucln_in.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="udat.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>