<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/ThirdParty/icu/source/common/udata.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ucurr.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="udataswp.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/ThirdParty/icu/source/common/udata.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -416,11 +416,12 @@</span>
  
  private:
      const char *path;                              /* working path (u_icudata_Dir) */
      const char *nextPath;                          /* path following this one */
      const char *basename;                          /* item&#39;s basename (icudt22e_mt.res)*/
<span class="udiff-line-modified-removed">-     const char *suffix;                            /* item suffix (can be null) */</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+     StringPiece suffix;                            /* item suffix (can be null) */</span>
  
      uint32_t    basenameLen;                       /* length of basename */
  
      CharString  itemPath;                          /* path passed in with item name */
      CharString  pathBuffer;                        /* output path for this it&#39;ion */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -430,17 +431,19 @@</span>
                                                      * to match, checks last 4 chars of suffix with
                                                      * last 4 of path, then previous chars. */
  };
  
  /**
<span class="udiff-line-modified-removed">-  * @param iter  The iterator to be initialized. Its current state does not matter.</span>
<span class="udiff-line-modified-removed">-  * @param path  The full pathname to be iterated over.  If NULL, defaults to U_ICUDATA_NAME</span>
<span class="udiff-line-modified-removed">-  * @param pkg   Package which is being searched for, ex &quot;icudt28l&quot;.  Will ignore leave directories such as /icudt28l</span>
<span class="udiff-line-modified-removed">-  * @param item  Item to be searched for.  Can include full path, such as /a/b/foo.dat</span>
<span class="udiff-line-modified-removed">-  * @param suffix  Optional item suffix, if not-null (ex. &quot;.dat&quot;) then &#39;path&#39; can contain &#39;item&#39; explicitly.</span>
<span class="udiff-line-modified-removed">-  *               Ex:   &#39;stuff.dat&#39; would be found in &#39;/a/foo:/tmp/stuff.dat:/bar/baz&#39; as item #2.</span>
<span class="udiff-line-modified-removed">-  *                     &#39;/blarg/stuff.dat&#39; would also be found.</span>
<span class="udiff-line-modified-added">+  * @param iter    The iterator to be initialized. Its current state does not matter.</span>
<span class="udiff-line-modified-added">+  * @param inPath  The full pathname to be iterated over.  If NULL, defaults to U_ICUDATA_NAME</span>
<span class="udiff-line-modified-added">+  * @param pkg     Package which is being searched for, ex &quot;icudt28l&quot;.  Will ignore leaf directories such as /icudt28l</span>
<span class="udiff-line-modified-added">+  * @param item    Item to be searched for.  Can include full path, such as /a/b/foo.dat</span>
<span class="udiff-line-modified-added">+  * @param inSuffix  Optional item suffix, if not-null (ex. &quot;.dat&quot;) then &#39;path&#39; can contain &#39;item&#39; explicitly.</span>
<span class="udiff-line-modified-added">+  *             Ex:   &#39;stuff.dat&#39; would be found in &#39;/a/foo:/tmp/stuff.dat:/bar/baz&#39; as item #2.</span>
<span class="udiff-line-modified-added">+  *                   &#39;/blarg/stuff.dat&#39; would also be found.</span>
<span class="udiff-line-added">+  *  Note: inSuffix may also be the &#39;item&#39; being searched for as well, (ex: &quot;ibm-5348_P100-1997.cnv&quot;), in which case</span>
<span class="udiff-line-added">+  *        the &#39;item&#39; parameter is often the same as pkg. (Though sometimes might have a tree part as well, ex: &quot;icudt62l-curr&quot;).</span>
   */
  UDataPathIterator::UDataPathIterator(const char *inPath, const char *pkg,
                                       const char *item, const char *inSuffix, UBool doCheckLastFour,
                                       UErrorCode *pErrorCode)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -564,11 +567,11 @@</span>
          /* check for .dat files */
          pathBasename = findBasename(pathBuffer.data());
  
          if(checkLastFour == TRUE &amp;&amp;
             (pathLen&gt;=4) &amp;&amp;
<span class="udiff-line-modified-removed">-            uprv_strncmp(pathBuffer.data() +(pathLen-4), suffix, 4)==0 &amp;&amp; /* suffix matches */</span>
<span class="udiff-line-modified-added">+            uprv_strncmp(pathBuffer.data() +(pathLen-4), suffix.data(), 4)==0 &amp;&amp; /* suffix matches */</span>
             uprv_strncmp(findBasename(pathBuffer.data()), basename, basenameLen)==0  &amp;&amp; /* base matches */
             uprv_strlen(pathBasename)==(basenameLen+4)) { /* base+suffix = full len */
  
  #ifdef UDATA_DEBUG
              fprintf(stderr, &quot;Have %s file on the path: %s\n&quot;, suffix, pathBuffer.data());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -600,12 +603,17 @@</span>
              }
  
              /* + basename */
              pathBuffer.append(packageStub.data()+1, packageStub.length()-1, *pErrorCode);
  
<span class="udiff-line-modified-removed">-             if(*suffix)  /* tack on suffix */</span>
<span class="udiff-line-modified-added">+             if (!suffix.empty())  /* tack on suffix */</span>
              {
<span class="udiff-line-added">+                 if (suffix.length() &gt; 4) {</span>
<span class="udiff-line-added">+                     // If the suffix is actually an item (&quot;ibm-5348_P100-1997.cnv&quot;) and not an extension (&quot;.res&quot;)</span>
<span class="udiff-line-added">+                     // then we need to ensure that the path ends with a separator.</span>
<span class="udiff-line-added">+                     pathBuffer.ensureEndsWithFileSeparator(*pErrorCode);</span>
<span class="udiff-line-added">+                 }</span>
                  pathBuffer.append(suffix, *pErrorCode);
              }
          }
  
  #ifdef UDATA_DEBUG
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -749,29 +757,32 @@</span>
       * Hunt it down, trying all the path locations
       */
  
      UDataPathIterator iter(u_getDataDirectory(), inBasename, path, &quot;.dat&quot;, TRUE, pErrorCode);
  
<span class="udiff-line-modified-removed">-     while((UDataMemory_isLoaded(&amp;tData)==FALSE) &amp;&amp; (pathBuffer = iter.next(pErrorCode)) != NULL)</span>
<span class="udiff-line-modified-added">+     while ((UDataMemory_isLoaded(&amp;tData)==FALSE) &amp;&amp; (pathBuffer = iter.next(pErrorCode)) != NULL)</span>
      {
  #ifdef UDATA_DEBUG
          fprintf(stderr, &quot;ocd: trying path %s - &quot;, pathBuffer);
  #endif
<span class="udiff-line-modified-removed">-         uprv_mapFile(&amp;tData, pathBuffer);</span>
<span class="udiff-line-modified-added">+         uprv_mapFile(&amp;tData, pathBuffer, pErrorCode);</span>
  #ifdef UDATA_DEBUG
          fprintf(stderr, &quot;%s\n&quot;, UDataMemory_isLoaded(&amp;tData)?&quot;LOADED&quot;:&quot;not loaded&quot;);
  #endif
      }
<span class="udiff-line-added">+     if (U_FAILURE(*pErrorCode)) {</span>
<span class="udiff-line-added">+         return NULL;</span>
<span class="udiff-line-added">+     }</span>
  
  #if defined(OS390_STUBDATA) &amp;&amp; defined(OS390BATCH)
      if (!UDataMemory_isLoaded(&amp;tData)) {
          char ourPathBuffer[1024];
          /* One more chance, for extendCommonData() */
          uprv_strncpy(ourPathBuffer, path, 1019);
          ourPathBuffer[1019]=0;
          uprv_strcat(ourPathBuffer, &quot;.dat&quot;);
<span class="udiff-line-modified-removed">-         uprv_mapFile(&amp;tData, ourPathBuffer);</span>
<span class="udiff-line-modified-added">+         uprv_mapFile(&amp;tData, ourPathBuffer, pErrorCode);</span>
      }
  #endif
  
      if (U_FAILURE(*pErrorCode)) {
          return NULL;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -858,11 +869,11 @@</span>
  
  #if MAP_IMPLEMENTATION==MAP_STDIO
      umtx_unlock(&amp;extendICUDataMutex);
  #endif
      return didUpdate;               /* Return true if ICUData pointer was updated.   */
<span class="udiff-line-modified-removed">-                                     /*   (Could potentialy have been done by another thread racing */</span>
<span class="udiff-line-modified-added">+                                     /*   (Could potentially have been done by another thread racing */</span>
                                      /*   us through here, but that&#39;s fine, we still return true    */
                                      /*   so that current thread will also examine extended data.   */
  }
  
  /*----------------------------------------------------------------------*
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -984,16 +995,16 @@</span>
  
      /* look in ind. files: package\nam.typ  ========================= */
      /* init path iterator for individual files */
      UDataPathIterator iter(dataPath, pkgName, path, tocEntryPathSuffix, FALSE, pErrorCode);
  
<span class="udiff-line-modified-removed">-     while((pathBuffer = iter.next(pErrorCode)) != NULL)</span>
<span class="udiff-line-modified-added">+     while ((pathBuffer = iter.next(pErrorCode)) != NULL)</span>
      {
  #ifdef UDATA_DEBUG
          fprintf(stderr, &quot;UDATA: trying individual file %s\n&quot;, pathBuffer);
  #endif
<span class="udiff-line-modified-removed">-         if(uprv_mapFile(&amp;dataMemory, pathBuffer))</span>
<span class="udiff-line-modified-added">+         if (uprv_mapFile(&amp;dataMemory, pathBuffer, pErrorCode))</span>
          {
              pEntryData = checkDataItem(dataMemory.pHeader, isAcceptable, context, type, name, subErrorCode, pErrorCode);
              if (pEntryData != NULL) {
                  /* Data is good.
                  *  Hand off ownership of the backing memory to the user&#39;s UDataMemory.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1005,11 +1016,11 @@</span>
                  fprintf(stderr, &quot;** Mapped file: %s\n&quot;, pathBuffer);
  #endif
                  return pEntryData;
              }
  
<span class="udiff-line-modified-removed">-             /* the data is not acceptable, or some error occured.  Either way, unmap the memory */</span>
<span class="udiff-line-modified-added">+             /* the data is not acceptable, or some error occurred.  Either way, unmap the memory */</span>
              udata_close(&amp;dataMemory);
  
              /* If we had a nasty error, bail out completely.  */
              if (U_FAILURE(*pErrorCode)) {
                  return NULL;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1074,10 +1085,15 @@</span>
                      pEntryData-&gt;length = length;
                      return pEntryData;
                  }
              }
          }
<span class="udiff-line-added">+         // If we failed due to being out-of-memory, then stop early and report the error.</span>
<span class="udiff-line-added">+         if (*subErrorCode == U_MEMORY_ALLOCATION_ERROR) {</span>
<span class="udiff-line-added">+             *pErrorCode = *subErrorCode;</span>
<span class="udiff-line-added">+             return NULL;</span>
<span class="udiff-line-added">+         }</span>
          /* Data wasn&#39;t found.  If we were looking for an ICUData item and there is
           * more data available, load it and try again,
           * otherwise break out of this loop. */
          if (!isICUData) {
              return NULL;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1250,11 +1266,12 @@</span>
      tocEntryPath.append(U_FILE_SEP_CHAR, *pErrorCode).append(name, *pErrorCode);
      if(type!=NULL &amp;&amp; *type!=0) {
          tocEntryName.append(&quot;.&quot;, *pErrorCode).append(type, *pErrorCode);
          tocEntryPath.append(&quot;.&quot;, *pErrorCode).append(type, *pErrorCode);
      }
<span class="udiff-line-modified-removed">-     tocEntryPathSuffix = tocEntryPath.data()+tocEntrySuffixIndex; /* suffix starts here */</span>
<span class="udiff-line-modified-added">+     // The +1 is for the U_FILE_SEP_CHAR that is always appended above.</span>
<span class="udiff-line-added">+     tocEntryPathSuffix = tocEntryPath.data() + tocEntrySuffixIndex + 1; /* suffix starts here */</span>
  
  #ifdef UDATA_DEBUG
      fprintf(stderr, &quot; tocEntryName = %s\n&quot;, tocEntryName.data());
      fprintf(stderr, &quot; tocEntryPath = %s\n&quot;, tocEntryName.data());
  #endif
</pre>
<center><a href="ucurr.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="udataswp.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>