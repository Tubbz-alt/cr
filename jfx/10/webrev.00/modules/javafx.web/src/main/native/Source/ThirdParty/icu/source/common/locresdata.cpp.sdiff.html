<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/ThirdParty/icu/source/common/locresdata.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="locmap.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="locutil.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/ThirdParty/icu/source/common/locresdata.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 32  * Lookup a resource bundle table item with fallback on the table level.
 33  * Regular resource bundle lookups perform fallback to parent locale bundles
 34  * and eventually the root bundle, but only for top-level items.
 35  * This function takes the name of a top-level table and of an item in that table
 36  * and performs a lookup of both, falling back until a bundle contains a table
 37  * with this item.
 38  *
 39  * Note: Only the opening of entire bundles falls back through the default locale
 40  * before root. Once a bundle is open, item lookups do not go through the
 41  * default locale because that would result in a mix of languages that is
 42  * unpredictable to the programmer and most likely useless.
 43  */
 44 U_CAPI const UChar * U_EXPORT2
 45 uloc_getTableStringWithFallback(const char *path, const char *locale,
 46                               const char *tableKey, const char *subTableKey,
 47                               const char *itemKey,
 48                               int32_t *pLength,
 49                               UErrorCode *pErrorCode)
 50 {
 51 /*    char localeBuffer[ULOC_FULLNAME_CAPACITY*4];*/
<span class="line-removed"> 52     UResourceBundle *rb=NULL, table, subTable;</span>
 53     const UChar *item=NULL;
 54     UErrorCode errorCode;
 55     char explicitFallbackName[ULOC_FULLNAME_CAPACITY] = {0};
 56 
 57     /*
 58      * open the bundle for the current locale
 59      * this falls back through the locale&#39;s chain to root
 60      */
 61     errorCode=U_ZERO_ERROR;
<span class="line-modified"> 62     rb=ures_open(path, locale, &amp;errorCode);</span>
 63 
 64     if(U_FAILURE(errorCode)) {
 65         /* total failure, not even root could be opened */
 66         *pErrorCode=errorCode;
 67         return NULL;
 68     } else if(errorCode==U_USING_DEFAULT_WARNING ||
 69                 (errorCode==U_USING_FALLBACK_WARNING &amp;&amp; *pErrorCode!=U_USING_DEFAULT_WARNING)
 70     ) {
 71         /* set the &quot;strongest&quot; error code (success-&gt;fallback-&gt;default-&gt;failure) */
 72         *pErrorCode=errorCode;
 73     }
 74 
 75     for(;;){
<span class="line-modified"> 76         ures_initStackObject(&amp;table);</span>
<span class="line-modified"> 77         ures_initStackObject(&amp;subTable);</span>
<span class="line-modified"> 78         ures_getByKeyWithFallback(rb, tableKey, &amp;table, &amp;errorCode);</span>
 79 
 80         if (subTableKey != NULL) {
 81             /*
<span class="line-modified"> 82             ures_getByKeyWithFallback(&amp;table,subTableKey, &amp;subTable, &amp;errorCode);</span>
<span class="line-modified"> 83             item = ures_getStringByKeyWithFallback(&amp;subTable, itemKey, pLength, &amp;errorCode);</span>
 84             if(U_FAILURE(errorCode)){
 85                 *pErrorCode = errorCode;
 86             }
 87 
 88             break;*/
 89 
<span class="line-modified"> 90             ures_getByKeyWithFallback(&amp;table,subTableKey, &amp;table, &amp;errorCode);</span>
 91         }
 92         if(U_SUCCESS(errorCode)){
<span class="line-modified"> 93             item = ures_getStringByKeyWithFallback(&amp;table, itemKey, pLength, &amp;errorCode);</span>
 94             if(U_FAILURE(errorCode)){
 95                 const char* replacement = NULL;
 96                 *pErrorCode = errorCode; /*save the errorCode*/
 97                 errorCode = U_ZERO_ERROR;
 98                 /* may be a deprecated code */
 99                 if(uprv_strcmp(tableKey, &quot;Countries&quot;)==0){
100                     replacement =  uloc_getCurrentCountryID(itemKey);
101                 }else if(uprv_strcmp(tableKey, &quot;Languages&quot;)==0){
102                     replacement =  uloc_getCurrentLanguageID(itemKey);
103                 }
104                 /*pointer comparison is ok since uloc_getCurrentCountryID &amp; uloc_getCurrentLanguageID return the key itself is replacement is not found*/
105                 if(replacement!=NULL &amp;&amp; itemKey != replacement){
<span class="line-modified">106                     item = ures_getStringByKeyWithFallback(&amp;table, replacement, pLength, &amp;errorCode);</span>
107                     if(U_SUCCESS(errorCode)){
108                         *pErrorCode = errorCode;
109                         break;
110                     }
111                 }
112             }else{
113                 break;
114             }
115         }
116 
117         if(U_FAILURE(errorCode)){
118 
119             /* still can&#39;t figure out ?.. try the fallback mechanism */
120             int32_t len = 0;
121             const UChar* fallbackLocale =  NULL;
122             *pErrorCode = errorCode;
123             errorCode = U_ZERO_ERROR;
124 
<span class="line-modified">125             fallbackLocale = ures_getStringByKeyWithFallback(&amp;table, &quot;Fallback&quot;, &amp;len, &amp;errorCode);</span>
126             if(U_FAILURE(errorCode)){
127                *pErrorCode = errorCode;
128                 break;
129             }
130 
131             u_UCharsToChars(fallbackLocale, explicitFallbackName, len);
132 
133             /* guard against recursive fallback */
134             if(uprv_strcmp(explicitFallbackName, locale)==0){
135                 *pErrorCode = U_INTERNAL_PROGRAM_ERROR;
136                 break;
137             }
<span class="line-modified">138             ures_close(rb);</span>
<span class="line-removed">139             rb = ures_open(path, explicitFallbackName, &amp;errorCode);</span>
140             if(U_FAILURE(errorCode)){
141                 *pErrorCode = errorCode;
142                 break;
143             }
144             /* succeeded in opening the fallback bundle .. continue and try to fetch the item */
145         }else{
146             break;
147         }
148     }
<span class="line-modified">149     /* done with the locale string - ready to close table and rb */</span>
<span class="line-removed">150     ures_close(&amp;subTable);</span>
<span class="line-removed">151     ures_close(&amp;table);</span>
<span class="line-removed">152     ures_close(rb);</span>
153     return item;
154 }
155 
156 static ULayoutType
157 _uloc_getOrientationHelper(const char* localeId,
158                            const char* key,
159                            UErrorCode *status)
160 {
161     ULayoutType result = ULOC_LAYOUT_UNKNOWN;
162 
163     if (!U_FAILURE(*status)) {
164         int32_t length = 0;
165         char localeBuffer[ULOC_FULLNAME_CAPACITY];
166 
167         uloc_canonicalize(localeId, localeBuffer, sizeof(localeBuffer), status);
168 
169         if (!U_FAILURE(*status)) {
170             const UChar* const value =
171                 uloc_getTableStringWithFallback(
172                     NULL,
</pre>
</td>
<td>
<hr />
<pre>
 32  * Lookup a resource bundle table item with fallback on the table level.
 33  * Regular resource bundle lookups perform fallback to parent locale bundles
 34  * and eventually the root bundle, but only for top-level items.
 35  * This function takes the name of a top-level table and of an item in that table
 36  * and performs a lookup of both, falling back until a bundle contains a table
 37  * with this item.
 38  *
 39  * Note: Only the opening of entire bundles falls back through the default locale
 40  * before root. Once a bundle is open, item lookups do not go through the
 41  * default locale because that would result in a mix of languages that is
 42  * unpredictable to the programmer and most likely useless.
 43  */
 44 U_CAPI const UChar * U_EXPORT2
 45 uloc_getTableStringWithFallback(const char *path, const char *locale,
 46                               const char *tableKey, const char *subTableKey,
 47                               const char *itemKey,
 48                               int32_t *pLength,
 49                               UErrorCode *pErrorCode)
 50 {
 51 /*    char localeBuffer[ULOC_FULLNAME_CAPACITY*4];*/

 52     const UChar *item=NULL;
 53     UErrorCode errorCode;
 54     char explicitFallbackName[ULOC_FULLNAME_CAPACITY] = {0};
 55 
 56     /*
 57      * open the bundle for the current locale
 58      * this falls back through the locale&#39;s chain to root
 59      */
 60     errorCode=U_ZERO_ERROR;
<span class="line-modified"> 61     icu::LocalUResourceBundlePointer rb(ures_open(path, locale, &amp;errorCode));</span>
 62 
 63     if(U_FAILURE(errorCode)) {
 64         /* total failure, not even root could be opened */
 65         *pErrorCode=errorCode;
 66         return NULL;
 67     } else if(errorCode==U_USING_DEFAULT_WARNING ||
 68                 (errorCode==U_USING_FALLBACK_WARNING &amp;&amp; *pErrorCode!=U_USING_DEFAULT_WARNING)
 69     ) {
 70         /* set the &quot;strongest&quot; error code (success-&gt;fallback-&gt;default-&gt;failure) */
 71         *pErrorCode=errorCode;
 72     }
 73 
 74     for(;;){
<span class="line-modified"> 75         icu::StackUResourceBundle table;</span>
<span class="line-modified"> 76         icu::StackUResourceBundle subTable;</span>
<span class="line-modified"> 77         ures_getByKeyWithFallback(rb.getAlias(), tableKey, table.getAlias(), &amp;errorCode);</span>
 78 
 79         if (subTableKey != NULL) {
 80             /*
<span class="line-modified"> 81             ures_getByKeyWithFallback(table.getAlias(), subTableKey, subTable.getAlias(), &amp;errorCode);</span>
<span class="line-modified"> 82             item = ures_getStringByKeyWithFallback(subTable.getAlias(), itemKey, pLength, &amp;errorCode);</span>
 83             if(U_FAILURE(errorCode)){
 84                 *pErrorCode = errorCode;
 85             }
 86 
 87             break;*/
 88 
<span class="line-modified"> 89             ures_getByKeyWithFallback(table.getAlias(), subTableKey, table.getAlias(), &amp;errorCode);</span>
 90         }
 91         if(U_SUCCESS(errorCode)){
<span class="line-modified"> 92             item = ures_getStringByKeyWithFallback(table.getAlias(), itemKey, pLength, &amp;errorCode);</span>
 93             if(U_FAILURE(errorCode)){
 94                 const char* replacement = NULL;
 95                 *pErrorCode = errorCode; /*save the errorCode*/
 96                 errorCode = U_ZERO_ERROR;
 97                 /* may be a deprecated code */
 98                 if(uprv_strcmp(tableKey, &quot;Countries&quot;)==0){
 99                     replacement =  uloc_getCurrentCountryID(itemKey);
100                 }else if(uprv_strcmp(tableKey, &quot;Languages&quot;)==0){
101                     replacement =  uloc_getCurrentLanguageID(itemKey);
102                 }
103                 /*pointer comparison is ok since uloc_getCurrentCountryID &amp; uloc_getCurrentLanguageID return the key itself is replacement is not found*/
104                 if(replacement!=NULL &amp;&amp; itemKey != replacement){
<span class="line-modified">105                     item = ures_getStringByKeyWithFallback(table.getAlias(), replacement, pLength, &amp;errorCode);</span>
106                     if(U_SUCCESS(errorCode)){
107                         *pErrorCode = errorCode;
108                         break;
109                     }
110                 }
111             }else{
112                 break;
113             }
114         }
115 
116         if(U_FAILURE(errorCode)){
117 
118             /* still can&#39;t figure out ?.. try the fallback mechanism */
119             int32_t len = 0;
120             const UChar* fallbackLocale =  NULL;
121             *pErrorCode = errorCode;
122             errorCode = U_ZERO_ERROR;
123 
<span class="line-modified">124             fallbackLocale = ures_getStringByKeyWithFallback(table.getAlias(), &quot;Fallback&quot;, &amp;len, &amp;errorCode);</span>
125             if(U_FAILURE(errorCode)){
126                *pErrorCode = errorCode;
127                 break;
128             }
129 
130             u_UCharsToChars(fallbackLocale, explicitFallbackName, len);
131 
132             /* guard against recursive fallback */
133             if(uprv_strcmp(explicitFallbackName, locale)==0){
134                 *pErrorCode = U_INTERNAL_PROGRAM_ERROR;
135                 break;
136             }
<span class="line-modified">137             rb.adoptInstead(ures_open(path, explicitFallbackName, &amp;errorCode));</span>

138             if(U_FAILURE(errorCode)){
139                 *pErrorCode = errorCode;
140                 break;
141             }
142             /* succeeded in opening the fallback bundle .. continue and try to fetch the item */
143         }else{
144             break;
145         }
146     }
<span class="line-modified">147 </span>



148     return item;
149 }
150 
151 static ULayoutType
152 _uloc_getOrientationHelper(const char* localeId,
153                            const char* key,
154                            UErrorCode *status)
155 {
156     ULayoutType result = ULOC_LAYOUT_UNKNOWN;
157 
158     if (!U_FAILURE(*status)) {
159         int32_t length = 0;
160         char localeBuffer[ULOC_FULLNAME_CAPACITY];
161 
162         uloc_canonicalize(localeId, localeBuffer, sizeof(localeBuffer), status);
163 
164         if (!U_FAILURE(*status)) {
165             const UChar* const value =
166                 uloc_getTableStringWithFallback(
167                     NULL,
</pre>
</td>
</tr>
</table>
<center><a href="locmap.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="locutil.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>