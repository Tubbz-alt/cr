<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/ThirdParty/icu/source/common/uts46.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="utrie2_impl.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="uvector.cpp.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/ThirdParty/icu/source/common/uts46.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 540     UBool doMapDevChars=
 541         toASCII ? (options&amp;UIDNA_NONTRANSITIONAL_TO_ASCII)==0 :
 542                   (options&amp;UIDNA_NONTRANSITIONAL_TO_UNICODE)==0;
 543     const UChar *destArray=dest.getBuffer();
 544     int32_t destLength=dest.length();
 545     int32_t labelLimit=labelStart;
 546     while(labelLimit&lt;destLength) {
 547         UChar c=destArray[labelLimit];
 548         if(c==0x2e &amp;&amp; !isLabel) {
 549             int32_t labelLength=labelLimit-labelStart;
 550             int32_t newLength=processLabel(dest, labelStart, labelLength,
 551                                             toASCII, info, errorCode);
 552             info.errors|=info.labelErrors;
 553             info.labelErrors=0;
 554             if(U_FAILURE(errorCode)) {
 555                 return dest;
 556             }
 557             destArray=dest.getBuffer();
 558             destLength+=newLength-labelLength;
 559             labelLimit=labelStart+=newLength+1;
<span class="line-modified"> 560         } else if(0xdf&lt;=c &amp;&amp; c&lt;=0x200d &amp;&amp; (c==0xdf || c==0x3c2 || c&gt;=0x200c)) {</span>



 561             info.isTransDiff=TRUE;
 562             if(doMapDevChars) {
 563                 destLength=mapDevChars(dest, labelStart, labelLimit, errorCode);
 564                 if(U_FAILURE(errorCode)) {
 565                     return dest;
 566                 }
 567                 destArray=dest.getBuffer();
<span class="line-removed"> 568                 // Do not increment labelLimit in case c was removed.</span>
 569                 // All deviation characters have been mapped, no need to check for them again.
 570                 doMapDevChars=FALSE;
<span class="line-modified"> 571             } else {</span>
<span class="line-modified"> 572                 ++labelLimit;</span>










 573             }
<span class="line-removed"> 574         } else {</span>
<span class="line-removed"> 575             ++labelLimit;</span>
 576         }

 577     }
 578     // Permit an empty label at the end (0&lt;labelStart==labelLimit==destLength is ok)
 579     // but not an empty label elsewhere nor a completely empty domain name.
 580     // processLabel() sets UIDNA_ERROR_EMPTY_LABEL when labelLength==0.
 581     if(0==labelStart || labelStart&lt;labelLimit) {
 582         processLabel(dest, labelStart, labelLimit-labelStart,
 583                       toASCII, info, errorCode);
 584         info.errors|=info.labelErrors;
 585     }
 586     return dest;
 587 }
 588 
 589 int32_t
 590 UTS46::mapDevChars(UnicodeString &amp;dest, int32_t labelStart, int32_t mappingStart,
 591                    UErrorCode &amp;errorCode) const {
 592     if(U_FAILURE(errorCode)) {
 593         return 0;
 594     }
 595     int32_t length=dest.length();
 596     UChar *s=dest.getBuffer(dest[mappingStart]==0xdf ? length+1 : length);
</pre>
</td>
<td>
<hr />
<pre>
 540     UBool doMapDevChars=
 541         toASCII ? (options&amp;UIDNA_NONTRANSITIONAL_TO_ASCII)==0 :
 542                   (options&amp;UIDNA_NONTRANSITIONAL_TO_UNICODE)==0;
 543     const UChar *destArray=dest.getBuffer();
 544     int32_t destLength=dest.length();
 545     int32_t labelLimit=labelStart;
 546     while(labelLimit&lt;destLength) {
 547         UChar c=destArray[labelLimit];
 548         if(c==0x2e &amp;&amp; !isLabel) {
 549             int32_t labelLength=labelLimit-labelStart;
 550             int32_t newLength=processLabel(dest, labelStart, labelLength,
 551                                             toASCII, info, errorCode);
 552             info.errors|=info.labelErrors;
 553             info.labelErrors=0;
 554             if(U_FAILURE(errorCode)) {
 555                 return dest;
 556             }
 557             destArray=dest.getBuffer();
 558             destLength+=newLength-labelLength;
 559             labelLimit=labelStart+=newLength+1;
<span class="line-modified"> 560             continue;</span>
<span class="line-added"> 561         } else if(c&lt;0xdf) {</span>
<span class="line-added"> 562             // pass</span>
<span class="line-added"> 563         } else if(c&lt;=0x200d &amp;&amp; (c==0xdf || c==0x3c2 || c&gt;=0x200c)) {</span>
 564             info.isTransDiff=TRUE;
 565             if(doMapDevChars) {
 566                 destLength=mapDevChars(dest, labelStart, labelLimit, errorCode);
 567                 if(U_FAILURE(errorCode)) {
 568                     return dest;
 569                 }
 570                 destArray=dest.getBuffer();

 571                 // All deviation characters have been mapped, no need to check for them again.
 572                 doMapDevChars=FALSE;
<span class="line-modified"> 573                 // Do not increment labelLimit in case c was removed.</span>
<span class="line-modified"> 574                 continue;</span>
<span class="line-added"> 575             }</span>
<span class="line-added"> 576         } else if(U16_IS_SURROGATE(c)) {</span>
<span class="line-added"> 577             if(U16_IS_SURROGATE_LEAD(c) ?</span>
<span class="line-added"> 578                     (labelLimit+1)==destLength || !U16_IS_TRAIL(destArray[labelLimit+1]) :</span>
<span class="line-added"> 579                     labelLimit==labelStart || !U16_IS_LEAD(destArray[labelLimit-1])) {</span>
<span class="line-added"> 580                 // Map an unpaired surrogate to U+FFFD before normalization so that when</span>
<span class="line-added"> 581                 // that removes characters we do not turn two unpaired ones into a pair.</span>
<span class="line-added"> 582                 info.labelErrors|=UIDNA_ERROR_DISALLOWED;</span>
<span class="line-added"> 583                 dest.setCharAt(labelLimit, 0xfffd);</span>
<span class="line-added"> 584                 destArray=dest.getBuffer();</span>
 585             }


 586         }
<span class="line-added"> 587         ++labelLimit;</span>
 588     }
 589     // Permit an empty label at the end (0&lt;labelStart==labelLimit==destLength is ok)
 590     // but not an empty label elsewhere nor a completely empty domain name.
 591     // processLabel() sets UIDNA_ERROR_EMPTY_LABEL when labelLength==0.
 592     if(0==labelStart || labelStart&lt;labelLimit) {
 593         processLabel(dest, labelStart, labelLimit-labelStart,
 594                       toASCII, info, errorCode);
 595         info.errors|=info.labelErrors;
 596     }
 597     return dest;
 598 }
 599 
 600 int32_t
 601 UTS46::mapDevChars(UnicodeString &amp;dest, int32_t labelStart, int32_t mappingStart,
 602                    UErrorCode &amp;errorCode) const {
 603     if(U_FAILURE(errorCode)) {
 604         return 0;
 605     }
 606     int32_t length=dest.length();
 607     UChar *s=dest.getBuffer(dest[mappingStart]==0xdf ? length+1 : length);
</pre>
</td>
</tr>
</table>
<center><a href="utrie2_impl.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="uvector.cpp.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>