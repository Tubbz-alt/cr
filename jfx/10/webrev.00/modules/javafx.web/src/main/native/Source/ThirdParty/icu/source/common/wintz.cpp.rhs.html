<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/ThirdParty/icu/source/common/wintz.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 // Â© 2016 and later: Unicode, Inc. and others.
  2 // License &amp; terms of use: http://www.unicode.org/copyright.html
  3 /*
  4 ********************************************************************************
  5 *   Copyright (C) 2005-2015, International Business Machines
  6 *   Corporation and others.  All Rights Reserved.
  7 ********************************************************************************
  8 *
  9 * File WINTZ.CPP
 10 *
 11 ********************************************************************************
 12 */
 13 
 14 #include &quot;unicode/utypes.h&quot;
 15 
<a name="1" id="anc1"></a><span class="line-modified"> 16 #if U_PLATFORM_USES_ONLY_WIN32_API</span>


 17 
 18 #include &quot;wintz.h&quot;
 19 #include &quot;cmemory.h&quot;
 20 #include &quot;cstring.h&quot;
 21 
 22 #include &quot;unicode/ures.h&quot;
 23 #include &quot;unicode/ustring.h&quot;
<a name="2" id="anc2"></a><span class="line-added"> 24 #include &quot;uresimp.h&quot;</span>
 25 
 26 #ifndef WIN32_LEAN_AND_MEAN
 27 #   define WIN32_LEAN_AND_MEAN
 28 #endif
 29 #   define VC_EXTRALEAN
 30 #   define NOUSER
 31 #   define NOSERVICE
 32 #   define NOIME
 33 #   define NOMCX
 34 #include &lt;windows.h&gt;
 35 
<a name="3" id="anc3"></a><span class="line-modified"> 36 U_NAMESPACE_BEGIN</span>
 37 
<a name="4" id="anc4"></a><span class="line-modified"> 38 // The max size of TimeZoneKeyName is 128, defined in DYNAMIC_TIME_ZONE_INFORMATION</span>
<span class="line-modified"> 39 #define MAX_TIMEZONE_ID_LENGTH 128</span>















 40 
 41 /**
<a name="5" id="anc5"></a><span class="line-modified"> 42 * Main Windows time zone detection function.</span>
<span class="line-modified"> 43 * Returns the Windows time zone converted to an ICU time zone as a heap-allocated buffer, or nullptr upon failure.</span>
<span class="line-modified"> 44 * Note: We use the Win32 API GetDynamicTimeZoneInformation to get the current time zone info.</span>
<span class="line-modified"> 45 * This API returns a non-localized time zone name, which we can then map to an ICU time zone name.</span>

















































































































































 46 */
<a name="6" id="anc6"></a><span class="line-modified"> 47 U_INTERNAL const char* U_EXPORT2</span>





 48 uprv_detectWindowsTimeZone()
 49 {
 50     UErrorCode status = U_ZERO_ERROR;
<a name="7" id="anc7"></a><span class="line-modified"> 51     char* icuid = nullptr;</span>
<span class="line-modified"> 52     char dynamicTZKeyName[MAX_TIMEZONE_ID_LENGTH];</span>
<span class="line-modified"> 53     char tmpid[MAX_TIMEZONE_ID_LENGTH];</span>


 54     int32_t len;
<a name="8" id="anc8"></a><span class="line-modified"> 55     int id = GEOID_NOT_AVAILABLE;</span>
 56     int errorCode;
<a name="9" id="anc9"></a><span class="line-modified"> 57     wchar_t ISOcodeW[3] = {}; /* 2 letter ISO code in UTF-16 */</span>
<span class="line-modified"> 58     char ISOcode[3] = {}; /* 2 letter ISO code in UTF-8 */</span>
 59 
<a name="10" id="anc10"></a><span class="line-modified"> 60     DYNAMIC_TIME_ZONE_INFORMATION dynamicTZI;</span>
<span class="line-modified"> 61     uprv_memset(&amp;dynamicTZI, 0, sizeof(dynamicTZI));</span>
<span class="line-modified"> 62     uprv_memset(dynamicTZKeyName, 0, sizeof(dynamicTZKeyName));</span>
<span class="line-modified"> 63     uprv_memset(tmpid, 0, sizeof(tmpid));</span>
 64 
<a name="11" id="anc11"></a><span class="line-modified"> 65     /* Obtain TIME_ZONE_INFORMATION from the API and get the non-localized time zone name. */</span>
<span class="line-modified"> 66     if (TIME_ZONE_ID_INVALID == GetDynamicTimeZoneInformation(&amp;dynamicTZI)) {</span>
<span class="line-added"> 67         return nullptr;</span>
<span class="line-added"> 68     }</span>
 69 
<a name="12" id="anc12"></a><span class="line-modified"> 70     id = GetUserGeoID(GEOCLASS_NATION);</span>
<span class="line-modified"> 71     errorCode = GetGeoInfoW(id, GEO_ISO2, ISOcodeW, 3, 0);</span>










 72 
<a name="13" id="anc13"></a><span class="line-modified"> 73     // convert from wchar_t* (UTF-16 on Windows) to char* (UTF-8).</span>
<span class="line-modified"> 74     u_strToUTF8(ISOcode, UPRV_LENGTHOF(ISOcode), nullptr,</span>
<span class="line-modified"> 75         reinterpret_cast&lt;const UChar*&gt;(ISOcodeW), UPRV_LENGTHOF(ISOcodeW), &amp;status);</span>
 76 
<a name="14" id="anc14"></a><span class="line-modified"> 77     LocalUResourceBundlePointer bundle(ures_openDirect(nullptr, &quot;windowsZones&quot;, &amp;status));</span>
<span class="line-added"> 78     ures_getByKey(bundle.getAlias(), &quot;mapTimezones&quot;, bundle.getAlias(), &amp;status);</span>
 79 
<a name="15" id="anc15"></a><span class="line-modified"> 80     // convert from wchar_t* (UTF-16 on Windows) to char* (UTF-8).</span>
<span class="line-modified"> 81     u_strToUTF8(dynamicTZKeyName, UPRV_LENGTHOF(dynamicTZKeyName), nullptr,</span>
<span class="line-modified"> 82         reinterpret_cast&lt;const UChar*&gt;(dynamicTZI.TimeZoneKeyName), -1, &amp;status);</span>
<span class="line-added"> 83 </span>
<span class="line-added"> 84     if (U_FAILURE(status)) {</span>
<span class="line-added"> 85         return nullptr;</span>
<span class="line-added"> 86     }</span>
 87 
<a name="16" id="anc16"></a><span class="line-modified"> 88     if (dynamicTZI.TimeZoneKeyName[0] != 0) {</span>
<span class="line-modified"> 89         StackUResourceBundle winTZ;</span>
<span class="line-added"> 90         ures_getByKey(bundle.getAlias(), dynamicTZKeyName, winTZ.getAlias(), &amp;status);</span>
 91 
<a name="17" id="anc17"></a><span class="line-modified"> 92         if (U_SUCCESS(status)) {</span>
<span class="line-modified"> 93             const UChar* icuTZ = nullptr;</span>
<span class="line-modified"> 94             if (errorCode != 0) {</span>
<span class="line-modified"> 95                 icuTZ = ures_getStringByKey(winTZ.getAlias(), ISOcode, &amp;len, &amp;status);</span>














 96             }
<a name="18" id="anc18"></a><span class="line-modified"> 97             if (errorCode == 0 || icuTZ == nullptr) {</span>

 98                 /* fallback to default &quot;001&quot; and reset status */
 99                 status = U_ZERO_ERROR;
<a name="19" id="anc19"></a><span class="line-modified">100                 icuTZ = ures_getStringByKey(winTZ.getAlias(), &quot;001&quot;, &amp;len, &amp;status);</span>
101             }
102 
<a name="20" id="anc20"></a><span class="line-modified">103             if (U_SUCCESS(status)) {</span>
<span class="line-modified">104                 int index = 0;</span>











105 
<a name="21" id="anc21"></a><span class="line-modified">106                 while (!(*icuTZ == &#39;\0&#39; || *icuTZ == &#39; &#39;)) {</span>
<span class="line-modified">107                     // time zone IDs only contain ASCII invariant characters.</span>
<span class="line-modified">108                     tmpid[index++] = (char)(*icuTZ++);</span>































































109                 }
<a name="22" id="anc22"></a><span class="line-modified">110                 tmpid[index] = &#39;\0&#39;;</span>




111             }
112         }
113     }
114 
<a name="23" id="anc23"></a><span class="line-modified">115     // Copy the timezone ID to icuid to be returned.</span>
<span class="line-modified">116     if (tmpid[0] != 0) {</span>
<span class="line-modified">117         icuid = uprv_strdup(tmpid);</span>








118     }
119 
<a name="24" id="anc24"></a>

120     return icuid;
121 }
122 
<a name="25" id="anc25"></a><span class="line-modified">123 U_NAMESPACE_END</span>
<span class="line-added">124 #endif /* U_PLATFORM_USES_ONLY_WIN32_API  */</span>
<a name="26" id="anc26"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="26" type="hidden" />
</body>
</html>