<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/ThirdParty/icu/source/common/uloc_tag.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="uloc_keytype.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="ulocimp.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/ThirdParty/icu/source/common/uloc_tag.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -5,15 +5,19 @@</span>
  *   Copyright (C) 2009-2015, International Business Machines
  *   Corporation and others.  All Rights Reserved.
  **********************************************************************
  */
  
<span class="udiff-line-added">+ #include &quot;unicode/bytestream.h&quot;</span>
  #include &quot;unicode/utypes.h&quot;
  #include &quot;unicode/ures.h&quot;
<span class="udiff-line-added">+ #include &quot;unicode/localpointer.h&quot;</span>
  #include &quot;unicode/putil.h&quot;
<span class="udiff-line-added">+ #include &quot;unicode/uenum.h&quot;</span>
  #include &quot;unicode/uloc.h&quot;
  #include &quot;ustr_imp.h&quot;
<span class="udiff-line-added">+ #include &quot;charstr.h&quot;</span>
  #include &quot;cmemory.h&quot;
  #include &quot;cstring.h&quot;
  #include &quot;putilimp.h&quot;
  #include &quot;uinvchar.h&quot;
  #include &quot;ulocimp.h&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -25,21 +29,21 @@</span>
      const char              *variant;
      struct VariantListEntry *next;
  } VariantListEntry;
  
  /* struct holding a single attribute value */
<span class="udiff-line-modified-removed">- typedef struct AttributeListEntry {</span>
<span class="udiff-line-modified-added">+ struct AttributeListEntry : public icu::UMemory {</span>
      const char              *attribute;
      struct AttributeListEntry *next;
<span class="udiff-line-modified-removed">- } AttributeListEntry;</span>
<span class="udiff-line-modified-added">+ };</span>
  
  /* struct holding a single extension */
<span class="udiff-line-modified-removed">- typedef struct ExtensionListEntry {</span>
<span class="udiff-line-modified-added">+ struct ExtensionListEntry : public icu::UMemory {</span>
      const char                  *key;
      const char                  *value;
      struct ExtensionListEntry   *next;
<span class="udiff-line-modified-removed">- } ExtensionListEntry;</span>
<span class="udiff-line-modified-added">+ };</span>
  
  #define MAXEXTLANG 3
  typedef struct ULanguageTag {
      char                *buf;   /* holding parsed subtags */
      const char          *language;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -75,23 +79,38 @@</span>
  static const char PRIVUSE_VARIANT_PREFIX[] = &quot;lvariant&quot;;
  static const char LOCALE_TYPE_YES[] = &quot;yes&quot;;
  
  #define LANG_UND_LEN 3
  
<span class="udiff-line-added">+ /*</span>
<span class="udiff-line-added">+  Updated on 2018-09-12 from</span>
<span class="udiff-line-added">+  https://www.iana.org/assignments/language-subtag-registry/language-subtag-registry .</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+  This table has 2 parts. The parts for Grandfathered tags is generated by the</span>
<span class="udiff-line-added">+  following scripts from the IANA language tag registry.</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+  curl  https://www.iana.org/assignments/language-subtag-registry/language-subtag-registry |\</span>
<span class="udiff-line-added">+  egrep -A 7 &#39;Type: grandfathered&#39; | \</span>
<span class="udiff-line-added">+  egrep &#39;Tag|Prefe&#39; | grep -B1 &#39;Preferred&#39; | grep -v &#39;^--&#39; | \</span>
<span class="udiff-line-added">+  awk -n &#39;/Tag/ {printf(&quot;    \&quot;%s\&quot;, &quot;, $2);} /Preferred/ {printf(&quot;\&quot;%s\&quot;,\n&quot;, $2);}&#39; |\</span>
<span class="udiff-line-added">+  tr &#39;A-Z&#39; &#39;a-z&#39;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+  The 2nd part is made of five ICU-specific entries. They&#39;re kept for</span>
<span class="udiff-line-added">+  the backward compatibility for now, even though there are no preferred</span>
<span class="udiff-line-added">+  values. They may have to be removed for the strict BCP 47 compliance.</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ */</span>
  static const char* const GRANDFATHERED[] = {
  /*  grandfathered   preferred */
      &quot;art-lojban&quot;,   &quot;jbo&quot;,
<span class="udiff-line-modified-removed">-     &quot;cel-gaulish&quot;,  &quot;xtg-x-cel-gaulish&quot;,</span>
<span class="udiff-line-removed">-     &quot;en-GB-oed&quot;,    &quot;en-GB-x-oed&quot;,</span>
<span class="udiff-line-modified-added">+     &quot;en-gb-oed&quot;,    &quot;en-gb-oxendict&quot;,</span>
      &quot;i-ami&quot;,        &quot;ami&quot;,
      &quot;i-bnn&quot;,        &quot;bnn&quot;,
<span class="udiff-line-removed">-     &quot;i-default&quot;,    &quot;en-x-i-default&quot;,</span>
<span class="udiff-line-removed">-     &quot;i-enochian&quot;,   &quot;und-x-i-enochian&quot;,</span>
      &quot;i-hak&quot;,        &quot;hak&quot;,
      &quot;i-klingon&quot;,    &quot;tlh&quot;,
      &quot;i-lux&quot;,        &quot;lb&quot;,
<span class="udiff-line-removed">-     &quot;i-mingo&quot;,      &quot;see-x-i-mingo&quot;,</span>
      &quot;i-navajo&quot;,     &quot;nv&quot;,
      &quot;i-pwn&quot;,        &quot;pwn&quot;,
      &quot;i-tao&quot;,        &quot;tao&quot;,
      &quot;i-tay&quot;,        &quot;tay&quot;,
      &quot;i-tsu&quot;,        &quot;tsu&quot;,
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -100,21 +119,179 @@</span>
      &quot;sgn-be-fr&quot;,    &quot;sfb&quot;,
      &quot;sgn-be-nl&quot;,    &quot;vgt&quot;,
      &quot;sgn-ch-de&quot;,    &quot;sgg&quot;,
      &quot;zh-guoyu&quot;,     &quot;cmn&quot;,
      &quot;zh-hakka&quot;,     &quot;hak&quot;,
<span class="udiff-line-removed">-     &quot;zh-min&quot;,       &quot;nan-x-zh-min&quot;,</span>
      &quot;zh-min-nan&quot;,   &quot;nan&quot;,
      &quot;zh-xiang&quot;,     &quot;hsn&quot;,
<span class="udiff-line-modified-removed">-     NULL,           NULL</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+     // Grandfathered tags with no preferred value in the IANA</span>
<span class="udiff-line-added">+     // registry. Kept for now for the backward compatibility</span>
<span class="udiff-line-added">+     // because ICU has mapped them this way.</span>
<span class="udiff-line-added">+     &quot;cel-gaulish&quot;,  &quot;xtg-x-cel-gaulish&quot;,</span>
<span class="udiff-line-added">+     &quot;i-default&quot;,    &quot;en-x-i-default&quot;,</span>
<span class="udiff-line-added">+     &quot;i-enochian&quot;,   &quot;und-x-i-enochian&quot;,</span>
<span class="udiff-line-added">+     &quot;i-mingo&quot;,      &quot;see-x-i-mingo&quot;,</span>
<span class="udiff-line-added">+     &quot;zh-min&quot;,       &quot;nan-x-zh-min&quot;,</span>
<span class="udiff-line-added">+ };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ /*</span>
<span class="udiff-line-added">+  Updated on 2018-09-12 from</span>
<span class="udiff-line-added">+  https://www.iana.org/assignments/language-subtag-registry/language-subtag-registry .</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+  The table lists redundant tags with preferred value in the IANA languate tag registry.</span>
<span class="udiff-line-added">+  It&#39;s generated with the following command:</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+  curl  https://www.iana.org/assignments/language-subtag-registry/language-subtag-registry |\</span>
<span class="udiff-line-added">+  grep &#39;Type: redundant&#39; -A 5 | egrep &#39;^(Tag:|Prefer)&#39; | grep -B1 &#39;Preferred&#39; | \</span>
<span class="udiff-line-added">+  awk -n &#39;/Tag/ {printf(&quot;    \&quot;%s\&quot;,       &quot;, $2);} /Preferred/ {printf(&quot;\&quot;%s\&quot;,\n&quot;, $2);}&#39; | \</span>
<span class="udiff-line-added">+  tr &#39;A-Z&#39; &#39;a-z&#39;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+  In addition, ja-latn-hepburn-heploc is mapped to ja-latn-alalc97 because</span>
<span class="udiff-line-added">+  a variant tag &#39;hepburn-heploc&#39; has the preferred subtag, &#39;alaic97&#39;.</span>
<span class="udiff-line-added">+ */</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ static const char* const REDUNDANT[] = {</span>
<span class="udiff-line-added">+ //  redundant       preferred</span>
<span class="udiff-line-added">+     &quot;sgn-br&quot;,       &quot;bzs&quot;,</span>
<span class="udiff-line-added">+     &quot;sgn-co&quot;,       &quot;csn&quot;,</span>
<span class="udiff-line-added">+     &quot;sgn-de&quot;,       &quot;gsg&quot;,</span>
<span class="udiff-line-added">+     &quot;sgn-dk&quot;,       &quot;dsl&quot;,</span>
<span class="udiff-line-added">+     &quot;sgn-es&quot;,       &quot;ssp&quot;,</span>
<span class="udiff-line-added">+     &quot;sgn-fr&quot;,       &quot;fsl&quot;,</span>
<span class="udiff-line-added">+     &quot;sgn-gb&quot;,       &quot;bfi&quot;,</span>
<span class="udiff-line-added">+     &quot;sgn-gr&quot;,       &quot;gss&quot;,</span>
<span class="udiff-line-added">+     &quot;sgn-ie&quot;,       &quot;isg&quot;,</span>
<span class="udiff-line-added">+     &quot;sgn-it&quot;,       &quot;ise&quot;,</span>
<span class="udiff-line-added">+     &quot;sgn-jp&quot;,       &quot;jsl&quot;,</span>
<span class="udiff-line-added">+     &quot;sgn-mx&quot;,       &quot;mfs&quot;,</span>
<span class="udiff-line-added">+     &quot;sgn-ni&quot;,       &quot;ncs&quot;,</span>
<span class="udiff-line-added">+     &quot;sgn-nl&quot;,       &quot;dse&quot;,</span>
<span class="udiff-line-added">+     &quot;sgn-no&quot;,       &quot;nsl&quot;,</span>
<span class="udiff-line-added">+     &quot;sgn-pt&quot;,       &quot;psr&quot;,</span>
<span class="udiff-line-added">+     &quot;sgn-se&quot;,       &quot;swl&quot;,</span>
<span class="udiff-line-added">+     &quot;sgn-us&quot;,       &quot;ase&quot;,</span>
<span class="udiff-line-added">+     &quot;sgn-za&quot;,       &quot;sfs&quot;,</span>
<span class="udiff-line-added">+     &quot;zh-cmn&quot;,       &quot;cmn&quot;,</span>
<span class="udiff-line-added">+     &quot;zh-cmn-hans&quot;,  &quot;cmn-hans&quot;,</span>
<span class="udiff-line-added">+     &quot;zh-cmn-hant&quot;,  &quot;cmn-hant&quot;,</span>
<span class="udiff-line-added">+     &quot;zh-gan&quot;,       &quot;gan&quot;,</span>
<span class="udiff-line-added">+     &quot;zh-wuu&quot;,       &quot;wuu&quot;,</span>
<span class="udiff-line-added">+     &quot;zh-yue&quot;,       &quot;yue&quot;,</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // variant tag with preferred value</span>
<span class="udiff-line-added">+     &quot;ja-latn-hepburn-heploc&quot;, &quot;ja-latn-alalc97&quot;,</span>
  };
  
<span class="udiff-line-added">+ /*</span>
<span class="udiff-line-added">+   Updated on 2018-09-12 from</span>
<span class="udiff-line-added">+   https://www.iana.org/assignments/language-subtag-registry/language-subtag-registry .</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   grep &#39;Type: language&#39; -A 7 language-subtag-registry  | egrep &#39;Subtag|Prefe&#39; | \</span>
<span class="udiff-line-added">+   grep -B1 &#39;Preferred&#39; | grep -v &#39;^--&#39; | \</span>
<span class="udiff-line-added">+   awk -n &#39;/Subtag/ {printf(&quot;    \&quot;%s\&quot;,       &quot;, $2);} /Preferred/ {printf(&quot;\&quot;%s\&quot;,\n&quot;, $2);}&#39;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   Make sure that 2-letter language subtags come before 3-letter subtags.</span>
<span class="udiff-line-added">+ */</span>
  static const char DEPRECATEDLANGS[][4] = {
  /*  deprecated  new */
<span class="udiff-line-added">+     &quot;in&quot;,       &quot;id&quot;,</span>
      &quot;iw&quot;,       &quot;he&quot;,
      &quot;ji&quot;,       &quot;yi&quot;,
<span class="udiff-line-modified-removed">-     &quot;in&quot;,       &quot;id&quot;</span>
<span class="udiff-line-modified-added">+     &quot;jw&quot;,       &quot;jv&quot;,</span>
<span class="udiff-line-added">+     &quot;mo&quot;,       &quot;ro&quot;,</span>
<span class="udiff-line-added">+     &quot;aam&quot;,       &quot;aas&quot;,</span>
<span class="udiff-line-added">+     &quot;adp&quot;,       &quot;dz&quot;,</span>
<span class="udiff-line-added">+     &quot;aue&quot;,       &quot;ktz&quot;,</span>
<span class="udiff-line-added">+     &quot;ayx&quot;,       &quot;nun&quot;,</span>
<span class="udiff-line-added">+     &quot;bgm&quot;,       &quot;bcg&quot;,</span>
<span class="udiff-line-added">+     &quot;bjd&quot;,       &quot;drl&quot;,</span>
<span class="udiff-line-added">+     &quot;ccq&quot;,       &quot;rki&quot;,</span>
<span class="udiff-line-added">+     &quot;cjr&quot;,       &quot;mom&quot;,</span>
<span class="udiff-line-added">+     &quot;cka&quot;,       &quot;cmr&quot;,</span>
<span class="udiff-line-added">+     &quot;cmk&quot;,       &quot;xch&quot;,</span>
<span class="udiff-line-added">+     &quot;coy&quot;,       &quot;pij&quot;,</span>
<span class="udiff-line-added">+     &quot;cqu&quot;,       &quot;quh&quot;,</span>
<span class="udiff-line-added">+     &quot;drh&quot;,       &quot;khk&quot;,</span>
<span class="udiff-line-added">+     &quot;drw&quot;,       &quot;prs&quot;,</span>
<span class="udiff-line-added">+     &quot;gav&quot;,       &quot;dev&quot;,</span>
<span class="udiff-line-added">+     &quot;gfx&quot;,       &quot;vaj&quot;,</span>
<span class="udiff-line-added">+     &quot;ggn&quot;,       &quot;gvr&quot;,</span>
<span class="udiff-line-added">+     &quot;gti&quot;,       &quot;nyc&quot;,</span>
<span class="udiff-line-added">+     &quot;guv&quot;,       &quot;duz&quot;,</span>
<span class="udiff-line-added">+     &quot;hrr&quot;,       &quot;jal&quot;,</span>
<span class="udiff-line-added">+     &quot;ibi&quot;,       &quot;opa&quot;,</span>
<span class="udiff-line-added">+     &quot;ilw&quot;,       &quot;gal&quot;,</span>
<span class="udiff-line-added">+     &quot;jeg&quot;,       &quot;oyb&quot;,</span>
<span class="udiff-line-added">+     &quot;kgc&quot;,       &quot;tdf&quot;,</span>
<span class="udiff-line-added">+     &quot;kgh&quot;,       &quot;kml&quot;,</span>
<span class="udiff-line-added">+     &quot;koj&quot;,       &quot;kwv&quot;,</span>
<span class="udiff-line-added">+     &quot;krm&quot;,       &quot;bmf&quot;,</span>
<span class="udiff-line-added">+     &quot;ktr&quot;,       &quot;dtp&quot;,</span>
<span class="udiff-line-added">+     &quot;kvs&quot;,       &quot;gdj&quot;,</span>
<span class="udiff-line-added">+     &quot;kwq&quot;,       &quot;yam&quot;,</span>
<span class="udiff-line-added">+     &quot;kxe&quot;,       &quot;tvd&quot;,</span>
<span class="udiff-line-added">+     &quot;kzj&quot;,       &quot;dtp&quot;,</span>
<span class="udiff-line-added">+     &quot;kzt&quot;,       &quot;dtp&quot;,</span>
<span class="udiff-line-added">+     &quot;lii&quot;,       &quot;raq&quot;,</span>
<span class="udiff-line-added">+     &quot;lmm&quot;,       &quot;rmx&quot;,</span>
<span class="udiff-line-added">+     &quot;meg&quot;,       &quot;cir&quot;,</span>
<span class="udiff-line-added">+     &quot;mst&quot;,       &quot;mry&quot;,</span>
<span class="udiff-line-added">+     &quot;mwj&quot;,       &quot;vaj&quot;,</span>
<span class="udiff-line-added">+     &quot;myt&quot;,       &quot;mry&quot;,</span>
<span class="udiff-line-added">+     &quot;nad&quot;,       &quot;xny&quot;,</span>
<span class="udiff-line-added">+     &quot;ncp&quot;,       &quot;kdz&quot;,</span>
<span class="udiff-line-added">+     &quot;nnx&quot;,       &quot;ngv&quot;,</span>
<span class="udiff-line-added">+     &quot;nts&quot;,       &quot;pij&quot;,</span>
<span class="udiff-line-added">+     &quot;oun&quot;,       &quot;vaj&quot;,</span>
<span class="udiff-line-added">+     &quot;pcr&quot;,       &quot;adx&quot;,</span>
<span class="udiff-line-added">+     &quot;pmc&quot;,       &quot;huw&quot;,</span>
<span class="udiff-line-added">+     &quot;pmu&quot;,       &quot;phr&quot;,</span>
<span class="udiff-line-added">+     &quot;ppa&quot;,       &quot;bfy&quot;,</span>
<span class="udiff-line-added">+     &quot;ppr&quot;,       &quot;lcq&quot;,</span>
<span class="udiff-line-added">+     &quot;pry&quot;,       &quot;prt&quot;,</span>
<span class="udiff-line-added">+     &quot;puz&quot;,       &quot;pub&quot;,</span>
<span class="udiff-line-added">+     &quot;sca&quot;,       &quot;hle&quot;,</span>
<span class="udiff-line-added">+     &quot;skk&quot;,       &quot;oyb&quot;,</span>
<span class="udiff-line-added">+     &quot;tdu&quot;,       &quot;dtp&quot;,</span>
<span class="udiff-line-added">+     &quot;thc&quot;,       &quot;tpo&quot;,</span>
<span class="udiff-line-added">+     &quot;thx&quot;,       &quot;oyb&quot;,</span>
<span class="udiff-line-added">+     &quot;tie&quot;,       &quot;ras&quot;,</span>
<span class="udiff-line-added">+     &quot;tkk&quot;,       &quot;twm&quot;,</span>
<span class="udiff-line-added">+     &quot;tlw&quot;,       &quot;weo&quot;,</span>
<span class="udiff-line-added">+     &quot;tmp&quot;,       &quot;tyj&quot;,</span>
<span class="udiff-line-added">+     &quot;tne&quot;,       &quot;kak&quot;,</span>
<span class="udiff-line-added">+     &quot;tnf&quot;,       &quot;prs&quot;,</span>
<span class="udiff-line-added">+     &quot;tsf&quot;,       &quot;taj&quot;,</span>
<span class="udiff-line-added">+     &quot;uok&quot;,       &quot;ema&quot;,</span>
<span class="udiff-line-added">+     &quot;xba&quot;,       &quot;cax&quot;,</span>
<span class="udiff-line-added">+     &quot;xia&quot;,       &quot;acn&quot;,</span>
<span class="udiff-line-added">+     &quot;xkh&quot;,       &quot;waw&quot;,</span>
<span class="udiff-line-added">+     &quot;xsj&quot;,       &quot;suj&quot;,</span>
<span class="udiff-line-added">+     &quot;ybd&quot;,       &quot;rki&quot;,</span>
<span class="udiff-line-added">+     &quot;yma&quot;,       &quot;lrr&quot;,</span>
<span class="udiff-line-added">+     &quot;ymt&quot;,       &quot;mtm&quot;,</span>
<span class="udiff-line-added">+     &quot;yos&quot;,       &quot;zom&quot;,</span>
<span class="udiff-line-added">+     &quot;yuu&quot;,       &quot;yug&quot;,</span>
<span class="udiff-line-added">+ };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ /*</span>
<span class="udiff-line-added">+   Updated on 2018-04-24 from</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+   curl  https://www.iana.org/assignments/language-subtag-registry/language-subtag-registry | \</span>
<span class="udiff-line-added">+   grep &#39;Type: region&#39; -A 7 | egrep &#39;Subtag|Prefe&#39; | \</span>
<span class="udiff-line-added">+   grep -B1 &#39;Preferred&#39; | \</span>
<span class="udiff-line-added">+   awk -n &#39;/Subtag/ {printf(&quot;    \&quot;%s\&quot;,       &quot;, $2);} /Preferred/ {printf(&quot;\&quot;%s\&quot;,\n&quot;, $2);}&#39;</span>
<span class="udiff-line-added">+ */</span>
<span class="udiff-line-added">+ static const char DEPRECATEDREGIONS[][3] = {</span>
<span class="udiff-line-added">+ /*  deprecated  new */</span>
<span class="udiff-line-added">+     &quot;BU&quot;,       &quot;MM&quot;,</span>
<span class="udiff-line-added">+     &quot;DD&quot;,       &quot;DE&quot;,</span>
<span class="udiff-line-added">+     &quot;FX&quot;,       &quot;FR&quot;,</span>
<span class="udiff-line-added">+     &quot;TP&quot;,       &quot;TL&quot;,</span>
<span class="udiff-line-added">+     &quot;YD&quot;,       &quot;YE&quot;,</span>
<span class="udiff-line-added">+     &quot;ZR&quot;,       &quot;CD&quot;,</span>
  };
  
  /*
  * -------------------------------------------------
  *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -170,10 +347,25 @@</span>
  #if 0
  static const char*
  ultag_getGrandfathered(const ULanguageTag* langtag);
  #endif
  
<span class="udiff-line-added">+ U_NAMESPACE_BEGIN</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ /**</span>
<span class="udiff-line-added">+  * \class LocalULanguageTagPointer</span>
<span class="udiff-line-added">+  * &quot;Smart pointer&quot; class, closes a ULanguageTag via ultag_close().</span>
<span class="udiff-line-added">+  * For most methods see the LocalPointerBase base class.</span>
<span class="udiff-line-added">+  *</span>
<span class="udiff-line-added">+  * @see LocalPointerBase</span>
<span class="udiff-line-added">+  * @see LocalPointer</span>
<span class="udiff-line-added">+  * @internal</span>
<span class="udiff-line-added">+  */</span>
<span class="udiff-line-added">+ U_DEFINE_LOCAL_OPEN_POINTER(LocalULanguageTagPointer, ULanguageTag, ultag_close);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ U_NAMESPACE_END</span>
<span class="udiff-line-added">+ </span>
  /*
  * -------------------------------------------------
  *
  * Language subtag syntax validation functions
  *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -212,17 +404,26 @@</span>
      }
      return TRUE;
  }
  
  static UBool
<span class="udiff-line-modified-removed">- _isLanguageSubtag(const char* s, int32_t len) {</span>
<span class="udiff-line-modified-added">+ _isAlphaNumericStringLimitedLength(const char* s, int32_t len, int32_t min, int32_t max) {</span>
<span class="udiff-line-added">+     if (len &lt; 0) {</span>
<span class="udiff-line-added">+         len = (int32_t)uprv_strlen(s);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     if (len &gt;= min &amp;&amp; len &lt;= max &amp;&amp; _isAlphaNumericString(s, len)) {</span>
<span class="udiff-line-added">+         return TRUE;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     return FALSE;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ U_CFUNC UBool</span>
<span class="udiff-line-added">+ ultag_isLanguageSubtag(const char* s, int32_t len) {</span>
      /*
<span class="udiff-line-modified-removed">-      * language      = 2*3ALPHA            ; shortest ISO 639 code</span>
<span class="udiff-line-modified-removed">-      *                 [&quot;-&quot; extlang]       ; sometimes followed by</span>
<span class="udiff-line-modified-removed">-      *                                     ;   extended language subtags</span>
<span class="udiff-line-removed">-      *               / 4ALPHA              ; or reserved for future use</span>
<span class="udiff-line-removed">-      *               / 5*8ALPHA            ; or registered language subtag</span>
<span class="udiff-line-modified-added">+      * unicode_language_subtag = alpha{2,3} | alpha{5,8};</span>
<span class="udiff-line-modified-added">+      * NOTE: Per ICUTC 2019/01/23- accepting alpha 4</span>
<span class="udiff-line-modified-added">+      * See ICU-20372</span>
       */
      if (len &lt; 0) {
          len = (int32_t)uprv_strlen(s);
      }
      if (len &gt;= 2 &amp;&amp; len &lt;= 8 &amp;&amp; _isAlphaString(s, len)) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -244,12 +445,12 @@</span>
          return TRUE;
      }
      return FALSE;
  }
  
<span class="udiff-line-modified-removed">- static UBool</span>
<span class="udiff-line-modified-removed">- _isScriptSubtag(const char* s, int32_t len) {</span>
<span class="udiff-line-modified-added">+ U_CFUNC UBool</span>
<span class="udiff-line-modified-added">+ ultag_isScriptSubtag(const char* s, int32_t len) {</span>
      /*
       * script        = 4ALPHA              ; ISO 15924 code
       */
      if (len &lt; 0) {
          len = (int32_t)uprv_strlen(s);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -258,12 +459,12 @@</span>
          return TRUE;
      }
      return FALSE;
  }
  
<span class="udiff-line-modified-removed">- static UBool</span>
<span class="udiff-line-modified-removed">- _isRegionSubtag(const char* s, int32_t len) {</span>
<span class="udiff-line-modified-added">+ U_CFUNC UBool</span>
<span class="udiff-line-modified-added">+ ultag_isRegionSubtag(const char* s, int32_t len) {</span>
      /*
       * region        = 2ALPHA              ; ISO 3166-1 code
       *               / 3DIGIT              ; UN M.49 code
       */
      if (len &lt; 0) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -285,172 +486,326 @@</span>
       *               / (DIGIT 3alphanum)
       */
      if (len &lt; 0) {
          len = (int32_t)uprv_strlen(s);
      }
<span class="udiff-line-modified-removed">-     if (len &gt;= 5 &amp;&amp; len &lt;= 8 &amp;&amp; _isAlphaNumericString(s, len)) {</span>
<span class="udiff-line-modified-added">+     if (_isAlphaNumericStringLimitedLength(s, len, 5, 8)) {</span>
          return TRUE;
      }
      if (len == 4 &amp;&amp; ISNUMERIC(*s) &amp;&amp; _isAlphaNumericString(s + 1, 3)) {
          return TRUE;
      }
      return FALSE;
  }
  
<span class="udiff-line-added">+ static UBool</span>
<span class="udiff-line-added">+ _isSepListOf(UBool (*test)(const char*, int32_t), const char* s, int32_t len) {</span>
<span class="udiff-line-added">+     const char *p = s;</span>
<span class="udiff-line-added">+     const char *pSubtag = NULL;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (len &lt; 0) {</span>
<span class="udiff-line-added">+         len = (int32_t)uprv_strlen(s);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     while ((p - s) &lt; len) {</span>
<span class="udiff-line-added">+         if (*p == SEP) {</span>
<span class="udiff-line-added">+             if (pSubtag == NULL) {</span>
<span class="udiff-line-added">+                 return FALSE;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             if (!test(pSubtag, (int32_t)(p - pSubtag))) {</span>
<span class="udiff-line-added">+                 return FALSE;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             pSubtag = NULL;</span>
<span class="udiff-line-added">+         } else if (pSubtag == NULL) {</span>
<span class="udiff-line-added">+             pSubtag = p;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         p++;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     if (pSubtag == NULL) {</span>
<span class="udiff-line-added">+         return FALSE;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     return test(pSubtag, (int32_t)(p - pSubtag));</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ U_CFUNC UBool</span>
<span class="udiff-line-added">+ ultag_isVariantSubtags(const char* s, int32_t len) {</span>
<span class="udiff-line-added">+     return _isSepListOf(&amp;_isVariantSubtag, s, len);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ // This is for the ICU-specific &quot;lvariant&quot; handling.</span>
  static UBool
  _isPrivateuseVariantSubtag(const char* s, int32_t len) {
      /*
       * variant       = 1*8alphanum         ; registered variants
       *               / (DIGIT 3alphanum)
       */
<span class="udiff-line-modified-removed">-     if (len &lt; 0) {</span>
<span class="udiff-line-removed">-         len = (int32_t)uprv_strlen(s);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     if (len &gt;= 1 &amp;&amp; len &lt;= 8 &amp;&amp; _isAlphaNumericString(s, len)) {</span>
<span class="udiff-line-removed">-         return TRUE;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     return FALSE;</span>
<span class="udiff-line-modified-added">+     return _isAlphaNumericStringLimitedLength(s, len , 1, 8);</span>
  }
  
  static UBool
  _isExtensionSingleton(const char* s, int32_t len) {
      /*
       * extension     = singleton 1*(&quot;-&quot; (2*8alphanum))
<span class="udiff-line-added">+      *</span>
<span class="udiff-line-added">+      * singleton     = DIGIT               ; 0 - 9</span>
<span class="udiff-line-added">+      *               / %x41-57             ; A - W</span>
<span class="udiff-line-added">+      *               / %x59-5A             ; Y - Z</span>
<span class="udiff-line-added">+      *               / %x61-77             ; a - w</span>
<span class="udiff-line-added">+      *               / %x79-7A             ; y - z</span>
       */
      if (len &lt; 0) {
          len = (int32_t)uprv_strlen(s);
      }
<span class="udiff-line-modified-removed">-     if (len == 1 &amp;&amp; ISALPHA(*s) &amp;&amp; (uprv_tolower(*s) != PRIVATEUSE)) {</span>
<span class="udiff-line-modified-added">+     if (len == 1 &amp;&amp; (ISALPHA(*s) || ISNUMERIC(*s)) &amp;&amp; (uprv_tolower(*s) != PRIVATEUSE)) {</span>
          return TRUE;
      }
      return FALSE;
  }
  
  static UBool
  _isExtensionSubtag(const char* s, int32_t len) {
      /*
       * extension     = singleton 1*(&quot;-&quot; (2*8alphanum))
       */
<span class="udiff-line-added">+     return _isAlphaNumericStringLimitedLength(s, len, 2, 8);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ U_CFUNC UBool</span>
<span class="udiff-line-added">+ ultag_isExtensionSubtags(const char* s, int32_t len) {</span>
<span class="udiff-line-added">+     return _isSepListOf(&amp;_isExtensionSubtag, s, len);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ static UBool</span>
<span class="udiff-line-added">+ _isPrivateuseValueSubtag(const char* s, int32_t len) {</span>
<span class="udiff-line-added">+     /*</span>
<span class="udiff-line-added">+      * privateuse    = &quot;x&quot; 1*(&quot;-&quot; (1*8alphanum))</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     return _isAlphaNumericStringLimitedLength(s, len, 1, 8);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ U_CFUNC UBool</span>
<span class="udiff-line-added">+ ultag_isPrivateuseValueSubtags(const char* s, int32_t len) {</span>
<span class="udiff-line-added">+     return _isSepListOf(&amp;_isPrivateuseValueSubtag, s, len);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ U_CFUNC UBool</span>
<span class="udiff-line-added">+ ultag_isUnicodeLocaleAttribute(const char* s, int32_t len) {</span>
<span class="udiff-line-added">+     /*</span>
<span class="udiff-line-added">+      * attribute = alphanum{3,8} ;</span>
<span class="udiff-line-added">+      */</span>
<span class="udiff-line-added">+     return _isAlphaNumericStringLimitedLength(s, len , 3, 8);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ U_CFUNC UBool</span>
<span class="udiff-line-added">+ ultag_isUnicodeLocaleAttributes(const char* s, int32_t len) {</span>
<span class="udiff-line-added">+     return _isSepListOf(&amp;ultag_isUnicodeLocaleAttribute, s, len);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ U_CFUNC UBool</span>
<span class="udiff-line-added">+ ultag_isUnicodeLocaleKey(const char* s, int32_t len) {</span>
<span class="udiff-line-added">+     /*</span>
<span class="udiff-line-added">+      * key = alphanum alpha ;</span>
<span class="udiff-line-added">+      */</span>
      if (len &lt; 0) {
          len = (int32_t)uprv_strlen(s);
      }
<span class="udiff-line-modified-removed">-     if (len &gt;= 2 &amp;&amp; len &lt;= 8 &amp;&amp; _isAlphaNumericString(s, len)) {</span>
<span class="udiff-line-modified-added">+     if (len == 2 &amp;&amp; (ISALPHA(*s) || ISNUMERIC(*s)) &amp;&amp; ISALPHA(s[1])) {</span>
          return TRUE;
      }
      return FALSE;
  }
  
<span class="udiff-line-modified-removed">- static UBool</span>
<span class="udiff-line-modified-removed">- _isExtensionSubtags(const char* s, int32_t len) {</span>
<span class="udiff-line-modified-removed">-     const char *p = s;</span>
<span class="udiff-line-modified-removed">-     const char *pSubtag = NULL;</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-     if (len &lt; 0) {</span>
<span class="udiff-line-modified-removed">-         len = (int32_t)uprv_strlen(s);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+ U_CFUNC UBool</span>
<span class="udiff-line-modified-added">+ _isUnicodeLocaleTypeSubtag(const char*s, int32_t len) {</span>
<span class="udiff-line-modified-added">+     /*</span>
<span class="udiff-line-modified-added">+      * alphanum{3,8}</span>
<span class="udiff-line-modified-added">+      */</span>
<span class="udiff-line-modified-added">+     return _isAlphaNumericStringLimitedLength(s, len , 3, 8);</span>
<span class="udiff-line-modified-added">+ }</span>
  
<span class="udiff-line-modified-removed">-     while ((p - s) &lt; len) {</span>
<span class="udiff-line-modified-removed">-         if (*p == SEP) {</span>
<span class="udiff-line-modified-removed">-             if (pSubtag == NULL) {</span>
<span class="udiff-line-modified-removed">-                 return FALSE;</span>
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-removed">-             if (!_isExtensionSubtag(pSubtag, (int32_t)(p - pSubtag))) {</span>
<span class="udiff-line-removed">-                 return FALSE;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             pSubtag = NULL;</span>
<span class="udiff-line-removed">-         } else if (pSubtag == NULL) {</span>
<span class="udiff-line-removed">-             pSubtag = p;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         p++;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     if (pSubtag == NULL) {</span>
<span class="udiff-line-removed">-         return FALSE;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">-     return _isExtensionSubtag(pSubtag, (int32_t)(p - pSubtag));</span>
<span class="udiff-line-modified-added">+ U_CFUNC UBool</span>
<span class="udiff-line-modified-added">+ ultag_isUnicodeLocaleType(const char*s, int32_t len) {</span>
<span class="udiff-line-modified-added">+     /*</span>
<span class="udiff-line-modified-added">+      * type = alphanum{3,8} (sep alphanum{3,8})* ;</span>
<span class="udiff-line-modified-added">+      */</span>
<span class="udiff-line-modified-added">+     return _isSepListOf(&amp;_isUnicodeLocaleTypeSubtag, s, len);</span>
  }
  
  static UBool
<span class="udiff-line-modified-removed">- _isPrivateuseValueSubtag(const char* s, int32_t len) {</span>
<span class="udiff-line-modified-added">+ _isTKey(const char* s, int32_t len)</span>
<span class="udiff-line-added">+ {</span>
      /*
<span class="udiff-line-modified-removed">-      * privateuse    = &quot;x&quot; 1*(&quot;-&quot; (1*8alphanum))</span>
<span class="udiff-line-modified-added">+      * tkey = alpha digit ;</span>
       */
      if (len &lt; 0) {
          len = (int32_t)uprv_strlen(s);
      }
<span class="udiff-line-modified-removed">-     if (len &gt;= 1 &amp;&amp; len &lt;= 8 &amp;&amp; _isAlphaNumericString(s, len)) {</span>
<span class="udiff-line-modified-added">+     if (len == 2 &amp;&amp; ISALPHA(*s) &amp;&amp; ISNUMERIC(*(s + 1))) {</span>
          return TRUE;
      }
      return FALSE;
  }
  
  static UBool
<span class="udiff-line-modified-removed">- _isPrivateuseValueSubtags(const char* s, int32_t len) {</span>
<span class="udiff-line-modified-removed">-     const char *p = s;</span>
<span class="udiff-line-modified-removed">-     const char *pSubtag = NULL;</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-     if (len &lt; 0) {</span>
<span class="udiff-line-modified-removed">-         len = (int32_t)uprv_strlen(s);</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+ _isTValue(const char* s, int32_t len)</span>
<span class="udiff-line-modified-added">+ {</span>
<span class="udiff-line-modified-added">+     /*</span>
<span class="udiff-line-modified-added">+      * tvalue = (sep alphanum{3,8})+ ;</span>
<span class="udiff-line-modified-added">+      */</span>
<span class="udiff-line-modified-added">+     return _isAlphaNumericStringLimitedLength(s, len , 3, 8);</span>
<span class="udiff-line-modified-added">+ }</span>
  
<span class="udiff-line-modified-removed">-     while ((p - s) &lt; len) {</span>
<span class="udiff-line-modified-removed">-         if (*p == SEP) {</span>
<span class="udiff-line-modified-removed">-             if (pSubtag == NULL) {</span>
<span class="udiff-line-modified-removed">-                 return FALSE;</span>
<span class="udiff-line-modified-added">+ static UBool</span>
<span class="udiff-line-modified-added">+ _isTransformedExtensionSubtag(int32_t&amp; state, const char* s, int32_t len)</span>
<span class="udiff-line-modified-added">+ {</span>
<span class="udiff-line-modified-added">+     const int32_t kStart = 0;       // Start, wait for unicode_language_subtag, tkey or end</span>
<span class="udiff-line-added">+     const int32_t kGotLanguage = 1; // Got unicode_language_subtag, wait for unicode_script_subtag,</span>
<span class="udiff-line-added">+                                     // unicode_region_subtag, unicode_variant_subtag, tkey or end</span>
<span class="udiff-line-added">+     const int32_t kGotScript = 2;   // Got unicode_script_subtag, wait for unicode_region_subtag,</span>
<span class="udiff-line-added">+                                     // unicode_variant_subtag, tkey, or end</span>
<span class="udiff-line-added">+     const int32_t kGotRegion = 3;   // Got unicode_region_subtag, wait for unicode_variant_subtag,</span>
<span class="udiff-line-added">+                                     // tkey, or end.</span>
<span class="udiff-line-added">+     const int32_t kGotVariant = 4;  // Got unicode_variant_subtag, wait for unicode_variant_subtag</span>
<span class="udiff-line-added">+                                     // tkey or end.</span>
<span class="udiff-line-added">+     const int32_t kGotTKey = -1;    // Got tkey, wait for tvalue. ERROR if stop here.</span>
<span class="udiff-line-added">+     const int32_t kGotTValue = 6;   // Got tvalue, wait for tkey, tvalue or end</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     switch (state) {</span>
<span class="udiff-line-added">+         case kStart:</span>
<span class="udiff-line-added">+             if (ultag_isLanguageSubtag(s, len)) {</span>
<span class="udiff-line-added">+                 state = kGotLanguage;</span>
<span class="udiff-line-added">+                 return TRUE;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             if (_isTKey(s, len)) {</span>
<span class="udiff-line-added">+                 state = kGotTKey;</span>
<span class="udiff-line-added">+                 return TRUE;</span>
              }
<span class="udiff-line-modified-removed">-             if (!_isPrivateuseValueSubtag(pSubtag, (int32_t)(p - pSubtag))) {</span>
<span class="udiff-line-modified-removed">-                 return FALSE;</span>
<span class="udiff-line-modified-added">+             return FALSE;</span>
<span class="udiff-line-modified-added">+         case kGotLanguage:</span>
<span class="udiff-line-added">+             if (ultag_isScriptSubtag(s, len)) {</span>
<span class="udiff-line-added">+                 state = kGotScript;</span>
<span class="udiff-line-added">+                 return TRUE;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             U_FALLTHROUGH;</span>
<span class="udiff-line-added">+         case kGotScript:</span>
<span class="udiff-line-added">+             if (ultag_isRegionSubtag(s, len)) {</span>
<span class="udiff-line-added">+                 state = kGotRegion;</span>
<span class="udiff-line-added">+                 return TRUE;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             U_FALLTHROUGH;</span>
<span class="udiff-line-added">+         case kGotRegion:</span>
<span class="udiff-line-added">+             U_FALLTHROUGH;</span>
<span class="udiff-line-added">+         case kGotVariant:</span>
<span class="udiff-line-added">+             if (_isVariantSubtag(s, len)) {</span>
<span class="udiff-line-added">+                 state = kGotVariant;</span>
<span class="udiff-line-added">+                 return TRUE;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             if (_isTKey(s, len)) {</span>
<span class="udiff-line-added">+                 state = kGotTKey;</span>
<span class="udiff-line-added">+                 return TRUE;</span>
              }
<span class="udiff-line-modified-removed">-             pSubtag = NULL;</span>
<span class="udiff-line-modified-removed">-         } else if (pSubtag == NULL) {</span>
<span class="udiff-line-modified-removed">-             pSubtag = p;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         p++;</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-removed">-     if (pSubtag == NULL) {</span>
<span class="udiff-line-modified-removed">-         return FALSE;</span>
<span class="udiff-line-modified-added">+             return FALSE;</span>
<span class="udiff-line-modified-added">+         case kGotTKey:</span>
<span class="udiff-line-modified-added">+             if (_isTValue(s, len)) {</span>
<span class="udiff-line-modified-added">+                 state = kGotTValue;</span>
<span class="udiff-line-modified-added">+                 return TRUE;</span>
<span class="udiff-line-modified-added">+             }</span>
<span class="udiff-line-modified-added">+             return FALSE;</span>
<span class="udiff-line-modified-added">+         case kGotTValue:</span>
<span class="udiff-line-added">+             if (_isTKey(s, len)) {</span>
<span class="udiff-line-added">+                 state = kGotTKey;</span>
<span class="udiff-line-added">+                 return TRUE;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             if (_isTValue(s, len)) {</span>
<span class="udiff-line-added">+                 return TRUE;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             return FALSE;</span>
      }
<span class="udiff-line-modified-removed">-     return _isPrivateuseValueSubtag(pSubtag, (int32_t)(p - pSubtag));</span>
<span class="udiff-line-modified-added">+     return FALSE;</span>
  }
  
<span class="udiff-line-modified-removed">- U_CFUNC UBool</span>
<span class="udiff-line-modified-removed">- ultag_isUnicodeLocaleKey(const char* s, int32_t len) {</span>
<span class="udiff-line-modified-removed">-     if (len &lt; 0) {</span>
<span class="udiff-line-modified-removed">-         len = (int32_t)uprv_strlen(s);</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-removed">-     if (len == 2 &amp;&amp; _isAlphaNumericString(s, len)) {</span>
<span class="udiff-line-modified-removed">-         return TRUE;</span>
<span class="udiff-line-modified-added">+ static UBool</span>
<span class="udiff-line-modified-added">+ _isUnicodeExtensionSubtag(int32_t&amp; state, const char* s, int32_t len)</span>
<span class="udiff-line-modified-added">+ {</span>
<span class="udiff-line-modified-added">+     const int32_t kStart = 0;         // Start, wait for a key or attribute or end</span>
<span class="udiff-line-modified-added">+     const int32_t kGotKey = 1;        // Got a key, wait for type or key or end</span>
<span class="udiff-line-modified-added">+     const int32_t kGotType = 2;       // Got a type, wait for key or end</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+     switch (state) {</span>
<span class="udiff-line-added">+         case kStart:</span>
<span class="udiff-line-added">+             if (ultag_isUnicodeLocaleKey(s, len)) {</span>
<span class="udiff-line-added">+                 state = kGotKey;</span>
<span class="udiff-line-added">+                 return TRUE;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             if (ultag_isUnicodeLocaleAttribute(s, len)) {</span>
<span class="udiff-line-added">+                 return TRUE;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             return FALSE;</span>
<span class="udiff-line-added">+         case kGotKey:</span>
<span class="udiff-line-added">+             if (ultag_isUnicodeLocaleKey(s, len)) {</span>
<span class="udiff-line-added">+                 return TRUE;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             if (_isUnicodeLocaleTypeSubtag(s, len)) {</span>
<span class="udiff-line-added">+                 state = kGotType;</span>
<span class="udiff-line-added">+                 return TRUE;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             return FALSE;</span>
<span class="udiff-line-added">+         case kGotType:</span>
<span class="udiff-line-added">+             if (ultag_isUnicodeLocaleKey(s, len)) {</span>
<span class="udiff-line-added">+                 state = kGotKey;</span>
<span class="udiff-line-added">+                 return TRUE;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             if (_isUnicodeLocaleTypeSubtag(s, len)) {</span>
<span class="udiff-line-added">+                 return TRUE;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             return FALSE;</span>
      }
      return FALSE;
  }
  
<span class="udiff-line-modified-removed">- U_CFUNC UBool</span>
<span class="udiff-line-modified-removed">- ultag_isUnicodeLocaleType(const char*s, int32_t len) {</span>
<span class="udiff-line-modified-added">+ static UBool</span>
<span class="udiff-line-modified-added">+ _isStatefulSepListOf(UBool (*test)(int32_t&amp;, const char*, int32_t), const char* s, int32_t len)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     int32_t state = 0;</span>
      const char* p;
<span class="udiff-line-added">+     const char* start = s;</span>
      int32_t subtagLen = 0;
  
      if (len &lt; 0) {
          len = (int32_t)uprv_strlen(s);
      }
  
      for (p = s; len &gt; 0; p++, len--) {
          if (*p == SEP) {
<span class="udiff-line-modified-removed">-             if (subtagLen &lt; 3) {</span>
<span class="udiff-line-modified-added">+             if (!test(state, start, subtagLen)) {</span>
                  return FALSE;
              }
              subtagLen = 0;
<span class="udiff-line-modified-removed">-         } else if (ISALPHA(*p) || ISNUMERIC(*p)) {</span>
<span class="udiff-line-removed">-             subtagLen++;</span>
<span class="udiff-line-removed">-             if (subtagLen &gt; 8) {</span>
<span class="udiff-line-removed">-                 return FALSE;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-modified-added">+             start = p + 1;</span>
          } else {
<span class="udiff-line-modified-removed">-             return FALSE;</span>
<span class="udiff-line-modified-added">+             subtagLen++;</span>
          }
      }
  
<span class="udiff-line-modified-removed">-     return (subtagLen &gt;= 3);</span>
<span class="udiff-line-modified-added">+     if (test(state, start, subtagLen) &amp;&amp; state &gt;= 0) {</span>
<span class="udiff-line-added">+         return TRUE;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     return FALSE;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ U_CFUNC UBool</span>
<span class="udiff-line-added">+ ultag_isTransformedExtensionSubtags(const char* s, int32_t len)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     return _isStatefulSepListOf(&amp;_isTransformedExtensionSubtag, s, len);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ U_CFUNC UBool</span>
<span class="udiff-line-added">+ ultag_isUnicodeExtensionSubtags(const char* s, int32_t len) {</span>
<span class="udiff-line-added">+     return _isStatefulSepListOf(&amp;_isUnicodeExtensionSubtag, s, len);</span>
  }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
  /*
  * -------------------------------------------------
  *
  * Helper functions
  *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -633,166 +988,146 @@</span>
  
      langtag-&gt;grandfathered = EMPTY;
      langtag-&gt;privateuse = EMPTY;
  }
  
<span class="udiff-line-modified-removed">- static int32_t</span>
<span class="udiff-line-modified-removed">- _appendLanguageToLanguageTag(const char* localeID, char* appendAt, int32_t capacity, UBool strict, UErrorCode* status) {</span>
<span class="udiff-line-modified-added">+ static void</span>
<span class="udiff-line-modified-added">+ _appendLanguageToLanguageTag(const char* localeID, icu::ByteSink&amp; sink, UBool strict, UErrorCode* status) {</span>
      char buf[ULOC_LANG_CAPACITY];
      UErrorCode tmpStatus = U_ZERO_ERROR;
      int32_t len, i;
<span class="udiff-line-removed">-     int32_t reslen = 0;</span>
  
      if (U_FAILURE(*status)) {
<span class="udiff-line-modified-removed">-         return 0;</span>
<span class="udiff-line-modified-added">+         return;</span>
      }
  
      len = uloc_getLanguage(localeID, buf, sizeof(buf), &amp;tmpStatus);
      if (U_FAILURE(tmpStatus) || tmpStatus == U_STRING_NOT_TERMINATED_WARNING) {
          if (strict) {
              *status = U_ILLEGAL_ARGUMENT_ERROR;
<span class="udiff-line-modified-removed">-             return 0;</span>
<span class="udiff-line-modified-added">+             return;</span>
          }
          len = 0;
      }
  
      /* Note: returned language code is in lower case letters */
  
      if (len == 0) {
<span class="udiff-line-modified-removed">-         if (reslen &lt; capacity) {</span>
<span class="udiff-line-modified-removed">-             uprv_memcpy(appendAt + reslen, LANG_UND, uprv_min(LANG_UND_LEN, capacity - reslen));</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         reslen += LANG_UND_LEN;</span>
<span class="udiff-line-removed">-     } else if (!_isLanguageSubtag(buf, len)) {</span>
<span class="udiff-line-modified-added">+         sink.Append(LANG_UND, LANG_UND_LEN);</span>
<span class="udiff-line-modified-added">+     } else if (!ultag_isLanguageSubtag(buf, len)) {</span>
              /* invalid language code */
          if (strict) {
              *status = U_ILLEGAL_ARGUMENT_ERROR;
<span class="udiff-line-modified-removed">-             return 0;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         if (reslen &lt; capacity) {</span>
<span class="udiff-line-removed">-             uprv_memcpy(appendAt + reslen, LANG_UND, uprv_min(LANG_UND_LEN, capacity - reslen));</span>
<span class="udiff-line-modified-added">+             return;</span>
          }
<span class="udiff-line-modified-removed">-         reslen += LANG_UND_LEN;</span>
<span class="udiff-line-modified-added">+         sink.Append(LANG_UND, LANG_UND_LEN);</span>
      } else {
          /* resolve deprecated */
          for (i = 0; i &lt; UPRV_LENGTHOF(DEPRECATEDLANGS); i += 2) {
<span class="udiff-line-added">+             // 2-letter deprecated subtags are listede before 3-letter</span>
<span class="udiff-line-added">+             // ones in DEPRECATEDLANGS[]. Get out of loop on coming</span>
<span class="udiff-line-added">+             // across the 1st 3-letter subtag, if the input is a 2-letter code.</span>
<span class="udiff-line-added">+             // to avoid continuing to try when there&#39;s no match.</span>
<span class="udiff-line-added">+             if (uprv_strlen(buf) &lt; uprv_strlen(DEPRECATEDLANGS[i])) break;</span>
              if (uprv_compareInvCharsAsAscii(buf, DEPRECATEDLANGS[i]) == 0) {
                  uprv_strcpy(buf, DEPRECATEDLANGS[i + 1]);
                  len = (int32_t)uprv_strlen(buf);
                  break;
              }
          }
<span class="udiff-line-modified-removed">-         if (reslen &lt; capacity) {</span>
<span class="udiff-line-removed">-             uprv_memcpy(appendAt + reslen, buf, uprv_min(len, capacity - reslen));</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         reslen += len;</span>
<span class="udiff-line-modified-added">+         sink.Append(buf, len);</span>
      }
<span class="udiff-line-removed">-     u_terminateChars(appendAt, capacity, reslen, status);</span>
<span class="udiff-line-removed">-     return reslen;</span>
  }
  
<span class="udiff-line-modified-removed">- static int32_t</span>
<span class="udiff-line-modified-removed">- _appendScriptToLanguageTag(const char* localeID, char* appendAt, int32_t capacity, UBool strict, UErrorCode* status) {</span>
<span class="udiff-line-modified-added">+ static void</span>
<span class="udiff-line-modified-added">+ _appendScriptToLanguageTag(const char* localeID, icu::ByteSink&amp; sink, UBool strict, UErrorCode* status) {</span>
      char buf[ULOC_SCRIPT_CAPACITY];
      UErrorCode tmpStatus = U_ZERO_ERROR;
      int32_t len;
<span class="udiff-line-removed">-     int32_t reslen = 0;</span>
  
      if (U_FAILURE(*status)) {
<span class="udiff-line-modified-removed">-         return 0;</span>
<span class="udiff-line-modified-added">+         return;</span>
      }
  
      len = uloc_getScript(localeID, buf, sizeof(buf), &amp;tmpStatus);
      if (U_FAILURE(tmpStatus) || tmpStatus == U_STRING_NOT_TERMINATED_WARNING) {
          if (strict) {
              *status = U_ILLEGAL_ARGUMENT_ERROR;
          }
<span class="udiff-line-modified-removed">-         return 0;</span>
<span class="udiff-line-modified-added">+         return;</span>
      }
  
      if (len &gt; 0) {
<span class="udiff-line-modified-removed">-         if (!_isScriptSubtag(buf, len)) {</span>
<span class="udiff-line-modified-added">+         if (!ultag_isScriptSubtag(buf, len)) {</span>
              /* invalid script code */
              if (strict) {
                  *status = U_ILLEGAL_ARGUMENT_ERROR;
              }
<span class="udiff-line-modified-removed">-             return 0;</span>
<span class="udiff-line-modified-added">+             return;</span>
          } else {
<span class="udiff-line-modified-removed">-             if (reslen &lt; capacity) {</span>
<span class="udiff-line-modified-removed">-                 *(appendAt + reslen) = SEP;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             reslen++;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             if (reslen &lt; capacity) {</span>
<span class="udiff-line-removed">-                 uprv_memcpy(appendAt + reslen, buf, uprv_min(len, capacity - reslen));</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             reslen += len;</span>
<span class="udiff-line-modified-added">+             sink.Append(&quot;-&quot;, 1);</span>
<span class="udiff-line-modified-added">+             sink.Append(buf, len);</span>
          }
      }
<span class="udiff-line-removed">-     u_terminateChars(appendAt, capacity, reslen, status);</span>
<span class="udiff-line-removed">-     return reslen;</span>
  }
  
<span class="udiff-line-modified-removed">- static int32_t</span>
<span class="udiff-line-modified-removed">- _appendRegionToLanguageTag(const char* localeID, char* appendAt, int32_t capacity, UBool strict, UErrorCode* status) {</span>
<span class="udiff-line-modified-added">+ static void</span>
<span class="udiff-line-modified-added">+ _appendRegionToLanguageTag(const char* localeID, icu::ByteSink&amp; sink, UBool strict, UErrorCode* status) {</span>
      char buf[ULOC_COUNTRY_CAPACITY];
      UErrorCode tmpStatus = U_ZERO_ERROR;
      int32_t len;
<span class="udiff-line-removed">-     int32_t reslen = 0;</span>
  
      if (U_FAILURE(*status)) {
<span class="udiff-line-modified-removed">-         return 0;</span>
<span class="udiff-line-modified-added">+         return;</span>
      }
  
      len = uloc_getCountry(localeID, buf, sizeof(buf), &amp;tmpStatus);
      if (U_FAILURE(tmpStatus) || tmpStatus == U_STRING_NOT_TERMINATED_WARNING) {
          if (strict) {
              *status = U_ILLEGAL_ARGUMENT_ERROR;
          }
<span class="udiff-line-modified-removed">-         return 0;</span>
<span class="udiff-line-modified-added">+         return;</span>
      }
  
      if (len &gt; 0) {
<span class="udiff-line-modified-removed">-         if (!_isRegionSubtag(buf, len)) {</span>
<span class="udiff-line-modified-added">+         if (!ultag_isRegionSubtag(buf, len)) {</span>
              /* invalid region code */
              if (strict) {
                  *status = U_ILLEGAL_ARGUMENT_ERROR;
              }
<span class="udiff-line-modified-removed">-             return 0;</span>
<span class="udiff-line-modified-added">+             return;</span>
          } else {
<span class="udiff-line-modified-removed">-             if (reslen &lt; capacity) {</span>
<span class="udiff-line-modified-removed">-                 *(appendAt + reslen) = SEP;</span>
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-removed">-             reslen++;</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-             if (reslen &lt; capacity) {</span>
<span class="udiff-line-modified-removed">-                 uprv_memcpy(appendAt + reslen, buf, uprv_min(len, capacity - reslen));</span>
<span class="udiff-line-modified-added">+             sink.Append(&quot;-&quot;, 1);</span>
<span class="udiff-line-modified-added">+             /* resolve deprecated */</span>
<span class="udiff-line-modified-added">+             for (int i = 0; i &lt; UPRV_LENGTHOF(DEPRECATEDREGIONS); i += 2) {</span>
<span class="udiff-line-modified-added">+                 if (uprv_compareInvCharsAsAscii(buf, DEPRECATEDREGIONS[i]) == 0) {</span>
<span class="udiff-line-modified-added">+                     uprv_strcpy(buf, DEPRECATEDREGIONS[i + 1]);</span>
<span class="udiff-line-modified-added">+                     len = (int32_t)uprv_strlen(buf);</span>
<span class="udiff-line-modified-added">+                     break;</span>
<span class="udiff-line-added">+                 }</span>
              }
<span class="udiff-line-modified-removed">-             reslen += len;</span>
<span class="udiff-line-modified-added">+             sink.Append(buf, len);</span>
          }
      }
<span class="udiff-line-removed">-     u_terminateChars(appendAt, capacity, reslen, status);</span>
<span class="udiff-line-removed">-     return reslen;</span>
  }
  
<span class="udiff-line-modified-removed">- static int32_t</span>
<span class="udiff-line-modified-removed">- _appendVariantsToLanguageTag(const char* localeID, char* appendAt, int32_t capacity, UBool strict, UBool *hadPosix, UErrorCode* status) {</span>
<span class="udiff-line-modified-added">+ static void</span>
<span class="udiff-line-modified-added">+ _appendVariantsToLanguageTag(const char* localeID, icu::ByteSink&amp; sink, UBool strict, UBool *hadPosix, UErrorCode* status) {</span>
      char buf[ULOC_FULLNAME_CAPACITY];
      UErrorCode tmpStatus = U_ZERO_ERROR;
      int32_t len, i;
<span class="udiff-line-removed">-     int32_t reslen = 0;</span>
  
      if (U_FAILURE(*status)) {
<span class="udiff-line-modified-removed">-         return 0;</span>
<span class="udiff-line-modified-added">+         return;</span>
      }
  
      len = uloc_getVariant(localeID, buf, sizeof(buf), &amp;tmpStatus);
      if (U_FAILURE(tmpStatus) || tmpStatus == U_STRING_NOT_TERMINATED_WARNING) {
          if (strict) {
              *status = U_ILLEGAL_ARGUMENT_ERROR;
          }
<span class="udiff-line-modified-removed">-         return 0;</span>
<span class="udiff-line-modified-added">+         return;</span>
      }
  
      if (len &gt; 0) {
          char *p, *pVar;
          UBool bNext = TRUE;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -865,19 +1200,13 @@</span>
                  int32_t varLen;
  
                  /* write out validated/normalized variants to the target */
                  var = varFirst;
                  while (var != NULL) {
<span class="udiff-line-modified-removed">-                     if (reslen &lt; capacity) {</span>
<span class="udiff-line-removed">-                         *(appendAt + reslen) = SEP;</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-removed">-                     reslen++;</span>
<span class="udiff-line-modified-added">+                     sink.Append(&quot;-&quot;, 1);</span>
                      varLen = (int32_t)uprv_strlen(var-&gt;variant);
<span class="udiff-line-modified-removed">-                     if (reslen &lt; capacity) {</span>
<span class="udiff-line-removed">-                         uprv_memcpy(appendAt + reslen, var-&gt;variant, uprv_min(varLen, capacity - reslen));</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-removed">-                     reslen += varLen;</span>
<span class="udiff-line-modified-added">+                     sink.Append(var-&gt;variant, varLen);</span>
                      var = var-&gt;next;
                  }
              }
          }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -888,65 +1217,92 @@</span>
              uprv_free(var);
              var = tmpVar;
          }
  
          if (U_FAILURE(*status)) {
<span class="udiff-line-modified-removed">-             return 0;</span>
<span class="udiff-line-modified-added">+             return;</span>
          }
      }
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     u_terminateChars(appendAt, capacity, reslen, status);</span>
<span class="udiff-line-removed">-     return reslen;</span>
  }
  
<span class="udiff-line-modified-removed">- static int32_t</span>
<span class="udiff-line-modified-removed">- _appendKeywordsToLanguageTag(const char* localeID, char* appendAt, int32_t capacity, UBool strict, UBool hadPosix, UErrorCode* status) {</span>
<span class="udiff-line-removed">-     char buf[ULOC_KEYWORD_AND_VALUES_CAPACITY];</span>
<span class="udiff-line-modified-added">+ static void</span>
<span class="udiff-line-modified-added">+ _appendKeywordsToLanguageTag(const char* localeID, icu::ByteSink&amp; sink, UBool strict, UBool hadPosix, UErrorCode* status) {</span>
      char attrBuf[ULOC_KEYWORD_AND_VALUES_CAPACITY] = { 0 };
      int32_t attrBufLength = 0;
<span class="udiff-line-removed">-     UEnumeration *keywordEnum = NULL;</span>
<span class="udiff-line-removed">-     int32_t reslen = 0;</span>
  
<span class="udiff-line-modified-removed">-     keywordEnum = uloc_openKeywords(localeID, status);</span>
<span class="udiff-line-modified-added">+     icu::MemoryPool&lt;AttributeListEntry&gt; attrPool;</span>
<span class="udiff-line-added">+     icu::MemoryPool&lt;ExtensionListEntry&gt; extPool;</span>
<span class="udiff-line-added">+     icu::MemoryPool&lt;icu::CharString&gt; strPool;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     icu::LocalUEnumerationPointer keywordEnum(uloc_openKeywords(localeID, status));</span>
      if (U_FAILURE(*status) &amp;&amp; !hadPosix) {
<span class="udiff-line-modified-removed">-         uenum_close(keywordEnum);</span>
<span class="udiff-line-removed">-         return 0;</span>
<span class="udiff-line-modified-added">+         return;</span>
      }
<span class="udiff-line-modified-removed">-     if (keywordEnum != NULL || hadPosix) {</span>
<span class="udiff-line-modified-added">+     if (keywordEnum.isValid() || hadPosix) {</span>
          /* reorder extensions */
          int32_t len;
          const char *key;
          ExtensionListEntry *firstExt = NULL;
          ExtensionListEntry *ext;
          AttributeListEntry *firstAttr = NULL;
          AttributeListEntry *attr;
<span class="udiff-line-modified-removed">-         char *attrValue;</span>
<span class="udiff-line-removed">-         char extBuf[ULOC_KEYWORD_AND_VALUES_CAPACITY];</span>
<span class="udiff-line-removed">-         char *pExtBuf = extBuf;</span>
<span class="udiff-line-removed">-         int32_t extBufCapacity = sizeof(extBuf);</span>
<span class="udiff-line-modified-added">+         icu::MemoryPool&lt;icu::CharString&gt; extBufPool;</span>
          const char *bcpKey=nullptr, *bcpValue=nullptr;
          UErrorCode tmpStatus = U_ZERO_ERROR;
          int32_t keylen;
          UBool isBcpUExt;
  
          while (TRUE) {
<span class="udiff-line-modified-removed">-             key = uenum_next(keywordEnum, NULL, status);</span>
<span class="udiff-line-modified-added">+             icu::CharString buf;</span>
<span class="udiff-line-added">+             key = uenum_next(keywordEnum.getAlias(), NULL, status);</span>
              if (key == NULL) {
                  break;
              }
<span class="udiff-line-modified-removed">-             len = uloc_getKeywordValue(localeID, key, buf, sizeof(buf), &amp;tmpStatus);</span>
<span class="udiff-line-modified-removed">-             /* buf must be null-terminated */</span>
<span class="udiff-line-modified-removed">-             if (U_FAILURE(tmpStatus) || tmpStatus == U_STRING_NOT_TERMINATED_WARNING) {</span>
<span class="udiff-line-modified-added">+             char* buffer;</span>
<span class="udiff-line-modified-added">+             int32_t resultCapacity = ULOC_KEYWORD_AND_VALUES_CAPACITY;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+             for (;;) {</span>
<span class="udiff-line-added">+                 buffer = buf.getAppendBuffer(</span>
<span class="udiff-line-added">+                         /*minCapacity=*/resultCapacity,</span>
<span class="udiff-line-added">+                         /*desiredCapacityHint=*/resultCapacity,</span>
<span class="udiff-line-added">+                         resultCapacity,</span>
<span class="udiff-line-added">+                         tmpStatus);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                 if (U_FAILURE(tmpStatus)) {</span>
<span class="udiff-line-added">+                     break;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                 len = uloc_getKeywordValue(</span>
<span class="udiff-line-added">+                         localeID, key, buffer, resultCapacity, &amp;tmpStatus);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                 if (tmpStatus != U_BUFFER_OVERFLOW_ERROR) {</span>
<span class="udiff-line-added">+                     break;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                 resultCapacity = len;</span>
<span class="udiff-line-added">+                 tmpStatus = U_ZERO_ERROR;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             if (U_FAILURE(tmpStatus)) {</span>
<span class="udiff-line-added">+                 if (tmpStatus == U_MEMORY_ALLOCATION_ERROR) {</span>
<span class="udiff-line-added">+                     *status = U_MEMORY_ALLOCATION_ERROR;</span>
<span class="udiff-line-added">+                     break;</span>
<span class="udiff-line-added">+                 }</span>
                  if (strict) {
                      *status = U_ILLEGAL_ARGUMENT_ERROR;
                      break;
                  }
                  /* ignore this keyword */
<span class="udiff-line-added">+             buf.append(buffer, len, tmpStatus);</span>
<span class="udiff-line-added">+             if (tmpStatus == U_STRING_NOT_TERMINATED_WARNING) {</span>
<span class="udiff-line-added">+                 tmpStatus = U_ZERO_ERROR;  // Terminators provided by CharString.</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
              keylen = (int32_t)uprv_strlen(key);
              isBcpUExt = (keylen &gt; 1);
  
              /* special keyword used for representing Unicode locale attributes */
              if (uprv_strcmp(key, LOCALE_ATTRIBUTE_KEY) == 0) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -968,26 +1324,27 @@</span>
                          } else if (i &gt;= len){
                              break;
                          }
  
                          /* create AttributeListEntry */
<span class="udiff-line-modified-removed">-                         attr = (AttributeListEntry*)uprv_malloc(sizeof(AttributeListEntry));</span>
<span class="udiff-line-modified-added">+                         attr = attrPool.create();</span>
                          if (attr == NULL) {
                              *status = U_MEMORY_ALLOCATION_ERROR;
                              break;
                          }
<span class="udiff-line-modified-removed">-                         attrValue = (char*)uprv_malloc(attrBufLength + 1);</span>
<span class="udiff-line-modified-added">+                         icu::CharString* attrValue =</span>
<span class="udiff-line-added">+                                 strPool.create(attrBuf, attrBufLength, *status);</span>
                          if (attrValue == NULL) {
                              *status = U_MEMORY_ALLOCATION_ERROR;
                              break;
                          }
<span class="udiff-line-modified-removed">-                         uprv_strcpy(attrValue, attrBuf);</span>
<span class="udiff-line-modified-removed">-                         attr-&gt;attribute = attrValue;</span>
<span class="udiff-line-modified-added">+                         if (U_FAILURE(*status)) {</span>
<span class="udiff-line-modified-added">+                             break;</span>
<span class="udiff-line-added">+                         }</span>
<span class="udiff-line-added">+                         attr-&gt;attribute = attrValue-&gt;data();</span>
  
                          if (!_addAttributeToList(&amp;firstAttr, attr)) {
<span class="udiff-line-removed">-                             uprv_free(attr);</span>
<span class="udiff-line-removed">-                             uprv_free(attrValue);</span>
                              if (strict) {
                                  *status = U_ILLEGAL_ARGUMENT_ERROR;
                                  break;
                              }
                          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1005,314 +1362,254 @@</span>
                      }
                      continue;
                  }
  
                  /* we&#39;ve checked buf is null-terminated above */
<span class="udiff-line-modified-removed">-                 bcpValue = uloc_toUnicodeLocaleType(key, buf);</span>
<span class="udiff-line-modified-added">+                 bcpValue = uloc_toUnicodeLocaleType(key, buf.data());</span>
                  if (bcpValue == NULL) {
                      if (strict) {
                          *status = U_ILLEGAL_ARGUMENT_ERROR;
                          break;
                      }
                      continue;
                  }
<span class="udiff-line-modified-removed">-                 if (bcpValue == buf) {</span>
<span class="udiff-line-modified-added">+                 if (bcpValue == buf.data()) {</span>
                      /*
                      When uloc_toUnicodeLocaleType(key, buf) returns the
                      input value as is, the value is well-formed, but has
                      no known mapping. This implementation normalizes the
<span class="udiff-line-modified-removed">-                     the value to lower case</span>
<span class="udiff-line-modified-added">+                     value to lower case</span>
                      */
<span class="udiff-line-added">+                     icu::CharString* extBuf = extBufPool.create();</span>
<span class="udiff-line-added">+                     if (extBuf == nullptr) {</span>
<span class="udiff-line-added">+                         *status = U_MEMORY_ALLOCATION_ERROR;</span>
<span class="udiff-line-added">+                         break;</span>
<span class="udiff-line-added">+                     }</span>
                      int32_t bcpValueLen = static_cast&lt;int32_t&gt;(uprv_strlen(bcpValue));
<span class="udiff-line-modified-removed">-                     if (bcpValueLen &lt; extBufCapacity) {</span>
<span class="udiff-line-modified-removed">-                         uprv_strcpy(pExtBuf, bcpValue);</span>
<span class="udiff-line-modified-removed">-                         T_CString_toLowerCase(pExtBuf);</span>
<span class="udiff-line-modified-added">+                     int32_t resultCapacity;</span>
<span class="udiff-line-modified-added">+                     char* pExtBuf = extBuf-&gt;getAppendBuffer(</span>
<span class="udiff-line-modified-added">+                             /*minCapacity=*/bcpValueLen,</span>
<span class="udiff-line-added">+                             /*desiredCapacityHint=*/bcpValueLen,</span>
<span class="udiff-line-added">+                             resultCapacity,</span>
<span class="udiff-line-added">+                             tmpStatus);</span>
<span class="udiff-line-added">+                     if (U_FAILURE(tmpStatus)) {</span>
<span class="udiff-line-added">+                         *status = tmpStatus;</span>
<span class="udiff-line-added">+                         break;</span>
<span class="udiff-line-added">+                     }</span>
  
<span class="udiff-line-modified-removed">-                         bcpValue = pExtBuf;</span>
<span class="udiff-line-modified-added">+                     uprv_strcpy(pExtBuf, bcpValue);</span>
<span class="udiff-line-added">+                     T_CString_toLowerCase(pExtBuf);</span>
  
<span class="udiff-line-modified-removed">-                         pExtBuf += (bcpValueLen + 1);</span>
<span class="udiff-line-modified-removed">-                         extBufCapacity -= (bcpValueLen + 1);</span>
<span class="udiff-line-modified-removed">-                     } else {</span>
<span class="udiff-line-modified-removed">-                         if (strict) {</span>
<span class="udiff-line-removed">-                             *status = U_ILLEGAL_ARGUMENT_ERROR;</span>
<span class="udiff-line-removed">-                             break;</span>
<span class="udiff-line-removed">-                         }</span>
<span class="udiff-line-removed">-                         continue;</span>
<span class="udiff-line-modified-added">+                     extBuf-&gt;append(pExtBuf, bcpValueLen, tmpStatus);</span>
<span class="udiff-line-modified-added">+                     if (U_FAILURE(tmpStatus)) {</span>
<span class="udiff-line-modified-added">+                         *status = tmpStatus;</span>
<span class="udiff-line-modified-added">+                         break;</span>
                      }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+                     bcpValue = extBuf-&gt;data();</span>
                  }
              } else {
                  if (*key == PRIVATEUSE) {
<span class="udiff-line-modified-removed">-                     if (!_isPrivateuseValueSubtags(buf, len)) {</span>
<span class="udiff-line-modified-added">+                     if (!ultag_isPrivateuseValueSubtags(buf.data(), len)) {</span>
                          if (strict) {
                              *status = U_ILLEGAL_ARGUMENT_ERROR;
                              break;
                          }
                          continue;
                      }
                  } else {
<span class="udiff-line-modified-removed">-                     if (!_isExtensionSingleton(key, keylen) || !_isExtensionSubtags(buf, len)) {</span>
<span class="udiff-line-modified-added">+                     if (!_isExtensionSingleton(key, keylen) || !ultag_isExtensionSubtags(buf.data(), len)) {</span>
                          if (strict) {
                              *status = U_ILLEGAL_ARGUMENT_ERROR;
                              break;
                          }
                          continue;
                      }
                  }
                  bcpKey = key;
<span class="udiff-line-modified-removed">-                 if ((len + 1) &lt; extBufCapacity) {</span>
<span class="udiff-line-modified-removed">-                     uprv_memcpy(pExtBuf, buf, len);</span>
<span class="udiff-line-modified-removed">-                     bcpValue = pExtBuf;</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-                     pExtBuf += len;</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-                     *pExtBuf = 0;</span>
<span class="udiff-line-modified-removed">-                     pExtBuf++;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-                     extBufCapacity -= (len + 1);</span>
<span class="udiff-line-removed">-                 } else {</span>
<span class="udiff-line-removed">-                     *status = U_ILLEGAL_ARGUMENT_ERROR;</span>
<span class="udiff-line-modified-added">+                 icu::CharString* extBuf =</span>
<span class="udiff-line-modified-added">+                     extBufPool.create(buf.data(), len, tmpStatus);</span>
<span class="udiff-line-modified-added">+                 if (extBuf == nullptr) {</span>
<span class="udiff-line-modified-added">+                     *status = U_MEMORY_ALLOCATION_ERROR;</span>
<span class="udiff-line-modified-added">+                     break;</span>
<span class="udiff-line-modified-added">+                 }</span>
<span class="udiff-line-modified-added">+                 if (U_FAILURE(tmpStatus)) {</span>
<span class="udiff-line-modified-added">+                     *status = tmpStatus;</span>
                      break;
                  }
<span class="udiff-line-added">+                 bcpValue = extBuf-&gt;data();</span>
              }
  
              /* create ExtensionListEntry */
<span class="udiff-line-modified-removed">-             ext = (ExtensionListEntry*)uprv_malloc(sizeof(ExtensionListEntry));</span>
<span class="udiff-line-modified-added">+             ext = extPool.create();</span>
              if (ext == NULL) {
                  *status = U_MEMORY_ALLOCATION_ERROR;
                  break;
              }
              ext-&gt;key = bcpKey;
              ext-&gt;value = bcpValue;
  
              if (!_addExtensionToList(&amp;firstExt, ext, TRUE)) {
<span class="udiff-line-removed">-                 uprv_free(ext);</span>
                  if (strict) {
                      *status = U_ILLEGAL_ARGUMENT_ERROR;
                      break;
                  }
              }
          }
  
          /* Special handling for POSIX variant - add the keywords for POSIX */
          if (hadPosix) {
              /* create ExtensionListEntry for POSIX */
<span class="udiff-line-modified-removed">-             ext = (ExtensionListEntry*)uprv_malloc(sizeof(ExtensionListEntry));</span>
<span class="udiff-line-modified-added">+             ext = extPool.create();</span>
              if (ext == NULL) {
                  *status = U_MEMORY_ALLOCATION_ERROR;
<span class="udiff-line-modified-removed">-                 goto cleanup;</span>
<span class="udiff-line-modified-added">+                 return;</span>
              }
              ext-&gt;key = POSIX_KEY;
              ext-&gt;value = POSIX_VALUE;
  
              if (!_addExtensionToList(&amp;firstExt, ext, TRUE)) {
<span class="udiff-line-modified-removed">-                 uprv_free(ext);</span>
<span class="udiff-line-modified-added">+                 // Silently ignore errors.</span>
              }
          }
  
          if (U_SUCCESS(*status) &amp;&amp; (firstExt != NULL || firstAttr != NULL)) {
              UBool startLDMLExtension = FALSE;
              for (ext = firstExt; ext; ext = ext-&gt;next) {
                  if (!startLDMLExtension &amp;&amp; uprv_strlen(ext-&gt;key) &gt; 1) {
                      /* first LDML u singlton extension */
<span class="udiff-line-modified-removed">-                    if (reslen &lt; capacity) {</span>
<span class="udiff-line-removed">-                        *(appendAt + reslen) = SEP;</span>
<span class="udiff-line-removed">-                    }</span>
<span class="udiff-line-removed">-                    reslen++;</span>
<span class="udiff-line-removed">-                    if (reslen &lt; capacity) {</span>
<span class="udiff-line-removed">-                        *(appendAt + reslen) = LDMLEXT;</span>
<span class="udiff-line-removed">-                    }</span>
<span class="udiff-line-removed">-                    reslen++;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-modified-added">+                    sink.Append(&quot;-u&quot;, 2);</span>
                     startLDMLExtension = TRUE;
                  }
  
                  /* write out the sorted BCP47 attributes, extensions and private use */
                  if (uprv_strcmp(ext-&gt;key, LOCALE_ATTRIBUTE_KEY) == 0) {
                      /* write the value for the attributes */
                      for (attr = firstAttr; attr; attr = attr-&gt;next) {
<span class="udiff-line-modified-removed">-                         if (reslen &lt; capacity) {</span>
<span class="udiff-line-modified-removed">-                             *(appendAt + reslen) = SEP;</span>
<span class="udiff-line-modified-removed">-                         }</span>
<span class="udiff-line-removed">-                         reslen++;</span>
<span class="udiff-line-removed">-                         len = (int32_t)uprv_strlen(attr-&gt;attribute);</span>
<span class="udiff-line-removed">-                         if (reslen &lt; capacity) {</span>
<span class="udiff-line-removed">-                             uprv_memcpy(appendAt + reslen, attr-&gt;attribute, uprv_min(len, capacity - reslen));</span>
<span class="udiff-line-removed">-                         }</span>
<span class="udiff-line-removed">-                         reslen += len;</span>
<span class="udiff-line-modified-added">+                         sink.Append(&quot;-&quot;, 1);</span>
<span class="udiff-line-modified-added">+                         sink.Append(</span>
<span class="udiff-line-modified-added">+                                 attr-&gt;attribute, static_cast&lt;int32_t&gt;(uprv_strlen(attr-&gt;attribute)));</span>
                      }
                  } else {
<span class="udiff-line-modified-removed">-                     if (reslen &lt; capacity) {</span>
<span class="udiff-line-modified-removed">-                         *(appendAt + reslen) = SEP;</span>
<span class="udiff-line-modified-removed">-                     }</span>
<span class="udiff-line-modified-removed">-                     reslen++;</span>
<span class="udiff-line-removed">-                     len = (int32_t)uprv_strlen(ext-&gt;key);</span>
<span class="udiff-line-removed">-                     if (reslen &lt; capacity) {</span>
<span class="udiff-line-removed">-                         uprv_memcpy(appendAt + reslen, ext-&gt;key, uprv_min(len, capacity - reslen));</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-removed">-                     reslen += len;</span>
<span class="udiff-line-removed">-                     if (reslen &lt; capacity) {</span>
<span class="udiff-line-removed">-                         *(appendAt + reslen) = SEP;</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-removed">-                     reslen++;</span>
<span class="udiff-line-removed">-                     len = (int32_t)uprv_strlen(ext-&gt;value);</span>
<span class="udiff-line-removed">-                     if (reslen &lt; capacity) {</span>
<span class="udiff-line-removed">-                         uprv_memcpy(appendAt + reslen, ext-&gt;value, uprv_min(len, capacity - reslen));</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-removed">-                     reslen += len;</span>
<span class="udiff-line-modified-added">+                     sink.Append(&quot;-&quot;, 1);</span>
<span class="udiff-line-modified-added">+                     sink.Append(ext-&gt;key, static_cast&lt;int32_t&gt;(uprv_strlen(ext-&gt;key)));</span>
<span class="udiff-line-modified-added">+                     sink.Append(&quot;-&quot;, 1);</span>
<span class="udiff-line-modified-added">+                     sink.Append(ext-&gt;value, static_cast&lt;int32_t&gt;(uprv_strlen(ext-&gt;value)));</span>
                  }
              }
          }
<span class="udiff-line-removed">- cleanup:</span>
<span class="udiff-line-removed">-         /* clean up */</span>
<span class="udiff-line-removed">-         ext = firstExt;</span>
<span class="udiff-line-removed">-         while (ext != NULL) {</span>
<span class="udiff-line-removed">-             ExtensionListEntry *tmpExt = ext-&gt;next;</span>
<span class="udiff-line-removed">-             uprv_free(ext);</span>
<span class="udiff-line-removed">-             ext = tmpExt;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         attr = firstAttr;</span>
<span class="udiff-line-removed">-         while (attr != NULL) {</span>
<span class="udiff-line-removed">-             AttributeListEntry *tmpAttr = attr-&gt;next;</span>
<span class="udiff-line-removed">-             char *pValue = (char *)attr-&gt;attribute;</span>
<span class="udiff-line-removed">-             uprv_free(pValue);</span>
<span class="udiff-line-removed">-             uprv_free(attr);</span>
<span class="udiff-line-removed">-             attr = tmpAttr;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         uenum_close(keywordEnum);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         if (U_FAILURE(*status)) {</span>
<span class="udiff-line-removed">-             return 0;</span>
<span class="udiff-line-removed">-         }</span>
      }
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     return u_terminateChars(appendAt, capacity, reslen, status);</span>
  }
  
  /**
   * Append keywords parsed from LDML extension value
   * e.g. &quot;u-ca-gregory-co-trad&quot; -&gt; {calendar = gregorian} {collation = traditional}
   * Note: char* buf is used for storing keywords
   */
  static void
<span class="udiff-line-modified-removed">- _appendLDMLExtensionAsKeywords(const char* ldmlext, ExtensionListEntry** appendTo, char* buf, int32_t bufSize, UBool *posixVariant, UErrorCode *status) {</span>
<span class="udiff-line-modified-added">+ _appendLDMLExtensionAsKeywords(const char* ldmlext, ExtensionListEntry** appendTo, icu::MemoryPool&lt;ExtensionListEntry&gt;&amp; extPool, icu::MemoryPool&lt;icu::CharString&gt;&amp; kwdBuf, UBool *posixVariant, UErrorCode *status) {</span>
      const char *pTag;   /* beginning of current subtag */
      const char *pKwds;  /* beginning of key-type pairs */
      UBool variantExists = *posixVariant;
  
      ExtensionListEntry *kwdFirst = NULL;    /* first LDML keyword */
      ExtensionListEntry *kwd, *nextKwd;
  
<span class="udiff-line-removed">-     AttributeListEntry *attrFirst = NULL;   /* first attribute */</span>
<span class="udiff-line-removed">-     AttributeListEntry *attr, *nextAttr;</span>
<span class="udiff-line-removed">- </span>
      int32_t len;
<span class="udiff-line-removed">-     int32_t bufIdx = 0;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     char attrBuf[ULOC_KEYWORD_AND_VALUES_CAPACITY];</span>
<span class="udiff-line-removed">-     int32_t attrBufIdx = 0;</span>
  
      /* Reset the posixVariant value */
      *posixVariant = FALSE;
  
      pTag = ldmlext;
      pKwds = NULL;
  
<span class="udiff-line-modified-removed">-     /* Iterate through u extension attributes */</span>
<span class="udiff-line-modified-removed">-     while (*pTag) {</span>
<span class="udiff-line-modified-removed">-         /* locate next separator char */</span>
<span class="udiff-line-removed">-         for (len = 0; *(pTag + len) &amp;&amp; *(pTag + len) != SEP; len++);</span>
<span class="udiff-line-modified-added">+     {</span>
<span class="udiff-line-modified-added">+         AttributeListEntry *attrFirst = NULL;   /* first attribute */</span>
<span class="udiff-line-modified-added">+         AttributeListEntry *attr, *nextAttr;</span>
  
<span class="udiff-line-modified-removed">-         if (ultag_isUnicodeLocaleKey(pTag, len)) {</span>
<span class="udiff-line-modified-removed">-             pKwds = pTag;</span>
<span class="udiff-line-removed">-             break;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+         char attrBuf[ULOC_KEYWORD_AND_VALUES_CAPACITY];</span>
<span class="udiff-line-modified-added">+         int32_t attrBufIdx = 0;</span>
  
<span class="udiff-line-modified-removed">-         /* add this attribute to the list */</span>
<span class="udiff-line-removed">-         attr = (AttributeListEntry*)uprv_malloc(sizeof(AttributeListEntry));</span>
<span class="udiff-line-removed">-         if (attr == NULL) {</span>
<span class="udiff-line-removed">-             *status = U_MEMORY_ALLOCATION_ERROR;</span>
<span class="udiff-line-removed">-             goto cleanup;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+         icu::MemoryPool&lt;AttributeListEntry&gt; attrPool;</span>
  
<span class="udiff-line-modified-removed">-         if (len &lt; (int32_t)sizeof(attrBuf) - attrBufIdx) {</span>
<span class="udiff-line-modified-removed">-             uprv_memcpy(&amp;attrBuf[attrBufIdx], pTag, len);</span>
<span class="udiff-line-modified-removed">-             attrBuf[attrBufIdx + len] = 0;</span>
<span class="udiff-line-modified-removed">-             attr-&gt;attribute = &amp;attrBuf[attrBufIdx];</span>
<span class="udiff-line-removed">-             attrBufIdx += (len + 1);</span>
<span class="udiff-line-removed">-         } else {</span>
<span class="udiff-line-removed">-             *status = U_ILLEGAL_ARGUMENT_ERROR;</span>
<span class="udiff-line-removed">-             goto cleanup;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+         /* Iterate through u extension attributes */</span>
<span class="udiff-line-modified-added">+         while (*pTag) {</span>
<span class="udiff-line-modified-added">+             /* locate next separator char */</span>
<span class="udiff-line-modified-added">+             for (len = 0; *(pTag + len) &amp;&amp; *(pTag + len) != SEP; len++);</span>
  
<span class="udiff-line-modified-removed">-         if (!_addAttributeToList(&amp;attrFirst, attr)) {</span>
<span class="udiff-line-modified-removed">-             *status = U_ILLEGAL_ARGUMENT_ERROR;</span>
<span class="udiff-line-modified-removed">-             uprv_free(attr);</span>
<span class="udiff-line-modified-removed">-             goto cleanup;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+             if (ultag_isUnicodeLocaleKey(pTag, len)) {</span>
<span class="udiff-line-modified-added">+                 pKwds = pTag;</span>
<span class="udiff-line-modified-added">+                 break;</span>
<span class="udiff-line-modified-added">+             }</span>
  
<span class="udiff-line-modified-removed">-         /* next tag */</span>
<span class="udiff-line-modified-removed">-         pTag += len;</span>
<span class="udiff-line-modified-removed">-         if (*pTag) {</span>
<span class="udiff-line-modified-removed">-             /* next to the separator */</span>
<span class="udiff-line-modified-removed">-             pTag++;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-modified-added">+             /* add this attribute to the list */</span>
<span class="udiff-line-modified-added">+             attr = attrPool.create();</span>
<span class="udiff-line-modified-added">+             if (attr == NULL) {</span>
<span class="udiff-line-modified-added">+                 *status = U_MEMORY_ALLOCATION_ERROR;</span>
<span class="udiff-line-modified-added">+                 return;</span>
<span class="udiff-line-modified-added">+             }</span>
  
<span class="udiff-line-modified-removed">-     if (attrFirst) {</span>
<span class="udiff-line-modified-removed">-         /* emit attributes as an LDML keyword, e.g. attribute=attr1-attr2 */</span>
<span class="udiff-line-modified-added">+             if (len &lt; (int32_t)sizeof(attrBuf) - attrBufIdx) {</span>
<span class="udiff-line-modified-added">+                 uprv_memcpy(&amp;attrBuf[attrBufIdx], pTag, len);</span>
<span class="udiff-line-added">+                 attrBuf[attrBufIdx + len] = 0;</span>
<span class="udiff-line-added">+                 attr-&gt;attribute = &amp;attrBuf[attrBufIdx];</span>
<span class="udiff-line-added">+                 attrBufIdx += (len + 1);</span>
<span class="udiff-line-added">+             } else {</span>
<span class="udiff-line-added">+                 *status = U_ILLEGAL_ARGUMENT_ERROR;</span>
<span class="udiff-line-added">+                 return;</span>
<span class="udiff-line-added">+             }</span>
  
<span class="udiff-line-modified-removed">-         if (attrBufIdx &gt; bufSize) {</span>
<span class="udiff-line-modified-removed">-             /* attrBufIdx == &lt;total length of attribute subtag&gt; + 1 */</span>
<span class="udiff-line-modified-removed">-             *status = U_ILLEGAL_ARGUMENT_ERROR;</span>
<span class="udiff-line-modified-removed">-             goto cleanup;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+             if (!_addAttributeToList(&amp;attrFirst, attr)) {</span>
<span class="udiff-line-modified-added">+                 *status = U_ILLEGAL_ARGUMENT_ERROR;</span>
<span class="udiff-line-modified-added">+                 return;</span>
<span class="udiff-line-modified-added">+             }</span>
  
<span class="udiff-line-modified-removed">-         kwd = (ExtensionListEntry*)uprv_malloc(sizeof(ExtensionListEntry));</span>
<span class="udiff-line-modified-removed">-         if (kwd == NULL) {</span>
<span class="udiff-line-modified-removed">-             *status = U_MEMORY_ALLOCATION_ERROR;</span>
<span class="udiff-line-modified-removed">-             goto cleanup;</span>
<span class="udiff-line-modified-added">+             /* next tag */</span>
<span class="udiff-line-modified-added">+             pTag += len;</span>
<span class="udiff-line-modified-added">+             if (*pTag) {</span>
<span class="udiff-line-modified-added">+                 /* next to the separator */</span>
<span class="udiff-line-added">+                 pTag++;</span>
<span class="udiff-line-added">+             }</span>
          }
  
<span class="udiff-line-modified-removed">-         kwd-&gt;key = LOCALE_ATTRIBUTE_KEY;</span>
<span class="udiff-line-modified-removed">-         kwd-&gt;value = buf;</span>
<span class="udiff-line-modified-added">+         if (attrFirst) {</span>
<span class="udiff-line-modified-added">+             /* emit attributes as an LDML keyword, e.g. attribute=attr1-attr2 */</span>
  
<span class="udiff-line-modified-removed">-         /* attribute subtags sorted in alphabetical order as type */</span>
<span class="udiff-line-modified-removed">-         attr = attrFirst;</span>
<span class="udiff-line-modified-removed">-         while (attr != NULL) {</span>
<span class="udiff-line-modified-removed">-             nextAttr = attr-&gt;next;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             /* buffer size check is done above */</span>
<span class="udiff-line-removed">-             if (attr != attrFirst) {</span>
<span class="udiff-line-removed">-                 *(buf + bufIdx) = SEP;</span>
<span class="udiff-line-removed">-                 bufIdx++;</span>
<span class="udiff-line-modified-added">+             kwd = extPool.create();</span>
<span class="udiff-line-modified-added">+             if (kwd == NULL) {</span>
<span class="udiff-line-modified-added">+                 *status = U_MEMORY_ALLOCATION_ERROR;</span>
<span class="udiff-line-modified-added">+                 return;</span>
              }
  
<span class="udiff-line-modified-removed">-             len = static_cast&lt;int32_t&gt;(uprv_strlen(attr-&gt;attribute));</span>
<span class="udiff-line-modified-removed">-             uprv_memcpy(buf + bufIdx, attr-&gt;attribute, len);</span>
<span class="udiff-line-modified-removed">-             bufIdx += len;</span>
<span class="udiff-line-modified-added">+             icu::CharString* value = kwdBuf.create();</span>
<span class="udiff-line-modified-added">+             if (value == NULL) {</span>
<span class="udiff-line-modified-added">+                 *status = U_MEMORY_ALLOCATION_ERROR;</span>
<span class="udiff-line-added">+                 return;</span>
<span class="udiff-line-added">+             }</span>
  
<span class="udiff-line-modified-removed">-             attr = nextAttr;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         *(buf + bufIdx) = 0;</span>
<span class="udiff-line-modified-removed">-         bufIdx++;</span>
<span class="udiff-line-modified-added">+             /* attribute subtags sorted in alphabetical order as type */</span>
<span class="udiff-line-modified-added">+             attr = attrFirst;</span>
<span class="udiff-line-modified-added">+             while (attr != NULL) {</span>
<span class="udiff-line-modified-added">+                 nextAttr = attr-&gt;next;</span>
<span class="udiff-line-added">+                 if (attr != attrFirst) {</span>
<span class="udiff-line-added">+                     value-&gt;append(&#39;-&#39;, *status);</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+                 value-&gt;append(attr-&gt;attribute, *status);</span>
<span class="udiff-line-added">+                 attr = nextAttr;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             if (U_FAILURE(*status)) {</span>
<span class="udiff-line-added">+                 return;</span>
<span class="udiff-line-added">+             }</span>
  
<span class="udiff-line-modified-removed">-         if (!_addExtensionToList(&amp;kwdFirst, kwd, FALSE)) {</span>
<span class="udiff-line-modified-removed">-             *status = U_ILLEGAL_ARGUMENT_ERROR;</span>
<span class="udiff-line-removed">-             uprv_free(kwd);</span>
<span class="udiff-line-removed">-             goto cleanup;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+             kwd-&gt;key = LOCALE_ATTRIBUTE_KEY;</span>
<span class="udiff-line-modified-added">+             kwd-&gt;value = value-&gt;data();</span>
  
<span class="udiff-line-modified-removed">-         /* once keyword entry is created, delete the attribute list */</span>
<span class="udiff-line-modified-removed">-         attr = attrFirst;</span>
<span class="udiff-line-modified-removed">-         while (attr != NULL) {</span>
<span class="udiff-line-modified-removed">-             nextAttr = attr-&gt;next;</span>
<span class="udiff-line-removed">-             uprv_free(attr);</span>
<span class="udiff-line-removed">-             attr = nextAttr;</span>
<span class="udiff-line-modified-added">+             if (!_addExtensionToList(&amp;kwdFirst, kwd, FALSE)) {</span>
<span class="udiff-line-modified-added">+                 *status = U_ILLEGAL_ARGUMENT_ERROR;</span>
<span class="udiff-line-modified-added">+                 return;</span>
<span class="udiff-line-modified-added">+             }</span>
          }
<span class="udiff-line-removed">-         attrFirst = NULL;</span>
      }
  
      if (pKwds) {
          const char *pBcpKey = NULL;     /* u extenstion key subtag */
          const char *pBcpType = NULL;    /* beginning of u extension type subtag(s) */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1372,74 +1669,72 @@</span>
                  U_ASSERT(pBcpKey != NULL);
  
                  if (bcpKeyLen &gt;= (int32_t)sizeof(bcpKeyBuf)) {
                      /* the BCP key is invalid */
                      *status = U_ILLEGAL_ARGUMENT_ERROR;
<span class="udiff-line-modified-removed">-                     goto cleanup;</span>
<span class="udiff-line-modified-added">+                     return;</span>
                  }
  
                  uprv_strncpy(bcpKeyBuf, pBcpKey, bcpKeyLen);
                  bcpKeyBuf[bcpKeyLen] = 0;
  
                  /* u extension key to LDML key */
                  pKey = uloc_toLegacyKey(bcpKeyBuf);
                  if (pKey == NULL) {
                      *status = U_ILLEGAL_ARGUMENT_ERROR;
<span class="udiff-line-modified-removed">-                     goto cleanup;</span>
<span class="udiff-line-modified-added">+                     return;</span>
                  }
                  if (pKey == bcpKeyBuf) {
                      /*
                      The key returned by toLegacyKey points to the input buffer.
                      We normalize the result key to lower case.
                      */
                      T_CString_toLowerCase(bcpKeyBuf);
<span class="udiff-line-modified-removed">-                     if (bufSize - bufIdx - 1 &gt;= bcpKeyLen) {</span>
<span class="udiff-line-modified-removed">-                         uprv_memcpy(buf + bufIdx, bcpKeyBuf, bcpKeyLen);</span>
<span class="udiff-line-modified-removed">-                         pKey = buf + bufIdx;</span>
<span class="udiff-line-modified-removed">-                         bufIdx += bcpKeyLen;</span>
<span class="udiff-line-modified-removed">-                         *(buf + bufIdx) = 0;</span>
<span class="udiff-line-modified-removed">-                         bufIdx++;</span>
<span class="udiff-line-modified-removed">-                     } else {</span>
<span class="udiff-line-removed">-                         *status = U_BUFFER_OVERFLOW_ERROR;</span>
<span class="udiff-line-removed">-                         goto cleanup;</span>
<span class="udiff-line-modified-added">+                     icu::CharString* key = kwdBuf.create(bcpKeyBuf, bcpKeyLen, *status);</span>
<span class="udiff-line-modified-added">+                     if (key == NULL) {</span>
<span class="udiff-line-modified-added">+                         *status = U_MEMORY_ALLOCATION_ERROR;</span>
<span class="udiff-line-modified-added">+                         return;</span>
<span class="udiff-line-modified-added">+                     }</span>
<span class="udiff-line-modified-added">+                     if (U_FAILURE(*status)) {</span>
<span class="udiff-line-modified-added">+                         return;</span>
                      }
<span class="udiff-line-added">+                     pKey = key-&gt;data();</span>
                  }
  
                  if (pBcpType) {
                      char bcpTypeBuf[128];       /* practically long enough even considering multiple subtag type */
                      if (bcpTypeLen &gt;= (int32_t)sizeof(bcpTypeBuf)) {
                          /* the BCP type is too long */
                          *status = U_ILLEGAL_ARGUMENT_ERROR;
<span class="udiff-line-modified-removed">-                         goto cleanup;</span>
<span class="udiff-line-modified-added">+                         return;</span>
                      }
  
                      uprv_strncpy(bcpTypeBuf, pBcpType, bcpTypeLen);
                      bcpTypeBuf[bcpTypeLen] = 0;
  
                      /* BCP type to locale type */
                      pType = uloc_toLegacyType(pKey, bcpTypeBuf);
                      if (pType == NULL) {
                          *status = U_ILLEGAL_ARGUMENT_ERROR;
<span class="udiff-line-modified-removed">-                         goto cleanup;</span>
<span class="udiff-line-modified-added">+                         return;</span>
                      }
                      if (pType == bcpTypeBuf) {
                          /*
                          The type returned by toLegacyType points to the input buffer.
                          We normalize the result type to lower case.
                          */
                          /* normalize to lower case */
                          T_CString_toLowerCase(bcpTypeBuf);
<span class="udiff-line-modified-removed">-                         if (bufSize - bufIdx - 1 &gt;= bcpTypeLen) {</span>
<span class="udiff-line-modified-removed">-                             uprv_memcpy(buf + bufIdx, bcpTypeBuf, bcpTypeLen);</span>
<span class="udiff-line-modified-removed">-                             pType = buf + bufIdx;</span>
<span class="udiff-line-modified-removed">-                             bufIdx += bcpTypeLen;</span>
<span class="udiff-line-removed">-                             *(buf + bufIdx) = 0;</span>
<span class="udiff-line-removed">-                             bufIdx++;</span>
<span class="udiff-line-removed">-                         } else {</span>
<span class="udiff-line-removed">-                             *status = U_BUFFER_OVERFLOW_ERROR;</span>
<span class="udiff-line-removed">-                             goto cleanup;</span>
<span class="udiff-line-modified-added">+                         icu::CharString* type = kwdBuf.create(bcpTypeBuf, bcpTypeLen, *status);</span>
<span class="udiff-line-modified-added">+                         if (type == NULL) {</span>
<span class="udiff-line-modified-added">+                             *status = U_MEMORY_ALLOCATION_ERROR;</span>
<span class="udiff-line-modified-added">+                             return;</span>
                          }
<span class="udiff-line-added">+                         if (U_FAILURE(*status)) {</span>
<span class="udiff-line-added">+                             return;</span>
<span class="udiff-line-added">+                         }</span>
<span class="udiff-line-added">+                         pType = type-&gt;data();</span>
                      }
                  } else {
                      /* typeless - default type value is &quot;yes&quot; */
                      pType = LOCALE_TYPE_YES;
                  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1448,23 +1743,22 @@</span>
                     not as a keyword */
                  if (!variantExists &amp;&amp; !uprv_strcmp(pKey, POSIX_KEY) &amp;&amp; !uprv_strcmp(pType, POSIX_VALUE) ) {
                      *posixVariant = TRUE;
                  } else {
                      /* create an ExtensionListEntry for this keyword */
<span class="udiff-line-modified-removed">-                     kwd = (ExtensionListEntry*)uprv_malloc(sizeof(ExtensionListEntry));</span>
<span class="udiff-line-modified-added">+                     kwd = extPool.create();</span>
                      if (kwd == NULL) {
                          *status = U_MEMORY_ALLOCATION_ERROR;
<span class="udiff-line-modified-removed">-                         goto cleanup;</span>
<span class="udiff-line-modified-added">+                         return;</span>
                      }
  
                      kwd-&gt;key = pKey;
                      kwd-&gt;value = pType;
  
                      if (!_addExtensionToList(&amp;kwdFirst, kwd, FALSE)) {
<span class="udiff-line-modified-removed">-                         *status = U_ILLEGAL_ARGUMENT_ERROR;</span>
<span class="udiff-line-modified-removed">-                         uprv_free(kwd);</span>
<span class="udiff-line-removed">-                         goto cleanup;</span>
<span class="udiff-line-modified-added">+                         // duplicate keyword is allowed, Only the first</span>
<span class="udiff-line-modified-added">+                         // is honored.</span>
                      }
                  }
  
                  pBcpKey = pNextBcpKey;
                  bcpKeyLen = pNextBcpKey != NULL ? nextBcpKeyLen : 0;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1478,50 +1772,26 @@</span>
      while (kwd != NULL) {
          nextKwd = kwd-&gt;next;
          _addExtensionToList(appendTo, kwd, FALSE);
          kwd = nextKwd;
      }
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     return;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- cleanup:</span>
<span class="udiff-line-removed">-     attr = attrFirst;</span>
<span class="udiff-line-removed">-     while (attr != NULL) {</span>
<span class="udiff-line-removed">-         nextAttr = attr-&gt;next;</span>
<span class="udiff-line-removed">-         uprv_free(attr);</span>
<span class="udiff-line-removed">-         attr = nextAttr;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     kwd = kwdFirst;</span>
<span class="udiff-line-removed">-     while (kwd != NULL) {</span>
<span class="udiff-line-removed">-         nextKwd = kwd-&gt;next;</span>
<span class="udiff-line-removed">-         uprv_free(kwd);</span>
<span class="udiff-line-removed">-         kwd = nextKwd;</span>
<span class="udiff-line-removed">-     }</span>
  }
  
  
<span class="udiff-line-modified-removed">- static int32_t</span>
<span class="udiff-line-modified-removed">- _appendKeywords(ULanguageTag* langtag, char* appendAt, int32_t capacity, UErrorCode* status) {</span>
<span class="udiff-line-removed">-     int32_t reslen = 0;</span>
<span class="udiff-line-modified-added">+ static void</span>
<span class="udiff-line-modified-added">+ _appendKeywords(ULanguageTag* langtag, icu::ByteSink&amp; sink, UErrorCode* status) {</span>
      int32_t i, n;
      int32_t len;
      ExtensionListEntry *kwdFirst = NULL;
      ExtensionListEntry *kwd;
      const char *key, *type;
<span class="udiff-line-modified-removed">-     char *kwdBuf = NULL;</span>
<span class="udiff-line-modified-removed">-     int32_t kwdBufLength = capacity;</span>
<span class="udiff-line-modified-added">+     icu::MemoryPool&lt;ExtensionListEntry&gt; extPool;</span>
<span class="udiff-line-modified-added">+     icu::MemoryPool&lt;icu::CharString&gt; kwdBuf;</span>
      UBool posixVariant = FALSE;
  
      if (U_FAILURE(*status)) {
<span class="udiff-line-modified-removed">-         return 0;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     kwdBuf = (char*)uprv_malloc(kwdBufLength);</span>
<span class="udiff-line-removed">-     if (kwdBuf == NULL) {</span>
<span class="udiff-line-removed">-         *status = U_MEMORY_ALLOCATION_ERROR;</span>
<span class="udiff-line-removed">-         return 0;</span>
<span class="udiff-line-modified-added">+         return;</span>
      }
  
      /* Determine if variants already exists */
      if (ultag_getVariantsSize(langtag)) {
          posixVariant = TRUE;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1532,135 +1802,99 @@</span>
      /* resolve locale keywords and reordering keys */
      for (i = 0; i &lt; n; i++) {
          key = ultag_getExtensionKey(langtag, i);
          type = ultag_getExtensionValue(langtag, i);
          if (*key == LDMLEXT) {
<span class="udiff-line-modified-removed">-             _appendLDMLExtensionAsKeywords(type, &amp;kwdFirst, kwdBuf, kwdBufLength, &amp;posixVariant, status);</span>
<span class="udiff-line-modified-added">+             _appendLDMLExtensionAsKeywords(type, &amp;kwdFirst, extPool, kwdBuf, &amp;posixVariant, status);</span>
              if (U_FAILURE(*status)) {
                  break;
              }
          } else {
<span class="udiff-line-modified-removed">-             kwd = (ExtensionListEntry*)uprv_malloc(sizeof(ExtensionListEntry));</span>
<span class="udiff-line-modified-added">+             kwd = extPool.create();</span>
              if (kwd == NULL) {
                  *status = U_MEMORY_ALLOCATION_ERROR;
                  break;
              }
              kwd-&gt;key = key;
              kwd-&gt;value = type;
              if (!_addExtensionToList(&amp;kwdFirst, kwd, FALSE)) {
<span class="udiff-line-removed">-                 uprv_free(kwd);</span>
                  *status = U_ILLEGAL_ARGUMENT_ERROR;
                  break;
              }
          }
      }
  
      if (U_SUCCESS(*status)) {
          type = ultag_getPrivateUse(langtag);
          if ((int32_t)uprv_strlen(type) &gt; 0) {
              /* add private use as a keyword */
<span class="udiff-line-modified-removed">-             kwd = (ExtensionListEntry*)uprv_malloc(sizeof(ExtensionListEntry));</span>
<span class="udiff-line-modified-added">+             kwd = extPool.create();</span>
              if (kwd == NULL) {
                  *status = U_MEMORY_ALLOCATION_ERROR;
              } else {
                  kwd-&gt;key = PRIVATEUSE_KEY;
                  kwd-&gt;value = type;
                  if (!_addExtensionToList(&amp;kwdFirst, kwd, FALSE)) {
<span class="udiff-line-removed">-                     uprv_free(kwd);</span>
                      *status = U_ILLEGAL_ARGUMENT_ERROR;
                  }
              }
          }
      }
  
      /* If a POSIX variant was in the extensions, write it out before writing the keywords. */
  
      if (U_SUCCESS(*status) &amp;&amp; posixVariant) {
          len = (int32_t) uprv_strlen(_POSIX);
<span class="udiff-line-modified-removed">-         if (reslen &lt; capacity) {</span>
<span class="udiff-line-removed">-             uprv_memcpy(appendAt + reslen, _POSIX, uprv_min(len, capacity - reslen));</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         reslen += len;</span>
<span class="udiff-line-modified-added">+         sink.Append(_POSIX, len);</span>
      }
  
      if (U_SUCCESS(*status) &amp;&amp; kwdFirst != NULL) {
          /* write out the sorted keywords */
          UBool firstValue = TRUE;
          kwd = kwdFirst;
          do {
<span class="udiff-line-modified-removed">-             if (reslen &lt; capacity) {</span>
<span class="udiff-line-modified-removed">-                 if (firstValue) {</span>
<span class="udiff-line-modified-removed">-                     /* &#39;@&#39; */</span>
<span class="udiff-line-modified-removed">-                     *(appendAt + reslen) = LOCALE_EXT_SEP;</span>
<span class="udiff-line-modified-removed">-                     firstValue = FALSE;</span>
<span class="udiff-line-removed">-                 } else {</span>
<span class="udiff-line-removed">-                     /* &#39;;&#39; */</span>
<span class="udiff-line-removed">-                     *(appendAt + reslen) = LOCALE_KEYWORD_SEP;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-modified-added">+             if (firstValue) {</span>
<span class="udiff-line-modified-added">+                 sink.Append(&quot;@&quot;, 1);</span>
<span class="udiff-line-modified-added">+                 firstValue = FALSE;</span>
<span class="udiff-line-modified-added">+             } else {</span>
<span class="udiff-line-modified-added">+                 sink.Append(&quot;;&quot;, 1);</span>
              }
<span class="udiff-line-removed">-             reslen++;</span>
  
              /* key */
              len = (int32_t)uprv_strlen(kwd-&gt;key);
<span class="udiff-line-modified-removed">-             if (reslen &lt; capacity) {</span>
<span class="udiff-line-modified-removed">-                 uprv_memcpy(appendAt + reslen, kwd-&gt;key, uprv_min(len, capacity - reslen));</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             reslen += len;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-             /* &#39;=&#39; */</span>
<span class="udiff-line-removed">-             if (reslen &lt; capacity) {</span>
<span class="udiff-line-removed">-                 *(appendAt + reslen) = LOCALE_KEY_TYPE_SEP;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             reslen++;</span>
<span class="udiff-line-modified-added">+             sink.Append(kwd-&gt;key, len);</span>
<span class="udiff-line-modified-added">+             sink.Append(&quot;=&quot;, 1);</span>
  
              /* type */
              len = (int32_t)uprv_strlen(kwd-&gt;value);
<span class="udiff-line-modified-removed">-             if (reslen &lt; capacity) {</span>
<span class="udiff-line-removed">-                 uprv_memcpy(appendAt + reslen, kwd-&gt;value, uprv_min(len, capacity - reslen));</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             reslen += len;</span>
<span class="udiff-line-modified-added">+             sink.Append(kwd-&gt;value, len);</span>
  
              kwd = kwd-&gt;next;
          } while (kwd);
      }
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     /* clean up */</span>
<span class="udiff-line-removed">-     kwd = kwdFirst;</span>
<span class="udiff-line-removed">-     while (kwd != NULL) {</span>
<span class="udiff-line-removed">-         ExtensionListEntry *tmpKwd = kwd-&gt;next;</span>
<span class="udiff-line-removed">-         uprv_free(kwd);</span>
<span class="udiff-line-removed">-         kwd = tmpKwd;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     uprv_free(kwdBuf);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (U_FAILURE(*status)) {</span>
<span class="udiff-line-removed">-         return 0;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     return u_terminateChars(appendAt, capacity, reslen, status);</span>
  }
  
<span class="udiff-line-modified-removed">- static int32_t</span>
<span class="udiff-line-modified-removed">- _appendPrivateuseToLanguageTag(const char* localeID, char* appendAt, int32_t capacity, UBool strict, UBool hadPosix, UErrorCode* status) {</span>
<span class="udiff-line-modified-added">+ static void</span>
<span class="udiff-line-modified-added">+ _appendPrivateuseToLanguageTag(const char* localeID, icu::ByteSink&amp; sink, UBool strict, UBool hadPosix, UErrorCode* status) {</span>
      (void)hadPosix;
      char buf[ULOC_FULLNAME_CAPACITY];
      char tmpAppend[ULOC_FULLNAME_CAPACITY];
      UErrorCode tmpStatus = U_ZERO_ERROR;
      int32_t len, i;
      int32_t reslen = 0;
<span class="udiff-line-added">+     int32_t capacity = sizeof tmpAppend;</span>
  
      if (U_FAILURE(*status)) {
<span class="udiff-line-modified-removed">-         return 0;</span>
<span class="udiff-line-modified-added">+         return;</span>
      }
  
      len = uloc_getVariant(localeID, buf, sizeof(buf), &amp;tmpStatus);
      if (U_FAILURE(tmpStatus) || tmpStatus == U_STRING_NOT_TERMINATED_WARNING) {
          if (strict) {
              *status = U_ILLEGAL_ARGUMENT_ERROR;
          }
<span class="udiff-line-modified-removed">-         return 0;</span>
<span class="udiff-line-modified-added">+         return;</span>
      }
  
      if (len &gt; 0) {
          char *p, *pPriv;
          UBool bNext = TRUE;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1740,24 +1974,18 @@</span>
              }
              p++;
          }
  
          if (U_FAILURE(*status)) {
<span class="udiff-line-modified-removed">-             return 0;</span>
<span class="udiff-line-modified-added">+             return;</span>
          }
      }
  
      if (U_SUCCESS(*status)) {
          len = reslen;
<span class="udiff-line-modified-removed">-         if (reslen &lt; capacity) {</span>
<span class="udiff-line-removed">-             uprv_memcpy(appendAt, tmpAppend, uprv_min(len, capacity - reslen));</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+         sink.Append(tmpAppend, len);</span>
      }
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     u_terminateChars(appendAt, capacity, reslen, status);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     return reslen;</span>
  }
  
  /*
  * -------------------------------------------------
  *
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1785,11 +2013,10 @@</span>
  #pragma optimize( &quot;&quot;, off )
  #endif
  
  static ULanguageTag*
  ultag_parse(const char* tag, int32_t tagLen, int32_t* parsedLen, UErrorCode* status) {
<span class="udiff-line-removed">-     ULanguageTag *t;</span>
      char *tagBuf;
      int16_t next;
      char *pSubtag, *pNext, *pLastGoodPosition;
      int32_t subtagLen;
      int32_t extlangIdx;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1819,47 +2046,94 @@</span>
      }
      uprv_memcpy(tagBuf, tag, tagLen);
      *(tagBuf + tagLen) = 0;
  
      /* create a ULanguageTag */
<span class="udiff-line-modified-removed">-     t = (ULanguageTag*)uprv_malloc(sizeof(ULanguageTag));</span>
<span class="udiff-line-modified-removed">-     if (t == NULL) {</span>
<span class="udiff-line-modified-added">+     icu::LocalULanguageTagPointer t(</span>
<span class="udiff-line-modified-added">+             (ULanguageTag*)uprv_malloc(sizeof(ULanguageTag)));</span>
<span class="udiff-line-added">+     if (t.isNull()) {</span>
          uprv_free(tagBuf);
          *status = U_MEMORY_ALLOCATION_ERROR;
          return NULL;
      }
<span class="udiff-line-modified-removed">-     _initializeULanguageTag(t);</span>
<span class="udiff-line-modified-added">+     _initializeULanguageTag(t.getAlias());</span>
      t-&gt;buf = tagBuf;
  
      if (tagLen &lt; MINLEN) {
          /* the input tag is too short - return empty ULanguageTag */
<span class="udiff-line-modified-removed">-         return t;</span>
<span class="udiff-line-modified-added">+         return t.orphan();</span>
      }
  
<span class="udiff-line-added">+     size_t parsedLenDelta = 0;</span>
<span class="udiff-line-added">+     // Grandfathered tag will be consider together. Grandfathered tag with intervening</span>
<span class="udiff-line-added">+     // script and region such as art-DE-lojban or art-Latn-lojban won&#39;t be</span>
<span class="udiff-line-added">+     // matched.</span>
      /* check if the tag is grandfathered */
<span class="udiff-line-modified-removed">-     for (i = 0; GRANDFATHERED[i] != NULL; i += 2) {</span>
<span class="udiff-line-modified-removed">-         if (uprv_stricmp(GRANDFATHERED[i], tagBuf) == 0) {</span>
<span class="udiff-line-modified-added">+     for (i = 0; i &lt; UPRV_LENGTHOF(GRANDFATHERED); i += 2) {</span>
<span class="udiff-line-modified-added">+         int32_t checkGrandfatheredLen = static_cast&lt;int32_t&gt;(uprv_strlen(GRANDFATHERED[i]));</span>
<span class="udiff-line-added">+         if (tagLen &lt; checkGrandfatheredLen) {</span>
<span class="udiff-line-added">+             continue;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         if (tagLen &gt; checkGrandfatheredLen &amp;&amp; tagBuf[checkGrandfatheredLen] != &#39;-&#39;) {</span>
<span class="udiff-line-added">+             // make sure next char is &#39;-&#39;.</span>
<span class="udiff-line-added">+             continue;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+         if (uprv_strnicmp(GRANDFATHERED[i], tagBuf, checkGrandfatheredLen) == 0) {</span>
              int32_t newTagLength;
  
<span class="udiff-line-modified-removed">-             grandfatheredLen = tagLen;  /* back up for output parsedLen */</span>
<span class="udiff-line-modified-removed">-             newTagLength = static_cast&lt;int32_t&gt;(uprv_strlen(GRANDFATHERED[i+1]));</span>
<span class="udiff-line-modified-added">+             grandfatheredLen = checkGrandfatheredLen;  /* back up for output parsedLen */</span>
<span class="udiff-line-modified-added">+             int32_t replacementLen = static_cast&lt;int32_t&gt;(uprv_strlen(GRANDFATHERED[i+1]));</span>
<span class="udiff-line-added">+             newTagLength = replacementLen + tagLen - checkGrandfatheredLen;</span>
              if (tagLen &lt; newTagLength) {
                  uprv_free(tagBuf);
                  tagBuf = (char*)uprv_malloc(newTagLength + 1);
                  if (tagBuf == NULL) {
                      *status = U_MEMORY_ALLOCATION_ERROR;
<span class="udiff-line-removed">-                     ultag_close(t);</span>
                      return NULL;
                  }
                  t-&gt;buf = tagBuf;
                  tagLen = newTagLength;
              }
<span class="udiff-line-added">+             parsedLenDelta = checkGrandfatheredLen - replacementLen;</span>
              uprv_strcpy(t-&gt;buf, GRANDFATHERED[i + 1]);
<span class="udiff-line-added">+             if (checkGrandfatheredLen != tagLen) {</span>
<span class="udiff-line-added">+                 uprv_strcpy(t-&gt;buf + replacementLen, tag + checkGrandfatheredLen);</span>
<span class="udiff-line-added">+             }</span>
              break;
          }
      }
  
<span class="udiff-line-added">+     if (grandfatheredLen == 0) {</span>
<span class="udiff-line-added">+         for (i = 0; i &lt; UPRV_LENGTHOF(REDUNDANT); i += 2) {</span>
<span class="udiff-line-added">+             const char* redundantTag = REDUNDANT[i];</span>
<span class="udiff-line-added">+             size_t redundantTagLen = uprv_strlen(redundantTag);</span>
<span class="udiff-line-added">+             // The preferred tag for a redundant tag is always shorter than redundant</span>
<span class="udiff-line-added">+             // tag. A redundant tag may or may not be followed by other subtags.</span>
<span class="udiff-line-added">+             // (i.e. &quot;zh-yue&quot; or &quot;zh-yue-u-co-pinyin&quot;).</span>
<span class="udiff-line-added">+             if (uprv_strnicmp(redundantTag, tagBuf, static_cast&lt;uint32_t&gt;(redundantTagLen)) == 0) {</span>
<span class="udiff-line-added">+                 const char* redundantTagEnd = tagBuf + redundantTagLen;</span>
<span class="udiff-line-added">+                 if (*redundantTagEnd  == &#39;\0&#39; || *redundantTagEnd == SEP) {</span>
<span class="udiff-line-added">+                     const char* preferredTag = REDUNDANT[i + 1];</span>
<span class="udiff-line-added">+                     size_t preferredTagLen = uprv_strlen(preferredTag);</span>
<span class="udiff-line-added">+                     uprv_strncpy(t-&gt;buf, preferredTag, preferredTagLen);</span>
<span class="udiff-line-added">+                     if (*redundantTagEnd == SEP) {</span>
<span class="udiff-line-added">+                         uprv_memmove(tagBuf + preferredTagLen,</span>
<span class="udiff-line-added">+                                      redundantTagEnd,</span>
<span class="udiff-line-added">+                                      tagLen - redundantTagLen + 1);</span>
<span class="udiff-line-added">+                     } else {</span>
<span class="udiff-line-added">+                         tagBuf[preferredTagLen] = &#39;\0&#39;;</span>
<span class="udiff-line-added">+                     }</span>
<span class="udiff-line-added">+                     // parsedLen should be the length of the input</span>
<span class="udiff-line-added">+                     // before redundantTag is replaced by preferredTag.</span>
<span class="udiff-line-added">+                     // Save the delta to add it back later.</span>
<span class="udiff-line-added">+                     parsedLenDelta = redundantTagLen - preferredTagLen;</span>
<span class="udiff-line-added">+                     break;</span>
<span class="udiff-line-added">+                 }</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
      /*
       * langtag      =   language
       *                  [&quot;-&quot; script]
       *                  [&quot;-&quot; region]
       *                  *(&quot;-&quot; variant)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1894,16 +2168,19 @@</span>
              pNext = pSep + 1;
          }
          subtagLen = (int32_t)(pSep - pSubtag);
  
          if (next &amp; LANG) {
<span class="udiff-line-modified-removed">-             if (_isLanguageSubtag(pSubtag, subtagLen)) {</span>
<span class="udiff-line-modified-added">+             if (ultag_isLanguageSubtag(pSubtag, subtagLen)) {</span>
                  *pSep = 0;  /* terminate */
<span class="udiff-line-added">+                 // TODO: move deprecated language code handling here.</span>
                  t-&gt;language = T_CString_toLowerCase(pSubtag);
  
                  pLastGoodPosition = pSep;
<span class="udiff-line-modified-removed">-                 next = EXTL | SCRT | REGN | VART | EXTS | PRIV;</span>
<span class="udiff-line-modified-added">+                 next = SCRT | REGN | VART | EXTS | PRIV;</span>
<span class="udiff-line-added">+                 if (subtagLen &lt;= 3)</span>
<span class="udiff-line-added">+                   next |= EXTL;</span>
                  continue;
              }
          }
          if (next &amp; EXTL) {
              if (_isExtlangSubtag(pSubtag, subtagLen)) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1918,11 +2195,11 @@</span>
                  }
                  continue;
              }
          }
          if (next &amp; SCRT) {
<span class="udiff-line-modified-removed">-             if (_isScriptSubtag(pSubtag, subtagLen)) {</span>
<span class="udiff-line-modified-added">+             if (ultag_isScriptSubtag(pSubtag, subtagLen)) {</span>
                  char *p = pSubtag;
  
                  *pSep = 0;
  
                  /* to title case */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1938,12 +2215,13 @@</span>
                  next = REGN | VART | EXTS | PRIV;
                  continue;
              }
          }
          if (next &amp; REGN) {
<span class="udiff-line-modified-removed">-             if (_isRegionSubtag(pSubtag, subtagLen)) {</span>
<span class="udiff-line-modified-added">+             if (ultag_isRegionSubtag(pSubtag, subtagLen)) {</span>
                  *pSep = 0;
<span class="udiff-line-added">+                 // TODO: move deprecated region code handling here.</span>
                  t-&gt;region = T_CString_toUpperCase(pSubtag);
  
                  pLastGoodPosition = pSep;
                  next = VART | EXTS | PRIV;
                  continue;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1956,11 +2234,11 @@</span>
                  UBool isAdded;
  
                  var = (VariantListEntry*)uprv_malloc(sizeof(VariantListEntry));
                  if (var == NULL) {
                      *status = U_MEMORY_ALLOCATION_ERROR;
<span class="udiff-line-modified-removed">-                     goto error;</span>
<span class="udiff-line-modified-added">+                     return NULL;</span>
                  }
                  *pSep = 0;
                  var-&gt;variant = T_CString_toUpperCase(pSubtag);
                  isAdded = _addVariantToList(&amp;(t-&gt;variants), var);
                  if (!isAdded) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2000,11 +2278,11 @@</span>
  
                  /* create a new extension */
                  pExtension = (ExtensionListEntry*)uprv_malloc(sizeof(ExtensionListEntry));
                  if (pExtension == NULL) {
                      *status = U_MEMORY_ALLOCATION_ERROR;
<span class="udiff-line-modified-removed">-                     goto error;</span>
<span class="udiff-line-modified-added">+                     return NULL;</span>
                  }
                  *pSep = 0;
                  pExtension-&gt;key = T_CString_toLowerCase(pSubtag);
                  pExtension-&gt;value = NULL;   /* will be set later */
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2033,11 +2311,11 @@</span>
  
                  continue;
              }
          }
          if (next &amp; PRIV) {
<span class="udiff-line-modified-removed">-             if (uprv_tolower(*pSubtag) == PRIVATEUSE) {</span>
<span class="udiff-line-modified-added">+             if (uprv_tolower(*pSubtag) == PRIVATEUSE &amp;&amp; subtagLen == 1) {</span>
                  char *pPrivuseVal;
  
                  if (pExtension != NULL) {
                      /* Process the last extension */
                      if (pExtValueSubtag == NULL || pExtValueSubtagEnd == NULL) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2136,18 +2414,14 @@</span>
              }
          }
      }
  
      if (parsedLen != NULL) {
<span class="udiff-line-modified-removed">-         *parsedLen = (grandfatheredLen &gt; 0) ? grandfatheredLen : (int32_t)(pLastGoodPosition - t-&gt;buf);</span>
<span class="udiff-line-modified-added">+         *parsedLen = (int32_t)(pLastGoodPosition - t-&gt;buf + parsedLenDelta);</span>
      }
  
<span class="udiff-line-modified-removed">-     return t;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- error:</span>
<span class="udiff-line-removed">-     ultag_close(t);</span>
<span class="udiff-line-removed">-     return NULL;</span>
<span class="udiff-line-modified-added">+     return t.orphan();</span>
  }
  
  /**
  * Ticket #12705 - Turn optimization back on.
  */
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2333,53 +2607,111 @@</span>
  uloc_toLanguageTag(const char* localeID,
                     char* langtag,
                     int32_t langtagCapacity,
                     UBool strict,
                     UErrorCode* status) {
<span class="udiff-line-modified-removed">-     /* char canonical[ULOC_FULLNAME_CAPACITY]; */ /* See #6822 */</span>
<span class="udiff-line-modified-removed">-     char canonical[256];</span>
<span class="udiff-line-modified-removed">-     int32_t reslen = 0;</span>
<span class="udiff-line-modified-added">+     if (U_FAILURE(*status)) {</span>
<span class="udiff-line-modified-added">+         return 0;</span>
<span class="udiff-line-modified-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     icu::CheckedArrayByteSink sink(langtag, langtagCapacity);</span>
<span class="udiff-line-added">+     ulocimp_toLanguageTag(localeID, sink, strict, status);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     int32_t reslen = sink.NumberOfBytesAppended();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (U_FAILURE(*status)) {</span>
<span class="udiff-line-added">+         return reslen;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (sink.Overflowed()) {</span>
<span class="udiff-line-added">+         *status = U_BUFFER_OVERFLOW_ERROR;</span>
<span class="udiff-line-added">+     } else {</span>
<span class="udiff-line-added">+         u_terminateChars(langtag, langtagCapacity, reslen, status);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return reslen;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ U_CAPI void U_EXPORT2</span>
<span class="udiff-line-added">+ ulocimp_toLanguageTag(const char* localeID,</span>
<span class="udiff-line-added">+                       icu::ByteSink&amp; sink,</span>
<span class="udiff-line-added">+                       UBool strict,</span>
<span class="udiff-line-added">+                       UErrorCode* status) {</span>
<span class="udiff-line-added">+     icu::CharString canonical;</span>
<span class="udiff-line-added">+     int32_t reslen;</span>
      UErrorCode tmpStatus = U_ZERO_ERROR;
      UBool hadPosix = FALSE;
      const char* pKeywordStart;
  
      /* Note: uloc_canonicalize returns &quot;en_US_POSIX&quot; for input locale ID &quot;&quot;.  See #6835 */
<span class="udiff-line-modified-removed">-     canonical[0] = 0;</span>
<span class="udiff-line-modified-removed">-     if (uprv_strlen(localeID) &gt; 0) {</span>
<span class="udiff-line-modified-removed">-         uloc_canonicalize(localeID, canonical, sizeof(canonical), &amp;tmpStatus);</span>
<span class="udiff-line-modified-removed">-         if (tmpStatus != U_ZERO_ERROR) {</span>
<span class="udiff-line-modified-added">+     int32_t resultCapacity = static_cast&lt;int32_t&gt;(uprv_strlen(localeID));</span>
<span class="udiff-line-modified-added">+     if (resultCapacity &gt; 0) {</span>
<span class="udiff-line-modified-added">+         char* buffer;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-added">+         for (;;) {</span>
<span class="udiff-line-added">+             buffer = canonical.getAppendBuffer(</span>
<span class="udiff-line-added">+                     /*minCapacity=*/resultCapacity,</span>
<span class="udiff-line-added">+                     /*desiredCapacityHint=*/resultCapacity,</span>
<span class="udiff-line-added">+                     resultCapacity,</span>
<span class="udiff-line-added">+                     tmpStatus);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             if (U_FAILURE(tmpStatus)) {</span>
<span class="udiff-line-added">+                 *status = tmpStatus;</span>
<span class="udiff-line-added">+                 return;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             reslen =</span>
<span class="udiff-line-added">+                 uloc_canonicalize(localeID, buffer, resultCapacity, &amp;tmpStatus);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             if (tmpStatus != U_BUFFER_OVERFLOW_ERROR) {</span>
<span class="udiff-line-added">+                 break;</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+             resultCapacity = reslen;</span>
<span class="udiff-line-added">+             tmpStatus = U_ZERO_ERROR;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if (U_FAILURE(tmpStatus)) {</span>
              *status = U_ILLEGAL_ARGUMENT_ERROR;
<span class="udiff-line-modified-removed">-             return 0;</span>
<span class="udiff-line-modified-added">+             return;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         canonical.append(buffer, reslen, tmpStatus);</span>
<span class="udiff-line-added">+         if (tmpStatus == U_STRING_NOT_TERMINATED_WARNING) {</span>
<span class="udiff-line-added">+             tmpStatus = U_ZERO_ERROR;  // Terminators provided by CharString.</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         if (U_FAILURE(tmpStatus)) {</span>
<span class="udiff-line-added">+             *status = tmpStatus;</span>
<span class="udiff-line-added">+             return;</span>
          }
      }
  
      /* For handling special case - private use only tag */
<span class="udiff-line-modified-removed">-     pKeywordStart = locale_getKeywordsStart(canonical);</span>
<span class="udiff-line-modified-removed">-     if (pKeywordStart == canonical) {</span>
<span class="udiff-line-removed">-         UEnumeration *kwdEnum;</span>
<span class="udiff-line-modified-added">+     pKeywordStart = locale_getKeywordsStart(canonical.data());</span>
<span class="udiff-line-modified-added">+     if (pKeywordStart == canonical.data()) {</span>
          int kwdCnt = 0;
          UBool done = FALSE;
  
<span class="udiff-line-modified-removed">-         kwdEnum = uloc_openKeywords((const char*)canonical, &amp;tmpStatus);</span>
<span class="udiff-line-modified-removed">-         if (kwdEnum != NULL) {</span>
<span class="udiff-line-modified-removed">-             kwdCnt = uenum_count(kwdEnum, &amp;tmpStatus);</span>
<span class="udiff-line-modified-added">+         icu::LocalUEnumerationPointer kwdEnum(uloc_openKeywords(canonical.data(), &amp;tmpStatus));</span>
<span class="udiff-line-modified-added">+         if (U_SUCCESS(tmpStatus)) {</span>
<span class="udiff-line-modified-added">+             kwdCnt = uenum_count(kwdEnum.getAlias(), &amp;tmpStatus);</span>
              if (kwdCnt == 1) {
                  const char *key;
                  int32_t len = 0;
  
<span class="udiff-line-modified-removed">-                 key = uenum_next(kwdEnum, &amp;len, &amp;tmpStatus);</span>
<span class="udiff-line-modified-added">+                 key = uenum_next(kwdEnum.getAlias(), &amp;len, &amp;tmpStatus);</span>
                  if (len == 1 &amp;&amp; *key == PRIVATEUSE) {
                      char buf[ULOC_KEYWORD_AND_VALUES_CAPACITY];
                      buf[0] = PRIVATEUSE;
                      buf[1] = SEP;
                      len = uloc_getKeywordValue(localeID, key, &amp;buf[2], sizeof(buf) - 2, &amp;tmpStatus);
                      if (U_SUCCESS(tmpStatus)) {
<span class="udiff-line-modified-removed">-                         if (_isPrivateuseValueSubtags(&amp;buf[2], len)) {</span>
<span class="udiff-line-modified-added">+                         if (ultag_isPrivateuseValueSubtags(&amp;buf[2], len)) {</span>
                              /* return private use only tag */
<span class="udiff-line-modified-removed">-                             reslen = len + 2;</span>
<span class="udiff-line-removed">-                             uprv_memcpy(langtag, buf, uprv_min(reslen, langtagCapacity));</span>
<span class="udiff-line-removed">-                             u_terminateChars(langtag, langtagCapacity, reslen, status);</span>
<span class="udiff-line-modified-added">+                             sink.Append(buf, len + 2);</span>
                              done = TRUE;
                          } else if (strict) {
                              *status = U_ILLEGAL_ARGUMENT_ERROR;
                              done = TRUE;
                          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2388,145 +2720,139 @@</span>
                          *status = U_ILLEGAL_ARGUMENT_ERROR;
                          done = TRUE;
                      }
                  }
              }
<span class="udiff-line-removed">-             uenum_close(kwdEnum);</span>
              if (done) {
<span class="udiff-line-modified-removed">-                 return reslen;</span>
<span class="udiff-line-modified-added">+                 return;</span>
              }
          }
      }
  
<span class="udiff-line-modified-removed">-     reslen += _appendLanguageToLanguageTag(canonical, langtag, langtagCapacity, strict, status);</span>
<span class="udiff-line-modified-removed">-     reslen += _appendScriptToLanguageTag(canonical, langtag + reslen, langtagCapacity - reslen, strict, status);</span>
<span class="udiff-line-modified-removed">-     reslen += _appendRegionToLanguageTag(canonical, langtag + reslen, langtagCapacity - reslen, strict, status);</span>
<span class="udiff-line-modified-removed">-     reslen += _appendVariantsToLanguageTag(canonical, langtag + reslen, langtagCapacity - reslen, strict, &amp;hadPosix, status);</span>
<span class="udiff-line-modified-removed">-     reslen += _appendKeywordsToLanguageTag(canonical, langtag + reslen, langtagCapacity - reslen, strict, hadPosix, status);</span>
<span class="udiff-line-modified-removed">-     reslen += _appendPrivateuseToLanguageTag(canonical, langtag + reslen, langtagCapacity - reslen, strict, hadPosix, status);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     return reslen;</span>
<span class="udiff-line-modified-added">+     _appendLanguageToLanguageTag(canonical.data(), sink, strict, status);</span>
<span class="udiff-line-modified-added">+     _appendScriptToLanguageTag(canonical.data(), sink, strict, status);</span>
<span class="udiff-line-modified-added">+     _appendRegionToLanguageTag(canonical.data(), sink, strict, status);</span>
<span class="udiff-line-modified-added">+     _appendVariantsToLanguageTag(canonical.data(), sink, strict, &amp;hadPosix, status);</span>
<span class="udiff-line-modified-added">+     _appendKeywordsToLanguageTag(canonical.data(), sink, strict, hadPosix, status);</span>
<span class="udiff-line-modified-added">+     _appendPrivateuseToLanguageTag(canonical.data(), sink, strict, hadPosix, status);</span>
  }
  
  
  U_CAPI int32_t U_EXPORT2
  uloc_forLanguageTag(const char* langtag,
                      char* localeID,
                      int32_t localeIDCapacity,
                      int32_t* parsedLength,
                      UErrorCode* status) {
<span class="udiff-line-modified-removed">-     ULanguageTag *lt;</span>
<span class="udiff-line-modified-removed">-     int32_t reslen = 0;</span>
<span class="udiff-line-modified-added">+     if (U_FAILURE(*status)) {</span>
<span class="udiff-line-modified-added">+         return 0;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     icu::CheckedArrayByteSink sink(localeID, localeIDCapacity);</span>
<span class="udiff-line-added">+     ulocimp_forLanguageTag(langtag, -1, sink, parsedLength, status);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     int32_t reslen = sink.NumberOfBytesAppended();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (U_FAILURE(*status)) {</span>
<span class="udiff-line-added">+         return reslen;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (sink.Overflowed()) {</span>
<span class="udiff-line-added">+         *status = U_BUFFER_OVERFLOW_ERROR;</span>
<span class="udiff-line-added">+     } else {</span>
<span class="udiff-line-added">+         u_terminateChars(localeID, localeIDCapacity, reslen, status);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return reslen;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ U_CAPI void U_EXPORT2</span>
<span class="udiff-line-added">+ ulocimp_forLanguageTag(const char* langtag,</span>
<span class="udiff-line-added">+                        int32_t tagLen,</span>
<span class="udiff-line-added">+                        icu::ByteSink&amp; sink,</span>
<span class="udiff-line-added">+                        int32_t* parsedLength,</span>
<span class="udiff-line-added">+                        UErrorCode* status) {</span>
<span class="udiff-line-added">+     UBool isEmpty = TRUE;</span>
      const char *subtag, *p;
      int32_t len;
      int32_t i, n;
      UBool noRegion = TRUE;
  
<span class="udiff-line-modified-removed">-     lt = ultag_parse(langtag, -1, parsedLength, status);</span>
<span class="udiff-line-modified-added">+     icu::LocalULanguageTagPointer lt(ultag_parse(langtag, tagLen, parsedLength, status));</span>
      if (U_FAILURE(*status)) {
<span class="udiff-line-modified-removed">-         return 0;</span>
<span class="udiff-line-modified-added">+         return;</span>
      }
  
      /* language */
<span class="udiff-line-modified-removed">-     subtag = ultag_getExtlangSize(lt) &gt; 0 ? ultag_getExtlang(lt, 0) : ultag_getLanguage(lt);</span>
<span class="udiff-line-modified-added">+     subtag = ultag_getExtlangSize(lt.getAlias()) &gt; 0 ? ultag_getExtlang(lt.getAlias(), 0) : ultag_getLanguage(lt.getAlias());</span>
      if (uprv_compareInvCharsAsAscii(subtag, LANG_UND) != 0) {
          len = (int32_t)uprv_strlen(subtag);
          if (len &gt; 0) {
<span class="udiff-line-modified-removed">-             if (reslen &lt; localeIDCapacity) {</span>
<span class="udiff-line-modified-removed">-                 uprv_memcpy(localeID, subtag, uprv_min(len, localeIDCapacity - reslen));</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             reslen += len;</span>
<span class="udiff-line-modified-added">+             sink.Append(subtag, len);</span>
<span class="udiff-line-modified-added">+             isEmpty = FALSE;</span>
          }
      }
  
      /* script */
<span class="udiff-line-modified-removed">-     subtag = ultag_getScript(lt);</span>
<span class="udiff-line-modified-added">+     subtag = ultag_getScript(lt.getAlias());</span>
      len = (int32_t)uprv_strlen(subtag);
      if (len &gt; 0) {
<span class="udiff-line-modified-removed">-         if (reslen &lt; localeIDCapacity) {</span>
<span class="udiff-line-modified-removed">-             *(localeID + reslen) = LOCALE_SEP;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         reslen++;</span>
<span class="udiff-line-modified-added">+         sink.Append(&quot;_&quot;, 1);</span>
<span class="udiff-line-modified-added">+         isEmpty = FALSE;</span>
  
          /* write out the script in title case */
<span class="udiff-line-modified-removed">-         p = subtag;</span>
<span class="udiff-line-modified-removed">-         while (*p) {</span>
<span class="udiff-line-modified-removed">-             if (reslen &lt; localeIDCapacity) {</span>
<span class="udiff-line-removed">-                 if (p == subtag) {</span>
<span class="udiff-line-removed">-                     *(localeID + reslen) = uprv_toupper(*p);</span>
<span class="udiff-line-removed">-                 } else {</span>
<span class="udiff-line-removed">-                     *(localeID + reslen) = *p;</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             reslen++;</span>
<span class="udiff-line-removed">-             p++;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-modified-added">+         char c = uprv_toupper(*subtag);</span>
<span class="udiff-line-modified-added">+         sink.Append(&amp;c, 1);</span>
<span class="udiff-line-modified-added">+         sink.Append(subtag + 1, len - 1);</span>
      }
  
      /* region */
<span class="udiff-line-modified-removed">-     subtag = ultag_getRegion(lt);</span>
<span class="udiff-line-modified-added">+     subtag = ultag_getRegion(lt.getAlias());</span>
      len = (int32_t)uprv_strlen(subtag);
      if (len &gt; 0) {
<span class="udiff-line-modified-removed">-         if (reslen &lt; localeIDCapacity) {</span>
<span class="udiff-line-modified-removed">-             *(localeID + reslen) = LOCALE_SEP;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         reslen++;</span>
<span class="udiff-line-removed">-         /* write out the retion in upper case */</span>
<span class="udiff-line-modified-added">+         sink.Append(&quot;_&quot;, 1);</span>
<span class="udiff-line-modified-added">+         isEmpty = FALSE;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+         /* write out the region in upper case */</span>
          p = subtag;
          while (*p) {
<span class="udiff-line-modified-removed">-             if (reslen &lt; localeIDCapacity) {</span>
<span class="udiff-line-modified-removed">-                 *(localeID + reslen) = uprv_toupper(*p);</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             reslen++;</span>
<span class="udiff-line-modified-added">+             char c = uprv_toupper(*p);</span>
<span class="udiff-line-modified-added">+             sink.Append(&amp;c, 1);</span>
              p++;
          }
          noRegion = FALSE;
      }
  
      /* variants */
<span class="udiff-line-modified-removed">-     n = ultag_getVariantsSize(lt);</span>
<span class="udiff-line-modified-added">+     n = ultag_getVariantsSize(lt.getAlias());</span>
      if (n &gt; 0) {
          if (noRegion) {
<span class="udiff-line-modified-removed">-             if (reslen &lt; localeIDCapacity) {</span>
<span class="udiff-line-modified-removed">-                 *(localeID + reslen) = LOCALE_SEP;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             reslen++;</span>
<span class="udiff-line-modified-added">+             sink.Append(&quot;_&quot;, 1);</span>
<span class="udiff-line-modified-added">+             isEmpty = FALSE;</span>
          }
  
          for (i = 0; i &lt; n; i++) {
<span class="udiff-line-modified-removed">-             subtag = ultag_getVariant(lt, i);</span>
<span class="udiff-line-modified-removed">-             if (reslen &lt; localeIDCapacity) {</span>
<span class="udiff-line-modified-removed">-                 *(localeID + reslen) = LOCALE_SEP;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             reslen++;</span>
<span class="udiff-line-modified-added">+             subtag = ultag_getVariant(lt.getAlias(), i);</span>
<span class="udiff-line-modified-added">+             sink.Append(&quot;_&quot;, 1);</span>
<span class="udiff-line-modified-added">+ </span>
              /* write out the variant in upper case */
              p = subtag;
              while (*p) {
<span class="udiff-line-modified-removed">-                 if (reslen &lt; localeIDCapacity) {</span>
<span class="udiff-line-modified-removed">-                     *(localeID + reslen) = uprv_toupper(*p);</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-                 reslen++;</span>
<span class="udiff-line-modified-added">+                 char c = uprv_toupper(*p);</span>
<span class="udiff-line-modified-added">+                 sink.Append(&amp;c, 1);</span>
                  p++;
              }
          }
      }
  
      /* keywords */
<span class="udiff-line-modified-removed">-     n = ultag_getExtensionsSize(lt);</span>
<span class="udiff-line-modified-removed">-     subtag = ultag_getPrivateUse(lt);</span>
<span class="udiff-line-modified-added">+     n = ultag_getExtensionsSize(lt.getAlias());</span>
<span class="udiff-line-modified-added">+     subtag = ultag_getPrivateUse(lt.getAlias());</span>
      if (n &gt; 0 || uprv_strlen(subtag) &gt; 0) {
<span class="udiff-line-modified-removed">-         if (reslen == 0 &amp;&amp; n &gt; 0) {</span>
<span class="udiff-line-modified-added">+         if (isEmpty &amp;&amp; n &gt; 0) {</span>
              /* need a language */
<span class="udiff-line-modified-removed">-             if (reslen &lt; localeIDCapacity) {</span>
<span class="udiff-line-removed">-                 uprv_memcpy(localeID + reslen, LANG_UND, uprv_min(LANG_UND_LEN, localeIDCapacity - reslen));</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             reslen += LANG_UND_LEN;</span>
<span class="udiff-line-modified-added">+             sink.Append(LANG_UND, LANG_UND_LEN);</span>
          }
<span class="udiff-line-modified-removed">-         len = _appendKeywords(lt, localeID + reslen, localeIDCapacity - reslen, status);</span>
<span class="udiff-line-removed">-         reslen += len;</span>
<span class="udiff-line-modified-added">+         _appendKeywords(lt.getAlias(), sink, status);</span>
      }
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     ultag_close(lt);</span>
<span class="udiff-line-removed">-     return u_terminateChars(localeID, localeIDCapacity, reslen, status);</span>
  }
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
</pre>
<center><a href="uloc_keytype.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="ulocimp.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>