<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/ThirdParty/icu/source/i18n/japancal.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="islamcal.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="japancal.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/ThirdParty/icu/source/i18n/japancal.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 14,300 ***</span>
  */
  
  #include &quot;unicode/utypes.h&quot;
  
  #if !UCONFIG_NO_FORMATTING
<span class="line-modified">! </span>
  #include &quot;cmemory.h&quot;
  #include &quot;japancal.h&quot;
  #include &quot;unicode/gregocal.h&quot;
  #include &quot;umutex.h&quot;
  #include &quot;uassert.h&quot;
<span class="line-modified">! </span>
<span class="line-modified">! //#define U_DEBUG_JCAL</span>
<span class="line-modified">! </span>
<span class="line-modified">! #ifdef U_DEBUG_JCAL</span>
<span class="line-modified">! #include &lt;stdio.h&gt;</span>
<span class="line-modified">! #endif</span>
  
  U_NAMESPACE_BEGIN
  
  UOBJECT_DEFINE_RTTI_IMPLEMENTATION(JapaneseCalendar)
  
<span class="line-removed">- //  Gregorian date of each emperor&#39;s ascension</span>
<span class="line-removed">- //  Years are AD, months are 1-based.</span>
<span class="line-removed">- static const struct {</span>
<span class="line-removed">-     int16_t year;</span>
<span class="line-removed">-     int8_t  month;</span>
<span class="line-removed">-     int8_t  day;</span>
<span class="line-removed">- } kEraInfo[] =  {</span>
<span class="line-removed">-     //  Year  Month Day</span>
<span class="line-removed">-     {   645,    6, 19 },   // Taika   0</span>
<span class="line-removed">-     {   650,    2, 15 },   // Hakuchi 1</span>
<span class="line-removed">-     {   672,    1,  1 },   // Hakuho  2</span>
<span class="line-removed">-     {   686,    7, 20 },   // Shucho  3</span>
<span class="line-removed">-     {   701,    3, 21 },   // Taiho   4</span>
<span class="line-removed">-     {   704,    5, 10 },   // Keiun   5</span>
<span class="line-removed">-     {   708,    1, 11 },   // Wado    6</span>
<span class="line-removed">-     {   715,    9,  2 },   // Reiki   7</span>
<span class="line-removed">-     {   717,   11, 17 },   // Yoro    8</span>
<span class="line-removed">-     {   724,    2,  4 },   // Jinki   9</span>
<span class="line-removed">-     {   729,    8,  5 },   // Tempyo  10</span>
<span class="line-removed">-     {   749,    4, 14 },   // Tempyo-kampo 11</span>
<span class="line-removed">-     {   749,    7,  2 },   // Tempyo-shoho 12</span>
<span class="line-removed">-     {   757,    8, 18 },   // Tempyo-hoji  13</span>
<span class="line-removed">-     {   765,    1,  7 },   // Tempho-jingo 14</span>
<span class="line-removed">-     {   767,    8, 16 },   // Jingo-keiun  15</span>
<span class="line-removed">-     {   770,   10,  1 },   // Hoki         16</span>
<span class="line-removed">-     {   781,    1,  1 },   // Ten-o        17</span>
<span class="line-removed">-     {   782,    8, 19 },   // Enryaku      18</span>
<span class="line-removed">-     {   806,    5, 18 },   // Daido        19</span>
<span class="line-removed">-     {   810,    9, 19 },   // Konin        20</span>
<span class="line-removed">-     {   824,    1,  5 },   // Tencho</span>
<span class="line-removed">-     {   834,    1,  3 },   // Showa</span>
<span class="line-removed">-     {   848,    6, 13 },   // Kajo</span>
<span class="line-removed">-     {   851,    4, 28 },   // Ninju</span>
<span class="line-removed">-     {   854,   11, 30 },   // Saiko</span>
<span class="line-removed">-     {   857,    2, 21 },   // Tennan</span>
<span class="line-removed">-     {   859,    4, 15 },   // Jogan</span>
<span class="line-removed">-     {   877,    4, 16 },   // Genkei</span>
<span class="line-removed">-     {   885,    2, 21 },   // Ninna</span>
<span class="line-removed">-     {   889,    4, 27 },   // Kampyo       30</span>
<span class="line-removed">-     {   898,    4, 26 },   // Shotai</span>
<span class="line-removed">-     {   901,    7, 15 },   // Engi</span>
<span class="line-removed">-     {   923,    4, 11 },   // Encho</span>
<span class="line-removed">-     {   931,    4, 26 },   // Shohei</span>
<span class="line-removed">-     {   938,    5, 22 },   // Tengyo</span>
<span class="line-removed">-     {   947,    4, 22 },   // Tenryaku</span>
<span class="line-removed">-     {   957,   10, 27 },   // Tentoku</span>
<span class="line-removed">-     {   961,    2, 16 },   // Owa</span>
<span class="line-removed">-     {   964,    7, 10 },   // Koho</span>
<span class="line-removed">-     {   968,    8, 13 },   // Anna        40</span>
<span class="line-removed">-     {   970,    3, 25 },   // Tenroku</span>
<span class="line-removed">-     {   973,   12, 20 },   // Ten-en</span>
<span class="line-removed">-     {   976,    7, 13 },   // Jogen</span>
<span class="line-removed">-     {   978,   11, 29 },   // Tengen</span>
<span class="line-removed">-     {   983,    4, 15 },   // Eikan</span>
<span class="line-removed">-     {   985,    4, 27 },   // Kanna</span>
<span class="line-removed">-     {   987,    4,  5 },   // Ei-en</span>
<span class="line-removed">-     {   989,    8,  8 },   // Eiso</span>
<span class="line-removed">-     {   990,   11,  7 },   // Shoryaku</span>
<span class="line-removed">-     {   995,    2, 22 },   // Chotoku      50</span>
<span class="line-removed">-     {   999,    1, 13 },   // Choho</span>
<span class="line-removed">-     {  1004,    7, 20 },   // Kanko</span>
<span class="line-removed">-     {  1012,   12, 25 },   // Chowa</span>
<span class="line-removed">-     {  1017,    4, 23 },   // Kannin</span>
<span class="line-removed">-     {  1021,    2,  2 },   // Jian</span>
<span class="line-removed">-     {  1024,    7, 13 },   // Manju</span>
<span class="line-removed">-     {  1028,    7, 25 },   // Chogen</span>
<span class="line-removed">-     {  1037,    4, 21 },   // Choryaku</span>
<span class="line-removed">-     {  1040,   11, 10 },   // Chokyu</span>
<span class="line-removed">-     {  1044,   11, 24 },   // Kantoku      60</span>
<span class="line-removed">-     {  1046,    4, 14 },   // Eisho</span>
<span class="line-removed">-     {  1053,    1, 11 },   // Tengi</span>
<span class="line-removed">-     {  1058,    8, 29 },   // Kohei</span>
<span class="line-removed">-     {  1065,    8,  2 },   // Jiryaku</span>
<span class="line-removed">-     {  1069,    4, 13 },   // Enkyu</span>
<span class="line-removed">-     {  1074,    8, 23 },   // Shoho</span>
<span class="line-removed">-     {  1077,   11, 17 },   // Shoryaku</span>
<span class="line-removed">-     {  1081,    2, 10 },   // Eiho</span>
<span class="line-removed">-     {  1084,    2,  7 },   // Otoku</span>
<span class="line-removed">-     {  1087,    4,  7 },   // Kanji       70</span>
<span class="line-removed">-     {  1094,   12, 15 },   // Kaho</span>
<span class="line-removed">-     {  1096,   12, 17 },   // Eicho</span>
<span class="line-removed">-     {  1097,   11, 21 },   // Shotoku</span>
<span class="line-removed">-     {  1099,    8, 28 },   // Kowa</span>
<span class="line-removed">-     {  1104,    2, 10 },   // Choji</span>
<span class="line-removed">-     {  1106,    4,  9 },   // Kasho</span>
<span class="line-removed">-     {  1108,    8,  3 },   // Tennin</span>
<span class="line-removed">-     {  1110,    7, 13 },   // Ten-ei</span>
<span class="line-removed">-     {  1113,    7, 13 },   // Eikyu</span>
<span class="line-removed">-     {  1118,    4,  3 },   // Gen-ei      80</span>
<span class="line-removed">-     {  1120,    4, 10 },   // Hoan</span>
<span class="line-removed">-     {  1124,    4,  3 },   // Tenji</span>
<span class="line-removed">-     {  1126,    1, 22 },   // Daiji</span>
<span class="line-removed">-     {  1131,    1, 29 },   // Tensho</span>
<span class="line-removed">-     {  1132,    8, 11 },   // Chosho</span>
<span class="line-removed">-     {  1135,    4, 27 },   // Hoen</span>
<span class="line-removed">-     {  1141,    7, 10 },   // Eiji</span>
<span class="line-removed">-     {  1142,    4, 28 },   // Koji</span>
<span class="line-removed">-     {  1144,    2, 23 },   // Tenyo</span>
<span class="line-removed">-     {  1145,    7, 22 },   // Kyuan      90</span>
<span class="line-removed">-     {  1151,    1, 26 },   // Ninpei</span>
<span class="line-removed">-     {  1154,   10, 28 },   // Kyuju</span>
<span class="line-removed">-     {  1156,    4, 27 },   // Hogen</span>
<span class="line-removed">-     {  1159,    4, 20 },   // Heiji</span>
<span class="line-removed">-     {  1160,    1, 10 },   // Eiryaku</span>
<span class="line-removed">-     {  1161,    9,  4 },   // Oho</span>
<span class="line-removed">-     {  1163,    3, 29 },   // Chokan</span>
<span class="line-removed">-     {  1165,    6,  5 },   // Eiman</span>
<span class="line-removed">-     {  1166,    8, 27 },   // Nin-an</span>
<span class="line-removed">-     {  1169,    4,  8 },   // Kao       100</span>
<span class="line-removed">-     {  1171,    4, 21 },   // Shoan</span>
<span class="line-removed">-     {  1175,    7, 28 },   // Angen</span>
<span class="line-removed">-     {  1177,    8,  4 },   // Jisho</span>
<span class="line-removed">-     {  1181,    7, 14 },   // Yowa</span>
<span class="line-removed">-     {  1182,    5, 27 },   // Juei</span>
<span class="line-removed">-     {  1184,    4, 16 },   // Genryuku</span>
<span class="line-removed">-     {  1185,    8, 14 },   // Bunji</span>
<span class="line-removed">-     {  1190,    4, 11 },   // Kenkyu</span>
<span class="line-removed">-     {  1199,    4, 27 },   // Shoji</span>
<span class="line-removed">-     {  1201,    2, 13 },   // Kennin     110</span>
<span class="line-removed">-     {  1204,    2, 20 },   // Genkyu</span>
<span class="line-removed">-     {  1206,    4, 27 },   // Ken-ei</span>
<span class="line-removed">-     {  1207,   10, 25 },   // Shogen</span>
<span class="line-removed">-     {  1211,    3,  9 },   // Kenryaku</span>
<span class="line-removed">-     {  1213,   12,  6 },   // Kenpo</span>
<span class="line-removed">-     {  1219,    4, 12 },   // Shokyu</span>
<span class="line-removed">-     {  1222,    4, 13 },   // Joo</span>
<span class="line-removed">-     {  1224,   11, 20 },   // Gennin</span>
<span class="line-removed">-     {  1225,    4, 20 },   // Karoku</span>
<span class="line-removed">-     {  1227,   12, 10 },   // Antei      120</span>
<span class="line-removed">-     {  1229,    3,  5 },   // Kanki</span>
<span class="line-removed">-     {  1232,    4,  2 },   // Joei</span>
<span class="line-removed">-     {  1233,    4, 15 },   // Tempuku</span>
<span class="line-removed">-     {  1234,   11,  5 },   // Bunryaku</span>
<span class="line-removed">-     {  1235,    9, 19 },   // Katei</span>
<span class="line-removed">-     {  1238,   11, 23 },   // Ryakunin</span>
<span class="line-removed">-     {  1239,    2,  7 },   // En-o</span>
<span class="line-removed">-     {  1240,    7, 16 },   // Ninji</span>
<span class="line-removed">-     {  1243,    2, 26 },   // Kangen</span>
<span class="line-removed">-     {  1247,    2, 28 },   // Hoji      130</span>
<span class="line-removed">-     {  1249,    3, 18 },   // Kencho</span>
<span class="line-removed">-     {  1256,   10,  5 },   // Kogen</span>
<span class="line-removed">-     {  1257,    3, 14 },   // Shoka</span>
<span class="line-removed">-     {  1259,    3, 26 },   // Shogen</span>
<span class="line-removed">-     {  1260,    4, 13 },   // Bun-o</span>
<span class="line-removed">-     {  1261,    2, 20 },   // Kocho</span>
<span class="line-removed">-     {  1264,    2, 28 },   // Bun-ei</span>
<span class="line-removed">-     {  1275,    4, 25 },   // Kenji</span>
<span class="line-removed">-     {  1278,    2, 29 },   // Koan</span>
<span class="line-removed">-     {  1288,    4, 28 },   // Shoo      140</span>
<span class="line-removed">-     {  1293,    8, 55 },   // Einin</span>
<span class="line-removed">-     {  1299,    4, 25 },   // Shoan</span>
<span class="line-removed">-     {  1302,   11, 21 },   // Kengen</span>
<span class="line-removed">-     {  1303,    8,  5 },   // Kagen</span>
<span class="line-removed">-     {  1306,   12, 14 },   // Tokuji</span>
<span class="line-removed">-     {  1308,   10,  9 },   // Enkei</span>
<span class="line-removed">-     {  1311,    4, 28 },   // Ocho</span>
<span class="line-removed">-     {  1312,    3, 20 },   // Showa</span>
<span class="line-removed">-     {  1317,    2,  3 },   // Bunpo</span>
<span class="line-removed">-     {  1319,    4, 28 },   // Geno      150</span>
<span class="line-removed">-     {  1321,    2, 23 },   // Genkyo</span>
<span class="line-removed">-     {  1324,   12,  9 },   // Shochu</span>
<span class="line-removed">-     {  1326,    4, 26 },   // Kareki</span>
<span class="line-removed">-     {  1329,    8, 29 },   // Gentoku</span>
<span class="line-removed">-     {  1331,    8,  9 },   // Genko</span>
<span class="line-removed">-     {  1334,    1, 29 },   // Kemmu</span>
<span class="line-removed">-     {  1336,    2, 29 },   // Engen</span>
<span class="line-removed">-     {  1340,    4, 28 },   // Kokoku</span>
<span class="line-removed">-     {  1346,   12,  8 },   // Shohei</span>
<span class="line-removed">-     {  1370,    7, 24 },   // Kentoku       160</span>
<span class="line-removed">-     {  1372,    4,  1 },   // Bunch\u0169</span>
<span class="line-removed">-     {  1375,    5, 27 },   // Tenju</span>
<span class="line-removed">-     {  1379,    3, 22 },   // Koryaku</span>
<span class="line-removed">-     {  1381,    2, 10 },   // Kowa</span>
<span class="line-removed">-     {  1384,    4, 28 },   // Gench\u0169</span>
<span class="line-removed">-     {  1384,    2, 27 },   // Meitoku</span>
<span class="line-removed">-     {  1387,    8, 23 },   // Kakei</span>
<span class="line-removed">-     {  1389,    2,  9 },   // Koo</span>
<span class="line-removed">-     {  1390,    3, 26 },   // Meitoku</span>
<span class="line-removed">-     {  1394,    7,  5 },   // Oei           170</span>
<span class="line-removed">-     {  1428,    4, 27 },   // Shocho</span>
<span class="line-removed">-     {  1429,    9,  5 },   // Eikyo</span>
<span class="line-removed">-     {  1441,    2, 17 },   // Kakitsu</span>
<span class="line-removed">-     {  1444,    2,  5 },   // Bun-an</span>
<span class="line-removed">-     {  1449,    7, 28 },   // Hotoku</span>
<span class="line-removed">-     {  1452,    7, 25 },   // Kyotoku</span>
<span class="line-removed">-     {  1455,    7, 25 },   // Kosho</span>
<span class="line-removed">-     {  1457,    9, 28 },   // Choroku</span>
<span class="line-removed">-     {  1460,   12, 21 },   // Kansho</span>
<span class="line-removed">-     {  1466,    2, 28 },   // Bunsho        180</span>
<span class="line-removed">-     {  1467,    3,  3 },   // Onin</span>
<span class="line-removed">-     {  1469,    4, 28 },   // Bunmei</span>
<span class="line-removed">-     {  1487,    7, 29 },   // Chokyo</span>
<span class="line-removed">-     {  1489,    8, 21 },   // Entoku</span>
<span class="line-removed">-     {  1492,    7, 19 },   // Meio</span>
<span class="line-removed">-     {  1501,    2, 29 },   // Bunki</span>
<span class="line-removed">-     {  1504,    2, 30 },   // Eisho</span>
<span class="line-removed">-     {  1521,    8, 23 },   // Taiei</span>
<span class="line-removed">-     {  1528,    8, 20 },   // Kyoroku</span>
<span class="line-removed">-     {  1532,    7, 29 },   // Tenmon       190</span>
<span class="line-removed">-     {  1555,   10, 23 },   // Koji</span>
<span class="line-removed">-     {  1558,    2, 28 },   // Eiroku</span>
<span class="line-removed">-     {  1570,    4, 23 },   // Genki</span>
<span class="line-removed">-     {  1573,    7, 28 },   // Tensho</span>
<span class="line-removed">-     {  1592,   12,  8 },   // Bunroku</span>
<span class="line-removed">-     {  1596,   10, 27 },   // Keicho</span>
<span class="line-removed">-     {  1615,    7, 13 },   // Genwa</span>
<span class="line-removed">-     {  1624,    2, 30 },   // Kan-ei</span>
<span class="line-removed">-     {  1644,   12, 16 },   // Shoho</span>
<span class="line-removed">-     {  1648,    2, 15 },   // Keian       200</span>
<span class="line-removed">-     {  1652,    9, 18 },   // Shoo</span>
<span class="line-removed">-     {  1655,    4, 13 },   // Meiryaku</span>
<span class="line-removed">-     {  1658,    7, 23 },   // Manji</span>
<span class="line-removed">-     {  1661,    4, 25 },   // Kanbun</span>
<span class="line-removed">-     {  1673,    9, 21 },   // Enpo</span>
<span class="line-removed">-     {  1681,    9, 29 },   // Tenwa</span>
<span class="line-removed">-     {  1684,    2, 21 },   // Jokyo</span>
<span class="line-removed">-     {  1688,    9, 30 },   // Genroku</span>
<span class="line-removed">-     {  1704,    3, 13 },   // Hoei</span>
<span class="line-removed">-     {  1711,    4, 25 },   // Shotoku      210</span>
<span class="line-removed">-     {  1716,    6, 22 },   // Kyoho</span>
<span class="line-removed">-     {  1736,    4, 28 },   // Genbun</span>
<span class="line-removed">-     {  1741,    2, 27 },   // Kanpo</span>
<span class="line-removed">-     {  1744,    2, 21 },   // Enkyo</span>
<span class="line-removed">-     {  1748,    7, 12 },   // Kan-en</span>
<span class="line-removed">-     {  1751,   10, 27 },   // Horyaku</span>
<span class="line-removed">-     {  1764,    6,  2 },   // Meiwa</span>
<span class="line-removed">-     {  1772,   11, 16 },   // An-ei</span>
<span class="line-removed">-     {  1781,    4,  2 },   // Tenmei</span>
<span class="line-removed">-     {  1789,    1, 25 },   // Kansei      220</span>
<span class="line-removed">-     {  1801,    2,  5 },   // Kyowa</span>
<span class="line-removed">-     {  1804,    2, 11 },   // Bunka</span>
<span class="line-removed">-     {  1818,    4, 22 },   // Bunsei</span>
<span class="line-removed">-     {  1830,   12, 10 },   // Tenpo</span>
<span class="line-removed">-     {  1844,   12,  2 },   // Koka</span>
<span class="line-removed">-     {  1848,    2, 28 },   // Kaei</span>
<span class="line-removed">-     {  1854,   11, 27 },   // Ansei</span>
<span class="line-removed">-     {  1860,    3, 18 },   // Man-en</span>
<span class="line-removed">-     {  1861,    2, 19 },   // Bunkyu</span>
<span class="line-removed">-     {  1864,    2, 20 },   // Genji        230</span>
<span class="line-removed">-     {  1865,    4,  7 },   // Keio     231</span>
<span class="line-removed">-     {  1868,    9,  8 },   // Meiji    232</span>
<span class="line-removed">-     {  1912,    7, 30 },   // Taisho   233</span>
<span class="line-removed">-     {  1926,   12, 25 },   // Showa    234</span>
<span class="line-removed">-     {  1989,    1,  8 }   // Heisei    235</span>
<span class="line-removed">- };</span>
<span class="line-removed">- </span>
<span class="line-removed">- #define kEraCount UPRV_LENGTHOF(kEraInfo)</span>
<span class="line-removed">- </span>
<span class="line-removed">- /**</span>
<span class="line-removed">-  * The current era, for reference.</span>
<span class="line-removed">-  */</span>
<span class="line-removed">- static const int32_t kCurrentEra = (kEraCount-1);  // int32_t to match the calendar field type</span>
<span class="line-removed">- </span>
  static const int32_t kGregorianEpoch = 1970;    // used as the default value of EXTENDED_YEAR
  
  /* Some platforms don&#39;t like to export constants, like old Palm OS and some z/OS configurations. */
  uint32_t JapaneseCalendar::getCurrentEra() {
<span class="line-modified">!     return kCurrentEra;</span>
  }
  
  JapaneseCalendar::JapaneseCalendar(const Locale&amp; aLocale, UErrorCode&amp; success)
  :   GregorianCalendar(aLocale, success)
  {
      setTimeInMillis(getNow(), success); // Call this again now that the vtable is set up properly.
  }
  
  JapaneseCalendar::~JapaneseCalendar()
  {
  }
  
  JapaneseCalendar&amp; JapaneseCalendar::operator= ( const JapaneseCalendar&amp; right)
  {
      GregorianCalendar::operator=(right);
<span class="line-new-header">--- 14,122 ---</span>
  */
  
  #include &quot;unicode/utypes.h&quot;
  
  #if !UCONFIG_NO_FORMATTING
<span class="line-modified">! #if U_PLATFORM_HAS_WINUWP_API == 0</span>
<span class="line-added">+ #include &lt;stdlib.h&gt; // getenv() is not available in UWP env</span>
<span class="line-added">+ #else</span>
<span class="line-added">+ #ifndef WIN32_LEAN_AND_MEAN</span>
<span class="line-added">+ #   define WIN32_LEAN_AND_MEAN</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+ #   define VC_EXTRALEAN</span>
<span class="line-added">+ #   define NOUSER</span>
<span class="line-added">+ #   define NOSERVICE</span>
<span class="line-added">+ #   define NOIME</span>
<span class="line-added">+ #   define NOMCX</span>
<span class="line-added">+ #include &lt;windows.h&gt;</span>
<span class="line-added">+ #endif</span>
  #include &quot;cmemory.h&quot;
<span class="line-added">+ #include &quot;erarules.h&quot;</span>
  #include &quot;japancal.h&quot;
  #include &quot;unicode/gregocal.h&quot;
  #include &quot;umutex.h&quot;
  #include &quot;uassert.h&quot;
<span class="line-modified">! #include &quot;ucln_in.h&quot;</span>
<span class="line-modified">! #include &quot;cstring.h&quot;</span>
<span class="line-modified">! </span>
<span class="line-modified">! static icu::EraRules * gJapaneseEraRules = nullptr;</span>
<span class="line-modified">! static icu::UInitOnce gJapaneseEraRulesInitOnce = U_INITONCE_INITIALIZER;</span>
<span class="line-modified">! static int32_t gCurrentEra = 0;</span>
<span class="line-added">+ </span>
<span class="line-added">+ U_CDECL_BEGIN</span>
<span class="line-added">+ static UBool japanese_calendar_cleanup(void) {</span>
<span class="line-added">+     if (gJapaneseEraRules) {</span>
<span class="line-added">+         delete gJapaneseEraRules;</span>
<span class="line-added">+         gJapaneseEraRules = nullptr;</span>
<span class="line-added">+     }</span>
<span class="line-added">+     gCurrentEra = 0;</span>
<span class="line-added">+     gJapaneseEraRulesInitOnce.reset();</span>
<span class="line-added">+     return TRUE;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ U_CDECL_END</span>
  
  U_NAMESPACE_BEGIN
  
  UOBJECT_DEFINE_RTTI_IMPLEMENTATION(JapaneseCalendar)
  
  static const int32_t kGregorianEpoch = 1970;    // used as the default value of EXTENDED_YEAR
<span class="line-added">+ static const char* TENTATIVE_ERA_VAR_NAME = &quot;ICU_ENABLE_TENTATIVE_ERA&quot;;</span>
<span class="line-added">+ </span>
<span class="line-added">+ </span>
<span class="line-added">+ // Export the following for use by test code.</span>
<span class="line-added">+ UBool JapaneseCalendar::enableTentativeEra() {</span>
<span class="line-added">+     // Although start date of next Japanese era is planned ahead, a name of</span>
<span class="line-added">+     // new era might not be available. This implementation allows tester to</span>
<span class="line-added">+     // check a new era without era names by settings below (in priority order).</span>
<span class="line-added">+     // By default, such tentative era is disabled.</span>
<span class="line-added">+ </span>
<span class="line-added">+     // 1. Environment variable ICU_ENABLE_TENTATIVE_ERA=true or false</span>
<span class="line-added">+ </span>
<span class="line-added">+     UBool includeTentativeEra = FALSE;</span>
<span class="line-added">+ </span>
<span class="line-added">+ #if U_PLATFORM_HAS_WINUWP_API == 1</span>
<span class="line-added">+     // UWP doesn&#39;t allow access to getenv(), but we can call GetEnvironmentVariableW to do the same thing.</span>
<span class="line-added">+     UChar varName[26] = {};</span>
<span class="line-added">+     u_charsToUChars(TENTATIVE_ERA_VAR_NAME, varName, static_cast&lt;int32_t&gt;(uprv_strlen(TENTATIVE_ERA_VAR_NAME)));</span>
<span class="line-added">+     WCHAR varValue[5] = {};</span>
<span class="line-added">+     DWORD ret = GetEnvironmentVariableW(reinterpret_cast&lt;WCHAR*&gt;(varName), varValue, UPRV_LENGTHOF(varValue));</span>
<span class="line-added">+     if ((ret == 4) &amp;&amp; (_wcsicmp(varValue, L&quot;true&quot;) == 0)) {</span>
<span class="line-added">+         includeTentativeEra = TRUE;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ #else</span>
<span class="line-added">+     char *envVarVal = getenv(TENTATIVE_ERA_VAR_NAME);</span>
<span class="line-added">+     if (envVarVal != NULL &amp;&amp; uprv_stricmp(envVarVal, &quot;true&quot;) == 0) {</span>
<span class="line-added">+         includeTentativeEra = TRUE;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+     return includeTentativeEra;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ </span>
<span class="line-added">+ // Initialize global Japanese era data</span>
<span class="line-added">+ static void U_CALLCONV initializeEras(UErrorCode &amp;status) {</span>
<span class="line-added">+     gJapaneseEraRules = EraRules::createInstance(&quot;japanese&quot;, JapaneseCalendar::enableTentativeEra(), status);</span>
<span class="line-added">+     if (U_FAILURE(status)) {</span>
<span class="line-added">+         return;</span>
<span class="line-added">+     }</span>
<span class="line-added">+     gCurrentEra = gJapaneseEraRules-&gt;getCurrentEraIndex();</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ static void init(UErrorCode &amp;status) {</span>
<span class="line-added">+     umtx_initOnce(gJapaneseEraRulesInitOnce, &amp;initializeEras, status);</span>
<span class="line-added">+     ucln_i18n_registerCleanup(UCLN_I18N_JAPANESE_CALENDAR, japanese_calendar_cleanup);</span>
<span class="line-added">+ }</span>
  
  /* Some platforms don&#39;t like to export constants, like old Palm OS and some z/OS configurations. */
  uint32_t JapaneseCalendar::getCurrentEra() {
<span class="line-modified">!     return gCurrentEra;</span>
  }
  
  JapaneseCalendar::JapaneseCalendar(const Locale&amp; aLocale, UErrorCode&amp; success)
  :   GregorianCalendar(aLocale, success)
  {
<span class="line-added">+     init(success);</span>
      setTimeInMillis(getNow(), success); // Call this again now that the vtable is set up properly.
  }
  
  JapaneseCalendar::~JapaneseCalendar()
  {
<span class="line-added">+     UErrorCode status = U_ZERO_ERROR;</span>
<span class="line-added">+     init(status);</span>
<span class="line-added">+     U_ASSERT(U_SUCCESS(status));</span>
  }
  
  JapaneseCalendar&amp; JapaneseCalendar::operator= ( const JapaneseCalendar&amp; right)
  {
      GregorianCalendar::operator=(right);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 330,134 ***</span>
      // TODO do we assume we can trust &#39;era&#39;?  What if it is denormalized?
  
      int32_t month = 0;
  
      // Find out if we are at the edge of an era
<span class="line-modified">! </span>
<span class="line-modified">!     if(eyear == kEraInfo[era].year) {</span>
          // Yes, we&#39;re in the first year of this era.
<span class="line-modified">!         return kEraInfo[era].month-1;</span>
      }
  
      return month;
  }
  
  int32_t JapaneseCalendar::getDefaultDayInMonth(int32_t eyear, int32_t month)
  {
      int32_t era = internalGetEra();
      int32_t day = 1;
  
<span class="line-modified">!     if(eyear == kEraInfo[era].year) {</span>
<span class="line-modified">!         if(month == (kEraInfo[era].month-1)) {</span>
<span class="line-modified">!             return kEraInfo[era].day;</span>
          }
      }
  
      return day;
  }
  
  
  int32_t JapaneseCalendar::internalGetEra() const
  {
<span class="line-modified">!     return internalGet(UCAL_ERA, kCurrentEra);</span>
  }
  
  int32_t JapaneseCalendar::handleGetExtendedYear()
  {
      // EXTENDED_YEAR in JapaneseCalendar is a Gregorian year
      // The default value of EXTENDED_YEAR is 1970 (Showa 45)
      int32_t year;
  
      if (newerField(UCAL_EXTENDED_YEAR, UCAL_YEAR) == UCAL_EXTENDED_YEAR &amp;&amp;
          newerField(UCAL_EXTENDED_YEAR, UCAL_ERA) == UCAL_EXTENDED_YEAR) {
<span class="line-modified">!             year = internalGet(UCAL_EXTENDED_YEAR, kGregorianEpoch);</span>
<span class="line-modified">!         } else {</span>
<span class="line-modified">!             // Subtract one because year starts at 1</span>
<span class="line-modified">!             year = internalGet(UCAL_YEAR) + kEraInfo[internalGetEra()].year - 1;</span>
<span class="line-modified">!         }</span>
<span class="line-modified">!         return year;</span>
  }
  
  
  void JapaneseCalendar::handleComputeFields(int32_t julianDay, UErrorCode&amp; status)
  {
      //Calendar::timeToFields(theTime, quick, status);
      GregorianCalendar::handleComputeFields(julianDay, status);
      int32_t year = internalGet(UCAL_EXTENDED_YEAR); // Gregorian year
  
<span class="line-modified">!     int32_t low = 0;</span>
<span class="line-modified">! </span>
<span class="line-removed">-     // Short circuit for recent years.  Most modern computations will</span>
<span class="line-removed">-     // occur in the current era and won&#39;t require the binary search.</span>
<span class="line-removed">-     // Note that if the year is == the current era year, then we use</span>
<span class="line-removed">-     // the binary search to handle the month/dom comparison.</span>
<span class="line-removed">- #ifdef U_DEBUG_JCAL</span>
<span class="line-removed">-     fprintf(stderr, &quot;==  %d \n&quot;, year);</span>
<span class="line-removed">- #endif</span>
<span class="line-removed">- </span>
<span class="line-removed">-     if (year &gt; kEraInfo[kCurrentEra].year) {</span>
<span class="line-removed">-         low = kCurrentEra;</span>
<span class="line-removed">- #ifdef U_DEBUG_JCAL</span>
<span class="line-removed">-         fprintf(stderr, &quot; low=%d (special)\n&quot;, low);</span>
<span class="line-removed">- #endif</span>
<span class="line-removed">-     } else {</span>
<span class="line-removed">-         // Binary search</span>
<span class="line-removed">-         int32_t high = kEraCount;</span>
<span class="line-removed">- </span>
<span class="line-removed">- #ifdef U_DEBUG_JCAL</span>
<span class="line-removed">-         fprintf(stderr, &quot; high=%d\n&quot;, high);</span>
<span class="line-removed">- #endif</span>
<span class="line-removed">-         while (low &lt; high - 1) {</span>
<span class="line-removed">-             int32_t i = (low + high) / 2;</span>
<span class="line-removed">-             int32_t diff = year - kEraInfo[i].year;</span>
<span class="line-removed">- </span>
<span class="line-removed">- #ifdef U_DEBUG_JCAL</span>
<span class="line-removed">-             fprintf(stderr, &quot;  d=%d   low=%d, high=%d. Considering %d:M%d D%d Y%d. { we are ?:M%d D%d Y%d }\n&quot;,</span>
<span class="line-removed">-                 diff,low, high, i, kEraInfo[i].month-1, kEraInfo[i].day,  kEraInfo[i].year, internalGet(UCAL_MONTH), internalGet(UCAL_DATE),year);</span>
<span class="line-removed">- #endif</span>
<span class="line-removed">- </span>
<span class="line-removed">-             // If years are the same, then compare the months, and if those</span>
<span class="line-removed">-             // are the same, compare days of month.  In the ERAS array</span>
<span class="line-removed">-             // months are 1-based for easier maintenance.</span>
<span class="line-removed">-             if (diff == 0) {</span>
<span class="line-removed">-                 diff = internalGet(UCAL_MONTH) - (kEraInfo[i].month - 1);</span>
<span class="line-removed">- #ifdef U_DEBUG_JCAL</span>
<span class="line-removed">-                 fprintf(stderr, &quot;diff now %d (M)  = %d - %d - 1\n&quot;, diff, internalGet(UCAL_MONTH), kEraInfo[i].month);</span>
<span class="line-removed">- #endif</span>
<span class="line-removed">-                 if (diff == 0) {</span>
<span class="line-removed">-                     diff = internalGet(UCAL_DATE) - kEraInfo[i].day;</span>
<span class="line-removed">- #ifdef U_DEBUG_JCAL</span>
<span class="line-removed">-                     fprintf(stderr, &quot;diff now %d (D)\n&quot;, diff);</span>
<span class="line-removed">- #endif</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-             if (diff &gt;= 0) {</span>
<span class="line-removed">-                 low = i;</span>
<span class="line-removed">-             } else {</span>
<span class="line-removed">-                 high = i;</span>
<span class="line-removed">-             }</span>
<span class="line-removed">- #ifdef U_DEBUG_JCAL</span>
<span class="line-removed">-             fprintf(stderr, &quot;. low=%d, high=%d, i=%d, diff=%d.. %d\n&quot;, low, high, i, diff, year);</span>
<span class="line-removed">- #endif</span>
<span class="line-removed">- </span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- </span>
<span class="line-removed">- #ifdef U_DEBUG_JCAL</span>
<span class="line-removed">-     fprintf(stderr, &quot;  low[era]=%d,.. %d\n&quot;, low, year);</span>
<span class="line-removed">- #endif</span>
<span class="line-removed">-     // Now we&#39;ve found the last era that starts before this date, so</span>
<span class="line-removed">-     // adjust the year to count from the start of that era.  Note that</span>
<span class="line-removed">-     // all dates before the first era will fall into the first era by</span>
<span class="line-removed">-     // the algorithm.</span>
<span class="line-removed">- </span>
<span class="line-removed">-     internalSet(UCAL_ERA, low);</span>
<span class="line-removed">-     internalSet(UCAL_YEAR, year - kEraInfo[low].year + 1);</span>
<span class="line-removed">- #ifdef U_DEBUG_JCAL</span>
<span class="line-removed">-     fprintf(stderr, &quot;  Set ERA=%d, year=%d\n&quot;, low, year-kEraInfo[low].year+1);</span>
<span class="line-removed">- #endif</span>
<span class="line-removed">- </span>
  }
  
  /*
  Disable pivoting
  */
<span class="line-new-header">--- 152,79 ---</span>
      // TODO do we assume we can trust &#39;era&#39;?  What if it is denormalized?
  
      int32_t month = 0;
  
      // Find out if we are at the edge of an era
<span class="line-modified">!     int32_t eraStart[3] = { 0,0,0 };</span>
<span class="line-modified">!     UErrorCode status = U_ZERO_ERROR;</span>
<span class="line-added">+     gJapaneseEraRules-&gt;getStartDate(era, eraStart, status);</span>
<span class="line-added">+     U_ASSERT(U_SUCCESS(status));</span>
<span class="line-added">+     if(eyear == eraStart[0]) {</span>
          // Yes, we&#39;re in the first year of this era.
<span class="line-modified">!         return eraStart[1]  // month</span>
<span class="line-added">+                 -1;         // return 0-based month</span>
      }
  
      return month;
  }
  
  int32_t JapaneseCalendar::getDefaultDayInMonth(int32_t eyear, int32_t month)
  {
      int32_t era = internalGetEra();
      int32_t day = 1;
  
<span class="line-modified">!     int32_t eraStart[3] = { 0,0,0 };</span>
<span class="line-modified">!     UErrorCode status = U_ZERO_ERROR;</span>
<span class="line-modified">!     gJapaneseEraRules-&gt;getStartDate(era, eraStart, status);</span>
<span class="line-added">+     U_ASSERT(U_SUCCESS(status));</span>
<span class="line-added">+     if(eyear == eraStart[0]) {</span>
<span class="line-added">+         if(month == eraStart[1] - 1) {</span>
<span class="line-added">+             return eraStart[2];</span>
          }
      }
  
      return day;
  }
  
  
  int32_t JapaneseCalendar::internalGetEra() const
  {
<span class="line-modified">!     return internalGet(UCAL_ERA, gCurrentEra);</span>
  }
  
  int32_t JapaneseCalendar::handleGetExtendedYear()
  {
      // EXTENDED_YEAR in JapaneseCalendar is a Gregorian year
      // The default value of EXTENDED_YEAR is 1970 (Showa 45)
      int32_t year;
  
      if (newerField(UCAL_EXTENDED_YEAR, UCAL_YEAR) == UCAL_EXTENDED_YEAR &amp;&amp;
          newerField(UCAL_EXTENDED_YEAR, UCAL_ERA) == UCAL_EXTENDED_YEAR) {
<span class="line-modified">!         year = internalGet(UCAL_EXTENDED_YEAR, kGregorianEpoch);</span>
<span class="line-modified">!     } else {</span>
<span class="line-modified">!         UErrorCode status = U_ZERO_ERROR;</span>
<span class="line-modified">!         int32_t eraStartYear = gJapaneseEraRules-&gt;getStartYear(internalGet(UCAL_ERA, gCurrentEra), status);</span>
<span class="line-modified">!         U_ASSERT(U_SUCCESS(status));</span>
<span class="line-modified">! </span>
<span class="line-added">+         // extended year is a gregorian year, where 1 = 1AD,  0 = 1BC, -1 = 2BC, etc</span>
<span class="line-added">+         year = internalGet(UCAL_YEAR, 1)    // pin to minimum of year 1 (first year)</span>
<span class="line-added">+             + eraStartYear                  // add gregorian starting year</span>
<span class="line-added">+             - 1;                            // Subtract one because year starts at 1</span>
<span class="line-added">+     }</span>
<span class="line-added">+     return year;</span>
  }
  
  
  void JapaneseCalendar::handleComputeFields(int32_t julianDay, UErrorCode&amp; status)
  {
      //Calendar::timeToFields(theTime, quick, status);
      GregorianCalendar::handleComputeFields(julianDay, status);
      int32_t year = internalGet(UCAL_EXTENDED_YEAR); // Gregorian year
<span class="line-added">+     int32_t eraIdx = gJapaneseEraRules-&gt;getEraIndex(year, internalGet(UCAL_MONTH) + 1, internalGet(UCAL_DAY_OF_MONTH), status);</span>
  
<span class="line-modified">!     internalSet(UCAL_ERA, eraIdx);</span>
<span class="line-modified">!     internalSet(UCAL_YEAR, year - gJapaneseEraRules-&gt;getStartYear(eraIdx, status) + 1);</span>
  }
  
  /*
  Disable pivoting
  */
</pre>
<hr />
<pre>
<span class="line-old-header">*** 481,22 ***</span>
      switch(field) {
      case UCAL_ERA:
          if (limitType == UCAL_LIMIT_MINIMUM || limitType == UCAL_LIMIT_GREATEST_MINIMUM) {
              return 0;
          }
<span class="line-modified">!         return kCurrentEra;</span>
      case UCAL_YEAR:
          {
              switch (limitType) {
              case UCAL_LIMIT_MINIMUM:
              case UCAL_LIMIT_GREATEST_MINIMUM:
                  return 1;
              case UCAL_LIMIT_LEAST_MAXIMUM:
                  return 1;
              case  UCAL_LIMIT_COUNT: //added to avoid warning
              case UCAL_LIMIT_MAXIMUM:
<span class="line-modified">!                 return GregorianCalendar::handleGetLimit(UCAL_YEAR, UCAL_LIMIT_MAXIMUM) - kEraInfo[kCurrentEra].year;</span>
              default:
                  return 1;    // Error condition, invalid limitType
              }
          }
      default:
<span class="line-new-header">--- 248,27 ---</span>
      switch(field) {
      case UCAL_ERA:
          if (limitType == UCAL_LIMIT_MINIMUM || limitType == UCAL_LIMIT_GREATEST_MINIMUM) {
              return 0;
          }
<span class="line-modified">!         return gJapaneseEraRules-&gt;getNumberOfEras() - 1; // max known era, not gCurrentEra</span>
      case UCAL_YEAR:
          {
              switch (limitType) {
              case UCAL_LIMIT_MINIMUM:
              case UCAL_LIMIT_GREATEST_MINIMUM:
                  return 1;
              case UCAL_LIMIT_LEAST_MAXIMUM:
                  return 1;
              case  UCAL_LIMIT_COUNT: //added to avoid warning
              case UCAL_LIMIT_MAXIMUM:
<span class="line-modified">!             {</span>
<span class="line-added">+                 UErrorCode status = U_ZERO_ERROR;</span>
<span class="line-added">+                 int32_t eraStartYear = gJapaneseEraRules-&gt;getStartYear(gCurrentEra, status);</span>
<span class="line-added">+                 U_ASSERT(U_SUCCESS(status));</span>
<span class="line-added">+                 return GregorianCalendar::handleGetLimit(UCAL_YEAR, UCAL_LIMIT_MAXIMUM) - eraStartYear;</span>
<span class="line-added">+             }</span>
              default:
                  return 1;    // Error condition, invalid limitType
              }
          }
      default:
</pre>
<hr />
<pre>
<span class="line-old-header">*** 508,19 ***</span>
      if (field == UCAL_YEAR) {
          int32_t era = get(UCAL_ERA, status);
          if (U_FAILURE(status)) {
              return 0; // error case... any value
          }
<span class="line-modified">!         if (era == kCurrentEra) {</span>
              // TODO: Investigate what value should be used here - revisit after 4.0.
              return handleGetLimit(UCAL_YEAR, UCAL_LIMIT_MAXIMUM);
          } else {
<span class="line-modified">!             int32_t nextEraYear = kEraInfo[era + 1].year;</span>
<span class="line-modified">!             int32_t nextEraMonth = kEraInfo[era + 1].month;</span>
<span class="line-modified">!             int32_t nextEraDate = kEraInfo[era + 1].day;</span>
<span class="line-modified">! </span>
<span class="line-modified">!             int32_t maxYear = nextEraYear - kEraInfo[era].year + 1; // 1-base</span>
              if (nextEraMonth == 1 &amp;&amp; nextEraDate == 1) {
                  // Subtract 1, because the next era starts at Jan 1
                  maxYear--;
              }
              return maxYear;
<span class="line-new-header">--- 280,22 ---</span>
      if (field == UCAL_YEAR) {
          int32_t era = get(UCAL_ERA, status);
          if (U_FAILURE(status)) {
              return 0; // error case... any value
          }
<span class="line-modified">!         if (era == gJapaneseEraRules-&gt;getNumberOfEras() - 1) { // max known era, not gCurrentEra</span>
              // TODO: Investigate what value should be used here - revisit after 4.0.
              return handleGetLimit(UCAL_YEAR, UCAL_LIMIT_MAXIMUM);
          } else {
<span class="line-modified">!             int32_t nextEraStart[3] = { 0,0,0 };</span>
<span class="line-modified">!             gJapaneseEraRules-&gt;getStartDate(era + 1, nextEraStart, status);</span>
<span class="line-modified">!             int32_t nextEraYear = nextEraStart[0];</span>
<span class="line-modified">!             int32_t nextEraMonth = nextEraStart[1]; // 1-base</span>
<span class="line-modified">!             int32_t nextEraDate = nextEraStart[2];</span>
<span class="line-added">+ </span>
<span class="line-added">+             int32_t eraStartYear = gJapaneseEraRules-&gt;getStartYear(era, status);</span>
<span class="line-added">+             int32_t maxYear = nextEraYear - eraStartYear + 1;   // 1-base</span>
              if (nextEraMonth == 1 &amp;&amp; nextEraDate == 1) {
                  // Subtract 1, because the next era starts at Jan 1
                  maxYear--;
              }
              return maxYear;
</pre>
<center><a href="islamcal.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> <a href="japancal.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>