<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/ThirdParty/icu/source/tools/toolutil/swapimpl.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="pkg_gencmn.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="toolutil.cpp.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/ThirdParty/icu/source/tools/toolutil/swapimpl.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -39,10 +39,11 @@</span>
  #include &quot;uinvchar.h&quot;
  #include &quot;uassert.h&quot;
  #include &quot;uarrsort.h&quot;
  #include &quot;ucmndata.h&quot;
  #include &quot;udataswp.h&quot;
<span class="udiff-line-added">+ #include &quot;ulayout_props.h&quot;</span>
  
  /* swapping implementations in common */
  
  #include &quot;uresdata.h&quot;
  #include &quot;ucnv_io.h&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -241,11 +242,11 @@</span>
  
          /*
           * swap the main properties UTrie
           * PT serialized properties trie, see utrie.h (byte size: 4*(i0-16))
           */
<span class="udiff-line-modified-removed">-         utrie2_swapAnyVersion(ds,</span>
<span class="udiff-line-modified-added">+         utrie_swapAnyVersion(ds,</span>
              inData32+UPROPS_INDEX_COUNT,
              4*(dataIndexes[UPROPS_PROPS32_INDEX]-UPROPS_INDEX_COUNT),
              outData32+UPROPS_INDEX_COUNT,
              pErrorCode);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -272,11 +273,11 @@</span>
  
          /*
           * swap the additional UTrie
           * i3 additionalTrieIndex; -- 32-bit unit index to the additional trie for more properties
           */
<span class="udiff-line-modified-removed">-         utrie2_swapAnyVersion(ds,</span>
<span class="udiff-line-modified-added">+         utrie_swapAnyVersion(ds,</span>
              inData32+dataIndexes[UPROPS_ADDITIONAL_TRIE_INDEX],
              4*(dataIndexes[UPROPS_ADDITIONAL_VECTORS_INDEX]-dataIndexes[UPROPS_ADDITIONAL_TRIE_INDEX]),
              outData32+dataIndexes[UPROPS_ADDITIONAL_TRIE_INDEX],
              pErrorCode);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -334,11 +335,11 @@</span>
          pInfo-&gt;dataFormat[2]==UCASE_FMT_2 &amp;&amp;
          pInfo-&gt;dataFormat[3]==UCASE_FMT_3 &amp;&amp;
          ((pInfo-&gt;formatVersion[0]==1 &amp;&amp;
            pInfo-&gt;formatVersion[2]==UTRIE_SHIFT &amp;&amp;
            pInfo-&gt;formatVersion[3]==UTRIE_INDEX_SHIFT) ||
<span class="udiff-line-modified-removed">-          2&lt;=pInfo-&gt;formatVersion[0] || pInfo-&gt;formatVersion[0]&lt;=4)</span>
<span class="udiff-line-modified-added">+          (2&lt;=pInfo-&gt;formatVersion[0] &amp;&amp; pInfo-&gt;formatVersion[0]&lt;=4))</span>
      )) {
          udata_printError(ds, &quot;ucase_swap(): data format %02x.%02x.%02x.%02x (format version %02x) is not recognized as case mapping data\n&quot;,
                           pInfo-&gt;dataFormat[0], pInfo-&gt;dataFormat[1],
                           pInfo-&gt;dataFormat[2], pInfo-&gt;dataFormat[3],
                           pInfo-&gt;formatVersion[0]);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -389,11 +390,11 @@</span>
          ds-&gt;swapArray32(ds, inBytes, count, outBytes, pErrorCode);
          offset+=count;
  
          /* swap the UTrie */
          count=indexes[UCASE_IX_TRIE_SIZE];
<span class="udiff-line-modified-removed">-         utrie2_swapAnyVersion(ds, inBytes+offset, count, outBytes+offset, pErrorCode);</span>
<span class="udiff-line-modified-added">+         utrie_swapAnyVersion(ds, inBytes+offset, count, outBytes+offset, pErrorCode);</span>
          offset+=count;
  
          /* swap the uint16_t exceptions[] and unfold[] */
          count=(indexes[UCASE_IX_EXC_LENGTH]+indexes[UCASE_IX_UNFOLD_LENGTH])*2;
          ds-&gt;swapArray16(ds, inBytes+offset, count, outBytes+offset, pErrorCode);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -491,11 +492,11 @@</span>
          ds-&gt;swapArray32(ds, inBytes, count, outBytes, pErrorCode);
          offset+=count;
  
          /* swap the UTrie */
          count=indexes[UBIDI_IX_TRIE_SIZE];
<span class="udiff-line-modified-removed">-         utrie2_swapAnyVersion(ds, inBytes+offset, count, outBytes+offset, pErrorCode);</span>
<span class="udiff-line-modified-added">+         utrie_swapAnyVersion(ds, inBytes+offset, count, outBytes+offset, pErrorCode);</span>
          offset+=count;
  
          /* swap the uint32_t mirrors[] */
          count=indexes[UBIDI_IX_MIRROR_LENGTH]*4;
          ds-&gt;swapArray32(ds, inBytes+offset, count, outBytes+offset, pErrorCode);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -638,10 +639,110 @@</span>
      return headerSize+size;
  }
  
  #endif
  
<span class="udiff-line-added">+ // Unicode text layout properties data swapping --------------------------------</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ static int32_t U_CALLCONV</span>
<span class="udiff-line-added">+ ulayout_swap(const UDataSwapper *ds,</span>
<span class="udiff-line-added">+              const void *inData, int32_t length, void *outData,</span>
<span class="udiff-line-added">+              UErrorCode *pErrorCode) {</span>
<span class="udiff-line-added">+     // udata_swapDataHeader checks the arguments.</span>
<span class="udiff-line-added">+     int32_t headerSize = udata_swapDataHeader(ds, inData, length, outData, pErrorCode);</span>
<span class="udiff-line-added">+     if (pErrorCode == nullptr || U_FAILURE(*pErrorCode)) {</span>
<span class="udiff-line-added">+         return 0;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // Check data format and format version.</span>
<span class="udiff-line-added">+     const UDataInfo *pInfo = (const UDataInfo *)((const char *)inData + 4);</span>
<span class="udiff-line-added">+     if (!(</span>
<span class="udiff-line-added">+             pInfo-&gt;dataFormat[0] == ULAYOUT_FMT_0 &amp;&amp;    // dataFormat=&quot;Layo&quot;</span>
<span class="udiff-line-added">+             pInfo-&gt;dataFormat[1] == ULAYOUT_FMT_1 &amp;&amp;</span>
<span class="udiff-line-added">+             pInfo-&gt;dataFormat[2] == ULAYOUT_FMT_2 &amp;&amp;</span>
<span class="udiff-line-added">+             pInfo-&gt;dataFormat[3] == ULAYOUT_FMT_3 &amp;&amp;</span>
<span class="udiff-line-added">+             pInfo-&gt;formatVersion[0] == 1)) {</span>
<span class="udiff-line-added">+         udata_printError(ds,</span>
<span class="udiff-line-added">+             &quot;ulayout_swap(): data format %02x.%02x.%02x.%02x (format version %02x) &quot;</span>
<span class="udiff-line-added">+             &quot;is not recognized as text layout properties data\n&quot;,</span>
<span class="udiff-line-added">+             pInfo-&gt;dataFormat[0], pInfo-&gt;dataFormat[1],</span>
<span class="udiff-line-added">+             pInfo-&gt;dataFormat[2], pInfo-&gt;dataFormat[3],</span>
<span class="udiff-line-added">+             pInfo-&gt;formatVersion[0]);</span>
<span class="udiff-line-added">+         *pErrorCode = U_UNSUPPORTED_ERROR;</span>
<span class="udiff-line-added">+         return 0;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     const uint8_t *inBytes = (const uint8_t *)inData + headerSize;</span>
<span class="udiff-line-added">+     uint8_t *outBytes = (uint8_t *)outData + headerSize;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     const int32_t *inIndexes = (const int32_t *)inBytes;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (length &gt;= 0) {</span>
<span class="udiff-line-added">+         length -= headerSize;</span>
<span class="udiff-line-added">+         if (length &lt; 12 * 4) {</span>
<span class="udiff-line-added">+             udata_printError(ds,</span>
<span class="udiff-line-added">+                 &quot;ulayout_swap(): too few bytes (%d after header) for text layout properties data\n&quot;,</span>
<span class="udiff-line-added">+                 length);</span>
<span class="udiff-line-added">+             *pErrorCode = U_INDEX_OUTOFBOUNDS_ERROR;</span>
<span class="udiff-line-added">+             return 0;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     int32_t indexesLength = udata_readInt32(ds, inIndexes[ULAYOUT_IX_INDEXES_LENGTH]);</span>
<span class="udiff-line-added">+     if (indexesLength &lt; 12) {</span>
<span class="udiff-line-added">+         udata_printError(ds,</span>
<span class="udiff-line-added">+             &quot;ulayout_swap(): too few indexes (%d) for text layout properties data\n&quot;,</span>
<span class="udiff-line-added">+             indexesLength);</span>
<span class="udiff-line-added">+         *pErrorCode = U_INDEX_OUTOFBOUNDS_ERROR;</span>
<span class="udiff-line-added">+         return 0;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     // Read the data offsets before swapping anything.</span>
<span class="udiff-line-added">+     int32_t indexes[ULAYOUT_IX_TRIES_TOP + 1];</span>
<span class="udiff-line-added">+     for (int32_t i = ULAYOUT_IX_INPC_TRIE_TOP; i &lt;= ULAYOUT_IX_TRIES_TOP; ++i) {</span>
<span class="udiff-line-added">+         indexes[i] = udata_readInt32(ds, inIndexes[i]);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     int32_t size = indexes[ULAYOUT_IX_TRIES_TOP];</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (length &gt;= 0) {</span>
<span class="udiff-line-added">+         if (length &lt; size) {</span>
<span class="udiff-line-added">+             udata_printError(ds,</span>
<span class="udiff-line-added">+                 &quot;ulayout_swap(): too few bytes (%d after header) &quot;</span>
<span class="udiff-line-added">+                 &quot;for all of text layout properties data\n&quot;,</span>
<span class="udiff-line-added">+                 length);</span>
<span class="udiff-line-added">+             *pErrorCode = U_INDEX_OUTOFBOUNDS_ERROR;</span>
<span class="udiff-line-added">+             return 0;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // Copy the data for inaccessible bytes.</span>
<span class="udiff-line-added">+         if (inBytes != outBytes) {</span>
<span class="udiff-line-added">+             uprv_memcpy(outBytes, inBytes, size);</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // Swap the int32_t indexes[].</span>
<span class="udiff-line-added">+         int32_t offset = 0;</span>
<span class="udiff-line-added">+         int32_t count = indexesLength * 4;</span>
<span class="udiff-line-added">+         ds-&gt;swapArray32(ds, inBytes, count, outBytes, pErrorCode);</span>
<span class="udiff-line-added">+         offset += count;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         // Swap each trie.</span>
<span class="udiff-line-added">+         for (int32_t i = ULAYOUT_IX_INPC_TRIE_TOP; i &lt;= ULAYOUT_IX_TRIES_TOP; ++i) {</span>
<span class="udiff-line-added">+             int32_t top = indexes[i];</span>
<span class="udiff-line-added">+             count = top - offset;</span>
<span class="udiff-line-added">+             U_ASSERT(count &gt;= 0);</span>
<span class="udiff-line-added">+             if (count &gt;= 16) {</span>
<span class="udiff-line-added">+                 utrie_swapAnyVersion(ds, inBytes + offset, count, outBytes + offset, pErrorCode);</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+             offset = top;</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         U_ASSERT(offset == size);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return headerSize + size;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  /* Swap &#39;Test&#39; data from gentest */
  static int32_t U_CALLCONV
  test_swap(const UDataSwapper *ds,
             const void *inData, int32_t length, void *outData,
             UErrorCode *pErrorCode) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -729,10 +830,14 @@</span>
  
  #if !UCONFIG_NO_NORMALIZATION
      { { 0x4e, 0x6f, 0x72, 0x6d }, unorm_swap },         /* dataFormat=&quot;Norm&quot; */
      { { 0x4e, 0x72, 0x6d, 0x32 }, unorm2_swap },        /* dataFormat=&quot;Nrm2&quot; */
  #endif
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     { { ULAYOUT_FMT_0, ULAYOUT_FMT_1, ULAYOUT_FMT_2, ULAYOUT_FMT_3 },</span>
<span class="udiff-line-added">+                                   ulayout_swap },       // dataFormat=&quot;Layo&quot;</span>
<span class="udiff-line-added">+ </span>
  #if !UCONFIG_NO_COLLATION
      { { 0x55, 0x43, 0x6f, 0x6c }, ucol_swap },          /* dataFormat=&quot;UCol&quot; */
      { { 0x49, 0x6e, 0x76, 0x43 }, ucol_swapInverseUCA },/* dataFormat=&quot;InvC&quot; */
  #endif
  #if !UCONFIG_NO_BREAK_ITERATION
</pre>
<center><a href="pkg_gencmn.cpp.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../../index.html" target="_top">index</a> <a href="toolutil.cpp.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>